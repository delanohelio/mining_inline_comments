{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA1MDA0MzY5", "number": 6449, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMzoyNTowNFrOEutVqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMzoyNToxMlrOEutVwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3NDEyNzc4OnYy", "diffSide": "RIGHT", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/topic/TopicDeleteInjector.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMzoyNTowNFrOHjSOjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNTozOTo1OVrOHkU9yA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc2MDg0NQ==", "bodyText": "Is this functional?", "url": "https://github.com/confluentinc/ksql/pull/6449#discussion_r506760845", "createdAt": "2020-10-16T23:25:04Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/topic/TopicDeleteInjector.java", "diffHunk": "@@ -100,26 +98,18 @@ public TopicDeleteInjector(\n \n     if (source != null) {\n       checkTopicRefs(source);\n-      try {\n-        ExecutorUtil.executeWithRetries(\n-            () -> topicClient.deleteTopics(ImmutableList.of(source.getKafkaTopicName())),\n-            ExecutorUtil.RetryBehaviour.ALWAYS);\n-      } catch (final Exception e) {\n-        throw new RuntimeException(\"Could not delete the corresponding kafka topic: \"\n-                + source.getKafkaTopicName(), e);\n-      }\n \n+      deleteTopic(source);\n+\n+      final Closer closer = Closer.create();\n+      deleteValueSubject(source);\n+      deleteKeySubject(source);\n       try {\n-        final Format valueFormat = FormatFactory\n-            .fromName(source.getKsqlTopic().getValueFormat().getFormat());\n-\n-        if (valueFormat.supportsFeature(SerdeFeature.SCHEMA_INFERENCE)) {\n-          SchemaRegistryUtil.deleteSubjectWithRetries(\n-                  schemaRegistryClient,\n-                  source.getKafkaTopicName() + KsqlConstants.SCHEMA_REGISTRY_VALUE_SUFFIX);\n-        }\n+        closer.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "437ef4bf08a9020d23f315306711d8e090e473aa"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc2MTkzMA==", "bodyText": "what do you mean by \"functional\"? If by \"does it do anything\" the answer is yes - it will first close all of the closeables registered, and then it'll throw the first non-suppressed error that it encountered", "url": "https://github.com/confluentinc/ksql/pull/6449#discussion_r506761930", "createdAt": "2020-10-16T23:30:42Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/topic/TopicDeleteInjector.java", "diffHunk": "@@ -100,26 +98,18 @@ public TopicDeleteInjector(\n \n     if (source != null) {\n       checkTopicRefs(source);\n-      try {\n-        ExecutorUtil.executeWithRetries(\n-            () -> topicClient.deleteTopics(ImmutableList.of(source.getKafkaTopicName())),\n-            ExecutorUtil.RetryBehaviour.ALWAYS);\n-      } catch (final Exception e) {\n-        throw new RuntimeException(\"Could not delete the corresponding kafka topic: \"\n-                + source.getKafkaTopicName(), e);\n-      }\n \n+      deleteTopic(source);\n+\n+      final Closer closer = Closer.create();\n+      deleteValueSubject(source);\n+      deleteKeySubject(source);\n       try {\n-        final Format valueFormat = FormatFactory\n-            .fromName(source.getKsqlTopic().getValueFormat().getFormat());\n-\n-        if (valueFormat.supportsFeature(SerdeFeature.SCHEMA_INFERENCE)) {\n-          SchemaRegistryUtil.deleteSubjectWithRetries(\n-                  schemaRegistryClient,\n-                  source.getKafkaTopicName() + KsqlConstants.SCHEMA_REGISTRY_VALUE_SUFFIX);\n-        }\n+        closer.close();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc2MDg0NQ=="}, "originalCommit": {"oid": "437ef4bf08a9020d23f315306711d8e090e473aa"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzI0MzMxMw==", "bodyText": "Where are closeables registered?", "url": "https://github.com/confluentinc/ksql/pull/6449#discussion_r507243313", "createdAt": "2020-10-18T23:07:41Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/topic/TopicDeleteInjector.java", "diffHunk": "@@ -100,26 +98,18 @@ public TopicDeleteInjector(\n \n     if (source != null) {\n       checkTopicRefs(source);\n-      try {\n-        ExecutorUtil.executeWithRetries(\n-            () -> topicClient.deleteTopics(ImmutableList.of(source.getKafkaTopicName())),\n-            ExecutorUtil.RetryBehaviour.ALWAYS);\n-      } catch (final Exception e) {\n-        throw new RuntimeException(\"Could not delete the corresponding kafka topic: \"\n-                + source.getKafkaTopicName(), e);\n-      }\n \n+      deleteTopic(source);\n+\n+      final Closer closer = Closer.create();\n+      deleteValueSubject(source);\n+      deleteKeySubject(source);\n       try {\n-        final Format valueFormat = FormatFactory\n-            .fromName(source.getKsqlTopic().getValueFormat().getFormat());\n-\n-        if (valueFormat.supportsFeature(SerdeFeature.SCHEMA_INFERENCE)) {\n-          SchemaRegistryUtil.deleteSubjectWithRetries(\n-                  schemaRegistryClient,\n-                  source.getKafkaTopicName() + KsqlConstants.SCHEMA_REGISTRY_VALUE_SUFFIX);\n-        }\n+        closer.close();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc2MDg0NQ=="}, "originalCommit": {"oid": "437ef4bf08a9020d23f315306711d8e090e473aa"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg0Njg4Mw==", "bodyText": "\ud83e\udd26 I think something got lost in my merge. Thanks for catching this...", "url": "https://github.com/confluentinc/ksql/pull/6449#discussion_r507846883", "createdAt": "2020-10-19T15:30:16Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/topic/TopicDeleteInjector.java", "diffHunk": "@@ -100,26 +98,18 @@ public TopicDeleteInjector(\n \n     if (source != null) {\n       checkTopicRefs(source);\n-      try {\n-        ExecutorUtil.executeWithRetries(\n-            () -> topicClient.deleteTopics(ImmutableList.of(source.getKafkaTopicName())),\n-            ExecutorUtil.RetryBehaviour.ALWAYS);\n-      } catch (final Exception e) {\n-        throw new RuntimeException(\"Could not delete the corresponding kafka topic: \"\n-                + source.getKafkaTopicName(), e);\n-      }\n \n+      deleteTopic(source);\n+\n+      final Closer closer = Closer.create();\n+      deleteValueSubject(source);\n+      deleteKeySubject(source);\n       try {\n-        final Format valueFormat = FormatFactory\n-            .fromName(source.getKsqlTopic().getValueFormat().getFormat());\n-\n-        if (valueFormat.supportsFeature(SerdeFeature.SCHEMA_INFERENCE)) {\n-          SchemaRegistryUtil.deleteSubjectWithRetries(\n-                  schemaRegistryClient,\n-                  source.getKafkaTopicName() + KsqlConstants.SCHEMA_REGISTRY_VALUE_SUFFIX);\n-        }\n+        closer.close();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc2MDg0NQ=="}, "originalCommit": {"oid": "437ef4bf08a9020d23f315306711d8e090e473aa"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg1NDI4MA==", "bodyText": "#6461", "url": "https://github.com/confluentinc/ksql/pull/6449#discussion_r507854280", "createdAt": "2020-10-19T15:39:59Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/topic/TopicDeleteInjector.java", "diffHunk": "@@ -100,26 +98,18 @@ public TopicDeleteInjector(\n \n     if (source != null) {\n       checkTopicRefs(source);\n-      try {\n-        ExecutorUtil.executeWithRetries(\n-            () -> topicClient.deleteTopics(ImmutableList.of(source.getKafkaTopicName())),\n-            ExecutorUtil.RetryBehaviour.ALWAYS);\n-      } catch (final Exception e) {\n-        throw new RuntimeException(\"Could not delete the corresponding kafka topic: \"\n-                + source.getKafkaTopicName(), e);\n-      }\n \n+      deleteTopic(source);\n+\n+      final Closer closer = Closer.create();\n+      deleteValueSubject(source);\n+      deleteKeySubject(source);\n       try {\n-        final Format valueFormat = FormatFactory\n-            .fromName(source.getKsqlTopic().getValueFormat().getFormat());\n-\n-        if (valueFormat.supportsFeature(SerdeFeature.SCHEMA_INFERENCE)) {\n-          SchemaRegistryUtil.deleteSubjectWithRetries(\n-                  schemaRegistryClient,\n-                  source.getKafkaTopicName() + KsqlConstants.SCHEMA_REGISTRY_VALUE_SUFFIX);\n-        }\n+        closer.close();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc2MDg0NQ=="}, "originalCommit": {"oid": "437ef4bf08a9020d23f315306711d8e090e473aa"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3NDEyNzg5OnYy", "diffSide": "RIGHT", "path": "ksqldb-engine/src/test/java/io/confluent/ksql/integration/EndToEndIntegrationTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMzoyNTowOVrOHjSOmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMzoyOTowOVrOHjSRcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc2MDg1OQ==", "bodyText": "We're planning on enabling Avro keys soon, right? We should remember to pull these out when we do.", "url": "https://github.com/confluentinc/ksql/pull/6449#discussion_r506760859", "createdAt": "2020-10-16T23:25:09Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-engine/src/test/java/io/confluent/ksql/integration/EndToEndIntegrationTest.java", "diffHunk": "@@ -123,6 +123,10 @@\n       .withAdditionalConfig(\n           KsqlConfig.SCHEMA_REGISTRY_URL_PROPERTY,\n           \"http://foo:8080\")\n+      .withAdditionalConfig(\n+          KsqlConfig.KSQL_KEY_FORMAT_ENABLED,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "437ef4bf08a9020d23f315306711d8e090e473aa"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc2MTU4Nw==", "bodyText": "Added a task to the project.", "url": "https://github.com/confluentinc/ksql/pull/6449#discussion_r506761587", "createdAt": "2020-10-16T23:29:09Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/test/java/io/confluent/ksql/integration/EndToEndIntegrationTest.java", "diffHunk": "@@ -123,6 +123,10 @@\n       .withAdditionalConfig(\n           KsqlConfig.SCHEMA_REGISTRY_URL_PROPERTY,\n           \"http://foo:8080\")\n+      .withAdditionalConfig(\n+          KsqlConfig.KSQL_KEY_FORMAT_ENABLED,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc2MDg1OQ=="}, "originalCommit": {"oid": "437ef4bf08a9020d23f315306711d8e090e473aa"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3NDEyODAyOnYy", "diffSide": "RIGHT", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/InsertValuesExecutor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMzoyNToxMlrOHjSOrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMzozMTo1MlrOHjST0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc2MDg3Ng==", "bodyText": "nit (not your code): can we update the error message here to say Could not serialize value? To me \"row\" could refer to either the key or the value. Seems good to be more specific when we can.", "url": "https://github.com/confluentinc/ksql/pull/6449#discussion_r506760876", "createdAt": "2020-10-16T23:25:12Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/InsertValuesExecutor.java", "diffHunk": "@@ -292,29 +299,39 @@ private void throwIfDisabled(final KsqlConfig config) {\n     try {\n       return valueSerde.serializer().serialize(topicName, row);\n     } catch (final Exception e) {\n-      final Format valueFormat = FormatFactory\n-          .fromName(dataSource.getKsqlTopic().getValueFormat().getFormat());\n-      if (valueFormat.supportsFeature(SerdeFeature.SCHEMA_INFERENCE)) {\n-        final Throwable rootCause = ExceptionUtils.getRootCause(e);\n-        if (rootCause instanceof RestClientException) {\n-          switch (((RestClientException) rootCause).getStatus()) {\n-            case HttpStatus.SC_UNAUTHORIZED:\n-            case HttpStatus.SC_FORBIDDEN:\n-              throw new KsqlException(String.format(\n-                  \"Not authorized to write Schema Registry subject: [%s]\",\n-                  topicName + KsqlConstants.SCHEMA_REGISTRY_VALUE_SUFFIX\n-              ));\n-            default:\n-              break;\n-          }\n-        }\n-      }\n-\n+      maybeThrowSchemaRegistryAuthError(\n+          FormatFactory.fromName(dataSource.getKsqlTopic().getValueFormat().getFormat()),\n+          topicName,\n+          false,\n+          e);\n       LOG.error(\"Could not serialize row.\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "437ef4bf08a9020d23f315306711d8e090e473aa"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc2MjE5NQ==", "bodyText": "Since I need to update the other PR and this one is green, i'm going to just go ahead and merge and do it in #6452", "url": "https://github.com/confluentinc/ksql/pull/6449#discussion_r506762195", "createdAt": "2020-10-16T23:31:52Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/InsertValuesExecutor.java", "diffHunk": "@@ -292,29 +299,39 @@ private void throwIfDisabled(final KsqlConfig config) {\n     try {\n       return valueSerde.serializer().serialize(topicName, row);\n     } catch (final Exception e) {\n-      final Format valueFormat = FormatFactory\n-          .fromName(dataSource.getKsqlTopic().getValueFormat().getFormat());\n-      if (valueFormat.supportsFeature(SerdeFeature.SCHEMA_INFERENCE)) {\n-        final Throwable rootCause = ExceptionUtils.getRootCause(e);\n-        if (rootCause instanceof RestClientException) {\n-          switch (((RestClientException) rootCause).getStatus()) {\n-            case HttpStatus.SC_UNAUTHORIZED:\n-            case HttpStatus.SC_FORBIDDEN:\n-              throw new KsqlException(String.format(\n-                  \"Not authorized to write Schema Registry subject: [%s]\",\n-                  topicName + KsqlConstants.SCHEMA_REGISTRY_VALUE_SUFFIX\n-              ));\n-            default:\n-              break;\n-          }\n-        }\n-      }\n-\n+      maybeThrowSchemaRegistryAuthError(\n+          FormatFactory.fromName(dataSource.getKsqlTopic().getValueFormat().getFormat()),\n+          topicName,\n+          false,\n+          e);\n       LOG.error(\"Could not serialize row.\", e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc2MDg3Ng=="}, "originalCommit": {"oid": "437ef4bf08a9020d23f315306711d8e090e473aa"}, "originalPosition": 47}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2715, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}