{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwOTg0NzA3", "number": 4658, "title": "fix: don't cleanup topics on engine close", "bodyText": "Co-authored-by: Rohan desai.p.rohan@gmail.com\nfixes #4654\nDescription\nSee the description in the ticket above. This makes it so that we don't cleanup topics for persistent queries on closing the engine (but we do for transient).\nTesting done\n\nUnit tests\nManual testing to ensure we can't reproduce the bug.\n\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-02-27T17:41:41Z", "url": "https://github.com/confluentinc/ksql/pull/4658", "merged": true, "mergeCommit": {"oid": "a8ecb72058faf663cf812eb19459375d480c558c"}, "closed": true, "closedAt": "2020-02-27T20:06:51Z", "author": {"login": "agavra"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIe-jOgBqjMwNzg4MTU3Mjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIgX0HgBqjMwNzkxNTMzNzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2721a50a562dbc3b4fb2ff51aaa4f836a48cf48", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/e2721a50a562dbc3b4fb2ff51aaa4f836a48cf48", "committedDate": "2020-02-27T17:39:04Z", "message": "fix: don't cleanup topics on engine close\n\nCo-authored-by: Rohan <desai.p.rohan@gmail.com>"}, "afterCommit": {"oid": "876a543f89d9b47135680f4adc719641fd8dab29", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/876a543f89d9b47135680f4adc719641fd8dab29", "committedDate": "2020-02-27T17:42:50Z", "message": "fix: don't cleanup topics on engine close\n\nCo-authored-by: Rohan <desai.p.rohan@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "876a543f89d9b47135680f4adc719641fd8dab29", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/876a543f89d9b47135680f4adc719641fd8dab29", "committedDate": "2020-02-27T17:42:50Z", "message": "fix: don't cleanup topics on engine close\n\nCo-authored-by: Rohan <desai.p.rohan@gmail.com>"}, "afterCommit": {"oid": "7c7a222a12fcdc10a14fae39e5c7a722a2ab7513", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/7c7a222a12fcdc10a14fae39e5c7a722a2ab7513", "committedDate": "2020-02-27T17:46:11Z", "message": "fix: don't cleanup topics on engine close\n\nCo-authored-by: Rohan <desai.p.rohan@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1ODc1MDA3", "url": "https://github.com/confluentinc/ksql/pull/4658#pullrequestreview-365875007", "createdAt": "2020-02-27T17:56:08Z", "commit": {"oid": "7c7a222a12fcdc10a14fae39e5c7a722a2ab7513"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNzo1NjowOVrOFvbTWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNzo1NjowOVrOFvbTWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3NDcxNA==", "bodyText": "How about?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                verifyNoMoreInteractions(closeCallback);\n          \n          \n            \n                verify(kafkaStreams).close(Duration.ofMillis(closeTimeout));\n          \n          \n            \n                verify(closeCallback, never()).accept(any());\n          \n      \n    \n    \n  \n\nOr add another test that checks ks.close is called on stop.", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385274714", "createdAt": "2020-02-27T17:56:09Z", "author": {"login": "big-andy-coates"}, "path": "ksql-engine/src/test/java/io/confluent/ksql/util/QueryMetadataTest.java", "diffHunk": "@@ -136,6 +137,15 @@ public void shouldCloseKStreamsAppOnCloseThenCloseCallback() {\n     inOrder.verify(closeCallback).accept(query);\n   }\n \n+  @Test\n+  public void shouldNotCallCloseCallbackOnStop() {\n+    // When:\n+    query.stop();\n+\n+    // Then:\n+    verifyNoMoreInteractions(closeCallback);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c7a222a12fcdc10a14fae39e5c7a722a2ab7513"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1ODc2MDc1", "url": "https://github.com/confluentinc/ksql/pull/4658#pullrequestreview-365876075", "createdAt": "2020-02-27T17:57:41Z", "commit": {"oid": "7c7a222a12fcdc10a14fae39e5c7a722a2ab7513"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNzo1Nzo0MVrOFvbW1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNzo1Nzo0MVrOFvbW1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3NTYwNw==", "bodyText": "I'd be tempted to make this abstract and move this impl to PersistentQuery.\nNo biggie, just feels cleaner to me.", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385275607", "createdAt": "2020-02-27T17:57:41Z", "author": {"login": "big-andy-coates"}, "path": "ksql-engine/src/main/java/io/confluent/ksql/util/QueryMetadata.java", "diffHunk": "@@ -169,14 +169,41 @@ public boolean hasEverBeenStarted() {\n     return everStarted;\n   }\n \n-  public void close() {\n+\n+  /**\n+   * Stops the query without cleaning up the external resources\n+   * so that it can be resumed when we call {@link #start()}.\n+   *\n+   * <p>NOTE: {@link TransientQueryMetadata} overrides this method\n+   * since any time a transient query is stopped the external resources\n+   * should be cleaned up.</p>\n+   *\n+   * @see #close()\n+   */\n+  public void stop() {\n+    close(false);\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c7a222a12fcdc10a14fae39e5c7a722a2ab7513"}, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7c7a222a12fcdc10a14fae39e5c7a722a2ab7513", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/7c7a222a12fcdc10a14fae39e5c7a722a2ab7513", "committedDate": "2020-02-27T17:46:11Z", "message": "fix: don't cleanup topics on engine close\n\nCo-authored-by: Rohan <desai.p.rohan@gmail.com>"}, "afterCommit": {"oid": "a6ae256e6e19b62b228e463007e95dde9ca6bbdb", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/a6ae256e6e19b62b228e463007e95dde9ca6bbdb", "committedDate": "2020-02-27T18:08:27Z", "message": "fix: don't cleanup topics on engine close\n\nCo-authored-by: Rohan <desai.p.rohan@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a6ae256e6e19b62b228e463007e95dde9ca6bbdb", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/a6ae256e6e19b62b228e463007e95dde9ca6bbdb", "committedDate": "2020-02-27T18:08:27Z", "message": "fix: don't cleanup topics on engine close\n\nCo-authored-by: Rohan <desai.p.rohan@gmail.com>"}, "afterCommit": {"oid": "de929b12aa00384f5451d34698bc2bd4c73d87f1", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/de929b12aa00384f5451d34698bc2bd4c73d87f1", "committedDate": "2020-02-27T18:08:48Z", "message": "fix: don't cleanup topics on engine close\n\nCo-authored-by: Rohan <desai.p.rohan@gmail.com>\nCo-authored-by: Andy Coates <big-andy-coates@users.noreply.github.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de929b12aa00384f5451d34698bc2bd4c73d87f1", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/de929b12aa00384f5451d34698bc2bd4c73d87f1", "committedDate": "2020-02-27T18:08:48Z", "message": "fix: don't cleanup topics on engine close\n\nCo-authored-by: Rohan <desai.p.rohan@gmail.com>\nCo-authored-by: Andy Coates <big-andy-coates@users.noreply.github.com>"}, "afterCommit": {"oid": "d237f85079583fd3c1f9af72ea2f0cab02240312", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/d237f85079583fd3c1f9af72ea2f0cab02240312", "committedDate": "2020-02-27T18:11:13Z", "message": "fix: don't cleanup topics on engine close\n\nCo-authored-by: Rohan <desai.p.rohan@gmail.com>\nCo-authored-by: Andy Coates <big-andy-coates@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1ODkzMjc0", "url": "https://github.com/confluentinc/ksql/pull/4658#pullrequestreview-365893274", "createdAt": "2020-02-27T18:23:47Z", "commit": {"oid": "d237f85079583fd3c1f9af72ea2f0cab02240312"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoyMzo0N1rOFvcLoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoyMzo0N1rOFvcLoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI4OTEyMQ==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                verify(topicClient, times(0)).deleteInternalTopics(any());\n          \n          \n            \n                verify(topicClient, never()).deleteInternalTopics(any());", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385289121", "createdAt": "2020-02-27T18:23:47Z", "author": {"login": "big-andy-coates"}, "path": "ksql-engine/src/test/java/io/confluent/ksql/engine/KsqlEngineTest.java", "diffHunk": "@@ -676,6 +677,64 @@ public void shouldCleanUpInternalTopicsOnClose() {\n     verify(topicClient).deleteInternalTopics(query.getQueryApplicationId());\n   }\n \n+  @Test\n+  public void shouldCleanUpInternalTopicsOnEngineCloseForTransientQueries() {\n+    // Given:\n+    final QueryMetadata query = KsqlEngineTestUtil.executeQuery(\n+        serviceContext,\n+        ksqlEngine,\n+        \"select * from test1 EMIT CHANGES;\",\n+        KSQL_CONFIG, Collections.emptyMap()\n+    );\n+\n+    query.start();\n+\n+    // When:\n+    ksqlEngine.close();\n+\n+    // Then:\n+    verify(topicClient).deleteInternalTopics(query.getQueryApplicationId());\n+    verifyNoMoreInteractions(topicClient);\n+  }\n+\n+  @Test\n+  public void shouldNotCleanUpInternalTopicsOnEngineCloseForPersistentQueries() {\n+    // Given:\n+    final List<QueryMetadata> query = KsqlEngineTestUtil.execute(\n+        serviceContext,\n+        ksqlEngine,\n+        \"create stream persistent as select * from test1 EMIT CHANGES;\",\n+        KSQL_CONFIG, Collections.emptyMap()\n+    );\n+\n+    query.get(0).start();\n+\n+    // When:\n+    ksqlEngine.close();\n+\n+    // Then (there are no transient queries, so no internal topics should be deleted):\n+    verify(topicClient, times(0)).deleteInternalTopics(any());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d237f85079583fd3c1f9af72ea2f0cab02240312"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1ODk0NDE0", "url": "https://github.com/confluentinc/ksql/pull/4658#pullrequestreview-365894414", "createdAt": "2020-02-27T18:25:28Z", "commit": {"oid": "d237f85079583fd3c1f9af72ea2f0cab02240312"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoyNToyOFrOFvcPIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoyNToyOFrOFvcPIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5MDAxNg==", "bodyText": "nit: not necessary.", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385290016", "createdAt": "2020-02-27T18:25:28Z", "author": {"login": "big-andy-coates"}, "path": "ksql-engine/src/test/java/io/confluent/ksql/engine/KsqlEngineTest.java", "diffHunk": "@@ -676,6 +677,64 @@ public void shouldCleanUpInternalTopicsOnClose() {\n     verify(topicClient).deleteInternalTopics(query.getQueryApplicationId());\n   }\n \n+  @Test\n+  public void shouldCleanUpInternalTopicsOnEngineCloseForTransientQueries() {\n+    // Given:\n+    final QueryMetadata query = KsqlEngineTestUtil.executeQuery(\n+        serviceContext,\n+        ksqlEngine,\n+        \"select * from test1 EMIT CHANGES;\",\n+        KSQL_CONFIG, Collections.emptyMap()\n+    );\n+\n+    query.start();\n+\n+    // When:\n+    ksqlEngine.close();\n+\n+    // Then:\n+    verify(topicClient).deleteInternalTopics(query.getQueryApplicationId());\n+    verifyNoMoreInteractions(topicClient);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d237f85079583fd3c1f9af72ea2f0cab02240312"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1ODk0ODE5", "url": "https://github.com/confluentinc/ksql/pull/4658#pullrequestreview-365894819", "createdAt": "2020-02-27T18:26:05Z", "commit": {"oid": "d237f85079583fd3c1f9af72ea2f0cab02240312"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoyNjowNVrOFvcQcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoyNjowNVrOFvcQcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5MDM1Mg==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                verify(kafkaStreams, times(0)).cleanUp();\n          \n          \n            \n                verify(kafkaStreams, never()).cleanUp();", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385290352", "createdAt": "2020-02-27T18:26:05Z", "author": {"login": "big-andy-coates"}, "path": "ksql-engine/src/test/java/io/confluent/ksql/util/QueryMetadataTest.java", "diffHunk": "@@ -147,6 +167,15 @@ public void shouldCleanUpKStreamsAppAfterCloseOnClose() {\n     inOrder.verify(kafkaStreams).cleanUp();\n   }\n \n+  @Test\n+  public void shouldNotCleanUpKStreamsAppOnStop() {\n+    // When:\n+    query.stop();\n+\n+    // Then:\n+    verify(kafkaStreams, times(0)).cleanUp();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d237f85079583fd3c1f9af72ea2f0cab02240312"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1ODk1MDc3", "url": "https://github.com/confluentinc/ksql/pull/4658#pullrequestreview-365895077", "createdAt": "2020-02-27T18:26:27Z", "commit": {"oid": "d237f85079583fd3c1f9af72ea2f0cab02240312"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoyNjoyN1rOFvcROQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoyNjoyN1rOFvcROQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5MDU1Mw==", "bodyText": "If the order is important, then I'd test the order too...", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385290553", "createdAt": "2020-02-27T18:26:27Z", "author": {"login": "big-andy-coates"}, "path": "ksql-engine/src/test/java/io/confluent/ksql/util/TransientQueryMetadataTest.java", "diffHunk": "@@ -87,4 +88,22 @@ public void shouldCloseQueueBeforeTopologyToAvoidDeadLock() {\n     inOrder.verify(rowQueue).close();\n     inOrder.verify(kafkaStreams).close(any());\n   }\n+\n+  @Test\n+  public void shouldCleanupOnStop() {\n+    // When:\n+    query.stop();\n+\n+    // Then:\n+    verify(kafkaStreams).close(any());\n+  }\n+\n+  @Test\n+  public void shouldCallCallbackOnStop() {\n+    // When:\n+    query.stop();\n+\n+    // Then:\n+    verify(closeCallback).accept(query);\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d237f85079583fd3c1f9af72ea2f0cab02240312"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1ODk1MTk1", "url": "https://github.com/confluentinc/ksql/pull/4658#pullrequestreview-365895195", "createdAt": "2020-02-27T18:26:37Z", "commit": {"oid": "d237f85079583fd3c1f9af72ea2f0cab02240312"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b52acefa514182556c7ea1ee3d85d5fa6ff75fc", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/0b52acefa514182556c7ea1ee3d85d5fa6ff75fc", "committedDate": "2020-02-27T18:30:15Z", "message": "fix: don't cleanup topics on engine close\n\nCo-authored-by: Rohan <desai.p.rohan@gmail.com>\nCo-authored-by: Andy Coates <big-andy-coates@users.noreply.github.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d237f85079583fd3c1f9af72ea2f0cab02240312", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/d237f85079583fd3c1f9af72ea2f0cab02240312", "committedDate": "2020-02-27T18:11:13Z", "message": "fix: don't cleanup topics on engine close\n\nCo-authored-by: Rohan <desai.p.rohan@gmail.com>\nCo-authored-by: Andy Coates <big-andy-coates@users.noreply.github.com>"}, "afterCommit": {"oid": "0b52acefa514182556c7ea1ee3d85d5fa6ff75fc", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/0b52acefa514182556c7ea1ee3d85d5fa6ff75fc", "committedDate": "2020-02-27T18:30:15Z", "message": "fix: don't cleanup topics on engine close\n\nCo-authored-by: Rohan <desai.p.rohan@gmail.com>\nCo-authored-by: Andy Coates <big-andy-coates@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f52591d832c91c97907a60fe21362596958851b2", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/f52591d832c91c97907a60fe21362596958851b2", "committedDate": "2020-02-27T19:20:19Z", "message": "chore: make QMD abstract"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7dfb7223d4c6d89da6d7be0690d0265b411e1304", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/7dfb7223d4c6d89da6d7be0690d0265b411e1304", "committedDate": "2020-02-27T19:10:35Z", "message": "chore: make QMD abstract"}, "afterCommit": {"oid": "f52591d832c91c97907a60fe21362596958851b2", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/f52591d832c91c97907a60fe21362596958851b2", "committedDate": "2020-02-27T19:20:19Z", "message": "chore: make QMD abstract"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4889, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}