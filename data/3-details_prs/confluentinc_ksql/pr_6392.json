{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNTc2NzI2", "number": 6392, "title": "chore: partition by null should set key format to NONE", "bodyText": "Description\nfixes: #6391\nTesting done\nUsual\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-10-09T13:05:55Z", "url": "https://github.com/confluentinc/ksql/pull/6392", "merged": true, "mergeCommit": {"oid": "7005fb7ea7b298d750ba63aad6bfc8aeecd07b3d"}, "closed": true, "closedAt": "2020-10-13T12:02:09Z", "author": {"login": "big-andy-coates"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQ13PoAH2gAyNTAwNTc2NzI2OmQ1ZWE3ZDE3YzU4MWNkOTg4Y2M4Y2VlOWIwMGE3NmRkMGQ1MzAwMjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSFlYvAH2gAyNTAwNTc2NzI2OjNiMzdlNjhkOTdhY2Q4OWNiMzczNWVhOWRjZTQ3NTg0M2NiY2M2MzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d5ea7d17c581cd988cc8cee9b00a76dd0d530021", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/d5ea7d17c581cd988cc8cee9b00a76dd0d530021", "committedDate": "2020-10-09T13:05:20Z", "message": "chore: partition by null should set key format to NONE\n\nfixes: https://github.com/confluentinc/ksql/issues/6391"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NjY2Nzc3", "url": "https://github.com/confluentinc/ksql/pull/6392#pullrequestreview-505666777", "createdAt": "2020-10-09T13:21:57Z", "commit": {"oid": "d5ea7d17c581cd988cc8cee9b00a76dd0d530021"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1ODAzNzc2", "url": "https://github.com/confluentinc/ksql/pull/6392#pullrequestreview-505803776", "createdAt": "2020-10-09T15:59:04Z", "commit": {"oid": "d5ea7d17c581cd988cc8cee9b00a76dd0d530021"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNTo1OTowNFrOHfP2_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNTo1OTo0M1rOHfP4mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUyNzc0MQ==", "bodyText": "did you mean to return here?", "url": "https://github.com/confluentinc/ksql/pull/6392#discussion_r502527741", "createdAt": "2020-10-09T15:59:04Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/Analyzer.java", "diffHunk": "@@ -189,6 +191,30 @@ private void analyzeNonStdOutSink(final Sink sink) {\n           .setInto(Into.newSink(sink.getName(), topicName, windowInfo, keyFmtInfo, valueFmtInfo));\n     }\n \n+    private FormatInfo buildKeyFormatInfo(\n+        final Optional<String> explicitFormat,\n+        final Map<String, String> formatProperties,\n+        final FormatInfo sourceFormat\n+    ) {\n+      final boolean partitioningByNull = analysis.getPartitionBy()\n+          .map(pb -> pb.getExpression() instanceof NullLiteral)\n+          .orElse(false);\n+\n+      if (partitioningByNull) {\n+        final boolean nonNoneExplicitFormat = explicitFormat\n+            .map(fmt -> !fmt.equalsIgnoreCase(NoneFormat.NAME))\n+            .orElse(false);\n+\n+        if (nonNoneExplicitFormat) {\n+          throw new KsqlException(\"Key format specified for stream without key columns.\");\n+        }\n+\n+        FormatInfo.of(NoneFormat.NAME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5ea7d17c581cd988cc8cee9b00a76dd0d530021"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUyODE1NQ==", "bodyText": "why is this an error? can't I have null keys with non-NONE formats?", "url": "https://github.com/confluentinc/ksql/pull/6392#discussion_r502528155", "createdAt": "2020-10-09T15:59:43Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/Analyzer.java", "diffHunk": "@@ -189,6 +191,30 @@ private void analyzeNonStdOutSink(final Sink sink) {\n           .setInto(Into.newSink(sink.getName(), topicName, windowInfo, keyFmtInfo, valueFmtInfo));\n     }\n \n+    private FormatInfo buildKeyFormatInfo(\n+        final Optional<String> explicitFormat,\n+        final Map<String, String> formatProperties,\n+        final FormatInfo sourceFormat\n+    ) {\n+      final boolean partitioningByNull = analysis.getPartitionBy()\n+          .map(pb -> pb.getExpression() instanceof NullLiteral)\n+          .orElse(false);\n+\n+      if (partitioningByNull) {\n+        final boolean nonNoneExplicitFormat = explicitFormat\n+            .map(fmt -> !fmt.equalsIgnoreCase(NoneFormat.NAME))\n+            .orElse(false);\n+\n+        if (nonNoneExplicitFormat) {\n+          throw new KsqlException(\"Key format specified for stream without key columns.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5ea7d17c581cd988cc8cee9b00a76dd0d530021"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "188841abead7a427d1f44abb816d3554962f9082", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/188841abead7a427d1f44abb816d3554962f9082", "committedDate": "2020-10-12T11:24:49Z", "message": "Merge branch 'master' into partition_by_null"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc628e7cf2253e7f9fccbf0f75aba0017684b332", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/cc628e7cf2253e7f9fccbf0f75aba0017684b332", "committedDate": "2020-10-12T20:13:39Z", "message": "Merge branch 'master' into partition_by_null"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68c16ba5b72267dc4834b108f84685d70ae7905d", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/68c16ba5b72267dc4834b108f84685d70ae7905d", "committedDate": "2020-10-12T20:19:29Z", "message": "chore: requested changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef75343d900eb075f0e0634a3ae3c570e2caed20", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/ef75343d900eb075f0e0634a3ae3c570e2caed20", "committedDate": "2020-10-13T09:57:52Z", "message": "test: historic plans"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b37e68d97acd89cb3735ea9dce475843cbcc630", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/3b37e68d97acd89cb3735ea9dce475843cbcc630", "committedDate": "2020-10-13T09:58:14Z", "message": "Merge branch 'master' into partition_by_null"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4998, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}