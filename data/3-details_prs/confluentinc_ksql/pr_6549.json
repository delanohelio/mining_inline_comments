{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyNzE1OTcz", "number": 6549, "title": "build: st-4518 Fix release script to work with changes made from nano versioning. still using beta artifacts.", "bodyText": "Description\nThe ksqldb release build broke due to the nano versioning changes. This does not change the ksqldb release build to use nano versioned artifacts so it will continue to use beta artifacts. That is a separate project coming soon.\nThe build was failing because when it runs the maven plugins it loads the pom file first and that was failing because it couldn't find the nano versioned artifacts which the parent pom is set to use. Since this repo is pointing at the maven repo with the beta artifacts and not the repo with the nano versioned artifacts it does not find them.\nI fixed this by doing a find and replace of the parent version specified in the parent pom file instead of using the maven plugin. Once that is done the pom file should be able to load successfully and the other plugins we run should work. I removed the call to the plugin we had which was setting the parent version before.\nThere are also two new properties introduced with nano versioning that we also need to set now, and I added two calls the maven set-property plugin to update those. One is the schema registry version property which tells the project which version of that to use, which is set to the beta version. The other property is similar to the project.version so we set that to the ksqldb version we are building.\nI also had to update the beta version that was being used because the version that is currently is used is old and does not contain the nano versioning changes which the latest version of the ksql code expect since it has the nano versioning changes. I updated it to the latest version of 6.1.0 instead of jumping to 6.2.0\nTesting done\nI tested the regex locally by running it from a groovy script and then doing a diff of the file to make sure it only changed what it was supposed to. All of the changes I made to this script get run through during the PR build so it should be all set. The only additional step that is done when it is not a PR build is to tag the repo and upload the artifacts. I don't think any of the changes made from the nano versioning roll out will affect those steps though.\nI am going to be on vacation starting tomorrow 10/30 and all of next week so I will not be around to support this, but some one else on the team should be available to merge this for and help out with any bugs. We can also test this out by doing a replay of the Jenkins build that was being done when we encountered this bug.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-10-30T02:27:03Z", "url": "https://github.com/confluentinc/ksql/pull/6549", "merged": true, "mergeCommit": {"oid": "9b9d03359bd7841a5fcfb865a51cda73a18f0290"}, "closed": true, "closedAt": "2021-01-05T18:32:00Z", "author": {"login": "elismaga"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXddr_ABqjM5MzkyMTQxMjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtPRnvgH2gAyNTEyNzE1OTczOjU5MDA1NmM2ZmE1MTQxODAyMmRjYTRjYjMyZmVlMGYyZDc2OTJmMDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c75c2378460fdae64e94d806d7967450e325f7c", "author": {"user": {"login": "elismaga", "name": null}}, "url": "https://github.com/confluentinc/ksql/commit/5c75c2378460fdae64e94d806d7967450e325f7c", "committedDate": "2020-10-30T02:19:04Z", "message": "build: st-4518 Fix release script to work with changes made from nano versioning. still using beta artifacts."}, "afterCommit": {"oid": "b51425c0bf5b5354af18e5f3b876ef2f571be815", "author": {"user": {"login": "elismaga", "name": null}}, "url": "https://github.com/confluentinc/ksql/commit/b51425c0bf5b5354af18e5f3b876ef2f571be815", "committedDate": "2020-10-30T02:37:03Z", "message": "build: st-4518 Fix release script to work with changes made from nano versioning. still using beta artifacts."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64d36a0f284c83efc0ee47778a179f67ff8164b0", "author": {"user": {"login": "elismaga", "name": null}}, "url": "https://github.com/confluentinc/ksql/commit/64d36a0f284c83efc0ee47778a179f67ff8164b0", "committedDate": "2020-10-30T02:45:00Z", "message": "build: st-4518 Fix release script to work with changes made from nano versioning. still using beta artifacts."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b51425c0bf5b5354af18e5f3b876ef2f571be815", "author": {"user": {"login": "elismaga", "name": null}}, "url": "https://github.com/confluentinc/ksql/commit/b51425c0bf5b5354af18e5f3b876ef2f571be815", "committedDate": "2020-10-30T02:37:03Z", "message": "build: st-4518 Fix release script to work with changes made from nano versioning. still using beta artifacts."}, "afterCommit": {"oid": "64d36a0f284c83efc0ee47778a179f67ff8164b0", "author": {"user": {"login": "elismaga", "name": null}}, "url": "https://github.com/confluentinc/ksql/commit/64d36a0f284c83efc0ee47778a179f67ff8164b0", "committedDate": "2020-10-30T02:45:00Z", "message": "build: st-4518 Fix release script to work with changes made from nano versioning. still using beta artifacts."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNzYzOTAz", "url": "https://github.com/confluentinc/ksql/pull/6549#pullrequestreview-520763903", "createdAt": "2020-10-30T15:11:49Z", "commit": {"oid": "64d36a0f284c83efc0ee47778a179f67ff8164b0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNToxMTo0OVrOHrTelQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNToxMTo0OVrOHrTelQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE2OTk0MQ==", "bodyText": "def newPomFile = pomFile.replaceFirst(parentVersionPattern, \"\\$1${config.cp_version}\\$2\")\n\nIs the \\$1 groovy syntax to reference matched groups?", "url": "https://github.com/confluentinc/ksql/pull/6549#discussion_r515169941", "createdAt": "2020-10-30T15:11:49Z", "author": {"login": "andrewegel"}, "path": "Jenkinsfile", "diffHunk": "@@ -208,12 +210,22 @@ def job = {\n                                 sh \"docker pull ${config.dockerRegistry}${dockerRepo}:${config.cp_version}-latest\"\n                             }\n \n+                            // We need to replace the parent version range before we can run any maven commands\n+                            def pomFile = readFile('pom.xml')\n+                            def parentVersionPattern = Pattern.compile(/(.*<parent>.*<groupId>io.confluent\\S*<\\/groupId>.*<version>)\\[\\d+\\.\\d+\\.\\d+-\\d+\\,\\s+\\d+\\.\\d+\\.\\d+-\\d+\\)(<\\/version>.*<\\/parent>.*)/, Pattern.DOTALL)\n+                            // Groovy regex replaces the groups we didn't match, so we print the beginning of the file, our version, and the rest of the file.\n+                            def newPomFile = pomFile.replaceFirst(parentVersionPattern, \"\\$1${config.cp_version}\\$2\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64d36a0f284c83efc0ee47778a179f67ff8164b0"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNzY0OTYz", "url": "https://github.com/confluentinc/ksql/pull/6549#pullrequestreview-520764963", "createdAt": "2020-10-30T15:13:00Z", "commit": {"oid": "64d36a0f284c83efc0ee47778a179f67ff8164b0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNToxMzowMFrOHrThfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNToxMzowMFrOHrThfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE3MDY4Ng==", "bodyText": "I think somewhere else in this Jenkinsfile we mark the root pom as an artifact, since we're re-writing it here, should we mark that as the artifact?", "url": "https://github.com/confluentinc/ksql/pull/6549#discussion_r515170686", "createdAt": "2020-10-30T15:13:00Z", "author": {"login": "andrewegel"}, "path": "Jenkinsfile", "diffHunk": "@@ -208,12 +210,22 @@ def job = {\n                                 sh \"docker pull ${config.dockerRegistry}${dockerRepo}:${config.cp_version}-latest\"\n                             }\n \n+                            // We need to replace the parent version range before we can run any maven commands\n+                            def pomFile = readFile('pom.xml')\n+                            def parentVersionPattern = Pattern.compile(/(.*<parent>.*<groupId>io.confluent\\S*<\\/groupId>.*<version>)\\[\\d+\\.\\d+\\.\\d+-\\d+\\,\\s+\\d+\\.\\d+\\.\\d+-\\d+\\)(<\\/version>.*<\\/parent>.*)/, Pattern.DOTALL)\n+                            // Groovy regex replaces the groups we didn't match, so we print the beginning of the file, our version, and the rest of the file.\n+                            def newPomFile = pomFile.replaceFirst(parentVersionPattern, \"\\$1${config.cp_version}\\$2\")\n+                            writeFile(file: 'pom.xml', text: newPomFile)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64d36a0f284c83efc0ee47778a179f67ff8164b0"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNzY1NTYx", "url": "https://github.com/confluentinc/ksql/pull/6549#pullrequestreview-520765561", "createdAt": "2020-10-30T15:13:39Z", "commit": {"oid": "64d36a0f284c83efc0ee47778a179f67ff8164b0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNToxMzozOVrOHrTjMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNToxMzozOVrOHrTjMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE3MTEyMw==", "bodyText": "I wonder if we should be factoring this out into function jenkins-common?", "url": "https://github.com/confluentinc/ksql/pull/6549#discussion_r515171123", "createdAt": "2020-10-30T15:13:39Z", "author": {"login": "andrewegel"}, "path": "Jenkinsfile", "diffHunk": "@@ -208,12 +210,22 @@ def job = {\n                                 sh \"docker pull ${config.dockerRegistry}${dockerRepo}:${config.cp_version}-latest\"\n                             }\n \n+                            // We need to replace the parent version range before we can run any maven commands\n+                            def pomFile = readFile('pom.xml')\n+                            def parentVersionPattern = Pattern.compile(/(.*<parent>.*<groupId>io.confluent\\S*<\\/groupId>.*<version>)\\[\\d+\\.\\d+\\.\\d+-\\d+\\,\\s+\\d+\\.\\d+\\.\\d+-\\d+\\)(<\\/version>.*<\\/parent>.*)/, Pattern.DOTALL)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64d36a0f284c83efc0ee47778a179f67ff8164b0"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNzY1ODY0", "url": "https://github.com/confluentinc/ksql/pull/6549#pullrequestreview-520765864", "createdAt": "2020-10-30T15:13:59Z", "commit": {"oid": "64d36a0f284c83efc0ee47778a179f67ff8164b0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwODU0NjM4", "url": "https://github.com/confluentinc/ksql/pull/6549#pullrequestreview-520854638", "createdAt": "2020-10-30T16:52:33Z", "commit": {"oid": "64d36a0f284c83efc0ee47778a179f67ff8164b0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjo1MjozM1rOHrXnlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjo1MjozM1rOHrXnlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIzNzc4Mg==", "bodyText": "Hey @elismaga (and the rest of the tools team since Eli is OOO), this version bump is a problem for us since the previous version 6.1.0-beta201006024150 has been qualified for our release, but not this new one. Do we have options to release with the old version?", "url": "https://github.com/confluentinc/ksql/pull/6549#discussion_r515237782", "createdAt": "2020-10-30T16:52:33Z", "author": {"login": "vcrfxia"}, "path": "Jenkinsfile", "diffHunk": "@@ -1,8 +1,10 @@\n+import java.util.regex.Pattern\n+\n def baseConfig = {\n     owner = 'ksql'\n     slackChannel = '#ksql-alerts'\n     ksql_db_version = \"0.14.0\"  // next version to be released\n-    cp_version = \"6.1.0-beta201006024150\"  // must be a beta version from the packaging build\n+    cp_version = \"6.1.0-beta201020194508\"  // must be a beta version from the packaging build", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64d36a0f284c83efc0ee47778a179f67ff8164b0"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f69708300fcdc74636222228558951eef21f5d9", "author": {"user": {"login": "rodesai", "name": "Rohan"}}, "url": "https://github.com/confluentinc/ksql/commit/6f69708300fcdc74636222228558951eef21f5d9", "committedDate": "2021-01-05T18:30:36Z", "message": "set cp version to version for 0.15"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "590056c6fa51418022dca4cb32fee0f2d7692f04", "author": {"user": {"login": "rodesai", "name": "Rohan"}}, "url": "https://github.com/confluentinc/ksql/commit/590056c6fa51418022dca4cb32fee0f2d7692f04", "committedDate": "2021-01-05T18:31:39Z", "message": "Merge branch 'ksql-db-release' into ksql_release_nano_with_beta_fix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4599, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}