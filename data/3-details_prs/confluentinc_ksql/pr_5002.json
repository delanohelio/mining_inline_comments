{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5NTg2OTIy", "number": 5002, "title": "feat: speed up restarts by not building topologies for terminated queries", "bodyText": "Description\nfixes: #4923\nPreviously, on a restart, each ksqlDB node would build a query topology for each previously submitted persistent queries, i.e. CREATE TABLE AS SELECT, CREATE STREAM AS SELECT or INSERT INTO statement, even if the associated query has already been terminated.\nBuilding the query topology takes a reasonable amount of time. By avoiding building these topologies for terminated queries the restart time will be much reduced for clusters with a lot of historic commands in the command topic.\nA more complete solution to this problem is to move to a compacted topic for storing commands: #4659\nTesting done\nUsual.\nReviewing notes:\nI didn't take the approach suggested in #4923 by @rodesai :\n\nthe fix should be simple - just store a Supplier instead of KafkaStreams in QueryMetadata and only get it from start()\n\nIMHO, such an approach would:\n\nComplicate the QueryMetadata type unnecessarily.\nBe very hard to test that the topologies weren't being built, e.g. in RecoveryTest.\nBrittle: a regression could easily be introduced if someone were to add code in the recovery processes that called any getting on QueryMetadata that caused the supplied to be invoked.\n\nHence, I went with a different approach: to compact the list of commands to be restored. This compaction searches through the list of commands, keeping track of any commands that start a persistent query. If it later finds a terminate for that query, it removes the terminate and updates the originating command to no longer start a persistent query.\nTBH, I don't really like either fix, but it serves a purpose in the short term until we have a better solution, i.e. #4659\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-04-06T11:46:21Z", "url": "https://github.com/confluentinc/ksql/pull/5002", "merged": true, "mergeCommit": {"oid": "24723824635e7ca175bc5be1fbf6a415010b00bb"}, "closed": true, "closedAt": "2020-04-08T17:24:10Z", "author": {"login": "big-andy-coates"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcU9JKVgH2gAyMzk5NTg2OTIyOjY3MzBhMTFjNzhiOTNkMTY4YTdiMDA5OTA5MDFjY2I5ZTgwMDdmNzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVVcK2AFqTM4OTI1OTg1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6730a11c78b93d168a7b00990901ccb9e8007f72", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/6730a11c78b93d168a7b00990901ccb9e8007f72", "committedDate": "2020-04-06T11:38:47Z", "message": "feat: speed up restarts by not building topologies for terminated queries\n\nfixes: https://github.com/confluentinc/ksql/issues/4923\n\nPreviously, on a restart, each ksqlDB node would build a query topology for each previously submitted persistent queries, i.e. CREATE TABLE AS SELECT, CREATE STREAM AS SELECT or INSERT INTO statement, _even if the associated query has already been terminated_.\n\nBuilding the query topology takes a reasonable amount of time. By avoiding building these topologies for terminated queries the restart time will be much reduced for clusters with a lot of historic commands in the command topic.\n\nA more complete solution to this problem is to move to a compacted topic for storing commands: https://github.com/confluentinc/ksql/pull/4659"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "632b2ab7a7cd42b4485db9f07a1763cde466d133", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/632b2ab7a7cd42b4485db9f07a1763cde466d133", "committedDate": "2020-04-06T12:28:13Z", "message": "chore: handle INSERT INTO queries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f116df722d83e6a14d6a77159ca7a2de9d0d2fce", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/f116df722d83e6a14d6a77159ca7a2de9d0d2fce", "committedDate": "2020-04-06T13:41:40Z", "message": "chore: fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NDI2OTU3", "url": "https://github.com/confluentinc/ksql/pull/5002#pullrequestreview-388426957", "createdAt": "2020-04-06T16:38:54Z", "commit": {"oid": "f116df722d83e6a14d6a77159ca7a2de9d0d2fce"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNjozODo1NFrOGBgaSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNjozODo1NFrOGBgaSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIzMjc3OQ==", "bodyText": "this feels needlessly complicated (in place modification using the iterator is really hard for me to follow as I need to track which source collection is being modified and used where). Can we simplify it by having a first pass just collect the index of terminated queries and the terminate commands in restoreCommands and then have a second pass that just copies the ones we need (modifying the ones that need to be modified) into a new list?\nThat would also obviate the need for using IdentityHashMap as we're using the index in the list to uniquely identify a command.", "url": "https://github.com/confluentinc/ksql/pull/5002#discussion_r404232779", "createdAt": "2020-04-06T16:38:54Z", "author": {"login": "agavra"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/RestoreCommandsCompactor.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.rest.server.computation;\n+\n+import io.confluent.ksql.engine.KsqlPlan;\n+import io.confluent.ksql.query.QueryId;\n+import io.confluent.ksql.rest.entity.CommandId.Type;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.IdentityHashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.ListIterator;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+/**\n+ * Util for compacting the restore commands\n+ */\n+public final class RestoreCommandsCompactor {\n+\n+  private RestoreCommandsCompactor() {\n+  }\n+\n+  /**\n+   * Compact the list of commands to restore.\n+   *\n+   * <p>Finds any command's whose queries plans that are later terminated. Any such commands have\n+   * their query plan and associated terminate command removed.\n+   *\n+   * <p>This compaction stops unnecessary creation of Streams topologies on a server restart.\n+   * Building such topologies is relatively slow and best avoided.\n+   *\n+   * @param restoreCommands the list of commands to compact.\n+   * @return the compacted list of commands.\n+   */\n+  static List<QueuedCommand> compact(final List<QueuedCommand> restoreCommands) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f116df722d83e6a14d6a77159ca7a2de9d0d2fce"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NTg5MjI4", "url": "https://github.com/confluentinc/ksql/pull/5002#pullrequestreview-388589228", "createdAt": "2020-04-06T20:24:14Z", "commit": {"oid": "f116df722d83e6a14d6a77159ca7a2de9d0d2fce"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMDoyNDoxNFrOGBof5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMDozMzozMVrOGBo0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM2NTI4NQ==", "bodyText": "probably better to use a linked list here since we're removing random elements", "url": "https://github.com/confluentinc/ksql/pull/5002#discussion_r404365285", "createdAt": "2020-04-06T20:24:14Z", "author": {"login": "rodesai"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/RestoreCommandsCompactor.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.rest.server.computation;\n+\n+import io.confluent.ksql.engine.KsqlPlan;\n+import io.confluent.ksql.query.QueryId;\n+import io.confluent.ksql.rest.entity.CommandId.Type;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.IdentityHashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.ListIterator;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+/**\n+ * Util for compacting the restore commands\n+ */\n+public final class RestoreCommandsCompactor {\n+\n+  private RestoreCommandsCompactor() {\n+  }\n+\n+  /**\n+   * Compact the list of commands to restore.\n+   *\n+   * <p>Finds any command's whose queries plans that are later terminated. Any such commands have\n+   * their query plan and associated terminate command removed.\n+   *\n+   * <p>This compaction stops unnecessary creation of Streams topologies on a server restart.\n+   * Building such topologies is relatively slow and best avoided.\n+   *\n+   * @param restoreCommands the list of commands to compact.\n+   * @return the compacted list of commands.\n+   */\n+  static List<QueuedCommand> compact(final List<QueuedCommand> restoreCommands) {\n+    final List<QueuedCommand> compacted = new ArrayList<>(restoreCommands);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f116df722d83e6a14d6a77159ca7a2de9d0d2fce"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM3MDQ4NA==", "bodyText": "This loop could be simplified. We now run a protocol to ensure that no invalid commands get enqueued, so you can assume all terminates are valid.", "url": "https://github.com/confluentinc/ksql/pull/5002#discussion_r404370484", "createdAt": "2020-04-06T20:33:31Z", "author": {"login": "rodesai"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/RestoreCommandsCompactor.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.rest.server.computation;\n+\n+import io.confluent.ksql.engine.KsqlPlan;\n+import io.confluent.ksql.query.QueryId;\n+import io.confluent.ksql.rest.entity.CommandId.Type;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.IdentityHashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.ListIterator;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+\n+/**\n+ * Util for compacting the restore commands\n+ */\n+public final class RestoreCommandsCompactor {\n+\n+  private RestoreCommandsCompactor() {\n+  }\n+\n+  /**\n+   * Compact the list of commands to restore.\n+   *\n+   * <p>Finds any command's whose queries plans that are later terminated. Any such commands have\n+   * their query plan and associated terminate command removed.\n+   *\n+   * <p>This compaction stops unnecessary creation of Streams topologies on a server restart.\n+   * Building such topologies is relatively slow and best avoided.\n+   *\n+   * @param restoreCommands the list of commands to compact.\n+   * @return the compacted list of commands.\n+   */\n+  static List<QueuedCommand> compact(final List<QueuedCommand> restoreCommands) {\n+    final List<QueuedCommand> compacted = new ArrayList<>(restoreCommands);\n+\n+    final Set<QueuedCommand> terminatedQueries =\n+        findTerminatedQueriesAndRemoveTerminateCommands(compacted);\n+\n+    removeQueryPlansOfTerminated(compacted, terminatedQueries);\n+\n+    return compacted;\n+  }\n+\n+  private static Set<QueuedCommand> findTerminatedQueriesAndRemoveTerminateCommands(\n+      final List<QueuedCommand> commands\n+  ) {\n+    final Map<QueryId, QueuedCommand> queries = new HashMap<>();\n+    final Set<QueuedCommand> terminatedQueries = Collections.newSetFromMap(new IdentityHashMap<>());\n+\n+    final Iterator<QueuedCommand> it = commands.iterator();\n+    while (it.hasNext()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f116df722d83e6a14d6a77159ca7a2de9d0d2fce"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a56b9a4b61c4028548df4d9fd15eacfa73be379", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/8a56b9a4b61c4028548df4d9fd15eacfa73be379", "committedDate": "2020-04-07T10:23:53Z", "message": "chore: rohan's requested changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MjE3MTA2", "url": "https://github.com/confluentinc/ksql/pull/5002#pullrequestreview-389217106", "createdAt": "2020-04-07T15:12:24Z", "commit": {"oid": "8a56b9a4b61c4028548df4d9fd15eacfa73be379"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MjU5ODUz", "url": "https://github.com/confluentinc/ksql/pull/5002#pullrequestreview-389259853", "createdAt": "2020-04-07T15:57:16Z", "commit": {"oid": "8a56b9a4b61c4028548df4d9fd15eacfa73be379"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4988, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}