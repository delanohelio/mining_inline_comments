{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1OTg2OTkz", "number": 5874, "title": "fix: change default grace period to zero", "bodyText": "Description\nWhat behavior do you want to change, why, how does your patch achieve the changes?\nWhen EMIT FINAL is used appropriately on a windowed aggregation, but no grace period specified, the previous behavior made the default grace period to be 24h. This patch changes this default to 0.\nTesting done\nDescribe the testing strategy. Unit and integration tests are expected for any behavior changes.\nCreated RewrittenAnalysisTest and added relevant unit tests\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-07-23T22:40:15Z", "url": "https://github.com/confluentinc/ksql/pull/5874", "merged": true, "mergeCommit": {"oid": "7e841ed5112800ced86ee19ce5be66c1ac966ee4"}, "closed": true, "closedAt": "2020-07-27T16:28:46Z", "author": {"login": "nae701"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc302EJAH2gAyNDU1OTg2OTkzOmRhOTNlMGQxODYxM2NjY2IyMGNlMzE1OTc2NTNhOWE3ZjkzZWVlMzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5DU_6gFqTQ1NTg3NzgyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "da93e0d18613cccb20ce31597653a9a7f93eee37", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/da93e0d18613cccb20ce31597653a9a7f93eee37", "committedDate": "2020-07-23T19:46:02Z", "message": "chore: switching to suppress branch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe6b04e410b34f2f291ab50d3fc6a30c48487016", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/fe6b04e410b34f2f291ab50d3fc6a30c48487016", "committedDate": "2020-07-23T21:47:56Z", "message": "fix: change default grace period to zero"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NTU0MjEz", "url": "https://github.com/confluentinc/ksql/pull/5874#pullrequestreview-454554213", "createdAt": "2020-07-23T23:11:25Z", "commit": {"oid": "fe6b04e410b34f2f291ab50d3fc6a30c48487016"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMzoxMToyNVrOG2elhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMzoxMjoxOFrOG2emlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3NzQxMg==", "bodyText": "nit: I think this code would be easier to read if we had:\nif (!original.getRefinementInfo().isPresent || !original.getWindowExpression().isPresent()) {\n  return original.getWindowExpression();\n}\n\nRefinementInfo refinement = optional.get();\nWindowExpression window = optional.get();\n...", "url": "https://github.com/confluentinc/ksql/pull/5874#discussion_r459777412", "createdAt": "2020-07-23T23:11:25Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/RewrittenAnalysis.java", "diffHunk": "@@ -113,7 +123,49 @@ public ImmutableAnalysis original() {\n \n   @Override\n   public Optional<WindowExpression> getWindowExpression() {\n-    return original.getWindowExpression();\n+    if (original.getRefinementInfo().isPresent()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe6b04e410b34f2f291ab50d3fc6a30c48487016"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3NzY4Nw==", "bodyText": "nit: can be static final", "url": "https://github.com/confluentinc/ksql/pull/5874#discussion_r459777687", "createdAt": "2020-07-23T23:12:18Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/RewrittenAnalysis.java", "diffHunk": "@@ -113,7 +123,49 @@ public ImmutableAnalysis original() {\n \n   @Override\n   public Optional<WindowExpression> getWindowExpression() {\n-    return original.getWindowExpression();\n+    if (original.getRefinementInfo().isPresent()\n+        && original.getRefinementInfo().get().getOutputRefinement() == OutputRefinement.FINAL\n+        && !original.getWindowExpression().get()\n+        .getKsqlWindowExpression().getGracePeriod().isPresent()) {\n+      final KsqlWindowExpression ksqlWindowNew;\n+      final KsqlWindowExpression ksqlWindowOld =\n+          original.getWindowExpression().get().getKsqlWindowExpression();\n+      final WindowTimeClause zeroGracePeriod = new WindowTimeClause(0L, TimeUnit.MILLISECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe6b04e410b34f2f291ab50d3fc6a30c48487016"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NTU5NjIw", "url": "https://github.com/confluentinc/ksql/pull/5874#pullrequestreview-454559620", "createdAt": "2020-07-23T23:27:05Z", "commit": {"oid": "fe6b04e410b34f2f291ab50d3fc6a30c48487016"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMzoyNzowNlrOG2e4Nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMzoyNzowNlrOG2e4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc4MjE5OQ==", "bodyText": "nit: we're not checking isPresent here, which I think is causing https://jenkins.confluent.io/job/confluentinc-pr/job/ksql/job/PR-5874/1/testReport/junit/io.confluent.ksql.planner/LogicalPlannerTest/shouldThrowOnNonWindowedAggregationSuppressions/ to fail", "url": "https://github.com/confluentinc/ksql/pull/5874#discussion_r459782199", "createdAt": "2020-07-23T23:27:06Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/RewrittenAnalysis.java", "diffHunk": "@@ -113,7 +123,49 @@ public ImmutableAnalysis original() {\n \n   @Override\n   public Optional<WindowExpression> getWindowExpression() {\n-    return original.getWindowExpression();\n+    if (original.getRefinementInfo().isPresent()\n+        && original.getRefinementInfo().get().getOutputRefinement() == OutputRefinement.FINAL\n+        && !original.getWindowExpression().get()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe6b04e410b34f2f291ab50d3fc6a30c48487016"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74531cbdc3a9fc9380655e3be482644ee813d3d7", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/74531cbdc3a9fc9380655e3be482644ee813d3d7", "committedDate": "2020-07-24T20:58:30Z", "message": "test: add unit tests for rewritten window default grace 0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5673085b90fefd8a235f6db2440b273251c3878", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/a5673085b90fefd8a235f6db2440b273251c3878", "committedDate": "2020-07-24T20:59:33Z", "message": "chore: remove unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41eec3c013f0987056d885ab60e0426a5e62270a", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/41eec3c013f0987056d885ab60e0426a5e62270a", "committedDate": "2020-07-24T21:08:33Z", "message": "chore: add license"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc616f35593bbe729d4e347a0babefd08987830a", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/cc616f35593bbe729d4e347a0babefd08987830a", "committedDate": "2020-07-24T21:38:53Z", "message": "fix: check if grace is present before rewrite"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0a520ffaa544f9ed3beecb2c778e75a7b54c581", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/e0a520ffaa544f9ed3beecb2c778e75a7b54c581", "committedDate": "2020-07-24T22:43:41Z", "message": "fix: default grace 0 only for suppressions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "926c120e57db123c42c3eec15a9a21ea91c27d98", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/926c120e57db123c42c3eec15a9a21ea91c27d98", "committedDate": "2020-07-25T21:26:49Z", "message": "chore: clarify if conditon and invert logic for better readability"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1ODc3ODIy", "url": "https://github.com/confluentinc/ksql/pull/5874#pullrequestreview-455877822", "createdAt": "2020-07-27T15:12:25Z", "commit": {"oid": "926c120e57db123c42c3eec15a9a21ea91c27d98"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4752, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}