{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzOTAwOTc3", "number": 5621, "title": "fix: /inserts-stream endpoint now supports nested types", "bodyText": "Description\nFixes #5620 and adds a lot more test coverage, not only for structs for also for other nested types: array of arrays, array of maps, array of structs, map of arrays, map of maps, map of structs, etc.\nThis fix turned out to be a lot larger than I had hoped in order to accommodate the following constraints of the /inserts-stream endpoint:\n\ncolumn names are case-insensitive (unless quoted)\nstruct field names are case-insensitive (unless quoted)\nmap keys are case-sensitive\nstruct and map types are both represented as JsonObject (KsqlObject for client)\nstrings and doubles may be coerced to decimal types only for the /inserts-stream endpoint, not other uses of DefaultSqlValueCoercer. This constraint is required as JsonObject does not support BigDecimal\nclient serializes BigDecimal for insert requests as strings, due to the constraint above\n\nTesting done\nUnit + integration tests.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-06-12T21:58:37Z", "url": "https://github.com/confluentinc/ksql/pull/5621", "merged": true, "mergeCommit": {"oid": "866ae3499a9d59068461d17ed15e1353759a0334"}, "closed": true, "closedAt": "2020-06-15T17:37:26Z", "author": {"login": "vcrfxia"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqQFzJgH2gAyNDMzOTAwOTc3OjRlZDMwODc4NzZhOTE1YTFhODNiOTdhY2RmMDAyZGE2MDk5ODQ0NDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcrcGKfAFqTQzMDQwOTc4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4ed3087876a915a1a83b97acdf002da609984440", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/4ed3087876a915a1a83b97acdf002da609984440", "committedDate": "2020-06-11T15:35:43Z", "message": "fix: inserts stream endpoint now supports struct"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "732317ca26c35a7e0bf3214fb2efbb0c9d93a0dc", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/732317ca26c35a7e0bf3214fb2efbb0c9d93a0dc", "committedDate": "2020-06-11T19:44:26Z", "message": "fix: support case-insensitive insert of nested struct"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "417f0f9315d18a6047ee8a2c4c3e2f596639e4e3", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/417f0f9315d18a6047ee8a2c4c3e2f596639e4e3", "committedDate": "2020-06-11T23:04:26Z", "message": "fix: should not coerce map to struct in non-json case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfda29139fb4e663d3d43d044b65f5c2aa31f5f6", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/dfda29139fb4e663d3d43d044b65f5c2aa31f5f6", "committedDate": "2020-06-12T00:08:23Z", "message": "fix: allow insert of decimal nested in struct"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92d69ae9e43ce8a8d81304e687d51b4e7b3f234f", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/92d69ae9e43ce8a8d81304e687d51b4e7b3f234f", "committedDate": "2020-06-12T00:28:32Z", "message": "test: basic unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "393c7a1ca032ffa44a5d9cb4f0fca4038c1e8ffb", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/393c7a1ca032ffa44a5d9cb4f0fca4038c1e8ffb", "committedDate": "2020-06-12T02:41:34Z", "message": "test: lots of unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e30aa2c8e5a3abc8126e0aedb5a17a20ca54184e", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/e30aa2c8e5a3abc8126e0aedb5a17a20ca54184e", "committedDate": "2020-06-12T16:10:24Z", "message": "test: prep for integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12151d3ef5036eb2d79bbe3d67ae2784348197ed", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/12151d3ef5036eb2d79bbe3d67ae2784348197ed", "committedDate": "2020-06-12T16:28:04Z", "message": "test: integration test support for struct"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d16797071a338c8508b0980db9e167fd6f7a9bb8", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/d16797071a338c8508b0980db9e167fd6f7a9bb8", "committedDate": "2020-06-12T18:17:12Z", "message": "test: integration test support for complex structs (wip)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f296a3b8f96d2f6504c76895dd4c43f703af458b", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/f296a3b8f96d2f6504c76895dd4c43f703af458b", "committedDate": "2020-06-12T20:05:50Z", "message": "fix: allow insertion of nested structs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f05bfa64864af045be7a1c9c36ac9ef8ebea825a", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/f05bfa64864af045be7a1c9c36ac9ef8ebea825a", "committedDate": "2020-06-12T20:31:41Z", "message": "test: fix test expectation for nested decimal"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49ddd7be6a8464e3fac1f9d306bf9b4f85b551ad", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/49ddd7be6a8464e3fac1f9d306bf9b4f85b551ad", "committedDate": "2020-06-12T20:50:26Z", "message": "fix: support insert of struct nested inside array or map"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea074728dc98cd7308b501745ad95c95b56c208e", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/ea074728dc98cd7308b501745ad95c95b56c208e", "committedDate": "2020-06-12T20:55:43Z", "message": "test: reenable tests for arrays of complex types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c45e880a705c0d97eaf239b6ff9df015ba6600e5", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/c45e880a705c0d97eaf239b6ff9df015ba6600e5", "committedDate": "2020-06-12T21:38:32Z", "message": "test: update server integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e639ea58c70716a73bbd71fc392d50aa96791f5d", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/e639ea58c70716a73bbd71fc392d50aa96791f5d", "committedDate": "2020-06-12T21:45:47Z", "message": "chore: checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1246c7b8747f755a770ea8208f17d6fe77c7df79", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/1246c7b8747f755a770ea8208f17d6fe77c7df79", "committedDate": "2020-06-12T22:35:44Z", "message": "chore: dummy commit to retrigger build"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNDA5Nzgz", "url": "https://github.com/confluentinc/ksql/pull/5621#pullrequestreview-430409783", "createdAt": "2020-06-15T08:05:38Z", "commit": {"oid": "1246c7b8747f755a770ea8208f17d6fe77c7df79"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwODowNTozOVrOGjnYjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwODowNjo1NlrOGjnbcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk5ODYwNA==", "bodyText": "I don't think it's necessary to create special classes JavaListObject/JsonListObject etc.\nCan just call getList() on the JsonArray to get the List. This should simplify things quite a bit?", "url": "https://github.com/confluentinc/ksql/pull/5621#discussion_r439998604", "createdAt": "2020-06-15T08:05:39Z", "author": {"login": "purplefox"}, "path": "ksqldb-parser/src/main/java/io/confluent/ksql/schema/ksql/DefaultSqlValueCoercer.java", "diffHunk": "@@ -129,15 +162,19 @@ private static Result coerceStruct(final Object value, final SqlStruct targetTyp\n     return Result.of(coerced);\n   }\n \n-  private static Result coerceArray(final Object value, final SqlArray targetType) {\n-    if (!(value instanceof List<?>)) {\n+  private Result coerceArray(final Object value, final SqlArray targetType) {\n+    final ListObject list;\n+    if (value instanceof List<?>) {\n+      list = JavaListObject.of((List<?>) value);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1246c7b8747f755a770ea8208f17d6fe77c7df79"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk5OTM0NA==", "bodyText": "As previous comment, I don't think these classes are necessary (?)", "url": "https://github.com/confluentinc/ksql/pull/5621#discussion_r439999344", "createdAt": "2020-06-15T08:06:56Z", "author": {"login": "purplefox"}, "path": "ksqldb-parser/src/main/java/io/confluent/ksql/schema/ksql/DefaultSqlValueCoercer.java", "diffHunk": "@@ -167,4 +208,162 @@ private static Result coerceMap(final Object value, final SqlMap targetType) {\n \n     return Result.of(coerced);\n   }\n+\n+  private interface ListObject {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1246c7b8747f755a770ea8208f17d6fe77c7df79"}, "originalPosition": 166}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 204, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}