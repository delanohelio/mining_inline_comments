{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwNzQzNTk3", "number": 5710, "title": "refactor: move queryID generator out of physical plan", "bodyText": "Description\nThis is a minor refactor which moves queryID generation outside of the physical plan into a place that is better suited for \"replace\" style queries which reuse the existing queryID. The query id generation is now done in EngineExecutor (there is also no queryId generation in QueryMetadata anymore.\nTesting done\nNon-functional change, moved unit tests as appropriate.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-06-26T19:09:31Z", "url": "https://github.com/confluentinc/ksql/pull/5710", "merged": true, "mergeCommit": {"oid": "19e0a8f97c9006a9e6216687c5f4ec7417dfb2e9"}, "closed": true, "closedAt": "2020-06-29T21:45:50Z", "author": {"login": "agavra"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvIGoCAH2gAyNDQwNzQzNTk3OjRlMTNkMDU3MTk0N2M0NjhhMTUzMGRjYzA3ODU0YmI3OTFlY2U4NDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwHSY0AH2gAyNDQwNzQzNTk3OjhmMTIwNDNmM2NlMzJhMDhhYWU4OWJhNDEwNGNlYzI0ZmFkZDJiMzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4e13d0571947c468a1530dcc07854bb791ece848", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/4e13d0571947c468a1530dcc07854bb791ece848", "committedDate": "2020-06-26T19:07:00Z", "message": "refactor: move queryID generator out of physical plan"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NDY1NDMw", "url": "https://github.com/confluentinc/ksql/pull/5710#pullrequestreview-439465430", "createdAt": "2020-06-29T20:12:44Z", "commit": {"oid": "4e13d0571947c468a1530dcc07854bb791ece848"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMDoxMjo0NFrOGqge4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMDoyMjoxMVrOGqgyjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIyNTU2OA==", "bodyText": "nit: unused import?", "url": "https://github.com/confluentinc/ksql/pull/5710#discussion_r447225568", "createdAt": "2020-06-29T20:12:44Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-engine/src/test/java/io/confluent/ksql/testutils/AnalysisTestUtil.java", "diffHunk": "@@ -28,6 +28,7 @@\n import io.confluent.ksql.parser.tree.Statement;\n import io.confluent.ksql.planner.LogicalPlanner;\n import io.confluent.ksql.planner.plan.OutputNode;\n+import io.confluent.ksql.query.id.SequentialQueryIdGenerator;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e13d0571947c468a1530dcc07854bb791ece848"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIyNzk4MA==", "bodyText": "What happened to this toUpperCase() call? I don't see it in the migrated code.", "url": "https://github.com/confluentinc/ksql/pull/5710#discussion_r447227980", "createdAt": "2020-06-29T20:17:11Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/planner/plan/KsqlStructuredDataOutputNode.java", "diffHunk": "@@ -83,15 +80,8 @@ public SourceName getIntoSourceName() {\n   }\n \n   @Override\n-  public QueryId getQueryId(final QueryIdGenerator queryIdGenerator) {\n-    final String base = queryIdGenerator.getNext().toUpperCase();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e13d0571947c468a1530dcc07854bb791ece848"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIzMDYwNQ==", "bodyText": "Why is there no check here on whether the sink specifies CREATE OR REPLACE or not?", "url": "https://github.com/confluentinc/ksql/pull/5710#discussion_r447230605", "createdAt": "2020-06-29T20:22:11Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/QueryIdUtil.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"; you may not use\n+ * this file except in compliance with the License. You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.engine;\n+\n+import com.google.common.collect.Iterables;\n+import io.confluent.ksql.metastore.MetaStore;\n+import io.confluent.ksql.metastore.model.DataSource.DataSourceType;\n+import io.confluent.ksql.name.SourceName;\n+import io.confluent.ksql.planner.plan.KsqlStructuredDataOutputNode;\n+import io.confluent.ksql.planner.plan.OutputNode;\n+import io.confluent.ksql.query.QueryId;\n+import io.confluent.ksql.query.id.QueryIdGenerator;\n+import io.confluent.ksql.util.KsqlException;\n+import java.util.Set;\n+import java.util.concurrent.ThreadLocalRandom;\n+\n+/**\n+ * Utility for constructing {@link QueryId}s - separate from {@code EngineExecutor} for\n+ * easy access to unit testing.\n+ */\n+final class QueryIdUtil {\n+\n+  private QueryIdUtil() {\n+  }\n+\n+  /**\n+   * Builds a {@link QueryId} for a physical plan specification.\n+   *\n+   * @param metaStore   the meta store representing the current state of the engine\n+   * @param idGenerator generates query ids\n+   * @param outputNode  the logical plan\n+   * @return the {@link QueryId} to be used\n+   */\n+  static QueryId buildId(\n+      final MetaStore metaStore,\n+      final QueryIdGenerator idGenerator,\n+      final OutputNode outputNode\n+  ) {\n+    if (!outputNode.getSinkName().isPresent()) {\n+      return new QueryId(String.valueOf(Math.abs(ThreadLocalRandom.current().nextLong())));\n+    }\n+\n+    final KsqlStructuredDataOutputNode structured = (KsqlStructuredDataOutputNode) outputNode;\n+    if (!structured.createInto()) {\n+      return new QueryId(\"INSERTQUERY_\" + idGenerator.getNext());\n+    }\n+\n+    final SourceName sink = outputNode.getSinkName().get();\n+    final Set<String> queriesForSink = metaStore.getQueriesWithSink(sink);\n+    if (queriesForSink.size() > 1) {\n+      throw new KsqlException(\"REPLACE for sink \" + sink + \" is not supported because there are \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e13d0571947c468a1530dcc07854bb791ece848"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f12043f3ce32a08aae89ba4104cec24fadd2b30", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/8f12043f3ce32a08aae89ba4104cec24fadd2b30", "committedDate": "2020-06-29T20:43:52Z", "message": "chore: address comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 267, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}