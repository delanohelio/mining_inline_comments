{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0ODM5OTEy", "number": 5969, "title": "feat: add config for suppress buffer", "bodyText": "Description\nWhat behavior do you want to change, why, how does your patch achieve the changes?\nAdding configs to enable/disable suppress as well as to bound suppress buffer size\nTesting done\nDescribe the testing strategy. Unit and integration tests are expected for any behavior changes.\nUnit tests and qtts have been added\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-08-07T21:24:00Z", "url": "https://github.com/confluentinc/ksql/pull/5969", "merged": true, "mergeCommit": {"oid": "53b0d4d7e00fae6443cc4dc9039b9dee9ab805d2"}, "closed": true, "closedAt": "2020-08-09T22:24:14Z", "author": {"login": "nae701"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8XcovAH2gAyNDY0ODM5OTEyOjI0ZDVhMTQxMGI5NjExNWQ5NGY1ZjZhOWJiZDAwMmQyZTVmODIwMDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc9UgF4gH2gAyNDY0ODM5OTEyOmQ1OThmNzBmNzFiZWQxMmQzOGI0NzdkZmJiNThiZmM1YjZiYjYxYmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "24d5a1410b96115d94f5f6a9bbd002d2e5f82008", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/24d5a1410b96115d94f5f6a9bbd002d2e5f82008", "committedDate": "2020-08-06T22:20:38Z", "message": "fix: add config to disable suppress andbound buffer size"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a93ad762c1bd8b01cc8758644ae7c4dad697c745", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/a93ad762c1bd8b01cc8758644ae7c4dad697c745", "committedDate": "2020-08-07T17:55:40Z", "message": "fix: add suppress feature flag and buffer configs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e8d7343ababddc236b14c54472d9f59cc47a399", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/3e8d7343ababddc236b14c54472d9f59cc47a399", "committedDate": "2020-08-07T18:10:16Z", "message": "fix: fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ed4ec739b44f5aa591bedfcf7747a3f9781cc85", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/0ed4ec739b44f5aa591bedfcf7747a3f9781cc85", "committedDate": "2020-08-07T21:22:32Z", "message": "fix: fix checstyle violation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNjcxMDE4", "url": "https://github.com/confluentinc/ksql/pull/5969#pullrequestreview-463671018", "createdAt": "2020-08-07T22:27:55Z", "commit": {"oid": "0ed4ec739b44f5aa591bedfcf7747a3f9781cc85"}, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QyMjoyNzo1NVrOG9qetg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QyMjozMToyMVrOG9qiEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxMjMxMA==", "bodyText": "let's explicitly call out that -1L is \"unbounded\" and also we should describe the failure behavior (i.e. what happens if the bound is filled?)", "url": "https://github.com/confluentinc/ksql/pull/5969#discussion_r467312310", "createdAt": "2020-08-07T22:27:55Z", "author": {"login": "agavra"}, "path": "ksqldb-common/src/main/java/io/confluent/ksql/util/KsqlConfig.java", "diffHunk": "@@ -304,10 +304,14 @@\n       + \"KSQL metastore backup files are located.\";\n \n   public static final String KSQL_SUPPRESS_ENABLED = \"ksql.suppress.enabled\";\n-  public static final Boolean KSQL_SUPPRESS_ENABLED_DEFAULT = false;\n+  public static final Boolean KSQL_SUPPRESS_ENABLED_DEFAULT = true;\n   public static final String KSQL_SUPPRESS_ENABLED_DOC =\n       \"Feature flag for suppression, specifically EMIT FINAL\";\n \n+  public static final String KSQL_SUPPRESS_BUFFER_SIZE = \"ksql.suppress.buffer.size\";\n+  public static final Long KSQL_SUPPRESS_BUFFER_SIZE_DEFAULT = -1L;\n+  public static final String KSQL_SUPPRESS_BUFFER_SIZE_DOC =\n+      \"Bound the size of the buffer used for suppression\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ed4ec739b44f5aa591bedfcf7747a3f9781cc85"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxMjQyMw==", "bodyText": "let's just toss in the config name here so that it's easier for people to track it down\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    throw new KsqlException(\"Suppression is currently disabled in the KsqlConfig.\");\n          \n          \n            \n                    throw new KsqlException(\"Suppression is currently disabled. You can enable it by setting \" + KsqlConfig.KSQL_SUPPRESS_ENABLED + \" to true\");", "url": "https://github.com/confluentinc/ksql/pull/5969#discussion_r467312423", "createdAt": "2020-08-07T22:28:26Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/planner/LogicalPlanner.java", "diffHunk": "@@ -143,6 +145,9 @@ public OutputNode buildPlan() {\n \n     if (analysis.getRefinementInfo().isPresent()\n         && analysis.getRefinementInfo().get().getOutputRefinement() == OutputRefinement.FINAL) {\n+      if (!ksqlConfig.getBoolean(KsqlConfig.KSQL_SUPPRESS_ENABLED)) {\n+        throw new KsqlException(\"Suppression is currently disabled in the KsqlConfig.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ed4ec739b44f5aa591bedfcf7747a3f9781cc85"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxMjcwMQ==", "bodyText": "nit: used?", "url": "https://github.com/confluentinc/ksql/pull/5969#discussion_r467312701", "createdAt": "2020-08-07T22:29:28Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/test/java/io/confluent/ksql/planner/LogicalPlannerTest.java", "diffHunk": "@@ -45,6 +44,8 @@\n import io.confluent.ksql.util.KsqlException;\n import io.confluent.ksql.util.MetaStoreFixture;\n import java.util.Collections;\n+\n+import org.apache.kafka.common.config.ConfigDef;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ed4ec739b44f5aa591bedfcf7747a3f9781cc85"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxMjk5Mg==", "bodyText": "nit: add //given //when //then", "url": "https://github.com/confluentinc/ksql/pull/5969#discussion_r467312992", "createdAt": "2020-08-07T22:30:30Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/test/java/io/confluent/ksql/planner/LogicalPlannerTest.java", "diffHunk": "@@ -319,6 +323,20 @@ public void shouldThrowOnNonWindowedAggregationSuppressions() {\n \n     assertThat(e.getMessage(), containsString(\"EMIT FINAL is only supported for windowed aggregations.\"));\n   }\n+\n+  @Test\n+  public void shouldThrowOnSuppressDisabledInConfig() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ed4ec739b44f5aa591bedfcf7747a3f9781cc85"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxMzEwNA==", "bodyText": "I think checkstyle forces this to be final", "url": "https://github.com/confluentinc/ksql/pull/5969#discussion_r467313104", "createdAt": "2020-08-07T22:31:05Z", "author": {"login": "agavra"}, "path": "ksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/TableSuppressBuilder.java", "diffHunk": "@@ -91,6 +93,18 @@ public TableSuppressBuilder() {\n             keySerde,\n             valueSerde\n         );\n+\n+    final Suppressed.StrictBufferConfig strictBufferConfig;\n+    long maxBytes = queryBuilder.getKsqlConfig().getLong(KsqlConfig.KSQL_SUPPRESS_BUFFER_SIZE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ed4ec739b44f5aa591bedfcf7747a3f9781cc85"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxMzE3MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (maxBytes == -1) {\n          \n          \n            \n                if (maxBytes < 0) {\n          \n      \n    \n    \n  \n\nnit: sometimes people typo", "url": "https://github.com/confluentinc/ksql/pull/5969#discussion_r467313170", "createdAt": "2020-08-07T22:31:21Z", "author": {"login": "agavra"}, "path": "ksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/TableSuppressBuilder.java", "diffHunk": "@@ -91,6 +93,18 @@ public TableSuppressBuilder() {\n             keySerde,\n             valueSerde\n         );\n+\n+    final Suppressed.StrictBufferConfig strictBufferConfig;\n+    long maxBytes = queryBuilder.getKsqlConfig().getLong(KsqlConfig.KSQL_SUPPRESS_BUFFER_SIZE);\n+\n+    if (maxBytes == -1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ed4ec739b44f5aa591bedfcf7747a3f9781cc85"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b748f32f4306ab937b2dfd4e3b7a0b73f712561d", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/b748f32f4306ab937b2dfd4e3b7a0b73f712561d", "committedDate": "2020-08-09T19:25:16Z", "message": "fix: address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fed21aeec1d4b025cef42e33b024270542103891", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/fed21aeec1d4b025cef42e33b024270542103891", "committedDate": "2020-08-09T19:33:10Z", "message": "fix: add commmit suggestions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e0b8d65ba8f3c2772baa10fae3d81b3402274960", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/e0b8d65ba8f3c2772baa10fae3d81b3402274960", "committedDate": "2020-08-09T19:00:09Z", "message": "Merge branch 'master' into suppress-buffer"}, "afterCommit": {"oid": "fed21aeec1d4b025cef42e33b024270542103891", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/fed21aeec1d4b025cef42e33b024270542103891", "committedDate": "2020-08-09T19:33:10Z", "message": "fix: add commmit suggestions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59439c38bf8a548b92dd242a72300873e876d497", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/59439c38bf8a548b92dd242a72300873e876d497", "committedDate": "2020-08-09T19:47:23Z", "message": "fix: import order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88eeba0c5cd5f64ffb90d82b8f3d0984d79d0b0a", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/88eeba0c5cd5f64ffb90d82b8f3d0984d79d0b0a", "committedDate": "2020-08-09T20:02:47Z", "message": "test: fix tablesuppressbuilder test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "af5ba9d13ad9a41091118d1ff8069cd5de5045f4", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/af5ba9d13ad9a41091118d1ff8069cd5de5045f4", "committedDate": "2020-08-09T19:34:47Z", "message": "Merge branch 'master' into suppress-buffer"}, "afterCommit": {"oid": "88eeba0c5cd5f64ffb90d82b8f3d0984d79d0b0a", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/88eeba0c5cd5f64ffb90d82b8f3d0984d79d0b0a", "committedDate": "2020-08-09T20:02:47Z", "message": "test: fix tablesuppressbuilder test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79a685dcbece1b4b0cbefc9da07301672e77a925", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/79a685dcbece1b4b0cbefc9da07301672e77a925", "committedDate": "2020-08-09T21:17:46Z", "message": "test: fix logical planner test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83b0746f3679575390e0ece521e3c64bd3fcbc06", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/83b0746f3679575390e0ece521e3c64bd3fcbc06", "committedDate": "2020-08-09T20:05:07Z", "message": "Merge branch 'master' into suppress-buffer"}, "afterCommit": {"oid": "79a685dcbece1b4b0cbefc9da07301672e77a925", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/79a685dcbece1b4b0cbefc9da07301672e77a925", "committedDate": "2020-08-09T21:17:46Z", "message": "test: fix logical planner test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d598f70f71bed12d38b477dfbb58bfc5b6bb61bc", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/d598f70f71bed12d38b477dfbb58bfc5b6bb61bc", "committedDate": "2020-08-09T21:28:37Z", "message": "Merge branch 'master' into suppress-buffer"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4798, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}