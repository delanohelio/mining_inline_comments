{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3ODIwMzA2", "number": 5360, "title": "fix(client): Java client error handling", "bodyText": "Description\nThis PR is stacked on #5346 -- only the latest commits (starting from \"fix: java client handling of errors during query stream\") need to be reviewed.\nPrior to this PR, the Java client wasn't wired up to handle ErrorResponses from the server while streaming queries. There were also a variety of bugs around when query results would be marked failed and/or complete, and the behavior of methods such as poll() and subscribe() after errors were encountered were unclear. This PR cleans all of that up and adds test coverage for relevant scenarios.\nHow to review:\n\nLook at the new Java docs in StreamedQueryResult for the intended behavior\nLook at the new unit tests in StreamedQueryResultImpl and/or ClientTest -- two copies of the same tests since @purplefox prefers non-mocked unit tests while I prefer sanity-checking myself with mocked unit tests first ;)\nLook at the various fixes in StreamedQueryResultImpl, BufferedPublisher, BasePublisher, and PollableSubscriber, and StreamQueryResponseHandler required to get the new tests passing\nThe rest of the files, including new tests in BufferedPublisherTest and an added piece of functionality to TestQueryPublisher\n\nTesting done\nBunch of new unit tests.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-05-14T08:00:27Z", "url": "https://github.com/confluentinc/ksql/pull/5360", "merged": true, "mergeCommit": {"oid": "4dca4dc4f56d9448bc0e66ea39cc728b2cf0a8fa"}, "closed": true, "closedAt": "2020-05-14T23:03:03Z", "author": {"login": "vcrfxia"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgppNtgH2gAyNDE3ODIwMzA2OjgwMTkwMTYwYzNhZTI3ZTQ5Y2E4MDliNTY1Mzk0N2I1MzRjZmQxNDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchTtv-gH2gAyNDE3ODIwMzA2OjBlM2ExYTA3ODY4NzViOTQwNjEyMjA4Nzk1OTdjNWRiYTlkMTRiMDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "80190160c3ae27e49ca809b5653947b534cfd147", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/80190160c3ae27e49ca809b5653947b534cfd147", "committedDate": "2020-05-12T19:42:47Z", "message": "chore: rename BaseApiTest columns"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d45869ed9f67879a67304cafd270661b4eece614", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/d45869ed9f67879a67304cafd270661b4eece614", "committedDate": "2020-05-12T22:06:38Z", "message": "test: add complex types to BaseApiTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1494cf0e5b3941453327eb5178eaa554d02e102", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/f1494cf0e5b3941453327eb5178eaa554d02e102", "committedDate": "2020-05-12T22:34:25Z", "message": "refactor: collect row verification in ClientTest into one place"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6387d698fc441d7a5da51c5a84fb95099ea2da81", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/6387d698fc441d7a5da51c5a84fb95099ea2da81", "committedDate": "2020-05-12T22:58:08Z", "message": "test: exercise Row methods in ClientTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0acc152812ed18e2d1fdeb072c0913c41eea480", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/b0acc152812ed18e2d1fdeb072c0913c41eea480", "committedDate": "2020-05-13T20:41:27Z", "message": "test: exercise KsqlArray and KsqlObject methods in ClientTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8303a4c77103912d582069e8637dc8ed34e5a6b1", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/8303a4c77103912d582069e8637dc8ed34e5a6b1", "committedDate": "2020-05-13T21:04:01Z", "message": "fix: do not close PollableSubscriber on complete til all rows delivered"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "424e8918bb6017ae75cd55afa664430e3e0ee6f0", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/424e8918bb6017ae75cd55afa664430e3e0ee6f0", "committedDate": "2020-05-13T21:04:47Z", "message": "Merge branch 'master' into java-client-test-coverage-2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e406173f0692499d6f817f37eda93cf7e9c6018", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/9e406173f0692499d6f817f37eda93cf7e9c6018", "committedDate": "2020-05-13T21:10:24Z", "message": "test: verify nested fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44228e579d748e149ef272218c01ad26db5d6c23", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/44228e579d748e149ef272218c01ad26db5d6c23", "committedDate": "2020-05-13T22:55:26Z", "message": "chore: findbugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c1cd2af711e355ff7600dcaca019c0e57525498", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/3c1cd2af711e355ff7600dcaca019c0e57525498", "committedDate": "2020-05-14T06:53:30Z", "message": "Merge branch 'master' into java-client-test-coverage-2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc591b43e38f04cfa9f8372dcdc11a23fe4e2b4d", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/dc591b43e38f04cfa9f8372dcdc11a23fe4e2b4d", "committedDate": "2020-05-14T07:48:50Z", "message": "fix: java client handling of errors during query stream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "630c823a12447c1f025036819fd7b5ed75738086", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/630c823a12447c1f025036819fd7b5ed75738086", "committedDate": "2020-05-14T08:03:03Z", "message": "chore: fix typo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExOTA1MjQ3", "url": "https://github.com/confluentinc/ksql/pull/5360#pullrequestreview-411905247", "createdAt": "2020-05-14T15:11:15Z", "commit": {"oid": "630c823a12447c1f025036819fd7b5ed75738086"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNToxMToxNlrOGVg-yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNToyMTo0OVrOGVhdaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIxMzY0MQ==", "bodyText": "Why wrap it in an exception?", "url": "https://github.com/confluentinc/ksql/pull/5360#discussion_r425213641", "createdAt": "2020-05-14T15:11:16Z", "author": {"login": "purplefox"}, "path": "ksqldb-api-client/src/main/java/io/confluent/ksql/api/client/impl/PollableSubscriber.java", "diffHunk": "@@ -55,6 +56,7 @@ protected void handleValue(final Row row) {\n \n   @Override\n   protected void handleError(final Throwable t) {\n+    failed = true;\n     errorHandler.accept(new Exception(t));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "630c823a12447c1f025036819fd7b5ed75738086"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIyMDAzOA==", "bodyText": "If hasSentComplete, isn't complete always true?", "url": "https://github.com/confluentinc/ksql/pull/5360#discussion_r425220038", "createdAt": "2020-05-14T15:19:57Z", "author": {"login": "purplefox"}, "path": "ksqldb-common/src/main/java/io/confluent/ksql/reactive/BufferedPublisher.java", "diffHunk": "@@ -90,10 +90,10 @@ public BufferedPublisher(final Context ctx, final int bufferMaxSize) {\n    */\n   public boolean accept(final T t) {\n     checkContext();\n-    if (complete) {\n+    if (isComplete() || hasSentComplete()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "630c823a12447c1f025036819fd7b5ed75738086"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIyMDYwMQ==", "bodyText": "I think cancelled can be removed completely now?", "url": "https://github.com/confluentinc/ksql/pull/5360#discussion_r425220601", "createdAt": "2020-05-14T15:20:39Z", "author": {"login": "purplefox"}, "path": "ksqldb-common/src/main/java/io/confluent/ksql/reactive/BasePublisher.java", "diffHunk": "@@ -37,6 +37,8 @@\n   private Subscriber<? super T> subscriber;\n   private long demand;\n   private boolean cancelled;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "630c823a12447c1f025036819fd7b5ed75738086"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIyMTQ4MQ==", "bodyText": "I think sentComplete and failure should be volatile as they're accessed outside of a monitor", "url": "https://github.com/confluentinc/ksql/pull/5360#discussion_r425221481", "createdAt": "2020-05-14T15:21:49Z", "author": {"login": "purplefox"}, "path": "ksqldb-common/src/main/java/io/confluent/ksql/reactive/BasePublisher.java", "diffHunk": "@@ -37,6 +37,8 @@\n   private Subscriber<? super T> subscriber;\n   private long demand;\n   private boolean cancelled;\n+  private boolean sentComplete;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "630c823a12447c1f025036819fd7b5ed75738086"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f207345b64ec993bde9557e0c5d1a4f792b74cef", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/f207345b64ec993bde9557e0c5d1a4f792b74cef", "committedDate": "2020-05-14T19:37:59Z", "message": "chore: feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e3a1a0786875b94061220879597c5dba9d14b04", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/0e3a1a0786875b94061220879597c5dba9d14b04", "committedDate": "2020-05-14T20:43:45Z", "message": "chore: remove unnecessary volatiles"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4755, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}