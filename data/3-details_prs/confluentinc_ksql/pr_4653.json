{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwNTY5NDI1", "number": 4653, "title": "fix: CommandRunner metric has correct metric displayed when thread dies", "bodyText": "Description\nFixes: #4652\nAdd a new variable to CommandRunner that keeps track of the last time the command topic was polled. If there's too long of a duration between the current time when CommandRunner.checkCommandRunnerStatus is called and the last poll, that means the thread is in ERROR state.\nTesting done\nKilled the command runner thread and watched the metric. It transitioned to error state after 15 seconds.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-02-27T00:06:38Z", "url": "https://github.com/confluentinc/ksql/pull/4653", "merged": true, "mergeCommit": {"oid": "1db542bfea5006fc9b3af59bca28d4af48fc5d57"}, "closed": true, "closedAt": "2020-03-23T16:29:18Z", "author": {"login": "stevenpyzhang"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIP5uNABqjMwNzU5MDQzMDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQZQ0WAFqTM3OTE4NDEzOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a80fc63fb813552de3bf693538d5eb0c539322e", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/3a80fc63fb813552de3bf693538d5eb0c539322e", "committedDate": "2020-02-26T23:55:20Z", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead"}, "afterCommit": {"oid": "6d5be45a44999d20fa56bedbae547ab21cd5ef2f", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/6d5be45a44999d20fa56bedbae547ab21cd5ef2f", "committedDate": "2020-02-27T00:09:00Z", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MzQ4MzEy", "url": "https://github.com/confluentinc/ksql/pull/4653#pullrequestreview-365348312", "createdAt": "2020-02-27T00:50:32Z", "commit": {"oid": "6d5be45a44999d20fa56bedbae547ab21cd5ef2f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwMDo1MDozM1rOFvBslg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwMDo1MDozM1rOFvBslg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1NTE5MA==", "bodyText": "Can we just get rid of this and set the status to ERROR if we haven't polled in a while?", "url": "https://github.com/confluentinc/ksql/pull/4653#discussion_r384855190", "createdAt": "2020-02-27T00:50:33Z", "author": {"login": "rodesai"}, "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java", "diffHunk": "@@ -262,12 +266,15 @@ private void terminateCluster(final Command command) {\n   CommandRunnerStatus checkCommandRunnerStatus() {\n     final Pair<QueuedCommand, Instant> currentCommand = currentCommandRef.get();\n     if (currentCommand == null) {\n-      return CommandRunnerStatus.RUNNING;\n+      return lastPollTime.get() == null ||\n+          Duration.between(lastPollTime.get(), clock.instant()).toMillis()\n+              < NEW_CMDS_TIMEOUT.toMillis() * 3\n+              ? CommandRunnerStatus.RUNNING : CommandRunnerStatus.ERROR;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d5be45a44999d20fa56bedbae547ab21cd5ef2f"}, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6d5be45a44999d20fa56bedbae547ab21cd5ef2f", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/6d5be45a44999d20fa56bedbae547ab21cd5ef2f", "committedDate": "2020-02-27T00:09:00Z", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead"}, "afterCommit": {"oid": "9251d032407d07d8dd98933a62d46dcbe7b608a8", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/9251d032407d07d8dd98933a62d46dcbe7b608a8", "committedDate": "2020-02-27T20:40:23Z", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9251d032407d07d8dd98933a62d46dcbe7b608a8", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/9251d032407d07d8dd98933a62d46dcbe7b608a8", "committedDate": "2020-02-27T20:40:23Z", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead"}, "afterCommit": {"oid": "11155cf8812cab889acfd8d0543e42471fe02bda", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/11155cf8812cab889acfd8d0543e42471fe02bda", "committedDate": "2020-02-27T23:26:53Z", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "11155cf8812cab889acfd8d0543e42471fe02bda", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/11155cf8812cab889acfd8d0543e42471fe02bda", "committedDate": "2020-02-27T23:26:53Z", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead"}, "afterCommit": {"oid": "235f5bdf83b4586825a4c871ff5afcea46b94cc5", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/235f5bdf83b4586825a4c871ff5afcea46b94cc5", "committedDate": "2020-02-28T00:38:11Z", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "235f5bdf83b4586825a4c871ff5afcea46b94cc5", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/235f5bdf83b4586825a4c871ff5afcea46b94cc5", "committedDate": "2020-02-28T00:38:11Z", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead"}, "afterCommit": {"oid": "eda865dbdd2d9d75438991912a0a619045dd7133", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/eda865dbdd2d9d75438991912a0a619045dd7133", "committedDate": "2020-03-02T20:05:01Z", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eda865dbdd2d9d75438991912a0a619045dd7133", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/eda865dbdd2d9d75438991912a0a619045dd7133", "committedDate": "2020-03-02T20:05:01Z", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead"}, "afterCommit": {"oid": "aef463889aa45bffeddfa292b21a5a66fb0953cc", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/aef463889aa45bffeddfa292b21a5a66fb0953cc", "committedDate": "2020-03-02T21:24:41Z", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aef463889aa45bffeddfa292b21a5a66fb0953cc", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/aef463889aa45bffeddfa292b21a5a66fb0953cc", "committedDate": "2020-03-02T21:24:41Z", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead"}, "afterCommit": {"oid": "310350de5286cbfea06c125e649fab82cabf575d", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/310350de5286cbfea06c125e649fab82cabf575d", "committedDate": "2020-03-02T21:51:18Z", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MjU1MzQ1", "url": "https://github.com/confluentinc/ksql/pull/4653#pullrequestreview-368255345", "createdAt": "2020-03-03T19:20:05Z", "commit": {"oid": "310350de5286cbfea06c125e649fab82cabf575d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxOToyMDowNVrOFxTMIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxOToyMDowNVrOFxTMIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIzODk0NQ==", "bodyText": "why do we need this additional status? Once it's here we have to support it forever. Why is it not enough to know that the runner is up or down?", "url": "https://github.com/confluentinc/ksql/pull/4653#discussion_r387238945", "createdAt": "2020-03-03T19:20:05Z", "author": {"login": "rodesai"}, "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandRunner.java", "diffHunk": "@@ -64,11 +64,13 @@\n \n   private final CommandRunnerStatusMetric commandRunnerStatusMetric;\n   private final AtomicReference<Pair<QueuedCommand, Instant>> currentCommandRef;\n+  private final AtomicReference<Instant> lastPollTime;\n   private final Duration commandRunnerHealthTimeout;\n   private final Clock clock;\n \n   public enum CommandRunnerStatus {\n     RUNNING,\n+    STUCK,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "310350de5286cbfea06c125e649fab82cabf575d"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b69ad12a61c3309dadeca5422bcd6b976f2163ab", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/b69ad12a61c3309dadeca5422bcd6b976f2163ab", "committedDate": "2020-03-18T22:03:07Z", "message": "fix: CommandRunner metric has correct metric displayed when thread dies"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "310350de5286cbfea06c125e649fab82cabf575d", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/310350de5286cbfea06c125e649fab82cabf575d", "committedDate": "2020-03-02T21:51:18Z", "message": "fix: CommandRunner metric correctly reports status of thread if it's dead"}, "afterCommit": {"oid": "b69ad12a61c3309dadeca5422bcd6b976f2163ab", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/b69ad12a61c3309dadeca5422bcd6b976f2163ab", "committedDate": "2020-03-18T22:03:07Z", "message": "fix: CommandRunner metric has correct metric displayed when thread dies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11c084996cca1669fbe9e59bcfd98a6644b1c74f", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/11c084996cca1669fbe9e59bcfd98a6644b1c74f", "committedDate": "2020-03-20T18:40:48Z", "message": "get rid of the stuck status"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5cb1af0def9ab007df8cbc138053dc34a5101794", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/5cb1af0def9ab007df8cbc138053dc34a5101794", "committedDate": "2020-03-20T18:40:00Z", "message": "get rid of the stuck status"}, "afterCommit": {"oid": "11c084996cca1669fbe9e59bcfd98a6644b1c74f", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/11c084996cca1669fbe9e59bcfd98a6644b1c74f", "committedDate": "2020-03-20T18:40:48Z", "message": "get rid of the stuck status"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MTg0MTM5", "url": "https://github.com/confluentinc/ksql/pull/4653#pullrequestreview-379184139", "createdAt": "2020-03-23T07:34:52Z", "commit": {"oid": "11c084996cca1669fbe9e59bcfd98a6644b1c74f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4882, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}