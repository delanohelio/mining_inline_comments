{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyNjEyMjY2", "number": 6632, "title": "chore: improve sr key schema check in insert values (MINOR)", "bodyText": "Description\nFollow-up from #6601 (comment)\nTesting done\nRan the unit tests\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-11-17T18:23:14Z", "url": "https://github.com/confluentinc/ksql/pull/6632", "merged": true, "mergeCommit": {"oid": "2c9561fc0a5e5ef6f40deba742cd477bd486162f"}, "closed": true, "closedAt": "2020-11-18T21:22:42Z", "author": {"login": "agavra"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddgqjkgFqTUzMjgzNzUyMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABddzcx9AH2gAyNTIyNjEyMjY2OmFjMTUzM2FhYTdkZTRlYTUxZDc1NWJlZmVlODljZWQzY2E5NjQ0MWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyODM3NTIy", "url": "https://github.com/confluentinc/ksql/pull/6632#pullrequestreview-532837522", "createdAt": "2020-11-17T21:43:46Z", "commit": {"oid": "84473b6b7d50a208bca6635a190db98d14f9e8b3"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMTo0Mzo0NlrOH1MrdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMTo0NDoxNVrOH1Mshw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU0NDMwOQ==", "bodyText": "What's the purpose of separately handling potential auth errors here rather than unifying in SchemaRegistryUtil where missing schemas are handled?", "url": "https://github.com/confluentinc/ksql/pull/6632#discussion_r525544309", "createdAt": "2020-11-17T21:43:46Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/InsertValuesExecutor.java", "diffHunk": "@@ -303,21 +303,25 @@ private void ensureKeySchemasMatch(\n         .getSchemaTranslator(keyFormat.getFormatInfo().getProperties())\n         .toParsedSchema(keySchema);\n \n+    final Optional<SchemaMetadata> latest;\n     try {\n-      final SchemaMetadata latest = serviceContext.getSchemaRegistryClient()\n-          .getLatestSchemaMetadata(\n-              KsqlConstants.getSRSubject(dataSource.getKafkaTopicName(), true));\n-      if (!latest.getSchema().equals(schema.canonicalString())) {\n-        throw new KsqlException(\"Cannot INSERT VALUES into data source \" + dataSource.getName()\n-            + \". ksqlDB generated schema would overwrite existing key schema.\"\n-            + \"\\n\\tExisting Schema: \" + latest.getSchema()\n-            + \"\\n\\tksqlDB Generated: \" + schema.canonicalString());\n-      }\n-    } catch (IOException | RestClientException e) {\n+      latest = SchemaRegistryUtil.getLatestSchema(\n+          serviceContext.getSchemaRegistryClient(),\n+          dataSource.getKafkaTopicName(),\n+          true);\n+\n+    } catch (final Exception e) {\n       maybeThrowSchemaRegistryAuthError(format, dataSource.getKafkaTopicName(), true, \"read\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84473b6b7d50a208bca6635a190db98d14f9e8b3"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU0NDU4Mw==", "bodyText": "Do we ever expect exceptions other than KsqlException here?", "url": "https://github.com/confluentinc/ksql/pull/6632#discussion_r525544583", "createdAt": "2020-11-17T21:44:15Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/InsertValuesExecutor.java", "diffHunk": "@@ -303,21 +303,25 @@ private void ensureKeySchemasMatch(\n         .getSchemaTranslator(keyFormat.getFormatInfo().getProperties())\n         .toParsedSchema(keySchema);\n \n+    final Optional<SchemaMetadata> latest;\n     try {\n-      final SchemaMetadata latest = serviceContext.getSchemaRegistryClient()\n-          .getLatestSchemaMetadata(\n-              KsqlConstants.getSRSubject(dataSource.getKafkaTopicName(), true));\n-      if (!latest.getSchema().equals(schema.canonicalString())) {\n-        throw new KsqlException(\"Cannot INSERT VALUES into data source \" + dataSource.getName()\n-            + \". ksqlDB generated schema would overwrite existing key schema.\"\n-            + \"\\n\\tExisting Schema: \" + latest.getSchema()\n-            + \"\\n\\tksqlDB Generated: \" + schema.canonicalString());\n-      }\n-    } catch (IOException | RestClientException e) {\n+      latest = SchemaRegistryUtil.getLatestSchema(\n+          serviceContext.getSchemaRegistryClient(),\n+          dataSource.getKafkaTopicName(),\n+          true);\n+\n+    } catch (final Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84473b6b7d50a208bca6635a190db98d14f9e8b3"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a22e9fffc9e9e48f44bc9811b0bba49b9dd562e7", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/a22e9fffc9e9e48f44bc9811b0bba49b9dd562e7", "committedDate": "2020-11-18T19:05:09Z", "message": "chore: improve sr key schema check in insert values (MINOR)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21681b513fa0a7d15478adbc2cf2c38636f31e39", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/21681b513fa0a7d15478adbc2cf2c38636f31e39", "committedDate": "2020-11-18T19:05:09Z", "message": "chore: test me plz"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77bf7c9a5d5853b992738b5d5c9fc2fb907a00af", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/77bf7c9a5d5853b992738b5d5c9fc2fb907a00af", "committedDate": "2020-11-18T19:19:20Z", "message": "chore: tighten try-catch"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84473b6b7d50a208bca6635a190db98d14f9e8b3", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/84473b6b7d50a208bca6635a190db98d14f9e8b3", "committedDate": "2020-11-17T19:33:49Z", "message": "chore: test me plz"}, "afterCommit": {"oid": "77bf7c9a5d5853b992738b5d5c9fc2fb907a00af", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/77bf7c9a5d5853b992738b5d5c9fc2fb907a00af", "committedDate": "2020-11-18T19:19:20Z", "message": "chore: tighten try-catch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac1533aaa7de4ea51d755befee89ced3ca96441a", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/ac1533aaa7de4ea51d755befee89ced3ca96441a", "committedDate": "2020-11-18T19:37:38Z", "message": "test me"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4544, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}