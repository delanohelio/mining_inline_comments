{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3MzAxNDEw", "number": 5138, "title": "refactor: Consolidate API config", "bodyText": "Description\nThis PR consolidates the api server config with the old ksql config, so we have just one config.\nAlso, as we're no longer using rest-utils it doesn't extend RestConfig so we need to extract any config from RestConfig that we are using (e.g. SSL stuff) and put it in the new config.\nTesting done\nNon functional change.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-04-22T13:45:28Z", "url": "https://github.com/confluentinc/ksql/pull/5138", "merged": true, "mergeCommit": {"oid": "dc4b0621439d4f1c8bfcf56df4995870945d57bf"}, "closed": true, "closedAt": "2020-04-24T08:07:30Z", "author": {"login": "purplefox"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaJgIIgBqjMyNjA5ODgxNTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcasNiDgH2gAyNDA3MzAxNDEwOmZjYjYyNWIwYTQ3YmQ1ZmI2OWM4Nzg0MWZmNmYwZmM5NmM2YWVjNzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8a783d1f7ceccd7fa13354073efb08780a3b7d01", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/8a783d1f7ceccd7fa13354073efb08780a3b7d01", "committedDate": "2020-04-22T13:43:13Z", "message": "consolidate server config"}, "afterCommit": {"oid": "d9faaa9729d9f177ac99883d26fed1b5a3f9e379", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/d9faaa9729d9f177ac99883d26fed1b5a3f9e379", "committedDate": "2020-04-22T14:52:05Z", "message": "consolidate server config"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d9faaa9729d9f177ac99883d26fed1b5a3f9e379", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/d9faaa9729d9f177ac99883d26fed1b5a3f9e379", "committedDate": "2020-04-22T14:52:05Z", "message": "consolidate server config"}, "afterCommit": {"oid": "cc16a0962f8e196a6c651928995fcbf657d9b3c7", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/cc16a0962f8e196a6c651928995fcbf657d9b3c7", "committedDate": "2020-04-22T15:52:46Z", "message": "consolidate server config"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc16a0962f8e196a6c651928995fcbf657d9b3c7", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/cc16a0962f8e196a6c651928995fcbf657d9b3c7", "committedDate": "2020-04-22T15:52:46Z", "message": "consolidate server config"}, "afterCommit": {"oid": "cfb3e50cda40eb59c4e283cae744b18b3122c9ff", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/cfb3e50cda40eb59c4e283cae744b18b3122c9ff", "committedDate": "2020-04-22T16:25:30Z", "message": "consolidate server config"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1bda4c580195f682509ee8cbc542bd1d695e9fd0", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/1bda4c580195f682509ee8cbc542bd1d695e9fd0", "committedDate": "2020-04-22T18:44:14Z", "message": "fixed cors test"}, "afterCommit": {"oid": "ade18132d95972ed43a06d48f30d7e44ec4ced4e", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/ade18132d95972ed43a06d48f30d7e44ec4ced4e", "committedDate": "2020-04-22T19:00:04Z", "message": "consolidate server config"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ade18132d95972ed43a06d48f30d7e44ec4ced4e", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/ade18132d95972ed43a06d48f30d7e44ec4ced4e", "committedDate": "2020-04-22T19:00:04Z", "message": "consolidate server config"}, "afterCommit": {"oid": "24181456519ef8c1031576176b4194b4ff01be08", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/24181456519ef8c1031576176b4194b4ff01be08", "committedDate": "2020-04-23T08:52:19Z", "message": "consolidate server config"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "24181456519ef8c1031576176b4194b4ff01be08", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/24181456519ef8c1031576176b4194b4ff01be08", "committedDate": "2020-04-23T08:52:19Z", "message": "consolidate server config"}, "afterCommit": {"oid": "bca377a4637d4e7f25204d86e0273fa2e772435a", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/bca377a4637d4e7f25204d86e0273fa2e772435a", "committedDate": "2020-04-23T09:27:19Z", "message": "consolidate server config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13dc84c3ade5d71e18fa5372d4f922377f8ecb3c", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/13dc84c3ade5d71e18fa5372d4f922377f8ecb3c", "committedDate": "2020-04-23T10:25:04Z", "message": "consolidate server config"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8b48bb96b3ecdcabf52040cb1619ce7254f975b3", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/8b48bb96b3ecdcabf52040cb1619ce7254f975b3", "committedDate": "2020-04-23T09:36:50Z", "message": "removed old test and added to KsqlRestConfigTest"}, "afterCommit": {"oid": "13dc84c3ade5d71e18fa5372d4f922377f8ecb3c", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/13dc84c3ade5d71e18fa5372d4f922377f8ecb3c", "committedDate": "2020-04-23T10:25:04Z", "message": "consolidate server config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NjA3MDUx", "url": "https://github.com/confluentinc/ksql/pull/5138#pullrequestreview-399607051", "createdAt": "2020-04-24T02:55:19Z", "commit": {"oid": "13dc84c3ade5d71e18fa5372d4f922377f8ecb3c"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwMjo1NToxOVrOGLEHTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwMjo1NzozOVrOGLEKHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI1NDkyNQ==", "bodyText": "This PR contains breaking changes, such as this config rename from ssl.client.auth to ssl.client.authentication. Can you add a BREAKING CHANGE: description into the PR description and commit message (when merging this PR) with details?\nI think we should also add a check for the old config (ssl.client.auth) and fail startup if the old config is specified, in order to alert users to the breaking change, since the current behavior of silently ignoring the old config and using the default value of the new config does not seem acceptable.", "url": "https://github.com/confluentinc/ksql/pull/5138#discussion_r414254925", "createdAt": "2020-04-24T02:55:19Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/KsqlRestConfig.java", "diffHunk": "@@ -90,31 +96,28 @@\n \n   public static final String AUTHENTICATION_ROLES_CONFIG = \"authentication.roles\";\n   public static final String AUTHENTICATION_ROLES_DOC = \"Valid roles to authenticate against.\";\n-  public static final List<String> AUTHENTICATION_ROLES_DEFAULT =\n-      Collections.unmodifiableList(Arrays.asList(\"*\"));\n+  public static final List<String> AUTHENTICATION_ROLES_DEFAULT = Collections.singletonList(\"*\");\n \n-  public static final String SSL_KEYSTORE_LOCATION_CONFIG = \"ssl.keystore.location\";\n-  protected static final String SSL_KEYSTORE_LOCATION_DOC =\n-      \"Location of the keystore file to use for SSL. This is required for HTTPS.\";\n   protected static final String SSL_KEYSTORE_LOCATION_DEFAULT = \"\";\n-  public static final String SSL_KEYSTORE_PASSWORD_CONFIG = \"ssl.keystore.password\";\n-  protected static final String SSL_KEYSTORE_PASSWORD_DOC =\n-      \"The store password for the keystore file.\";\n   protected static final String SSL_KEYSTORE_PASSWORD_DEFAULT = \"\";\n \n-  public static final String SSL_TRUSTSTORE_LOCATION_CONFIG = \"ssl.truststore.location\";\n-  protected static final String SSL_TRUSTSTORE_LOCATION_DOC =\n-      \"Location of the trust store. Required only to authenticate HTTPS clients.\";\n   protected static final String SSL_TRUSTSTORE_LOCATION_DEFAULT = \"\";\n-  public static final String SSL_TRUSTSTORE_PASSWORD_CONFIG = \"ssl.truststore.password\";\n-  protected static final String SSL_TRUSTSTORE_PASSWORD_DOC =\n-      \"The store password for the trust store file.\";\n   protected static final String SSL_TRUSTSTORE_PASSWORD_DEFAULT = \"\";\n \n-  public static final String SSL_CLIENT_AUTH_CONFIG = \"ssl.client.auth\";\n-  protected static final String SSL_CLIENT_AUTH_DOC =\n-      \"Whether or not to require the https client to authenticate via the server's trust store.\";\n-  protected static final boolean SSL_CLIENT_AUTH_DEFAULT = false;\n+  public static final String SSL_CLIENT_AUTHENTICATION_CONFIG = \"ssl.client.authentication\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13dc84c3ade5d71e18fa5372d4f922377f8ecb3c"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI1NTM5MA==", "bodyText": "Do we need a null check on keyStorePassword here (and on trustStorePassword below)? The old code had a null check that's been removed. Haven't looked into whether it's actually needed or not.", "url": "https://github.com/confluentinc/ksql/pull/5138#discussion_r414255390", "createdAt": "2020-04-24T02:56:43Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/Server.java", "diffHunk": "@@ -240,30 +243,32 @@ private static HttpServerOptions createHttpServerOptions(final ApiServerConfig a\n     if (tls) {\n       options.setUseAlpn(true).setSsl(true);\n \n-      final String keyStorePath = apiServerConfig.getString(ApiServerConfig.TLS_KEY_STORE_PATH);\n-      final String keyStorePassword = apiServerConfig\n-          .getString(ApiServerConfig.TLS_KEY_STORE_PASSWORD);\n+      final String keyStorePath = ksqlRestConfig\n+          .getString(SslConfigs.SSL_KEYSTORE_LOCATION_CONFIG);\n+      final Password keyStorePassword = ksqlRestConfig\n+          .getPassword(SslConfigs.SSL_KEYSTORE_PASSWORD_CONFIG);\n       if (keyStorePath != null && !keyStorePath.isEmpty()) {\n         options.setKeyStoreOptions(\n-            new JksOptions().setPath(keyStorePath).setPassword(keyStorePassword));\n+            new JksOptions().setPath(keyStorePath).setPassword(keyStorePassword.value()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13dc84c3ade5d71e18fa5372d4f922377f8ecb3c"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDI1NTY0Nw==", "bodyText": "nit: can we use KsqlRestConfig.SSL_KEYSTORE_LOCATION_CONFIG instead? And similarly for the other appearances of SslConfigs in this file, and in ListenersTest.java and TlsTest.java.", "url": "https://github.com/confluentinc/ksql/pull/5138#discussion_r414255647", "createdAt": "2020-04-24T02:57:39Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/Server.java", "diffHunk": "@@ -273,7 +278,8 @@ private static HttpServerOptions createHttpServerOptions(final ApiServerConfig a\n           throw new ConfigException(\"Invalid URI scheme should be http or https: \" + listenerName);\n         }\n         if (\"https\".equalsIgnoreCase(scheme)) {\n-          final String keyStoreLocation = config.getString(ApiServerConfig.TLS_KEY_STORE_PATH);\n+          final String keyStoreLocation = config\n+              .getString(SslConfigs.SSL_KEYSTORE_LOCATION_CONFIG);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13dc84c3ade5d71e18fa5372d4f922377f8ecb3c"}, "originalPosition": 130}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d11fb6fce23383614f1a8112cdb171e4e49dc76", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/4d11fb6fce23383614f1a8112cdb171e4e49dc76", "committedDate": "2020-04-24T07:14:58Z", "message": "Support the old deprecated client auth and warn if specified"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69cce692be0be51718cbcd574163866e729d95d8", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/69cce692be0be51718cbcd574163866e729d95d8", "committedDate": "2020-04-24T07:15:53Z", "message": "small fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcb625b0a47bd5fb69c87841ff6f0fc96c6aec78", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/fcb625b0a47bd5fb69c87841ff6f0fc96c6aec78", "committedDate": "2020-04-24T07:18:43Z", "message": "do not support bearer"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4888, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}