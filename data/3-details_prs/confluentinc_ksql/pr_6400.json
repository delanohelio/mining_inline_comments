{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwODc4NDE4", "number": 6400, "title": "feat: Add support for ALTER STREAM|TABLE", "bodyText": "Description\nAdd new syntax, ALTER STREAM|TABLE.  It works as follows:\nksql> alter stream riderlocations add column name string;\n\n Message\n-------------------------------\n Stream RIDERLOCATIONS altered\n-------------------------------\n\nksql> describe extended riderlocations;\n\n...\nStatement            : CREATE STREAM riderLocations (profileId VARCHAR, latitude DOUBLE, longitude DOUBLE)\n  WITH (kafka_topic='quickstart-locations', value_format='json', partitions=1);alter stream riderLocations add column a string;alter stream riderlocations add column name string;\n\n Field     | Type\n-----------------------------\n PROFILEID | VARCHAR(STRING)\n LATITUDE  | DOUBLE\n LONGITUDE | DOUBLE\n NAME      | VARCHAR(STRING)\n-----------------------------\n\nIt only works on data sources that are created using DDL statements.\nFixes #6038\nTesting done\nUnit and QTT tests.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-10-10T00:42:26Z", "url": "https://github.com/confluentinc/ksql/pull/6400", "merged": true, "mergeCommit": {"oid": "a58e041cba721a1ad5f28bb0be1c792cb73bec14"}, "closed": true, "closedAt": "2020-10-19T20:39:17Z", "author": {"login": "jzaralim"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQ8fCrAH2gAyNTAwODc4NDE4OjZjZDc0ZjU0MTk2NjBiMDcwOWZkM2UwZDg1ZDgzYTI1NGI3M2UyYjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUI4NAgH2gAyNTAwODc4NDE4OjA1NWE4ZGZkN2IwZjkwMmQ0NTc4YzExMjc0YTE1NjkyYjMwODVjZmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6cd74f5419660b0709fd3e0d85d83a254b73e2b6", "author": {"user": {"login": "jzaralim", "name": "Zara Lim"}}, "url": "https://github.com/confluentinc/ksql/commit/6cd74f5419660b0709fd3e0d85d83a254b73e2b6", "committedDate": "2020-10-09T20:48:14Z", "message": "feat: Add support for ALTER STREAM|TABLE"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b0d339a4d66d16bb2f17ebef36818ffb05613fc", "author": {"user": {"login": "jzaralim", "name": "Zara Lim"}}, "url": "https://github.com/confluentinc/ksql/commit/2b0d339a4d66d16bb2f17ebef36818ffb05613fc", "committedDate": "2020-10-09T21:01:29Z", "message": "Merge with master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9d0168276473c284215bf40e01cf1e6b7ae6eb8", "author": {"user": {"login": "jzaralim", "name": "Zara Lim"}}, "url": "https://github.com/confluentinc/ksql/commit/d9d0168276473c284215bf40e01cf1e6b7ae6eb8", "committedDate": "2020-10-10T00:25:09Z", "message": "Merge branch 'master' of github.com:confluentinc/ksql into alter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11b0dee0c661de4b80c209f95644af84d9dcd9e1", "author": {"user": {"login": "jzaralim", "name": "Zara Lim"}}, "url": "https://github.com/confluentinc/ksql/commit/11b0dee0c661de4b80c209f95644af84d9dcd9e1", "committedDate": "2020-10-10T00:42:05Z", "message": "Remove SerdeOptions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NzMxMDAz", "url": "https://github.com/confluentinc/ksql/pull/6400#pullrequestreview-506731003", "createdAt": "2020-10-12T15:43:08Z", "commit": {"oid": "11b0dee0c661de4b80c209f95644af84d9dcd9e1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2OTA3NDA1", "url": "https://github.com/confluentinc/ksql/pull/6400#pullrequestreview-506907405", "createdAt": "2020-10-12T20:47:36Z", "commit": {"oid": "11b0dee0c661de4b80c209f95644af84d9dcd9e1"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMDo0NzozN1rOHgMrhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMTozNTozMlrOHgN_OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUyNDIyOQ==", "bodyText": "we should add these to nonReserved", "url": "https://github.com/confluentinc/ksql/pull/6400#discussion_r503524229", "createdAt": "2020-10-12T20:47:37Z", "author": {"login": "agavra"}, "path": "ksqldb-parser/src/main/antlr4/io/confluent/ksql/parser/SqlBase.g4", "diffHunk": "@@ -495,6 +500,8 @@ VIEW: 'VIEW';\n PRIMARY: 'PRIMARY';\n REPLACE: 'REPLACE';\n ASSERT: 'ASSERT';\n+ADD: 'ADD';\n+ALTER: 'ALTER';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11b0dee0c661de4b80c209f95644af84d9dcd9e1"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUyNjA5NQ==", "bodyText": "the error message in putSource needs to be updated:\n      existing.source.canUpgradeTo(dataSource).ifPresent(msg -> {\n        throw new KsqlException(\"Cannot REPLACE data source: \" + msg);\n      });\nWe could either make it more generic, or pass in more details in the putSource method to correctly display ALTER or REPLACE", "url": "https://github.com/confluentinc/ksql/pull/6400#discussion_r503526095", "createdAt": "2020-10-12T20:52:07Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/ddl/commands/DdlCommandExec.java", "diffHunk": "@@ -127,6 +131,81 @@ public DdlCommandResult executeDropType(final DropTypeCommand dropType) {\n           ? new DdlCommandResult(true, \"Dropped type '\" + typeName + \"'\")\n           : new DdlCommandResult(true, \"Type '\" + typeName + \"' does not exist\");\n     }\n+\n+    @Override\n+    public DdlCommandResult executeAlterSource(final AlterSourceCommand alterSource) {\n+      final DataSource dataSource = metaStore.getSource(alterSource.getSourceName());\n+\n+      if (dataSource == null) {\n+        throw new KsqlException(\n+            \"Source \" + alterSource.getSourceName().text()\n+                + \" does not exist.\"\n+        );\n+      }\n+\n+      if (!dataSource.getDataSourceType().getKsqlType().equals(alterSource.getKsqlType())) {\n+        throw new KsqlException(String.format(\n+            \"Incompatible data source type is %s, but statement was ALTER %s\",\n+            dataSource.getDataSourceType().getKsqlType(),\n+            alterSource.getKsqlType()\n+        ));\n+      }\n+\n+      if (dataSource.isCasTarget()) {\n+        throw new KsqlException(String.format(\n+            \"ALTER command is not supported for CREATE ... AS statements.\"\n+        ));\n+      }\n+\n+      final LogicalSchema newSchema = dataSource.getSchema()\n+          .asBuilder()\n+          .valueColumns(alterSource.getNewColumns().columns())\n+          .build();\n+\n+      if (alterSource.getKsqlType().equals(DataSourceType.KSTREAM.getKsqlType())) {\n+        return alterStream(dataSource, newSchema);\n+      } else {\n+        return alterTable(dataSource, newSchema);\n+      }\n+    }\n+\n+    private DdlCommandResult alterStream(\n+        final DataSource dataSource,\n+        final LogicalSchema newSchema\n+    ) {\n+      final KsqlStream<?> ksqlStream = new KsqlStream<>(\n+          dataSource.getSqlExpression().concat(sql),\n+          dataSource.getName(),\n+          newSchema,\n+          dataSource.getTimestampColumn(),\n+          dataSource.isCasTarget(),\n+          dataSource.getKsqlTopic()\n+      );\n+      metaStore.putSource(ksqlStream, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11b0dee0c661de4b80c209f95644af84d9dcd9e1"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUyNjU5MQ==", "bodyText": "I recommend writing this in YATT format since it was built a little bit better for upgrades (namely, you could test that you could actually insert data in the expected format). There are some limitations in the testing tool, but you can see projections.sql as an example of one of those tests.\nWhen you do that, make sure to assert the post-condition schema as well", "url": "https://github.com/confluentinc/ksql/pull/6400#discussion_r503526591", "createdAt": "2020-10-12T20:53:10Z", "author": {"login": "agavra"}, "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/alter.json", "diffHunk": "@@ -0,0 +1,47 @@\n+{\n+  \"comments\": [\n+    \"Tests covering the use of the ALTER function.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11b0dee0c661de4b80c209f95644af84d9dcd9e1"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUyNzEzNA==", "bodyText": "what happens if there is a persistent INSERT INTO writing into this?", "url": "https://github.com/confluentinc/ksql/pull/6400#discussion_r503527134", "createdAt": "2020-10-12T20:54:18Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/ddl/commands/DdlCommandExec.java", "diffHunk": "@@ -127,6 +131,81 @@ public DdlCommandResult executeDropType(final DropTypeCommand dropType) {\n           ? new DdlCommandResult(true, \"Dropped type '\" + typeName + \"'\")\n           : new DdlCommandResult(true, \"Type '\" + typeName + \"' does not exist\");\n     }\n+\n+    @Override\n+    public DdlCommandResult executeAlterSource(final AlterSourceCommand alterSource) {\n+      final DataSource dataSource = metaStore.getSource(alterSource.getSourceName());\n+\n+      if (dataSource == null) {\n+        throw new KsqlException(\n+            \"Source \" + alterSource.getSourceName().text()\n+                + \" does not exist.\"\n+        );\n+      }\n+\n+      if (!dataSource.getDataSourceType().getKsqlType().equals(alterSource.getKsqlType())) {\n+        throw new KsqlException(String.format(\n+            \"Incompatible data source type is %s, but statement was ALTER %s\",\n+            dataSource.getDataSourceType().getKsqlType(),\n+            alterSource.getKsqlType()\n+        ));\n+      }\n+\n+      if (dataSource.isCasTarget()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11b0dee0c661de4b80c209f95644af84d9dcd9e1"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUzNTAyMw==", "bodyText": "instead of constructing this here, we should add a method to KsqlStream labeled withSchema. This ensures that if anyone ever modifies KsqlStream and adds new arguments it won't accidentally be missed when we copy it here (same for KsqlTable).\nalso, it could make it cleaner if you just added it to DataSource API, then you don't even need to check which type it is :)", "url": "https://github.com/confluentinc/ksql/pull/6400#discussion_r503535023", "createdAt": "2020-10-12T21:13:29Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/ddl/commands/DdlCommandExec.java", "diffHunk": "@@ -127,6 +131,81 @@ public DdlCommandResult executeDropType(final DropTypeCommand dropType) {\n           ? new DdlCommandResult(true, \"Dropped type '\" + typeName + \"'\")\n           : new DdlCommandResult(true, \"Type '\" + typeName + \"' does not exist\");\n     }\n+\n+    @Override\n+    public DdlCommandResult executeAlterSource(final AlterSourceCommand alterSource) {\n+      final DataSource dataSource = metaStore.getSource(alterSource.getSourceName());\n+\n+      if (dataSource == null) {\n+        throw new KsqlException(\n+            \"Source \" + alterSource.getSourceName().text()\n+                + \" does not exist.\"\n+        );\n+      }\n+\n+      if (!dataSource.getDataSourceType().getKsqlType().equals(alterSource.getKsqlType())) {\n+        throw new KsqlException(String.format(\n+            \"Incompatible data source type is %s, but statement was ALTER %s\",\n+            dataSource.getDataSourceType().getKsqlType(),\n+            alterSource.getKsqlType()\n+        ));\n+      }\n+\n+      if (dataSource.isCasTarget()) {\n+        throw new KsqlException(String.format(\n+            \"ALTER command is not supported for CREATE ... AS statements.\"\n+        ));\n+      }\n+\n+      final LogicalSchema newSchema = dataSource.getSchema()\n+          .asBuilder()\n+          .valueColumns(alterSource.getNewColumns().columns())\n+          .build();\n+\n+      if (alterSource.getKsqlType().equals(DataSourceType.KSTREAM.getKsqlType())) {\n+        return alterStream(dataSource, newSchema);\n+      } else {\n+        return alterTable(dataSource, newSchema);\n+      }\n+    }\n+\n+    private DdlCommandResult alterStream(\n+        final DataSource dataSource,\n+        final LogicalSchema newSchema\n+    ) {\n+      final KsqlStream<?> ksqlStream = new KsqlStream<>(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11b0dee0c661de4b80c209f95644af84d9dcd9e1"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUzNTM1Mg==", "bodyText": "how does this end up looking like to the user when you describe a source? is this the UX we want? (make sure to add test coverage for this in ConsoleTest", "url": "https://github.com/confluentinc/ksql/pull/6400#discussion_r503535352", "createdAt": "2020-10-12T21:14:23Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/ddl/commands/DdlCommandExec.java", "diffHunk": "@@ -127,6 +131,81 @@ public DdlCommandResult executeDropType(final DropTypeCommand dropType) {\n           ? new DdlCommandResult(true, \"Dropped type '\" + typeName + \"'\")\n           : new DdlCommandResult(true, \"Type '\" + typeName + \"' does not exist\");\n     }\n+\n+    @Override\n+    public DdlCommandResult executeAlterSource(final AlterSourceCommand alterSource) {\n+      final DataSource dataSource = metaStore.getSource(alterSource.getSourceName());\n+\n+      if (dataSource == null) {\n+        throw new KsqlException(\n+            \"Source \" + alterSource.getSourceName().text()\n+                + \" does not exist.\"\n+        );\n+      }\n+\n+      if (!dataSource.getDataSourceType().getKsqlType().equals(alterSource.getKsqlType())) {\n+        throw new KsqlException(String.format(\n+            \"Incompatible data source type is %s, but statement was ALTER %s\",\n+            dataSource.getDataSourceType().getKsqlType(),\n+            alterSource.getKsqlType()\n+        ));\n+      }\n+\n+      if (dataSource.isCasTarget()) {\n+        throw new KsqlException(String.format(\n+            \"ALTER command is not supported for CREATE ... AS statements.\"\n+        ));\n+      }\n+\n+      final LogicalSchema newSchema = dataSource.getSchema()\n+          .asBuilder()\n+          .valueColumns(alterSource.getNewColumns().columns())\n+          .build();\n+\n+      if (alterSource.getKsqlType().equals(DataSourceType.KSTREAM.getKsqlType())) {\n+        return alterStream(dataSource, newSchema);\n+      } else {\n+        return alterTable(dataSource, newSchema);\n+      }\n+    }\n+\n+    private DdlCommandResult alterStream(\n+        final DataSource dataSource,\n+        final LogicalSchema newSchema\n+    ) {\n+      final KsqlStream<?> ksqlStream = new KsqlStream<>(\n+          dataSource.getSqlExpression().concat(sql),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11b0dee0c661de4b80c209f95644af84d9dcd9e1"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUzNjM4MQ==", "bodyText": "passing in a LogicalSchema to represent the new columns seems... odd? we should probably be passing down just the new columns - users shouldn't be, for example, creating new KEY columns (at the moment at least), and the new columns shouldn't include any of the psuedocolumns.\nwe can see this in the way that you use it (you only get the columns):\nalterSource.getNewColumns().columns()", "url": "https://github.com/confluentinc/ksql/pull/6400#discussion_r503536381", "createdAt": "2020-10-12T21:17:00Z", "author": {"login": "agavra"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/ddl/commands/AlterSourceCommand.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.execution.ddl.commands;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import io.confluent.ksql.name.SourceName;\n+import io.confluent.ksql.schema.ksql.LogicalSchema;\n+\n+public class AlterSourceCommand implements DdlCommand {\n+  private final SourceName sourceName;\n+  private final String ksqlType;\n+  private final LogicalSchema newColumns;\n+\n+\n+  public AlterSourceCommand(\n+      @JsonProperty(value = \"sourceName\", required = true) final SourceName sourceName,\n+      @JsonProperty(value = \"ksqlType\", required = true) final String ksqlType,\n+      @JsonProperty(value = \"newColumns\", required = true) final LogicalSchema newColumns", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11b0dee0c661de4b80c209f95644af84d9dcd9e1"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUzNzkxMQ==", "bodyText": "somewhere we should add a test that adds a column with the same name as a column that already exists", "url": "https://github.com/confluentinc/ksql/pull/6400#discussion_r503537911", "createdAt": "2020-10-12T21:21:01Z", "author": {"login": "agavra"}, "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/alter.json", "diffHunk": "@@ -0,0 +1,47 @@\n+{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11b0dee0c661de4b80c209f95644af84d9dcd9e1"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUzODI0MQ==", "bodyText": "I think we're missing test coverage for this in SqlFormatterTest", "url": "https://github.com/confluentinc/ksql/pull/6400#discussion_r503538241", "createdAt": "2020-10-12T21:21:49Z", "author": {"login": "agavra"}, "path": "ksqldb-parser/src/main/java/io/confluent/ksql/parser/SqlFormatter.java", "diffHunk": "@@ -493,6 +495,22 @@ protected Void visitGroupBy(final GroupBy node, final Integer indent) {\n       return null;\n     }\n \n+    @Override\n+    public Void visitAlterSource(final AlterSource node, final Integer indent) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11b0dee0c661de4b80c209f95644af84d9dcd9e1"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUzOTY2NA==", "bodyText": "hmm, I'm wondering what this means for compatibility - I'm not sure what adding a value to an enum will do to the JSON serde. I think it works but we should test issuing some commands on an earlier version of ksqlDB then upgrading to a version that has this patch and seeing that it works. Similarly, we should test what happens if we downgrade (submit something with ALTER in it, and then roll back). We should make sure we gracefully handle the failure and enter DEGRADED state)\nFYI @stevenpyzhang", "url": "https://github.com/confluentinc/ksql/pull/6400#discussion_r503539664", "createdAt": "2020-10-12T21:25:31Z", "author": {"login": "agavra"}, "path": "ksqldb-rest-model/src/main/java/io/confluent/ksql/rest/entity/CommandId.java", "diffHunk": "@@ -42,7 +42,8 @@\n     CREATE,\n     DROP,\n     EXECUTE,\n-    TERMINATE\n+    TERMINATE,\n+    ALTER", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11b0dee0c661de4b80c209f95644af84d9dcd9e1"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU0NTY1Nw==", "bodyText": "nit - please use the string concatenation method for toString (that's what the rest of the code base uses)", "url": "https://github.com/confluentinc/ksql/pull/6400#discussion_r503545657", "createdAt": "2020-10-12T21:35:32Z", "author": {"login": "agavra"}, "path": "ksqldb-parser/src/main/java/io/confluent/ksql/parser/tree/AlterSource.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.parser.tree;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+\n+import com.google.errorprone.annotations.Immutable;\n+import io.confluent.ksql.metastore.model.DataSource.DataSourceType;\n+import io.confluent.ksql.name.SourceName;\n+import io.confluent.ksql.parser.NodeLocation;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+@Immutable\n+public class AlterSource extends Statement implements ExecutableDdlStatement {\n+  private final SourceName name;\n+  private final DataSourceType dataSourceType;\n+  private final List<AlterOption> alterOptions;\n+\n+  public AlterSource(\n+      final SourceName name,\n+      final DataSourceType dataSourceType,\n+      final List<AlterOption> alterOptions\n+  ) {\n+    this(Optional.empty(), name, dataSourceType, alterOptions);\n+  }\n+\n+  public AlterSource(\n+      final Optional<NodeLocation> location,\n+      final SourceName name,\n+      final DataSourceType dataSourceType,\n+      final List<AlterOption> alterOptions\n+  ) {\n+    super(location);\n+    this.name = name;\n+    this.dataSourceType = dataSourceType;\n+    this.alterOptions = alterOptions;\n+  }\n+\n+  public SourceName getName() {\n+    return name;\n+  }\n+\n+  public DataSourceType getDataSourceType() {\n+    return dataSourceType;\n+  }\n+\n+  public List<AlterOption> getAlterOptions() {\n+    return alterOptions;\n+  }\n+\n+  @Override\n+  public  <R, C> R accept(final AstVisitor<R, C> visitor, final C context) {\n+    return visitor.visitAlterSource(this, context);\n+  }\n+\n+  @Override\n+  public int hashCode() {\n+    return Objects.hash(name, dataSourceType, alterOptions);\n+  }\n+\n+  @Override\n+  public boolean equals(final Object o) {\n+    if (this == o) {\n+      return true;\n+    }\n+    if (o == null || getClass() != o.getClass()) {\n+      return false;\n+    }\n+    final AlterSource that = (AlterSource) o;\n+    return Objects.equals(name, that.name)\n+        && Objects.equals(dataSourceType, that.dataSourceType)\n+        && Objects.equals(alterOptions, that.alterOptions);\n+  }\n+\n+  @Override\n+  public String toString() {\n+    return toStringHelper(this)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11b0dee0c661de4b80c209f95644af84d9dcd9e1"}, "originalPosition": 92}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75b61b09946e72b15894177a66234c13ee757429", "author": {"user": {"login": "jzaralim", "name": "Zara Lim"}}, "url": "https://github.com/confluentinc/ksql/commit/75b61b09946e72b15894177a66234c13ee757429", "committedDate": "2020-10-12T21:41:56Z", "message": "Merge branch 'master' of github.com:confluentinc/ksql into alter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63eb35935af6f2a01c889070b590cbac5e1c3776", "author": {"user": {"login": "jzaralim", "name": "Zara Lim"}}, "url": "https://github.com/confluentinc/ksql/commit/63eb35935af6f2a01c889070b590cbac5e1c3776", "committedDate": "2020-10-15T22:43:15Z", "message": "Address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fc75071f54b2d1763155b1f0d891d69142b5cc5", "author": {"user": {"login": "jzaralim", "name": "Zara Lim"}}, "url": "https://github.com/confluentinc/ksql/commit/2fc75071f54b2d1763155b1f0d891d69142b5cc5", "committedDate": "2020-10-15T23:38:43Z", "message": "Rename Column Serde files"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExOTEzOTc4", "url": "https://github.com/confluentinc/ksql/pull/6400#pullrequestreview-511913978", "createdAt": "2020-10-19T15:53:37Z", "commit": {"oid": "2fc75071f54b2d1763155b1f0d891d69142b5cc5"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNTo1MzozN1rOHkVowg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNTo1OToxMlrOHkV42Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg2NTI4Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    throw new KsqlException(\"Cannot add existing column to schema: \" + e.getColumn());\n          \n          \n            \n                    throw new KsqlException(\"Cannot add column '\" + e.getColumn() + \"' to schema. A column with the same name already exists.\");", "url": "https://github.com/confluentinc/ksql/pull/6400#discussion_r507865282", "createdAt": "2020-10-19T15:53:37Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/ddl/commands/DdlCommandExec.java", "diffHunk": "@@ -127,6 +132,54 @@ public DdlCommandResult executeDropType(final DropTypeCommand dropType) {\n           ? new DdlCommandResult(true, \"Dropped type '\" + typeName + \"'\")\n           : new DdlCommandResult(true, \"Type '\" + typeName + \"' does not exist\");\n     }\n+\n+    @Override\n+    public DdlCommandResult executeAlterSource(final AlterSourceCommand alterSource) {\n+      final DataSource dataSource = metaStore.getSource(alterSource.getSourceName());\n+\n+      if (dataSource == null) {\n+        throw new KsqlException(\n+            \"Source \" + alterSource.getSourceName().text()\n+                + \" does not exist.\"\n+        );\n+      }\n+\n+      if (!dataSource.getDataSourceType().getKsqlType().equals(alterSource.getKsqlType())) {\n+        throw new KsqlException(String.format(\n+            \"Incompatible data source type is %s, but statement was ALTER %s\",\n+            dataSource.getDataSourceType().getKsqlType(),\n+            alterSource.getKsqlType()\n+        ));\n+      }\n+\n+      if (dataSource.isCasTarget()) {\n+        throw new KsqlException(String.format(\n+            \"ALTER command is not supported for CREATE ... AS statements.\"\n+        ));\n+      }\n+\n+      final LogicalSchema newSchema;\n+\n+      try {\n+        newSchema = dataSource.getSchema()\n+            .asBuilder()\n+            .valueColumns(alterSource.getNewColumns())\n+            .build();\n+      } catch (DuplicateColumnException e) {\n+        throw new KsqlException(\"Cannot add existing column to schema: \" + e.getColumn());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fc75071f54b2d1763155b1f0d891d69142b5cc5"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg2Njk2Ng==", "bodyText": "nit: let's java doc what sql is as well", "url": "https://github.com/confluentinc/ksql/pull/6400#discussion_r507866966", "createdAt": "2020-10-19T15:55:51Z", "author": {"login": "agavra"}, "path": "ksqldb-metastore/src/main/java/io/confluent/ksql/metastore/model/DataSource.java", "diffHunk": "@@ -97,4 +97,9 @@ public String getKsqlType() {\n    */\n   Optional<String> canUpgradeTo(DataSource other);\n \n+  /**\n+   * @param schema a schema", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fc75071f54b2d1763155b1f0d891d69142b5cc5"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg2OTQwMQ==", "bodyText": "I think we need to follow the pattern of SchemaParser and do the proper error handling (see usages of error listeners) otherwise it only gets logged to stdout", "url": "https://github.com/confluentinc/ksql/pull/6400#discussion_r507869401", "createdAt": "2020-10-19T15:59:12Z", "author": {"login": "agavra"}, "path": "ksqldb-parser/src/main/java/io/confluent/ksql/parser/json/ColumnDeserializor.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"; you may not use\n+ * this file except in compliance with the License. You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.parser.json;\n+\n+import com.fasterxml.jackson.core.JsonParser;\n+import com.fasterxml.jackson.databind.DeserializationContext;\n+import com.fasterxml.jackson.databind.JsonDeserializer;\n+import io.confluent.ksql.metastore.TypeRegistry;\n+import io.confluent.ksql.name.ColumnName;\n+import io.confluent.ksql.parser.CaseInsensitiveStream;\n+import io.confluent.ksql.parser.SqlBaseLexer;\n+import io.confluent.ksql.parser.SqlBaseParser;\n+import io.confluent.ksql.parser.SqlBaseParser.TableElementContext;\n+import io.confluent.ksql.schema.ksql.Column;\n+import io.confluent.ksql.schema.ksql.Column.Namespace;\n+import io.confluent.ksql.schema.ksql.SqlTypeParser;\n+import io.confluent.ksql.util.ParserUtil;\n+import java.io.IOException;\n+import org.antlr.v4.runtime.CharStreams;\n+import org.antlr.v4.runtime.CommonTokenStream;\n+\n+public class ColumnDeserializor extends JsonDeserializer<Column> {\n+\n+  public ColumnDeserializor() {\n+  }\n+\n+  @Override\n+  public Column deserialize(\n+      final JsonParser p,\n+      final DeserializationContext ctxt\n+  ) throws IOException {\n+    final String text = p.readValueAs(String.class);\n+    final SqlBaseLexer lexer = new SqlBaseLexer(\n+        new CaseInsensitiveStream(CharStreams.fromString(text))\n+    );\n+    final CommonTokenStream tokStream = new CommonTokenStream(lexer);\n+    final SqlBaseParser parser = new SqlBaseParser(tokStream);\n+    final TableElementContext context = parser.tableElement();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fc75071f54b2d1763155b1f0d891d69142b5cc5"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "055a8dfd7b0f902d4578c11274a15692b3085cfb", "author": {"user": {"login": "jzaralim", "name": "Zara Lim"}}, "url": "https://github.com/confluentinc/ksql/commit/055a8dfd7b0f902d4578c11274a15692b3085cfb", "committedDate": "2020-10-19T18:56:21Z", "message": "A couple of small changes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4627, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}