{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwNDcxODU5", "number": 6054, "title": "Single value wrapping", "bodyText": "Description\nfixes: #5994\nBetter fix for the above issue. Previous fix didn't fit right.\nThis fix introduces a SerdeFeature enum and an associated supportedFeatures() method on Format. This allows formats to define the features it supports.  This will work well when we come to 'User defined formats'.\nIf the user supplies WRAP_SINGLE_VALUES in the WITH clause, this will map to either SerdeOption.WRAP_SINGLE_VALUES or SerdeOption.UNWRAP_SINGLE_VALUES.  These two options map to SerdeFeature.WRAP_SINGLES and SerdeFeature.UNWRAP_SINGLES, respectively.\nIf the user doesn't supply WRAP_SINGLE_VALUES then no option is set and the format is free to use its default format. (Though this requires a follow up change to allow the default to be 'unwrapped').\nThere is also a config users can set to provide a default for the wrapping. This previously defaulted to true, and would have caused issues if used with a format that didn't support wrapping. The default has now been removed and the bug fixed. This is to allow formats to define their own default, rather than having it enforced by the system. For example, JSON will wrap by default, where as KAFKA will be unwrapped by default.  If a format does not support the default, it ignores it, rather than failing.\nReviewing notes\nPR broken down into individual commits to make things easier:\n\n1st commit: main code changes.\n2nd commit: test code changes.\n3rd commit: doc updates\n4th commit: historic plans only.\n5th commit: add validated set of options. Lots of files changed, but little functionality. replaced Set<SerdeOption> with SerdeOptions. The latter ensuring no bad combinations of options are possible.", "createdAt": "2020-08-19T21:38:14Z", "url": "https://github.com/confluentinc/ksql/pull/6054", "merged": true, "mergeCommit": {"oid": "a1c8062ce2b9c972d2fc85ad5df7a869cbc28444"}, "closed": true, "closedAt": "2020-08-21T19:31:55Z", "author": {"login": "big-andy-coates"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAikZpAH2gAyNDcwNDcxODU5OmY1OWRjNWZkZTg3NDAwYWYxZmNhM2M0YWI0ZGE4MzRkYTFkYTQ1YmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdBHJcygH2gAyNDcwNDcxODU5OjQxYmQwNzFlOWZkYmRlN2FjMWMzMDc0MmJjMDM2M2FkYTVhYjk1OGQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f59dc5fde87400af1fca3c4ab4da834da1da45ba", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/f59dc5fde87400af1fca3c4ab4da834da1da45ba", "committedDate": "2020-08-19T21:33:46Z", "message": "refactor: better fix for protobuf not supporting unwrapped values\n\nfixes: https://github.com/confluentinc/ksql/issues/5994\n\nBetter fix for the above issue. Previous fix didn't fit right.\n\nThis fix introduces a `SerdeFeature` enum and an associated `supportedFeatures()` method on `Format`. This allows formats to define the features it supports.  This will work well when we come to 'User defined formats'.\n\nIf the user supplies `WRAP_SINGLE_VALUES` in the `WITH` clause, this will map to either `SerdeOption.WRAP_SINGLE_VALUES` or `SerdeOption.UNWRAP_SINGLE_VALUES`.  These two options map to `SerdeFeature.WRAP_SINGLES` and `SerdeFeature.UNWRAP_SINGLES`, respectively.\n\nIf the user doesn't supply `WRAP_SINGLE_VALUES` then no option is set and the format is free to use its default format. Though this requires a follow up change to allow the default to be 'unwrapped'.\n\nThe default value for the config that provides the default for single value wrapping has been removed. This is to allow formats to define what they do by default, rather than having it enforced by the system. For example, JSON will wrap by default, where as KAFKA will be unwrapped by default."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "124a8784e78b520cd064f5a02c14a2a6f6d1ad04", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/124a8784e78b520cd064f5a02c14a2a6f6d1ad04", "committedDate": "2020-08-19T21:34:22Z", "message": "test: test changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40141e27010ec4b934f94adc82ccd3cc4f6acce1", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/40141e27010ec4b934f94adc82ccd3cc4f6acce1", "committedDate": "2020-08-19T21:51:09Z", "message": "docs: doc updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3703faa4e3e86bfded2b8707be9c7457b2171a7", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/c3703faa4e3e86bfded2b8707be9c7457b2171a7", "committedDate": "2020-08-19T21:54:30Z", "message": "test: historic plans"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "90c63a504868ce198c1174210c2bf650e47f44bd", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/90c63a504868ce198c1174210c2bf650e47f44bd", "committedDate": "2020-08-19T21:34:53Z", "message": "doc: doc updates"}, "afterCommit": {"oid": "c3703faa4e3e86bfded2b8707be9c7457b2171a7", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/c3703faa4e3e86bfded2b8707be9c7457b2171a7", "committedDate": "2020-08-19T21:54:30Z", "message": "test: historic plans"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/9080ec8549ac352e1242f9a31164e1cad83ecc97", "committedDate": "2020-08-19T22:14:18Z", "message": "refactor: validated set of options"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNjc1Nzk3", "url": "https://github.com/confluentinc/ksql/pull/6054#pullrequestreview-471675797", "createdAt": "2020-08-20T14:32:36Z", "commit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNDozMjozNlrOHEEdgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNDozNjozMlrOHEEoug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAyOTQ0MA==", "bodyText": "How come ProtobufFormat has WRAP_SINGLES in its set of supported features, but the Kafka and delimited formats have the empty supported feature sets? Seems inconsistent in that I'd expect Kafka and delimited to have UNWRAP_SINGLES in their supported feature sets to parallel this.", "url": "https://github.com/confluentinc/ksql/pull/6054#discussion_r474029440", "createdAt": "2020-08-20T14:32:36Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-serde/src/main/java/io/confluent/ksql/serde/protobuf/ProtobufFormat.java", "diffHunk": "@@ -16,17 +16,24 @@\n package io.confluent.ksql.serde.protobuf;\n \n import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n import io.confluent.connect.protobuf.ProtobufData;\n import io.confluent.connect.protobuf.ProtobufDataConfig;\n import io.confluent.kafka.schemaregistry.ParsedSchema;\n import io.confluent.kafka.schemaregistry.protobuf.ProtobufSchema;\n import io.confluent.ksql.serde.FormatInfo;\n import io.confluent.ksql.serde.KsqlSerdeFactory;\n+import io.confluent.ksql.serde.SerdeFeature;\n import io.confluent.ksql.serde.connect.ConnectFormat;\n+import java.util.Set;\n import org.apache.kafka.connect.data.Schema;\n \n public class ProtobufFormat extends ConnectFormat {\n \n+  private static final Set<SerdeFeature> SUPPORTED_FEATURES = ImmutableSet.of(\n+      SerdeFeature.WRAP_SINGLES", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAzMTA5Nw==", "bodyText": "It doesn't look like the docs specify what the default value for each format is.\nAlso, where is the default added in the code right now? Is it hard-coded to be wrapped (if SerdeOptions is empty) somewhere in the planner?", "url": "https://github.com/confluentinc/ksql/pull/6054#discussion_r474031097", "createdAt": "2020-08-20T14:34:49Z", "author": {"login": "vcrfxia"}, "path": "docs/operate-and-deploy/installation/server-config/config-reference.md", "diffHunk": "@@ -320,10 +321,10 @@ For more information, refer to the\n [CREATE STREAM AS SELECT](../../../developer-guide/ksqldb-reference/create-stream-as-select.md)\n statements.\n \n-!!! note\n-\t The `DELIMITED` format is not affected by the\n-    `ksql.persistence.ensure.value.is.struct` setting, because it has no\n-    concept of an outer record or structure.\n+ !!! note\n+   Not all formats support wrapping and unwrapping. If you use a format that does not support\n+   the default value you set, the format will ignore the setting. For information on which formats", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAzMjMxNA==", "bodyText": "The mapping between SerdeOption and SerdeFeature always be 1-to-1, right? What's the purpose of having SerdeOption wrap SerdeFeature?", "url": "https://github.com/confluentinc/ksql/pull/6054#discussion_r474032314", "createdAt": "2020-08-20T14:36:32Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-common/src/main/java/io/confluent/ksql/serde/SerdeOption.java", "diffHunk": "@@ -16,29 +16,42 @@\n package io.confluent.ksql.serde;\n \n import com.fasterxml.jackson.annotation.JsonCreator;\n-import com.google.common.collect.ImmutableSet;\n-import java.util.Set;\n+import java.util.Objects;\n \n public enum SerdeOption {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxODIwOTk2", "url": "https://github.com/confluentinc/ksql/pull/6054#pullrequestreview-471820996", "createdAt": "2020-08-20T17:09:43Z", "commit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNzowOTo0M1rOHELe-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNzowOTo0M1rOHELe-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0NDUwNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            When set to the `true` ksqlDB serializes the column value nested within a JSON object, Avro record,\n          \n          \n            \n            When set to `true`, ksqlDB serializes the column value nested within a JSON object, Avro record,", "url": "https://github.com/confluentinc/ksql/pull/6054#discussion_r474144507", "createdAt": "2020-08-20T17:09:43Z", "author": {"login": "JimGalasyn"}, "path": "docs/operate-and-deploy/installation/server-config/config-reference.md", "diffHunk": "@@ -274,10 +274,12 @@ not supplied explicitly in [CREATE TABLE](../../../developer-guide/ksqldb-refere\n [CREATE STREAM AS SELECT](../../../developer-guide/ksqldb-reference/create-stream-as-select.md)\n statements.\n \n-When set to the default value, `true`, ksqlDB serializes the column value\n-nested with a JSON object, Avro record, or Protobuf message, depending on the\n-format in use. When set to `false`, ksqlDB persists the column value without any\n-nesting.\n+If not set and no explicit value is provided in the statement, the value format's default wrapping \n+is used.\n+\n+When set to the `true` ksqlDB serializes the column value nested within a JSON object, Avro record,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxODIxOTI1", "url": "https://github.com/confluentinc/ksql/pull/6054#pullrequestreview-471821925", "createdAt": "2020-08-20T17:10:58Z", "commit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNzoxMDo1OFrOHELhqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNzoxMDo1OFrOHELhqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0NTE5Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               Not all formats support wrapping and unwrapping. If you use a format that does not support\n          \n          \n            \n               Not all formats support wrapping and unwrapping. If you use a format that doesn't support", "url": "https://github.com/confluentinc/ksql/pull/6054#discussion_r474145192", "createdAt": "2020-08-20T17:10:58Z", "author": {"login": "JimGalasyn"}, "path": "docs/operate-and-deploy/installation/server-config/config-reference.md", "diffHunk": "@@ -320,10 +321,10 @@ For more information, refer to the\n [CREATE STREAM AS SELECT](../../../developer-guide/ksqldb-reference/create-stream-as-select.md)\n statements.\n \n-!!! note\n-\t The `DELIMITED` format is not affected by the\n-    `ksql.persistence.ensure.value.is.struct` setting, because it has no\n-    concept of an outer record or structure.\n+ !!! note\n+   Not all formats support wrapping and unwrapping. If you use a format that does not support", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxODIyMjg2", "url": "https://github.com/confluentinc/ksql/pull/6054#pullrequestreview-471822286", "createdAt": "2020-08-20T17:11:26Z", "commit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNzoxMToyNlrOHELimQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQxNzoxMToyNlrOHELimQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDE0NTQzMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               the default value you set, the format will ignore the setting. For information on which formats\n          \n          \n            \n               the default value you set, the format ignores the setting. For information on which formats", "url": "https://github.com/confluentinc/ksql/pull/6054#discussion_r474145433", "createdAt": "2020-08-20T17:11:26Z", "author": {"login": "JimGalasyn"}, "path": "docs/operate-and-deploy/installation/server-config/config-reference.md", "diffHunk": "@@ -320,10 +321,10 @@ For more information, refer to the\n [CREATE STREAM AS SELECT](../../../developer-guide/ksqldb-reference/create-stream-as-select.md)\n statements.\n \n-!!! note\n-\t The `DELIMITED` format is not affected by the\n-    `ksql.persistence.ensure.value.is.struct` setting, because it has no\n-    concept of an outer record or structure.\n+ !!! note\n+   Not all formats support wrapping and unwrapping. If you use a format that does not support\n+   the default value you set, the format will ignore the setting. For information on which formats", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxODIyNTY5", "url": "https://github.com/confluentinc/ksql/pull/6054#pullrequestreview-471822569", "createdAt": "2020-08-20T17:11:50Z", "commit": {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58e01be53f34c42efbf540fa69b6f8f8b1c25c0d", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/58e01be53f34c42efbf540fa69b6f8f8b1c25c0d", "committedDate": "2020-08-21T11:22:27Z", "message": "Update docs/operate-and-deploy/installation/server-config/config-reference.md\n\nCo-authored-by: Jim Galasyn <jim.galasyn@confluent.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f32f9ec6e90349435d0abb58f0f89250c2d1acec", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/f32f9ec6e90349435d0abb58f0f89250c2d1acec", "committedDate": "2020-08-21T11:22:34Z", "message": "Update docs/operate-and-deploy/installation/server-config/config-reference.md\n\nCo-authored-by: Jim Galasyn <jim.galasyn@confluent.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61bda7112b3c12362f01c2055b660848f900368f", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/61bda7112b3c12362f01c2055b660848f900368f", "committedDate": "2020-08-21T11:22:41Z", "message": "Update docs/operate-and-deploy/installation/server-config/config-reference.md\n\nCo-authored-by: Jim Galasyn <jim.galasyn@confluent.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa6d3501d610086508bc24fa0af5ea31ddba8397", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/fa6d3501d610086508bc24fa0af5ea31ddba8397", "committedDate": "2020-08-21T11:23:08Z", "message": "test: fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fdab8a0f2eed4a097cfa1d5e078cf233144e1e2", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/0fdab8a0f2eed4a097cfa1d5e078cf233144e1e2", "committedDate": "2020-08-21T12:50:11Z", "message": "test: fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05fb229679e630a568144da3d1eff58657f0fedc", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/05fb229679e630a568144da3d1eff58657f0fedc", "committedDate": "2020-08-21T14:50:11Z", "message": "test: fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9449e101b2c32d92fc4405f370e21aed98f8cd5", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/c9449e101b2c32d92fc4405f370e21aed98f8cd5", "committedDate": "2020-08-21T15:53:06Z", "message": "test: fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41bd071e9fdbde7ac1c30742bc0363ada5ab958d", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/41bd071e9fdbde7ac1c30742bc0363ada5ab958d", "committedDate": "2020-08-21T16:10:49Z", "message": "test: fix test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4712, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}