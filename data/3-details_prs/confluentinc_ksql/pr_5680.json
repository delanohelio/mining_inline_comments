{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5NTY2MTE2", "number": 5680, "title": "feat: support WINDOWEND in WHERE of pull queries", "bodyText": "Description\nfixes: #5666\nPull queries can now reference WINDOWEND in their WHERE clause, (assuming the source is windowed):\nSELECT * FROM T\n   WHERE id = 10\n   AND 134874632 <= WINDOWSTART AND WINDOWEND < 134891111;\nTesting done\nusual\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-06-24T23:13:20Z", "url": "https://github.com/confluentinc/ksql/pull/5680", "merged": true, "mergeCommit": {"oid": "40f2f1317174d57c9356a1153580f83b0c03f2cb"}, "closed": true, "closedAt": "2020-06-25T10:40:21Z", "author": {"login": "big-andy-coates"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuiZW0AH2gAyNDM5NTY2MTE2OjNiZmRkMGMzNmE4MGU0Njk3ZTdhNjhjYWJhMTg2ZDcxMDc5NThjMzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcusO42gH2gAyNDM5NTY2MTE2OjE2N2I0MTkxNDllYjk4ZTY0OGI4ZjVhMDAxNzkzNDRkNDJjMmY1ZGU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3bfdd0c36a80e4697e7a68caba186d7107958c30", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/3bfdd0c36a80e4697e7a68caba186d7107958c30", "committedDate": "2020-06-24T23:11:04Z", "message": "feat: support WINDOWEND in WHERE of pull queries\n\nfixes: https://github.com/confluentinc/ksql/issues/5666"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MDcxMzI0", "url": "https://github.com/confluentinc/ksql/pull/5680#pullrequestreview-437071324", "createdAt": "2020-06-24T23:23:48Z", "commit": {"oid": "3bfdd0c36a80e4697e7a68caba186d7107958c30"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MDc1NjI2", "url": "https://github.com/confluentinc/ksql/pull/5680#pullrequestreview-437075626", "createdAt": "2020-06-24T23:35:40Z", "commit": {"oid": "3bfdd0c36a80e4697e7a68caba186d7107958c30"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMzozNTo0MFrOGomklA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMzo1MTo1MlrOGom3IA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIyODE4MA==", "bodyText": "Extra parens", "url": "https://github.com/confluentinc/ksql/pull/5680#discussion_r445228180", "createdAt": "2020-06-24T23:35:40Z", "author": {"login": "AlanConfluent"}, "path": "ksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/materialization/ks/KsMaterializedSessionTable.java", "diffHunk": "@@ -61,28 +63,35 @@\n   private List<WindowedRow> findSession(\n       final ReadOnlySessionStore<Struct, GenericRow> store,\n       final Struct key,\n-      final Range<Instant> windowStart\n+      final Range<Instant> windowStart,\n+      final Range<Instant> windowEnd\n   ) {\n     try (KeyValueIterator<Windowed<Struct>, GenericRow> it = store.fetch(key)) {\n \n       final Builder<WindowedRow> builder = ImmutableList.builder();\n \n       while (it.hasNext()) {\n         final KeyValue<Windowed<Struct>, GenericRow> next = it.next();\n+        final Window wnd = next.key.window();\n \n-        if (windowStart.contains(next.key.window().startTime())) {\n+        if (!windowStart.contains(wnd.startTime())) {\n+          continue;\n+        }\n+\n+        if (!windowEnd.contains((wnd.endTime()))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3bfdd0c36a80e4697e7a68caba186d7107958c30"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIzMjkyOA==", "bodyText": "Just for my own knowledge, why don't we fetch from the store using the same bounds as in KsMaterializedWindowTable.java.  Is it because the window sizes are not uniform in size and therefore we don't know exactly where to stop if all we know is the window start range?  If they provide a window end range now, it seems like we could provide bounds to the store lookup (and could use Long.MAX_VALUE anyway).", "url": "https://github.com/confluentinc/ksql/pull/5680#discussion_r445232928", "createdAt": "2020-06-24T23:51:52Z", "author": {"login": "AlanConfluent"}, "path": "ksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/materialization/ks/KsMaterializedSessionTable.java", "diffHunk": "@@ -61,28 +63,35 @@\n   private List<WindowedRow> findSession(\n       final ReadOnlySessionStore<Struct, GenericRow> store,\n       final Struct key,\n-      final Range<Instant> windowStart\n+      final Range<Instant> windowStart,\n+      final Range<Instant> windowEnd\n   ) {\n     try (KeyValueIterator<Windowed<Struct>, GenericRow> it = store.fetch(key)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3bfdd0c36a80e4697e7a68caba186d7107958c30"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "167b419149eb98e648b8f5a00179344d42c2f5de", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/167b419149eb98e648b8f5a00179344d42c2f5de", "committedDate": "2020-06-25T10:38:41Z", "message": "chore: changes requested by Alan"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 255, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}