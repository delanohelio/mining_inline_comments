{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4MjM4MzQx", "number": 4778, "title": "feat: Security plumbing", "bodyText": "Description\nThis PR includes a few bits of security plumbing needed in the new API\n\n\nA new handler that does the same as the old Jetty filter that allows custom authorization to be implemented (e.g. for RBAC in CP). This is obtained from the KsqlSecurityExtension class.\n\n\nA new handler that does the same as the custom Jetty filters that were installed for authentication e.g. in cloud and CP.\n\n\nSome changes in JaasAuthProvider to make sure that authorisation doesn't happen in the authentication stage.\n\n\nJaasAuthProviderTest is also ignored for now. @vcrfxia could you take a look at this please?\n\n\nA few other bits and pieces\n\n\nChanges to plugins can be seen here https://github.com/purplefox/confluent-security-plugins/pull/1\nTesting done\nNew test cases added\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-03-14T09:43:34Z", "url": "https://github.com/confluentinc/ksql/pull/4778", "merged": true, "mergeCommit": {"oid": "395626cbdfec86ceb0cf9ca99ad6c5cb66a473db"}, "closed": true, "closedAt": "2020-03-16T10:49:18Z", "author": {"login": "purplefox"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOImQfgFqTM3NDkzODQxNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOLIZcgBqjMxMzI0MDY5NjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0OTM4NDE3", "url": "https://github.com/confluentinc/ksql/pull/4778#pullrequestreview-374938417", "createdAt": "2020-03-16T06:35:24Z", "commit": {"oid": "d7432c6524831146e3a5f8533ff5440adb7fa57e"}, "state": "APPROVED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwNjozNToyNVrOF2m46g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwNzowMDozMFrOF2nmhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjgwNDU4Ng==", "bodyText": "Is this behavior (that authentication.method is ignored if a custom auth plugin is specified) consistent with the existing Jetty-based implementation ? It seems sensible that only one form of auth should be configured at a time, just want to double check that the usage of these configs matches that of the current implementation.", "url": "https://github.com/confluentinc/ksql/pull/4778#discussion_r392804586", "createdAt": "2020-03-16T06:35:25Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/ServerVerticle.java", "diffHunk": "@@ -96,19 +108,31 @@ int actualPort() {\n   private Router setupRouter() {\n     final Router router = Router.router(vertx);\n \n-    router.route().failureHandler(ServerVerticle::handleFailure);\n+    // We only want to apply failure handler and auth handlers to routes that are not proxied\n+    // as Jetty will do it's own auth and failure handler\n+    routeFailureToNewApi(router, ServerVerticle::handleFailure);\n+\n+    final Optional<AuthHandler> authHandler = getAuthHandler(server);\n+    final KsqlSecurityExtension securityExtension = server.getSecurityExtension();\n+    final Optional<AuthenticationPlugin> authenticationPlugin = server.getAuthenticationPlugin();\n \n-    getAuthHandler(server).ifPresent(authHandler -> {\n-      router.route().handler(ServerVerticle::pauseHandler);\n-      router.route().handler(authHandler);\n-      server\n-          .getSecurityExtension()\n-          .getAuthorizationProvider()\n-          .ifPresent(ksqlAuthorizationProvider -> router.route()\n-              .handler(new KsqlAuthorizationFilter(server.getWorkerExecutor(),\n+    if (authHandler.isPresent() || authenticationPlugin.isPresent()) {\n+      routeToNewApi(router, ServerVerticle::pauseHandler);\n+      if (authenticationPlugin.isPresent()) {\n+        // Authentication plugin has precedence", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7432c6524831146e3a5f8533ff5440adb7fa57e"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjgwNTU2NA==", "bodyText": "Can we clarify in the Java docs for the AuthenticationPlugin interface that the expected behavior of the plugin is to:\n\nend the response and return null for the principal, if the user fails to authenticate\nreturn the principal, if the user successfully authenticates\n\nNot sure whether this is standard practice, but I was surprised to see that the expectation is for the plugin to end the response if the user fails to authenticate.", "url": "https://github.com/confluentinc/ksql/pull/4778#discussion_r392805564", "createdAt": "2020-03-16T06:38:52Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/ServerVerticle.java", "diffHunk": "@@ -130,12 +154,32 @@ private Router setupRouter() {\n     return router;\n   }\n \n+  private Handler<RoutingContext> createAuthenticationPluginHandler(\n+      final AuthenticationPlugin securityHandlerPlugin) {\n+    return routingContext -> {\n+      final CompletableFuture<Principal> cf = securityHandlerPlugin\n+          .handleAuth(routingContext, server.getWorkerExecutor());\n+      cf.thenAccept(principal -> {\n+        if (principal == null) {\n+          // Not authenticated\n+          // Do nothing, response is already ended by the plugin", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7432c6524831146e3a5f8533ff5440adb7fa57e"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjgwNjc5Ng==", "bodyText": "As discussed offline, authMethod will never be null because the config has a default value (of NONE, meaning no authentication). This means that if a user specifies ksql.apiserver.authentication.method without setting authentication.method, then the value for ksql.apiserver.authentication.method will be overwritten with the default of no authentication which is not great but perhaps OK if we make it clear that during this transition from the old server to the new server, the old security configs are the ones that should be used. Could you add a note into the description for the new API server security configs making this explicit? I know it's just temporary but I'm worried others looking at the code may be surprised / confused. Perhaps we can also add a quick comment into this piece of code here too?\nSame concern with the other auth configs (auth role and realm) below.", "url": "https://github.com/confluentinc/ksql/pull/4778#discussion_r392806796", "createdAt": "2020-03-16T06:43:17Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/KsqlRestApplication.java", "diffHunk": "@@ -220,6 +224,24 @@ public static KsqlRestConfig convertToApiServerConfig(final KsqlRestConfig confi\n       }\n     }\n \n+    final String authMethod = config.getString(\"authentication.method\");\n+    if (authMethod != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7432c6524831146e3a5f8533ff5440adb7fa57e"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjgwNzA5OQ==", "bodyText": "It'd be more reliable to check if any of the authRoles is **, rather than checking that there is only a single auth role and it has value **.", "url": "https://github.com/confluentinc/ksql/pull/4778#discussion_r392807099", "createdAt": "2020-03-16T06:44:21Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/KsqlRestApplication.java", "diffHunk": "@@ -220,6 +224,24 @@ public static KsqlRestConfig convertToApiServerConfig(final KsqlRestConfig confi\n       }\n     }\n \n+    final String authMethod = config.getString(\"authentication.method\");\n+    if (authMethod != null) {\n+      origs.put(ApiServerConfig.AUTHENTICATION_METHOD_CONFIG, authMethod);\n+    }\n+    final List<String> authRoles = config.getList(\"authentication.roles\");\n+    if (authRoles != null) {\n+      if (authRoles.size() == 1 && authRoles.get(0).equals(\"**\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7432c6524831146e3a5f8533ff5440adb7fa57e"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjgwNzg3NQ==", "bodyText": "We should also add a check for * in the old config and remove it, since * in the old config meant to look at the web.xml file for roles, which AFAIC means no access since KSQL doesn't have a web.xml.\nWithout this, the default value of * for the old auth roles config will get propagated to the new config, which interprets * to mean all roles have access, which is the opposite meaning of the original default -- yikes!", "url": "https://github.com/confluentinc/ksql/pull/4778#discussion_r392807875", "createdAt": "2020-03-16T06:46:50Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/KsqlRestApplication.java", "diffHunk": "@@ -220,6 +224,24 @@ public static KsqlRestConfig convertToApiServerConfig(final KsqlRestConfig confi\n       }\n     }\n \n+    final String authMethod = config.getString(\"authentication.method\");\n+    if (authMethod != null) {\n+      origs.put(ApiServerConfig.AUTHENTICATION_METHOD_CONFIG, authMethod);\n+    }\n+    final List<String> authRoles = config.getList(\"authentication.roles\");\n+    if (authRoles != null) {\n+      if (authRoles.size() == 1 && authRoles.get(0).equals(\"**\")) {\n+        // \"**\" in old config means \"*\" in new config", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7432c6524831146e3a5f8533ff5440adb7fa57e"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjgxMDA4MQ==", "bodyText": "As discussed offline, we've got a test gap in our current integration tests in that we start directly from the ApiServerConfig and bypass this translation from old configs to new configs, which means we miss bugs in translation logic such as this one. We should plug this testing gap.", "url": "https://github.com/confluentinc/ksql/pull/4778#discussion_r392810081", "createdAt": "2020-03-16T06:50:25Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/KsqlRestApplication.java", "diffHunk": "@@ -220,6 +224,24 @@ public static KsqlRestConfig convertToApiServerConfig(final KsqlRestConfig confi\n       }\n     }\n \n+    final String authMethod = config.getString(\"authentication.method\");\n+    if (authMethod != null) {\n+      origs.put(ApiServerConfig.AUTHENTICATION_METHOD_CONFIG, authMethod);\n+    }\n+    final List<String> authRoles = config.getList(\"authentication.roles\");\n+    if (authRoles != null) {\n+      if (authRoles.size() == 1 && authRoles.get(0).equals(\"**\")) {\n+        // \"**\" in old config means \"*\" in new config", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjgwNzg3NQ=="}, "originalCommit": {"oid": "d7432c6524831146e3a5f8533ff5440adb7fa57e"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjgxMTYxMw==", "bodyText": "nit: can we rename this to shouldNotAllowQueryWithSecurityPluginIfAuthenticationFails or something similar? I find it confusing that there are two tests named shouldAllowQueryWithSecurityPlugin and shouldNotAllowQueryWithSecurityPlugin. Similarly for the other tests below.", "url": "https://github.com/confluentinc/ksql/pull/4778#discussion_r392811613", "createdAt": "2020-03-16T06:52:55Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/test/java/io/confluent/ksql/api/AuthTest.java", "diffHunk": "@@ -214,22 +221,57 @@ public void shouldAllowCloseQueryWithPermissionCheck() throws Exception {\n   @Test\n   public void shouldNotAllowQueryIfPermissionCheckThrowsException() throws Exception {\n     shouldNotAllowAccessIfPermissionCheckThrowsException(\n-        () -> shouldFailQuery(USER_WITH_ACCESS, USER_WITH_ACCESS_PWD));\n+        () -> shouldFailQuery(USER_WITH_ACCESS, USER_WITH_ACCESS_PWD, 403));\n   }\n \n   @Test\n   public void shouldNotAllowInsertsIfPermissionCheckThrowsException() throws Exception {\n     shouldNotAllowAccessIfPermissionCheckThrowsException(\n-        () -> shouldFailInsertRequest(USER_WITH_ACCESS, USER_WITH_ACCESS_PWD));\n+        () -> shouldFailInsertRequest(USER_WITH_ACCESS, USER_WITH_ACCESS_PWD, 403));\n   }\n \n   @Test\n   public void shouldNotAllowCloseQueryIfPermissionCheckThrowsException() throws Exception {\n     shouldNotAllowAccessIfPermissionCheckThrowsException(\n-        () -> shouldFailCloseQuery(USER_WITH_ACCESS, USER_WITH_ACCESS_PWD));\n+        () -> shouldFailCloseQuery(USER_WITH_ACCESS, USER_WITH_ACCESS_PWD, 403));\n   }\n \n-  private void shouldFailQuery(final String username, final String password) throws Exception {\n+  @Test\n+  public void shouldAllowQueryWithSecurityPlugin() throws Exception {\n+    shouldAuthenticateWithSecurityPlugin(USER_WITHOUT_ACCESS, super::shouldExecutePullQuery, true);\n+  }\n+\n+  @Test\n+  public void shouldNotAllowQueryWithSecurityPlugin() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7432c6524831146e3a5f8533ff5440adb7fa57e"}, "originalPosition": 131}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjgxMzA4MA==", "bodyText": "This test is confusing on first read since it tests a user's ability to successfully access an endpoint, yet the user in the test is USER_WITHOUT_ACCESS. Can we update this to USER_WITH_ACCESS? And similarly for the other tests.", "url": "https://github.com/confluentinc/ksql/pull/4778#discussion_r392813080", "createdAt": "2020-03-16T06:55:33Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/test/java/io/confluent/ksql/api/AuthTest.java", "diffHunk": "@@ -214,22 +221,57 @@ public void shouldAllowCloseQueryWithPermissionCheck() throws Exception {\n   @Test\n   public void shouldNotAllowQueryIfPermissionCheckThrowsException() throws Exception {\n     shouldNotAllowAccessIfPermissionCheckThrowsException(\n-        () -> shouldFailQuery(USER_WITH_ACCESS, USER_WITH_ACCESS_PWD));\n+        () -> shouldFailQuery(USER_WITH_ACCESS, USER_WITH_ACCESS_PWD, 403));\n   }\n \n   @Test\n   public void shouldNotAllowInsertsIfPermissionCheckThrowsException() throws Exception {\n     shouldNotAllowAccessIfPermissionCheckThrowsException(\n-        () -> shouldFailInsertRequest(USER_WITH_ACCESS, USER_WITH_ACCESS_PWD));\n+        () -> shouldFailInsertRequest(USER_WITH_ACCESS, USER_WITH_ACCESS_PWD, 403));\n   }\n \n   @Test\n   public void shouldNotAllowCloseQueryIfPermissionCheckThrowsException() throws Exception {\n     shouldNotAllowAccessIfPermissionCheckThrowsException(\n-        () -> shouldFailCloseQuery(USER_WITH_ACCESS, USER_WITH_ACCESS_PWD));\n+        () -> shouldFailCloseQuery(USER_WITH_ACCESS, USER_WITH_ACCESS_PWD, 403));\n   }\n \n-  private void shouldFailQuery(final String username, final String password) throws Exception {\n+  @Test\n+  public void shouldAllowQueryWithSecurityPlugin() throws Exception {\n+    shouldAuthenticateWithSecurityPlugin(USER_WITHOUT_ACCESS, super::shouldExecutePullQuery, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7432c6524831146e3a5f8533ff5440adb7fa57e"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjgxMzk4Mw==", "bodyText": "Do we need to pass expectedUser into this method? I don't see any verification for it. If its only usage is in  creating the StringPrincipal we can probably just remove the parameter and put in a dummy value.", "url": "https://github.com/confluentinc/ksql/pull/4778#discussion_r392813983", "createdAt": "2020-03-16T06:56:52Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/test/java/io/confluent/ksql/api/AuthTest.java", "diffHunk": "@@ -315,6 +356,37 @@ private void assertAuthorisedSecurityContext(String username) {\n         is(username));\n   }\n \n+  private void shouldAuthenticateWithSecurityPlugin(final String expectedUser,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7432c6524831146e3a5f8533ff5440adb7fa57e"}, "originalPosition": 208}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjgxNTM1Ng==", "bodyText": "I see this PR moves the async handling for creating QueryPublishers and InsertStreamSubscribers from those classes into KsqlServerEndpoints. Why is this preferred? (Trying to learn guidelines for determining where it makes sense for async handling to take place.)", "url": "https://github.com/confluentinc/ksql/pull/4778#discussion_r392815356", "createdAt": "2020-03-16T06:58:58Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/endpoints/KsqlServerEndpoints.java", "diffHunk": "@@ -52,28 +56,36 @@ public KsqlServerEndpoints(\n   }\n \n   @Override\n-  public QueryPublisher createQueryPublisher(final String sql, final JsonObject properties,\n+  public CompletableFuture<QueryPublisher> createQueryPublisher(final String sql,\n+      final JsonObject properties,\n       final Context context,\n       final WorkerExecutor workerExecutor,\n       final ApiSecurityContext apiSecurityContext) {\n-    return new QueryStreamEndpoint(ksqlEngine, ksqlConfig, pullQueryExecutor)\n-        .createQueryPublisher(sql, properties, context, workerExecutor,\n-            createServiceContext(apiSecurityContext));\n+    return executeOnWorker(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7432c6524831146e3a5f8533ff5440adb7fa57e"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjgxNjI2Mg==", "bodyText": "As part of moving the async handling for creating InsertsStreamSubsribers to KsqlServerEndpoints, this optimization for non-serial blocking code execution was lost. I assume that's no big deal, but wanted to call it out in case the optimization was significant.", "url": "https://github.com/confluentinc/ksql/pull/4778#discussion_r392816262", "createdAt": "2020-03-16T07:00:30Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/InsertsStreamHandler.java", "diffHunk": "@@ -216,20 +213,4 @@ private void handleResponseEnd() {\n \n   }\n \n-  private CompletableFuture<InsertsStreamSubscriber> createInsertsSubscriberAsync(\n-      final String target,\n-      final JsonObject properties, final Subscriber<InsertResult> acksSubscriber,\n-      final Context context,\n-      final ApiSecurityContext apiSecurityContext) {\n-    final VertxCompletableFuture<InsertsStreamSubscriber> vcf = new VertxCompletableFuture<>();\n-    workerExecutor.executeBlocking(\n-        p -> p.complete(\n-            endpoints.createInsertsSubscriber(target, properties, acksSubscriber, context,\n-                workerExecutor, apiSecurityContext)),\n-        false,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7432c6524831146e3a5f8533ff5440adb7fa57e"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d88a50cbd9a6d15dc225ebca0bcccb6bf1a3a16e", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/d88a50cbd9a6d15dc225ebca0bcccb6bf1a3a16e", "committedDate": "2020-03-16T09:18:47Z", "message": "Security plumbing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9c4843a283b466b67d79e4c3ff035fe5b871d6e", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/d9c4843a283b466b67d79e4c3ff035fe5b871d6e", "committedDate": "2020-03-16T09:18:51Z", "message": "Some updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e030b4fb9cc87b05a0833ad0b925de729f99813", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/3e030b4fb9cc87b05a0833ad0b925de729f99813", "committedDate": "2020-03-16T09:18:51Z", "message": "Updated JaasAuthProviderTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81933890e200f23bfac29473f90f610297b2e1c8", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/81933890e200f23bfac29473f90f610297b2e1c8", "committedDate": "2020-03-16T09:18:51Z", "message": "Review updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7360afae0e778781b13af9c8dafb68ae0672023", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/e7360afae0e778781b13af9c8dafb68ae0672023", "committedDate": "2020-03-16T09:58:32Z", "message": "Fixed test after merge"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d7432c6524831146e3a5f8533ff5440adb7fa57e", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/d7432c6524831146e3a5f8533ff5440adb7fa57e", "committedDate": "2020-03-15T07:17:12Z", "message": "Updated JaasAuthProviderTest"}, "afterCommit": {"oid": "e7360afae0e778781b13af9c8dafb68ae0672023", "author": {"user": {"login": "purplefox", "name": "Tim Fox"}}, "url": "https://github.com/confluentinc/ksql/commit/e7360afae0e778781b13af9c8dafb68ae0672023", "committedDate": "2020-03-16T09:58:32Z", "message": "Fixed test after merge"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 15, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}