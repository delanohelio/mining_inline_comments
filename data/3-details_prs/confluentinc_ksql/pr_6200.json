{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg2OTM4NzU4", "number": 6200, "title": "refactor: push Connect schema down", "bodyText": "Description\nFollowing on from the fixes and refactors done in #6188, this commit pushes down the use of the Connect schema type to lower levels of the code. Higher levels of the code now deal with LogicalSchema, PersistentSchema or just a List<SimpleColumn>.\nThis moves us closer to removing the Connect schema from the code base, except in the Serde code that deals with connect formats.\nLogicalSchema and PersistentSchema no longer know about the Connect schema type. Calls to retrieve the Connect schema from these types have been replaced with a util function that can convert a list of columns into a Struct Connect schema.  As more code moves away from the Connect schema these util function calls will slowly be removed.\nA good sign this is an improvement is that this PR deletes more code than it adds, and now error messages use SQL types, not connect types.\nTesting done\nusual\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-09-14T23:14:23Z", "url": "https://github.com/confluentinc/ksql/pull/6200", "merged": true, "mergeCommit": {"oid": "c57bdb187b90d60f8a70fd2aee6297e39dc7a7ab"}, "closed": true, "closedAt": "2020-09-16T08:37:53Z", "author": {"login": "big-andy-coates"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdH69wNgH2gAyNDg2OTM4NzU4OmE3ZjIzZmY1NWZkM2ViYTk1NDNiZDQzN2ZmZDU5NGM3ZDA0YjhhYjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJQrl9gFqTQ4OTE2MDkyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a7f23ff55fd3eba9543bd437ffd594c7d04b8ab5", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/a7f23ff55fd3eba9543bd437ffd594c7d04b8ab5", "committedDate": "2020-09-11T19:56:39Z", "message": "fix: register correct unwrapped schema\n\nThis commit fixes several issues and refactors a lot of the serde code around wrapping and unwrapping single values.\n\nThe main issues being fixed are:\n  1. allow each format to define if it supported wrapping and/or unwrapping. (Not possible with current design)\n  2. pass the correct wrapping / unwrapping flags are passed to key vs value formats when creating serde. (bug in code passes same SerdeOptions to key and value).\n  3. register the correct wrapped / unwrapped schema with the SR. (bug in existing code meant registered format is always wrapped).\n\nAt the same time, the way wrapping / unwrapping was handled in the code wasn't great. Formats like `JSON` needed to be able to handle both wrapped and unwrapped schemas and values, depending on whether the user _explicitly_ set wrapping or unwrapping, vs the default behaviour of the format. This commit refactors the code such that the format will always be passed the a consistent schema and the set of serde features the format should use when creating the serde. This simplifies things and paves the way to user-define-serde."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cf7cf11e94cb14801bfc6ba02d040eb5835ded6", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/8cf7cf11e94cb14801bfc6ba02d040eb5835ded6", "committedDate": "2020-09-11T22:10:00Z", "message": "test: historic plans"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c764c7a29ea096080d2376d4c3e2d8463532d39", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/7c764c7a29ea096080d2376d4c3e2d8463532d39", "committedDate": "2020-09-14T22:45:35Z", "message": "chore: almog's requested changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6722928d7536fc6f06ae2246ab10e0723f750920", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/6722928d7536fc6f06ae2246ab10e0723f750920", "committedDate": "2020-09-14T23:12:30Z", "message": "refactor: push ConnectSchema down\n\nFollowing on from the fixes and refactors done in #6188, this commit pushes down the use of the Connect schema type to lower levels of the code. Higher levels of the code now deal with `LogicalSchema`, `PersistentSchema` or just a `List<SimpleColumn>`.\n\nThis moves us closer to removing the Connect schema from the code base, except in the Serde code that deals with connect formats.\n\n`LogicalSchema` and `PersistentSchema` no longer know about the Connect schema type. Calls to retrieve the Connect schema from these types have been replaced with a util function that can convert a list of columns into a Struct Connect schema.  As more code moves away from the Connect schema these util function calls will slowly be removed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db6dbe6af299b2804d80ee1dc17b68699092a1ee", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/db6dbe6af299b2804d80ee1dc17b68699092a1ee", "committedDate": "2020-09-15T00:21:39Z", "message": "chore: merge from master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MTYwOTIz", "url": "https://github.com/confluentinc/ksql/pull/6200#pullrequestreview-489160923", "createdAt": "2020-09-15T22:52:54Z", "commit": {"oid": "db6dbe6af299b2804d80ee1dc17b68699092a1ee"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQyMjo1Mjo1NFrOHSZKeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQyMjo1NjoxOFrOHSZU0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA0ODY5Nw==", "bodyText": "nit: this was true before your change, but we should consider how this design fares with regards to performance. we should not be creating a schema per-record (as I think we are here) - the older code would have been easier to \"cache\" the result inside the data source", "url": "https://github.com/confluentinc/ksql/pull/6200#discussion_r489048697", "createdAt": "2020-09-15T22:52:54Z", "author": {"login": "agavra"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/impl/KeyValueExtractor.java", "diffHunk": "@@ -35,9 +37,13 @@\n   private KeyValueExtractor() {\n   }\n \n-  public static Struct extractKey(final JsonObject values, final LogicalSchema logicalSchema,\n-      final SqlValueCoercer sqlValueCoercer) {\n-    final Struct key = new Struct(logicalSchema.keyConnectSchema());\n+  public static Struct extractKey(\n+      final JsonObject values,\n+      final LogicalSchema logicalSchema,\n+      final SqlValueCoercer sqlValueCoercer\n+  ) {\n+    final ConnectSchema keySchema = ConnectSchemas.columnsToConnectSchema(logicalSchema.key());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db6dbe6af299b2804d80ee1dc17b68699092a1ee"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTA1MTM0Ng==", "bodyText": "pull queries are less problematic, but here's another per-record conversion", "url": "https://github.com/confluentinc/ksql/pull/6200#discussion_r489051346", "createdAt": "2020-09-15T22:56:18Z", "author": {"login": "agavra"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/PullQueryExecutor.java", "diffHunk": "@@ -1048,10 +1050,12 @@ private static KsqlException invalidWhereClauseException(\n   }\n \n   private static Struct asKeyStruct(final Object keyValue, final PhysicalSchema physicalSchema) {\n-    final Field keyField = Iterables\n-        .getOnlyElement(physicalSchema.keySchema().connectSchema().fields());\n+    final ConnectSchema keySchema = ConnectSchemas\n+        .columnsToConnectSchema(physicalSchema.keySchema().columns());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db6dbe6af299b2804d80ee1dc17b68699092a1ee"}, "originalPosition": 23}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4652, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}