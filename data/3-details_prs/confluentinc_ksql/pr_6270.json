{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxMDM2MTQ5", "number": 6270, "title": "refactor: Format interface", "bodyText": "Description\nIn prep for user-defined-formats and just to tidy up the interface and fix some bugs while I had a spare moment...\nRefactor\nRefactored the Format interface so that the functions used during schema inference, i.e. toParsedSchema and toColumns, are moved onto a new interface SchemaTranslator. The SchemaTranslator is obtained from the Format by calling getSchemaTranslator, passing in the format properties.\nThis removes the strange requirement of having to pass a FormatInfo, which contains the name of the format, to the toParsedSchema method.\nAnd ensures consistent properties are used for both toParsedSchema and toColumns. (Though at the moment properties are only needed in toParsedSchema, that may not be the case once user-definfed-formats are supported.\nSwitched the supportsSchemaInference method on Format to a SerdeFeature, reducing the surface of the interface.\nFixes / Enhancements\nFixed a bug / ux issue, where a C* statement that was using schema inference would not report any issues if the supplied VALUE_FORMAT did not match the type of the schema in the schema registry. For example, if VALUE_FORMAT was AVRO, but the schema returned by the Schema Registry was JsonSchema, then the statement would succeed... and would later generate lots of deserialisation errors if used. The statement will now fail.\nTesting done\nUsual\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-09-22T15:49:33Z", "url": "https://github.com/confluentinc/ksql/pull/6270", "merged": true, "mergeCommit": {"oid": "b3e37af66fa798cc33f7f37dc8295eed57195d97"}, "closed": true, "closedAt": "2020-09-30T10:00:32Z", "author": {"login": "big-andy-coates"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLZqRWAH2gAyNDkxMDM2MTQ5OjM5N2EyYTVmZmQ2ZDE5OTlmNjkwNzQ4ZWNlMzkzMzJlNWQwMzNhN2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdN4zc6AH2gAyNDkxMDM2MTQ5OjU1NDBmMWQ4NWJmZjY4NDRkOTEyYzhjNGUwZGVkZmY5Mzg3ZWE4YTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "397a2a5ffd6d1999f690748ece39332e5d033a7d", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/397a2a5ffd6d1999f690748ece39332e5d033a7d", "committedDate": "2020-09-22T15:24:12Z", "message": "refactor: format interface\n\nIn prep for user-defined-formats and just to tidy up the interface and fix some bugs...\n\n## Refactor\n\nRefactored the `Format` interface so that the functions used during schema inference, i.e. `toParsedSchema` and `toColumns`, are moved onto a new interface `SchemaTranslator`. The `SchemaTranslator` is obtained from the `Format` by calling `getSchemaTranslator`, passing in the format properties.\n\nThis removes the strange requirement of having to pass a `FormatInfo`, which contains the name of the format, to the `toParsedSchema` method.\n\nAnd ensures consistent properties are used for both `toParsedSchema` and `toColumns`. (Though at the moment properties are only needed in `toParsedSchema`, that may not be the case once user-definfed-formats are supported.\n\n## Fixes / Enhancements\nFixed a bug / ux issue, where a C* statement that was using schema inference would not report any issues if the supplied `VALUE_FORMAT` did not match the type of the schema in the schema registry. For example, if `VALUE_FORMAT` was `AVRO`, but the schema returned by the Schema Registry was `JsonSchema`, then the statement would succeed... and would later generate lots of deserialisation errors if used. The statement will now fail."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47a082f0e512abb4202d2c1befce0a2fb32118e6", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/47a082f0e512abb4202d2c1befce0a2fb32118e6", "committedDate": "2020-09-22T15:28:31Z", "message": "chore: move Avro specific constants into Avro package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ac2f7d958a0bc201533a3fa1c36521e26a9a8e6", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/7ac2f7d958a0bc201533a3fa1c36521e26a9a8e6", "committedDate": "2020-09-22T15:46:32Z", "message": "chore: switch schema inference to a SerdeFeature"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c5c49e28651148f37bc648072a36907363f6514", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/8c5c49e28651148f37bc648072a36907363f6514", "committedDate": "2020-09-22T16:12:30Z", "message": "chore: fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7347c0066a4e4ac7c84f58bb8889eddf0331f60f", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/7347c0066a4e4ac7c84f58bb8889eddf0331f60f", "committedDate": "2020-09-29T16:05:45Z", "message": "chore: merge from master\n\nConflicting files\nksqldb-engine/src/main/java/io/confluent/ksql/engine/InsertValuesExecutor.java\nksqldb-engine/src/main/java/io/confluent/ksql/schema/ksql/inference/SchemaRegisterInjector.java\nksqldb-engine/src/main/java/io/confluent/ksql/topic/TopicDeleteInjector.java\nksqldb-engine/src/main/java/io/confluent/ksql/util/AvroUtil.java\nksqldb-engine/src/test/java/io/confluent/ksql/integration/IntegrationTestHarness.java\nksqldb-engine/src/test/java/io/confluent/ksql/util/AvroUtilTest.java\nksqldb-functional-tests/src/main/java/io/confluent/ksql/test/tools/TestCaseBuilderUtil.java\nksqldb-functional-tests/src/main/java/io/confluent/ksql/test/tools/TestExecutorUtil.java\nksqldb-rest-app/src/main/java/io/confluent/ksql/rest/util/ClusterTerminator.java\nksqldb-rest-app/src/test/java/io/confluent/ksql/rest/integration/KsqlResourceFunctionalTest.java\nksqldb-serde/src/test/java/io/confluent/ksql/serde/avro/AvroFormatTest.java\nksqldb-serde/src/test/java/io/confluent/ksql/serde/connect/ConnectFormatTest.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5MDA0NTE2", "url": "https://github.com/confluentinc/ksql/pull/6270#pullrequestreview-499004516", "createdAt": "2020-09-30T00:03:47Z", "commit": {"oid": "7347c0066a4e4ac7c84f58bb8889eddf0331f60f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwMDowMzo0N1rOHaIYQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQwMDoxMjoxMlrOHaIuxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE2MjMwNA==", "bodyText": "\ud83d\udcaf", "url": "https://github.com/confluentinc/ksql/pull/6270#discussion_r497162304", "createdAt": "2020-09-30T00:03:47Z", "author": {"login": "agavra"}, "path": "ksqldb-common/src/main/java/io/confluent/ksql/serde/SerdeFeature.java", "diffHunk": "@@ -24,6 +24,15 @@\n  */\n public enum SerdeFeature {\n \n+  /**\n+   * The format supports interaction with the Confluent Schema Registry.\n+   *\n+   * <p>Indicates whether or not a format can support CREATE statements that\n+   * omit the table elements and instead determine the schema from a Confluent Schema Registry\n+   * query.\n+   */\n+  SCHEMA_INFERENCE,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7347c0066a4e4ac7c84f58bb8889eddf0331f60f"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE2ODA2OA==", "bodyText": "nit: comment needs to be updated getSupportedProperties() is no longer a method call here", "url": "https://github.com/confluentinc/ksql/pull/6270#discussion_r497168068", "createdAt": "2020-09-30T00:12:12Z", "author": {"login": "agavra"}, "path": "ksqldb-serde/src/main/java/io/confluent/ksql/serde/FormatProperties.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.serde;\n+\n+import com.google.common.collect.Sets;\n+import com.google.common.collect.Sets.SetView;\n+import io.confluent.ksql.util.KsqlException;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * Util class for handling format properties\n+ */\n+public final class FormatProperties {\n+\n+  private FormatProperties() {\n+  }\n+\n+  public static void validateProperties(\n+      final String formatName,\n+      final Map<String, String> properties,\n+      final Set<String> supportedProperties\n+  ) {\n+    // by default, this method ensures that there are no property names\n+    // (case-insensitive) that are not in the getSupportedProperties()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7347c0066a4e4ac7c84f58bb8889eddf0331f60f"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7cf2c32daa566525a92944db2135349763f00ba", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/e7cf2c32daa566525a92944db2135349763f00ba", "committedDate": "2020-09-30T08:36:09Z", "message": "Merge branch 'master' into format_refac"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5540f1d85bff6844d912c8c4e0dedff9387ea8a3", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/5540f1d85bff6844d912c8c4e0dedff9387ea8a3", "committedDate": "2020-09-30T08:49:08Z", "message": "chore: review comments and stuff"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4667, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}