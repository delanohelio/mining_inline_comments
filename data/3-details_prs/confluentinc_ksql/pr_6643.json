{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzNjY5MzQ1", "number": 6643, "title": "chore: emit metrics with ksql.service.id in metrics tag", "bodyText": "Description\nAddresses #5948\nWe'll keep the legacy metrics with the ksql service id in the metric name for now so as to not break existing monitoring/metrics collection. Once those have been updated,  the old metrics can be removed at a later date.\nThe old legacy metrics were removed also.\nio.confluent.ksql.metrics:type=ksql-engine-query-stats\nThese are considered legacy metrics now:\nio.confluent.ksql.metrics:type=_confluent-ksql-default_ksql-engine-query-stats\nThese are the new metrics naming convention:\nio.confluent.ksql.metrics:type=_confluent-ksql-engine-query-stats,ksql_service_id=default_\nTesting done\nUnit test\nLooked at metrics in jconsole and verified that there are two sets of metric, one with new naming scheme and one with old\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-11-19T04:34:28Z", "url": "https://github.com/confluentinc/ksql/pull/6643", "merged": true, "mergeCommit": {"oid": "40f518b8a378b1458232dece229b27fccc8f5d0c"}, "closed": true, "closedAt": "2020-12-07T22:26:02Z", "author": {"login": "stevenpyzhang"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeHHbqgBqjQwMTczMjUxMzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj8K75ABqjQwODE2OTEyODc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2802fd58dec4fda4067559666a9a625b9169222f", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/2802fd58dec4fda4067559666a9a625b9169222f", "committedDate": "2020-11-19T04:26:27Z", "message": "chore: emit metrics with ksql.service.id in metrics tag"}, "afterCommit": {"oid": "8c5d8dcf2370a5026b6a13ab46a176dfef14909b", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/8c5d8dcf2370a5026b6a13ab46a176dfef14909b", "committedDate": "2020-11-19T18:32:10Z", "message": "chore: emit metrics with ksql.service.id in metrics tag"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "783d52128e9a5817271273572c4144da0ff6fd6f", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/783d52128e9a5817271273572c4144da0ff6fd6f", "committedDate": "2020-11-20T21:07:25Z", "message": "update tag with underscores instead of ."}, "afterCommit": {"oid": "2f46f423dcfd74451f08fe68bf03e85d900aa3d3", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/2f46f423dcfd74451f08fe68bf03e85d900aa3d3", "committedDate": "2020-11-30T17:45:14Z", "message": "update tag with underscores instead of ."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a224b6f5a82ea8a5e4d6a8bd1a929bd158e8b2df", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/a224b6f5a82ea8a5e4d6a8bd1a929bd158e8b2df", "committedDate": "2020-11-30T17:47:20Z", "message": "chore: emit metrics with ksql.service.id in metrics tag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de1c557de0b7e93fa49851ca3f783769c9c574a2", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/de1c557de0b7e93fa49851ca3f783769c9c574a2", "committedDate": "2020-11-30T17:47:27Z", "message": "update tag with underscores instead of ."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2f46f423dcfd74451f08fe68bf03e85d900aa3d3", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/2f46f423dcfd74451f08fe68bf03e85d900aa3d3", "committedDate": "2020-11-30T17:45:14Z", "message": "update tag with underscores instead of ."}, "afterCommit": {"oid": "de1c557de0b7e93fa49851ca3f783769c9c574a2", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/de1c557de0b7e93fa49851ca3f783769c9c574a2", "committedDate": "2020-11-30T17:47:27Z", "message": "update tag with underscores instead of ."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTYxMTIx", "url": "https://github.com/confluentinc/ksql/pull/6643#pullrequestreview-541161121", "createdAt": "2020-11-30T18:02:54Z", "commit": {"oid": "de1c557de0b7e93fa49851ca3f783769c9c574a2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMjg5NDU2", "url": "https://github.com/confluentinc/ksql/pull/6643#pullrequestreview-543289456", "createdAt": "2020-12-02T22:26:45Z", "commit": {"oid": "de1c557de0b7e93fa49851ca3f783769c9c574a2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMjoyNjo0NlrOH9wu7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMjoyNjo0NlrOH9wu7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUyMzYyOQ==", "bodyText": "Why are we changing the name and group for legacy metric here?", "url": "https://github.com/confluentinc/ksql/pull/6643#discussion_r534523629", "createdAt": "2020-12-02T22:26:46Z", "author": {"login": "harinirajendran"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/internal/KsqlEngineMetrics.java", "diffHunk": "@@ -298,15 +307,19 @@ private void configureMetric(\n       final KsqlMetric metric) {\n     // legacy\n     sensor.add(\n-        metrics.metricName(ksqlServiceId + metric.name(), metricGroupName, metric.description()),\n+        metrics.metricName(\n+            metric.name(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de1c557de0b7e93fa49851ca3f783769c9c574a2"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMjg5OTA4", "url": "https://github.com/confluentinc/ksql/pull/6643#pullrequestreview-543289908", "createdAt": "2020-12-02T22:27:31Z", "commit": {"oid": "de1c557de0b7e93fa49851ca3f783769c9c574a2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMjoyNzozMVrOH9wwag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMjoyNzozMVrOH9wwag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUyNDAxMA==", "bodyText": "Why are we changing the name and group for legacy metric here?", "url": "https://github.com/confluentinc/ksql/pull/6643#discussion_r534524010", "createdAt": "2020-12-02T22:27:31Z", "author": {"login": "harinirajendran"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/internal/KsqlEngineMetrics.java", "diffHunk": "@@ -346,16 +359,16 @@ private void configureNumActiveQueriesForGivenState(\n     final String name = state + \"-queries\";\n     // legacy\n     configureGaugeForState(\n-        ksqlServiceId + metricGroupName + \"-\" + name,\n-        metricGroupName,\n-        Collections.emptyMap(),\n+        name,\n+        ksqlServiceIdLegacyPrefix + metricGroupName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de1c557de0b7e93fa49851ca3f783769c9c574a2"}, "originalPosition": 83}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMzA5Mjc2", "url": "https://github.com/confluentinc/ksql/pull/6643#pullrequestreview-543309276", "createdAt": "2020-12-02T23:01:40Z", "commit": {"oid": "de1c557de0b7e93fa49851ca3f783769c9c574a2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MjcxMzk5", "url": "https://github.com/confluentinc/ksql/pull/6643#pullrequestreview-544271399", "createdAt": "2020-12-03T18:47:50Z", "commit": {"oid": "de1c557de0b7e93fa49851ca3f783769c9c574a2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MzQzOTAz", "url": "https://github.com/confluentinc/ksql/pull/6643#pullrequestreview-546343903", "createdAt": "2020-12-07T16:56:30Z", "commit": {"oid": "de1c557de0b7e93fa49851ca3f783769c9c574a2"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNjo1NjozMFrOIAwg6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNjo1NjozMFrOIAwg6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY2NTc2OQ==", "bodyText": "Could this be more efficient as it does 1 copy instead of 2?.\nthis.newCustomMetricsTags = ImmutableMap.<String, String>builder()\n       .putAll(customMetricsTags)\n       .put(KsqlConstants.KSQL_SERVICE_ID_METRICS_TAG, ksqlEngine.getServiceId())\n       .build();", "url": "https://github.com/confluentinc/ksql/pull/6643#discussion_r537665769", "createdAt": "2020-12-07T16:56:30Z", "author": {"login": "spena"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/internal/KsqlEngineMetrics.java", "diffHunk": "@@ -88,13 +92,18 @@ public KsqlEngineMetrics(\n       final Optional<KsqlMetricsExtension> metricsExtension\n   ) {\n     this.ksqlEngine = ksqlEngine;\n-    this.ksqlServiceId = ReservedInternalTopics.KSQL_INTERNAL_TOPIC_PREFIX\n+    this.ksqlServiceIdLegacyPrefix = ReservedInternalTopics.KSQL_INTERNAL_TOPIC_PREFIX\n         + ksqlEngine.getServiceId();\n+    this.ksqlServicePrefix = ReservedInternalTopics.CONFLUENT_PREFIX;\n     this.sensors = new ArrayList<>();\n     this.countMetrics = new ArrayList<>();\n     this.metricGroupPrefix = Objects.requireNonNull(metricGroupPrefix, \"metricGroupPrefix\");\n     this.metricGroupName = metricGroupPrefix + METRIC_GROUP_POST_FIX;\n     this.customMetricsTags = customMetricsTags;\n+\n+    final Map<String, String> metricsTags = new HashMap<>(customMetricsTags);\n+    metricsTags.put(KsqlConstants.KSQL_SERVICE_ID_METRICS_TAG, ksqlEngine.getServiceId());\n+    this.newCustomMetricsTags = ImmutableMap.copyOf(metricsTags);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de1c557de0b7e93fa49851ca3f783769c9c574a2"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "532630c933c7d832e529ddaabb10be57a79eb929", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/532630c933c7d832e529ddaabb10be57a79eb929", "committedDate": "2020-12-07T21:10:41Z", "message": "minor update"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b80f0f20b04ce37d5808c06d149e8b35f532c99d", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/b80f0f20b04ce37d5808c06d149e8b35f532c99d", "committedDate": "2020-12-07T20:25:40Z", "message": "minor update"}, "afterCommit": {"oid": "532630c933c7d832e529ddaabb10be57a79eb929", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/532630c933c7d832e529ddaabb10be57a79eb929", "committedDate": "2020-12-07T21:10:41Z", "message": "minor update"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4548, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}