{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1ODYxODQx", "number": 4744, "title": "chore: fix rendering of error from new API server (MINOR)", "bodyText": "Description\nThe current failure handler for the new API server sets a status code but does not return anything in the response buffer, but tools such as curl only display the response buffer and not the response status code. This means that when request failures trigger the error handler, e.g., as authentication errors do, there's no feedback to the user regarding what went wrong:\n$ curl --http2 -X POST \"http://localhost:8088/query-stream\" -H \"Content-Type: application/json; charset=utf-8\" -H \"Authorization: BASIC dXNlcm5hbWU6cGFzc3dvcmQ=\" -d '{\"sql\":\" select * from ksql_processing_log emit changes;\"}' | jq\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100    58    0     0  100    58      0   1039 --:--:-- --:--:-- --:--:--  1054\n\nWith this PR, the failure handler now populates the response buffer, so details about the error are properly displayed via curl:\n$ curl --http2 -X POST \"http://localhost:8088/query-stream\" -H \"Content-Type: application/json; charset=utf-8\" -H \"Authorization: BASIC dXNlcm5hbWU6cGFzc3dvcmQ=\" -d '{\"sql\":\" select * from ksql_processing_log emit changes;\"}' | jq\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100   117  100    59  100    58     64     63 --:--:-- --:--:-- --:--:--    64\n{\n  \"status\": \"error\",\n  \"errorCode\": 401,\n  \"message\": \"Unauthorized\"\n}\n\nTesting done\nUpdated unit tests.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-03-09T23:16:17Z", "url": "https://github.com/confluentinc/ksql/pull/4744", "merged": true, "mergeCommit": {"oid": "6ebd6cd699397c1c91745d0b885ad7ef90ce39ea"}, "closed": true, "closedAt": "2020-03-14T22:57:18Z", "author": {"login": "vcrfxia"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMGSPwAH2gAyMzg1ODYxODQxOjAyNjFlMzVkODNiZjcwODYwODA3YTlmNDMzZGFjMzMyYjM3MGIyZGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOJOyPgFqTM3NDk3NTA0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0261e35d83bf70860807a9f433dac332b370b2db", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/0261e35d83bf70860807a9f433dac332b370b2db", "committedDate": "2020-03-09T23:12:32Z", "message": "chore: fix rendering of error from new API server (MINOR)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxODMzMTEz", "url": "https://github.com/confluentinc/ksql/pull/4744#pullrequestreview-371833113", "createdAt": "2020-03-10T10:28:21Z", "commit": {"oid": "0261e35d83bf70860807a9f433dac332b370b2db"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "200d392bda0592fecbaf869be16b05134d4b84dc", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/200d392bda0592fecbaf869be16b05134d4b84dc", "committedDate": "2020-03-14T15:35:58Z", "message": "Merge branch 'master' into auth-error-response-merge"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0OTc1MDQ2", "url": "https://github.com/confluentinc/ksql/pull/4744#pullrequestreview-374975046", "createdAt": "2020-03-16T07:46:19Z", "commit": {"oid": "200d392bda0592fecbaf869be16b05134d4b84dc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwNzo0NjoxOVrOF2orCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwNzo0NjoxOVrOF2orCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjgzMzgwMQ==", "bodyText": "We should use an error code (creating a new one if necessary) from the ErrorCodes class here, not the HTTP status code.", "url": "https://github.com/confluentinc/ksql/pull/4744#discussion_r392833801", "createdAt": "2020-03-16T07:46:19Z", "author": {"login": "purplefox"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/ServerVerticle.java", "diffHunk": "@@ -135,8 +135,15 @@ private static void handleFailure(final RoutingContext routingContext) {\n       log.error(String.format(\"Failed to handle request %d %s\", routingContext.statusCode(),\n           routingContext.request().path()),\n           routingContext.failure());\n+      ServerUtils.handleError(\n+          routingContext.response(),\n+          routingContext.statusCode(),\n+          routingContext.statusCode(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "200d392bda0592fecbaf869be16b05134d4b84dc"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4936, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}