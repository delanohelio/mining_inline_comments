{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2MTQ0OTcy", "number": 6665, "title": "fix: don't create threads per request", "bodyText": "Description\nWith the pull query physical plan refactoring, a bug was introduced where the executor service was instantiated per pull query request. I fixed that by creating it once in the KsqlRestApplication.\nTesting done\nAll tests pass\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-11-24T03:21:12Z", "url": "https://github.com/confluentinc/ksql/pull/6665", "merged": true, "mergeCommit": {"oid": "132d50d7b1ee953d07dfa304e8b5eb7a7b705291"}, "closed": true, "closedAt": "2020-12-05T03:19:23Z", "author": {"login": "vpapavas"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdft9ERgH2gAyNTI2MTQ0OTcyOjhkMmVkOWNiMmRhMTM0YTNmMmM2ZjgzOTNlZWZmYzc5NjllMDQwMWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdjCV0zAH2gAyNTI2MTQ0OTcyOmM3ZmVjYmYzNTcxZTEwOTAyYWY1YWM3ZTc0ZDM1MTk0NjY5ZThjNDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8d2ed9cb2da134a3f2c6f8393eeffc7969e0401a", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/8d2ed9cb2da134a3f2c6f8393eeffc7969e0401a", "committedDate": "2020-11-24T18:21:19Z", "message": "fix: creating threads per request"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c8195edaf1303231bd79a4a87b126bbb62ee7398", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/c8195edaf1303231bd79a4a87b126bbb62ee7398", "committedDate": "2020-11-24T03:19:34Z", "message": "fix: creating threads per request"}, "afterCommit": {"oid": "8d2ed9cb2da134a3f2c6f8393eeffc7969e0401a", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/8d2ed9cb2da134a3f2c6f8393eeffc7969e0401a", "committedDate": "2020-11-24T18:21:19Z", "message": "fix: creating threads per request"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3ODE1Mzk2", "url": "https://github.com/confluentinc/ksql/pull/6665#pullrequestreview-537815396", "createdAt": "2020-11-24T18:56:46Z", "commit": {"oid": "8d2ed9cb2da134a3f2c6f8393eeffc7969e0401a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxODo1Njo0NlrOH5Q5mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxODo1Njo0NlrOH5Q5mA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwNzc2OA==", "bodyText": "If someone has interrupted this thread, you can just skip awaiting termination of the executorService and log the exception.  I don't think there's any point in resetting the interrupt flag.  That's kind of the reverse of the pattern:\nhttps://docs.oracle.com/javase/tutorial/essential/concurrency/interrupt.html", "url": "https://github.com/confluentinc/ksql/pull/6665#discussion_r529807768", "createdAt": "2020-11-24T18:56:46Z", "author": {"login": "AlanConfluent"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/KsqlRestApplication.java", "diffHunk": "@@ -486,6 +492,14 @@ public void shutdown() {\n       log.error(\"Exception while waiting for pull query metrics to close\", e);\n     }\n \n+    try {\n+      pullExecutorService.shutdown();\n+      pullExecutorService.awaitTermination(\n+          Duration.ofSeconds(10).toMillis(), TimeUnit.MILLISECONDS);\n+    } catch (final InterruptedException e) {\n+      Thread.currentThread().interrupt();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d2ed9cb2da134a3f2c6f8393eeffc7969e0401a"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3ODE4NDg0", "url": "https://github.com/confluentinc/ksql/pull/6665#pullrequestreview-537818484", "createdAt": "2020-11-24T19:00:52Z", "commit": {"oid": "8d2ed9cb2da134a3f2c6f8393eeffc7969e0401a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxOTowMDo1MlrOH5RDbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxOTowMDo1MlrOH5RDbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgxMDI4NQ==", "bodyText": "Can we avoid passing down a general-purpose ExecutorService? It seems very easy to \"abuse\" if down the line someone needs a thread pool they'll think \"oh look, I can just use this one that's already here!\" and \"steal\" threads from the pull queries.\nI'm about to hop on a meeting but I'll take a deeper look in a bit. I think it might be worth refactoring HARouting so that we can pass one instance down (or create on when we create the engine).", "url": "https://github.com/confluentinc/ksql/pull/6665#discussion_r529810285", "createdAt": "2020-11-24T19:00:52Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/KsqlExecutionContext.java", "diffHunk": "@@ -154,6 +155,7 @@ PullQueryResult executePullQuery(\n       ConfiguredStatement<Query> statement,\n       RoutingFilterFactory routingFilterFactory,\n       RoutingOptions routingOptions,\n+      ExecutorService executorService,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d2ed9cb2da134a3f2c6f8393eeffc7969e0401a"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b490cf9488eadddd9ffee59a38487820d82187e6", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/b490cf9488eadddd9ffee59a38487820d82187e6", "committedDate": "2020-12-03T18:47:52Z", "message": "make HARouting singleton"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35d4e9df556fba4d67e4e979e09645bd1d2089ff", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/35d4e9df556fba4d67e4e979e09645bd1d2089ff", "committedDate": "2020-12-03T20:40:14Z", "message": "working on fixing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52571b45305da6ea335fe0b4788a60af0a2c4db2", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/52571b45305da6ea335fe0b4788a60af0a2c4db2", "committedDate": "2020-12-03T23:08:03Z", "message": "use enabled ksql client in test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTg2MzUx", "url": "https://github.com/confluentinc/ksql/pull/6665#pullrequestreview-544586351", "createdAt": "2020-12-04T01:11:01Z", "commit": {"oid": "52571b45305da6ea335fe0b4788a60af0a2c4db2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83f5df083174e6f083bbd86f8864d4b708ae1550", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/83f5df083174e6f083bbd86f8864d4b708ae1550", "committedDate": "2020-12-04T22:12:27Z", "message": "Trigger Build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7fecbf3571e10902af5ac7e74d35194669e8c49", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/c7fecbf3571e10902af5ac7e74d35194669e8c49", "committedDate": "2020-12-05T01:48:14Z", "message": "fix tests?"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4554, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}