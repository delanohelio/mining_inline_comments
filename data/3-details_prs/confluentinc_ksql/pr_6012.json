{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3MTQxMTQ4", "number": 6012, "title": "feat: move command topic deserialization to CommandRunner and introduce DEGRADED CommandRunnerStatus", "bodyText": "Description\nMoves deserialization of the ConsumerRecords from the CommandTopic to the CommandRunner. This allows for deserialization of individual records and better detection of SerializationException that can occur when a server processes an incompatible command.\nIntroduces a DEGRADED CommandRunnerStatus which indicates that the CommandRunner has encountered an incompatible process and the thread has been terminated. The only way to get out of this state currently is to start up a server version that can process the command that put old server version into the DEGRADED state\nNext step is to add a check in DistributingExecutor that makes sure the CommandRunner isn't in a DEGRADED state.\nTesting done\nUpdated Unit tests and added new ones\nManual test:\n\nStart with fresh command topic\nStart up server on this branch\nIssue a bunch of statements to the command topic (CS/CSAS)\nStopped the server\nCreated a new branch and added a field to the Command object\nStart server and issue DDL statements\nSwitched to this branch and start up server\nVerify with JConsole the CommandRunnerStatus is degraded\nVerify all previous commands before the incompatible command are executed and the queries are started\nVerify CommandRunner thread is shut down by trying to issue more DDL statements to server\n\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-08-13T04:38:17Z", "url": "https://github.com/confluentinc/ksql/pull/6012", "merged": true, "mergeCommit": {"oid": "ab8cec26d8f2f87ad782e96d49fc3c8762bbf26b"}, "closed": true, "closedAt": "2020-08-20T03:56:06Z", "author": {"login": "stevenpyzhang"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-askcABqjM2NTA3MzQyOTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAnbjtAFqTQ3MTA5NzgyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd27224679697527ccebf569ea4fb37ce39d1426", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/fd27224679697527ccebf569ea4fb37ce39d1426", "committedDate": "2020-08-12T17:53:15Z", "message": "temp"}, "afterCommit": {"oid": "02ce7ab93f6f599bbbb7c1edfd7487f546e97c94", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/02ce7ab93f6f599bbbb7c1edfd7487f546e97c94", "committedDate": "2020-08-13T07:15:20Z", "message": "temp"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02ce7ab93f6f599bbbb7c1edfd7487f546e97c94", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/02ce7ab93f6f599bbbb7c1edfd7487f546e97c94", "committedDate": "2020-08-13T07:15:20Z", "message": "temp"}, "afterCommit": {"oid": "71dc3c4d8ba634a9cf372f71ee5881bcb467f578", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/71dc3c4d8ba634a9cf372f71ee5881bcb467f578", "committedDate": "2020-08-13T20:01:32Z", "message": "temp"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "71dc3c4d8ba634a9cf372f71ee5881bcb467f578", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/71dc3c4d8ba634a9cf372f71ee5881bcb467f578", "committedDate": "2020-08-13T20:01:32Z", "message": "temp"}, "afterCommit": {"oid": "c983cd5159521be8d3028a2cf28d1998cbe73cdd", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/c983cd5159521be8d3028a2cf28d1998cbe73cdd", "committedDate": "2020-08-13T20:40:06Z", "message": "feat: move deserialization to CommandRunner and introduce DEGRADED to CommandRunnerStatus"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c983cd5159521be8d3028a2cf28d1998cbe73cdd", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/c983cd5159521be8d3028a2cf28d1998cbe73cdd", "committedDate": "2020-08-13T20:40:06Z", "message": "feat: move deserialization to CommandRunner and introduce DEGRADED to CommandRunnerStatus"}, "afterCommit": {"oid": "1d1918eeb5cfa4742e71ffaf652afe317fe2701b", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/1d1918eeb5cfa4742e71ffaf652afe317fe2701b", "committedDate": "2020-08-13T21:09:58Z", "message": "feat: move deserialization to CommandRunner and introduce DEGRADED to CommandRunnerStatus"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1d1918eeb5cfa4742e71ffaf652afe317fe2701b", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/1d1918eeb5cfa4742e71ffaf652afe317fe2701b", "committedDate": "2020-08-13T21:09:58Z", "message": "feat: move deserialization to CommandRunner and introduce DEGRADED to CommandRunnerStatus"}, "afterCommit": {"oid": "edd24664f0e306cdef243b1e3141d70939bc60e6", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/edd24664f0e306cdef243b1e3141d70939bc60e6", "committedDate": "2020-08-13T22:47:21Z", "message": "feat: move deserialization to CommandRunner and introduce DEGRADED to CommandRunnerStatus"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "edd24664f0e306cdef243b1e3141d70939bc60e6", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/edd24664f0e306cdef243b1e3141d70939bc60e6", "committedDate": "2020-08-13T22:47:21Z", "message": "feat: move deserialization to CommandRunner and introduce DEGRADED to CommandRunnerStatus"}, "afterCommit": {"oid": "03f27a9d8caf8a961be8bdb63c6512cf9365d307", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/03f27a9d8caf8a961be8bdb63c6512cf9365d307", "committedDate": "2020-08-14T04:20:24Z", "message": "feat: move deserialization to CommandRunner and introduce DEGRADED to CommandRunnerStatus"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03f27a9d8caf8a961be8bdb63c6512cf9365d307", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/03f27a9d8caf8a961be8bdb63c6512cf9365d307", "committedDate": "2020-08-14T04:20:24Z", "message": "feat: move deserialization to CommandRunner and introduce DEGRADED to CommandRunnerStatus"}, "afterCommit": {"oid": "f03080efe77639a401efd2b5a2d7796d0b4bf00d", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/f03080efe77639a401efd2b5a2d7796d0b4bf00d", "committedDate": "2020-08-14T04:29:06Z", "message": "feat: move deserialization to CommandRunner and introduce DEGRADED to CommandRunnerStatus"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f03080efe77639a401efd2b5a2d7796d0b4bf00d", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/f03080efe77639a401efd2b5a2d7796d0b4bf00d", "committedDate": "2020-08-14T04:29:06Z", "message": "feat: move deserialization to CommandRunner and introduce DEGRADED to CommandRunnerStatus"}, "afterCommit": {"oid": "69c4c5527ddc0b6cf7edba8ded17b4bb409726b9", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/69c4c5527ddc0b6cf7edba8ded17b4bb409726b9", "committedDate": "2020-08-14T04:51:30Z", "message": "feat: move deserialization to CommandRunner and introduce DEGRADED to CommandRunnerStatus"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09356e8b37725a1c2c8d948f0c6a326c116d2602", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/09356e8b37725a1c2c8d948f0c6a326c116d2602", "committedDate": "2020-08-14T07:27:24Z", "message": "feat: move deserialization to CommandRunner and introduce DEGRADED to CommandRunnerStatus"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "69c4c5527ddc0b6cf7edba8ded17b4bb409726b9", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/69c4c5527ddc0b6cf7edba8ded17b4bb409726b9", "committedDate": "2020-08-14T04:51:30Z", "message": "feat: move deserialization to CommandRunner and introduce DEGRADED to CommandRunnerStatus"}, "afterCommit": {"oid": "09356e8b37725a1c2c8d948f0c6a326c116d2602", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/09356e8b37725a1c2c8d948f0c6a326c116d2602", "committedDate": "2020-08-14T07:27:24Z", "message": "feat: move deserialization to CommandRunner and introduce DEGRADED to CommandRunnerStatus"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4OTI3MzAx", "url": "https://github.com/confluentinc/ksql/pull/6012#pullrequestreview-468927301", "createdAt": "2020-08-18T01:11:37Z", "commit": {"oid": "09356e8b37725a1c2c8d948f0c6a326c116d2602"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMToxMTozN1rOHB_4Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMToxMTozN1rOHB_4Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg1NzE4Ng==", "bodyText": "I don't agree with the decision to pull QueuedCommand out of this interface and replace it with Pair<ConsumerRecord, CommandStatusFuture>> since it breaks this abstraction unnecessarily. The idea behind this interface was to provide an api to a message queue where a caller could enqueue/dequeue, and also register to be notified when a given message is consumed/processed, or when a given offset is consumed/processed. It's not important that the backing store is Kafka, and that shouldn't really leak into the interface (I know the txnl producer is in there, but that can be fixed). It's also not that important that the messages have key/value types CommandID/Command (I know, bad naming \ud83d\ude01 ). Therefore I think it would be better to organize this in the following way:\nLeave this interface mostly the same, except change references to Command and CommandID to byte[]\nChange QueuedCommand's members to be:\nclass QueuedCommand {\n    byte[] commandId;\n    byte[] command;\n    ....\n}\n\nThat said, it is useful to have an explicit type for Command to improve safety (so for example, a caller can't accidentally mix them up, or CommandStore can't accidentally use the Command as the key to the status map). So, an additional improvement we could make would be to leave the command parameters as type Command (I'd still use byte[] for the command id and just serialize/deserialize that from the caller). Then, in QueuedCommand, change getCommand to getAndDeserializeCommand(Deserializer<Command> deserializer) so that CommandRunner is the entity that actually does the deserialization.", "url": "https://github.com/confluentinc/ksql/pull/6012#discussion_r471857186", "createdAt": "2020-08-18T01:11:37Z", "author": {"login": "rodesai"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandQueue.java", "diffHunk": "@@ -48,29 +52,32 @@ QueuedCommandStatus enqueueCommand(\n   );\n   \n   /**\n-   * Polls the Queue for any commands that have been enqueued since the last\n-   * invocation to this method.\n+   * Polls the Queue for any command records that have been enqueued since the last\n+   * invocation to this method. Returns the CommandStatusFuture associated with a record\n+   * if it exists\n    *\n    * <p>The method blocks until either there is data to return or the\n    * supplied {@code timeout} expires.\n    *\n    * <p>If between invocations to this method, {@link #getRestoreCommands()} is\n    * invoked, this command will begin where the results of that call ended.\n    *\n-   * @param timeout the max time to wait for new commands.\n-   * @return a list of commands that have been enqueued since the last call\n+   * @param timeout the max time to wait for new records.\n+   * @return a list of records that have been enqueued since the last call\n    * @apiNote this method may block\n    */\n-  List<QueuedCommand> getNewCommands(Duration timeout);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09356e8b37725a1c2c8d948f0c6a326c116d2602"}, "originalPosition": 37}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "09c358c6133c46ddb16006e6dcf867409fdca533", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/09c358c6133c46ddb16006e6dcf867409fdca533", "committedDate": "2020-08-18T18:34:29Z", "message": "rohan comment"}, "afterCommit": {"oid": "04d7121873b6360ee88034ddd6ca037b0d2c0da8", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/04d7121873b6360ee88034ddd6ca037b0d2c0da8", "committedDate": "2020-08-18T18:51:23Z", "message": "rohan comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f5ce5f5a60329dcebf3027cceca1d13eee1ed5c", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/4f5ce5f5a60329dcebf3027cceca1d13eee1ed5c", "committedDate": "2020-08-18T18:54:06Z", "message": "rohan comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "04d7121873b6360ee88034ddd6ca037b0d2c0da8", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/04d7121873b6360ee88034ddd6ca037b0d2c0da8", "committedDate": "2020-08-18T18:51:23Z", "message": "rohan comment"}, "afterCommit": {"oid": "4f5ce5f5a60329dcebf3027cceca1d13eee1ed5c", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/4f5ce5f5a60329dcebf3027cceca1d13eee1ed5c", "committedDate": "2020-08-18T18:54:06Z", "message": "rohan comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dae4eee5a9625404ccdcb8b742ab35400792e226", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/dae4eee5a9625404ccdcb8b742ab35400792e226", "committedDate": "2020-08-18T20:16:25Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMTU4MTQy", "url": "https://github.com/confluentinc/ksql/pull/6012#pullrequestreview-470158142", "createdAt": "2020-08-19T06:27:38Z", "commit": {"oid": "dae4eee5a9625404ccdcb8b742ab35400792e226"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNjoyNzozOFrOHC2r3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNjo0MzoyNFrOHC3agw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc1NTE2NA==", "bodyText": "do we really need this class? it's not really doing anything", "url": "https://github.com/confluentinc/ksql/pull/6012#discussion_r472755164", "createdAt": "2020-08-19T06:27:38Z", "author": {"login": "rodesai"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/util/CommandTopicUtil.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.rest.util;\n+\n+import io.confluent.ksql.rest.entity.CommandId;\n+import io.confluent.ksql.rest.server.computation.Command;\n+import io.confluent.ksql.rest.server.computation.InternalTopicSerdes;\n+\n+public final class CommandTopicUtil {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dae4eee5a9625404ccdcb8b742ab35400792e226"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjc2NzEwNw==", "bodyText": "Couple of thoughts about design here:\nIt would be nice to try to structure this so that the implementation of CommandStore cannot deserialize Command (at least not without making assumptions about its format, which it shouldn't do). This would require the following tweaks:\n\nmake the CommandID serializer/deserializer, and the Command serializer only (not deserializer) parameters to CommandStore passed in the constructor. Don't have it accept a deserializer.\nmake the deserializer a parameter to QueuedCommand.getAndDeserializeCommand()", "url": "https://github.com/confluentinc/ksql/pull/6012#discussion_r472767107", "createdAt": "2020-08-19T06:43:24Z", "author": {"login": "rodesai"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandStore.java", "diffHunk": "@@ -55,6 +59,7 @@\n // CHECKSTYLE_RULES.OFF: ClassDataAbstractionCoupling\n public class CommandStore implements CommandQueue, Closeable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dae4eee5a9625404ccdcb8b742ab35400792e226"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5aba943a40f9126bcda43d0b774b2846ca98538", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/d5aba943a40f9126bcda43d0b774b2846ca98538", "committedDate": "2020-08-19T17:46:40Z", "message": "more feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5110d66e3416abb4bc92582590e59a3e601b2b45", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/5110d66e3416abb4bc92582590e59a3e601b2b45", "committedDate": "2020-08-19T20:28:05Z", "message": "pass deserializer to queuedcommand for command"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMDk2NzQ3", "url": "https://github.com/confluentinc/ksql/pull/6012#pullrequestreview-471096747", "createdAt": "2020-08-20T03:09:28Z", "commit": {"oid": "5110d66e3416abb4bc92582590e59a3e601b2b45"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMDk3ODIy", "url": "https://github.com/confluentinc/ksql/pull/6012#pullrequestreview-471097822", "createdAt": "2020-08-20T03:13:37Z", "commit": {"oid": "5110d66e3416abb4bc92582590e59a3e601b2b45"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMzoxMzozN1rOHDn8hA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMzoxMzozN1rOHDn8hA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU2MjI0NA==", "bodyText": "nit: I'd just pass command, commandId, status, and offset in as parameters rather than deserializing from this method", "url": "https://github.com/confluentinc/ksql/pull/6012#discussion_r473562244", "createdAt": "2020-08-20T03:13:37Z", "author": {"login": "rodesai"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/InteractiveStatementExecutor.java", "diffHunk": "@@ -117,8 +123,8 @@ void handleStatement(final QueuedCommand queuedCommand) {\n     throwIfNotConfigured();\n \n     handleStatementWithTerminatedQueries(\n-        queuedCommand.getCommand(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5110d66e3416abb4bc92582590e59a3e601b2b45"}, "originalPosition": 47}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4682, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}