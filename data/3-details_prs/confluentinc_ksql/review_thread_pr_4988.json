{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4MzI3MTkw", "number": 4988, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxODo0MzoyN1rODvsY5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMDozMzo1MFrODw2n0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzM2OTMyOnYy", "diffSide": "RIGHT", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/Analyzer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxODo0MzoyN1rOGCROUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMDowMToyOVrOGCT7pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAzMjUzMQ==", "bodyText": "Just curious, does it matter that you keep passing in left?  What if two of the rights are the same.  Seems like it would miss the self-join check.", "url": "https://github.com/confluentinc/ksql/pull/4988#discussion_r405032531", "createdAt": "2020-04-07T18:43:27Z", "author": {"login": "AlanConfluent"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/Analyzer.java", "diffHunk": "@@ -286,12 +286,23 @@ protected AstNode visitJoin(final Join node, final Void context) {\n       process(node.getLeft(), context);\n       node.getRights().forEach(right -> process(right.getRelation(), context));\n \n-      final JoinNode.JoinType joinType = getJoinType(node);\n-\n       final AliasedDataSource left = analysis.getFromDataSources().get(0);\n-      final AliasedDataSource right = analysis.getFromDataSources().get(1);\n \n-      final JoinedSource source = Iterables.getOnlyElement(node.getRights());\n+      final ImmutableList<JoinedSource> rights = node.getRights();\n+      for (int i = 0; i < rights.size(); i++) {\n+        final JoinedSource source = rights.get(i);\n+        visitJoinedSource(left, analysis.getFromDataSources().get(i + 1), source);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb5013b803f213b1b66de72e1bd1388db5530ceb"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3NjkwMw==", "bodyText": "good catch - I think I need to rework some of this (especially after talking with @vpapavas)", "url": "https://github.com/confluentinc/ksql/pull/4988#discussion_r405076903", "createdAt": "2020-04-07T20:01:29Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/Analyzer.java", "diffHunk": "@@ -286,12 +286,23 @@ protected AstNode visitJoin(final Join node, final Void context) {\n       process(node.getLeft(), context);\n       node.getRights().forEach(right -> process(right.getRelation(), context));\n \n-      final JoinNode.JoinType joinType = getJoinType(node);\n-\n       final AliasedDataSource left = analysis.getFromDataSources().get(0);\n-      final AliasedDataSource right = analysis.getFromDataSources().get(1);\n \n-      final JoinedSource source = Iterables.getOnlyElement(node.getRights());\n+      final ImmutableList<JoinedSource> rights = node.getRights();\n+      for (int i = 0; i < rights.size(); i++) {\n+        final JoinedSource source = rights.get(i);\n+        visitJoinedSource(left, analysis.getFromDataSources().get(i + 1), source);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAzMjUzMQ=="}, "originalCommit": {"oid": "cb5013b803f213b1b66de72e1bd1388db5530ceb"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzM5ODM5OnYy", "diffSide": "RIGHT", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/planner/LogicalPlanner.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxODo1MTowNVrOGCRgPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMDowMTo0NVrOGCT8HA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAzNzExNg==", "bodyText": "Is this part of a followup?", "url": "https://github.com/confluentinc/ksql/pull/4988#discussion_r405037116", "createdAt": "2020-04-07T18:51:05Z", "author": {"login": "AlanConfluent"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/planner/LogicalPlanner.java", "diffHunk": "@@ -425,6 +426,8 @@ private PlanNode buildSourceNode() {\n \n     if (sources.size() == 1) {\n       throw new IllegalStateException(\"Expected more than one source. Got \" + sources.size());\n+    } else if (sources.size() != 2) {\n+      throw new KsqlException(\"ksqlDB does not support multi-way joins.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb5013b803f213b1b66de72e1bd1388db5530ceb"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3NzAyMA==", "bodyText": "yup! I wanted to split it up into smaller PRs", "url": "https://github.com/confluentinc/ksql/pull/4988#discussion_r405077020", "createdAt": "2020-04-07T20:01:45Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/planner/LogicalPlanner.java", "diffHunk": "@@ -425,6 +426,8 @@ private PlanNode buildSourceNode() {\n \n     if (sources.size() == 1) {\n       throw new IllegalStateException(\"Expected more than one source. Got \" + sources.size());\n+    } else if (sources.size() != 2) {\n+      throw new KsqlException(\"ksqlDB does not support multi-way joins.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAzNzExNg=="}, "originalCommit": {"oid": "cb5013b803f213b1b66de72e1bd1388db5530ceb"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNTQ4Nzg4OnYy", "diffSide": "RIGHT", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/rewrite/DataSourceExtractor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMDoxODoxNlrOGEEt_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMDo0NzoyNVrOGEFcRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkyNDc5OQ==", "bodyText": "I feel like I've seen a lot of the same bits of code error checking column references, such as in Analyze where it does column name validation.  Wondering if this can be consolidated a bit.", "url": "https://github.com/confluentinc/ksql/pull/4988#discussion_r406924799", "createdAt": "2020-04-10T20:18:16Z", "author": {"login": "AlanConfluent"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/rewrite/DataSourceExtractor.java", "diffHunk": "@@ -58,64 +53,37 @@\n \n   public void extractDataSources(final AstNode node) {\n     new Visitor().process(node, null);\n-    commonColumnNames.addAll(Sets.intersection(leftColumnNames, rightColumnNames));\n-  }\n-\n-  public SourceName getFromAlias() {\n-    return fromAlias;\n-  }\n-\n-  public SourceName getLeftAlias() {\n-    return leftAlias;\n-  }\n-\n-  public SourceName getRightAlias() {\n-    return rightAlias;\n   }\n \n-  public Set<DataSource> getAllSources() {\n-    return Collections.unmodifiableSet(allSources);\n+  public Set<AliasedDataSource> getAllSources() {\n+    return ImmutableSet.copyOf(allSources);\n   }\n \n   public Set<ColumnName> getCommonColumnNames() {\n     return Collections.unmodifiableSet(commonColumnNames);\n   }\n \n-  public SourceName getFromName() {\n-    return fromName;\n-  }\n-\n-  public SourceName getLeftName() {\n-    return leftName;\n-  }\n-\n-  public SourceName getRightName() {\n-    return rightName;\n-  }\n-\n   public boolean isJoin() {\n     return isJoin;\n   }\n \n   public SourceName getAliasFor(final ColumnName columnName) {\n-    if (isJoin) {\n-      if (commonColumnNames.contains(columnName)) {\n-        throw new KsqlException(\"Column '\" + columnName.text() + \"' is ambiguous.\");\n-      }\n-\n-      if (leftColumnNames.contains(columnName)) {\n-        return leftAlias;\n-      }\n-\n-      if (rightColumnNames.contains(columnName)) {\n-        return rightAlias;\n-      }\n+    if (!isJoin) {\n+      return Iterables.getOnlyElement(allSources).getAlias();\n+    }\n \n-      throw new KsqlException(\n-          \"Column '\" + columnName.text() + \"' cannot be resolved.\"\n-      );\n+    final List<SourceName> source = allSources.stream()\n+        .filter(aliased -> aliased.getDataSource().getSchema().findColumn(columnName).isPresent())\n+        .map(AliasedDataSource::getAlias)\n+        .collect(Collectors.toList());\n+\n+    if (source.size() > 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36cedf0d719cec3ee0ba381ce1323fd05c814423"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkzNjY0Ng==", "bodyText": "totally agree - I think this whole class should be removed, but that's a problem for another time :)", "url": "https://github.com/confluentinc/ksql/pull/4988#discussion_r406936646", "createdAt": "2020-04-10T20:47:25Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/rewrite/DataSourceExtractor.java", "diffHunk": "@@ -58,64 +53,37 @@\n \n   public void extractDataSources(final AstNode node) {\n     new Visitor().process(node, null);\n-    commonColumnNames.addAll(Sets.intersection(leftColumnNames, rightColumnNames));\n-  }\n-\n-  public SourceName getFromAlias() {\n-    return fromAlias;\n-  }\n-\n-  public SourceName getLeftAlias() {\n-    return leftAlias;\n-  }\n-\n-  public SourceName getRightAlias() {\n-    return rightAlias;\n   }\n \n-  public Set<DataSource> getAllSources() {\n-    return Collections.unmodifiableSet(allSources);\n+  public Set<AliasedDataSource> getAllSources() {\n+    return ImmutableSet.copyOf(allSources);\n   }\n \n   public Set<ColumnName> getCommonColumnNames() {\n     return Collections.unmodifiableSet(commonColumnNames);\n   }\n \n-  public SourceName getFromName() {\n-    return fromName;\n-  }\n-\n-  public SourceName getLeftName() {\n-    return leftName;\n-  }\n-\n-  public SourceName getRightName() {\n-    return rightName;\n-  }\n-\n   public boolean isJoin() {\n     return isJoin;\n   }\n \n   public SourceName getAliasFor(final ColumnName columnName) {\n-    if (isJoin) {\n-      if (commonColumnNames.contains(columnName)) {\n-        throw new KsqlException(\"Column '\" + columnName.text() + \"' is ambiguous.\");\n-      }\n-\n-      if (leftColumnNames.contains(columnName)) {\n-        return leftAlias;\n-      }\n-\n-      if (rightColumnNames.contains(columnName)) {\n-        return rightAlias;\n-      }\n+    if (!isJoin) {\n+      return Iterables.getOnlyElement(allSources).getAlias();\n+    }\n \n-      throw new KsqlException(\n-          \"Column '\" + columnName.text() + \"' cannot be resolved.\"\n-      );\n+    final List<SourceName> source = allSources.stream()\n+        .filter(aliased -> aliased.getDataSource().getSchema().findColumn(columnName).isPresent())\n+        .map(AliasedDataSource::getAlias)\n+        .collect(Collectors.toList());\n+\n+    if (source.size() > 1) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkyNDc5OQ=="}, "originalCommit": {"oid": "36cedf0d719cec3ee0ba381ce1323fd05c814423"}, "originalPosition": 115}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNTUzMTcwOnYy", "diffSide": "RIGHT", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/rewrite/DataSourceExtractor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMDozMzo1MFrOGEFIgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMDo0MToxOFrOGEFRwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkzMTU4NQ==", "bodyText": "I assume this is in place of the join code, which you've removed.  Why was join special-cased before?", "url": "https://github.com/confluentinc/ksql/pull/4988#discussion_r406931585", "createdAt": "2020-04-10T20:33:50Z", "author": {"login": "AlanConfluent"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/rewrite/DataSourceExtractor.java", "diffHunk": "@@ -126,50 +94,34 @@ public Void visitRelation(final Relation relation, final Void ctx) {\n \n     @Override\n     public Void visitAliasedRelation(final AliasedRelation relation, final Void ctx) {\n-      fromAlias = relation.getAlias();\n-      fromName = ((Table) relation.getRelation()).getName();\n+      final SourceName fromName = ((Table) relation.getRelation()).getName();\n       final DataSource source = metaStore.getSource(fromName);\n       if (source == null) {\n         throw new KsqlException(fromName.text() + \" does not exist.\");\n       }\n \n-      allSources.add(source);\n+      allSources.add(new AliasedDataSource(relation.getAlias(), source));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36cedf0d719cec3ee0ba381ce1323fd05c814423"}, "originalPosition": 139}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkzMzk1NA==", "bodyText": "you are right, this does the same thing, but is just cleaner IMO - when there were just two sides of a join it wasn't too bad to special case it, but I don't think there was any good reason to", "url": "https://github.com/confluentinc/ksql/pull/4988#discussion_r406933954", "createdAt": "2020-04-10T20:41:18Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/rewrite/DataSourceExtractor.java", "diffHunk": "@@ -126,50 +94,34 @@ public Void visitRelation(final Relation relation, final Void ctx) {\n \n     @Override\n     public Void visitAliasedRelation(final AliasedRelation relation, final Void ctx) {\n-      fromAlias = relation.getAlias();\n-      fromName = ((Table) relation.getRelation()).getName();\n+      final SourceName fromName = ((Table) relation.getRelation()).getName();\n       final DataSource source = metaStore.getSource(fromName);\n       if (source == null) {\n         throw new KsqlException(fromName.text() + \" does not exist.\");\n       }\n \n-      allSources.add(source);\n+      allSources.add(new AliasedDataSource(relation.getAlias(), source));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkzMTU4NQ=="}, "originalCommit": {"oid": "36cedf0d719cec3ee0ba381ce1323fd05c814423"}, "originalPosition": 139}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3735, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}