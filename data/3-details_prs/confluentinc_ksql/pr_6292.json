{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyMzM3MDA3", "number": 6292, "title": "Json keys", "bodyText": "Description\npart of: #6215\nfixes: #6214\nFirst pass of adding QTT tests around the JSON key format, including adding tests for DECIMAL and BOOLEAN types, which is the first time they've been used as a key column type.\nCommit includes a fix in SerdeOptionsFactory to ensure no key unwrapping is set if there is no key, plus refactored SerdeOptionsFactory, combining the two public methods.\nTesting done\nusual\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-09-24T10:11:18Z", "url": "https://github.com/confluentinc/ksql/pull/6292", "merged": true, "mergeCommit": {"oid": "a8713f2232db1932d44497e5827af9930ebc4f96"}, "closed": true, "closedAt": "2020-09-30T08:33:13Z", "author": {"login": "big-andy-coates"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdL-XJeAH2gAyNDkyMzM3MDA3OjlhZDFhOWIxODM4OTAxZjVhMzQ2NzY3YzQ5ZGJlYzA3ZDBkOWU3NmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNpo4sgH2gAyNDkyMzM3MDA3OjZiZjIzNDM0YzcyYTk4OGQ0YmE0MzNhYzIyNzQwOTdlODQyNzNhNTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9ad1a9b1838901f5a346767c49dbec07d0d9e76e", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/9ad1a9b1838901f5a346767c49dbec07d0d9e76e", "committedDate": "2020-09-24T10:09:48Z", "message": "chore: first pass of JSON key support\n\nwip: https://github.com/confluentinc/ksql/issues/6215\nfixes: https://github.com/confluentinc/ksql/issues/6214\n\nFirst pass of adding QTT tests around the JSON key format, including adding tests for `DECIMAL` and `BOOLEAN` types, which is the first time they've been used as a key column type.\n\nThe test around a JSON `DOUBLE` key is currently disabled, due to a limitation of QTT which reads doubles as `BigDecimal`.  Code works, just need to enhance QTT to do the right thing.\n\nCommit includes a fix in `SerdeOptionsFactory` to ensure no key unwrapping is set if there is no key, plus refactored `SerdeOptionsFactory`, combining the two public methods."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cc048302d8fd6b391d8768b33a25f6b85ca635b", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/0cc048302d8fd6b391d8768b33a25f6b85ca635b", "committedDate": "2020-09-24T10:10:07Z", "message": "test: historical plans"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79471e5785f06c66652e82f956815ac45af7851d", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/79471e5785f06c66652e82f956815ac45af7851d", "committedDate": "2020-09-24T13:04:14Z", "message": "chore: enable test for doubles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca9ed08834fcab5d6517dd4fb3b08644cb5798c2", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/ca9ed08834fcab5d6517dd4fb3b08644cb5798c2", "committedDate": "2020-09-24T14:49:12Z", "message": "test: more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae9f2295c1cbdaa471d23f28c2fa14e0b4375b92", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/ae9f2295c1cbdaa471d23f28c2fa14e0b4375b92", "committedDate": "2020-09-24T15:26:56Z", "message": "chore: windowed keys"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2adf60bca0f18cc2dddaf466e548374222dbb1f5", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/2adf60bca0f18cc2dddaf466e548374222dbb1f5", "committedDate": "2020-09-25T12:59:35Z", "message": "chore: merge from master\n\n...and fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NjEzNDM2", "url": "https://github.com/confluentinc/ksql/pull/6292#pullrequestreview-497613436", "createdAt": "2020-09-28T14:53:02Z", "commit": {"oid": "2adf60bca0f18cc2dddaf466e548374222dbb1f5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNDo1MzowMlrOHZBh4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNDo1MzowMlrOHZBh4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAwMTUwNQ==", "bodyText": "The PR description says this test is currently disabled. How so?", "url": "https://github.com/confluentinc/ksql/pull/6292#discussion_r496001505", "createdAt": "2020-09-28T14:53:02Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/json.json", "diffHunk": "@@ -1,31 +1,426 @@\n {\n   \"tests\": [\n     {\n-      \"name\": \"deserialize anonymous primitive - value\",\n+      \"name\": \"BOOLEAN - key\",\n       \"statements\": [\n-        \"CREATE STREAM INPUT (K STRING KEY, foo INT) WITH (WRAP_SINGLE_VALUE=false, kafka_topic='input_topic', value_format='JSON');\",\n+        \"CREATE STREAM INPUT (K BOOLEAN KEY, V INT) WITH (kafka_topic='input_topic', format='JSON');\",\n+        \"CREATE STREAM OUTPUT AS SELECT * FROM INPUT;\"\n+      ],\n+      \"properties\": {\n+        \"ksql.key.format.enabled\": true\n+      },\n+      \"inputs\": [\n+        {\"topic\": \"input_topic\", \"key\": true, \"value\": {\"V\": 0}},\n+        {\"topic\": \"input_topic\", \"key\": false, \"value\": {\"V\": 0}},\n+        {\"topic\": \"input_topic\", \"key\": null, \"value\": {\"V\": 0}}\n+      ],\n+      \"outputs\": [\n+        {\"topic\": \"OUTPUT\", \"key\": true, \"value\": {\"V\": 0}},\n+        {\"topic\": \"OUTPUT\", \"key\": false, \"value\": {\"V\": 0}},\n+        {\"topic\": \"OUTPUT\", \"key\": null, \"value\": {\"V\": 0}}\n+      ]\n+    },\n+    {\n+      \"name\": \"BOOLEAN - value - anonymous - deserialize\",\n+      \"statements\": [\n+        \"CREATE STREAM INPUT (V BOOLEAN) WITH (WRAP_SINGLE_VALUE=false, kafka_topic='input_topic', value_format='JSON');\",\n+        \"CREATE STREAM OUTPUT AS SELECT * FROM INPUT;\"\n+      ],\n+      \"inputs\": [\n+        {\"topic\": \"input_topic\", \"value\": true},\n+        {\"topic\": \"input_topic\", \"value\": false},\n+        {\"topic\": \"input_topic\", \"value\": null}\n+      ],\n+      \"outputs\": [\n+        {\"topic\": \"OUTPUT\", \"value\": {\"V\": true}},\n+        {\"topic\": \"OUTPUT\", \"value\": {\"V\": false}},\n+        {\"topic\": \"OUTPUT\", \"value\": null}\n+      ]\n+    },\n+    {\n+      \"name\": \"BOOLEAN - value - anonymous - serialize\",\n+      \"statements\": [\n+        \"CREATE STREAM INPUT (V BOOLEAN) WITH (kafka_topic='input_topic', value_format='JSON');\",\n+        \"CREATE STREAM OUTPUT WITH (WRAP_SINGLE_VALUE=false) AS SELECT * FROM INPUT;\"\n+      ],\n+      \"inputs\": [\n+        {\"topic\": \"input_topic\", \"value\": {\"V\": true}},\n+        {\"topic\": \"input_topic\", \"value\": {\"V\": false}},\n+        {\"topic\": \"input_topic\", \"value\": null}\n+      ],\n+      \"outputs\": [\n+        {\"topic\": \"OUTPUT\", \"value\": true},\n+        {\"topic\": \"OUTPUT\", \"value\": false},\n+        {\"topic\": \"OUTPUT\", \"value\": null}\n+      ]\n+    },\n+    {\n+      \"name\": \"INT - key\",\n+      \"statements\": [\n+        \"CREATE STREAM INPUT (K INT KEY, V INT) WITH (kafka_topic='input_topic', format='JSON');\",\n+        \"CREATE STREAM OUTPUT AS SELECT * FROM INPUT;\"\n+      ],\n+      \"properties\": {\n+        \"ksql.key.format.enabled\": true\n+      },\n+      \"inputs\": [\n+        {\"topic\": \"input_topic\", \"key\": 33, \"value\": {\"V\": 0}},\n+        {\"topic\": \"input_topic\", \"key\": null, \"value\": {\"V\": 0}}\n+      ],\n+      \"outputs\": [\n+        {\"topic\": \"OUTPUT\", \"key\": 33, \"value\": {\"V\": 0}},\n+        {\"topic\": \"OUTPUT\", \"key\": null, \"value\": {\"V\": 0}}\n+      ]\n+    },\n+    {\n+      \"name\": \"INT - value - anonymous - deserialize\",\n+      \"statements\": [\n+        \"CREATE STREAM INPUT (V INT) WITH (WRAP_SINGLE_VALUE=false, kafka_topic='input_topic', value_format='JSON');\",\n         \"CREATE STREAM OUTPUT AS SELECT * FROM INPUT;\"\n       ],\n       \"inputs\": [\n         {\"topic\": \"input_topic\", \"value\": 10},\n         {\"topic\": \"input_topic\", \"value\": null}\n       ],\n       \"outputs\": [\n-        {\"topic\": \"OUTPUT\", \"value\": {\"FOO\": 10}},\n+        {\"topic\": \"OUTPUT\", \"value\": {\"V\": 10}},\n+        {\"topic\": \"OUTPUT\", \"value\": null}\n+      ]\n+    },\n+    {\n+      \"name\": \"INT - value - anonymous - serialize\",\n+      \"statements\": [\n+        \"CREATE STREAM INPUT (V INT) WITH (kafka_topic='input_topic', value_format='JSON');\",\n+        \"CREATE STREAM OUTPUT WITH (WRAP_SINGLE_VALUE=false) AS SELECT * FROM INPUT;\"\n+      ],\n+      \"inputs\": [\n+        {\"topic\": \"input_topic\", \"value\": {\"V\": 123}},\n+        {\"topic\": \"input_topic\", \"value\": null}\n+      ],\n+      \"outputs\": [\n+        {\"topic\": \"OUTPUT\", \"value\": 123},\n+        {\"topic\": \"OUTPUT\", \"value\": null}\n+      ]\n+    },\n+    {\n+      \"name\": \"BIGINT - key\",\n+      \"statements\": [\n+        \"CREATE STREAM INPUT (K BIGINT KEY, V INT) WITH (kafka_topic='input_topic', format='JSON');\",\n+        \"CREATE STREAM OUTPUT AS SELECT * FROM INPUT;\"\n+      ],\n+      \"properties\": {\n+        \"ksql.key.format.enabled\": true\n+      },\n+      \"inputs\": [\n+        {\"topic\": \"input_topic\", \"key\": 998877665544332211, \"value\": {\"V\": 0}},\n+        {\"topic\": \"input_topic\", \"key\": null, \"value\": {\"V\": 0}}\n+      ],\n+      \"outputs\": [\n+        {\"topic\": \"OUTPUT\", \"key\": 998877665544332211, \"value\": {\"V\": 0}},\n+        {\"topic\": \"OUTPUT\", \"key\": null, \"value\": {\"V\": 0}}\n+      ]\n+    },\n+    {\n+      \"name\": \"BIGINT - value - anonymous - deserialize\",\n+      \"statements\": [\n+        \"CREATE STREAM INPUT (V BIGINT) WITH (WRAP_SINGLE_VALUE=false, kafka_topic='input_topic', value_format='JSON');\",\n+        \"CREATE STREAM OUTPUT AS SELECT * FROM INPUT;\"\n+      ],\n+      \"inputs\": [\n+        {\"topic\": \"input_topic\", \"value\": 10827272222},\n+        {\"topic\": \"input_topic\", \"value\": null}\n+      ],\n+      \"outputs\": [\n+        {\"topic\": \"OUTPUT\", \"value\": {\"V\": 10827272222}},\n+        {\"topic\": \"OUTPUT\", \"value\": null}\n+      ]\n+    },\n+    {\n+      \"name\": \"BIGINT - value - anonymous - serialize\",\n+      \"statements\": [\n+        \"CREATE STREAM INPUT (V BIGINT) WITH (kafka_topic='input_topic', value_format='JSON');\",\n+        \"CREATE STREAM OUTPUT WITH (WRAP_SINGLE_VALUE=false) AS SELECT * FROM INPUT;\"\n+      ],\n+      \"inputs\": [\n+        {\"topic\": \"input_topic\", \"value\": {\"V\": 1234567890}},\n+        {\"topic\": \"input_topic\", \"value\": null}\n+      ],\n+      \"outputs\": [\n+        {\"topic\": \"OUTPUT\", \"value\": 1234567890},\n+        {\"topic\": \"OUTPUT\", \"value\": null}\n+      ]\n+    },\n+    {\n+      \"name\": \"DOUBLE - key\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2adf60bca0f18cc2dddaf466e548374222dbb1f5"}, "originalPosition": 157}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f107dc21f5ee354798f69c689c21e593124ec739", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/f107dc21f5ee354798f69c689c21e593124ec739", "committedDate": "2020-09-28T17:00:08Z", "message": "chore: fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bf23434c72a988d4ba433ac2274097e84273a52", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/6bf23434c72a988d4ba433ac2274097e84273a52", "committedDate": "2020-09-29T15:09:01Z", "message": "chore: merge from master\n\nConflicting files\nksqldb-engine/src/main/java/io/confluent/ksql/ddl/commands/CreateSourceFactory.java\nksqldb-engine/src/main/java/io/confluent/ksql/planner/LogicalPlanner.java\nksqldb-engine/src/main/java/io/confluent/ksql/schema/ksql/inference/SchemaRegisterInjector.java\nksqldb-engine/src/main/java/io/confluent/ksql/serde/SerdeOptionsFactory.java\nksqldb-engine/src/main/java/io/confluent/ksql/structured/SchemaKGroupedStream.java\nksqldb-engine/src/test/java/io/confluent/ksql/serde/SerdeOptionsFactoryTest.java\nksqldb-engine/src/test/java/io/confluent/ksql/structured/SchemaKGroupedStreamTest.java\nksqldb-functional-tests/src/main/java/io/confluent/ksql/test/tools/TestCaseBuilderUtil.java"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4673, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}