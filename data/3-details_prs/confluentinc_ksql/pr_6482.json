{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3NzIzODE5", "number": 6482, "title": "fix: Internal Server Error for /healthcheck endpoint in RBAC-enabled", "bodyText": "Description\nFixes #6479\nContext:\nThere are endpoints in KsqlServerEndpoints that do not require a security context initialized. Some of these endpoints do not require authentication, so a security context should not be initialized because there is no Principal authenticated.\nThe current Vert.x code in KsqlServerEndpoints attempted to initialize the security context on endpoints where the user was not authenticated. This caused an error when calling these endpoints even with valid credentials. The fix was just to prevent initializing the security contexts, which is unnecessary.\nTesting done\nAdded unit tests.\nVerified manually with Confluent RBAC library.\n\nUser:ksql has valid credentials and has authorization to the server.\nUser:user1 has valid credentials but not authorization to the server.\n\n\nEndpoints that required authentication only\n\ncurl   http://localhost:8088/info | jq .\n{\n  \"@type\": \"generic_error\",\n  \"error_code\": 40100,\n  \"message\": \"Failed authentication\"\n}\n\ncurl -u user1:user1  http://localhost:8088/info | jq .\n{\n  \"KsqlServerInfo\": {\n    \"version\": \"6.1.0-0\",\n    \"kafkaClusterId\": \"Bj_7MIRSQ36T97mtEimh-A\",\n    \"ksqlServiceId\": \"default_\",\n    \"serverStatus\": \"RUNNING\"\n  }\n}\n\n\nEndpoints that do not require authentication\n\n curl http://localhost:8088/v1/metadata/id 2>/dev/null | jq .\n{\n  \"scope\": {\n    \"path\": [],\n    \"clusters\": {\n      \"kafka-cluster\": \"Bj_7MIRSQ36T97mtEimh-A\",\n      \"ksql-cluster\": \"default_\"\n    }\n  },\n  \"id\": \"\"\n}\n\n\nEndpoints that require authentication and authorization\n\n$ curl http://localhost:8088/info 2>/dev/null | jq .\n{\n  \"@type\": \"generic_error\",\n  \"error_code\": 40100,\n  \"message\": \"Failed authentication\"\n}\n\n$ curl -u user1:user1 http://localhost:8088/status 2>/dev/null | jq .\n{\n  \"@type\": \"generic_error\",\n  \"error_code\": 40300,\n  \"message\": \"You are forbidden from using this cluster.\"\n}\n\n$ curl -u ksql:ksql http://localhost:8088/status 2>/dev/null | jq .\n{\n  \"commandStatuses\": {\n    \"stream/`KSQL_PROCESSING_LOG`/create\": \"SUCCESS\"\n  }\n}\n\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-10-21T17:15:15Z", "url": "https://github.com/confluentinc/ksql/pull/6482", "merged": true, "mergeCommit": {"oid": "ebee5ecde99009413a3eafc928ae08374a3a8c92"}, "closed": true, "closedAt": "2020-10-26T18:23:58Z", "author": {"login": "spena"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUtgwxAH2gAyNTA3NzIzODE5OjEzMTcyYjk0ZjgzZGNjMzQ3MTQ2NGIwZGQ3OGExZWExYzA1OTZkYWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWV30ugBqjM5MjEyNjM0NjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "13172b94f83dcc3471464b0dd78a1ea1c0596dae", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/13172b94f83dcc3471464b0dd78a1ea1c0596dae", "committedDate": "2020-10-21T13:37:14Z", "message": "fix: Internal Server Error for /healthcheck endpoint in RBAC-enabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f49fbf29e9728f84f26e0f5c23b1b57cc8be2c71", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/f49fbf29e9728f84f26e0f5c23b1b57cc8be2c71", "committedDate": "2020-10-22T11:12:07Z", "message": "test: add tests to verify paths without authentication"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a4ac35600490d080551fb69d5980e84626ecb0a9", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/a4ac35600490d080551fb69d5980e84626ecb0a9", "committedDate": "2020-10-21T17:11:37Z", "message": "test: add tests to verify paths without authentication"}, "afterCommit": {"oid": "64038328e0973fe0ed53d72b364575ffc4130490", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/64038328e0973fe0ed53d72b364575ffc4130490", "committedDate": "2020-10-22T11:20:07Z", "message": "chore: remove unused method"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "64038328e0973fe0ed53d72b364575ffc4130490", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/64038328e0973fe0ed53d72b364575ffc4130490", "committedDate": "2020-10-22T11:20:07Z", "message": "chore: remove unused method"}, "afterCommit": {"oid": "1202d41893a574721333b23cf498d6fc6e5b3064", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/1202d41893a574721333b23cf498d6fc6e5b3064", "committedDate": "2020-10-22T12:58:25Z", "message": "chore: remove unused method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "807260d12172929e67f270ed33768f3902309c72", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/807260d12172929e67f270ed33768f3902309c72", "committedDate": "2020-10-22T17:26:24Z", "message": "chore: remove unused method"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1202d41893a574721333b23cf498d6fc6e5b3064", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/1202d41893a574721333b23cf498d6fc6e5b3064", "committedDate": "2020-10-22T12:58:25Z", "message": "chore: remove unused method"}, "afterCommit": {"oid": "807260d12172929e67f270ed33768f3902309c72", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/807260d12172929e67f270ed33768f3902309c72", "committedDate": "2020-10-22T17:26:24Z", "message": "chore: remove unused method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MjM0MTg2", "url": "https://github.com/confluentinc/ksql/pull/6482#pullrequestreview-515234186", "createdAt": "2020-10-23T02:18:46Z", "commit": {"oid": "807260d12172929e67f270ed33768f3902309c72"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwMjoxODo0NlrOHm58cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwMjoyMDowNVrOHm592w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU1NzI5OQ==", "bodyText": "Why can't this still be private?", "url": "https://github.com/confluentinc/ksql/pull/6482#discussion_r510557299", "createdAt": "2020-10-23T02:18:46Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/test/java/io/confluent/ksql/api/AuthTest.java", "diffHunk": "@@ -539,7 +612,7 @@ private void shouldNotAllowAccessIfPermissionCheckThrowsException(\n     void run() throws Exception;\n   }\n \n-  private static class StringPrincipal implements Principal {\n+  public static class StringPrincipal implements Principal {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "807260d12172929e67f270ed33768f3902309c72"}, "originalPosition": 150}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU1NzUxNQ==", "bodyText": "Can we move this into AuthenticationPluginHandler if we're going to rename it? It looks out of place here.", "url": "https://github.com/confluentinc/ksql/pull/6482#discussion_r510557515", "createdAt": "2020-10-23T02:19:33Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/auth/KsqlAuthorizationProviderHandler.java", "diffHunk": "@@ -32,7 +32,7 @@\n  */\n public class KsqlAuthorizationProviderHandler implements Handler<RoutingContext> {\n \n-  public static final Set<String> PATHS_WITHOUT_AUTHORIZATION = ImmutableSet\n+  public static final Set<String> KSQL_AUTHENTICATION_SKIP_PATHS = ImmutableSet", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "807260d12172929e67f270ed33768f3902309c72"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU1NzYxNQ==", "bodyText": "nit: can we rename this to sendPostRequest() in light of the new method above?", "url": "https://github.com/confluentinc/ksql/pull/6482#discussion_r510557615", "createdAt": "2020-10-23T02:19:54Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/test/java/io/confluent/ksql/api/AuthTest.java", "diffHunk": "@@ -137,6 +142,11 @@ public void close() {\n     server.start();\n   }\n \n+  @Override\n+  protected HttpResponse<Buffer> sendGetRequest(final String uri) throws Exception {\n+    return sendGetRequestWithCreds(client, uri, USER_WITH_ACCESS, USER_WITH_ACCESS_PWD);\n+  }\n+\n   @Override\n   protected HttpResponse<Buffer> sendRequest(final WebClient client, final String uri,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "807260d12172929e67f270ed33768f3902309c72"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU1NzY1OQ==", "bodyText": "nit: can we rename this to sendPostRequestWithCreds() in light of the new method above?", "url": "https://github.com/confluentinc/ksql/pull/6482#discussion_r510557659", "createdAt": "2020-10-23T02:20:05Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/test/java/io/confluent/ksql/api/AuthTest.java", "diffHunk": "@@ -415,6 +436,22 @@ private void shouldFailInsertRequest(final String username, final String passwor\n     validateError(expectedErrorCode, expectedMessage, insertsResponse.error);\n   }\n \n+  // auth header is omitted if username and password are null\n+  private static HttpResponse<Buffer> sendGetRequestWithCreds(\n+      final WebClient client,\n+      final String uri,\n+      final String username,\n+      final String password\n+  ) throws Exception {\n+    VertxCompletableFuture<HttpResponse<Buffer>> requestFuture = new VertxCompletableFuture<>();\n+    HttpRequest<Buffer> request = client.get(uri);\n+    if (username != null || password != null) {\n+      request = request.basicAuthentication(username, password);\n+    }\n+    request.send(requestFuture);\n+    return requestFuture.get();\n+  }\n+\n   private HttpResponse<Buffer> sendRequestWithCreds(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "807260d12172929e67f270ed33768f3902309c72"}, "originalPosition": 92}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3558b6b22d2a37b8baa8ce8efb35ba878026cc58", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/3558b6b22d2a37b8baa8ce8efb35ba878026cc58", "committedDate": "2020-10-23T14:37:37Z", "message": "refactor: rename sendRequest() to sendPostRequest()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ea80d536d51ec8d6903bafbd1819ef4a3937525", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/5ea80d536d51ec8d6903bafbd1819ef4a3937525", "committedDate": "2020-10-23T14:45:57Z", "message": "refactor: move KSQL_AUTHENTICATINO_SKIPT_PATHS and other minor fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "553fc189802891fd3138b824c5f2804102dfcd97", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/553fc189802891fd3138b824c5f2804102dfcd97", "committedDate": "2020-10-23T20:12:51Z", "message": "fix: return a default ServiceContext when User is missing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ffca8426e8d1277088675f1fcca521a1928dd8d3", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/ffca8426e8d1277088675f1fcca521a1928dd8d3", "committedDate": "2020-10-23T16:02:58Z", "message": "fix: return a default ServiceContext when User is missing"}, "afterCommit": {"oid": "553fc189802891fd3138b824c5f2804102dfcd97", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/553fc189802891fd3138b824c5f2804102dfcd97", "committedDate": "2020-10-23T20:12:51Z", "message": "fix: return a default ServiceContext when User is missing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NDY3MTAz", "url": "https://github.com/confluentinc/ksql/pull/6482#pullrequestreview-516467103", "createdAt": "2020-10-26T04:51:19Z", "commit": {"oid": "553fc189802891fd3138b824c5f2804102dfcd97"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNDo1MToxOVrOHoA1KQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNDo1MToxOVrOHoA1KQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcxODY5Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // A user context is not necessary if a user context provider is not present or\n          \n          \n            \n                // the user principal is missing. The missing principal was already validated by the\n          \n          \n            \n                // Authentication and Authorization plugins before calling this method, which means the\n          \n          \n            \n                // missing principal is a valid connection. For those cases, we create a default service\n          \n          \n            \n                // context that the missing user can use.\n          \n          \n            \n                // A user context is not necessary if a user context provider is not present or\n          \n          \n            \n                // the user principal is missing. If a failed authentication attempt results in a missing principle,\n          \n          \n            \n                // then the authentication plugin will have already failed the connection before calling this method.\n          \n          \n            \n                // Therefore, if we've reached this method with a missing principle, then this must be a valid connection that does not require authentication. \n          \n          \n            \n                // For these cases, we create a default service\n          \n          \n            \n                // context that the missing user can use.", "url": "https://github.com/confluentinc/ksql/pull/6482#discussion_r511718697", "createdAt": "2020-10-26T04:51:19Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/impl/DefaultKsqlSecurityContextProvider.java", "diffHunk": "@@ -57,7 +57,17 @@ public KsqlSecurityContext provide(final ApiSecurityContext apiSecurityContext)\n     final Optional<Principal> principal = apiSecurityContext.getPrincipal();\n     final Optional<String> authHeader = apiSecurityContext.getAuthToken();\n \n-    if (securityExtension == null || !securityExtension.getUserContextProvider().isPresent()) {\n+    // A user context is not necessary if a user context provider is not present or\n+    // the user principal is missing. The missing principal was already validated by the\n+    // Authentication and Authorization plugins before calling this method, which means the\n+    // missing principal is a valid connection. For those cases, we create a default service\n+    // context that the missing user can use.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "553fc189802891fd3138b824c5f2804102dfcd97"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50cbb758f8b4dec9343c1487107b49301a1381f6", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/50cbb758f8b4dec9343c1487107b49301a1381f6", "committedDate": "2020-10-26T15:12:05Z", "message": "Update comment\n\nCo-authored-by: Victoria Xia <victoria.f.xia281@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e93c03573112ae20506fc7ac59aa901270750923", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/e93c03573112ae20506fc7ac59aa901270750923", "committedDate": "2020-10-26T14:30:04Z", "message": "Update ksqldb-rest-app/src/main/java/io/confluent/ksql/api/impl/DefaultKsqlSecurityContextProvider.java\n\nCo-authored-by: Victoria Xia <victoria.f.xia281@gmail.com>"}, "afterCommit": {"oid": "50cbb758f8b4dec9343c1487107b49301a1381f6", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/50cbb758f8b4dec9343c1487107b49301a1381f6", "committedDate": "2020-10-26T15:12:05Z", "message": "Update comment\n\nCo-authored-by: Victoria Xia <victoria.f.xia281@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4586, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}