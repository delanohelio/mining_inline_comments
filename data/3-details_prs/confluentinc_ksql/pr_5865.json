{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1Mjc3MTE5", "number": 5865, "title": "chore: dont list all topics to determine single topic existence (MINOR)", "bodyText": "Description\nWe shouldn't be using listTopics to determine whether or not a single topic exists. This PR changes it to use the describeTopics API to check for only a single topic.\nTesting done\nUnit tests\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-07-22T18:15:09Z", "url": "https://github.com/confluentinc/ksql/pull/5865", "merged": true, "mergeCommit": {"oid": "d742b137db667594b6d872c8341d64b38ae23b18"}, "closed": true, "closedAt": "2020-07-23T15:23:13Z", "author": {"login": "agavra"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3ewK4gH2gAyNDU1Mjc3MTE5OjU3MWE1OGQyZDg3OWJmNjY1ZmE2OTNmZmY5MmViOTEzMzlkNGE5Njg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3lDhVgFqTQ1Mzc4NjMwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "571a58d2d879bf665fa693fff92eb91339d4a968", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/571a58d2d879bf665fa693fff92eb91339d4a968", "committedDate": "2020-07-22T18:01:41Z", "message": "chore: dont list all topics to determine single topic existence"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8dde38f7882bc0654ff3a440ebbc2811f280ddcb", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/8dde38f7882bc0654ff3a440ebbc2811f280ddcb", "committedDate": "2020-07-22T18:51:45Z", "message": "test: fix the tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNjEyMDU0", "url": "https://github.com/confluentinc/ksql/pull/5865#pullrequestreview-453612054", "createdAt": "2020-07-22T19:16:51Z", "commit": {"oid": "8dde38f7882bc0654ff3a440ebbc2811f280ddcb"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOToxNjo1MVrOG1wrkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOToxNjo1MVrOG1wrkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAyNTI5OA==", "bodyText": "If they're not authorized, it returns false.  Was this the behavior of listTopicNames that it returned a list of only the topics for which they are authorized?", "url": "https://github.com/confluentinc/ksql/pull/5865#discussion_r459025298", "createdAt": "2020-07-22T19:16:51Z", "author": {"login": "AlanConfluent"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/services/KafkaTopicClientImpl.java", "diffHunk": "@@ -161,7 +165,26 @@ private short getDefaultClusterReplication() {\n   @Override\n   public boolean isTopicExists(final String topic) {\n     LOG.trace(\"Checking for existence of topic '{}'\", topic);\n-    return listTopicNames().contains(topic);\n+    try {\n+      ExecutorUtil.executeWithRetries(\n+          () -> adminClient.get().describeTopics(\n+              ImmutableList.of(topic),\n+              new DescribeTopicsOptions().includeAuthorizedOperations(true)\n+          ).values().get(topic).get(),\n+          RetryBehaviour.ON_RETRYABLE\n+      );\n+      return true;\n+    } catch (final Exception e) {\n+      if (Throwables.getRootCause(e) instanceof UnknownTopicOrPartitionException) {\n+        return false;\n+      }\n+\n+      if (Throwables.getRootCause(e) instanceof TopicAuthorizationException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8dde38f7882bc0654ff3a440ebbc2811f280ddcb"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNjYxMDM0", "url": "https://github.com/confluentinc/ksql/pull/5865#pullrequestreview-453661034", "createdAt": "2020-07-22T20:30:04Z", "commit": {"oid": "8dde38f7882bc0654ff3a440ebbc2811f280ddcb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMDozMDowNFrOG1zDkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMDozMDowNFrOG1zDkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2NDIwOQ==", "bodyText": "I'm not sure I understand the reasoning for returning false here. We don't know if the topic exists or not at this point right?", "url": "https://github.com/confluentinc/ksql/pull/5865#discussion_r459064209", "createdAt": "2020-07-22T20:30:04Z", "author": {"login": "rodesai"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/services/KafkaTopicClientImpl.java", "diffHunk": "@@ -161,7 +165,26 @@ private short getDefaultClusterReplication() {\n   @Override\n   public boolean isTopicExists(final String topic) {\n     LOG.trace(\"Checking for existence of topic '{}'\", topic);\n-    return listTopicNames().contains(topic);\n+    try {\n+      ExecutorUtil.executeWithRetries(\n+          () -> adminClient.get().describeTopics(\n+              ImmutableList.of(topic),\n+              new DescribeTopicsOptions().includeAuthorizedOperations(true)\n+          ).values().get(topic).get(),\n+          RetryBehaviour.ON_RETRYABLE\n+      );\n+      return true;\n+    } catch (final Exception e) {\n+      if (Throwables.getRootCause(e) instanceof UnknownTopicOrPartitionException) {\n+        return false;\n+      }\n+\n+      if (Throwables.getRootCause(e) instanceof TopicAuthorizationException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8dde38f7882bc0654ff3a440ebbc2811f280ddcb"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "926d1cbdc0353badf88edad6e8e9e31d682390b2", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/926d1cbdc0353badf88edad6e8e9e31d682390b2", "committedDate": "2020-07-22T21:12:02Z", "message": "chore: checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c7c738e3fb0352f958a32bff013e5e5b7ae9b00", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/0c7c738e3fb0352f958a32bff013e5e5b7ae9b00", "committedDate": "2020-07-22T21:42:37Z", "message": "chore: remove ACL check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNzg2MzA5", "url": "https://github.com/confluentinc/ksql/pull/5865#pullrequestreview-453786309", "createdAt": "2020-07-23T01:22:15Z", "commit": {"oid": "0c7c738e3fb0352f958a32bff013e5e5b7ae9b00"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4751, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}