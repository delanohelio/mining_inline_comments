{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3NTA4NjE2", "number": 4597, "title": "fix: added special handling for forwarded pull query request ", "bodyText": "Description\nFixes #4506 and #4413\nBefore this change we had no way to differentiate between a request that originated from a client and a request internally forwarded to another ksql host due to HA. This resulted in both requests being handled the same way which means for both the logic of filtering and deciding where to route to and actually routing was applied. This could lead to infinite loops of routing between standbys if their lags fluctuated.\nWith this change, if a request is the result of internal forwarding, the forwarded request is either served locally or not at all and the pull query fails. The only filter applied is the max lag filter of the localhost.\nMost notable changes:\nBesides changes in PullQueryExecutor and KsLocator, I created a new config file for internal properties set as part of a pull query request (KsqlRequestConfig) and I also added a map to the KsqlResquest for these properties.\nTesting done\nAdded the properties map to KsqlRequestTest and verified PullQueryRoutingFunctionalTest works as expected.", "createdAt": "2020-02-20T01:52:42Z", "url": "https://github.com/confluentinc/ksql/pull/4597", "merged": true, "mergeCommit": {"oid": "ba4fe7456209000889a4e9c978a4a63c3946f70e"}, "closed": true, "closedAt": "2020-02-27T22:38:26Z", "author": {"login": "vpapavas"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHo37zgFqTM2MzYyOTQ4NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIirpDgFqTM2NjAzMTI2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNjI5NDg0", "url": "https://github.com/confluentinc/ksql/pull/4597#pullrequestreview-363629484", "createdAt": "2020-02-24T19:08:15Z", "commit": {"oid": "b5ca4a22c9f854c938ba9607923afcbedd9b770e"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxOTowODoxNVrOFtsWyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQwMjo0MDoyM1rOFt237Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ1Njk2OQ==", "bodyText": "should we rework this block.. Seems like we just want to match a propertyName to three prefixes and call three different methods?", "url": "https://github.com/confluentinc/ksql/pull/4597#discussion_r383456969", "createdAt": "2020-02-24T19:08:15Z", "author": {"login": "vinothchandar"}, "path": "ksql-common/src/main/java/io/confluent/ksql/config/KsqlConfigResolver.java", "diffHunk": "@@ -51,8 +54,12 @@\n   @Override\n   public  Optional<ConfigItem> resolve(final String propertyName, final boolean strict) {\n     if (propertyName.startsWith(KSQL_CONFIG_PROPERTY_PREFIX)\n-        && !propertyName.startsWith(KSQL_STREAMS_PREFIX)) {\n+        && !propertyName.startsWith(KSQL_STREAMS_PREFIX)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5ca4a22c9f854c938ba9607923afcbedd9b770e"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU1MTk0NQ==", "bodyText": "rename to SKIP_ROUTING to stay consistent with terminologies?", "url": "https://github.com/confluentinc/ksql/pull/4597#discussion_r383551945", "createdAt": "2020-02-24T22:26:34Z", "author": {"login": "vinothchandar"}, "path": "ksql-common/src/main/java/io/confluent/ksql/util/KsqlRequestConfig.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 2019 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"; you may not use\n+ * this file except in compliance with the License. You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.util;\n+\n+import java.util.Map;\n+import org.apache.kafka.common.config.AbstractConfig;\n+import org.apache.kafka.common.config.ConfigDef;\n+import org.apache.kafka.common.config.ConfigDef.Type;\n+\n+public class KsqlRequestConfig extends AbstractConfig {\n+\n+  public static final String KSQL_REQUEST_CONFIG_PROPERTY_PREFIX = \"request.ksql.\";\n+\n+  public static final ConfigDef CURRENT_DEF = buildConfigDef();\n+\n+  public static final String KSQL_REQUEST_QUERY_PULL_SKIP_FORWARD =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5ca4a22c9f854c938ba9607923afcbedd9b770e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU1MjI1NQ==", "bodyText": "should these be on their own lines?", "url": "https://github.com/confluentinc/ksql/pull/4597#discussion_r383552255", "createdAt": "2020-02-24T22:27:17Z", "author": {"login": "vinothchandar"}, "path": "ksql-engine/src/main/java/io/confluent/ksql/engine/KsqlEngine.java", "diffHunk": "@@ -230,7 +235,8 @@ public QueryMetadata executeQuery(\n       final Consumer<GenericRow> rowConsumer\n   ) {\n     final QueryMetadata query = EngineExecutor\n-        .create(primaryContext, serviceContext, statement.getConfig(), statement.getOverrides())\n+        .create(\n+            primaryContext, serviceContext, statement.getConfig(), statement.getClientProperties())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5ca4a22c9f854c938ba9607923afcbedd9b770e"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyNDY0Mw==", "bodyText": "by clientProperties, do you actually mean requestProperties?  may be we can stick to that?", "url": "https://github.com/confluentinc/ksql/pull/4597#discussion_r383624643", "createdAt": "2020-02-25T02:21:38Z", "author": {"login": "vinothchandar"}, "path": "ksql-engine/src/main/java/io/confluent/ksql/statement/ConfiguredStatement.java", "diffHunk": "@@ -35,7 +35,9 @@\n \n   private final PreparedStatement<T> statement;\n   @EffectivelyImmutable\n-  private final ImmutableMap<String, Object> overrides;\n+  private final ImmutableMap<String, Object> clientProperties;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5ca4a22c9f854c938ba9607923afcbedd9b770e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyNDkzMw==", "bodyText": "I guess this is what we originally meant by overrides which have to be from KsqlConfig.. If so, then call this configOverrides ... trying to move away from client and server terminology, since it feels a bit broad", "url": "https://github.com/confluentinc/ksql/pull/4597#discussion_r383624933", "createdAt": "2020-02-25T02:22:53Z", "author": {"login": "vinothchandar"}, "path": "ksql-engine/src/main/java/io/confluent/ksql/statement/ConfiguredStatement.java", "diffHunk": "@@ -35,7 +35,9 @@\n \n   private final PreparedStatement<T> statement;\n   @EffectivelyImmutable\n-  private final ImmutableMap<String, Object> overrides;\n+  private final ImmutableMap<String, Object> clientProperties;\n+  @EffectivelyImmutable\n+  private final ImmutableMap<String, Object> serverProperties;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5ca4a22c9f854c938ba9607923afcbedd9b770e"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyNjA1OA==", "bodyText": "why fold the line?", "url": "https://github.com/confluentinc/ksql/pull/4597#discussion_r383626058", "createdAt": "2020-02-25T02:27:27Z", "author": {"login": "vinothchandar"}, "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/KsqlRestApplication.java", "diffHunk": "@@ -783,18 +783,27 @@ static KsqlRestApplication buildApplication(\n   }\n \n   private static RoutingFilterFactory initializeRoutingFilterFactory(\n-      final KsqlConfig ksqlConfig,\n+      final KsqlConfig configWithApplicationServer,\n       final Optional<HeartbeatAgent> heartbeatAgent,\n       final Optional<LagReportingAgent> lagReportingAgent) {\n     return (routingOptions, hosts, active, applicationQueryId, storeName, partition) -> {\n       final ImmutableList.Builder<RoutingFilter> filterBuilder = ImmutableList.builder();\n-      if (!ksqlConfig.getBoolean(KsqlConfig.KSQL_QUERY_PULL_ENABLE_STANDBY_READS)) {\n-        filterBuilder.add(new ActiveHostFilter(active));\n+\n+      // If the lookup is for a forwarded request, apply only MaxLagFilter for localhost\n+      if (routingOptions.skipForwardRequest()) {\n+        MaximumLagFilter.create(\n+            lagReportingAgent, routingOptions, hosts, applicationQueryId, storeName, partition)\n+            .map(filterBuilder::add);\n+      } else {\n+        if (!configWithApplicationServer.getBoolean(\n+            KsqlConfig.KSQL_QUERY_PULL_ENABLE_STANDBY_READS)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5ca4a22c9f854c938ba9607923afcbedd9b770e"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyNzAxMQ==", "bodyText": "Forwarding attempt failed?", "url": "https://github.com/confluentinc/ksql/pull/4597#discussion_r383627011", "createdAt": "2020-02-25T02:30:34Z", "author": {"login": "vinothchandar"}, "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/PullQueryExecutor.java", "diffHunk": "@@ -317,6 +317,63 @@ TableRowsEntity queryRowsLocally(\n     );\n   }\n \n+  @VisibleForTesting\n+  TableRowsEntity forwardTo(\n+      final KsqlNode owner,\n+      final ConfiguredStatement<Query> statement,\n+      final ServiceContext serviceContext\n+  ) {\n+    // Add skip forward flag to properties\n+    final Map<String, Object> serverProperties = ImmutableMap.of(\n+        KsqlRequestConfig.KSQL_REQUEST_QUERY_PULL_SKIP_FORWARD, true);\n+    final RestResponse<List<StreamedRow>> response = serviceContext\n+        .getKsqlClient()\n+        .makeQueryRequest(\n+            owner.location(),\n+            statement.getStatementText(),\n+            statement.getClientProperties(),\n+            serverProperties\n+        );\n+\n+    if (response.isErroneous()) {\n+      throw new KsqlServerException(\"Proxy attempt failed: \" + response.getErrorMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5ca4a22c9f854c938ba9607923afcbedd9b770e"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyNzA5Mw==", "bodyText": "forward call?  lets stick to one term? :)", "url": "https://github.com/confluentinc/ksql/pull/4597#discussion_r383627093", "createdAt": "2020-02-25T02:30:51Z", "author": {"login": "vinothchandar"}, "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/PullQueryExecutor.java", "diffHunk": "@@ -317,6 +317,63 @@ TableRowsEntity queryRowsLocally(\n     );\n   }\n \n+  @VisibleForTesting\n+  TableRowsEntity forwardTo(\n+      final KsqlNode owner,\n+      final ConfiguredStatement<Query> statement,\n+      final ServiceContext serviceContext\n+  ) {\n+    // Add skip forward flag to properties\n+    final Map<String, Object> serverProperties = ImmutableMap.of(\n+        KsqlRequestConfig.KSQL_REQUEST_QUERY_PULL_SKIP_FORWARD, true);\n+    final RestResponse<List<StreamedRow>> response = serviceContext\n+        .getKsqlClient()\n+        .makeQueryRequest(\n+            owner.location(),\n+            statement.getStatementText(),\n+            statement.getClientProperties(),\n+            serverProperties\n+        );\n+\n+    if (response.isErroneous()) {\n+      throw new KsqlServerException(\"Proxy attempt failed: \" + response.getErrorMessage());\n+    }\n+\n+    final List<StreamedRow> streamedRows = response.getResponse();\n+    if (streamedRows.isEmpty()) {\n+      throw new KsqlServerException(\"Invalid empty response from proxy call\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5ca4a22c9f854c938ba9607923afcbedd9b770e"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyNzI4OA==", "bodyText": "since this got moved, it was hard to see what changed. but seems like you are just adding the flag.", "url": "https://github.com/confluentinc/ksql/pull/4597#discussion_r383627288", "createdAt": "2020-02-25T02:31:42Z", "author": {"login": "vinothchandar"}, "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/PullQueryExecutor.java", "diffHunk": "@@ -317,6 +317,63 @@ TableRowsEntity queryRowsLocally(\n     );\n   }\n \n+  @VisibleForTesting\n+  TableRowsEntity forwardTo(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5ca4a22c9f854c938ba9607923afcbedd9b770e"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyODY3Nw==", "bodyText": "just 1 debug statement after the if block, that print the flag value, and allHosts?", "url": "https://github.com/confluentinc/ksql/pull/4597#discussion_r383628677", "createdAt": "2020-02-25T02:37:46Z", "author": {"login": "vinothchandar"}, "path": "ksql-streams/src/main/java/io/confluent/ksql/execution/streams/materialization/ks/KsLocator.java", "diffHunk": "@@ -85,17 +86,26 @@\n \n     final HostInfo activeHost = metadata.getActiveHost();\n     final Set<HostInfo> standByHosts = metadata.getStandbyHosts();\n-    LOG.debug(\"Before filtering: Active host {} , standby hosts {}\", activeHost, standByHosts);\n \n-    final List<KsqlHostInfo> allHosts = Stream.concat(Stream.of(activeHost), standByHosts.stream())\n-        .map(this::asKsqlHost)\n-        .collect(Collectors.toList());\n+    // If the lookup is for a forwarded request, only filter localhost\n+    List<KsqlHostInfo> allHosts = null;\n+    if (routingOptions.skipForwardRequest()) {\n+      LOG.debug(\"Before filtering: Local host {} \", localHost);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5ca4a22c9f854c938ba9607923afcbedd9b770e"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzYyOTI5Mw==", "bodyText": "I assume this will make node.isLocal() return true always", "url": "https://github.com/confluentinc/ksql/pull/4597#discussion_r383629293", "createdAt": "2020-02-25T02:40:23Z", "author": {"login": "vinothchandar"}, "path": "ksql-streams/src/main/java/io/confluent/ksql/execution/streams/materialization/ks/KsLocator.java", "diffHunk": "@@ -85,17 +86,26 @@\n \n     final HostInfo activeHost = metadata.getActiveHost();\n     final Set<HostInfo> standByHosts = metadata.getStandbyHosts();\n-    LOG.debug(\"Before filtering: Active host {} , standby hosts {}\", activeHost, standByHosts);\n \n-    final List<KsqlHostInfo> allHosts = Stream.concat(Stream.of(activeHost), standByHosts.stream())\n-        .map(this::asKsqlHost)\n-        .collect(Collectors.toList());\n+    // If the lookup is for a forwarded request, only filter localhost\n+    List<KsqlHostInfo> allHosts = null;\n+    if (routingOptions.skipForwardRequest()) {\n+      LOG.debug(\"Before filtering: Local host {} \", localHost);\n+      allHosts = ImmutableList.of(new KsqlHostInfo(localHost.getHost(), localHost.getPort()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5ca4a22c9f854c938ba9607923afcbedd9b770e"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b5ca4a22c9f854c938ba9607923afcbedd9b770e", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/b5ca4a22c9f854c938ba9607923afcbedd9b770e", "committedDate": "2020-02-20T01:52:23Z", "message": "minor change"}, "afterCommit": {"oid": "8af5fac42d7bc91a0ec3b6b0f1ce12c4f6bad623", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/8af5fac42d7bc91a0ec3b6b0f1ce12c4f6bad623", "committedDate": "2020-02-27T17:16:44Z", "message": "applied vinoth's comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "736619fb4e2d73078b929bbbe9118984d36796ef", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/736619fb4e2d73078b929bbbe9118984d36796ef", "committedDate": "2020-02-27T18:21:15Z", "message": "added request properties to ksql request\n\nfixed tests\n\nminor change\n\napplied vinoth's comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cb97921a1f66ebf8ea8b741fb8d3b549a81c517", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/9cb97921a1f66ebf8ea8b741fb8d3b549a81c517", "committedDate": "2020-02-27T19:55:50Z", "message": "rebase"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8af5fac42d7bc91a0ec3b6b0f1ce12c4f6bad623", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/8af5fac42d7bc91a0ec3b6b0f1ce12c4f6bad623", "committedDate": "2020-02-27T17:16:44Z", "message": "applied vinoth's comments"}, "afterCommit": {"oid": "9cb97921a1f66ebf8ea8b741fb8d3b549a81c517", "author": {"user": {"login": "vpapavas", "name": "Vicky Papavasileiou"}}, "url": "https://github.com/confluentinc/ksql/commit/9cb97921a1f66ebf8ea8b741fb8d3b549a81c517", "committedDate": "2020-02-27T19:55:50Z", "message": "rebase"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MDMxMjYw", "url": "https://github.com/confluentinc/ksql/pull/4597#pullrequestreview-366031260", "createdAt": "2020-02-27T22:01:55Z", "commit": {"oid": "8af5fac42d7bc91a0ec3b6b0f1ce12c4f6bad623"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4850, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}