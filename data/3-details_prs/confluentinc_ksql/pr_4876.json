{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyNjcyODA4", "number": 4876, "title": "refactor: cloud-first ksqldb releases", "bodyText": "Description\nSame as #4774 except triggers downstream job in cc-docker-ksql for the portion of the job that builds a Cloud image.\nRequires confluentinc/cc-docker-ksql#37 to be merged, as that change adds the necessary build params to the cc-docker-ksql jobs.\nTesting done\nVerified docker images and GitHub tags from manual testing builds in Jenkins.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-03-23T22:32:52Z", "url": "https://github.com/confluentinc/ksql/pull/4876", "merged": true, "mergeCommit": {"oid": "03048d3a44cfb8234430f1742cf34edad302b08c"}, "closed": true, "closedAt": "2020-04-03T22:39:45Z", "author": {"login": "vcrfxia"}, "timelineItems": {"totalCount": 48, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcM-fw9gH2gAyMzkyNjcyODA4OmQxNDAxYmNjNWEyYTQ1ZTQ2OTVmMzYzZDQ1OWM0NmU4OGY1NzQ1Y2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcUIZx7AH2gAyMzkyNjcyODA4OmQzNWZhNTYwMDc4ZThiNWJkMmQzOTVjODJmMzcwMmQyMTMyNzcyZDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d1401bcc5a2a45e4695f363d459c46e88f5745cb", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/d1401bcc5a2a45e4695f363d459c46e88f5745cb", "committedDate": "2020-03-12T16:41:59Z", "message": "chore: bump ksqlDB version to 0.8.0 and update CP dependency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c3292d65ec82c57e05028a74188fe2c7d49d048", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/3c3292d65ec82c57e05028a74188fe2c7d49d048", "committedDate": "2020-03-12T17:27:12Z", "message": "fix: update docker artifact name in light of module rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93ec21eb58585416f35e8edd64257572b51c5178", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/93ec21eb58585416f35e8edd64257572b51c5178", "committedDate": "2020-03-12T23:25:44Z", "message": "build: add building ccloud image into release pipeline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e03ee6b806b2dfbc97784a1d8297d4aa7c04f302", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/e03ee6b806b2dfbc97784a1d8297d4aa7c04f302", "committedDate": "2020-03-12T23:37:00Z", "message": "fix: look for artifacts in staging s3 bucket"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1180da6a990a07b9b6bfc1caa38d78f0828f484", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/e1180da6a990a07b9b6bfc1caa38d78f0828f484", "committedDate": "2020-03-12T23:45:51Z", "message": "chore: temporarily remove slack notification to avoid spamming channel for tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90a2daba9cf4a1b2e4cc543857e6d2a19139f753", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/90a2daba9cf4a1b2e4cc543857e6d2a19139f753", "committedDate": "2020-03-13T20:49:02Z", "message": "fix: fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea03a8367c4cbd18808a7a2f456116f0641cc9cc", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/ea03a8367c4cbd18808a7a2f456116f0641cc9cc", "committedDate": "2020-03-13T20:49:55Z", "message": "chore: temporarily change cc-docker-ksql branch until PR is merged"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34e0e5e32b72f512da5d53802c20178f9920bff6", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/34e0e5e32b72f512da5d53802c20178f9920bff6", "committedDate": "2020-03-13T20:56:51Z", "message": "chore: temporarily disable ksqldb build to focus on testing cc-docker-ksql portion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7575b27da4fef482c8f05f1717ed32dcf6e41a5", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/b7575b27da4fef482c8f05f1717ed32dcf6e41a5", "committedDate": "2020-03-13T22:19:39Z", "message": "fix: more fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3ce192de3fc744fa0b7c7b499cc1cc46fedd2c6", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/a3ce192de3fc744fa0b7c7b499cc1cc46fedd2c6", "committedDate": "2020-03-13T22:27:07Z", "message": "Merge branch 'ksql-db-release' into ksql-db-release-cloud-first-release"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2ff9b19a7011c0d38d4c57d6c44da4fd964d8fb", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/f2ff9b19a7011c0d38d4c57d6c44da4fd964d8fb", "committedDate": "2020-03-13T22:37:33Z", "message": "chore: temporarily set isPrJob to false for testing purposes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9d4dafe7d1d776cb4dba6e5291511aad8e1384c", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/d9d4dafe7d1d776cb4dba6e5291511aad8e1384c", "committedDate": "2020-03-13T22:37:53Z", "message": "Revert \"chore: temporarily set isPrJob to false for testing purposes\"\n\nThis reverts commit f2ff9b19a7011c0d38d4c57d6c44da4fd964d8fb."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae8e37d685835cbc55b25000bac2f7d0f7b83b83", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/ae8e37d685835cbc55b25000bac2f7d0f7b83b83", "committedDate": "2020-03-13T22:38:26Z", "message": "fix: more fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c00fe068b00b5533f48383aefc7ca99504cef30", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/7c00fe068b00b5533f48383aefc7ca99504cef30", "committedDate": "2020-03-13T22:54:40Z", "message": "fix: more fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cc39a2c6a5f07b10888efe0794a1aed92c6e890", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/8cc39a2c6a5f07b10888efe0794a1aed92c6e890", "committedDate": "2020-03-21T08:03:01Z", "message": "bump beta packaging version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91fbf59592209d961e919439e699d15d68023cdb", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/91fbf59592209d961e919439e699d15d68023cdb", "committedDate": "2020-03-23T18:54:09Z", "message": "build: switch to common jenkins credentials for cloud build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aed71b67fc51b8bffe08fc6dc388f877eeaf9521", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/aed71b67fc51b8bffe08fc6dc388f877eeaf9521", "committedDate": "2020-03-23T18:58:31Z", "message": "chore: backout unnecessary changes to maven settings template"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e79b453779308bba121aa2c096be6b84eddc32f3", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/e79b453779308bba121aa2c096be6b84eddc32f3", "committedDate": "2020-03-23T19:01:39Z", "message": "build: pass packaging beta version to downstream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4df4659bd6ec46c020185aa58272595461dfe397", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/4df4659bd6ec46c020185aa58272595461dfe397", "committedDate": "2020-03-23T20:09:33Z", "message": "chore: backout temporary changes and other cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "632c13f598ebec7e8755da8c53f860a49f619191", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/632c13f598ebec7e8755da8c53f860a49f619191", "committedDate": "2020-03-23T20:18:41Z", "message": "Merge branch 'ksql-db-release' into ksql-db-release-cloud-first-release"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19a084eb7c1797694b9c1f294b408e0341505855", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/19a084eb7c1797694b9c1f294b408e0341505855", "committedDate": "2020-03-23T20:56:46Z", "message": "chore: pass packaging build number to downstream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "695ed42e4eed56a6ce5ec175a28d369cff776a73", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/695ed42e4eed56a6ce5ec175a28d369cff776a73", "committedDate": "2020-03-23T21:35:17Z", "message": "fix: missed a spot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "268d1290dae303974f61126bbf227d554ef271aa", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/268d1290dae303974f61126bbf227d554ef271aa", "committedDate": "2020-03-23T21:44:57Z", "message": "chore: remove unneeded block from cloud image section"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd9b250481022540c585be741453aae42d360657", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/cd9b250481022540c585be741453aae42d360657", "committedDate": "2020-03-23T22:31:58Z", "message": "build: trigger cc-docker-ksql build as separate job"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a12ca5f4fa565dca20c9cab2e53ce6ed2c098805", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/a12ca5f4fa565dca20c9cab2e53ce6ed2c098805", "committedDate": "2020-03-24T21:12:40Z", "message": "Merge branch 'ksql-db-release' into ksql-db-release-cloud-first-release-2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNzc3Mzkw", "url": "https://github.com/confluentinc/ksql/pull/4876#pullrequestreview-380777390", "createdAt": "2020-03-24T23:58:40Z", "commit": {"oid": "a12ca5f4fa565dca20c9cab2e53ce6ed2c098805"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMzo1ODo0MFrOF7Hemg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMzo1ODo0MFrOF7Hemg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUzMjgyNg==", "bodyText": "this doesn't have to be a sha right? In fact, assuming cloud-first releases this could just be the tag we used for the cloud-release.", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r397532826", "createdAt": "2020-03-24T23:58:40Z", "author": {"login": "rodesai"}, "path": "Jenkinsfile", "diffHunk": "@@ -16,20 +16,23 @@ def baseConfig = {\n \n def defaultParams = [\n     booleanParam(name: 'RELEASE_BUILD',\n-        description: 'Is this a release build.',\n+        description: 'Is this a release build. If so, GIT_REVISION must be specified, and only on-prem images will be built.',\n         defaultValue: false),\n     string(name: 'GIT_REVISION',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a12ca5f4fa565dca20c9cab2e53ce6ed2c098805"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9021289f095bcad7a3986322e5a1d7cf909fd25", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/d9021289f095bcad7a3986322e5a1d7cf909fd25", "committedDate": "2020-03-26T01:14:36Z", "message": "chore: feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMTkzNDU4", "url": "https://github.com/confluentinc/ksql/pull/4876#pullrequestreview-382193458", "createdAt": "2020-03-26T16:36:32Z", "commit": {"oid": "d9021289f095bcad7a3986322e5a1d7cf909fd25"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNjozNjozMlrOF8P1ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNjo1MDowOVrOF8QeeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcxODM2Ng==", "bodyText": "when you say only on-prem images will be built you mean it won't trigger the cloud build, correct? because this build only builds on-prem images anyways, right. maybe we can change this to just say won't trigger cloud build because it makes it seem like this job could actually do that. i am thinking this wording is probably just left over from the original draft where this was doing both builds.", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398718366", "createdAt": "2020-03-26T16:36:32Z", "author": {"login": "elismaga"}, "path": "Jenkinsfile", "diffHunk": "@@ -16,20 +16,23 @@ def baseConfig = {\n \n def defaultParams = [\n     booleanParam(name: 'RELEASE_BUILD',\n-        description: 'Is this a release build.',\n+        description: 'Is this a release build. If so, GIT_REVISION must be specified, and only on-prem images will be built.',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9021289f095bcad7a3986322e5a1d7cf909fd25"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcxOTg0Ng==", "bodyText": "i'm confused by this. the cloud build is downstream from this so why would you need to enter the git sha for cloud when building this? it seems like this makes the ksqldb on prem build dependent on the cloud ksql build.", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398719846", "createdAt": "2020-03-26T16:38:23Z", "author": {"login": "elismaga"}, "path": "Jenkinsfile", "diffHunk": "@@ -16,20 +16,23 @@ def baseConfig = {\n \n def defaultParams = [\n     booleanParam(name: 'RELEASE_BUILD',\n-        description: 'Is this a release build.',\n+        description: 'Is this a release build. If so, GIT_REVISION must be specified, and only on-prem images will be built.',\n         defaultValue: false),\n     string(name: 'GIT_REVISION',\n-        description: 'The git SHA to create the release build from.',\n+        description: 'The git SHA to build ksqlDB from.',\n+        defaultValue: ''),\n+    string(name: 'CCLOUD_GIT_REVISION',\n+        description: 'The cc-docker-ksql git SHA to build the CCloud ksqlDB image from.',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9021289f095bcad7a3986322e5a1d7cf909fd25"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyNDg1NA==", "bodyText": "if you are going to append the build number then you need to remove the snapshot qualifier. i made a more detailed comment about this in the cloud PR since I reviewed that one first", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398724854", "createdAt": "2020-03-26T16:45:03Z", "author": {"login": "elismaga"}, "path": "Jenkinsfile", "diffHunk": "@@ -74,9 +77,13 @@ def job = {\n \n         // For a release build we remove the -SNAPSHOT from the version.\n         config.ksql_db_version = config.ksql_db_version.tokenize(\"-\")[0]\n+\n+        config.ksql_db_artifact_version = config.ksql_db_version\n         config.docker_tag = config.ksql_db_version\n     } else {\n-        config.docker_tag = config.ksql_db_version.tokenize(\"-\")[0] + '-' + env.BUILD_NUMBER\n+        // For non-release builds, we append the build number to the maven artifacts and docker image tag\n+        config.ksql_db_artifact_version = config.ksql_db_version + '-' + env.BUILD_NUMBER", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9021289f095bcad7a3986322e5a1d7cf909fd25"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyNTI4Ng==", "bodyText": "is this comment still relevant since we don't build cloud images here?", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398725286", "createdAt": "2020-03-26T16:45:36Z", "author": {"login": "elismaga"}, "path": "Jenkinsfile", "diffHunk": "@@ -146,6 +153,8 @@ def job = {\n         return null\n     }\n \n+    // Build on-prem ksqlDB image", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9021289f095bcad7a3986322e5a1d7cf909fd25"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyODgyNA==", "bodyText": "can we make this if not release build then do the extra stage and trigger the cloud build.", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398728824", "createdAt": "2020-03-26T16:50:09Z", "author": {"login": "elismaga"}, "path": "Jenkinsfile", "diffHunk": "@@ -319,13 +328,35 @@ def job = {\n                     sh \"docker push ${config.dockerRegistry}${dockerRepo}:master-latest\"\n \n                     if (config.release) {\n-                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n-                        sh \"docker push ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n+                        // docker_tag for release builds does not include the build number\n+                        // here we add it back so an image version with the build number always exists\n+                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-beta${env.BUILD_NUMBER}\"\n+                        sh \"docker push ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-beta${env.BUILD_NUMBER}\"\n                     }\n                 }\n             }\n         }\n     }\n+\n+    // Build CCloud ksqlDB image\n+\n+    if (config.release) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9021289f095bcad7a3986322e5a1d7cf909fd25"}, "originalPosition": 130}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d8383acf1f0ec0fd7a18e132c09ac7a4a856ef6", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/4d8383acf1f0ec0fd7a18e132c09ac7a4a856ef6", "committedDate": "2020-03-26T22:24:45Z", "message": "fix: eli's feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNDU3Nzgx", "url": "https://github.com/confluentinc/ksql/pull/4876#pullrequestreview-382457781", "createdAt": "2020-03-26T22:12:25Z", "commit": {"oid": "d9021289f095bcad7a3986322e5a1d7cf909fd25"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMjoxMjoyNVrOF8cYuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMjoxNDozNlrOF8cclA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkyMzk2MA==", "bodyText": "Yeah, leftover from an earlier version as you said. I've updated this.", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398923960", "createdAt": "2020-03-26T22:12:25Z", "author": {"login": "vcrfxia"}, "path": "Jenkinsfile", "diffHunk": "@@ -16,20 +16,23 @@ def baseConfig = {\n \n def defaultParams = [\n     booleanParam(name: 'RELEASE_BUILD',\n-        description: 'Is this a release build.',\n+        description: 'Is this a release build. If so, GIT_REVISION must be specified, and only on-prem images will be built.',", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcxODM2Ng=="}, "originalCommit": {"oid": "d9021289f095bcad7a3986322e5a1d7cf909fd25"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkyNDUxNg==", "bodyText": "Also leftover from an earlier iteration. Removed.", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398924516", "createdAt": "2020-03-26T22:13:41Z", "author": {"login": "vcrfxia"}, "path": "Jenkinsfile", "diffHunk": "@@ -16,20 +16,23 @@ def baseConfig = {\n \n def defaultParams = [\n     booleanParam(name: 'RELEASE_BUILD',\n-        description: 'Is this a release build.',\n+        description: 'Is this a release build. If so, GIT_REVISION must be specified, and only on-prem images will be built.',\n         defaultValue: false),\n     string(name: 'GIT_REVISION',\n-        description: 'The git SHA to create the release build from.',\n+        description: 'The git SHA to build ksqlDB from.',\n+        defaultValue: ''),\n+    string(name: 'CCLOUD_GIT_REVISION',\n+        description: 'The cc-docker-ksql git SHA to build the CCloud ksqlDB image from.',", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcxOTg0Ng=="}, "originalCommit": {"oid": "d9021289f095bcad7a3986322e5a1d7cf909fd25"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkyNDc3OQ==", "bodyText": "Yup, responded on the other PR. Updated here as well.", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398924779", "createdAt": "2020-03-26T22:14:09Z", "author": {"login": "vcrfxia"}, "path": "Jenkinsfile", "diffHunk": "@@ -74,9 +77,13 @@ def job = {\n \n         // For a release build we remove the -SNAPSHOT from the version.\n         config.ksql_db_version = config.ksql_db_version.tokenize(\"-\")[0]\n+\n+        config.ksql_db_artifact_version = config.ksql_db_version\n         config.docker_tag = config.ksql_db_version\n     } else {\n-        config.docker_tag = config.ksql_db_version.tokenize(\"-\")[0] + '-' + env.BUILD_NUMBER\n+        // For non-release builds, we append the build number to the maven artifacts and docker image tag\n+        config.ksql_db_artifact_version = config.ksql_db_version + '-' + env.BUILD_NUMBER", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyNDg1NA=="}, "originalCommit": {"oid": "d9021289f095bcad7a3986322e5a1d7cf909fd25"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkyNDgzNQ==", "bodyText": "Nope, removed.", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398924835", "createdAt": "2020-03-26T22:14:17Z", "author": {"login": "vcrfxia"}, "path": "Jenkinsfile", "diffHunk": "@@ -146,6 +153,8 @@ def job = {\n         return null\n     }\n \n+    // Build on-prem ksqlDB image", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyNTI4Ng=="}, "originalCommit": {"oid": "d9021289f095bcad7a3986322e5a1d7cf909fd25"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODkyNDk0OA==", "bodyText": "Done. Also made it so the downstream is not triggered for PR jobs, which was a bug in the previous iteration of this PR.", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r398924948", "createdAt": "2020-03-26T22:14:36Z", "author": {"login": "vcrfxia"}, "path": "Jenkinsfile", "diffHunk": "@@ -319,13 +328,35 @@ def job = {\n                     sh \"docker push ${config.dockerRegistry}${dockerRepo}:master-latest\"\n \n                     if (config.release) {\n-                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n-                        sh \"docker push ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n+                        // docker_tag for release builds does not include the build number\n+                        // here we add it back so an image version with the build number always exists\n+                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-beta${env.BUILD_NUMBER}\"\n+                        sh \"docker push ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-beta${env.BUILD_NUMBER}\"\n                     }\n                 }\n             }\n         }\n     }\n+\n+    // Build CCloud ksqlDB image\n+\n+    if (config.release) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODcyODgyNA=="}, "originalCommit": {"oid": "d9021289f095bcad7a3986322e5a1d7cf909fd25"}, "originalPosition": 130}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91f7b030da78e39bdc6c51c2b2694eda81ae714a", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/91f7b030da78e39bdc6c51c2b2694eda81ae714a", "committedDate": "2020-03-26T22:29:11Z", "message": "chore: create git tag after maven build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d62ff6aea894622886c3e673f786a438c48955c", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/1d62ff6aea894622886c3e673f786a438c48955c", "committedDate": "2020-03-27T17:02:50Z", "message": "chore: make default git revision more prominent"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MzA4NzQ0", "url": "https://github.com/confluentinc/ksql/pull/4876#pullrequestreview-384308744", "createdAt": "2020-03-30T23:44:20Z", "commit": {"oid": "4d8383acf1f0ec0fd7a18e132c09ac7a4a856ef6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQyMzo0NDoyMFrOF-AO5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQyMzo1NTo1NVrOF-AclQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU1OTg0Ng==", "bodyText": "we won't ever be doing snapshot builds anymore correct? So if you just remove the -SNAPSHOT from the ksql_db_version variable in the config you don't need the tokenize call here or line 77 anymore. would you still need this new variable config.ksql_db_artifact_version?", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r400559846", "createdAt": "2020-03-30T23:44:20Z", "author": {"login": "elismaga"}, "path": "Jenkinsfile", "diffHunk": "@@ -82,7 +79,7 @@ def job = {\n         config.docker_tag = config.ksql_db_version\n     } else {\n         // For non-release builds, we append the build number to the maven artifacts and docker image tag\n-        config.ksql_db_artifact_version = config.ksql_db_version + '-' + env.BUILD_NUMBER\n+        config.ksql_db_artifact_version = config.ksql_db_version.tokenize(\"-\")[0] + '-' + env.BUILD_NUMBER", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d8383acf1f0ec0fd7a18e132c09ac7a4a856ef6"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU2MDk1Ng==", "bodyText": "I would prefer we didn't use the beta qualifier in the artifact version.", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r400560956", "createdAt": "2020-03-30T23:48:09Z", "author": {"login": "elismaga"}, "path": "Jenkinsfile", "diffHunk": "@@ -74,13 +75,17 @@ def job = {\n \n         // For a release build we remove the -SNAPSHOT from the version.\n         config.ksql_db_version = config.ksql_db_version.tokenize(\"-\")[0]\n+\n+        config.ksql_db_artifact_version = config.ksql_db_version\n         config.docker_tag = config.ksql_db_version\n     } else {\n-        config.docker_tag = config.ksql_db_version.tokenize(\"-\")[0] + '-' + env.BUILD_NUMBER\n+        // For non-release builds, we append the build number to the maven artifacts and docker image tag\n+        config.ksql_db_artifact_version = config.ksql_db_version.tokenize(\"-\")[0] + '-' + env.BUILD_NUMBER\n+        config.docker_tag = config.ksql_db_version.tokenize(\"-\")[0] + '-beta' + env.BUILD_NUMBER", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d62ff6aea894622886c3e673f786a438c48955c"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU2MzM0OQ==", "bodyText": "i would prefer we remove the \"-beta\" qualifier", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r400563349", "createdAt": "2020-03-30T23:55:55Z", "author": {"login": "elismaga"}, "path": "Jenkinsfile", "diffHunk": "@@ -319,13 +324,31 @@ def job = {\n                     sh \"docker push ${config.dockerRegistry}${dockerRepo}:master-latest\"\n \n                     if (config.release) {\n-                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n-                        sh \"docker push ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n+                        // docker_tag for release builds does not include the build number\n+                        // here we add it back so an image version with the build number always exists\n+                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-beta${env.BUILD_NUMBER}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d62ff6aea894622886c3e673f786a438c48955c"}, "originalPosition": 131}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf5927fb8906165af306cd120e40de1f3e9fd3a6", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/bf5927fb8906165af306cd120e40de1f3e9fd3a6", "committedDate": "2020-03-31T22:03:06Z", "message": "Merge branch 'ksql-db-release' into ksql-db-release-cloud-first-release-2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cfa30b892f72c9679e2e6db6cb35e2a9288caad", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/8cfa30b892f72c9679e2e6db6cb35e2a9288caad", "committedDate": "2020-03-31T22:03:33Z", "message": "chore: bump to next ksqldb release version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a40d3f9a689f5c01a4d41732450ab31558c1079", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/1a40d3f9a689f5c01a4d41732450ab31558c1079", "committedDate": "2020-03-31T22:05:36Z", "message": "chore: update maven artifact version and docker image tag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d138ec6313fd6e22f7666f756f877f39dd9daff3", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/d138ec6313fd6e22f7666f756f877f39dd9daff3", "committedDate": "2020-03-31T22:10:24Z", "message": "chore: clean up snapshot from ksqldb version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MTQxMTkz", "url": "https://github.com/confluentinc/ksql/pull/4876#pullrequestreview-385141193", "createdAt": "2020-03-31T22:11:10Z", "commit": {"oid": "1d62ff6aea894622886c3e673f786a438c48955c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMjoxMToxMFrOF-qGKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMjoxMzoxNFrOF-qJPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0NTczNg==", "bodyText": "As discussed offline, I've updated the docker tag, maven artifact version, and git tag to all use -rc instead of -beta.", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401245736", "createdAt": "2020-03-31T22:11:10Z", "author": {"login": "vcrfxia"}, "path": "Jenkinsfile", "diffHunk": "@@ -74,13 +75,17 @@ def job = {\n \n         // For a release build we remove the -SNAPSHOT from the version.\n         config.ksql_db_version = config.ksql_db_version.tokenize(\"-\")[0]\n+\n+        config.ksql_db_artifact_version = config.ksql_db_version\n         config.docker_tag = config.ksql_db_version\n     } else {\n-        config.docker_tag = config.ksql_db_version.tokenize(\"-\")[0] + '-' + env.BUILD_NUMBER\n+        // For non-release builds, we append the build number to the maven artifacts and docker image tag\n+        config.ksql_db_artifact_version = config.ksql_db_version.tokenize(\"-\")[0] + '-' + env.BUILD_NUMBER\n+        config.docker_tag = config.ksql_db_version.tokenize(\"-\")[0] + '-beta' + env.BUILD_NUMBER", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU2MDk1Ng=="}, "originalCommit": {"oid": "1d62ff6aea894622886c3e673f786a438c48955c"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0NTc2OA==", "bodyText": "As above.", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401245768", "createdAt": "2020-03-31T22:11:17Z", "author": {"login": "vcrfxia"}, "path": "Jenkinsfile", "diffHunk": "@@ -319,13 +324,31 @@ def job = {\n                     sh \"docker push ${config.dockerRegistry}${dockerRepo}:master-latest\"\n \n                     if (config.release) {\n-                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n-                        sh \"docker push ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n+                        // docker_tag for release builds does not include the build number\n+                        // here we add it back so an image version with the build number always exists\n+                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-beta${env.BUILD_NUMBER}\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU2MzM0OQ=="}, "originalCommit": {"oid": "1d62ff6aea894622886c3e673f786a438c48955c"}, "originalPosition": 131}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0NjUyNA==", "bodyText": "Great point. An added benefit of this is that the build param KSQLDB_VERSION and the config var ksql_db_version are now of the same form, removing some existing confusion around the two.\nMade the update, though I left docker_tag as a separate var from ksql_db_artifact_version even though they're always the same since I think subsequent lines in this script are easier to read that way.", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401246524", "createdAt": "2020-03-31T22:13:14Z", "author": {"login": "vcrfxia"}, "path": "Jenkinsfile", "diffHunk": "@@ -82,7 +79,7 @@ def job = {\n         config.docker_tag = config.ksql_db_version\n     } else {\n         // For non-release builds, we append the build number to the maven artifacts and docker image tag\n-        config.ksql_db_artifact_version = config.ksql_db_version + '-' + env.BUILD_NUMBER\n+        config.ksql_db_artifact_version = config.ksql_db_version.tokenize(\"-\")[0] + '-' + env.BUILD_NUMBER", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU1OTg0Ng=="}, "originalCommit": {"oid": "4d8383acf1f0ec0fd7a18e132c09ac7a4a856ef6"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94cd165cf73f1ee6211c6d3708c83cf02c068a84", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/94cd165cf73f1ee6211c6d3708c83cf02c068a84", "committedDate": "2020-03-31T23:02:43Z", "message": "chore: combine sh blocks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1OTIxODI3", "url": "https://github.com/confluentinc/ksql/pull/4876#pullrequestreview-385921827", "createdAt": "2020-04-01T20:23:34Z", "commit": {"oid": "94cd165cf73f1ee6211c6d3708c83cf02c068a84"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMDoyMzozNFrOF_RPAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMDoyNjoyMVrOF_RUsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4Njk3OQ==", "bodyText": "you can move these up to line 171 along with other call to writeFile, and then you only need one sh block.", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401886979", "createdAt": "2020-04-01T20:23:34Z", "author": {"login": "elismaga"}, "path": "Jenkinsfile", "diffHunk": "@@ -175,10 +176,9 @@ def job = {\n                                 set +x\n \n                                 LOGIN_CMD=$(aws ecr get-login --no-include-email --region us-west-2)\n-\n                                 $LOGIN_CMD\n-                            '''\n-                            sh '''\n+\n+                                set -x\n                                 echo $ARTIFACTORY_PASSWORD | docker login confluent-docker.jfrog.io -u $ARTIFACTORY_USERNAME --password-stdin\n                             '''\n                             writeFile file:'create-pip-conf-with-jfrog.sh', text:libraryResource('scripts/create-pip-conf-with-jfrog.sh')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94cd165cf73f1ee6211c6d3708c83cf02c068a84"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4ODA4Mw==", "bodyText": "seems odd to use the docker_tag here instead of the artifact version, even though they are the same thing.", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401888083", "createdAt": "2020-04-01T20:25:39Z", "author": {"login": "elismaga"}, "path": "Jenkinsfile", "diffHunk": "@@ -226,13 +216,23 @@ def job = {\n                                 sh cmd\n                             }\n                             step([$class: 'hudson.plugins.findbugs.FindBugsPublisher', pattern: '**/*bugsXml.xml'])\n+\n+                            if (!config.isPrJob) {\n+                                def git_tag = \"v${config.docker_tag}-ksqldb\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94cd165cf73f1ee6211c6d3708c83cf02c068a84"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4ODQzMw==", "bodyText": "i don't know if this is just a display problem with the diff, but it seems like you have a space between \"${config.\" and \"cp_version}\".", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401888433", "createdAt": "2020-04-01T20:26:21Z", "author": {"login": "elismaga"}, "path": "Jenkinsfile", "diffHunk": "@@ -226,13 +216,23 @@ def job = {\n                                 sh cmd\n                             }\n                             step([$class: 'hudson.plugins.findbugs.FindBugsPublisher', pattern: '**/*bugsXml.xml'])\n+\n+                            if (!config.isPrJob) {\n+                                def git_tag = \"v${config.docker_tag}-ksqldb\"\n+                                sh \"git add .\"\n+                                sh \"git commit -m \\\"build: Setting project version ${config.ksql_db_artifact_version} and parent version ${config. cp_version}.\\\"\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94cd165cf73f1ee6211c6d3708c83cf02c068a84"}, "originalPosition": 100}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86c308465545de2bbdf6a69f6087563d7fb9a193", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/86c308465545de2bbdf6a69f6087563d7fb9a193", "committedDate": "2020-04-01T23:24:40Z", "message": "fix: more feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MDE2NDY1", "url": "https://github.com/confluentinc/ksql/pull/4876#pullrequestreview-386016465", "createdAt": "2020-04-01T23:26:28Z", "commit": {"oid": "94cd165cf73f1ee6211c6d3708c83cf02c068a84"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMzoyNjoyOFrOF_WJfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMzoyOTozOVrOF_WNkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2NzQ4NA==", "bodyText": "Done.", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401967484", "createdAt": "2020-04-01T23:26:28Z", "author": {"login": "vcrfxia"}, "path": "Jenkinsfile", "diffHunk": "@@ -175,10 +176,9 @@ def job = {\n                                 set +x\n \n                                 LOGIN_CMD=$(aws ecr get-login --no-include-email --region us-west-2)\n-\n                                 $LOGIN_CMD\n-                            '''\n-                            sh '''\n+\n+                                set -x\n                                 echo $ARTIFACTORY_PASSWORD | docker login confluent-docker.jfrog.io -u $ARTIFACTORY_USERNAME --password-stdin\n                             '''\n                             writeFile file:'create-pip-conf-with-jfrog.sh', text:libraryResource('scripts/create-pip-conf-with-jfrog.sh')", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4Njk3OQ=="}, "originalCommit": {"oid": "94cd165cf73f1ee6211c6d3708c83cf02c068a84"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2NzcyMA==", "bodyText": "Don't feel strongly one way or the other. I've updated it to be the artifact version.", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401967720", "createdAt": "2020-04-01T23:27:08Z", "author": {"login": "vcrfxia"}, "path": "Jenkinsfile", "diffHunk": "@@ -226,13 +216,23 @@ def job = {\n                                 sh cmd\n                             }\n                             step([$class: 'hudson.plugins.findbugs.FindBugsPublisher', pattern: '**/*bugsXml.xml'])\n+\n+                            if (!config.isPrJob) {\n+                                def git_tag = \"v${config.docker_tag}-ksqldb\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4ODA4Mw=="}, "originalCommit": {"oid": "94cd165cf73f1ee6211c6d3708c83cf02c068a84"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2Nzc2Nw==", "bodyText": "Good catch -- fixed.", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401967767", "createdAt": "2020-04-01T23:27:19Z", "author": {"login": "vcrfxia"}, "path": "Jenkinsfile", "diffHunk": "@@ -226,13 +216,23 @@ def job = {\n                                 sh cmd\n                             }\n                             step([$class: 'hudson.plugins.findbugs.FindBugsPublisher', pattern: '**/*bugsXml.xml'])\n+\n+                            if (!config.isPrJob) {\n+                                def git_tag = \"v${config.docker_tag}-ksqldb\"\n+                                sh \"git add .\"\n+                                sh \"git commit -m \\\"build: Setting project version ${config.ksql_db_artifact_version} and parent version ${config. cp_version}.\\\"\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4ODQzMw=="}, "originalCommit": {"oid": "94cd165cf73f1ee6211c6d3708c83cf02c068a84"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2ODUyOQ==", "bodyText": "Added this so dependency images are cleaned up in addition to the built ones. The script doesn't pull dependencies in PROMOTE_TO_PRODUCTION mode and the dependency repo doesn't exist in the production registry, but I think that should be fine? As in, trying to clean up a registry + repo combination that doesn't exist shouldn't cause the script to error. Please correct me if I'm mistaken.", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401968529", "createdAt": "2020-04-01T23:29:39Z", "author": {"login": "vcrfxia"}, "path": "Jenkinsfile", "diffHunk": "@@ -319,18 +318,36 @@ def job = {\n                     sh \"docker push ${config.dockerRegistry}${dockerRepo}:master-latest\"\n \n                     if (config.release) {\n-                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n-                        sh \"docker push ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n+                        // docker_tag for release builds does not include the build number\n+                        // here we add it back so an image version with the build number always exists\n+                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-rc${env.BUILD_NUMBER}\"\n+                        sh \"docker push ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-rc${env.BUILD_NUMBER}\"\n                     }\n                 }\n             }\n         }\n     }\n+\n+    // Build CCloud ksqlDB image\n+\n+    if (!config.release && !config.isPrJob) {\n+        stage('Trigger CCloud ksqlDB Docker image job') {\n+            build job: \"confluentinc/cc-docker-ksql/master\",\n+                wait: false,\n+                parameters: [\n+                    booleanParam(name: \"NIGHTLY_BUILD\", value: true),\n+                    string(name: \"NIGHTLY_BUILD_NUMBER\", value: \"${env.BUILD_NUMBER}\"),\n+                    string(name: \"CP_BETA_VERSION\", value: \"${config.cp_version}\"),\n+                    string(name: \"CP_BETA_BUILD_NUMBER\", value: \"${config.packaging_build_number}\"),\n+                    string(name: \"KSQLDB_ARTIFACT_VERSION\", value: \"${config.ksql_db_artifact_version}\")\n+                ]\n+        }\n+    }\n }\n \n def post = {\n     withDockerServer([uri: dockerHost()]) {\n-        repos = config.dockerArtifacts + config.dockerRepos\n+        repos = config.dockerArtifacts + config.dockerRepos + config.dockerPullDeps", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86c308465545de2bbdf6a69f6087563d7fb9a193"}, "originalPosition": 194}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MDUxMDU3", "url": "https://github.com/confluentinc/ksql/pull/4876#pullrequestreview-386051057", "createdAt": "2020-04-02T01:16:35Z", "commit": {"oid": "86c308465545de2bbdf6a69f6087563d7fb9a193"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMToxNjozNVrOF_YFcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMToxNjozNVrOF_YFcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5OTIxNw==", "bodyText": "@vcrfxia Apologies, but I got that wrong and I mentioned some more detail in the other PR. You only want to delete the images you build.", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r401999217", "createdAt": "2020-04-02T01:16:35Z", "author": {"login": "elismaga"}, "path": "Jenkinsfile", "diffHunk": "@@ -319,18 +318,36 @@ def job = {\n                     sh \"docker push ${config.dockerRegistry}${dockerRepo}:master-latest\"\n \n                     if (config.release) {\n-                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n-                        sh \"docker push ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n+                        // docker_tag for release builds does not include the build number\n+                        // here we add it back so an image version with the build number always exists\n+                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-rc${env.BUILD_NUMBER}\"\n+                        sh \"docker push ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-rc${env.BUILD_NUMBER}\"\n                     }\n                 }\n             }\n         }\n     }\n+\n+    // Build CCloud ksqlDB image\n+\n+    if (!config.release && !config.isPrJob) {\n+        stage('Trigger CCloud ksqlDB Docker image job') {\n+            build job: \"confluentinc/cc-docker-ksql/master\",\n+                wait: false,\n+                parameters: [\n+                    booleanParam(name: \"NIGHTLY_BUILD\", value: true),\n+                    string(name: \"NIGHTLY_BUILD_NUMBER\", value: \"${env.BUILD_NUMBER}\"),\n+                    string(name: \"CP_BETA_VERSION\", value: \"${config.cp_version}\"),\n+                    string(name: \"CP_BETA_BUILD_NUMBER\", value: \"${config.packaging_build_number}\"),\n+                    string(name: \"KSQLDB_ARTIFACT_VERSION\", value: \"${config.ksql_db_artifact_version}\")\n+                ]\n+        }\n+    }\n }\n \n def post = {\n     withDockerServer([uri: dockerHost()]) {\n-        repos = config.dockerArtifacts + config.dockerRepos\n+        repos = config.dockerArtifacts + config.dockerRepos + config.dockerPullDeps", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2ODUyOQ=="}, "originalCommit": {"oid": "86c308465545de2bbdf6a69f6087563d7fb9a193"}, "originalPosition": 194}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "836ee4cb2e4d1b6a61a708ac865483bdd37b6a47", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/836ee4cb2e4d1b6a61a708ac865483bdd37b6a47", "committedDate": "2020-04-02T06:08:23Z", "message": "fix: undo cleanup change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NTcyMzIy", "url": "https://github.com/confluentinc/ksql/pull/4876#pullrequestreview-387572322", "createdAt": "2020-04-03T20:51:15Z", "commit": {"oid": "836ee4cb2e4d1b6a61a708ac865483bdd37b6a47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QyMDo1MToxNVrOGApGbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QyMDo1MToxNVrOGApGbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMyNjU3Mw==", "bodyText": "1 nit here: would it be better to just pass in an opaque version string here rather than the beta version and the nightly build number and having the cc-docker-ksql build reconstruct the ksqldb rc version? It would be easier to keep it consistent this way (in case we change the format of the ksqldb rc version).", "url": "https://github.com/confluentinc/ksql/pull/4876#discussion_r403326573", "createdAt": "2020-04-03T20:51:15Z", "author": {"login": "rodesai"}, "path": "Jenkinsfile", "diffHunk": "@@ -319,13 +318,31 @@ def job = {\n                     sh \"docker push ${config.dockerRegistry}${dockerRepo}:master-latest\"\n \n                     if (config.release) {\n-                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n-                        sh \"docker push ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-${env.BUILD_NUMBER}\"\n+                        // docker_tag for release builds does not include the build number\n+                        // here we add it back so an image version with the build number always exists\n+                        sh \"docker tag ${config.dockerRegistry}${dockerRepo}:${config.docker_tag} ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-rc${env.BUILD_NUMBER}\"\n+                        sh \"docker push ${config.dockerRegistry}${dockerRepo}:${config.docker_tag}-rc${env.BUILD_NUMBER}\"\n                     }\n                 }\n             }\n         }\n     }\n+\n+    // Build CCloud ksqlDB image\n+\n+    if (!config.release && !config.isPrJob) {\n+        stage('Trigger CCloud ksqlDB Docker image job') {\n+            build job: \"confluentinc/cc-docker-ksql/master\",\n+                wait: false,\n+                parameters: [\n+                    booleanParam(name: \"NIGHTLY_BUILD\", value: true),\n+                    string(name: \"NIGHTLY_BUILD_NUMBER\", value: \"${env.BUILD_NUMBER}\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "836ee4cb2e4d1b6a61a708ac865483bdd37b6a47"}, "originalPosition": 182}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ff7fc58e80e5c5b38f32be8b5f014a251b331de", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/7ff7fc58e80e5c5b38f32be8b5f014a251b331de", "committedDate": "2020-04-03T21:46:15Z", "message": "chore: remove downstream build param"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8547bee6c5d3c3597f308d2cce835252d50f209", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/c8547bee6c5d3c3597f308d2cce835252d50f209", "committedDate": "2020-04-03T22:06:40Z", "message": "Merge branch 'ksql-db-release' into ksql-db-release-cloud-first-release-2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d35fa560078e8b5bd2d395c82f3702d2132772d0", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/d35fa560078e8b5bd2d395c82f3702d2132772d0", "committedDate": "2020-04-03T22:11:58Z", "message": "chore: add back downstream build param"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4915, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}