{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExNjIzMjUz", "number": 6537, "title": "fix: '-e/-f' CLI parameters are not handling session variables correctly", "bodyText": "Description\nThere are three fixes in this PR:\n\nfix: allow '-e' parameter to use variable substitution\nfix: SHOW VARIABLES is not working with RUN SCRIPT and '-f' parameter\nfix: RUN SCRIPT and '-f' parameter do not handle PRINT/SELECT queries\n\nTesting done\nAdded unit tests and verified manually\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-10-28T15:12:06Z", "url": "https://github.com/confluentinc/ksql/pull/6537", "merged": true, "mergeCommit": {"oid": "9629c39584801bced33c6d2fe9dcc74e4945e588"}, "closed": true, "closedAt": "2020-10-28T18:11:26Z", "author": {"login": "spena"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdW-D4DgH2gAyNTExNjIzMjUzOmM4YTg5Y2Q4MjcxNzFmNWQzMmU3YmUxOGVkZmQyYWExOTE2ZTg5Mzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXBbTKgFqTUxODg2NDcwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c8a89cd827171f5d32e7be18edfd2aa1916e8939", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/c8a89cd827171f5d32e7be18edfd2aa1916e8939", "committedDate": "2020-10-28T14:01:55Z", "message": "fix: allow '-e' parameter to use variable substitution"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d243699b9916961b9dc7503856d8abeab7cc8f83", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/d243699b9916961b9dc7503856d8abeab7cc8f83", "committedDate": "2020-10-28T14:42:47Z", "message": "fix: SHOW VARIABLES is not working with RUN SCRIPT and '-f' parameter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26323d6d2f5b5f9ac079fae9fc022fa90ae79821", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/26323d6d2f5b5f9ac079fae9fc022fa90ae79821", "committedDate": "2020-10-28T15:09:29Z", "message": "fix: RUN SCRIPT and '-f' parameter do not handle PRINT/SELECT queries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcd8cf2e07ede4fdb4c173b86ad7b82eb08f984f", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/fcd8cf2e07ede4fdb4c173b86ad7b82eb08f984f", "committedDate": "2020-10-28T16:27:02Z", "message": "test: enable variable subst. in CliTest test case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4ODY0NzA5", "url": "https://github.com/confluentinc/ksql/pull/6537#pullrequestreview-518864709", "createdAt": "2020-10-28T16:37:40Z", "commit": {"oid": "fcd8cf2e07ede4fdb4c173b86ad7b82eb08f984f"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNjozNzo0MFrOHpzRZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNzo1NzowN1rOHp2zIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU5MzcwMw==", "bodyText": "nit: would help future reviews if we javadoc that this is used only for the -e usecase", "url": "https://github.com/confluentinc/ksql/pull/6537#discussion_r513593703", "createdAt": "2020-10-28T16:37:40Z", "author": {"login": "agavra"}, "path": "ksqldb-cli/src/main/java/io/confluent/ksql/cli/Cli.java", "diffHunk": "@@ -220,10 +219,9 @@ public void runScript(final String scriptFile) {\n   public void runCommand(final String command) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcd8cf2e07ede4fdb4c173b86ad7b82eb08f984f"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY1MDU3Ng==", "bodyText": "should we use Iterables.getOnlyElement here to make sure it fails if there's more than 1?", "url": "https://github.com/confluentinc/ksql/pull/6537#discussion_r513650576", "createdAt": "2020-10-28T17:55:51Z", "author": {"login": "agavra"}, "path": "ksqldb-cli/src/main/java/io/confluent/ksql/cli/Cli.java", "diffHunk": "@@ -354,22 +352,21 @@ private boolean isVariableSubstitutionEnabled() {\n     return KsqlConfig.KSQL_VARIABLE_SUBSTITUTION_ENABLE_DEFAULT;\n   }\n \n-  private List<ParsedStatement> substituteVariables(final List<ParsedStatement> statements) {\n+  private ParsedStatement substituteVariables(final ParsedStatement statement) {\n     if (isVariableSubstitutionEnabled()) {\n-      return statements.stream()\n-          .map(stmt -> VariableSubstitutor.substitute(stmt, sessionVariables))\n-          .flatMap(replacedSql -> KSQL_PARSER.parse(replacedSql).stream())\n-          .collect(Collectors.toList());\n+      final String replacedStmt = VariableSubstitutor.substitute(statement, sessionVariables);\n+      return KSQL_PARSER.parse(replacedStmt).get(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcd8cf2e07ede4fdb4c173b86ad7b82eb08f984f"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY1MTQ5MQ==", "bodyText": "this has never been released, right? should be safe to change", "url": "https://github.com/confluentinc/ksql/pull/6537#discussion_r513651491", "createdAt": "2020-10-28T17:57:07Z", "author": {"login": "agavra"}, "path": "ksqldb-rest-model/src/main/java/io/confluent/ksql/rest/entity/VariablesList.java", "diffHunk": "@@ -80,7 +80,7 @@ public String toString() {\n   @JsonCreator\n   public VariablesList(\n       @JsonProperty(\"statementText\") final String statementText,\n-      @JsonProperty(\"properties\") final List<Variable> variables\n+      @JsonProperty(\"variables\") final List<Variable> variables", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcd8cf2e07ede4fdb4c173b86ad7b82eb08f984f"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4594, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}