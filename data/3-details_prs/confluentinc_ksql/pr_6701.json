{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwNjk5MTYy", "number": 6701, "title": "fix: Makes response codes rate limited as well as prints a message when it is hit", "bodyText": "Description\nMakes response codes logging rate limited too.  Also prints a message when rate limit is hit.\nTesting done\nUnit tests and manual testing\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-12-02T02:31:52Z", "url": "https://github.com/confluentinc/ksql/pull/6701", "merged": true, "mergeCommit": {"oid": "bdec3dd647c61c69ac7fff4c5e01b085070bc5bd"}, "closed": true, "closedAt": "2020-12-07T18:05:44Z", "author": {"login": "AlanConfluent"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiFH4wAH2gAyNTMwNjk5MTYyOjdmMWVkYjE0ZDAwNDViYTljMDE4OGMyODY5OGJiY2I1MGZhMTI0ZDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdjEBALAH2gAyNTMwNjk5MTYyOmJlOTQ2NjQyNmViMjg3MDAxNjE3OTQ4ZmRiYWNlODgxNzI5MDA0NDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7f1edb14d0045ba9c0188c28698bbcb50fa124d1", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/7f1edb14d0045ba9c0188c28698bbcb50fa124d1", "committedDate": "2020-12-02T02:28:48Z", "message": "fix: Makes response codes rate limited as well as prints a message when it is hit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8673feccf6c3eac95958ed110e4bb16fbee184d3", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/8673feccf6c3eac95958ed110e4bb16fbee184d3", "committedDate": "2020-12-02T02:30:35Z", "message": "Fix test name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48282a47e0339128a381871336b39004f9a27e9f", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/48282a47e0339128a381871336b39004f9a27e9f", "committedDate": "2020-12-02T17:16:45Z", "message": "Adds some more pairs to map test case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMjk3NDk2", "url": "https://github.com/confluentinc/ksql/pull/6701#pullrequestreview-543297496", "createdAt": "2020-12-02T22:39:53Z", "commit": {"oid": "48282a47e0339128a381871336b39004f9a27e9f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMjozOTo1M1rOH9xJGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMjozOTo1M1rOH9xJGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUzMDMzMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            logging.  This is useful for limiting certain 4XX errors that you\n          \n          \n            \n            logging. This is useful for limiting certain 4XX errors that you", "url": "https://github.com/confluentinc/ksql/pull/6701#discussion_r534530330", "createdAt": "2020-12-02T22:39:53Z", "author": {"login": "JimGalasyn"}, "path": "docs/operate-and-deploy/installation/server-config/config-reference.md", "diffHunk": "@@ -612,11 +612,13 @@ property has the value `KSQL_PROCESSING_LOG`.\n Toggles whether or not the processing log should include rows in log\n messages. By default, this property has the value `false`.\n \n-### ksql.logging.server.skipped.response.codes\n+### ksql.logging.server.rate.limited.response.codes\n \n-A comma-separated list of HTTP response codes to skip during server\n-request logging. This is useful for ignoring certain 4XX errors that you\n-might not want to show up in the logs.\n+A list of `path:rate_limit` pairs, to limit the rate of server request\n+logging.  This is useful for limiting certain 4XX errors that you", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48282a47e0339128a381871336b39004f9a27e9f"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMjk3OTAy", "url": "https://github.com/confluentinc/ksql/pull/6701#pullrequestreview-543297902", "createdAt": "2020-12-02T22:40:37Z", "commit": {"oid": "48282a47e0339128a381871336b39004f9a27e9f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6836df9edc6a3a5be388f5adeaba02bc1187970c", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/6836df9edc6a3a5be388f5adeaba02bc1187970c", "committedDate": "2020-12-03T17:51:54Z", "message": "Apply suggestions from code review\n\nCo-authored-by: Jim Galasyn <jim.galasyn@confluent.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTQwMjM3", "url": "https://github.com/confluentinc/ksql/pull/6701#pullrequestreview-544540237", "createdAt": "2020-12-03T23:14:30Z", "commit": {"oid": "6836df9edc6a3a5be388f5adeaba02bc1187970c"}, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMzoxNDozMFrOH-5fzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMzoyMTo1N1rOH-5sEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcxNTc4OQ==", "bodyText": "Clarify the units of the rate limit (and also for the other config below). Appears to be number of messages per second?", "url": "https://github.com/confluentinc/ksql/pull/6701#discussion_r535715789", "createdAt": "2020-12-03T23:14:30Z", "author": {"login": "vcrfxia"}, "path": "docs/operate-and-deploy/installation/server-config/config-reference.md", "diffHunk": "@@ -612,11 +612,13 @@ property has the value `KSQL_PROCESSING_LOG`.\n Toggles whether or not the processing log should include rows in log\n messages. By default, this property has the value `false`.\n \n-### ksql.logging.server.skipped.response.codes\n+### ksql.logging.server.rate.limited.response.codes\n \n-A comma-separated list of HTTP response codes to skip during server\n-request logging. This is useful for ignoring certain 4XX errors that you\n-might not want to show up in the logs.\n+A list of `path:rate_limit` pairs, to limit the rate of server request", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6836df9edc6a3a5be388f5adeaba02bc1187970c"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcxNTc5OQ==", "bodyText": "Mention that a message will be logged (at most once every five seconds) if the threshold is hit? (And same for the other config below.)", "url": "https://github.com/confluentinc/ksql/pull/6701#discussion_r535715799", "createdAt": "2020-12-03T23:14:32Z", "author": {"login": "vcrfxia"}, "path": "docs/operate-and-deploy/installation/server-config/config-reference.md", "diffHunk": "@@ -612,11 +612,13 @@ property has the value `KSQL_PROCESSING_LOG`.\n Toggles whether or not the processing log should include rows in log\n messages. By default, this property has the value `false`.\n \n-### ksql.logging.server.skipped.response.codes\n+### ksql.logging.server.rate.limited.response.codes\n \n-A comma-separated list of HTTP response codes to skip during server\n-request logging. This is useful for ignoring certain 4XX errors that you\n-might not want to show up in the logs.\n+A list of `path:rate_limit` pairs, to limit the rate of server request\n+logging. This is useful for limiting certain 4XX errors that you\n+might not want to blow up in the logs. \n+This setting enables seeing the logs when the request rate is low \n+and dropping them when they go over the threshold.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6836df9edc6a3a5be388f5adeaba02bc1187970c"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcxNjEyNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              // Print \"You hit a rate limit\" every 5 seconds\n          \n          \n            \n              // Print \"You hit a rate limit\" at most once every 5 seconds", "url": "https://github.com/confluentinc/ksql/pull/6701#discussion_r535716124", "createdAt": "2020-12-03T23:15:20Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/LoggingRateLimiter.java", "diffHunk": "@@ -26,13 +27,23 @@\n import java.util.Map.Entry;\n import java.util.concurrent.ConcurrentHashMap;\n import java.util.function.Function;\n+import org.slf4j.Logger;\n \n class LoggingRateLimiter {\n+  // Print \"You hit a rate limit\" every 5 seconds", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6836df9edc6a3a5be388f5adeaba02bc1187970c"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcxNzEzMg==", "bodyText": "Would it be better to initialize the rate limiters up front, rather than calling computeIfAbsent on each request? I don't have a sense of how large this optimization is, feels minor but I also feel it can't hurt. Feel free to disagree.", "url": "https://github.com/confluentinc/ksql/pull/6701#discussion_r535717132", "createdAt": "2020-12-03T23:17:44Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/LoggingRateLimiter.java", "diffHunk": "@@ -45,13 +56,33 @@\n     requireNonNull(ksqlRestConfig);\n     this.rateLimiterFactory = requireNonNull(rateLimiterFactory);\n     this.rateLimitedPaths = getRateLimitedRequestPaths(ksqlRestConfig);\n+    this.rateLimitedResponseCodes = getRateLimitedResponseCodes(ksqlRestConfig);\n+    this.pathLimitHit = rateLimiterFactory.apply(LIMIT_HIT_LOG_RATE);\n+    this.responseCodeLimitHit = rateLimiterFactory.apply(LIMIT_HIT_LOG_RATE);\n   }\n \n-  public boolean shouldLog(final String path) {\n+  public boolean shouldLog(final Logger logger, final String path, final int responseCode) {\n     if (rateLimitedPaths.containsKey(path)) {\n       final double rateLimit = rateLimitedPaths.get(path);\n-      rateLimiters.computeIfAbsent(path, (k) -> rateLimiterFactory.apply(rateLimit));\n-      return rateLimiters.get(path).tryAcquire();\n+      rateLimitersByPath.computeIfAbsent(path, (k) -> rateLimiterFactory.apply(rateLimit));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6836df9edc6a3a5be388f5adeaba02bc1187970c"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcxNzI4NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                // Already validated as all ints\n          \n          \n            \n                // Already validated as having int keys and double values", "url": "https://github.com/confluentinc/ksql/pull/6701#discussion_r535717284", "createdAt": "2020-12-03T23:18:06Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/LoggingRateLimiter.java", "diffHunk": "@@ -64,4 +95,12 @@ public boolean shouldLog(final String path) {\n             entry -> Double.parseDouble(entry.getValue())));\n   }\n \n+  private static Map<Integer, Double> getRateLimitedResponseCodes(final KsqlRestConfig config) {\n+    // Already validated as all ints", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6836df9edc6a3a5be388f5adeaba02bc1187970c"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcxODkyOQ==", "bodyText": "We're currently logging for internal endpoints (used in server-to-server communication for multi-node clusters), right? Would it make sense to disable logging for those by default? (I don't feel strongly one way or the other -- you have more context than I do about when/how often those endpoints are hit.)", "url": "https://github.com/confluentinc/ksql/pull/6701#discussion_r535718929", "createdAt": "2020-12-03T23:21:57Z", "author": {"login": "vcrfxia"}, "path": "docs/operate-and-deploy/installation/server-config/config-reference.md", "diffHunk": "@@ -612,11 +612,13 @@ property has the value `KSQL_PROCESSING_LOG`.\n Toggles whether or not the processing log should include rows in log\n messages. By default, this property has the value `false`.\n \n-### ksql.logging.server.skipped.response.codes\n+### ksql.logging.server.rate.limited.response.codes\n \n-A comma-separated list of HTTP response codes to skip during server\n-request logging. This is useful for ignoring certain 4XX errors that you\n-might not want to show up in the logs.\n+A list of `path:rate_limit` pairs, to limit the rate of server request\n+logging. This is useful for limiting certain 4XX errors that you\n+might not want to blow up in the logs. \n+This setting enables seeing the logs when the request rate is low \n+and dropping them when they go over the threshold.\n \n ### ksql.logging.server.rate.limited.request.paths", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6836df9edc6a3a5be388f5adeaba02bc1187970c"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c0ec7a1831f58107c61b7d0fc886bdae67985e2", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/1c0ec7a1831f58107c61b7d0fc886bdae67985e2", "committedDate": "2020-12-05T03:25:24Z", "message": "Feedback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f93c781552915866e4b4f49556705a7629f6129a", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/f93c781552915866e4b4f49556705a7629f6129a", "committedDate": "2020-12-05T02:36:21Z", "message": "Apply suggestions from code review\n\nCo-authored-by: Victoria Xia <victoria.f.xia281@gmail.com>"}, "afterCommit": {"oid": "1c0ec7a1831f58107c61b7d0fc886bdae67985e2", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/1c0ec7a1831f58107c61b7d0fc886bdae67985e2", "committedDate": "2020-12-05T03:25:24Z", "message": "Feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be9466426eb287001617948fdbace88172900443", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/be9466426eb287001617948fdbace88172900443", "committedDate": "2020-12-05T03:45:18Z", "message": "Lint"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4563, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}