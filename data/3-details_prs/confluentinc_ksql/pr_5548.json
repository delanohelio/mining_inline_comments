{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3NjA1NjMy", "number": 5548, "title": "feat: new UDFs for set-like operations on Arrays", "bodyText": "Four new UDFs, implementing set-like operations on Array fields,inspired by the similarly-named functions in Presto (and others):\n\narray_distinct(array)\narray_except(array1, array2)\narray_intersect(array1, array2)\narray_union(array1, array2)\n\nThis is a revised and updated version of these functions and their tests, which were originally proposed long ago  in PR #1611 and blocked at that time by limited scope for handling collections of generics in the UDF invocation framework.\nReview feedback from the original PR incorporated herein, along with QTTs and historical plans.", "createdAt": "2020-06-04T05:53:20Z", "url": "https://github.com/confluentinc/ksql/pull/5548", "merged": true, "mergeCommit": {"oid": "50428c74089dddd43fb96e8299a28c507c615e4a"}, "closed": true, "closedAt": "2020-06-05T16:59:52Z", "author": {"login": "blueedgenick"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcn3dVggH2gAyNDI3NjA1NjMyOmI0NWIzMDIwODY0YWE3ODMyODM3YTg0Y2YwZTczOTcwOThlOTFkNWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoU6FiAH2gAyNDI3NjA1NjMyOjhkNzc2OWUzM2IyMTcyMDk1ZmEwNjQxMmEwMGYzZWI0NjU3MmUyY2Q=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b45b3020864aa7832837a84cf0e7397098e91d5f", "author": {"user": {"login": "blueedgenick", "name": "Nick Dearden"}}, "url": "https://github.com/confluentinc/ksql/commit/b45b3020864aa7832837a84cf0e7397098e91d5f", "committedDate": "2020-06-04T05:45:57Z", "message": "initial version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NzgzMzA3", "url": "https://github.com/confluentinc/ksql/pull/5548#pullrequestreview-424783307", "createdAt": "2020-06-04T19:58:25Z", "commit": {"oid": "b45b3020864aa7832837a84cf0e7397098e91d5f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxOTo1ODoyNVrOGfVtRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxOTo1ODoyNVrOGfVtRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxNDY5Mg==", "bodyText": "You are missing a test case where the arrays contain null values", "url": "https://github.com/confluentinc/ksql/pull/5548#discussion_r435514692", "createdAt": "2020-06-04T19:58:25Z", "author": {"login": "vpapavas"}, "path": "ksqldb-engine/src/test/java/io/confluent/ksql/function/udf/array/ArrayExceptTest.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License; you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and limitations under the\n+ * License.\n+ */\n+\n+package io.confluent.ksql.function.udf.array;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.CoreMatchers.nullValue;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.contains;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import org.junit.Test;\n+\n+public class ArrayExceptTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b45b3020864aa7832837a84cf0e7397098e91d5f"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0Nzg0NTM0", "url": "https://github.com/confluentinc/ksql/pull/5548#pullrequestreview-424784534", "createdAt": "2020-06-04T20:00:16Z", "commit": {"oid": "b45b3020864aa7832837a84cf0e7397098e91d5f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQyMDowMDoxNlrOGfVwyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQyMDowMDoxNlrOGfVwyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTUxNTU5NQ==", "bodyText": "This is a bit confusing behavior for me. Why does the test right above contain a null value in the resulting array but this test returns null?", "url": "https://github.com/confluentinc/ksql/pull/5548#discussion_r435515595", "createdAt": "2020-06-04T20:00:16Z", "author": {"login": "vpapavas"}, "path": "ksqldb-engine/src/test/java/io/confluent/ksql/function/udf/array/ArrayUnionTest.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License; you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and limitations under the\n+ * License.\n+ */\n+\n+package io.confluent.ksql.function.udf.array;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.CoreMatchers.nullValue;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.contains;\n+\n+import com.google.common.collect.ImmutableMap;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import org.junit.Test;\n+\n+public class ArrayUnionTest {\n+\n+  private final ArrayUnion udf = new ArrayUnion();\n+\n+  @Test\n+  public void shouldUnionArraysOfLikeType() {\n+    final List<String> input1 = Arrays.asList(\"foo\", \" \", \"bar\");\n+    final List<String> input2 = Arrays.asList(\"baz\");\n+    final List<String> result = udf.union(input1, input2);\n+    assertThat(result, contains(\"foo\", \" \", \"bar\", \"baz\"));\n+  }\n+\n+  @Test\n+  public void shouldReturnDistinctValues() {\n+    final List<String> input1 = Arrays.asList(\"foo\", \"foo\", \"bar\");\n+    final List<String> input2 = Arrays.asList(\"baz\", \"foo\");\n+    final List<String> result = udf.union(input1, input2);\n+    assertThat(result, contains(\"foo\", \"bar\", \"baz\"));\n+  }\n+\n+  @SuppressWarnings(\"unchecked\")\n+  @Test\n+  public void shouldIntersectArraysOfMaps() {\n+    final Map<String, Integer> map1 = ImmutableMap.of(\"foo\", 1, \"bar\", 2, \"baz\", 3);\n+    final Map<String, Integer> map2 = ImmutableMap.of(\"foo\", 10, \"baz\", 3);\n+    final Map<String, Integer> map3 = ImmutableMap.of(\"foo\", 1, \"bar\", 2, \"baz\", 3);\n+    final List<Map<String, Integer>> input1 = Arrays.asList(map1, map2);\n+    final List<Map<String, Integer>> input2 = Arrays.asList(map2, map3);\n+    final List<Map<String, Integer>> result = udf.union(input1, input2);\n+    assertThat(result, contains(map1, map2));\n+  }\n+\n+  @Test\n+  public void shouldUnionArraysContainingNulls() {\n+    final List<String> input1 = Arrays.asList(null, \"bar\");\n+    final List<String> input2 = Arrays.asList(\"foo\");\n+    final List<String> result = udf.union(input1, input2);\n+    assertThat(result, contains(null, \"bar\", \"foo\"));\n+  }\n+\n+  @Test\n+  public void shouldUnionArraysBothContainingNulls() {\n+    final List<String> input1 = Arrays.asList(null, \"foo\", \"bar\");\n+    final List<String> input2 = Arrays.asList(\"foo\", null);\n+    final List<String> result = udf.union(input1, input2);\n+    assertThat(result, contains((String) null, \"foo\", \"bar\"));\n+  }\n+\n+  @Test\n+  public void shouldReturnNullForArraysOfOnlyNulls() {\n+    final List<String> input1 = Arrays.asList(null, null);\n+    final List<String> input2 = Arrays.asList(null, null, null);\n+    final List<String> result = udf.union(input1, input2);\n+    assertThat(result, contains(nullValue()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b45b3020864aa7832837a84cf0e7397098e91d5f"}, "originalPosition": 81}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6b1fb5cda8f72841801749a6c46902b73b1e2f7", "author": {"user": {"login": "blueedgenick", "name": "Nick Dearden"}}, "url": "https://github.com/confluentinc/ksql/commit/c6b1fb5cda8f72841801749a6c46902b73b1e2f7", "committedDate": "2020-06-04T23:28:33Z", "message": "Vicky's requested change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0OTE4MjMy", "url": "https://github.com/confluentinc/ksql/pull/5548#pullrequestreview-424918232", "createdAt": "2020-06-05T00:13:36Z", "commit": {"oid": "c6b1fb5cda8f72841801749a6c46902b73b1e2f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwMDoxMzozN1rOGfcZmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwMDoxMzozN1rOGfcZmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTYyNDM0Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The output array elements will be in order of their first occurrence in the input.\n          \n          \n            \n            The output array elements are in order of their first occurrence in the input.", "url": "https://github.com/confluentinc/ksql/pull/5548#discussion_r435624347", "createdAt": "2020-06-05T00:13:37Z", "author": {"login": "JimGalasyn"}, "path": "docs/developer-guide/ksqldb-reference/scalar-functions.md", "diffHunk": "@@ -156,6 +156,55 @@ Given an array, checks if a search value is contained in the array.\n \n Accepts any `ARRAY` type. The type of the second param must match the element type of the `ARRAY`.\n \n+### ``ARRAY_DISTINCT``\n+\n+```sql\n+ARRAY_DISTINCT([1, 2, 3])\n+```\n+\n+Returns an array of all the distinct values, including NULL if present, from the input array.\n+The output array elements will be in order of their first occurrence in the input.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6b1fb5cda8f72841801749a6c46902b73b1e2f7"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0OTE4NDE1", "url": "https://github.com/confluentinc/ksql/pull/5548#pullrequestreview-424918415", "createdAt": "2020-06-05T00:14:10Z", "commit": {"oid": "c6b1fb5cda8f72841801749a6c46902b73b1e2f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwMDoxNDoxMFrOGfcaKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwMDoxNDoxMFrOGfcaKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTYyNDQ4OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Returns an array of all the distinct elements from an array except for those also present in a second array. The order of entries in the first array is preserved although any duplicates are removed. \n          \n          \n            \n            Returns an array of all the distinct elements from an array, except for those also present in a second array. The order of entries in the first array is preserved, but duplicates are removed.", "url": "https://github.com/confluentinc/ksql/pull/5548#discussion_r435624488", "createdAt": "2020-06-05T00:14:10Z", "author": {"login": "JimGalasyn"}, "path": "docs/developer-guide/ksqldb-reference/scalar-functions.md", "diffHunk": "@@ -156,6 +156,55 @@ Given an array, checks if a search value is contained in the array.\n \n Accepts any `ARRAY` type. The type of the second param must match the element type of the `ARRAY`.\n \n+### ``ARRAY_DISTINCT``\n+\n+```sql\n+ARRAY_DISTINCT([1, 2, 3])\n+```\n+\n+Returns an array of all the distinct values, including NULL if present, from the input array.\n+The output array elements will be in order of their first occurrence in the input.\n+\n+Returns NULL if the input array is NULL.\n+\n+Examples:\n+```sql \n+ARRAY_DISTINCT(ARRAY[1, 1, 2, 3, 1, 2])  => [1, 2, 3]\n+ARRAY_DISTINCT(ARRAY['apple', 'apple', NULL, 'cherry'])  => ['apple', NULL, 'cherry']\n+```\n+\n+### ``ARRAY_EXCEPT``\n+\n+```sql\n+ARRAY_EXCEPT(array1, array2)\n+```\n+\n+Returns an array of all the distinct elements from an array except for those also present in a second array. The order of entries in the first array is preserved although any duplicates are removed. ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6b1fb5cda8f72841801749a6c46902b73b1e2f7"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0OTE4NTg3", "url": "https://github.com/confluentinc/ksql/pull/5548#pullrequestreview-424918587", "createdAt": "2020-06-05T00:14:43Z", "commit": {"oid": "c6b1fb5cda8f72841801749a6c46902b73b1e2f7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0OTI5NzM4", "url": "https://github.com/confluentinc/ksql/pull/5548#pullrequestreview-424929738", "createdAt": "2020-06-05T00:53:57Z", "commit": {"oid": "c6b1fb5cda8f72841801749a6c46902b73b1e2f7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d7769e33b2172095fa06412a00f3eb46572e2cd", "author": {"user": {"login": "blueedgenick", "name": "Nick Dearden"}}, "url": "https://github.com/confluentinc/ksql/commit/8d7769e33b2172095fa06412a00f3eb46572e2cd", "committedDate": "2020-06-05T16:04:36Z", "message": "Jim's suggeseted doc tweaks"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4715, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}