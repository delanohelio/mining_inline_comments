{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5MDQ5ODI0", "number": 6253, "title": "feat: add KSQL processing log message on uncaught streams exceptions", "bodyText": "Description\nFixes #6130\nCalls the ProcessingLogger on uncaught errors by Kafka streams. The processing log uncaught handler is registered by the PersistentQueryMetadata only. Transient queries do not need to log errors to the processing log (they're at sent back to the user instead).\nThe error sent to the logger uses a new KafkaStreamsThreadErrorMessage type that creates an structured error message. It contains the error message, the thread and the exception.\nTesting done\nAdded unit tests\nksql> select * from KSQL_PROCESSING_LOG emit changes;\n+---------------------------------------------+---------------------------------------------+---------------------------------------------+---------------------------------------------+\n|LOGGER                                       |LEVEL                                        |TIME                                         |MESSAGE                                      |\n+---------------------------------------------+---------------------------------------------+---------------------------------------------+---------------------------------------------+\n|processing.CSAS_S1_0.ksql.logger.thread.excep|ERROR                                        |1600872731171                                |{TYPE=4, DESERIALIZATIONERROR=null, RECORDPRO|\n|tion.uncaught                                |                                             |                                             |CESSINGERROR=null, PRODUCTIONERROR=null, SERI|\n|                                             |                                             |                                             |ALIZATIONERROR=null, KAFKASTREAMSTHREADERROR=|\n|                                             |                                             |                                             |{ERRORMESSAGE=Unhandled exception caught in s|\n|                                             |                                             |                                             |treams thread, THREADNAME=_confluent-ksql-def|\n|                                             |                                             |                                             |ault_query_CSAS_S1_0-22278e08-e1ab-475f-84fe-|\n|                                             |                                             |                                             |c4c97815c5d4-StreamThread-4, CAUSE=[One or mo|\n|                                             |                                             |                                             |re source topics were missing during rebalanc|\n|                                             |                                             |                                             |e]}}                                         |\n\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-09-18T03:41:44Z", "url": "https://github.com/confluentinc/ksql/pull/6253", "merged": true, "mergeCommit": {"oid": "ac8875f62d1e0e068386bcd7ff44f5c7dd74b8db"}, "closed": true, "closedAt": "2020-09-23T21:12:41Z", "author": {"login": "spena"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKGJ1ZgBqjM3ODI3ODg1ODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLyI5_gFqTQ5NTAwMDI1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ee9355be7e22169f456a5f59c4b780de718bf11", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/8ee9355be7e22169f456a5f59c4b780de718bf11", "committedDate": "2020-09-18T03:36:45Z", "message": "feat: add KSQL processing log message on uncaught streams exceptions"}, "afterCommit": {"oid": "9219c6d4caa29c9e695a94bea646c2b8065248ac", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/9219c6d4caa29c9e695a94bea646c2b8065248ac", "committedDate": "2020-09-18T14:06:30Z", "message": "feat: add KSQL processing log message on uncaught streams exceptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9219c6d4caa29c9e695a94bea646c2b8065248ac", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/9219c6d4caa29c9e695a94bea646c2b8065248ac", "committedDate": "2020-09-18T14:06:30Z", "message": "feat: add KSQL processing log message on uncaught streams exceptions"}, "afterCommit": {"oid": "430c7ac4e42ccd4c8cc47c0a5c1897c51b92ad50", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/430c7ac4e42ccd4c8cc47c0a5c1897c51b92ad50", "committedDate": "2020-09-21T14:35:48Z", "message": "feat: add KSQL processing log message on uncaught streams exceptions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMTQ4OTEx", "url": "https://github.com/confluentinc/ksql/pull/6253#pullrequestreview-493148911", "createdAt": "2020-09-22T06:12:19Z", "commit": {"oid": "430c7ac4e42ccd4c8cc47c0a5c1897c51b92ad50"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNjoxMjoxOVrOHVrZgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNjoyNDowN1rOHVrovg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ5MzE4NA==", "bodyText": "let's use the name \"threadName\"", "url": "https://github.com/confluentinc/ksql/pull/6253#discussion_r492493184", "createdAt": "2020-09-22T06:12:19Z", "author": {"login": "rodesai"}, "path": "ksqldb-common/src/main/java/io/confluent/ksql/logging/processing/ProcessingLogMessageSchema.java", "diffHunk": "@@ -76,11 +76,23 @@\n       .optional()\n       .build();\n \n+  public static final String KAFKA_STREAMS_THREAD_ERROR_FIELD_MESSAGE = \"errorMessage\";\n+  public static final String KAFKA_STREAMS_THREAD_ERROR_FIELD_NAME = \"name\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "430c7ac4e42ccd4c8cc47c0a5c1897c51b92ad50"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ5NjY2Mg==", "bodyText": "We should use a different logger here. The logger is important because its name tells you a lot about the context of the error. In this case, the logger's name is ksql.logger.production.error, which tells you this is an error hit while trying to produce a record to Kafka. Other loggers' names include the node in the query topology. Eventually we'll let users adjust the log levels for some loggers at runtime, so you could see very detailed logging from just 1 UDF for example. In this case I'd name this something like ksql.logger.thread.exception.uncaught.\nTo create the logger, you can use the factory in the processingLogContext member of this class.", "url": "https://github.com/confluentinc/ksql/pull/6253#discussion_r492496662", "createdAt": "2020-09-22T06:22:47Z", "author": {"login": "rodesai"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/query/QueryExecutor.java", "diffHunk": "@@ -229,7 +229,9 @@ public PersistentQueryMetadata buildPersistentQuery(\n         ksqlConfig.getLong(KSQL_SHUTDOWN_TIMEOUT_MS_CONFIG),\n         classifier,\n         physicalPlan,\n-        ksqlConfig.getInt(KsqlConfig.KSQL_QUERY_ERROR_MAX_QUEUE_SIZE)\n+        ksqlConfig.getInt(KsqlConfig.KSQL_QUERY_ERROR_MAX_QUEUE_SIZE),\n+        (ProcessingLogger) streamsProperties.get(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "430c7ac4e42ccd4c8cc47c0a5c1897c51b92ad50"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQ5NzA4Ng==", "bodyText": "consider logging this at the fatal level, since this is a thread-killing error.", "url": "https://github.com/confluentinc/ksql/pull/6253#discussion_r492497086", "createdAt": "2020-09-22T06:24:07Z", "author": {"login": "rodesai"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/util/PersistentQueryMetadata.java", "diffHunk": "@@ -114,6 +120,15 @@ protected PersistentQueryMetadata(\n     this.materializationProvider = other.materializationProvider;\n     this.physicalPlan = other.physicalPlan;\n     this.materializationProviderBuilder = other.materializationProviderBuilder;\n+    this.processingLogger = other.processingLogger;\n+  }\n+\n+  @Override\n+  protected void uncaughtHandler(final Thread thread, final Throwable error) {\n+    super.uncaughtHandler(thread, error);\n+\n+    processingLogger.error(KafkaStreamsThreadError.of(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "430c7ac4e42ccd4c8cc47c0a5c1897c51b92ad50"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91d9b3599c26f3fb3832c2f69a97247cc9d8cf2f", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/91d9b3599c26f3fb3832c2f69a97247cc9d8cf2f", "committedDate": "2020-09-22T20:34:49Z", "message": "feat: add KSQL processing log message on uncaught streams exceptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79b471c9ab8a0b25601faa144fb1fcfc214b9de7", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/79b471c9ab8a0b25601faa144fb1fcfc214b9de7", "committedDate": "2020-09-22T20:35:37Z", "message": "fix: address PR feedback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d03ddd5a4a6e8a6efc5dd1e482225bc86fd68722", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/d03ddd5a4a6e8a6efc5dd1e482225bc86fd68722", "committedDate": "2020-09-22T16:50:23Z", "message": "fix: address PR feedback"}, "afterCommit": {"oid": "79b471c9ab8a0b25601faa144fb1fcfc214b9de7", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/79b471c9ab8a0b25601faa144fb1fcfc214b9de7", "committedDate": "2020-09-22T20:35:37Z", "message": "fix: address PR feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzODc4ODU0", "url": "https://github.com/confluentinc/ksql/pull/6253#pullrequestreview-493878854", "createdAt": "2020-09-22T22:04:15Z", "commit": {"oid": "79b471c9ab8a0b25601faa144fb1fcfc214b9de7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56a28eb3729a7b128f7e26f4d4cdb59f7f8e18ad", "author": {"user": {"login": "spena", "name": "Sergio Pe\u00f1a"}}, "url": "https://github.com/confluentinc/ksql/commit/56a28eb3729a7b128f7e26f4d4cdb59f7f8e18ad", "committedDate": "2020-09-23T14:58:14Z", "message": "fix: add queryId to logger name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0OTkzODE0", "url": "https://github.com/confluentinc/ksql/pull/6253#pullrequestreview-494993814", "createdAt": "2020-09-23T19:45:57Z", "commit": {"oid": "56a28eb3729a7b128f7e26f4d4cdb59f7f8e18ad"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MDAwMjUw", "url": "https://github.com/confluentinc/ksql/pull/6253#pullrequestreview-495000250", "createdAt": "2020-09-23T19:55:24Z", "commit": {"oid": "56a28eb3729a7b128f7e26f4d4cdb59f7f8e18ad"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4660, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}