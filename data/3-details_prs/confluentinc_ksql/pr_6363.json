{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4MDYzMTI4", "number": 6363, "title": "chore: wire in auto-register for key schemas", "bodyText": "Description\nPartial work for #6222 - this PR supports writing to schema registry (and ensuring compatibility) for formats that support schema inference. This PR also includes most of the piping we need to test it in QTT, but I haven't actually written any of those tests until we have AVRO key formats wired up.\nTesting done\nUnit testing\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-10-05T19:19:26Z", "url": "https://github.com/confluentinc/ksql/pull/6363", "merged": true, "mergeCommit": {"oid": "76a1c7c527c31bfe1162ee7872987d80d1b3fa1b"}, "closed": true, "closedAt": "2020-10-06T17:19:01Z", "author": {"login": "agavra"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPpclrAH2gAyNDk4MDYzMTI4OjRjODNmMWM5Zjg4YmYwNmFhY2FkMjYyYTlmYjlhMmJjMzMzMDAwM2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdP6b-cgH2gAyNDk4MDYzMTI4OmE0NDlmNzdmYWU0YTc3YTgzZjY5MmNhNzUwMGM2NmVlYTgwZjYwY2Q=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4c83f1c9f88bf06aacad262a9fb9a2bc3330003b", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/4c83f1c9f88bf06aacad262a9fb9a2bc3330003b", "committedDate": "2020-10-05T20:03:26Z", "message": "feat: wire in auto-register for key schemas"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "113e9460ce7e237718b04df992738597cc123fa9", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/113e9460ce7e237718b04df992738597cc123fa9", "committedDate": "2020-10-05T19:11:09Z", "message": "feat: wire in auto-register for key schemas"}, "afterCommit": {"oid": "4c83f1c9f88bf06aacad262a9fb9a2bc3330003b", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/4c83f1c9f88bf06aacad262a9fb9a2bc3330003b", "committedDate": "2020-10-05T20:03:26Z", "message": "feat: wire in auto-register for key schemas"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMDA1MDcw", "url": "https://github.com/confluentinc/ksql/pull/6363#pullrequestreview-503005070", "createdAt": "2020-10-06T14:09:11Z", "commit": {"oid": "4c83f1c9f88bf06aacad262a9fb9a2bc3330003b"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNDowOToxMVrOHdIwaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNDoxNTowMFrOHdJGfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMxNDIxOQ==", "bodyText": "Can we rename schema and format to valueSchema and valueFormat? I realize there's a little extra effort needed to maintain backwards compatibility for users of the testing tool but I think not doing the rename will be confusing down the line, especially since format is used throughout the rest of the codebase to mean both key and value format (e.g., CREATE STREAM ... WITH (FORMAT='JSON', ...); is valid now).", "url": "https://github.com/confluentinc/ksql/pull/6363#discussion_r500314219", "createdAt": "2020-10-06T14:09:11Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-functional-tests/src/main/java/io/confluent/ksql/test/model/TopicNode.java", "diffHunk": "@@ -39,20 +38,26 @@\n   private static final ObjectMapper OBJECT_MAPPER = TestJsonMapper.INSTANCE.get();\n \n   private final String name;\n+  private final JsonNode keySchema;\n   private final JsonNode schema;\n   private final int numPartitions;\n   private final int replicas;\n+  private final String keyFormat;\n   private final String format;\n \n   public TopicNode(\n       @JsonProperty(\"name\") final String name,\n+      @JsonProperty(\"keySchema\") final JsonNode keySchema,\n       @JsonProperty(\"schema\") final JsonNode schema,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c83f1c9f88bf06aacad262a9fb9a2bc3330003b"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMxNDc0MA==", "bodyText": "Rename method from buildValueSchema to buildSchema to avoid confusion? (And rename the params in the method as well)", "url": "https://github.com/confluentinc/ksql/pull/6363#discussion_r500314740", "createdAt": "2020-10-06T14:09:38Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-functional-tests/src/main/java/io/confluent/ksql/test/tools/TestCaseBuilderUtil.java", "diffHunk": "@@ -147,12 +148,27 @@ private static Topic createTopicFromStatement(\n       final CreateSource statement = (CreateSource) stmt.getStatement();\n       final CreateSourceProperties props = statement.getProperties();\n \n-      final FormatInfo valueFormatInfo = SourcePropertiesUtil.getValueFormat(props);\n-      final Format valueFormat = FormatFactory.fromName(valueFormatInfo.getFormat());\n+      final LogicalSchema logicalSchema = statement.getElements().toLogicalSchema();\n+\n+      final FormatInfo keyFormatInfo = SourcePropertiesUtil.getKeyFormat(props);\n+      final Format keyFormat = FormatFactory.fromName(keyFormatInfo.getFormat());\n+      final SerdeFeatures keySerdeFeats = buildKeyFeatures(\n+          keyFormat, logicalSchema);\n+\n+      final Optional<ParsedSchema> keySchema =\n+          keyFormat.supportsFeature(SerdeFeature.SCHEMA_INFERENCE)\n+              ? buildValueSchema(sql, logicalSchema.key(), keyFormatInfo, keyFormat, keySerdeFeats)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c83f1c9f88bf06aacad262a9fb9a2bc3330003b"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMxNTI0Ng==", "bodyText": "Rename from valueFormat to keyFormat to avoid confusion?", "url": "https://github.com/confluentinc/ksql/pull/6363#discussion_r500315246", "createdAt": "2020-10-06T14:10:07Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-functional-tests/src/main/java/io/confluent/ksql/test/tools/TestCaseBuilderUtil.java", "diffHunk": "@@ -228,6 +238,21 @@ private static Topic createTopicFromStatement(\n     }\n   }\n \n+  private static SerdeFeatures buildKeyFeatures(\n+      final Format valueFormat,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c83f1c9f88bf06aacad262a9fb9a2bc3330003b"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMxNzAxOA==", "bodyText": "This method is called is called to retrieve the key schema above (line 180) even though the method hardcodes the value suffix. Is key schema inference meant to be supported in QTT / the testing tool in this PR or not? I see in initializeTopics() below that only the value schema is checked as well.", "url": "https://github.com/confluentinc/ksql/pull/6363#discussion_r500317018", "createdAt": "2020-10-06T14:11:56Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-functional-tests/src/main/java/io/confluent/ksql/test/tools/TestExecutorUtil.java", "diffHunk": "@@ -177,28 +177,37 @@ private static Topic buildSinkTopic(\n   ) {\n     final String kafkaTopicName = sinkDataSource.getKafkaTopicName();\n \n-    final Optional<ParsedSchema> schema = getSchema(sinkDataSource, schemaRegistryClient);\n+    final Optional<ParsedSchema> keySchema = getSchema(\n+        sinkDataSource.getKsqlTopic().getKeyFormat().getFormat(),\n+        sinkDataSource.getKsqlTopic().getKafkaTopicName(),\n+        schemaRegistryClient\n+    );\n+    final Optional<ParsedSchema> valueSchema = getSchema(\n+        sinkDataSource.getKsqlTopic().getValueFormat().getFormat(),\n+        sinkDataSource.getKsqlTopic().getKafkaTopicName(),\n+        schemaRegistryClient\n+    );\n \n-    final Topic sinkTopic = new Topic(kafkaTopicName, schema);\n+    final Topic sinkTopic = new Topic(kafkaTopicName, keySchema, valueSchema);\n \n     stubKafkaService.ensureTopic(sinkTopic);\n     return sinkTopic;\n   }\n \n   private static Optional<ParsedSchema> getSchema(\n-      final DataSource dataSource,\n+      final String format,\n+      final String topicName,\n       final SchemaRegistryClient schemaRegistryClient\n   ) {\n     final Format valueFormat = FormatFactory\n-        .fromName(dataSource.getKsqlTopic().getValueFormat().getFormat());\n+        .fromName(format);\n \n     if (!valueFormat.supportsFeature(SerdeFeature.SCHEMA_INFERENCE)) {\n       return Optional.empty();\n     }\n \n     try {\n-      final String subject =\n-          dataSource.getKafkaTopicName() + KsqlConstants.SCHEMA_REGISTRY_VALUE_SUFFIX;\n+      final String subject = topicName + KsqlConstants.SCHEMA_REGISTRY_VALUE_SUFFIX;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c83f1c9f88bf06aacad262a9fb9a2bc3330003b"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMxOTg3MA==", "bodyText": "nit: not your code but can we add a quick unit test to ensure that withoutPseudoAndKeyColsInValue() here isn't lost? There doesn't appear to be one right now.", "url": "https://github.com/confluentinc/ksql/pull/6363#discussion_r500319870", "createdAt": "2020-10-06T14:15:00Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/schema/ksql/inference/SchemaRegisterInjector.java", "diffHunk": "@@ -76,27 +78,42 @@ private void registerForCreateSource(final ConfiguredStatement<? extends CreateS\n     // since this injector is chained after the TopicCreateInjector,\n     // we can assume that the kafka topic is always present in the\n     // statement properties\n+    final CreateSource statement = cs.getStatement();\n+    final LogicalSchema schema = statement.getElements().toLogicalSchema();\n \n-    final LogicalSchema schema = cs.getStatement().getElements().toLogicalSchema();\n-\n-    final FormatInfo valueFormat = SourcePropertiesUtil\n-        .getValueFormat(cs.getStatement().getProperties());\n+    final FormatInfo keyFormat = SourcePropertiesUtil.getKeyFormat(statement.getProperties());\n+    final SerdeFeatures keyFeatures = SerdeFeaturesFactory.buildKeyFeatures(\n+        schema,\n+        FormatFactory.of(keyFormat)\n+    );\n+    registerSchema(\n+        schema.key(),\n+        statement.getProperties().getKafkaTopic(),\n+        keyFormat,\n+        keyFeatures,\n+        cs.getSessionConfig().getConfig(false),\n+        cs.getStatementText(),\n+        false,\n+        KsqlConstants.SCHEMA_REGISTRY_KEY_SUFFIX\n+    );\n \n+    final FormatInfo valueFormat = SourcePropertiesUtil.getValueFormat(statement.getProperties());\n     final SerdeFeatures valFeatures = SerdeFeaturesFactory.buildValueFeatures(\n         schema,\n         FormatFactory.of(valueFormat),\n-        cs.getStatement().getProperties().getValueSerdeFeatures(),\n+        statement.getProperties().getValueSerdeFeatures(),\n         cs.getSessionConfig().getConfig(false)\n     );\n \n     registerSchema(\n-        schema,\n-        cs.getStatement().getProperties().getKafkaTopic(),\n+        schema.withoutPseudoAndKeyColsInValue().value(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c83f1c9f88bf06aacad262a9fb9a2bc3330003b"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMDUzMDE5", "url": "https://github.com/confluentinc/ksql/pull/6363#pullrequestreview-503053019", "createdAt": "2020-10-06T14:52:17Z", "commit": {"oid": "4c83f1c9f88bf06aacad262a9fb9a2bc3330003b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNDo1MjoxN1rOHdLUIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNDo1MjoxN1rOHdLUIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM1NjEzMA==", "bodyText": "minor: consider adding a registerSchemas method, which takes the logical schema and both formats. Internally, it justs called registerSchema for key then value.\nThis would make the code easier to read and remove a bit of duplication.", "url": "https://github.com/confluentinc/ksql/pull/6363#discussion_r500356130", "createdAt": "2020-10-06T14:52:17Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/schema/ksql/inference/SchemaRegisterInjector.java", "diffHunk": "@@ -115,24 +132,36 @@ private void registerForCreateAs(final ConfiguredStatement<? extends CreateAsSel\n         ));\n \n     registerSchema(\n-        queryMetadata.getLogicalSchema(),\n+        queryMetadata.getLogicalSchema().key(),\n+        queryMetadata.getResultTopic().getKafkaTopicName(),\n+        queryMetadata.getResultTopic().getKeyFormat().getFormatInfo(),\n+        queryMetadata.getPhysicalSchema().keySchema().features(),\n+        cas.getSessionConfig().getConfig(false),\n+        cas.getStatementText(),\n+        true,\n+        KsqlConstants.SCHEMA_REGISTRY_KEY_SUFFIX\n+    );\n+    registerSchema(\n+        queryMetadata.getLogicalSchema().withoutPseudoAndKeyColsInValue().value(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c83f1c9f88bf06aacad262a9fb9a2bc3330003b"}, "originalPosition": 82}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a449f77fae4a77a83f692ca7500c66eea80f60cd", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/a449f77fae4a77a83f692ca7500c66eea80f60cd", "committedDate": "2020-10-06T15:51:09Z", "message": "chore: address PR feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4621, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}