{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyNjc1Nzc0", "number": 4494, "title": "fix: Fixes the single host lag reporting case", "bodyText": "Description\nCurrently, when a single host exists, lag doesn't get reported.  This ensures lag always gets reported.  Also changes the default to not filter if there is no lag data.\nTesting done\nDescribe the testing strategy. Unit and integration tests are expected for any behavior changes.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-02-08T03:44:04Z", "url": "https://github.com/confluentinc/ksql/pull/4494", "merged": true, "mergeCommit": {"oid": "6b8bc2ae946db0ce445b0bce4c02c8c627d5434c"}, "closed": true, "closedAt": "2020-02-10T22:24:04Z", "author": {"login": "AlanConfluent"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcCLtVMAFqTM1NTUyNzkwMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDDnZSAH2gAyMzcyNjc1Nzc0OmQ1MjMzMGRkNjkzZDgyZWJkZTUyZDBmZjVkMmIzNDQzNjg4YjdjN2M=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTI3OTAz", "url": "https://github.com/confluentinc/ksql/pull/4494#pullrequestreview-355527903", "createdAt": "2020-02-08T03:52:23Z", "commit": {"oid": "30c2acecc56740abd09be697bc0a7f201fe28bc7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwMzo1MjoyNFrOFnPAlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwMzo1MjoyNFrOFnPAlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY4NDY5Mg==", "bodyText": "is this related to the single host lag reporting case?", "url": "https://github.com/confluentinc/ksql/pull/4494#discussion_r376684692", "createdAt": "2020-02-08T03:52:24Z", "author": {"login": "vinothchandar"}, "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/HeartbeatAgent.java", "diffHunk": "@@ -223,6 +223,9 @@ private void processHeartbeats(final long windowStart, final long windowEnd) {\n           }\n           return status;\n         });\n+        for (HostStatusListener listener : hostStatusListeners) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30c2acecc56740abd09be697bc0a7f201fe28bc7"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTI4MDk0", "url": "https://github.com/confluentinc/ksql/pull/4494#pullrequestreview-355528094", "createdAt": "2020-02-08T03:57:24Z", "commit": {"oid": "30c2acecc56740abd09be697bc0a7f201fe28bc7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwMzo1NzoyNFrOFnPBog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwMzo1NzoyNFrOFnPBog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY4NDk2Mg==", "bodyText": "I think we should do this and then prime the cache on the remote host on-demand as we discussed..  This will ensure correct filtering in all cases..\nChoosing to ignore nodes if we don't have lag , would mean that, on every bounce of the ksql server, queries will fail for few seconds until lags are propogated across the cluster again (bounced server will begin with an empty map).. Thus a rolling bounce of the cluster will see large error spikes.. This is a bad move IMO", "url": "https://github.com/confluentinc/ksql/pull/4494#discussion_r376684962", "createdAt": "2020-02-08T03:57:24Z", "author": {"login": "vinothchandar"}, "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/MaximumLagFilter.java", "diffHunk": "@@ -66,8 +66,8 @@ public boolean filter(final KsqlHostInfo hostInfo) {\n           final long offsetLag = Math.max(endOffset - hostLag.getCurrentOffsetPosition(), 0);\n           return offsetLag <= allowedOffsetLag;\n         })\n-        // If we don't have lag info, we'll be conservative and not include the host\n-        .orElse(false);\n+        // If we don't have lag info, we'll be conservative and include the host", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30c2acecc56740abd09be697bc0a7f201fe28bc7"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTI4NDU3", "url": "https://github.com/confluentinc/ksql/pull/4494#pullrequestreview-355528457", "createdAt": "2020-02-08T04:05:40Z", "commit": {"oid": "30c2acecc56740abd09be697bc0a7f201fe28bc7"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MjE5MjU2", "url": "https://github.com/confluentinc/ksql/pull/4494#pullrequestreview-356219256", "createdAt": "2020-02-10T19:55:16Z", "commit": {"oid": "aad6b645fdb593d512ab0ed6ac9aa3c02f01d8f3"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxOTo1NToxNlrOFnzgbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxOTo1NToxNlrOFnzgbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI4MjY2OA==", "bodyText": "any exception handling needed here to ensure we don't stop notifying if one of  the callbacks throw an error?", "url": "https://github.com/confluentinc/ksql/pull/4494#discussion_r377282668", "createdAt": "2020-02-10T19:55:16Z", "author": {"login": "vinothchandar"}, "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/HeartbeatAgent.java", "diffHunk": "@@ -223,6 +223,9 @@ private void processHeartbeats(final long windowStart, final long windowEnd) {\n           }\n           return status;\n         });\n+        for (HostStatusListener listener : hostStatusListeners) {\n+          listener.onHostStatusUpdated(getHostsStatus());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aad6b645fdb593d512ab0ed6ac9aa3c02f01d8f3"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f90bd2da41d5d5afb3b9de83c5ed625f5d2846fa", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/f90bd2da41d5d5afb3b9de83c5ed625f5d2846fa", "committedDate": "2020-02-10T20:30:35Z", "message": "fix: Fixes the single host lag reporting case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba8c6c9dad5a17c50ab987d633d3a52d383072e7", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/ba8c6c9dad5a17c50ab987d633d3a52d383072e7", "committedDate": "2020-02-10T20:30:35Z", "message": "Adds test cases for callback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c126ea14fa28dd74221b3562bf0e0d955dc5ffe", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/9c126ea14fa28dd74221b3562bf0e0d955dc5ffe", "committedDate": "2020-02-10T20:30:35Z", "message": "Catches listener errors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aad6b645fdb593d512ab0ed6ac9aa3c02f01d8f3", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/aad6b645fdb593d512ab0ed6ac9aa3c02f01d8f3", "committedDate": "2020-02-10T18:34:28Z", "message": "Adds test cases for callback"}, "afterCommit": {"oid": "9c126ea14fa28dd74221b3562bf0e0d955dc5ffe", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/9c126ea14fa28dd74221b3562bf0e0d955dc5ffe", "committedDate": "2020-02-10T20:30:35Z", "message": "Catches listener errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d52330dd693d82ebde52d0ff5d2b3443688b7c7c", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/d52330dd693d82ebde52d0ff5d2b3443688b7c7c", "committedDate": "2020-02-10T21:00:36Z", "message": "Fix test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4987, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}