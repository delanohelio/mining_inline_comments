{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwOTg0NzA3", "number": 4658, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNzo1NjowOVrODjjdVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoyNjoyN1rODjkDZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NjA3NzAxOnYy", "diffSide": "RIGHT", "path": "ksql-engine/src/test/java/io/confluent/ksql/util/QueryMetadataTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNzo1NjowOVrOFvbTWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoxMDo1OVrOFvbxcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3NDcxNA==", "bodyText": "How about?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                verifyNoMoreInteractions(closeCallback);\n          \n          \n            \n                verify(kafkaStreams).close(Duration.ofMillis(closeTimeout));\n          \n          \n            \n                verify(closeCallback, never()).accept(any());\n          \n      \n    \n    \n  \n\nOr add another test that checks ks.close is called on stop.", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385274714", "createdAt": "2020-02-27T17:56:09Z", "author": {"login": "big-andy-coates"}, "path": "ksql-engine/src/test/java/io/confluent/ksql/util/QueryMetadataTest.java", "diffHunk": "@@ -136,6 +137,15 @@ public void shouldCloseKStreamsAppOnCloseThenCloseCallback() {\n     inOrder.verify(closeCallback).accept(query);\n   }\n \n+  @Test\n+  public void shouldNotCallCloseCallbackOnStop() {\n+    // When:\n+    query.stop();\n+\n+    // Then:\n+    verifyNoMoreInteractions(closeCallback);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c7a222a12fcdc10a14fae39e5c7a722a2ab7513"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI4MjQxOQ==", "bodyText": "Added an additional test", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385282419", "createdAt": "2020-02-27T18:10:59Z", "author": {"login": "agavra"}, "path": "ksql-engine/src/test/java/io/confluent/ksql/util/QueryMetadataTest.java", "diffHunk": "@@ -136,6 +137,15 @@ public void shouldCloseKStreamsAppOnCloseThenCloseCallback() {\n     inOrder.verify(closeCallback).accept(query);\n   }\n \n+  @Test\n+  public void shouldNotCallCloseCallbackOnStop() {\n+    // When:\n+    query.stop();\n+\n+    // Then:\n+    verifyNoMoreInteractions(closeCallback);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3NDcxNA=="}, "originalCommit": {"oid": "7c7a222a12fcdc10a14fae39e5c7a722a2ab7513"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NjA4MjQ4OnYy", "diffSide": "RIGHT", "path": "ksql-engine/src/main/java/io/confluent/ksql/util/QueryMetadata.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNzo1Nzo0MVrOFvbW1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxOTowMTowNFrOFvdaXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3NTYwNw==", "bodyText": "I'd be tempted to make this abstract and move this impl to PersistentQuery.\nNo biggie, just feels cleaner to me.", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385275607", "createdAt": "2020-02-27T17:57:41Z", "author": {"login": "big-andy-coates"}, "path": "ksql-engine/src/main/java/io/confluent/ksql/util/QueryMetadata.java", "diffHunk": "@@ -169,14 +169,41 @@ public boolean hasEverBeenStarted() {\n     return everStarted;\n   }\n \n-  public void close() {\n+\n+  /**\n+   * Stops the query without cleaning up the external resources\n+   * so that it can be resumed when we call {@link #start()}.\n+   *\n+   * <p>NOTE: {@link TransientQueryMetadata} overrides this method\n+   * since any time a transient query is stopped the external resources\n+   * should be cleaned up.</p>\n+   *\n+   * @see #close()\n+   */\n+  public void stop() {\n+    close(false);\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c7a222a12fcdc10a14fae39e5c7a722a2ab7513"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI4MTY3OQ==", "bodyText": "I wanted to do that, but there's a place where QueryMetadata is actually being instantiated directly. Not sure if that's a bug, but I didn't want to deal with it now.", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385281679", "createdAt": "2020-02-27T18:09:36Z", "author": {"login": "agavra"}, "path": "ksql-engine/src/main/java/io/confluent/ksql/util/QueryMetadata.java", "diffHunk": "@@ -169,14 +169,41 @@ public boolean hasEverBeenStarted() {\n     return everStarted;\n   }\n \n-  public void close() {\n+\n+  /**\n+   * Stops the query without cleaning up the external resources\n+   * so that it can be resumed when we call {@link #start()}.\n+   *\n+   * <p>NOTE: {@link TransientQueryMetadata} overrides this method\n+   * since any time a transient query is stopped the external resources\n+   * should be cleaned up.</p>\n+   *\n+   * @see #close()\n+   */\n+  public void stop() {\n+    close(false);\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3NTYwNw=="}, "originalCommit": {"oid": "7c7a222a12fcdc10a14fae39e5c7a722a2ab7513"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5NDAyMQ==", "bodyText": "Really? Sounds like a bug!", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385294021", "createdAt": "2020-02-27T18:32:54Z", "author": {"login": "big-andy-coates"}, "path": "ksql-engine/src/main/java/io/confluent/ksql/util/QueryMetadata.java", "diffHunk": "@@ -169,14 +169,41 @@ public boolean hasEverBeenStarted() {\n     return everStarted;\n   }\n \n-  public void close() {\n+\n+  /**\n+   * Stops the query without cleaning up the external resources\n+   * so that it can be resumed when we call {@link #start()}.\n+   *\n+   * <p>NOTE: {@link TransientQueryMetadata} overrides this method\n+   * since any time a transient query is stopped the external resources\n+   * should be cleaned up.</p>\n+   *\n+   * @see #close()\n+   */\n+  public void stop() {\n+    close(false);\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3NTYwNw=="}, "originalCommit": {"oid": "7c7a222a12fcdc10a14fae39e5c7a722a2ab7513"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMwNzIzNQ==", "bodyText": "Looks like this is used from the new API code: for transient queries. So this should default to cleaning up internal topics.", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385307235", "createdAt": "2020-02-27T18:57:23Z", "author": {"login": "big-andy-coates"}, "path": "ksql-engine/src/main/java/io/confluent/ksql/util/QueryMetadata.java", "diffHunk": "@@ -169,14 +169,41 @@ public boolean hasEverBeenStarted() {\n     return everStarted;\n   }\n \n-  public void close() {\n+\n+  /**\n+   * Stops the query without cleaning up the external resources\n+   * so that it can be resumed when we call {@link #start()}.\n+   *\n+   * <p>NOTE: {@link TransientQueryMetadata} overrides this method\n+   * since any time a transient query is stopped the external resources\n+   * should be cleaned up.</p>\n+   *\n+   * @see #close()\n+   */\n+  public void stop() {\n+    close(false);\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3NTYwNw=="}, "originalCommit": {"oid": "7c7a222a12fcdc10a14fae39e5c7a722a2ab7513"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMwOTI3OQ==", "bodyText": "so we should switch this to close(true) as we want transient queries to delete internal state.\nThis will also mean we need to remove the overloaded version from TransientQueryMetadata and add the following overload to PersistentQueryMetadata\n@Override\npublic void stop() {\n    close(false);\n  }", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385309279", "createdAt": "2020-02-27T19:01:04Z", "author": {"login": "big-andy-coates"}, "path": "ksql-engine/src/main/java/io/confluent/ksql/util/QueryMetadata.java", "diffHunk": "@@ -169,14 +169,41 @@ public boolean hasEverBeenStarted() {\n     return everStarted;\n   }\n \n-  public void close() {\n+\n+  /**\n+   * Stops the query without cleaning up the external resources\n+   * so that it can be resumed when we call {@link #start()}.\n+   *\n+   * <p>NOTE: {@link TransientQueryMetadata} overrides this method\n+   * since any time a transient query is stopped the external resources\n+   * should be cleaned up.</p>\n+   *\n+   * @see #close()\n+   */\n+  public void stop() {\n+    close(false);\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3NTYwNw=="}, "originalCommit": {"oid": "7c7a222a12fcdc10a14fae39e5c7a722a2ab7513"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NjE2NTY3OnYy", "diffSide": "RIGHT", "path": "ksql-engine/src/test/java/io/confluent/ksql/engine/KsqlEngineTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoyMzo0N1rOFvcLoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoyMzo0N1rOFvcLoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI4OTEyMQ==", "bodyText": "nit:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                verify(topicClient, times(0)).deleteInternalTopics(any());\n          \n          \n            \n                verify(topicClient, never()).deleteInternalTopics(any());", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385289121", "createdAt": "2020-02-27T18:23:47Z", "author": {"login": "big-andy-coates"}, "path": "ksql-engine/src/test/java/io/confluent/ksql/engine/KsqlEngineTest.java", "diffHunk": "@@ -676,6 +677,64 @@ public void shouldCleanUpInternalTopicsOnClose() {\n     verify(topicClient).deleteInternalTopics(query.getQueryApplicationId());\n   }\n \n+  @Test\n+  public void shouldCleanUpInternalTopicsOnEngineCloseForTransientQueries() {\n+    // Given:\n+    final QueryMetadata query = KsqlEngineTestUtil.executeQuery(\n+        serviceContext,\n+        ksqlEngine,\n+        \"select * from test1 EMIT CHANGES;\",\n+        KSQL_CONFIG, Collections.emptyMap()\n+    );\n+\n+    query.start();\n+\n+    // When:\n+    ksqlEngine.close();\n+\n+    // Then:\n+    verify(topicClient).deleteInternalTopics(query.getQueryApplicationId());\n+    verifyNoMoreInteractions(topicClient);\n+  }\n+\n+  @Test\n+  public void shouldNotCleanUpInternalTopicsOnEngineCloseForPersistentQueries() {\n+    // Given:\n+    final List<QueryMetadata> query = KsqlEngineTestUtil.execute(\n+        serviceContext,\n+        ksqlEngine,\n+        \"create stream persistent as select * from test1 EMIT CHANGES;\",\n+        KSQL_CONFIG, Collections.emptyMap()\n+    );\n+\n+    query.get(0).start();\n+\n+    // When:\n+    ksqlEngine.close();\n+\n+    // Then (there are no transient queries, so no internal topics should be deleted):\n+    verify(topicClient, times(0)).deleteInternalTopics(any());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d237f85079583fd3c1f9af72ea2f0cab02240312"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NjE3MTA2OnYy", "diffSide": "RIGHT", "path": "ksql-engine/src/test/java/io/confluent/ksql/engine/KsqlEngineTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoyNToyOFrOFvcPIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoyNToyOFrOFvcPIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5MDAxNg==", "bodyText": "nit: not necessary.", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385290016", "createdAt": "2020-02-27T18:25:28Z", "author": {"login": "big-andy-coates"}, "path": "ksql-engine/src/test/java/io/confluent/ksql/engine/KsqlEngineTest.java", "diffHunk": "@@ -676,6 +677,64 @@ public void shouldCleanUpInternalTopicsOnClose() {\n     verify(topicClient).deleteInternalTopics(query.getQueryApplicationId());\n   }\n \n+  @Test\n+  public void shouldCleanUpInternalTopicsOnEngineCloseForTransientQueries() {\n+    // Given:\n+    final QueryMetadata query = KsqlEngineTestUtil.executeQuery(\n+        serviceContext,\n+        ksqlEngine,\n+        \"select * from test1 EMIT CHANGES;\",\n+        KSQL_CONFIG, Collections.emptyMap()\n+    );\n+\n+    query.start();\n+\n+    // When:\n+    ksqlEngine.close();\n+\n+    // Then:\n+    verify(topicClient).deleteInternalTopics(query.getQueryApplicationId());\n+    verifyNoMoreInteractions(topicClient);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d237f85079583fd3c1f9af72ea2f0cab02240312"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NjE3MzA4OnYy", "diffSide": "RIGHT", "path": "ksql-engine/src/test/java/io/confluent/ksql/util/QueryMetadataTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoyNjowNVrOFvcQcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoyNjowNVrOFvcQcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5MDM1Mg==", "bodyText": "nit:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                verify(kafkaStreams, times(0)).cleanUp();\n          \n          \n            \n                verify(kafkaStreams, never()).cleanUp();", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385290352", "createdAt": "2020-02-27T18:26:05Z", "author": {"login": "big-andy-coates"}, "path": "ksql-engine/src/test/java/io/confluent/ksql/util/QueryMetadataTest.java", "diffHunk": "@@ -147,6 +167,15 @@ public void shouldCleanUpKStreamsAppAfterCloseOnClose() {\n     inOrder.verify(kafkaStreams).cleanUp();\n   }\n \n+  @Test\n+  public void shouldNotCleanUpKStreamsAppOnStop() {\n+    // When:\n+    query.stop();\n+\n+    // Then:\n+    verify(kafkaStreams, times(0)).cleanUp();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d237f85079583fd3c1f9af72ea2f0cab02240312"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NjE3NDQ0OnYy", "diffSide": "RIGHT", "path": "ksql-engine/src/test/java/io/confluent/ksql/util/TransientQueryMetadataTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoyNjoyN1rOFvcROQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoyNjoyN1rOFvcROQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5MDU1Mw==", "bodyText": "If the order is important, then I'd test the order too...", "url": "https://github.com/confluentinc/ksql/pull/4658#discussion_r385290553", "createdAt": "2020-02-27T18:26:27Z", "author": {"login": "big-andy-coates"}, "path": "ksql-engine/src/test/java/io/confluent/ksql/util/TransientQueryMetadataTest.java", "diffHunk": "@@ -87,4 +88,22 @@ public void shouldCloseQueueBeforeTopologyToAvoidDeadLock() {\n     inOrder.verify(rowQueue).close();\n     inOrder.verify(kafkaStreams).close(any());\n   }\n+\n+  @Test\n+  public void shouldCleanupOnStop() {\n+    // When:\n+    query.stop();\n+\n+    // Then:\n+    verify(kafkaStreams).close(any());\n+  }\n+\n+  @Test\n+  public void shouldCallCallbackOnStop() {\n+    // When:\n+    query.stop();\n+\n+    // Then:\n+    verify(closeCallback).accept(query);\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d237f85079583fd3c1f9af72ea2f0cab02240312"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2019, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}