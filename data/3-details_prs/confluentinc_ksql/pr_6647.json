{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0MjgyNDgz", "number": 6647, "title": "fix: propagate null-valued records in repartition", "bodyText": "Description\nFixes #6646\nThe current mapper used in repartitions builds the new key by evaluating the generated expression on the value. If the value is null, the mapper returns an empty key rather than the original key. More intuitive behavior is to detect when the partition by expression depends only on key column(s) and evaluate the new key on the key columns in these cases, allowing null values to be propagated. This is needed to enable the propagation of tombstones in #6635\nTesting done\nUnit + QTT.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-11-19T22:46:59Z", "url": "https://github.com/confluentinc/ksql/pull/6647", "merged": true, "mergeCommit": {"oid": "d3007f255567d1457dc6755bc75f174be1ca3538"}, "closed": true, "closedAt": "2020-11-20T19:23:41Z", "author": {"login": "vcrfxia"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeKpz8gH2gAyNTI0MjgyNDgzOjIzN2QzNTE5ZmVhMjVhMjZkOGMwZTljYTMxNzk0NDVhOGNjMzdmODc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdebbTEgH2gAyNTI0MjgyNDgzOmJkMGUzMzg5ZTEyMDJiYTgwNDc0NjcxNDI0YzljZTgwYzkzYjI2N2Q=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "237d3519fea25a26d8c0e9ca3179445a8cc37f87", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/237d3519fea25a26d8c0e9ca3179445a8cc37f87", "committedDate": "2020-11-19T22:39:41Z", "message": "fix: propagate null-valued records in repartition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9c0de09da22cd6552c140b3b7b5056893a9c3dc", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/a9c0de09da22cd6552c140b3b7b5056893a9c3dc", "committedDate": "2020-11-19T22:42:01Z", "message": "chore: historic plans"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad0f0311b3e3d5844f570179486bfacda4badc76", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/ad0f0311b3e3d5844f570179486bfacda4badc76", "committedDate": "2020-11-19T22:48:09Z", "message": "chore: style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0OTIxODAx", "url": "https://github.com/confluentinc/ksql/pull/6647#pullrequestreview-534921801", "createdAt": "2020-11-19T22:49:53Z", "commit": {"oid": "a9c0de09da22cd6552c140b3b7b5056893a9c3dc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMjo0OTo1M1rOH21Lmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMjo0OTo1M1rOH21Lmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1NjQ3NQ==", "bodyText": "Is there a reason this was previously List<?> rather than List<Object>? I don't fully understand the meaning of this change, but it lets us avoid an unchecked cast downstream.", "url": "https://github.com/confluentinc/ksql/pull/6647#discussion_r527256475", "createdAt": "2020-11-19T22:49:53Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/util/StructKeyUtil.java", "diffHunk": "@@ -58,7 +58,7 @@ public static KeyBuilder keyBuilder(final ColumnName name, final SqlType type) {\n   }\n \n   @SuppressWarnings(\"unchecked\")\n-  public static List<?> asList(final Object key) {\n+  public static List<Object> asList(final Object key) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9c0de09da22cd6552c140b3b7b5056893a9c3dc"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0OTIyMTk4", "url": "https://github.com/confluentinc/ksql/pull/6647#pullrequestreview-534922198", "createdAt": "2020-11-19T22:50:39Z", "commit": {"oid": "a9c0de09da22cd6552c140b3b7b5056893a9c3dc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMjo1MDo0MFrOH21NGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMjo1MDo0MFrOH21NGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1Njg1OA==", "bodyText": "I don't love the package this was moved to but couldn't think of anywhere better. Suggestions welcome!", "url": "https://github.com/confluentinc/ksql/pull/6647#discussion_r527256858", "createdAt": "2020-11-19T22:50:40Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/util/ColumnExtractor.java", "diffHunk": "@@ -13,7 +13,7 @@\n  * specific language governing permissions and limitations under the License.\n  */\n \n-package io.confluent.ksql.analyzer;\n+package io.confluent.ksql.execution.util;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9c0de09da22cd6552c140b3b7b5056893a9c3dc"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0OTU0ODM3", "url": "https://github.com/confluentinc/ksql/pull/6647#pullrequestreview-534954837", "createdAt": "2020-11-19T23:57:14Z", "commit": {"oid": "ad0f0311b3e3d5844f570179486bfacda4badc76"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMzo1NzoxNVrOH22w-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwMToxNDoxM1rOH25v-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI4MjQyNQ==", "bodyText": "\ud83e\udd37 it's not a public API so it doesn't really matter to me", "url": "https://github.com/confluentinc/ksql/pull/6647#discussion_r527282425", "createdAt": "2020-11-19T23:57:15Z", "author": {"login": "agavra"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/util/ColumnExtractor.java", "diffHunk": "@@ -13,7 +13,7 @@\n  * specific language governing permissions and limitations under the License.\n  */\n \n-package io.confluent.ksql.analyzer;\n+package io.confluent.ksql.execution.util;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1Njg1OA=="}, "originalCommit": {"oid": "a9c0de09da22cd6552c140b3b7b5056893a9c3dc"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI4MzA5Mw==", "bodyText": "https://stackoverflow.com/a/35273095/2258040 - for our use case, I don't think it really makes sense to return List<?>", "url": "https://github.com/confluentinc/ksql/pull/6647#discussion_r527283093", "createdAt": "2020-11-19T23:59:26Z", "author": {"login": "agavra"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/util/StructKeyUtil.java", "diffHunk": "@@ -58,7 +58,7 @@ public static KeyBuilder keyBuilder(final ColumnName name, final SqlType type) {\n   }\n \n   @SuppressWarnings(\"unchecked\")\n-  public static List<?> asList(final Object key) {\n+  public static List<Object> asList(final Object key) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1NjQ3NQ=="}, "originalCommit": {"oid": "a9c0de09da22cd6552c140b3b7b5056893a9c3dc"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI4MzYyMw==", "bodyText": "we probably need to make sure that partitionByCols.size() is the same as the number of keys (otherwise it's possible that they selected only key columns, but not all of them)", "url": "https://github.com/confluentinc/ksql/pull/6647#discussion_r527283623", "createdAt": "2020-11-20T00:00:46Z", "author": {"login": "agavra"}, "path": "ksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/PartitionByParamsFactory.java", "diffHunk": "@@ -87,12 +90,19 @@ public static PartitionByParams build(\n       // is already present in the current value\n       mapper = (k, v) -> new KeyValue<>(null, v);\n     } else {\n-      final Function<GenericRow, Object> evaluator = buildExpressionEvaluator(\n+      final Set<? extends ColumnReferenceExp> partitionByCols =\n+          ColumnExtractor.extractColumns(partitionBy);\n+      final boolean isKeyExpression = partitionByCols.stream()\n+          .map(ColumnReferenceExp::getColumnName)\n+          .allMatch(sourceSchema::isKeyColumn);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad0f0311b3e3d5844f570179486bfacda4badc76"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMyNzY2MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final boolean acceptsKey;\n          \n          \n            \n                private final boolean operatesOnKeyOnly;\n          \n      \n    \n    \n  \n\nA little hard for me to understand it inline without context on what this PR does:\n      final Object newKey = evaluator.evaluator.apply(\n          evaluator.acceptsKey\n          ? GenericRow.fromList(StructKeyUtil.asList(k))\n          : v\n      );", "url": "https://github.com/confluentinc/ksql/pull/6647#discussion_r527327660", "createdAt": "2020-11-20T01:02:12Z", "author": {"login": "agavra"}, "path": "ksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/PartitionByParamsFactory.java", "diffHunk": "@@ -202,6 +217,23 @@ private static LogicalSchema buildSchema(\n     final String errorMsg = \"Error computing new key from expression \"\n         + expressionMetadata.getExpression();\n \n-    return row -> expressionMetadata.evaluate(row, null, logger, () -> errorMsg);\n+    return new PartitionByExpressionEvaluator(\n+        row -> expressionMetadata.evaluate(row, null, logger, () -> errorMsg),\n+        isKeyExpression\n+    );\n+  }\n+\n+  private static class PartitionByExpressionEvaluator {\n+\n+    private final Function<GenericRow, Object> evaluator;\n+    private final boolean acceptsKey;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad0f0311b3e3d5844f570179486bfacda4badc76"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMzMTMyMA==", "bodyText": "I suspect this isn't the only place where this bug happens (a null value doesn't get properly passed into an ExpressionEvaluator \ud83e\udd14). I had a PR at one point going to try to have ExpressionMetadata#evaluate take in both a key and a value instead of just a GenericRow which would have prevented this issue. Unfortunately, I couldn't get joins to work because the joiner doesn't actually have access to the key \ud83d\ude2d\ntldr, I think it would be good if we encapsulate as much of this \"put the keys and only the keys into the generic row if the row was null\" into the PartitionByExpressionEvaluator and have that implement BiFunction<Struct, GenericRow, Object> so at least the part that creates the key is all in the same place that calls the evaluator:\n      final Object newKey = evaluator.evaluator.apply(\n          evaluator.acceptsKey\n          ? GenericRow.fromList(StructKeyUtil.asList(k))\n          : v\n      );\nI would also just pass in expressionMetadata into the PartitionByExpressionEvaluator instead of passing it in as a lambda so that it's centralized and we don't have to track down where it's being called and what's getting passed into it", "url": "https://github.com/confluentinc/ksql/pull/6647#discussion_r527331320", "createdAt": "2020-11-20T01:14:13Z", "author": {"login": "agavra"}, "path": "ksqldb-streams/src/main/java/io/confluent/ksql/execution/streams/PartitionByParamsFactory.java", "diffHunk": "@@ -202,6 +217,23 @@ private static LogicalSchema buildSchema(\n     final String errorMsg = \"Error computing new key from expression \"\n         + expressionMetadata.getExpression();\n \n-    return row -> expressionMetadata.evaluate(row, null, logger, () -> errorMsg);\n+    return new PartitionByExpressionEvaluator(\n+        row -> expressionMetadata.evaluate(row, null, logger, () -> errorMsg),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad0f0311b3e3d5844f570179486bfacda4badc76"}, "originalPosition": 88}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd0e3389e1202ba80474671424c9ce80c93b267d", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/bd0e3389e1202ba80474671424c9ce80c93b267d", "committedDate": "2020-11-20T18:12:13Z", "message": "chore: feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4549, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}