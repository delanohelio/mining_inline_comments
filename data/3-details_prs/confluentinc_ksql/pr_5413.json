{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwMjc4OTg5", "number": 5413, "title": "chore: ensure physical plan has correct key column name ", "bodyText": "Description\nNoticed that when a key column is aliased in the projection of a persistent query, the physical plan has the old name for the key column.\nThis change fixes that by including the names of the key columns in the StreamSelect / TableSelect physical plan step types.  It's sufficient to track just the column names as they key data can not be changed in a projection, only the column names.\nCurrently, only a single key column is possible. However, the select step pojos take a list of column names in prep for multiple key columns.\nReviewing\n\nFirst commit is prod code changes.\nSecond is test changes\nThird is historical plans.\n\nTesting done\nusual\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-05-19T18:04:45Z", "url": "https://github.com/confluentinc/ksql/pull/5413", "merged": true, "mergeCommit": {"oid": "16641a2dd24357e16395dfc6ce958136501517e4"}, "closed": true, "closedAt": "2020-05-20T10:02:22Z", "author": {"login": "big-andy-coates"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABci4YTOAH2gAyNDIwMjc4OTg5OjUxZjBiNDRiOWNlNGE5OTRlYTE2OTcxMmRiYTMwYzRhMDllNzYyN2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjFQG2gH2gAyNDIwMjc4OTg5OmFhMjlmN2YxNTc4NTJmM2JkODVjOGQ3YjY3Nzc3OTg5MGIxOTBhMDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "51f0b44b9ce4a994ea169712dba30c4a09e7627e", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/51f0b44b9ce4a994ea169712dba30c4a09e7627e", "committedDate": "2020-05-19T18:00:44Z", "message": "chore: ensure physical plan has correct key column name\n\nNoticed that when a key column is aliased in the projection of a persistent query, the physical plan has the old name for the key column.\n\nThis change fixes that by including the names of the key columns in the `StreamSelect` / `TableSelect` physical plan step types.  It's sufficient to track just the column names as they key data can not be changed in a projection, only the column names.\n\nCurrently, only a single key column is possible. However, the select step pojos take a list of column names in prep for multiple key columns."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd8408c7778a45cdbb4f37e254d866ffd8dd4bf1", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/bd8408c7778a45cdbb4f37e254d866ffd8dd4bf1", "committedDate": "2020-05-19T18:01:19Z", "message": "test: test changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de2418c808ca64254bcbd3892d8c75cf33491cc4", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/de2418c808ca64254bcbd3892d8c75cf33491cc4", "committedDate": "2020-05-19T18:02:55Z", "message": "test: historical plans"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NzI5MDY3", "url": "https://github.com/confluentinc/ksql/pull/5413#pullrequestreview-414729067", "createdAt": "2020-05-19T18:47:36Z", "commit": {"oid": "51f0b44b9ce4a994ea169712dba30c4a09e7627e"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxODo0NzozNlrOGXt_bQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMDoxODo1N1rOGXxFjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyMzk0OQ==", "bodyText": "github issue?", "url": "https://github.com/confluentinc/ksql/pull/5413#discussion_r427523949", "createdAt": "2020-05-19T18:47:36Z", "author": {"login": "agavra"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/plan/StreamSelect.java", "diffHunk": "@@ -16,30 +16,49 @@\n \n import static java.util.Objects.requireNonNull;\n \n+import com.fasterxml.jackson.annotation.JsonCreator;\n import com.fasterxml.jackson.annotation.JsonIgnore;\n import com.fasterxml.jackson.annotation.JsonProperty;\n import com.google.common.collect.ImmutableList;\n import com.google.errorprone.annotations.Immutable;\n+import io.confluent.ksql.name.ColumnName;\n import java.util.Collections;\n import java.util.List;\n import java.util.Objects;\n+import java.util.Optional;\n \n @Immutable\n public class StreamSelect<K> implements ExecutionStep<KStreamHolder<K>> {\n \n   private final ExecutionStepPropertiesV1 properties;\n   private final ExecutionStep<KStreamHolder<K>> source;\n+  private final ImmutableList<ColumnName> keyColumnNames;\n   private final ImmutableList<SelectExpression> selectExpressions;\n \n   public StreamSelect(\n+      final ExecutionStepPropertiesV1 props,\n+      final ExecutionStep<KStreamHolder<K>> source,\n+      final List<ColumnName> keyColumnNames,\n+      final List<SelectExpression> selectExpressions\n+  ) {\n+    this.properties = requireNonNull(props, \"props\");\n+    this.source = requireNonNull(source, \"source\");\n+    this.keyColumnNames = ImmutableList.copyOf(keyColumnNames);\n+    this.selectExpressions = ImmutableList.copyOf(selectExpressions);\n+  }\n+\n+  @SuppressWarnings(\"unused\") // Invoked via reflection by Jackson\n+  @JsonCreator\n+  private StreamSelect(\n       @JsonProperty(value = \"properties\", required = true) final ExecutionStepPropertiesV1 props,\n       @JsonProperty(value = \"source\", required = true) final ExecutionStep<KStreamHolder<K>> source,\n+      // keyColumnNames introduced in 0.10.0.\n+      // Can be mandatory once 0.9.0 query plans are unsupported.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51f0b44b9ce4a994ea169712dba30c4a09e7627e"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU3NDY3MQ==", "bodyText": "derp... did this test never do anything? \ud83d\ude02", "url": "https://github.com/confluentinc/ksql/pull/5413#discussion_r427574671", "createdAt": "2020-05-19T20:18:57Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/test/java/io/confluent/ksql/engine/QueryPlanTest.java", "diffHunk": "@@ -62,6 +63,7 @@ public void shouldImplementEquals() {\n         .addEqualityGroup(new QueryPlan(sources2, sink1, plan1, id1))\n         .addEqualityGroup(new QueryPlan(sources1, sink2, plan1, id1))\n         .addEqualityGroup(new QueryPlan(sources1, sink1, plan2, id1))\n-        .addEqualityGroup(new QueryPlan(sources1, sink1, plan1, id2));\n+        .addEqualityGroup(new QueryPlan(sources1, sink1, plan1, id2))\n+        .testEquals();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd8408c7778a45cdbb4f37e254d866ffd8dd4bf1"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa29f7f157852f3bd85c8d7b677779890b190a06", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/aa29f7f157852f3bd85c8d7b677779890b190a06", "committedDate": "2020-05-20T09:00:33Z", "message": "chore: changes requested by Almog"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4787, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}