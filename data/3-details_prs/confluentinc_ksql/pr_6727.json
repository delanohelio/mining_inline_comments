{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyODU5NTU1", "number": 6727, "title": "fix: catch stack overflow error when parsing/preparing statements", "bodyText": "Description\n#5882\nThere were two possible places throwing the stack overflow error, while parsing/preparing.\nOne suggestion was to limit the Where clause size, but I don't think that's an optimal since it's possible to have a large where clause and not hit this issue. The error is being thrown when recursively trying to evaluate the boolean expression that's part of the Where clause, and the number of nested parentheses expressions is causing the deep recursion tree, but if the boolean expression was something like `Where ITM.ITEM_ID = '61151234123412345......(very long id)....12341234123412341', there wouldn't be the overflow, but the expression would have a large size.\nSo I just ended up catching the stack overflow error and throwing a more helpful exception.\nTesting done\nI Issued large where clause statement and verifying both error messages were returned.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-12-05T00:31:53Z", "url": "https://github.com/confluentinc/ksql/pull/6727", "merged": true, "mergeCommit": {"oid": "37371cc427e93a3b7518587a6c817d7b390b2003"}, "closed": true, "closedAt": "2020-12-09T18:08:46Z", "author": {"login": "stevenpyzhang"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdjBPrigH2gAyNTMyODU5NTU1OmM1OWQ3ZGYxNjk1NzQzYzczMjUwYjJlNDQyMTExOWY3NzdmNGVhMWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkhyaBABqjQwOTA5OTExMTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c59d7df1695743c73250b2e4421119f777f4ea1c", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/c59d7df1695743c73250b2e4421119f777f4ea1c", "committedDate": "2020-12-05T00:31:37Z", "message": "fix: catch stack overflow error when parsing/preparing statements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MzgzMjg1", "url": "https://github.com/confluentinc/ksql/pull/6727#pullrequestreview-546383285", "createdAt": "2020-12-07T17:41:31Z", "commit": {"oid": "c59d7df1695743c73250b2e4421119f777f4ea1c"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "947b3d3a5865f7f2f3940d7b44a373333d10ad29", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/947b3d3a5865f7f2f3940d7b44a373333d10ad29", "committedDate": "2020-12-08T17:46:57Z", "message": "add QTT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NTAxMDUx", "url": "https://github.com/confluentinc/ksql/pull/6727#pullrequestreview-547501051", "createdAt": "2020-12-08T18:15:01Z", "commit": {"oid": "947b3d3a5865f7f2f3940d7b44a373333d10ad29"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxODoxNTowMVrOIBuoqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxODoxNTowMVrOIBuoqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODY4MzU2Mw==", "bodyText": "nit: might make sense to include the GH ticket in the error message so that users can understand which part and what to do about it (namely, make the nested parenthesis less nested)", "url": "https://github.com/confluentinc/ksql/pull/6727#discussion_r538683563", "createdAt": "2020-12-08T18:15:01Z", "author": {"login": "agavra"}, "path": "ksqldb-parser/src/main/java/io/confluent/ksql/parser/AstBuilder.java", "diffHunk": "@@ -1474,9 +1474,13 @@ private static OptionalInt getLimit(final LimitClauseContext limitContext) {\n   }\n \n   private static Set<SourceName> getSources(final ParseTree parseTree) {\n-    final SourceAccumulator accumulator = new SourceAccumulator();\n-    accumulator.visit(parseTree);\n-    return accumulator.getSources();\n+    try {\n+      final SourceAccumulator accumulator = new SourceAccumulator();\n+      accumulator.visit(parseTree);\n+      return accumulator.getSources();\n+    } catch (StackOverflowError e) {\n+      throw new KsqlException(\"Error processing statement: Statement is too large to parse.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "947b3d3a5865f7f2f3940d7b44a373333d10ad29"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49374480f2d228eb5b30a0c0617bbaa014adf2b3", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/49374480f2d228eb5b30a0c0617bbaa014adf2b3", "committedDate": "2020-12-08T19:25:42Z", "message": "update error message"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "42632b4b19d205d57b68d028da2361e3be51b0aa", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/42632b4b19d205d57b68d028da2361e3be51b0aa", "committedDate": "2020-12-08T20:46:35Z", "message": "temp"}, "afterCommit": {"oid": "41ff83c53af7a6d4b4c5b32438ce0b30b41ea233", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/41ff83c53af7a6d4b4c5b32438ce0b30b41ea233", "committedDate": "2020-12-08T20:51:22Z", "message": "temp"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "41ff83c53af7a6d4b4c5b32438ce0b30b41ea233", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/41ff83c53af7a6d4b4c5b32438ce0b30b41ea233", "committedDate": "2020-12-08T20:51:22Z", "message": "temp"}, "afterCommit": {"oid": "5b53318f9f70d4b8a752c6eee7ac6982c8c0c06c", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/5b53318f9f70d4b8a752c6eee7ac6982c8c0c06c", "committedDate": "2020-12-08T21:22:11Z", "message": "temp"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NjU3MDA2", "url": "https://github.com/confluentinc/ksql/pull/6727#pullrequestreview-547657006", "createdAt": "2020-12-08T21:43:15Z", "commit": {"oid": "5b53318f9f70d4b8a752c6eee7ac6982c8c0c06c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45e7efefc458f90a733d5b9dedeb1c1a4b64d468", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/45e7efefc458f90a733d5b9dedeb1c1a4b64d468", "committedDate": "2020-12-09T17:00:17Z", "message": "update test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b53318f9f70d4b8a752c6eee7ac6982c8c0c06c", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/5b53318f9f70d4b8a752c6eee7ac6982c8c0c06c", "committedDate": "2020-12-08T21:22:11Z", "message": "temp"}, "afterCommit": {"oid": "45e7efefc458f90a733d5b9dedeb1c1a4b64d468", "author": {"user": {"login": "stevenpyzhang", "name": "Steven Zhang"}}, "url": "https://github.com/confluentinc/ksql/commit/45e7efefc458f90a733d5b9dedeb1c1a4b64d468", "committedDate": "2020-12-09T17:00:17Z", "message": "update test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4574, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}