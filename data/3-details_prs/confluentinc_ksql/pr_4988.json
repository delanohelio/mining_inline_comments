{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4MzI3MTkw", "number": 4988, "title": "chore: add analysis/formatting around multi-way joins", "bodyText": "Description\nGets us one step closer to multi-way joins by adding support in the analysis phase. I moved the failure to the Logical Planner if you try to multi-way join (see the QTT test)\nTesting done\nUpdated unit tests.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-04-03T18:39:32Z", "url": "https://github.com/confluentinc/ksql/pull/4988", "merged": true, "mergeCommit": {"oid": "0e0c28381fd82a8b9dd6e0b87f653c1861ac1d6d"}, "closed": true, "closedAt": "2020-04-10T20:47:48Z", "author": {"login": "agavra"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVBwa0gBqjMyMDYzMzA5OTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWXNPtAFqTM5MTY0MDI2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "53e41d224ae9cab52c87d621edbd2f3582aa7265", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/53e41d224ae9cab52c87d621edbd2f3582aa7265", "committedDate": "2020-04-03T18:36:39Z", "message": "chore: add analysis/formatting around multi-way joins"}, "afterCommit": {"oid": "cb5013b803f213b1b66de72e1bd1388db5530ceb", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/cb5013b803f213b1b66de72e1bd1388db5530ceb", "committedDate": "2020-04-06T17:01:05Z", "message": "fix: rebase removed import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzkyNjI1", "url": "https://github.com/confluentinc/ksql/pull/4988#pullrequestreview-389392625", "createdAt": "2020-04-07T18:43:27Z", "commit": {"oid": "cb5013b803f213b1b66de72e1bd1388db5530ceb"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxODo0MzoyN1rOGCROUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxODo1MTowNVrOGCRgPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAzMjUzMQ==", "bodyText": "Just curious, does it matter that you keep passing in left?  What if two of the rights are the same.  Seems like it would miss the self-join check.", "url": "https://github.com/confluentinc/ksql/pull/4988#discussion_r405032531", "createdAt": "2020-04-07T18:43:27Z", "author": {"login": "AlanConfluent"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/Analyzer.java", "diffHunk": "@@ -286,12 +286,23 @@ protected AstNode visitJoin(final Join node, final Void context) {\n       process(node.getLeft(), context);\n       node.getRights().forEach(right -> process(right.getRelation(), context));\n \n-      final JoinNode.JoinType joinType = getJoinType(node);\n-\n       final AliasedDataSource left = analysis.getFromDataSources().get(0);\n-      final AliasedDataSource right = analysis.getFromDataSources().get(1);\n \n-      final JoinedSource source = Iterables.getOnlyElement(node.getRights());\n+      final ImmutableList<JoinedSource> rights = node.getRights();\n+      for (int i = 0; i < rights.size(); i++) {\n+        final JoinedSource source = rights.get(i);\n+        visitJoinedSource(left, analysis.getFromDataSources().get(i + 1), source);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb5013b803f213b1b66de72e1bd1388db5530ceb"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAzNzExNg==", "bodyText": "Is this part of a followup?", "url": "https://github.com/confluentinc/ksql/pull/4988#discussion_r405037116", "createdAt": "2020-04-07T18:51:05Z", "author": {"login": "AlanConfluent"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/planner/LogicalPlanner.java", "diffHunk": "@@ -425,6 +426,8 @@ private PlanNode buildSourceNode() {\n \n     if (sources.size() == 1) {\n       throw new IllegalStateException(\"Expected more than one source. Got \" + sources.size());\n+    } else if (sources.size() != 2) {\n+      throw new KsqlException(\"ksqlDB does not support multi-way joins.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb5013b803f213b1b66de72e1bd1388db5530ceb"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36cedf0d719cec3ee0ba381ce1323fd05c814423", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/36cedf0d719cec3ee0ba381ce1323fd05c814423", "committedDate": "2020-04-09T00:49:55Z", "message": "chore: add analysis/formatting around multi-way joins"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cb5013b803f213b1b66de72e1bd1388db5530ceb", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/cb5013b803f213b1b66de72e1bd1388db5530ceb", "committedDate": "2020-04-06T17:01:05Z", "message": "fix: rebase removed import"}, "afterCommit": {"oid": "36cedf0d719cec3ee0ba381ce1323fd05c814423", "author": {"user": {"login": "agavra", "name": "Almog Gavra"}}, "url": "https://github.com/confluentinc/ksql/commit/36cedf0d719cec3ee0ba381ce1323fd05c814423", "committedDate": "2020-04-09T00:49:55Z", "message": "chore: add analysis/formatting around multi-way joins"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNjQwMjY1", "url": "https://github.com/confluentinc/ksql/pull/4988#pullrequestreview-391640265", "createdAt": "2020-04-10T20:18:16Z", "commit": {"oid": "36cedf0d719cec3ee0ba381ce1323fd05c814423"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMDoxODoxNlrOGEEt_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMDozMzo1MFrOGEFIgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkyNDc5OQ==", "bodyText": "I feel like I've seen a lot of the same bits of code error checking column references, such as in Analyze where it does column name validation.  Wondering if this can be consolidated a bit.", "url": "https://github.com/confluentinc/ksql/pull/4988#discussion_r406924799", "createdAt": "2020-04-10T20:18:16Z", "author": {"login": "AlanConfluent"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/rewrite/DataSourceExtractor.java", "diffHunk": "@@ -58,64 +53,37 @@\n \n   public void extractDataSources(final AstNode node) {\n     new Visitor().process(node, null);\n-    commonColumnNames.addAll(Sets.intersection(leftColumnNames, rightColumnNames));\n-  }\n-\n-  public SourceName getFromAlias() {\n-    return fromAlias;\n-  }\n-\n-  public SourceName getLeftAlias() {\n-    return leftAlias;\n-  }\n-\n-  public SourceName getRightAlias() {\n-    return rightAlias;\n   }\n \n-  public Set<DataSource> getAllSources() {\n-    return Collections.unmodifiableSet(allSources);\n+  public Set<AliasedDataSource> getAllSources() {\n+    return ImmutableSet.copyOf(allSources);\n   }\n \n   public Set<ColumnName> getCommonColumnNames() {\n     return Collections.unmodifiableSet(commonColumnNames);\n   }\n \n-  public SourceName getFromName() {\n-    return fromName;\n-  }\n-\n-  public SourceName getLeftName() {\n-    return leftName;\n-  }\n-\n-  public SourceName getRightName() {\n-    return rightName;\n-  }\n-\n   public boolean isJoin() {\n     return isJoin;\n   }\n \n   public SourceName getAliasFor(final ColumnName columnName) {\n-    if (isJoin) {\n-      if (commonColumnNames.contains(columnName)) {\n-        throw new KsqlException(\"Column '\" + columnName.text() + \"' is ambiguous.\");\n-      }\n-\n-      if (leftColumnNames.contains(columnName)) {\n-        return leftAlias;\n-      }\n-\n-      if (rightColumnNames.contains(columnName)) {\n-        return rightAlias;\n-      }\n+    if (!isJoin) {\n+      return Iterables.getOnlyElement(allSources).getAlias();\n+    }\n \n-      throw new KsqlException(\n-          \"Column '\" + columnName.text() + \"' cannot be resolved.\"\n-      );\n+    final List<SourceName> source = allSources.stream()\n+        .filter(aliased -> aliased.getDataSource().getSchema().findColumn(columnName).isPresent())\n+        .map(AliasedDataSource::getAlias)\n+        .collect(Collectors.toList());\n+\n+    if (source.size() > 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36cedf0d719cec3ee0ba381ce1323fd05c814423"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkzMTU4NQ==", "bodyText": "I assume this is in place of the join code, which you've removed.  Why was join special-cased before?", "url": "https://github.com/confluentinc/ksql/pull/4988#discussion_r406931585", "createdAt": "2020-04-10T20:33:50Z", "author": {"login": "AlanConfluent"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/rewrite/DataSourceExtractor.java", "diffHunk": "@@ -126,50 +94,34 @@ public Void visitRelation(final Relation relation, final Void ctx) {\n \n     @Override\n     public Void visitAliasedRelation(final AliasedRelation relation, final Void ctx) {\n-      fromAlias = relation.getAlias();\n-      fromName = ((Table) relation.getRelation()).getName();\n+      final SourceName fromName = ((Table) relation.getRelation()).getName();\n       final DataSource source = metaStore.getSource(fromName);\n       if (source == null) {\n         throw new KsqlException(fromName.text() + \" does not exist.\");\n       }\n \n-      allSources.add(source);\n+      allSources.add(new AliasedDataSource(relation.getAlias(), source));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36cedf0d719cec3ee0ba381ce1323fd05c814423"}, "originalPosition": 139}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4981, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}