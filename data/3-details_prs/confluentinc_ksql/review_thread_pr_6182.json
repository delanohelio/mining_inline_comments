{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0MjMwMzk5", "number": 6182, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMTo0MToxMlrOEiWXZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMjowMjo1OVrOEiWnUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDUzNDc4OnYy", "diffSide": "RIGHT", "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/util/ExpressionTypeManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMTo0MToxMlrOHQLRMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMTowNjo0NlrOHQahNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyMzg4OQ==", "bodyText": "This error message doesn't make sense to me. The block above throws if any key types are null, so if we reach here and keyTypes.size() is zero, that means no keys were specified, but that's not possible either since if (exp.getMap().isEmpty()) is already checked and handled at the start of the method.", "url": "https://github.com/confluentinc/ksql/pull/6182#discussion_r486723889", "createdAt": "2020-09-11T01:41:12Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/util/ExpressionTypeManager.java", "diffHunk": "@@ -401,12 +401,14 @@ public Void visitCreateMapExpression(\n           })\n           .collect(Collectors.toList());\n \n-      if (keyTypes.stream().anyMatch(type -> !SqlTypes.STRING.equals(type))) {\n-        final String types = keyTypes.stream()\n-            .map(type -> type == null ? \"NULL\" : type.toString())\n-            .collect(Collectors.joining(\", \", \"[\", \"]\"));\n+      if (keyTypes.stream().anyMatch(type -> type == null)) {\n+        throw new KsqlException(\"Map keys can not be NULL\");\n+      }\n \n-        throw new KsqlException(\"Only STRING keys are supported in maps but got: \" + types);\n+      if (keyTypes.size() == 0) {\n+        throw new KsqlException(\"Cannot construct a map with all NULL key \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e169b638f2c658909e3774dc7f0bbde48a7046e"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk3Mzc0OQ==", "bodyText": "Removed.", "url": "https://github.com/confluentinc/ksql/pull/6182#discussion_r486973749", "createdAt": "2020-09-11T11:06:46Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/util/ExpressionTypeManager.java", "diffHunk": "@@ -401,12 +401,14 @@ public Void visitCreateMapExpression(\n           })\n           .collect(Collectors.toList());\n \n-      if (keyTypes.stream().anyMatch(type -> !SqlTypes.STRING.equals(type))) {\n-        final String types = keyTypes.stream()\n-            .map(type -> type == null ? \"NULL\" : type.toString())\n-            .collect(Collectors.joining(\", \", \"[\", \"]\"));\n+      if (keyTypes.stream().anyMatch(type -> type == null)) {\n+        throw new KsqlException(\"Map keys can not be NULL\");\n+      }\n \n-        throw new KsqlException(\"Only STRING keys are supported in maps but got: \" + types);\n+      if (keyTypes.size() == 0) {\n+        throw new KsqlException(\"Cannot construct a map with all NULL key \"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyMzg4OQ=="}, "originalCommit": {"oid": "0e169b638f2c658909e3774dc7f0bbde48a7046e"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDU0MjQzOnYy", "diffSide": "RIGHT", "path": "ksqldb-functional-tests/src/main/java/io/confluent/ksql/test/tools/TestExecutorUtil.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMTo0NTowMlrOHQLVgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMjozNjozNlrOHQdDJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyNDk5NA==", "bodyText": "Why are we catching KsqlStatementException and throwing a different KsqlStatementException here? Did you mean to catch KsqlException instead?", "url": "https://github.com/confluentinc/ksql/pull/6182#discussion_r486724994", "createdAt": "2020-09-11T01:45:02Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-functional-tests/src/main/java/io/confluent/ksql/test/tools/TestExecutorUtil.java", "diffHunk": "@@ -308,15 +308,20 @@ private static ExecuteResultAndSources executePlan(\n       final KsqlExecutionContext executionContext,\n       final ConfiguredKsqlPlan plan\n   ) {\n-    final ExecuteResult executeResult = executionContext.execute(\n-        executionContext.getServiceContext(),\n-        plan\n-    );\n+    try {\n+      final ExecuteResult executeResult = executionContext.execute(\n+          executionContext.getServiceContext(),\n+          plan\n+      );\n \n-    final Optional<List<DataSource>> dataSources = plan.getPlan().getQueryPlan()\n-        .map(queryPlan -> getSources(queryPlan.getSources(), executionContext.getMetaStore()));\n+      final Optional<List<DataSource>> dataSources = plan.getPlan().getQueryPlan()\n+          .map(queryPlan -> getSources(queryPlan.getSources(), executionContext.getMetaStore()));\n \n-    return new ExecuteResultAndSources(executeResult, dataSources);\n+      return new ExecuteResultAndSources(executeResult, dataSources);\n+    } catch (final KsqlStatementException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e169b638f2c658909e3774dc7f0bbde48a7046e"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk3MTcwMw==", "bodyText": "Nope, the code is attempting to catch a KsqlStatementException thrown by the engine, which will have the reformatted SQL in it, and throw a almost matching KsqlStatementException that contains the pre-formatted sql.  Its a hack, but not a new one, this is copied for somewhere else in the test code.\nAlso, in this case it doesn't work - as the code only has the reformatted SQL - forgot I hadn't fixed this, let me take a look.", "url": "https://github.com/confluentinc/ksql/pull/6182#discussion_r486971703", "createdAt": "2020-09-11T11:01:46Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-functional-tests/src/main/java/io/confluent/ksql/test/tools/TestExecutorUtil.java", "diffHunk": "@@ -308,15 +308,20 @@ private static ExecuteResultAndSources executePlan(\n       final KsqlExecutionContext executionContext,\n       final ConfiguredKsqlPlan plan\n   ) {\n-    final ExecuteResult executeResult = executionContext.execute(\n-        executionContext.getServiceContext(),\n-        plan\n-    );\n+    try {\n+      final ExecuteResult executeResult = executionContext.execute(\n+          executionContext.getServiceContext(),\n+          plan\n+      );\n \n-    final Optional<List<DataSource>> dataSources = plan.getPlan().getQueryPlan()\n-        .map(queryPlan -> getSources(queryPlan.getSources(), executionContext.getMetaStore()));\n+      final Optional<List<DataSource>> dataSources = plan.getPlan().getQueryPlan()\n+          .map(queryPlan -> getSources(queryPlan.getSources(), executionContext.getMetaStore()));\n \n-    return new ExecuteResultAndSources(executeResult, dataSources);\n+      return new ExecuteResultAndSources(executeResult, dataSources);\n+    } catch (final KsqlStatementException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyNDk5NA=="}, "originalCommit": {"oid": "0e169b638f2c658909e3774dc7f0bbde48a7046e"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAxNTIwNQ==", "bodyText": "Resolved.", "url": "https://github.com/confluentinc/ksql/pull/6182#discussion_r487015205", "createdAt": "2020-09-11T12:36:36Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-functional-tests/src/main/java/io/confluent/ksql/test/tools/TestExecutorUtil.java", "diffHunk": "@@ -308,15 +308,20 @@ private static ExecuteResultAndSources executePlan(\n       final KsqlExecutionContext executionContext,\n       final ConfiguredKsqlPlan plan\n   ) {\n-    final ExecuteResult executeResult = executionContext.execute(\n-        executionContext.getServiceContext(),\n-        plan\n-    );\n+    try {\n+      final ExecuteResult executeResult = executionContext.execute(\n+          executionContext.getServiceContext(),\n+          plan\n+      );\n \n-    final Optional<List<DataSource>> dataSources = plan.getPlan().getQueryPlan()\n-        .map(queryPlan -> getSources(queryPlan.getSources(), executionContext.getMetaStore()));\n+      final Optional<List<DataSource>> dataSources = plan.getPlan().getQueryPlan()\n+          .map(queryPlan -> getSources(queryPlan.getSources(), executionContext.getMetaStore()));\n \n-    return new ExecuteResultAndSources(executeResult, dataSources);\n+      return new ExecuteResultAndSources(executeResult, dataSources);\n+    } catch (final KsqlStatementException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyNDk5NA=="}, "originalCommit": {"oid": "0e169b638f2c658909e3774dc7f0bbde48a7046e"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDU0NjgyOnYy", "diffSide": "RIGHT", "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/avro.json", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMTo0NzowOFrOHQLX3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMTowMjo0MFrOHQaang==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyNTU5Ng==", "bodyText": "How come this results in KsqlException whereas the test above results in KsqlStatementException? The inconsistency is surprising.", "url": "https://github.com/confluentinc/ksql/pull/6182#discussion_r486725596", "createdAt": "2020-09-11T01:47:08Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/avro.json", "diffHunk": "@@ -639,6 +639,27 @@\n           {\"name\": \"OUTPUT\", \"type\": \"stream\", \"schema\": \"ID INT KEY, C1 BOOLEAN, C2 INT, C3 BIGINT, C4 DOUBLE, C5 STRING\"}\n         ]\n       }\n+    },\n+    {\n+      \"name\": \"map with non-string keys fails - C*\",\n+      \"statements\": [\n+        \"CREATE STREAM INPUT (foo MAP<INT, DOUBLE>) WITH (kafka_topic='input_topic', value_format='AVRO');\"\n+      ],\n+      \"expectedException\": {\n+        \"type\": \"io.confluent.ksql.util.KsqlStatementException\",\n+        \"message\": \"Avro only supports MAPs with STRING keys\"\n+      }\n+    },\n+    {\n+      \"name\": \"map with non-string keys fails - C*AS\",\n+      \"statements\": [\n+        \"CREATE STREAM INPUT (k INT, v DOUBLE) WITH (kafka_topic='input_topic', value_format='AVRO');\",\n+        \"CREATE STREAM OUTPUT AS SELECT MAP(k:=v) FROM INPUT;\"\n+      ],\n+      \"expectedException\": {\n+        \"type\": \"io.confluent.ksql.util.KsqlException\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e169b638f2c658909e3774dc7f0bbde48a7046e"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk3MjA2Mg==", "bodyText": "See comment above for why", "url": "https://github.com/confluentinc/ksql/pull/6182#discussion_r486972062", "createdAt": "2020-09-11T11:02:40Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/avro.json", "diffHunk": "@@ -639,6 +639,27 @@\n           {\"name\": \"OUTPUT\", \"type\": \"stream\", \"schema\": \"ID INT KEY, C1 BOOLEAN, C2 INT, C3 BIGINT, C4 DOUBLE, C5 STRING\"}\n         ]\n       }\n+    },\n+    {\n+      \"name\": \"map with non-string keys fails - C*\",\n+      \"statements\": [\n+        \"CREATE STREAM INPUT (foo MAP<INT, DOUBLE>) WITH (kafka_topic='input_topic', value_format='AVRO');\"\n+      ],\n+      \"expectedException\": {\n+        \"type\": \"io.confluent.ksql.util.KsqlStatementException\",\n+        \"message\": \"Avro only supports MAPs with STRING keys\"\n+      }\n+    },\n+    {\n+      \"name\": \"map with non-string keys fails - C*AS\",\n+      \"statements\": [\n+        \"CREATE STREAM INPUT (k INT, v DOUBLE) WITH (kafka_topic='input_topic', value_format='AVRO');\",\n+        \"CREATE STREAM OUTPUT AS SELECT MAP(k:=v) FROM INPUT;\"\n+      ],\n+      \"expectedException\": {\n+        \"type\": \"io.confluent.ksql.util.KsqlException\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyNTU5Ng=="}, "originalCommit": {"oid": "0e169b638f2c658909e3774dc7f0bbde48a7046e"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDU1ODkwOnYy", "diffSide": "RIGHT", "path": "ksqldb-rest-app/src/test/java/io/confluent/ksql/rest/util/EntityUtilTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMTo1NDoxMlrOHQLfEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMTowMzowMlrOHQabLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyNzQ0Mw==", "bodyText": "SchemaInfo doesn't currently expose the key schema for maps. Is this intended as follow-up work for when ksqlDB's use of protobuf is actually extended to support non-string keys?", "url": "https://github.com/confluentinc/ksql/pull/6182#discussion_r486727443", "createdAt": "2020-09-11T01:54:12Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/test/java/io/confluent/ksql/rest/util/EntityUtilTest.java", "diffHunk": "@@ -61,7 +61,7 @@ public void shouldBuildCorrectBooleanField() {\n   public void shouldBuildCorrectMapField() {\n     // Given:\n     final LogicalSchema schema = LogicalSchema.builder()\n-        .valueColumn(ColumnName.of(\"field\"), SqlTypes.map(SqlTypes.INTEGER))\n+        .valueColumn(ColumnName.of(\"field\"), SqlTypes.map(SqlTypes.BIGINT, SqlTypes.INTEGER))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e169b638f2c658909e3774dc7f0bbde48a7046e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk3MjIwNw==", "bodyText": "Correct, it's already called out in #6177", "url": "https://github.com/confluentinc/ksql/pull/6182#discussion_r486972207", "createdAt": "2020-09-11T11:03:02Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-rest-app/src/test/java/io/confluent/ksql/rest/util/EntityUtilTest.java", "diffHunk": "@@ -61,7 +61,7 @@ public void shouldBuildCorrectBooleanField() {\n   public void shouldBuildCorrectMapField() {\n     // Given:\n     final LogicalSchema schema = LogicalSchema.builder()\n-        .valueColumn(ColumnName.of(\"field\"), SqlTypes.map(SqlTypes.INTEGER))\n+        .valueColumn(ColumnName.of(\"field\"), SqlTypes.map(SqlTypes.BIGINT, SqlTypes.INTEGER))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyNzQ0Mw=="}, "originalCommit": {"oid": "0e169b638f2c658909e3774dc7f0bbde48a7046e"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDU2NjM5OnYy", "diffSide": "RIGHT", "path": "ksqldb-serde/src/main/java/io/confluent/ksql/serde/avro/AvroDataTranslator.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMTo1ODowMlrOHQLjaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMzo0MjozNlrOHQfYFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyODU1Mw==", "bodyText": "Why this change? Statements with non-string map keys in Avro format should've already been rejected during validation, before reaching this, right? Same question for the other serde changes below.", "url": "https://github.com/confluentinc/ksql/pull/6182#discussion_r486728553", "createdAt": "2020-09-11T01:58:02Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-serde/src/main/java/io/confluent/ksql/serde/avro/AvroDataTranslator.java", "diffHunk": "@@ -135,7 +136,7 @@ private static Schema throwOnInvalidSchema(final Schema schema) {\n       @Override\n       public Void visitMap(final Schema schema, final Void key, final Void value) {\n         if (schema.keySchema().type() != Type.STRING) {\n-          throw new IllegalArgumentException(\"Avro only supports MAPs with STRING keys\");\n+          throw new KsqlException(\"Avro only supports MAPs with STRING keys\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e169b638f2c658909e3774dc7f0bbde48a7046e"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk3NTIwNQ==", "bodyText": "On investigation, the AvroFormat wasn't validating the schema before this point. It does now and the validation code is now common.", "url": "https://github.com/confluentinc/ksql/pull/6182#discussion_r486975205", "createdAt": "2020-09-11T11:09:54Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-serde/src/main/java/io/confluent/ksql/serde/avro/AvroDataTranslator.java", "diffHunk": "@@ -135,7 +136,7 @@ private static Schema throwOnInvalidSchema(final Schema schema) {\n       @Override\n       public Void visitMap(final Schema schema, final Void key, final Void value) {\n         if (schema.keySchema().type() != Type.STRING) {\n-          throw new IllegalArgumentException(\"Avro only supports MAPs with STRING keys\");\n+          throw new KsqlException(\"Avro only supports MAPs with STRING keys\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyODU1Mw=="}, "originalCommit": {"oid": "0e169b638f2c658909e3774dc7f0bbde48a7046e"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA1MzMzNA==", "bodyText": "To check my understanding: you're saying this same code path is also used for validation, and that's why it's better to throw KsqlException than IllegalArgumentException?", "url": "https://github.com/confluentinc/ksql/pull/6182#discussion_r487053334", "createdAt": "2020-09-11T13:42:36Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-serde/src/main/java/io/confluent/ksql/serde/avro/AvroDataTranslator.java", "diffHunk": "@@ -135,7 +136,7 @@ private static Schema throwOnInvalidSchema(final Schema schema) {\n       @Override\n       public Void visitMap(final Schema schema, final Void key, final Void value) {\n         if (schema.keySchema().type() != Type.STRING) {\n-          throw new IllegalArgumentException(\"Avro only supports MAPs with STRING keys\");\n+          throw new KsqlException(\"Avro only supports MAPs with STRING keys\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyODU1Mw=="}, "originalCommit": {"oid": "0e169b638f2c658909e3774dc7f0bbde48a7046e"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDU3MDU4OnYy", "diffSide": "RIGHT", "path": "ksqldb-udf/src/test/java/io/confluent/ksql/schema/ksql/types/SqlArrayTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMjowMDoxMVrOHQLlwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMTowMzo0OVrOHQacRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyOTE1Mg==", "bodyText": "This looks like it should be SqlMap.of(SqlTypes.STRING, SqlPrimitiveType.of(SqlTypes.BOOLEAN)) instead?", "url": "https://github.com/confluentinc/ksql/pull/6182#discussion_r486729152", "createdAt": "2020-09-11T02:00:11Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-udf/src/test/java/io/confluent/ksql/schema/ksql/types/SqlArrayTest.java", "diffHunk": "@@ -36,7 +36,7 @@ public void shouldImplementHashCodeAndEqualsProperly() {\n     new EqualsTester()\n         .addEqualityGroup(SqlArray.of(SOME_TYPE), SqlArray.of(SOME_TYPE))\n         .addEqualityGroup(SqlArray.of(SqlPrimitiveType.of(SqlBaseType.BOOLEAN)))\n-        .addEqualityGroup(SqlMap.of(SqlPrimitiveType.of(SqlBaseType.BOOLEAN)))\n+        .addEqualityGroup(SqlMap.of(SqlTypes.STRING, SqlTypes.BOOLEAN))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e169b638f2c658909e3774dc7f0bbde48a7046e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk3MjQ4Nw==", "bodyText": "No difference. Same thing.", "url": "https://github.com/confluentinc/ksql/pull/6182#discussion_r486972487", "createdAt": "2020-09-11T11:03:49Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-udf/src/test/java/io/confluent/ksql/schema/ksql/types/SqlArrayTest.java", "diffHunk": "@@ -36,7 +36,7 @@ public void shouldImplementHashCodeAndEqualsProperly() {\n     new EqualsTester()\n         .addEqualityGroup(SqlArray.of(SOME_TYPE), SqlArray.of(SOME_TYPE))\n         .addEqualityGroup(SqlArray.of(SqlPrimitiveType.of(SqlBaseType.BOOLEAN)))\n-        .addEqualityGroup(SqlMap.of(SqlPrimitiveType.of(SqlBaseType.BOOLEAN)))\n+        .addEqualityGroup(SqlMap.of(SqlTypes.STRING, SqlTypes.BOOLEAN))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyOTE1Mg=="}, "originalCommit": {"oid": "0e169b638f2c658909e3774dc7f0bbde48a7046e"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDU3NTQyOnYy", "diffSide": "RIGHT", "path": "ksqldb-engine/src/test/java/io/confluent/ksql/function/UdtfLoaderTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMjowMjo1NFrOHQLoqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMToxMjo1M1rOHQarxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyOTg5OQ==", "bodyText": "Not your code but I notice that shouldLoadParameterizedListParams() (the test above this one in this file) doesn't test what it says it's testing. Wanna fix it while you're in here?", "url": "https://github.com/confluentinc/ksql/pull/6182#discussion_r486729899", "createdAt": "2020-09-11T02:02:54Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-engine/src/test/java/io/confluent/ksql/function/UdtfLoaderTest.java", "diffHunk": "@@ -97,13 +97,13 @@ public void shouldLoadParameterizedMapParams() {\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e169b638f2c658909e3774dc7f0bbde48a7046e"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk3NjQ1Mw==", "bodyText": "done", "url": "https://github.com/confluentinc/ksql/pull/6182#discussion_r486976453", "createdAt": "2020-09-11T11:12:53Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-engine/src/test/java/io/confluent/ksql/function/UdtfLoaderTest.java", "diffHunk": "@@ -97,13 +97,13 @@ public void shouldLoadParameterizedMapParams() {\n ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyOTg5OQ=="}, "originalCommit": {"oid": "0e169b638f2c658909e3774dc7f0bbde48a7046e"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDU3NTQ3OnYy", "diffSide": "RIGHT", "path": "ksqldb-engine/src/test/java/io/confluent/ksql/integration/SecureIntegrationTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMjowMjo1NlrOHQLotA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMTowNDoyOFrOHQadgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyOTkwOA==", "bodyText": "Curious: why the addition of a timeout to this test file in particular? Seems unrelated to the changes in this PR?", "url": "https://github.com/confluentinc/ksql/pull/6182#discussion_r486729908", "createdAt": "2020-09-11T02:02:56Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-engine/src/test/java/io/confluent/ksql/integration/SecureIntegrationTest.java", "diffHunk": "@@ -112,6 +114,10 @@\n       .outerRule(Retry.of(3, ZooKeeperClientException.class, 3, TimeUnit.SECONDS))\n       .around(TEST_HARNESS);\n \n+\n+  @Rule\n+  public final Timeout timeout = Timeout.seconds(30);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e169b638f2c658909e3774dc7f0bbde48a7046e"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk3MjgwMA==", "bodyText": "Is unrelated, but given this test deadlocked locally, I thought I'd just add the timeout.", "url": "https://github.com/confluentinc/ksql/pull/6182#discussion_r486972800", "createdAt": "2020-09-11T11:04:28Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-engine/src/test/java/io/confluent/ksql/integration/SecureIntegrationTest.java", "diffHunk": "@@ -112,6 +114,10 @@\n       .outerRule(Retry.of(3, ZooKeeperClientException.class, 3, TimeUnit.SECONDS))\n       .around(TEST_HARNESS);\n \n+\n+  @Rule\n+  public final Timeout timeout = Timeout.seconds(30);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyOTkwOA=="}, "originalCommit": {"oid": "0e169b638f2c658909e3774dc7f0bbde48a7046e"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDU3NTU0OnYy", "diffSide": "RIGHT", "path": "ksqldb-parser/src/test/java/io/confluent/ksql/parser/json/KsqlTypesSerdeModuleTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMjowMjo1OVrOHQLovA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMzo0NToxOVrOHQffVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyOTkxNg==", "bodyText": "Any particular reason this is reversed?", "url": "https://github.com/confluentinc/ksql/pull/6182#discussion_r486729916", "createdAt": "2020-09-11T02:02:59Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-parser/src/test/java/io/confluent/ksql/parser/json/KsqlTypesSerdeModuleTest.java", "diffHunk": "@@ -75,19 +78,22 @@ public void shouldSerDeSqlArrayTypes() throws JsonProcessingException {\n   @Test\n   public void shouldSerDeSqlMapTypes() throws JsonProcessingException {\n     // Given:\n-    final SqlType[] types = new SqlType[]{\n+    final List<SqlType> types = ImmutableList.of(\n         SqlTypes.INTEGER,\n         SqlTypes.BIGINT,\n         SqlTypes.DOUBLE,\n         SqlTypes.STRING\n-    };\n+    );\n \n-    for (final SqlType type : types) {\n-      // When:\n-      final SqlType out = MAPPER.readValue(MAPPER.writeValueAsString(SqlMap.of(type)), SqlType.class);\n+    for (final SqlType keyType : types) {\n+      for (final SqlType valueType : Lists.reverse(types)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e169b638f2c658909e3774dc7f0bbde48a7046e"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk3MzAzMA==", "bodyText": "So they don't match.  Otherwise the code could be flipping key and value and the test would still pass.", "url": "https://github.com/confluentinc/ksql/pull/6182#discussion_r486973030", "createdAt": "2020-09-11T11:05:01Z", "author": {"login": "big-andy-coates"}, "path": "ksqldb-parser/src/test/java/io/confluent/ksql/parser/json/KsqlTypesSerdeModuleTest.java", "diffHunk": "@@ -75,19 +78,22 @@ public void shouldSerDeSqlArrayTypes() throws JsonProcessingException {\n   @Test\n   public void shouldSerDeSqlMapTypes() throws JsonProcessingException {\n     // Given:\n-    final SqlType[] types = new SqlType[]{\n+    final List<SqlType> types = ImmutableList.of(\n         SqlTypes.INTEGER,\n         SqlTypes.BIGINT,\n         SqlTypes.DOUBLE,\n         SqlTypes.STRING\n-    };\n+    );\n \n-    for (final SqlType type : types) {\n-      // When:\n-      final SqlType out = MAPPER.readValue(MAPPER.writeValueAsString(SqlMap.of(type)), SqlType.class);\n+    for (final SqlType keyType : types) {\n+      for (final SqlType valueType : Lists.reverse(types)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyOTkxNg=="}, "originalCommit": {"oid": "0e169b638f2c658909e3774dc7f0bbde48a7046e"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA1NTE4OQ==", "bodyText": "I get why the additional for-loop was added (for that reason), but I'm wondering by there's Lists.reverse() in there. Is it because Guava contains a convenient method for copying a list and reversing its contents, but not for directly copying the list...?", "url": "https://github.com/confluentinc/ksql/pull/6182#discussion_r487055189", "createdAt": "2020-09-11T13:45:19Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-parser/src/test/java/io/confluent/ksql/parser/json/KsqlTypesSerdeModuleTest.java", "diffHunk": "@@ -75,19 +78,22 @@ public void shouldSerDeSqlArrayTypes() throws JsonProcessingException {\n   @Test\n   public void shouldSerDeSqlMapTypes() throws JsonProcessingException {\n     // Given:\n-    final SqlType[] types = new SqlType[]{\n+    final List<SqlType> types = ImmutableList.of(\n         SqlTypes.INTEGER,\n         SqlTypes.BIGINT,\n         SqlTypes.DOUBLE,\n         SqlTypes.STRING\n-    };\n+    );\n \n-    for (final SqlType type : types) {\n-      // When:\n-      final SqlType out = MAPPER.readValue(MAPPER.writeValueAsString(SqlMap.of(type)), SqlType.class);\n+    for (final SqlType keyType : types) {\n+      for (final SqlType valueType : Lists.reverse(types)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjcyOTkxNg=="}, "originalCommit": {"oid": "0e169b638f2c658909e3774dc7f0bbde48a7046e"}, "originalPosition": 33}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2759, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}