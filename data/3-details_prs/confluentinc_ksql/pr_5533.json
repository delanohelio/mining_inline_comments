{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2OTAwMDMz", "number": 5533, "title": "Explicit keys", "bodyText": "Description\nimplements: KLIP-29\nfixes: #5303\nfixes: #4678\nThis change sees ksqlDB no longer adding an implicit ROWKEY STRING key column to created streams or primary key column to created tables when no key column is explicitly provided in the CREATE statement.\nBREAKING CHANGE\nCREATE TABLE statements will now fail if not PRIMARY KEY column is provided.\nFor example, a statement such as:\nCREATE TABLE FOO (name STRING) WITH (kafka_topic='foo', value_format='json');\nWill need to be updated to include the definition of the PRIMARY KEY, e.g.\nCREATE TABLE FOO (ID STRING PRIMARY KEY, name STRING) WITH (kafka_topic='foo', value_format='json');\nIf using schema inference, i.e. loading the value columns of the topic from the Schema Registry, the primary key can be provided as a partial schema, e.g.\n-- FOO will have value columns loaded from the Schema Registry\nCREATE TABLE FOO (ID INT PRIMARY KEY) WITH (kafka_topic='foo', value_format='avro');\nCREATE STREAM statements that do not define a KEY column will no longer have an implicit ROWKEY key column.\nFor example:\nCREATE STREAM BAR (NAME STRING) WITH (...);\nThe above statement would previously have resulted in a stream with two columns: ROWKEY STRING KEY and NAME STRING.\nWith this change the above statement will result in a stream with only the NAME STRING column.\nStreams will no KEY column will be serialized to Kafka topics with a null key.\nTesting done\nusual\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-06-03T00:42:14Z", "url": "https://github.com/confluentinc/ksql/pull/5533", "merged": true, "mergeCommit": {"oid": "d0db0cfac050cef94019c6daa59cd765ca0f7379"}, "closed": true, "closedAt": "2020-06-03T09:43:24Z", "author": {"login": "big-andy-coates"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnefBhAH2gAyNDI2OTAwMDMzOjJkZDYzN2U5Y2YyMzkzNDVkNTU3NGE1N2VkZjkzMzZmYTZmNjg1MWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnmNbHgH2gAyNDI2OTAwMDMzOjQ4ODUzYjRiMzM2OWQ0ZmQ5NzhiZjFlZDMwNTA0YTMwMjI2MzE3OTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2dd637e9cf239345d5574a57edf9336fa6f6851a", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/2dd637e9cf239345d5574a57edf9336fa6f6851a", "committedDate": "2020-06-03T00:40:10Z", "message": "feat: explicit keys\n\nimplements: [KLIP-29](https://github.com/confluentinc/ksql/pull/5530)\n\nfixes: https://github.com/confluentinc/ksql/issues/5303\nfixes: https://github.com/confluentinc/ksql/issues/4678\n\nThis change sees ksqlDB no longer adding an implicit `ROWKEY STRING` key column to created streams or primary key column to created tables when no key column is explicitly provided in the `CREATE` statement.\n\nBREAKING CHANGE\n\n`CREATE TABLE` statements will now fail if not `PRIMARY KEY` column is provided.\n\nFor example, a statement such as:\n\n```sql\nCREATE TABLE FOO (name STRING) WITH (kafka_topic='foo', value_format='json');\n```\n\nWill need to be updated to include the definition of the PRIMARY KEY, e.g.\n\n```sql\nCREATE TABLE FOO (ID STRING PRIMARY KEY, name STRING) WITH (kafka_topic='foo', value_format='json');\n```\n\nIf using schema inference, i.e. loading the value columns of the topic from the Schema Registry, the primary key can be provided as a partial schema, e.g.\n\n```sql\n-- FOO will have value columns loaded from the Schema Registry\nCREATE TABLE FOO (ID INT PRIMARY KEY) WITH (kafka_topic='foo', value_format='avro');\n```\n\n`CREATE STREAM` statements that do not define a `KEY` column will no longer have an implicit `ROWKEY` key column.\n\nFor example:\n\n```sql\nCREATE STREAM BAR (NAME STRING) WITH (...);\n```\n\nThe above statement would previously have resulted in a stream with two columns: `ROWKEY STRING KEY` and `NAME STRING`.\nWith this change the above statement will result in a stream with only the `NAME STRING` column.\n\nStreams will no KEY column will be serialized to Kafka topics with a `null` key."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97b86a3ba5fb79c3da5561f5888bd28441db72c5", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/97b86a3ba5fb79c3da5561f5888bd28441db72c5", "committedDate": "2020-06-03T00:40:27Z", "message": "docs: docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e952d9133ae0ab5f60957f82acfbd91223062e89", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/e952d9133ae0ab5f60957f82acfbd91223062e89", "committedDate": "2020-06-03T00:41:05Z", "message": "test: test changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ddfdeef9514ecbcd830709afb628da8e06428f0", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/6ddfdeef9514ecbcd830709afb628da8e06428f0", "committedDate": "2020-06-03T00:41:27Z", "message": "test: historical plans"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMTYzMTgy", "url": "https://github.com/confluentinc/ksql/pull/5533#pullrequestreview-423163182", "createdAt": "2020-06-03T01:39:03Z", "commit": {"oid": "e952d9133ae0ab5f60957f82acfbd91223062e89"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwMTozOTowM1rOGeJSsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwMTo0Mjo0OVrOGeJWIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI2MjcwNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    {\"topic\": \"input\", \"key\": null, \"value\": {\"ID\": 1, \"F0\": 2}}\n          \n          \n            \n                    {\"topic\": \"input\", \"key\": null, \"value\": {\"ID\": 1, \"F0\": 2}},\n          \n          \n            \n                    {\"topic\": \"input\", \"key\": \"foo\", \"value\": {\"ID\": 1, \"F0\": 2}}\n          \n      \n    \n    \n  \n\nlet's also test what happens when there is a key in the message but one isn't declared", "url": "https://github.com/confluentinc/ksql/pull/5533#discussion_r434262706", "createdAt": "2020-06-03T01:39:03Z", "author": {"login": "agavra"}, "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/elements.json", "diffHunk": "@@ -859,6 +859,52 @@\n           {\"name\": \"OUTPUT\", \"type\": \"stream\", \"schema\": \"ID INT KEY, ID_COPY INT\"}\n         ]\n       }\n+    },\n+    {\n+      \"name\": \"table without primary key fails\",\n+      \"statements\": [\n+        \"CREATE TABLE INPUT (ID INT, F0 INT) WITH (kafka_topic='input', value_format='JSON');\"\n+      ],\n+      \"expectedException\": {\n+        \"type\": \"io.confluent.ksql.util.KsqlStatementException\",\n+        \"message\": \"Tables require a PRIMARY KEY. Please define the PRIMARY KEY.\"\n+      }\n+    },\n+    {\n+      \"name\": \"table without primary key fails - schema inference\",\n+      \"statements\": [\n+        \"CREATE TABLE INPUT WITH (kafka_topic='input', value_format='Avro');\"\n+      ],\n+      \"topics\": [\n+        {\n+          \"name\": \"input\",\n+          \"schema\": {\"name\": \"blah\", \"type\": \"record\", \"fields\": [{\"name\": \"c1\", \"type\": \"int\"}]},\n+          \"format\": \"AVRO\"\n+        }\n+      ],\n+      \"expectedException\": {\n+        \"type\": \"io.confluent.ksql.util.KsqlException\",\n+        \"message\": \"Tables require a PRIMARY KEY. Please define the PRIMARY KEY.\\nUse a partial schema to define the primary key and still load the value columns from the Schema Registry, for example:\\n\\tCREATE TABLE INPUT (ID INT PRIMARY KEY) WITH (...);\"\n+      }\n+    },\n+    {\n+      \"name\": \"stream without key column\",\n+      \"statements\": [\n+        \"CREATE STREAM INPUT (ID INT, F0 INT) WITH (kafka_topic='input', value_format='JSON');\",\n+        \"CREATE STREAM OUTPUT AS SELECT * FROM INPUT;\"\n+      ],\n+      \"inputs\": [\n+        {\"topic\": \"input\", \"key\": null, \"value\": {\"ID\": 1, \"F0\": 2}}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e952d9133ae0ab5f60957f82acfbd91223062e89"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI2MzU4Ng==", "bodyText": "dont want to be too picky, but let's also add a stream no-key --> table join", "url": "https://github.com/confluentinc/ksql/pull/5533#discussion_r434263586", "createdAt": "2020-06-03T01:42:49Z", "author": {"login": "agavra"}, "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/joins.json", "diffHunk": "@@ -1966,6 +1966,26 @@\n       \"outputs\": [\n         {\"topic\": \"OUTPUT\", \"key\": \"user_0\", \"value\": {\"IMPRESSION_ID\": 24, \"URL\": \"urlA\"}, \"timestamp\":  12}\n       ]\n+    },\n+    {\n+      \"name\": \"streams with no key columns\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e952d9133ae0ab5f60957f82acfbd91223062e89"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f5ac03f6f5f9e2f2ca3cfbe977c71352463d2da", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/2f5ac03f6f5f9e2f2ca3cfbe977c71352463d2da", "committedDate": "2020-06-03T08:45:26Z", "message": "Merge branch 'master' into explicit_keys"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2819615d98deadbd379b02d150e8690dc549eeb", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/e2819615d98deadbd379b02d150e8690dc549eeb", "committedDate": "2020-06-03T09:06:08Z", "message": "Merge branch 'master' into explicit_keys"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48853b4b3369d4fd978bf1ed30504a3022631792", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/48853b4b3369d4fd978bf1ed30504a3022631792", "committedDate": "2020-06-03T09:40:11Z", "message": "chore: requested changes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4707, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}