{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwOTU5NzIx", "number": 6785, "title": "chore: fix multi-column GROUP BY support with new execution steps", "bodyText": "Description\nFollow-up to #6770 -- turns out the approach in that PR doesn't preserve backwards compatibility for existing multi-column GROUP BY queries since the logic for determining whether to concatenate grouping expressions into a single key column or not was contained purely in the engine, not in the execution plan itself. This PR fixes the issue by introducing new versions of the StreamGroupBy and TableGroupBy execution steps instead.\nNote that nothing is currently broken for users since the new multi-column group by logic is currently behind a feature flag. The presence of this feature flag is also the reason no historic QTTs failed on the previous PR.\nFor reviewers: the raw number of lines changed in this PR is high but each of the changes are straightforward. Four commits for ease of reviewing:\n\nsplit GroupByParamsFactory into GroupByParamsV1Factory (old behavior, i.e., single, concatenated string key) and GroupByParamsFactory (new behavior, i.e., multi-column keys)\nintroduce new execution steps\nintroduce StreamGroupByBuilder and StreamGroupByBuilderV1, with the shared logic in StreamGroupByBuilderBase, and similarly for the table group by builders\nlast few changes to finish wiring up the new classes\n\nTesting done\nVerified historic QTT pass once the feature flag is removed (tested locally).\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-12-16T07:34:21Z", "url": "https://github.com/confluentinc/ksql/pull/6785", "merged": true, "mergeCommit": {"oid": "4995684db13a7e29016c5a9142977ab7754fb4f8"}, "closed": true, "closedAt": "2020-12-16T21:05:48Z", "author": {"login": "vcrfxia"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmpcy3gH2gAyNTQwOTU5NzIxOmRiNzEwMDU3Yzk4MThhOTc2MGRiNDBmYWI5NTgxM2QxOGVmM2YwNTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmyvgZAFqTU1MzkzNTQ4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "db710057c9818a9760db40fab95813d18ef3f055", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/db710057c9818a9760db40fab95813d18ef3f055", "committedDate": "2020-12-16T07:03:55Z", "message": "chore: split GroupByParamsFactory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bfbc9e83ceed99528e15a6080b51427fce293d6", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/7bfbc9e83ceed99528e15a6080b51427fce293d6", "committedDate": "2020-12-16T07:04:14Z", "message": "chore: split execution steps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "261128a8925c9a5610964ae4d370baa1066f6f53", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/261128a8925c9a5610964ae4d370baa1066f6f53", "committedDate": "2020-12-16T07:04:15Z", "message": "chore: split group by builders"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8f99bb23f7ffc7b2800b5ba3d1179a003677b92", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/d8f99bb23f7ffc7b2800b5ba3d1179a003677b92", "committedDate": "2020-12-16T07:04:20Z", "message": "chore: finish wiring up new steps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "902449726ff8447e25febdb051dc0fb46fe30c26", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/902449726ff8447e25febdb051dc0fb46fe30c26", "committedDate": "2020-12-16T07:50:55Z", "message": "test: fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f628749318a2017963891199f2abc85c483b74d7", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/f628749318a2017963891199f2abc85c483b74d7", "committedDate": "2020-12-16T16:04:07Z", "message": "chore: update plan schema"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f90e8ed17bf02da42ea643781f0c60dbf863f3ab", "author": {"user": {"login": "vcrfxia", "name": "Victoria Xia"}}, "url": "https://github.com/confluentinc/ksql/commit/f90e8ed17bf02da42ea643781f0c60dbf863f3ab", "committedDate": "2020-12-16T17:43:42Z", "message": "chore: fix key schema upgrade check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzOTM1NDg0", "url": "https://github.com/confluentinc/ksql/pull/6785#pullrequestreview-553935484", "createdAt": "2020-12-16T17:46:55Z", "commit": {"oid": "7bfbc9e83ceed99528e15a6080b51427fce293d6"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNzo0Njo1NVrOIHRkcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNzo0Njo1NVrOIHRkcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ5ODgwMg==", "bodyText": "to avoid confusion that I have with StreamSelectKey every time i look at the class, what do you think about (in a follow-up PR) changing the class name of StreamGroupBy to StreamGroupByV2 and StreamSelectKey to StreamSelectKeyV2", "url": "https://github.com/confluentinc/ksql/pull/6785#discussion_r544498802", "createdAt": "2020-12-16T17:46:55Z", "author": {"login": "agavra"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/plan/ExecutionStep.java", "diffHunk": "@@ -31,7 +31,8 @@\n     @Type(value = StreamAggregate.class, name = \"streamAggregateV1\"),\n     @Type(value = StreamFilter.class, name = \"streamFilterV1\"),\n     @Type(value = StreamFlatMap.class, name = \"streamFlatMapV1\"),\n-    @Type(value = StreamGroupBy.class, name = \"streamGroupByV1\"),\n+    @Type(value = StreamGroupByV1.class, name = \"streamGroupByV1\"),\n+    @Type(value = StreamGroupBy.class, name = \"streamGroupByV2\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bfbc9e83ceed99528e15a6080b51427fce293d6"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4527, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}