{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1NzgxNzE2", "number": 6336, "title": "chore: fail joins where the key format differs", "bodyText": "Description\nfixes: #6213\nAdd code to throw a useful error message if a join has incompatible key formats. QTT test added too.\nTesting done\nUsual\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-09-30T20:53:00Z", "url": "https://github.com/confluentinc/ksql/pull/6336", "merged": true, "mergeCommit": {"oid": "73e85b52881181ce3459f321ae1d0d4849bfa4a6"}, "closed": true, "closedAt": "2020-10-01T18:00:56Z", "author": {"login": "big-andy-coates"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdODJj6AH2gAyNDk1NzgxNzE2OmEzMjQ4OGRmZWEwNzc2MDI2M2EyMDdmNTA3ZGRlNDI1MTQ2MmRjMzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOQv8AgH2gAyNDk1NzgxNzE2OmJlZjRkNmIzMWQ5MDE0YTk0NTdkMmJhYjNhYTkyN2QyN2Q0YjhjNTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a32488dfea07760263a207f507dde4251462dc32", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/a32488dfea07760263a207f507dde4251462dc32", "committedDate": "2020-09-30T20:52:20Z", "message": "chore: fail joins where the key format differs\n\nfixes: https://github.com/confluentinc/ksql/issues/6213\n\nAdd code to throw a useful error message if a join has incompatible key formats. QTT test added too."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11fa29718a2f722c7316982f497d8717f60385c2", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/11fa29718a2f722c7316982f497d8717f60385c2", "committedDate": "2020-10-01T09:15:45Z", "message": "chore: fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMjY4Nzgz", "url": "https://github.com/confluentinc/ksql/pull/6336#pullrequestreview-500268783", "createdAt": "2020-10-01T11:54:35Z", "commit": {"oid": "11fa29718a2f722c7316982f497d8717f60385c2"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxMTo1NDozNVrOHbG2ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxMTo1NjozMFrOHbG6fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE4NTg1MQ==", "bodyText": "Why are the schemas for session and non-session windows different? Is this because non-session windows don't store window end times?", "url": "https://github.com/confluentinc/ksql/pull/6336#discussion_r498185851", "createdAt": "2020-10-01T11:54:35Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/planner/plan/JoinNode.java", "diffHunk": "@@ -67,6 +72,20 @@\n     INNER, LEFT, OUTER\n   }\n \n+  private static final ImmutableList<KeyProperty> KEY_PROPERTIES = ImmutableList.of(\n+      new KeyProperty(\"format\", kf -> kf.getFormatInfo().getFormat()),\n+      new KeyProperty(\"properties\", kf -> kf.getFormatInfo().getProperties()),\n+      new KeyProperty(\"features\", KeyFormat::getFeatures),\n+      new KeyProperty(\"widowing\", kf -> kf.getWindowInfo()\n+          .map(WindowInfo::getType)\n+          .map(t -> t == WindowType.SESSION\n+              ? \"session windowing\" : \"non session windowing\")\n+          .orElse(\"no windowing\"))\n+  // Note: we deliberately do NOT fail if one side is HOPPING and the other is TUMBLING, or fail\n+  // on different window sizes. This is because we only fail if the _schema_ of the key is\n+  // different. Neither of these differences make the schemas different.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11fa29718a2f722c7316982f497d8717f60385c2"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE4Njg3OQ==", "bodyText": "How come this validation happens here rather than in buildStream() where other validation (matching partition counts) occurs? Is it because we actually prefer to validate in the constructor when possible, but the partition count validation requires a topic client which isn't available until buildStream() is called?", "url": "https://github.com/confluentinc/ksql/pull/6336#discussion_r498186879", "createdAt": "2020-10-01T11:56:30Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/planner/plan/JoinNode.java", "diffHunk": "@@ -97,6 +116,8 @@ public JoinNode(\n     this.left = requireNonNull(left, \"left\");\n     this.right = requireNonNull(right, \"right\");\n     this.withinExpression = requireNonNull(withinExpression, \"withinExpression\");\n+\n+    throwOnKeyMismatch(left, right);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11fa29718a2f722c7316982f497d8717f60385c2"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bef4d6b31d9014a9457d2bab3aa927d27d4b8c59", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/bef4d6b31d9014a9457d2bab3aa927d27d4b8c59", "committedDate": "2020-10-01T12:43:01Z", "message": "chore: fix test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4613, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}