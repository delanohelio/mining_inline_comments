{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMjM3OTk3", "number": 6708, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxODoyMTozNlrOFAZYwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDozOTozOFrOFAdqjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1OTYwMjU3OnYy", "diffSide": "RIGHT", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/planner/plan/JoinNode.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxODoyMTozNlrOH-qzpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNjoyNDoyMlrOH_YOKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3NTEwOQ==", "bodyText": "The PR description says\n\nThis still doesn't fully address what #6017 (klip-33) outlines because it prefers the left instead of the right source to maintain some compatibility with previous code. It would be backwards compatible to change this as this is done at logical plan and not the physical plan.\n\nbut this javadoc seems to describe exactly what's in KLIP 33. From the changes in this PR, it looks like the PR description is out of date and needs to be updated?", "url": "https://github.com/confluentinc/ksql/pull/6708#discussion_r535475109", "createdAt": "2020-12-03T18:21:36Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/planner/plan/JoinNode.java", "diffHunk": "@@ -112,48 +112,18 @@ public JoinNode(\n   /**\n    * Determines the key format of the join.\n    *\n-   * <p>Avoids repartitioning tables for now. Instead choosing to repartition the stream side.\n-   * This is different to what is proposed in KLIP-33. Issue #6229 will look to implement\n-   * repartitioning tables.\n-   *\n-   * <p>For now, the left key format is the preferred join key format unless either:\n-   * <ul>\n-   *   <li>The right source is not already being repartitioned and the left source is.</li>\n-   *   <li>The right source is a table.</li>\n-   * </ul>\n-   * In which case, the right key format it used.\n-   *\n-   * <p>An exception is currently thrown if both sides are tables and their key formats differ.\n+   * <p>For now, the left key format is the preferred join key format unless the\n+   * right source is not already being repartitioned and the left source is.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "720caeea709281faa22b97fc902facbc81bad41a"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc0NDM1NA==", "bodyText": "From KLIP-33:\n\nWhere one side must be repartitioned to correct the key format, choosing which side to repartition\ncan not be driven by the size of the data, as in a traditional database system, as the size of\nthe data is unknown, likely infinite. Ideally, for a streaming system it is the rate of change of\nthe data, i.e. the throughput, that would drive the choice. Unfortunately, this too can not be\nknown upfront.  For this reason, we propose repartitioning based on the order of sources within\nthe query, with the source on the right being repartitioned.\n\nI'm still choosing to repartition the left source, not the right.", "url": "https://github.com/confluentinc/ksql/pull/6708#discussion_r535744354", "createdAt": "2020-12-04T00:23:28Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/planner/plan/JoinNode.java", "diffHunk": "@@ -112,48 +112,18 @@ public JoinNode(\n   /**\n    * Determines the key format of the join.\n    *\n-   * <p>Avoids repartitioning tables for now. Instead choosing to repartition the stream side.\n-   * This is different to what is proposed in KLIP-33. Issue #6229 will look to implement\n-   * repartitioning tables.\n-   *\n-   * <p>For now, the left key format is the preferred join key format unless either:\n-   * <ul>\n-   *   <li>The right source is not already being repartitioned and the left source is.</li>\n-   *   <li>The right source is a table.</li>\n-   * </ul>\n-   * In which case, the right key format it used.\n-   *\n-   * <p>An exception is currently thrown if both sides are tables and their key formats differ.\n+   * <p>For now, the left key format is the preferred join key format unless the\n+   * right source is not already being repartitioned and the left source is.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3NTEwOQ=="}, "originalCommit": {"oid": "720caeea709281faa22b97fc902facbc81bad41a"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc3NjM1OA==", "bodyText": "The changes in this PR choose the preferred format from the left source, which means the right source is being repartitioned. The QTTs support this as well. Have I missed something?", "url": "https://github.com/confluentinc/ksql/pull/6708#discussion_r535776358", "createdAt": "2020-12-04T01:50:25Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/planner/plan/JoinNode.java", "diffHunk": "@@ -112,48 +112,18 @@ public JoinNode(\n   /**\n    * Determines the key format of the join.\n    *\n-   * <p>Avoids repartitioning tables for now. Instead choosing to repartition the stream side.\n-   * This is different to what is proposed in KLIP-33. Issue #6229 will look to implement\n-   * repartitioning tables.\n-   *\n-   * <p>For now, the left key format is the preferred join key format unless either:\n-   * <ul>\n-   *   <li>The right source is not already being repartitioned and the left source is.</li>\n-   *   <li>The right source is a table.</li>\n-   * </ul>\n-   * In which case, the right key format it used.\n-   *\n-   * <p>An exception is currently thrown if both sides are tables and their key formats differ.\n+   * <p>For now, the left key format is the preferred join key format unless the\n+   * right source is not already being repartitioned and the left source is.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3NTEwOQ=="}, "originalCommit": {"oid": "720caeea709281faa22b97fc902facbc81bad41a"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjIxOTE3OQ==", "bodyText": "\ud83d\ude2c yes... you are right!", "url": "https://github.com/confluentinc/ksql/pull/6708#discussion_r536219179", "createdAt": "2020-12-04T16:24:22Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/planner/plan/JoinNode.java", "diffHunk": "@@ -112,48 +112,18 @@ public JoinNode(\n   /**\n    * Determines the key format of the join.\n    *\n-   * <p>Avoids repartitioning tables for now. Instead choosing to repartition the stream side.\n-   * This is different to what is proposed in KLIP-33. Issue #6229 will look to implement\n-   * repartitioning tables.\n-   *\n-   * <p>For now, the left key format is the preferred join key format unless either:\n-   * <ul>\n-   *   <li>The right source is not already being repartitioned and the left source is.</li>\n-   *   <li>The right source is a table.</li>\n-   * </ul>\n-   * In which case, the right key format it used.\n-   *\n-   * <p>An exception is currently thrown if both sides are tables and their key formats differ.\n+   * <p>For now, the left key format is the preferred join key format unless the\n+   * right source is not already being repartitioned and the left source is.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3NTEwOQ=="}, "originalCommit": {"oid": "720caeea709281faa22b97fc902facbc81bad41a"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1OTYyNTExOnYy", "diffSide": "RIGHT", "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/joins.json", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxODoyNjoxMFrOH-rBSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMDoyMjozMVrOH-7N6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3ODYwMA==", "bodyText": "This change is backwards incompatible, right? As in, existing queries will continue running as before but if the same join statements were to be re-issued, a different topology would result. I think we should call this out in the PR description so it appears in the changelog.", "url": "https://github.com/confluentinc/ksql/pull/6708#discussion_r535478600", "createdAt": "2020-12-03T18:26:10Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/joins.json", "diffHunk": "@@ -2250,14 +2250,20 @@\n         \"topics\" : {\n           \"topics\" : [\n             {\n-              \"name\" : \"_confluent-ksql-some.ksql.service.idquery_CSAS_OUTPUT_0-Join-repartition\",\n-              \"keyFormat\" : {\"format\" : \"KAFKA\"},\n-              \"valueFormat\" : {\"format\" : \"JSON\"}\n+              \"name\": \"_confluent-ksql-some.ksql.service.idquery_CSAS_OUTPUT_0-RightSourceKeyed-SelectKey-repartition\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "720caeea709281faa22b97fc902facbc81bad41a"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc0Mzk3OA==", "bodyText": "yes, it is backwards incompatible in that sense. it's not in the sense that all old enqueued commands would still work in the same way. I will call that out", "url": "https://github.com/confluentinc/ksql/pull/6708#discussion_r535743978", "createdAt": "2020-12-04T00:22:31Z", "author": {"login": "agavra"}, "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/joins.json", "diffHunk": "@@ -2250,14 +2250,20 @@\n         \"topics\" : {\n           \"topics\" : [\n             {\n-              \"name\" : \"_confluent-ksql-some.ksql.service.idquery_CSAS_OUTPUT_0-Join-repartition\",\n-              \"keyFormat\" : {\"format\" : \"KAFKA\"},\n-              \"valueFormat\" : {\"format\" : \"JSON\"}\n+              \"name\": \"_confluent-ksql-some.ksql.service.idquery_CSAS_OUTPUT_0-RightSourceKeyed-SelectKey-repartition\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTQ3ODYwMA=="}, "originalCommit": {"oid": "720caeea709281faa22b97fc902facbc81bad41a"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MDI5NDM4OnYy", "diffSide": "RIGHT", "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/multi-joins.json", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDozODoxNlrOH-xXiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDozODoxNlrOH-xXiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU4MjYwMA==", "bodyText": "This topic should also go away with #6650 -- it makes sense that all internal topics should be Avro formatted in this case.", "url": "https://github.com/confluentinc/ksql/pull/6708#discussion_r535582600", "createdAt": "2020-12-03T20:38:16Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/multi-joins.json", "diffHunk": "@@ -1227,41 +1238,41 @@\n       ],\n       \"post\": {\n         \"topics\": {\n-          \"topics\" : [\n+          \"topics\": [\n             {\n-              \"name\" : \"_confluent-ksql-some.ksql.service.idquery_CSAS_OUTPUT_0-L_Join-left-repartition\",\n-              \"keyFormat\" : {\"format\" : \"JSON_SR\", \"features\": [\"UNWRAP_SINGLES\"]},\n-              \"valueFormat\" : {\"format\" : \"JSON\"}\n+              \"name\": \"_confluent-ksql-some.ksql.service.idquery_CSAS_OUTPUT_0-KafkaTopic_Right-Reduce-changelog\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "720caeea709281faa22b97fc902facbc81bad41a"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MDMwMzQ5OnYy", "diffSide": "RIGHT", "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/multi-joins.json", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDozOTozOFrOH-xdqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDozOTozOFrOH-xdqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU4NDE2OA==", "bodyText": "nit: can we order these topics in a more readable fashion? Previously it was repartition topics first, then changelogs, ordered from left to right.", "url": "https://github.com/confluentinc/ksql/pull/6708#discussion_r535584168", "createdAt": "2020-12-03T20:39:38Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-functional-tests/src/test/resources/query-validation-tests/multi-joins.json", "diffHunk": "@@ -1227,41 +1238,41 @@\n       ],\n       \"post\": {\n         \"topics\": {\n-          \"topics\" : [\n+          \"topics\": [", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "720caeea709281faa22b97fc902facbc81bad41a"}, "originalPosition": 52}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2485, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}