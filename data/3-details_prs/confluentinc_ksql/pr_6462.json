{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2MTAyMzc5", "number": 6462, "title": "feat: cli to show tombstones in transient query output", "bodyText": "Description\nfixes: #3616\nThe output from transient queries that return tables will now include tombstones when run in the CLI or using the REST API directly.\nTombstones indicate an existing row has been deleted.\nCLI output now looks like:\nksql> SELECT * FROM SOME_TABLE EMIT CHANGES;\n\n|  ID   |   COL0      |   COL1      |\n+-------+-------------+-------------+\n| 10    | A           | B           |\n| 20    | E           | F           |\n| 10    | <TOMBSTONE> | <TOMBSTONE> | <-- previous row '10' has been deleted.\n| 11    | X           | Y           |\n\nTo facilitate this, the response from the rest api needed to evolve.  The query response includes a single header, followed by row's of data. Previously, this looked like:\n{\"header\":{\"queryId\":\"X\",\"schema\":\"`ID` BIGINT, `COL0` STRING, `COL1` STRING\"}},\n{\"row\":{\"columns\":[10,A,B]}},\n{\"row\":{\"columns\":[20,E,F]}},\n{\"row\":{\"columns\":[11,X,Y]}},\n\nFor queries returning table rows, the result now looks like:\n{\"header\":{\"queryId\":\"X\",\"schema\":\"`ID` BIGINT, `COL0` STRING, `COL1` STRING\"}},\n{\"row\":{\"columns\":[10,A,B]}},\n{\"row\":{\"columns\":[20,E,F]}},\n{\"row\":{\"columns\":[10,null,null],\"tombstone\":true}},\n{\"row\":{\"columns\":[11,X,Y]}}\n\nNote how a row can now be flagged as a tombstone.  Such rows will have all non-key columns set to null, (which may be all columns if no key columns are in the projection).\nNOTE: the old websocket query api is yet to be updated to support tombstones: #6439, and the same goes for the new client API: #6438\nTesting done\nusual\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-10-19T16:13:31Z", "url": "https://github.com/confluentinc/ksql/pull/6462", "merged": true, "mergeCommit": {"oid": "ef3039a078b7814efd5bdec932af4a42ba11ee71"}, "closed": true, "closedAt": "2020-11-03T13:58:13Z", "author": {"login": "big-andy-coates"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUGig7gH2gAyNTA2MTAyMzc5OjQ0NjJhNmRjNTJiMTIwYjg4ZGEyZmQ1ZTU5YTA1ZTljYWEyYjY2NGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYnScwAH2gAyNTA2MTAyMzc5OjJlMDBhNTdkMDRjNzM1OTFkYjEyYWFlMmY0ODBhNTQ4MDVjNWYxZWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4462a6dc52b120b88da2fd5e59a05e9caa2b664f", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/4462a6dc52b120b88da2fd5e59a05e9caa2b664f", "committedDate": "2020-10-19T16:12:51Z", "message": "feat: cli to show tombstones in transient query output\n\nfixes: https://github.com/confluentinc/ksql/issues/3616\n\nThe output from transient queries that return tables will now include tombstones when run in the CLI or using the REST API directly.\n\nTombstones indicate an existing row has been deleted.\n\nCLI output now looks like:\n\n```\nksql> SELECT * FROM SOME_TABLE EMIT CHANGES;\n\n|  ID   |   COL0      |   COL1      |\n+-------+-------------+-------------+\n| 10    | A           | B           |\n| 20    | E           | F           |\n| 10    | <TOMBSTONE> | <TOMBSTONE> | <-- previous row '10' has been deleted.\n| 11    | X           | Y           |\n```\n\nTo facilitate this, the response from the rest api needed to change.  The query response includes a single `header`, followed by `row`'s of data. Previously, this looked like:\n\n```\n{\"header\":{\"queryId\":\"X\",\"schema\":\"`ID` BIGINT, `COL0` STRING, `COL1` STRING\"}},\n{\"row\":{\"columns\":[10,A,B]}},\n{\"row\":{\"columns\":[20,E,F]}},\n{\"row\":{\"columns\":[11,X,Y]}},\n```\n\nFor queries returning table rows, the result now looks like:\n\n```\n{\"header\":{\"queryId\":\"X\",\"key\":\"`ID` BIGINT\",\"schema\":\"`ID` BIGINT, `COL0` STRING, `COL1` STRING\"}},\n{\"row\":{\"key\":[10],\"columns\":[10,A,B]}},\n{\"row\":{\"key\":[20],\"columns\":[20,E,F]}},\n{\"row\":{\"key\":[10],\"tombstone\":true}},\n{\"row\":{\"key\":[11],\"columns\":[11,X,Y]}}\n```\n\nNote the addition of:\n* the `key` field in the `header`: this provides the schema of the primary key of the table,\n* the `key` field in each `row`: this provides the primary key of the row\n* the `tombstone` field of `row`. This is only set when the row is a tombstone.\n\nNote, it is possible that the query itself does not return the columns that make up the primary key of the table:\n\n```\nksql> SELECT COL0, COL1 FROM SOME_TABLE EMIT CHANGES;\n\n|   COL0      |   COL1      |\n+-------------+-------------+\n| A           | B           |\n| E           | F           |\n| <TOMBSTONE> | <TOMBSTONE> | <-- previous row deleted\n| X           | Y           |\n```\n\nThough of course, without including the key columns in the projection, its hard to tell which row has been deleted.\n\nThe API response would look like:\n\n```\n{\"header\":{\"queryId\":\"X\",\"key\":\"`ID` BIGINT\",\"schema\":\"`COL0` STRING, `COL1` STRING\"}},\n{\"row\":{\"key\":[10],\"columns\":[A,B]}},\n{\"row\":{\"key\":[20],\"columns\":[E,F]}},\n{\"row\":{\"key\":[10],\"tombstone\":true}},\n{\"row\":{\"key\":[11],\"columns\":[X,Y]}}\n```\n\nAs the change may break users of the API, the media type version has been bumped:\n\n* `application/vnd.ksql.v1+json`: works as before. No `key` or `tombstone` fields. Tombstones filters from output.\n* `application/vnd.ksql.v2+json`: new, and the new default, contains new fields and includes tombstones.\n\nUsers are recommended to use the version specific media types. Anyone using `application/json` will see a change in the response content."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/0bb5d6a63c0252afa5ef03f17f14c479d11138a8", "committedDate": "2020-10-19T16:19:53Z", "message": "chore: merge from master\n\nConflicting files\nksqldb-engine/src/main/java/io/confluent/ksql/query/QueryExecutor.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "608e3b754ad2978d9e28dd15411412c0ab990425", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/608e3b754ad2978d9e28dd15411412c0ab990425", "committedDate": "2020-10-19T16:29:06Z", "message": "test: include missing test update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMDMyMzU5", "url": "https://github.com/confluentinc/ksql/pull/6462#pullrequestreview-512032359", "createdAt": "2020-10-19T18:10:34Z", "commit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxODoxMDozNFrOHkblpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxODoxMDozNFrOHkblpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk2Mjc4OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Where the result of the query is a stream, the response will not include the **row.key** or\n          \n          \n            \n            If the query result is a stream, the response doesn't include the **row.key** or", "url": "https://github.com/confluentinc/ksql/pull/6462#discussion_r507962788", "createdAt": "2020-10-19T18:10:34Z", "author": {"login": "JimGalasyn"}, "path": "docs/developer-guide/ksqldb-rest-api/query-endpoint.md", "diffHunk": "@@ -62,15 +82,40 @@ Content-Type: application/vnd.ksql.v1+json\n }\r\n ```\r\n \r\n-### Example response\r\n+### Example stream response\r\n+\r\n+Where the result of the query is a stream, the response will not include the **row.key** or\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMDMyODMz", "url": "https://github.com/confluentinc/ksql/pull/6462#pullrequestreview-512032833", "createdAt": "2020-10-19T18:11:09Z", "commit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxODoxMTowOVrOHkbnIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxODoxMTowOVrOHkbnIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk2MzE2OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            **row.tombstone** fields, as streams do not have primary keys.\n          \n          \n            \n            **row.tombstone** fields, because streams don't have primary keys.", "url": "https://github.com/confluentinc/ksql/pull/6462#discussion_r507963169", "createdAt": "2020-10-19T18:11:09Z", "author": {"login": "JimGalasyn"}, "path": "docs/developer-guide/ksqldb-rest-api/query-endpoint.md", "diffHunk": "@@ -62,15 +82,40 @@ Content-Type: application/vnd.ksql.v1+json\n }\r\n ```\r\n \r\n-### Example response\r\n+### Example stream response\r\n+\r\n+Where the result of the query is a stream, the response will not include the **row.key** or\r\n+**row.tombstone** fields, as streams do not have primary keys.\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMDMzNTEz", "url": "https://github.com/confluentinc/ksql/pull/6462#pullrequestreview-512033513", "createdAt": "2020-10-19T18:12:03Z", "commit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxODoxMjowM1rOHkbpGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxODoxMjowM1rOHkbpGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk2MzY3NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Where the result of the query is a table, the response will include the primary key of each row in \n          \n          \n            \n            If the query result is a table, the response includes the primary key of each row in", "url": "https://github.com/confluentinc/ksql/pull/6462#discussion_r507963675", "createdAt": "2020-10-19T18:12:03Z", "author": {"login": "JimGalasyn"}, "path": "docs/developer-guide/ksqldb-rest-api/query-endpoint.md", "diffHunk": "@@ -62,15 +82,40 @@ Content-Type: application/vnd.ksql.v1+json\n }\r\n ```\r\n \r\n-### Example response\r\n+### Example stream response\r\n+\r\n+Where the result of the query is a stream, the response will not include the **row.key** or\r\n+**row.tombstone** fields, as streams do not have primary keys.\r\n+\r\n+```http\r\n+HTTP/1.1 200 OK\r\n+Content-Type: application/vnd.ksql.v2+json\r\n+Transfer-Encoding: chunked\r\n+\r\n+...\r\n+{\"header\":{\"queryId\":\"_confluent_id_19\",schema\":\"`ROWTIME` BIGINT, `NAME` STRING, `AGE` INT\"}}\r\n+{\"row\":{\"columns\":[1524760769983,\"1\",1524760769747,\"alice\",\"home\"]}}\r\n+...\r\n+```\r\n+\r\n+### Example table response\r\n+\r\n+Where the result of the query is a table, the response will include the primary key of each row in \r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMDM0MjI1", "url": "https://github.com/confluentinc/ksql/pull/6462#pullrequestreview-512034225", "createdAt": "2020-10-19T18:13:02Z", "commit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxODoxMzowMlrOHkbrPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxODoxMzowMlrOHkbrPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk2NDIyMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            the **row.key** field. Deletes from the result table will be identified by the **row.tombstone** \n          \n          \n            \n            the **row.key** field. Rows that are deleted from the result table are identified by the **row.tombstone**", "url": "https://github.com/confluentinc/ksql/pull/6462#discussion_r507964223", "createdAt": "2020-10-19T18:13:02Z", "author": {"login": "JimGalasyn"}, "path": "docs/developer-guide/ksqldb-rest-api/query-endpoint.md", "diffHunk": "@@ -62,15 +82,40 @@ Content-Type: application/vnd.ksql.v1+json\n }\r\n ```\r\n \r\n-### Example response\r\n+### Example stream response\r\n+\r\n+Where the result of the query is a stream, the response will not include the **row.key** or\r\n+**row.tombstone** fields, as streams do not have primary keys.\r\n+\r\n+```http\r\n+HTTP/1.1 200 OK\r\n+Content-Type: application/vnd.ksql.v2+json\r\n+Transfer-Encoding: chunked\r\n+\r\n+...\r\n+{\"header\":{\"queryId\":\"_confluent_id_19\",schema\":\"`ROWTIME` BIGINT, `NAME` STRING, `AGE` INT\"}}\r\n+{\"row\":{\"columns\":[1524760769983,\"1\",1524760769747,\"alice\",\"home\"]}}\r\n+...\r\n+```\r\n+\r\n+### Example table response\r\n+\r\n+Where the result of the query is a table, the response will include the primary key of each row in \r\n+the **row.key** field. Deletes from the result table will be identified by the **row.tombstone** \r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8"}, "originalPosition": 78}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMDM1NzEw", "url": "https://github.com/confluentinc/ksql/pull/6462#pullrequestreview-512035710", "createdAt": "2020-10-19T18:14:51Z", "commit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxODoxNDo1MVrOHkbvtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxODoxNDo1MVrOHkbvtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzk2NTM2Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Note: media type `application/vnd.ksql.v1+json` does not populate **row.key** or return tombstone\n          \n          \n            \n            !!! note\n          \n          \n            \n                Media type `application/vnd.ksql.v1+json` does not populate **row.key** or return tombstone", "url": "https://github.com/confluentinc/ksql/pull/6462#discussion_r507965366", "createdAt": "2020-10-19T18:14:51Z", "author": {"login": "JimGalasyn"}, "path": "docs/developer-guide/ksqldb-rest-api/query-endpoint.md", "diffHunk": "@@ -62,15 +82,40 @@ Content-Type: application/vnd.ksql.v1+json\n }\r\n ```\r\n \r\n-### Example response\r\n+### Example stream response\r\n+\r\n+Where the result of the query is a stream, the response will not include the **row.key** or\r\n+**row.tombstone** fields, as streams do not have primary keys.\r\n+\r\n+```http\r\n+HTTP/1.1 200 OK\r\n+Content-Type: application/vnd.ksql.v2+json\r\n+Transfer-Encoding: chunked\r\n+\r\n+...\r\n+{\"header\":{\"queryId\":\"_confluent_id_19\",schema\":\"`ROWTIME` BIGINT, `NAME` STRING, `AGE` INT\"}}\r\n+{\"row\":{\"columns\":[1524760769983,\"1\",1524760769747,\"alice\",\"home\"]}}\r\n+...\r\n+```\r\n+\r\n+### Example table response\r\n+\r\n+Where the result of the query is a table, the response will include the primary key of each row in \r\n+the **row.key** field. Deletes from the result table will be identified by the **row.tombstone** \r\n+field.\r\n \r\n ```http\r\n HTTP/1.1 200 OK\r\n-Content-Type: application/vnd.ksql.v1+json\r\n+Content-Type: application/vnd.ksql.v2+json\r\n Transfer-Encoding: chunked\r\n \r\n ...\r\n-{\"row\":{\"columns\":[1524760769983,\"1\",1524760769747,\"alice\",\"home\"]},\"errorMessage\":null}\r\n+{\"header\":{\"queryId\":\"_confluent_id_34\",key\":\"`ID BIGINT`\",schema\":\"`ROWTIME` BIGINT, `NAME` STRING, `AGE` INT\"}}\r\n+{\"row\":{\"key\":[10],\"columns\":[1524760769983,\"alice\",10]}},\r\n+{\"row\":{\"key\":[10],\"tombstone\":true}}\r\n ...\r\n ```\r\n \r\n+Note: media type `application/vnd.ksql.v1+json` does not populate **row.key** or return tombstone\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8"}, "originalPosition": 95}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMDM2Mzg1", "url": "https://github.com/confluentinc/ksql/pull/6462#pullrequestreview-512036385", "createdAt": "2020-10-19T18:15:41Z", "commit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMzc0MzI3", "url": "https://github.com/confluentinc/ksql/pull/6462#pullrequestreview-512374327", "createdAt": "2020-10-20T06:41:43Z", "commit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8"}, "state": "APPROVED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwNjo0MTo0M1rOHks0eQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwNjo0Nzo0M1rOHks_ZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI0NTExMw==", "bodyText": "Why not directly return boolean?", "url": "https://github.com/confluentinc/ksql/pull/6462#discussion_r508245113", "createdAt": "2020-10-20T06:41:43Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-model/src/main/java/io/confluent/ksql/rest/entity/StreamedRow.java", "diffHunk": "@@ -218,21 +368,80 @@ public boolean equals(final Object o) {\n       }\n       final Header header = (Header) o;\n       return Objects.equals(queryId, header.queryId)\n-          && Objects.equals(schema, header.schema);\n+          && Objects.equals(keySchema, header.keySchema)\n+          && Objects.equals(columnsSchema, header.columnsSchema);\n     }\n \n     @Override\n     public int hashCode() {\n-      return Objects.hash(queryId, schema);\n+      return Objects.hash(queryId, keySchema, columnsSchema);\n+    }\n+  }\n+\n+  @JsonInclude(Include.NON_EMPTY)\n+  @JsonIgnoreProperties(ignoreUnknown = true)\n+  public static final class DataRow extends BaseRow {\n+\n+    @EffectivelyImmutable\n+    private final Optional<List<?>> key;\n+    @EffectivelyImmutable\n+    private final Optional<List<?>> columns;\n+\n+    public static DataRow row(\n+        final Optional<List<?>> key,\n+        final List<?> columns\n+    ) {\n+      return new DataRow(key, Optional.of(columns));\n+    }\n+\n+    public static DataRow tombstone(\n+        final List<?> key\n+    ) {\n+      return new DataRow(Optional.of(key), Optional.empty());\n+    }\n+\n+\n+    public Optional<List<?>> getKey() {\n+      return key;\n+    }\n+\n+    public Optional<List<?>> getColumns() {\n+      return columns;\n+    }\n+\n+    public Optional<Boolean> getTombstone() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8"}, "originalPosition": 336}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI0NTI3MQ==", "bodyText": "This should be marked as new as of v2.", "url": "https://github.com/confluentinc/ksql/pull/6462#discussion_r508245271", "createdAt": "2020-10-20T06:41:59Z", "author": {"login": "vcrfxia"}, "path": "docs/developer-guide/ksqldb-rest-api/query-endpoint.md", "diffHunk": "@@ -28,18 +28,38 @@ Each response chunk is a JSON object with the following format:\n \r\n Response JSON Object:\r\n \r\n+- **header** (object): Information about the result.\r\n+    - **header.queryId**: (string): the unique id of the query. This can be useful when debugging. \r\n+    For example, when looking in the logs or processing log for errors or issues.\r\n+    - **header.key**: (string)(since v2): the list of key columns, if the result is a table. \r\n+    This defines the schema for the data returned later in **row.key**. \r\n+    - **header.schema**: (string): the list of columns being returned. This defines the schema for \r\n+    the data returned later in **row.columns**.  \r\n - **row** (object): A single row being returned. This will be null if an error is being returned.\r\n-- **row.columns** (array): The values contained in the row.\r\n-- **row.columns[i]** (?): The value contained in a single column for the row. The value type depends on the type of the column.\r\n-- **finalMessage** (string): If this field is non-null, it contains a final message from the server. No additional rows will be returned and the server will end the response.\r\n-- **errorMessage** (string): If this field is non-null, an error has been encountered while running the statement. No additional rows are returned and the server will end the response.\r\n+    - **row.key** (array): If the data being returned is a table, the primary key of the row.\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI0NTQ4NA==", "bodyText": "Looks like something was meant to be here but was forgotten. Perhaps check that <TOMBSTONE> is present?", "url": "https://github.com/confluentinc/ksql/pull/6462#discussion_r508245484", "createdAt": "2020-10-20T06:42:31Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-cli/src/test/java/io/confluent/ksql/cli/console/ConsoleTest.java", "diffHunk": "@@ -187,24 +187,58 @@ public void after() {\n   }\n \n   @Test\n-  public void testPrintGenericStreamedRow() {\n+  public void testPrintStreamRow() {\n     // Given:\n-    final StreamedRow row = StreamedRow.row(genericRow(\"col_1\", \"col_2\"));\n+    final StreamedRow row = StreamedRow.streamRow(genericRow(\"col_1\", \"col_2\"));\n \n     // When:\n     console.printStreamedRow(row);\n \n     // Then:\n+    assertThat(terminal.getOutputString(), containsString(\"col_1\"));\n+    assertThat(terminal.getOutputString(), containsString(\"col_2\"));\n+  }\n+\n+  @Test\n+  public void testPrintTableRow() {\n+    // Given:\n+    final StreamedRow row = StreamedRow.tableRow(ImmutableList.of(\"k_0\"), genericRow(\"col_1\", \"col_2\"));\n+\n+    // When:\n+    console.printStreamedRow(row);\n+\n+    // Then:\n+    if (console.getOutputFormat() != OutputFormat.TABULAR) {\n+      assertThat(terminal.getOutputString(), containsString(\"k_0\"));\n+    }\n+    assertThat(terminal.getOutputString(), containsString(\"col_1\"));\n+    assertThat(terminal.getOutputString(), containsString(\"col_2\"));\n+  }\n+\n+  @Test\n+  public void testPrintTableTombstone() {\n+    // Given:\n+    console.printStreamedRow(StreamedRow.pushHeader(new QueryId(\"id\"), SCHEMA.key(), SCHEMA.value()));\n+\n+    final StreamedRow row = StreamedRow.tombstone(ImmutableList.of(\"k_0\"));\n+\n+    // When:\n+    console.printStreamedRow(row);\n+\n+    // Then:\n+    assertThat(terminal.getOutputString(), containsString(\"k_0\"));\n+\n     if (console.getOutputFormat() == OutputFormat.TABULAR) {\n-      assertThat(terminal.getOutputString(), containsString(\"col_1\"));\n-      assertThat(terminal.getOutputString(), containsString(\"col_2\"));\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI0NTg2NA==", "bodyText": "To check my understanding: the reason this PR adds window info into the output node is so the window info can be printed as part of the key?", "url": "https://github.com/confluentinc/ksql/pull/6462#discussion_r508245864", "createdAt": "2020-10-20T06:43:23Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/planner/plan/KsqlBareOutputNode.java", "diffHunk": "@@ -15,25 +15,32 @@\n \n package io.confluent.ksql.planner.plan;\n \n+import static java.util.Objects.requireNonNull;\n+\n import io.confluent.ksql.execution.builder.KsqlQueryBuilder;\n import io.confluent.ksql.execution.timestamp.TimestampColumn;\n import io.confluent.ksql.name.SourceName;\n import io.confluent.ksql.schema.ksql.LogicalSchema;\n+import io.confluent.ksql.serde.WindowInfo;\n import io.confluent.ksql.structured.SchemaKStream;\n import java.util.Optional;\n import java.util.OptionalInt;\n \n @SuppressWarnings(\"OptionalUsedAsFieldOrParameterType\")\n public class KsqlBareOutputNode extends OutputNode {\n \n+  private final Optional<WindowInfo> windowInfo;\n+\n   public KsqlBareOutputNode(\n       final PlanNodeId id,\n       final PlanNode source,\n       final LogicalSchema schema,\n       final OptionalInt limit,\n-      final Optional<TimestampColumn> timestampColumn\n+      final Optional<TimestampColumn> timestampColumn,\n+      final Optional<WindowInfo> windowInfo", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI0NTk3MQ==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  throw new IllegalArgumentException(\"None struct key: \" + key);\n          \n          \n            \n                  throw new IllegalArgumentException(\"Non struct key: \" + key);", "url": "https://github.com/confluentinc/ksql/pull/6462#discussion_r508245971", "createdAt": "2020-10-20T06:43:37Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/util/StructKeyUtil.java", "diffHunk": "@@ -55,6 +58,40 @@ public static KeyBuilder keyBuilder(final ColumnName name, final SqlType type) {\n     );\n   }\n \n+  @SuppressWarnings(\"unchecked\")\n+  public static List<?> asList(final Object key) {\n+    final Optional<Windowed<Object>> windowed = key instanceof Windowed\n+        ? Optional.of((Windowed<Object>) key)\n+        : Optional.empty();\n+\n+    final Object naturalKey = windowed\n+        .map(Windowed::key)\n+        .orElse(key);\n+\n+    if (naturalKey != null && !(naturalKey instanceof Struct)) {\n+      throw new IllegalArgumentException(\"None struct key: \" + key);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI0NjgwMw==", "bodyText": "How come we use List<?> for the key type and GenericRow for the value type throughout this PR? Isn't GenericRow essentially just a wrapper around List<?>? Wondering what motivates the inconsistency here.", "url": "https://github.com/confluentinc/ksql/pull/6462#discussion_r508246803", "createdAt": "2020-10-20T06:45:15Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/spi/QueryPublisher.java", "diffHunk": "@@ -24,7 +25,7 @@\n  * query that is executed. A subscriber from the API implementation then subscribes to it, then a\n  * stream of query results flows from back-end to front-end where they are written to the wire.\n  */\n-public interface QueryPublisher extends Publisher<GenericRow> {\n+public interface QueryPublisher extends Publisher<KeyValue<List<?>, GenericRow>> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI0NjkzNw==", "bodyText": "nit: can we rename this to something more meaningful?", "url": "https://github.com/confluentinc/ksql/pull/6462#discussion_r508246937", "createdAt": "2020-10-20T06:45:32Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/resources/streaming/QueryStreamWriter.java", "diffHunk": "@@ -54,11 +61,13 @@\n       final TransientQueryMetadata queryMetadata,\n       final long disconnectCheckInterval,\n       final ObjectMapper objectMapper,\n-      final CompletableFuture<Void> connectionClosedFuture\n+      final CompletableFuture<Void> connectionClosedFuture,\n+      final boolean oldFormat", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI0NzQ5NQ==", "bodyText": "I'm a bit confused about what media types are accepted for the websocket endpoint. Is only v1 accepted, or is v2 also accepted but v2 functions the same as v1? I thought the former but I don't see any check here to fail on v2.", "url": "https://github.com/confluentinc/ksql/pull/6462#discussion_r508247495", "createdAt": "2020-10-20T06:46:46Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/resources/streaming/WSQueryEndpoint.java", "diffHunk": "@@ -217,16 +217,16 @@ public void executeStreamQuery(final ServerWebSocket webSocket, final MultiMap r\n     }\n   }\n \n-  private void validateVersion(final MultiMap requestParams) {\n-\n-    final String version = requestParams.get(Versions.KSQL_V1_WS_PARAM);\n-\n+  private static void validateVersion(final MultiMap requestParams) {\n+    final String version = requestParams.get(\"version\");\n     if (version == null) {\n       return;\n     }\n \n-    if (!Versions.KSQL_V1_WS.equals(version)) {\n-      throw new IllegalArgumentException(\"Received invalid api version: \" + version);\n+    try {\n+      KsqlMediaType.valueOf(\"JSON\", Integer.parseInt(version));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI0NzkwOA==", "bodyText": "Read this a few times but I'm still not understanding this comment. (The two lines below make sense but I can't parse Type used Logical Schema to serialize key columns. in a meaningful way.)", "url": "https://github.com/confluentinc/ksql/pull/6462#discussion_r508247908", "createdAt": "2020-10-20T06:47:43Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-model/src/main/java/io/confluent/ksql/rest/entity/StreamedRow.java", "diffHunk": "@@ -181,31 +269,93 @@ private static void checkUnion(final Optional<?>... fs) {\n   }\n \n   @Immutable\n+  public abstract static class BaseRow {\n+\n+    @Override\n+    public String toString() {\n+      try {\n+        return OBJECT_MAPPER.writeValueAsString(this);\n+      } catch (final JsonProcessingException e) {\n+        return super.toString();\n+      }\n+    }\n+  }\n+\n+  // Note: Type used `LogicalSchema` as a cheeky way of (de)serializing lists of columns.\n+  @JsonInclude(Include.NON_EMPTY)\n   @JsonIgnoreProperties(ignoreUnknown = true)\n-  public static final class Header {\n+  public static final class Header extends BaseRow {\n \n     private final QueryId queryId;\n-    private final LogicalSchema schema;\n+    private final Optional<ImmutableList<SimpleColumn>> keySchema;\n+    private final LogicalSchema columnsSchema;\n \n-    @JsonCreator\n     public static Header of(\n-        @JsonProperty(value = \"queryId\", required = true) final QueryId queryId,\n-        @JsonProperty(value = \"schema\", required = true) final LogicalSchema schema\n+        final QueryId queryId,\n+        final Optional<List<? extends SimpleColumn>> key,\n+        final LogicalSchema columnsSchema\n     ) {\n-      return new Header(queryId, schema);\n+      final Optional<List<? extends SimpleColumn>> keySchema = key\n+          .map(k -> LogicalSchema.builder().valueColumns(k).build())\n+          .map(LogicalSchema::columns);\n+\n+      return new Header(queryId, keySchema, columnsSchema);\n     }\n \n     public QueryId getQueryId() {\n       return queryId;\n     }\n \n-    public LogicalSchema getSchema() {\n-      return schema;\n+    /**\n+     * Used for push queries to return the schema of the key columns.\n+     *\n+     * <p>Note: The columns that make up the key may or may not be present in the projection, i.e.\n+     * in the {@link #getColumnsSchema()}.\n+     *\n+     * @return the columns that make up the key.\n+     */\n+    @JsonIgnore\n+    public Optional<List<SimpleColumn>> getKeySchema() {\n+      return keySchema.map(v -> v);\n     }\n \n-    private Header(final QueryId queryId, final LogicalSchema schema) {\n+    /**\n+     * @return The schema of the columns being returned by the query.\n+     */\n+    @JsonProperty(\"schema\")\n+    public LogicalSchema getColumnsSchema() {\n+      return columnsSchema;\n+    }\n+\n+    @JsonProperty(\"key\")\n+    @SuppressWarnings(\"unused\") // Invoked by reflection by Jackson.\n+    private Optional<LogicalSchema> getSerializedKeySchema() {\n+      // Type used Logical Schema to serialize key columns.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bb5d6a63c0252afa5ef03f17f14c479d11138a8"}, "originalPosition": 259}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24c4ece73fe53957ef2dc5e7d596e7c252fdbe83", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/24c4ece73fe53957ef2dc5e7d596e7c252fdbe83", "committedDate": "2020-10-20T18:50:27Z", "message": "Update docs/developer-guide/ksqldb-rest-api/query-endpoint.md\n\nCo-authored-by: Jim Galasyn <jim.galasyn@confluent.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f24146939275086b2f78b5c6231bdf382017fcea", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/f24146939275086b2f78b5c6231bdf382017fcea", "committedDate": "2020-10-20T18:50:35Z", "message": "Update docs/developer-guide/ksqldb-rest-api/query-endpoint.md\n\nCo-authored-by: Jim Galasyn <jim.galasyn@confluent.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3742c2208f8d3f965c7edbe4e3af25f76267feed", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/3742c2208f8d3f965c7edbe4e3af25f76267feed", "committedDate": "2020-10-20T18:50:42Z", "message": "Update docs/developer-guide/ksqldb-rest-api/query-endpoint.md\n\nCo-authored-by: Jim Galasyn <jim.galasyn@confluent.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3736e68120032abedcc2dac49fd2488e7da658f7", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/3736e68120032abedcc2dac49fd2488e7da658f7", "committedDate": "2020-10-20T18:50:49Z", "message": "Update docs/developer-guide/ksqldb-rest-api/query-endpoint.md\n\nCo-authored-by: Jim Galasyn <jim.galasyn@confluent.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fc7b6426546f6a9e52976679eab86987f0ec0fc", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/1fc7b6426546f6a9e52976679eab86987f0ec0fc", "committedDate": "2020-10-20T18:50:56Z", "message": "Update docs/developer-guide/ksqldb-rest-api/query-endpoint.md\n\nCo-authored-by: Jim Galasyn <jim.galasyn@confluent.io>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb7bd501431930bfc429fbee0702b931edeb9ee1", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/cb7bd501431930bfc429fbee0702b931edeb9ee1", "committedDate": "2020-10-20T18:51:59Z", "message": "Merge branch 'cli_tombstones' of github.com:big-andy-coates/ksql into cli_tombstones"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d8600b05bb8016992104ded0a17f9d53925a36c", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/0d8600b05bb8016992104ded0a17f9d53925a36c", "committedDate": "2020-10-20T18:59:32Z", "message": "chore: merge from master\n\nConflicting files\nksqldb-engine/src/test/java/io/confluent/ksql/util/TestDataProvider.java\nksqldb-rest-app/src/test/java/io/confluent/ksql/rest/integration/RestIntegrationTestUtil.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcd2eeb76427d8de6015e6953b334106519af02a", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/fcd2eeb76427d8de6015e6953b334106519af02a", "committedDate": "2020-10-23T14:20:03Z", "message": "chore: switch approach"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f83e2d6985c9e0bc6f7a2d76d3fd29c59fdf063", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/5f83e2d6985c9e0bc6f7a2d76d3fd29c59fdf063", "committedDate": "2020-10-23T14:30:06Z", "message": "chore: merge from master\n\nConflicting files\nksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/ServerVerticle.java\nksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/resources/streaming/PullQueryPublisher.java\nksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/resources/streaming/StreamedQueryResource.java\nksqldb-rest-app/src/test/java/io/confluent/ksql/rest/integration/RestApiTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02e253da6cf96f749f948c48660dad99994eb315", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/02e253da6cf96f749f948c48660dad99994eb315", "committedDate": "2020-10-23T14:58:48Z", "message": "chore: revert some noise and fix some things"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2579a03f81538e327e2763bd62910359ee73965", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/a2579a03f81538e327e2763bd62910359ee73965", "committedDate": "2020-10-23T15:52:45Z", "message": "chore: fix some tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df87e14ffdf1ad9055afe403ae5bb1a48e78d6a7", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/df87e14ffdf1ad9055afe403ae5bb1a48e78d6a7", "committedDate": "2020-10-23T16:46:38Z", "message": "chore: fix some tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1ODY2ODg0", "url": "https://github.com/confluentinc/ksql/pull/6462#pullrequestreview-515866884", "createdAt": "2020-10-23T17:27:12Z", "commit": {"oid": "df87e14ffdf1ad9055afe403ae5bb1a48e78d6a7"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NDY4MzE5", "url": "https://github.com/confluentinc/ksql/pull/6462#pullrequestreview-516468319", "createdAt": "2020-10-26T04:56:26Z", "commit": {"oid": "df87e14ffdf1ad9055afe403ae5bb1a48e78d6a7"}, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNDo1NjoyNlrOHoA5ZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNToxMToyNFrOHoBEgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcxOTc4MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                - **row.tombstone** (boolean): the row is a deletion of a previously row.\n          \n          \n            \n                - **row.tombstone** (boolean): Whether the row is a deletion of a previous row.", "url": "https://github.com/confluentinc/ksql/pull/6462#discussion_r511719781", "createdAt": "2020-10-26T04:56:26Z", "author": {"login": "vcrfxia"}, "path": "docs/developer-guide/ksqldb-rest-api/query-endpoint.md", "diffHunk": "@@ -28,18 +28,32 @@ Each response chunk is a JSON object with the following format:\n \r\n Response JSON Object:\r\n \r\n+- **header** (object): Information about the result.\r\n+    - **header.queryId**: (string): the unique id of the query. This can be useful when debugging. \r\n+    For example, when looking in the logs or processing log for errors or issues.\r\n+    - **header.schema**: (string): the list of columns being returned. This defines the schema for \r\n+    the data returned later in **row.columns**.  \r\n - **row** (object): A single row being returned. This will be null if an error is being returned.\r\n-- **row.columns** (array): The values contained in the row.\r\n-- **row.columns[i]** (?): The value contained in a single column for the row. The value type depends on the type of the column.\r\n-- **finalMessage** (string): If this field is non-null, it contains a final message from the server. No additional rows will be returned and the server will end the response.\r\n-- **errorMessage** (string): If this field is non-null, an error has been encountered while running the statement. No additional rows are returned and the server will end the response.\r\n+    - **row.columns** (array): The values of the columns requested. The schema of the columns was\r\n+    already supplied in **header.schema**.\r\n+    - **row.tombstone** (boolean): the row is a deletion of a previously row.\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df87e14ffdf1ad9055afe403ae5bb1a48e78d6a7"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcxOTg3Mg==", "bodyText": "This is out of date in the newest version of this PR and should be removed. Same with the sentence below that mentions v2 of the API.", "url": "https://github.com/confluentinc/ksql/pull/6462#discussion_r511719872", "createdAt": "2020-10-26T04:56:56Z", "author": {"login": "vcrfxia"}, "path": "docs/developer-guide/ksqldb-rest-api/query-endpoint.md", "diffHunk": "@@ -28,18 +28,32 @@ Each response chunk is a JSON object with the following format:\n \r\n Response JSON Object:\r\n \r\n+- **header** (object): Information about the result.\r\n+    - **header.queryId**: (string): the unique id of the query. This can be useful when debugging. \r\n+    For example, when looking in the logs or processing log for errors or issues.\r\n+    - **header.schema**: (string): the list of columns being returned. This defines the schema for \r\n+    the data returned later in **row.columns**.  \r\n - **row** (object): A single row being returned. This will be null if an error is being returned.\r\n-- **row.columns** (array): The values contained in the row.\r\n-- **row.columns[i]** (?): The value contained in a single column for the row. The value type depends on the type of the column.\r\n-- **finalMessage** (string): If this field is non-null, it contains a final message from the server. No additional rows will be returned and the server will end the response.\r\n-- **errorMessage** (string): If this field is non-null, an error has been encountered while running the statement. No additional rows are returned and the server will end the response.\r\n+    - **row.columns** (array): The values of the columns requested. The schema of the columns was\r\n+    already supplied in **header.schema**.\r\n+    - **row.tombstone** (boolean): the row is a deletion of a previously row.\r\n+    The **row.key** field contains the unique key of the row that has been deleted.\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df87e14ffdf1ad9055afe403ae5bb1a48e78d6a7"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyMDA5Mw==", "bodyText": "There is no row.key field ever now, right?", "url": "https://github.com/confluentinc/ksql/pull/6462#discussion_r511720093", "createdAt": "2020-10-26T04:58:13Z", "author": {"login": "vcrfxia"}, "path": "docs/developer-guide/ksqldb-rest-api/query-endpoint.md", "diffHunk": "@@ -62,15 +76,40 @@ Content-Type: application/vnd.ksql.v1+json\n }\r\n ```\r\n \r\n-### Example response\r\n+### Example stream response\r\n+\r\n+If the query result is a stream, the response doesn't include the **row.key** or\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df87e14ffdf1ad9055afe403ae5bb1a48e78d6a7"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyMDE4OA==", "bodyText": "There is no row.key field now, right?", "url": "https://github.com/confluentinc/ksql/pull/6462#discussion_r511720188", "createdAt": "2020-10-26T04:58:46Z", "author": {"login": "vcrfxia"}, "path": "docs/developer-guide/ksqldb-rest-api/query-endpoint.md", "diffHunk": "@@ -62,15 +76,40 @@ Content-Type: application/vnd.ksql.v1+json\n }\r\n ```\r\n \r\n-### Example response\r\n+### Example stream response\r\n+\r\n+If the query result is a stream, the response doesn't include the **row.key** or\r\n+\r\n+**row.tombstone** fields, because streams don't have primary keys.\r\n+\r\n \r\n ```http\r\n HTTP/1.1 200 OK\r\n Content-Type: application/vnd.ksql.v1+json\r\n Transfer-Encoding: chunked\r\n \r\n ...\r\n-{\"row\":{\"columns\":[1524760769983,\"1\",1524760769747,\"alice\",\"home\"]},\"errorMessage\":null}\r\n+{\"header\":{\"queryId\":\"_confluent_id_19\",schema\":\"`ROWTIME` BIGINT, `NAME` STRING, `AGE` INT\"}}\r\n+{\"row\":{\"columns\":[1524760769983,\"1\",1524760769747,\"alice\",\"home\"]}}\r\n ...\r\n ```\r\n \r\n+### Example table response\r\n+\r\n+If the query result is a table, the response includes the primary key of each row in\r\n+\r\n+the **row.key** field. Rows that are deleted from the result table are identified by the **row.tombstone** \r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df87e14ffdf1ad9055afe403ae5bb1a48e78d6a7"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyMTMwNQ==", "bodyText": "This comment is out of date.", "url": "https://github.com/confluentinc/ksql/pull/6462#discussion_r511721305", "createdAt": "2020-10-26T05:04:36Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/api/server/ServerVerticle.java", "diffHunk": "@@ -147,62 +148,63 @@ private Router setupRouter() {\n     // ----------------------------------------------\n \n     router.route(HttpMethod.GET, \"/\")\n-        .handler(this::handleInfoRedirect);\n+        .handler(ServerVerticle::handleInfoRedirect);\n     router.route(HttpMethod.POST, \"/ksql\")\n         .handler(BodyHandler.create())\n-        .produces(Versions.KSQL_V1_JSON)\n+        .produces(KsqlMediaType.KSQL_V1_JSON.mediaType())\n         .produces(JSON_CONTENT_TYPE)\n         .handler(this::handleKsqlRequest);\n     router.route(HttpMethod.POST, \"/ksql/terminate\")\n         .handler(BodyHandler.create())\n-        .produces(Versions.KSQL_V1_JSON)\n+        .produces(KsqlMediaType.KSQL_V1_JSON.mediaType())\n         .produces(JSON_CONTENT_TYPE)\n         .handler(this::handleTerminateRequest);\n     router.route(HttpMethod.POST, \"/query\")\n         .handler(BodyHandler.create())\n-        .produces(Versions.KSQL_V1_JSON)\n+        .produces(KsqlMediaType.KSQL_V1_JSON.mediaType())\n         .produces(JSON_CONTENT_TYPE)\n         .handler(this::handleQueryRequest);\n     router.route(HttpMethod.GET, \"/info\")\n-        .produces(Versions.KSQL_V1_JSON)\n+        .produces(KsqlMediaType.KSQL_V1_JSON.mediaType())\n         .produces(JSON_CONTENT_TYPE)\n         .handler(this::handleInfoRequest);\n     router.route(HttpMethod.POST, \"/heartbeat\")\n         .handler(BodyHandler.create())\n-        .produces(Versions.KSQL_V1_JSON)\n+        .produces(KsqlMediaType.KSQL_V1_JSON.mediaType())\n         .produces(JSON_CONTENT_TYPE)\n         .handler(this::handleHeartbeatRequest);\n     router.route(HttpMethod.GET, \"/clusterStatus\")\n-        .produces(Versions.KSQL_V1_JSON)\n+        .produces(KsqlMediaType.KSQL_V1_JSON.mediaType())\n         .produces(JSON_CONTENT_TYPE)\n         .handler(this::handleClusterStatusRequest);\n     router.route(HttpMethod.GET, \"/status/:type/:entity/:action\")\n-        .produces(Versions.KSQL_V1_JSON)\n+        .produces(KsqlMediaType.KSQL_V1_JSON.mediaType())\n         .produces(JSON_CONTENT_TYPE)\n         .handler(this::handleStatusRequest);\n     router.route(HttpMethod.GET, \"/status\")\n-        .produces(Versions.KSQL_V1_JSON)\n+        .produces(KsqlMediaType.KSQL_V1_JSON.mediaType())\n         .produces(JSON_CONTENT_TYPE)\n         .handler(this::handleAllStatusesRequest);\n     router.route(HttpMethod.POST, \"/lag\")\n         .handler(BodyHandler.create())\n-        .produces(Versions.KSQL_V1_JSON)\n+        .produces(KsqlMediaType.KSQL_V1_JSON.mediaType())\n         .produces(JSON_CONTENT_TYPE)\n         .handler(this::handleLagReportRequest);\n     router.route(HttpMethod.GET, \"/healthcheck\")\n-        .produces(Versions.KSQL_V1_JSON)\n+        .produces(KsqlMediaType.KSQL_V1_JSON.mediaType())\n         .produces(JSON_CONTENT_TYPE)\n         .handler(this::handleHealthcheckRequest);\n     router.route(HttpMethod.GET, \"/v1/metadata\")\n-        .produces(Versions.KSQL_V1_JSON)\n+        .produces(KsqlMediaType.KSQL_V1_JSON.mediaType())\n         .produces(JSON_CONTENT_TYPE)\n         .handler(this::handleServerMetadataRequest);\n     router.route(HttpMethod.GET, \"/v1/metadata/id\")\n-        .produces(Versions.KSQL_V1_JSON)\n+        .produces(KsqlMediaType.KSQL_V1_JSON.mediaType())\n         .produces(JSON_CONTENT_TYPE)\n         .handler(this::handleServerMetadataClusterIdRequest);\n     router.route(HttpMethod.GET, \"/ws/query\")\n-        .produces(Versions.KSQL_V1_JSON)\n+        .produces(KsqlMediaType.KSQL_V1_JSON.mediaType())\n+        // No support yet for V2. See https://github.com/confluentinc/ksql/issues/6439.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df87e14ffdf1ad9055afe403ae5bb1a48e78d6a7"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyMjYyNg==", "bodyText": "Now that we're no longer returning the key as part of the API, is there any point in continuing to pipe it in? I'm wondering if these changes can be removed, along with KeyValue and StructKeyUtil#asList.", "url": "https://github.com/confluentinc/ksql/pull/6462#discussion_r511722626", "createdAt": "2020-10-26T05:11:24Z", "author": {"login": "vcrfxia"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/resources/streaming/QueryStreamWriter.java", "diffHunk": "@@ -124,14 +126,22 @@ public synchronized void close() {\n   }\n \n   private StreamedRow buildHeader() {\n+    final QueryId queryId = queryMetadata.getQueryId();\n+\n     // Push queries only return value columns, but query metadata schema includes key and meta:\n     final LogicalSchema storedSchema = queryMetadata.getLogicalSchema();\n \n-    final Builder actualSchemaBuilder = LogicalSchema.builder();\n+    final Builder projectionSchema = LogicalSchema.builder();\n+\n+    storedSchema.value().forEach(projectionSchema::valueColumn);\n \n-    storedSchema.value().forEach(actualSchemaBuilder::valueColumn);\n+    return StreamedRow.header(queryId, projectionSchema.build());\n+  }\n \n-    return StreamedRow.header(NO_QUERY_ID, actualSchemaBuilder.build());\n+  private StreamedRow buildRow(final KeyValue<List<?>, GenericRow> row) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df87e14ffdf1ad9055afe403ae5bb1a48e78d6a7"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea2a0b01b584d76d83c3254ccea37fb9306eb808", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/ea2a0b01b584d76d83c3254ccea37fb9306eb808", "committedDate": "2020-11-02T16:25:12Z", "message": "chore: requested changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e00a57d04c73591db12aae2f480a54805c5f1ee", "author": {"user": {"login": "big-andy-coates", "name": "Andy Coates"}}, "url": "https://github.com/confluentinc/ksql/commit/2e00a57d04c73591db12aae2f480a54805c5f1ee", "committedDate": "2020-11-02T16:37:52Z", "message": "Merge branch 'master' into cli_tombstones"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4580, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}