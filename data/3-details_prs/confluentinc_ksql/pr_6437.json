{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNzE3ODU2", "number": 6437, "title": "fix: Properly clean up state when executing a command fails", "bodyText": "Description\nAttempts to cleanup and state associated with a command id when a transaction for that command fails to commit properly.\nFixes #6340\nTesting done\nRan unit tests\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-10-14T23:56:02Z", "url": "https://github.com/confluentinc/ksql/pull/6437", "merged": true, "mergeCommit": {"oid": "242a32ecef79545436de3ae0b6cc5486a0b3cd95"}, "closed": true, "closedAt": "2020-10-19T18:09:28Z", "author": {"login": "AlanConfluent"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSmI2iAH2gAyNTAzNzE3ODU2OjI3MDdjYTA2MTU1NDYzZjBlZTg0MjhjZWEwYWFlMjJhMWY3NmJlMDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUIBn2AFqTUxMjAyMTM4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2707ca06155463f0ee8428cea0aae22a1f76be04", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/2707ca06155463f0ee8428cea0aae22a1f76be04", "committedDate": "2020-10-14T23:53:56Z", "message": "fix: Properly clean up state when executing a command fails"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4ODcwMTAz", "url": "https://github.com/confluentinc/ksql/pull/6437#pullrequestreview-508870103", "createdAt": "2020-10-15T01:06:54Z", "commit": {"oid": "2707ca06155463f0ee8428cea0aae22a1f76be04"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwMTowNjo1NVrOHhtN2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwMTowNjo1NVrOHhtN2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTEwNTg4MA==", "bodyText": "We could actually call this before the command is registered right? If something throws between generating the command id and enqueueing?", "url": "https://github.com/confluentinc/ksql/pull/6437#discussion_r505105880", "createdAt": "2020-10-15T01:06:55Z", "author": {"login": "rodesai"}, "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/computation/CommandStore.java", "diffHunk": "@@ -303,6 +303,21 @@ public void ensureConsumedPast(final long seqNum, final Duration timeout)\n     );\n   }\n \n+  @Override\n+  public void abortCommand(final CommandId commandId) {\n+    commandStatusMap.compute(\n+        commandId,\n+        (k, v) -> {\n+          if (v == null) {\n+            throw new IllegalStateException(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2707ca06155463f0ee8428cea0aae22a1f76be04"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8964c6ab227636d08acf29a6af41112ddadbeb6", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/b8964c6ab227636d08acf29a6af41112ddadbeb6", "committedDate": "2020-10-16T20:51:17Z", "message": "Dont throw on aborting unknown"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMDIxMzgx", "url": "https://github.com/confluentinc/ksql/pull/6437#pullrequestreview-512021381", "createdAt": "2020-10-19T17:56:44Z", "commit": {"oid": "b8964c6ab227636d08acf29a6af41112ddadbeb6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4632, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}