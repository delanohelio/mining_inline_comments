{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwNTEzMzQy", "number": 4427, "title": "refactor: Changes lag APIs to return Optional, per comments", "bodyText": "Description\nChanges some lag APIs to return Optional rather than nullable values, per discussion here: #4417 (review)\nTesting done\nRan existing tests\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-02-03T20:42:13Z", "url": "https://github.com/confluentinc/ksql/pull/4427", "merged": true, "mergeCommit": {"oid": "02d3e654168e62ad8361feb3af4522cf3ab115b1"}, "closed": true, "closedAt": "2020-02-04T19:43:59Z", "author": {"login": "AlanConfluent"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcA1xElgH2gAyMzcwNTEzMzQyOmI2NDlhZTU0YWZlNGZmMmExOWZkZThkMmZkNGExODBmZjc4OTY0MGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBGCGkAH2gAyMzcwNTEzMzQyOjQ5MDhiNzJlNjE4MWRjYzc1ZTRkOTM2ZWE0ZGJkOThmODMwNjBlODE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b649ae54afe4ff2a19fde8d2fd4a180ff789640e", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/b649ae54afe4ff2a19fde8d2fd4a180ff789640e", "committedDate": "2020-02-03T23:44:39Z", "message": "refactor: Changes lag APIs to return Optional, per comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41f0d6fe7cc2dc481d1f053dc8511710af6d8f7a", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/41f0d6fe7cc2dc481d1f053dc8511710af6d8f7a", "committedDate": "2020-02-03T23:44:39Z", "message": "Simplifies test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c271a0f44c482ca4b9c4858e4ee1b373b6f39540", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/c271a0f44c482ca4b9c4858e4ee1b373b6f39540", "committedDate": "2020-02-03T23:44:39Z", "message": "Additional test simplification"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7ed77e0bbe48b44f64626b14dae1cf69d2e0ae3", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/d7ed77e0bbe48b44f64626b14dae1cf69d2e0ae3", "committedDate": "2020-02-03T23:44:40Z", "message": "Remove unused empty objects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ce99053548ee0a03093d3b0c938c0cd983f45bb", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/4ce99053548ee0a03093d3b0c938c0cd983f45bb", "committedDate": "2020-02-03T23:44:40Z", "message": "Fixes tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9898c3c162a2a624906298c5e15cbcaa0936e832", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/9898c3c162a2a624906298c5e15cbcaa0936e832", "committedDate": "2020-02-03T20:45:06Z", "message": "Remove unused empty objects"}, "afterCommit": {"oid": "4ce99053548ee0a03093d3b0c938c0cd983f45bb", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/4ce99053548ee0a03093d3b0c938c0cd983f45bb", "committedDate": "2020-02-03T23:44:40Z", "message": "Fixes tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdce4832ad55855c4edb06b67f9a397e11513418", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/bdce4832ad55855c4edb06b67f9a397e11513418", "committedDate": "2020-02-04T00:21:55Z", "message": "Fix validation after rebase"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMTM2ODMy", "url": "https://github.com/confluentinc/ksql/pull/4427#pullrequestreview-353136832", "createdAt": "2020-02-04T16:51:46Z", "commit": {"oid": "bdce4832ad55855c4edb06b67f9a397e11513418"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNjo1MTo0N1rOFlbm3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNjo1NToxOFrOFlbu3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc5Mzk0OQ==", "bodyText": "nit: if you invert this if you could move it before the construction of the lagInfo var.\ne.g.\n  if (!aliveHosts.contains(host)) {\n     return Optional.empty();\n   }\n\n   final Optional<LagInfoEntity> lagInfo = ...\n   return lagInfo;", "url": "https://github.com/confluentinc/ksql/pull/4427#discussion_r374793949", "createdAt": "2020-02-04T16:51:47Z", "author": {"login": "big-andy-coates"}, "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/LagReportingAgent.java", "diffHunk": "@@ -171,12 +167,11 @@ public void receiveHostLag(final LagReportingMessage lagReportingMessage) {\n   public Optional<LagInfoEntity> getHostsPartitionLagInfo(\n       final KsqlHost host, final QueryStateStoreId queryStateStoreId, final int partition) {\n     final Set<KsqlHost> aliveHosts = aliveHostsRef.get();\n-    final LagInfoEntity lagInfo = receivedLagInfo\n-        .getOrDefault(host, EMPTY_HOST_STORE_LAGS)\n-        .getStateStoreLagsOrDefault(queryStateStoreId, EMPTY_STATE_STORE_LAGS)\n-        .getLagByPartition(partition);\n-    if (aliveHosts.contains(host) && lagInfo != null) {\n-      return Optional.of(lagInfo);\n+    final Optional<LagInfoEntity> lagInfo = Optional.ofNullable(receivedLagInfo.get(host))\n+        .flatMap(hostStoreLags -> hostStoreLags.getStateStoreLags(queryStateStoreId))\n+        .flatMap(stateStoreLags -> stateStoreLags.getLagByPartition(partition));\n+    if (aliveHosts.contains(host)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdce4832ad55855c4edb06b67f9a397e11513418"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc5NTA5Mg==", "bodyText": "Can't this be:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                final Optional<LagInfoEntity> lagInfo = Optional.ofNullable(receivedLagInfo.get(host))\n          \n          \n            \n                final Optional<LagInfoEntity> lagInfo = getLagPerHost(host)\n          \n      \n    \n    \n  \n\n??", "url": "https://github.com/confluentinc/ksql/pull/4427#discussion_r374795092", "createdAt": "2020-02-04T16:53:45Z", "author": {"login": "big-andy-coates"}, "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/LagReportingAgent.java", "diffHunk": "@@ -171,12 +167,11 @@ public void receiveHostLag(final LagReportingMessage lagReportingMessage) {\n   public Optional<LagInfoEntity> getHostsPartitionLagInfo(\n       final KsqlHost host, final QueryStateStoreId queryStateStoreId, final int partition) {\n     final Set<KsqlHost> aliveHosts = aliveHostsRef.get();\n-    final LagInfoEntity lagInfo = receivedLagInfo\n-        .getOrDefault(host, EMPTY_HOST_STORE_LAGS)\n-        .getStateStoreLagsOrDefault(queryStateStoreId, EMPTY_STATE_STORE_LAGS)\n-        .getLagByPartition(partition);\n-    if (aliveHosts.contains(host) && lagInfo != null) {\n-      return Optional.of(lagInfo);\n+    final Optional<LagInfoEntity> lagInfo = Optional.ofNullable(receivedLagInfo.get(host))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdce4832ad55855c4edb06b67f9a397e11513418"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc5NTk5Nw==", "bodyText": "Think this can just be:\nprivate HostStoreLags getHostStoreLags(final KsqlHost ksqlHost) {\n    return lagReportingAgent\n        .map(agent -> agent.getLagPerHost(ksqlHost))\n        .orElse(EMPTY_HOST_STORE_LAGS);\n  }", "url": "https://github.com/confluentinc/ksql/pull/4427#discussion_r374795997", "createdAt": "2020-02-04T16:55:18Z", "author": {"login": "big-andy-coates"}, "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/resources/ClusterStatusResource.java", "diffHunk": "@@ -71,12 +71,17 @@ private ClusterStatusResponse getResponse() {\n             entry -> new KsqlHostEntity(entry.getKey().host(), entry.getKey().port()) ,\n             entry -> new HostStatusEntity(entry.getValue().isHostAlive(),\n                                           entry.getValue().getLastStatusUpdateMs(),\n-                                          lagReportingAgent.isPresent()\n-                                              ? lagReportingAgent.get().getLagPerHost(\n-                                                  entry.getKey())\n-                                              : EMPTY_HOST_STORE_LAGS)\n+                                          getHostStoreLags(entry.getKey()))\n         ));\n \n     return new ClusterStatusResponse(response);\n   }\n+\n+  private HostStoreLags getHostStoreLags(final KsqlHost ksqlHost) {\n+    if (!lagReportingAgent.isPresent()) {\n+      return EMPTY_HOST_STORE_LAGS;\n+    }\n+    final Optional<HostStoreLags> lags = lagReportingAgent.get().getLagPerHost(ksqlHost);\n+    return lags.orElse(EMPTY_HOST_STORE_LAGS);\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdce4832ad55855c4edb06b67f9a397e11513418"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4908b72e6181dcc75e4d936ea4dbd98f83060e81", "author": {"user": {"login": "AlanConfluent", "name": "Alan Sheinberg"}}, "url": "https://github.com/confluentinc/ksql/commit/4908b72e6181dcc75e4d936ea4dbd98f83060e81", "committedDate": "2020-02-04T18:41:44Z", "message": "Feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4938, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}