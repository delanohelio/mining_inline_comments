{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyMjc3NTA4", "number": 5739, "title": "feat: add syntax for suppression", "bodyText": "Description\nWhat behavior do you want to change, why, how does your patch achieve the changes?\nAdded keyword  FINAL to be used for result materialization. This patch introduces the new syntax in the grammar and adjusts result materialization to use either keyword CHANGES or FINAL.\nTesting done\nDescribe the testing strategy. Unit and integration tests are expected for any behavior changes.\nAdded test in sqlFormatterTest to ensure query with emit final is formatted properly, and made sure other formatting tests still passed.\nReviewer checklist\n\n Ensure docs are updated if necessary. (eg. if a user visible feature is being added or changed).\n Ensure relevant issues are linked (description should include text like \"Fixes #\")", "createdAt": "2020-06-30T20:33:49Z", "url": "https://github.com/confluentinc/ksql/pull/5739", "merged": true, "mergeCommit": {"oid": "31573c67cfb218829c8e0d050339a04eabe20e92"}, "closed": true, "closedAt": "2020-07-06T23:14:00Z", "author": {"login": "nae701"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcweg2mgFqTQ0MDQyMTIxNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyZDJ1AFqTQ0MzQ0ODIyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNDIxMjE2", "url": "https://github.com/confluentinc/ksql/pull/5739#pullrequestreview-440421216", "createdAt": "2020-06-30T22:10:03Z", "commit": {"oid": "e528c5b1134c1701f8006e7dfcbfd11f72e222c8"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMjoxMDowNFrOGrQN5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMjoyNDowMlrOGrQihQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAwNzY1NA==", "bodyText": "we probably want to keep this but change the condition to if (analysis.getResultMaterialization().isPresent() && analysis.getResultMaterialization().get() == ResultMaterialization.FINAL) because we haven't added support for EMIT FINAL yet. We'll remove this in a future PR, but we want to make sure that each PR is independently releasable and doesn't \"break\" master", "url": "https://github.com/confluentinc/ksql/pull/5739#discussion_r448007654", "createdAt": "2020-06-30T22:10:04Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/PushQueryValidator.java", "diffHunk": "@@ -17,17 +17,12 @@\n \n import io.confluent.ksql.analyzer.Analysis.AliasedDataSource;\n import io.confluent.ksql.metastore.model.DataSource.DataSourceType;\n-import io.confluent.ksql.parser.tree.ResultMaterialization;\n import io.confluent.ksql.util.KsqlException;\n \n public class PushQueryValidator implements QueryValidator {\n \n   @Override\n   public void validate(final Analysis analysis) {\n-    if (analysis.getResultMaterialization() != ResultMaterialization.CHANGES) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e528c5b1134c1701f8006e7dfcbfd11f72e222c8"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAwODIzNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    givenQuery(Optional.empty(), Optional.empty(), Optional.empty(), Optional.empty(), Optional.empty(),Optional.empty());\n          \n          \n            \n                    givenQuery(Optional.empty(), Optional.empty(), Optional.empty(), Optional.empty(), Optional.empty(), Optional.empty());\n          \n      \n    \n    \n  \n\nnit: and the same goes for the statements below", "url": "https://github.com/confluentinc/ksql/pull/5739#discussion_r448008234", "createdAt": "2020-06-30T22:11:34Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/test/java/io/confluent/ksql/engine/rewrite/StatementRewriterTest.java", "diffHunk": "@@ -193,7 +194,7 @@ private Query givenQuery(\n   public void shouldRewriteQuery() {\n     // Given:\n     final Query query =\n-        givenQuery(Optional.empty(), Optional.empty(), Optional.empty(), Optional.empty(), Optional.empty());\n+        givenQuery(Optional.empty(), Optional.empty(), Optional.empty(), Optional.empty(), Optional.empty(),Optional.empty());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e528c5b1134c1701f8006e7dfcbfd11f72e222c8"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAwOTQ3Mg==", "bodyText": "it looks like we're changing behavior of this method by adding the resultMaterialization parameter, previously it would use the field. This makes me think that because we're passing in Optional.empty() here, the tests below should be failing because we're expecting Optional.of(resultMaterialization)", "url": "https://github.com/confluentinc/ksql/pull/5739#discussion_r448009472", "createdAt": "2020-06-30T22:14:46Z", "author": {"login": "agavra"}, "path": "ksqldb-engine/src/test/java/io/confluent/ksql/engine/rewrite/StatementRewriterTest.java", "diffHunk": "@@ -170,7 +170,8 @@ private Query givenQuery(\n       final Optional<Expression> where,\n       final Optional<GroupBy> groupBy,\n       final Optional<PartitionBy> partitionBy,\n-      final Optional<Expression> having\n+      final Optional<Expression> having,\n+      final Optional<ResultMaterialization> resultMaterialization", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e528c5b1134c1701f8006e7dfcbfd11f72e222c8"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxMDUzNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // Else must be a push query\n          \n          \n            \n                    // Else must be a push query, which must specify a materialization", "url": "https://github.com/confluentinc/ksql/pull/5739#discussion_r448010536", "createdAt": "2020-06-30T22:17:26Z", "author": {"login": "agavra"}, "path": "ksqldb-parser/src/main/java/io/confluent/ksql/parser/AstBuilder.java", "diffHunk": "@@ -395,16 +394,27 @@ public Query visitQuery(final SqlBaseParser.QueryContext context) {\n \n       final boolean pullQuery = context.EMIT() == null && !buildingPersistentQuery;\n \n-      final ResultMaterialization resultMaterialization = Optional\n-          .ofNullable(context.resultMaterialization())\n-          .map(rm -> rm.CHANGES() == null\n-              ? ResultMaterialization.FINAL\n-              : ResultMaterialization.CHANGES\n-          )\n-          .orElse(buildingPersistentQuery\n-              ? ResultMaterialization.CHANGES\n-              : ResultMaterialization.FINAL\n-          );\n+      final Optional<ResultMaterialization> resultMaterialization;\n+\n+      if (pullQuery) {\n+        resultMaterialization = Optional.empty();\n+      } else if (buildingPersistentQuery) {\n+        resultMaterialization = Optional.of(Optional\n+            .ofNullable(context.resultMaterialization())\n+            .map(rm -> rm.FINAL() == null\n+                ? ResultMaterialization.CHANGES\n+                : ResultMaterialization.FINAL\n+            )\n+            .orElse(ResultMaterialization.CHANGES\n+            ));\n+        // Else must be a push query", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e528c5b1134c1701f8006e7dfcbfd11f72e222c8"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxMjUzMA==", "bodyText": "this can be simplified to:\nappend(indent, \"EMIT \");\nappend(indent, node.getResultMaterialization().orElse(ResultMaterialization.CHANGES).toString()).append('\\n');", "url": "https://github.com/confluentinc/ksql/pull/5739#discussion_r448012530", "createdAt": "2020-06-30T22:22:45Z", "author": {"login": "agavra"}, "path": "ksqldb-parser/src/main/java/io/confluent/ksql/parser/SqlFormatter.java", "diffHunk": "@@ -127,9 +127,16 @@ protected Void visitQuery(final Query node, final Integer indent) {\n       }\n \n       if (!node.isPullQuery()) {\n-        append(indent, \"EMIT \");\n-        append(indent, node.getResultMaterialization().toString())\n-            .append('\\n');\n+        if (node.getResultMaterialization().isPresent()) {\n+          append(indent, \"EMIT \");\n+          append(indent, node.getResultMaterialization().get().toString())\n+              .append('\\n');\n+        } else {\n+          append(indent, \"EMIT \");\n+          append(indent, \"CHANGES\")\n+              .append('\\n');\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e528c5b1134c1701f8006e7dfcbfd11f72e222c8"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxMjkzMw==", "bodyText": "make sure to add test coverage that accounts for the new code added to ast builder (it should cover all the branches you added from AstBuilder.java L399:L417)", "url": "https://github.com/confluentinc/ksql/pull/5739#discussion_r448012933", "createdAt": "2020-06-30T22:24:02Z", "author": {"login": "agavra"}, "path": "ksqldb-parser/src/test/java/io/confluent/ksql/parser/AstBuilderTest.java", "diffHunk": "@@ -444,7 +443,7 @@ public void shouldSupportExplicitEmitChangesOnBareQuery() {\n \n     // Then:\n     assertThat(\"Should be push\", result.isPullQuery(), is(false));\n-    assertThat(result.getResultMaterialization(), is(ResultMaterialization.CHANGES));\n+    assertThat(result.getResultMaterialization(), is(Optional.of(ResultMaterialization.CHANGES)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e528c5b1134c1701f8006e7dfcbfd11f72e222c8"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57ce5d2fc9fbb95bdfa63e28c2127d8a78b6e1f2", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/57ce5d2fc9fbb95bdfa63e28c2127d8a78b6e1f2", "committedDate": "2020-07-06T20:57:45Z", "message": "made resultMaterialization optional and fixed logic in AstBuilder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "595852086f8445072d976bd386f2e2e7056aea44", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/595852086f8445072d976bd386f2e2e7056aea44", "committedDate": "2020-07-06T21:07:22Z", "message": "feat: add syntax for suppression"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8475960a98821879906ec1348a6f358460802c5f", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/8475960a98821879906ec1348a6f358460802c5f", "committedDate": "2020-07-06T21:07:56Z", "message": "fix: default to emit changes for ctas/csas"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51cb6c06d41b6be77ffc67c4bb2e0c8946dbf4be", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/51cb6c06d41b6be77ffc67c4bb2e0c8946dbf4be", "committedDate": "2020-07-06T21:08:08Z", "message": "chore: cleaning up code resultMaterialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81c45353a3c3fae4a6b240b001e3cec2d6d26528", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/81c45353a3c3fae4a6b240b001e3cec2d6d26528", "committedDate": "2020-07-06T21:08:26Z", "message": "test: add tests for emit final"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "184755e3910bc580606cfb4c5604c6edd725eedd", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/184755e3910bc580606cfb4c5604c6edd725eedd", "committedDate": "2020-07-06T21:11:23Z", "message": "chore: revert rewrite test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d5d871ebc4079c1d4c5678cbb41e0a60332ab018", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/d5d871ebc4079c1d4c5678cbb41e0a60332ab018", "committedDate": "2020-07-06T20:21:09Z", "message": "chore: fix to merge"}, "afterCommit": {"oid": "184755e3910bc580606cfb4c5604c6edd725eedd", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/184755e3910bc580606cfb4c5604c6edd725eedd", "committedDate": "2020-07-06T21:11:23Z", "message": "chore: revert rewrite test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNDMxNzIz", "url": "https://github.com/confluentinc/ksql/pull/5739#pullrequestreview-443431723", "createdAt": "2020-07-06T21:54:16Z", "commit": {"oid": "184755e3910bc580606cfb4c5604c6edd725eedd"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMTo1NDoxNlrOGtoUHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMTo1ODoxNlrOGtoaew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ5OTYxMg==", "bodyText": "nit: can just be .get() we know that it's present from the check above\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          .orElse(ResultMaterialization.CHANGES)\n          \n          \n            \n                          .get()", "url": "https://github.com/confluentinc/ksql/pull/5739#discussion_r450499612", "createdAt": "2020-07-06T21:54:16Z", "author": {"login": "agavra"}, "path": "ksqldb-parser/src/main/java/io/confluent/ksql/parser/SqlFormatter.java", "diffHunk": "@@ -127,9 +127,13 @@ protected Void visitQuery(final Query node, final Integer indent) {\n       }\n \n       if (!node.isPullQuery()) {\n-        append(indent, \"EMIT \");\n-        append(indent, node.getResultMaterialization().toString())\n-            .append('\\n');\n+        if (node.getResultMaterialization().isPresent()) {\n+          append(indent, \"EMIT \");\n+          append(indent, node.getResultMaterialization()\n+              .orElse(ResultMaterialization.CHANGES)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "184755e3910bc580606cfb4c5604c6edd725eedd"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUwMTI0Mw==", "bodyText": "did you mean to add this? \ud83d\ude09", "url": "https://github.com/confluentinc/ksql/pull/5739#discussion_r450501243", "createdAt": "2020-07-06T21:58:16Z", "author": {"login": "agavra"}, "path": "ksqldb-rest-app/src/test/java/io/confluent/ksql/rest/server/KsqlRestConfigTest.java", "diffHunk": "@@ -41,6 +41,7 @@\n import org.apache.kafka.clients.consumer.ConsumerConfig;\n import org.apache.kafka.common.config.ConfigException;\n import org.apache.kafka.streams.StreamsConfig;\n+import org.junit.Ignore;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "184755e3910bc580606cfb4c5604c6edd725eedd"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c820585f3572360af4478742c6bceb9f6c9959b", "author": {"user": {"login": "nae701", "name": "Natea Eshetu Beshada"}}, "url": "https://github.com/confluentinc/ksql/commit/9c820585f3572360af4478742c6bceb9f6c9959b", "committedDate": "2020-07-06T22:15:51Z", "message": "chore: fix nits"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNDQ4MjI4", "url": "https://github.com/confluentinc/ksql/pull/5739#pullrequestreview-443448228", "createdAt": "2020-07-06T22:33:22Z", "commit": {"oid": "9c820585f3572360af4478742c6bceb9f6c9959b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 298, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}