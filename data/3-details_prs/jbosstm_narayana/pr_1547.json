{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxMTE5OTE5", "number": 1547, "title": "JBTM-3243 Use PostConstruct/PreDestroy for ApplicationScoped bean (instead of Observer)", "bodyText": "https://issues.redhat.com/browse/JBTM-3243\n!MAIN !TOMCAT !AS_TESTS !RTS !JACOCO !XTS !QA_JTA !QA_JTS_JACORB !QA_JTS_JDKORB !QA_JTS_OPENJDKORB !BLACKTIE !PERF LRA !NO_WIN !DB_TESTS !mysql !db2 !postgres !oracle", "createdAt": "2020-01-09T19:28:00Z", "url": "https://github.com/jbosstm/narayana/pull/1547", "merged": true, "mergeCommit": {"oid": "47d1ecfd1def1a663658ce04c35a9dde86e5e81b"}, "closed": true, "closedAt": "2020-01-13T16:31:08Z", "author": {"login": "mmusgrov"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb5BNdSgBqjI5MzkxMDkzOTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb5-p-7gFqTM0MTk1NTcxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef91974af6860ba707327607cb529b03482cf054", "author": {"user": {"login": "mmusgrov", "name": "Michael Musgrove"}}, "url": "https://github.com/jbosstm/narayana/commit/ef91974af6860ba707327607cb529b03482cf054", "committedDate": "2020-01-09T19:20:51Z", "message": "JBTM-3243 Use ActivateRequestContext for CDI destroy event"}, "afterCommit": {"oid": "747b0537818d2ff43e4d15c5a16b1c6e99612f48", "author": {"user": {"login": "mmusgrov", "name": "Michael Musgrove"}}, "url": "https://github.com/jbosstm/narayana/commit/747b0537818d2ff43e4d15c5a16b1c6e99612f48", "committedDate": "2020-01-10T16:32:42Z", "message": "JBTM-3243 Use ActivateRequestContext for CDI destroy event"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMjg0MTIx", "url": "https://github.com/jbosstm/narayana/pull/1547#pullrequestreview-341284121", "createdAt": "2020-01-10T16:39:40Z", "commit": {"oid": "747b0537818d2ff43e4d15c5a16b1c6e99612f48"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxNjozOTo0MFrOFcZo0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxNjozOTo0MFrOFcZo0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMyNDQ5Nw==", "bodyText": "I guess this is separate to the core JBTM in this PR?", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365324497", "createdAt": "2020-01-10T16:39:40Z", "author": {"login": "tomjenkinson"}, "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/service/LRAService.java", "diffHunk": "@@ -62,7 +61,7 @@\n     private Map<URI, Transaction> recoveringLRAs = new ConcurrentHashMap<>();\n     private Map<URI, ReentrantLock> locks = new ConcurrentHashMap<>();\n \n-    private static Map<String, String> participants = new ConcurrentHashMap<>();\n+    private Map<String, String> participants = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "747b0537818d2ff43e4d15c5a16b1c6e99612f48"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMjg1MzU1", "url": "https://github.com/jbosstm/narayana/pull/1547#pullrequestreview-341285355", "createdAt": "2020-01-10T16:41:30Z", "commit": {"oid": "747b0537818d2ff43e4d15c5a16b1c6e99612f48"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxNjo0MTozMVrOFcZsaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxNjo0MTozMVrOFcZsaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMyNTQxNg==", "bodyText": "I note that this is currently a no-op but I wonder if a separate JBTM should be removing from the RecordTypeManager to reverse the install?", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365325416", "createdAt": "2020-01-10T16:41:31Z", "author": {"login": "tomjenkinson"}, "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/service/LRAService.java", "diffHunk": "@@ -410,18 +404,18 @@ void enableRecovery(@Observes @Initialized(ApplicationScoped.class) Object init)\n \n     /**\n      * When the deployment is unloaded unregister for recovery\n-     *\n-     * @param init a javax.servlet.ServletContext\n      */\n-    void disableRecovery(@Observes @Destroyed(ApplicationScoped.class) Object init) {\n-        assert lraRecoveryModule != null;\n+    @PreDestroy\n+    void disableRecovery() {\n+        if (lraRecoveryModule != null) {\n \n-        Implementations.uninstall();\n-        RecoveryManager.manager().removeModule(lraRecoveryModule, false);\n-        lraRecoveryModule = null;\n+            Implementations.uninstall();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "747b0537818d2ff43e4d15c5a16b1c6e99612f48"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMjg2MDIy", "url": "https://github.com/jbosstm/narayana/pull/1547#pullrequestreview-341286022", "createdAt": "2020-01-10T16:42:31Z", "commit": {"oid": "747b0537818d2ff43e4d15c5a16b1c6e99612f48"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxNjo0MjozMVrOFcZuZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxNjo0MjozMVrOFcZuZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMyNTkyNQ==", "bodyText": "I am not sure what the %n refers to here. I think it would be fine to correct the typo given it is debug statement and is being edited in this PR", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365325925", "createdAt": "2020-01-10T16:42:31Z", "author": {"login": "tomjenkinson"}, "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/service/LRAService.java", "diffHunk": "@@ -410,18 +404,18 @@ void enableRecovery(@Observes @Initialized(ApplicationScoped.class) Object init)\n \n     /**\n      * When the deployment is unloaded unregister for recovery\n-     *\n-     * @param init a javax.servlet.ServletContext\n      */\n-    void disableRecovery(@Observes @Destroyed(ApplicationScoped.class) Object init) {\n-        assert lraRecoveryModule != null;\n+    @PreDestroy\n+    void disableRecovery() {\n+        if (lraRecoveryModule != null) {\n \n-        Implementations.uninstall();\n-        RecoveryManager.manager().removeModule(lraRecoveryModule, false);\n-        lraRecoveryModule = null;\n+            Implementations.uninstall();\n+            RecoveryManager.manager().removeModule(lraRecoveryModule, false);\n+            lraRecoveryModule = null;\n \n-        if (LRALogger.logger.isDebugEnabled()) {\n-            LRALogger.logger.debugf(\"LRAServicve.disableRecovery%n\");\n+            if (LRALogger.logger.isDebugEnabled()) {\n+                LRALogger.logger.debugf(\"LRAServicve.disableRecovery%n\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "747b0537818d2ff43e4d15c5a16b1c6e99612f48"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMjkxMTA1", "url": "https://github.com/jbosstm/narayana/pull/1547#pullrequestreview-341291105", "createdAt": "2020-01-10T16:50:21Z", "commit": {"oid": "747b0537818d2ff43e4d15c5a16b1c6e99612f48"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxNjo1MDoyMlrOFcZ8xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxNjo1MDoyMlrOFcZ8xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMyOTYwNg==", "bodyText": "I don't think this dependency should be required now? Or at least javax/annotation is not provided directly inside it. If a dependency is required I suspect it would be on one from https://search.maven.org/artifact/jakarta.annotation/jakarta.annotation-api", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365329606", "createdAt": "2020-01-10T16:50:22Z", "author": {"login": "tomjenkinson"}, "path": "rts/lra/lra-coordinator-jar/pom.xml", "diffHunk": "@@ -103,6 +103,12 @@\n             <version>${project.version}</version>\n             <scope>test</scope>\n         </dependency>\n+        <dependency>\n+            <groupId>jakarta.enterprise</groupId>\n+            <artifactId>jakarta.enterprise.cdi-api</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "747b0537818d2ff43e4d15c5a16b1c6e99612f48"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMjkxOTkx", "url": "https://github.com/jbosstm/narayana/pull/1547#pullrequestreview-341291991", "createdAt": "2020-01-10T16:51:49Z", "commit": {"oid": "747b0537818d2ff43e4d15c5a16b1c6e99612f48"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxNjo1MTo0OVrOFcZ_WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxNjo1MTo0OVrOFcZ_WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMzMDI2NA==", "bodyText": "was this part a general tidy up or was it related to JBTM-3243? if general I think it needs a separate issue?", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365330264", "createdAt": "2020-01-10T16:51:49Z", "author": {"login": "tomjenkinson"}, "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/service/LRAService.java", "diffHunk": "@@ -189,13 +188,9 @@ public void remove(String state, URI lraId) {\n             lras.remove(lraId);\n         }\n \n-        if (recoveringLRAs.containsKey(lraId)) {\n-            recoveringLRAs.remove(lraId);\n-        }\n+        recoveringLRAs.remove(lraId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "747b0537818d2ff43e4d15c5a16b1c6e99612f48"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMjkyMDYy", "url": "https://github.com/jbosstm/narayana/pull/1547#pullrequestreview-341292062", "createdAt": "2020-01-10T16:51:55Z", "commit": {"oid": "747b0537818d2ff43e4d15c5a16b1c6e99612f48"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxNjo1MTo1NVrOFcZ_kQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxNjo1MTo1NVrOFcZ_kQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTMzMDMyMQ==", "bodyText": "was this part a general tidy up or was it related to JBTM-3243? if general I think it needs a separate issue?", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365330321", "createdAt": "2020-01-10T16:51:55Z", "author": {"login": "tomjenkinson"}, "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/service/LRAService.java", "diffHunk": "@@ -189,13 +188,9 @@ public void remove(String state, URI lraId) {\n             lras.remove(lraId);\n         }\n \n-        if (recoveringLRAs.containsKey(lraId)) {\n-            recoveringLRAs.remove(lraId);\n-        }\n+        recoveringLRAs.remove(lraId);\n \n-        if (locks.containsKey(lraId)) {\n-            locks.remove(lraId);\n-        }\n+        locks.remove(lraId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "747b0537818d2ff43e4d15c5a16b1c6e99612f48"}, "originalPosition": 34}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "747b0537818d2ff43e4d15c5a16b1c6e99612f48", "author": {"user": {"login": "mmusgrov", "name": "Michael Musgrove"}}, "url": "https://github.com/jbosstm/narayana/commit/747b0537818d2ff43e4d15c5a16b1c6e99612f48", "committedDate": "2020-01-10T16:32:42Z", "message": "JBTM-3243 Use ActivateRequestContext for CDI destroy event"}, "afterCommit": {"oid": "e73ab4356a22f08c54dfd381596e65571eab07d2", "author": {"user": {"login": "mmusgrov", "name": "Michael Musgrove"}}, "url": "https://github.com/jbosstm/narayana/commit/e73ab4356a22f08c54dfd381596e65571eab07d2", "committedDate": "2020-01-10T17:51:04Z", "message": "JBTM-3243 Use ActivateRequestContext for CDI destroy event"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMzYyOTYw", "url": "https://github.com/jbosstm/narayana/pull/1547#pullrequestreview-341362960", "createdAt": "2020-01-10T19:05:37Z", "commit": {"oid": "e73ab4356a22f08c54dfd381596e65571eab07d2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxOTowNTozOFrOFcdWdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxOTowNTozOFrOFcdWdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM4NTMzMg==", "bodyText": "@tomjenkinson This is the implementation for Implementations.uninstall()", "url": "https://github.com/jbosstm/narayana/pull/1547#discussion_r365385332", "createdAt": "2020-01-10T19:05:38Z", "author": {"login": "mmusgrov"}, "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/internal/Implementations.java", "diffHunk": "@@ -48,17 +48,20 @@ public int getType() {\n \n public class Implementations {\n \n-    private static boolean _added = false;\n+    private static LRACompensatorMap typeMap;\n \n     public static synchronized void install() {\n-        if (!_added) {\n-            RecordTypeManager.manager().add(new LRACompensatorMap());\n-\n-            _added = true;\n+        if (typeMap == null) {\n+            typeMap = new LRACompensatorMap();\n+            RecordTypeManager.manager().add(typeMap);\n         }\n     }\n \n     public static synchronized void uninstall() {\n+        if (typeMap != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e73ab4356a22f08c54dfd381596e65571eab07d2"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMzY5NTI0", "url": "https://github.com/jbosstm/narayana/pull/1547#pullrequestreview-341369524", "createdAt": "2020-01-10T19:18:04Z", "commit": {"oid": "e73ab4356a22f08c54dfd381596e65571eab07d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMzcxMTc3", "url": "https://github.com/jbosstm/narayana/pull/1547#pullrequestreview-341371177", "createdAt": "2020-01-10T19:21:07Z", "commit": {"oid": "e73ab4356a22f08c54dfd381596e65571eab07d2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e73ab4356a22f08c54dfd381596e65571eab07d2", "author": {"user": {"login": "mmusgrov", "name": "Michael Musgrove"}}, "url": "https://github.com/jbosstm/narayana/commit/e73ab4356a22f08c54dfd381596e65571eab07d2", "committedDate": "2020-01-10T17:51:04Z", "message": "JBTM-3243 Use ActivateRequestContext for CDI destroy event"}, "afterCommit": {"oid": "809a8a9648396875de85a2b2a4b3ae7cf40260e6", "author": {"user": {"login": "mmusgrov", "name": "Michael Musgrove"}}, "url": "https://github.com/jbosstm/narayana/commit/809a8a9648396875de85a2b2a4b3ae7cf40260e6", "committedDate": "2020-01-10T21:11:23Z", "message": "JBTM-3243 Use PostConstruct/PreDestroy for ApplicationScoped bean (instead of Observer)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "792cdfaf0c11d68ac12475bd7b6e8c82f37bc074", "author": {"user": {"login": "mmusgrov", "name": "Michael Musgrove"}}, "url": "https://github.com/jbosstm/narayana/commit/792cdfaf0c11d68ac12475bd7b6e8c82f37bc074", "committedDate": "2020-01-13T16:02:26Z", "message": "JBTM-3243 Use PostConstruct and PreDestroy to detect LRA application lifecycle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e817f63a7ca38a3966586a65203ea25779a51ea1", "author": {"user": {"login": "mmusgrov", "name": "Michael Musgrove"}}, "url": "https://github.com/jbosstm/narayana/commit/e817f63a7ca38a3966586a65203ea25779a51ea1", "committedDate": "2020-01-13T16:03:42Z", "message": "tidyup whilst fixing JBTM-3243"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "809a8a9648396875de85a2b2a4b3ae7cf40260e6", "author": {"user": {"login": "mmusgrov", "name": "Michael Musgrove"}}, "url": "https://github.com/jbosstm/narayana/commit/809a8a9648396875de85a2b2a4b3ae7cf40260e6", "committedDate": "2020-01-10T21:11:23Z", "message": "JBTM-3243 Use PostConstruct/PreDestroy for ApplicationScoped bean (instead of Observer)"}, "afterCommit": {"oid": "e817f63a7ca38a3966586a65203ea25779a51ea1", "author": {"user": {"login": "mmusgrov", "name": "Michael Musgrove"}}, "url": "https://github.com/jbosstm/narayana/commit/e817f63a7ca38a3966586a65203ea25779a51ea1", "committedDate": "2020-01-13T16:03:42Z", "message": "tidyup whilst fixing JBTM-3243"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxOTU1NzE4", "url": "https://github.com/jbosstm/narayana/pull/1547#pullrequestreview-341955718", "createdAt": "2020-01-13T16:08:35Z", "commit": {"oid": "e817f63a7ca38a3966586a65203ea25779a51ea1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4504, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}