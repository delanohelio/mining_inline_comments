{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1MzgwOTgy", "number": 1677, "title": "JBTM-3349 Replace Apache HttpClient with JAX-RS client in LRA modules ", "bodyText": "https://issues.redhat.com/browse/JBTM-3349\nContains also a fix for https://issues.redhat.com/browse/JBTM-3189.\n!MAIN !TOMCAT !AS_TESTS !RTS !JACOCO !XTS !QA_JTA !QA_JTS_JACORB !QA_JTS_JDKORB !QA_JTS_OPENJDKORB !BLACKTIE !PERF LRA NO_WIN !DB_TESTS !mysql !db2 !postgres !oracle\nPlease note that this is the minimal set of changes needed to pass all test suites. There are several enhancements that can be implemented on top of it but the time was prioritized.", "createdAt": "2020-09-30T09:37:15Z", "url": "https://github.com/jbosstm/narayana/pull/1677", "merged": true, "mergeCommit": {"oid": "9fb19c13b4e9109c49bd2339ab455561bc7a3434"}, "closed": true, "closedAt": "2020-10-16T17:35:59Z", "author": {"login": "xstefank"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdN8M9zgFqTQ5OTM4MjU1Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdTDCYpgBqjM4ODU0ODU5NDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5MzgyNTUz", "url": "https://github.com/jbosstm/narayana/pull/1677#pullrequestreview-499382553", "createdAt": "2020-09-30T12:37:50Z", "commit": {"oid": "a651fbf53f35bebf867b6c56a326301a966426e2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMjozNzo1MFrOHabcGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMjo0NTowMFrOHabuMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ3NDU4NA==", "bodyText": "Do you think we can move the version definition to a maven property?", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r497474584", "createdAt": "2020-09-30T12:37:50Z", "author": {"login": "ochaloup"}, "path": "rts/lra/lra-client/pom.xml", "diffHunk": "@@ -57,6 +57,16 @@\n             <version>2.5</version>\n             <scope>provided</scope>\n         </dependency>\n+      <dependency>\n+        <groupId>org.eclipse.microprofile.rest.client</groupId>\n+        <artifactId>microprofile-rest-client-api</artifactId>\n+        <version>1.4.1</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a651fbf53f35bebf867b6c56a326301a966426e2"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ3NjIxNQ==", "bodyText": "For internationalization purposes we are used to use the error messages defined in i18Logger (ie. LRALogger.i18NLogger.*). Would be possible to change it that way?\n(I understand that it was not done so in the code before but as I hit this in the diff I think it could be good to be changed.)", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r497476215", "createdAt": "2020-09-30T12:40:19Z", "author": {"login": "ochaloup"}, "path": "rts/lra/lra-client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java", "diffHunk": "@@ -569,9 +562,14 @@ public LRAStatus getStatus(URI uri) throws WebApplicationException {\n         }\n \n         try {\n-            response = getTarget().path(getLRAId(lraId.toString())).path(\"status\")\n-                    .request()\n-                    .get();\n+            response = coordinatorClient.getLRAStatus(getLRAId(lraId.toString()));\n+        } catch (WebApplicationException wae) {\n+            Response waeResponse = wae.getResponse();\n+            if (waeResponse.getStatus() == Response.Status.NOT_FOUND.getStatusCode()) {\n+                String responseContent = waeResponse.readEntity(String.class);\n+                throw new NotFoundException(\"Failed to get status of LRA id \" + lraId", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a651fbf53f35bebf867b6c56a326301a966426e2"}, "originalPosition": 212}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ3OTIxOA==", "bodyText": "I don't understand the purpose of the change here. The LRAData was intentionally made immutable. Why is needed this to be changed?", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r497479218", "createdAt": "2020-09-30T12:45:00Z", "author": {"login": "ochaloup"}, "path": "rts/lra/lra-service-base/src/main/java/io/narayana/lra/LRAData.java", "diffHunk": "@@ -8,14 +8,16 @@\n  * for JSON response creation when LRA info is asked for.\n  */\n public class LRAData {\n-    private final String lraId;\n-    private final String clientId;\n-    private final LRAStatus status;\n-    private final boolean isTopLevel;\n-    private final boolean isRecovering;\n-    private final long startTime;\n-    private final long finishTime;\n-    private final int httpStatus;\n+    private String lraId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a651fbf53f35bebf867b6c56a326301a966426e2"}, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a651fbf53f35bebf867b6c56a326301a966426e2", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/a651fbf53f35bebf867b6c56a326301a966426e2", "committedDate": "2020-09-30T09:35:58Z", "message": "JBTM-3349 Replace Apache HttpClient with MP REST Client"}, "afterCommit": {"oid": "3c191622d7ccda6c782f43f2504982c8864f6a2b", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/3c191622d7ccda6c782f43f2504982c8864f6a2b", "committedDate": "2020-10-01T10:41:32Z", "message": "JBTM-3349 Replace Apache HttpClient with MP REST Client"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMjk5ODI1", "url": "https://github.com/jbosstm/narayana/pull/1677#pullrequestreview-500299825", "createdAt": "2020-10-01T12:36:09Z", "commit": {"oid": "3c191622d7ccda6c782f43f2504982c8864f6a2b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNjU4MjQw", "url": "https://github.com/jbosstm/narayana/pull/1677#pullrequestreview-501658240", "createdAt": "2020-10-04T20:48:30Z", "commit": {"oid": "3c191622d7ccda6c782f43f2504982c8864f6a2b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c191622d7ccda6c782f43f2504982c8864f6a2b", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/3c191622d7ccda6c782f43f2504982c8864f6a2b", "committedDate": "2020-10-01T10:41:32Z", "message": "JBTM-3349 Replace Apache HttpClient with MP REST Client"}, "afterCommit": {"oid": "6d1fa33a85710dad640dd49cc1e54b575bb6160b", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/6d1fa33a85710dad640dd49cc1e54b575bb6160b", "committedDate": "2020-10-05T07:15:54Z", "message": "JBTM-3349 Replace Apache HttpClient with MP REST Client"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6d1fa33a85710dad640dd49cc1e54b575bb6160b", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/6d1fa33a85710dad640dd49cc1e54b575bb6160b", "committedDate": "2020-10-05T07:15:54Z", "message": "JBTM-3349 Replace Apache HttpClient with MP REST Client"}, "afterCommit": {"oid": "fff617f1679b39df87e8f2cd9837b7c1ee0e96bd", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/fff617f1679b39df87e8f2cd9837b7c1ee0e96bd", "committedDate": "2020-10-05T08:17:16Z", "message": "JBTM-3349 Replace Apache HttpClient with MP REST Client"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMDQ5Mjgz", "url": "https://github.com/jbosstm/narayana/pull/1677#pullrequestreview-502049283", "createdAt": "2020-10-05T13:22:03Z", "commit": {"oid": "fff617f1679b39df87e8f2cd9837b7c1ee0e96bd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMzoyMjowM1rOHccySg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMzoyMjowM1rOHccySg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTU5MzgwMg==", "bodyText": "should not be this in scope provided?", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r499593802", "createdAt": "2020-10-05T13:22:03Z", "author": {"login": "ochaloup"}, "path": "rts/lra/lra-client/pom.xml", "diffHunk": "@@ -57,6 +57,11 @@\n             <version>2.5</version>\n             <scope>provided</scope>\n         </dependency>\n+        <dependency>\n+          <groupId>org.jboss.resteasy</groupId>\n+          <artifactId>resteasy-client-microprofile</artifactId>\n+          <version>${version.org.jboss.resteasy}</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fff617f1679b39df87e8f2cd9837b7c1ee0e96bd"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMDY3Mjc3", "url": "https://github.com/jbosstm/narayana/pull/1677#pullrequestreview-502067277", "createdAt": "2020-10-05T13:41:07Z", "commit": {"oid": "fff617f1679b39df87e8f2cd9837b7c1ee0e96bd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fff617f1679b39df87e8f2cd9837b7c1ee0e96bd", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/fff617f1679b39df87e8f2cd9837b7c1ee0e96bd", "committedDate": "2020-10-05T08:17:16Z", "message": "JBTM-3349 Replace Apache HttpClient with MP REST Client"}, "afterCommit": {"oid": "1e87ae73d50b1c8b509f4bf43ee2852a433a444e", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/1e87ae73d50b1c8b509f4bf43ee2852a433a444e", "committedDate": "2020-10-07T08:33:59Z", "message": "JBTM-3349 Replace Apache HttpClient with MP REST Client"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1e87ae73d50b1c8b509f4bf43ee2852a433a444e", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/1e87ae73d50b1c8b509f4bf43ee2852a433a444e", "committedDate": "2020-10-07T08:33:59Z", "message": "JBTM-3349 Replace Apache HttpClient with MP REST Client"}, "afterCommit": {"oid": "788e0c203989b7b7cefaa226190a06e893950277", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/788e0c203989b7b7cefaa226190a06e893950277", "committedDate": "2020-10-07T11:08:36Z", "message": "JBTM-3349 Replace Apache HttpClient with MP REST Client"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NDg4NDQ2", "url": "https://github.com/jbosstm/narayana/pull/1677#pullrequestreview-504488446", "createdAt": "2020-10-08T07:15:40Z", "commit": {"oid": "788e0c203989b7b7cefaa226190a06e893950277"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0Njc0NzU0", "url": "https://github.com/jbosstm/narayana/pull/1677#pullrequestreview-504674754", "createdAt": "2020-10-08T11:14:39Z", "commit": {"oid": "788e0c203989b7b7cefaa226190a06e893950277"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMToxNDozOVrOHeZo5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMToxNDozOVrOHeZo5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYzOTM5OA==", "bodyText": "You can't just ignore code.\nAre there any other places in this PR where you have removed stuff that's required?", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r501639398", "createdAt": "2020-10-08T11:14:39Z", "author": {"login": "mmusgrov"}, "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/api/Coordinator.java", "diffHunk": "@@ -238,13 +234,8 @@ public Response startLRA(\n                     return Response.status(response.getStatus()).build();\n                 }\n             } else {\n-                ResponseHolder resp = new RequestBuilder(parentLRAUrl)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "788e0c203989b7b7cefaa226190a06e893950277"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "788e0c203989b7b7cefaa226190a06e893950277", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/788e0c203989b7b7cefaa226190a06e893950277", "committedDate": "2020-10-07T11:08:36Z", "message": "JBTM-3349 Replace Apache HttpClient with MP REST Client"}, "afterCommit": {"oid": "73b67965869963f7314db468c27db7a8332d760b", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/73b67965869963f7314db468c27db7a8332d760b", "committedDate": "2020-10-08T12:47:02Z", "message": "JBTM-3349 Replace Apache HttpClient with MP REST Client"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c0a5550e8e8855b80f426ea5e425612f020a7b44", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/c0a5550e8e8855b80f426ea5e425612f020a7b44", "committedDate": "2020-10-12T13:31:56Z", "message": "Replace MP REST client with JAX-RS client in lra-client module"}, "afterCommit": {"oid": "f16dde974e7dda093485c55721af40b4a7b8688d", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/f16dde974e7dda093485c55721af40b4a7b8688d", "committedDate": "2020-10-12T13:49:38Z", "message": "Replace MP REST client with JAX-RS client in lra-client module"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NzQ4NDg5", "url": "https://github.com/jbosstm/narayana/pull/1677#pullrequestreview-506748489", "createdAt": "2020-10-12T16:06:57Z", "commit": {"oid": "f16dde974e7dda093485c55721af40b4a7b8688d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNjowNjo1OFrOHgEzSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNjowNjo1OFrOHgEzSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM5NTE0Ng==", "bodyText": "is this still needed here? does it help the coordinator to work right?", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r503395146", "createdAt": "2020-10-12T16:06:58Z", "author": {"login": "ochaloup"}, "path": "rts/lra/lra-client/src/main/resources/META-INF/services/javax.ws.rs.client.ClientBuilder", "diffHunk": "@@ -0,0 +1 @@\n+org.jboss.resteasy.client.jaxrs.ResteasyClientBuilder", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16dde974e7dda093485c55721af40b4a7b8688d"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MzE4ODc3", "url": "https://github.com/jbosstm/narayana/pull/1677#pullrequestreview-508318877", "createdAt": "2020-10-14T13:01:00Z", "commit": {"oid": "f16dde974e7dda093485c55721af40b4a7b8688d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMzowMTowMVrOHhR0Fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNDoyNzo0MFrOHhV2tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY1NjkxOA==", "bodyText": "Not used (nor is the dependency on it in rts/lra/lra-client/pom.xml)", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504656918", "createdAt": "2020-10-14T13:01:01Z", "author": {"login": "mmusgrov"}, "path": "pom.xml", "diffHunk": "@@ -459,6 +459,7 @@\n     <version.javax.inject>1</version.javax.inject>\n     <version.javax.servlet>3.0.1</version.javax.servlet>\n     <version.commons-httpclient>3.1-jbossorg-1</version.commons-httpclient>\n+    <version.commons-io>2.8.0</version.commons-io>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16dde974e7dda093485c55721af40b4a7b8688d"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY1ODcyMg==", "bodyText": "Not used (nor is dependency on it in rts/lra/lra-coordinator/pom.xml)", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504658722", "createdAt": "2020-10-14T13:03:43Z", "author": {"login": "mmusgrov"}, "path": "pom.xml", "diffHunk": "@@ -494,6 +495,7 @@\n     <version.org.wildfly.checkstyle-config>1.0.8.Final</version.org.wildfly.checkstyle-config>\n     <version.com.github.docker-java>3.0.14</version.com.github.docker-java>\n     <version.org.eclipse.microprofile.openapi>1.1.2</version.org.eclipse.microprofile.openapi>\n+    <version.org.eclipse.microprofile.rest.client>1.4.1</version.org.eclipse.microprofile.rest.client>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16dde974e7dda093485c55721af40b4a7b8688d"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY2MDEyNw==", "bodyText": "Not used.", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504660127", "createdAt": "2020-10-14T13:05:43Z", "author": {"login": "mmusgrov"}, "path": "rts/lra/lra-client/pom.xml", "diffHunk": "@@ -57,6 +57,16 @@\n             <version>2.5</version>\n             <scope>provided</scope>\n         </dependency>\n+      <dependency>\n+        <groupId>org.jboss.resteasy</groupId>\n+        <artifactId>resteasy-json-binding-provider</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16dde974e7dda093485c55721af40b4a7b8688d"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY2MDI0Mw==", "bodyText": "Not used.", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504660243", "createdAt": "2020-10-14T13:05:52Z", "author": {"login": "mmusgrov"}, "path": "rts/lra/lra-client/pom.xml", "diffHunk": "@@ -57,6 +57,16 @@\n             <version>2.5</version>\n             <scope>provided</scope>\n         </dependency>\n+      <dependency>\n+        <groupId>org.jboss.resteasy</groupId>\n+        <artifactId>resteasy-json-binding-provider</artifactId>\n+        <version>${version.org.jboss.resteasy}</version>\n+      </dependency>\n+      <dependency>\n+        <groupId>commons-io</groupId>\n+        <artifactId>commons-io</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16dde974e7dda093485c55721af40b4a7b8688d"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3MTMyMg==", "bodyText": "newClient is a very expensive resource. Can you move the Client construction code to a separate method so that we can cache it in the future (you don't need to cache it in this PR but we should be doing so in the future). Similarly for other calls to newClient in this PR.", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504671322", "createdAt": "2020-10-14T13:21:12Z", "author": {"login": "mmusgrov"}, "path": "rts/lra/lra-client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java", "diffHunk": "@@ -230,6 +226,27 @@ public void setCurrentLRA(URI coordinatorUri) {\n         }\n     }\n \n+    public List<LRAData> getAllLRAs() {\n+        Client client = null;\n+        try {\n+            client = ClientBuilder.newClient();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16dde974e7dda093485c55721af40b4a7b8688d"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3NDMwMQ==", "bodyText": "I don't think failure to contact a coordinator is an error condition (at most I would log it at debug or trace and leave it up to the application/caller to report noteworthy events). Similarly for other logging at error level.", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504674301", "createdAt": "2020-10-14T13:25:24Z", "author": {"login": "mmusgrov"}, "path": "rts/lra/lra-client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java", "diffHunk": "@@ -230,6 +226,27 @@ public void setCurrentLRA(URI coordinatorUri) {\n         }\n     }\n \n+    public List<LRAData> getAllLRAs() {\n+        Client client = null;\n+        try {\n+            client = ClientBuilder.newClient();\n+            Response response = client.target(base)\n+                .request()\n+                .get();\n+\n+            if (response.getStatus() != Response.Status.OK.getStatusCode()) {\n+                LRALogger.i18NLogger.error_getAllLRAs(response.getStatus());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16dde974e7dda093485c55721af40b4a7b8688d"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY3NjA5Mg==", "bodyText": "See previous comment (close is an expensive resource).", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504676092", "createdAt": "2020-10-14T13:27:50Z", "author": {"login": "mmusgrov"}, "path": "rts/lra/lra-client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java", "diffHunk": "@@ -230,6 +226,27 @@ public void setCurrentLRA(URI coordinatorUri) {\n         }\n     }\n \n+    public List<LRAData> getAllLRAs() {\n+        Client client = null;\n+        try {\n+            client = ClientBuilder.newClient();\n+            Response response = client.target(base)\n+                .request()\n+                .get();\n+\n+            if (response.getStatus() != Response.Status.OK.getStatusCode()) {\n+                LRALogger.i18NLogger.error_getAllLRAs(response.getStatus());\n+                throw new WebApplicationException(response);\n+            }\n+\n+            return response.readEntity(new GenericType<List<LRAData>>() {});\n+        } finally {\n+            if (client != null) {\n+                client.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16dde974e7dda093485c55721af40b4a7b8688d"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDY4NzA0OQ==", "bodyText": "Who adds the header (normally it would be done by ClientLRARequestFilter but I cannot see where that gets added)?", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504687049", "createdAt": "2020-10-14T13:42:46Z", "author": {"login": "mmusgrov"}, "path": "rts/lra/lra-client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java", "diffHunk": "@@ -358,16 +383,25 @@ public URI joinLRA(URI lraId, Long timelimit,\n     }\n \n     public void leaveLRA(URI lraId, String body) throws WebApplicationException {\n-        ResponseHolder response = null;\n+        Client client = null;\n+        Response response = null;\n \n-        response = getTarget().path(String.format(leaveFormat, getLRAId(lraId.toString())))\n+        try {\n+            client = ClientBuilder.newClient();\n+\n+            response = client.target(base)\n+                .path(String.format(LEAVE_PATH, getLRAId(lraId.toString())))\n                 .request()\n-                .header(LRA_HTTP_CONTEXT_HEADER, lraId)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16dde974e7dda093485c55721af40b4a7b8688d"}, "originalPosition": 234}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcwNTY1Nw==", "bodyText": "This error code seems a bit random. The method signature is already handling it (ie it throws WebApplicationException). Also we don't need to log anything here (see my previous comments about logging errors). If you really did want to log it at trace level then just re-throw the WebApplicationException.", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504705657", "createdAt": "2020-10-14T14:05:24Z", "author": {"login": "mmusgrov"}, "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/api/Coordinator.java", "diffHunk": "@@ -238,13 +239,34 @@ public Response startLRA(\n                     return Response.status(response.getStatus()).build();\n                 }\n             } else {\n-                ResponseHolder resp = new RequestBuilder(parentLRAUrl)\n+                LRALogger.i18NLogger.error_parentLRANotFound(parentLRAUrl);\n+\n+                Client client = null;\n+                Response response = null;\n+\n+                try {\n+                    client = ClientBuilder.newClient();\n+                    response = client.target(parentLRAUrl)\n                         .request()\n-                        .async(PARTICIPANT_TIMEOUT, TimeUnit.SECONDS)\n-                        .put(compensatorUrl, MediaType.TEXT_PLAIN);\n-                if (resp.getStatus() != Response.Status.OK.getStatusCode()) {\n-                    return Response.status(resp.getStatus()).build(); // TODO include reason\n+                        .async()\n+                        .put(Entity.text(compensatorUrl))\n+                        .get(PARTICIPANT_TIMEOUT, TimeUnit.SECONDS);\n+\n+                    if (response.getStatus() != Response.Status.OK.getStatusCode()) {\n+                        String errMessage = String.format(\"The coordinator at %s returned an unexpected response: %d\",\n+                            parentLRAUrl, response.getStatus());\n+                        return Response.status(response.getStatus()).entity(errMessage).build();\n+                    }\n+                } catch (Exception e) {\n+                    LRALogger.logger.errorf(\"Cannot contact the LRA Coordinator at %s\", parentLRA);\n+                    return Response.status(PRECONDITION_FAILED).entity(e.getMessage()).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16dde974e7dda093485c55721af40b4a7b8688d"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcwOTU2Mg==", "bodyText": "WebApplicationException is the exception of choice here - since we are using JAX-RS.", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504709562", "createdAt": "2020-10-14T14:10:32Z", "author": {"login": "mmusgrov"}, "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/model/LRARecord.java", "diffHunk": "@@ -419,17 +432,21 @@ private boolean afterLRARequest(URI target, String payload) {\n                 builder.header(LRA.LRA_HTTP_CONTEXT_HEADER, lra.getId().toASCIIString());\n             }\n \n-            builder.async(PARTICIPANT_TIMEOUT, TimeUnit.SECONDS);\n-\n-            ResponseHolder response = target.equals(forgetURI) ? builder.delete() : builder.put(payload, MediaType.TEXT_PLAIN);\n+            Future<Response> responseFuture =  target.equals(forgetURI) ? builder.async().delete()\n+                : builder.async().put(Entity.text(payload));\n+            Response response = responseFuture.get(PARTICIPANT_TIMEOUT, TimeUnit.SECONDS);\n \n             if (response.getStatus() == 200) {\n                 return true;\n             }\n-        } catch (WebApplicationException e) {\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16dde974e7dda093485c55721af40b4a7b8688d"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxNDIyMQ==", "bodyText": "Similar comment as above. We are using JAX-RS so we need to use the WebApplicationException since that will already hold the relevant status code.", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504714221", "createdAt": "2020-10-14T14:16:27Z", "author": {"login": "mmusgrov"}, "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/model/LRARecord.java", "diffHunk": "@@ -718,8 +745,14 @@ boolean forget() {\n                     forgetURI, e.getMessage());\n                 // TODO write a test to ensure that recovery only retries the forget request\n                 return false; // force recovery to keep retrying\n+            } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16dde974e7dda093485c55721af40b4a7b8688d"}, "originalPosition": 202}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxNjIzNw==", "bodyText": "I would use debug here (failure to contact a participant is not particularly noteworthy since it is often an expected outcome in a distributed system).", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504716237", "createdAt": "2020-10-14T14:18:59Z", "author": {"login": "mmusgrov"}, "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/model/LRARecord.java", "diffHunk": "@@ -718,8 +745,14 @@ boolean forget() {\n                     forgetURI, e.getMessage());\n                 // TODO write a test to ensure that recovery only retries the forget request\n                 return false; // force recovery to keep retrying\n+            } catch (Exception e) {\n+                LRALogger.logger.infof(\"LRARecord.forget at '%s' could not reach participant: %s\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16dde974e7dda093485c55721af40b4a7b8688d"}, "originalPosition": 203}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxODUwNA==", "bodyText": "I like it, good find :-)", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504718504", "createdAt": "2020-10-14T14:21:58Z", "author": {"login": "mmusgrov"}, "path": "rts/lra/lra-coordinator-thorntail/src/main/java/ForkJoinClassLoading.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * JBoss, Home of Professional Open Source.\n+ * Copyright 2020, Red Hat, Inc., and individual contributors\n+ * as indicated by the @author tags. See the copyright.txt file in the\n+ * distribution for a full listing of individual contributors.\n+ *\n+ * This is free software; you can redistribute it and/or modify it\n+ * under the terms of the GNU Lesser General Public License as\n+ * published by the Free Software Foundation; either version 2.1 of\n+ * the License, or (at your option) any later version.\n+ *\n+ * This software is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU\n+ * Lesser General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Lesser General Public\n+ * License along with this software; if not, write to the Free\n+ * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA\n+ * 02110-1301 USA, or see the FSF site: http://www.fsf.org.\n+ */\n+import org.jboss.logging.Logger;\n+\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.enterprise.context.Initialized;\n+import javax.enterprise.event.Observes;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ForkJoinPool;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Originally copied from https://github.com/quarkusio/quarkus/blob/1.8.1.Final/core/deployment/src/main/java/io/quarkus/runner/bootstrap/ForkJoinClassLoading.java\n+ */\n+@ApplicationScoped\n+public class ForkJoinClassLoading {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16dde974e7dda093485c55721af40b4a7b8688d"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcxODcwNw==", "bodyText": "Not used", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504718707", "createdAt": "2020-10-14T14:22:13Z", "author": {"login": "mmusgrov"}, "path": "rts/lra/lra-coordinator/pom.xml", "diffHunk": "@@ -61,6 +61,10 @@\n     </build>\n \n     <dependencies>\n+        <dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16dde974e7dda093485c55721af40b4a7b8688d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcyMzEyNg==", "bodyText": "Failure to find a resource in a distributed system is not an error (in fact it is a common occurrence).", "url": "https://github.com/jbosstm/narayana/pull/1677#discussion_r504723126", "createdAt": "2020-10-14T14:27:40Z", "author": {"login": "mmusgrov"}, "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/api/Coordinator.java", "diffHunk": "@@ -238,13 +239,34 @@ public Response startLRA(\n                     return Response.status(response.getStatus()).build();\n                 }\n             } else {\n-                ResponseHolder resp = new RequestBuilder(parentLRAUrl)\n+                LRALogger.i18NLogger.error_parentLRANotFound(parentLRAUrl);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f16dde974e7dda093485c55721af40b4a7b8688d"}, "originalPosition": 39}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f16dde974e7dda093485c55721af40b4a7b8688d", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/f16dde974e7dda093485c55721af40b4a7b8688d", "committedDate": "2020-10-12T13:49:38Z", "message": "Replace MP REST client with JAX-RS client in lra-client module"}, "afterCommit": {"oid": "a5993ed6f616d1876c1b3e09c61013e02bdcc46a", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/a5993ed6f616d1876c1b3e09c61013e02bdcc46a", "committedDate": "2020-10-15T12:18:05Z", "message": "Replace Apache HttpClient with JAX-RS client in LRA modules"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a5993ed6f616d1876c1b3e09c61013e02bdcc46a", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/a5993ed6f616d1876c1b3e09c61013e02bdcc46a", "committedDate": "2020-10-15T12:18:05Z", "message": "Replace Apache HttpClient with JAX-RS client in LRA modules"}, "afterCommit": {"oid": "f199e5388b7d4c9977038d322d773eb1bf8f0954", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/f199e5388b7d4c9977038d322d773eb1bf8f0954", "committedDate": "2020-10-15T12:20:25Z", "message": "[JBTM-3189] Resteasy providers are absent when a thread from the ForkJoinPool is used to cancel the LRA"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f199e5388b7d4c9977038d322d773eb1bf8f0954", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/f199e5388b7d4c9977038d322d773eb1bf8f0954", "committedDate": "2020-10-15T12:20:25Z", "message": "[JBTM-3189] Resteasy providers are absent when a thread from the ForkJoinPool is used to cancel the LRA"}, "afterCommit": {"oid": "fce240983b02982cdc3c52325f118def71b7b7db", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/fce240983b02982cdc3c52325f118def71b7b7db", "committedDate": "2020-10-15T12:37:43Z", "message": "[JBTM-3189] Resteasy providers are absent when a thread from the ForkJoinPool is used to cancel the LRA"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fce240983b02982cdc3c52325f118def71b7b7db", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/fce240983b02982cdc3c52325f118def71b7b7db", "committedDate": "2020-10-15T12:37:43Z", "message": "[JBTM-3189] Resteasy providers are absent when a thread from the ForkJoinPool is used to cancel the LRA"}, "afterCommit": {"oid": "4fa4ce2db63d134ac88fc28a70853650497fe20d", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/4fa4ce2db63d134ac88fc28a70853650497fe20d", "committedDate": "2020-10-15T12:44:31Z", "message": "[JBTM-3349] Replace Apache HttpClient with JAX-RS client in LRA modules\n\nAlso contains a fix for JBTM-3189 Resteasy providers are absent when a thread from the ForkJoinPool is used to cancel the LRA"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwMjY2MzQz", "url": "https://github.com/jbosstm/narayana/pull/1677#pullrequestreview-510266343", "createdAt": "2020-10-16T08:39:09Z", "commit": {"oid": "4fa4ce2db63d134ac88fc28a70853650497fe20d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfc9774b22ae593dc9d71d329b64f7ad046c64b1", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/dfc9774b22ae593dc9d71d329b64f7ad046c64b1", "committedDate": "2020-10-16T09:33:58Z", "message": "[JBTM-3349] Replace Apache HttpClient with JAX-RS client in LRA modules\n\nAlso contains a fix for JBTM-3189 Resteasy providers are absent when a thread from the ForkJoinPool is used to cancel the LRA"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4fa4ce2db63d134ac88fc28a70853650497fe20d", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/4fa4ce2db63d134ac88fc28a70853650497fe20d", "committedDate": "2020-10-15T12:44:31Z", "message": "[JBTM-3349] Replace Apache HttpClient with JAX-RS client in LRA modules\n\nAlso contains a fix for JBTM-3189 Resteasy providers are absent when a thread from the ForkJoinPool is used to cancel the LRA"}, "afterCommit": {"oid": "dfc9774b22ae593dc9d71d329b64f7ad046c64b1", "author": {"user": {"login": "xstefank", "name": "Martin Stefanko"}}, "url": "https://github.com/jbosstm/narayana/commit/dfc9774b22ae593dc9d71d329b64f7ad046c64b1", "committedDate": "2020-10-16T09:33:58Z", "message": "[JBTM-3349] Replace Apache HttpClient with JAX-RS client in LRA modules\n\nAlso contains a fix for JBTM-3189 Resteasy providers are absent when a thread from the ForkJoinPool is used to cancel the LRA"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4464, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}