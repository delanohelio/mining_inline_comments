{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxMjM0OTk3", "number": 1626, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNzo1NjowMVrOD-sYHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwOToyODozMlrOD_mFAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3MDY1Mzc0OnYy", "diffSide": "RIGHT", "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/model/Transaction.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNzo1NjowMVrOGY867A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNzo1NjowMVrOGY867A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODgxNzEzMg==", "bodyText": "just two ideas\n\ncould be pending null or it could not be?\nI would, personally and if I don't miss some detail, consider more readable the lamda style like pending.removeIf(record -> record.forget())", "url": "https://github.com/jbosstm/narayana/pull/1626#discussion_r428817132", "createdAt": "2020-05-21T17:56:01Z", "author": {"login": "ochaloup"}, "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/model/Transaction.java", "diffHunk": "@@ -690,10 +697,21 @@ public boolean forgetParticipant(String participantUrl) {\n         return findLRAParticipant(participantUrl, true) != null;\n     }\n \n-    public void forgetAllParticipants() {\n-        if (pending != null) {\n-            pending.forEach(LRARecord::forget);\n+    public boolean forgetAllParticipants() {\n+        boolean notifiedAll = true;\n+\n+        Iterator<LRARecord> iterator = pending.iterator();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fdd62431d14c2f1eefd3e2cce92acaf58010509d"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MDEwNzU1OnYy", "diffSide": "RIGHT", "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/model/Transaction.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwOToyODozMlrOGaWIJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwOTozMjo1NFrOGdpvuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI3ODY5Mg==", "bodyText": "Do we need to call runPostLRAActions();. Have you tested your changes with an AfterLRAListener registered with the nested LRA?", "url": "https://github.com/jbosstm/narayana/pull/1626#discussion_r430278692", "createdAt": "2020-05-26T09:28:32Z", "author": {"login": "mmusgrov"}, "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/model/Transaction.java", "diffHunk": "@@ -480,7 +480,13 @@ private int doEnd(boolean cancel) {\n                     status = toLRAStatus(status());\n                 } else {\n                     // forget calls for nested participants\n-                    forgetAllParticipants();\n+                    if (forgetAllParticipants()) {\n+                        updateState(LRAStatus.Closed);\n+                        return ActionStatus.COMMITTED;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0351d68661591df1fd53bd81d741fc7ded362bfb"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM0ODgxOQ==", "bodyText": "AfterLRA notifications should depend on the outcome of forget calls, as nested LRA is not finished before forget calls are delivered. Or did I misunderstood the scenario? I can add such test if needed.", "url": "https://github.com/jbosstm/narayana/pull/1626#discussion_r430348819", "createdAt": "2020-05-26T11:41:06Z", "author": {"login": "xstefank"}, "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/model/Transaction.java", "diffHunk": "@@ -480,7 +480,13 @@ private int doEnd(boolean cancel) {\n                     status = toLRAStatus(status());\n                 } else {\n                     // forget calls for nested participants\n-                    forgetAllParticipants();\n+                    if (forgetAllParticipants()) {\n+                        updateState(LRAStatus.Closed);\n+                        return ActionStatus.COMMITTED;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI3ODY5Mg=="}, "originalCommit": {"oid": "0351d68661591df1fd53bd81d741fc7ded362bfb"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDk3MTA4Mw==", "bodyText": "After your code changes the transaction end logic finishes early and you are skipping a section of code that we currently execute. In particular the code on line\n\n  \n    \n      narayana/rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/model/Transaction.java\n    \n    \n         Line 520\n      in\n      0351d68\n    \n    \n    \n    \n\n        \n          \n           runPostLRAActions(); \n        \n    \n  \n\n that was designed to perform the AfterLRA notifications is skipped.", "url": "https://github.com/jbosstm/narayana/pull/1626#discussion_r430971083", "createdAt": "2020-05-27T09:10:09Z", "author": {"login": "mmusgrov"}, "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/model/Transaction.java", "diffHunk": "@@ -480,7 +480,13 @@ private int doEnd(boolean cancel) {\n                     status = toLRAStatus(status());\n                 } else {\n                     // forget calls for nested participants\n-                    forgetAllParticipants();\n+                    if (forgetAllParticipants()) {\n+                        updateState(LRAStatus.Closed);\n+                        return ActionStatus.COMMITTED;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI3ODY5Mg=="}, "originalCommit": {"oid": "0351d68661591df1fd53bd81d741fc7ded362bfb"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIyMzA3Mg==", "bodyText": "sorry @mmusgrov I've just got back to this. So if I remove this return statement then it should be ok right?", "url": "https://github.com/jbosstm/narayana/pull/1626#discussion_r433223072", "createdAt": "2020-06-01T13:08:33Z", "author": {"login": "xstefank"}, "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/model/Transaction.java", "diffHunk": "@@ -480,7 +480,13 @@ private int doEnd(boolean cancel) {\n                     status = toLRAStatus(status());\n                 } else {\n                     // forget calls for nested participants\n-                    forgetAllParticipants();\n+                    if (forgetAllParticipants()) {\n+                        updateState(LRAStatus.Closed);\n+                        return ActionStatus.COMMITTED;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI3ODY5Mg=="}, "originalCommit": {"oid": "0351d68661591df1fd53bd81d741fc7ded362bfb"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxMDg5Nw==", "bodyText": "@mmusgrov actually, it doesn't seem to matter to return here. I've added the test as you've requested.", "url": "https://github.com/jbosstm/narayana/pull/1626#discussion_r433410897", "createdAt": "2020-06-01T18:27:11Z", "author": {"login": "xstefank"}, "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/model/Transaction.java", "diffHunk": "@@ -480,7 +480,13 @@ private int doEnd(boolean cancel) {\n                     status = toLRAStatus(status());\n                 } else {\n                     // forget calls for nested participants\n-                    forgetAllParticipants();\n+                    if (forgetAllParticipants()) {\n+                        updateState(LRAStatus.Closed);\n+                        return ActionStatus.COMMITTED;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI3ODY5Mg=="}, "originalCommit": {"oid": "0351d68661591df1fd53bd81d741fc7ded362bfb"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzc0NTg0OQ==", "bodyText": "I am still uncomfortable why this route through the end() routine is returning early. No other code path returns early so it makes maintaining this method more difficult. We either need to avoid the early return or fully comment why it is safe to do so.\nThanks for the extra test - I didn't really understand what is was doing so some commentary would have been helpful to the both the reviewer and to future maintainers.", "url": "https://github.com/jbosstm/narayana/pull/1626#discussion_r433745849", "createdAt": "2020-06-02T09:32:54Z", "author": {"login": "mmusgrov"}, "path": "rts/lra/lra-coordinator-jar/src/main/java/io/narayana/lra/coordinator/domain/model/Transaction.java", "diffHunk": "@@ -480,7 +480,13 @@ private int doEnd(boolean cancel) {\n                     status = toLRAStatus(status());\n                 } else {\n                     // forget calls for nested participants\n-                    forgetAllParticipants();\n+                    if (forgetAllParticipants()) {\n+                        updateState(LRAStatus.Closed);\n+                        return ActionStatus.COMMITTED;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI3ODY5Mg=="}, "originalCommit": {"oid": "0351d68661591df1fd53bd81d741fc7ded362bfb"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1175, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}