{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxMDIyNTI4", "number": 1748, "title": "JBTM-3213 Allow request timeouts to be configurable. Enable throttlin\u2026", "bodyText": "https://issues.redhat.com/browse/JBTM-3213\n!MAIN !CORE !QA_JTA !QA_JTS_JDKORB !QA_JTS_OPENJDKORB !QA_JTS_JACORB !BLACKTIE !XTS !PERF NO_WIN !RTS !AS_TESTS !TOMCAT !JACOCO\nLRA\nThis is a partial fix for JBTM-3213 and the PR increases the resilience of LRA to overload. The PR:\n\nallows throttling of LRA start requests to be configurable;\nallows clients to control how long coordinator requests can take before giving up. The PR adds separate properties for things like starting, joining, ending LRAs etc. We need separate properties since some request failures are more serious than others (eg failure to abort an LRA is significantly more problematic than are failures to start or join with LRAs).\n\nThere is a lot we can do in this area [fault resilience] and we have a few JIRAs for tackling the various requirements.\nBut this PR is a basic minimum to reduce the number of errors caused by overloading the system in which LRA operates.", "createdAt": "2020-12-16T09:32:58Z", "url": "https://github.com/jbosstm/narayana/pull/1748", "merged": true, "mergeCommit": {"oid": "81172ab1e1cf50619dfd252386ab43cf78e626e2"}, "closed": true, "closedAt": "2020-12-18T16:52:34Z", "author": {"login": "mmusgrov"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmwBT9AFqTU1MzczNjU2OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnEf63ABqjQxMjU0MDUwMTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNzM2NTY5", "url": "https://github.com/jbosstm/narayana/pull/1748#pullrequestreview-553736569", "createdAt": "2020-12-16T14:26:27Z", "commit": {"oid": "098d46097f3a0e8957d4507717a80564eccca055"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNDoyNjoyN1rOIHH4KQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNDo0MTozMVrOIHImPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM0MDAwOQ==", "bodyText": "The versions would be better to be configurable with properties.", "url": "https://github.com/jbosstm/narayana/pull/1748#discussion_r544340009", "createdAt": "2020-12-16T14:26:27Z", "author": {"login": "ochaloup"}, "path": "rts/lra/coordinator/pom.xml", "diffHunk": "@@ -28,6 +28,11 @@\n             <artifactId>microprofile-lra-api</artifactId>\n             <version>${version.microprofile.lra.api}</version>\n         </dependency>\n+        <dependency>\n+            <groupId>org.eclipse.microprofile.fault-tolerance</groupId>\n+            <artifactId>microprofile-fault-tolerance-api</artifactId>\n+            <version>2.1.1</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "098d46097f3a0e8957d4507717a80564eccca055"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM0Mzk2MA==", "bodyText": "Would not be good to have one system property to define all client timeout values at once and on top of that to provide ability to granularly change the particular value?", "url": "https://github.com/jbosstm/narayana/pull/1748#discussion_r544343960", "createdAt": "2020-12-16T14:31:26Z", "author": {"login": "ochaloup"}, "path": "rts/lra/client/src/main/java/io/narayana/lra/client/NarayanaLRAClient.java", "diffHunk": "@@ -124,7 +124,11 @@\n      * WARNING: NarayanaLRAClient is an internal utility class and is subject to change\n      * (but it will be made available with improved guarantees in a subsequent release).\n      */\n-    private static final long CLIENT_TIMEOUT = Long.getLong(\"lra.internal.client.timeout\", 10);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "098d46097f3a0e8957d4507717a80564eccca055"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM1MTU2NQ==", "bodyText": "I'm interested what is the reason for taking the faultolerance @Bulkhead on start method.\nHaving the fault tolerance capability is probably fine but why not other options (e.g. @Retry)? Why we want to work with only 10 parallel requests - what is the reason? Are we fine in adding one more dependency to the mix for the LRA processing?", "url": "https://github.com/jbosstm/narayana/pull/1748#discussion_r544351565", "createdAt": "2020-12-16T14:41:16Z", "author": {"login": "ochaloup"}, "path": "rts/lra/coordinator/src/main/java/io/narayana/lra/coordinator/api/Coordinator.java", "diffHunk": "@@ -189,6 +191,7 @@ public LRAData getLRAInfo(\n     @POST\n     @Path(\"start\")\n     @Produces(MediaType.TEXT_PLAIN)\n+    @Bulkhead", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "098d46097f3a0e8957d4507717a80564eccca055"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM1MTgwNg==", "bodyText": "Is the compile scope considered as the right one for this?", "url": "https://github.com/jbosstm/narayana/pull/1748#discussion_r544351806", "createdAt": "2020-12-16T14:41:31Z", "author": {"login": "ochaloup"}, "path": "rts/lra/coordinator/pom.xml", "diffHunk": "@@ -28,6 +28,11 @@\n             <artifactId>microprofile-lra-api</artifactId>\n             <version>${version.microprofile.lra.api}</version>\n         </dependency>\n+        <dependency>\n+            <groupId>org.eclipse.microprofile.fault-tolerance</groupId>\n+            <artifactId>microprofile-fault-tolerance-api</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "098d46097f3a0e8957d4507717a80564eccca055"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NDIwMjg2", "url": "https://github.com/jbosstm/narayana/pull/1748#pullrequestreview-554420286", "createdAt": "2020-12-17T09:28:27Z", "commit": {"oid": "098d46097f3a0e8957d4507717a80564eccca055"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwOToyODoyN1rOIHsXvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwOToyODoyN1rOIHsXvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDkzNzkxOQ==", "bodyText": "Generally, this PR looks good. But I just want to point out that @Bulkhead is only reducing concurrent executions of the method thus at max 10 threads can run start at the same time but that doesn't correspond to the reduction of the number of active LRAs that the coordinator manages. The erroneous state can still be reached but it would take a few retries on the /start calls.", "url": "https://github.com/jbosstm/narayana/pull/1748#discussion_r544937919", "createdAt": "2020-12-17T09:28:27Z", "author": {"login": "xstefank"}, "path": "rts/lra/coordinator/src/main/java/io/narayana/lra/coordinator/api/Coordinator.java", "diffHunk": "@@ -189,6 +191,7 @@ public LRAData getLRAInfo(\n     @POST\n     @Path(\"start\")\n     @Produces(MediaType.TEXT_PLAIN)\n+    @Bulkhead", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM1MTU2NQ=="}, "originalCommit": {"oid": "098d46097f3a0e8957d4507717a80564eccca055"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NDM1Mzk0", "url": "https://github.com/jbosstm/narayana/pull/1748#pullrequestreview-554435394", "createdAt": "2020-12-17T09:46:47Z", "commit": {"oid": "098d46097f3a0e8957d4507717a80564eccca055"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "098d46097f3a0e8957d4507717a80564eccca055", "author": {"user": {"login": "mmusgrov", "name": "Michael Musgrove"}}, "url": "https://github.com/jbosstm/narayana/commit/098d46097f3a0e8957d4507717a80564eccca055", "committedDate": "2020-12-16T09:22:37Z", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}, "afterCommit": {"oid": "0fe9ee8db312deb0b96e3928f48c1bba15dc2f43", "author": {"user": {"login": "mmusgrov", "name": "Michael Musgrove"}}, "url": "https://github.com/jbosstm/narayana/commit/0fe9ee8db312deb0b96e3928f48c1bba15dc2f43", "committedDate": "2020-12-17T12:48:51Z", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NjI1NjAz", "url": "https://github.com/jbosstm/narayana/pull/1748#pullrequestreview-554625603", "createdAt": "2020-12-17T13:56:54Z", "commit": {"oid": "0fe9ee8db312deb0b96e3928f48c1bba15dc2f43"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMzo1Njo1NFrOIH2yZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMzo1ODoyM1rOIH22aQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTEwODU4MQ==", "bodyText": "My point is the best described in way that I think the dependency should be in scope provided. The app runtime then loads the api library. It won't be the application that defines it.", "url": "https://github.com/jbosstm/narayana/pull/1748#discussion_r545108581", "createdAt": "2020-12-17T13:56:54Z", "author": {"login": "ochaloup"}, "path": "rts/lra/coordinator/pom.xml", "diffHunk": "@@ -28,6 +28,11 @@\n             <artifactId>microprofile-lra-api</artifactId>\n             <version>${version.microprofile.lra.api}</version>\n         </dependency>\n+        <dependency>\n+            <groupId>org.eclipse.microprofile.fault-tolerance</groupId>\n+            <artifactId>microprofile-fault-tolerance-api</artifactId>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM1MTgwNg=="}, "originalCommit": {"oid": "098d46097f3a0e8957d4507717a80564eccca055"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTEwOTYwOQ==", "bodyText": "I like this change ;-)", "url": "https://github.com/jbosstm/narayana/pull/1748#discussion_r545109609", "createdAt": "2020-12-17T13:58:23Z", "author": {"login": "ochaloup"}, "path": "rts/lra/jaxrs/src/main/java/io/narayana/lra/filter/ServerLRAFilter.java", "diffHunk": "@@ -87,8 +87,7 @@\n \n     private static final Pattern START_END_QUOTES_PATTERN = Pattern.compile(\"^\\\"|\\\"$\");\n     private static final long DEFAULT_TIMEOUT_MILLIS = 0L;\n-    // i18nMessageCode corresponding to lraI18NLogger#warn_LRAStatusInDoubt\n-    private static final int i18nMessageCode = 25145;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fe9ee8db312deb0b96e3928f48c1bba15dc2f43"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NjUwODg3", "url": "https://github.com/jbosstm/narayana/pull/1748#pullrequestreview-554650887", "createdAt": "2020-12-17T14:24:33Z", "commit": {"oid": "0fe9ee8db312deb0b96e3928f48c1bba15dc2f43"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90f1b20fcb5b35c07fcfa1dc54f00b5fa19967bc", "author": {"user": {"login": "mmusgrov", "name": "Michael Musgrove"}}, "url": "https://github.com/jbosstm/narayana/commit/90f1b20fcb5b35c07fcfa1dc54f00b5fa19967bc", "committedDate": "2020-12-17T14:34:34Z", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0fe9ee8db312deb0b96e3928f48c1bba15dc2f43", "author": {"user": {"login": "mmusgrov", "name": "Michael Musgrove"}}, "url": "https://github.com/jbosstm/narayana/commit/0fe9ee8db312deb0b96e3928f48c1bba15dc2f43", "committedDate": "2020-12-17T12:48:51Z", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}, "afterCommit": {"oid": "90f1b20fcb5b35c07fcfa1dc54f00b5fa19967bc", "author": {"user": {"login": "mmusgrov", "name": "Michael Musgrove"}}, "url": "https://github.com/jbosstm/narayana/commit/90f1b20fcb5b35c07fcfa1dc54f00b5fa19967bc", "committedDate": "2020-12-17T14:34:34Z", "message": "JBTM-3213 Allow request timeouts to be configurable. Enable throttling of requests to start new LRAs."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4421, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}