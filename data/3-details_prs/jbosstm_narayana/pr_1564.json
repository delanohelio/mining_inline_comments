{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0MTg2MjQ3", "number": 1564, "title": "JBTM-3262  improve string serialization", "bodyText": "https://issues.redhat.com/browse/JBTM-3262\n!AS_TESTS !TOMCAT !JACOCO !LRA !BLACKTIE\n!PERF  !QA_JTA !RTS !QA_JTS_OPENJDKORB !XTS !QA_JTS_JDKORB !QA_JTS_JACORB", "createdAt": "2020-03-05T10:19:34Z", "url": "https://github.com/jbosstm/narayana/pull/1564", "merged": true, "mergeCommit": {"oid": "0b511d470f7ab8dedf585cb14d4900170684621b"}, "closed": true, "closedAt": "2020-03-16T16:21:46Z", "author": {"login": "jhalliday"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKr7dHgFqTM2OTU4MjI2OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOQmgrAFqTM3NTM3NDg1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NTgyMjY4", "url": "https://github.com/jbosstm/narayana/pull/1564#pullrequestreview-369582268", "createdAt": "2020-03-05T13:51:02Z", "commit": {"oid": "aed8dc5cf6387e6bfb3408a244d3a2a2e165eb48"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMzo1MTowM1rOFyUORQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMzo1NTo0MFrOFyUZEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMwNDQ1Mw==", "bodyText": "What is the performance difference between packing the bytes directly versus packing the string - is it that the string copy (os.packString(StateManager.marker)) is avoided?", "url": "https://github.com/jbosstm/narayana/pull/1564#discussion_r388304453", "createdAt": "2020-03-05T13:51:03Z", "author": {"login": "mmusgrov"}, "path": "ArjunaCore/arjuna/classes/com/arjuna/ats/arjuna/StateManager.java", "diffHunk": "@@ -641,12 +642,12 @@ protected void packHeader (OutputObjectState os, Header hdr)\n \n         Uid txId = ((hdr == null) ? null : hdr.getTxId());\n         Uid processUid = ((hdr == null) ? null : hdr.getProcessId());\n-        \n+\n         try\n         {\n             // pack the marker first.\n \n-            os.packString(StateManager.marker);\n+            os.packStringBytes(markerBytes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aed8dc5cf6387e6bfb3408a244d3a2a2e165eb48"}, "originalPosition": 161}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMwNzIxNg==", "bodyText": "Just a question - did the original code add space for the string delimiter but not actually pack it into the output buffer? How did you uncover this bug?", "url": "https://github.com/jbosstm/narayana/pull/1564#discussion_r388307216", "createdAt": "2020-03-05T13:55:40Z", "author": {"login": "mmusgrov"}, "path": "ArjunaCore/arjuna/classes/com/arjuna/ats/arjuna/state/OutputBuffer.java", "diffHunk": "@@ -358,26 +358,26 @@ public final synchronized void packString (String s) throws IOException\n         if (!_valid)\n             throw new IOException(tsLogger.i18NLogger.get_state_OutputBuffer_10());\n \n-        int sz = 0;\n-        String dummy = null;\n-\n-        if (s != null)\n-        {\n-            sz = s.length() + 1;\n-            dummy = s + '\\0';\n+        if(s == null) {\n+            packInt(0);\n+        } else {\n+            packStringBytes( s.getBytes(StandardCharsets.UTF_8) );\n+        }\n+    }\n \n+    public final synchronized void packStringBytes(byte[] bytes) throws IOException\n+    {\n+        if (!_valid || bytes == null) {\n+            throw new IOException(tsLogger.i18NLogger.get_state_OutputBuffer_10());\n         }\n \n-        packInt(sz);\n+        packInt(bytes.length+1);\n \n         _valid = false;\n \n-        if (sz > 0)\n-        {\n-            byte[] bytes = dummy.getBytes(StandardCharsets.UTF_8);\n-            _output.write(bytes, 0, bytes.length);\n-            realign(bytes.length);\n-        }\n+        _output.write(bytes, 0, bytes.length);\n+        _output.writeByte(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cbe156bd6f7066d43f4b048082a569e63e78288"}, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NzgwOTc5", "url": "https://github.com/jbosstm/narayana/pull/1564#pullrequestreview-369780979", "createdAt": "2020-03-05T17:45:06Z", "commit": {"oid": "aed8dc5cf6387e6bfb3408a244d3a2a2e165eb48"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNzA5Mzgy", "url": "https://github.com/jbosstm/narayana/pull/1564#pullrequestreview-373709382", "createdAt": "2020-03-12T16:25:31Z", "commit": {"oid": "b51268661510914a52dd71a0393d374d6bd3d45c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fb7a387fbc426071201b28a83ee0ccd95cd90f3", "author": {"user": {"login": "jhalliday", "name": "Jonathan Halliday"}}, "url": "https://github.com/jbosstm/narayana/commit/0fb7a387fbc426071201b28a83ee0ccd95cd90f3", "committedDate": "2020-03-13T10:05:29Z", "message": "JBTM-3262 improve string serialization"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b51268661510914a52dd71a0393d374d6bd3d45c", "author": {"user": {"login": "jhalliday", "name": "Jonathan Halliday"}}, "url": "https://github.com/jbosstm/narayana/commit/b51268661510914a52dd71a0393d374d6bd3d45c", "committedDate": "2020-03-11T15:30:48Z", "message": "JBTM-3262 improve string serialization"}, "afterCommit": {"oid": "0fb7a387fbc426071201b28a83ee0ccd95cd90f3", "author": {"user": {"login": "jhalliday", "name": "Jonathan Halliday"}}, "url": "https://github.com/jbosstm/narayana/commit/0fb7a387fbc426071201b28a83ee0ccd95cd90f3", "committedDate": "2020-03-13T10:05:29Z", "message": "JBTM-3262 improve string serialization"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1Mzc0ODUy", "url": "https://github.com/jbosstm/narayana/pull/1564#pullrequestreview-375374852", "createdAt": "2020-03-16T16:21:34Z", "commit": {"oid": "0fb7a387fbc426071201b28a83ee0ccd95cd90f3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4526, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}