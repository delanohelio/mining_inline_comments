{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5NTYxNzQx", "number": 1635, "title": "HDDS-4524. Create freon test to measure closed container replication", "bodyText": "What changes were proposed in this pull request?\nCreate new Freon test for the closed container replication.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4524\nHow was this patch tested?\n#Generate keys\nozone ockg -n 10\n#Close container\nozone container close 1\n#Execute freon\nozone freon cr\n\nContainers supposed to be visible under /tmp/....\nNote: this patch requires the changes in #1551", "createdAt": "2020-11-30T13:47:59Z", "url": "https://github.com/apache/ozone/pull/1635", "merged": true, "mergeCommit": {"oid": "247dad577c644ee373e07f4b4a22a727a7c660b8"}, "closed": true, "closedAt": "2021-01-10T07:36:49Z", "author": {"login": "elek"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhk9XogH2gAyNTI5NTYxNzQxOjBmMWY2MmZkMWEyNDQ2YmIzNWFiNzQ2NDMzNjRkODM1YzQ2NjdhOTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABduMpT0AFqTU2NDQ2OTQzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0f1f62fd1a2446bb35ab74643364d835c4667a97", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/0f1f62fd1a2446bb35ab74643364d835c4667a97", "committedDate": "2020-11-30T13:00:21Z", "message": "HDDS-4524. Create freon test to measure closed container replication"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99c4b387759d7bce6086999cc6a222dbefdeaff0", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/99c4b387759d7bce6086999cc6a222dbefdeaff0", "committedDate": "2020-11-30T13:23:58Z", "message": "fixes before pr"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5Njk5NDcy", "url": "https://github.com/apache/ozone/pull/1635#pullrequestreview-549699472", "createdAt": "2020-12-10T23:42:47Z", "commit": {"oid": "99c4b387759d7bce6086999cc6a222dbefdeaff0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMzo0Mjo0N1rOIDijZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMzo0NDo0NVrOIDimWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU4Mjc1Ng==", "bodyText": "specified.", "url": "https://github.com/apache/ozone/pull/1635#discussion_r540582756", "createdAt": "2020-12-10T23:42:47Z", "author": {"login": "jojochuang"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/freon/ClosedContainerReplicator.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.ozone.freon;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.stream.Collectors;\n+\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdds.protocol.DatanodeDetails;\n+import org.apache.hadoop.hdds.protocol.datanode.proto.ContainerProtos.ContainerType;\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos.LifeCycleState;\n+import org.apache.hadoop.hdds.scm.cli.ContainerOperationClient;\n+import org.apache.hadoop.hdds.scm.container.ContainerInfo;\n+import org.apache.hadoop.hdds.scm.container.common.helpers.ContainerWithPipeline;\n+import org.apache.hadoop.ozone.container.common.helpers.ContainerMetrics;\n+import org.apache.hadoop.ozone.container.common.impl.ContainerSet;\n+import org.apache.hadoop.ozone.container.common.interfaces.Handler;\n+import org.apache.hadoop.ozone.container.common.volume.MutableVolumeSet;\n+import org.apache.hadoop.ozone.container.keyvalue.TarContainerPacker;\n+import org.apache.hadoop.ozone.container.ozoneimpl.ContainerController;\n+import org.apache.hadoop.ozone.container.replication.ContainerReplicator;\n+import org.apache.hadoop.ozone.container.replication.DownloadAndImportReplicator;\n+import org.apache.hadoop.ozone.container.replication.ReplicationSupervisor;\n+import org.apache.hadoop.ozone.container.replication.ReplicationTask;\n+import org.apache.hadoop.ozone.container.replication.SimpleContainerDownloader;\n+\n+import com.codahale.metrics.Timer;\n+import org.jetbrains.annotations.NotNull;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Option;\n+\n+/**\n+ * Utility to replicated closed container with datanode code.\n+ */\n+@Command(name = \"cr\",\n+    aliases = \"container-replicator\",\n+    description = \"Replicate / download closed containers.\",\n+    versionProvider = HddsVersionProvider.class,\n+    mixinStandardHelpOptions = true,\n+    showDefaultValues = true)\n+public class ClosedContainerReplicator extends BaseFreonGenerator implements\n+    Callable<Void> {\n+\n+  @Option(names = {\"--datanode\"},\n+      description = \"Replicate only containers on this specific datanode.\",\n+      defaultValue = \"\")\n+  private String datanode;\n+\n+  private ReplicationSupervisor supervisor;\n+\n+  private Timer timer;\n+\n+  private List<ReplicationTask> replicationTasks;\n+\n+  @Override\n+  public Void call() throws Exception {\n+\n+    //logic same as the download+import on the destination datanode\n+    OzoneConfiguration conf = initializeReplicationSupervisor();\n+\n+    final ContainerOperationClient containerOperationClient =\n+        new ContainerOperationClient(conf);\n+\n+    final List<ContainerInfo> containerInfos =\n+        containerOperationClient.listContainer(0L, 1_000_000);\n+\n+    replicationTasks = new ArrayList<>();\n+\n+    for (ContainerInfo container : containerInfos) {\n+\n+      final ContainerWithPipeline containerWithPipeline =\n+          containerOperationClient\n+              .getContainerWithPipeline(container.getContainerID());\n+\n+      if (container.getState() == LifeCycleState.CLOSED) {\n+\n+        final List<DatanodeDetails> datanodesWithContainer =\n+            containerWithPipeline.getPipeline().getNodes();\n+\n+        final List<String> datanodeUUIDs =\n+            datanodesWithContainer\n+                .stream().map(DatanodeDetails::getUuidString)\n+                .collect(Collectors.toList());\n+\n+        //if datanode is specific replicate only container if has a replica.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99c4b387759d7bce6086999cc6a222dbefdeaff0"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU4MzMxNw==", "bodyText": "typically ppl use String.isEmpty() instead.", "url": "https://github.com/apache/ozone/pull/1635#discussion_r540583317", "createdAt": "2020-12-10T23:44:18Z", "author": {"login": "jojochuang"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/freon/ClosedContainerReplicator.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.ozone.freon;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.stream.Collectors;\n+\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdds.protocol.DatanodeDetails;\n+import org.apache.hadoop.hdds.protocol.datanode.proto.ContainerProtos.ContainerType;\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos.LifeCycleState;\n+import org.apache.hadoop.hdds.scm.cli.ContainerOperationClient;\n+import org.apache.hadoop.hdds.scm.container.ContainerInfo;\n+import org.apache.hadoop.hdds.scm.container.common.helpers.ContainerWithPipeline;\n+import org.apache.hadoop.ozone.container.common.helpers.ContainerMetrics;\n+import org.apache.hadoop.ozone.container.common.impl.ContainerSet;\n+import org.apache.hadoop.ozone.container.common.interfaces.Handler;\n+import org.apache.hadoop.ozone.container.common.volume.MutableVolumeSet;\n+import org.apache.hadoop.ozone.container.keyvalue.TarContainerPacker;\n+import org.apache.hadoop.ozone.container.ozoneimpl.ContainerController;\n+import org.apache.hadoop.ozone.container.replication.ContainerReplicator;\n+import org.apache.hadoop.ozone.container.replication.DownloadAndImportReplicator;\n+import org.apache.hadoop.ozone.container.replication.ReplicationSupervisor;\n+import org.apache.hadoop.ozone.container.replication.ReplicationTask;\n+import org.apache.hadoop.ozone.container.replication.SimpleContainerDownloader;\n+\n+import com.codahale.metrics.Timer;\n+import org.jetbrains.annotations.NotNull;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Option;\n+\n+/**\n+ * Utility to replicated closed container with datanode code.\n+ */\n+@Command(name = \"cr\",\n+    aliases = \"container-replicator\",\n+    description = \"Replicate / download closed containers.\",\n+    versionProvider = HddsVersionProvider.class,\n+    mixinStandardHelpOptions = true,\n+    showDefaultValues = true)\n+public class ClosedContainerReplicator extends BaseFreonGenerator implements\n+    Callable<Void> {\n+\n+  @Option(names = {\"--datanode\"},\n+      description = \"Replicate only containers on this specific datanode.\",\n+      defaultValue = \"\")\n+  private String datanode;\n+\n+  private ReplicationSupervisor supervisor;\n+\n+  private Timer timer;\n+\n+  private List<ReplicationTask> replicationTasks;\n+\n+  @Override\n+  public Void call() throws Exception {\n+\n+    //logic same as the download+import on the destination datanode\n+    OzoneConfiguration conf = initializeReplicationSupervisor();\n+\n+    final ContainerOperationClient containerOperationClient =\n+        new ContainerOperationClient(conf);\n+\n+    final List<ContainerInfo> containerInfos =\n+        containerOperationClient.listContainer(0L, 1_000_000);\n+\n+    replicationTasks = new ArrayList<>();\n+\n+    for (ContainerInfo container : containerInfos) {\n+\n+      final ContainerWithPipeline containerWithPipeline =\n+          containerOperationClient\n+              .getContainerWithPipeline(container.getContainerID());\n+\n+      if (container.getState() == LifeCycleState.CLOSED) {\n+\n+        final List<DatanodeDetails> datanodesWithContainer =\n+            containerWithPipeline.getPipeline().getNodes();\n+\n+        final List<String> datanodeUUIDs =\n+            datanodesWithContainer\n+                .stream().map(DatanodeDetails::getUuidString)\n+                .collect(Collectors.toList());\n+\n+        //if datanode is specific replicate only container if has a replica.\n+        if (datanode.equals(\"\") || datanodeUUIDs.contains(datanode)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99c4b387759d7bce6086999cc6a222dbefdeaff0"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU4MzUxNQ==", "bodyText": "String.isEmpty()?", "url": "https://github.com/apache/ozone/pull/1635#discussion_r540583515", "createdAt": "2020-12-10T23:44:45Z", "author": {"login": "jojochuang"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/freon/ClosedContainerReplicator.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.ozone.freon;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.stream.Collectors;\n+\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdds.protocol.DatanodeDetails;\n+import org.apache.hadoop.hdds.protocol.datanode.proto.ContainerProtos.ContainerType;\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos.LifeCycleState;\n+import org.apache.hadoop.hdds.scm.cli.ContainerOperationClient;\n+import org.apache.hadoop.hdds.scm.container.ContainerInfo;\n+import org.apache.hadoop.hdds.scm.container.common.helpers.ContainerWithPipeline;\n+import org.apache.hadoop.ozone.container.common.helpers.ContainerMetrics;\n+import org.apache.hadoop.ozone.container.common.impl.ContainerSet;\n+import org.apache.hadoop.ozone.container.common.interfaces.Handler;\n+import org.apache.hadoop.ozone.container.common.volume.MutableVolumeSet;\n+import org.apache.hadoop.ozone.container.keyvalue.TarContainerPacker;\n+import org.apache.hadoop.ozone.container.ozoneimpl.ContainerController;\n+import org.apache.hadoop.ozone.container.replication.ContainerReplicator;\n+import org.apache.hadoop.ozone.container.replication.DownloadAndImportReplicator;\n+import org.apache.hadoop.ozone.container.replication.ReplicationSupervisor;\n+import org.apache.hadoop.ozone.container.replication.ReplicationTask;\n+import org.apache.hadoop.ozone.container.replication.SimpleContainerDownloader;\n+\n+import com.codahale.metrics.Timer;\n+import org.jetbrains.annotations.NotNull;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Option;\n+\n+/**\n+ * Utility to replicated closed container with datanode code.\n+ */\n+@Command(name = \"cr\",\n+    aliases = \"container-replicator\",\n+    description = \"Replicate / download closed containers.\",\n+    versionProvider = HddsVersionProvider.class,\n+    mixinStandardHelpOptions = true,\n+    showDefaultValues = true)\n+public class ClosedContainerReplicator extends BaseFreonGenerator implements\n+    Callable<Void> {\n+\n+  @Option(names = {\"--datanode\"},\n+      description = \"Replicate only containers on this specific datanode.\",\n+      defaultValue = \"\")\n+  private String datanode;\n+\n+  private ReplicationSupervisor supervisor;\n+\n+  private Timer timer;\n+\n+  private List<ReplicationTask> replicationTasks;\n+\n+  @Override\n+  public Void call() throws Exception {\n+\n+    //logic same as the download+import on the destination datanode\n+    OzoneConfiguration conf = initializeReplicationSupervisor();\n+\n+    final ContainerOperationClient containerOperationClient =\n+        new ContainerOperationClient(conf);\n+\n+    final List<ContainerInfo> containerInfos =\n+        containerOperationClient.listContainer(0L, 1_000_000);\n+\n+    replicationTasks = new ArrayList<>();\n+\n+    for (ContainerInfo container : containerInfos) {\n+\n+      final ContainerWithPipeline containerWithPipeline =\n+          containerOperationClient\n+              .getContainerWithPipeline(container.getContainerID());\n+\n+      if (container.getState() == LifeCycleState.CLOSED) {\n+\n+        final List<DatanodeDetails> datanodesWithContainer =\n+            containerWithPipeline.getPipeline().getNodes();\n+\n+        final List<String> datanodeUUIDs =\n+            datanodesWithContainer\n+                .stream().map(DatanodeDetails::getUuidString)\n+                .collect(Collectors.toList());\n+\n+        //if datanode is specific replicate only container if has a replica.\n+        if (datanode.equals(\"\") || datanodeUUIDs.contains(datanode)) {\n+          replicationTasks.add(new ReplicationTask(container.getContainerID(),\n+              datanodesWithContainer));\n+        }\n+      }\n+\n+    }\n+\n+    //important: override the max number of tasks.\n+    setTestNo(replicationTasks.size());\n+\n+    init();\n+\n+    timer = getMetrics().timer(\"replicate-container\");\n+    runTests(this::replicateContainer);\n+    return null;\n+  }\n+\n+  @NotNull\n+  private OzoneConfiguration initializeReplicationSupervisor()\n+      throws IOException {\n+    String fakeDatanodeUuid = datanode;\n+\n+    if (fakeDatanodeUuid.equals(\"\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99c4b387759d7bce6086999cc6a222dbefdeaff0"}, "originalPosition": 130}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a7d378d64b1d084309dde5a8bd8279be1e20706", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/7a7d378d64b1d084309dde5a8bd8279be1e20706", "committedDate": "2021-01-06T11:21:18Z", "message": "fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0911e1089d97fdefc08345df53dd63dc265fb827", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/0911e1089d97fdefc08345df53dd63dc265fb827", "committedDate": "2021-01-06T11:21:30Z", "message": "Use String.isEmpty()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcf882be5f030ca821960efa231daeb9126af271", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/bcf882be5f030ca821960efa231daeb9126af271", "committedDate": "2021-01-06T11:21:39Z", "message": "Merge remote-tracking branch 'origin/master' into HDDS-4524"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5aa2fcce08dc37ce5497547ad48c5452425cb28f", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/5aa2fcce08dc37ce5497547ad48c5452425cb28f", "committedDate": "2021-01-06T15:44:53Z", "message": "implement check on the destination dir"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY0NDY5NDM0", "url": "https://github.com/apache/ozone/pull/1635#pullrequestreview-564469434", "createdAt": "2021-01-08T18:01:44Z", "commit": {"oid": "5aa2fcce08dc37ce5497547ad48c5452425cb28f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1989, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}