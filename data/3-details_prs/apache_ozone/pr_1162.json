{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0MjYyMDkx", "number": 1162, "title": "HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacemen\u2026", "bodyText": "https://issues.apache.org/jira/browse/HDDS-3921", "createdAt": "2020-07-04T09:24:17Z", "url": "https://github.com/apache/ozone/pull/1162", "merged": true, "mergeCommit": {"oid": "59771684d25f3f75ce4d97bc877335e9e5897e03"}, "closed": true, "closedAt": "2020-07-13T06:38:34Z", "author": {"login": "ChenSammi"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxknZRgBqjM1MTI0MjUyNDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczdc8igH2gAyNDQ0MjYyMDkxOjI3N2IwMjg4MThmZmU5OTI0MTZjMmI0MTI4MDVmMmE3OTBkYjBjNTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "96cc52758e0f83d8310628b9d885b8c753f42796", "author": {"user": {"login": "ChenSammi", "name": "Sammi Chen"}}, "url": "https://github.com/apache/ozone/commit/96cc52758e0f83d8310628b9d885b8c753f42796", "committedDate": "2020-07-04T09:22:00Z", "message": "HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacementRackAware.chooseDatanodes"}, "afterCommit": {"oid": "247c40c4a70e204f9a6fe9e5001862fb8a8a34a5", "author": {"user": {"login": "ChenSammi", "name": "Sammi Chen"}}, "url": "https://github.com/apache/ozone/commit/247c40c4a70e204f9a6fe9e5001862fb8a8a34a5", "committedDate": "2020-07-04T09:27:40Z", "message": "HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacementRackAware.chooseDatanodes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a05598276e11bf7981b5c142a470e993293f375a", "author": {"user": {"login": "ChenSammi", "name": "Sammi Chen"}}, "url": "https://github.com/apache/ozone/commit/a05598276e11bf7981b5c142a470e993293f375a", "committedDate": "2020-07-04T14:14:33Z", "message": "HDDS-3921. IllegalArgumentException triggered in SCMContainerPlacementRackAware.chooseDatanodes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNDQ4NjI1", "url": "https://github.com/apache/ozone/pull/1162#pullrequestreview-443448625", "createdAt": "2020-07-06T22:34:23Z", "commit": {"oid": "e1aa46bc3e13b64e27058d2afad5f321c9bc57ec"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNDQ5MDMz", "url": "https://github.com/apache/ozone/pull/1162#pullrequestreview-443449033", "createdAt": "2020-07-06T22:35:21Z", "commit": {"oid": "e1aa46bc3e13b64e27058d2afad5f321c9bc57ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMjozNToyMVrOGtpNdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMjozNToyMVrOGtpNdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUxNDI5NQ==", "bodyText": "NIT: this line to move the line to calculate delta from 547->549 is not needed.  Only the line 550 is the core change that breaks out when we've already handle the under replicate container via inflight replication.", "url": "https://github.com/apache/ozone/pull/1162#discussion_r450514295", "createdAt": "2020-07-06T22:35:21Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "diffHunk": "@@ -543,11 +543,15 @@ private void handleUnderReplicatedContainer(final ContainerInfo container,\n         List<DatanodeDetails> targetReplicas = new ArrayList<>(source);\n         // Then add any pending additions\n         targetReplicas.addAll(replicationInFlight);\n-\n-        int delta = replicationFactor - getReplicaCount(id, replicas);\n         final ContainerPlacementStatus placementStatus =\n             containerPlacement.validateContainerPlacement(\n                 targetReplicas, replicationFactor);\n+        int delta = replicationFactor - getReplicaCount(id, replicas);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1aa46bc3e13b64e27058d2afad5f321c9bc57ec"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzODMzMjI1", "url": "https://github.com/apache/ozone/pull/1162#pullrequestreview-443833225", "createdAt": "2020-07-07T12:17:50Z", "commit": {"oid": "e1aa46bc3e13b64e27058d2afad5f321c9bc57ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjoxNzo1MFrOGt75LQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjoxNzo1MFrOGt75LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyMDM5Nw==", "bodyText": "Rather than this new IF block here, would it make sense to simply add:\nif (replicasNeeded <= 0) {\n  LOG.debug(...);\n  return;\n}\n\nAt line 554 / 558, just after the line:\n        final int replicasNeeded\n            = delta < misRepDelta ? misRepDelta : delta;\n\nThat would avoid needing to check call placementStatus.isPolicySatisfied() and then placementStatus.misReplicationCount() afterwards, as misReplicationCount() calls isPolicySatisfied() anyway.", "url": "https://github.com/apache/ozone/pull/1162#discussion_r450820397", "createdAt": "2020-07-07T12:17:50Z", "author": {"login": "sodonnel"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "diffHunk": "@@ -543,11 +543,15 @@ private void handleUnderReplicatedContainer(final ContainerInfo container,\n         List<DatanodeDetails> targetReplicas = new ArrayList<>(source);\n         // Then add any pending additions\n         targetReplicas.addAll(replicationInFlight);\n-\n-        int delta = replicationFactor - getReplicaCount(id, replicas);\n         final ContainerPlacementStatus placementStatus =\n             containerPlacement.validateContainerPlacement(\n                 targetReplicas, replicationFactor);\n+        int delta = replicationFactor - getReplicaCount(id, replicas);\n+        if (placementStatus.isPolicySatisfied() && delta <= 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1aa46bc3e13b64e27058d2afad5f321c9bc57ec"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "091a7b634b2b9342efdc28ef4acc9e3e77be4300", "author": {"user": {"login": "ChenSammi", "name": "Sammi Chen"}}, "url": "https://github.com/apache/ozone/commit/091a7b634b2b9342efdc28ef4acc9e3e77be4300", "committedDate": "2020-07-09T08:26:53Z", "message": "address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e1aa46bc3e13b64e27058d2afad5f321c9bc57ec", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/e1aa46bc3e13b64e27058d2afad5f321c9bc57ec", "committedDate": "2020-07-06T14:45:16Z", "message": "trigger new CI check"}, "afterCommit": {"oid": "091a7b634b2b9342efdc28ef4acc9e3e77be4300", "author": {"user": {"login": "ChenSammi", "name": "Sammi Chen"}}, "url": "https://github.com/apache/ozone/commit/091a7b634b2b9342efdc28ef4acc9e3e77be4300", "committedDate": "2020-07-09T08:26:53Z", "message": "address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NDU1MjA2", "url": "https://github.com/apache/ozone/pull/1162#pullrequestreview-445455206", "createdAt": "2020-07-09T09:42:37Z", "commit": {"oid": "091a7b634b2b9342efdc28ef4acc9e3e77be4300"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "277b028818ffe992416c2b412805f2a790db0c50", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/277b028818ffe992416c2b412805f2a790db0c50", "committedDate": "2020-07-10T06:15:05Z", "message": "trigger new CI check"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3067, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}