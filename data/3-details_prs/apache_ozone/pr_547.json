{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0MDY0NTE2", "number": 547, "title": "HDDS-2928. Implement ofs://: listStatus", "bodyText": "What changes were proposed in this pull request?\nofs:// should be able to handle list (recursive or not) under \"root\" and under each volume \"directory\", as if it is a flat filesystem (if the user has permissions to see the volumes).\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-2928\nHow was this patch tested?\nSo far manually tested in CLI. See commit message for instructions.\nAdding unit tests.", "createdAt": "2020-02-12T02:45:27Z", "url": "https://github.com/apache/ozone/pull/547", "merged": true, "mergeCommit": {"oid": "7c35d76b2ec22dbd869ec7332e1c333567821e11"}, "closed": true, "closedAt": "2020-02-25T05:59:45Z", "author": {"login": "smengcl"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDdIf1gH2gAyMzc0MDY0NTE2Ojc1NDI5Y2YxMjgyZGMwMDhhOGJjYzdiMmU3NmE0NGI2MjlmM2U0Mzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHlVU4AFqTM2Mzc1MDAxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "75429cf1282dc008a8bcc7b2e76a44b629f3e439", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/75429cf1282dc008a8bcc7b2e76a44b629f3e439", "committedDate": "2020-02-12T02:44:23Z", "message": "Fix NPE for \"ozone fs -ls ofs://om/\" due to path field is null\n\nBefore fix:\n\nbash-4.2$ ozone fs -ls ofs://om/\n-ls: Fatal internal error\njava.lang.NullPointerException\n\tat org.apache.hadoop.fs.shell.PathData.expandAsGlob(PathData.java:379)\n\tat org.apache.hadoop.fs.shell.Command.expandArgument(Command.java:250)\n\tat org.apache.hadoop.fs.shell.Command.expandArguments(Command.java:233)\n\tat org.apache.hadoop.fs.shell.FsCommand.processRawArguments(FsCommand.java:104)\n\tat org.apache.hadoop.fs.shell.Command.run(Command.java:177)\n\tat org.apache.hadoop.fs.FsShell.run(FsShell.java:327)\n\tat org.apache.hadoop.util.ToolRunner.run(ToolRunner.java:76)\n\tat org.apache.hadoop.util.ToolRunner.run(ToolRunner.java:90)\n\tat org.apache.hadoop.fs.ozone.OzoneFsShell.main(OzoneFsShell.java:79)\n\nAfter fix:\n\nbash-4.2$ ozone fs -ls ofs://om/\nFound 2 items\ndrwxr-xr-x   - hadoop hadoop          0 1970-01-01 00:00 /volume1\ndrwxr-xr-x   - hadoop hadoop          0 1970-01-01 00:00 /volume2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89fb201eeb9d04f154c01c6671a3fb89f2a7f2f3", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/89fb201eeb9d04f154c01c6671a3fb89f2a7f2f3", "committedDate": "2020-02-12T02:44:44Z", "message": "Fix listStatus root result item prefix.\n\nBefore:\n\nbash-4.2$ ozone fs -ls ofs://om/\nFound 2 items\ndrwxr-xr-x   - hadoop hadoop          0 2020-02-12 01:04 /volume1\ndrwxr-xr-x   - hadoop hadoop          0 2020-02-12 01:04 /volume2\n\nAfter:\n\nbash-4.2$ ozone fs -ls ofs://om/\nFound 2 items\ndrwxr-xr-x   - hadoop hadoop          0 2020-02-12 02:27 ofs://om/volume1\ndrwxr-xr-x   - hadoop hadoop          0 2020-02-12 02:27 ofs://om/volume2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21ffd671caf076199a86d07073daee96ad3aea5f", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/21ffd671caf076199a86d07073daee96ad3aea5f", "committedDate": "2020-02-12T02:44:47Z", "message": "listStatus on root and volume works now, recursive or not. Tested in CLI:\n\nbash-4.2$ ozone fs -ls ofs://om/\nFound 2 items\ndrwxr-xr-x   - hadoop hadoop          0 2020-02-12 02:27 ofs://om/volume1\ndrwxr-xr-x   - hadoop hadoop          0 2020-02-12 02:27 ofs://om/volume2\n\nbash-4.2$ ozone fs -ls ofs://om/volume1/\nFound 1 items\ndrwxr-xr-x   - hadoop hadoop          0 2020-02-12 02:27 ofs://om/volume1/bucket1\n\nbash-4.2$ ozone fs -ls -R ofs://om/\ndrwxr-xr-x   - hadoop hadoop          0 2020-02-12 02:27 ofs://om/volume1\ndrwxr-xr-x   - hadoop hadoop          0 2020-02-12 02:27 ofs://om/volume1/bucket1\ndrwxrwxrwx   - hadoop hadoop          0 2020-02-12 02:34 ofs://om/volume1/bucket1/dir1\ndrwxrwxrwx   - hadoop hadoop          0 2020-02-12 02:34 ofs://om/volume1/bucket1/dir1/subdir1\ndrwxr-xr-x   - hadoop hadoop          0 2020-02-12 02:27 ofs://om/volume2\ndrwxr-xr-x   - hadoop hadoop          0 2020-02-12 02:27 ofs://om/volume2/bucket2\ndrwxrwxrwx   - hadoop hadoop          0 2020-02-12 02:34 ofs://om/volume2/bucket2/dir2\ndrwxrwxrwx   - hadoop hadoop          0 2020-02-12 02:34 ofs://om/volume2/bucket2/dir2/subdir2\n\nbash-4.2$ ozone fs -ls -R ofs://om/volume1/\ndrwxr-xr-x   - hadoop hadoop          0 2020-02-12 02:27 ofs://om/volume1/bucket1\ndrwxrwxrwx   - hadoop hadoop          0 2020-02-12 02:29 ofs://om/volume1/bucket1/dir1\ndrwxrwxrwx   - hadoop hadoop          0 2020-02-12 02:29 ofs://om/volume1/bucket1/dir1/subdir1\n\nbash-4.2$ ozone fs -ls -R ofs://om/volume1/bucket1/\ndrwxrwxrwx   - hadoop hadoop          0 2020-02-12 02:34 ofs://om/volume1/bucket1/dir1\ndrwxrwxrwx   - hadoop hadoop          0 2020-02-12 02:34 ofs://om/volume1/bucket1/dir1/subdir1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c5206cdd46a8cadecefd9005c5cf010909c21ac", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/5c5206cdd46a8cadecefd9005c5cf010909c21ac", "committedDate": "2020-02-12T21:11:27Z", "message": "Fix test `testGetFileStatusRoot()` due to `getFileStatusAdapterForRoot()` return value change."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4d28caf0bd7453551a34abe286632575983eeea", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/c4d28caf0bd7453551a34abe286632575983eeea", "committedDate": "2020-02-13T05:49:28Z", "message": "Add test testListStatusOFSRoot()."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d9b2acd2a56c9a9bb6189cfdda895a073c7a0bd", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/1d9b2acd2a56c9a9bb6189cfdda895a073c7a0bd", "committedDate": "2020-02-13T05:49:58Z", "message": "Clean up code."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMTc5NTQw", "url": "https://github.com/apache/ozone/pull/547#pullrequestreview-362179540", "createdAt": "2020-02-20T19:38:35Z", "commit": {"oid": "1d9b2acd2a56c9a9bb6189cfdda895a073c7a0bd"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxOTozODozNlrOFsgmaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMDowNDoyMFrOFshY_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIxNTc4NA==", "bodyText": "NIT: can we refactor to dedup line 501-517.", "url": "https://github.com/apache/ozone/pull/547#discussion_r382215784", "createdAt": "2020-02-20T19:38:36Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/fs/ozone/TestRootedOzoneFileSystem.java", "diffHunk": "@@ -492,4 +493,42 @@ private void assertKeyNotFoundException(IOException ex) {\n     GenericTestUtils.assertExceptionContains(\"KEY_NOT_FOUND\", ex);\n   }\n \n+  /**\n+   * OFS: Test recursive listStatus on root.\n+   */\n+  @Test\n+  public void testListStatusRootAndVolumeNonRecursive() throws Exception {\n+    String volume1 = getRandomNonExistVolumeName();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d9b2acd2a56c9a9bb6189cfdda895a073c7a0bd"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIxNjQwMw==", "bodyText": "Can we add a test case to cover recursive list status?", "url": "https://github.com/apache/ozone/pull/547#discussion_r382216403", "createdAt": "2020-02-20T19:39:50Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/fs/ozone/TestRootedOzoneFileSystem.java", "diffHunk": "@@ -492,4 +493,42 @@ private void assertKeyNotFoundException(IOException ex) {\n     GenericTestUtils.assertExceptionContains(\"KEY_NOT_FOUND\", ex);\n   }\n \n+  /**\n+   * OFS: Test recursive listStatus on root.\n+   */\n+  @Test\n+  public void testListStatusRootAndVolumeNonRecursive() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d9b2acd2a56c9a9bb6189cfdda895a073c7a0bd"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIxNzI5NA==", "bodyText": "NIT: Can we wrap the logic into OFSPath#isRoot?", "url": "https://github.com/apache/ozone/pull/547#discussion_r382217294", "createdAt": "2020-02-20T19:41:32Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java", "diffHunk": "@@ -439,11 +440,15 @@ public FileStatusAdapter getFileStatus(String path, URI uri,\n     incrementCounter(Statistic.OBJECTS_QUERY);\n     OFSPath ofsPath = new OFSPath(path);\n     String key = ofsPath.getKeyName();\n-    // getFileStatus is called for root\n+    // path is root\n     if (ofsPath.getVolumeName().isEmpty() &&\n         ofsPath.getBucketName().isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d9b2acd2a56c9a9bb6189cfdda895a073c7a0bd"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIxNzYzMQ==", "bodyText": "Same as above. Can we wrap with OFSPath#isVolume?", "url": "https://github.com/apache/ozone/pull/547#discussion_r382217631", "createdAt": "2020-02-20T19:42:08Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java", "diffHunk": "@@ -439,11 +440,15 @@ public FileStatusAdapter getFileStatus(String path, URI uri,\n     incrementCounter(Statistic.OBJECTS_QUERY);\n     OFSPath ofsPath = new OFSPath(path);\n     String key = ofsPath.getKeyName();\n-    // getFileStatus is called for root\n+    // path is root\n     if (ofsPath.getVolumeName().isEmpty() &&\n         ofsPath.getBucketName().isEmpty()) {\n-      // Generate a FileStatusAdapter for root\n-      return rootFileStatusAdapter();\n+      return getFileStatusAdapterForRoot(uri);\n+    }\n+    // path is a volume\n+    if (ofsPath.getBucketName().isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d9b2acd2a56c9a9bb6189cfdda895a073c7a0bd"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIxOTIzOA==", "bodyText": "Can we have a single static RootFileStatusAdapter for all?", "url": "https://github.com/apache/ozone/pull/547#discussion_r382219238", "createdAt": "2020-02-20T19:45:02Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java", "diffHunk": "@@ -664,17 +732,73 @@ private FileStatusAdapter toFileStatusAdapter(OzoneFileStatus status) {\n     );\n   }\n \n+  /**\n+   * Generate a FileStatusAdapter for a volume.\n+   * @param ozoneVolume OzoneVolume object\n+   * @param uri Full URI to OFS root.\n+   * @return FileStatusAdapter for a volume.\n+   */\n+  private static FileStatusAdapter getFileStatusAdapterForVolume(\n+      OzoneVolume ozoneVolume, URI uri) {\n+    String pathStr = uri.toString() +\n+        OZONE_URI_DELIMITER + ozoneVolume.getName();\n+    LOG.debug(\"getFileStatusAdapterForVolume(pathStr=\" + pathStr);\n+    Path path = new Path(pathStr);\n+    return new FileStatusAdapter(\n+        0L,\n+        path,\n+        true,\n+        (short)0,\n+        0L,\n+        ozoneVolume.getCreationTime().getEpochSecond() * 1000,\n+        0L,\n+        (short)00755,  // Default directory permission, derive from ACLs later?\n+        ozoneVolume.getOwner(),\n+        ozoneVolume.getAdmin(),  // TODO: Get group of whom?\n+        path\n+    );\n+  }\n+\n+  /**\n+   * Generate a FileStatusAdapter for a bucket.\n+   * @param ozoneBucket OzoneBucket object.\n+   * @param uri Full URI to OFS root.\n+   * @return FileStatusAdapter for a bucket.\n+   */\n+  private static FileStatusAdapter getFileStatusAdapterForBucket(\n+      OzoneBucket ozoneBucket, URI uri, String username) {\n+    String pathStr = uri.toString() +\n+        OZONE_URI_DELIMITER + ozoneBucket.getVolumeName() +\n+        OZONE_URI_DELIMITER + ozoneBucket.getName();\n+    LOG.debug(\"getFileStatusAdapterForBucket(pathStr=\" + pathStr);\n+    Path path = new Path(pathStr);\n+    return new FileStatusAdapter(\n+        0L,\n+        path,\n+        true,\n+        (short)0,\n+        0L,\n+        ozoneBucket.getCreationTime().getEpochSecond() * 1000,\n+        0L,\n+        (short)00755,  // Default directory permission, derive from ACLs later?\n+        username,  // TODO: owner and group.\n+        username,\n+        path\n+    );\n+  }\n+\n   /**\n    * Generate a FileStatusAdapter for OFS root.\n+   * @param uri Full URI to OFS root.\n    * @return FileStatusAdapter for root.\n    */\n-  private static FileStatusAdapter rootFileStatusAdapter() {\n+  private static FileStatusAdapter getFileStatusAdapterForRoot(URI uri) {\n     // Note that most fields are mimicked from HDFS FileStatus for root,\n     //  except modification time, permission, owner and group.\n-    // TODO: Revisit the return value.\n+    Path path = new Path(uri.toString() + OZONE_URI_DELIMITER);\n     return new FileStatusAdapter(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d9b2acd2a56c9a9bb6189cfdda895a073c7a0bd"}, "originalPosition": 180}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIxOTYwNQ==", "bodyText": "NIT: can we define as a const?", "url": "https://github.com/apache/ozone/pull/547#discussion_r382219605", "createdAt": "2020-02-20T19:45:49Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java", "diffHunk": "@@ -664,17 +732,73 @@ private FileStatusAdapter toFileStatusAdapter(OzoneFileStatus status) {\n     );\n   }\n \n+  /**\n+   * Generate a FileStatusAdapter for a volume.\n+   * @param ozoneVolume OzoneVolume object\n+   * @param uri Full URI to OFS root.\n+   * @return FileStatusAdapter for a volume.\n+   */\n+  private static FileStatusAdapter getFileStatusAdapterForVolume(\n+      OzoneVolume ozoneVolume, URI uri) {\n+    String pathStr = uri.toString() +\n+        OZONE_URI_DELIMITER + ozoneVolume.getName();\n+    LOG.debug(\"getFileStatusAdapterForVolume(pathStr=\" + pathStr);\n+    Path path = new Path(pathStr);\n+    return new FileStatusAdapter(\n+        0L,\n+        path,\n+        true,\n+        (short)0,\n+        0L,\n+        ozoneVolume.getCreationTime().getEpochSecond() * 1000,\n+        0L,\n+        (short)00755,  // Default directory permission, derive from ACLs later?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d9b2acd2a56c9a9bb6189cfdda895a073c7a0bd"}, "originalPosition": 134}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIyMDQwNQ==", "bodyText": "Let do this with\nif (LOG.isDebugEnabled()) {\nLOG.debug(\"getFileStatusAdapterForBucket(pathStr={}\", pathStr);\n}", "url": "https://github.com/apache/ozone/pull/547#discussion_r382220405", "createdAt": "2020-02-20T19:47:20Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java", "diffHunk": "@@ -664,17 +732,73 @@ private FileStatusAdapter toFileStatusAdapter(OzoneFileStatus status) {\n     );\n   }\n \n+  /**\n+   * Generate a FileStatusAdapter for a volume.\n+   * @param ozoneVolume OzoneVolume object\n+   * @param uri Full URI to OFS root.\n+   * @return FileStatusAdapter for a volume.\n+   */\n+  private static FileStatusAdapter getFileStatusAdapterForVolume(\n+      OzoneVolume ozoneVolume, URI uri) {\n+    String pathStr = uri.toString() +\n+        OZONE_URI_DELIMITER + ozoneVolume.getName();\n+    LOG.debug(\"getFileStatusAdapterForVolume(pathStr=\" + pathStr);\n+    Path path = new Path(pathStr);\n+    return new FileStatusAdapter(\n+        0L,\n+        path,\n+        true,\n+        (short)0,\n+        0L,\n+        ozoneVolume.getCreationTime().getEpochSecond() * 1000,\n+        0L,\n+        (short)00755,  // Default directory permission, derive from ACLs later?\n+        ozoneVolume.getOwner(),\n+        ozoneVolume.getAdmin(),  // TODO: Get group of whom?\n+        path\n+    );\n+  }\n+\n+  /**\n+   * Generate a FileStatusAdapter for a bucket.\n+   * @param ozoneBucket OzoneBucket object.\n+   * @param uri Full URI to OFS root.\n+   * @return FileStatusAdapter for a bucket.\n+   */\n+  private static FileStatusAdapter getFileStatusAdapterForBucket(\n+      OzoneBucket ozoneBucket, URI uri, String username) {\n+    String pathStr = uri.toString() +\n+        OZONE_URI_DELIMITER + ozoneBucket.getVolumeName() +\n+        OZONE_URI_DELIMITER + ozoneBucket.getName();\n+    LOG.debug(\"getFileStatusAdapterForBucket(pathStr=\" + pathStr);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d9b2acd2a56c9a9bb6189cfdda895a073c7a0bd"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIyMTYyMw==", "bodyText": "similar to the one below, please add conditional debug output with parameterized log.", "url": "https://github.com/apache/ozone/pull/547#discussion_r382221623", "createdAt": "2020-02-20T19:49:51Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java", "diffHunk": "@@ -664,17 +732,73 @@ private FileStatusAdapter toFileStatusAdapter(OzoneFileStatus status) {\n     );\n   }\n \n+  /**\n+   * Generate a FileStatusAdapter for a volume.\n+   * @param ozoneVolume OzoneVolume object\n+   * @param uri Full URI to OFS root.\n+   * @return FileStatusAdapter for a volume.\n+   */\n+  private static FileStatusAdapter getFileStatusAdapterForVolume(\n+      OzoneVolume ozoneVolume, URI uri) {\n+    String pathStr = uri.toString() +\n+        OZONE_URI_DELIMITER + ozoneVolume.getName();\n+    LOG.debug(\"getFileStatusAdapterForVolume(pathStr=\" + pathStr);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d9b2acd2a56c9a9bb6189cfdda895a073c7a0bd"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIyNzQyNg==", "bodyText": "should we use startBucket as parameter to avoid creating OFSPath unnecessarily?", "url": "https://github.com/apache/ozone/pull/547#discussion_r382227426", "createdAt": "2020-02-20T20:01:33Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java", "diffHunk": "@@ -486,6 +491,57 @@ public void makeQualified(FileStatus status, URI uri, Path path,\n     return new IteratorAdapter(bucket.listKeys(key));\n   }\n \n+  /**\n+   * Helper for OFS listStatus on root.\n+   */\n+  private List<FileStatusAdapter> listStatusRoot(\n+      boolean recursive, String startPath, long numEntries,\n+      URI uri, Path workingDir, String username) throws IOException {\n+    OFSPath ofsStartPath = new OFSPath(startPath);\n+    // list volumes for user\n+    Iterator<? extends OzoneVolume> iter = objectStore.listVolumesByUser(\n+        username, null, ofsStartPath.getVolumeName());\n+    List<FileStatusAdapter> res = new ArrayList<>();\n+    // TODO: Test continuation\n+    while (iter.hasNext() && res.size() <= numEntries) {\n+      OzoneVolume volume = iter.next();\n+      res.add(getFileStatusAdapterForVolume(volume, uri));\n+      if (recursive) {\n+        String next = volume.getName();\n+        // TODO: Check startPath\n+        res.addAll(listStatus(next, recursive, startPath,\n+            numEntries - res.size(), uri, workingDir, username));\n+      }\n+    }\n+    return res;\n+  }\n+\n+  /**\n+   * Helper for OFS listStatus on a volume.\n+   */\n+  private List<FileStatusAdapter> listStatusVolume(String volumeStr,\n+      boolean recursive, String startPath, long numEntries,\n+      URI uri, Path workingDir, String username) throws IOException {\n+    OFSPath ofsStartPath = new OFSPath(startPath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d9b2acd2a56c9a9bb6189cfdda895a073c7a0bd"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIyNzYzNA==", "bodyText": "Can we add OFSPath helpers as suggested above?", "url": "https://github.com/apache/ozone/pull/547#discussion_r382227634", "createdAt": "2020-02-20T20:01:58Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java", "diffHunk": "@@ -511,10 +567,22 @@ public void makeQualified(FileStatus status, URI uri, Path path,\n \n     incrementCounter(Statistic.OBJECTS_LIST);\n     OFSPath ofsPath = new OFSPath(pathStr);\n-    // TODO: Subject to change in HDDS-2928.\n+\n+    // listStatus root\n+    if (ofsPath.getVolumeName().isEmpty()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d9b2acd2a56c9a9bb6189cfdda895a073c7a0bd"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIyODczMg==", "bodyText": "I think we can implement this with either next or startPath but not necessarily both.", "url": "https://github.com/apache/ozone/pull/547#discussion_r382228732", "createdAt": "2020-02-20T20:04:20Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java", "diffHunk": "@@ -486,6 +491,57 @@ public void makeQualified(FileStatus status, URI uri, Path path,\n     return new IteratorAdapter(bucket.listKeys(key));\n   }\n \n+  /**\n+   * Helper for OFS listStatus on root.\n+   */\n+  private List<FileStatusAdapter> listStatusRoot(\n+      boolean recursive, String startPath, long numEntries,\n+      URI uri, Path workingDir, String username) throws IOException {\n+    OFSPath ofsStartPath = new OFSPath(startPath);\n+    // list volumes for user\n+    Iterator<? extends OzoneVolume> iter = objectStore.listVolumesByUser(\n+        username, null, ofsStartPath.getVolumeName());\n+    List<FileStatusAdapter> res = new ArrayList<>();\n+    // TODO: Test continuation\n+    while (iter.hasNext() && res.size() <= numEntries) {\n+      OzoneVolume volume = iter.next();\n+      res.add(getFileStatusAdapterForVolume(volume, uri));\n+      if (recursive) {\n+        String next = volume.getName();\n+        // TODO: Check startPath\n+        res.addAll(listStatus(next, recursive, startPath,\n+            numEntries - res.size(), uri, workingDir, username));\n+      }\n+    }\n+    return res;\n+  }\n+\n+  /**\n+   * Helper for OFS listStatus on a volume.\n+   */\n+  private List<FileStatusAdapter> listStatusVolume(String volumeStr,\n+      boolean recursive, String startPath, long numEntries,\n+      URI uri, Path workingDir, String username) throws IOException {\n+    OFSPath ofsStartPath = new OFSPath(startPath);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIyNzQyNg=="}, "originalCommit": {"oid": "1d9b2acd2a56c9a9bb6189cfdda895a073c7a0bd"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab03db64f18a75fdd5fcc0032ae7170e942576bf", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/ab03db64f18a75fdd5fcc0032ae7170e942576bf", "committedDate": "2020-02-20T21:19:36Z", "message": "Improve comments; dedup testListStatusRootAndVolumeNonRecursive. https://github.com/apache/hadoop-ozone/pull/547#discussion_r382215784"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5048760863a73ae3712bed1f6b8b21f6ced247a8", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/5048760863a73ae3712bed1f6b8b21f6ced247a8", "committedDate": "2020-02-21T16:26:04Z", "message": "Add recursive listStatus test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f003b87c307b5b3aae91a5fe25d3b81bc945ec3d", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/f003b87c307b5b3aae91a5fe25d3b81bc945ec3d", "committedDate": "2020-02-21T16:37:54Z", "message": "Impl OFSPath#isRoot and OFSPath#isVolume. https://github.com/apache/hadoop-ozone/pull/547#discussion_r382217294 and https://github.com/apache/hadoop-ozone/pull/547#discussion_r382217631"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5cc3e4035df0267b60354224980d3a4da1f89e4", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/b5cc3e4035df0267b60354224980d3a4da1f89e4", "committedDate": "2020-02-21T16:53:14Z", "message": "Use FsPermission.getDirDefault(). Root FileStatusAdapter mod time defaults to System.currentTimeMillis() now.\nhttps://github.com/apache/hadoop-ozone/pull/547#discussion_r382219605"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "936f87472fcb204128b3ab53a8afd978d288076c", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/936f87472fcb204128b3ab53a8afd978d288076c", "committedDate": "2020-02-21T17:01:37Z", "message": "Improve debug message. https://github.com/apache/hadoop-ozone/pull/547#discussion_r382220405"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3553f6301a70292c4643fe8ded21e91d718334e8", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/3553f6301a70292c4643fe8ded21e91d718334e8", "committedDate": "2020-02-21T17:05:02Z", "message": "Improve debug message; Use FsPermission.getDirDefault()."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ada1ac4b0b0164c71e912a70c495c269887cde09", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/ada1ac4b0b0164c71e912a70c495c269887cde09", "committedDate": "2020-02-21T17:07:16Z", "message": "Use ofsPath.isRoot and ofsPath.isVolume to improve code readability."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41c081f2f6e506f0942fe89ad5ced91df6e2c3d0", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/41c081f2f6e506f0942fe89ad5ced91df6e2c3d0", "committedDate": "2020-02-21T17:14:10Z", "message": "Optimize listStatusVolume: remove unnecessary new OFSPath by using startBucket instead of startPath in listStatusVolume."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a1860808a4304dbd1e62080c0879c533ae9043a", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/9a1860808a4304dbd1e62080c0879c533ae9043a", "committedDate": "2020-02-21T17:21:08Z", "message": "Clean up test code."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f94b95c4148d19dd00f2c16781b9d4a33be4b891", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/f94b95c4148d19dd00f2c16781b9d4a33be4b891", "committedDate": "2020-02-21T17:50:19Z", "message": "Fix listVolumesByUser usage; listStatusVolume: Change startBucket back to startPath for correctness."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNzUwMDE3", "url": "https://github.com/apache/ozone/pull/547#pullrequestreview-363750017", "createdAt": "2020-02-24T22:33:20Z", "commit": {"oid": "f94b95c4148d19dd00f2c16781b9d4a33be4b891"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3872, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}