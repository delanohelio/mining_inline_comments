{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMjk5NzU0", "number": 1650, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMjo1MzoxNVrOE_2BQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwNjozNDowNFrOFKxqLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MzgwODAzOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestRelicationAnnotation.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMjo1MzoxNVrOH9xhfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMjo1MzoxNVrOH9xhfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUzNjU3Mw==", "bodyText": "Should I actually mock a InvocationHandler and add a request type RequestType.Test? Then make sure replicatedOperation is eventually called.", "url": "https://github.com/apache/ozone/pull/1650#discussion_r534536573", "createdAt": "2020-12-02T22:53:15Z", "author": {"login": "amaliujia"}, "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestRelicationAnnotation.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p/>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p/>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.hdds.scm.ha;\n+\n+import java.io.IOException;\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol.RequestType;\n+import org.apache.hadoop.hdds.scm.metadata.Replicate;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/**\n+ * Tests on {@link org.apache.hadoop.hdds.scm.metadata.Replicate}.\n+ */\n+public class TestRelicationAnnotation {\n+  private SCMHAInvocationHandler scmhaInvocationHandler;\n+\n+  @Before\n+  public void setup() {\n+    scmhaInvocationHandler = new SCMHAInvocationHandler(\n+        RequestType.CONTAINER,\n+        null,\n+        new MockRatisServer());\n+  }\n+\n+  @Test(expected = IOException.class)\n+  public void testReplicateAnnotationBasic() throws Throwable {\n+    // test whether replicatedOperation will hit the Ratis based replication\n+    // code path in SCMHAInvocationHandler. Expect to see a IOException cause\n+    // no handler is added yet.\n+    scmhaInvocationHandler.invoke(new Object(),\n+        this.getClass().getMethod(\"replicatedOperation\"), new Object[0]);\n+  }\n+\n+  @Replicate\n+  public void replicatedOperation() { }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06c4c234f6f81bf596b477810ad852ea3ffe7843"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1Nzc2ODkzOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestRelicationAnnotation.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMjozOTozOVrOH-ZqsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMjozOTozOVrOH-ZqsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE5NDI4OQ==", "bodyText": "typo Relication -> Replication", "url": "https://github.com/apache/ozone/pull/1650#discussion_r535194289", "createdAt": "2020-12-03T12:39:39Z", "author": {"login": "GlenGeng"}, "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestRelicationAnnotation.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p/>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p/>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.hdds.scm.ha;\n+\n+import java.io.IOException;\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol.RequestType;\n+import org.apache.hadoop.hdds.scm.metadata.Replicate;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/**\n+ * Tests on {@link org.apache.hadoop.hdds.scm.metadata.Replicate}.\n+ */\n+public class TestRelicationAnnotation {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06c4c234f6f81bf596b477810ad852ea3ffe7843"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2MDM4NTMxOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/MockSCMHAManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQwOToxOTowOVrOIMljIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQyMzozMjoyMFrOIM3D5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDA2OTAyNg==", "bodyText": "Hey Rui, Why we need to move MockRatisServer out of MockSCMHAManager ? My concern is\n// TODO: Move this class to test package after fixing Recon, I would like to separate them until they are moved back to test dir.\nYou duplicated the licenses.", "url": "https://github.com/apache/ozone/pull/1650#discussion_r550069026", "createdAt": "2020-12-30T09:19:09Z", "author": {"login": "GlenGeng"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/MockSCMHAManager.java", "diffHunk": "@@ -15,29 +15,28 @@\n  * the License.\n  */\n \n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be72174ba5dc256af5b9b083ce3b996e99707fe5"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDM1NTk0Mw==", "bodyText": "O we don't need to :)\nThat was a old design but now our codebase has changed so there is no need to move out this Ratis server. I will move it back.", "url": "https://github.com/apache/ozone/pull/1650#discussion_r550355943", "createdAt": "2020-12-30T23:32:20Z", "author": {"login": "amaliujia"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/MockSCMHAManager.java", "diffHunk": "@@ -15,29 +15,28 @@\n  * the License.\n  */\n \n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDA2OTAyNg=="}, "originalCommit": {"oid": "be72174ba5dc256af5b9b083ce3b996e99707fe5"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2MDk2NDUyOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestReplicationAnnotation.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxMTozNzo0M1rOIMrXbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQwNTo1OTo0NFrOIM6BIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE2NDMzNA==", "bodyText": "Hey Rui, I suggested to simulate the real ratis call, what do you think ?\npublic class TestReplicationAnnotation {\n  @Test\n  public void testReplicateAnnotationBasic() throws Throwable {\n\n    final ContainerStateManagerV2 csm = new ContainerStateManagerV2() {\n\n      @Override\n      public boolean contains(HddsProtos.ContainerID containerID) {\n        return false;\n      }\n\n      @Override\n      public Set<ContainerID> getContainerIDs() {\n        return null;\n      }\n\n      @Override\n      public Set<ContainerID> getContainerIDs(HddsProtos.LifeCycleState state) {\n        return null;\n      }\n\n      @Override\n      public ContainerInfo getContainer(HddsProtos.ContainerID id) {\n        return null;\n      }\n\n      @Override\n      public Set<ContainerReplica> getContainerReplicas(HddsProtos.ContainerID id) {\n        return null;\n      }\n\n      @Override\n      public void updateContainerReplica(HddsProtos.ContainerID id, ContainerReplica replica) {\n\n      }\n\n      @Override\n      public void removeContainerReplica(HddsProtos.ContainerID id, ContainerReplica replica) {\n\n      }\n\n      @Override\n      public void addContainer(HddsProtos.ContainerInfoProto containerInfo) throws IOException {\n\n      }\n\n      @Override\n      public void updateContainerState(HddsProtos.ContainerID id, HddsProtos.LifeCycleEvent event) throws IOException, InvalidStateTransitionException {\n\n      }\n\n      @Override\n      public void updateDeleteTransactionId(Map<ContainerID, Long> deleteTransactionMap) throws IOException {\n\n      }\n\n      @Override\n      public ContainerInfo getMatchingContainer(long size, String owner, PipelineID pipelineID, NavigableSet<ContainerID> containerIDs) {\n        return null;\n      }\n\n      @Override\n      public void removeContainer(HddsProtos.ContainerID containerInfo) throws IOException {\n\n      }\n\n      @Override\n      public void close() throws IOException {\n\n      }\n    };\n\n    SCMRatisServer ratisServer = new SCMRatisServer() {\n      @Override\n      public void start() throws IOException {\n\n      }\n\n      @Override\n      public void registerStateMachineHandler(SCMRatisProtocol.RequestType handlerType, Object handler) {\n\n      }\n\n      @Override\n      public SCMRatisResponse submitRequest(SCMRatisRequest request) throws IOException, ExecutionException, InterruptedException {\n        throw new IOException(\"submitRequest is called.\");\n      }\n\n      @Override\n      public void stop() throws IOException {\n\n      }\n\n      @Override\n      public RaftServer.Division getDivision() {\n        return null;\n      }\n\n      @Override\n      public List<String> getRatisRoles() {\n        return null;\n      }\n\n      @Override\n      public NotLeaderException triggerNotLeaderException() {\n        return null;\n      }\n    };\n\n    final SCMHAInvocationHandler invocationHandler =\n        new SCMHAInvocationHandler(\n            SCMRatisProtocol.RequestType.CONTAINER, csm, ratisServer);\n\n    ContainerStateManagerV2 proxy = (ContainerStateManagerV2) Proxy.newProxyInstance(\n        SCMHAInvocationHandler.class.getClassLoader(),\n        new Class<?>[]{ContainerStateManagerV2.class}, invocationHandler);\n\n    try {\n      proxy.addContainer(HddsProtos.ContainerInfoProto.getDefaultInstance());\n      Assert.fail();\n    } catch (IOException ignore) {\n\n    }\n  }\n}", "url": "https://github.com/apache/ozone/pull/1650#discussion_r550164334", "createdAt": "2020-12-30T11:37:43Z", "author": {"login": "GlenGeng"}, "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestReplicationAnnotation.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p/>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p/>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.hdds.scm.ha;\n+\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol.RequestType;\n+import org.apache.hadoop.hdds.scm.metadata.Replicate;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/**\n+ * Tests on {@link org.apache.hadoop.hdds.scm.metadata.Replicate}.\n+ */\n+public class TestReplicationAnnotation {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be72174ba5dc256af5b9b083ce3b996e99707fe5"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDM1NzQ4Nw==", "bodyText": "I see. How about creating a MockContainerStateManagerV2 directly?", "url": "https://github.com/apache/ozone/pull/1650#discussion_r550357487", "createdAt": "2020-12-30T23:41:59Z", "author": {"login": "amaliujia"}, "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestReplicationAnnotation.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p/>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p/>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.hdds.scm.ha;\n+\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol.RequestType;\n+import org.apache.hadoop.hdds.scm.metadata.Replicate;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/**\n+ * Tests on {@link org.apache.hadoop.hdds.scm.metadata.Replicate}.\n+ */\n+public class TestReplicationAnnotation {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE2NDMzNA=="}, "originalCommit": {"oid": "be72174ba5dc256af5b9b083ce3b996e99707fe5"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDM4OTc2NA==", "bodyText": "I consider that we can create a MockContainerStateManagerV2 when we need it. This anonymous one is an auto generated class by IDE.", "url": "https://github.com/apache/ozone/pull/1650#discussion_r550389764", "createdAt": "2020-12-31T03:54:40Z", "author": {"login": "GlenGeng"}, "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestReplicationAnnotation.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p/>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p/>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.hdds.scm.ha;\n+\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol.RequestType;\n+import org.apache.hadoop.hdds.scm.metadata.Replicate;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/**\n+ * Tests on {@link org.apache.hadoop.hdds.scm.metadata.Replicate}.\n+ */\n+public class TestReplicationAnnotation {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE2NDMzNA=="}, "originalCommit": {"oid": "be72174ba5dc256af5b9b083ce3b996e99707fe5"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQwNDM4Ng==", "bodyText": "Done", "url": "https://github.com/apache/ozone/pull/1650#discussion_r550404386", "createdAt": "2020-12-31T05:59:44Z", "author": {"login": "amaliujia"}, "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestReplicationAnnotation.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p/>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p/>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.hdds.scm.ha;\n+\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol.RequestType;\n+import org.apache.hadoop.hdds.scm.metadata.Replicate;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+/**\n+ * Tests on {@link org.apache.hadoop.hdds.scm.metadata.Replicate}.\n+ */\n+public class TestReplicationAnnotation {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE2NDMzNA=="}, "originalCommit": {"oid": "be72174ba5dc256af5b9b083ce3b996e99707fe5"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2Mjc0Njk4OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/MockSCMHAManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQwNjo0MjoyN1rOIM6Xyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQwNjo0MjoyN1rOIM6Xyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQxMDE4Nw==", "bodyText": "Hey Rui, changes in MockSCMHAManager.java may not be needed, since MockRatisServer is an inner class of MockSCMHAManager,", "url": "https://github.com/apache/ozone/pull/1650#discussion_r550410187", "createdAt": "2020-12-31T06:42:27Z", "author": {"login": "GlenGeng"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/MockSCMHAManager.java", "diffHunk": "@@ -92,11 +92,20 @@ public void shutdown() throws IOException {\n     ratisServer.stop();\n   }\n \n-  private class MockRatisServer implements SCMRatisServer {\n+  /**\n+   * Mock RatisServer implementation for testing.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbf055ef0da1d0338a9c4d43de2aa2e3d61b455c"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2Mjc1MTkzOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestReplicationAnnotation.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQwNjo0NjoyMlrOIM6aUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQwNjo0NjoyMlrOIM6aUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQxMDgzMg==", "bodyText": "Hey Rui, I consider you have to use my anonymous version of SCMRatisServer,\nbecause of\n\n      @Override\n      public SCMRatisResponse submitRequest(SCMRatisRequest request) throws IOException, ExecutionException, InterruptedException {\n        throw new IOException(\"submitRequest is called.\");\n      }\n\n,\nfrom the IOException\n    ContainerStateManagerV2 proxy = (ContainerStateManagerV2) Proxy.newProxyInstance(\n        SCMHAInvocationHandler.class.getClassLoader(),\n        new Class<?>[]{ContainerStateManagerV2.class}, invocationHandler);\n\n    try {\n      proxy.addContainer(HddsProtos.ContainerInfoProto.getDefaultInstance());\n      Assert.fail();\n    } catch (IOException ignore) {\n\n    }\n\nwe can know that invokeRatis() is called, due to the annotation.", "url": "https://github.com/apache/ozone/pull/1650#discussion_r550410832", "createdAt": "2020-12-31T06:46:22Z", "author": {"login": "GlenGeng"}, "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestReplicationAnnotation.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p/>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p/>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.hdds.scm.ha;\n+\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos;\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol.RequestType;\n+import org.apache.hadoop.hdds.scm.container.ContainerID;\n+import org.apache.hadoop.hdds.scm.container.ContainerInfo;\n+import org.apache.hadoop.hdds.scm.container.ContainerReplica;\n+import org.apache.hadoop.hdds.scm.container.ContainerStateManagerV2;\n+import org.apache.hadoop.hdds.scm.pipeline.PipelineID;\n+import org.apache.hadoop.ozone.common.statemachine.InvalidStateTransitionException;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.NavigableSet;\n+import java.util.Set;\n+\n+/**\n+ * Tests on {@link org.apache.hadoop.hdds.scm.metadata.Replicate}.\n+ */\n+public class TestReplicationAnnotation {\n+  private SCMHAInvocationHandler scmhaInvocationHandler;\n+  private ContainerStateManagerV2 mockCSM;\n+\n+  @Before\n+  public void setup() {\n+    SCMHAManager mock = MockSCMHAManager.getInstance(true);\n+    mockCSM = new ContainerStateManagerV2() {\n+      @Override\n+      public boolean contains(HddsProtos.ContainerID containerID) {\n+        return false;\n+      }\n+\n+      @Override\n+      public Set<ContainerID> getContainerIDs() {\n+        return null;\n+      }\n+\n+      @Override\n+      public Set<ContainerID> getContainerIDs(\n+          HddsProtos.LifeCycleState state) {\n+        return null;\n+      }\n+\n+      @Override\n+      public ContainerInfo getContainer(HddsProtos.ContainerID id) {\n+        return null;\n+      }\n+\n+      @Override\n+      public Set<ContainerReplica> getContainerReplicas(\n+          HddsProtos.ContainerID id) {\n+        return null;\n+      }\n+\n+      @Override\n+      public void updateContainerReplica(\n+          HddsProtos.ContainerID id, ContainerReplica replica) {\n+\n+      }\n+\n+      @Override\n+      public void removeContainerReplica(\n+          HddsProtos.ContainerID id, ContainerReplica replica) {\n+\n+      }\n+\n+      @Override\n+      public void addContainer(HddsProtos.ContainerInfoProto containerInfo)\n+          throws IOException {\n+\n+      }\n+\n+      @Override\n+      public void updateContainerState(\n+          HddsProtos.ContainerID id, HddsProtos.LifeCycleEvent event)\n+          throws IOException, InvalidStateTransitionException {\n+\n+      }\n+\n+      @Override\n+      public void updateDeleteTransactionId(\n+          Map<ContainerID, Long> deleteTransactionMap) throws IOException {\n+\n+      }\n+\n+      @Override\n+      public ContainerInfo getMatchingContainer(\n+          long size, String owner, PipelineID pipelineID,\n+          NavigableSet<ContainerID> containerIDs) {\n+        return null;\n+      }\n+\n+      @Override\n+      public void removeContainer(HddsProtos.ContainerID containerInfo)\n+          throws IOException {\n+      }\n+\n+      @Override\n+      public void close() throws IOException {\n+\n+      }\n+    };\n+\n+    scmhaInvocationHandler = new SCMHAInvocationHandler(\n+        RequestType.CONTAINER, mockCSM, mock.getRatisServer());\n+  }\n+\n+  @Test\n+  public void testReplicateAnnotationBasic() throws Throwable {\n+    // test whether this call will hit the Ratis based replication\n+    // code path in SCMHAInvocationHandler. The invoke() can return means the\n+    // request is handled properly thus response is successful. Expected\n+    // result is null because the function returns nothing.\n+    Object[] arguments = {HddsProtos.ContainerInfoProto.getDefaultInstance()};\n+    Assert.assertEquals(null, scmhaInvocationHandler.invoke(new Object(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbf055ef0da1d0338a9c4d43de2aa2e3d61b455c"}, "originalPosition": 134}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2MjgzMzg4OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestReplicationAnnotation.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQwNzo1MzoyMFrOIM7EPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQwNzo1MzoyMFrOIM7EPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQyMTU2Ng==", "bodyText": "@GlenGeng\nDone.", "url": "https://github.com/apache/ozone/pull/1650#discussion_r550421566", "createdAt": "2020-12-31T07:53:20Z", "author": {"login": "amaliujia"}, "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestReplicationAnnotation.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p/>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p/>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.hdds.scm.ha;\n+\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos;\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol;\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol.RequestType;\n+import org.apache.hadoop.hdds.scm.container.ContainerStateManagerV2;\n+import org.apache.ratis.protocol.exceptions.NotLeaderException;\n+import org.apache.ratis.server.RaftServer;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.lang.reflect.Proxy;\n+import java.util.List;\n+import java.util.concurrent.ExecutionException;\n+\n+/**\n+ * Tests on {@link org.apache.hadoop.hdds.scm.metadata.Replicate}.\n+ */\n+public class TestReplicationAnnotation {\n+  private SCMHAInvocationHandler scmhaInvocationHandler;\n+\n+  @Before\n+  public void setup() {\n+    SCMRatisServer ratisServer = new SCMRatisServer() {\n+      @Override\n+      public void start() throws IOException {\n+      }\n+\n+      @Override\n+      public void registerStateMachineHandler(\n+          SCMRatisProtocol.RequestType handlerType, Object handler) {\n+      }\n+\n+      @Override\n+      public SCMRatisResponse submitRequest(SCMRatisRequest request)\n+          throws IOException, ExecutionException, InterruptedException {\n+        throw new IOException(\"submitRequest is called.\");\n+      }\n+\n+      @Override\n+      public void stop() throws IOException {\n+      }\n+\n+      @Override\n+      public RaftServer.Division getDivision() {\n+        return null;\n+      }\n+\n+      @Override\n+      public List<String> getRatisRoles() {\n+        return null;\n+      }\n+\n+      @Override\n+      public NotLeaderException triggerNotLeaderException() {\n+        return null;\n+      }\n+    };\n+\n+    scmhaInvocationHandler = new SCMHAInvocationHandler(\n+        RequestType.CONTAINER, null, ratisServer);\n+  }\n+\n+  @Test\n+  public void testReplicateAnnotationBasic() throws Throwable {\n+    ContainerStateManagerV2 proxy =\n+        (ContainerStateManagerV2) Proxy.newProxyInstance(\n+        SCMHAInvocationHandler.class.getClassLoader(),\n+        new Class<?>[]{ContainerStateManagerV2.class}, scmhaInvocationHandler);\n+\n+    try {\n+      proxy.addContainer(HddsProtos.ContainerInfoProto.getDefaultInstance());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e10e0ce8c20dfa538232d9bbc858f98e97db2ed"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2MjgzNDc1OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestReplicationAnnotation.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQwNzo1NDowMFrOIM7Esg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQwNzo1NDowMFrOIM7Esg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQyMTY4Mg==", "bodyText": "We only want to see that it will hit SCMHAInvocationHandler.invokeRatis() so there is no need to implement a ContainerStateManagerV2.", "url": "https://github.com/apache/ozone/pull/1650#discussion_r550421682", "createdAt": "2020-12-31T07:54:00Z", "author": {"login": "amaliujia"}, "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestReplicationAnnotation.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p/>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p/>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.hdds.scm.ha;\n+\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos;\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol;\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol.RequestType;\n+import org.apache.hadoop.hdds.scm.container.ContainerStateManagerV2;\n+import org.apache.ratis.protocol.exceptions.NotLeaderException;\n+import org.apache.ratis.server.RaftServer;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.lang.reflect.Proxy;\n+import java.util.List;\n+import java.util.concurrent.ExecutionException;\n+\n+/**\n+ * Tests on {@link org.apache.hadoop.hdds.scm.metadata.Replicate}.\n+ */\n+public class TestReplicationAnnotation {\n+  private SCMHAInvocationHandler scmhaInvocationHandler;\n+\n+  @Before\n+  public void setup() {\n+    SCMRatisServer ratisServer = new SCMRatisServer() {\n+      @Override\n+      public void start() throws IOException {\n+      }\n+\n+      @Override\n+      public void registerStateMachineHandler(\n+          SCMRatisProtocol.RequestType handlerType, Object handler) {\n+      }\n+\n+      @Override\n+      public SCMRatisResponse submitRequest(SCMRatisRequest request)\n+          throws IOException, ExecutionException, InterruptedException {\n+        throw new IOException(\"submitRequest is called.\");\n+      }\n+\n+      @Override\n+      public void stop() throws IOException {\n+      }\n+\n+      @Override\n+      public RaftServer.Division getDivision() {\n+        return null;\n+      }\n+\n+      @Override\n+      public List<String> getRatisRoles() {\n+        return null;\n+      }\n+\n+      @Override\n+      public NotLeaderException triggerNotLeaderException() {\n+        return null;\n+      }\n+    };\n+\n+    scmhaInvocationHandler = new SCMHAInvocationHandler(\n+        RequestType.CONTAINER, null, ratisServer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e10e0ce8c20dfa538232d9bbc858f98e97db2ed"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2ODQzNjk1OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestReplicationAnnotation.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwNjozNDowNVrOINmyNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwNjozNDowNVrOINmyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTEzNzg0NA==", "bodyText": "Please add some message such as Assert.fail(\"xxxxx\");. You can do it in next pr, I will merge this first.", "url": "https://github.com/apache/ozone/pull/1650#discussion_r551137844", "createdAt": "2021-01-04T06:34:05Z", "author": {"login": "runzhiwang"}, "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestReplicationAnnotation.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p/>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p/>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.hdds.scm.ha;\n+\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos;\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol;\n+import org.apache.hadoop.hdds.protocol.proto.SCMRatisProtocol.RequestType;\n+import org.apache.hadoop.hdds.scm.container.ContainerStateManagerV2;\n+import org.apache.ratis.protocol.exceptions.NotLeaderException;\n+import org.apache.ratis.server.RaftServer;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.lang.reflect.Proxy;\n+import java.util.List;\n+import java.util.concurrent.ExecutionException;\n+\n+/**\n+ * Tests on {@link org.apache.hadoop.hdds.scm.metadata.Replicate}.\n+ */\n+public class TestReplicationAnnotation {\n+  private SCMHAInvocationHandler scmhaInvocationHandler;\n+\n+  @Before\n+  public void setup() {\n+    SCMRatisServer ratisServer = new SCMRatisServer() {\n+      @Override\n+      public void start() throws IOException {\n+      }\n+\n+      @Override\n+      public void registerStateMachineHandler(\n+          SCMRatisProtocol.RequestType handlerType, Object handler) {\n+      }\n+\n+      @Override\n+      public SCMRatisResponse submitRequest(SCMRatisRequest request)\n+          throws IOException, ExecutionException, InterruptedException {\n+        throw new IOException(\"submitRequest is called.\");\n+      }\n+\n+      @Override\n+      public void stop() throws IOException {\n+      }\n+\n+      @Override\n+      public RaftServer.Division getDivision() {\n+        return null;\n+      }\n+\n+      @Override\n+      public List<String> getRatisRoles() {\n+        return null;\n+      }\n+\n+      @Override\n+      public NotLeaderException triggerNotLeaderException() {\n+        return null;\n+      }\n+    };\n+\n+    scmhaInvocationHandler = new SCMHAInvocationHandler(\n+        RequestType.CONTAINER, null, ratisServer);\n+  }\n+\n+  @Test\n+  public void testReplicateAnnotationBasic() throws Throwable {\n+    ContainerStateManagerV2 proxy =\n+        (ContainerStateManagerV2) Proxy.newProxyInstance(\n+        SCMHAInvocationHandler.class.getClassLoader(),\n+        new Class<?>[]{ContainerStateManagerV2.class}, scmhaInvocationHandler);\n+\n+    try {\n+      proxy.addContainer(HddsProtos.ContainerInfoProto.getDefaultInstance());\n+      // Should have seen a IOException.\n+      Assert.fail();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e10e0ce8c20dfa538232d9bbc858f98e97db2ed"}, "originalPosition": 92}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4547, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}