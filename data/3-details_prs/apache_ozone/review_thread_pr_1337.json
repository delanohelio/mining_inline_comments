{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMDA0MDY0", "number": 1337, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNToyNDo1M1rOEbn5dQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwODo1MjoxN1rOEgTPHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3NDAwNjkzOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNToyNDo1M1rOHFqSHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QwMzozMzoxNFrOHH5Zcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY5NzY5NA==", "bodyText": "What about volumes created before this change with the previous max. value?  Will those be treated by new version as if quota had been enabled for them?", "url": "https://github.com/apache/ozone/pull/1337#discussion_r475697694", "createdAt": "2020-08-24T15:24:53Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "diffHunk": "@@ -200,9 +200,9 @@ public static Versioning getVersioning(boolean versioning) {\n \n \n   /**\n-   * Max OM Quota size of 1024 PB.\n+   * Max OM Quota size of Long.MAX_VALUE.\n    */\n-  public static final long MAX_QUOTA_IN_BYTES = 1024L * 1024 * TB;\n+  public static final long MAX_QUOTA_IN_BYTES = Long.MAX_VALUE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16772eee391abb6c4d12ae8e07864e26f2a88127"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI1MzE1Ng==", "bodyText": "Thanks for  @adoroszlai 's discussion. Yes, the previous volume will enable quota. So I created JIRA HDDS-4106, which supports user Clearing spaceQuota.", "url": "https://github.com/apache/ozone/pull/1337#discussion_r476253156", "createdAt": "2020-08-25T08:00:18Z", "author": {"login": "captainzmc"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "diffHunk": "@@ -200,9 +200,9 @@ public static Versioning getVersioning(boolean versioning) {\n \n \n   /**\n-   * Max OM Quota size of 1024 PB.\n+   * Max OM Quota size of Long.MAX_VALUE.\n    */\n-  public static final long MAX_QUOTA_IN_BYTES = 1024L * 1024 * TB;\n+  public static final long MAX_QUOTA_IN_BYTES = Long.MAX_VALUE;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY5NzY5NA=="}, "originalCommit": {"oid": "16772eee391abb6c4d12ae8e07864e26f2a88127"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzAxNDkzOQ==", "bodyText": "Suggest add new logic during OM startup to reset existing Volume max quota value to mitigate the compatibility issue.", "url": "https://github.com/apache/ozone/pull/1337#discussion_r477014939", "createdAt": "2020-08-26T03:43:08Z", "author": {"login": "ChenSammi"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "diffHunk": "@@ -200,9 +200,9 @@ public static Versioning getVersioning(boolean versioning) {\n \n \n   /**\n-   * Max OM Quota size of 1024 PB.\n+   * Max OM Quota size of Long.MAX_VALUE.\n    */\n-  public static final long MAX_QUOTA_IN_BYTES = 1024L * 1024 * TB;\n+  public static final long MAX_QUOTA_IN_BYTES = Long.MAX_VALUE;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY5NzY5NA=="}, "originalCommit": {"oid": "16772eee391abb6c4d12ae8e07864e26f2a88127"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzEyMTE4NQ==", "bodyText": "I double checked HDFS implementation\uff0cit doesn't use LONG.MAX_VALUE to verify whether quota is enabled or not. It use \"-1\" which is more reasonable for a set/unset check.", "url": "https://github.com/apache/ozone/pull/1337#discussion_r477121185", "createdAt": "2020-08-26T08:20:20Z", "author": {"login": "ChenSammi"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "diffHunk": "@@ -200,9 +200,9 @@ public static Versioning getVersioning(boolean versioning) {\n \n \n   /**\n-   * Max OM Quota size of 1024 PB.\n+   * Max OM Quota size of Long.MAX_VALUE.\n    */\n-  public static final long MAX_QUOTA_IN_BYTES = 1024L * 1024 * TB;\n+  public static final long MAX_QUOTA_IN_BYTES = Long.MAX_VALUE;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY5NzY5NA=="}, "originalCommit": {"oid": "16772eee391abb6c4d12ae8e07864e26f2a88127"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODA0MjQ4Mw==", "bodyText": "Thanks sammi for the discussion. It is indeed uncommon to use the maximum value to determine whether to enable quota, and it is more common to use -1 to determine. Later I will confirm whether to enable quota with -1 in HDDS-3727. The MAX_QUOTA_IN_BYTES here will be used to determine if the parameter values for setquota and updatequota are reasonable in HDDS-3725.", "url": "https://github.com/apache/ozone/pull/1337#discussion_r478042483", "createdAt": "2020-08-27T03:33:14Z", "author": {"login": "captainzmc"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "diffHunk": "@@ -200,9 +200,9 @@ public static Versioning getVersioning(boolean versioning) {\n \n \n   /**\n-   * Max OM Quota size of 1024 PB.\n+   * Max OM Quota size of Long.MAX_VALUE.\n    */\n-  public static final long MAX_QUOTA_IN_BYTES = 1024L * 1024 * TB;\n+  public static final long MAX_QUOTA_IN_BYTES = Long.MAX_VALUE;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY5NzY5NA=="}, "originalCommit": {"oid": "16772eee391abb6c4d12ae8e07864e26f2a88127"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMzAzNzAxOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwODo0ODozMlrOHNFR7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwOToxMjozNVrOHNGGLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ4MDA0Nw==", "bodyText": "Can we add a UT for this function?", "url": "https://github.com/apache/ozone/pull/1337#discussion_r483480047", "createdAt": "2020-09-04T08:48:32Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3540,6 +3546,43 @@ public boolean getEnableFileSystemPaths() {\n         OZONE_OM_ENABLE_FILESYSTEM_PATHS_DEFAULT);\n   }\n \n+  /**\n+   * Initialize volume's quota, which resolves the problem that the old quota\n+   * initial value was not set correctly. This method will be removed in a\n+   * later version.\n+   * @throws IOException\n+   */\n+  private void initializeOldVolumeQuota() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f1fd51531e3f2836bcc7c916d8b1a0c0e72d8fa"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ5MzQyMA==", "bodyText": "Yes, the corresponding UT has been added.", "url": "https://github.com/apache/ozone/pull/1337#discussion_r483493420", "createdAt": "2020-09-04T09:12:35Z", "author": {"login": "captainzmc"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3540,6 +3546,43 @@ public boolean getEnableFileSystemPaths() {\n         OZONE_OM_ENABLE_FILESYSTEM_PATHS_DEFAULT);\n   }\n \n+  /**\n+   * Initialize volume's quota, which resolves the problem that the old quota\n+   * initial value was not set correctly. This method will be removed in a\n+   * later version.\n+   * @throws IOException\n+   */\n+  private void initializeOldVolumeQuota() throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ4MDA0Nw=="}, "originalCommit": {"oid": "3f1fd51531e3f2836bcc7c916d8b1a0c0e72d8fa"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMzA0MDE3OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwODo0OToyM1rOHNFT0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwOToyNjo1MFrOHNGkEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ4MDUzMQ==", "bodyText": "Why  omVolumeArgs.getQuotaInBytes() == OzoneConsts.MAX_QUOTA_IN_BYTES check is required here?", "url": "https://github.com/apache/ozone/pull/1337#discussion_r483480531", "createdAt": "2020-09-04T08:49:23Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3540,6 +3546,43 @@ public boolean getEnableFileSystemPaths() {\n         OZONE_OM_ENABLE_FILESYSTEM_PATHS_DEFAULT);\n   }\n \n+  /**\n+   * Initialize volume's quota, which resolves the problem that the old quota\n+   * initial value was not set correctly. This method will be removed in a\n+   * later version.\n+   * @throws IOException\n+   */\n+  private void initializeOldVolumeQuota() throws IOException {\n+\n+    TableIterator<String, ? extends Table.KeyValue<String,\n+         OmVolumeArgs>> iterator = metadataManager.getVolumeTable().iterator();\n+    while(iterator.hasNext()) {\n+      OmVolumeArgs omVolumeArgs = iterator.next().getValue();\n+      String omVolumeKey = metadataManager.getVolumeKey(\n+          omVolumeArgs.getVolume());\n+      // Previously, the volume quota was created to default to 1EB. To change\n+      // to -1, default does not enable quota.\n+      if (omVolumeArgs.getQuotaInBytes() == 1024 * 1024 * TB ||\n+          omVolumeArgs.getQuotaInBytes() == OzoneConsts.MAX_QUOTA_IN_BYTES) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f1fd51531e3f2836bcc7c916d8b1a0c0e72d8fa"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUwMTA3Mw==", "bodyText": "This judgment is redundant, will delete it.", "url": "https://github.com/apache/ozone/pull/1337#discussion_r483501073", "createdAt": "2020-09-04T09:26:50Z", "author": {"login": "captainzmc"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3540,6 +3546,43 @@ public boolean getEnableFileSystemPaths() {\n         OZONE_OM_ENABLE_FILESYSTEM_PATHS_DEFAULT);\n   }\n \n+  /**\n+   * Initialize volume's quota, which resolves the problem that the old quota\n+   * initial value was not set correctly. This method will be removed in a\n+   * later version.\n+   * @throws IOException\n+   */\n+  private void initializeOldVolumeQuota() throws IOException {\n+\n+    TableIterator<String, ? extends Table.KeyValue<String,\n+         OmVolumeArgs>> iterator = metadataManager.getVolumeTable().iterator();\n+    while(iterator.hasNext()) {\n+      OmVolumeArgs omVolumeArgs = iterator.next().getValue();\n+      String omVolumeKey = metadataManager.getVolumeKey(\n+          omVolumeArgs.getVolume());\n+      // Previously, the volume quota was created to default to 1EB. To change\n+      // to -1, default does not enable quota.\n+      if (omVolumeArgs.getQuotaInBytes() == 1024 * 1024 * TB ||\n+          omVolumeArgs.getQuotaInBytes() == OzoneConsts.MAX_QUOTA_IN_BYTES) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ4MDUzMQ=="}, "originalCommit": {"oid": "3f1fd51531e3f2836bcc7c916d8b1a0c0e72d8fa"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMzA0MTc0OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwODo0OTo1MlrOHNFU2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwODo0OTo1MlrOHNFU2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ4MDc5NA==", "bodyText": "duplicate \",\"", "url": "https://github.com/apache/ozone/pull/1337#discussion_r483480794", "createdAt": "2020-09-04T08:49:52Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3540,6 +3546,43 @@ public boolean getEnableFileSystemPaths() {\n         OZONE_OM_ENABLE_FILESYSTEM_PATHS_DEFAULT);\n   }\n \n+  /**\n+   * Initialize volume's quota, which resolves the problem that the old quota\n+   * initial value was not set correctly. This method will be removed in a\n+   * later version.\n+   * @throws IOException\n+   */\n+  private void initializeOldVolumeQuota() throws IOException {\n+\n+    TableIterator<String, ? extends Table.KeyValue<String,\n+         OmVolumeArgs>> iterator = metadataManager.getVolumeTable().iterator();\n+    while(iterator.hasNext()) {\n+      OmVolumeArgs omVolumeArgs = iterator.next().getValue();\n+      String omVolumeKey = metadataManager.getVolumeKey(\n+          omVolumeArgs.getVolume());\n+      // Previously, the volume quota was created to default to 1EB. To change\n+      // to -1, default does not enable quota.\n+      if (omVolumeArgs.getQuotaInBytes() == 1024 * 1024 * TB ||\n+          omVolumeArgs.getQuotaInBytes() == OzoneConsts.MAX_QUOTA_IN_BYTES) {\n+        omVolumeArgs.setQuotaInBytes(-1);\n+        // Commit to DB.\n+        BatchOperation batchOperation =\n+            metadataManager.getStore().initBatchOperation();\n+        metadataManager.getVolumeTable().putWithBatch(batchOperation,\n+            omVolumeKey, omVolumeArgs);\n+        metadataManager.getStore().commitBatchOperation(batchOperation);\n+\n+        // Add to cache.\n+        long transactionID = (Long.MAX_VALUE - 1) >> 8;\n+        metadataManager.getVolumeTable().addCacheEntry(\n+            new CacheKey<>(omVolumeKey),\n+            new CacheValue<>(Optional.of(omVolumeArgs), transactionID));\n+        LOG.info(\"Update Volume {}'s quota to -1, , default does not enable\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f1fd51531e3f2836bcc7c916d8b1a0c0e72d8fa"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMzA1MDUyOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwODo1MjoxN1rOHNFZ7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwOTo0NDo1MlrOHNHIZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ4MjA5Mw==", "bodyText": "There is one risk here,  if user set the quota to 1EB specifically,  we cann't reset it to -1 on next OM restart.", "url": "https://github.com/apache/ozone/pull/1337#discussion_r483482093", "createdAt": "2020-09-04T08:52:17Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3540,6 +3546,43 @@ public boolean getEnableFileSystemPaths() {\n         OZONE_OM_ENABLE_FILESYSTEM_PATHS_DEFAULT);\n   }\n \n+  /**\n+   * Initialize volume's quota, which resolves the problem that the old quota\n+   * initial value was not set correctly. This method will be removed in a\n+   * later version.\n+   * @throws IOException\n+   */\n+  private void initializeOldVolumeQuota() throws IOException {\n+\n+    TableIterator<String, ? extends Table.KeyValue<String,\n+         OmVolumeArgs>> iterator = metadataManager.getVolumeTable().iterator();\n+    while(iterator.hasNext()) {\n+      OmVolumeArgs omVolumeArgs = iterator.next().getValue();\n+      String omVolumeKey = metadataManager.getVolumeKey(\n+          omVolumeArgs.getVolume());\n+      // Previously, the volume quota was created to default to 1EB. To change\n+      // to -1, default does not enable quota.\n+      if (omVolumeArgs.getQuotaInBytes() == 1024 * 1024 * TB ||", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f1fd51531e3f2836bcc7c916d8b1a0c0e72d8fa"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUxMDM3Mg==", "bodyText": "Currently, the way to determine the old quota is by seeing whether his quota is 1 EB. So 1EB is still a special value. At present, OZone's cluster size is not large, far from the upper limit of 1EB.\nSo can we ignore this case? In addition, I adjust the LOG level from INFO to Warn (I can change it to ERROR if needed) to alert the user that the corresponding quota has been changed.", "url": "https://github.com/apache/ozone/pull/1337#discussion_r483510372", "createdAt": "2020-09-04T09:44:52Z", "author": {"login": "captainzmc"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3540,6 +3546,43 @@ public boolean getEnableFileSystemPaths() {\n         OZONE_OM_ENABLE_FILESYSTEM_PATHS_DEFAULT);\n   }\n \n+  /**\n+   * Initialize volume's quota, which resolves the problem that the old quota\n+   * initial value was not set correctly. This method will be removed in a\n+   * later version.\n+   * @throws IOException\n+   */\n+  private void initializeOldVolumeQuota() throws IOException {\n+\n+    TableIterator<String, ? extends Table.KeyValue<String,\n+         OmVolumeArgs>> iterator = metadataManager.getVolumeTable().iterator();\n+    while(iterator.hasNext()) {\n+      OmVolumeArgs omVolumeArgs = iterator.next().getValue();\n+      String omVolumeKey = metadataManager.getVolumeKey(\n+          omVolumeArgs.getVolume());\n+      // Previously, the volume quota was created to default to 1EB. To change\n+      // to -1, default does not enable quota.\n+      if (omVolumeArgs.getQuotaInBytes() == 1024 * 1024 * TB ||", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ4MjA5Mw=="}, "originalCommit": {"oid": "3f1fd51531e3f2836bcc7c916d8b1a0c0e72d8fa"}, "originalPosition": 47}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3900, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}