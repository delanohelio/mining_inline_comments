{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1ODQ3OTE1", "number": 654, "title": "HDDS-3150. Implement getIfExist in Table and use it in CreateKey/File", "bodyText": "What changes were proposed in this pull request?\nImplement getIfExist in Table and use it in CreateKey/File\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3150\nHow was this patch tested?\nAdded UT.\nAnd also deployed this fix on a laptop and ran the benchmark with/without fix.\nUsing db.getIfExist\n$ support-tools-0.1.0-SNAPSHOT/bin/ozone-tools benchmark om write -d=35m -w=50\nFinal Stats!\nTime elapsed: 2100 sec.\nNumber of Threads: 50\nNumber of Keys written: 6335987\nAverage Key write time (CPU Time): 16.5624 milliseconds. \nAverage Key write time (Real): .3312 milliseconds. \nMax Key write time (CPU Time): 558 milliseconds.\n****************************************************************\n\nMetrics\nSo, out of 6.33 million calls of getIfExist, only 15599 calls performed db.get and all those are misses. So, it proves that using db.getIfExist in a negative case is better.\n\"NumDBKeyGetIfExistChecks\": 6335987, (Total calls to API)\n\"NumDBKeyGetIfExistMisses\": 15599, (keyMay Exist returned true, we call db.get, this metric value says how many times we called db.get())\n\"NumDBKeyGetIfExistGets\": 15599 (keyMay Exist returned true, we called db.get(), but turns out that db.get() returns null, so this is a miss where keyMayExist was not able to find out correctly)\nWithout getIfExist/ With get\n$ support-tools-0.1.0-SNAPSHOT/bin/ozone-tools benchmark om write -d=60m -w=50\n================================================================\n2020-03-09T14:06:33.169\n================================================================\nTime elapsed: 2100 sec.\nNumber of Threads: 50\nNumber of Keys written: 5815634\nAverage Key write time (CPU Time): 18.0492 milliseconds. \nAverage Key write time (Real): .3610 milliseconds. \nMax Key write time (CPU Time): 1080 milliseconds.\n****************************************************************\n\nConclusion:\nWith getIfExists:\n6335987 Keys created in 35 mts\nThroughput: 3017 keys/sec\nWith get:\n5815634 Keys created in 35 mts\nThroughput: 2769 keys/sec", "createdAt": "2020-03-09T22:27:15Z", "url": "https://github.com/apache/ozone/pull/654", "merged": true, "mergeCommit": {"oid": "fd1aba8241a908dfcf95041a233201eefba65b73"}, "closed": true, "closedAt": "2020-03-16T15:38:07Z", "author": {"login": "bharatviswa504"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMFv1mgH2gAyMzg1ODQ3OTE1OmFhZjc0ODhkMGQ0NTZkYWMzNzI3MDFhMzFhOTFiMTg0NTRkMjUzYzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOP-aRAFqTM3NTMzNTI5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "aaf7488d0d456dac372701a31a91b18454d253c9", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/aaf7488d0d456dac372701a31a91b18454d253c9", "committedDate": "2020-03-09T22:34:57Z", "message": "getIfExist"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab337e657bdd5ac65db7ce49b43da71784aa1c2c", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/ab337e657bdd5ac65db7ce49b43da71784aa1c2c", "committedDate": "2020-03-09T21:35:02Z", "message": "fix test"}, "afterCommit": {"oid": "aaf7488d0d456dac372701a31a91b18454d253c9", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/aaf7488d0d456dac372701a31a91b18454d253c9", "committedDate": "2020-03-09T22:34:57Z", "message": "getIfExist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "faa0c88371d544882ca7c23464fe8b18c4ac0020", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/faa0c88371d544882ca7c23464fe8b18c4ac0020", "committedDate": "2020-03-09T22:43:24Z", "message": "minor change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNjQ5MTEw", "url": "https://github.com/apache/ozone/pull/654#pullrequestreview-371649110", "createdAt": "2020-03-10T02:46:30Z", "commit": {"oid": "faa0c88371d544882ca7c23464fe8b18c4ac0020"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMjo0NjozMVrOFz_xiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMjo0NjozMVrOFz_xiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA2NjU3MQ==", "bodyText": "whats the reason for the illegal arguement exception ? Do we have a stack trace?", "url": "https://github.com/apache/ozone/pull/654#discussion_r390066571", "createdAt": "2020-03-10T02:46:31Z", "author": {"login": "mukul1987"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBTable.java", "diffHunk": "@@ -155,6 +155,32 @@ public boolean isExist(byte[] key) throws IOException {\n     }\n   }\n \n+  @Override\n+  public byte[] getIfExist(byte[] key) throws IOException {\n+    try {\n+      // RocksDB#keyMayExist\n+      // If the key definitely does not exist in the database, then this\n+      // method returns false, else true.\n+      rdbMetrics.incNumDBKeyGetIfExistChecks();\n+      StringBuilder outValue = new StringBuilder();\n+      boolean keyMayExist = db.keyMayExist(handle, key, outValue);\n+      if (keyMayExist) {\n+        // Not using out value from string builder, as that is causing\n+        // IllegalArgumentException during protobuf parsing.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faa0c88371d544882ca7c23464fe8b18c4ac0020"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ca75ae770643d3b5a24b2c6e5dc6b6411f2fef1", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/1ca75ae770643d3b5a24b2c6e5dc6b6411f2fef1", "committedDate": "2020-03-10T04:40:22Z", "message": "make key commit also use getIfExist"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MzM1Mjkx", "url": "https://github.com/apache/ozone/pull/654#pullrequestreview-375335291", "createdAt": "2020-03-16T15:37:46Z", "commit": {"oid": "1ca75ae770643d3b5a24b2c6e5dc6b6411f2fef1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3445, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}