{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwMDg4NTc0", "number": 1128, "title": "HDDS-3862. Prepare checks for running some tests multiple times", "bodyText": "What changes were proposed in this pull request?\n\nImprove unit.sh and integration.sh to allow running tests multiple times after a single compilation.\n\nNumber of runs is controlled by ITERATIONS environment variable (defaults to 1).\nFailed test output from each iteration is saved into a separate directory (iterationN), but only if repetitions are requested, ie. no change for regular, single run.\nEach run is followed by a one-liner summary, eg.: Iteration 1 exit code: 0\n\n\nReduce duplication by extracting common logic into separate junit.sh script.\n\nhttps://issues.apache.org/jira/browse/HDDS-3862\nHow was this patch tested?\nRegular CI runs:\n\nunit\neg. integration (client)\n\nRepeated tests:\n\nTestCloseContainerByPipeline, failed 5/20\nTestCSMMetrics, passed 20/20", "createdAt": "2020-06-25T15:15:19Z", "url": "https://github.com/apache/ozone/pull/1128", "merged": true, "mergeCommit": {"oid": "86bd3b3659ed3801339851da021e92b6b6677769"}, "closed": true, "closedAt": "2020-07-02T19:07:04Z", "author": {"login": "adoroszlai"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcud2oXgH2gAyNDQwMDg4NTc0OjI2OGU1OWU2ZDAxNWE0OGIwN2IxMmIwZGQzYzIyODlmM2IzMTFkYzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcxBPCVAH2gAyNDQwMDg4NTc0OjkyYzA1NWQzZTQzNjIwZGFhYmE5Y2E0NmNmZTliMzc4NDVkMTEzZjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "268e59e6d015a48b07b12b0dd3c2289f3b311dc2", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/268e59e6d015a48b07b12b0dd3c2289f3b311dc2", "committedDate": "2020-06-24T17:53:31Z", "message": "HDDS-3862. Prepare checks for running some tests multiple times"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bb425194b1f0d00a935a937ae28336830964a9e", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/3bb425194b1f0d00a935a937ae28336830964a9e", "committedDate": "2020-06-25T06:35:23Z", "message": "trigger new CI check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5ODU1MDE0", "url": "https://github.com/apache/ozone/pull/1128#pullrequestreview-439855014", "createdAt": "2020-06-30T09:50:46Z", "commit": {"oid": "3bb425194b1f0d00a935a937ae28336830964a9e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwOTo1MDo0NlrOGq0zPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwOTo1MDo0NlrOGq0zPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU1ODQ2Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                echo \"Iteration ${i} exit code: ${irc}\" | tee -a \"${REPORT_DIR}/output.log\"\n          \n          \n            \n                echo \"Iteration ${i} exit code: ${irc}\" | tee -a \"${REPORT_DIR}/summary.txt\"\n          \n      \n    \n    \n  \n\nBased on the existing convention, output.log contains the full std output, summary.txt the information.", "url": "https://github.com/apache/ozone/pull/1128#discussion_r447558463", "createdAt": "2020-06-30T09:50:46Z", "author": {"login": "elek"}, "path": "hadoop-ozone/dev-support/checks/junit.sh", "diffHunk": "@@ -0,0 +1,63 @@\n+#!/usr/bin/env bash\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+set -u -o pipefail\n+\n+DIR=\"$( cd \"$( dirname \"${BASH_SOURCE[0]}\" )\" >/dev/null 2>&1 && pwd )\"\n+cd \"$DIR/../../..\" || exit 1\n+\n+: ${CHECK:=\"unit\"}\n+: ${ITERATIONS:=\"1\"}\n+\n+export MAVEN_OPTS=\"-Xmx4096m\"\n+MAVEN_OPTIONS='-B -Dskip.npx -Dskip.installnpx'\n+mvn ${MAVEN_OPTIONS} -DskipTests clean install\n+\n+REPORT_DIR=${OUTPUT_DIR:-\"$DIR/../../../target/${CHECK}\"}\n+mkdir -p \"$REPORT_DIR\"\n+\n+rc=0\n+for i in $(seq 1 ${ITERATIONS}); do\n+  if [[ ${ITERATIONS} -gt 1 ]]; then\n+    original_report_dir=\"${REPORT_DIR}\"\n+    REPORT_DIR=\"${original_report_dir}/iteration${i}\"\n+    mkdir -p \"${REPORT_DIR}\"\n+  fi\n+\n+  mvn ${MAVEN_OPTIONS} -fae \"$@\" test \\\n+    | tee \"${REPORT_DIR}/output.log\"\n+  irc=$?\n+\n+  # shellcheck source=hadoop-ozone/dev-support/checks/_mvn_unit_report.sh\n+  source \"${DIR}/_mvn_unit_report.sh\"\n+\n+  if [[ ${ITERATIONS} -gt 1 ]]; then\n+    REPORT_DIR=\"${original_report_dir}\"\n+    echo \"Iteration ${i} exit code: ${irc}\" | tee -a \"${REPORT_DIR}/output.log\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3bb425194b1f0d00a935a937ae28336830964a9e"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9b0239711b811b8f1888c2d3e9b98c55928d1ce", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/f9b0239711b811b8f1888c2d3e9b98c55928d1ce", "committedDate": "2020-06-30T10:19:41Z", "message": "HDDS-3862. Output iteration result to summary"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMDMzNjk0", "url": "https://github.com/apache/ozone/pull/1128#pullrequestreview-441033694", "createdAt": "2020-07-01T16:41:08Z", "commit": {"oid": "f9b0239711b811b8f1888c2d3e9b98c55928d1ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e83b53233304d8ee68299de9864663854a5420e4", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/e83b53233304d8ee68299de9864663854a5420e4", "committedDate": "2020-07-01T17:23:48Z", "message": "trigger new CI check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df8c3ea6795fb026d8c21cf98d10eeed1681f4ae", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/df8c3ea6795fb026d8c21cf98d10eeed1681f4ae", "committedDate": "2020-07-02T10:43:29Z", "message": "trigger new CI check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "416b9ad0a6de8c54468143c0e6e9fa5659a9dcf5", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/416b9ad0a6de8c54468143c0e6e9fa5659a9dcf5", "committedDate": "2020-07-02T13:07:49Z", "message": "trigger new CI check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92c055d3e43620daaba9ca46cfe9b37845d113f1", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/92c055d3e43620daaba9ca46cfe9b37845d113f1", "committedDate": "2020-07-02T16:14:42Z", "message": "trigger new CI check"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3024, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}