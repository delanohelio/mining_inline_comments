{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxMjM4NTYz", "number": 428, "title": "HDDS-2868. Add ObjectID and UpdateID to OMKeyInfo.", "bodyText": "What changes were proposed in this pull request?\nSimilar to OMVolumeInfo and OMBucketInfo, we need objectID and updateID in OMKeyInfo as well to ensure that transactions are idempotent.\nThis Jira adds objectID and updateID to OMKeyInfo proto and sets these values when creating/ updating keys.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-2868\nHow was this patch tested?\nIntegration and Acceptance tests. Follow-up Jiras for key operation idempotence will add more tests.", "createdAt": "2020-01-10T01:47:52Z", "url": "https://github.com/apache/ozone/pull/428", "merged": true, "mergeCommit": {"oid": "a47974307d8e8a1f42748346674845ba5c48bfb8"}, "closed": true, "closedAt": "2020-01-15T21:41:20Z", "author": {"login": "hanishakoneru"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb40gxkgH2gAyMzYxMjM4NTYzOjcwZjA4NmU2OWNmMzM3NWY1MWQ5MmE3MGUwOTJkZjQ0ZWVmYTk3NmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb--9CYgFqTM0OTg2NTE5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "70f086e69cf3375f51d92a70e092df44eefa976f", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/70f086e69cf3375f51d92a70e092df44eefa976f", "committedDate": "2020-01-10T01:45:33Z", "message": "HDDS-2868. Add ObjectID and UpdateID to OMKeyInfo."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwOTc4Mjgz", "url": "https://github.com/apache/ozone/pull/428#pullrequestreview-340978283", "createdAt": "2020-01-10T06:46:12Z", "commit": {"oid": "70f086e69cf3375f51d92a70e092df44eefa976f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwNjo0NjoxMlrOFcLdIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwNjo0NjoxMlrOFcLdIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA5MjEyOA==", "bodyText": "NIT: primitive type, we dont need @nonnull", "url": "https://github.com/apache/ozone/pull/428#discussion_r365092128", "createdAt": "2020-01-10T06:46:12Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyRequest.java", "diffHunk": "@@ -349,7 +349,8 @@ protected OmKeyInfo createKeyInfo(@Nonnull KeyArgs keyArgs,\n       @Nonnull HddsProtos.ReplicationType type, long size,\n       @Nullable FileEncryptionInfo encInfo,\n       @Nonnull PrefixManager prefixManager,\n-      @Nullable OmBucketInfo omBucketInfo) {\n+      @Nullable OmBucketInfo omBucketInfo,\n+      @Nonnull long transactionLogIndex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70f086e69cf3375f51d92a70e092df44eefa976f"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwOTc4Mzc1", "url": "https://github.com/apache/ozone/pull/428#pullrequestreview-340978375", "createdAt": "2020-01-10T06:46:31Z", "commit": {"oid": "70f086e69cf3375f51d92a70e092df44eefa976f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwNjo0NjozMVrOFcLdZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwNjo0NjozMVrOFcLdZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA5MjE5OQ==", "bodyText": "NIT: primitive type, we dont need @nonnull", "url": "https://github.com/apache/ozone/pull/428#discussion_r365092199", "createdAt": "2020-01-10T06:46:31Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyRequest.java", "diffHunk": "@@ -416,12 +419,14 @@ protected OmKeyInfo prepareKeyInfo(\n       @Nonnull KeyArgs keyArgs, @Nonnull String dbKeyName, long size,\n       @Nonnull List<OmKeyLocationInfo> locations,\n       @Nullable FileEncryptionInfo encInfo,\n-      @Nonnull PrefixManager prefixManager, @Nullable OmBucketInfo omBucketInfo)\n+      @Nonnull PrefixManager prefixManager,\n+      @Nullable OmBucketInfo omBucketInfo,\n+      @Nonnull long transactionLogIndex)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70f086e69cf3375f51d92a70e092df44eefa976f"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwOTc5ODM0", "url": "https://github.com/apache/ozone/pull/428#pullrequestreview-340979834", "createdAt": "2020-01-10T06:51:47Z", "commit": {"oid": "70f086e69cf3375f51d92a70e092df44eefa976f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwNjo1MTo0N1rOFcLh4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwNjo1MTo0N1rOFcLh4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA5MzM0NQ==", "bodyText": "Missing to add objectID and updateID in multipartKeyInfo", "url": "https://github.com/apache/ozone/pull/428#discussion_r365093345", "createdAt": "2020-01-10T06:51:47Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/s3/multipart/S3InitiateMultipartUploadRequest.java", "diffHunk": "@@ -158,9 +158,10 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           .setOmKeyLocationInfos(Collections.singletonList(\n               new OmKeyLocationInfoGroup(0, new ArrayList<>())))\n           .setAcls(OzoneAclUtil.fromProtobuf(keyArgs.getAclsList()))\n+          .setObjectID(transactionLogIndex)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70f086e69cf3375f51d92a70e092df44eefa976f"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwOTgwMzE3", "url": "https://github.com/apache/ozone/pull/428#pullrequestreview-340980317", "createdAt": "2020-01-10T06:53:36Z", "commit": {"oid": "70f086e69cf3375f51d92a70e092df44eefa976f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwNjo1MzozN1rOFcLjbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwNjo1MzozN1rOFcLjbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA5Mzc0MQ==", "bodyText": "Not understood the reason of setting updateID here, as below we are setting Optional.absent(), so it  means entry is deleted from DB.", "url": "https://github.com/apache/ozone/pull/428#discussion_r365093741", "createdAt": "2020-01-10T06:53:37Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/s3/multipart/S3MultipartUploadAbortRequest.java", "diffHunk": "@@ -120,6 +124,21 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n         multipartKeyInfo = omMetadataManager\n             .getMultipartInfoTable().get(multipartKey);\n \n+        // Set updateID to current transactionLogIndex for all parts\n+        TreeMap<Integer, PartKeyInfo> partKeyInfoMap = multipartKeyInfo\n+            .getPartKeyInfoMap();\n+        for (Map.Entry<Integer, PartKeyInfo> partKeyInfoEntry :\n+            partKeyInfoMap.entrySet()) {\n+          PartKeyInfo partKeyInfo = partKeyInfoEntry.getValue();\n+          OmKeyInfo currentKeyPartInfo = OmKeyInfo.getFromProtobuf(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70f086e69cf3375f51d92a70e092df44eefa976f"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/979d8a226b839f23dfcb5ea281d0c014781c6051", "committedDate": "2020-01-10T19:42:39Z", "message": "review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNjE4MzQ2", "url": "https://github.com/apache/ozone/pull/428#pullrequestreview-341618346", "createdAt": "2020-01-13T01:56:10Z", "commit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwMTo1NjoxMFrOFcsR4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwMjowNzo0NlrOFcsVRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYyOTkyMQ==", "bodyText": "assert that it is greater than current updateID?", "url": "https://github.com/apache/ozone/pull/428#discussion_r365629921", "createdAt": "2020-01-13T01:56:10Z", "author": {"login": "arp7"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyInfo.java", "diffHunk": "@@ -135,6 +141,47 @@ public void updateModifcationTime() {\n     this.modificationTime = Time.monotonicNow();\n   }\n \n+  /**\n+   * Set the Object ID. If this value is already set then this function throws.\n+   * There is a reason why we cannot use the final here. The OMKeyInfo is\n+   * deserialized from the protobuf in many places in code. We need to set\n+   * this object ID, after it is deserialized.\n+   *\n+   * @param obId - long\n+   */\n+  public void setObjectID(long obId) {\n+    if(this.objectID != 0) {\n+      throw new UnsupportedOperationException(\"Attempt to modify object ID \" +\n+          \"which is not zero. Current Object ID is \" + this.objectID);\n+    }\n+    this.objectID = obId;\n+  }\n+\n+  /**\n+   * Sets the update ID. For each modification of this object, we will set\n+   * this to a value greater than the current value.\n+   * @param updateID  long\n+   */\n+  public void setUpdateID(long updateID) {\n+    this.updateID = updateID;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYyOTk0Nw==", "bodyText": "Is 0 an invalid object ID and update id?", "url": "https://github.com/apache/ozone/pull/428#discussion_r365629947", "createdAt": "2020-01-13T01:56:30Z", "author": {"login": "arp7"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyInfo.java", "diffHunk": "@@ -52,6 +52,9 @@\n   private HddsProtos.ReplicationType type;\n   private HddsProtos.ReplicationFactor factor;\n   private FileEncryptionInfo encInfo;\n+  private long objectID;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYzMDUwMw==", "bodyText": "Is this code still used? @bharatviswa504", "url": "https://github.com/apache/ozone/pull/428#discussion_r365630503", "createdAt": "2020-01-13T02:04:14Z", "author": {"login": "arp7"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java", "diffHunk": "@@ -943,9 +943,13 @@ private OmMultipartInfo createMultipartInfo(OmKeyArgs keyArgs,\n \n       long currentTime = Time.now();\n       Map<Integer, PartKeyInfo> partKeyInfoMap = new HashMap<>();\n-      OmMultipartKeyInfo multipartKeyInfo = new OmMultipartKeyInfo(\n-          multipartUploadID, currentTime, keyArgs.getType(),\n-          keyArgs.getFactor(), partKeyInfoMap);\n+      OmMultipartKeyInfo multipartKeyInfo = new OmMultipartKeyInfo.Builder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYzMDU2Mg==", "bodyText": "Is the transaction log index reset when the Ratis term changes?", "url": "https://github.com/apache/ozone/pull/428#discussion_r365630562", "createdAt": "2020-01-13T02:05:05Z", "author": {"login": "arp7"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMDirectoryCreateRequest.java", "diffHunk": "@@ -210,7 +210,7 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n \n   private OmKeyInfo createDirectoryKeyInfo(OzoneManager ozoneManager,\n       OmBucketInfo omBucketInfo, String volumeName, String bucketName,\n-      String keyName, KeyArgs keyArgs)\n+      String keyName, KeyArgs keyArgs, long transactionLogIndex)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYzMDY3NQ==", "bodyText": "Also what happens for deployed clusters where the persisted keys have no object Id or update ID? What do we initialize it to?", "url": "https://github.com/apache/ozone/pull/428#discussion_r365630675", "createdAt": "2020-01-13T02:06:15Z", "author": {"login": "arp7"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyInfo.java", "diffHunk": "@@ -52,6 +52,9 @@\n   private HddsProtos.ReplicationType type;\n   private HddsProtos.ReplicationFactor factor;\n   private FileEncryptionInfo encInfo;\n+  private long objectID;\n+  private long updateID;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYzMDc5MA==", "bodyText": "It may be safer to initialize success to false, and set it to true at the end of the try block when all operations are complete.", "url": "https://github.com/apache/ozone/pull/428#discussion_r365630790", "createdAt": "2020-01-13T02:07:46Z", "author": {"login": "arp7"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyRenameRequest.java", "diffHunk": "@@ -112,6 +112,7 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n     OMMetadataManager omMetadataManager = ozoneManager.getMetadataManager();\n     boolean acquiredLock = false;\n     OMClientResponse omClientResponse = null;\n+    boolean success = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMTE0MzY2", "url": "https://github.com/apache/ozone/pull/428#pullrequestreview-342114366", "createdAt": "2020-01-13T20:22:18Z", "commit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QyMDoyMjoxOFrOFdDbeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QyMDoyMjoxOFrOFdDbeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAwOTIxMA==", "bodyText": "Minor NIT: OmKeyInfo -> OmMultipartKeyInfo", "url": "https://github.com/apache/ozone/pull/428#discussion_r366009210", "createdAt": "2020-01-13T20:22:18Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmMultipartKeyInfo.java", "diffHunk": "@@ -83,6 +128,72 @@ public ReplicationFactor getReplicationFactor() {\n     return replicationFactor;\n   }\n \n+  /**\n+   * Builder of OmKeyInfo.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMTM4OTA5", "url": "https://github.com/apache/ozone/pull/428#pullrequestreview-342138909", "createdAt": "2020-01-13T21:07:19Z", "commit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QyMTowNzoxOVrOFdElEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QyMTowNzoxOVrOFdElEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAyODA1MQ==", "bodyText": "I think, we don't need to set updateID, as we delete this entry from KeyTable anyway. (As we set Optional.absent() below, which will be deleted from OM DB eventually when double buffer picks). Or is there any scenario by setting this helps.\nExample: Create key Key1 - 1, Delete Key Key1 - 2 Create Key Key1 (again) - 3 Now replay happening from 1, as now in KeyTable it will have updateID 3, we think it as replay just by checking OmKeyInfo.getUpdateID, similar to Bucket/Volume delete.", "url": "https://github.com/apache/ozone/pull/428#discussion_r366028051", "createdAt": "2020-01-13T21:07:19Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyDeleteRequest.java", "diffHunk": "@@ -126,6 +126,8 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n       if (omKeyInfo == null) {\n         throw new OMException(\"Key not found\", KEY_NOT_FOUND);\n       }\n+      // Set the UpdateID to current transactionLogIndex\n+      omKeyInfo.setUpdateID(transactionLogIndex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMTQxNzQy", "url": "https://github.com/apache/ozone/pull/428#pullrequestreview-342141742", "createdAt": "2020-01-13T21:12:18Z", "commit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QyMToxMjoxOVrOFdEt6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QyMToxMjoxOVrOFdEt6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAzMDMxMg==", "bodyText": "Same as above, I think we don't need to set updateID here, as anyway we are removing entry from multipartInfo table. Is there is any use case that will help in the detection of replay by setting here?", "url": "https://github.com/apache/ozone/pull/428#discussion_r366030312", "createdAt": "2020-01-13T21:12:19Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/s3/multipart/S3MultipartUploadAbortRequest.java", "diffHunk": "@@ -120,6 +124,7 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n         multipartKeyInfo = omMetadataManager\n             .getMultipartInfoTable().get(multipartKey);\n \n+        multipartKeyInfo.setUpdateID(transactionLogIndex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMjAzOTcw", "url": "https://github.com/apache/ozone/pull/428#pullrequestreview-342203970", "createdAt": "2020-01-13T23:16:32Z", "commit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QyMzoxNjozMlrOFdHvfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QyMzoxNjozMlrOFdHvfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA3OTg3MA==", "bodyText": "As this is like new key is getting created, so do we need to set objectID also here?", "url": "https://github.com/apache/ozone/pull/428#discussion_r366079870", "createdAt": "2020-01-13T23:16:32Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyRenameRequest.java", "diffHunk": "@@ -155,6 +156,9 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n       //Set modification time\n       fromKeyValue.setModificationTime(renameKeyArgs.getModificationTime());\n \n+      // Set the UpdateID to current transactionLogIndex\n+      fromKeyValue.setUpdateID(transactionLogIndex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMjE4MjQy", "url": "https://github.com/apache/ozone/pull/428#pullrequestreview-342218242", "createdAt": "2020-01-13T23:57:44Z", "commit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QyMzo1Nzo0NFrOFdIdxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QyMzo1Nzo0NFrOFdIdxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA5MTcxOQ==", "bodyText": "As discussed offline, for this we can set ObjectID, which we have in the dbOpenKeyInfo.", "url": "https://github.com/apache/ozone/pull/428#discussion_r366091719", "createdAt": "2020-01-13T23:57:44Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/s3/multipart/S3MultipartUploadCompleteRequest.java", "diffHunk": "@@ -229,17 +229,33 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           // This is a newly added key, it does not have any versions.\n           OmKeyLocationInfoGroup keyLocationInfoGroup = new\n               OmKeyLocationInfoGroup(0, partLocationInfos);\n+\n+          // Get the objectID of the key from OpenKeyTable\n+          OmKeyInfo dbOpenKeyInfo = omMetadataManager.getOpenKeyTable()\n+              .get(multipartKey);\n+\n           // A newly created key, this is the first version.\n-          omKeyInfo = new OmKeyInfo.Builder().setVolumeName(volumeName)\n+          OmKeyInfo.Builder builder =\n+              new OmKeyInfo.Builder().setVolumeName(volumeName)\n               .setBucketName(bucketName).setKeyName(keyName)\n               .setReplicationFactor(factor).setReplicationType(type)\n               .setCreationTime(keyArgs.getModificationTime())\n               .setModificationTime(keyArgs.getModificationTime())\n               .setDataSize(dataSize)\n               .setOmKeyLocationInfos(\n                   Collections.singletonList(keyLocationInfoGroup))\n-              .setAcls(OzoneAclUtil.fromProtobuf(keyArgs.getAclsList()))\n-              .build();\n+              .setAcls(OzoneAclUtil.fromProtobuf(keyArgs.getAclsList()));\n+          // Check if db entry has ObjectID. This check is required because\n+          // it is possible that between multipart key uploads and complete,\n+          // we had an upgrade.\n+          // TODO: If on upgrades we do not consider the non-completed multipart\n+          //  uploads, then this check can be removed.\n+          if (dbOpenKeyInfo.getObjectID() != 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMjE5MjU3", "url": "https://github.com/apache/ozone/pull/428#pullrequestreview-342219257", "createdAt": "2020-01-14T00:01:00Z", "commit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwMDowMTowMFrOFdIhBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwMDowMTowMFrOFdIhBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA5MjU1MA==", "bodyText": "This method is not called any where, as we use builder methods.", "url": "https://github.com/apache/ozone/pull/428#discussion_r366092550", "createdAt": "2020-01-14T00:01:00Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmMultipartKeyInfo.java", "diffHunk": "@@ -35,22 +35,67 @@\n   private final ReplicationType replicationType;\n   private final ReplicationFactor replicationFactor;\n   private TreeMap<Integer, PartKeyInfo> partKeyInfoList;\n+  private long objectID;\n+  private long updateID;\n \n   /**\n    * Construct OmMultipartKeyInfo object which holds multipart upload\n    * information for a key.\n    */\n   public OmMultipartKeyInfo(String id, long creationTime,\n-                            ReplicationType replicationType,\n-                            ReplicationFactor replicationFactor,\n-                            Map<Integer, PartKeyInfo> list) {\n+      ReplicationType replicationType, ReplicationFactor replicationFactor,\n+      Map<Integer, PartKeyInfo> list, long objectID, long updateID) {\n     this.uploadID = id;\n     this.creationTime = creationTime;\n     this.replicationType = replicationType;\n     this.replicationFactor = replicationFactor;\n     this.partKeyInfoList = new TreeMap<>(list);\n+    this.objectID = objectID;\n+    this.updateID = updateID;\n   }\n \n+  /**\n+   * Set the Object ID. If this value is already set then this function throws.\n+   * There is a reason why we cannot use the final here. The\n+   * OMMultipartKeyInfo is deserialized from the protobuf in many places in\n+   * code. We need to set this object ID, after it is deserialized.\n+   *\n+   * @param obId - long\n+   */\n+  public void setObjectID(long obId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMjE5NTM4", "url": "https://github.com/apache/ozone/pull/428#pullrequestreview-342219538", "createdAt": "2020-01-14T00:01:54Z", "commit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwMDowMTo1NVrOFdIh8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwMDowMTo1NVrOFdIh8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA5Mjc4NA==", "bodyText": "This method is not called anywhere, as we use builder methods.", "url": "https://github.com/apache/ozone/pull/428#discussion_r366092784", "createdAt": "2020-01-14T00:01:55Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyInfo.java", "diffHunk": "@@ -135,6 +141,47 @@ public void updateModifcationTime() {\n     this.modificationTime = Time.monotonicNow();\n   }\n \n+  /**\n+   * Set the Object ID. If this value is already set then this function throws.\n+   * There is a reason why we cannot use the final here. The OMKeyInfo is\n+   * deserialized from the protobuf in many places in code. We need to set\n+   * this object ID, after it is deserialized.\n+   *\n+   * @param obId - long\n+   */\n+  public void setObjectID(long obId) {\n+    if(this.objectID != 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMjIwNDE0", "url": "https://github.com/apache/ozone/pull/428#pullrequestreview-342220414", "createdAt": "2020-01-14T00:04:49Z", "commit": {"oid": "979d8a226b839f23dfcb5ea281d0c014781c6051"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abf4119878ed2a302c176759124669a10b2bab08", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/abf4119878ed2a302c176759124669a10b2bab08", "committedDate": "2020-01-14T20:00:54Z", "message": "Review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ff22114b9fea4e46d886e460330be0bde2f62c6", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/6ff22114b9fea4e46d886e460330be0bde2f62c6", "committedDate": "2020-01-14T20:03:22Z", "message": "checkstype fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNTQwMzI4", "url": "https://github.com/apache/ozone/pull/428#pullrequestreview-343540328", "createdAt": "2020-01-15T21:41:02Z", "commit": {"oid": "6ff22114b9fea4e46d886e460330be0bde2f62c6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5ODY1MTk4", "url": "https://github.com/apache/ozone/pull/428#pullrequestreview-349865198", "createdAt": "2020-01-29T05:15:39Z", "commit": {"oid": "6ff22114b9fea4e46d886e460330be0bde2f62c6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNToxNTo0MFrOFi8yPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNToxNTo0MFrOFi8yPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE5MTgwNQ==", "bodyText": "Can transactionLogIndex be used as a unique objectId over time ?", "url": "https://github.com/apache/ozone/pull/428#discussion_r372191805", "createdAt": "2020-01-29T05:15:40Z", "author": {"login": "prashantpogde"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMDirectoryCreateRequest.java", "diffHunk": "@@ -210,7 +210,7 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n \n   private OmKeyInfo createDirectoryKeyInfo(OzoneManager ozoneManager,\n       OmBucketInfo omBucketInfo, String volumeName, String bucketName,\n-      String keyName, KeyArgs keyArgs)\n+      String keyName, KeyArgs keyArgs, long transactionLogIndex)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ff22114b9fea4e46d886e460330be0bde2f62c6"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3906, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}