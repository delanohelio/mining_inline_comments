{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3MzEwODg3", "number": 1191, "title": "HDDS-3837 Add isLeader check in SCMHAManager.", "bodyText": "What changes were proposed in this pull request?\nAdd isLeader check in SCMHAManager.\n(Please fill in changes proposed in this fix)\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3837\n(Please create an issue in ASF JIRA before opening a pull request,\nand you need to set the title of the pull request which starts with\nthe corresponding JIRA issue number. (e.g. HDDS-XXXX. Fix a typo in YYY.)\nPlease replace this section with the link to the Apache JIRA)\nHow was this patch tested?\nUT\n(Please explain how this patch was tested. Ex: unit tests, manual tests)\n(If this patch involves UI changes, please attach a screen-shot; otherwise, remove this)", "createdAt": "2020-07-10T08:45:00Z", "url": "https://github.com/apache/ozone/pull/1191", "merged": true, "mergeCommit": {"oid": "2e3e0649a59d51a35cd4cf15a89dd41d845644cd"}, "closed": true, "closedAt": "2020-08-06T01:10:14Z", "author": {"login": "timmylicheng"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczf0b2gBqjM1MzMwMjYwNDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7d8iXgBqjM2MTgzNTg1MDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c56e9a9f49e261cf33a7013e7e04be3aced0d077", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/c56e9a9f49e261cf33a7013e7e04be3aced0d077", "committedDate": "2020-07-10T08:31:17Z", "message": "HDDS-3837 Add isLeader check in SCMHAManager."}, "afterCommit": {"oid": "27920f49ebfd173bfde03caa91329eb5ea4bf89f", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/27920f49ebfd173bfde03caa91329eb5ea4bf89f", "committedDate": "2020-07-10T09:00:20Z", "message": "HDDS-3837 Add isLeader check in SCMHAManager."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "27920f49ebfd173bfde03caa91329eb5ea4bf89f", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/27920f49ebfd173bfde03caa91329eb5ea4bf89f", "committedDate": "2020-07-10T09:00:20Z", "message": "HDDS-3837 Add isLeader check in SCMHAManager."}, "afterCommit": {"oid": "89b3d3a50098d280d7f1ad1863c9920d79d6660c", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/89b3d3a50098d280d7f1ad1863c9920d79d6660c", "committedDate": "2020-07-10T10:07:05Z", "message": "HDDS-3837 Add isLeader check in SCMHAManager."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "89b3d3a50098d280d7f1ad1863c9920d79d6660c", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/89b3d3a50098d280d7f1ad1863c9920d79d6660c", "committedDate": "2020-07-10T10:07:05Z", "message": "HDDS-3837 Add isLeader check in SCMHAManager."}, "afterCommit": {"oid": "9fa5755a66ef94d0d59539daf287fc04b5f1c7d8", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/9fa5755a66ef94d0d59539daf287fc04b5f1c7d8", "committedDate": "2020-07-11T13:08:45Z", "message": "HDDS-3837 Add isLeader check in SCMHAManager."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9fa5755a66ef94d0d59539daf287fc04b5f1c7d8", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/9fa5755a66ef94d0d59539daf287fc04b5f1c7d8", "committedDate": "2020-07-11T13:08:45Z", "message": "HDDS-3837 Add isLeader check in SCMHAManager."}, "afterCommit": {"oid": "76c1cb7f2c98ddd56269ecc3ed7ce206c7c74485", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/76c1cb7f2c98ddd56269ecc3ed7ce206c7c74485", "committedDate": "2020-07-11T13:10:03Z", "message": "HDDS-3837 Add isLeader check in SCMHAManager."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "76c1cb7f2c98ddd56269ecc3ed7ce206c7c74485", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/76c1cb7f2c98ddd56269ecc3ed7ce206c7c74485", "committedDate": "2020-07-11T13:10:03Z", "message": "HDDS-3837 Add isLeader check in SCMHAManager."}, "afterCommit": {"oid": "0ca2ff54d496ee9c74273a79a1d33e0dd998eecf", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/0ca2ff54d496ee9c74273a79a1d33e0dd998eecf", "committedDate": "2020-07-13T02:33:06Z", "message": "HDDS-3837 Add isLeader check in SCMHAManager."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3ODU5OTkw", "url": "https://github.com/apache/ozone/pull/1191#pullrequestreview-447859990", "createdAt": "2020-07-14T07:35:15Z", "commit": {"oid": "0ca2ff54d496ee9c74273a79a1d33e0dd998eecf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwNzozNToxNVrOGxH2EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwNzozNToxNVrOGxH2EA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE2MTkzNg==", "bodyText": "Would it be cleaner by using InvocationHander to inject these isLeader() check ?\nStateManager pipelineStateManager = (StateManager) Proxy.newProxyInstance(\n    null,\n    new Class<?>[] {StateManager.class}, \n    (proxy, method, args) -> {\n      if (method.getName().equals(\"xxx\")) {\n        // do is leader check;\n        // throw exception if needed;\n      }\n      return method.invoke(args);\n    });\n\nYou may use hashmap or annotation to speed up the method name check.\nJust a recommendation.", "url": "https://github.com/apache/ozone/pull/1191#discussion_r454161936", "createdAt": "2020-07-14T07:35:15Z", "author": {"login": "GlenGeng"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java", "diffHunk": "@@ -327,6 +349,9 @@ public void openPipeline(PipelineID pipelineId) throws IOException {\n    * @throws IOException\n    */\n   protected void removePipeline(Pipeline pipeline) throws IOException {\n+    if (!scmhaManager.isLeader()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ca2ff54d496ee9c74273a79a1d33e0dd998eecf"}, "originalPosition": 112}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTg3MjI3", "url": "https://github.com/apache/ozone/pull/1191#pullrequestreview-448587227", "createdAt": "2020-07-15T02:29:27Z", "commit": {"oid": "0ca2ff54d496ee9c74273a79a1d33e0dd998eecf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMjoyOToyOFrOGxr6hQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwMjoyOToyOFrOGxr6hQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc1MjkwMQ==", "bodyText": "Add a todo please\n// will change from RaftServerImpl:::isLeader() to RaftServerImpl::getRoleInfoProto()\n// after RATIS-1001 is merged.", "url": "https://github.com/apache/ozone/pull/1191#discussion_r454752901", "createdAt": "2020-07-15T02:29:28Z", "author": {"login": "GlenGeng"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java", "diffHunk": "@@ -56,7 +69,28 @@ public void start() throws IOException {\n    */\n   @Override\n   public boolean isLeader() {\n-    return isLeader;\n+    if (!SCMHAUtils.isSCMHAEnabled(conf)) {\n+      // When SCM HA is not enabled, the current SCM is always the leader.\n+      return true;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ca2ff54d496ee9c74273a79a1d33e0dd998eecf"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c97f3d305d5cfffc9ad148b344a8a1df9c4146b", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/9c97f3d305d5cfffc9ad148b344a8a1df9c4146b", "committedDate": "2020-07-15T07:58:47Z", "message": "HDDS-3837 Add isLeader check in SCMHAManager."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ca2ff54d496ee9c74273a79a1d33e0dd998eecf", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/0ca2ff54d496ee9c74273a79a1d33e0dd998eecf", "committedDate": "2020-07-13T02:33:06Z", "message": "HDDS-3837 Add isLeader check in SCMHAManager."}, "afterCommit": {"oid": "9c97f3d305d5cfffc9ad148b344a8a1df9c4146b", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/9c97f3d305d5cfffc9ad148b344a8a1df9c4146b", "committedDate": "2020-07-15T07:58:47Z", "message": "HDDS-3837 Add isLeader check in SCMHAManager."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MDU0OTgy", "url": "https://github.com/apache/ozone/pull/1191#pullrequestreview-456054982", "createdAt": "2020-07-27T19:02:44Z", "commit": {"oid": "9c97f3d305d5cfffc9ad148b344a8a1df9c4146b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxOTowMjo0NVrOG3vnaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxOTowMjo0NVrOG3vnaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEwNTAwMA==", "bodyText": "should we move this to the try block?", "url": "https://github.com/apache/ozone/pull/1191#discussion_r461105000", "createdAt": "2020-07-27T19:02:45Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java", "diffHunk": "@@ -56,7 +69,28 @@ public void start() throws IOException {\n    */\n   @Override\n   public boolean isLeader() {\n-    return isLeader;\n+    if (!SCMHAUtils.isSCMHAEnabled(conf)) {\n+      // When SCM HA is not enabled, the current SCM is always the leader.\n+      return true;\n+    }\n+    RaftServer server = ratisServer.getServer();\n+    Preconditions.checkState(server instanceof RaftServerProxy);\n+    RaftServerImpl serverImpl = null;\n+    try {\n+      // SCM only has one raft group.\n+      serverImpl = ((RaftServerProxy) server)\n+          .getImpl(ratisServer.getRaftGroupId());\n+    } catch (IOException ioe) {\n+      LOG.error(\"Fail to get RaftServer impl and therefore it's not clear \" +\n+          \"whether it's leader. \", ioe);\n+    } finally {\n+      if (serverImpl != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c97f3d305d5cfffc9ad148b344a8a1df9c4146b"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MDYzMzY1", "url": "https://github.com/apache/ozone/pull/1191#pullrequestreview-456063365", "createdAt": "2020-07-27T19:15:43Z", "commit": {"oid": "9c97f3d305d5cfffc9ad148b344a8a1df9c4146b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxOToxNTo0M1rOG3wCGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxOToxNTo0M1rOG3wCGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTExMTgzNQ==", "bodyText": "getId().getAddress() seems unnecessary.", "url": "https://github.com/apache/ozone/pull/1191#discussion_r461111835", "createdAt": "2020-07-27T19:15:43Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java", "diffHunk": "@@ -67,6 +101,44 @@ public SCMRatisServer getRatisServer() {\n     return ratisServer;\n   }\n \n+  private RaftPeerId getPeerIdFromRoleInfo(RaftServerImpl serverImpl) {\n+    if (serverImpl.isLeader()) {\n+      return RaftPeerId.getRaftPeerId(\n+          serverImpl.getRoleInfoProto().getLeaderInfo().toString());\n+    } else if (serverImpl.isFollower()) {\n+      return RaftPeerId.getRaftPeerId(\n+          serverImpl.getRoleInfoProto().getFollowerInfo()\n+              .getLeaderInfo().getId().getAddress());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c97f3d305d5cfffc9ad148b344a8a1df9c4146b"}, "originalPosition": 78}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3629ed3d71174d79fd2e6ef75491b101084fb139", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/3629ed3d71174d79fd2e6ef75491b101084fb139", "committedDate": "2020-07-28T12:50:38Z", "message": "Update comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODUzMzUx", "url": "https://github.com/apache/ozone/pull/1191#pullrequestreview-458853351", "createdAt": "2020-07-31T00:49:07Z", "commit": {"oid": "3629ed3d71174d79fd2e6ef75491b101084fb139"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMDo0OTowN1rOG54hhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMDo0OTowN1rOG54hhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0ODEwMQ==", "bodyText": "Same as above, can we move this to the try block?", "url": "https://github.com/apache/ozone/pull/1191#discussion_r463348101", "createdAt": "2020-07-31T00:49:07Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMHAManagerImpl.java", "diffHunk": "@@ -67,6 +101,44 @@ public SCMRatisServer getRatisServer() {\n     return ratisServer;\n   }\n \n+  private RaftPeerId getPeerIdFromRoleInfo(RaftServerImpl serverImpl) {\n+    if (serverImpl.isLeader()) {\n+      return RaftPeerId.getRaftPeerId(\n+          serverImpl.getRoleInfoProto().getLeaderInfo().toString());\n+    } else if (serverImpl.isFollower()) {\n+      return RaftPeerId.valueOf(\n+          serverImpl.getRoleInfoProto().getFollowerInfo()\n+              .getLeaderInfo().getId().getId());\n+    } else {\n+      return null;\n+    }\n+  }\n+\n+  @Override\n+  public RaftPeer getSuggestedLeader() {\n+    RaftServer server = ratisServer.getServer();\n+    Preconditions.checkState(server instanceof RaftServerProxy);\n+    RaftServerImpl serverImpl = null;\n+    try {\n+      // SCM only has one raft group.\n+      serverImpl = ((RaftServerProxy) server)\n+          .getImpl(ratisServer.getRaftGroupId());\n+    } catch (IOException ioe) {\n+      LOG.error(\"Fail to get RaftServer impl and therefore it's not clear \" +\n+          \"whether it's leader. \", ioe);\n+    } finally {\n+      if (serverImpl != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3629ed3d71174d79fd2e6ef75491b101084fb139"}, "originalPosition": 97}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODU0ODA5", "url": "https://github.com/apache/ozone/pull/1191#pullrequestreview-458854809", "createdAt": "2020-07-31T00:53:37Z", "commit": {"oid": "3629ed3d71174d79fd2e6ef75491b101084fb139"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMDo1MzozN1rOG54nSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMDo1MzozN1rOG54nSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0OTU3OQ==", "bodyText": "why ScmRatiSserver only have one entry in the raft peers, is this something we plan to implement in future?", "url": "https://github.com/apache/ozone/pull/1191#discussion_r463349579", "createdAt": "2020-07-31T00:53:37Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMRatisServerImpl.java", "diffHunk": "@@ -110,4 +111,18 @@ public void stop() throws IOException {\n     server.close();\n   }\n \n+  @Override\n+  public RaftServer getServer() {\n+    return server;\n+  }\n+\n+  @Override\n+  public RaftGroupId getRaftGroupId() {\n+    return raftGroupId;\n+  }\n+\n+  @Override\n+  public List<RaftPeer> getRaftPeers() {\n+    return Collections.singletonList(new RaftPeer(raftPeerId));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3629ed3d71174d79fd2e6ef75491b101084fb139"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODU1MjQ3", "url": "https://github.com/apache/ozone/pull/1191#pullrequestreview-458855247", "createdAt": "2020-07-31T00:55:08Z", "commit": {"oid": "3629ed3d71174d79fd2e6ef75491b101084fb139"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMDo1NTowOFrOG54ozw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMDo1NTowOFrOG54ozw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM0OTk2Nw==", "bodyText": "Can we put this as debug log to avoid spamming the SCM log?", "url": "https://github.com/apache/ozone/pull/1191#discussion_r463349967", "createdAt": "2020-07-31T00:55:08Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/NewNodeHandler.java", "diffHunk": "@@ -41,6 +46,11 @@ public NewNodeHandler(PipelineManager pipelineManager,\n   @Override\n   public void onMessage(DatanodeDetails datanodeDetails,\n       EventPublisher publisher) {\n-    pipelineManager.triggerPipelineCreation();\n+    try {\n+      pipelineManager.triggerPipelineCreation();\n+    } catch (NotLeaderException ex) {\n+      LOG.warn(\"Not the current leader SCM and cannot start pipeline\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3629ed3d71174d79fd2e6ef75491b101084fb139"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODU1MzI1", "url": "https://github.com/apache/ozone/pull/1191#pullrequestreview-458855325", "createdAt": "2020-07-31T00:55:24Z", "commit": {"oid": "3629ed3d71174d79fd2e6ef75491b101084fb139"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMDo1NToyNFrOG54pGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMDo1NToyNFrOG54pGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM1MDA0Mw==", "bodyText": "Same as above.", "url": "https://github.com/apache/ozone/pull/1191#discussion_r463350043", "createdAt": "2020-07-31T00:55:24Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/NonHealthyToHealthyNodeHandler.java", "diffHunk": "@@ -42,6 +47,11 @@ public NonHealthyToHealthyNodeHandler(\n   @Override\n   public void onMessage(DatanodeDetails datanodeDetails,\n       EventPublisher publisher) {\n-    pipelineManager.triggerPipelineCreation();\n+    try {\n+      pipelineManager.triggerPipelineCreation();\n+    } catch (NotLeaderException ex) {\n+      LOG.warn(\"Not the current leader SCM and cannot start pipeline\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3629ed3d71174d79fd2e6ef75491b101084fb139"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODU1OTY3", "url": "https://github.com/apache/ozone/pull/1191#pullrequestreview-458855967", "createdAt": "2020-07-31T00:57:45Z", "commit": {"oid": "3629ed3d71174d79fd2e6ef75491b101084fb139"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMDo1Nzo0NVrOG54rRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMDo1Nzo0NVrOG54rRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM1MDU5OA==", "bodyText": "NIT: Can we add a helper function like checkLeader() to dedup the code?", "url": "https://github.com/apache/ozone/pull/1191#discussion_r463350598", "createdAt": "2020-07-31T00:57:45Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java", "diffHunk": "@@ -136,6 +139,9 @@ public static PipelineManagerV2Impl newPipelineManager(\n   @Override\n   public Pipeline createPipeline(ReplicationType type,\n                                  ReplicationFactor factor) throws IOException {\n+    if (!scmhaManager.isLeader()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3629ed3d71174d79fd2e6ef75491b101084fb139"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODU2NTc2", "url": "https://github.com/apache/ozone/pull/1191#pullrequestreview-458856576", "createdAt": "2020-07-31T00:59:52Z", "commit": {"oid": "3629ed3d71174d79fd2e6ef75491b101084fb139"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMDo1OTo1MlrOG54tfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMDo1OTo1MlrOG54tfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzM1MTE2NA==", "bodyText": "when scm leader changes, how to ensure the creator and scrubber threads are started on the new leader and stopped on the old leader?", "url": "https://github.com/apache/ozone/pull/1191#discussion_r463351164", "createdAt": "2020-07-31T00:59:52Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java", "diffHunk": "@@ -431,15 +464,21 @@ public void scrubPipeline(ReplicationType type, ReplicationFactor factor)\n    * Schedules a fixed interval job to create pipelines.\n    */\n   @Override\n-  public void startPipelineCreator() {\n+  public void startPipelineCreator() throws NotLeaderException {\n+    if (!scmhaManager.isLeader()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3629ed3d71174d79fd2e6ef75491b101084fb139"}, "originalPosition": 146}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODU4MjQ2", "url": "https://github.com/apache/ozone/pull/1191#pullrequestreview-458858246", "createdAt": "2020-07-31T01:05:37Z", "commit": {"oid": "3629ed3d71174d79fd2e6ef75491b101084fb139"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "469ce398eb97239238cda0ad6192a7d90fb1cd3a", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/469ce398eb97239238cda0ad6192a7d90fb1cd3a", "committedDate": "2020-08-03T13:34:35Z", "message": "Improve handling NotLeaderException."}, "afterCommit": {"oid": "13908ed70b6413eddc4b4675362357fd54b4cec0", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/13908ed70b6413eddc4b4675362357fd54b4cec0", "committedDate": "2020-08-03T13:40:37Z", "message": "Improve handling NotLeaderException."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "570d9d78390d258330eb910e7e34a368a3ab03fe", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/570d9d78390d258330eb910e7e34a368a3ab03fe", "committedDate": "2020-08-04T03:20:46Z", "message": "Improve handling NotLeaderException."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "13908ed70b6413eddc4b4675362357fd54b4cec0", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/13908ed70b6413eddc4b4675362357fd54b4cec0", "committedDate": "2020-08-03T13:40:37Z", "message": "Improve handling NotLeaderException."}, "afterCommit": {"oid": "570d9d78390d258330eb910e7e34a368a3ab03fe", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/570d9d78390d258330eb910e7e34a368a3ab03fe", "committedDate": "2020-08-04T03:20:46Z", "message": "Improve handling NotLeaderException."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2838, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}