{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2NTgwNzU0", "number": 1258, "title": "HDDS-4029. Recon unable to add a new container which is in CLOSED state.", "bodyText": "What changes were proposed in this pull request?\nWhenever there is a state change (OPEN -> CLOSING/CLOSED) while Recon is down, when it starts up again, it is not able to process reports for that container.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4029\nHow was this patch tested?\nManually tested.\nAdded unit tests.", "createdAt": "2020-07-25T07:24:46Z", "url": "https://github.com/apache/ozone/pull/1258", "merged": true, "mergeCommit": {"oid": "c07ccd7c23dd63745124f8b509fe4d90c4d5c966"}, "closed": true, "closedAt": "2020-08-03T16:20:28Z", "author": {"login": "avijayanhwx"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc4Ta3fgH2gAyNDU2NTgwNzU0OmM5ZmIwOWNhYzBiMTkyMGRmNWNiN2VlMTAyOTkxMjk4ZjFhZGQwMGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7C3bbAH2gAyNDU2NTgwNzU0OmViYjM2MDdjMTRlMmM4ZTNjNmIzN2E3MTkyY2Y0YjM0MDk1MTJkYWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c9fb09cac0b1920df5cb7ee102991298f1add00a", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/c9fb09cac0b1920df5cb7ee102991298f1add00a", "committedDate": "2020-07-25T07:23:23Z", "message": "HDDS-4029. Recon unable to add a new container which is in CLOSED state."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3b419418ef46434ac6a81b416392a48edb3612e", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/b3b419418ef46434ac6a81b416392a48edb3612e", "committedDate": "2020-07-25T22:02:40Z", "message": "Fix unit test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fc3fdab7b3f4830c4484eecdff9eaa19bedad07", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/0fc3fdab7b3f4830c4484eecdff9eaa19bedad07", "committedDate": "2020-07-27T17:07:12Z", "message": "Add more comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37559b32f467a6a646339fb5fcaade079449a78c", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/37559b32f467a6a646339fb5fcaade079449a78c", "committedDate": "2020-07-27T17:41:34Z", "message": "Add more unit test cases."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2OTEwMzg1", "url": "https://github.com/apache/ozone/pull/1258#pullrequestreview-456910385", "createdAt": "2020-07-28T18:44:58Z", "commit": {"oid": "37559b32f467a6a646339fb5fcaade079449a78c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0NDo1OFrOG4ZwgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0NDo1OFrOG4ZwgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NTQ1Nw==", "bodyText": "I'm trying to understand why this is not an issue in SCM?\nDoes Recon have similar idea like SCM safemode to ensure Pipeline meet the minimal requirement?", "url": "https://github.com/apache/ozone/pull/1258#discussion_r461795457", "createdAt": "2020-07-28T18:44:58Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerStateManager.java", "diffHunk": "@@ -325,8 +325,12 @@ public void addContainerInfo(long containerID,\n                                Pipeline pipeline) throws IOException {\n     Preconditions.checkNotNull(containerInfo);\n     containers.addContainer(containerInfo);\n-    pipelineManager.addContainerToPipeline(pipeline.getId(),\n-        ContainerID.valueof(containerID));\n+    if (pipeline != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37559b32f467a6a646339fb5fcaade079449a78c"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2OTExNTYw", "url": "https://github.com/apache/ozone/pull/1258#pullrequestreview-456911560", "createdAt": "2020-07-28T18:46:42Z", "commit": {"oid": "37559b32f467a6a646339fb5fcaade079449a78c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0Njo0M1rOG4Z0Jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0Njo0M1rOG4Z0Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NjM5MA==", "bodyText": "NIT: \"part of \" => \"pipeline\"", "url": "https://github.com/apache/ozone/pull/1258#discussion_r461796390", "createdAt": "2020-07-28T18:46:43Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/scm/ReconContainerManager.java", "diffHunk": "@@ -77,22 +82,42 @@ public ReconContainerManager(\n    * @throws IOException on Error.\n    */\n   public void checkAndAddNewContainer(ContainerID containerID,\n+      ContainerReplicaProto.State replicaState,\n       DatanodeDetails datanodeDetails)\n       throws IOException {\n     if (!exists(containerID)) {\n       LOG.info(\"New container {} got from {}.\", containerID,\n           datanodeDetails.getHostName());\n       ContainerWithPipeline containerWithPipeline =\n           scmClient.getContainerWithPipeline(containerID.getId());\n-      LOG.debug(\"Verified new container from SCM {} \",\n-          containerWithPipeline.getContainerInfo().containerID());\n+      LOG.info(\"Verified new container from SCM {}, part of {} \",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37559b32f467a6a646339fb5fcaade079449a78c"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2OTEyNzAx", "url": "https://github.com/apache/ozone/pull/1258#pullrequestreview-456912701", "createdAt": "2020-07-28T18:48:23Z", "commit": {"oid": "37559b32f467a6a646339fb5fcaade079449a78c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0ODoyM1rOG4Z3nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0ODoyM1rOG4Z3nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NzI3OQ==", "bodyText": "should we more preciously check for ContainerReplicaProto.State.CLOSE state?", "url": "https://github.com/apache/ozone/pull/1258#discussion_r461797279", "createdAt": "2020-07-28T18:48:23Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/scm/ReconContainerManager.java", "diffHunk": "@@ -77,22 +82,42 @@ public ReconContainerManager(\n    * @throws IOException on Error.\n    */\n   public void checkAndAddNewContainer(ContainerID containerID,\n+      ContainerReplicaProto.State replicaState,\n       DatanodeDetails datanodeDetails)\n       throws IOException {\n     if (!exists(containerID)) {\n       LOG.info(\"New container {} got from {}.\", containerID,\n           datanodeDetails.getHostName());\n       ContainerWithPipeline containerWithPipeline =\n           scmClient.getContainerWithPipeline(containerID.getId());\n-      LOG.debug(\"Verified new container from SCM {} \",\n-          containerWithPipeline.getContainerInfo().containerID());\n+      LOG.info(\"Verified new container from SCM {}, part of {} \",\n+          containerID, containerWithPipeline.getPipeline().getId());\n       // If no other client added this, go ahead and add this container.\n       if (!exists(containerID)) {\n         addNewContainer(containerID.getId(), containerWithPipeline);\n       }\n+    } else {\n+      // Check if container state is not open. In SCM, container state\n+      // changes to CLOSING first, and then the close command is pushed down\n+      // to Datanodes. Recon 'learns' this from DN, and hence replica state\n+      // will move container state to 'CLOSING'.\n+      ContainerInfo containerInfo = getContainer(containerID);\n+      if (containerInfo.getState().equals(HddsProtos.LifeCycleState.OPEN)\n+          && !replicaState.equals(ContainerReplicaProto.State.OPEN)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37559b32f467a6a646339fb5fcaade079449a78c"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MDAxMTI4", "url": "https://github.com/apache/ozone/pull/1258#pullrequestreview-457001128", "createdAt": "2020-07-28T20:49:33Z", "commit": {"oid": "37559b32f467a6a646339fb5fcaade079449a78c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMDo0OTozM1rOG4eTcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMDo0OTozM1rOG4eTcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg2OTkzOA==", "bodyText": "This can be simplified as\nLOG.warn(\"Pipeline {} not found. Cannot add container {}\",\npipelineID, containerInfo.containerID());", "url": "https://github.com/apache/ozone/pull/1258#discussion_r461869938", "createdAt": "2020-07-28T20:49:33Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/scm/ReconContainerManager.java", "diffHunk": "@@ -105,18 +130,32 @@ public void addNewContainer(long containerId,\n     ContainerInfo containerInfo = containerWithPipeline.getContainerInfo();\n     getLock().lock();\n     try {\n-      if (getPipelineManager().containsPipeline(\n-          containerWithPipeline.getPipeline().getId())) {\n-        getContainerStateManager().addContainerInfo(containerId, containerInfo,\n-            getPipelineManager(), containerWithPipeline.getPipeline());\n+      boolean success = false;\n+      if (containerInfo.getState().equals(HddsProtos.LifeCycleState.OPEN)) {\n+        PipelineID pipelineID = containerWithPipeline.getPipeline().getId();\n+        if (getPipelineManager().containsPipeline(pipelineID)) {\n+          getContainerStateManager().addContainerInfo(containerId,\n+              containerInfo, getPipelineManager(),\n+              containerWithPipeline.getPipeline());\n+          success = true;\n+        } else {\n+          // Get open container for a pipeline that Recon does not know\n+          // about yet. Cannot update internal state until pipeline is synced.\n+          LOG.warn(String.format(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37559b32f467a6a646339fb5fcaade079449a78c"}, "originalPosition": 86}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MDg1Nzg3", "url": "https://github.com/apache/ozone/pull/1258#pullrequestreview-457085787", "createdAt": "2020-07-28T22:59:08Z", "commit": {"oid": "37559b32f467a6a646339fb5fcaade079449a78c"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODM4MjQx", "url": "https://github.com/apache/ozone/pull/1258#pullrequestreview-458838241", "createdAt": "2020-07-30T23:57:12Z", "commit": {"oid": "37559b32f467a6a646339fb5fcaade079449a78c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMzo1NzoxM1rOG53rbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMzo1NzoxM1rOG53rbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMzNDI1NQ==", "bodyText": "Can we reuse the getTestContainer below to reduce duplicated code?", "url": "https://github.com/apache/ozone/pull/1258#discussion_r463334255", "createdAt": "2020-07-30T23:57:13Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/recon/src/test/java/org/apache/hadoop/ozone/recon/scm/AbstractReconContainerManagerTest.java", "diffHunk": "@@ -129,4 +132,46 @@ private StorageContainerServiceProvider getScmServiceProvider()\n         .thenReturn(containerWithPipeline);\n     return scmServiceProviderMock;\n   }\n+\n+  protected Table<ContainerID, ContainerInfo> getContainerTable()\n+      throws IOException {\n+    return CONTAINERS.getTable(store);\n+  }\n+\n+  protected ContainerWithPipeline getTestContainer(LifeCycleState state)\n+      throws IOException {\n+    ContainerID containerID = new ContainerID(100L);\n+    Pipeline pipeline = getRandomPipeline();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37559b32f467a6a646339fb5fcaade079449a78c"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODM5NzY4", "url": "https://github.com/apache/ozone/pull/1258#pullrequestreview-458839768", "createdAt": "2020-07-31T00:02:06Z", "commit": {"oid": "37559b32f467a6a646339fb5fcaade079449a78c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMDowMjowN1rOG53w2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwMDowMjowN1rOG53w2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMzNTY0MA==", "bodyText": "Can we add an additional case from CLOSING to QUASI_CLOSED upon receiving State.QUASI_CLOSED?", "url": "https://github.com/apache/ozone/pull/1258#discussion_r463335640", "createdAt": "2020-07-31T00:02:07Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/recon/src/test/java/org/apache/hadoop/ozone/recon/scm/TestReconContainerManager.java", "diffHunk": "@@ -86,12 +104,39 @@ public void testCheckAndAddNewContainer() throws IOException {\n     ReconContainerManager containerManager = getContainerManager();\n     assertFalse(containerManager.exists(containerID));\n     DatanodeDetails datanodeDetails = randomDatanodeDetails();\n-    containerManager.checkAndAddNewContainer(containerID, datanodeDetails);\n+    containerManager.checkAndAddNewContainer(containerID,\n+        OPEN, datanodeDetails);\n     assertTrue(containerManager.exists(containerID));\n \n     // Doing it one more time should not change any state.\n-    containerManager.checkAndAddNewContainer(containerID, datanodeDetails);\n+    containerManager.checkAndAddNewContainer(containerID, OPEN,\n+        datanodeDetails);\n     assertTrue(containerManager.exists(containerID));\n+    assertEquals(LifeCycleState.OPEN,\n+        getContainerManager().getContainer(containerID).getState());\n   }\n \n+  @Test\n+  public void testUpdateContainerStateFromOpen() throws IOException {\n+    ContainerWithPipeline containerWithPipeline =\n+        getTestContainer(LifeCycleState.OPEN);\n+\n+    long id = containerWithPipeline.getContainerInfo().getContainerID();\n+    ContainerID containerID =\n+        containerWithPipeline.getContainerInfo().containerID();\n+\n+    // Adding container #100.\n+    getContainerManager().addNewContainer(id, containerWithPipeline);\n+    assertEquals(LifeCycleState.OPEN,\n+        getContainerManager().getContainer(containerID).getState());\n+\n+    DatanodeDetails datanodeDetails = randomDatanodeDetails();\n+\n+    // First report with \"CLOSED\" replica state moves container state to\n+    // \"CLOSING\".\n+    getContainerManager().checkAndAddNewContainer(containerID, State.CLOSED,\n+        datanodeDetails);\n+    assertEquals(CLOSING,\n+        getContainerManager().getContainer(containerID).getState());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37559b32f467a6a646339fb5fcaade079449a78c"}, "originalPosition": 142}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4ODQwMDYz", "url": "https://github.com/apache/ozone/pull/1258#pullrequestreview-458840063", "createdAt": "2020-07-31T00:02:59Z", "commit": {"oid": "37559b32f467a6a646339fb5fcaade079449a78c"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "775181a129adaa3a1ba5c9901e50ba1e681c8b54", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/775181a129adaa3a1ba5c9901e50ba1e681c8b54", "committedDate": "2020-07-31T03:26:18Z", "message": "Merge remote-tracking branch 'upstream/master' into HDDS-4029-master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "394f746ba00cda3e4adeb2490c6459bd3ff2095b", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/394f746ba00cda3e4adeb2490c6459bd3ff2095b", "committedDate": "2020-07-31T03:27:09Z", "message": "Addressed review comment."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8563fb5db7d2edd30c0c2789200e6765511f5373", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/8563fb5db7d2edd30c0c2789200e6765511f5373", "committedDate": "2020-07-31T13:57:49Z", "message": "trigger new CI check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fe0f64cfa2c8b85d7b3cebf1df2694aa853dd76", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/2fe0f64cfa2c8b85d7b3cebf1df2694aa853dd76", "committedDate": "2020-07-31T20:23:28Z", "message": "Merge remote-tracking branch 'upstream/master' into HDDS-4029-master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebb3607c14e2c8e3c6b37a7192cf4b3409512dae", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/ebb3607c14e2c8e3c6b37a7192cf4b3409512dae", "committedDate": "2020-08-02T19:47:58Z", "message": "Merge remote-tracking branch 'upstream/master' into HDDS-4029-master"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2929, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}