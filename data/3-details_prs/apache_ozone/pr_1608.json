{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1MDE2ODg3", "number": 1608, "title": "HDDS-4481. With HA OM can send deletion blocks to SCM multiple times.", "bodyText": "What changes were proposed in this pull request?\nOM sends multiple times the same batch of block deletes to SCM, as keys will not be deleted from delete table, even though they are submitted for the purge.\nReason for this issue:\n\nWhen KeyDelete Service submits a request KeyPurge from KeyDelete Service, as this is submitted internally from OMServer the callID and ClientID will be passed the same, the subsequent requests are considered as retry, and it will not be processed until ratis clears its retry cache.\n\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4481\nHow was this patch tested?\nAdded a test and also tested the fix on the cluster, now KeyDeletion service is working as expected.", "createdAt": "2020-11-21T00:02:53Z", "url": "https://github.com/apache/ozone/pull/1608", "merged": true, "mergeCommit": {"oid": "d83ec1af165677d7c063ff574d32ae2abdd4ff5d"}, "closed": true, "closedAt": "2020-11-25T15:41:50Z", "author": {"login": "bharatviswa504"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfpaWzgFqTUzNzQ2ODQwMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdf5HKbAFqTUzODIxMjY3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NDY4NDAz", "url": "https://github.com/apache/ozone/pull/1608#pullrequestreview-537468403", "createdAt": "2020-11-24T13:02:31Z", "commit": {"oid": "cfa857aab6d1f6822cf809a7226e7e86b049a021"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMzowMjozMlrOH4_0WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMzowMjozMlrOH4_0WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTUyNzg5Ng==", "bodyText": "createWriteRaftClientRequest was creating a request with the same callId. Is that the bug here?\nIf that is the case we would also need to make changes in this function so that callId is different for every request.", "url": "https://github.com/apache/ozone/pull/1608#discussion_r529527896", "createdAt": "2020-11-24T13:02:32Z", "author": {"login": "lokeshj1703"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerRatisServer.java", "diffHunk": "@@ -126,15 +126,32 @@ private static long nextCallId() {\n   public OMResponse submitRequest(OMRequest omRequest) throws ServiceException {\n     RaftClientRequest raftClientRequest =\n         createWriteRaftClientRequest(omRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa857aab6d1f6822cf809a7226e7e86b049a021"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0bd744115d244a75bda510427b50c1ba09cb63f", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/f0bd744115d244a75bda510427b50c1ba09cb63f", "committedDate": "2020-11-24T17:31:14Z", "message": "HDDS-4481. With HA OM can send deletion blocks to SCM multiple times."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b7757290ff4c672088a29e3095aef3a787a14bc", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/5b7757290ff4c672088a29e3095aef3a787a14bc", "committedDate": "2020-11-24T17:31:15Z", "message": "change unnecessarily moved code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e031b6221bbcc860dd2de67df5445ffb615ee895", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/e031b6221bbcc860dd2de67df5445ffb615ee895", "committedDate": "2020-11-24T17:31:16Z", "message": "change back to debug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a4207731b41820ab6b85e93fa7f66fcd9d0682f", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/5a4207731b41820ab6b85e93fa7f66fcd9d0682f", "committedDate": "2020-11-24T17:31:16Z", "message": "fix cs and make clientID static, so that until OM is stopped it will have same value"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acde8eab1e0462ddcbee7df76d4a9cc4841d2a65", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/acde8eab1e0462ddcbee7df76d4a9cc4841d2a65", "committedDate": "2020-11-24T17:31:16Z", "message": "fix rat"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cfa857aab6d1f6822cf809a7226e7e86b049a021", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/cfa857aab6d1f6822cf809a7226e7e86b049a021", "committedDate": "2020-11-21T00:11:22Z", "message": "fix rat"}, "afterCommit": {"oid": "acde8eab1e0462ddcbee7df76d4a9cc4841d2a65", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/acde8eab1e0462ddcbee7df76d4a9cc4841d2a65", "committedDate": "2020-11-24T17:31:16Z", "message": "fix rat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ac48bf0811910eb7c0e7317e7292dbec53b6bb0", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/3ac48bf0811910eb7c0e7317e7292dbec53b6bb0", "committedDate": "2020-11-25T06:11:18Z", "message": "review comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MjEyNjc0", "url": "https://github.com/apache/ozone/pull/1608#pullrequestreview-538212674", "createdAt": "2020-11-25T07:21:18Z", "commit": {"oid": "3ac48bf0811910eb7c0e7317e7292dbec53b6bb0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1935, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}