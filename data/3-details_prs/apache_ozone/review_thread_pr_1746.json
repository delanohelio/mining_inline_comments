{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2ODMyMDU5", "number": 1746, "reviewThreads": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQwNTo0NToxOFrOFKOkOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQwMzowODoxM1rOFO8CFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ2MjY4NzI4OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQwNTo0NToxOFrOIM555w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMVQwODowMjoyNlrOIM7KMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQwMjUzNQ==", "bodyText": "Question: how to set QUOTA.RESET? (basically how to disable quota by set the quota). In the past I guess we can set -2 but now it seems disallowed.\nFor example, is there a case that a bucket is enabled quota, later users decide to disable the quota by setting a quota value?", "url": "https://github.com/apache/ozone/pull/1746#discussion_r550402535", "createdAt": "2020-12-31T05:45:18Z", "author": {"login": "amaliujia"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -190,14 +201,44 @@ public static OzoneQuota parseQuota(String quotaInBytes,\n           \" value cannot be greater than Long.MAX_VALUE BYTES\");\n     }\n \n-    if (nSize < 0) {\n-      throw new IllegalArgumentException(\"Quota cannot be negative.\");\n+    if (nSize <= 0) {\n+      throw new IllegalArgumentException(\"Invalid values for quota: \" + nSize);\n     }\n \n-    return new OzoneQuota(quotaInNamespace,\n-        new RawQuotaInBytes(currUnit, nSize));\n+    return new OzoneQuota(new RawQuotaInBytes(currUnit, nSize));\n   }\n \n+  /**\n+   * Parses a user provided string Namespace quota and returns the\n+   * Quota Object.\n+   *\n+   * @param quotaInNamespace Volume quota in counts\n+   *\n+   * @return OzoneQuota object\n+   */\n+  public static OzoneQuota parseNameSpaceQuota(String quotaInNamespace) {\n+    long nameSpaceQuota = Long.parseLong(quotaInNamespace);\n+    if (nameSpaceQuota <= 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdaed0c5504ed04174ec5d6494eb180327e8f9b9"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQyMzA5MA==", "bodyText": "If the user not specifies quota when creating bucket and volume,the default is -1, indicating that quota is not enabled.\nA quota value of -2 is a special case, because older clusters such as previous versions of Ozone1.0, volume Info and bucket Info do not have quotaInBytes and quotaInNamespace in them. After such a cluster is upgraded to Ozone1.1, these fields become to 0 when getting volume Info and bucket Info because they didn't exist before, so in HDDS-4562 proto is set to -2 by default, indicating that these volumes and buckets are old, and their quota is also not enabled. Currently, it is not recommended to enable quota for these volumes and buckets because their usedbyte and usedNamespace are incorrect. So, -2 is more used to distinguish between old volumes and buckets. Later if we can support recalculation of usedbyte and usedNamespace. This lets us know which volumes and buckets need to be recalculated.\nTo disable quota, use the clrquota method instead of setquota.", "url": "https://github.com/apache/ozone/pull/1746#discussion_r550423090", "createdAt": "2020-12-31T08:02:26Z", "author": {"login": "captainzmc"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -190,14 +201,44 @@ public static OzoneQuota parseQuota(String quotaInBytes,\n           \" value cannot be greater than Long.MAX_VALUE BYTES\");\n     }\n \n-    if (nSize < 0) {\n-      throw new IllegalArgumentException(\"Quota cannot be negative.\");\n+    if (nSize <= 0) {\n+      throw new IllegalArgumentException(\"Invalid values for quota: \" + nSize);\n     }\n \n-    return new OzoneQuota(quotaInNamespace,\n-        new RawQuotaInBytes(currUnit, nSize));\n+    return new OzoneQuota(new RawQuotaInBytes(currUnit, nSize));\n   }\n \n+  /**\n+   * Parses a user provided string Namespace quota and returns the\n+   * Quota Object.\n+   *\n+   * @param quotaInNamespace Volume quota in counts\n+   *\n+   * @return OzoneQuota object\n+   */\n+  public static OzoneQuota parseNameSpaceQuota(String quotaInNamespace) {\n+    long nameSpaceQuota = Long.parseLong(quotaInNamespace);\n+    if (nameSpaceQuota <= 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDQwMjUzNQ=="}, "originalCommit": {"oid": "bdaed0c5504ed04174ec5d6494eb180327e8f9b9"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ5NDc1NjM0OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxNTozNjoxMVrOIRalvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNToxNzowMlrOITpV3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTEzMjM1MA==", "bodyText": "@captainzmc \uff0c can we rollback long to string convert for namspace quota now? As default quota 0 will all be converted to Quota.RESET based on above approach that we discussed. Or we can create a new PR for this.", "url": "https://github.com/apache/ozone/pull/1746#discussion_r555132350", "createdAt": "2021-01-11T15:36:11Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -190,14 +201,44 @@ public static OzoneQuota parseQuota(String quotaInBytes,\n           \" value cannot be greater than Long.MAX_VALUE BYTES\");\n     }\n \n-    if (nSize < 0) {\n-      throw new IllegalArgumentException(\"Quota cannot be negative.\");\n+    if (nSize <= 0) {\n+      throw new IllegalArgumentException(\"Invalid values for quota: \" + nSize);\n     }\n \n-    return new OzoneQuota(quotaInNamespace,\n-        new RawQuotaInBytes(currUnit, nSize));\n+    return new OzoneQuota(new RawQuotaInBytes(currUnit, nSize));\n   }\n \n+  /**\n+   * Parses a user provided string Namespace quota and returns the\n+   * Quota Object.\n+   *\n+   * @param quotaInNamespace Volume quota in counts\n+   *\n+   * @return OzoneQuota object\n+   */\n+  public static OzoneQuota parseNameSpaceQuota(String quotaInNamespace) {\n+    long nameSpaceQuota = Long.parseLong(quotaInNamespace);\n+    if (nameSpaceQuota <= 0) {\n+      throw new IllegalArgumentException(\n+          \"Invalid values for quota: \" + nameSpaceQuota);\n+    }\n+    return new OzoneQuota(nameSpaceQuota, new RawQuotaInBytes(Units.BYTES, -1));\n+  }\n+\n+  /**\n+   * Parses a user provided string and returns the\n+   * Quota Object.\n+   *\n+   * @param quotaInBytes Volume quota in bytes\n+   * @param quotaInNamespace Volume quota in counts\n+   *\n+   * @return OzoneQuota object\n+   */\n+  public static OzoneQuota parseQuota(String quotaInBytes,\n+      String quotaInNamespace) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5c28c8d87cc63c87865e3ec880be81a89d68b08"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTUwODA0Ng==", "bodyText": "The above advice only solves our problem of creating volume or bucket, not setquota.\nThe string quotainNamespace in parseQuota is still useful for verifying whether the user passed quotainNamespace.Let's look at this case:\nIf the original volume space and namespace quoat were 100 and 10T, respectively, we reset the space quota separately:\nozone sh volume setquota vol1 --space-quota 20TB\nOzoneConsts.QUOTA_RESET is the default quota for VolumeArgs. The space and namespace quota for vol1 will change to -1 and 20T, which is not expected.\nI think it makes more sense to handle these cases in Ozonequota #parseQuota. Also, spaceQuota is currently a String in parseQuota, which makes our client-side processing logic more consistent,  making the code easier to maintain.", "url": "https://github.com/apache/ozone/pull/1746#discussion_r555508046", "createdAt": "2021-01-12T04:33:52Z", "author": {"login": "captainzmc"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -190,14 +201,44 @@ public static OzoneQuota parseQuota(String quotaInBytes,\n           \" value cannot be greater than Long.MAX_VALUE BYTES\");\n     }\n \n-    if (nSize < 0) {\n-      throw new IllegalArgumentException(\"Quota cannot be negative.\");\n+    if (nSize <= 0) {\n+      throw new IllegalArgumentException(\"Invalid values for quota: \" + nSize);\n     }\n \n-    return new OzoneQuota(quotaInNamespace,\n-        new RawQuotaInBytes(currUnit, nSize));\n+    return new OzoneQuota(new RawQuotaInBytes(currUnit, nSize));\n   }\n \n+  /**\n+   * Parses a user provided string Namespace quota and returns the\n+   * Quota Object.\n+   *\n+   * @param quotaInNamespace Volume quota in counts\n+   *\n+   * @return OzoneQuota object\n+   */\n+  public static OzoneQuota parseNameSpaceQuota(String quotaInNamespace) {\n+    long nameSpaceQuota = Long.parseLong(quotaInNamespace);\n+    if (nameSpaceQuota <= 0) {\n+      throw new IllegalArgumentException(\n+          \"Invalid values for quota: \" + nameSpaceQuota);\n+    }\n+    return new OzoneQuota(nameSpaceQuota, new RawQuotaInBytes(Units.BYTES, -1));\n+  }\n+\n+  /**\n+   * Parses a user provided string and returns the\n+   * Quota Object.\n+   *\n+   * @param quotaInBytes Volume quota in bytes\n+   * @param quotaInNamespace Volume quota in counts\n+   *\n+   * @return OzoneQuota object\n+   */\n+  public static OzoneQuota parseQuota(String quotaInBytes,\n+      String quotaInNamespace) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTEzMjM1MA=="}, "originalCommit": {"oid": "e5c28c8d87cc63c87865e3ec880be81a89d68b08"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTYxNjc5OQ==", "bodyText": "Hi @linyiqun , thanks for review the code.  We found bugs in production cluster with the previous implementation which doesn't distinguish the cases that user doesn't set the quota and user set the quota to 0.  So it's better to make it clear to avoid bugs caused by concept vague.\nIn summary, for quota in bucket and volume,\n\nquota value will be -2  to indicates it's 1.0.0 bucket/volume\nquota value will be -1 if  bucket/volume created without explicitly set quota value in 1.1.0\nquota > 0 indicates quota is enabled\nthrow exception if user set quota to 0 to keep consistent with current HDFS behavior\n\nI\u2018m not sure If I have answered your question. Let me know if a further explanation is needed.", "url": "https://github.com/apache/ozone/pull/1746#discussion_r555616799", "createdAt": "2021-01-12T09:13:36Z", "author": {"login": "ChenSammi"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -190,14 +201,44 @@ public static OzoneQuota parseQuota(String quotaInBytes,\n           \" value cannot be greater than Long.MAX_VALUE BYTES\");\n     }\n \n-    if (nSize < 0) {\n-      throw new IllegalArgumentException(\"Quota cannot be negative.\");\n+    if (nSize <= 0) {\n+      throw new IllegalArgumentException(\"Invalid values for quota: \" + nSize);\n     }\n \n-    return new OzoneQuota(quotaInNamespace,\n-        new RawQuotaInBytes(currUnit, nSize));\n+    return new OzoneQuota(new RawQuotaInBytes(currUnit, nSize));\n   }\n \n+  /**\n+   * Parses a user provided string Namespace quota and returns the\n+   * Quota Object.\n+   *\n+   * @param quotaInNamespace Volume quota in counts\n+   *\n+   * @return OzoneQuota object\n+   */\n+  public static OzoneQuota parseNameSpaceQuota(String quotaInNamespace) {\n+    long nameSpaceQuota = Long.parseLong(quotaInNamespace);\n+    if (nameSpaceQuota <= 0) {\n+      throw new IllegalArgumentException(\n+          \"Invalid values for quota: \" + nameSpaceQuota);\n+    }\n+    return new OzoneQuota(nameSpaceQuota, new RawQuotaInBytes(Units.BYTES, -1));\n+  }\n+\n+  /**\n+   * Parses a user provided string and returns the\n+   * Quota Object.\n+   *\n+   * @param quotaInBytes Volume quota in bytes\n+   * @param quotaInNamespace Volume quota in counts\n+   *\n+   * @return OzoneQuota object\n+   */\n+  public static OzoneQuota parseQuota(String quotaInBytes,\n+      String quotaInNamespace) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTEzMjM1MA=="}, "originalCommit": {"oid": "e5c28c8d87cc63c87865e3ec880be81a89d68b08"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQ3MTE5OQ==", "bodyText": "Comments make sense to me, @captainzmc , @ChenSammi", "url": "https://github.com/apache/ozone/pull/1746#discussion_r557471199", "createdAt": "2021-01-14T15:17:02Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -190,14 +201,44 @@ public static OzoneQuota parseQuota(String quotaInBytes,\n           \" value cannot be greater than Long.MAX_VALUE BYTES\");\n     }\n \n-    if (nSize < 0) {\n-      throw new IllegalArgumentException(\"Quota cannot be negative.\");\n+    if (nSize <= 0) {\n+      throw new IllegalArgumentException(\"Invalid values for quota: \" + nSize);\n     }\n \n-    return new OzoneQuota(quotaInNamespace,\n-        new RawQuotaInBytes(currUnit, nSize));\n+    return new OzoneQuota(new RawQuotaInBytes(currUnit, nSize));\n   }\n \n+  /**\n+   * Parses a user provided string Namespace quota and returns the\n+   * Quota Object.\n+   *\n+   * @param quotaInNamespace Volume quota in counts\n+   *\n+   * @return OzoneQuota object\n+   */\n+  public static OzoneQuota parseNameSpaceQuota(String quotaInNamespace) {\n+    long nameSpaceQuota = Long.parseLong(quotaInNamespace);\n+    if (nameSpaceQuota <= 0) {\n+      throw new IllegalArgumentException(\n+          \"Invalid values for quota: \" + nameSpaceQuota);\n+    }\n+    return new OzoneQuota(nameSpaceQuota, new RawQuotaInBytes(Units.BYTES, -1));\n+  }\n+\n+  /**\n+   * Parses a user provided string and returns the\n+   * Quota Object.\n+   *\n+   * @param quotaInBytes Volume quota in bytes\n+   * @param quotaInNamespace Volume quota in counts\n+   *\n+   * @return OzoneQuota object\n+   */\n+  public static OzoneQuota parseQuota(String quotaInBytes,\n+      String quotaInNamespace) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTEzMjM1MA=="}, "originalCommit": {"oid": "e5c28c8d87cc63c87865e3ec880be81a89d68b08"}, "originalPosition": 100}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwOTE5MTIwOnYy", "diffSide": "LEFT", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMzowNDo0MFrOITjwsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMzowNDo0MFrOITjwsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM3OTc2Mg==", "bodyText": "Shall we keep this null check or add new Precondition check that quotaInBytes cannot be null or empty.\nThis suggestion also applies to parseNameSpaceQuota.\nBecause these two functions are public static, we need to do some kind of parameter check.", "url": "https://github.com/apache/ozone/pull/1746#discussion_r557379762", "createdAt": "2021-01-14T13:04:40Z", "author": {"login": "ChenSammi"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -145,21 +163,14 @@ public static String formatQuota(OzoneQuota quota) {\n   }\n \n   /**\n-   * Parses a user provided string and returns the\n+   * Parses a user provided string space quota and returns the\n    * Quota Object.\n    *\n    * @param quotaInBytes Volume quota in bytes\n-   * @param quotaInNamespace Volume quota in counts\n    *\n    * @return OzoneQuota object\n    */\n-  public static OzoneQuota parseQuota(String quotaInBytes,\n-      long quotaInNamespace) {\n-\n-    if (Strings.isNullOrEmpty(quotaInBytes)) {\n-      throw new IllegalArgumentException(\n-          \"Quota string cannot be null or empty.\");\n-    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "363f3923a91067bd7f1875bdf99b32f5db4cbcbb"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwOTI3NTE5OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/volume/CreateVolumeHandler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMzoyNjo1M1rOITkkCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNDoxNjozMFrOITmikg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM5MjkwNA==", "bodyText": "With default quotaInBytes and quotaInNamespace value, do we still need this and below else statement?", "url": "https://github.com/apache/ozone/pull/1746#discussion_r557392904", "createdAt": "2021-01-14T13:26:53Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/volume/CreateVolumeHandler.java", "diffHunk": "@@ -59,13 +61,19 @@ protected void execute(OzoneClient client, OzoneAddress address)\n     VolumeArgs.Builder volumeArgsBuilder = VolumeArgs.newBuilder()\n         .setAdmin(adminName)\n         .setOwner(ownerName);\n-    if (quotaOptions.getQuotaInBytes() != null) {\n-      volumeArgsBuilder.setQuotaInBytes(OzoneQuota.parseQuota(\n-          quotaOptions.getQuotaInBytes(),\n-          quotaOptions.getQuotaInNamespace()).getQuotaInBytes());\n+    if (!Strings.isNullOrEmpty(quotaOptions.getQuotaInBytes())) {\n+      volumeArgsBuilder.setQuotaInBytes(OzoneQuota.parseSpaceQuota(\n+          quotaOptions.getQuotaInBytes()).getQuotaInBytes());\n+    } else {\n+      volumeArgsBuilder.setQuotaInBytes(OzoneConsts.QUOTA_RESET);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "363f3923a91067bd7f1875bdf99b32f5db4cbcbb"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQyNTI5OA==", "bodyText": "This part is superfluous and can be deleted", "url": "https://github.com/apache/ozone/pull/1746#discussion_r557425298", "createdAt": "2021-01-14T14:16:30Z", "author": {"login": "captainzmc"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/volume/CreateVolumeHandler.java", "diffHunk": "@@ -59,13 +61,19 @@ protected void execute(OzoneClient client, OzoneAddress address)\n     VolumeArgs.Builder volumeArgsBuilder = VolumeArgs.newBuilder()\n         .setAdmin(adminName)\n         .setOwner(ownerName);\n-    if (quotaOptions.getQuotaInBytes() != null) {\n-      volumeArgsBuilder.setQuotaInBytes(OzoneQuota.parseQuota(\n-          quotaOptions.getQuotaInBytes(),\n-          quotaOptions.getQuotaInNamespace()).getQuotaInBytes());\n+    if (!Strings.isNullOrEmpty(quotaOptions.getQuotaInBytes())) {\n+      volumeArgsBuilder.setQuotaInBytes(OzoneQuota.parseSpaceQuota(\n+          quotaOptions.getQuotaInBytes()).getQuotaInBytes());\n+    } else {\n+      volumeArgsBuilder.setQuotaInBytes(OzoneConsts.QUOTA_RESET);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM5MjkwNA=="}, "originalCommit": {"oid": "363f3923a91067bd7f1875bdf99b32f5db4cbcbb"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwOTI3NzUwOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/bucket/CreateBucketHandler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMzoyNzoyOFrOITklZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMzoyNzoyOFrOITklZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM5MzI1NA==", "bodyText": "Same as below comment.", "url": "https://github.com/apache/ozone/pull/1746#discussion_r557393254", "createdAt": "2021-01-14T13:27:28Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/bucket/CreateBucketHandler.java", "diffHunk": "@@ -80,12 +81,19 @@ public void execute(OzoneClient client, OzoneAddress address)\n       }\n     }\n \n-    if (quotaOptions.getQuotaInBytes() != null) {\n-      bb.setQuotaInBytes(OzoneQuota.parseQuota(quotaOptions.getQuotaInBytes(),\n-          quotaOptions.getQuotaInNamespace()).getQuotaInBytes());\n+    if (!Strings.isNullOrEmpty(quotaOptions.getQuotaInBytes())) {\n+      bb.setQuotaInBytes(OzoneQuota.parseSpaceQuota(\n+          quotaOptions.getQuotaInBytes()).getQuotaInBytes());\n+    } else {\n+      bb.setQuotaInBytes(OzoneConsts.QUOTA_RESET);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "363f3923a91067bd7f1875bdf99b32f5db4cbcbb"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwOTMxMzYwOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/OMVolumeSetQuotaRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMzozNjowN1rOITk7Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMzozNjowN1rOITk7Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM5ODgxOA==", "bodyText": "(volumeQuotaInBytes < OzoneConsts.QUOTA_RESET || volumeQuotaInBytes == 0) ?", "url": "https://github.com/apache/ozone/pull/1746#discussion_r557398818", "createdAt": "2021-01-14T13:36:07Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/OMVolumeSetQuotaRequest.java", "diffHunk": "@@ -189,7 +189,7 @@ public boolean checkQuotaBytesValid(OMMetadataManager metadataManager,\n       long volumeQuotaInBytes, String volumeName) throws IOException {\n     long totalBucketQuota = 0;\n \n-    if (volumeQuotaInBytes == 0) {\n+    if (volumeQuotaInBytes < OzoneConsts.QUOTA_RESET) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "363f3923a91067bd7f1875bdf99b32f5db4cbcbb"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwOTMxNDk5OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/OMVolumeSetQuotaRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMzozNjoyN1rOITk76g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxMzozNjoyN1rOITk76g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM5OTAxOA==", "bodyText": "Same question as as above comment.", "url": "https://github.com/apache/ozone/pull/1746#discussion_r557399018", "createdAt": "2021-01-14T13:36:27Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/OMVolumeSetQuotaRequest.java", "diffHunk": "@@ -213,8 +213,7 @@ public boolean checkQuotaBytesValid(OMMetadataManager metadataManager,\n \n   public boolean checkQuotaNamespaceValid(long quotaInNamespace) {\n \n-    if ((quotaInNamespace <= 0\n-         && quotaInNamespace != OzoneConsts.QUOTA_RESET)) {\n+    if (quotaInNamespace < OzoneConsts.QUOTA_RESET) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "363f3923a91067bd7f1875bdf99b32f5db4cbcbb"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwOTc3NTMyOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNToxODo0NlrOITpbFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNToxODo0NlrOITpbFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQ3MjUzNQ==", "bodyText": "Can you update quota to 'space quota' that will be more accurate for this exception?", "url": "https://github.com/apache/ozone/pull/1746#discussion_r557472535", "createdAt": "2021-01-14T15:18:46Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -190,14 +207,48 @@ public static OzoneQuota parseQuota(String quotaInBytes,\n           \" value cannot be greater than Long.MAX_VALUE BYTES\");\n     }\n \n-    if (nSize < 0) {\n-      throw new IllegalArgumentException(\"Quota cannot be negative.\");\n+    if (nSize <= 0) {\n+      throw new IllegalArgumentException(\"Invalid values for quota: \" + nSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfb3d14a8ae65a7a14999b1626222f715aa8df76"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwOTc4MDk1OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNToxOTo1NFrOITpelQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNToxOTo1NFrOITpelQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQ3MzQyOQ==", "bodyText": "Similar comment: quota to namespace quota.", "url": "https://github.com/apache/ozone/pull/1746#discussion_r557473429", "createdAt": "2021-01-14T15:19:54Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -190,14 +207,48 @@ public static OzoneQuota parseQuota(String quotaInBytes,\n           \" value cannot be greater than Long.MAX_VALUE BYTES\");\n     }\n \n-    if (nSize < 0) {\n-      throw new IllegalArgumentException(\"Quota cannot be negative.\");\n+    if (nSize <= 0) {\n+      throw new IllegalArgumentException(\"Invalid values for quota: \" + nSize);\n     }\n \n-    return new OzoneQuota(quotaInNamespace,\n-        new RawQuotaInBytes(currUnit, nSize));\n+    return new OzoneQuota(new RawQuotaInBytes(currUnit, nSize));\n   }\n \n+  /**\n+   * Parses a user provided string Namespace quota and returns the\n+   * Quota Object.\n+   *\n+   * @param quotaInNamespace Volume quota in counts\n+   *\n+   * @return OzoneQuota object\n+   */\n+  public static OzoneQuota parseNameSpaceQuota(String quotaInNamespace) {\n+    if (Strings.isNullOrEmpty(quotaInNamespace)) {\n+      throw new IllegalArgumentException(\n+          \"Quota string cannot be null or empty.\");\n+    }\n+    long nameSpaceQuota = Long.parseLong(quotaInNamespace);\n+    if (nameSpaceQuota <= 0) {\n+      throw new IllegalArgumentException(\n+          \"Invalid values for quota: \" + nameSpaceQuota);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfb3d14a8ae65a7a14999b1626222f715aa8df76"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwOTc5MDYxOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNToyMjowMlrOITpkrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNToyMjowMlrOITpkrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQ3NDk4OA==", "bodyText": "Seems this should be updated to quotaInBytes < OzoneConsts.QUOTA_RESET || quotaInBytes == 0 as well.", "url": "https://github.com/apache/ozone/pull/1746#discussion_r557474988", "createdAt": "2021-01-14T15:22:02Z", "author": {"login": "linyiqun"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java", "diffHunk": "@@ -239,7 +239,7 @@ public boolean checkQuotaBytesValid(OMMetadataManager metadataManager,\n           OMException.ResultCodes.QUOTA_ERROR);\n     }\n \n-    if (quotaInBytes == 0) {\n+    if (quotaInBytes < OzoneConsts.QUOTA_RESET) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfb3d14a8ae65a7a14999b1626222f715aa8df76"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwOTc5MjczOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNToyMjoyN1rOITpl-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNFQxNToyMjoyN1rOITpl-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQ3NTMyMw==", "bodyText": "Same comment for this.", "url": "https://github.com/apache/ozone/pull/1746#discussion_r557475323", "createdAt": "2021-01-14T15:22:27Z", "author": {"login": "linyiqun"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java", "diffHunk": "@@ -273,8 +273,7 @@ public boolean checkQuotaNamespaceValid(OmVolumeArgs omVolumeArgs,\n       OmBucketArgs omBucketArgs) {\n     long quotaInNamespace = omBucketArgs.getQuotaInNamespace();\n \n-    if ((quotaInNamespace <= 0\n-         && quotaInNamespace != OzoneConsts.QUOTA_RESET)) {\n+    if (quotaInNamespace < OzoneConsts.QUOTA_RESET) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfb3d14a8ae65a7a14999b1626222f715aa8df76"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUxMjA3Nzc2OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQwMzowNzozN1rOIT_hCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQwMzowNzozN1rOIT_hCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzgzNDUwNA==", "bodyText": "volume quota should be ozone quota since this quota can also the bucket quota", "url": "https://github.com/apache/ozone/pull/1746#discussion_r557834504", "createdAt": "2021-01-15T03:07:37Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -145,16 +164,14 @@ public static String formatQuota(OzoneQuota quota) {\n   }\n \n   /**\n-   * Parses a user provided string and returns the\n+   * Parses a user provided string space quota and returns the\n    * Quota Object.\n    *\n    * @param quotaInBytes Volume quota in bytes", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20c54b21641ab85a2f792bab12c2279668f8bf6c"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUxMjA3ODY1OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQwMzowNzo1NlrOIT_hdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQwMzowNzo1NlrOIT_hdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzgzNDYxNA==", "bodyText": "Same comment as above.", "url": "https://github.com/apache/ozone/pull/1746#discussion_r557834614", "createdAt": "2021-01-15T03:07:56Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -190,14 +207,49 @@ public static OzoneQuota parseQuota(String quotaInBytes,\n           \" value cannot be greater than Long.MAX_VALUE BYTES\");\n     }\n \n-    if (nSize < 0) {\n-      throw new IllegalArgumentException(\"Quota cannot be negative.\");\n+    if (nSize <= 0) {\n+      throw new IllegalArgumentException(\"Invalid values for space quota: \"\n+          + nSize);\n     }\n \n-    return new OzoneQuota(quotaInNamespace,\n-        new RawQuotaInBytes(currUnit, nSize));\n+    return new OzoneQuota(new RawQuotaInBytes(currUnit, nSize));\n   }\n \n+  /**\n+   * Parses a user provided string Namespace quota and returns the\n+   * Quota Object.\n+   *\n+   * @param quotaInNamespace Volume quota in counts", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20c54b21641ab85a2f792bab12c2279668f8bf6c"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUxMjA3OTU4OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQwMzowODoxNFrOIT_h-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQwMzowODoxNFrOIT_h-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzgzNDc0NQ==", "bodyText": "Same comment as above.", "url": "https://github.com/apache/ozone/pull/1746#discussion_r557834745", "createdAt": "2021-01-15T03:08:14Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/client/OzoneQuota.java", "diffHunk": "@@ -190,14 +207,49 @@ public static OzoneQuota parseQuota(String quotaInBytes,\n           \" value cannot be greater than Long.MAX_VALUE BYTES\");\n     }\n \n-    if (nSize < 0) {\n-      throw new IllegalArgumentException(\"Quota cannot be negative.\");\n+    if (nSize <= 0) {\n+      throw new IllegalArgumentException(\"Invalid values for space quota: \"\n+          + nSize);\n     }\n \n-    return new OzoneQuota(quotaInNamespace,\n-        new RawQuotaInBytes(currUnit, nSize));\n+    return new OzoneQuota(new RawQuotaInBytes(currUnit, nSize));\n   }\n \n+  /**\n+   * Parses a user provided string Namespace quota and returns the\n+   * Quota Object.\n+   *\n+   * @param quotaInNamespace Volume quota in counts\n+   *\n+   * @return OzoneQuota object\n+   */\n+  public static OzoneQuota parseNameSpaceQuota(String quotaInNamespace) {\n+    if (Strings.isNullOrEmpty(quotaInNamespace)) {\n+      throw new IllegalArgumentException(\n+          \"Quota string cannot be null or empty.\");\n+    }\n+    long nameSpaceQuota = Long.parseLong(quotaInNamespace);\n+    if (nameSpaceQuota <= 0) {\n+      throw new IllegalArgumentException(\n+          \"Invalid values for namespace quota: \" + nameSpaceQuota);\n+    }\n+    return new OzoneQuota(nameSpaceQuota, new RawQuotaInBytes(Units.BYTES, -1));\n+  }\n+\n+  /**\n+   * Parses a user provided string and returns the\n+   * Quota Object.\n+   *\n+   * @param quotaInBytes Volume quota in bytes\n+   * @param quotaInNamespace Volume quota in counts", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20c54b21641ab85a2f792bab12c2279668f8bf6c"}, "originalPosition": 87}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4492, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}