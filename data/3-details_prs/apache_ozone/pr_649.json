{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MDQ3OTU3", "number": 649, "title": "HDDS-3120. Freon work with OM HA.", "bodyText": "What changes were proposed in this pull request?\nMake Freon work with OM HA.\nAnd also refactor OzoneClientFactory.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3120\nHow was this patch tested?\nTested it on ozone-om-ha-s3 docker-compose cluster.\nFreon tests are added to test with OM HA.\nbash-4.2$ ozone freon rk --om-service-id=id1 --numOfVolumes=1 --numOfBuckets=1 --numOfKeys=1 --numOfThreads=1\n2020-03-06 20:46:21,267 [main] INFO impl.MetricsConfig: Loaded properties from hadoop-metrics2.properties\n2020-03-06 20:46:21,529 [main] INFO impl.MetricsSystemImpl: Scheduled Metric snapshot period at 10 second(s).\n2020-03-06 20:46:21,529 [main] INFO impl.MetricsSystemImpl: ozone-freon metrics system started\n2020-03-06 20:46:23,391 [main] INFO freon.RandomKeyGenerator: Number of Threads: 1\n2020-03-06 20:46:23,392 [main] INFO freon.RandomKeyGenerator: Number of Volumes: 1.\n2020-03-06 20:46:23,392 [main] INFO freon.RandomKeyGenerator: Number of Buckets per Volume: 1.\n2020-03-06 20:46:23,393 [main] INFO freon.RandomKeyGenerator: Number of Keys per Bucket: 1.\n2020-03-06 20:46:23,393 [main] INFO freon.RandomKeyGenerator: Key size: 10240 bytes\n2020-03-06 20:46:23,393 [main] INFO freon.RandomKeyGenerator: Buffer size: 4096 bytes\n2020-03-06 20:46:23,394 [main] INFO freon.RandomKeyGenerator: validateWrites : false\n2020-03-06 20:46:23,398 [main] INFO freon.RandomKeyGenerator: Starting progress bar Thread.\n\n 0.00% |?                                                                                                    |  0/1 Time: 0:00:002020-03-06 20:46:23,466 [pool-2-thread-1] INFO rpc.RpcClient: Creating Volume: vol-0-45597, with hadoop as owner.\n2020-03-06 20:46:23,533 [pool-2-thread-1] INFO rpc.RpcClient: Creating Bucket: vol-0-45597/bucket-0-56744, with Versioning false and Storage Type set to DISK and Encryption set to false \n2020-03-06 20:46:24,103 [pool-2-thread-1] WARN impl.MetricsSystemImpl: ozone-freon metrics system already initialized!\n 100.00% |?????????????????????????????????????????????????????????????????????????????????????????????????????|  1/1 Time: 0:00:01\n\n***************************************************\nStatus: Success\nGit Base Revision: e97acb3bd8f3befd27418996fa5d4b50bf2e17bf\nNumber of Volumes created: 1\nNumber of Buckets created: 1\nNumber of Keys added: 1\nRatis replication factor: ONE\nRatis replication type: STAND_ALONE\nAverage Time spent in volume creation: 00:00:00,104\nAverage Time spent in bucket creation: 00:00:00,026\nAverage Time spent in key creation: 00:00:00,079\nAverage Time spent in key write: 00:00:00,735\nTotal bytes written: 10240\nTotal Execution time: 00:00:06,431\n***************************************************", "createdAt": "2020-03-06T22:23:52Z", "url": "https://github.com/apache/ozone/pull/649", "merged": true, "mergeCommit": {"oid": "f0f67862688600d6b27faadb2510390b89324b82"}, "closed": true, "closedAt": "2020-03-10T22:10:16Z", "author": {"login": "bharatviswa504"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcLH1AggBqjMxMDcwNzQxNjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMY-gTAH2gAyMzg1MDQ3OTU3OjQ1NGZiOWYwNzA1ZjE0ZWE5MTU5MjE0ZmNhZWVlZGZmOGI1YzBmM2Y=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ea2f0db6dc67e0a388d9d62e37b486bc34d4f7f", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/0ea2f0db6dc67e0a388d9d62e37b486bc34d4f7f", "committedDate": "2020-03-06T20:40:31Z", "message": "HDDS-3120. Freon work with OM HA."}, "afterCommit": {"oid": "3ef9dadcd0c43d62d709e9cd400722ab19e03315", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/3ef9dadcd0c43d62d709e9cd400722ab19e03315", "committedDate": "2020-03-06T22:26:17Z", "message": "HDDS-3120. Freon work with OM HA."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ef9dadcd0c43d62d709e9cd400722ab19e03315", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/3ef9dadcd0c43d62d709e9cd400722ab19e03315", "committedDate": "2020-03-06T22:26:17Z", "message": "HDDS-3120. Freon work with OM HA."}, "afterCommit": {"oid": "5bf977969ea8d0015fc12349908b95979a425d0f", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/5bf977969ea8d0015fc12349908b95979a425d0f", "committedDate": "2020-03-06T22:28:17Z", "message": "HDDS-3120. Freon work with OM HA."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5bf977969ea8d0015fc12349908b95979a425d0f", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/5bf977969ea8d0015fc12349908b95979a425d0f", "committedDate": "2020-03-06T22:28:17Z", "message": "HDDS-3120. Freon work with OM HA."}, "afterCommit": {"oid": "f0649b9f03a8d226963e9c99e57b894f1d6a0e1b", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/f0649b9f03a8d226963e9c99e57b894f1d6a0e1b", "committedDate": "2020-03-06T23:01:51Z", "message": "HDDS-3120. Freon work with OM HA."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f0649b9f03a8d226963e9c99e57b894f1d6a0e1b", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/f0649b9f03a8d226963e9c99e57b894f1d6a0e1b", "committedDate": "2020-03-06T23:01:51Z", "message": "HDDS-3120. Freon work with OM HA."}, "afterCommit": {"oid": "b1213a8905eedc7d3636dcd935055cf8a681cf4c", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/b1213a8905eedc7d3636dcd935055cf8a681cf4c", "committedDate": "2020-03-06T23:05:36Z", "message": "HDDS-3120. Freon work with OM HA."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMDA5NDg0", "url": "https://github.com/apache/ozone/pull/649#pullrequestreview-371009484", "createdAt": "2020-03-09T09:18:36Z", "commit": {"oid": "3b77726e82ace5c849caea354236ec101d171ea1"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33f6a38e80afba8973bb068ed66bdf3b582f2c4e", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/33f6a38e80afba8973bb068ed66bdf3b582f2c4e", "committedDate": "2020-03-09T16:42:44Z", "message": "HDDS-3120. Freon work with OM HA."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81dc976e19c553af90191a915b24cd894c54a97d", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/81dc976e19c553af90191a915b24cd894c54a97d", "committedDate": "2020-03-09T16:42:46Z", "message": "fix ombg:"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33d4c074dd595b929bc72ff810ffdd06a3a00cd5", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/33d4c074dd595b929bc72ff810ffdd06a3a00cd5", "committedDate": "2020-03-09T16:42:46Z", "message": "freon test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62cc3de6e7f44232e2f36607840d6f717ec38420", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/62cc3de6e7f44232e2f36607840d6f717ec38420", "committedDate": "2020-03-09T16:42:46Z", "message": "add check of isServiceIdsDefined in default getClient method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3335790d7a2696e78bc66c9ebaaa88238e815b28", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/3335790d7a2696e78bc66c9ebaaa88238e815b28", "committedDate": "2020-03-09T16:42:46Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87ee02f0dd9a8d1605878b2418b63fc483164e4f", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/87ee02f0dd9a8d1605878b2418b63fc483164e4f", "committedDate": "2020-03-09T16:42:46Z", "message": "fix new test failure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc69bda71af4b7e6638537bb431995acef4176ff", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/dc69bda71af4b7e6638537bb431995acef4176ff", "committedDate": "2020-03-09T16:42:46Z", "message": "remove space'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7f4b31215f478febaba3951c764d4ea016a56c6", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/b7f4b31215f478febaba3951c764d4ea016a56c6", "committedDate": "2020-03-09T18:13:15Z", "message": "use env and make test work for ha and non-ha"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3b77726e82ace5c849caea354236ec101d171ea1", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/3b77726e82ace5c849caea354236ec101d171ea1", "committedDate": "2020-03-09T03:19:02Z", "message": "remove space'"}, "afterCommit": {"oid": "b7f4b31215f478febaba3951c764d4ea016a56c6", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/b7f4b31215f478febaba3951c764d4ea016a56c6", "committedDate": "2020-03-09T18:13:15Z", "message": "use env and make test work for ha and non-ha"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNDY4MTM1", "url": "https://github.com/apache/ozone/pull/649#pullrequestreview-371468135", "createdAt": "2020-03-09T19:30:12Z", "commit": {"oid": "b7f4b31215f478febaba3951c764d4ea016a56c6"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxOTozMDoxMlrOFz2ZKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMDowNzo0NlrOFz3j-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxMjg3NA==", "bodyText": "What's the reason for changing to try-finally here?", "url": "https://github.com/apache/ozone/pull/649#discussion_r389912874", "createdAt": "2020-03-09T19:30:12Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/freon/OzoneClientKeyGenerator.java", "diffHunk": "@@ -86,22 +91,24 @@ public Void call() throws Exception {\n \n     OzoneConfiguration ozoneConfiguration = createOzoneConfiguration();\n \n-    ensureVolumeAndBucketExist(ozoneConfiguration, volumeName, bucketName);\n \n     contentGenerator = new ContentGenerator(keySize, bufferSize);\n     metadata = new HashMap<>();\n \n-    try (OzoneClient rpcClient = OzoneClientFactory\n-        .getRpcClient(ozoneConfiguration)) {\n-\n-      bucket =\n-          rpcClient.getObjectStore().getVolume(volumeName)\n-              .getBucket(bucketName);\n+    OzoneClient rpcClient = null;\n+    try {\n+      rpcClient = createOzoneClient(omServiceID, ozoneConfiguration);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7f4b31215f478febaba3951c764d4ea016a56c6"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkxNTc5Ng==", "bodyText": "Now that rpcClient is passed as a parameter, can we merge this block and ensureVolumeExists?", "url": "https://github.com/apache/ozone/pull/649#discussion_r389915796", "createdAt": "2020-03-09T19:35:53Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/freon/BaseFreonGenerator.java", "diffHunk": "@@ -374,53 +369,45 @@ public String generateObjectName(long counter) {\n   /**\n    * Create missing target volume/bucket.\n    */\n-  public void ensureVolumeAndBucketExist(OzoneConfiguration ozoneConfiguration,\n+  public void ensureVolumeAndBucketExist(OzoneClient rpcClient,\n       String volumeName, String bucketName) throws IOException {\n \n-    try (OzoneClient rpcClient = OzoneClientFactory\n-        .getRpcClient(ozoneConfiguration)) {\n-\n-      OzoneVolume volume = null;\n-      try {\n+    OzoneVolume volume = null;\n+    try {\n+      volume = rpcClient.getObjectStore().getVolume(volumeName);\n+    } catch (OMException ex) {\n+      if (ex.getResult() == ResultCodes.VOLUME_NOT_FOUND) {\n+        rpcClient.getObjectStore().createVolume(volumeName);\n         volume = rpcClient.getObjectStore().getVolume(volumeName);\n-      } catch (OMException ex) {\n-        if (ex.getResult() == ResultCodes.VOLUME_NOT_FOUND) {\n-          rpcClient.getObjectStore().createVolume(volumeName);\n-          volume = rpcClient.getObjectStore().getVolume(volumeName);\n-        } else {\n-          throw ex;\n-        }\n+      } else {\n+        throw ex;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7f4b31215f478febaba3951c764d4ea016a56c6"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkyMjg5Ng==", "bodyText": "Please reuse createOzoneClient from parent class.", "url": "https://github.com/apache/ozone/pull/649#discussion_r389922896", "createdAt": "2020-03-09T19:49:41Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/freon/OmBucketGenerator.java", "diffHunk": "@@ -46,24 +48,49 @@\n       defaultValue = \"vol1\")\n   private String volumeName;\n \n+  @Option(\n+      names = \"--om-service-id\",\n+      description = \"OM Service ID\"\n+  )\n+  private String omServiceID = null;\n+\n   private OzoneManagerProtocol ozoneManagerClient;\n \n   private Timer bucketCreationTimer;\n \n   @Override\n   public Void call() throws Exception {\n \n-    init();\n+    OzoneClient ozoneClient = null;\n+    try {\n+      init();\n+\n+      OzoneConfiguration ozoneConfiguration = createOzoneConfiguration();\n+\n+      ozoneManagerClient = createOmClient(ozoneConfiguration, omServiceID);\n+\n+      if (omServiceID != null) {\n+        ozoneClient = OzoneClientFactory.getRpcClient(omServiceID,\n+            ozoneConfiguration);\n+      } else {\n+        ozoneClient = OzoneClientFactory.getRpcClient(ozoneConfiguration);\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7f4b31215f478febaba3951c764d4ea016a56c6"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkyNTA0MQ==", "bodyText": "Leftover debug.", "url": "https://github.com/apache/ozone/pull/649#discussion_r389925041", "createdAt": "2020-03-09T19:53:37Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/freon/OmKeyGenerator.java", "diffHunk": "@@ -62,24 +63,44 @@\n   )\n   private ReplicationFactor factor = ReplicationFactor.THREE;\n \n+  @Option(\n+      names = \"--om-service-id\",\n+      description = \"OM Service ID\"\n+  )\n+  private String omServiceID = null;\n+\n   private OzoneManagerProtocol ozoneManagerClient;\n \n   private Timer timer;\n \n   @Override\n   public Void call() throws Exception {\n \n-    init();\n+    OzoneClient rpcClient = null;\n+    try {\n+      init();\n+\n+      OzoneConfiguration ozoneConfiguration = createOzoneConfiguration();\n+\n+      rpcClient = createOzoneClient(omServiceID, ozoneConfiguration);\n \n-    OzoneConfiguration ozoneConfiguration = createOzoneConfiguration();\n+      ensureVolumeAndBucketExist(rpcClient, volumeName, bucketName);\n \n-    ensureVolumeAndBucketExist(ozoneConfiguration, volumeName, bucketName);\n+      System.out.print(\"Bharat \" + omServiceID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7f4b31215f478febaba3951c764d4ea016a56c6"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkyNTM3Mw==", "bodyText": "Can rpcClient be closed right after creating volume/bucket?  Probably best to wrap in \"try-with-resources\" block.", "url": "https://github.com/apache/ozone/pull/649#discussion_r389925373", "createdAt": "2020-03-09T19:54:14Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/freon/OmKeyGenerator.java", "diffHunk": "@@ -62,24 +63,44 @@\n   )\n   private ReplicationFactor factor = ReplicationFactor.THREE;\n \n+  @Option(\n+      names = \"--om-service-id\",\n+      description = \"OM Service ID\"\n+  )\n+  private String omServiceID = null;\n+\n   private OzoneManagerProtocol ozoneManagerClient;\n \n   private Timer timer;\n \n   @Override\n   public Void call() throws Exception {\n \n-    init();\n+    OzoneClient rpcClient = null;\n+    try {\n+      init();\n+\n+      OzoneConfiguration ozoneConfiguration = createOzoneConfiguration();\n+\n+      rpcClient = createOzoneClient(omServiceID, ozoneConfiguration);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7f4b31215f478febaba3951c764d4ea016a56c6"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkyNjA0NQ==", "bodyText": "Can ozoneClient be closed right after creating volume?", "url": "https://github.com/apache/ozone/pull/649#discussion_r389926045", "createdAt": "2020-03-09T19:55:36Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/freon/OmBucketGenerator.java", "diffHunk": "@@ -46,24 +48,49 @@\n       defaultValue = \"vol1\")\n   private String volumeName;\n \n+  @Option(\n+      names = \"--om-service-id\",\n+      description = \"OM Service ID\"\n+  )\n+  private String omServiceID = null;\n+\n   private OzoneManagerProtocol ozoneManagerClient;\n \n   private Timer bucketCreationTimer;\n \n   @Override\n   public Void call() throws Exception {\n \n-    init();\n+    OzoneClient ozoneClient = null;\n+    try {\n+      init();\n+\n+      OzoneConfiguration ozoneConfiguration = createOzoneConfiguration();\n+\n+      ozoneManagerClient = createOmClient(ozoneConfiguration, omServiceID);\n+\n+      if (omServiceID != null) {\n+        ozoneClient = OzoneClientFactory.getRpcClient(omServiceID,\n+            ozoneConfiguration);\n+      } else {\n+        ozoneClient = OzoneClientFactory.getRpcClient(ozoneConfiguration);\n+      }\n+      ensureVolumeExists(ozoneClient, volumeName);\n \n-    OzoneConfiguration ozoneConfiguration = createOzoneConfiguration();\n+      bucketCreationTimer = getMetrics().timer(\"bucket-create\");\n \n-    ozoneManagerClient = createOmClient(ozoneConfiguration);\n+      runTests(this::createBucket);\n \n-    ensureVolumeExists(ozoneConfiguration, volumeName);\n+    } finally {\n \n-    bucketCreationTimer = getMetrics().timer(\"bucket-create\");\n+      if (ozoneClient != null) {\n+        ozoneClient.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7f4b31215f478febaba3951c764d4ea016a56c6"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTkzMjAyNg==", "bodyText": "I think here getClient should be used to validate presence of --om-service-id param.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  return OzoneClientFactory.getRpcClient(conf);\n          \n          \n            \n                  return OzoneClientFactory.getClient(conf);\n          \n      \n    \n    \n  \n\nThere are two methods in OzoneClientFactory that take Configuration and return OzoneClient:\n\ngetClient(Configuration) throws exception if configuration has OM service ID, but\ngetRpcClient(Configuration) does not\n\nI'm getting timeout on OM HA cluster when --om-service-id is omitted.\n$ ozone freon ockg -n 1 -t 1\n...\n[main] INFO ipc.Client: Retrying connect to server: 0.0.0.0/0.0.0.0:9862. Already tried 0 time(s); retry policy is RetryUpToMaximumCountWithFixedSleep(maxRetries=10, sleepTime=1000 MILLISECONDS)\n...\n[main] ERROR ha.OMFailoverProxyProvider: Failed to connect to OMs: [nodeId=null,nodeAddress=0.0.0.0:9862]. Attempted 15 failovers.\n\nAfter making the suggested change locally, I get the error message as expected:\n$ ozone freon ockg -n 1 -t 1\n...\nFollowing ServiceID's [id1] are defined in the configuration. Use the method getClient which takes serviceID and configuration as param", "url": "https://github.com/apache/ozone/pull/649#discussion_r389932026", "createdAt": "2020-03-09T20:07:46Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/freon/BaseFreonGenerator.java", "diffHunk": "@@ -469,4 +456,13 @@ public AtomicLong getAttemptCounter() {\n   public int getThreadNo() {\n     return threadNo;\n   }\n+\n+  protected OzoneClient createOzoneClient(String omServiceID,\n+      OzoneConfiguration conf) throws Exception {\n+    if (omServiceID != null) {\n+      return OzoneClientFactory.getRpcClient(omServiceID, conf);\n+    } else {\n+      return OzoneClientFactory.getRpcClient(conf);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7f4b31215f478febaba3951c764d4ea016a56c6"}, "originalPosition": 117}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2216298ce583aa7aa6ee17ba3beee1a9a16f7910", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/2216298ce583aa7aa6ee17ba3beee1a9a16f7910", "committedDate": "2020-03-10T17:04:57Z", "message": "review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "78a9b4feb596493ca239304f7c07fdf0e4038aaf", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/78a9b4feb596493ca239304f7c07fdf0e4038aaf", "committedDate": "2020-03-10T17:04:20Z", "message": "missed code changes"}, "afterCommit": {"oid": "2216298ce583aa7aa6ee17ba3beee1a9a16f7910", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/2216298ce583aa7aa6ee17ba3beee1a9a16f7910", "committedDate": "2020-03-10T17:04:57Z", "message": "review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fd5dedc0b2a34f94805e2f5d447bc84af484a4e", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/0fd5dedc0b2a34f94805e2f5d447bc84af484a4e", "committedDate": "2020-03-10T17:10:22Z", "message": "change exception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c181ce87cb447c35450f6e4ca7329a8cfe4f1aee", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/c181ce87cb447c35450f6e4ca7329a8cfe4f1aee", "committedDate": "2020-03-10T18:12:39Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMzA3MjM1", "url": "https://github.com/apache/ozone/pull/649#pullrequestreview-372307235", "createdAt": "2020-03-10T20:44:11Z", "commit": {"oid": "c181ce87cb447c35450f6e4ca7329a8cfe4f1aee"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMDo0NDoxMVrOF0gSIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMDo0NDoxMVrOF0gSIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU5OTIwMQ==", "bodyText": "Should throw ex in else branch, otherwise volume creation fails silently and will run into NPE elsewhere.", "url": "https://github.com/apache/ozone/pull/649#discussion_r390599201", "createdAt": "2020-03-10T20:44:11Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/freon/BaseFreonGenerator.java", "diffHunk": "@@ -374,53 +369,37 @@ public String generateObjectName(long counter) {\n   /**\n    * Create missing target volume/bucket.\n    */\n-  public void ensureVolumeAndBucketExist(OzoneConfiguration ozoneConfiguration,\n+  public void ensureVolumeAndBucketExist(OzoneClient rpcClient,\n       String volumeName, String bucketName) throws IOException {\n \n-    try (OzoneClient rpcClient = OzoneClientFactory\n-        .getRpcClient(ozoneConfiguration)) {\n+    OzoneVolume volume;\n+    ensureVolumeExists(rpcClient, volumeName);\n+    volume = rpcClient.getObjectStore().getVolume(volumeName);\n \n-      OzoneVolume volume = null;\n-      try {\n-        volume = rpcClient.getObjectStore().getVolume(volumeName);\n-      } catch (OMException ex) {\n-        if (ex.getResult() == ResultCodes.VOLUME_NOT_FOUND) {\n-          rpcClient.getObjectStore().createVolume(volumeName);\n-          volume = rpcClient.getObjectStore().getVolume(volumeName);\n-        } else {\n-          throw ex;\n-        }\n-      }\n-\n-      try {\n-        volume.getBucket(bucketName);\n-      } catch (OMException ex) {\n-        if (ex.getResult() == ResultCodes.BUCKET_NOT_FOUND) {\n-          volume.createBucket(bucketName);\n-        } else {\n-          throw ex;\n-        }\n+    try {\n+      volume.getBucket(bucketName);\n+    } catch (OMException ex) {\n+      if (ex.getResult() == ResultCodes.BUCKET_NOT_FOUND) {\n+        volume.createBucket(bucketName);\n+      } else {\n+        throw ex;\n       }\n     }\n+\n   }\n \n   /**\n    * Create missing target volume.\n    */\n   public void ensureVolumeExists(\n-      OzoneConfiguration ozoneConfiguration,\n+      OzoneClient rpcClient,\n       String volumeName) throws IOException {\n-    try (OzoneClient rpcClient = OzoneClientFactory\n-        .getRpcClient(ozoneConfiguration)) {\n-\n-      try {\n-        rpcClient.getObjectStore().getVolume(volumeName);\n-      } catch (OMException ex) {\n-        if (ex.getResult() == ResultCodes.VOLUME_NOT_FOUND) {\n-          rpcClient.getObjectStore().createVolume(volumeName);\n-        }\n+    try {\n+      rpcClient.getObjectStore().getVolume(volumeName);\n+    } catch (OMException ex) {\n+      if (ex.getResult() == ResultCodes.VOLUME_NOT_FOUND) {\n+        rpcClient.getObjectStore().createVolume(volumeName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c181ce87cb447c35450f6e4ca7329a8cfe4f1aee"}, "originalPosition": 95}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "454fb9f0705f14ea9159214fcaeeedff8b5c0f3f", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/454fb9f0705f14ea9159214fcaeeedff8b5c0f3f", "committedDate": "2020-03-10T20:59:10Z", "message": "review comment."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3689, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}