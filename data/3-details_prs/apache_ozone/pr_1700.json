{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5OTY1MzQy", "number": 1700, "title": "HDDS-4589: Handle potential data loss during ReplicationManager.handleOverReplicatedContainer()", "bodyText": "What changes were proposed in this pull request?\nProblem:\u00a0\nReplicationManager maintains the in-flight replication and deletion in-memory, which is not replicated using Ratis. So, theoretically it\u2019s possible that we might run into issues if we immediately start ReplicationManager after a failover.\nScenario: There are 6 replicas of the container C1 namely CR1, CR2, CR3, CR4, CR5 and CR6. The container is over replicated, so the current SCM S1 decides to delete the excess replicas. SCM S1 picks CR1, CR2 and CR3 for deletion, this information is updated in the in-flight deletion list and deletion commands are sent to the datanodes. If there is a failover at this point and SCM S2 becomes leader, it doesn\u2019t have the in-flight deletion list from SCM S1 and it finds the container C1 to be over replicated. Theoretically it\u2019s possible that SCM S2 picks CR4, CR5 and CR6 for deletion. If this happens, we will end up in data loss.\nTo address this issue we will make the logic to select a replica for deletion deterministic. This will make sure that the new leader after failover will pick the same replica for deletion which was picked by the old leader.\u00a0\nApproach:\u00a0\nSort the candidate replicas.\u00a0Delete excess replicas from small to large.\u00a0There will not be any DeleteContainerCommand for the largest 3 Replica sent by any SCM.\nExample:\nAssume there are 6 replicas of the container C1, the factor of C1 is 3, the names of the replicas are CR1, CR2, CR3, CR4, CR5 and CR6.\u00a0There will not be any DeleteContainerCommand for CR4, CR5, CR6 sent by any SCM:\nIf SCM sees less than or equal to 3 replicas, it won\u2019t send any DeleteContainerCommand.\nIf SCM sees 4 replicas, It deletes the smallest replica, which means it won\u2019t send DeleteContainerCommand for CR4 CR5, CR6, otherwise there will be a contradiction.\nIf SCM sees 5 replicas, It deletes the smallest 2 replicas, which means it won\u2019t send DeleteContainerCommand for CR4 CR5, CR6, otherwise there will be a contradiction.\nIf SCM sees 6 replicas, It deletes the smallest 3 replicas, which means it won\u2019t send DeleteContainerCommand for CR4 CR5, CR6, otherwise there will be a contradiction.\nP.S.:\nSince this issue exists in master as well, e.g., a quickly restart of SCM, we decide to fix this problem in master, and will have this fix in the next merge from master to our dev branch HDDS-2823.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4589\nHow was this patch tested?\nCI", "createdAt": "2020-12-15T04:24:52Z", "url": "https://github.com/apache/ozone/pull/1700", "merged": true, "mergeCommit": {"oid": "9e9defd5721dda3b6631332835fc6f7b1a2fd4ba"}, "closed": true, "closedAt": "2020-12-17T07:27:12Z", "author": {"login": "GlenGeng"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmTVY7gBqjQxMTI3MzI0NDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdm-X5BAFqTU1NDMzNjI3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "db77e49b37a2dbf6f479b771d979d3c188aa4994", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/db77e49b37a2dbf6f479b771d979d3c188aa4994", "committedDate": "2020-12-15T04:22:29Z", "message": "HDDS-4589: Handle potential data loss during ReplicationManager.handleOverReplicatedContainer()"}, "afterCommit": {"oid": "c0b206bf4389ff6e2b6594d9066c6c194240e8f5", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/c0b206bf4389ff6e2b6594d9066c6c194240e8f5", "committedDate": "2020-12-15T05:17:17Z", "message": "HDDS-4589: Handle potential data loss during ReplicationManager.handleOverReplicatedContainer()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5be9ddc11631a6071ecf7c3c73f8970597ce29b8", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/5be9ddc11631a6071ecf7c3c73f8970597ce29b8", "committedDate": "2020-12-15T12:59:06Z", "message": "HDDS-4589: Handle potential data loss during ReplicationManager.handleOverReplicatedContainer()"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c0b206bf4389ff6e2b6594d9066c6c194240e8f5", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/c0b206bf4389ff6e2b6594d9066c6c194240e8f5", "committedDate": "2020-12-15T05:17:17Z", "message": "HDDS-4589: Handle potential data loss during ReplicationManager.handleOverReplicatedContainer()"}, "afterCommit": {"oid": "5be9ddc11631a6071ecf7c3c73f8970597ce29b8", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/5be9ddc11631a6071ecf7c3c73f8970597ce29b8", "committedDate": "2020-12-15T12:59:06Z", "message": "HDDS-4589: Handle potential data loss during ReplicationManager.handleOverReplicatedContainer()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyODQxNDAx", "url": "https://github.com/apache/ozone/pull/1700#pullrequestreview-552841401", "createdAt": "2020-12-15T20:27:43Z", "commit": {"oid": "5be9ddc11631a6071ecf7c3c73f8970597ce29b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMDoyNzo0M1rOIGelkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMDoyNzo0M1rOIGelkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzY2MzUwNA==", "bodyText": "So it seems will be hard to write a test to verify the case in HDDS-4589 :)", "url": "https://github.com/apache/ozone/pull/1700#discussion_r543663504", "createdAt": "2020-12-15T20:27:43Z", "author": {"login": "amaliujia"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "diffHunk": "@@ -720,6 +721,12 @@ private void handleOverReplicatedContainer(final ContainerInfo container,\n \n       final List<ContainerReplica> eligibleReplicas = new ArrayList<>(replicas);\n \n+      // Iterate replicas in deterministic order to avoid potential data loss.\n+      // See https://issues.apache.org/jira/browse/HDDS-4589.\n+      // N.B., sort replicas by (containerID, datanodeDetails).\n+      eligibleReplicas.sort(\n+          Comparator.comparingLong(ContainerReplica::hashCode));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5be9ddc11631a6071ecf7c3c73f8970597ce29b8"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MzM2Mjc4", "url": "https://github.com/apache/ozone/pull/1700#pullrequestreview-554336278", "createdAt": "2020-12-17T07:26:34Z", "commit": {"oid": "5be9ddc11631a6071ecf7c3c73f8970597ce29b8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2119, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}