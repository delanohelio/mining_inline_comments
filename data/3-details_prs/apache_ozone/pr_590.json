{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4ODUyNDI5", "number": 590, "title": "HDDS-3049. Fix Replication factor passed in create API doesn't take effect", "bodyText": "What changes were proposed in this pull request?\nReplication did not take effect when we created the file through o3fs. This PR fix that.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3049\nHow was this patch tested?\nUt already exists", "createdAt": "2020-02-24T07:54:13Z", "url": "https://github.com/apache/ozone/pull/590", "merged": true, "mergeCommit": {"oid": "bb9933c96941a57b51832c7e1bd4a4667090eeb5"}, "closed": true, "closedAt": "2020-03-02T10:35:26Z", "author": {"login": "captainzmc"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHZ6FEgFqTM2MzIzODEzNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcJUJabgH2gAyMzc4ODUyNDI5OjQ4OGRjMmM0ZmE5NDdhZWU1ODc1YTZiMWQ3MDY5ZTIwYTZmNTVkZWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMjM4MTM0", "url": "https://github.com/apache/ozone/pull/590#pullrequestreview-363238134", "createdAt": "2020-02-24T09:03:14Z", "commit": {"oid": "3c9fc7fa4ca9be5bec2d865d5f9c93d68a49cdd3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwOTowMzoxNFrOFtZKRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwOTowMzoxNFrOFtZKRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE0MjQ2OQ==", "bodyText": "replicationFactor can now be a local variable.", "url": "https://github.com/apache/ozone/pull/590#discussion_r383142469", "createdAt": "2020-02-24T09:03:14Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneClientAdapterImpl.java", "diffHunk": "@@ -210,10 +210,14 @@ protected void incrementCounter(Statistic objectsRead) {\n   }\n \n   @Override\n-  public OzoneFSOutputStream createFile(String key, boolean overWrite,\n+  public OzoneFSOutputStream createFile(String key, short replication, boolean overWrite,\n       boolean recursive) throws IOException {\n     incrementCounter(Statistic.OBJECTS_CREATED);\n     try {\n+      if (replication == ReplicationFactor.ONE.getValue()\n+          || replication == ReplicationFactor.THREE.getValue()) {\n+        replicationFactor = ReplicationFactor.valueOf(replication);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c9fc7fa4ca9be5bec2d865d5f9c93d68a49cdd3"}, "originalPosition": 11}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb2d012bcc0c4b034783c79ee1b217636e07bb10", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/eb2d012bcc0c4b034783c79ee1b217636e07bb10", "committedDate": "2020-02-25T10:17:42Z", "message": "fix review issue"}, "afterCommit": {"oid": "2b2de7c2baa66b9ae9061d62138519333811062a", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/2b2de7c2baa66b9ae9061d62138519333811062a", "committedDate": "2020-02-25T10:29:47Z", "message": "fix review issue"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2b2de7c2baa66b9ae9061d62138519333811062a", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/2b2de7c2baa66b9ae9061d62138519333811062a", "committedDate": "2020-02-25T10:29:47Z", "message": "fix review issue"}, "afterCommit": {"oid": "474a8cc992ea3b359e8cd27a1cf84f6cc3ca5df1", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/474a8cc992ea3b359e8cd27a1cf84f6cc3ca5df1", "committedDate": "2020-02-25T10:47:24Z", "message": "fix review issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NzAwODYz", "url": "https://github.com/apache/ozone/pull/590#pullrequestreview-364700863", "createdAt": "2020-02-26T08:33:34Z", "commit": {"oid": "b9daf5814238935596fd5ef9673ac2a469067bd2"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQwODozMzozNFrOFuiHbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQwODozNjoxNFrOFuiMWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMzNzc3NQ==", "bodyText": "Please try to put parameters in the same line. One line one parameter is not recommended.\nSame comment for all the following piece of code.", "url": "https://github.com/apache/ozone/pull/590#discussion_r384337775", "createdAt": "2020-02-26T08:33:34Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneClientAdapterImpl.java", "diffHunk": "@@ -210,13 +210,33 @@ protected void incrementCounter(Statistic objectsRead) {\n   }\n \n   @Override\n-  public OzoneFSOutputStream createFile(String key, boolean overWrite,\n+  public OzoneFSOutputStream createFile(String key,\n+      short replication,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9daf5814238935596fd5ef9673ac2a469067bd2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMzOTAzMg==", "bodyText": "If the replicationFactor is 2, will the bucket create the key using system default replication here?", "url": "https://github.com/apache/ozone/pull/590#discussion_r384339032", "createdAt": "2020-02-26T08:36:14Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneClientAdapterImpl.java", "diffHunk": "@@ -210,13 +210,33 @@ protected void incrementCounter(Statistic objectsRead) {\n   }\n \n   @Override\n-  public OzoneFSOutputStream createFile(String key, boolean overWrite,\n+  public OzoneFSOutputStream createFile(String key,\n+      short replication,\n+      boolean overWrite,\n       boolean recursive) throws IOException {\n     incrementCounter(Statistic.OBJECTS_CREATED);\n     try {\n-      OzoneOutputStream ozoneOutputStream = bucket\n-          .createFile(key, 0, replicationType, replicationFactor, overWrite,\n-              recursive);\n+      OzoneOutputStream ozoneOutputStream = null;\n+      if (replication == ReplicationFactor.ONE.getValue()\n+          || replication == ReplicationFactor.THREE.getValue()) {\n+        ReplicationFactor clientReplication\n+            = ReplicationFactor.valueOf(replication);\n+        ozoneOutputStream = bucket.createFile(\n+            key,\n+            0,\n+            replicationType,\n+            clientReplication,\n+            overWrite,\n+            recursive);\n+      } else {\n+        ozoneOutputStream = bucket.createFile(\n+            key,\n+            0,\n+            replicationType,\n+            replicationFactor,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9daf5814238935596fd5ef9673ac2a469067bd2"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1ODYwNDY1", "url": "https://github.com/apache/ozone/pull/590#pullrequestreview-365860465", "createdAt": "2020-02-27T17:34:39Z", "commit": {"oid": "4690e3a77d66c7b32b7411c884e1b86cfd5ff4ca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc7be77719c602d686beb047a1dfb6b5d8ee143c", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/bc7be77719c602d686beb047a1dfb6b5d8ee143c", "committedDate": "2020-02-28T02:13:13Z", "message": "Fix Replication factor passed in create API doesn't take effect"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4690e3a77d66c7b32b7411c884e1b86cfd5ff4ca", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/4690e3a77d66c7b32b7411c884e1b86cfd5ff4ca", "committedDate": "2020-02-27T02:22:02Z", "message": "Fix review issue"}, "afterCommit": {"oid": "bc7be77719c602d686beb047a1dfb6b5d8ee143c", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/bc7be77719c602d686beb047a1dfb6b5d8ee143c", "committedDate": "2020-02-28T02:13:13Z", "message": "Fix Replication factor passed in create API doesn't take effect"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96eef385ddd13bdcda52e5020e10da663021755c", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/96eef385ddd13bdcda52e5020e10da663021755c", "committedDate": "2020-03-01T06:52:42Z", "message": "Fix review issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "488dc2c4fa947aee5875a6b1d7069e20a6f55ded", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/488dc2c4fa947aee5875a6b1d7069e20a6f55ded", "committedDate": "2020-03-01T07:39:47Z", "message": "Fix IT"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3612, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}