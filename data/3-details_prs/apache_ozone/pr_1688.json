{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM2MzcwNzUy", "number": 1688, "title": "HDDS-3378. OzoneManager group init failed because of incorrect snapshot directory location.", "bodyText": "What changes were proposed in this pull request?\nMake ratis.snapshot.dir do not depend on ozone.om.ratis.storage.dir, so that ozone.om.ratis.storage.dir does not have any other directories.\nAnd also if ratis.storage.dir is not defined, the default we fall back to ozone.metadata.dirs, then we will have ratis.storage.dir as ozone.metadata.dirs + \"/ratis\".\nAnd for older clusters, the directory will be moved to new ratis.snapshot.dir, if snapshot directory exists in ozone.om.ratis.storage.dir.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3378\nPlease replace this section with the link to the Apache JIRA)\nHow was this patch tested?\nExisting tests.", "createdAt": "2020-12-11T00:44:20Z", "url": "https://github.com/apache/ozone/pull/1688", "merged": true, "mergeCommit": {"oid": "7f36990d879da96fb3190d87b8a4deea94f1d61d"}, "closed": true, "closedAt": "2020-12-22T19:45:51Z", "author": {"login": "bharatviswa504"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdlO6e7gH2gAyNTM2MzcwNzUyOjJlZjg0NTEzNTBmZGViYjVmMGRlOGRjMWY3NDc2ZDA4NzIxNzRlODE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdotu3-AH2gAyNTM2MzcwNzUyOjQ3YWFlOTc0MmFjM2Y2NWExM2M2M2Y4YjkzODFmNDk0YzFlY2Y4MTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2ef8451350fdebb5f0de8dc1f7476d0872174e81", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/2ef8451350fdebb5f0de8dc1f7476d0872174e81", "committedDate": "2020-12-11T21:34:59Z", "message": "HDDS-3378. OzoneManager group init failed because of incorrect snapshot directory location."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f404f3d615225d455e315f0611c82c1179bd5b44", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/f404f3d615225d455e315f0611c82c1179bd5b44", "committedDate": "2020-12-11T21:34:59Z", "message": "fix cs and java doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b9f7c9c621d800f180acffc31a0d5abc4c124fe", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/8b9f7c9c621d800f180acffc31a0d5abc4c124fe", "committedDate": "2020-12-11T21:34:59Z", "message": "fix find bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8ee672cc267e398fbd454eb296817cbdde72066", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/a8ee672cc267e398fbd454eb296817cbdde72066", "committedDate": "2020-12-11T21:35:00Z", "message": "add back removed code mistakenly."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a2be63d33532cf0739c45568d2e04578ce70825", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/3a2be63d33532cf0739c45568d2e04578ce70825", "committedDate": "2020-12-11T21:35:00Z", "message": "fix test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30dcd99b20161d573eae94f9e3c04aa2dbd77fa8", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/30dcd99b20161d573eae94f9e3c04aa2dbd77fa8", "committedDate": "2020-12-11T01:49:23Z", "message": "add back removed code mistakenly."}, "afterCommit": {"oid": "3a2be63d33532cf0739c45568d2e04578ce70825", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/3a2be63d33532cf0739c45568d2e04578ce70825", "committedDate": "2020-12-11T21:35:00Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzMDA3NzEx", "url": "https://github.com/apache/ozone/pull/1688#pullrequestreview-553007711", "createdAt": "2020-12-15T22:35:13Z", "commit": {"oid": "3a2be63d33532cf0739c45568d2e04578ce70825"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMjozNToxM1rOIGjEPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQyMjozODowM1rOIGjJ1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzczNjg5Mg==", "bodyText": "Instead of listing the files and trying to find if snapshot subdir exists, why don't we construct the snapshot subdir path and check it that exists and move it.", "url": "https://github.com/apache/ozone/pull/1688#discussion_r543736892", "createdAt": "2020-12-15T22:35:13Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -464,16 +465,33 @@ private OzoneManager(OzoneConfiguration conf) throws IOException,\n             \" must be defined.\");\n       }\n       OmUtils.createOMDir(omRatisDirectory);\n+\n       // Create Ratis snapshot dir\n       omRatisSnapshotDir = OmUtils.createOMDir(\n           OzoneManagerRatisServer.getOMRatisSnapshotDirectory(configuration));\n \n+      // Before starting ratis server check, if previous installation has\n+      // snapshot directory in Ratis storage directory if so, move it to\n+      // snapshot directory.\n+      File[] dirs = new File(omRatisDirectory).listFiles();\n+\n+      if (dirs != null) {\n+        for (File dir : dirs) {\n+          if (dir.isDirectory() && dir.getName().equals(\"snapshot\")) {\n+            FileUtils.moveDirectory(dir.toPath(), omRatisSnapshotDir.toPath());\n+            break;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a2be63d33532cf0739c45568d2e04578ce70825"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzczODMyNg==", "bodyText": "Can we define \"snapshot\" as a constant in OzoneConsts and use that here and in getOMRatisSnapshotDirectory().", "url": "https://github.com/apache/ozone/pull/1688#discussion_r543738326", "createdAt": "2020-12-15T22:38:03Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -464,16 +465,33 @@ private OzoneManager(OzoneConfiguration conf) throws IOException,\n             \" must be defined.\");\n       }\n       OmUtils.createOMDir(omRatisDirectory);\n+\n       // Create Ratis snapshot dir\n       omRatisSnapshotDir = OmUtils.createOMDir(\n           OzoneManagerRatisServer.getOMRatisSnapshotDirectory(configuration));\n \n+      // Before starting ratis server check, if previous installation has\n+      // snapshot directory in Ratis storage directory if so, move it to\n+      // snapshot directory.\n+      File[] dirs = new File(omRatisDirectory).listFiles();\n+\n+      if (dirs != null) {\n+        for (File dir : dirs) {\n+          if (dir.isDirectory() && dir.getName().equals(\"snapshot\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a2be63d33532cf0739c45568d2e04578ce70825"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a554afa491a06a89c6876281bd64891a672b27d", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/5a554afa491a06a89c6876281bd64891a672b27d", "committedDate": "2020-12-16T18:15:26Z", "message": "address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10f8e8766644c89062e831c4e54fc0c28ed4d30f", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/10f8e8766644c89062e831c4e54fc0c28ed4d30f", "committedDate": "2020-12-16T18:17:19Z", "message": "rename by adding prefix OM"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6739f1e12eb0989de4aa61d595c8c8046287cd46", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/6739f1e12eb0989de4aa61d595c8c8046287cd46", "committedDate": "2020-12-16T18:18:57Z", "message": "update config default explanation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56adbaeeb56d05b9efa6eac8ed25e1721381e0d4", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/56adbaeeb56d05b9efa6eac8ed25e1721381e0d4", "committedDate": "2020-12-21T23:24:11Z", "message": "fix review comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NzU0MTI0", "url": "https://github.com/apache/ozone/pull/1688#pullrequestreview-556754124", "createdAt": "2020-12-22T01:00:29Z", "commit": {"oid": "56adbaeeb56d05b9efa6eac8ed25e1721381e0d4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47aae9742ac3f65a13c63f8b9381f494c1ecf810", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/47aae9742ac3f65a13c63f8b9381f494c1ecf810", "committedDate": "2020-12-22T17:11:08Z", "message": "Merge branch 'master' into HDDS-3378"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2092, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}