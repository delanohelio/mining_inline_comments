{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ1NTAyNjAy", "number": 1737, "title": "HDDS-4568. Add SCMContext to SCM HA", "bodyText": "What changes were proposed in this pull request?\nWe want to provide SCMContext, which would be a single source of truth for some key information that is shared across all components within SCM.\nSCMContext holds two kind of key information:\n\nRaftServer related info: isLeader, term.\nSafeMode related info: inSafeMode, preCheckComplete.\n\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4568\nHow was this patch tested?\nCI", "createdAt": "2020-12-25T03:08:22Z", "url": "https://github.com/apache/ozone/pull/1737", "merged": true, "mergeCommit": {"oid": "bb9c68fa410aa7643486062e47c8734e5ed3df8d"}, "closed": true, "closedAt": "2021-01-19T02:27:32Z", "author": {"login": "GlenGeng"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdpwddWgFqTU1ODgzOTEwMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdxY7vfAFqTU3MDYyMDIyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4ODM5MTAw", "url": "https://github.com/apache/ozone/pull/1737#pullrequestreview-558839100", "createdAt": "2020-12-25T22:45:39Z", "commit": {"oid": "ee5e166c956b9bf698102c6ae4ad5ec36ffe7cd6"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNVQyMjo0NTozOVrOILfV6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNVQyMjo1Mzo0MVrOILfYPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxODc2MA==", "bodyText": "This part of a change is contained in master (#1728)", "url": "https://github.com/apache/ozone/pull/1737#discussion_r548918760", "createdAt": "2020-12-25T22:45:39Z", "author": {"login": "amaliujia"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/transport/server/ratis/XceiverServerRatis.java", "diffHunk": "@@ -516,6 +515,15 @@ public RaftServer getServer() {\n     return server;\n   }\n \n+  public RaftServer.Division getServerDivision() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee5e166c956b9bf698102c6ae4ad5ec36ffe7cd6"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODkxOTM1OQ==", "bodyText": "Will it make sense to use SCMContext to get current term?", "url": "https://github.com/apache/ozone/pull/1737#discussion_r548919359", "createdAt": "2020-12-25T22:53:41Z", "author": {"login": "amaliujia"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMStateMachine.java", "diffHunk": "@@ -89,4 +103,27 @@ private Message process(final SCMRatisRequest request)\n     }\n   }\n \n+  @Override\n+  public void notifyNotLeader(Collection<TransactionContext> pendingEntries) {\n+    LOG.info(\"current leader SCM steps down.\");\n+    scm.getScmContext().updateIsLeaderAndTerm(false, 0);\n+  }\n+\n+  @Override\n+  public void notifyLeaderChanged(RaftGroupMemberId groupMemberId,\n+                                  RaftPeerId newLeaderId) {\n+    if (!groupMemberId.getPeerId().equals(newLeaderId)) {\n+      LOG.info(\"leader changed, yet current SCM is still follower.\");\n+      return;\n+    }\n+\n+    long term = scm.getScmHAManager()\n+        .getRatisServer()\n+        .getDivision()\n+        .getInfo()\n+        .getCurrentTerm();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee5e166c956b9bf698102c6ae4ad5ec36ffe7cd6"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwNjE3NTYx", "url": "https://github.com/apache/ozone/pull/1737#pullrequestreview-560617561", "createdAt": "2021-01-02T03:00:31Z", "commit": {"oid": "ee5e166c956b9bf698102c6ae4ad5ec36ffe7cd6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wMlQwMzowMDozMVrOINUVOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wMlQwMzowMDozMVrOINUVOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDgzNTUxNA==", "bodyText": "Could we also catch the NotLeaderException like other places does?  There are some other places we don't catch this exception that is swallowed by IOException.\n        } catch (NotLeaderException nle) {\n\n        }  catch (IOException e) {\n          // We may tolerate a number of failures for sometime\n          // but if it continues to fail, at some point we need to raise\n          // an exception and probably fail the SCM ? At present, it simply\n          // continues to retry the scanning.\n          LOG.error(\"Failed to get block deletion transactions from delTX log\",\n              e);\n          return EmptyTaskResult.newResult();\n        }", "url": "https://github.com/apache/ozone/pull/1737#discussion_r550835514", "createdAt": "2021-01-02T03:00:31Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/block/SCMBlockDeletingService.java", "diffHunk": "@@ -146,9 +151,10 @@ public EmptyTaskResult call() throws Exception {\n               // We should stop caching new commands if num of un-processed\n               // command is bigger than a limit, e.g 50. In case datanode goes\n               // offline for sometime, the cached commands be flooded.\n+              SCMCommand<?> command = new DeleteBlocksCommand(dnTXs);\n+              command.setTerm(scmContext.getTerm());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee5e166c956b9bf698102c6ae4ad5ec36ffe7cd6"}, "originalPosition": 46}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ee5e166c956b9bf698102c6ae4ad5ec36ffe7cd6", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/ee5e166c956b9bf698102c6ae4ad5ec36ffe7cd6", "committedDate": "2020-12-25T03:05:17Z", "message": "HDDS-4568: add UT"}, "afterCommit": {"oid": "369efc5c662b6cd10313664fd711acf97f2d904a", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/369efc5c662b6cd10313664fd711acf97f2d904a", "committedDate": "2021-01-06T11:30:18Z", "message": "HDDS-4568: add UT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d57a79aeba0528951a8ae2a2c5a4b0ea424c19a7", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/d57a79aeba0528951a8ae2a2c5a4b0ea424c19a7", "committedDate": "2021-01-12T07:19:40Z", "message": "HDDS-4568: SCMContext Part 1: Raft Related Info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b91c678f56ab2893bd0998039d5e155d432b2b44", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/b91c678f56ab2893bd0998039d5e155d432b2b44", "committedDate": "2021-01-12T07:19:43Z", "message": "HDDS-4568: SCMContext Part 2: SafeMode Related Info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ea79af1e0fac8c84cf4f3d24b3e6af14f18ab06", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/4ea79af1e0fac8c84cf4f3d24b3e6af14f18ab06", "committedDate": "2021-01-12T07:19:43Z", "message": "HDDS-4568: add UT"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "369efc5c662b6cd10313664fd711acf97f2d904a", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/369efc5c662b6cd10313664fd711acf97f2d904a", "committedDate": "2021-01-06T11:30:18Z", "message": "HDDS-4568: add UT"}, "afterCommit": {"oid": "4ea79af1e0fac8c84cf4f3d24b3e6af14f18ab06", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/4ea79af1e0fac8c84cf4f3d24b3e6af14f18ab06", "committedDate": "2021-01-12T07:19:43Z", "message": "HDDS-4568: add UT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b38236c86bcbd16cb41bdf35281c229542b2fc94", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/b38236c86bcbd16cb41bdf35281c229542b2fc94", "committedDate": "2021-01-12T10:40:25Z", "message": "HDDS-4568: Fix comments and failed tests."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b358bfc0c95449eeb4ff893cfd0c335561f67b0a", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/b358bfc0c95449eeb4ff893cfd0c335561f67b0a", "committedDate": "2021-01-12T08:49:00Z", "message": "HDDS-4568: Fix comments and failed UT."}, "afterCommit": {"oid": "b38236c86bcbd16cb41bdf35281c229542b2fc94", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/b38236c86bcbd16cb41bdf35281c229542b2fc94", "committedDate": "2021-01-12T10:40:25Z", "message": "HDDS-4568: Fix comments and failed tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY2OTA1NTc1", "url": "https://github.com/apache/ozone/pull/1737#pullrequestreview-566905575", "createdAt": "2021-01-13T05:38:05Z", "commit": {"oid": "b38236c86bcbd16cb41bdf35281c229542b2fc94"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QwNTozODowNVrOISgQJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QwNTozODowNVrOISgQJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjI3MzcwMg==", "bodyText": "Nit: will it better to replace constructor by a builder for creating instances of SCMContext? It could improve readability when constructing a SCMContext. E.g. setting as a follower for SCMContext versus setting as a leader, a setLeader(true/false) is more understandable. Also using constructor with multiple parameters  in multiple places is a signal to use builder pattern.", "url": "https://github.com/apache/ozone/pull/1737#discussion_r556273702", "createdAt": "2021-01-13T05:38:05Z", "author": {"login": "amaliujia"}, "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/TestSCMContext.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm.ha;\n+\n+import org.apache.hadoop.hdds.scm.safemode.SCMSafeModeManager.SafeModeStatus;\n+import org.apache.ratis.protocol.exceptions.NotLeaderException;\n+import org.junit.Test;\n+\n+import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.fail;\n+\n+/**\n+ * Test for SCMContext.\n+ */\n+public class TestSCMContext {\n+  @Test\n+  public void testRaftOperations() {\n+    // start as follower\n+    SCMContext scmContext = new SCMContext(false, 0, null, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b38236c86bcbd16cb41bdf35281c229542b2fc94"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY2OTA2NjMy", "url": "https://github.com/apache/ozone/pull/1737#pullrequestreview-566906632", "createdAt": "2021-01-13T05:41:12Z", "commit": {"oid": "b38236c86bcbd16cb41bdf35281c229542b2fc94"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY4MDEzMzQ5", "url": "https://github.com/apache/ozone/pull/1737#pullrequestreview-568013349", "createdAt": "2021-01-14T08:37:40Z", "commit": {"oid": "b38236c86bcbd16cb41bdf35281c229542b2fc94"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcwNjIwMjIw", "url": "https://github.com/apache/ozone/pull/1737#pullrequestreview-570620220", "createdAt": "2021-01-18T16:02:30Z", "commit": {"oid": "b38236c86bcbd16cb41bdf35281c229542b2fc94"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1915, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}