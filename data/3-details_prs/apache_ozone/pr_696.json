{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwNjc5MDY0", "number": 696, "title": "HDDS-3056. Allow users to list volumes they have access to, and optionally allow all users to list all volumes", "bodyText": "What changes were proposed in this pull request?\nOptionally allow non-admin users to list all volumes.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3056\nHow was this patch tested?\nNOTE: The info below might be a bit out-dated. Need to double check.\nTested manually in ozonesecure docker-compose.\ntestuser is an admin user (listed in ozone.administrators), testuser2 is a non-admin user.\n\n\n\n\nBefore\nAfter (ACL disabled)\nAfter (ACL enabled)\n\n\n\n\nozone sh volume list\nLists volumes owned by user\nLists volumes owned by user\nLists volumes that user has ACL LIST to.\n\n\nozone sh volume list --all\nn/a\nLists all volumes if ozone.om.volume.listall.allowed is true; if false, only admins can list all volumes, non-admin will get OmException with PERMISSION_DENIED.\nSame as ACL disabled.\n\n\n\nAfter the patch (non-admin can list all volumes)\nbash-4.2$ kinit -kt /etc/security/keytabs/testuser.keytab testuser/scm@EXAMPLE.COM\nbash-4.2$ klist\nTicket cache: FILE:/tmp/krb5cc_1000\nDefault principal: testuser/scm@EXAMPLE.COM\n\nValid starting     Expires            Service principal\n03/18/20 21:20:25  03/19/20 21:20:25  krbtgt/EXAMPLE.COM@EXAMPLE.COM\n\trenew until 03/25/20 21:20:25\nbash-4.2$ ozone sh volume create vol1\nbash-4.2$ ozone sh volume list\n{\n  \"metadata\" : { },\n  \"name\" : \"vol1\",\n  \"admin\" : \"root\",\n  \"owner\" : \"testuser/scm@EXAMPLE.COM\",\n...\nbash-4.2$ kdestroy\nbash-4.2$ kinit -kt /etc/security/keytabs/testuser2.keytab testuser2/scm@EXAMPLE.COM\nbash-4.2$ ozone sh volume list --all\n{\n  \"metadata\" : { },\n  \"name\" : \"vol1\",\n  \"admin\" : \"root\",\n  \"owner\" : \"testuser/scm@EXAMPLE.COM\",\n  \"creationTime\" : \"2020-03-18T21:20:35.370Z\",\n...\nFor comparison, before the patch (non-admin can't list all volumes)\n# kinit'ed as testuser2 (non-admin)\nbash-4.2$ ozone sh volume list --all\nPERMISSION_DENIED org.apache.hadoop.ozone.om.exceptions.OMException: Only admin users are authorized to create or list Ozone volumes.\nbash-4.2$ klist\nTicket cache: FILE:/tmp/krb5cc_1000\nDefault principal: testuser2/scm@EXAMPLE.COM\n\nValid starting     Expires            Service principal\n03/18/20 21:15:34  03/19/20 21:15:34  krbtgt/EXAMPLE.COM@EXAMPLE.COM\n\trenew until 03/25/20 21:15:34", "createdAt": "2020-03-18T21:40:14Z", "url": "https://github.com/apache/ozone/pull/696", "merged": true, "mergeCommit": {"oid": "091993bc7186a89265286a0a5773c4b67cb19f94"}, "closed": true, "closedAt": "2020-04-21T19:42:53Z", "author": {"login": "smengcl"}, "timelineItems": {"totalCount": 37, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPEVLfAFqTM3NzQxODczMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZnOwKABqjMyNTM4NzI5MjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NDE4NzMy", "url": "https://github.com/apache/ozone/pull/696#pullrequestreview-377418732", "createdAt": "2020-03-19T04:37:42Z", "commit": {"oid": "07b4516fc95a27f8600a932db6cc3f1e690d4b46"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNzI5NzI5", "url": "https://github.com/apache/ozone/pull/696#pullrequestreview-380729729", "createdAt": "2020-03-24T22:03:07Z", "commit": {"oid": "f732a8c1a95c4dae209ec8aae5261101ef8de57b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMjowMzowN1rOF7EziQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMjowMzowN1rOF7EziQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ4OTAzMw==", "bodyText": "Remove .user", "url": "https://github.com/apache/ozone/pull/696#discussion_r397489033", "createdAt": "2020-03-24T22:03:07Z", "author": {"login": "smengcl"}, "path": "hadoop-hdds/common/src/main/resources/ozone-default.xml", "diffHunk": "@@ -583,6 +583,16 @@\n       metadata to be cached in memory. This makes OM operations faster.\n     </description>\n   </property>\n+  <property>\n+    <name>ozone.om.user.volume.listall.allowed</name>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f732a8c1a95c4dae209ec8aae5261101ef8de57b"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cf12998f7ade118e1e274f4451bfa8b446d62e5a", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/cf12998f7ade118e1e274f4451bfa8b446d62e5a", "committedDate": "2020-03-25T17:04:04Z", "message": "Remove unused imports."}, "afterCommit": {"oid": "e880d579718c576c7e548cc4d73d15f26a196e49", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/e880d579718c576c7e548cc4d73d15f26a196e49", "committedDate": "2020-03-27T17:15:28Z", "message": "Remove unused imports."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MTM1NDQ5", "url": "https://github.com/apache/ozone/pull/696#pullrequestreview-385135449", "createdAt": "2020-03-31T21:59:53Z", "commit": {"oid": "e880d579718c576c7e548cc4d73d15f26a196e49"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMTo1OTo1M1rOF-pzVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMTo1OTo1M1rOF-pzVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0MDkxOA==", "bodyText": "Remove _USER.", "url": "https://github.com/apache/ozone/pull/696#discussion_r401240918", "createdAt": "2020-03-31T21:59:53Z", "author": {"login": "smengcl"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/OMConfigKeys.java", "diffHunk": "@@ -76,6 +76,10 @@ private OMConfigKeys() {\n       \"ozone.om.db.cache.size.mb\";\n   public static final int OZONE_OM_DB_CACHE_SIZE_DEFAULT = 128;\n \n+  public static final String OZONE_OM_USER_VOLUME_LISTALL_ALLOWED =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e880d579718c576c7e548cc4d73d15f26a196e49"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MTM3OTI1", "url": "https://github.com/apache/ozone/pull/696#pullrequestreview-385137925", "createdAt": "2020-03-31T22:04:36Z", "commit": {"oid": "e880d579718c576c7e548cc4d73d15f26a196e49"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMjowNDozNlrOF-p7Gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMjowNDozNlrOF-p7Gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0MjkwNg==", "bodyText": "Remove log", "url": "https://github.com/apache/ozone/pull/696#discussion_r401242906", "createdAt": "2020-03-31T22:04:36Z", "author": {"login": "smengcl"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -1819,7 +1823,30 @@ public void deleteVolume(String volume) throws IOException {\n     auditMap.put(OzoneConsts.USERNAME, userName);\n     try {\n       metrics.incNumVolumeLists();\n-      return volumeManager.listVolumes(userName, prefix, prevKey, maxKeys);\n+      if (isAclEnabled) {\n+        if (LOG.isDebugEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e880d579718c576c7e548cc4d73d15f26a196e49"}, "originalPosition": 99}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MTQwODYw", "url": "https://github.com/apache/ozone/pull/696#pullrequestreview-385140860", "createdAt": "2020-03-31T22:10:30Z", "commit": {"oid": "e880d579718c576c7e548cc4d73d15f26a196e49"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMjoxMDozMFrOF-qFFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMjoxMDozMFrOF-qFFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0NTQ2Mw==", "bodyText": "Use accessAuthorizer.checkAccess", "url": "https://github.com/apache/ozone/pull/696#discussion_r401245463", "createdAt": "2020-03-31T22:10:30Z", "author": {"login": "smengcl"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -1819,7 +1823,30 @@ public void deleteVolume(String volume) throws IOException {\n     auditMap.put(OzoneConsts.USERNAME, userName);\n     try {\n       metrics.incNumVolumeLists();\n-      return volumeManager.listVolumes(userName, prefix, prevKey, maxKeys);\n+      if (isAclEnabled) {\n+        if (LOG.isDebugEnabled()) {\n+          LOG.debug(\"ACL is enabled. Listing volumes accessible by user. \"\n+                  + \"Principal: {}, keytab: {}\",\n+              configuration.get(OZONE_OM_KERBEROS_PRINCIPAL_KEY),\n+              configuration.get(OZONE_OM_KERBEROS_KEYTAB_FILE_KEY));\n+        }\n+        // List all volumes first\n+        List<OmVolumeArgs> listOfAllVolumes = volumeManager.listVolumes(\n+            null, prefix, prevKey, maxKeys);\n+        // Filter all volumes by ACL LIST permission of UGI\n+        return listOfAllVolumes.stream().filter(v -> v.getAclMap()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e880d579718c576c7e548cc4d73d15f26a196e49"}, "originalPosition": 109}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MTQwOTI0", "url": "https://github.com/apache/ozone/pull/696#pullrequestreview-385140924", "createdAt": "2020-03-31T22:10:37Z", "commit": {"oid": "e880d579718c576c7e548cc4d73d15f26a196e49"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMjoxMDozN1rOF-qFRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMjoxMDozN1rOF-qFRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI0NTUxMA==", "bodyText": "Remove log", "url": "https://github.com/apache/ozone/pull/696#discussion_r401245510", "createdAt": "2020-03-31T22:10:37Z", "author": {"login": "smengcl"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -1819,7 +1823,30 @@ public void deleteVolume(String volume) throws IOException {\n     auditMap.put(OzoneConsts.USERNAME, userName);\n     try {\n       metrics.incNumVolumeLists();\n-      return volumeManager.listVolumes(userName, prefix, prevKey, maxKeys);\n+      if (isAclEnabled) {\n+        if (LOG.isDebugEnabled()) {\n+          LOG.debug(\"ACL is enabled. Listing volumes accessible by user. \"\n+                  + \"Principal: {}, keytab: {}\",\n+              configuration.get(OZONE_OM_KERBEROS_PRINCIPAL_KEY),\n+              configuration.get(OZONE_OM_KERBEROS_KEYTAB_FILE_KEY));\n+        }\n+        // List all volumes first\n+        List<OmVolumeArgs> listOfAllVolumes = volumeManager.listVolumes(\n+            null, prefix, prevKey, maxKeys);\n+        // Filter all volumes by ACL LIST permission of UGI\n+        return listOfAllVolumes.stream().filter(v -> v.getAclMap()\n+            .hasAccess(IAccessAuthorizer.ACLType.LIST, remoteUserUgi))\n+            .collect(Collectors.toList());\n+      } else {\n+        if (LOG.isDebugEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e880d579718c576c7e548cc4d73d15f26a196e49"}, "originalPosition": 113}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1OTE5ODcy", "url": "https://github.com/apache/ozone/pull/696#pullrequestreview-385919872", "createdAt": "2020-04-01T20:20:38Z", "commit": {"oid": "e880d579718c576c7e548cc4d73d15f26a196e49"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMDoyMDozOFrOF_RIsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMDoyMDozOFrOF_RIsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg4NTM2Mw==", "bodyText": "Improve the description.", "url": "https://github.com/apache/ozone/pull/696#discussion_r401885363", "createdAt": "2020-04-01T20:20:38Z", "author": {"login": "smengcl"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/web/ozShell/volume/ListVolumeHandler.java", "diffHunk": "@@ -63,6 +63,10 @@\n       description = \"Owner of the volumes to list.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e880d579718c576c7e548cc4d73d15f26a196e49"}, "originalPosition": 1}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6dfe21dc406083f01563cff89b402d2674f4c561", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/6dfe21dc406083f01563cff89b402d2674f4c561", "committedDate": "2020-04-07T21:14:44Z", "message": "Clean up test."}, "afterCommit": {"oid": "acaca3447599e7316e5186ef1bdb772c91b3ceea", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/acaca3447599e7316e5186ef1bdb772c91b3ceea", "committedDate": "2020-04-07T22:45:31Z", "message": "Clean up test."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "acaca3447599e7316e5186ef1bdb772c91b3ceea", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/acaca3447599e7316e5186ef1bdb772c91b3ceea", "committedDate": "2020-04-07T22:45:31Z", "message": "Clean up test."}, "afterCommit": {"oid": "f56ccba8beed3c818f7390dbbf6e8c1a648ffe6b", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/f56ccba8beed3c818f7390dbbf6e8c1a648ffe6b", "committedDate": "2020-04-10T05:27:44Z", "message": "Clean up test."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8de37a133a467b8c9b03ca9defe20b6324f365d8", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/8de37a133a467b8c9b03ca9defe20b6324f365d8", "committedDate": "2020-04-10T09:48:47Z", "message": "Enable TestOzoneManagerListVolumes (do not ignore). Expect failure from timeout due to (suspected) RocksDB not being cleaned up during each mini cluster launch and setup."}, "afterCommit": {"oid": "c85d20bcf31b533c2850dd301ae94a94744a70da", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/c85d20bcf31b533c2850dd301ae94a94744a70da", "committedDate": "2020-04-14T18:18:04Z", "message": "Enable TestOzoneManagerListVolumes (do not ignore). Expect failure from timeout due to (suspected) RocksDB not being cleaned up during each mini cluster launch and setup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c85d20bcf31b533c2850dd301ae94a94744a70da", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/c85d20bcf31b533c2850dd301ae94a94744a70da", "committedDate": "2020-04-14T18:18:04Z", "message": "Enable TestOzoneManagerListVolumes (do not ignore). Expect failure from timeout due to (suspected) RocksDB not being cleaned up during each mini cluster launch and setup."}, "afterCommit": {"oid": "2e3ab3bf1d8a21cb5f98cfb61191884157b944ad", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/2e3ab3bf1d8a21cb5f98cfb61191884157b944ad", "committedDate": "2020-04-15T03:02:14Z", "message": "Enable TestOzoneManagerListVolumes (do not ignore). Expect failure from timeout due to (suspected) RocksDB not being cleaned up during each mini cluster launch and setup."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0OTgwNTc2", "url": "https://github.com/apache/ozone/pull/696#pullrequestreview-394980576", "createdAt": "2020-04-16T20:37:17Z", "commit": {"oid": "3eec9d23d7030f030cd9cbf72f39ca3bbe35592a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMDozNzoxN1rOGG2PLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMDozNzoxN1rOGG2PLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgzMzI2MQ==", "bodyText": "can we wrap the stopCluster inside the try/final block in case the check failure the cluster will be stopped properly.", "url": "https://github.com/apache/ozone/pull/696#discussion_r409833261", "createdAt": "2020-04-16T20:37:17Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/om/TestOzoneManagerListVolumes.java", "diffHunk": "@@ -0,0 +1,238 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.om;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.UUID;\n+\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.ozone.MiniOzoneCluster;\n+import org.apache.hadoop.ozone.OzoneAcl;\n+import org.apache.hadoop.ozone.client.ObjectStore;\n+import org.apache.hadoop.ozone.client.OzoneClient;\n+import org.apache.hadoop.ozone.client.OzoneVolume;\n+import org.apache.hadoop.ozone.client.protocol.ClientProtocol;\n+import org.apache.hadoop.ozone.om.exceptions.OMException;\n+import org.apache.hadoop.ozone.security.acl.OzoneObj;\n+import org.apache.hadoop.ozone.security.acl.OzoneObjInfo;\n+import org.apache.hadoop.security.UserGroupInformation;\n+\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.OZONE_SCM_RATIS_PIPELINE_LIMIT;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.OZONE_ACL_AUTHORIZER_CLASS;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.OZONE_ACL_AUTHORIZER_CLASS_NATIVE;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.OZONE_ACL_ENABLED;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.OZONE_ADMINISTRATORS;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.OZONE_OPEN_KEY_EXPIRE_THRESHOLD_SECONDS;\n+import static org.apache.hadoop.ozone.om.OMConfigKeys.OZONE_OM_VOLUME_LISTALL_ALLOWED;\n+import static org.apache.hadoop.ozone.security.acl.OzoneObj.StoreType.OZONE;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.Timeout;\n+\n+/**\n+ * Test OzoneManager list volume operation under combinations of configs.\n+ */\n+public class TestOzoneManagerListVolumes {\n+\n+  @Rule\n+  public Timeout timeout = new Timeout(120_000);\n+\n+  private UserGroupInformation loginUser;\n+  private UserGroupInformation user1 =\n+      UserGroupInformation.createRemoteUser(\"user1\");  // Admin user\n+  private UserGroupInformation user2 =\n+      UserGroupInformation.createRemoteUser(\"user2\");  // Non-admin user\n+\n+  @Before\n+  public void init() throws Exception {\n+    loginUser = UserGroupInformation.getLoginUser();\n+  }\n+\n+  /**\n+   * Create a MiniDFSCluster for testing.\n+   */\n+  private MiniOzoneCluster startCluster(boolean aclEnabled,\n+      boolean volListAllAllowed) throws Exception {\n+\n+    OzoneConfiguration conf = new OzoneConfiguration();\n+    String clusterId = UUID.randomUUID().toString();\n+    String scmId = UUID.randomUUID().toString();\n+    String omId = UUID.randomUUID().toString();\n+    conf.setInt(OZONE_OPEN_KEY_EXPIRE_THRESHOLD_SECONDS, 2);\n+    conf.set(OZONE_ADMINISTRATORS, \"user1\");\n+    conf.setInt(OZONE_SCM_RATIS_PIPELINE_LIMIT, 10);\n+\n+    // Use native impl here, default impl doesn't do actual checks\n+    conf.set(OZONE_ACL_AUTHORIZER_CLASS, OZONE_ACL_AUTHORIZER_CLASS_NATIVE);\n+    // Note: OM doesn't support live config reloading\n+    conf.setBoolean(OZONE_ACL_ENABLED, aclEnabled);\n+    conf.setBoolean(OZONE_OM_VOLUME_LISTALL_ALLOWED, volListAllAllowed);\n+\n+    MiniOzoneCluster cluster = MiniOzoneCluster.newBuilder(conf)\n+        .setClusterId(clusterId).setScmId(scmId).setOmId(omId).build();\n+    cluster.waitForClusterToBeReady();\n+\n+    // loginUser is the user running this test.\n+    // Implication: loginUser is automatically added to the OM admin list.\n+    UserGroupInformation.setLoginUser(loginUser);\n+    // Create volumes with non-default owners and ACLs\n+    OzoneClient client = cluster.getClient();\n+    ObjectStore objectStore = client.getObjectStore();\n+\n+    /* r = READ, w = WRITE, c = CREATE, d = DELETE\n+       l = LIST, a = ALL, n = NONE, x = READ_ACL, y = WRITE_ACL */\n+    String aclUser1All = \"user:user1:a\";\n+    String aclUser2All = \"user:user2:a\";\n+    String aclWorldAll = \"world::a\";\n+    createVolumeWithOwnerAndAcl(objectStore, \"volume1\", \"user1\", aclUser1All);\n+    createVolumeWithOwnerAndAcl(objectStore, \"volume2\", \"user2\", aclUser2All);\n+    createVolumeWithOwnerAndAcl(objectStore, \"volume3\", \"user1\", aclUser2All);\n+    createVolumeWithOwnerAndAcl(objectStore, \"volume4\", \"user2\", aclUser1All);\n+    createVolumeWithOwnerAndAcl(objectStore, \"volume5\", \"user1\", aclWorldAll);\n+\n+    return cluster;\n+  }\n+\n+  private void stopCluster(MiniOzoneCluster cluster) {\n+    if (cluster != null) {\n+      cluster.shutdown();\n+    }\n+  }\n+\n+  private void createVolumeWithOwnerAndAcl(ObjectStore objectStore,\n+      String volumeName, String ownerName, String aclString)\n+      throws IOException {\n+    ClientProtocol proxy = objectStore.getClientProxy();\n+    objectStore.createVolume(volumeName);\n+    proxy.setVolumeOwner(volumeName, ownerName);\n+    setVolumeAcl(objectStore, volumeName, aclString);\n+  }\n+\n+  /**\n+   * Helper function to set volume ACL.\n+   */\n+  private void setVolumeAcl(ObjectStore objectStore, String volumeName,\n+      String aclString) throws IOException {\n+    OzoneObj obj = OzoneObjInfo.Builder.newBuilder().setVolumeName(volumeName)\n+        .setResType(OzoneObj.ResourceType.VOLUME).setStoreType(OZONE).build();\n+    Assert.assertTrue(objectStore.setAcl(obj, OzoneAcl.parseAcls(aclString)));\n+  }\n+\n+  /**\n+   * Helper function to reduce code redundancy for test checks with each user\n+   * under different config combination.\n+   */\n+  private void checkUser(MiniOzoneCluster cluster, UserGroupInformation user,\n+      List<String> expectVol, boolean expectListAllSuccess) throws IOException {\n+\n+    UserGroupInformation.setLoginUser(user);\n+    OzoneClient client = cluster.getClient();\n+    ObjectStore objectStore = client.getObjectStore();\n+\n+    // `ozone sh volume list` shall return volumes with LIST permission of user.\n+    Iterator<? extends OzoneVolume> it = objectStore.listVolumesByUser(\n+        null, \"\", \"\");\n+    Set<String> accessibleVolumes = new HashSet<>();\n+    while (it.hasNext()) {\n+      OzoneVolume vol = it.next();\n+      String volumeName = vol.getName();\n+      accessibleVolumes.add(volumeName);\n+    }\n+    Assert.assertEquals(new HashSet<>(expectVol), accessibleVolumes);\n+\n+    // `ozone sh volume list --all` returns all volumes,\n+    //  or throws exception (for non-admin if acl enabled & listall disallowed).\n+    if (expectListAllSuccess) {\n+      it = objectStore.listVolumes(\"volume\");\n+      int count = 0;\n+      while (it.hasNext()) {\n+        it.next();\n+        count++;\n+      }\n+      Assert.assertEquals(5, count);\n+    } else {\n+      try {\n+        objectStore.listVolumes(\"volume\");\n+        Assert.fail(\"listAllVolumes should fail for \" + user.getUserName());\n+      } catch (RuntimeException ex) {\n+        // Current listAllVolumes throws RuntimeException\n+        if (ex.getCause() instanceof OMException) {\n+          // Expect PERMISSION_DENIED\n+          if (((OMException) ex.getCause()).getResult() !=\n+              OMException.ResultCodes.PERMISSION_DENIED) {\n+            throw ex;\n+          }\n+        } else {\n+          throw ex;\n+        }\n+      }\n+    }\n+  }\n+\n+  @Test\n+  public void testAclEnabledListAllAllowed() throws Exception {\n+    // ozone.acl.enabled = true, ozone.om.volume.listall.allowed = true\n+    MiniOzoneCluster cluster = startCluster(true, true);\n+    checkUser(cluster, user1, Arrays.asList(\"volume1\", \"volume4\", \"volume5\"),\n+        true);\n+    checkUser(cluster, user2, Arrays.asList(\"volume2\", \"volume3\", \"volume5\"),\n+        true);\n+    stopCluster(cluster);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eec9d23d7030f030cd9cbf72f39ca3bbe35592a"}, "originalPosition": 203}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0OTgyNDM0", "url": "https://github.com/apache/ozone/pull/696#pullrequestreview-394982434", "createdAt": "2020-04-16T20:40:20Z", "commit": {"oid": "3eec9d23d7030f030cd9cbf72f39ca3bbe35592a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMDo0MDoyMFrOGG2Vsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQyMDo0MDoyMFrOGG2Vsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgzNDkzMQ==", "bodyText": "Do we really need a write lock for list volume operation?", "url": "https://github.com/apache/ozone/pull/696#discussion_r409834931", "createdAt": "2020-04-16T20:40:20Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/VolumeManagerImpl.java", "diffHunk": "@@ -453,23 +449,11 @@ public boolean checkVolumeAccess(String volume, OzoneAclInfo userAcl)\n   @Override\n   public List<OmVolumeArgs> listVolumes(String userName,\n       String prefix, String startKey, int maxKeys) throws IOException {\n-    metadataManager.getLock().acquireLock(USER_LOCK, userName);\n+    metadataManager.getLock().acquireWriteLock(USER_LOCK, userName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eec9d23d7030f030cd9cbf72f39ca3bbe35592a"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0OTgyODM2", "url": "https://github.com/apache/ozone/pull/696#pullrequestreview-394982836", "createdAt": "2020-04-16T20:40:57Z", "commit": {"oid": "3eec9d23d7030f030cd9cbf72f39ca3bbe35592a"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e629b675ecd0f22e967d34a4669221b95cc5c75e", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/e629b675ecd0f22e967d34a4669221b95cc5c75e", "committedDate": "2020-04-18T23:57:32Z", "message": "Revert the lock change to see if this is related to test failure."}, "afterCommit": {"oid": "da737d3b23844cfb125b4f583faef68d9f806674", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/da737d3b23844cfb125b4f583faef68d9f806674", "committedDate": "2020-04-20T15:13:33Z", "message": "Use read lock for listVolumes in VolumeManagerImpl."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fb402706bbba41de877349a9ca089c740d53c51", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/7fb402706bbba41de877349a9ca089c740d53c51", "committedDate": "2020-04-20T22:56:24Z", "message": "Remove admin check for listVolumes so every user can list all volumes via OM."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00b4d86f36ec9c3476d9adcea0faf633cc52528e", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/00b4d86f36ec9c3476d9adcea0faf633cc52528e", "committedDate": "2020-04-20T22:56:25Z", "message": "Add new option `--all` for `ozone sh volume list` so users can list all volumes via Ozone shell."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "693adb194ab5ea9cad1f369ae579968c7152530c", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/693adb194ab5ea9cad1f369ae579968c7152530c", "committedDate": "2020-04-20T22:56:25Z", "message": "Add new config key that optionally allows everyone to list all volumes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1128faf0de430eee9b143e1080d484ba9baf3610", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/1128faf0de430eee9b143e1080d484ba9baf3610", "committedDate": "2020-04-20T22:56:25Z", "message": "Allow users to list volumes they have access to. accessible = has READ ACL, for now."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c6d759046f0fd1a26012beab1ebc7f3e0c626b1", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/9c6d759046f0fd1a26012beab1ebc7f3e0c626b1", "committedDate": "2020-04-20T22:56:25Z", "message": "Simplify code; Remove filter logic in VolumeManager."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28ceabf2e64b4c73c707e543cbc80edce803c4f7", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/28ceabf2e64b4c73c707e543cbc80edce803c4f7", "committedDate": "2020-04-20T22:56:25Z", "message": "Rename config key ozone.om.user.volume.listall.allowed -> ozone.om.volume.listall.allowed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da9508c57d2b2e3c168f205fef65ff9154697e9a", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/da9508c57d2b2e3c168f205fef65ff9154697e9a", "committedDate": "2020-04-20T22:56:25Z", "message": "Remove unused imports."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d7b0dfd67dfe8a062ff5bc5da4bbb984fc6afc7", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/0d7b0dfd67dfe8a062ff5bc5da4bbb984fc6afc7", "committedDate": "2020-04-20T22:56:25Z", "message": "OZONE_OM_USER_VOLUME_LISTALL_ALLOWED -> OZONE_OM_VOLUME_LISTALL_ALLOWED"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fba10bd50349e6aebb6c6f2b03ab6548aeb16ed8", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/fba10bd50349e6aebb6c6f2b03ab6548aeb16ed8", "committedDate": "2020-04-20T22:56:25Z", "message": "Improve doc for ozone sh volume list."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3dca6e3e4268ade5d37fe6f5d481befefbe909b", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/b3dca6e3e4268ade5d37fe6f5d481befefbe909b", "committedDate": "2020-04-20T22:56:25Z", "message": "Remove unnecessary debug log."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "403ea76e41ad284dd38b13ac7811de55b6c24c4f", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/403ea76e41ad284dd38b13ac7811de55b6c24c4f", "committedDate": "2020-04-20T22:56:25Z", "message": "Use checkAccess; Add new `hasAcls` helper function to check ACL without throwing."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e2bc3880d206cb5763ac4c28a8756779a2ca379", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/2e2bc3880d206cb5763ac4c28a8756779a2ca379", "committedDate": "2020-04-20T22:56:25Z", "message": "Amend the doc."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bed9820fd363e387c948c66d829c0fefe4f18d5", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/7bed9820fd363e387c948c66d829c0fefe4f18d5", "committedDate": "2020-04-20T22:56:25Z", "message": "Remove unused import."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d3bed867cfc541f34ebf4f064e2a976c5390a80", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/4d3bed867cfc541f34ebf4f064e2a976c5390a80", "committedDate": "2020-04-20T22:56:25Z", "message": "OZONE_OM_USER_VOLUME_LISTALL_ALLOWED_DEFAULT -> OZONE_OM_VOLUME_LISTALL_ALLOWED_DEFAULT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2927378f96f7bb9e5805fa3c56813135d6abdbc", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/c2927378f96f7bb9e5805fa3c56813135d6abdbc", "committedDate": "2020-04-20T22:56:25Z", "message": "Duplicate TestOzoneManagerRestart -> TestOzoneManagerListVolumes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da604505ee85b2c2bfeccd96e9bd8503ba0e7497", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/da604505ee85b2c2bfeccd96e9bd8503ba0e7497", "committedDate": "2020-04-20T22:56:25Z", "message": "Add integration tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d5189419d332fee1fcd4600864f299455c1a83b", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/7d5189419d332fee1fcd4600864f299455c1a83b", "committedDate": "2020-04-20T22:56:25Z", "message": "Clean up test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9445c5c2c6038991a746faaaf657db3835b96444", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/9445c5c2c6038991a746faaaf657db3835b96444", "committedDate": "2020-04-20T22:56:25Z", "message": "Enable TestOzoneManagerListVolumes (do not ignore). Expect failure from timeout due to (suspected) RocksDB not being cleaned up during each mini cluster launch and setup."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "139858462f4363c6d6f9787282f28ffaa88f4c5c", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/139858462f4363c6d6f9787282f28ffaa88f4c5c", "committedDate": "2020-04-20T22:56:25Z", "message": "Retest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4a8817a6523a14f1293d6509e64e45dc2d775bc", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/f4a8817a6523a14f1293d6509e64e45dc2d775bc", "committedDate": "2020-04-20T22:56:25Z", "message": "Use read lock for listVolumes in VolumeManagerImpl."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da737d3b23844cfb125b4f583faef68d9f806674", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/da737d3b23844cfb125b4f583faef68d9f806674", "committedDate": "2020-04-20T15:13:33Z", "message": "Use read lock for listVolumes in VolumeManagerImpl."}, "afterCommit": {"oid": "f4a8817a6523a14f1293d6509e64e45dc2d775bc", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/f4a8817a6523a14f1293d6509e64e45dc2d775bc", "committedDate": "2020-04-20T22:56:25Z", "message": "Use read lock for listVolumes in VolumeManagerImpl."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3502, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}