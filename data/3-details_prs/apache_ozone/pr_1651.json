{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMzQwODky", "number": 1651, "title": "HDDS-4178. SCM Finalize client command implementation", "bodyText": "What changes were proposed in this pull request?\nSCM Finalize client command implementation\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4178\nHow was this patch tested?\nUT. I will fix CI failures.", "createdAt": "2020-12-02T22:58:18Z", "url": "https://github.com/apache/ozone/pull/1651", "merged": true, "mergeCommit": {"oid": "6519142ca92c04989f107f4eb75fb129d3050102"}, "closed": true, "closedAt": "2020-12-14T22:52:07Z", "author": {"login": "prashantpogde"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiXtxGABqjQwNjQ5Mjc1NTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmJjbaAFqTU1MTcyMzMxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "90e68d91ea57900e1f636de5d14089b26fe2ba42", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/90e68d91ea57900e1f636de5d14089b26fe2ba42", "committedDate": "2020-12-02T22:59:56Z", "message": "Merge branch 'HDDS-3698-upgrade' into HDDS-4178"}, "afterCommit": {"oid": "3b3027b09b6120539bbfb8598d786cb7daed633a", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/3b3027b09b6120539bbfb8598d786cb7daed633a", "committedDate": "2020-12-03T00:07:46Z", "message": "HDDS-4178. SCM Finalize command implementation."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f667c2b442b71c9b8f093c667dc2cb8b01a49648", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/f667c2b442b71c9b8f093c667dc2cb8b01a49648", "committedDate": "2020-12-03T00:09:20Z", "message": "Merge branch 'HDDS-3698-upgrade' into HDDS-4178"}, "afterCommit": {"oid": "ca7bf9f4bddb37c5b24a845acd4dcd8764918650", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/ca7bf9f4bddb37c5b24a845acd4dcd8764918650", "committedDate": "2020-12-04T02:36:11Z", "message": "HDDS-4178. SCM Finalize command implementation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca7bf9f4bddb37c5b24a845acd4dcd8764918650", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/ca7bf9f4bddb37c5b24a845acd4dcd8764918650", "committedDate": "2020-12-04T02:36:11Z", "message": "HDDS-4178. SCM Finalize command implementation."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1Mjk0NTkz", "url": "https://github.com/apache/ozone/pull/1651#pullrequestreview-545294593", "createdAt": "2020-12-04T21:03:27Z", "commit": {"oid": "ca7bf9f4bddb37c5b24a845acd4dcd8764918650"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMTowMzoyN1rOH_h7EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMToyMDozN1rOH_iadg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM3ODEyOA==", "bodyText": "Nit. Can be UpgradeFinalizer<StorageContainerManager>.", "url": "https://github.com/apache/ozone/pull/1651#discussion_r536378128", "createdAt": "2020-12-04T21:03:27Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/StorageContainerManager.java", "diffHunk": "@@ -211,6 +214,7 @@\n   private PipelineChoosePolicy pipelineChoosePolicy;\n \n   private HDDSLayoutVersionManager scmLayoutVersionManager;\n+  private UpgradeFinalizer upgradeFinalizer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca7bf9f4bddb37c5b24a845acd4dcd8764918650"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM3OTUxNQ==", "bodyText": "Why do we need ScmSubCommand to extend FinalizeUpgradeBaseCommand? Shouldn't the inheritance be the other way?", "url": "https://github.com/apache/ozone/pull/1651#discussion_r536379515", "createdAt": "2020-12-04T21:06:30Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/ScmSubcommand.java", "diffHunk": "@@ -17,21 +17,25 @@\n  */\n package org.apache.hadoop.hdds.scm.cli;\n \n+import org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeBaseCommand;\n import org.apache.hadoop.hdds.scm.client.ScmClient;\n import picocli.CommandLine;\n \n import java.io.IOException;\n import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n \n /**\n  * Base class for admin commands that connect via SCM client.\n  */\n-public abstract class ScmSubcommand implements Callable<Void> {\n+public abstract class ScmSubcommand extends FinalizeUpgradeBaseCommand", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca7bf9f4bddb37c5b24a845acd4dcd8764918650"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM4NjE2Ng==", "bodyText": "With this patch I see the CLI different for OM and SCM.\nFor SCM, it is something like ozone admin upgrade FinalizeSCM\nFor OM, it is ozone admin om finalizeupgrade\nCan we make sure it is common across OM and SCM? I believe the following are OK ->\nozone admin om/scm finalizeupgrade\nozone admin upgrade finalize-om-upgrade/finalize-scm-upgrade\nIn Ozone, the convention is to have CLI operations use lower case with \"-\" between words as needed.", "url": "https://github.com/apache/ozone/pull/1651#discussion_r536386166", "createdAt": "2020-12-04T21:20:37Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/upgrade/FinalizeScmUpgradeSubcommand.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm.cli.upgrade;\n+\n+import java.io.IOException;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.scm.cli.ScmSubcommand;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import org.apache.hadoop.ozone.upgrade.UpgradeException;\n+import org.apache.hadoop.ozone.upgrade.UpgradeFinalizer;\n+import org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.StatusAndMessages;\n+\n+import picocli.CommandLine;\n+\n+/**\n+ * Handler of Finalize SCM command.\n+ */\n+@CommandLine.Command(\n+    name = \"FinalizeScm\",\n+    description = \"Finalize SCM Upgrade\",\n+    mixinStandardHelpOptions = true,\n+    versionProvider = HddsVersionProvider.class)\n+\n+public class FinalizeScmUpgradeSubcommand extends ScmSubcommand {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca7bf9f4bddb37c5b24a845acd4dcd8764918650"}, "originalPosition": 48}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ca148f7b35f41420a62a1316577e754208b60b9e", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/ca148f7b35f41420a62a1316577e754208b60b9e", "committedDate": "2020-12-09T22:20:07Z", "message": "HDDS-4178. Addressing review comments."}, "afterCommit": {"oid": "867a4b587f87aa35131ac826e600ed72f58422c6", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/867a4b587f87aa35131ac826e600ed72f58422c6", "committedDate": "2020-12-09T22:24:40Z", "message": "HDDS-4178. Addressing review comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "867a4b587f87aa35131ac826e600ed72f58422c6", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/867a4b587f87aa35131ac826e600ed72f58422c6", "committedDate": "2020-12-09T22:24:40Z", "message": "HDDS-4178. Addressing review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NzA3OTY2", "url": "https://github.com/apache/ozone/pull/1651#pullrequestreview-548707966", "createdAt": "2020-12-09T23:42:55Z", "commit": {"oid": "867a4b587f87aa35131ac826e600ed72f58422c6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMzo0Mjo1NVrOICuoHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMzo0Mjo1NVrOICuoHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTczMTk5Ng==", "bodyText": "If we add here, then OM finalization will also print out the message. Can we print out the message after the actual work is done (freeze pipeline creation, pipelines are closed etc)?", "url": "https://github.com/apache/ozone/pull/1651#discussion_r539731996", "createdAt": "2020-12-09T23:42:55Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/upgrade/BasicUpgradeFinalizer.java", "diffHunk": "@@ -218,14 +218,15 @@ private void persistStorage(Storage config) throws IOException {\n \n   protected void emitNOOPMsg(String feature) {\n     String msg = \"No finalization work defined for feature: \" + feature + \".\";\n-    String msg2 = \"Skipping.\";\n \n     logAndEmit(msg);\n-    logAndEmit(msg2);\n   }\n \n   protected void emitStartingMsg() {\n-    String msg = \"Finalization started.\";\n+    String msg = \"Finalization started.\\n\";\n+    msg += \"Existing pipelines and containers will be closed during Upgrade.\\n\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "867a4b587f87aa35131ac826e600ed72f58422c6"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "09ac829d8f09f8a552d7317c04927359879da8ef", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/09ac829d8f09f8a552d7317c04927359879da8ef", "committedDate": "2020-12-10T01:31:44Z", "message": "HDDS-4178. Addressing review comments : part 2."}, "afterCommit": {"oid": "39bf2c5aedbe2897c81590143d7d7f9c642ed9f1", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/39bf2c5aedbe2897c81590143d7d7f9c642ed9f1", "committedDate": "2020-12-10T18:00:19Z", "message": "HDDS-4178. Addressing review comments : part 2."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39bf2c5aedbe2897c81590143d7d7f9c642ed9f1", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/39bf2c5aedbe2897c81590143d7d7f9c642ed9f1", "committedDate": "2020-12-10T18:00:19Z", "message": "HDDS-4178. Addressing review comments : part 2."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NzE1NDYw", "url": "https://github.com/apache/ozone/pull/1651#pullrequestreview-549715460", "createdAt": "2020-12-11T00:22:54Z", "commit": {"oid": "39bf2c5aedbe2897c81590143d7d7f9c642ed9f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwMDoyMjo1NFrOIDjh2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwMDoyMjo1NFrOIDjh2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU5ODc0NQ==", "bodyText": "I think, here we should just throw the cause of the ExecutionException wrapped into an IOException here.\nI believe it is a better approach, as with that other subcommands are not forced to declare to throw two types of exceptions.\nHowever as an alternative I am absolutely fine with declaring execute to throw an Exception, and do not mark specific Exceptions to be thrown, as the problem I see is the number of exceptions that method needs to declare and seems to declare implicitly for all SCM subcommands.", "url": "https://github.com/apache/ozone/pull/1651#discussion_r540598745", "createdAt": "2020-12-11T00:22:54Z", "author": {"login": "fapifta"}, "path": "hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/upgrade/FinalizeScmUpgradeSubcommand.java", "diffHunk": "@@ -0,0 +1,153 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm.cli.upgrade;\n+\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.emitCancellationMsg;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.emitExitMsg;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.emitFinishedMsg;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.emitGeneralErrorMsg;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.handleInvalidRequestAfterInitiatingFinalization;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.isDone;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.isFinalized;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.isInprogress;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.isStarting;\n+\n+import java.io.IOException;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.scm.cli.ScmSubcommand;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import org.apache.hadoop.ozone.upgrade.UpgradeException;\n+import org.apache.hadoop.ozone.upgrade.UpgradeFinalizer;\n+import org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.StatusAndMessages;\n+\n+import picocli.CommandLine;\n+\n+/**\n+ * Handler of Finalize SCM command.\n+ */\n+@CommandLine.Command(\n+    name = \"finalizeupgrade\",\n+    description = \"Finalize SCM Upgrade\",\n+    mixinStandardHelpOptions = true,\n+    versionProvider = HddsVersionProvider.class)\n+\n+public class FinalizeScmUpgradeSubcommand extends ScmSubcommand {\n+  @CommandLine.Option(\n+      names = {\"--takeover\"},\n+      description = \"Forces takeover of monitoring from another client, if \"\n+          + \"finalization has already been started and did not finish yet.\"\n+  )\n+  private boolean force;\n+\n+  @Override\n+  public void execute(ScmClient scmClient)\n+      throws IOException, ExecutionException {\n+    String upgradeClientID = \"Upgrade-Client-\" + UUID.randomUUID().toString();\n+    try {\n+      StatusAndMessages finalizationResponse =\n+          scmClient.finalizeScmUpgrade(upgradeClientID);\n+      if (isFinalized(finalizationResponse.status())){\n+        System.out.println(\"Upgrade has already been finalized.\");\n+        emitExitMsg();\n+        return;\n+      } else if (!isStarting(finalizationResponse.status())){\n+        System.err.println(\"Invalid response from Storage Container Manager.\");\n+        System.err.println(\n+            \"Current finalization status is: \" + finalizationResponse.status()\n+        );\n+        throw new IOException(\"Exiting...\");\n+      }\n+    } catch (UpgradeException e) {\n+      handleInvalidRequestAfterInitiatingFinalization(force, e);\n+    }\n+    monitorAndWaitFinalization(scmClient, upgradeClientID);\n+    return;\n+  }\n+\n+  private void monitorAndWaitFinalization(ScmClient client,\n+                                          String upgradeClientID) throws\n+      ExecutionException {\n+    ExecutorService exec = Executors.newSingleThreadExecutor();\n+    Future<?> monitor =\n+        exec.submit(new UpgradeMonitor(client, upgradeClientID, force));\n+    try {\n+      monitor.get();\n+      emitFinishedMsg(\"Storage Container Manager\");\n+    } catch (CancellationException |InterruptedException e) {\n+      emitCancellationMsg(\"Storage Container Manager\");\n+    } catch (ExecutionException e) {\n+      emitGeneralErrorMsg();\n+      throw e;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39bf2c5aedbe2897c81590143d7d7f9c642ed9f1"}, "originalPosition": 104}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NzE1NTUy", "url": "https://github.com/apache/ozone/pull/1651#pullrequestreview-549715552", "createdAt": "2020-12-11T00:23:08Z", "commit": {"oid": "39bf2c5aedbe2897c81590143d7d7f9c642ed9f1"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "128ec4a824bb05972a6f524739516361b9bf80d4", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/128ec4a824bb05972a6f524739516361b9bf80d4", "committedDate": "2020-12-11T07:55:13Z", "message": "HDDS-4178. Addressing review comments : part 3."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5OTExOTA5", "url": "https://github.com/apache/ozone/pull/1651#pullrequestreview-549911909", "createdAt": "2020-12-11T09:01:01Z", "commit": {"oid": "128ec4a824bb05972a6f524739516361b9bf80d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwOTowMTowMVrOIDvRhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwOTowMTowMVrOIDvRhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc5MTE3Mw==", "bodyText": "Thank you for making this change, one more thing still regarding this part, I think it is more beneficial to do not swallow the stack trace of this exception and having it reported in the output, so can we provide e.getCause() instead of e.getMessage() here to the wrapping IOException?", "url": "https://github.com/apache/ozone/pull/1651#discussion_r540791173", "createdAt": "2020-12-11T09:01:01Z", "author": {"login": "fapifta"}, "path": "hadoop-hdds/tools/src/main/java/org/apache/hadoop/hdds/scm/cli/upgrade/FinalizeScmUpgradeSubcommand.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm.cli.upgrade;\n+\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.emitCancellationMsg;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.emitExitMsg;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.emitFinishedMsg;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.emitGeneralErrorMsg;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.handleInvalidRequestAfterInitiatingFinalization;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.isDone;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.isFinalized;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.isInprogress;\n+import static org.apache.hadoop.hdds.scm.cli.upgrade.FinalizeUpgradeCommandUtil.isStarting;\n+\n+import java.io.IOException;\n+import java.util.UUID;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.scm.cli.ScmSubcommand;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import org.apache.hadoop.ozone.upgrade.UpgradeException;\n+import org.apache.hadoop.ozone.upgrade.UpgradeFinalizer;\n+import org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.StatusAndMessages;\n+\n+import picocli.CommandLine;\n+\n+/**\n+ * Handler of Finalize SCM command.\n+ */\n+@CommandLine.Command(\n+    name = \"finalizeupgrade\",\n+    description = \"Finalize SCM Upgrade\",\n+    mixinStandardHelpOptions = true,\n+    versionProvider = HddsVersionProvider.class)\n+\n+public class FinalizeScmUpgradeSubcommand extends ScmSubcommand {\n+  @CommandLine.Option(\n+      names = {\"--takeover\"},\n+      description = \"Forces takeover of monitoring from another client, if \"\n+          + \"finalization has already been started and did not finish yet.\"\n+  )\n+  private boolean force;\n+\n+  @Override\n+  public void execute(ScmClient scmClient) throws IOException {\n+    String upgradeClientID = \"Upgrade-Client-\" + UUID.randomUUID().toString();\n+    try {\n+      StatusAndMessages finalizationResponse =\n+          scmClient.finalizeScmUpgrade(upgradeClientID);\n+      if (isFinalized(finalizationResponse.status())){\n+        System.out.println(\"Upgrade has already been finalized.\");\n+        emitExitMsg();\n+        return;\n+      } else if (!isStarting(finalizationResponse.status())){\n+        System.err.println(\"Invalid response from Storage Container Manager.\");\n+        System.err.println(\n+            \"Current finalization status is: \" + finalizationResponse.status()\n+        );\n+        throw new IOException(\"Exiting...\");\n+      }\n+    } catch (UpgradeException e) {\n+      handleInvalidRequestAfterInitiatingFinalization(force, e);\n+    }\n+    monitorAndWaitFinalization(scmClient, upgradeClientID);\n+    return;\n+  }\n+\n+  private void monitorAndWaitFinalization(ScmClient client,\n+                                          String upgradeClientID)\n+      throws IOException {\n+    ExecutorService exec = Executors.newSingleThreadExecutor();\n+    Future<?> monitor =\n+        exec.submit(new UpgradeMonitor(client, upgradeClientID, force));\n+    try {\n+      monitor.get();\n+      emitFinishedMsg(\"Storage Container Manager\");\n+    } catch (CancellationException |InterruptedException e) {\n+      emitCancellationMsg(\"Storage Container Manager\");\n+    } catch (ExecutionException e) {\n+      emitGeneralErrorMsg();\n+      throw new IOException(e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "128ec4a824bb05972a6f524739516361b9bf80d4"}, "originalPosition": 103}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c921cafc3abe1fbb681c2d4f18364beba4c4cc7", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/6c921cafc3abe1fbb681c2d4f18364beba4c4cc7", "committedDate": "2020-12-11T17:33:15Z", "message": "HDDS-4178. Addressing review comments : part 4."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNTI1OTQ0", "url": "https://github.com/apache/ozone/pull/1651#pullrequestreview-550525944", "createdAt": "2020-12-11T19:41:45Z", "commit": {"oid": "6c921cafc3abe1fbb681c2d4f18364beba4c4cc7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a37268d73b6b89324e19458d30558b6dab9aa6d", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/7a37268d73b6b89324e19458d30558b6dab9aa6d", "committedDate": "2020-12-14T17:49:52Z", "message": "trigger new CI check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxNzIzMzEw", "url": "https://github.com/apache/ozone/pull/1651#pullrequestreview-551723310", "createdAt": "2020-12-14T17:54:12Z", "commit": {"oid": "7a37268d73b6b89324e19458d30558b6dab9aa6d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2018, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}