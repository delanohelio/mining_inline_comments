{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyOTMyNjYz", "number": 1346, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxOToxODozNFrOEcttEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwNzoxNTozN1rOEnz-ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4NTQ0NDAyOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/SCMClientProtocolServer.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxOToxODozNFrOHHaUMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxOToyMzo0MVrOHLFAlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzMzIzNQ==", "bodyText": "One thing I am not sure is what should be fetched from Ratis peers. Should I also include which one is leader and which one is follower?", "url": "https://github.com/apache/ozone/pull/1346#discussion_r477533235", "createdAt": "2020-08-26T19:18:34Z", "author": {"login": "amaliujia"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/SCMClientProtocolServer.java", "diffHunk": "@@ -560,6 +563,13 @@ public boolean getReplicationManagerStatus() {\n     return scm.getReplicationManager().isRunning();\n   }\n \n+  @Override\n+  public List<String> getScmRatisStatus() throws IOException {\n+    return scm.getScmHAManager()\n+        .getRatisServer().getRaftPeers()\n+        .stream().map(peer -> peer.getAddress()).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cf37411626ad478b219c48755c8783954118b4f"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEzNTk0MQ==", "bodyText": "Could potentially throw NPE", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481135941", "createdAt": "2020-09-01T13:26:47Z", "author": {"login": "timmylicheng"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/SCMClientProtocolServer.java", "diffHunk": "@@ -560,6 +563,13 @@ public boolean getReplicationManagerStatus() {\n     return scm.getReplicationManager().isRunning();\n   }\n \n+  @Override\n+  public List<String> getScmRatisStatus() throws IOException {\n+    return scm.getScmHAManager()\n+        .getRatisServer().getRaftPeers()\n+        .stream().map(peer -> peer.getAddress()).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzMzIzNQ=="}, "originalCommit": {"oid": "8cf37411626ad478b219c48755c8783954118b4f"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEzNjc1Mw==", "bodyText": "I can see this method be wrapper in ScmHAManager to show a list of scm hosts.", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481136753", "createdAt": "2020-09-01T13:28:04Z", "author": {"login": "timmylicheng"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/SCMClientProtocolServer.java", "diffHunk": "@@ -560,6 +563,13 @@ public boolean getReplicationManagerStatus() {\n     return scm.getReplicationManager().isRunning();\n   }\n \n+  @Override\n+  public List<String> getScmRatisStatus() throws IOException {\n+    return scm.getScmHAManager()\n+        .getRatisServer().getRaftPeers()\n+        .stream().map(peer -> peer.getAddress()).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzMzIzNQ=="}, "originalCommit": {"oid": "8cf37411626ad478b219c48755c8783954118b4f"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM3ODQ1NA==", "bodyText": "Got it. Will move this functionality to ScmHAManager.", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481378454", "createdAt": "2020-09-01T19:23:41Z", "author": {"login": "amaliujia"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/SCMClientProtocolServer.java", "diffHunk": "@@ -560,6 +563,13 @@ public boolean getReplicationManagerStatus() {\n     return scm.getReplicationManager().isRunning();\n   }\n \n+  @Override\n+  public List<String> getScmRatisStatus() throws IOException {\n+    return scm.getScmHAManager()\n+        .getRatisServer().getRaftPeers()\n+        .stream().map(peer -> peer.getAddress()).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzMzIzNQ=="}, "originalCommit": {"oid": "8cf37411626ad478b219c48755c8783954118b4f"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4NTQ0NzUzOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/protocol/StorageContainerLocationProtocol.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxOToxOTozM1rOHHaWVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMjozMzo0OVrOHLKiyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzMzc4MA==", "bodyText": "Does this API belongs to StorageContainerLocationProtocol?", "url": "https://github.com/apache/ozone/pull/1346#discussion_r477533780", "createdAt": "2020-08-26T19:19:33Z", "author": {"login": "amaliujia"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/protocol/StorageContainerLocationProtocol.java", "diffHunk": "@@ -230,4 +230,5 @@ Pipeline createReplicationPipeline(HddsProtos.ReplicationType type,\n    */\n   boolean getReplicationManagerStatus() throws IOException;\n \n+  List<String> getScmRatisStatus() throws IOException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cf37411626ad478b219c48755c8783954118b4f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0NzAxOQ==", "bodyText": "Any way to merge it with GetSCMInfo?", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481147019", "createdAt": "2020-09-01T13:42:34Z", "author": {"login": "timmylicheng"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/protocol/StorageContainerLocationProtocol.java", "diffHunk": "@@ -230,4 +230,5 @@ Pipeline createReplicationPipeline(HddsProtos.ReplicationType type,\n    */\n   boolean getReplicationManagerStatus() throws IOException;\n \n+  List<String> getScmRatisStatus() throws IOException;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzMzc4MA=="}, "originalCommit": {"oid": "8cf37411626ad478b219c48755c8783954118b4f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2OTEzMQ==", "bodyText": "Pushed a new commit to merge this logic into GetScmInfo", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481469131", "createdAt": "2020-09-01T22:33:49Z", "author": {"login": "amaliujia"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/protocol/StorageContainerLocationProtocol.java", "diffHunk": "@@ -230,4 +230,5 @@ Pipeline createReplicationPipeline(HddsProtos.ReplicationType type,\n    */\n   boolean getReplicationManagerStatus() throws IOException;\n \n+  List<String> getScmRatisStatus() throws IOException;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzMzc4MA=="}, "originalCommit": {"oid": "8cf37411626ad478b219c48755c8783954118b4f"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk4NTQ1MDg0OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxOToyMDozMVrOHHaYOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxOToyMDozMVrOHHaYOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzNDI2Ng==", "bodyText": "This is actually not a unit test as it does not check what is returned. I will think about whether there is a simple way to test that API directly.", "url": "https://github.com/apache/ozone/pull/1346#discussion_r477534266", "createdAt": "2020-08-26T19:20:31Z", "author": {"login": "amaliujia"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package org.apache.hadoop.ozone.shell;\n+\n+import java.io.File;\n+import java.net.InetSocketAddress;\n+import java.util.Arrays;\n+import java.util.UUID;\n+import org.apache.hadoop.fs.FileUtil;\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdds.scm.ScmConfigKeys;\n+import org.apache.hadoop.ozone.MiniOzoneCluster;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.admin.OzoneAdmin;\n+import org.apache.hadoop.ozone.admin.scm.ScmAdmin;\n+import org.apache.hadoop.test.GenericTestUtils;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import picocli.CommandLine;\n+import picocli.CommandLine.RunLast;\n+\n+public class TestScmAdminHA {\n+  private static OzoneAdmin ozoneAdmin;\n+  private static OzoneConfiguration conf;\n+  private static String omServiceId;\n+  private static int numOfOMs;\n+  private static String clusterId;\n+  private static String scmId;\n+  private static MiniOzoneCluster cluster;\n+\n+  @BeforeClass\n+  public static void init() throws Exception {\n+    ozoneAdmin = new OzoneAdmin();\n+    conf = new OzoneConfiguration();\n+\n+    // Init HA cluster\n+    omServiceId = \"om-service-test1\";\n+    numOfOMs = 3;\n+    clusterId = UUID.randomUUID().toString();\n+    scmId = UUID.randomUUID().toString();\n+    cluster = MiniOzoneCluster.newHABuilder(conf)\n+        .setClusterId(clusterId)\n+        .setScmId(scmId)\n+        .setOMServiceId(omServiceId)\n+        .setNumOfOzoneManagers(numOfOMs)\n+        .build();\n+    conf.setQuietMode(false);\n+    // enable ratis for Scm.\n+    conf.setBoolean(ScmConfigKeys.DFS_CONTAINER_RATIS_ENABLED_KEY, true);\n+    cluster.waitForClusterToBeReady();\n+  }\n+\n+  @AfterClass\n+  public static void shutdown() {\n+    if (cluster != null) {\n+      cluster.shutdown();\n+    }\n+  }\n+\n+  @Test\n+  public void testGetLeaderStatus() {\n+    InetSocketAddress address = cluster.getStorageContainerManager().getClientRpcAddress();\n+    String hostPort = address.getHostName() + \":\" + address.getPort();\n+    String[] args = {\"--scm\", hostPort, \"scmha\", \"listratisstatus\"};\n+    ozoneAdmin.execute(args);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cf37411626ad478b219c48755c8783954118b4f"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwODM4NjY4OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/protocol/StorageContainerLocationProtocolServerSideTranslatorPB.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMzoyNTowM1rOHK2IlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMzoyNTowM1rOHK2IlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTEzNDc0MQ==", "bodyText": "GetSCMRatisRole will be better", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481134741", "createdAt": "2020-09-01T13:25:03Z", "author": {"login": "timmylicheng"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/protocol/StorageContainerLocationProtocolServerSideTranslatorPB.java", "diffHunk": "@@ -271,6 +273,14 @@ public ScmContainerLocationResponse processRequest(\n             .setGetSafeModeRuleStatusesResponse(getSafeModeRuleStatues(\n                 request.getGetSafeModeRuleStatusesRequest()))\n             .build();\n+      case ScmHAStatus:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cf37411626ad478b219c48755c8783954118b4f"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwODQzNTg4OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java", "isResolved": false, "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMzozNjozMVrOHK2m9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwNTo1MjowNlrOHLbdXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjUxNw==", "bodyText": "Name seems a bit verbose. Let me find a syntax to align with OM HA", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481142517", "createdAt": "2020-09-01T13:36:31Z", "author": {"login": "timmylicheng"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.apache.hadoop.ozone.admin.scm;\n+\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import picocli.CommandLine;\n+\n+@CommandLine.Command(\n+    name = \"listratisstatus\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cf37411626ad478b219c48755c8783954118b4f"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM1OTM4Mw==", "bodyText": "I think both this one and OM HA getserviceroles can be improved.", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481359383", "createdAt": "2020-09-01T18:52:42Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.apache.hadoop.ozone.admin.scm;\n+\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import picocli.CommandLine;\n+\n+@CommandLine.Command(\n+    name = \"listratisstatus\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjUxNw=="}, "originalCommit": {"oid": "8cf37411626ad478b219c48755c8783954118b4f"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM3MTQ4Ng==", "bodyText": "@adoroszlai\nWhat kind of improvement OM HA getserviceroles you are thinking of? I am happy to make a separate PR for that.", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481371486", "createdAt": "2020-09-01T19:10:07Z", "author": {"login": "amaliujia"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.apache.hadoop.ozone.admin.scm;\n+\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import picocli.CommandLine;\n+\n+@CommandLine.Command(\n+    name = \"listratisstatus\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjUxNw=="}, "originalCommit": {"oid": "8cf37411626ad478b219c48755c8783954118b4f"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM4MDQ1Mg==", "bodyText": "status or roles would probably be enough to indicate the goal of the subcommand, something like\nozone admin (om|scm) status", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481380452", "createdAt": "2020-09-01T19:27:47Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.apache.hadoop.ozone.admin.scm;\n+\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import picocli.CommandLine;\n+\n+@CommandLine.Command(\n+    name = \"listratisstatus\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjUxNw=="}, "originalCommit": {"oid": "8cf37411626ad478b219c48755c8783954118b4f"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQxNDEyMw==", "bodyText": "Thanks. I will adopt ozone admin scm status in this PR and I will send another PR for ozone admin om status", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481414123", "createdAt": "2020-09-01T20:33:05Z", "author": {"login": "amaliujia"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.apache.hadoop.ozone.admin.scm;\n+\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import picocli.CommandLine;\n+\n+@CommandLine.Command(\n+    name = \"listratisstatus\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjUxNw=="}, "originalCommit": {"oid": "8cf37411626ad478b219c48755c8783954118b4f"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTU1NzIxNw==", "bodyText": "ozone admin om getserviceroles -id=<>\nThis is what OM does. I have my +1 on ozone admin (om|scm) roles. Status is more like health check.", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481557217", "createdAt": "2020-09-02T02:15:27Z", "author": {"login": "timmylicheng"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.apache.hadoop.ozone.admin.scm;\n+\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import picocli.CommandLine;\n+\n+@CommandLine.Command(\n+    name = \"listratisstatus\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjUxNw=="}, "originalCommit": {"oid": "8cf37411626ad478b219c48755c8783954118b4f"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTYzODI1Nw==", "bodyText": "I am ok with both.\n@adoroszlai  what do you think?", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481638257", "createdAt": "2020-09-02T04:01:56Z", "author": {"login": "amaliujia"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.apache.hadoop.ozone.admin.scm;\n+\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import picocli.CommandLine;\n+\n+@CommandLine.Command(\n+    name = \"listratisstatus\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjUxNw=="}, "originalCommit": {"oid": "8cf37411626ad478b219c48755c8783954118b4f"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTcwOTMzOA==", "bodyText": "I think it depends on whether you want to keep this command specific to roles, or may extend the same command in the future with other status info.  Probably \"roles\" is better now, and \"status\" can be either a separate command or another alias later.", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481709338", "createdAt": "2020-09-02T05:14:39Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.apache.hadoop.ozone.admin.scm;\n+\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import picocli.CommandLine;\n+\n+@CommandLine.Command(\n+    name = \"listratisstatus\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjUxNw=="}, "originalCommit": {"oid": "8cf37411626ad478b219c48755c8783954118b4f"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTc0NjI3MA==", "bodyText": "that makes sense. Indeed status sounds more like a health check and can carry much more information.\nConsider OM is also actually getting, essentially, roles. We can start from roles", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481746270", "createdAt": "2020-09-02T05:52:06Z", "author": {"login": "amaliujia"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.apache.hadoop.ozone.admin.scm;\n+\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import picocli.CommandLine;\n+\n+@CommandLine.Command(\n+    name = \"listratisstatus\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0MjUxNw=="}, "originalCommit": {"oid": "8cf37411626ad478b219c48755c8783954118b4f"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwODQ2MjQxOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxMzo0MjowMlrOHK23KQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMjozNDozOFrOHLKj5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0NjY2NQ==", "bodyText": "Apart from UT, we can have an acceptance test to test CLI.\nYou may find examples here: #375", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481146665", "createdAt": "2020-09-01T13:42:02Z", "author": {"login": "timmylicheng"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package org.apache.hadoop.ozone.shell;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cf37411626ad478b219c48755c8783954118b4f"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2OTQxMg==", "bodyText": "ack", "url": "https://github.com/apache/ozone/pull/1346#discussion_r481469412", "createdAt": "2020-09-01T22:34:38Z", "author": {"login": "amaliujia"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package org.apache.hadoop.ozone.shell;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTE0NjY2NQ=="}, "originalCommit": {"oid": "8cf37411626ad478b219c48755c8783954118b4f"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMTgwNzUxOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwNzowNTozNVrOHYlRZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxODozMzowMVrOHYpGkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUzODUzNQ==", "bodyText": "We probably want to align the naming here. Either we use roles or status for all external and internal interfaces.", "url": "https://github.com/apache/ozone/pull/1346#discussion_r495538535", "createdAt": "2020-09-27T07:05:35Z", "author": {"login": "timmylicheng"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.admin.scm;\n+\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import picocli.CommandLine;\n+\n+/**\n+ * Handler of scm status command.\n+ */\n+@CommandLine.Command(\n+    name = \"roles\",\n+    description = \"List all SCMs and their respective Ratis server status\",\n+    mixinStandardHelpOptions = true,\n+    versionProvider = HddsVersionProvider.class)\n+public class GetScmRatisStatusSubcommand implements Callable<Void> {\n+\n+  @CommandLine.ParentCommand\n+  private ScmAdmin parent;\n+\n+  @Override\n+  public Void call() throws Exception {\n+    ScmClient scmClient = parent.createScmClient();\n+    List<String> status = scmClient.getScmRatisStatus();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "277089b59186debc0c2f769fac69ac1cafe6a56a"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYwMTI5OA==", "bodyText": "Good point. I have switched all status to roles", "url": "https://github.com/apache/ozone/pull/1346#discussion_r495601298", "createdAt": "2020-09-27T18:33:01Z", "author": {"login": "amaliujia"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/admin/scm/GetScmRatisStatusSubcommand.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.admin.scm;\n+\n+import java.util.List;\n+import java.util.concurrent.Callable;\n+import org.apache.hadoop.hdds.cli.HddsVersionProvider;\n+import org.apache.hadoop.hdds.scm.client.ScmClient;\n+import picocli.CommandLine;\n+\n+/**\n+ * Handler of scm status command.\n+ */\n+@CommandLine.Command(\n+    name = \"roles\",\n+    description = \"List all SCMs and their respective Ratis server status\",\n+    mixinStandardHelpOptions = true,\n+    versionProvider = HddsVersionProvider.class)\n+public class GetScmRatisStatusSubcommand implements Callable<Void> {\n+\n+  @CommandLine.ParentCommand\n+  private ScmAdmin parent;\n+\n+  @Override\n+  public Void call() throws Exception {\n+    ScmClient scmClient = parent.createScmClient();\n+    List<String> status = scmClient.getScmRatisStatus();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUzODUzNQ=="}, "originalCommit": {"oid": "277089b59186debc0c2f769fac69ac1cafe6a56a"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMTgwOTMyOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwNzowODoxMVrOHYlSQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxODozMzozNlrOHYpGvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUzODc1Mg==", "bodyText": "You mean SCM here?", "url": "https://github.com/apache/ozone/pull/1346#discussion_r495538752", "createdAt": "2020-09-27T07:08:11Z", "author": {"login": "timmylicheng"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.shell;\n+\n+import java.net.InetSocketAddress;\n+import java.util.UUID;\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdds.scm.ScmConfigKeys;\n+import org.apache.hadoop.ozone.MiniOzoneCluster;\n+import org.apache.hadoop.ozone.admin.OzoneAdmin;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+/**\n+ * This class tests ozone admin scm commands.\n+ */\n+public class TestScmAdminHA {\n+  private static OzoneAdmin ozoneAdmin;\n+  private static OzoneConfiguration conf;\n+  private static String omServiceId;\n+  private static int numOfOMs;\n+  private static String clusterId;\n+  private static String scmId;\n+  private static MiniOzoneCluster cluster;\n+\n+  @BeforeClass\n+  public static void init() throws Exception {\n+    ozoneAdmin = new OzoneAdmin();\n+    conf = new OzoneConfiguration();\n+\n+    // Init HA cluster\n+    omServiceId = \"om-service-test1\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "277089b59186debc0c2f769fac69ac1cafe6a56a"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYwMTM0MQ==", "bodyText": "Actually I meant OM. It turns out that I cannot ignore omServiceId to start the cluster (there is a check for this service id).", "url": "https://github.com/apache/ozone/pull/1346#discussion_r495601341", "createdAt": "2020-09-27T18:33:36Z", "author": {"login": "amaliujia"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/shell/TestScmAdminHA.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.shell;\n+\n+import java.net.InetSocketAddress;\n+import java.util.UUID;\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdds.scm.ScmConfigKeys;\n+import org.apache.hadoop.ozone.MiniOzoneCluster;\n+import org.apache.hadoop.ozone.admin.OzoneAdmin;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+/**\n+ * This class tests ozone admin scm commands.\n+ */\n+public class TestScmAdminHA {\n+  private static OzoneAdmin ozoneAdmin;\n+  private static OzoneConfiguration conf;\n+  private static String omServiceId;\n+  private static int numOfOMs;\n+  private static String clusterId;\n+  private static String scmId;\n+  private static MiniOzoneCluster cluster;\n+\n+  @BeforeClass\n+  public static void init() throws Exception {\n+    ozoneAdmin = new OzoneAdmin();\n+    conf = new OzoneConfiguration();\n+\n+    // Init HA cluster\n+    omServiceId = \"om-service-test1\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUzODc1Mg=="}, "originalCommit": {"oid": "277089b59186debc0c2f769fac69ac1cafe6a56a"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMTgxNTM0OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/MockSCMHAManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwNzoxNTozN1rOHYlVDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxODozNDo0NFrOHYpHFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUzOTQ3MQ==", "bodyText": "You can use the default SCM RatisServer port. Check ratisBindPort in SCMHAConfiguration", "url": "https://github.com/apache/ozone/pull/1346#discussion_r495539471", "createdAt": "2020-09-27T07:15:37Z", "author": {"login": "timmylicheng"}, "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/MockSCMHAManager.java", "diffHunk": "@@ -107,6 +108,14 @@ public void shutdown() throws IOException {\n     ratisServer.stop();\n   }\n \n+  @Override\n+  public List<String> getRatisStatus() {\n+    return Arrays.asList(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "277089b59186debc0c2f769fac69ac1cafe6a56a"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYwMTQyOA==", "bodyText": "Switched to use the default port. In the future I will think about how to better construct MockSCMHAManager for testing purpose (as the code is evolving we can keep updating MockSCMHAManager)", "url": "https://github.com/apache/ozone/pull/1346#discussion_r495601428", "createdAt": "2020-09-27T18:34:44Z", "author": {"login": "amaliujia"}, "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/ha/MockSCMHAManager.java", "diffHunk": "@@ -107,6 +108,14 @@ public void shutdown() throws IOException {\n     ratisServer.stop();\n   }\n \n+  @Override\n+  public List<String> getRatisStatus() {\n+    return Arrays.asList(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUzOTQ3MQ=="}, "originalCommit": {"oid": "277089b59186debc0c2f769fac69ac1cafe6a56a"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3913, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}