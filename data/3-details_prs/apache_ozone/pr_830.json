{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0MDU2NTk5", "number": 830, "title": "HDDS-3392.OM create key/file should not generate different data encryption key during validateAndUpdateCache.", "bodyText": "What changes were proposed in this pull request?\nGenerate EncryptionInfo only by leader OM in HA.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3392\nPlease replace this section with the link to the Apache JIRA)\nHow was this patch tested?\nAs no secure docker-compose cluster for HA, no tests added for this scenario.", "createdAt": "2020-04-16T00:41:45Z", "url": "https://github.com/apache/ozone/pull/830", "merged": true, "mergeCommit": {"oid": "f020e6a4d03fa2e914fb004722444185d430a8d6"}, "closed": true, "closedAt": "2020-04-16T19:32:44Z", "author": {"login": "bharatviswa504"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYBs9wgH2gAyNDA0MDU2NTk5OjgwYzNhZWRhNzM0ODQxZjk0ODgyMDNiNzBkYjE3OWQzOTZiZjI0NjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYQR04gFqTM5NDg1NzA5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "80c3aeda734841f9488203b70db179d396bf2465", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/80c3aeda734841f9488203b70db179d396bf2465", "committedDate": "2020-04-16T00:39:17Z", "message": "HDDS-3392. OM create key/file should not generate different data encryption key during validateAndUpdateCache."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11bb2a21574fdaa22bd18438316dcf22443be169", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/11bb2a21574fdaa22bd18438316dcf22443be169", "committedDate": "2020-04-16T00:42:49Z", "message": "remove additional space"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a38bbd2b185c116c8a5862673b84230a5c87b728", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/a38bbd2b185c116c8a5862673b84230a5c87b728", "committedDate": "2020-04-16T00:56:46Z", "message": "check style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MjY2NzUz", "url": "https://github.com/apache/ozone/pull/830#pullrequestreview-394266753", "createdAt": "2020-04-16T02:59:54Z", "commit": {"oid": "a38bbd2b185c116c8a5862673b84230a5c87b728"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMjo1OTo1NFrOGGSxAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMjo1OTo1NFrOGGSxAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI1MjA5Nw==", "bodyText": "If we could fail the client earlier without the request adding to request log, that can avoid adding the request to ratis log as it will fail application any way.", "url": "https://github.com/apache/ozone/pull/830#discussion_r409252097", "createdAt": "2020-04-16T02:59:54Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyRequest.java", "diffHunk": "@@ -451,4 +446,62 @@ protected void checkKeyAclsInOpenKeyTable(OzoneManager ozoneManager,\n     checkKeyAcls(ozoneManager, volume, bucket, keyNameForAclCheck,\n           aclType, OzoneObj.ResourceType.KEY);\n   }\n+\n+  /**\n+   * Generate EncryptionInfo and set in to newKeyArgs.\n+   * @param keyArgs\n+   * @param newKeyArgs\n+   * @param ozoneManager\n+   */\n+  protected void generateRequiredEncryptionInfo(KeyArgs keyArgs,\n+      KeyArgs.Builder newKeyArgs, OzoneManager ozoneManager)\n+      throws IOException {\n+\n+    String volumeName = keyArgs.getVolumeName();\n+    String bucketName = keyArgs.getBucketName();\n+\n+    boolean acquireLock = false;\n+    OMMetadataManager omMetadataManager = ozoneManager.getMetadataManager();\n+\n+    // When TDE is enabled, we are doing a DB read in pre-execute. As for\n+    // most of the operations we don't read from DB because of our isLeader\n+    // semantics. This issue will be solved with implementation of leader\n+    // leases which provider strong leader semantics in the system.\n+\n+    // If KMS is not enabled, follow the normal approach of execution of not\n+    // reading DB in pre-execute.\n+    if (ozoneManager.getKmsProvider() != null) {\n+      try {\n+        acquireLock = omMetadataManager.getLock().acquireReadLock(\n+            BUCKET_LOCK, volumeName, bucketName);\n+\n+\n+        OmBucketInfo bucketInfo = omMetadataManager.getBucketTable().get(\n+            omMetadataManager.getBucketKey(volumeName, bucketName));\n+\n+\n+        // Don't throw exception of bucket not found when bucketinfo is not\n+        // null. If bucketinfo is null, later when request\n+        // is submitted and if bucket does not really exist it will fail in\n+        // applyTransaction step. Why we are doing this is if OM thinks it is\n+        // the leader, but it is not, we don't want to fail request in this\n+        // case. As anyway when it submits request to ratis it will fail with", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a38bbd2b185c116c8a5862673b84230a5c87b728"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MjY3NjQ4", "url": "https://github.com/apache/ozone/pull/830#pullrequestreview-394267648", "createdAt": "2020-04-16T03:03:11Z", "commit": {"oid": "a38bbd2b185c116c8a5862673b84230a5c87b728"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMzowMzoxMVrOGGS0JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMzowMzoxMVrOGGS0JA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI1MjkwMA==", "bodyText": "encryptionInfo.orNull() should be removed as the keyArgs now have the data encryption key info.", "url": "https://github.com/apache/ozone/pull/830#discussion_r409252900", "createdAt": "2020-04-16T03:03:11Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCreateRequest.java", "diffHunk": "@@ -213,7 +214,6 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n \n       OmBucketInfo bucketInfo = omMetadataManager.getBucketTable().get(\n           omMetadataManager.getBucketKey(volumeName, bucketName));\n-      encryptionInfo = getFileEncryptionInfo(ozoneManager, bucketInfo);\n \n       omKeyInfo = prepareKeyInfo(omMetadataManager, keyArgs, dbKeyInfo,\n           keyArgs.getDataSize(), locations, encryptionInfo.orNull(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a38bbd2b185c116c8a5862673b84230a5c87b728"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MjY3NzU0", "url": "https://github.com/apache/ozone/pull/830#pullrequestreview-394267754", "createdAt": "2020-04-16T03:03:36Z", "commit": {"oid": "a38bbd2b185c116c8a5862673b84230a5c87b728"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "252caca2c7af7fa024ebfb085e59e5b8d4268404", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/252caca2c7af7fa024ebfb085e59e5b8d4268404", "committedDate": "2020-04-16T05:25:04Z", "message": "review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac83fb91b042b1db7dfadced5d014bb86b56bafa", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/ac83fb91b042b1db7dfadced5d014bb86b56bafa", "committedDate": "2020-04-16T05:50:05Z", "message": "check style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0ODU3MDk2", "url": "https://github.com/apache/ozone/pull/830#pullrequestreview-394857096", "createdAt": "2020-04-16T17:38:12Z", "commit": {"oid": "ac83fb91b042b1db7dfadced5d014bb86b56bafa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNzozODoxM1rOGGwKEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNzozODoxM1rOGGwKEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTczMzY1MQ==", "bodyText": "NIT: Given we have pass keyArgs, we can reduce the number of arguments here to  avoid @SuppressWarnings(\"parameternumber\") for prepareKeyInfo().", "url": "https://github.com/apache/ozone/pull/830#discussion_r409733651", "createdAt": "2020-04-16T17:38:13Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCreateRequest.java", "diffHunk": "@@ -213,10 +213,9 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n \n       OmBucketInfo bucketInfo = omMetadataManager.getBucketTable().get(\n           omMetadataManager.getBucketKey(volumeName, bucketName));\n-      encryptionInfo = getFileEncryptionInfo(ozoneManager, bucketInfo);\n \n       omKeyInfo = prepareKeyInfo(omMetadataManager, keyArgs, dbKeyInfo,\n-          keyArgs.getDataSize(), locations, encryptionInfo.orNull(),\n+          keyArgs.getDataSize(), locations,  getFileEncryptionInfo(keyArgs),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac83fb91b042b1db7dfadced5d014bb86b56bafa"}, "originalPosition": 33}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3383, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}