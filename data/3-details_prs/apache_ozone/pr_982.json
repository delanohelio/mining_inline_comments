{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0NTU2NDc5", "number": 982, "title": "HDDS-3668. OzoneManager start fails with RocksDB error on downgrade to older version.", "bodyText": "What changes were proposed in this pull request?\nOM start fails with RocksDB error when downgrading to older version that does not have all the column families that may have been created  in the newer version.\nCaused by: org.rocksdb.RocksDBException: You have to open all column families. Column families not opened: transact\nionInfoTable\n        at org.rocksdb.RocksDB.open(Native Method)\n        at org.rocksdb.RocksDB.open(RocksDB.java:290)\n        at org.apache.hadoop.hdds.utils.db.RDBStore.<init>(RDBStore.java:97)\n        ... 20 more\n\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3668\nHow was this patch tested?\nManually tested. Unit test added.", "createdAt": "2020-05-28T15:14:33Z", "url": "https://github.com/apache/ozone/pull/982", "merged": true, "mergeCommit": {"oid": "d57e1514b134aa06f3be4b40f098cd5927ddc081"}, "closed": true, "closedAt": "2020-06-06T04:41:42Z", "author": {"login": "avijayanhwx"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclvXTIAH2gAyNDI0NTU2NDc5OmNmMGQ2N2I3MTUxYWU2NzRlMmU0NzNkNjM3MmUzMWRiYjE2ZDEzYmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoYN7JgFqTQyNTU4ODEyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cf0d67b7151ae674e2e473d6372e31dbb16d13be", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/cf0d67b7151ae674e2e473d6372e31dbb16d13be", "committedDate": "2020-05-28T15:12:16Z", "message": "HDDS-3668. OzoneManager start fails with RocksDB error on downgrade to older version."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMzIyMzMw", "url": "https://github.com/apache/ozone/pull/982#pullrequestreview-420322330", "createdAt": "2020-05-28T17:09:31Z", "commit": {"oid": "cf0d67b7151ae674e2e473d6372e31dbb16d13be"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNzowOTozMVrOGb-xCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNzoxMjoyMVrOGb-3Ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5MzA5OA==", "bodyText": "One question, can these extra column families can be dropped, if they are not required after upgrade/downgrade.\nBecause now we removed S3Table in #940. So, once after upgrade, technically we don't require the column family any more.", "url": "https://github.com/apache/ozone/pull/982#discussion_r431993098", "createdAt": "2020-05-28T17:09:31Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -94,6 +97,14 @@ public RDBStore(File dbFile, DBOptions options,\n     this.writeOptions = writeOptions;\n \n     try {\n+      List<TableConfig> columnFamiliesInDb = getColumnFamiliesInExistingDb();\n+      List<TableConfig> extraCf = columnFamiliesInDb.stream().filter(\n+          cf -> !families.contains(cf)).collect(Collectors.toList());\n+      for (TableConfig family : extraCf) {\n+        LOG.info(\"Adding column family {}\", family.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf0d67b7151ae674e2e473d6372e31dbb16d13be"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5Mzc2MQ==", "bodyText": "Can this comment be more clear saying ColumnFamily in DB, but not in the current version something like that?", "url": "https://github.com/apache/ozone/pull/982#discussion_r431993761", "createdAt": "2020-05-28T17:10:40Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -94,6 +97,14 @@ public RDBStore(File dbFile, DBOptions options,\n     this.writeOptions = writeOptions;\n \n     try {\n+      List<TableConfig> columnFamiliesInDb = getColumnFamiliesInExistingDb();\n+      List<TableConfig> extraCf = columnFamiliesInDb.stream().filter(\n+          cf -> !families.contains(cf)).collect(Collectors.toList());\n+      for (TableConfig family : extraCf) {\n+        LOG.info(\"Adding column family {}\", family.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf0d67b7151ae674e2e473d6372e31dbb16d13be"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5NDcxNQ==", "bodyText": "Question: If column family is missing also, but DBStore will open that column family right currently? So, do we need to check the columnFamily is opened or not also?", "url": "https://github.com/apache/ozone/pull/982#discussion_r431994715", "createdAt": "2020-05-28T17:12:21Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-hdds/framework/src/test/java/org/apache/hadoop/hdds/utils/db/TestRDBStore.java", "diffHunk": "@@ -348,5 +348,40 @@ public void testGetDBUpdatesSince() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testDowngrade() throws Exception {\n+\n+    // Write data to current DB which has 6 column families at the time of\n+    // writing this test.\n+    for (String family : families) {\n+      try (Table table = rdbStore.getTable(family)) {\n+        byte[] key = family.getBytes(StandardCharsets.UTF_8);\n+        byte[] value =\n+            RandomStringUtils.random(10).getBytes(StandardCharsets.UTF_8);\n+        table.put(key, value);\n+      }\n+    }\n+    // Close current DB.\n+    rdbStore.close();\n+\n+    // Reopen DB with the last column family removed.\n+    options = new DBOptions();\n+    options.setCreateIfMissing(true);\n+    options.setCreateMissingColumnFamilies(true);\n+    configSet = new HashSet<>();\n+    List<String> familiesMinusOne = families.subList(0, families.size() - 1);\n+    for(String name : familiesMinusOne) {\n+      TableConfig newConfig = new TableConfig(name, new ColumnFamilyOptions());\n+      configSet.add(newConfig);\n+    }\n+    rdbStore = new RDBStore(rdbStore.getDbLocation(), options, configSet);\n+    for (String family : familiesMinusOne) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf0d67b7151ae674e2e473d6372e31dbb16d13be"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "520eda58ae48fc060eadfe63e3539b97bc72c9b9", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/520eda58ae48fc060eadfe63e3539b97bc72c9b9", "committedDate": "2020-06-01T20:44:40Z", "message": "Merge remote-tracking branch 'upstream/master' into HDDS-3668-master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97bcc5063c13efe6ceff243d80e9f736b01c8505", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/97bcc5063c13efe6ceff243d80e9f736b01c8505", "committedDate": "2020-06-01T20:45:20Z", "message": "Address review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MTA0NzM3", "url": "https://github.com/apache/ozone/pull/982#pullrequestreview-425104737", "createdAt": "2020-06-05T08:36:51Z", "commit": {"oid": "97bcc5063c13efe6ceff243d80e9f736b01c8505"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODozNjo1MVrOGflfbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODo0NzowNFrOGfl1eA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3MzI5NQ==", "bodyText": "Nit: extraCf cannot be null, so I would prefer not adding a dependency:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  if (CollectionUtils.isNotEmpty(extraCf)) {\n          \n          \n            \n                  if (!extraCf.isEmpty()) {", "url": "https://github.com/apache/ozone/pull/982#discussion_r435773295", "createdAt": "2020-06-05T08:36:51Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -94,6 +98,15 @@ public RDBStore(File dbFile, DBOptions options,\n     this.writeOptions = writeOptions;\n \n     try {\n+      List<TableConfig> columnFamiliesInDb = getColumnFamiliesInExistingDb();\n+      List<TableConfig> extraCf = columnFamiliesInDb.stream().filter(\n+          cf -> !families.contains(cf)).collect(Collectors.toList());\n+      if (CollectionUtils.isNotEmpty(extraCf)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bcc5063c13efe6ceff243d80e9f736b01c8505"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3Mzc5MA==", "bodyText": "Nit: I think List.toString is just as good:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            \"{}\", Arrays.toString(extraCf.toArray()));\n          \n          \n            \n                            \"{}\", extraCf);", "url": "https://github.com/apache/ozone/pull/982#discussion_r435773790", "createdAt": "2020-06-05T08:37:41Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -94,6 +98,15 @@ public RDBStore(File dbFile, DBOptions options,\n     this.writeOptions = writeOptions;\n \n     try {\n+      List<TableConfig> columnFamiliesInDb = getColumnFamiliesInExistingDb();\n+      List<TableConfig> extraCf = columnFamiliesInDb.stream().filter(\n+          cf -> !families.contains(cf)).collect(Collectors.toList());\n+      if (CollectionUtils.isNotEmpty(extraCf)) {\n+        LOG.info(\"Found the following extra column families in existing DB : \" +\n+                \"{}\", Arrays.toString(extraCf.toArray()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bcc5063c13efe6ceff243d80e9f736b01c8505"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3Mzk3Mg==", "bodyText": "Nit: same here regarding arrays:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      Arrays.toString(columnFamiliesInDb.toArray()));\n          \n          \n            \n                      columnFamiliesInDb);", "url": "https://github.com/apache/ozone/pull/982#discussion_r435773972", "createdAt": "2020-06-05T08:38:00Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -149,6 +162,26 @@ public RDBStore(File dbFile, DBOptions options,\n     }\n   }\n \n+  /**\n+   * Read DB and return existing column families.\n+   * @return List of column families\n+   * @throws RocksDBException on Error.\n+   */\n+  private List<TableConfig> getColumnFamiliesInExistingDb()\n+      throws RocksDBException {\n+    List<byte[]> bytes = RocksDB.listColumnFamilies(new Options(),\n+        dbLocation.getAbsolutePath());\n+    List<TableConfig> columnFamiliesInDb = bytes.stream()\n+        .map(cfbytes -> new TableConfig(StringUtils.bytes2String(cfbytes),\n+            DBProfile.DISK.getColumnFamilyOptions()))\n+        .collect(Collectors.toList());\n+    if (LOG.isDebugEnabled()) {\n+      LOG.debug(\"Found column Families in DB : {}\",\n+          Arrays.toString(columnFamiliesInDb.toArray()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bcc5063c13efe6ceff243d80e9f736b01c8505"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3NDIzNA==", "bodyText": "Corresponding to suggestion about list to string:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import java.util.Arrays;", "url": "https://github.com/apache/ozone/pull/982#discussion_r435774234", "createdAt": "2020-06-05T08:38:30Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -24,11 +24,14 @@\n import java.io.IOException;\n import java.nio.file.Paths;\n import java.util.ArrayList;\n+import java.util.Arrays;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bcc5063c13efe6ceff243d80e9f736b01c8505"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3NDY0OQ==", "bodyText": "Corresponding to suggestion about empty list:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import org.apache.commons.collections.CollectionUtils;", "url": "https://github.com/apache/ozone/pull/982#discussion_r435774649", "createdAt": "2020-06-05T08:39:15Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -24,11 +24,14 @@\n import java.io.IOException;\n import java.nio.file.Paths;\n import java.util.ArrayList;\n+import java.util.Arrays;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.Set;\n+import java.util.stream.Collectors;\n \n+import org.apache.commons.collections.CollectionUtils;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bcc5063c13efe6ceff243d80e9f736b01c8505"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3ODkzNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        DBProfile.DISK.getColumnFamilyOptions()))\n          \n          \n            \n                        DBStoreBuilder.HDDS_DEFAULT_DB_PROFILE.getColumnFamilyOptions()))", "url": "https://github.com/apache/ozone/pull/982#discussion_r435778936", "createdAt": "2020-06-05T08:47:04Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -149,6 +162,26 @@ public RDBStore(File dbFile, DBOptions options,\n     }\n   }\n \n+  /**\n+   * Read DB and return existing column families.\n+   * @return List of column families\n+   * @throws RocksDBException on Error.\n+   */\n+  private List<TableConfig> getColumnFamiliesInExistingDb()\n+      throws RocksDBException {\n+    List<byte[]> bytes = RocksDB.listColumnFamilies(new Options(),\n+        dbLocation.getAbsolutePath());\n+    List<TableConfig> columnFamiliesInDb = bytes.stream()\n+        .map(cfbytes -> new TableConfig(StringUtils.bytes2String(cfbytes),\n+            DBProfile.DISK.getColumnFamilyOptions()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bcc5063c13efe6ceff243d80e9f736b01c8505"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a2616ad2a3a8034ef470e135d139a886c45c0c1", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/8a2616ad2a3a8034ef470e135d139a886c45c0c1", "committedDate": "2020-06-05T17:10:34Z", "message": "Update hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n\nCo-authored-by: Doroszlai, Attila <6454655+adoroszlai@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4469d6a0c649dadbc2f357600c418df58d3efbc", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/e4469d6a0c649dadbc2f357600c418df58d3efbc", "committedDate": "2020-06-05T17:10:49Z", "message": "Update hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n\nCo-authored-by: Doroszlai, Attila <6454655+adoroszlai@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66eb8faaedb7f633ebd5c66c9003f0e1e281f645", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/66eb8faaedb7f633ebd5c66c9003f0e1e281f645", "committedDate": "2020-06-05T17:11:22Z", "message": "Update hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n\nCo-authored-by: Doroszlai, Attila <6454655+adoroszlai@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "facfe5a3d9bf80b230ca9caa21d32a7d4ffb5020", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/facfe5a3d9bf80b230ca9caa21d32a7d4ffb5020", "committedDate": "2020-06-05T17:11:28Z", "message": "Update hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n\nCo-authored-by: Doroszlai, Attila <6454655+adoroszlai@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "312efe68251d374de6d354fd105b4e31eee9b1bc", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/312efe68251d374de6d354fd105b4e31eee9b1bc", "committedDate": "2020-06-05T17:11:33Z", "message": "Update hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n\nCo-authored-by: Doroszlai, Attila <6454655+adoroszlai@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04a1a0edabe52b02b9ecb9f68e4886fcba402583", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/04a1a0edabe52b02b9ecb9f68e4886fcba402583", "committedDate": "2020-06-05T17:11:41Z", "message": "Update hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java\n\nCo-authored-by: Doroszlai, Attila <6454655+adoroszlai@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "362a7bbe62d863b8885111b6af0fe75bb01b4024", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/362a7bbe62d863b8885111b6af0fe75bb01b4024", "committedDate": "2020-06-05T17:21:51Z", "message": "Merge remote-tracking branch 'upstream/master' into HDDS-3668-master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70237e265b6be75bb7520b5d57beede24e786788", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/70237e265b6be75bb7520b5d57beede24e786788", "committedDate": "2020-06-05T17:24:53Z", "message": "Add todo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NDg4NzYz", "url": "https://github.com/apache/ozone/pull/982#pullrequestreview-425488763", "createdAt": "2020-06-05T17:28:07Z", "commit": {"oid": "70237e265b6be75bb7520b5d57beede24e786788"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NTg4MTI2", "url": "https://github.com/apache/ozone/pull/982#pullrequestreview-425588126", "createdAt": "2020-06-05T19:55:59Z", "commit": {"oid": "70237e265b6be75bb7520b5d57beede24e786788"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3097, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}