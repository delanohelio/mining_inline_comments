{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMjk5OTc2", "number": 1291, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxODo0Nzo1MlrOEXwLtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxODo0Nzo1MlrOEXwLtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzMzQyMTM1OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelinePlacementPolicy.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxODo0Nzo1MlrOG_uGSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNVQwNzo1ODoyNlrOHBInag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ2ODc0NA==", "bodyText": "Should we also consider excludedNodes here?", "url": "https://github.com/apache/ozone/pull/1291#discussion_r469468744", "createdAt": "2020-08-12T18:47:52Z", "author": {"login": "nandakumar131"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelinePlacementPolicy.java", "diffHunk": "@@ -163,9 +163,42 @@ int currentPipelineCount(DatanodeDetails datanodeDetails, int nodesRequired) {\n       throw new SCMException(msg,\n           SCMException.ResultCodes.FAILED_TO_FIND_SUITABLE_NODE);\n     }\n+\n+    if (!checkAllNodesAreEqual(nodeManager.getClusterNetworkTopologyMap())) {\n+      boolean multipleRacks = multipleRacksAvailable(healthyNodes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a306c104830b6f78ba5cb7e6404cf74bb1cbbfb"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU5MTc2Mg==", "bodyText": "In line 124 if there are exclusions, then they are removed from the healthyNodes list, then based on the remaining elements healthyList is created by filtering the nodes that can not accept more pipeline.\nAt this point with the healthyNodes list we are checking whether there were multiple racks configured for the healthy nodes, as we need to know that we are in a multi rack environment. (If the whole cluster has just one rack, then even though we have rack awareness logic, we can not allocate pipelines in two racks, hence this check is needed.)\nThe second check is after filtering nodes that can not accept more pipeline, and the intention is to throw an exception if the remaining nodes are in one single rack, as in this case we have more racks with healthy nodes, still we can't allocate a rack aware pipeline.", "url": "https://github.com/apache/ozone/pull/1291#discussion_r469591762", "createdAt": "2020-08-12T22:55:15Z", "author": {"login": "fapifta"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelinePlacementPolicy.java", "diffHunk": "@@ -163,9 +163,42 @@ int currentPipelineCount(DatanodeDetails datanodeDetails, int nodesRequired) {\n       throw new SCMException(msg,\n           SCMException.ResultCodes.FAILED_TO_FIND_SUITABLE_NODE);\n     }\n+\n+    if (!checkAllNodesAreEqual(nodeManager.getClusterNetworkTopologyMap())) {\n+      boolean multipleRacks = multipleRacksAvailable(healthyNodes);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ2ODc0NA=="}, "originalCommit": {"oid": "5a306c104830b6f78ba5cb7e6404cf74bb1cbbfb"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDAwMzQ2Mg==", "bodyText": "In the first call to multipleRacksAvailable(...) we just use all healthy nodes and don't worry about excluded nodes. As Pifta said, excluded nodes are handled later and this first call is just to check if the cluster has multiple alive racks.", "url": "https://github.com/apache/ozone/pull/1291#discussion_r470003462", "createdAt": "2020-08-13T14:40:57Z", "author": {"login": "sodonnel"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelinePlacementPolicy.java", "diffHunk": "@@ -163,9 +163,42 @@ int currentPipelineCount(DatanodeDetails datanodeDetails, int nodesRequired) {\n       throw new SCMException(msg,\n           SCMException.ResultCodes.FAILED_TO_FIND_SUITABLE_NODE);\n     }\n+\n+    if (!checkAllNodesAreEqual(nodeManager.getClusterNetworkTopologyMap())) {\n+      boolean multipleRacks = multipleRacksAvailable(healthyNodes);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ2ODc0NA=="}, "originalCommit": {"oid": "5a306c104830b6f78ba5cb7e6404cf74bb1cbbfb"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk0ODM2Mg==", "bodyText": "Let's take the same example given in the description,\nRack 1 = 10 nodes; Rack 2 = 1 node\nFor some reason, the one node which is in Rack 2 is added to the exclude list. According to SCM the node in Rack 2 is still healthy.\nWe will end up creating a pipeline in the same rack (Rack 1), even though we have two racks. We will run into same scenario which this PR is trying to address.", "url": "https://github.com/apache/ozone/pull/1291#discussion_r470948362", "createdAt": "2020-08-15T07:13:36Z", "author": {"login": "nandakumar131"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelinePlacementPolicy.java", "diffHunk": "@@ -163,9 +163,42 @@ int currentPipelineCount(DatanodeDetails datanodeDetails, int nodesRequired) {\n       throw new SCMException(msg,\n           SCMException.ResultCodes.FAILED_TO_FIND_SUITABLE_NODE);\n     }\n+\n+    if (!checkAllNodesAreEqual(nodeManager.getClusterNetworkTopologyMap())) {\n+      boolean multipleRacks = multipleRacksAvailable(healthyNodes);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ2ODc0NA=="}, "originalCommit": {"oid": "5a306c104830b6f78ba5cb7e6404cf74bb1cbbfb"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk1MTc4Ng==", "bodyText": "You are correct. Checking this again, I see at line 121/126 the excluded nodes are removed from the healthyList:\n    List<DatanodeDetails> healthyNodes =\n        nodeManager.getNodes(HddsProtos.NodeState.HEALTHY);\n    if (excludedNodes != null) {\n      healthyNodes.removeAll(excludedNodes);\n    }\n\nSo I need to move the line:\nboolean multipleRacks = multipleRacksAvailable(healthyNodes);\n\nTo before removing the excluded nodes.", "url": "https://github.com/apache/ozone/pull/1291#discussion_r470951786", "createdAt": "2020-08-15T07:58:26Z", "author": {"login": "sodonnel"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelinePlacementPolicy.java", "diffHunk": "@@ -163,9 +163,42 @@ int currentPipelineCount(DatanodeDetails datanodeDetails, int nodesRequired) {\n       throw new SCMException(msg,\n           SCMException.ResultCodes.FAILED_TO_FIND_SUITABLE_NODE);\n     }\n+\n+    if (!checkAllNodesAreEqual(nodeManager.getClusterNetworkTopologyMap())) {\n+      boolean multipleRacks = multipleRacksAvailable(healthyNodes);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ2ODc0NA=="}, "originalCommit": {"oid": "5a306c104830b6f78ba5cb7e6404cf74bb1cbbfb"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4987, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}