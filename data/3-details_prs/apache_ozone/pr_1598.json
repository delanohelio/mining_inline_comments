{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyNTQ3ODE3", "number": 1598, "title": "HDDS-4478. Large deletedKeyset slows down OM via listStatus.", "bodyText": "What changes were proposed in this pull request?\nSee details about the issue found in the JIRA, the change proposed is fairly simple, as the key table is missing from the CleanupTableInfo annotation values, which prevents cache eviction in the OMDoubleBuffer logic.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4478\nHow was this patch tested?\nThe JUnit test I wrote tests this particular scenario with the given request. I am posting a follow up JIRA for a most comprehensive test that covers probably all the request - response pairs somehow. Or at least as an outcome, helps us detect these kind of problems easier and earlier.", "createdAt": "2020-11-17T16:40:16Z", "url": "https://github.com/apache/ozone/pull/1598", "merged": true, "mergeCommit": {"oid": "8ae1408c69f3714cf3b9e88df442af9f459708a0"}, "closed": true, "closedAt": "2020-11-19T22:41:05Z", "author": {"login": "fapifta"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddcb8PAH2gAyNTIyNTQ3ODE3OjExYTAxMTc1M2ZkZWExOGQ1ZjkzZjJhYmNmM2YzMmNlZDFmZDhhM2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeKrfXgFqTUzNDkxNzI5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "11a011753fdea18d5f93f2abcf3f32ced1fd8a3a", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/11a011753fdea18d5f93f2abcf3f32ced1fd8a3a", "committedDate": "2020-11-17T16:48:54Z", "message": "HDDS-4478. Large deletedKeyset slows down OM via listStatus."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a82bd40681d6829ac92da9b081d37e7185258b6", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/0a82bd40681d6829ac92da9b081d37e7185258b6", "committedDate": "2020-11-17T16:32:23Z", "message": "HDDS-4478. Large deletedKeyset slows down OM via listStatus."}, "afterCommit": {"oid": "11a011753fdea18d5f93f2abcf3f32ced1fd8a3a", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/11a011753fdea18d5f93f2abcf3f32ced1fd8a3a", "committedDate": "2020-11-17T16:48:54Z", "message": "HDDS-4478. Large deletedKeyset slows down OM via listStatus."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1b8ab8c70a97ef08b817e01365bcc373b88b01f", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/e1b8ab8c70a97ef08b817e01365bcc373b88b01f", "committedDate": "2020-11-17T17:01:42Z", "message": "Address checkstyle issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "017180b96cdee7f6261246802817ce07d0394046", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/017180b96cdee7f6261246802817ce07d0394046", "committedDate": "2020-11-17T18:17:50Z", "message": "Fix overdone mindless refactoring. :)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f87586ba60aaea42a06fdbea13c26706afce3ea6", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/f87586ba60aaea42a06fdbea13c26706afce3ea6", "committedDate": "2020-11-17T19:31:55Z", "message": "Trigger re-check."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c37e863cb207232de159ead29e7546702471da8c", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/c37e863cb207232de159ead29e7546702471da8c", "committedDate": "2020-11-17T20:55:16Z", "message": "Trigger re-check."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "763b1620dca909d297c2566ce55b70ae2971dddc", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/763b1620dca909d297c2566ce55b70ae2971dddc", "committedDate": "2020-11-17T22:42:49Z", "message": "Trigger re-check."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyODk5MDcx", "url": "https://github.com/apache/ozone/pull/1598#pullrequestreview-532899071", "createdAt": "2020-11-17T23:31:55Z", "commit": {"oid": "763b1620dca909d297c2566ce55b70ae2971dddc"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzozMTo1NlrOH1Pxow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QyMzo0ODo0OVrOH1QJDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU5NTA0Mw==", "bodyText": "KEY_TABLE is needed for KeyCreate also, as when ozone.om.enable.filesystem.paths is true, directories are created for KeyCreate also.", "url": "https://github.com/apache/ozone/pull/1598#discussion_r525595043", "createdAt": "2020-11-17T23:31:56Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/file/OMFileCreateResponse.java", "diffHunk": "@@ -23,15 +23,20 @@\n import org.apache.hadoop.ozone.om.helpers.OmBucketInfo;\n import org.apache.hadoop.ozone.om.helpers.OmKeyInfo;\n import org.apache.hadoop.ozone.om.helpers.OmVolumeArgs;\n+import org.apache.hadoop.ozone.om.response.CleanupTableInfo;\n import org.apache.hadoop.ozone.om.response.key.OMKeyCreateResponse;\n import org.apache.hadoop.ozone.protocol.proto.OzoneManagerProtocolProtos\n     .OMResponse;\n \n import java.util.List;\n \n+import static org.apache.hadoop.ozone.om.OmMetadataManagerImpl.KEY_TABLE;\n+import static org.apache.hadoop.ozone.om.OmMetadataManagerImpl.OPEN_KEY_TABLE;\n+\n /**\n  * Response for crate file request.\n  */\n+@CleanupTableInfo(cleanupTables = {KEY_TABLE, OPEN_KEY_TABLE})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "763b1620dca909d297c2566ce55b70ae2971dddc"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYwMTAzOA==", "bodyText": "Here we have checked only tables which are not part of FileCreateResponse cleanupTable annotation.\nDo we want to check tables which are affected also.\nJust a question, not got what these lines are testing? (Is it just to see any tables which are not affected have same size in Cache) But how this is verifying fix, not sure if i am missing something basic here.", "url": "https://github.com/apache/ozone/pull/1598#discussion_r525601038", "createdAt": "2020-11-17T23:48:49Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/test/java/org/apache/hadoop/ozone/om/response/TestCleanupTableInfo.java", "diffHunk": "@@ -66,4 +105,188 @@ public void checkAnnotationAndTableName() throws Exception {\n       }\n     });\n   }\n+\n+  @Test\n+  public void testHDDS4478() throws Exception {\n+    HddsProtos.BlockID blockID = new BlockID(1, 1).getProtobuf();\n+    String volume = \"testVol\";\n+    String bucket = \"testBuck\";\n+    String key = \"/foo/bar/baz/key\";\n+\n+\n+    OMFileCreateRequest request =\n+        anOmFileCreateRequest(blockID, volume, bucket, key);\n+\n+    OMMetadataManager omMetaMgr = createOMMetadataManagerSpy();\n+    OMMetrics omMetrics = mock(OMMetrics.class);\n+    OzoneManager om =\n+        createOzoneManagerMock(volume, bucket, request, omMetaMgr, omMetrics);\n+\n+    OmVolumeArgs volumeArgs = aVolumeArgs(volume);\n+    OmBucketInfo bucketInfo = aBucketInfo(volume, bucket);\n+    addVolumeToMetaTable(volume, volumeArgs, omMetaMgr);\n+    addBucketToMetaTable(volume, bucket, bucketInfo, omMetaMgr);\n+\n+    OzoneManagerDoubleBufferHelper dbh =\n+        mock(OzoneManagerDoubleBufferHelper.class);\n+\n+    Map<String, Integer> cacheItemCount = new HashMap<>();\n+    for (String tableName : omMetaMgr.listTableNames()){\n+      cacheItemCount.put(tableName,\n+          Iterators.size(omMetaMgr.getTable(tableName).cacheIterator()));\n+    }\n+\n+\n+    request.validateAndUpdateCache(om, 1, dbh);\n+\n+\n+    CleanupTableInfo ann =\n+        OMFileCreateResponse.class.getAnnotation(CleanupTableInfo.class);\n+    List<String> cleanup = Arrays.asList(ann.cleanupTables());\n+    for (String tableName : omMetaMgr.listTableNames()) {\n+      if (!cleanup.contains(tableName)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "763b1620dca909d297c2566ce55b70ae2971dddc"}, "originalPosition": 101}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3f2f3e78b5c6387309a35d36dbf5175c192772d", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/d3f2f3e78b5c6387309a35d36dbf5175c192772d", "committedDate": "2020-11-19T02:38:45Z", "message": "Added Junit test for KeyCreateResponse case came from the review.\n\nRefactored the test to make the real test methods easy to understand and free\nfrom setup clutter as much as possible."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e403887f4db52ab65a77c0dbdb8125da035be468", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/e403887f4db52ab65a77c0dbdb8125da035be468", "committedDate": "2020-11-19T02:45:32Z", "message": "Fix checkstyle warnings."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MDg4MjEw", "url": "https://github.com/apache/ozone/pull/1598#pullrequestreview-534088210", "createdAt": "2020-11-19T05:17:17Z", "commit": {"oid": "e403887f4db52ab65a77c0dbdb8125da035be468"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2455eb167f455cc7bd35ea2a1500851c4d6002f", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/e2455eb167f455cc7bd35ea2a1500851c4d6002f", "committedDate": "2020-11-19T10:40:26Z", "message": "Trigger re-check."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae46f08910cc5c9966f69e20a37e1ee35aad7e05", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/ae46f08910cc5c9966f69e20a37e1ee35aad7e05", "committedDate": "2020-11-19T11:48:21Z", "message": "Trigger re-check."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0OTE3Mjky", "url": "https://github.com/apache/ozone/pull/1598#pullrequestreview-534917292", "createdAt": "2020-11-19T22:41:31Z", "commit": {"oid": "ae46f08910cc5c9966f69e20a37e1ee35aad7e05"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2307, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}