{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0NzU5NDY1", "number": 1730, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQyMDo1ODozOFrOFL5iUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQyMDo1ODozOFrOFL5iUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ4MDIxMzI5OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/keyvalue/KeyValueContainer.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQyMDo1ODozOFrOIPV4mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QxNDo1MDowMFrOIPvS2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk1ODEwNg==", "bodyText": "The exception here should be a rare occurrence, so we are almost always going to have to escalate the read lock into a write lock. I think it would be simpler to just take the write lock at the start and forget about the read lock.\nThe part of the code under the read lock should be very fast, and the code under the write lock may be slow (compactDB) so I suspect we are saving very little by doing some work under the read lock. I think this lock is also only for this container (not for all containers on the DN) so contention should not be a big issue.\nWhat do you think?", "url": "https://github.com/apache/ozone/pull/1730#discussion_r552958106", "createdAt": "2021-01-06T20:58:38Z", "author": {"login": "sodonnel"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/keyvalue/KeyValueContainer.java", "diffHunk": "@@ -516,22 +516,36 @@ public void importContainerData(InputStream input,\n   @Override\n   public void exportContainerData(OutputStream destination,\n       ContainerPacker<KeyValueContainerData> packer) throws IOException {\n-    // Closed/ Quasi closed containers are considered for replication by\n-    // replication manager if they are under-replicated.\n-    ContainerProtos.ContainerDataProto.State state =\n-        getContainerData().getState();\n-    if (!(state == ContainerProtos.ContainerDataProto.State.CLOSED ||\n-        state == ContainerDataProto.State.QUASI_CLOSED)) {\n-      throw new IllegalStateException(\n-          \"Only closed/quasi closed containers could be exported: \" +\n-              \"Where as ContainerId=\"\n-              + getContainerData().getContainerID() + \" is in state \" + state);\n+    readLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ae7e06f27a0efefb9252eb99d7da912f7793946"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk3OTIxNA==", "bodyText": "Agreed, the first read lock can be removed.  I think we need to keep the second one, though (for packer.pack()).", "url": "https://github.com/apache/ozone/pull/1730#discussion_r552979214", "createdAt": "2021-01-06T21:53:05Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/keyvalue/KeyValueContainer.java", "diffHunk": "@@ -516,22 +516,36 @@ public void importContainerData(InputStream input,\n   @Override\n   public void exportContainerData(OutputStream destination,\n       ContainerPacker<KeyValueContainerData> packer) throws IOException {\n-    // Closed/ Quasi closed containers are considered for replication by\n-    // replication manager if they are under-replicated.\n-    ContainerProtos.ContainerDataProto.State state =\n-        getContainerData().getState();\n-    if (!(state == ContainerProtos.ContainerDataProto.State.CLOSED ||\n-        state == ContainerDataProto.State.QUASI_CLOSED)) {\n-      throw new IllegalStateException(\n-          \"Only closed/quasi closed containers could be exported: \" +\n-              \"Where as ContainerId=\"\n-              + getContainerData().getContainerID() + \" is in state \" + state);\n+    readLock();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk1ODEwNg=="}, "originalCommit": {"oid": "1ae7e06f27a0efefb9252eb99d7da912f7793946"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzA5NDYwOQ==", "bodyText": "Agreed, the first read lock can be removed. I think we need to keep the second one, though (for packer.pack()).\n\nAgree +1", "url": "https://github.com/apache/ozone/pull/1730#discussion_r553094609", "createdAt": "2021-01-07T03:52:06Z", "author": {"login": "lamberken"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/keyvalue/KeyValueContainer.java", "diffHunk": "@@ -516,22 +516,36 @@ public void importContainerData(InputStream input,\n   @Override\n   public void exportContainerData(OutputStream destination,\n       ContainerPacker<KeyValueContainerData> packer) throws IOException {\n-    // Closed/ Quasi closed containers are considered for replication by\n-    // replication manager if they are under-replicated.\n-    ContainerProtos.ContainerDataProto.State state =\n-        getContainerData().getState();\n-    if (!(state == ContainerProtos.ContainerDataProto.State.CLOSED ||\n-        state == ContainerDataProto.State.QUASI_CLOSED)) {\n-      throw new IllegalStateException(\n-          \"Only closed/quasi closed containers could be exported: \" +\n-              \"Where as ContainerId=\"\n-              + getContainerData().getContainerID() + \" is in state \" + state);\n+    readLock();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk1ODEwNg=="}, "originalCommit": {"oid": "1ae7e06f27a0efefb9252eb99d7da912f7793946"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzM3NDQyNQ==", "bodyText": "Thanks @sodonnel for the suggestion.  Patch is updated accordingly, can you please take another look?", "url": "https://github.com/apache/ozone/pull/1730#discussion_r553374425", "createdAt": "2021-01-07T14:50:00Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/keyvalue/KeyValueContainer.java", "diffHunk": "@@ -516,22 +516,36 @@ public void importContainerData(InputStream input,\n   @Override\n   public void exportContainerData(OutputStream destination,\n       ContainerPacker<KeyValueContainerData> packer) throws IOException {\n-    // Closed/ Quasi closed containers are considered for replication by\n-    // replication manager if they are under-replicated.\n-    ContainerProtos.ContainerDataProto.State state =\n-        getContainerData().getState();\n-    if (!(state == ContainerProtos.ContainerDataProto.State.CLOSED ||\n-        state == ContainerDataProto.State.QUASI_CLOSED)) {\n-      throw new IllegalStateException(\n-          \"Only closed/quasi closed containers could be exported: \" +\n-              \"Where as ContainerId=\"\n-              + getContainerData().getContainerID() + \" is in state \" + state);\n+    readLock();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk1ODEwNg=="}, "originalCommit": {"oid": "1ae7e06f27a0efefb9252eb99d7da912f7793946"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4475, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}