{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyNDgxNDcz", "number": 623, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QxMjozNDowNlrODmA1eA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxMzowNTo1NFrODotkbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTg2MTY4OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/key/OMKeyCreateResponse.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QxMjozNDowNlrOFzOCxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxMzo0MTowNVrOF2e-ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1MTc4MQ==", "bodyText": "lets wrap around LOG.isDebugEnabled()", "url": "https://github.com/apache/ozone/pull/623#discussion_r389251781", "createdAt": "2020-03-07T12:34:06Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/key/OMKeyCreateResponse.java", "diffHunk": "@@ -60,6 +68,22 @@ protected void addToDBBatch(OMMetadataManager omMetadataManager,\n         omKeyInfo.getBucketName(), omKeyInfo.getKeyName(), openKeySessionID);\n     omMetadataManager.getOpenKeyTable().putWithBatch(batchOperation,\n         openKey, omKeyInfo);\n+    /**\n+     * Create parent directory entries during Key Create - do not wait\n+     * for Key Commit request.\n+     * XXX handle stale directory entries.\n+     */\n+    if (parentKeyInfos != null) {\n+      for (OmKeyInfo parentKeyInfo : parentKeyInfos) {\n+        String parentKey = omMetadataManager\n+            .getOzoneDirKey(parentKeyInfo.getVolumeName(),\n+                parentKeyInfo.getBucketName(), parentKeyInfo.getKeyName());\n+        LOG.debug(\"putWithBatch adding parent : key {} info : {}\", parentKey,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d88b3d9d994fba01da45bea8f5036718000a0c28"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3NTAxMQ==", "bodyText": "done", "url": "https://github.com/apache/ozone/pull/623#discussion_r392675011", "createdAt": "2020-03-15T13:41:05Z", "author": {"login": "supratimdeka"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/key/OMKeyCreateResponse.java", "diffHunk": "@@ -60,6 +68,22 @@ protected void addToDBBatch(OMMetadataManager omMetadataManager,\n         omKeyInfo.getBucketName(), omKeyInfo.getKeyName(), openKeySessionID);\n     omMetadataManager.getOpenKeyTable().putWithBatch(batchOperation,\n         openKey, omKeyInfo);\n+    /**\n+     * Create parent directory entries during Key Create - do not wait\n+     * for Key Commit request.\n+     * XXX handle stale directory entries.\n+     */\n+    if (parentKeyInfos != null) {\n+      for (OmKeyInfo parentKeyInfo : parentKeyInfos) {\n+        String parentKey = omMetadataManager\n+            .getOzoneDirKey(parentKeyInfo.getVolumeName(),\n+                parentKeyInfo.getBucketName(), parentKeyInfo.getKeyName());\n+        LOG.debug(\"putWithBatch adding parent : key {} info : {}\", parentKey,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1MTc4MQ=="}, "originalCommit": {"oid": "d88b3d9d994fba01da45bea8f5036718000a0c28"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTg3NDY5OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QxMzowNDozOVrOFzOJPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxMzozOTo0OVrOF2e-RA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1MzQzNg==", "bodyText": "createPrefixEntries can we rename this as prefixEntriesEnabled?", "url": "https://github.com/apache/ozone/pull/623#discussion_r389253436", "createdAt": "2020-03-07T13:04:39Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "diffHunk": "@@ -379,6 +358,65 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n     return omClientResponse;\n   }\n \n+  private void checkAllParentsExist(OzoneManager ozoneManager,\n+      KeyArgs keyArgs,\n+      OMFileRequest.OMPathInfo pathInfo) throws IOException {\n+    Boolean canBeCreated = false;\n+    String keyName = keyArgs.getKeyName();\n+    OMFileRequest.OMDirectoryResult omDirectoryResult =\n+        pathInfo.getDirectoryResult();\n+\n+    if (ozoneManager.createPrefixEntries()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d88b3d9d994fba01da45bea8f5036718000a0c28"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3NDg4NA==", "bodyText": "this control/config function has been removed from OzoneManager.", "url": "https://github.com/apache/ozone/pull/623#discussion_r392674884", "createdAt": "2020-03-15T13:39:49Z", "author": {"login": "supratimdeka"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "diffHunk": "@@ -379,6 +358,65 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n     return omClientResponse;\n   }\n \n+  private void checkAllParentsExist(OzoneManager ozoneManager,\n+      KeyArgs keyArgs,\n+      OMFileRequest.OMPathInfo pathInfo) throws IOException {\n+    Boolean canBeCreated = false;\n+    String keyName = keyArgs.getKeyName();\n+    OMFileRequest.OMDirectoryResult omDirectoryResult =\n+        pathInfo.getDirectoryResult();\n+\n+    if (ozoneManager.createPrefixEntries()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1MzQzNg=="}, "originalCommit": {"oid": "d88b3d9d994fba01da45bea8f5036718000a0c28"}, "originalPosition": 115}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTg3NjM0OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QxMzowODoxM1rOFzOKCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxMzozOToxMVrOF2e-Cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1MzY0MQ==", "bodyText": "we can throw an exception here, as parent does not exsit.", "url": "https://github.com/apache/ozone/pull/623#discussion_r389253641", "createdAt": "2020-03-07T13:08:13Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "diffHunk": "@@ -379,6 +358,65 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n     return omClientResponse;\n   }\n \n+  private void checkAllParentsExist(OzoneManager ozoneManager,\n+      KeyArgs keyArgs,\n+      OMFileRequest.OMPathInfo pathInfo) throws IOException {\n+    Boolean canBeCreated = false;\n+    String keyName = keyArgs.getKeyName();\n+    OMFileRequest.OMDirectoryResult omDirectoryResult =\n+        pathInfo.getDirectoryResult();\n+\n+    if (ozoneManager.createPrefixEntries()) {\n+      // if immediate parent exists, assume higher level directories exist.\n+      if (pathInfo.getDirectParentExists()) {\n+        canBeCreated = true;\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d88b3d9d994fba01da45bea8f5036718000a0c28"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3NDgyNw==", "bodyText": "Code has changed", "url": "https://github.com/apache/ozone/pull/623#discussion_r392674827", "createdAt": "2020-03-15T13:39:11Z", "author": {"login": "supratimdeka"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "diffHunk": "@@ -379,6 +358,65 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n     return omClientResponse;\n   }\n \n+  private void checkAllParentsExist(OzoneManager ozoneManager,\n+      KeyArgs keyArgs,\n+      OMFileRequest.OMPathInfo pathInfo) throws IOException {\n+    Boolean canBeCreated = false;\n+    String keyName = keyArgs.getKeyName();\n+    OMFileRequest.OMDirectoryResult omDirectoryResult =\n+        pathInfo.getDirectoryResult();\n+\n+    if (ozoneManager.createPrefixEntries()) {\n+      // if immediate parent exists, assume higher level directories exist.\n+      if (pathInfo.getDirectParentExists()) {\n+        canBeCreated = true;\n+      }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1MzY0MQ=="}, "originalCommit": {"oid": "d88b3d9d994fba01da45bea8f5036718000a0c28"}, "originalPosition": 119}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTg3Njc1OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QxMzowODo0MVrOFzOKNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxMzozOTowMlrOF2e-Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1MzY4Ng==", "bodyText": "The exception here should be something like file exists in the actual path.", "url": "https://github.com/apache/ozone/pull/623#discussion_r389253686", "createdAt": "2020-03-07T13:08:41Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "diffHunk": "@@ -379,6 +358,65 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n     return omClientResponse;\n   }\n \n+  private void checkAllParentsExist(OzoneManager ozoneManager,\n+      KeyArgs keyArgs,\n+      OMFileRequest.OMPathInfo pathInfo) throws IOException {\n+    Boolean canBeCreated = false;\n+    String keyName = keyArgs.getKeyName();\n+    OMFileRequest.OMDirectoryResult omDirectoryResult =\n+        pathInfo.getDirectoryResult();\n+\n+    if (ozoneManager.createPrefixEntries()) {\n+      // if immediate parent exists, assume higher level directories exist.\n+      if (pathInfo.getDirectParentExists()) {\n+        canBeCreated = true;\n+      }\n+    } else {\n+      String volumeName = keyArgs.getVolumeName();\n+      String bucketName = keyArgs.getBucketName();\n+\n+      // We cannot create a file if complete parent directories don't exist.\n+\n+      // verifyFilesInPath, checks only the path and its parent directories.\n+      // But there may be some keys below the given path. So this method\n+      // checks them.\n+\n+      // Example:\n+      // Existing keys in table\n+      // a/b/c/d/e\n+      // a/b/c/d/f\n+      // a/b\n+\n+      // Take an example if given key to be created with isRecursive set\n+      // to false is \"a/b/c/e\".\n+      // There is no key in keyTable with the provided path.\n+      // Check in case if there are keys exist in given path. (This can\n+      // happen if keys are directly created using key requests.)\n+\n+      // We need to do this check only in the case of non-recursive, so\n+      // not included the checks done in checkKeysUnderPath in\n+      // verifyFilesInPath method, as that method is common method for\n+      // directory and file create request. This also avoid's this\n+      // unnecessary check which is not required for those cases.\n+      if (omDirectoryResult == NONE ||\n+          omDirectoryResult == DIRECTORY_EXISTS_IN_GIVENPATH) {\n+        canBeCreated =\n+            checkKeysUnderPath(ozoneManager.getMetadataManager(), volumeName,\n+                bucketName, keyName);\n+      } else if (omDirectoryResult == FILE_EXISTS_IN_GIVENPATH) {\n+        canBeCreated = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d88b3d9d994fba01da45bea8f5036718000a0c28"}, "originalPosition": 153}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3NDgxOA==", "bodyText": "This code has changed.", "url": "https://github.com/apache/ozone/pull/623#discussion_r392674818", "createdAt": "2020-03-15T13:39:02Z", "author": {"login": "supratimdeka"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "diffHunk": "@@ -379,6 +358,65 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n     return omClientResponse;\n   }\n \n+  private void checkAllParentsExist(OzoneManager ozoneManager,\n+      KeyArgs keyArgs,\n+      OMFileRequest.OMPathInfo pathInfo) throws IOException {\n+    Boolean canBeCreated = false;\n+    String keyName = keyArgs.getKeyName();\n+    OMFileRequest.OMDirectoryResult omDirectoryResult =\n+        pathInfo.getDirectoryResult();\n+\n+    if (ozoneManager.createPrefixEntries()) {\n+      // if immediate parent exists, assume higher level directories exist.\n+      if (pathInfo.getDirectParentExists()) {\n+        canBeCreated = true;\n+      }\n+    } else {\n+      String volumeName = keyArgs.getVolumeName();\n+      String bucketName = keyArgs.getBucketName();\n+\n+      // We cannot create a file if complete parent directories don't exist.\n+\n+      // verifyFilesInPath, checks only the path and its parent directories.\n+      // But there may be some keys below the given path. So this method\n+      // checks them.\n+\n+      // Example:\n+      // Existing keys in table\n+      // a/b/c/d/e\n+      // a/b/c/d/f\n+      // a/b\n+\n+      // Take an example if given key to be created with isRecursive set\n+      // to false is \"a/b/c/e\".\n+      // There is no key in keyTable with the provided path.\n+      // Check in case if there are keys exist in given path. (This can\n+      // happen if keys are directly created using key requests.)\n+\n+      // We need to do this check only in the case of non-recursive, so\n+      // not included the checks done in checkKeysUnderPath in\n+      // verifyFilesInPath method, as that method is common method for\n+      // directory and file create request. This also avoid's this\n+      // unnecessary check which is not required for those cases.\n+      if (omDirectoryResult == NONE ||\n+          omDirectoryResult == DIRECTORY_EXISTS_IN_GIVENPATH) {\n+        canBeCreated =\n+            checkKeysUnderPath(ozoneManager.getMetadataManager(), volumeName,\n+                bucketName, keyName);\n+      } else if (omDirectoryResult == FILE_EXISTS_IN_GIVENPATH) {\n+        canBeCreated = false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1MzY4Ng=="}, "originalCommit": {"oid": "d88b3d9d994fba01da45bea8f5036718000a0c28"}, "originalPosition": 153}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTkwMzI4OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/key/OMKeyCreateResponse.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QxNDowNDo0MlrOFzOW3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxMzozNDo1MFrOF2e8qQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1NjkyNA==", "bodyText": "Ideally, I feel we should create a directory prefix before the key/file prefix. this improves the readability.", "url": "https://github.com/apache/ozone/pull/623#discussion_r389256924", "createdAt": "2020-03-07T14:04:42Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/key/OMKeyCreateResponse.java", "diffHunk": "@@ -60,6 +68,22 @@ protected void addToDBBatch(OMMetadataManager omMetadataManager,\n         omKeyInfo.getBucketName(), omKeyInfo.getKeyName(), openKeySessionID);\n     omMetadataManager.getOpenKeyTable().putWithBatch(batchOperation,\n         openKey, omKeyInfo);\n+    /**\n+     * Create parent directory entries during Key Create - do not wait", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d88b3d9d994fba01da45bea8f5036718000a0c28"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1NzI0Mw==", "bodyText": "let's also follow the same order in DirectoryCreateResponse.", "url": "https://github.com/apache/ozone/pull/623#discussion_r389257243", "createdAt": "2020-03-07T14:09:50Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/key/OMKeyCreateResponse.java", "diffHunk": "@@ -60,6 +68,22 @@ protected void addToDBBatch(OMMetadataManager omMetadataManager,\n         omKeyInfo.getBucketName(), omKeyInfo.getKeyName(), openKeySessionID);\n     omMetadataManager.getOpenKeyTable().putWithBatch(batchOperation,\n         openKey, omKeyInfo);\n+    /**\n+     * Create parent directory entries during Key Create - do not wait", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1NjkyNA=="}, "originalCommit": {"oid": "d88b3d9d994fba01da45bea8f5036718000a0c28"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3NDQ3Mw==", "bodyText": "done", "url": "https://github.com/apache/ozone/pull/623#discussion_r392674473", "createdAt": "2020-03-15T13:34:50Z", "author": {"login": "supratimdeka"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/key/OMKeyCreateResponse.java", "diffHunk": "@@ -60,6 +68,22 @@ protected void addToDBBatch(OMMetadataManager omMetadataManager,\n         omKeyInfo.getBucketName(), omKeyInfo.getKeyName(), openKeySessionID);\n     omMetadataManager.getOpenKeyTable().putWithBatch(batchOperation,\n         openKey, omKeyInfo);\n+    /**\n+     * Create parent directory entries during Key Create - do not wait", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1NjkyNA=="}, "originalCommit": {"oid": "d88b3d9d994fba01da45bea8f5036718000a0c28"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTkwNzEyOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QxNDoxMTo0NFrOFzOYrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxMzozNDozOVrOF2e8og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1NzM4OA==", "bodyText": "lets also add these to the cache as well.", "url": "https://github.com/apache/ozone/pull/623#discussion_r389257388", "createdAt": "2020-03-07T14:11:44Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "diffHunk": "@@ -325,7 +304,7 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           .setOpenVersion(openVersion).build())\n           .setCmdType(Type.CreateFile);\n       omClientResponse = new OMFileCreateResponse(omResponse.build(),\n-          omKeyInfo, clientID);\n+          omKeyInfo, missingParentInfos, clientID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d88b3d9d994fba01da45bea8f5036718000a0c28"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3NDQ2Ng==", "bodyText": "done", "url": "https://github.com/apache/ozone/pull/623#discussion_r392674466", "createdAt": "2020-03-15T13:34:39Z", "author": {"login": "supratimdeka"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "diffHunk": "@@ -325,7 +304,7 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           .setOpenVersion(openVersion).build())\n           .setCmdType(Type.CreateFile);\n       omClientResponse = new OMFileCreateResponse(omResponse.build(),\n-          omKeyInfo, clientID);\n+          omKeyInfo, missingParentInfos, clientID);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1NzM4OA=="}, "originalCommit": {"oid": "d88b3d9d994fba01da45bea8f5036718000a0c28"}, "originalPosition": 99}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTkyMDAzOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileRequest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QxNDozODozMFrOFzOe_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxMzozNDoyNlrOF2e8jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1OTAwNg==", "bodyText": "This should be false as this is a file and not a directory", "url": "https://github.com/apache/ozone/pull/623#discussion_r389259006", "createdAt": "2020-03-07T14:38:30Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileRequest.java", "diffHunk": "@@ -80,6 +91,7 @@ public static OMPathInfo verifyFilesInPath(\n         // Check if this is actual file or a file in the given path\n         if (dbKeyName.equals(fileNameFromDetails)) {\n           result = OMDirectoryResult.FILE_EXISTS;\n+          parentExists = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d88b3d9d994fba01da45bea8f5036718000a0c28"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3NDQ0Ng==", "bodyText": "removed the special handling for parentExists as suggested in another comment.\nnow the same condition is determined using an empty missingParents list.", "url": "https://github.com/apache/ozone/pull/623#discussion_r392674446", "createdAt": "2020-03-15T13:34:26Z", "author": {"login": "supratimdeka"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileRequest.java", "diffHunk": "@@ -80,6 +91,7 @@ public static OMPathInfo verifyFilesInPath(\n         // Check if this is actual file or a file in the given path\n         if (dbKeyName.equals(fileNameFromDetails)) {\n           result = OMDirectoryResult.FILE_EXISTS;\n+          parentExists = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1OTAwNg=="}, "originalCommit": {"oid": "d88b3d9d994fba01da45bea8f5036718000a0c28"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTkyNDA1OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileRequest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QxNDo0NzoyOFrOFzOg_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxMzozMzozOVrOF2e8Tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1OTUxNg==", "bodyText": "this is false always.", "url": "https://github.com/apache/ozone/pull/623#discussion_r389259516", "createdAt": "2020-03-07T14:47:28Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileRequest.java", "diffHunk": "@@ -105,24 +120,37 @@ public static OMPathInfo verifyFilesInPath(\n \n         LOG.trace(\"verifyFiles in Path : \" + \"/\" + volumeName\n             + \"/\" + bucketName + \"/\" + keyName + \":\" + result);\n-        return new OMPathInfo(missing, result, inheritAcls);\n+        // if file exists, so does the parent. Assert.\n+        Preconditions.checkState((result != OMDirectoryResult.FILE_EXISTS)\n+            || (parentExists));\n+\n+        return new OMPathInfo(missing, result, inheritAcls, parentExists);\n       }\n       keyPath = keyPath.getParent();\n     }\n \n     if (inheritAcls.isEmpty()) {\n-      String bucketKey = omMetadataManager.getBucketKey(volumeName, bucketName);\n-      inheritAcls = omMetadataManager.getBucketTable().get(bucketKey).getAcls();\n+      String bucketKey = omMetadataManager.getBucketKey(volumeName,\n+          bucketName);\n+      inheritAcls = omMetadataManager.getBucketTable().get(bucketKey)\n+          .getAcls();\n       LOG.trace(\"Acls inherited from bucket \" + bucketName + \" are : \"\n           + inheritAcls);\n     }\n \n     LOG.trace(\"verifyFiles in Path : \" + volumeName + \"/\" + bucketName + \"/\"\n         + keyName + \":\" + result);\n+    // parentExists always true if we are creating inside root dir\n+    Preconditions.checkState(!pathIsRootDir(immediateParentPath)\n+        || parentExists);\n     // Found no files/ directories in the given path.\n-    return new OMPathInfo(missing, OMDirectoryResult.NONE, inheritAcls);\n+    return new OMPathInfo(missing, OMDirectoryResult.NONE, inheritAcls,\n+        parentExists);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d88b3d9d994fba01da45bea8f5036718000a0c28"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3NDM4Mw==", "bodyText": "the function has changed. this comment gets resolved indirectly", "url": "https://github.com/apache/ozone/pull/623#discussion_r392674383", "createdAt": "2020-03-15T13:33:39Z", "author": {"login": "supratimdeka"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileRequest.java", "diffHunk": "@@ -105,24 +120,37 @@ public static OMPathInfo verifyFilesInPath(\n \n         LOG.trace(\"verifyFiles in Path : \" + \"/\" + volumeName\n             + \"/\" + bucketName + \"/\" + keyName + \":\" + result);\n-        return new OMPathInfo(missing, result, inheritAcls);\n+        // if file exists, so does the parent. Assert.\n+        Preconditions.checkState((result != OMDirectoryResult.FILE_EXISTS)\n+            || (parentExists));\n+\n+        return new OMPathInfo(missing, result, inheritAcls, parentExists);\n       }\n       keyPath = keyPath.getParent();\n     }\n \n     if (inheritAcls.isEmpty()) {\n-      String bucketKey = omMetadataManager.getBucketKey(volumeName, bucketName);\n-      inheritAcls = omMetadataManager.getBucketTable().get(bucketKey).getAcls();\n+      String bucketKey = omMetadataManager.getBucketKey(volumeName,\n+          bucketName);\n+      inheritAcls = omMetadataManager.getBucketTable().get(bucketKey)\n+          .getAcls();\n       LOG.trace(\"Acls inherited from bucket \" + bucketName + \" are : \"\n           + inheritAcls);\n     }\n \n     LOG.trace(\"verifyFiles in Path : \" + volumeName + \"/\" + bucketName + \"/\"\n         + keyName + \":\" + result);\n+    // parentExists always true if we are creating inside root dir\n+    Preconditions.checkState(!pathIsRootDir(immediateParentPath)\n+        || parentExists);\n     // Found no files/ directories in the given path.\n-    return new OMPathInfo(missing, OMDirectoryResult.NONE, inheritAcls);\n+    return new OMPathInfo(missing, OMDirectoryResult.NONE, inheritAcls,\n+        parentExists);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1OTUxNg=="}, "originalCommit": {"oid": "d88b3d9d994fba01da45bea8f5036718000a0c28"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTkyNTgyOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QxNDo1MToxMFrOFzOh3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxMzozMjo1MVrOF2e7_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1OTc0Mg==", "bodyText": "The check for this is same as missingparents as null ?", "url": "https://github.com/apache/ozone/pull/623#discussion_r389259742", "createdAt": "2020-03-07T14:51:10Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "diffHunk": "@@ -379,6 +358,65 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n     return omClientResponse;\n   }\n \n+  private void checkAllParentsExist(OzoneManager ozoneManager,\n+      KeyArgs keyArgs,\n+      OMFileRequest.OMPathInfo pathInfo) throws IOException {\n+    Boolean canBeCreated = false;\n+    String keyName = keyArgs.getKeyName();\n+    OMFileRequest.OMDirectoryResult omDirectoryResult =\n+        pathInfo.getDirectoryResult();\n+\n+    if (ozoneManager.createPrefixEntries()) {\n+      // if immediate parent exists, assume higher level directories exist.\n+      if (pathInfo.getDirectParentExists()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d88b3d9d994fba01da45bea8f5036718000a0c28"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3NDMwMw==", "bodyText": "done", "url": "https://github.com/apache/ozone/pull/623#discussion_r392674303", "createdAt": "2020-03-15T13:32:51Z", "author": {"login": "supratimdeka"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "diffHunk": "@@ -379,6 +358,65 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n     return omClientResponse;\n   }\n \n+  private void checkAllParentsExist(OzoneManager ozoneManager,\n+      KeyArgs keyArgs,\n+      OMFileRequest.OMPathInfo pathInfo) throws IOException {\n+    Boolean canBeCreated = false;\n+    String keyName = keyArgs.getKeyName();\n+    OMFileRequest.OMDirectoryResult omDirectoryResult =\n+        pathInfo.getDirectoryResult();\n+\n+    if (ozoneManager.createPrefixEntries()) {\n+      // if immediate parent exists, assume higher level directories exist.\n+      if (pathInfo.getDirectParentExists()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI1OTc0Mg=="}, "originalCommit": {"oid": "d88b3d9d994fba01da45bea8f5036718000a0c28"}, "originalPosition": 117}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTkyODAwOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMDirectoryCreateRequest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QxNDo1NjoyNFrOFzOi8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxMzozMjozM1rOF2e75Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI2MDAxNw==", "bodyText": "both createDirectoryKeyInfoWithACL & createDirectoryKeyInfo can be collapsed into one function.", "url": "https://github.com/apache/ozone/pull/623#discussion_r389260017", "createdAt": "2020-03-07T14:56:24Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMDirectoryCreateRequest.java", "diffHunk": "@@ -347,7 +371,7 @@ private OmKeyInfo createDirectoryKeyInfoWithACL(OzoneManager ozoneManager,\n         .build();\n   }\n \n-  private OmKeyInfo createDirectoryKeyInfo(OzoneManager ozoneManager,\n+  private static OmKeyInfo createDirectoryKeyInfo(OzoneManager ozoneManager,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d88b3d9d994fba01da45bea8f5036718000a0c28"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY3NDI3Nw==", "bodyText": "done", "url": "https://github.com/apache/ozone/pull/623#discussion_r392674277", "createdAt": "2020-03-15T13:32:33Z", "author": {"login": "supratimdeka"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMDirectoryCreateRequest.java", "diffHunk": "@@ -347,7 +371,7 @@ private OmKeyInfo createDirectoryKeyInfoWithACL(OzoneManager ozoneManager,\n         .build();\n   }\n \n-  private OmKeyInfo createDirectoryKeyInfo(OzoneManager ozoneManager,\n+  private static OmKeyInfo createDirectoryKeyInfo(OzoneManager ozoneManager,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI2MDAxNw=="}, "originalCommit": {"oid": "d88b3d9d994fba01da45bea8f5036718000a0c28"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNDAyNzMwOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/om/TestKeyManagerImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxNjozNTozMFrOF2f7RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxNjozNTozMFrOF2f7RA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MDUwMA==", "bodyText": "Why is this test obsolete ?", "url": "https://github.com/apache/ozone/pull/623#discussion_r392690500", "createdAt": "2020-03-15T16:35:30Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/om/TestKeyManagerImpl.java", "diffHunk": "@@ -418,6 +412,8 @@ public void testOpenFile() throws IOException {\n   }\n \n   @Test\n+  @Ignore\n+  // TODO this test relies on KeyManagerImpl.createFile which is obsolete.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ea6ce18f23602be122e3f3e87e0f61b5be470e5"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNDAyNzM4OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/om/TestKeyManagerImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxNjozNTo0MVrOF2f7Uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxNjozNTo0MVrOF2f7Uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MDUxNQ==", "bodyText": "Lets expand the wildcards.", "url": "https://github.com/apache/ozone/pull/623#discussion_r392690515", "createdAt": "2020-03-15T16:35:41Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/om/TestKeyManagerImpl.java", "diffHunk": "@@ -92,13 +92,7 @@\n import org.apache.hadoop.test.LambdaTestUtils;\n \n import org.apache.hadoop.util.Time;\n-import org.junit.After;\n-import org.junit.AfterClass;\n-import org.junit.Assert;\n-import org.junit.Assume;\n-import org.junit.BeforeClass;\n-import org.junit.Rule;\n-import org.junit.Test;\n+import org.junit.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ea6ce18f23602be122e3f3e87e0f61b5be470e5"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MDE2MjM2OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxMzowNTo1NFrOF3bURw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxMzowNTo1NFrOF3bURw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzY2MzU1OQ==", "bodyText": "lets wrap in isDebugEnabled", "url": "https://github.com/apache/ozone/pull/623#discussion_r393663559", "createdAt": "2020-03-17T13:05:54Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "diffHunk": "@@ -175,7 +169,7 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n     // if isRecursive is true, file would be created even if parent\n     // directories does not exist.\n     boolean isRecursive = createFileRequest.getIsRecursive();\n-    LOG.info(\"File create for : \" + volumeName + \"/\" + bucketName + \"/\"\n+    LOG.debug(\"File create for : \" + volumeName + \"/\" + bucketName + \"/\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f59ccf1eae54edad24d54d0bbd843b3ea3247eff"}, "originalPosition": 42}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4937, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}