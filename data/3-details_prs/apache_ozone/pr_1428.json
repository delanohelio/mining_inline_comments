{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3OTAzMzQz", "number": 1428, "title": "HDDS-4192: enable SCM Raft Group based on config ozone.scm.names", "bodyText": "What changes were proposed in this pull request?\nSay ozone.scm.names is ip1,ip2,ip3, scm with ip1 identifies its RaftPeerId as scm1,  scm with ip2 identifies its RaftPeerId as scm2, scm with ip3 identifies its RaftPeerId as scm3. They will automatically become a raft group.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4192\nHow was this patch tested?\nCI", "createdAt": "2020-09-16T10:54:13Z", "url": "https://github.com/apache/ozone/pull/1428", "merged": true, "mergeCommit": {"oid": "7ddaa07d7de696c71113670c2f092cbc14f06658"}, "closed": true, "closedAt": "2020-10-10T03:28:07Z", "author": {"login": "GlenGeng"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJnqW3gH2gAyNDg3OTAzMzQzOjYyYzc1YTQxNGYxOGUxMDI4MzQyYTMzNjU4MzQ4ODI2ZGZmMWIxYjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQ1ykzABqjM4NjAwNDIzMjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "62c75a414f18e1028342a33658348826dff1b1b0", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/62c75a414f18e1028342a33658348826dff1b1b0", "committedDate": "2020-09-17T02:35:07Z", "message": "HDDS-4192: enable SCM Raft Group based on config ozone.scm.names"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "011507e68c7384be0be051f517ccda9aa244b97f", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/011507e68c7384be0be051f517ccda9aa244b97f", "committedDate": "2020-09-16T10:51:26Z", "message": "HDDS-4192: enable SCM Raft Group based on config ozone.scm.names"}, "afterCommit": {"oid": "62c75a414f18e1028342a33658348826dff1b1b0", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/62c75a414f18e1028342a33658348826dff1b1b0", "committedDate": "2020-09-17T02:35:07Z", "message": "HDDS-4192: enable SCM Raft Group based on config ozone.scm.names"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDU3MzQ3", "url": "https://github.com/apache/ozone/pull/1428#pullrequestreview-497057347", "createdAt": "2020-09-27T07:03:05Z", "commit": {"oid": "62c75a414f18e1028342a33658348826dff1b1b0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwNzowMzowNVrOHYlQiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwNzowMzowNVrOHYlQiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUzODMxMw==", "bodyText": "Could we move this self validation to an overall IP validation method so that we could throw in more validation once we are getting close to the ultimate HA config version?", "url": "https://github.com/apache/ozone/pull/1428#discussion_r495538313", "createdAt": "2020-09-27T07:03:05Z", "author": {"login": "timmylicheng"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/ha/SCMRatisServerImpl.java", "diffHunk": "@@ -59,18 +68,62 @@\n   SCMRatisServerImpl(final SCMHAConfiguration haConf,\n                      final ConfigurationSource conf)\n       throws IOException {\n-    final String scmServiceId = \"SCM-HA-Service\";\n-    final String scmNodeId = \"localhost\";\n-    this.raftPeerId = RaftPeerId.getRaftPeerId(scmNodeId);\n+    // If the SCM group starts from OZONE_SCM_NAMES, its raft peers\n+    // should locate on different nodes, and use the same port to\n+    // communicate with each other.\n+    //\n+    // Assume ozone.scm.names is \"ip0,ip1,ip2\", scm with ip0 identifies\n+    // its RaftPeerId as scm0, scm with ip1 identifies its RaftPeerId\n+    // as scm1, scm with ip2 identifies its RaftPeerId as scm2. After\n+    // startup, they will communicate with each other via\n+    // ozone.scm.ha.ratis.bind.port, and form a raft group with\n+    // groupID \"SCM-HA-Service\".\n+    List<String> scmHosts =\n+        Arrays.stream(conf.getTrimmedStrings(ScmConfigKeys.OZONE_SCM_NAMES))\n+            .map(scmName -> HddsUtils.getHostName(scmName).get())\n+            .collect(Collectors.toList());\n+\n     this.address = haConf.getRatisBindAddress();\n-    final RaftPeer localRaftPeer = new RaftPeer(raftPeerId, address);\n+    InetAddress localHost = InetAddress.getLocalHost();\n+\n+    int selfIndex = -1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62c75a414f18e1028342a33658348826dff1b1b0"}, "originalPosition": 65}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4dae8b45a6aed0fb711a0fb25230fa6e633831b7", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/4dae8b45a6aed0fb711a0fb25230fa6e633831b7", "committedDate": "2020-10-09T09:57:19Z", "message": "HDDS-4192: Fix comments"}, "afterCommit": {"oid": "ca9cb783fe5a8d7a7ac2119acad657374231b115", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/ca9cb783fe5a8d7a7ac2119acad657374231b115", "committedDate": "2020-10-09T10:34:58Z", "message": "HDDS-4192: Fix comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ebf168d478fb572ac583b51f181a38affe59114", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/5ebf168d478fb572ac583b51f181a38affe59114", "committedDate": "2020-10-09T11:14:56Z", "message": "HDDS-4192: fix comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ca9cb783fe5a8d7a7ac2119acad657374231b115", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/ca9cb783fe5a8d7a7ac2119acad657374231b115", "committedDate": "2020-10-09T10:34:58Z", "message": "HDDS-4192: Fix comments"}, "afterCommit": {"oid": "5ebf168d478fb572ac583b51f181a38affe59114", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/5ebf168d478fb572ac583b51f181a38affe59114", "committedDate": "2020-10-09T11:14:56Z", "message": "HDDS-4192: fix comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77751832fc88e98001c22e65b8aaff3e8d802198", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/77751832fc88e98001c22e65b8aaff3e8d802198", "committedDate": "2020-10-09T12:59:49Z", "message": "Merge remote-tracking branch 'github/HDDS-2823' into HDDS-4192."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0dde979b1d067244a8a3d22342c86f28dae56289", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/0dde979b1d067244a8a3d22342c86f28dae56289", "committedDate": "2020-10-09T11:50:03Z", "message": "Merge remote-tracking branch 'github/HDDS-2823' into HDDS-4192"}, "afterCommit": {"oid": "77751832fc88e98001c22e65b8aaff3e8d802198", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/77751832fc88e98001c22e65b8aaff3e8d802198", "committedDate": "2020-10-09T12:59:49Z", "message": "Merge remote-tracking branch 'github/HDDS-2823' into HDDS-4192."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2533, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}