{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3MDU5Nzc0", "number": 1324, "title": "HDDS-4068. Client should not retry same OM on network connection failure", "bodyText": "What changes were proposed in this pull request?\nOn connection failure to an OM, client retries 10 times on same OM before failing over to the next OM. This is not optimal. Client should failover to next OM after 1 connection exception. In case the connection exception was spurious, then OM HA failover logic would lead the client to retry on that OM again after trying the other OMs first.\n(Please fill in changes proposed in this fix)\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4068\nHow was this patch tested?\nTested manually on a docker cluster.", "createdAt": "2020-08-12T23:34:49Z", "url": "https://github.com/apache/ozone/pull/1324", "merged": true, "mergeCommit": {"oid": "9292b392207d976ce070940d8979c23bef818969"}, "closed": true, "closedAt": "2020-08-26T22:18:17Z", "author": {"login": "hanishakoneru"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCLYj6AFqTQ3Mzk5ODYxMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCgLV1AFqTQ3NTA2MTEyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczOTk4NjEw", "url": "https://github.com/apache/ozone/pull/1324#pullrequestreview-473998610", "createdAt": "2020-08-24T23:40:40Z", "commit": {"oid": "4014feaa479c310f600c5cb5d47212881f01ba9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQyMzo0MDo0MFrOHF6tGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQyMzo0MDo0MFrOHF6tGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTk2Njc0Ng==", "bodyText": "One question, can we use RetryPolicy TRY_ONCE_THEN_FAIL here?\nBecause in this failoverOnNetworkException, also we set retry count to zero and maxFailOvers to zero.", "url": "https://github.com/apache/ozone/pull/1324#discussion_r475966746", "createdAt": "2020-08-24T23:40:40Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/ha/OMFailoverProxyProvider.java", "diffHunk": "@@ -172,9 +174,12 @@ private OzoneManagerProtocolPB createOMProxy(InetSocketAddress omAddress)\n         LegacyHadoopConfigurationSource.asHadoopConfiguration(conf);\n     RPC.setProtocolEngine(hadoopConf, OzoneManagerProtocolPB.class,\n         ProtobufRpcEngine.class);\n-    return RPC.getProxy(OzoneManagerProtocolPB.class, omVersion, omAddress, ugi,\n-        hadoopConf, NetUtils.getDefaultSocketFactory(hadoopConf),\n-            (int) OmUtils.getOMClientRpcTimeOut(conf));\n+    RetryPolicy connectionRetryPolicy = RetryPolicies\n+        .failoverOnNetworkException(0);\n+    return RPC.getProtocolProxy(OzoneManagerProtocolPB.class, omVersion,\n+        omAddress, ugi, hadoopConf, NetUtils.getDefaultSocketFactory(\n+            hadoopConf), (int) OmUtils.getOMClientRpcTimeOut(conf),\n+        connectionRetryPolicy).getProxy();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4014feaa479c310f600c5cb5d47212881f01ba9b"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb0c246e448fbeb0120c8a04a06704efaa7b0c62", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/eb0c246e448fbeb0120c8a04a06704efaa7b0c62", "committedDate": "2020-08-25T02:49:50Z", "message": "HDDS-4068. Client should not retry same OM on network connection failure"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4014feaa479c310f600c5cb5d47212881f01ba9b", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/4014feaa479c310f600c5cb5d47212881f01ba9b", "committedDate": "2020-08-12T22:40:49Z", "message": "HDDS-4068. Client should not retry same OM on network connection failure"}, "afterCommit": {"oid": "db3d2b1556125db394f788e5fc28a8b7734a9a3b", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/db3d2b1556125db394f788e5fc28a8b7734a9a3b", "committedDate": "2020-08-25T02:53:01Z", "message": "adding comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "db3d2b1556125db394f788e5fc28a8b7734a9a3b", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/db3d2b1556125db394f788e5fc28a8b7734a9a3b", "committedDate": "2020-08-25T02:53:01Z", "message": "adding comments"}, "afterCommit": {"oid": "ef0dcf32cf708a7fe376dc19c97f4b99b7813071", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/ef0dcf32cf708a7fe376dc19c97f4b99b7813071", "committedDate": "2020-08-25T04:11:19Z", "message": "adding comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5aca6fcb4ce3a802e7f8a21aee0fc856bb22319", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/a5aca6fcb4ce3a802e7f8a21aee0fc856bb22319", "committedDate": "2020-08-25T16:00:26Z", "message": "adding comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef0dcf32cf708a7fe376dc19c97f4b99b7813071", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/ef0dcf32cf708a7fe376dc19c97f4b99b7813071", "committedDate": "2020-08-25T04:11:19Z", "message": "adding comments"}, "afterCommit": {"oid": "a5aca6fcb4ce3a802e7f8a21aee0fc856bb22319", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/a5aca6fcb4ce3a802e7f8a21aee0fc856bb22319", "committedDate": "2020-08-25T16:00:26Z", "message": "adding comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1MDYxMTI0", "url": "https://github.com/apache/ozone/pull/1324#pullrequestreview-475061124", "createdAt": "2020-08-25T23:54:26Z", "commit": {"oid": "a5aca6fcb4ce3a802e7f8a21aee0fc856bb22319"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2727, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}