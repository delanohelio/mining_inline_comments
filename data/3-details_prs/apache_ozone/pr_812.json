{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMjM0MjQy", "number": 812, "title": "HDDS-3161. Block illegal characters when creating keys.", "bodyText": "What changes were proposed in this pull request?\nAdded illegal character check (using regular expressions) for key name when creating key.\nFor the definition of illegal characters, I refer to Amazon S3's object key naming guide, which specifies the characters to avoid.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3161\nHow was this patch tested?\n\nRan UTs.\nUsing Ozone Shell to create a key with illegal characters in the name, errors can be detected, like this:", "createdAt": "2020-04-11T19:12:53Z", "url": "https://github.com/apache/ozone/pull/812", "merged": true, "mergeCommit": {"oid": "dd46a55ac8826246d8d7a8e6c01d7cbe197ec61e"}, "closed": true, "closedAt": "2020-06-30T10:01:14Z", "author": {"login": "cku328"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYc_IpAFqTM5NTI1ODUwMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuYm0LgH2gAyNDAyMjM0MjQyOjA3YTgzODZmZTZlNDE1NWRiYjE0MGJhZGJmMDE5MjdkMGUzNjA3OTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MjU4NTAw", "url": "https://github.com/apache/ozone/pull/812#pullrequestreview-395258500", "createdAt": "2020-04-17T08:26:33Z", "commit": {"oid": "2149bc56e20ab04aab00b1539f0d9f057f693115"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwODoyNjozM1rOGHEu0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwODoyNjozM1rOGHEu0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA3MDczOQ==", "bodyText": "Please move this regex to OzoneConsts and please add a simplified example on what characters are not allowed.", "url": "https://github.com/apache/ozone/pull/812#discussion_r410070739", "createdAt": "2020-04-17T08:26:33Z", "author": {"login": "mukul1987"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/client/HddsClientUtils.java", "diffHunk": "@@ -196,6 +196,27 @@ public static void verifyResourceName(String... resourceNames) {\n     }\n   }\n \n+  /**\n+   * verifies that key name is a valid name.\n+   *\n+   * @param keyName key name to be validated\n+   *\n+   * @throws IllegalArgumentException\n+   */\n+  public static void verifyKeyName(String keyName) {\n+    if (keyName == null) {\n+      throw new IllegalArgumentException(\"Key name is null\");\n+    }\n+    String regex = \"^[^^{}<>^?%~#`\\\\[\\\\]\\\\|\\\\\\\\(\\\\x80-\\\\xff)]$\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2149bc56e20ab04aab00b1539f0d9f057f693115"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2149bc56e20ab04aab00b1539f0d9f057f693115", "author": {"user": {"login": "cku328", "name": "Neo Yang"}}, "url": "https://github.com/apache/ozone/commit/2149bc56e20ab04aab00b1539f0d9f057f693115", "committedDate": "2020-04-11T18:05:13Z", "message": "HDDS-3161. Block illegal characters when creating keys."}, "afterCommit": {"oid": "a39cfcef4c0d680bdb61701d87153ba30da36b44", "author": {"user": {"login": "cku328", "name": "Neo Yang"}}, "url": "https://github.com/apache/ozone/commit/a39cfcef4c0d680bdb61701d87153ba30da36b44", "committedDate": "2020-04-19T13:12:43Z", "message": "HDDS-3161. Block illegal characters when creating keys."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a39cfcef4c0d680bdb61701d87153ba30da36b44", "author": {"user": {"login": "cku328", "name": "Neo Yang"}}, "url": "https://github.com/apache/ozone/commit/a39cfcef4c0d680bdb61701d87153ba30da36b44", "committedDate": "2020-04-19T13:12:43Z", "message": "HDDS-3161. Block illegal characters when creating keys."}, "afterCommit": {"oid": "6fba4369308a5f70c6b466b4bf3e9bd720f693a0", "author": {"user": {"login": "cku328", "name": "Neo Yang"}}, "url": "https://github.com/apache/ozone/commit/6fba4369308a5f70c6b466b4bf3e9bd720f693a0", "committedDate": "2020-04-20T15:11:23Z", "message": "Added key name check in some requests.\n\nSigned-off-by: Neo <cku328@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4MzM3NTYz", "url": "https://github.com/apache/ozone/pull/812#pullrequestreview-398337563", "createdAt": "2020-04-22T15:57:07Z", "commit": {"oid": "6fba4369308a5f70c6b466b4bf3e9bd720f693a0"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNTo1NzowOFrOGJ-DJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNjowMDoyNFrOGJ-NHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzEwNjk4MQ==", "bodyText": "Converting each character to string and checking separately with a regex seems more expensive than either individual character comparison or full-string regex check.", "url": "https://github.com/apache/ozone/pull/812#discussion_r413106981", "createdAt": "2020-04-22T15:57:08Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/client/HddsClientUtils.java", "diffHunk": "@@ -196,6 +196,27 @@ public static void verifyResourceName(String... resourceNames) {\n     }\n   }\n \n+  /**\n+   * verifies that key name is a valid name.\n+   *\n+   * @param keyName key name to be validated\n+   *\n+   * @throws IllegalArgumentException\n+   */\n+  public static void verifyKeyName(String keyName) {\n+    if (keyName == null) {\n+      throw new IllegalArgumentException(\"Key name is null\");\n+    }\n+    for (int index = 0; index < keyName.length(); index++) {\n+      char currChar = keyName.charAt(index);\n+      if (!(Character.toString(currChar)\n+              .matches(OzoneConsts.KEYNAME_AVOID_CHARACTERS_REGEX))){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fba4369308a5f70c6b466b4bf3e9bd720f693a0"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzEwOTUzNQ==", "bodyText": "Constants for regex patterns should be pre-compiled (Pattern.compile(...)).", "url": "https://github.com/apache/ozone/pull/812#discussion_r413109535", "createdAt": "2020-04-22T16:00:24Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "diffHunk": "@@ -328,5 +328,19 @@ private OzoneConsts() {\n   public static final String GDPR_SECRET = \"secret\";\n   public static final String GDPR_ALGORITHM = \"algorithm\";\n \n+  /**\n+   * Block key name as illegal characters\n+   *\n+   * This regular expression is used to check if key name\n+   * contains illegal characters when creating/renaming key.\n+   *\n+   * Avoid the following characters in a key name:\n+   * \"\\\", \"{\", \"}\", \"^\", \"<\", \">\", \"#\", \"|\", \"%\", \"`\", \"[\", \"]\", \"~\", \"?\"\n+   * and Non-printable ASCII characters (128\u2013255 decimal characters).\n+   * https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingMetadata.html\n+   */\n+  public static final String KEYNAME_AVOID_CHARACTERS_REGEX =\n+          \"^[^^{}<>^?%~#`\\\\[\\\\]\\\\|\\\\\\\\(\\\\x80-\\\\xff)]$\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fba4369308a5f70c6b466b4bf3e9bd720f693a0"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc8f2f99925d3e64443e776fd31bc6425b507c00", "author": {"user": {"login": "cku328", "name": "Neo Yang"}}, "url": "https://github.com/apache/ozone/commit/fc8f2f99925d3e64443e776fd31bc6425b507c00", "committedDate": "2020-04-24T19:46:00Z", "message": "HDDS-3161. Block illegal characters when creating keys."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a91e7f8186e1d34804296a9a889f273672dca1ef", "author": {"user": {"login": "cku328", "name": "Neo Yang"}}, "url": "https://github.com/apache/ozone/commit/a91e7f8186e1d34804296a9a889f273672dca1ef", "committedDate": "2020-04-24T19:46:00Z", "message": "Moving regular expression to OzoneConsts file.\n\nSigned-off-by: Neo <cku328@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78f9e99eace6affdd1bc4e6510c95902acef497d", "author": {"user": {"login": "cku328", "name": "Neo Yang"}}, "url": "https://github.com/apache/ozone/commit/78f9e99eace6affdd1bc4e6510c95902acef497d", "committedDate": "2020-04-24T19:46:00Z", "message": "Added key name check in some requests.\n\nSigned-off-by: Neo <cku328@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab75c37044d9f5a079731b144f875576f9fd2adb", "author": {"user": {"login": "cku328", "name": "Neo Yang"}}, "url": "https://github.com/apache/ozone/commit/ab75c37044d9f5a079731b144f875576f9fd2adb", "committedDate": "2020-04-24T19:46:00Z", "message": "pre-compiled regex patterns & check the entire string."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "986702696ca3337708823b1d998edd6537d3aaa9", "author": {"user": {"login": "cku328", "name": "Neo Yang"}}, "url": "https://github.com/apache/ozone/commit/986702696ca3337708823b1d998edd6537d3aaa9", "committedDate": "2020-04-24T19:31:32Z", "message": "change this check to optional"}, "afterCommit": {"oid": "320952174b22d57eb4e3fe6f8b682d6aa191680f", "author": {"user": {"login": "cku328", "name": "Neo Yang"}}, "url": "https://github.com/apache/ozone/commit/320952174b22d57eb4e3fe6f8b682d6aa191680f", "committedDate": "2020-04-24T19:47:15Z", "message": "change this check to optional"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e14e818441d3e0c075f573265d0a25d1e9e9518", "author": {"user": {"login": "cku328", "name": "Neo Yang"}}, "url": "https://github.com/apache/ozone/commit/4e14e818441d3e0c075f573265d0a25d1e9e9518", "committedDate": "2020-04-24T20:08:36Z", "message": "hange this check to optionl"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "320952174b22d57eb4e3fe6f8b682d6aa191680f", "author": {"user": {"login": "cku328", "name": "Neo Yang"}}, "url": "https://github.com/apache/ozone/commit/320952174b22d57eb4e3fe6f8b682d6aa191680f", "committedDate": "2020-04-24T19:47:15Z", "message": "change this check to optional"}, "afterCommit": {"oid": "4e14e818441d3e0c075f573265d0a25d1e9e9518", "author": {"user": {"login": "cku328", "name": "Neo Yang"}}, "url": "https://github.com/apache/ozone/commit/4e14e818441d3e0c075f573265d0a25d1e9e9518", "committedDate": "2020-04-24T20:08:36Z", "message": "hange this check to optionl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8973cd7f1090acc1f27f93ab2fb116acd0c56cb1", "author": {"user": {"login": "cku328", "name": "Neo Yang"}}, "url": "https://github.com/apache/ozone/commit/8973cd7f1090acc1f27f93ab2fb116acd0c56cb1", "committedDate": "2020-04-24T20:26:25Z", "message": "fixed checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ffb4d6347836766dff6130e14043ca0de33db32", "author": {"user": {"login": "cku328", "name": "Neo Yang"}}, "url": "https://github.com/apache/ozone/commit/9ffb4d6347836766dff6130e14043ca0de33db32", "committedDate": "2020-04-24T21:45:53Z", "message": "fix bugs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNzY0MDEz", "url": "https://github.com/apache/ozone/pull/812#pullrequestreview-401764013", "createdAt": "2020-04-28T12:00:52Z", "commit": {"oid": "9ffb4d6347836766dff6130e14043ca0de33db32"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMjowMDo1M1rOGNQiRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMjowMToyMFrOGNQjVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU1NTU5MQ==", "bodyText": "I would like to propose making this message consistent with the one in OmUtils, so that ozone fs -put and ozone sh key put both print the same error.  I think it can be most simply done by moving the message from OmUtils here and letting the OMException propagate the underlying exception's message.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  throw new IllegalArgumentException(\"key name contains \" +\n          \n          \n            \n                          \"illegal characters.\");\n          \n          \n            \n                  throw new IllegalArgumentException(\"Invalid key name: \" + keyName);\n          \n      \n    \n    \n  \n\nIf you agree, please feel free to wait for others' reviews before making this change, to reduce the number of rounds.", "url": "https://github.com/apache/ozone/pull/812#discussion_r416555591", "createdAt": "2020-04-28T12:00:53Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/client/HddsClientUtils.java", "diffHunk": "@@ -196,6 +196,24 @@ public static void verifyResourceName(String... resourceNames) {\n     }\n   }\n \n+  /**\n+   * verifies that key name is a valid name.\n+   *\n+   * @param keyName key name to be validated\n+   *\n+   * @throws IllegalArgumentException\n+   */\n+  public static void verifyKeyName(String keyName) {\n+    if (keyName == null) {\n+      throw new IllegalArgumentException(\"Key name is null\");\n+    }\n+    if(!OzoneConsts.KEYNAME_ILLEGAL_CHARACTER_CHECK_REGEX\n+            .matcher(keyName).matches()){\n+      throw new IllegalArgumentException(\"key name contains \" +\n+              \"illegal characters.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ffb4d6347836766dff6130e14043ca0de33db32"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU1NTg2MQ==", "bodyText": "Corresponding to the suggestion for HddsClientUtils:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  throw new OMException(\"Invalid key name: \" + keyName,\n          \n          \n            \n                  throw new OMException(e.getMessage(),", "url": "https://github.com/apache/ozone/pull/812#discussion_r416555861", "createdAt": "2020-04-28T12:01:20Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/OmUtils.java", "diffHunk": "@@ -506,4 +506,17 @@ public static long getOMClientRpcTimeOut(Configuration configuration) {\n     return OzoneConfiguration.of(configuration)\n         .getObject(OMClientConfig.class).getRpcTimeOut();\n   }\n+\n+  /**\n+   * Verify key name is a valid name.\n+   */\n+  public static void validateKeyName(String keyName)\n+          throws OMException {\n+    try {\n+      HddsClientUtils.verifyKeyName(keyName);\n+    } catch (IllegalArgumentException e) {\n+      throw new OMException(\"Invalid key name: \" + keyName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ffb4d6347836766dff6130e14043ca0de33db32"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17e40c23392df10bbfdf5e737b417ddda82f43c0", "author": {"user": {"login": "cku328", "name": "Neo Yang"}}, "url": "https://github.com/apache/ozone/commit/17e40c23392df10bbfdf5e737b417ddda82f43c0", "committedDate": "2020-05-05T16:18:16Z", "message": "update message of exception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41f9045c5e997c51dcdbf083ddeeb41ab543fb4b", "author": {"user": {"login": "cku328", "name": "Neo Yang"}}, "url": "https://github.com/apache/ozone/commit/41f9045c5e997c51dcdbf083ddeeb41ab543fb4b", "committedDate": "2020-05-05T16:56:13Z", "message": "Merge remote-tracking branch 'remotes/upstream/master' into HDDS-3161\n\n# Conflicts:\n#\thadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/rpc/RpcClient.java\n#\thadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/OmUtils.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07a8386fe6e4155dbb140badbf01927d0e360796", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/07a8386fe6e4155dbb140badbf01927d0e360796", "committedDate": "2020-06-24T11:46:43Z", "message": "Merge remote-tracking branch 'origin/master' into HEAD"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3348, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}