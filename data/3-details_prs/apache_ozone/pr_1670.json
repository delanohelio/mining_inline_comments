{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzODQyODM5", "number": 1670, "title": "HDDS-4403. Update the container replica history to the Recon DB lazily instead of for every report", "bodyText": "What changes were proposed in this pull request?\n\nContainer replica history DB should be updated less frequently. -- Pre-patch it is updating the SQL DB for every new report, which becomes a bottleneck when scaling with # of containers.\nSwitch the underlying DB for container replica history report from SQL DB to RocksDB.\nDB (container replica history table) now internally stores Datanode UUID instead of hostname. (The Web UI will still display hostnames.)\n\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4403\nHow was this patch tested?\n\nExisting test TestContainerEndpoint#testGetReplicaHistoryForContainer modded and passed.\nAdding new UTs and fixing existing ones.", "createdAt": "2020-12-07T17:50:19Z", "url": "https://github.com/apache/ozone/pull/1670", "merged": true, "mergeCommit": {"oid": "ad207a3eb13012d9a7e997a3777ec068be01fd89"}, "closed": true, "closedAt": "2021-01-13T18:00:27Z", "author": {"login": "smengcl"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiTCX9gH2gAyNTMzODQyODM5OmM5MzBiZDFkNTZlYzE2ZWRkYzdlNjM4ZTkyZDU2ZWYwZGMxYTFlNDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdvwfanAFqTU2NzI2NzA5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c930bd1d56ec16eddc7e638e92d56ef0dc1a1e44", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/c930bd1d56ec16eddc7e638e92d56ef0dc1a1e44", "committedDate": "2020-12-02T18:41:27Z", "message": "HDDS-4403. Update the container replica history to the Recon DB lazily instead of for every report.\n\nChange-Id: Id7209f850e8dc7f68cfe07c718a830e23e19a8bc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee9b5dc6b64a16e311c7d44c22ff4f0cc7ba177a", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/ee9b5dc6b64a16e311c7d44c22ff4f0cc7ba177a", "committedDate": "2020-12-02T18:46:49Z", "message": "Use Map<Long, Map<ContainerReplica, Long>>\n\nChange-Id: I8cf1791a5e7ce838aab7833159b4c02119265e12"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f54ed82854531e613af58181bb7ef912e5099152", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/f54ed82854531e613af58181bb7ef912e5099152", "committedDate": "2020-12-03T06:52:43Z", "message": "Use Map<Long, Map<UUID, ContainerReplicaWithTimestamp>>\n\nChange-Id: I8ae9b54775e9d5491bb67f8a5267a2310b3e2a4a"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddda6ec8707938f1b01457e10b7d807db5ed35cd", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/ddda6ec8707938f1b01457e10b7d807db5ed35cd", "committedDate": "2020-12-03T07:07:31Z", "message": "Clean up ContainerReplicaWithTimestamp.\n\nChange-Id: Ia68a91ee2d3fb815b880a75822c34028547ffc46"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51932db0194465f638db48d773471f15f1210b1b", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/51932db0194465f638db48d773471f15f1210b1b", "committedDate": "2020-12-07T17:24:30Z", "message": "Store and get container history from RDB. TestContainerEndpoint#testGetReplicaHistoryForContainer passed.\n\nChange-Id: I93ff290c1e520bebd52b6c441b4ebc4f7064f858"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb625169f6434a19594d2ac8e9876fe0792b60de", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/eb625169f6434a19594d2ac8e9876fe0792b60de", "committedDate": "2020-12-07T17:43:13Z", "message": "Cleanup.\n\nChange-Id: I846918caeff13c805fc88adcbeb826b9f9b450ab"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1be7b3c6f723290b0f5c796e43a2ac3e521a5907", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/1be7b3c6f723290b0f5c796e43a2ac3e521a5907", "committedDate": "2020-12-07T18:12:35Z", "message": "Javadoc and comments.\n\nChange-Id: I60942ccbc02d146dc35638da2306f6e2f8294a45"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4abc1a12e09ffcb71f09cd35ecd5742cc7ef38b4", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/4abc1a12e09ffcb71f09cd35ecd5742cc7ef38b4", "committedDate": "2020-12-07T18:25:51Z", "message": "Remove unused ContainerReplica field in timestamp class.\n\nChange-Id: I981b9234727197fe95f4fb114f325bd7f36dba75"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2eecec43baf4af89cacf292b2331b9c7ce8ab657", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/2eecec43baf4af89cacf292b2331b9c7ce8ab657", "committedDate": "2020-12-07T18:28:09Z", "message": "Address checkstyles.\n\nChange-Id: I80ef5ff2a1bec06ba676a3a74812da64db827969"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee616c2302b2b2de872dc5ef6b50026e2316ea23", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/ee616c2302b2b2de872dc5ef6b50026e2316ea23", "committedDate": "2020-12-07T18:37:49Z", "message": "Add comments.\n\nChange-Id: Ia90c21f677edcf87478e3372edecfbeede637cec"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00dcf15ad722d2af1ec1891bf844cd7d080bd984", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/00dcf15ad722d2af1ec1891bf844cd7d080bd984", "committedDate": "2020-12-07T22:43:01Z", "message": "Remove CONTAINER_HISTORY table.\n\nChange-Id: I130ea5f1e1f3fa419c606429d893e7f46167ab3d"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a8e24bfba9dc8885a16fe585a84db7727893540", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/8a8e24bfba9dc8885a16fe585a84db7727893540", "committedDate": "2020-12-08T00:39:41Z", "message": "All existing TestContainerEndpoint UTs pass.\n\nChange-Id: I115173eb7043e092cb0edf8f76c18784519523cc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afc7bab6a1c10251f5a0524d092b38032283cb01", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/afc7bab6a1c10251f5a0524d092b38032283cb01", "committedDate": "2020-12-08T01:43:23Z", "message": "Rename LastSeenMap -> ReplicaHistoryMap, etc.\n\nChange-Id: I0c5fe3faa50b0768ab0a9e95b7d3046e47a4fba5"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52b821d2467f481c2a667600833e1f7b270df090", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/52b821d2467f481c2a667600833e1f7b270df090", "committedDate": "2020-12-08T01:47:08Z", "message": "ContainerHistory: firstReportTimestamp -> firstSeenTime, lastReportTimestamp -> lastSeenTime\n\nChange-Id: I9eba3f414dd20b15d68f8070642ddbafcf0b9b1b"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4d7fc8f86edacf2e2b3be388ea7c875ce0b2177", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/b4d7fc8f86edacf2e2b3be388ea7c875ce0b2177", "committedDate": "2020-12-08T01:47:21Z", "message": "Check getLatestContainerHistory.\n\nChange-Id: I877dc618a500a32eaee6a3303b47534408f9e9ac"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2479d124e92509621e49e2a224f98f7a942d0f1a", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/2479d124e92509621e49e2a224f98f7a942d0f1a", "committedDate": "2020-12-08T01:50:20Z", "message": "Checkstyle.\n\nChange-Id: I1353458f1ac8eea4ac7e0ecbf91ec06043ae9a76"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NTEyNjcw", "url": "https://github.com/apache/ozone/pull/1670#pullrequestreview-548512670", "createdAt": "2020-12-09T19:00:35Z", "commit": {"oid": "2479d124e92509621e49e2a224f98f7a942d0f1a"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxOTowMDozNlrOICkkLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxOTo0Nzo0OFrOICmcFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU2NzE0OQ==", "bodyText": "Based on 16 bytes per container-DN combination, it comes to around 16KB for a degenerate case where a container has been in 1000 Datanodes through its lifecycle. Hence, I think we should be OK on the replica history growth over time.", "url": "https://github.com/apache/ozone/pull/1670#discussion_r539567149", "createdAt": "2020-12-09T19:00:36Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/codec/ContainerReplicaHistoryListCodec.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.hadoop.ozone.recon.codec;\n+\n+import org.apache.hadoop.hdds.utils.db.Codec;\n+import org.apache.hadoop.hdds.utils.db.LongCodec;\n+import org.apache.hadoop.ozone.recon.scm.ContainerReplicaHistory;\n+import org.apache.hadoop.ozone.recon.scm.ContainerReplicaHistoryList;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.DataInputStream;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.UUID;\n+\n+/**\n+ * Codec for ContainerReplicaHistoryList.\n+ */\n+public class ContainerReplicaHistoryListCodec\n+    implements Codec<ContainerReplicaHistoryList> {\n+\n+  // UUID takes 2 long to store. Each timestamp takes 1 long to store.\n+  static final int SIZE_PER_ENTRY = 4 * Long.BYTES;\n+  private final Codec<Long> lc = new LongCodec();\n+\n+  @Override\n+  public byte[] toPersistedFormat(ContainerReplicaHistoryList obj)\n+      throws IOException {\n+\n+    List<ContainerReplicaHistory> lst = obj.getList();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2479d124e92509621e49e2a224f98f7a942d0f1a"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU2OTAxNg==", "bodyText": "Can we add some documentation here on on the ContainerEndpoint API class that Recon can only track first and last seen time of the container replica on a DN. It cannot track intermediate states where a replica can move out a DN and then come back in the future again to the same DN. All Recon guarantees is first and last seen time, and not the whole interval in between the 2 times.", "url": "https://github.com/apache/ozone/pull/1670#discussion_r539569016", "createdAt": "2020-12-09T19:03:25Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/scm/ContainerReplicaHistory.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.recon.scm;\n+\n+import java.util.UUID;\n+\n+/**\n+ * A ContainerReplica timestamp class that tracks first and last seen time.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2479d124e92509621e49e2a224f98f7a942d0f1a"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU4NjgyNg==", "bodyText": "I don't see any usages for this method.", "url": "https://github.com/apache/ozone/pull/1670#discussion_r539586826", "createdAt": "2020-12-09T19:30:53Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/scm/ReconContainerManager.java", "diffHunk": "@@ -171,23 +182,93 @@ public void addNewContainer(long containerId,\n \n   /**\n    * Add a container Replica for given DataNode.\n-   *\n-   * @param containerID\n-   * @param replica\n    */\n   @Override\n   public void updateContainerReplica(ContainerID containerID,\n       ContainerReplica replica)\n       throws ContainerNotFoundException {\n     super.updateContainerReplica(containerID, replica);\n-    // Update container_history table\n-    long currentTime = System.currentTimeMillis();\n-    String datanodeHost = replica.getDatanodeDetails().getHostName();\n-    containerSchemaManager.upsertContainerHistory(containerID.getId(),\n-        datanodeHost, currentTime);\n+\n+    final long currTime = System.currentTimeMillis();\n+    final long id = containerID.getId();\n+    final DatanodeDetails dnInfo = replica.getDatanodeDetails();\n+    final UUID uuid = dnInfo.getUuid();\n+\n+    // Map from DataNode UUID to replica last seen time\n+    final Map<UUID, ContainerReplicaHistory> replicaLastSeenMap =\n+        replicaHistoryMap.get(id);\n+\n+    boolean flushToDB = false;\n+\n+    // If replica doesn't exist in in-memory map, add to DB and add to map\n+    if (replicaLastSeenMap == null) {\n+      // putIfAbsent to avoid TOCTOU\n+      replicaHistoryMap.putIfAbsent(id,\n+          new ConcurrentHashMap<UUID, ContainerReplicaHistory>() {{\n+            put(uuid, new ContainerReplicaHistory(uuid, currTime, currTime));\n+          }});\n+      flushToDB = true;\n+    } else {\n+      // ContainerID exists, update timestamp in memory\n+      final ContainerReplicaHistory ts = replicaLastSeenMap.get(uuid);\n+      if (ts == null) {\n+        // New Datanode\n+        replicaLastSeenMap.put(uuid,\n+            new ContainerReplicaHistory(uuid, currTime, currTime));\n+        flushToDB = true;\n+      } else {\n+        // if the object exists, only update the last seen time field\n+        ts.setLastSeenTime(currTime);\n+      }\n+    }\n+\n+    if (flushToDB) {\n+      containerSchemaManager.upsertContainerHistory(id, uuid, currTime);\n+    }\n   }\n \n+  /**\n+   * Remove a Container Replica of a given DataNode.\n+   */\n+  @Override\n+  public void removeContainerReplica(ContainerID containerID,\n+      ContainerReplica replica) throws ContainerNotFoundException,\n+      ContainerReplicaNotFoundException {\n+    super.removeContainerReplica(containerID, replica);\n+\n+    final long id = containerID.getId();\n+    final DatanodeDetails dnInfo = replica.getDatanodeDetails();\n+    final UUID uuid = dnInfo.getUuid();\n+\n+    final Map<UUID, ContainerReplicaHistory> replicaLastSeenMap =\n+        replicaHistoryMap.get(id);\n+    if (replicaLastSeenMap != null) {\n+      final ContainerReplicaHistory ts = replicaLastSeenMap.get(uuid);\n+      if (ts != null) {\n+        // Flush to DB, then remove from in-memory map\n+        containerSchemaManager.upsertContainerHistory(id, uuid,\n+            ts.getLastSeenTime());\n+        replicaLastSeenMap.remove(uuid);\n+      }\n+    }\n+  }\n+\n+  @VisibleForTesting\n   public ContainerSchemaManager getContainerSchemaManager() {\n     return containerSchemaManager;\n   }\n+\n+  @VisibleForTesting\n+  public Map<Long, Map<UUID, ContainerReplicaHistory>> getReplicaHistoryMap() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2479d124e92509621e49e2a224f98f7a942d0f1a"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU5MzUxNg==", "bodyText": "Is there any reason why we cannot maintain the ScmDB and replica history map only in this class and move the related methods (getContainerHistory, upsertContainerHistory, flushDb) from the ContainerSchemaManager to this class? The ContainerEndpoint class already has an instance of the Recon container manager. After this change, maybe we can also rename ContainerSchemaManager to ContainerHealthSchemaManager?", "url": "https://github.com/apache/ozone/pull/1670#discussion_r539593516", "createdAt": "2020-12-09T19:41:01Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/scm/ReconContainerManager.java", "diffHunk": "@@ -65,13 +73,16 @@\n   public ReconContainerManager(\n       ConfigurationSource conf,\n       Table<ContainerID, ContainerInfo> containerStore,\n-      BatchOperationHandler batchHandler,\n+      DBStore batchHandler,\n       PipelineManager pipelineManager,\n       StorageContainerServiceProvider scm,\n       ContainerSchemaManager containerSchemaManager) throws IOException {\n     super(conf, containerStore, batchHandler, pipelineManager);\n     this.scmClient = scm;\n     this.containerSchemaManager = containerSchemaManager;\n+    this.replicaHistoryMap = new ConcurrentHashMap<>();\n+    containerSchemaManager.setReplicaHistoryMap(replicaHistoryMap);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2479d124e92509621e49e2a224f98f7a942d0f1a"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU5NjA4NA==", "bodyText": "Nit. Method name can just be getContainerReplicaHistory.", "url": "https://github.com/apache/ozone/pull/1670#discussion_r539596084", "createdAt": "2020-12-09T19:45:06Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/spi/impl/ContainerDBServiceProviderImpl.java", "diffHunk": "@@ -184,6 +214,34 @@ public long getKeyCountForContainer(Long containerID) throws IOException {\n     return keyCount == null ? 0L : keyCount;\n   }\n \n+  /**\n+   * Get the container replica history of the given containerID.\n+   *\n+   * @param containerID the given containerId.\n+   * @return A map of ContainerReplicaWithTimestamp of the given containerID.\n+   * @throws IOException\n+   */\n+  @Override\n+  public Map<UUID, ContainerReplicaHistory> getContainerReplicaHistoryMap(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2479d124e92509621e49e2a224f98f7a942d0f1a"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTU5Nzg0Ng==", "bodyText": "Can we support a batch interface that uses the RocksDB BatchOperation? That will help with faster flushing.", "url": "https://github.com/apache/ozone/pull/1670#discussion_r539597846", "createdAt": "2020-12-09T19:47:48Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/persistence/ContainerSchemaManager.java", "diffHunk": "@@ -113,40 +142,121 @@ public void insertUnhealthyContainerRecords(List<UnhealthyContainers> recs) {\n     unhealthyContainersDao.insert(recs);\n   }\n \n-  public void upsertContainerHistory(long containerID, String datanode,\n-                                     long time) {\n-    DSLContext dslContext = containerSchemaDefinition.getDSLContext();\n-    Record2<Long, String> recordToFind =\n-        dslContext.newRecord(\n-        CONTAINER_HISTORY.CONTAINER_ID,\n-        CONTAINER_HISTORY.DATANODE_HOST).value1(containerID).value2(datanode);\n-    ContainerHistory newRecord = new ContainerHistory();\n-    newRecord.setContainerId(containerID);\n-    newRecord.setDatanodeHost(datanode);\n-    newRecord.setLastReportTimestamp(time);\n-    ContainerHistory record = containerHistoryDao.findById(recordToFind);\n-    if (record != null) {\n-      newRecord.setFirstReportTimestamp(record.getFirstReportTimestamp());\n-      containerHistoryDao.update(newRecord);\n-    } else {\n-      newRecord.setFirstReportTimestamp(time);\n-      containerHistoryDao.insert(newRecord);\n+  public void upsertContainerHistory(long containerID, UUID uuid, long time) {\n+    Map<UUID, ContainerReplicaHistory> tsMap;\n+    try {\n+      tsMap = dbServiceProvider.getContainerReplicaHistoryMap(containerID);\n+      ContainerReplicaHistory ts = tsMap.get(uuid);\n+      if (ts == null) {\n+        // New entry\n+        tsMap.put(uuid, new ContainerReplicaHistory(uuid, time, time));\n+      } else {\n+        // Entry exists, update last seen time and put it back to DB.\n+        ts.setLastSeenTime(time);\n+      }\n+      dbServiceProvider.storeContainerReplicaHistoryMap(containerID, tsMap);\n+    } catch (IOException e) {\n+      LOG.debug(\"Error on DB operations. {}\", e.getMessage());\n     }\n   }\n \n   public List<ContainerHistory> getAllContainerHistory(long containerID) {\n-    return containerHistoryDao.fetchByContainerId(containerID);\n+    // First, get the existing entries from DB\n+    Map<UUID, ContainerReplicaHistory> resMap;\n+    try {\n+      resMap = dbServiceProvider.getContainerReplicaHistoryMap(containerID);\n+    } catch (IOException ex) {\n+      resMap = new HashMap<>();\n+      LOG.debug(\"Unable to retrieve container replica history from RDB.\");\n+    }\n+\n+    // Then, update the entries with the latest in-memory info, if available\n+    if (replicaHistoryMap != null) {\n+      Map<UUID, ContainerReplicaHistory> replicaLastSeenMap =\n+          replicaHistoryMap.get(containerID);\n+      if (replicaLastSeenMap != null) {\n+        Map<UUID, ContainerReplicaHistory> finalResMap = resMap;\n+        replicaLastSeenMap.forEach((k, v) ->\n+            finalResMap.merge(k, v, (old, latest) -> latest));\n+        resMap = finalResMap;\n+      }\n+    }\n+\n+    // Finally, convert map to list for output\n+    List<ContainerHistory> resList = new ArrayList<>();\n+    for (Map.Entry<UUID, ContainerReplicaHistory> entry : resMap.entrySet()) {\n+      final UUID uuid = entry.getKey();\n+      String hostname = \"N/A\";\n+      // Attempt to retrieve hostname from NODES table\n+      if (nodeDB != null) {\n+        try {\n+          DatanodeDetails dnDetails = nodeDB.get(uuid);\n+          if (dnDetails != null) {\n+            hostname = dnDetails.getHostName();\n+          }\n+        } catch (IOException ex) {\n+          LOG.debug(\"Unable to retrieve from NODES table of node {}. {}\",\n+              uuid, ex.getMessage());\n+        }\n+      }\n+      final long firstSeenTime = entry.getValue().getFirstSeenTime();\n+      final long lastSeenTime = entry.getValue().getLastSeenTime();\n+      resList.add(new ContainerHistory(containerID, uuid.toString(), hostname,\n+          firstSeenTime, lastSeenTime));\n+    }\n+    return resList;\n   }\n \n   public List<ContainerHistory> getLatestContainerHistory(long containerID,\n                                                           int limit) {\n-    DSLContext dslContext = containerSchemaDefinition.getDSLContext();\n-    // Get container history sorted in descending order of last report timestamp\n-    return dslContext.select()\n-        .from(CONTAINER_HISTORY)\n-        .where(CONTAINER_HISTORY.CONTAINER_ID.eq(containerID))\n-        .orderBy(CONTAINER_HISTORY.LAST_REPORT_TIMESTAMP.desc())\n-        .limit(limit)\n-        .fetchInto(ContainerHistory.class);\n+    List<ContainerHistory> res = getAllContainerHistory(containerID);\n+    res.sort(comparingLong(ContainerHistory::getLastSeenTime).reversed());\n+    return res.stream().limit(limit).collect(Collectors.toList());\n+  }\n+\n+  /**\n+   * Should only be called once during ReconContainerManager init.\n+   */\n+  public void setReplicaHistoryMap(\n+      Map<Long, Map<UUID, ContainerReplicaHistory>> replicaHistoryMap) {\n+    this.replicaHistoryMap = replicaHistoryMap;\n+  }\n+\n+  /**\n+   * Should only be called once during ReconContainerManager init.\n+   */\n+  public void setScmDBStore(DBStore scmDBStore) {\n+    this.scmDBStore = scmDBStore;\n+    try {\n+      this.nodeDB = ReconSCMDBDefinition.NODES.getTable(scmDBStore);\n+    } catch (IOException ex) {\n+      LOG.debug(\"Failed to get NODES table. {}\", ex.getMessage());\n+    }\n+  }\n+\n+  /**\n+   * Flush the container replica history in-memory map to DB.\n+   * @param clearMap true to clear the in-memory map after flushing completes.\n+   */\n+  public void flushReplicaHistoryMapToDB(boolean clearMap) {\n+    if (replicaHistoryMap == null) {\n+      return;\n+    }\n+    synchronized (replicaHistoryMap) {\n+      try {\n+        for (Map.Entry<Long, Map<UUID, ContainerReplicaHistory>> entry :\n+            replicaHistoryMap.entrySet()) {\n+          final long containerId = entry.getKey();\n+          final Map<UUID, ContainerReplicaHistory> map = entry.getValue();\n+          dbServiceProvider.storeContainerReplicaHistoryMap(containerId, map);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2479d124e92509621e49e2a224f98f7a942d0f1a"}, "originalPosition": 220}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3f9a1e455d7865527e40e01e2500f80b439d446", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/c3f9a1e455d7865527e40e01e2500f80b439d446", "committedDate": "2021-01-04T19:00:58Z", "message": "getContainerReplicaHistoryMap -> getContainerReplicaHistory\n\nChange-Id: Ibc5530951a22da7b6a930e927a467755f63741a7"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a16beeb36163b592670a1d00f95e10b370097e0", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/5a16beeb36163b592670a1d00f95e10b370097e0", "committedDate": "2021-01-04T19:01:20Z", "message": "Add a note in ContainerReplicaHistory.\n\nChange-Id: Ie2d3c74d450dcf8ab3c9a9953afb3748fb1573e9"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd288fd1b8e47bcadeb9bc896e1804a19b121771", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/cd288fd1b8e47bcadeb9bc896e1804a19b121771", "committedDate": "2021-01-06T19:01:40Z", "message": "Implement batchStoreContainerReplicaHistory.\n\nChange-Id: I1c1b0190b8ea9e2600b0a0c3ea6ebb294e3615f6"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "168564873e2712199db1309f4507b95d40dc0c67", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/168564873e2712199db1309f4507b95d40dc0c67", "committedDate": "2021-01-11T18:18:51Z", "message": "Move DB and related methods from ContainerSchemaManager to ReconContainerManager.\n\nChange-Id: I286d1849455d9ee87c79a9478061d2e03c4bfdf8"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51a8c786dd6e77908c6c7a1fc00f644692fe99f5", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/51a8c786dd6e77908c6c7a1fc00f644692fe99f5", "committedDate": "2021-01-11T18:22:40Z", "message": "Rename ContainerSchemaManager -> ContainerHealthSchemaManager\n\nChange-Id: Ia58e495f66189ea7b728d0ceffcd49e784e9112f"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c79317280fb5e1bda7815810ec6ea8f2b31a8b53", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/c79317280fb5e1bda7815810ec6ea8f2b31a8b53", "committedDate": "2021-01-11T18:45:06Z", "message": "Checkstyle.\n\nChange-Id: I7a3995ef5c0083d018fe9be874734d682aecabe3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f192cf686b24a39f39525b46c6c4aa0b67d839f", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/3f192cf686b24a39f39525b46c6c4aa0b67d839f", "committedDate": "2021-01-11T20:50:02Z", "message": "Fix ReconContainerManager constructor.\n\nReconContainerManager is initialized in ReconStorageContainerManagerFacade (impl of OzoneStorageContainerManager), not a Singleton and not initialized directly by Guice injector, so @Inject annotation doesn't work here.\nThe proper way to do it is pass the ContainerDBServiceProvider to ReconContainerManager in ReconStorageContainerManagerFacade when it is initialized.\n\nChange-Id: I6eaa349e6aa1d75a8d6a3707de2f60fe401c1a4f"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8b82472cf0e345dc763e55a589a9e8d03232065", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/d8b82472cf0e345dc763e55a589a9e8d03232065", "committedDate": "2021-01-11T21:20:34Z", "message": "Add UT testUpdateAndRemoveContainerReplica.\n\nChange-Id: I3b2e95dc9bf8687dacc564c1a94d24a7e068d938"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c030f6d1eb2b70a26c3853eaed80ff5dc4afebff", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/c030f6d1eb2b70a26c3853eaed80ff5dc4afebff", "committedDate": "2021-01-11T21:21:44Z", "message": "Remove unused import.\n\nChange-Id: Ic48c10cdd28b3b679cffc505070b642d38eecb25"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adad8488eb55dc80e9901418bb1104376a59dd48", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/adad8488eb55dc80e9901418bb1104376a59dd48", "committedDate": "2021-01-11T21:52:16Z", "message": "Fix TestEndpoints.\n\nNow that we are injecting ContainerDBServiceProvider to ReconStorageContainerManagerFacade constructor, we need the DB class binding:\n\nbind(ContainerDBServiceProvider.class).to(ContainerDBServiceProviderImpl.class).in(Singleton.class);\nbind(DBStore.class).toProvider(ReconContainerDBProvider.class).in(Singleton.class);\n\nChange-Id: Iefc489718f6f22e8f45f68c4044f8bc52a8fc513"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e48cf41ecfe5a376566825a4870f616a9f976958", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/e48cf41ecfe5a376566825a4870f616a9f976958", "committedDate": "2021-01-12T00:20:07Z", "message": "Use lower case 'd' in ContainerHistory for consistency and appeasing Recon robot test.\n\nChange-Id: I3751feecaff7f18c783e5c00f4c94f2f24fe2bb0"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY3MjY3MDkz", "url": "https://github.com/apache/ozone/pull/1670#pullrequestreview-567267093", "createdAt": "2021-01-13T14:21:26Z", "commit": {"oid": "e48cf41ecfe5a376566825a4870f616a9f976958"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2058, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}