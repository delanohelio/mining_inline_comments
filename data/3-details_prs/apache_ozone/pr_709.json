{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyMzg1OTYx", "number": 709, "title": "HDDS-3244. Improve write efficiency by opening RocksDB only once", "bodyText": "What changes were proposed in this pull request?\nWhat's the problem ?\n\nwhen datanode create a new container, a new RocksDB instance will be\ncreated in HddsDispatcher.WriteChunk , but then the created RocksDB was  closed, until HddsDispatcher.PutBlock the RocsDB will be opend again and then put it into cache, so the RocksDB was open twice in each datanode.  Becase RocksDB.open cost about 200ms, so open it twice is a waste.\n\nHow to fix it ?\n\nPut the RocksDB handler into cache when open it the first time , to avoid open it again in HddsDispatcher.PutBlock.\n\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/projects/HDDS/issues/HDDS-3244\nHow was this patch tested?\nExisted UT and IT.", "createdAt": "2020-03-23T13:30:04Z", "url": "https://github.com/apache/ozone/pull/709", "merged": true, "mergeCommit": {"oid": "b50e93272021c96688466d8d4998c063ed678044"}, "closed": true, "closedAt": "2020-04-09T15:48:10Z", "author": {"login": "runzhiwang"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQeCplgH2gAyMzkyMzg1OTYxOmE2MzQwYTYyMzY2NzY2YTQ0NGFkMjBiYjEwY2JhMjg5M2Y5YmUwOTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTpRaNAFqTM4NjI3NDYxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a6340a62366766a444ad20bb10cba2893f9be098", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/a6340a62366766a444ad20bb10cba2893f9be098", "committedDate": "2020-03-23T13:08:55Z", "message": "HDDS-3244. Improve write efficiency by opening RocksDB only once"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NDkwMjY4", "url": "https://github.com/apache/ozone/pull/709#pullrequestreview-379490268", "createdAt": "2020-03-23T14:37:09Z", "commit": {"oid": "a6340a62366766a444ad20bb10cba2893f9be098"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNDozNzowOVrOF6IVXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNDozNzowOVrOF6IVXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ5ODI3MQ==", "bodyText": "Thanks for working on this @runzhiwang. Can we add to the cache here ?\nAlso the entry should be added to cache here and not in the apply transaction phase.", "url": "https://github.com/apache/ozone/pull/709#discussion_r396498271", "createdAt": "2020-03-23T14:37:09Z", "author": {"login": "mukul1987"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/keyvalue/helpers/KeyValueContainerUtil.java", "diffHunk": "@@ -73,14 +71,6 @@ public static void createContainerMetaData(File containerMetaDataPath, File\n       throw new IOException(\"Unable to create directory for metadata storage.\" +\n           \" Path: \" + containerMetaDataPath);\n     }\n-    MetadataStore store = MetadataStoreBuilder.newBuilder().setConf(conf)\n-        .setCreateIfMissing(true).setDbFile(dbFile).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6340a62366766a444ad20bb10cba2893f9be098"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30178fc176556493346fc533089653117d2dd4f6", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/30178fc176556493346fc533089653117d2dd4f6", "committedDate": "2020-03-27T09:41:56Z", "message": "HDDS-3244. Open Rocksdb in createContainer"}, "afterCommit": {"oid": "30943982300dcaee373e5dfe7499053eac24d3bb", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/30943982300dcaee373e5dfe7499053eac24d3bb", "committedDate": "2020-03-27T09:46:07Z", "message": "HDDS-3244. Open Rocksdb in createContainer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30943982300dcaee373e5dfe7499053eac24d3bb", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/30943982300dcaee373e5dfe7499053eac24d3bb", "committedDate": "2020-03-27T09:46:07Z", "message": "HDDS-3244. Open Rocksdb in createContainer"}, "afterCommit": {"oid": "b55237d114e3d8e70acbbbdac7dfc93f6b5443fa", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/b55237d114e3d8e70acbbbdac7dfc93f6b5443fa", "committedDate": "2020-03-27T09:48:41Z", "message": "HDDS-3244. Open Rocksdb in createContainer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b55237d114e3d8e70acbbbdac7dfc93f6b5443fa", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/b55237d114e3d8e70acbbbdac7dfc93f6b5443fa", "committedDate": "2020-03-27T09:48:41Z", "message": "HDDS-3244. Open Rocksdb in createContainer"}, "afterCommit": {"oid": "a145399c4d979244698d9dbef966671bc7e45cba", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/a145399c4d979244698d9dbef966671bc7e45cba", "committedDate": "2020-03-27T10:50:53Z", "message": "HDDS-3244. Open Rocksdb in createContainer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a145399c4d979244698d9dbef966671bc7e45cba", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/a145399c4d979244698d9dbef966671bc7e45cba", "committedDate": "2020-03-27T10:50:53Z", "message": "HDDS-3244. Open Rocksdb in createContainer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01853b20d9fcdcd4660052ee7aace4ee19e6aee1", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/01853b20d9fcdcd4660052ee7aace4ee19e6aee1", "committedDate": "2020-04-02T01:47:11Z", "message": "retrigger build with empty commit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MjMwNjgw", "url": "https://github.com/apache/ozone/pull/709#pullrequestreview-386230680", "createdAt": "2020-04-02T08:57:14Z", "commit": {"oid": "01853b20d9fcdcd4660052ee7aace4ee19e6aee1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwODo1NzoxNFrOF_hrwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwODo1NzoxNFrOF_hrwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE1NjQ4Mg==", "bodyText": "I think its better to update the cache only at the end of function \"createContainerMetaData\" so that even if the chunk dir creation fails, it won't be added to the container cache.", "url": "https://github.com/apache/ozone/pull/709#discussion_r402156482", "createdAt": "2020-04-02T08:57:14Z", "author": {"login": "bshashikant"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/keyvalue/helpers/KeyValueContainerUtil.java", "diffHunk": "@@ -73,14 +73,13 @@ public static void createContainerMetaData(File containerMetaDataPath, File\n       throw new IOException(\"Unable to create directory for metadata storage.\" +\n           \" Path: \" + containerMetaDataPath);\n     }\n+\n     MetadataStore store = MetadataStoreBuilder.newBuilder().setConf(conf)\n         .setCreateIfMissing(true).setDbFile(dbFile).build();\n-\n-    // we close since the SCM pre-creates containers.\n-    // we will open and put Db handle into a cache when keys are being created\n-    // in a container.\n-\n-    store.close();\n+    ReferenceCountedDB db =\n+        new ReferenceCountedDB(store, dbFile.getAbsolutePath());\n+    //add db handler into cache\n+    BlockUtils.addDB(db, dbFile.getAbsolutePath(), conf);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01853b20d9fcdcd4660052ee7aace4ee19e6aee1"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58096de61eaff93221180d6cc74dea55bdb9bfb7", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/58096de61eaff93221180d6cc74dea55bdb9bfb7", "committedDate": "2020-04-02T09:40:59Z", "message": "fix code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2Mjc0NjEz", "url": "https://github.com/apache/ozone/pull/709#pullrequestreview-386274613", "createdAt": "2020-04-02T09:55:46Z", "commit": {"oid": "58096de61eaff93221180d6cc74dea55bdb9bfb7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3512, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}