{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4MTg1OTMz", "number": 1333, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwNjo0NToyMVrOEeLl5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwNjo0NToyMVrOEeLl5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwMDgyNjYwOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestDiscardPreallocatedBlocks.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwNjo0NToyMVrOHJsdQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMjozMzo0NlrOHJ27QQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTkyNzYxOQ==", "bodyText": "Let's also add an assertion condition to verify the container Ids for both preallocated blocks are same.", "url": "https://github.com/apache/ozone/pull/1333#discussion_r479927619", "createdAt": "2020-08-31T06:45:21Z", "author": {"login": "bshashikant"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestDiscardPreallocatedBlocks.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.hadoop.ozone.client.rpc;\n+\n+import org.apache.hadoop.conf.StorageUnit;\n+import org.apache.hadoop.hdds.client.ReplicationType;\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdds.protocol.DatanodeDetails;\n+import org.apache.hadoop.hdds.scm.ScmConfigKeys;\n+import org.apache.hadoop.hdds.scm.container.ContainerID;\n+import org.apache.hadoop.hdds.scm.container.ContainerInfo;\n+import org.apache.hadoop.hdds.scm.pipeline.Pipeline;\n+import org.apache.hadoop.ozone.MiniOzoneCluster;\n+import org.apache.hadoop.ozone.OzoneConfigKeys;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.client.ObjectStore;\n+import org.apache.hadoop.ozone.client.OzoneClient;\n+import org.apache.hadoop.ozone.client.OzoneClientFactory;\n+import org.apache.hadoop.ozone.client.io.*;\n+import org.apache.hadoop.ozone.container.ContainerTestHelper;\n+import org.apache.hadoop.ozone.container.TestHelper;\n+import org.apache.hadoop.ozone.om.helpers.OmKeyLocationInfo;\n+import org.junit.AfterClass;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.UUID;\n+import java.util.concurrent.TimeUnit;\n+\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.HDDS_SCM_WATCHER_TIMEOUT;\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.OZONE_SCM_STALENODE_INTERVAL;\n+\n+import org.junit.Rule;\n+import org.junit.rules.Timeout;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+/**\n+ * Tests Close Container Exception handling by Ozone Client.\n+ */\n+public class TestDiscardPreallocatedBlocks{\n+\n+  /**\n+   * Set a timeout for each test.\n+   */\n+\n+  @Rule\n+  public Timeout timeout = new Timeout(300000);\n+  private static MiniOzoneCluster cluster;\n+  private static OzoneConfiguration conf = new OzoneConfiguration();\n+  private static OzoneClient client;\n+  private static ObjectStore objectStore;\n+  private static int chunkSize;\n+  private static int blockSize;\n+  private static String volumeName;\n+  private static String bucketName;\n+  private static String keyString;\n+\n+  /**\n+   * Create a MiniDFSCluster for testing.\n+   * <p>\n+   * Ozone is made active by setting OZONE_ENABLED = true\n+   *\n+   * @throws IOException\n+   */\n+\n+  @BeforeClass\n+  public static void init() throws Exception {\n+    chunkSize = (int) OzoneConsts.MB;\n+    blockSize = 4 * chunkSize;\n+    conf.setTimeDuration(HDDS_SCM_WATCHER_TIMEOUT, 1000, TimeUnit.MILLISECONDS);\n+    conf.setTimeDuration(OZONE_SCM_STALENODE_INTERVAL, 3, TimeUnit.SECONDS);\n+    conf.set(OzoneConfigKeys.OZONE_CLIENT_CHECKSUM_TYPE, \"NONE\");\n+    conf.setQuietMode(false);\n+    conf.setStorageSize(OzoneConfigKeys.OZONE_SCM_BLOCK_SIZE, 4,\n+        StorageUnit.MB);\n+    conf.setInt(ScmConfigKeys.OZONE_SCM_PIPELINE_OWNER_CONTAINER_COUNT, 1);\n+    cluster = MiniOzoneCluster.newBuilder(conf).setNumDatanodes(3).build();\n+    cluster.waitForClusterToBeReady();\n+    //the easiest way to create an open container is creating a key\n+    client = OzoneClientFactory.getRpcClient(conf);\n+    objectStore = client.getObjectStore();\n+    keyString = UUID.randomUUID().toString();\n+    volumeName = \"closecontainerexceptionhandlingtest\";\n+    bucketName = volumeName;\n+    objectStore.createVolume(volumeName);\n+    objectStore.getVolume(volumeName).createBucket(bucketName);\n+  }\n+\n+  private String getKeyName() {\n+    return UUID.randomUUID().toString();\n+  }\n+\n+  /**\n+  * Shutdown MiniDFSCluster.\n+  */\n+\n+  @AfterClass\n+  public static void shutdown() {\n+    if (cluster != null) {\n+      cluster.shutdown();\n+    }\n+  }\n+\n+  @Test\n+  public void testDiscardPreallocatedBlocks() throws Exception {\n+    String keyName = getKeyName();\n+    OzoneOutputStream key =\n+        createKey(keyName, ReplicationType.RATIS, 2 * blockSize);\n+    KeyOutputStream keyOutputStream =\n+        (KeyOutputStream) key.getOutputStream();\n+    Assert.assertTrue(key.getOutputStream() instanceof KeyOutputStream);\n+    // With the initial size provided, it should have pre allocated 2 blocks\n+    Assert.assertEquals(2, keyOutputStream.getStreamEntries().size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1cd8866ef7d1fb3e84fb3cdca773ae02135b8eaa"}, "originalPosition": 132}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDA5OTEzNw==", "bodyText": "Added.", "url": "https://github.com/apache/ozone/pull/1333#discussion_r480099137", "createdAt": "2020-08-31T12:33:46Z", "author": {"login": "aryangupta1998"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestDiscardPreallocatedBlocks.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.hadoop.ozone.client.rpc;\n+\n+import org.apache.hadoop.conf.StorageUnit;\n+import org.apache.hadoop.hdds.client.ReplicationType;\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdds.protocol.DatanodeDetails;\n+import org.apache.hadoop.hdds.scm.ScmConfigKeys;\n+import org.apache.hadoop.hdds.scm.container.ContainerID;\n+import org.apache.hadoop.hdds.scm.container.ContainerInfo;\n+import org.apache.hadoop.hdds.scm.pipeline.Pipeline;\n+import org.apache.hadoop.ozone.MiniOzoneCluster;\n+import org.apache.hadoop.ozone.OzoneConfigKeys;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.client.ObjectStore;\n+import org.apache.hadoop.ozone.client.OzoneClient;\n+import org.apache.hadoop.ozone.client.OzoneClientFactory;\n+import org.apache.hadoop.ozone.client.io.*;\n+import org.apache.hadoop.ozone.container.ContainerTestHelper;\n+import org.apache.hadoop.ozone.container.TestHelper;\n+import org.apache.hadoop.ozone.om.helpers.OmKeyLocationInfo;\n+import org.junit.AfterClass;\n+import org.junit.Assert;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.UUID;\n+import java.util.concurrent.TimeUnit;\n+\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.HDDS_SCM_WATCHER_TIMEOUT;\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.OZONE_SCM_STALENODE_INTERVAL;\n+\n+import org.junit.Rule;\n+import org.junit.rules.Timeout;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+/**\n+ * Tests Close Container Exception handling by Ozone Client.\n+ */\n+public class TestDiscardPreallocatedBlocks{\n+\n+  /**\n+   * Set a timeout for each test.\n+   */\n+\n+  @Rule\n+  public Timeout timeout = new Timeout(300000);\n+  private static MiniOzoneCluster cluster;\n+  private static OzoneConfiguration conf = new OzoneConfiguration();\n+  private static OzoneClient client;\n+  private static ObjectStore objectStore;\n+  private static int chunkSize;\n+  private static int blockSize;\n+  private static String volumeName;\n+  private static String bucketName;\n+  private static String keyString;\n+\n+  /**\n+   * Create a MiniDFSCluster for testing.\n+   * <p>\n+   * Ozone is made active by setting OZONE_ENABLED = true\n+   *\n+   * @throws IOException\n+   */\n+\n+  @BeforeClass\n+  public static void init() throws Exception {\n+    chunkSize = (int) OzoneConsts.MB;\n+    blockSize = 4 * chunkSize;\n+    conf.setTimeDuration(HDDS_SCM_WATCHER_TIMEOUT, 1000, TimeUnit.MILLISECONDS);\n+    conf.setTimeDuration(OZONE_SCM_STALENODE_INTERVAL, 3, TimeUnit.SECONDS);\n+    conf.set(OzoneConfigKeys.OZONE_CLIENT_CHECKSUM_TYPE, \"NONE\");\n+    conf.setQuietMode(false);\n+    conf.setStorageSize(OzoneConfigKeys.OZONE_SCM_BLOCK_SIZE, 4,\n+        StorageUnit.MB);\n+    conf.setInt(ScmConfigKeys.OZONE_SCM_PIPELINE_OWNER_CONTAINER_COUNT, 1);\n+    cluster = MiniOzoneCluster.newBuilder(conf).setNumDatanodes(3).build();\n+    cluster.waitForClusterToBeReady();\n+    //the easiest way to create an open container is creating a key\n+    client = OzoneClientFactory.getRpcClient(conf);\n+    objectStore = client.getObjectStore();\n+    keyString = UUID.randomUUID().toString();\n+    volumeName = \"closecontainerexceptionhandlingtest\";\n+    bucketName = volumeName;\n+    objectStore.createVolume(volumeName);\n+    objectStore.getVolume(volumeName).createBucket(bucketName);\n+  }\n+\n+  private String getKeyName() {\n+    return UUID.randomUUID().toString();\n+  }\n+\n+  /**\n+  * Shutdown MiniDFSCluster.\n+  */\n+\n+  @AfterClass\n+  public static void shutdown() {\n+    if (cluster != null) {\n+      cluster.shutdown();\n+    }\n+  }\n+\n+  @Test\n+  public void testDiscardPreallocatedBlocks() throws Exception {\n+    String keyName = getKeyName();\n+    OzoneOutputStream key =\n+        createKey(keyName, ReplicationType.RATIS, 2 * blockSize);\n+    KeyOutputStream keyOutputStream =\n+        (KeyOutputStream) key.getOutputStream();\n+    Assert.assertTrue(key.getOutputStream() instanceof KeyOutputStream);\n+    // With the initial size provided, it should have pre allocated 2 blocks\n+    Assert.assertEquals(2, keyOutputStream.getStreamEntries().size());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTkyNzYxOQ=="}, "originalCommit": {"oid": "1cd8866ef7d1fb3e84fb3cdca773ae02135b8eaa"}, "originalPosition": 132}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3892, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}