{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMDA0MDY0", "number": 1337, "title": "HDDS-4129. change MAX_QUOTA_IN_BYTES to Long.MAX_VALUE.", "bodyText": "What changes were proposed in this pull request?\nCurrently MAX_QUOTA_IN_BYTES is 1EB, which is not very exact. Later we need use this to determine whether quota is enabled or not.\nWe need to change it to long.max_value to be consistent with HDFS.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4129\nHow was this patch tested?\nExisting UT", "createdAt": "2020-08-19T08:25:58Z", "url": "https://github.com/apache/ozone/pull/1337", "merged": true, "mergeCommit": {"oid": "04ac1ef2aeda7ca2758449fdd35c8c42b2b6baa9"}, "closed": true, "closedAt": "2020-09-11T07:12:52Z", "author": {"login": "captainzmc"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCES4wAFqTQ3MzYwOTQ0OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHddhiAH2gAyNDcwMDA0MDY0OjE2MTM3NTg4M2YwOTM2ODIxYjgyNWUyNDUzYWU3NjdiOTkzM2IwZjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNjA5NDQ4", "url": "https://github.com/apache/ozone/pull/1337#pullrequestreview-473609448", "createdAt": "2020-08-24T15:24:52Z", "commit": {"oid": "16772eee391abb6c4d12ae8e07864e26f2a88127"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNToyNDo1M1rOHFqSHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNToyNDo1M1rOHFqSHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY5NzY5NA==", "bodyText": "What about volumes created before this change with the previous max. value?  Will those be treated by new version as if quota had been enabled for them?", "url": "https://github.com/apache/ozone/pull/1337#discussion_r475697694", "createdAt": "2020-08-24T15:24:53Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "diffHunk": "@@ -200,9 +200,9 @@ public static Versioning getVersioning(boolean versioning) {\n \n \n   /**\n-   * Max OM Quota size of 1024 PB.\n+   * Max OM Quota size of Long.MAX_VALUE.\n    */\n-  public static final long MAX_QUOTA_IN_BYTES = 1024L * 1024 * TB;\n+  public static final long MAX_QUOTA_IN_BYTES = Long.MAX_VALUE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16772eee391abb6c4d12ae8e07864e26f2a88127"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNDc0OTc1", "url": "https://github.com/apache/ozone/pull/1337#pullrequestreview-482474975", "createdAt": "2020-09-04T08:48:32Z", "commit": {"oid": "3f1fd51531e3f2836bcc7c916d8b1a0c0e72d8fa"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwODo0ODozMlrOHNFR7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwODo1MjoxN1rOHNFZ7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ4MDA0Nw==", "bodyText": "Can we add a UT for this function?", "url": "https://github.com/apache/ozone/pull/1337#discussion_r483480047", "createdAt": "2020-09-04T08:48:32Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3540,6 +3546,43 @@ public boolean getEnableFileSystemPaths() {\n         OZONE_OM_ENABLE_FILESYSTEM_PATHS_DEFAULT);\n   }\n \n+  /**\n+   * Initialize volume's quota, which resolves the problem that the old quota\n+   * initial value was not set correctly. This method will be removed in a\n+   * later version.\n+   * @throws IOException\n+   */\n+  private void initializeOldVolumeQuota() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f1fd51531e3f2836bcc7c916d8b1a0c0e72d8fa"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ4MDUzMQ==", "bodyText": "Why  omVolumeArgs.getQuotaInBytes() == OzoneConsts.MAX_QUOTA_IN_BYTES check is required here?", "url": "https://github.com/apache/ozone/pull/1337#discussion_r483480531", "createdAt": "2020-09-04T08:49:23Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3540,6 +3546,43 @@ public boolean getEnableFileSystemPaths() {\n         OZONE_OM_ENABLE_FILESYSTEM_PATHS_DEFAULT);\n   }\n \n+  /**\n+   * Initialize volume's quota, which resolves the problem that the old quota\n+   * initial value was not set correctly. This method will be removed in a\n+   * later version.\n+   * @throws IOException\n+   */\n+  private void initializeOldVolumeQuota() throws IOException {\n+\n+    TableIterator<String, ? extends Table.KeyValue<String,\n+         OmVolumeArgs>> iterator = metadataManager.getVolumeTable().iterator();\n+    while(iterator.hasNext()) {\n+      OmVolumeArgs omVolumeArgs = iterator.next().getValue();\n+      String omVolumeKey = metadataManager.getVolumeKey(\n+          omVolumeArgs.getVolume());\n+      // Previously, the volume quota was created to default to 1EB. To change\n+      // to -1, default does not enable quota.\n+      if (omVolumeArgs.getQuotaInBytes() == 1024 * 1024 * TB ||\n+          omVolumeArgs.getQuotaInBytes() == OzoneConsts.MAX_QUOTA_IN_BYTES) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f1fd51531e3f2836bcc7c916d8b1a0c0e72d8fa"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ4MDc5NA==", "bodyText": "duplicate \",\"", "url": "https://github.com/apache/ozone/pull/1337#discussion_r483480794", "createdAt": "2020-09-04T08:49:52Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3540,6 +3546,43 @@ public boolean getEnableFileSystemPaths() {\n         OZONE_OM_ENABLE_FILESYSTEM_PATHS_DEFAULT);\n   }\n \n+  /**\n+   * Initialize volume's quota, which resolves the problem that the old quota\n+   * initial value was not set correctly. This method will be removed in a\n+   * later version.\n+   * @throws IOException\n+   */\n+  private void initializeOldVolumeQuota() throws IOException {\n+\n+    TableIterator<String, ? extends Table.KeyValue<String,\n+         OmVolumeArgs>> iterator = metadataManager.getVolumeTable().iterator();\n+    while(iterator.hasNext()) {\n+      OmVolumeArgs omVolumeArgs = iterator.next().getValue();\n+      String omVolumeKey = metadataManager.getVolumeKey(\n+          omVolumeArgs.getVolume());\n+      // Previously, the volume quota was created to default to 1EB. To change\n+      // to -1, default does not enable quota.\n+      if (omVolumeArgs.getQuotaInBytes() == 1024 * 1024 * TB ||\n+          omVolumeArgs.getQuotaInBytes() == OzoneConsts.MAX_QUOTA_IN_BYTES) {\n+        omVolumeArgs.setQuotaInBytes(-1);\n+        // Commit to DB.\n+        BatchOperation batchOperation =\n+            metadataManager.getStore().initBatchOperation();\n+        metadataManager.getVolumeTable().putWithBatch(batchOperation,\n+            omVolumeKey, omVolumeArgs);\n+        metadataManager.getStore().commitBatchOperation(batchOperation);\n+\n+        // Add to cache.\n+        long transactionID = (Long.MAX_VALUE - 1) >> 8;\n+        metadataManager.getVolumeTable().addCacheEntry(\n+            new CacheKey<>(omVolumeKey),\n+            new CacheValue<>(Optional.of(omVolumeArgs), transactionID));\n+        LOG.info(\"Update Volume {}'s quota to -1, , default does not enable\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f1fd51531e3f2836bcc7c916d8b1a0c0e72d8fa"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ4MjA5Mw==", "bodyText": "There is one risk here,  if user set the quota to 1EB specifically,  we cann't reset it to -1 on next OM restart.", "url": "https://github.com/apache/ozone/pull/1337#discussion_r483482093", "createdAt": "2020-09-04T08:52:17Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3540,6 +3546,43 @@ public boolean getEnableFileSystemPaths() {\n         OZONE_OM_ENABLE_FILESYSTEM_PATHS_DEFAULT);\n   }\n \n+  /**\n+   * Initialize volume's quota, which resolves the problem that the old quota\n+   * initial value was not set correctly. This method will be removed in a\n+   * later version.\n+   * @throws IOException\n+   */\n+  private void initializeOldVolumeQuota() throws IOException {\n+\n+    TableIterator<String, ? extends Table.KeyValue<String,\n+         OmVolumeArgs>> iterator = metadataManager.getVolumeTable().iterator();\n+    while(iterator.hasNext()) {\n+      OmVolumeArgs omVolumeArgs = iterator.next().getValue();\n+      String omVolumeKey = metadataManager.getVolumeKey(\n+          omVolumeArgs.getVolume());\n+      // Previously, the volume quota was created to default to 1EB. To change\n+      // to -1, default does not enable quota.\n+      if (omVolumeArgs.getQuotaInBytes() == 1024 * 1024 * TB ||", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f1fd51531e3f2836bcc7c916d8b1a0c0e72d8fa"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e8f4f611d00a1bc68bb571403935c2afc1110b7", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/7e8f4f611d00a1bc68bb571403935c2afc1110b7", "committedDate": "2020-09-04T09:12:25Z", "message": "change max quota in bytes to long max value."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "daae0e22682f0a6deaaeead0a994a9890ccb6f1f", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/daae0e22682f0a6deaaeead0a994a9890ccb6f1f", "committedDate": "2020-09-04T09:12:25Z", "message": "initialize old volume quota."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c955f26489ad502d4f8c364c71ae26f3f604e1cb", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/c955f26489ad502d4f8c364c71ae26f3f604e1cb", "committedDate": "2020-09-04T09:24:06Z", "message": "fix review issues."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3f1fd51531e3f2836bcc7c916d8b1a0c0e72d8fa", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/3f1fd51531e3f2836bcc7c916d8b1a0c0e72d8fa", "committedDate": "2020-09-04T04:36:47Z", "message": "initialize old volume quota."}, "afterCommit": {"oid": "c955f26489ad502d4f8c364c71ae26f3f604e1cb", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/c955f26489ad502d4f8c364c71ae26f3f604e1cb", "committedDate": "2020-09-04T09:24:06Z", "message": "fix review issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a64e251283f87e724da389c4cbdd4792eac3511e", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/a64e251283f87e724da389c4cbdd4792eac3511e", "committedDate": "2020-09-10T09:33:56Z", "message": "Revert \"fix review issues.\"\n\nThis reverts commit c955f26489ad502d4f8c364c71ae26f3f604e1cb."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "161375883f0936821b825e2453ae767b9933b0f7", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/161375883f0936821b825e2453ae767b9933b0f7", "committedDate": "2020-09-10T09:34:12Z", "message": "Revert \"initialize old volume quota.\"\n\nThis reverts commit daae0e22682f0a6deaaeead0a994a9890ccb6f1f."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2742, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}