{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2NjkwMTkx", "number": 1506, "title": "HDDS-4359. Expose VolumeIOStats in DN JMX", "bodyText": "https://issues.apache.org/jira/browse/HDDS-4359\nHow was this patch tested?\nChecked manually in DN JMX (initial):\ne.g. http://127.0.0.1:9882/jmx?qry=Hadoop:service=HddsDatanode,name=VolumeIOStats-/data/hdds\n{\n  \"beans\" : [ {\n    \"name\" : \"Hadoop:service=HddsDatanode,name=VolumeIOStats-/data/hdds\",\n    \"modelerType\" : \"VolumeIOStats-/data/hdds\",\n    \"tag.Hostname\" : \"38d7022a0825\",\n    \"ReadBytes\" : 0,\n    \"ReadOpCount\" : 0,\n    \"WriteBytes\" : 0,\n    \"WriteOpCount\" : 0,\n    \"ReadTime\" : 0,\n    \"WriteTime\" : 0\n  } ]\n}\n(a short while) after executing ozone fs -put README.md ofs://om/vol1/buck1/:\n    \"name\" : \"Hadoop:service=HddsDatanode,name=VolumeIOStats-/data/hdds\",\n    \"modelerType\" : \"VolumeIOStats-/data/hdds\",\n    \"tag.Hostname\" : \"38d7022a0825\",\n    \"ReadBytes\" : 0,\n    \"ReadOpCount\" : 0,\n    \"WriteBytes\" : 3841,\n    \"WriteOpCount\" : 1,\n    \"ReadTime\" : 0,\n    \"WriteTime\" : 1", "createdAt": "2020-10-20T10:52:49Z", "url": "https://github.com/apache/ozone/pull/1506", "merged": true, "mergeCommit": {"oid": "6ba64bf3dce5e759ee21061b433c387be6b4d911"}, "closed": true, "closedAt": "2020-10-21T17:23:33Z", "author": {"login": "smengcl"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUWifHAH2gAyNTA2NjkwMTkxOmEzNjI5NDc1MTE0NjlmYjM5ODg0MjMyMDYxZTFlNWZiNGIzNDFlNDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUoRzRAH2gAyNTA2NjkwMTkxOmVlMzllYjg1NmRlZWE1Y2M4NDMwOTNhMzFmNGQ3M2ZmOTNlMmE4Mjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a362947511469fb39884232061e1e5fb4b341e47", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/a362947511469fb39884232061e1e5fb4b341e47", "committedDate": "2020-10-20T10:51:18Z", "message": "HDDS-4359. Expose VolumeIOStats in DN JMX\n\nChange-Id: I845824edc4af1c41c17e2f2e8a5ad63a7b9e4579"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyODAzNzQz", "url": "https://github.com/apache/ozone/pull/1506#pullrequestreview-512803743", "createdAt": "2020-10-20T14:48:29Z", "commit": {"oid": "a362947511469fb39884232061e1e5fb4b341e47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNDo0ODoyOVrOHlA73g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNDo0ODoyOVrOHlA73g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU3NDY4Ng==", "bodyText": "We should have the corresponding VolumeIOStats  unregister method to unregister these metric.", "url": "https://github.com/apache/ozone/pull/1506#discussion_r508574686", "createdAt": "2020-10-20T14:48:29Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/volume/VolumeIOStats.java", "diffHunk": "@@ -18,121 +18,135 @@\n \n package org.apache.hadoop.ozone.container.common.volume;\n \n-import java.util.concurrent.atomic.AtomicLong;\n+import org.apache.hadoop.metrics2.MetricsSystem;\n+import org.apache.hadoop.metrics2.annotation.Metric;\n+import org.apache.hadoop.metrics2.lib.DefaultMetricsSystem;\n+import org.apache.hadoop.metrics2.lib.MetricsRegistry;\n+import org.apache.hadoop.metrics2.lib.MutableCounterLong;\n \n /**\n  * This class is used to track Volume IO stats for each HDDS Volume.\n  */\n public class VolumeIOStats {\n+  private String name = VolumeIOStats.class.getSimpleName();\n \n-  private final AtomicLong readBytes;\n-  private final AtomicLong readOpCount;\n-  private final AtomicLong writeBytes;\n-  private final AtomicLong writeOpCount;\n-  private final AtomicLong readTime;\n-  private final AtomicLong writeTime;\n+  private @Metric MutableCounterLong readBytes;\n+  private @Metric MutableCounterLong readOpCount;\n+  private @Metric MutableCounterLong writeBytes;\n+  private @Metric MutableCounterLong writeOpCount;\n+  private @Metric MutableCounterLong readTime;\n+  private @Metric MutableCounterLong writeTime;\n+  private MetricsRegistry registry;\n \n   public VolumeIOStats() {\n-    readBytes = new AtomicLong(0);\n-    readOpCount = new AtomicLong(0);\n-    writeBytes = new AtomicLong(0);\n-    writeOpCount = new AtomicLong(0);\n-    readTime = new AtomicLong(0);\n-    writeTime = new AtomicLong(0);\n+    init();\n+  }\n+\n+  public VolumeIOStats(String identifier) {\n+    this.name += '-' + identifier;\n+    init();\n+  }\n+\n+  public void init() {\n+    DefaultMetricsSystem.initialize(name);\n+    MetricsSystem ms = DefaultMetricsSystem.instance();\n+    ms.register(name, \"Volume I/O Statistics\", this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a362947511469fb39884232061e1e5fb4b341e47"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1628e2b6cdea0ba89bd5378ab94f2952759dcc9e", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/1628e2b6cdea0ba89bd5378ab94f2952759dcc9e", "committedDate": "2020-10-20T20:34:40Z", "message": "Add unregister()\n\nChange-Id: I66431f9445ade6b7212c87f4f8d8147b4bc73ca2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a411543875da865d107290a76b4647b292355ea7", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/a411543875da865d107290a76b4647b292355ea7", "committedDate": "2020-10-20T21:26:27Z", "message": "Fix TestOzoneContainer#testBuildNodeReport.\n\nNo need to DefaultMetricsSystem.initialize(sourceName).\n`HddsServerUtil.initializeMetrics(conf, \"HddsDatanode\");` call has already initialized the metrics.\nCalling this again results in UT failures.\n\nChange-Id: Iaeb29e153c7394d2b80eb1bd74db0aeb566f8448"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a124b61403a9aa62a93b5342e9fd77e7fa49f2a0", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/a124b61403a9aa62a93b5342e9fd77e7fa49f2a0", "committedDate": "2020-10-20T22:04:26Z", "message": "Remove MetricsRegistry.\n\nChange-Id: I86adf4d6ecc6b12687dfb6c2554bb2c7597a6807"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee3123789e76b12f3324ecdef98a78775215e6b8", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/ee3123789e76b12f3324ecdef98a78775215e6b8", "committedDate": "2020-10-21T00:22:25Z", "message": "Checkstyle.\n\nChange-Id: Id7df790d521d639377390cabe75450fc350e234e"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMzA1NjUz", "url": "https://github.com/apache/ozone/pull/1506#pullrequestreview-513305653", "createdAt": "2020-10-21T04:55:00Z", "commit": {"oid": "ee3123789e76b12f3324ecdef98a78775215e6b8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eca96f51d9925ccf57b95853f756cefb70f37d92", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/eca96f51d9925ccf57b95853f756cefb70f37d92", "committedDate": "2020-10-21T06:19:26Z", "message": "Add test in TestContainerMetrics.\n\nChange-Id: I8b607e3d23f558931d4529b8cd95817666ca0a99"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee39eb856deea5cc843093a31f4d73ff93e2a827", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/ee39eb856deea5cc843093a31f4d73ff93e2a827", "committedDate": "2020-10-21T07:31:22Z", "message": "Checkstyle.\n\nChange-Id: I2652375e984528d8f38373e52638f6444fdd5273"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2401, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}