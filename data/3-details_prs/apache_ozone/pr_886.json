{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExMjI5Mjgw", "number": 886, "title": "HDDS-3473. Ozone chunkinfo CLI should display block file path info", "bodyText": "What changes were proposed in this pull request?\nThe debug tool CLI was not considering both the file per block and file per chunk strategies while displaying the file path .This change fixes the issue and depending on the strategy , the path is shown in a field called files.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3473\nHow was this patch tested?\nManually tested.", "createdAt": "2020-04-30T07:57:30Z", "url": "https://github.com/apache/ozone/pull/886", "merged": true, "mergeCommit": {"oid": "a2d650a2ebe16e1c51195b6aaca7afb983c382e7"}, "closed": true, "closedAt": "2020-05-15T09:01:53Z", "author": {"login": "sadanand48"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccoTPlgH2gAyNDExMjI5MjgwOjhlZWIxNzQ3MDY2MTM3MmJjMGEyNjMwNTA0MTczNWJhOTYyNjU5MGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcheRSWgFqTQxMjQ3MDk4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8eeb17470661372bc0a26305041735ba9626590a", "author": {"user": {"login": "sadanand48", "name": "Sadanand Shenoy"}}, "url": "https://github.com/apache/ozone/commit/8eeb17470661372bc0a26305041735ba9626590a", "committedDate": "2020-04-30T07:53:11Z", "message": "HDDS-3473.ozone chunkinfo CLI should display block file path info"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMjg5MTU3", "url": "https://github.com/apache/ozone/pull/886#pullrequestreview-403289157", "createdAt": "2020-04-30T08:01:39Z", "commit": {"oid": "8eeb17470661372bc0a26305041735ba9626590a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwODowMTozOVrOGOeKtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwODowMjoxNVrOGOeL9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgyNzUwOA==", "bodyText": "lets convert this if into a switch case, in case new CHunkLayoutVersions are added later, there should be an option of adding it later. Also for default case lets throw an exception.", "url": "https://github.com/apache/ozone/pull/886#discussion_r417827508", "createdAt": "2020-04-30T08:01:39Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/debug/ChunkKeyHandler.java", "diffHunk": "@@ -128,17 +131,23 @@ protected void execute(OzoneClient client, OzoneAddress address)\n         chunkDetails.setChunkName(chunkInfo.getChunkName());\n         chunkDetails.setChunkOffset(chunkInfo.getOffset());\n         chunkDetailsList.add(chunkDetails);\n-        chunkPaths.add(getChunkLocationPath(containerData.getContainerPath())\n-              + File.separator\n-              + chunkInfo.getChunkName());\n+        if (chunkLayOutVersion == ChunkLayOutVersion.FILE_PER_CHUNK) {\n+          chunkPaths.add(getChunkLocationPath(containerData.getContainerPath())\n+                  + File.separator\n+                  + chunkInfo.getChunkName());\n+        } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8eeb17470661372bc0a26305041735ba9626590a"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgyNzgzMQ==", "bodyText": "Can this command be executed on the datanode container and lets do a check that the file exists.", "url": "https://github.com/apache/ozone/pull/886#discussion_r417827831", "createdAt": "2020-04-30T08:02:15Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/dist/src/main/smoketest/basic/ozone-shell.robot", "diffHunk": "@@ -121,7 +121,7 @@ Test key handling\n     ${result} =     Execute             ozone sh key info ${protocol}${server}/${volume}/bb1/key1 | jq -r '. | select(.name==\"key1\")'\n                     Should contain      ${result}       creationTime\n     ${result} =     Execute             ozone debug chunkinfo ${protocol}${server}/${volume}/bb1/key1 | jq -r '.[]'\n-                    Should contain      ${result}       chunks\n+                    Should contain      ${result}       files", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8eeb17470661372bc0a26305041735ba9626590a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9946fb165af8c4615fe70a03c9d279e9251cc42f", "author": {"user": {"login": "sadanand48", "name": "Sadanand Shenoy"}}, "url": "https://github.com/apache/ozone/commit/9946fb165af8c4615fe70a03c9d279e9251cc42f", "committedDate": "2020-04-30T17:44:31Z", "message": "addressed review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdd21677fef1fe606eca885a58a32e15dad0f472", "author": {"user": {"login": "sadanand48", "name": "Sadanand Shenoy"}}, "url": "https://github.com/apache/ozone/commit/cdd21677fef1fe606eca885a58a32e15dad0f472", "committedDate": "2020-05-04T10:23:21Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5648c467e864671543fbe43b5a5a774eeda4490e", "author": {"user": {"login": "sadanand48", "name": "Sadanand Shenoy"}}, "url": "https://github.com/apache/ozone/commit/5648c467e864671543fbe43b5a5a774eeda4490e", "committedDate": "2020-05-04T10:31:27Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14e7103a3286df0b5d75f705eebffb024de479d3", "author": {"user": {"login": "sadanand48", "name": "Sadanand Shenoy"}}, "url": "https://github.com/apache/ozone/commit/14e7103a3286df0b5d75f705eebffb024de479d3", "committedDate": "2020-05-04T12:03:17Z", "message": "fix smoketest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NTEwMDA0", "url": "https://github.com/apache/ozone/pull/886#pullrequestreview-405510004", "createdAt": "2020-05-05T06:02:11Z", "commit": {"oid": "14e7103a3286df0b5d75f705eebffb024de479d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwNjowMjoxMVrOGQbcbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwNjowMjoxMVrOGQbcbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg4MDA0NQ==", "bodyText": "I think we should move the code to give the chunk file path given the containerID/ContainerData into some common utilities class and use it across client/server so that any further changes won't break it..", "url": "https://github.com/apache/ozone/pull/886#discussion_r419880045", "createdAt": "2020-05-05T06:02:11Z", "author": {"login": "bshashikant"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/debug/ChunkKeyHandler.java", "diffHunk": "@@ -128,17 +132,31 @@ protected void execute(OzoneClient client, OzoneAddress address)\n         chunkDetails.setChunkName(chunkInfo.getChunkName());\n         chunkDetails.setChunkOffset(chunkInfo.getOffset());\n         chunkDetailsList.add(chunkDetails);\n-        chunkPaths.add(getChunkLocationPath(containerData.getContainerPath())\n-              + File.separator\n-              + chunkInfo.getChunkName());\n+        switch (chunkLayOutVersion) {\n+        case FILE_PER_CHUNK:\n+          chunkPaths.add(getChunkLocationPath(containerData\n+                  .getContainerPath())\n+                  + File.separator\n+                  + chunkInfo.getChunkName());\n+          break;\n+        case FILE_PER_BLOCK:\n+          chunkPaths.add(getChunkLocationPath(containerData\n+                  .getContainerPath())\n+                  + File.separator\n+                  + keyLocation.getLocalID() + \".block\");\n+          break;\n+        default:\n+          throw new StorageContainerException(\"chunk strategy does not exist\",\n+                  ContainerProtos.Result.UNABLE_TO_FIND_CHUNK);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14e7103a3286df0b5d75f705eebffb024de479d3"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b9c097cdc240ea63d35cb2964945d26970ac4d6", "author": {"user": {"login": "sadanand48", "name": "Sadanand Shenoy"}}, "url": "https://github.com/apache/ozone/commit/7b9c097cdc240ea63d35cb2964945d26970ac4d6", "committedDate": "2020-05-05T07:07:24Z", "message": "addressed review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NTUxNTc3", "url": "https://github.com/apache/ozone/pull/886#pullrequestreview-405551577", "createdAt": "2020-05-05T07:32:34Z", "commit": {"oid": "7b9c097cdc240ea63d35cb2964945d26970ac4d6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwNzozMjozNFrOGQdmBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwNzozMjozNFrOGQdmBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkxNTI3MA==", "bodyText": "I'd prefer taking chunk file path directly from ChunkLayOutVersion.getChunkFile() instead of the switch.  This way if a new enum constant is introduced, this code will work without any changes.\nThis needs a minor refactoring in ChunkLayOutVersion, which accepts a ContainerData object, to work directly with the chunk dir:\n--- hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/impl/ChunkLayOutVersion.java\n+++ hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/impl/ChunkLayOutVersion.java\n@@ -40,17 +40,15 @@\n\n   FILE_PER_CHUNK(1, \"One file per chunk\") {\n     @Override\n-    public File getChunkFile(ContainerData containerData, BlockID blockID,\n-        ChunkInfo info) throws StorageContainerException {\n-      File chunksLoc = verifyChunkDirExists(containerData);\n-      return chunksLoc.toPath().resolve(info.getChunkName()).toFile();\n+    public File getChunkFile(File chunkDir, BlockID blockID,\n+        ChunkInfo info) {\n+      return chunkDir.toPath().resolve(info.getChunkName()).toFile();\n     }\n   },\n   FILE_PER_BLOCK(2, \"One file per block\") {\n     @Override\n-    public File getChunkFile(ContainerData containerData, BlockID blockID,\n-        ChunkInfo info) throws StorageContainerException {\n-      File chunkDir = verifyChunkDirExists(containerData);\n+    public File getChunkFile(File chunkDir, BlockID blockID,\n+        ChunkInfo info) {\n       return new File(chunkDir, blockID.getLocalID() + \".block\");\n     }\n   };\n@@ -118,8 +116,14 @@ public String getDescription() {\n     return description;\n   }\n\n-  public abstract File getChunkFile(ContainerData containerData,\n-      BlockID blockID, ChunkInfo info) throws StorageContainerException;\n+  public abstract File getChunkFile(File chunksDir,\n+      BlockID blockID, ChunkInfo info);\n+\n+  public File getChunkFile(ContainerData containerData,\n+      BlockID blockID, ChunkInfo info) throws StorageContainerException {\n+    File chunksLoc = verifyChunkDirExists(containerData);\n+    return getChunkFile(chunksLoc, blockID, info);\n+  }\n\n   @Override\n   public String toString() {", "url": "https://github.com/apache/ozone/pull/886#discussion_r419915270", "createdAt": "2020-05-05T07:32:34Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/debug/ChunkFileUtility.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package org.apache.hadoop.ozone.debug;\n+\n+import org.apache.hadoop.hdds.protocol.datanode.proto.ContainerProtos;\n+import org.apache.hadoop.hdds.scm.container.common.helpers.StorageContainerException;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.container.common.impl.ChunkLayOutVersion;\n+import org.apache.hadoop.ozone.om.helpers.OmKeyLocationInfo;\n+\n+import java.io.File;\n+\n+\n+public final class ChunkFileUtility {\n+\n+    static String getChunkLocationPath(String containerLocation) {\n+        return containerLocation + File.separator + OzoneConsts.STORAGE_DIR_CHUNKS;\n+    }\n+\n+    public static String getChunkFilePath(ContainerProtos.ChunkInfo\n+      chunkInfo, OmKeyLocationInfo keyLocation,\n+      ContainerProtos.ContainerDataProto data,\n+      ChunkLayOutVersion layOutVersion)\n+      throws StorageContainerException {\n+        switch (layOutVersion) {\n+        case FILE_PER_CHUNK:\n+          return  getChunkLocationPath(data\n+                  .getContainerPath())\n+                  + File.separator\n+                  + chunkInfo.getChunkName();\n+        case FILE_PER_BLOCK:\n+          return  getChunkLocationPath(data\n+                  .getContainerPath())\n+                  + File.separator\n+                  + keyLocation.getLocalID() + \".block\";\n+        default:\n+          throw new StorageContainerException(\"chunk strategy does not exist\",\n+                  ContainerProtos.Result.UNABLE_TO_FIND_CHUNK);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b9c097cdc240ea63d35cb2964945d26970ac4d6"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d22f2aa1ff4b3994dada72ffe09b50f2cfc7a2e", "author": {"user": {"login": "sadanand48", "name": "Sadanand Shenoy"}}, "url": "https://github.com/apache/ozone/commit/9d22f2aa1ff4b3994dada72ffe09b50f2cfc7a2e", "committedDate": "2020-05-05T07:45:19Z", "message": "fix rat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3758b77e7ccf1e99511cfc92405e6ac4d85a0e31", "author": {"user": {"login": "sadanand48", "name": "Sadanand Shenoy"}}, "url": "https://github.com/apache/ozone/commit/3758b77e7ccf1e99511cfc92405e6ac4d85a0e31", "committedDate": "2020-05-05T10:10:25Z", "message": "addressed review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3MjAyOTE5", "url": "https://github.com/apache/ozone/pull/886#pullrequestreview-407202919", "createdAt": "2020-05-07T07:11:47Z", "commit": {"oid": "3758b77e7ccf1e99511cfc92405e6ac4d85a0e31"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwNzoxMTo0N1rOGRxR2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwNzoxODo1NlrOGRxf0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI4NjM2Mw==", "bodyText": "I think this should be a Suite Setup instead of a Test Case, but it's OK to improve in a followup Jira.", "url": "https://github.com/apache/ozone/pull/886#discussion_r421286363", "createdAt": "2020-05-07T07:11:47Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/dist/src/main/smoketest/debug/ozone-debug.robot", "diffHunk": "@@ -0,0 +1,37 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+*** Settings ***\n+Documentation       Test ozone Debug CLI\n+Library             OperatingSystem\n+Resource            ../commonlib.robot\n+Test Timeout        2 minute\n+\n+*** Variables ***\n+\n+\n+*** Test Cases ***\n+Create Volume,Bucket and put key\n+   Execute             ozone sh volume create o3://om/vol1 --quota 100TB\n+   Execute             ozone sh bucket create o3://om/vol1/bucket1\n+   Execute             ozone sh key put o3://om/vol1/bucket1/debugKey /opt/hadoop/NOTICE.txt", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3758b77e7ccf1e99511cfc92405e6ac4d85a0e31"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI4OTkzNw==", "bodyText": "Execute checks the return code of the command, so I think this should be enough to verify that the file exists:\n                    Execute             test -f ${result}\n\nBetter yet, there is a Robot keyword for the same: File Should Exist\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                ${result3} =    Execute             echo \"exists\"\n          \n          \n            \n                ${result2} =    Execute             test -f ${result} && echo \"exists\"\n          \n          \n            \n                                Should Be Equal     ${result2}       ${result3}\n          \n          \n            \n                                File Should Exist             ${result}", "url": "https://github.com/apache/ozone/pull/886#discussion_r421289937", "createdAt": "2020-05-07T07:18:56Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/dist/src/main/smoketest/debug/ozone-debug.robot", "diffHunk": "@@ -0,0 +1,37 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+*** Settings ***\n+Documentation       Test ozone Debug CLI\n+Library             OperatingSystem\n+Resource            ../commonlib.robot\n+Test Timeout        2 minute\n+\n+*** Variables ***\n+\n+\n+*** Test Cases ***\n+Create Volume,Bucket and put key\n+   Execute             ozone sh volume create o3://om/vol1 --quota 100TB\n+   Execute             ozone sh bucket create o3://om/vol1/bucket1\n+   Execute             ozone sh key put o3://om/vol1/bucket1/debugKey /opt/hadoop/NOTICE.txt\n+\n+Test ozone debug\n+    ${result} =     Execute             ozone debug chunkinfo o3://om/vol1/bucket1/debugKey | jq -r '.[]'\n+                    Should contain      ${result}       files\n+    ${result} =     Execute             ozone debug chunkinfo o3://om/vol1/bucket1/debugKey | jq -r '.[].files[0]'\n+    ${result3} =    Execute             echo \"exists\"\n+    ${result2} =    Execute             test -f ${result} && echo \"exists\"\n+                    Should Be Equal     ${result2}       ${result3}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3758b77e7ccf1e99511cfc92405e6ac4d85a0e31"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b27b51a4090c8aedfdfc9e632ea9c8fefa0da73", "author": {"user": {"login": "sadanand48", "name": "Sadanand Shenoy"}}, "url": "https://github.com/apache/ozone/commit/4b27b51a4090c8aedfdfc9e632ea9c8fefa0da73", "committedDate": "2020-05-14T17:01:38Z", "message": "Update hadoop-ozone/dist/src/main/smoketest/debug/ozone-debug.robot\n\nCo-authored-by: Doroszlai, Attila <6454655+adoroszlai@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e16600c6b5813c19dddc0edc7635e7c6b4a3bbc", "author": {"user": {"login": "sadanand48", "name": "Sadanand Shenoy"}}, "url": "https://github.com/apache/ozone/commit/3e16600c6b5813c19dddc0edc7635e7c6b4a3bbc", "committedDate": "2020-05-14T17:26:31Z", "message": "addressed review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36fb6a654b0ba19bcd82aae9f6516ce486cdc4e0", "author": {"user": {"login": "sadanand48", "name": "Sadanand Shenoy"}}, "url": "https://github.com/apache/ozone/commit/36fb6a654b0ba19bcd82aae9f6516ce486cdc4e0", "committedDate": "2020-05-14T17:28:13Z", "message": "addressed review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNDcwOTg0", "url": "https://github.com/apache/ozone/pull/886#pullrequestreview-412470984", "createdAt": "2020-05-15T09:01:37Z", "commit": {"oid": "36fb6a654b0ba19bcd82aae9f6516ce486cdc4e0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3212, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}