{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUzOTY0Njg5", "number": 1227, "title": "HDDS-3993. Create volume required for S3G during OM startup.", "bodyText": "What changes were proposed in this pull request?\nCreate volume required for S3G during Om startup\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3993\nHow was this patch tested?\nTested to verify on docker-compose om-ha-s3 cluster, whether s3v volume is created or not.\nbash-4.2$ ozone sh volume list o3://id1\n{\n  \"metadata\" : { },\n  \"name\" : \"s3v\",\n  \"admin\" : \"hadoop\",\n  \"owner\" : \"hadoop\",\n  \"creationTime\" : \"2020-07-21T00:01:53.739Z\",\n  \"modificationTime\" : \"2020-07-21T00:01:53.739Z\",\n  \"acls\" : [ {\n    \"type\" : \"USER\",\n    \"name\" : \"hadoop\",\n    \"aclScope\" : \"ACCESS\",\n    \"aclList\" : [ \"ALL\" ]\n  }, {\n    \"type\" : \"GROUP\",\n    \"name\" : \"users\",\n    \"aclScope\" : \"ACCESS\",\n    \"aclList\" : [ \"ALL\" ]\n  } ],\n  \"quota\" : 1152921504606846976\n}", "createdAt": "2020-07-21T00:16:01Z", "url": "https://github.com/apache/ozone/pull/1227", "merged": true, "mergeCommit": {"oid": "7dac140024214c2189b72fad0566a0252d63e93c"}, "closed": true, "closedAt": "2020-07-22T16:35:00Z", "author": {"login": "bharatviswa504"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc264MgAH2gAyNDUzOTY0Njg5OjdmNjUxOTg2NDdiY2ZhYmM4YTJhNzk1NmViNWFlNmFlMGZiYTBiMWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3UUHBgFqTQ1MzAxMjc4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7f65198647bcfabc8a2a7956eb5ae6ae0fba0b1a", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/7f65198647bcfabc8a2a7956eb5ae6ae0fba0b1a", "committedDate": "2020-07-21T00:13:52Z", "message": "HDDS-3993. Create volume required for S3G during OM startup.\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4650ae55e01343673e7a515957f5040821e3dbc8", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/4650ae55e01343673e7a515957f5040821e3dbc8", "committedDate": "2020-07-21T00:16:39Z", "message": "fix cs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "498eb60f38eee2341ed29f8d43676954b8324688", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/498eb60f38eee2341ed29f8d43676954b8324688", "committedDate": "2020-07-21T00:18:37Z", "message": "remove collect"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19372393899cccecb10730a141b522cc239a092f", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/19372393899cccecb10730a141b522cc239a092f", "committedDate": "2020-07-21T00:20:25Z", "message": "add log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMTAzOTMz", "url": "https://github.com/apache/ozone/pull/1227#pullrequestreview-452103933", "createdAt": "2020-07-21T03:39:24Z", "commit": {"oid": "19372393899cccecb10730a141b522cc239a092f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwMzozOToyNFrOG0m7kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwMzozOToyNFrOG0m7kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgxNjk3Ng==", "bodyText": "What is the implication of hard-coding the transaction id = 1, especially for existing clusters where the s3 volume may not exist?", "url": "https://github.com/apache/ozone/pull/1227#discussion_r457816976", "createdAt": "2020-07-21T03:39:24Z", "author": {"login": "arp7"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3502,4 +3516,95 @@ public boolean getEnableFileSystemPaths() {\n     return configuration.getBoolean(OZONE_OM_ENABLE_FILESYSTEM_PATHS,\n         OZONE_OM_ENABLE_FILESYSTEM_PATHS_DEFAULT);\n   }\n+\n+  /**\n+   * Create volume which is required for S3Gateway operations.\n+   * @throws IOException\n+   */\n+  private void addS3GVolumeToDB() throws IOException {\n+    String s3VolumeName = HddsClientUtils.getS3VolumeName(configuration);\n+    String dbVolumeKey = metadataManager.getVolumeKey(s3VolumeName);\n+\n+    if (!s3VolumeName.equals(OzoneConfigKeys.OZONE_S3_VOLUME_NAME_DEFAULT)) {\n+      LOG.warn(\"Make sure that all S3Gateway use same volume name.\" +\n+          \" Otherwise user need to manually create/configure Volume \" +\n+          \"configured by S3Gateway\");\n+    }\n+    if (!metadataManager.getVolumeTable().isExist(dbVolumeKey)) {\n+      long transactionID = 1L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19372393899cccecb10730a141b522cc239a092f"}, "originalPosition": 99}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMTEyMjA1", "url": "https://github.com/apache/ozone/pull/1227#pullrequestreview-452112205", "createdAt": "2020-07-21T04:08:53Z", "commit": {"oid": "19372393899cccecb10730a141b522cc239a092f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNDowODo1M1rOG0nXnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNDowODo1M1rOG0nXnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgyNDE1OQ==", "bodyText": "I looked into this function. I think hard-coding the transaction ID may be risky in a cluster where there are already some Ratis transactions however the s3v volume was not yet created. Perhaps we can set it to a really high value, something that is very unlikely to be hit in a real cluster. Like (MAX_ULONG - 1) >> 8", "url": "https://github.com/apache/ozone/pull/1227#discussion_r457824159", "createdAt": "2020-07-21T04:08:53Z", "author": {"login": "arp7"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3502,4 +3516,95 @@ public boolean getEnableFileSystemPaths() {\n     return configuration.getBoolean(OZONE_OM_ENABLE_FILESYSTEM_PATHS,\n         OZONE_OM_ENABLE_FILESYSTEM_PATHS_DEFAULT);\n   }\n+\n+  /**\n+   * Create volume which is required for S3Gateway operations.\n+   * @throws IOException\n+   */\n+  private void addS3GVolumeToDB() throws IOException {\n+    String s3VolumeName = HddsClientUtils.getS3VolumeName(configuration);\n+    String dbVolumeKey = metadataManager.getVolumeKey(s3VolumeName);\n+\n+    if (!s3VolumeName.equals(OzoneConfigKeys.OZONE_S3_VOLUME_NAME_DEFAULT)) {\n+      LOG.warn(\"Make sure that all S3Gateway use same volume name.\" +\n+          \" Otherwise user need to manually create/configure Volume \" +\n+          \"configured by S3Gateway\");\n+    }\n+    if (!metadataManager.getVolumeTable().isExist(dbVolumeKey)) {\n+      long transactionID = 1L;\n+      long objectID = OMFileRequest.getObjIDFromTxId(transactionID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19372393899cccecb10730a141b522cc239a092f"}, "originalPosition": 100}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMzk3MzI2", "url": "https://github.com/apache/ozone/pull/1227#pullrequestreview-452397326", "createdAt": "2020-07-21T12:19:46Z", "commit": {"oid": "19372393899cccecb10730a141b522cc239a092f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d127a6134b0493ceb6a2d49d40e21dc317d17b6d", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/d127a6134b0493ceb6a2d49d40e21dc317d17b6d", "committedDate": "2020-07-21T18:10:01Z", "message": "test fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b14d93c61747ec5f86d2f05b7bb0d8a555f99935", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/b14d93c61747ec5f86d2f05b7bb0d8a555f99935", "committedDate": "2020-07-21T18:15:33Z", "message": "add new test and remove volume creation step of s3v in robot test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2f285fac8d227a4fb14c78dc9e0a98dd857e90d", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/d2f285fac8d227a4fb14c78dc9e0a98dd857e90d", "committedDate": "2020-07-21T18:47:13Z", "message": "address review comment and add username"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0369bb704b60395f20b25b7ef4c46872d0cc8513", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/0369bb704b60395f20b25b7ef4c46872d0cc8513", "committedDate": "2020-07-21T19:02:11Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb1f8381f4697e0d695ab807d05ff7df47350158", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/bb1f8381f4697e0d695ab807d05ff7df47350158", "committedDate": "2020-07-21T19:05:52Z", "message": "revert proto.lock changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNzM4ODQ0", "url": "https://github.com/apache/ozone/pull/1227#pullrequestreview-452738844", "createdAt": "2020-07-21T18:50:55Z", "commit": {"oid": "d2f285fac8d227a4fb14c78dc9e0a98dd857e90d"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxODo1MDo1NVrOG1FaKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxOToxMDo1NFrOG1GFAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMxNjMzMQ==", "bodyText": "Spurious change.", "url": "https://github.com/apache/ozone/pull/1227#discussion_r458316331", "createdAt": "2020-07-21T18:50:55Z", "author": {"login": "arp7"}, "path": "hadoop-hdds/interface-client/src/main/proto/proto.lock", "diffHunk": "@@ -1935,4 +1935,4 @@\n       }\n     }\n   ]\n-}\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2f285fac8d227a4fb14c78dc9e0a98dd857e90d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMxNjU3OA==", "bodyText": "Unrelated to this patch? \ud83d\ude42", "url": "https://github.com/apache/ozone/pull/1227#discussion_r458316578", "createdAt": "2020-07-21T18:51:21Z", "author": {"login": "arp7"}, "path": "hadoop-hdds/interface-server/src/main/proto/proto.lock", "diffHunk": "@@ -457,6 +457,12 @@\n                 \"name\": \"storageReport\",\n                 \"type\": \"StorageReportProto\",\n                 \"is_repeated\": true\n+              },\n+              {\n+                \"id\": 2,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2f285fac8d227a4fb14c78dc9e0a98dd857e90d"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMyNzI5Ng==", "bodyText": "Let's assert in a test case that the generated object ID is correct.", "url": "https://github.com/apache/ozone/pull/1227#discussion_r458327296", "createdAt": "2020-07-21T19:10:54Z", "author": {"login": "arp7"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3502,4 +3517,95 @@ public boolean getEnableFileSystemPaths() {\n     return configuration.getBoolean(OZONE_OM_ENABLE_FILESYSTEM_PATHS,\n         OZONE_OM_ENABLE_FILESYSTEM_PATHS_DEFAULT);\n   }\n+\n+  /**\n+   * Create volume which is required for S3Gateway operations.\n+   * @throws IOException\n+   */\n+  private void addS3GVolumeToDB() throws IOException {\n+    String s3VolumeName = HddsClientUtils.getS3VolumeName(configuration);\n+    String dbVolumeKey = metadataManager.getVolumeKey(s3VolumeName);\n+\n+    if (!s3VolumeName.equals(OzoneConfigKeys.OZONE_S3_VOLUME_NAME_DEFAULT)) {\n+      LOG.warn(\"Make sure that all S3Gateway use same volume name.\" +\n+          \" Otherwise user need to manually create/configure Volume \" +\n+          \"configured by S3Gateway\");\n+    }\n+    if (!metadataManager.getVolumeTable().isExist(dbVolumeKey)) {\n+      long transactionID = (Long.MAX_VALUE - 1) >> 8;\n+      long objectID = OMFileRequest.getObjIDFromTxId(transactionID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2f285fac8d227a4fb14c78dc9e0a98dd857e90d"}, "originalPosition": 101}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f0c36a91800781445c6b265c6595bf026c6b2e4", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/5f0c36a91800781445c6b265c6595bf026c6b2e4", "committedDate": "2020-07-21T19:16:30Z", "message": "revert proto change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e53738e4e8f16a18f708e2c87001c66781894fe", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/7e53738e4e8f16a18f708e2c87001c66781894fe", "committedDate": "2020-07-21T20:10:41Z", "message": "test objectid and transactionid"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMDEyNzgz", "url": "https://github.com/apache/ozone/pull/1227#pullrequestreview-453012783", "createdAt": "2020-07-22T05:51:59Z", "commit": {"oid": "7e53738e4e8f16a18f708e2c87001c66781894fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2885, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}