{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5NDc1MjYw", "number": 938, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxMzo0OTo0NVrOD9zr3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMzowNzoxN1rOD-x2TQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MTM2NTQwOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineStateMap.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxMzo0OTo0NVrOGXhX1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxMzo0OTo0NVrOGXhX1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMxNzIwNQ==", "bodyText": "Besides above change, Can you also do the empty check for another condition branch?\n} else {\n// for transition from OPEN to CLOSED state remove pipeline from\n// query2OpenPipelines\nquery2OpenPipelines.get(query).remove(pipeline);   <---\n}\nThere is also a chance that remove operation can throw NPE.", "url": "https://github.com/apache/ozone/pull/938#discussion_r427317205", "createdAt": "2020-05-19T13:49:45Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineStateMap.java", "diffHunk": "@@ -374,7 +374,12 @@ Pipeline updatePipelineState(PipelineID pipelineID, PipelineState state)\n     PipelineQuery query = new PipelineQuery(pipeline);\n     if (updatedPipeline.getPipelineState() == PipelineState.OPEN) {\n       // for transition to OPEN state add pipeline to query2OpenPipelines\n-      query2OpenPipelines.get(query).add(updatedPipeline);\n+      List<Pipeline> pipelineList = query2OpenPipelines.get(query);\n+      if (pipelineList == null) {\n+        pipelineList = new CopyOnWriteArrayList<>();\n+        query2OpenPipelines.put(query, pipelineList);\n+      }\n+      pipelineList.add(updatedPipeline);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c163a1140dbe00f51bea3eba3c446d6df6864cb1"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3MTU1MDIxOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineStateMap.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMzowNzoxN1rOGZFvmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwMDo0Mjo0NVrOGZHSCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk2MTY5MA==", "bodyText": "query2OpenPipelines has been initialized in initializeQueryMap() based on the RepType/ReFactor and has never been removed from the map. Correct me if I'm wrong, the pipelineList should never be null unless different RepType/Factor are specified in the query, which is currently impossible.", "url": "https://github.com/apache/ozone/pull/938#discussion_r428961690", "createdAt": "2020-05-21T23:07:17Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineStateMap.java", "diffHunk": "@@ -372,13 +372,20 @@ Pipeline updatePipelineState(PipelineID pipelineID, PipelineState state)\n     Pipeline updatedPipeline = pipelineMap.compute(pipelineID,\n         (id, p) -> Pipeline.newBuilder(pipeline).setState(state).build());\n     PipelineQuery query = new PipelineQuery(pipeline);\n+    List<Pipeline> pipelineList = query2OpenPipelines.get(query);\n     if (updatedPipeline.getPipelineState() == PipelineState.OPEN) {\n       // for transition to OPEN state add pipeline to query2OpenPipelines\n-      query2OpenPipelines.get(query).add(updatedPipeline);\n+      if (pipelineList == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6aeffde486bb354e5afe167bff8e63eae9fa113f"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk4Njg4OQ==", "bodyText": "@xiaoyuyao Yeah, you are right while we do something initialized in initializeQueryMap(), but i am working on query unknown replication query dynamically, so initializeQueryMap() just put the known replication factor into the query2OpenPipelines. Further more, i have an idea to remove initializeQueryMap, instead, using a lazy way to add and remove items from/to the query2OpenPipelines, it is only an idea, but for this PR, it makes NPE gone away.", "url": "https://github.com/apache/ozone/pull/938#discussion_r428986889", "createdAt": "2020-05-22T00:42:45Z", "author": {"login": "maobaolong"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineStateMap.java", "diffHunk": "@@ -372,13 +372,20 @@ Pipeline updatePipelineState(PipelineID pipelineID, PipelineState state)\n     Pipeline updatedPipeline = pipelineMap.compute(pipelineID,\n         (id, p) -> Pipeline.newBuilder(pipeline).setState(state).build());\n     PipelineQuery query = new PipelineQuery(pipeline);\n+    List<Pipeline> pipelineList = query2OpenPipelines.get(query);\n     if (updatedPipeline.getPipelineState() == PipelineState.OPEN) {\n       // for transition to OPEN state add pipeline to query2OpenPipelines\n-      query2OpenPipelines.get(query).add(updatedPipeline);\n+      if (pipelineList == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk2MTY5MA=="}, "originalCommit": {"oid": "6aeffde486bb354e5afe167bff8e63eae9fa113f"}, "originalPosition": 8}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4316, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}