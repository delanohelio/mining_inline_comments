{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2MTkxNDg3", "number": 1615, "title": "HDDS-4451.Handle start & stop of Trash Emptier thread when node becom\u2026", "bodyText": "\u2026es leader/follower\nWhat changes were proposed in this pull request?\nAdd handling for when to start/stop thread when OM switches from follower to leader or vice-versa.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4451\nHow was this patch tested?\nManually.", "createdAt": "2020-11-24T05:45:55Z", "url": "https://github.com/apache/ozone/pull/1615", "merged": true, "mergeCommit": {"oid": "6677200a7be75370c0ddcdd93197dda3227c6cdb"}, "closed": true, "closedAt": "2020-12-11T13:29:51Z", "author": {"login": "sadanand48"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfrnPaAFqTUzNzYzNzU3Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdlEWG2AFqTU0OTkyMjg1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NjM3NTcy", "url": "https://github.com/apache/ozone/pull/1615#pullrequestreview-537637572", "createdAt": "2020-11-24T15:36:55Z", "commit": {"oid": "0dea3ba4689da4be804ae727c16081091b7f1960"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNTozNjo1NVrOH5HHcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNTozNzoyN1rOH5HKjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY0NzQ3Mg==", "bodyText": "I think this should happen after the thread.sleep at line 117. As for most of the cases, when an OM restart the trash emptier it should check this status and skip doing any Trash processing.", "url": "https://github.com/apache/ozone/pull/1615#discussion_r529647472", "createdAt": "2020-11-24T15:36:55Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/TrashPolicyOzone.java", "diffHunk": "@@ -98,7 +105,8 @@ public Runnable getEmptier() throws IOException {\n \n     @Override\n     public void run() {\n-      if (emptierInterval == 0) {\n+      // if this is not the leader node,don't run the emptier\n+      if (emptierInterval == 0 || !om.isLeader()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0dea3ba4689da4be804ae727c16081091b7f1960"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY0ODI3MA==", "bodyText": "Also lets see if we can add a unit test for this change. Please check with @bharatviswa504 on the test", "url": "https://github.com/apache/ozone/pull/1615#discussion_r529648270", "createdAt": "2020-11-24T15:37:27Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/TrashPolicyOzone.java", "diffHunk": "@@ -98,7 +105,8 @@ public Runnable getEmptier() throws IOException {\n \n     @Override\n     public void run() {\n-      if (emptierInterval == 0) {\n+      // if this is not the leader node,don't run the emptier\n+      if (emptierInterval == 0 || !om.isLeader()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY0NzQ3Mg=="}, "originalCommit": {"oid": "0dea3ba4689da4be804ae727c16081091b7f1960"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5ODAxOTcw", "url": "https://github.com/apache/ozone/pull/1615#pullrequestreview-549801970", "createdAt": "2020-12-11T04:57:52Z", "commit": {"oid": "a99449edf2820609680bbaad0c4dcd155fa960a5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwNDo1Nzo1MlrOIDpK3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwNDo1Nzo1MlrOIDpK3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY5MTE2Nw==", "bodyText": "This should be continue here ?", "url": "https://github.com/apache/ozone/pull/1615#discussion_r540691167", "createdAt": "2020-12-11T04:57:52Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/TrashPolicyOzone.java", "diffHunk": "@@ -107,6 +136,9 @@ public void run() {\n         end = ceiling(now, emptierInterval);\n         try {                                     // sleep for interval\n           Thread.sleep(end - now);\n+          if (!om.isLeader()){\n+            return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a99449edf2820609680bbaad0c4dcd155fa960a5"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6387da4418c552f68dfadc5f915100033fca1e78", "author": {"user": {"login": "sadanand48", "name": "Sadanand Shenoy"}}, "url": "https://github.com/apache/ozone/commit/6387da4418c552f68dfadc5f915100033fca1e78", "committedDate": "2020-12-11T06:15:09Z", "message": "HDDS-4451.Handle start & stop of Trash Emptier thread when node becomes leader/follower"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7baaa7f29bbeb995be69ea03155f7013d771d2d", "author": {"user": {"login": "sadanand48", "name": "Sadanand Shenoy"}}, "url": "https://github.com/apache/ozone/commit/c7baaa7f29bbeb995be69ea03155f7013d771d2d", "committedDate": "2020-12-11T06:15:09Z", "message": "addressed some comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c85a4a1c32a3dad761e8847b5bb2ecd4372fea2", "author": {"user": {"login": "sadanand48", "name": "Sadanand Shenoy"}}, "url": "https://github.com/apache/ozone/commit/3c85a4a1c32a3dad761e8847b5bb2ecd4372fea2", "committedDate": "2020-12-11T06:15:09Z", "message": "addressed comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b04abb496ba7c2d22c841148679c97d466f397bc", "author": {"user": {"login": "sadanand48", "name": "Sadanand Shenoy"}}, "url": "https://github.com/apache/ozone/commit/b04abb496ba7c2d22c841148679c97d466f397bc", "committedDate": "2020-12-11T06:15:09Z", "message": "trigger new CI check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "694aa7ff093c55d33ccfe42d567b15ff1485424c", "author": {"user": {"login": "sadanand48", "name": "Sadanand Shenoy"}}, "url": "https://github.com/apache/ozone/commit/694aa7ff093c55d33ccfe42d567b15ff1485424c", "committedDate": "2020-12-11T06:15:09Z", "message": "trigger new CI check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e74d15722a3b8a747485606e19568c36b2b39b6", "author": {"user": {"login": "sadanand48", "name": "Sadanand Shenoy"}}, "url": "https://github.com/apache/ozone/commit/7e74d15722a3b8a747485606e19568c36b2b39b6", "committedDate": "2020-12-11T06:38:51Z", "message": "resolved conflict"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "11af5f113e4c1b95f778746b52859616acecd076", "author": {"user": {"login": "sadanand48", "name": "Sadanand Shenoy"}}, "url": "https://github.com/apache/ozone/commit/11af5f113e4c1b95f778746b52859616acecd076", "committedDate": "2020-12-11T05:58:39Z", "message": "trigger new CI check"}, "afterCommit": {"oid": "7e74d15722a3b8a747485606e19568c36b2b39b6", "author": {"user": {"login": "sadanand48", "name": "Sadanand Shenoy"}}, "url": "https://github.com/apache/ozone/commit/7e74d15722a3b8a747485606e19568c36b2b39b6", "committedDate": "2020-12-11T06:38:51Z", "message": "resolved conflict"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5OTIwMjAz", "url": "https://github.com/apache/ozone/pull/1615#pullrequestreview-549920203", "createdAt": "2020-12-11T09:12:35Z", "commit": {"oid": "7e74d15722a3b8a747485606e19568c36b2b39b6"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwOToxMjozNVrOIDvshg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwOToxMjozNVrOIDvshg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc5ODA4Ng==", "bodyText": "Lets remove this TODO's", "url": "https://github.com/apache/ozone/pull/1615#discussion_r540798086", "createdAt": "2020-12-11T09:12:35Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -1402,10 +1394,7 @@ public void stop() {\n       }\n       // TODO:Also stop this thread if an OM switches from leader to follower.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e74d15722a3b8a747485606e19568c36b2b39b6"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68d35f3da2d28e360bcc8e781b520ae954be9320", "author": {"user": {"login": "sadanand48", "name": "Sadanand Shenoy"}}, "url": "https://github.com/apache/ozone/commit/68d35f3da2d28e360bcc8e781b520ae954be9320", "committedDate": "2020-12-11T09:14:34Z", "message": "Update OzoneManager.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5OTIyODU1", "url": "https://github.com/apache/ozone/pull/1615#pullrequestreview-549922855", "createdAt": "2020-12-11T09:16:12Z", "commit": {"oid": "68d35f3da2d28e360bcc8e781b520ae954be9320"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1957, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}