{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1NzQxMzE4", "number": 1682, "title": "HDDS-4574. Inconsistencies in case the parent of a open file is deleted/renamed.", "bodyText": "What changes were proposed in this pull request?\nCheck whether parent exist before commit key to counter inconsistencies due to it. Scenario mentioned in the jira.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4574\nHow was this patch tested?\nAdded UT.", "createdAt": "2020-12-10T08:01:58Z", "url": "https://github.com/apache/ozone/pull/1682", "merged": true, "mergeCommit": {"oid": "1ceb96ac039243c8218aa14f4a4de3835d07d01f"}, "closed": true, "closedAt": "2020-12-18T07:00:09Z", "author": {"login": "ayushtkn"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkwualgFqTU0OTA0ODcxOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnSl7YAFqTU1NTIxMDg4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5MDQ4NzE4", "url": "https://github.com/apache/ozone/pull/1682#pullrequestreview-549048718", "createdAt": "2020-12-10T10:19:29Z", "commit": {"oid": "d493ebdde5186d26d61a524fba8eb01ab7a39803"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxMDoxOTozMFrOIDB25g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxMDoxOTozMFrOIDB25g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA0NzA3OA==", "bodyText": "Can you move this check inside ozoneManager.getEnableFileSystemPaths() == true case to do this only for FileSystem api.\nFor example, bucket#createKey & OzoneOutputStream#close() in turn make OMKeyCommitRequest call.", "url": "https://github.com/apache/ozone/pull/1682#discussion_r540047078", "createdAt": "2020-12-10T10:19:30Z", "author": {"login": "rakeshadr"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCommitRequest.java", "diffHunk": "@@ -172,6 +173,16 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n         throw new OMException(\"Failed to commit key, as \" + dbOpenKey +\n             \"entry is not found in the OpenKey table\", KEY_NOT_FOUND);\n       }\n+\n+      // Ensure the parent exist.\n+      if (!\"\".equals(OzoneFSUtils.getParent(keyName))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d493ebdde5186d26d61a524fba8eb01ab7a39803"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d493ebdde5186d26d61a524fba8eb01ab7a39803", "author": {"user": {"login": "ayushtkn", "name": "Ayush Saxena"}}, "url": "https://github.com/apache/ozone/commit/d493ebdde5186d26d61a524fba8eb01ab7a39803", "committedDate": "2020-12-10T09:34:10Z", "message": "Fix test."}, "afterCommit": {"oid": "9a75f427e9888ec049e73b897adef40a7ae1296e", "author": {"user": {"login": "ayushtkn", "name": "Ayush Saxena"}}, "url": "https://github.com/apache/ozone/commit/9a75f427e9888ec049e73b897adef40a7ae1296e", "committedDate": "2020-12-10T12:48:04Z", "message": "HDDS-4574. Inconsistencies in case the parent of a open file is deleted/renamed."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fbea3a5d09494b20ad6d8fee9434f915a5e8beeb", "author": {"user": {"login": "ayushtkn", "name": "Ayush Saxena"}}, "url": "https://github.com/apache/ozone/commit/fbea3a5d09494b20ad6d8fee9434f915a5e8beeb", "committedDate": "2020-12-11T06:59:31Z", "message": "Fix Checkstyle."}, "afterCommit": {"oid": "79906c33078b818bb51e9a5c9867544238f06459", "author": {"user": {"login": "ayushtkn", "name": "Ayush Saxena"}}, "url": "https://github.com/apache/ozone/commit/79906c33078b818bb51e9a5c9867544238f06459", "committedDate": "2020-12-15T10:45:41Z", "message": "Fix Checkstyle."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNzI3NjQx", "url": "https://github.com/apache/ozone/pull/1682#pullrequestreview-552727641", "createdAt": "2020-12-15T18:03:14Z", "commit": {"oid": "79906c33078b818bb51e9a5c9867544238f06459"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxODowMzoxNFrOIGYtig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxODowNzoxN1rOIGY4Xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2NzI0Mg==", "bodyText": "Just a question: Right now delete/rename is not an atomic operation, so will just checking the parent Dir is enough?\nBut this will help, once we have HDDS-2939 where we have atomic delete/renames.", "url": "https://github.com/apache/ozone/pull/1682#discussion_r543567242", "createdAt": "2020-12-15T18:03:14Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMAllocateBlockRequest.java", "diffHunk": "@@ -192,6 +193,17 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n             KEY_NOT_FOUND);\n       }\n \n+      if (ozoneManager.getEnableFileSystemPaths()) {\n+        // Ensure the parent exist.\n+        if (!\"\".equals(OzoneFSUtils.getParent(keyName))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79906c33078b818bb51e9a5c9867544238f06459"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU3MDAxNA==", "bodyText": "And also for performance reasons, can we leave allocateBlock, as during KeyCommit anyway we shall figure it out?\nAs this will save one extra DB op, (this might not be a problem again once HDDS-2939 comes in, as it has directory cache)\nBut I am fine with if we want to catch early also? Just thought of bringing this here.", "url": "https://github.com/apache/ozone/pull/1682#discussion_r543570014", "createdAt": "2020-12-15T18:07:17Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMAllocateBlockRequest.java", "diffHunk": "@@ -192,6 +193,17 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n             KEY_NOT_FOUND);\n       }\n \n+      if (ozoneManager.getEnableFileSystemPaths()) {\n+        // Ensure the parent exist.\n+        if (!\"\".equals(OzoneFSUtils.getParent(keyName))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU2NzI0Mg=="}, "originalCommit": {"oid": "79906c33078b818bb51e9a5c9867544238f06459"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5085e74172d77a9311af98d323540ac99cffb58", "author": {"user": {"login": "ayushtkn", "name": "Ayush Saxena"}}, "url": "https://github.com/apache/ozone/commit/d5085e74172d77a9311af98d323540ac99cffb58", "committedDate": "2020-12-16T09:31:26Z", "message": "HDDS-4574. Inconsistencies in case the parent of a open file is deleted/renamed."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "79906c33078b818bb51e9a5c9867544238f06459", "author": {"user": {"login": "ayushtkn", "name": "Ayush Saxena"}}, "url": "https://github.com/apache/ozone/commit/79906c33078b818bb51e9a5c9867544238f06459", "committedDate": "2020-12-15T10:45:41Z", "message": "Fix Checkstyle."}, "afterCommit": {"oid": "d5085e74172d77a9311af98d323540ac99cffb58", "author": {"user": {"login": "ayushtkn", "name": "Ayush Saxena"}}, "url": "https://github.com/apache/ozone/commit/d5085e74172d77a9311af98d323540ac99cffb58", "committedDate": "2020-12-16T09:31:26Z", "message": "HDDS-4574. Inconsistencies in case the parent of a open file is deleted/renamed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b88f3d358b0c0e731d504a09cefb3e643f840be", "author": {"user": {"login": "ayushtkn", "name": "Ayush Saxena"}}, "url": "https://github.com/apache/ozone/commit/0b88f3d358b0c0e731d504a09cefb3e643f840be", "committedDate": "2020-12-16T10:59:19Z", "message": "Fix test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d25584c7a82dc14199de791cdc696090eea1645", "author": {"user": {"login": "ayushtkn", "name": "Ayush Saxena"}}, "url": "https://github.com/apache/ozone/commit/4d25584c7a82dc14199de791cdc696090eea1645", "committedDate": "2020-12-16T11:27:04Z", "message": "Fix checkstyle."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MjEwODg4", "url": "https://github.com/apache/ozone/pull/1682#pullrequestreview-555210888", "createdAt": "2020-12-18T07:00:00Z", "commit": {"oid": "4d25584c7a82dc14199de791cdc696090eea1645"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2080, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}