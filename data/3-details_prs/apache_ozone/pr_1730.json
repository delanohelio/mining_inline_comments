{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0NzU5NDY1", "number": 1730, "title": "HDDS-4619. Intermittent error exporting same container to multiple datanodes", "bodyText": "What changes were proposed in this pull request?\nContainer export performs compaction while holding only read lock.  We need to acquire write lock to prevent concurrent export changing the files while others are packing the same files into tar archive.\nThis should fix intermittent exception which causes some of the TestDecommissionAndMaintenance failures:\njava.lang.IllegalArgumentException: refCount: [1]\n\tat com.google.common.base.Preconditions.checkArgument(Preconditions.java:203)\n\tat org.apache.hadoop.ozone.container.common.utils.ContainerCache.removeDB(ContainerCache.java:203)\n\tat org.apache.hadoop.ozone.container.keyvalue.helpers.BlockUtils.removeDB(BlockUtils.java:138)\n\tat org.apache.hadoop.ozone.container.keyvalue.KeyValueContainer.exportContainerData(KeyValueContainer.java:533)\n\tat org.apache.hadoop.ozone.container.keyvalue.KeyValueHandler.exportContainer(KeyValueHandler.java:939)\n\tat org.apache.hadoop.ozone.container.ozoneimpl.ContainerController.exportContainer(ContainerController.java:145)\n\tat org.apache.hadoop.ozone.container.replication.OnDemandContainerReplicationSource.copyData(OnDemandContainerReplicationSource.java:59)\n\tat org.apache.hadoop.ozone.container.replication.GrpcReplicationService.download(GrpcReplicationService.java:56)\n...\n[grpc-default-executor-9] ERROR replication.GrpcReplicationClient (GrpcReplicationClient.java:onError(161)) - Download of container 4 was unsuccessful\n\nhttps://issues.apache.org/jira/browse/HDDS-4619\nHow was this patch tested?\n\nadded unit test: https://github.com/adoroszlai/hadoop-ozone/runs/1599885042\nran TestDecommissionAndMaintenance 10x: https://github.com/adoroszlai/hadoop-ozone/runs/1599907254", "createdAt": "2020-12-23T12:47:55Z", "url": "https://github.com/apache/ozone/pull/1730", "merged": true, "mergeCommit": {"oid": "6844ea4e4c2c100f6c5eb085863ccc7ad3c17740"}, "closed": true, "closedAt": "2021-01-07T17:39:38Z", "author": {"login": "adoroszlai"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdor8EUAH2gAyNTQ0NzU5NDY1OmZjOGVmMWFhM2YyM2FkNDA5MDEyMTg1MzQzMGNkMWNkYTBiODU3NzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtnO2sgH2gAyNTQ0NzU5NDY1OmUyNWI0ODFkZDZhMzA1N2FkZmUxZGQwZmU4ZGVmOGQ1MmE0YTdmZWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fc8ef1aa3f23ad4090121853430cd1cda0b85776", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/fc8ef1aa3f23ad4090121853430cd1cda0b85776", "committedDate": "2020-12-22T15:05:44Z", "message": "HDDS-4619. Intermittent error exporting same container to multiple datanodes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa7ddab10e77d9160fb335500df4f979c962156c", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/aa7ddab10e77d9160fb335500df4f979c962156c", "committedDate": "2020-12-23T08:52:13Z", "message": "HDDS-4619. Add unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7f9606ba84a01dfee191515b15758716587b224", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/d7f9606ba84a01dfee191515b15758716587b224", "committedDate": "2020-12-23T09:32:28Z", "message": "HDDS-4619. Downgrade lock after compaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7a9e7a3e85d515cf45960ec041838b07916e2b9", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/d7a9e7a3e85d515cf45960ec041838b07916e2b9", "committedDate": "2020-12-23T10:35:52Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ae7e06f27a0efefb9252eb99d7da912f7793946", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/1ae7e06f27a0efefb9252eb99d7da912f7793946", "committedDate": "2021-01-04T12:47:02Z", "message": "Downgrade lock in case of exception, too"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzMDMyOTE3", "url": "https://github.com/apache/ozone/pull/1730#pullrequestreview-563032917", "createdAt": "2021-01-06T20:58:38Z", "commit": {"oid": "1ae7e06f27a0efefb9252eb99d7da912f7793946"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQyMDo1ODozOFrOIPV4mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQyMDo1ODozOFrOIPV4mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk1ODEwNg==", "bodyText": "The exception here should be a rare occurrence, so we are almost always going to have to escalate the read lock into a write lock. I think it would be simpler to just take the write lock at the start and forget about the read lock.\nThe part of the code under the read lock should be very fast, and the code under the write lock may be slow (compactDB) so I suspect we are saving very little by doing some work under the read lock. I think this lock is also only for this container (not for all containers on the DN) so contention should not be a big issue.\nWhat do you think?", "url": "https://github.com/apache/ozone/pull/1730#discussion_r552958106", "createdAt": "2021-01-06T20:58:38Z", "author": {"login": "sodonnel"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/keyvalue/KeyValueContainer.java", "diffHunk": "@@ -516,22 +516,36 @@ public void importContainerData(InputStream input,\n   @Override\n   public void exportContainerData(OutputStream destination,\n       ContainerPacker<KeyValueContainerData> packer) throws IOException {\n-    // Closed/ Quasi closed containers are considered for replication by\n-    // replication manager if they are under-replicated.\n-    ContainerProtos.ContainerDataProto.State state =\n-        getContainerData().getState();\n-    if (!(state == ContainerProtos.ContainerDataProto.State.CLOSED ||\n-        state == ContainerDataProto.State.QUASI_CLOSED)) {\n-      throw new IllegalStateException(\n-          \"Only closed/quasi closed containers could be exported: \" +\n-              \"Where as ContainerId=\"\n-              + getContainerData().getContainerID() + \" is in state \" + state);\n+    readLock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ae7e06f27a0efefb9252eb99d7da912f7793946"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e25b481dd6a3057adfe1dd0fe8def8d52a4a7fef", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/e25b481dd6a3057adfe1dd0fe8def8d52a4a7fef", "committedDate": "2021-01-06T22:26:21Z", "message": "Skip first read lock, take write lock right away"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1892, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}