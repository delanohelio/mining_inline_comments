{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0NTU2NDc5", "number": 982, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNzowOTozMVrOEAmXPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODo0NzowNFrOEC3uzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MDYzOTk4OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNzowOTozMVrOGb-xCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMDo0NzoxM1rOGdZjQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5MzA5OA==", "bodyText": "One question, can these extra column families can be dropped, if they are not required after upgrade/downgrade.\nBecause now we removed S3Table in #940. So, once after upgrade, technically we don't require the column family any more.", "url": "https://github.com/apache/ozone/pull/982#discussion_r431993098", "createdAt": "2020-05-28T17:09:31Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -94,6 +97,14 @@ public RDBStore(File dbFile, DBOptions options,\n     this.writeOptions = writeOptions;\n \n     try {\n+      List<TableConfig> columnFamiliesInDb = getColumnFamiliesInExistingDb();\n+      List<TableConfig> extraCf = columnFamiliesInDb.stream().filter(\n+          cf -> !families.contains(cf)).collect(Collectors.toList());\n+      for (TableConfig family : extraCf) {\n+        LOG.info(\"Adding column family {}\", family.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf0d67b7151ae674e2e473d6372e31dbb16d13be"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ4MDUxMg==", "bodyText": "@bharatviswa504 That is a good point. Based on our offline discussion, this will be handled on a case-by-case basis as outlined in the Ozone upgrades design doc (HDDS-3698).", "url": "https://github.com/apache/ozone/pull/982#discussion_r433480512", "createdAt": "2020-06-01T20:47:13Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -94,6 +97,14 @@ public RDBStore(File dbFile, DBOptions options,\n     this.writeOptions = writeOptions;\n \n     try {\n+      List<TableConfig> columnFamiliesInDb = getColumnFamiliesInExistingDb();\n+      List<TableConfig> extraCf = columnFamiliesInDb.stream().filter(\n+          cf -> !families.contains(cf)).collect(Collectors.toList());\n+      for (TableConfig family : extraCf) {\n+        LOG.info(\"Adding column family {}\", family.getName());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5MzA5OA=="}, "originalCommit": {"oid": "cf0d67b7151ae674e2e473d6372e31dbb16d13be"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MDY0Mzk4OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNzoxMDo0MFrOGb-zoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMDozMzoyMlrOGdZIPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5Mzc2MQ==", "bodyText": "Can this comment be more clear saying ColumnFamily in DB, but not in the current version something like that?", "url": "https://github.com/apache/ozone/pull/982#discussion_r431993761", "createdAt": "2020-05-28T17:10:40Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -94,6 +97,14 @@ public RDBStore(File dbFile, DBOptions options,\n     this.writeOptions = writeOptions;\n \n     try {\n+      List<TableConfig> columnFamiliesInDb = getColumnFamiliesInExistingDb();\n+      List<TableConfig> extraCf = columnFamiliesInDb.stream().filter(\n+          cf -> !families.contains(cf)).collect(Collectors.toList());\n+      for (TableConfig family : extraCf) {\n+        LOG.info(\"Adding column family {}\", family.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf0d67b7151ae674e2e473d6372e31dbb16d13be"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ3MzU5Ng==", "bodyText": "Will do.", "url": "https://github.com/apache/ozone/pull/982#discussion_r433473596", "createdAt": "2020-06-01T20:33:22Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -94,6 +97,14 @@ public RDBStore(File dbFile, DBOptions options,\n     this.writeOptions = writeOptions;\n \n     try {\n+      List<TableConfig> columnFamiliesInDb = getColumnFamiliesInExistingDb();\n+      List<TableConfig> extraCf = columnFamiliesInDb.stream().filter(\n+          cf -> !families.contains(cf)).collect(Collectors.toList());\n+      for (TableConfig family : extraCf) {\n+        LOG.info(\"Adding column family {}\", family.getName());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5Mzc2MQ=="}, "originalCommit": {"oid": "cf0d67b7151ae674e2e473d6372e31dbb16d13be"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MDY0OTkwOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/framework/src/test/java/org/apache/hadoop/hdds/utils/db/TestRDBStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNzoxMjoyMVrOGb-3Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMDo0NTo0NVrOGdZggQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5NDcxNQ==", "bodyText": "Question: If column family is missing also, but DBStore will open that column family right currently? So, do we need to check the columnFamily is opened or not also?", "url": "https://github.com/apache/ozone/pull/982#discussion_r431994715", "createdAt": "2020-05-28T17:12:21Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-hdds/framework/src/test/java/org/apache/hadoop/hdds/utils/db/TestRDBStore.java", "diffHunk": "@@ -348,5 +348,40 @@ public void testGetDBUpdatesSince() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testDowngrade() throws Exception {\n+\n+    // Write data to current DB which has 6 column families at the time of\n+    // writing this test.\n+    for (String family : families) {\n+      try (Table table = rdbStore.getTable(family)) {\n+        byte[] key = family.getBytes(StandardCharsets.UTF_8);\n+        byte[] value =\n+            RandomStringUtils.random(10).getBytes(StandardCharsets.UTF_8);\n+        table.put(key, value);\n+      }\n+    }\n+    // Close current DB.\n+    rdbStore.close();\n+\n+    // Reopen DB with the last column family removed.\n+    options = new DBOptions();\n+    options.setCreateIfMissing(true);\n+    options.setCreateMissingColumnFamilies(true);\n+    configSet = new HashSet<>();\n+    List<String> familiesMinusOne = families.subList(0, families.size() - 1);\n+    for(String name : familiesMinusOne) {\n+      TableConfig newConfig = new TableConfig(name, new ColumnFamilyOptions());\n+      configSet.add(newConfig);\n+    }\n+    rdbStore = new RDBStore(rdbStore.getDbLocation(), options, configSet);\n+    for (String family : familiesMinusOne) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf0d67b7151ae674e2e473d6372e31dbb16d13be"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ3OTgwOQ==", "bodyText": "Added check for the extra column family.", "url": "https://github.com/apache/ozone/pull/982#discussion_r433479809", "createdAt": "2020-06-01T20:45:45Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/framework/src/test/java/org/apache/hadoop/hdds/utils/db/TestRDBStore.java", "diffHunk": "@@ -348,5 +348,40 @@ public void testGetDBUpdatesSince() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testDowngrade() throws Exception {\n+\n+    // Write data to current DB which has 6 column families at the time of\n+    // writing this test.\n+    for (String family : families) {\n+      try (Table table = rdbStore.getTable(family)) {\n+        byte[] key = family.getBytes(StandardCharsets.UTF_8);\n+        byte[] value =\n+            RandomStringUtils.random(10).getBytes(StandardCharsets.UTF_8);\n+        table.put(key, value);\n+      }\n+    }\n+    // Close current DB.\n+    rdbStore.close();\n+\n+    // Reopen DB with the last column family removed.\n+    options = new DBOptions();\n+    options.setCreateIfMissing(true);\n+    options.setCreateMissingColumnFamilies(true);\n+    configSet = new HashSet<>();\n+    List<String> familiesMinusOne = families.subList(0, families.size() - 1);\n+    for(String name : familiesMinusOne) {\n+      TableConfig newConfig = new TableConfig(name, new ColumnFamilyOptions());\n+      configSet.add(newConfig);\n+    }\n+    rdbStore = new RDBStore(rdbStore.getDbLocation(), options, configSet);\n+    for (String family : familiesMinusOne) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk5NDcxNQ=="}, "originalCommit": {"oid": "cf0d67b7151ae674e2e473d6372e31dbb16d13be"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDQyMjM1OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODozNjo1MVrOGflfbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODozNjo1MVrOGflfbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3MzI5NQ==", "bodyText": "Nit: extraCf cannot be null, so I would prefer not adding a dependency:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  if (CollectionUtils.isNotEmpty(extraCf)) {\n          \n          \n            \n                  if (!extraCf.isEmpty()) {", "url": "https://github.com/apache/ozone/pull/982#discussion_r435773295", "createdAt": "2020-06-05T08:36:51Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -94,6 +98,15 @@ public RDBStore(File dbFile, DBOptions options,\n     this.writeOptions = writeOptions;\n \n     try {\n+      List<TableConfig> columnFamiliesInDb = getColumnFamiliesInExistingDb();\n+      List<TableConfig> extraCf = columnFamiliesInDb.stream().filter(\n+          cf -> !families.contains(cf)).collect(Collectors.toList());\n+      if (CollectionUtils.isNotEmpty(extraCf)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bcc5063c13efe6ceff243d80e9f736b01c8505"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDQyNTYwOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODozNzo0MVrOGflhXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODozNzo0MVrOGflhXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3Mzc5MA==", "bodyText": "Nit: I think List.toString is just as good:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            \"{}\", Arrays.toString(extraCf.toArray()));\n          \n          \n            \n                            \"{}\", extraCf);", "url": "https://github.com/apache/ozone/pull/982#discussion_r435773790", "createdAt": "2020-06-05T08:37:41Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -94,6 +98,15 @@ public RDBStore(File dbFile, DBOptions options,\n     this.writeOptions = writeOptions;\n \n     try {\n+      List<TableConfig> columnFamiliesInDb = getColumnFamiliesInExistingDb();\n+      List<TableConfig> extraCf = columnFamiliesInDb.stream().filter(\n+          cf -> !families.contains(cf)).collect(Collectors.toList());\n+      if (CollectionUtils.isNotEmpty(extraCf)) {\n+        LOG.info(\"Found the following extra column families in existing DB : \" +\n+                \"{}\", Arrays.toString(extraCf.toArray()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bcc5063c13efe6ceff243d80e9f736b01c8505"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDQyNjU3OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODozODowMFrOGfliFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODozODowMFrOGfliFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3Mzk3Mg==", "bodyText": "Nit: same here regarding arrays:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      Arrays.toString(columnFamiliesInDb.toArray()));\n          \n          \n            \n                      columnFamiliesInDb);", "url": "https://github.com/apache/ozone/pull/982#discussion_r435773972", "createdAt": "2020-06-05T08:38:00Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -149,6 +162,26 @@ public RDBStore(File dbFile, DBOptions options,\n     }\n   }\n \n+  /**\n+   * Read DB and return existing column families.\n+   * @return List of column families\n+   * @throws RocksDBException on Error.\n+   */\n+  private List<TableConfig> getColumnFamiliesInExistingDb()\n+      throws RocksDBException {\n+    List<byte[]> bytes = RocksDB.listColumnFamilies(new Options(),\n+        dbLocation.getAbsolutePath());\n+    List<TableConfig> columnFamiliesInDb = bytes.stream()\n+        .map(cfbytes -> new TableConfig(StringUtils.bytes2String(cfbytes),\n+            DBProfile.DISK.getColumnFamilyOptions()))\n+        .collect(Collectors.toList());\n+    if (LOG.isDebugEnabled()) {\n+      LOG.debug(\"Found column Families in DB : {}\",\n+          Arrays.toString(columnFamiliesInDb.toArray()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bcc5063c13efe6ceff243d80e9f736b01c8505"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDQyODE1OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODozODozMFrOGfljGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODozODozMFrOGfljGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3NDIzNA==", "bodyText": "Corresponding to suggestion about list to string:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import java.util.Arrays;", "url": "https://github.com/apache/ozone/pull/982#discussion_r435774234", "createdAt": "2020-06-05T08:38:30Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -24,11 +24,14 @@\n import java.io.IOException;\n import java.nio.file.Paths;\n import java.util.ArrayList;\n+import java.util.Arrays;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bcc5063c13efe6ceff243d80e9f736b01c8505"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDQzMDcxOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODozOToxNVrOGflkuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODozOToxNVrOGflkuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3NDY0OQ==", "bodyText": "Corresponding to suggestion about empty list:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import org.apache.commons.collections.CollectionUtils;", "url": "https://github.com/apache/ozone/pull/982#discussion_r435774649", "createdAt": "2020-06-05T08:39:15Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -24,11 +24,14 @@\n import java.io.IOException;\n import java.nio.file.Paths;\n import java.util.ArrayList;\n+import java.util.Arrays;\n import java.util.HashMap;\n import java.util.List;\n import java.util.Map;\n import java.util.Set;\n+import java.util.stream.Collectors;\n \n+import org.apache.commons.collections.CollectionUtils;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bcc5063c13efe6ceff243d80e9f736b01c8505"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDQ1NzEwOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODo0NzowNFrOGfl1eA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODo0NzowNFrOGfl1eA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3ODkzNg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        DBProfile.DISK.getColumnFamilyOptions()))\n          \n          \n            \n                        DBStoreBuilder.HDDS_DEFAULT_DB_PROFILE.getColumnFamilyOptions()))", "url": "https://github.com/apache/ozone/pull/982#discussion_r435778936", "createdAt": "2020-06-05T08:47:04Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBStore.java", "diffHunk": "@@ -149,6 +162,26 @@ public RDBStore(File dbFile, DBOptions options,\n     }\n   }\n \n+  /**\n+   * Read DB and return existing column families.\n+   * @return List of column families\n+   * @throws RocksDBException on Error.\n+   */\n+  private List<TableConfig> getColumnFamiliesInExistingDb()\n+      throws RocksDBException {\n+    List<byte[]> bytes = RocksDB.listColumnFamilies(new Options(),\n+        dbLocation.getAbsolutePath());\n+    List<TableConfig> columnFamiliesInDb = bytes.stream()\n+        .map(cfbytes -> new TableConfig(StringUtils.bytes2String(cfbytes),\n+            DBProfile.DISK.getColumnFamilyOptions()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97bcc5063c13efe6ceff243d80e9f736b01c8505"}, "originalPosition": 54}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4185, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}