{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwNjQ4MjAw", "number": 695, "title": "HDDS-3137. OM RpcClient fail with java.lang.IllegalArgumentException.", "bodyText": "What changes were proposed in this pull request?\nFix Rpcclient creation failing with java.lang.IllegalArgumentException\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3137\nHow was this patch tested?\nPreviously in docker-compose om-ha-s3, when one of the OM is killed using docker stop <> used to fail with IllegalArgumentException.\nNow with the fix, tried on the docker-compose ha cluster.\n$ docker ps\nCONTAINER ID        IMAGE                            COMMAND                  CREATED             STATUS              PORTS                                            NAMES\n4181d2fb54bb        apache/ozone-runner:20191107-1   \"/usr/local/bin/dumb\u2026\"   31 minutes ago      Up 31 minutes       0.0.0.0:9878->9878/tcp                           ozone-om-ha-s3_s3g_1\n81e613bda640        apache/ozone-runner:20191107-1   \"/usr/local/bin/dumb\u2026\"   31 minutes ago      Up 31 minutes       0.0.0.0:9890->9872/tcp, 0.0.0.0:9880->9874/tcp   ozone-om-ha-s3_om1_1\ncdd968cba61f        apache/ozone-runner:20191107-1   \"/usr/local/bin/dumb\u2026\"   31 minutes ago      Up 31 minutes       0.0.0.0:32769->9864/tcp                          ozone-om-ha-s3_datanode_1\n89f0e6a0f4c8        apache/ozone-runner:20191107-1   \"/usr/local/bin/dumb\u2026\"   31 minutes ago      Up 31 minutes       0.0.0.0:9894->9872/tcp, 0.0.0.0:9884->9874/tcp   ozone-om-ha-s3_om3_1\nc34627654655        apache/ozone-runner:20191107-1   \"/usr/local/bin/dumb\u2026\"   31 minutes ago      Up 31 minutes       0.0.0.0:9876->9876/tcp                           ozone-om-ha-s3_scm_1\nd97ff58182c1        apache/ozone-runner:20191107-1   \"/usr/local/bin/dumb\u2026\"   31 minutes ago      Up 2 seconds        0.0.0.0:9892->9872/tcp, 0.0.0.0:9882->9874/tcp   ozone-om-ha-s3_om2_1\n\n\n$ docker stop 81e613bda640\n81e613bda640\n\nbash-4.2$ ozone admin om getserviceroles -id=id1\nproxyom1 : FOLLOWER\nom2 : FOLLOWER\nom3 : LEADER", "createdAt": "2020-03-18T20:28:36Z", "url": "https://github.com/apache/ozone/pull/695", "merged": true, "mergeCommit": {"oid": "0201fc63e8c5942f14c09d4f16b9769055458138"}, "closed": true, "closedAt": "2020-03-20T03:28:39Z", "author": {"login": "bharatviswa504"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcO9IRcAH2gAyMzkwNjQ4MjAwOjc5M2M2MWU3OGQ5YTZkNWMyMjQwYjNlOTFmZjE4OTc3YmYwN2MyMzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPX8DAgFqTM3ODIxNjk4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "793c61e78d9a6d5c2240b3e91ff18977bf07c237", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/793c61e78d9a6d5c2240b3e91ff18977bf07c237", "committedDate": "2020-03-18T20:14:16Z", "message": "HDDS-3137. OM RpcClient fail with java.lang.IllegalArgumentException."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MjE5MDY1", "url": "https://github.com/apache/ozone/pull/695#pullrequestreview-377219065", "createdAt": "2020-03-18T20:41:19Z", "commit": {"oid": "793c61e78d9a6d5c2240b3e91ff18977bf07c237"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQyMDo0MToxOVrOF4WGVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQyMDo0MzowMFrOF4WJzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYyNjY0NQ==", "bodyText": "should we attempt this iif rpcAddr.isUnresolved()is false?", "url": "https://github.com/apache/ozone/pull/695#discussion_r394626645", "createdAt": "2020-03-18T20:41:19Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/ha/OMProxyInfo.java", "diffHunk": "@@ -21,23 +21,48 @@\n import org.apache.hadoop.io.Text;\n import org.apache.hadoop.net.NetUtils;\n import org.apache.hadoop.security.SecurityUtil;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n \n import java.net.InetSocketAddress;\n \n /**\n  * Class to store OM proxy information.\n  */\n public class OMProxyInfo {\n+  private String serviceId;\n   private String nodeId;\n   private String rpcAddrStr;\n   private InetSocketAddress rpcAddr;\n   private Text dtService;\n \n-  OMProxyInfo(String nodeID, String rpcAddress) {\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(OMProxyInfo.class);\n+\n+  OMProxyInfo(String serviceID, String nodeID, String rpcAddress) {\n+    this.serviceId = serviceID;\n     this.nodeId = nodeID;\n     this.rpcAddrStr = rpcAddress;\n     this.rpcAddr = NetUtils.createSocketAddr(rpcAddrStr);\n-    this.dtService = SecurityUtil.buildTokenService(rpcAddr);\n+    if (rpcAddr.isUnresolved()) {\n+      LOG.warn(\"OzoneManager address {} for serviceID {} remains unresolved \" +\n+          \"for node ID {} Check your ozone-site.xml file to ensure ozone \" +\n+          \"manager addresses are configured properly.\",\n+          rpcAddress, serviceId, nodeId);\n+    }\n+\n+    // This issue will be a problem with docker/kubernetes world where one of\n+    // the container is killed, and that OM address will be unresolved. For now\n+    // skip the unresolved OM address setting it to the token service field.\n+\n+    // TODo: Retry rpcAddr when unresolved during getProxy which will be used\n+    //  until next fail over. Fix setting of dtService also at that time.\n+    try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "793c61e78d9a6d5c2240b3e91ff18977bf07c237"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYyNzUzNQ==", "bodyText": "As we discussed offline, can you add a TODO to fix the computed DTService when the dtService is temporarily avialable due to OM instance reboot, DNS issue?", "url": "https://github.com/apache/ozone/pull/695#discussion_r394627535", "createdAt": "2020-03-18T20:43:00Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/ha/OMFailoverProxyProvider.java", "diffHunk": "@@ -191,20 +192,19 @@ public Text getCurrentProxyDelegationToken() {\n   private Text computeDelegationTokenService() {\n     // For HA, this will return \",\" separated address of all OM's.\n     StringBuilder rpcAddress = new StringBuilder();\n-    int count = 0;\n+\n     for (Map.Entry<String, OMProxyInfo> omProxyInfoSet :\n         omProxyInfos.entrySet()) {\n-      count++;\n-      rpcAddress =\n-          rpcAddress.append(\n-              omProxyInfoSet.getValue().getDelegationTokenService());\n+      Text dtService = omProxyInfoSet.getValue().getDelegationTokenService();\n \n-      if (omProxyInfos.size() != count) {\n-        rpcAddress.append(\",\");\n+      // dtService can be null when during client object creation when one of\n+      // the OM configured address in unreachable.\n+      if (dtService != null) {\n+        rpcAddress.append(\",\").append(rpcAddress);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "793c61e78d9a6d5c2240b3e91ff18977bf07c237"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0a8ba0fe3f02e5863057c26a6d2953e2c32b7be", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/d0a8ba0fe3f02e5863057c26a6d2953e2c32b7be", "committedDate": "2020-03-18T22:43:17Z", "message": "fix review comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb6b6aa5febd98a5f352906f4d317cb7a1c3c1e6", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/bb6b6aa5febd98a5f352906f4d317cb7a1c3c1e6", "committedDate": "2020-03-19T22:32:08Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8e314a9d33e39da9a89b1f5e0981dcef631a5c9", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/e8e314a9d33e39da9a89b1f5e0981dcef631a5c9", "committedDate": "2020-03-19T22:32:18Z", "message": "fix checkstyle and wording"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MjE2OTgz", "url": "https://github.com/apache/ozone/pull/695#pullrequestreview-378216983", "createdAt": "2020-03-20T03:28:21Z", "commit": {"oid": "e8e314a9d33e39da9a89b1f5e0981dcef631a5c9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3499, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}