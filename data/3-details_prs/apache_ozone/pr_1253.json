{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2MTA4Nzc2", "number": 1253, "title": "HDDS-4024. Avoid while loop too soon when exception happen", "bodyText": "What changes were proposed in this pull request?\nWhen exception throw in context.execute(executorService, heartbeatFrequency, TimeUnit.MILLISECONDS), thread will not sleep and start another while loop immediately, it will cause cpu very high and huge log size.\n\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4024\nHow was this patch tested?\nNo need add test.", "createdAt": "2020-07-24T06:46:49Z", "url": "https://github.com/apache/ozone/pull/1253", "merged": true, "mergeCommit": {"oid": "a96553e139642c1fa6d0344dc0b61d8324aa1d73"}, "closed": true, "closedAt": "2020-07-29T16:42:50Z", "author": {"login": "runzhiwang"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc394X3AH2gAyNDU2MTA4Nzc2OjRkYjUwZTM4Yjg5OTQxOGU0M2QzNDQ0MDk1ZmYxMGFmNjM2YzAzMzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5t0SGAFqTQ1NzcwMjA2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4db50e38b899418e43d3444095ff10af636c0331", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/4db50e38b899418e43d3444095ff10af636c0331", "committedDate": "2020-07-24T06:17:42Z", "message": "HDDS-4024. Avoid while loop too soon when exception happen"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NjkxNDI3", "url": "https://github.com/apache/ozone/pull/1253#pullrequestreview-454691427", "createdAt": "2020-07-24T07:45:48Z", "commit": {"oid": "4db50e38b899418e43d3444095ff10af636c0331"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNzo0NTo0OFrOG2mEqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNzo0NTo0OFrOG2mEqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTkwMDA3Mg==", "bodyText": "Now that sleep is moved outside this try, I think interrupted state needs to be restored here.  Otherwise if execute is interrupted, this catch clears interrupted state and the thread will sleep below.", "url": "https://github.com/apache/ozone/pull/1253#discussion_r459900072", "createdAt": "2020-07-24T07:45:48Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/DatanodeStateMachine.java", "diffHunk": "@@ -224,19 +224,25 @@ private void start() throws IOException {\n         nextHB.set(Time.monotonicNow() + heartbeatFrequency);\n         context.execute(executorService, heartbeatFrequency,\n             TimeUnit.MILLISECONDS);\n-        now = Time.monotonicNow();\n-        if (now < nextHB.get()) {\n-          if(!Thread.interrupted()) {\n-            Thread.sleep(nextHB.get() - now);\n-          }\n-        }\n       } catch (InterruptedException e) {\n         // Some one has sent interrupt signal, this could be because\n         // 1. Trigger heartbeat immediately\n         // 2. Shutdown has be initiated.\n+        LOG.warn(\"Interrupt the execution.\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db50e38b899418e43d3444095ff10af636c0331"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c89bc9d8f8eb9447be55d8fbbe32fb86fd445487", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/c89bc9d8f8eb9447be55d8fbbe32fb86fd445487", "committedDate": "2020-07-24T08:35:04Z", "message": "fix code review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2b9e81d08bd72a232ba34826962b0ab3a10b10f", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/b2b9e81d08bd72a232ba34826962b0ab3a10b10f", "committedDate": "2020-07-24T10:32:24Z", "message": "triger ci"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NjY1OTE3", "url": "https://github.com/apache/ozone/pull/1253#pullrequestreview-457665917", "createdAt": "2020-07-29T15:58:58Z", "commit": {"oid": "b2b9e81d08bd72a232ba34826962b0ab3a10b10f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NzAyMDY4", "url": "https://github.com/apache/ozone/pull/1253#pullrequestreview-457702068", "createdAt": "2020-07-29T16:42:36Z", "commit": {"oid": "b2b9e81d08bd72a232ba34826962b0ab3a10b10f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2921, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}