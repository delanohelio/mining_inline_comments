{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyNTEzODc5", "number": 624, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwNzoxMzoyN1rODkiU7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwNzoxNjowOVrODkiXFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5NjM3NzQzOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/scm/ReconIncrementalContainerReportHandler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwNzoxMzoyN1rOFw6b5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwNzoxMzoyN1rOFw6b5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjgzMzM4Mw==", "bodyText": "Looks like this block could be shared between the two container report handlers.", "url": "https://github.com/apache/ozone/pull/624#discussion_r386833383", "createdAt": "2020-03-03T07:13:27Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/scm/ReconIncrementalContainerReportHandler.java", "diffHunk": "@@ -70,19 +70,22 @@ public void onMessage(final IncrementalContainerReportFromDatanode report,\n         final DatanodeDetails dd = report.getDatanodeDetails();\n         final ContainerID id = ContainerID.valueof(\n             replicaProto.getContainerID());\n-        if (!getContainerManager().exists(id)) {\n-          LOG.info(\"New container {} got from {}.\", id,\n-              report.getDatanodeDetails());\n-          try {\n-            ContainerWithPipeline containerWithPipeline =\n-                scmClient.getContainerWithPipeline(id.getId());\n-            LOG.info(\"Verified new container from SCM {} \",\n-                containerWithPipeline.getContainerInfo().containerID());\n-            containerManager.addNewContainer(id.getId(), containerWithPipeline);\n-          } catch (IOException ioEx) {\n-            LOG.error(\"Exception while getting new container info from SCM\",\n-                ioEx);\n-            return;\n+        synchronized (containerManager) {\n+          if (!containerManager.exists(id)) {\n+            LOG.info(\"New container {} got from {}.\", id,\n+                report.getDatanodeDetails());\n+            try {\n+              ContainerWithPipeline containerWithPipeline =\n+                  scmClient.getContainerWithPipeline(id.getId());\n+              LOG.info(\"Verified new container from SCM {} \",\n+                  containerWithPipeline.getContainerInfo().containerID());\n+              containerManager\n+                  .addNewContainer(id.getId(), containerWithPipeline);\n+            } catch (IOException ioEx) {\n+              LOG.error(\"Exception while getting new container info from SCM\",\n+                  ioEx);\n+              return;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd0744bef2fad20453fb0feff633563e30cadb97"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5NjM4Mjk1OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/scm/ReconContainerReportHandler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwNzoxNjowOVrOFw6fIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwNzoxNjowOVrOFw6fIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjgzNDIxMQ==", "bodyText": "Might this be improved in a followup to avoid RPC while holding the lock?", "url": "https://github.com/apache/ozone/pull/624#discussion_r386834211", "createdAt": "2020-03-03T07:16:09Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/scm/ReconContainerReportHandler.java", "diffHunk": "@@ -63,19 +63,21 @@ public void onMessage(final ContainerReportFromDatanode reportFromDatanode,\n     for (ContainerReplicaProto containerReplicaProto : reportsList) {\n       final ContainerID id = ContainerID.valueof(\n           containerReplicaProto.getContainerID());\n-      if (!getContainerManager().exists(id)) {\n-        LOG.info(\"New container {} got from {}.\", id,\n-            reportFromDatanode.getDatanodeDetails());\n-        try {\n-          ContainerWithPipeline containerWithPipeline =\n-              scmClient.getContainerWithPipeline(id.getId());\n-          LOG.debug(\"Verified new container from SCM {} \",\n-              containerWithPipeline.getContainerInfo().containerID());\n-          containerManager.addNewContainer(id.getId(), containerWithPipeline);\n-        } catch (IOException ioEx) {\n-          LOG.error(\"Exception while getting new container info from SCM\",\n-              ioEx);\n-          return;\n+      synchronized (containerManager) {\n+        if (!containerManager.exists(id)) {\n+          LOG.info(\"New container {} got from {}.\", id,\n+              reportFromDatanode.getDatanodeDetails());\n+          try {\n+            ContainerWithPipeline containerWithPipeline =\n+                scmClient.getContainerWithPipeline(id.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd0744bef2fad20453fb0feff633563e30cadb97"}, "originalPosition": 23}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4939, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}