{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyMjQ0NDQ5", "number": 704, "title": "HDDS-3248. shutdown defaultMetricsSystem before tests", "bodyText": "What changes were proposed in this pull request?\nclean up DefaultMetricSystem after TestHandler and TestHddsDispatcher\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3248", "createdAt": "2020-03-23T08:54:20Z", "url": "https://github.com/apache/ozone/pull/704", "merged": true, "mergeCommit": {"oid": "97f59f8db5c997a20c594e745d9c17108bd31ed0"}, "closed": true, "closedAt": "2020-03-31T16:20:08Z", "author": {"login": "esahekmat"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQaYNrgH2gAyMzkyMjQ0NDQ5OmNlNTkzZGIxNWRjOWQxZDVmYjhjYWNkM2NlMzU3YTBmYzMwOWNlNGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTFkMTAFqTM4NDg5Njk2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ce593db15dc9d1d5fb8cacd3ce357a0fc309ce4e", "author": {"user": null}, "url": "https://github.com/apache/ozone/commit/ce593db15dc9d1d5fb8cacd3ce357a0fc309ce4e", "committedDate": "2020-03-23T08:52:51Z", "message": "HDDS-3248: shutdown defaultMetricsSystem before tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecde6a4106986b8d06cc991510baaca8ad5bed55", "author": {"user": null}, "url": "https://github.com/apache/ozone/commit/ecde6a4106986b8d06cc991510baaca8ad5bed55", "committedDate": "2020-03-23T09:02:50Z", "message": "import DefaultMetricsSystem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "686d0dd25a427743c6385dae2449123af4c21eb4", "author": {"user": null}, "url": "https://github.com/apache/ozone/commit/686d0dd25a427743c6385dae2449123af4c21eb4", "committedDate": "2020-03-24T10:29:08Z", "message": "clean up DefaultMetricSystem after TestHddsDispatcher and TestHandler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c58011521bcbf63f25519cbd40b665d4f532e95e", "author": {"user": null}, "url": "https://github.com/apache/ozone/commit/c58011521bcbf63f25519cbd40b665d4f532e95e", "committedDate": "2020-03-24T11:10:50Z", "message": "correct checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNDA5ODYz", "url": "https://github.com/apache/ozone/pull/704#pullrequestreview-380409863", "createdAt": "2020-03-24T15:14:04Z", "commit": {"oid": "c58011521bcbf63f25519cbd40b665d4f532e95e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNToxNDowNFrOF61Eqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNToxNDowNFrOF61Eqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIzMTI3NQ==", "bodyText": "Should we call shutdownDispatcher() here as well instead of just ContainerMetrics.remove()?", "url": "https://github.com/apache/ozone/pull/704#discussion_r397231275", "createdAt": "2020-03-24T15:14:04Z", "author": {"login": "fapifta"}, "path": "hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/impl/TestHddsDispatcher.java", "diffHunk": "@@ -132,6 +132,7 @@ public void testContainerCloseActionWhenFull() throws IOException {\n \n     } finally {\n       volumeSet.shutdown();\n+      ContainerMetrics.remove();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c58011521bcbf63f25519cbd40b665d4f532e95e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNDA5OTI3", "url": "https://github.com/apache/ozone/pull/704#pullrequestreview-380409927", "createdAt": "2020-03-24T15:14:07Z", "commit": {"oid": "c58011521bcbf63f25519cbd40b665d4f532e95e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNToxNDowN1rOF61E2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNToxNDowN1rOF61E2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIzMTMyMA==", "bodyText": "I am not convinced whether this step to remove the ContainerMetrics belongs to a method called shutdownDispatcher, at least from the name it is not clear it will do so besides shutting down the dispatcher. Shouldn't we separate this two?", "url": "https://github.com/apache/ozone/pull/704#discussion_r397231320", "createdAt": "2020-03-24T15:14:07Z", "author": {"login": "fapifta"}, "path": "hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/impl/TestHddsDispatcher.java", "diffHunk": "@@ -276,6 +283,13 @@ private HddsDispatcher createDispatcher(DatanodeDetails dd, UUID scmId,\n     return hddsDispatcher;\n   }\n \n+  private void shutdownDispatcher(HddsDispatcher dispatcher){\n+    if(dispatcher != null) {\n+      dispatcher.shutdown();\n+    }\n+    ContainerMetrics.remove();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c58011521bcbf63f25519cbd40b665d4f532e95e"}, "originalPosition": 85}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNDA5OTcy", "url": "https://github.com/apache/ozone/pull/704#pullrequestreview-380409972", "createdAt": "2020-03-24T15:14:09Z", "commit": {"oid": "c58011521bcbf63f25519cbd40b665d4f532e95e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNToxNDoxMFrOF61FAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNToxNDoxMFrOF61FAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIzMTM2MA==", "bodyText": "Do we still need this one after the added cleanup in TestHddsDispatcher?", "url": "https://github.com/apache/ozone/pull/704#discussion_r397231360", "createdAt": "2020-03-24T15:14:10Z", "author": {"login": "fapifta"}, "path": "hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/interfaces/TestHandler.java", "diffHunk": "@@ -58,6 +60,7 @@\n \n   @Before\n   public void setup() throws Exception {\n+    DefaultMetricsSystem.instance().shutdown();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c58011521bcbf63f25519cbd40b665d4f532e95e"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNDEwMDAz", "url": "https://github.com/apache/ozone/pull/704#pullrequestreview-380410003", "createdAt": "2020-03-24T15:14:11Z", "commit": {"oid": "c58011521bcbf63f25519cbd40b665d4f532e95e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNToxNDoxMVrOF61FFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNToxNDoxMVrOF61FFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIzMTM4Mw==", "bodyText": "Do we still need this one after the added cleanup in TestHddsDispatcher?", "url": "https://github.com/apache/ozone/pull/704#discussion_r397231383", "createdAt": "2020-03-24T15:14:11Z", "author": {"login": "fapifta"}, "path": "hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/volume/TestHddsVolumeChecker.java", "diffHunk": "@@ -91,6 +92,7 @@\n \n   @Before\n   public void setup() throws IOException {\n+    DefaultMetricsSystem.instance().shutdown();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c58011521bcbf63f25519cbd40b665d4f532e95e"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c2c6844d40dbba2a4489708d0481934bde558df", "author": {"user": null}, "url": "https://github.com/apache/ozone/commit/4c2c6844d40dbba2a4489708d0481934bde558df", "committedDate": "2020-03-24T15:29:18Z", "message": "remove shutting down the DefaultMetricsSystem before tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c54ce9ca6e9a689377eca4dda8635b1a0886843f", "author": {"user": null}, "url": "https://github.com/apache/ozone/commit/c54ce9ca6e9a689377eca4dda8635b1a0886843f", "committedDate": "2020-03-24T15:37:47Z", "message": "unify the call to ContainerMetrics.remove() in order to clean up"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0ODk2OTY4", "url": "https://github.com/apache/ozone/pull/704#pullrequestreview-384896968", "createdAt": "2020-03-31T16:19:42Z", "commit": {"oid": "c54ce9ca6e9a689377eca4dda8635b1a0886843f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3508, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}