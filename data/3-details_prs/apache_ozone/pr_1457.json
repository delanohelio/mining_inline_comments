{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1MjczMDY0", "number": 1457, "title": "HDDS-4253. Add LayoutVersion request/response for DN registration.", "bodyText": "What changes were proposed in this pull request?\nAdd LayoutVersion request/response for DN registration.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4253\nHow was this patch tested?\ntested with existing and updated UTs.", "createdAt": "2020-09-30T06:02:42Z", "url": "https://github.com/apache/ozone/pull/1457", "merged": true, "mergeCommit": {"oid": "b07927e81011d9df0389cb112f05169116b398d6"}, "closed": true, "closedAt": "2020-10-06T19:37:53Z", "author": {"login": "prashantpogde"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdN2W2cgH2gAyNDk1MjczMDY0OjZhMjU1Y2ZjYTZmYzVhMzhjZWM4NGFmZjFmYjY3ZWUyN2MwNzEzYTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdP9rY3AFqTUwMzI5NzEwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6a255cfca6fc5a38cec84aff1fb67ee27c0713a1", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/6a255cfca6fc5a38cec84aff1fb67ee27c0713a1", "committedDate": "2020-09-30T05:58:05Z", "message": "HDDS-4253. Add LayoutVersion request/response for DN registration."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NTA4MDk0", "url": "https://github.com/apache/ozone/pull/1457#pullrequestreview-499508094", "createdAt": "2020-09-30T14:42:47Z", "commit": {"oid": "6a255cfca6fc5a38cec84aff1fb67ee27c0713a1"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNDo0Mjo0N1rOHahETQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNDo0ODo0MFrOHahWPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2Njc5Nw==", "bodyText": "Can you update javadoc here as we add new param layoutVersionInfo?", "url": "https://github.com/apache/ozone/pull/1457#discussion_r497566797", "createdAt": "2020-09-30T14:42:47Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/StorageContainerNodeProtocol.java", "diffHunk": "@@ -58,7 +60,8 @@\n    */\n   RegisteredCommand register(DatanodeDetails datanodeDetails,\n                              NodeReportProto nodeReport,\n-                             PipelineReportsProto pipelineReport);\n+                             PipelineReportsProto pipelineReport,\n+                             LayoutVersionProto layoutVersionInfo);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a255cfca6fc5a38cec84aff1fb67ee27c0713a1"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU3MTM4OQ==", "bodyText": "For another case, if register dn layout version lower than scm version, do we need to print some log here that can be helpful for us know some old version DN be registered?", "url": "https://github.com/apache/ozone/pull/1457#discussion_r497571389", "createdAt": "2020-09-30T14:48:40Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java", "diffHunk": "@@ -240,8 +247,19 @@ public VersionResponse getVersion(SCMVersionRequestProto versionRequest) {\n   @Override\n   public RegisteredCommand register(\n       DatanodeDetails datanodeDetails, NodeReportProto nodeReport,\n-      PipelineReportsProto pipelineReportsProto) {\n-\n+      PipelineReportsProto pipelineReportsProto,\n+      LayoutVersionProto layoutInfo) {\n+\n+    if (layoutInfo != null) {\n+      if (layoutInfo.getSoftwareLayoutVersion() >\n+          scmLayoutVersionManager.getSoftwareLayoutVersion()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a255cfca6fc5a38cec84aff1fb67ee27c0713a1"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5ODUyODQ5", "url": "https://github.com/apache/ozone/pull/1457#pullrequestreview-499852849", "createdAt": "2020-09-30T22:21:42Z", "commit": {"oid": "6a255cfca6fc5a38cec84aff1fb67ee27c0713a1"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMjoyOTozNlrOHaxiXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQyMjo0NDoyMlrOHax2dQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzgzNjYzNg==", "bodyText": "Can we move this check to org.apache.hadoop.hdds.scm.server.SCMDatanodeProtocolServer#register? That way, a lot of test changes in this patch to incorporate the 4th parameter to NodeManager.register() can be avoided.", "url": "https://github.com/apache/ozone/pull/1457#discussion_r497836636", "createdAt": "2020-09-30T22:29:36Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java", "diffHunk": "@@ -240,8 +247,19 @@ public VersionResponse getVersion(SCMVersionRequestProto versionRequest) {\n   @Override\n   public RegisteredCommand register(\n       DatanodeDetails datanodeDetails, NodeReportProto nodeReport,\n-      PipelineReportsProto pipelineReportsProto) {\n-\n+      PipelineReportsProto pipelineReportsProto,\n+      LayoutVersionProto layoutInfo) {\n+\n+    if (layoutInfo != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a255cfca6fc5a38cec84aff1fb67ee27c0713a1"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg0MDk1MA==", "bodyText": "Nit. I don't see any usages for this yet.", "url": "https://github.com/apache/ozone/pull/1457#discussion_r497840950", "createdAt": "2020-09-30T22:41:49Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/StorageContainerManager.java", "diffHunk": "@@ -1149,4 +1155,8 @@ public String getScmId() {\n   public String getClusterId() {\n     return getScmStorageConfig().getClusterID();\n   }\n+\n+  public HDDSLayoutVersionManager getLayoutVersionManager() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a255cfca6fc5a38cec84aff1fb67ee27c0713a1"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzg0MTc4MQ==", "bodyText": "Can we refactor this test to use last layout feature's version and last layout feature's version + 1 for success and failure cases? That way, the test does not need change every time a Layout feature is added.", "url": "https://github.com/apache/ozone/pull/1457#discussion_r497841781", "createdAt": "2020-09-30T22:44:22Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/node/TestSCMNodeManager.java", "diffHunk": "@@ -170,6 +176,33 @@ public void testScmHeartbeat()\n     }\n   }\n \n+  /**\n+   * Tests that Node manager handles Layout versions correctly.\n+   *\n+   * @throws IOException\n+   * @throws InterruptedException\n+   * @throws TimeoutException\n+   */\n+  @Test\n+  public void testScmLayoutOnRegister()\n+      throws IOException, InterruptedException, AuthenticationException {\n+\n+    try (SCMNodeManager nodeManager = createNodeManager(getConf())) {\n+      LayoutVersionProto layoutInfoSuccess = LayoutVersionProto.newBuilder()\n+          .setMetadataLayoutVersion(1).setSoftwareLayoutVersion(1).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a255cfca6fc5a38cec84aff1fb67ee27c0713a1"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7453413e806993cba4506c0a3a438730417db045", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/7453413e806993cba4506c0a3a438730417db045", "committedDate": "2020-10-02T03:16:57Z", "message": "HDDS-4253. Addressed review comments and CI failure."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e23b74d150a6f534ba8b5f0bced90c3b6174f14", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/4e23b74d150a6f534ba8b5f0bced90c3b6174f14", "committedDate": "2020-10-06T04:25:22Z", "message": "HDDS-4253.Addressing CI failure."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjk3MTAx", "url": "https://github.com/apache/ozone/pull/1457#pullrequestreview-503297101", "createdAt": "2020-10-06T19:37:42Z", "commit": {"oid": "4e23b74d150a6f534ba8b5f0bced90c3b6174f14"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2583, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}