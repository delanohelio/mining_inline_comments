{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM4OTQxNzc1", "number": 1697, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwNDo1MzowM1rOFEzSBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwNDo1MzowM1rOFEzSBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQwNTc4ODIzOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/container/TestHelper.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwNDo1MzowM1rOIE_z3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxMToxMToxMlrOIFLgEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjExMDY4Nw==", "bodyText": "Thanx @adoroszlai for the fix, I am able to repro this, changes seems fair enough.\nDoes it makes sense to removeGroup explicitly in case server.isExist(pipelineId) is true, rather than waiting? Might speed up test? We can ignore the exception from removeGroup in the wait and retry to counter the race condition", "url": "https://github.com/apache/ozone/pull/1697#discussion_r542110687", "createdAt": "2020-12-14T04:53:03Z", "author": {"login": "ayushtkn"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/container/TestHelper.java", "diffHunk": "@@ -234,12 +235,14 @@ public static void waitForPipelineClose(List<Pipeline> pipelineList,\n \n     // wait for the pipeline to get destroyed in the datanodes\n     for (Pipeline pipeline : pipelineList) {\n+      HddsProtos.PipelineID pipelineId = pipeline.getId().getProtobuf();\n       for (DatanodeDetails dn : pipeline.getNodes()) {\n         XceiverServerSpi server =\n             cluster.getHddsDatanodes().get(cluster.getHddsDatanodeIndex(dn))\n                 .getDatanodeStateMachine().getContainer().getWriteChannel();\n         Assert.assertTrue(server instanceof XceiverServerRatis);\n-        server.removeGroup(pipeline.getId().getProtobuf());\n+        GenericTestUtils.waitFor(() -> !server.isExist(pipelineId),\n+            100, 30_000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "513077793c935ae1c80019db864fcfe33d2b7a40"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjI2Nzg1Mg==", "bodyText": "Thanks @ayushtkn for taking a look.\nI'd rather avoid such \"manual intervention\" and let the test exercise production code paths.\nI don't think keeping removeGroup would result in much speedup.  If SCM and datanodes take too much time to execute regular flow, we could probably tweak executor intervals, etc.\nIt might be possible to convert it to a unit test with mocks, resulting in much bigger speedup by avoiding the mini cluster.", "url": "https://github.com/apache/ozone/pull/1697#discussion_r542267852", "createdAt": "2020-12-14T10:18:13Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/container/TestHelper.java", "diffHunk": "@@ -234,12 +235,14 @@ public static void waitForPipelineClose(List<Pipeline> pipelineList,\n \n     // wait for the pipeline to get destroyed in the datanodes\n     for (Pipeline pipeline : pipelineList) {\n+      HddsProtos.PipelineID pipelineId = pipeline.getId().getProtobuf();\n       for (DatanodeDetails dn : pipeline.getNodes()) {\n         XceiverServerSpi server =\n             cluster.getHddsDatanodes().get(cluster.getHddsDatanodeIndex(dn))\n                 .getDatanodeStateMachine().getContainer().getWriteChannel();\n         Assert.assertTrue(server instanceof XceiverServerRatis);\n-        server.removeGroup(pipeline.getId().getProtobuf());\n+        GenericTestUtils.waitFor(() -> !server.isExist(pipelineId),\n+            100, 30_000);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjExMDY4Nw=="}, "originalCommit": {"oid": "513077793c935ae1c80019db864fcfe33d2b7a40"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwMjIyNw==", "bodyText": "makes better to stay near the prod code. Thanx", "url": "https://github.com/apache/ozone/pull/1697#discussion_r542302227", "createdAt": "2020-12-14T11:11:12Z", "author": {"login": "ayushtkn"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/container/TestHelper.java", "diffHunk": "@@ -234,12 +235,14 @@ public static void waitForPipelineClose(List<Pipeline> pipelineList,\n \n     // wait for the pipeline to get destroyed in the datanodes\n     for (Pipeline pipeline : pipelineList) {\n+      HddsProtos.PipelineID pipelineId = pipeline.getId().getProtobuf();\n       for (DatanodeDetails dn : pipeline.getNodes()) {\n         XceiverServerSpi server =\n             cluster.getHddsDatanodes().get(cluster.getHddsDatanodeIndex(dn))\n                 .getDatanodeStateMachine().getContainer().getWriteChannel();\n         Assert.assertTrue(server instanceof XceiverServerRatis);\n-        server.removeGroup(pipeline.getId().getProtobuf());\n+        GenericTestUtils.waitFor(() -> !server.isExist(pipelineId),\n+            100, 30_000);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjExMDY4Nw=="}, "originalCommit": {"oid": "513077793c935ae1c80019db864fcfe33d2b7a40"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4620, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}