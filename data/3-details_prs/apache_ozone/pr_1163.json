{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0Mjc5OTgz", "number": 1163, "title": "HDDS-3920. Too many redudant replications due to fail to get node's a\u2026", "bodyText": "https://issues.apache.org/jira/browse/HDDS-3920\nWith the patch, over-replicated replicas are deleted by ReplicationManager. The total containers on each datanode drops from 80K~ to 8K~", "createdAt": "2020-07-04T12:37:08Z", "url": "https://github.com/apache/ozone/pull/1163", "merged": true, "mergeCommit": {"oid": "9106f1421667c407dd5a533e1f1f37369424f0a3"}, "closed": true, "closedAt": "2020-07-13T06:51:53Z", "author": {"login": "ChenSammi"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxoobeAH2gAyNDQ0Mjc5OTgzOmVmNmUxYTVlNGFkZDJjNDk0MmZhODVjMjljODZhYmFjMWJkOGIyNDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczeTUCAH2gAyNDQ0Mjc5OTgzOmUyMjhjNmE0NmY3ODE2ODY4YjAyZWU1NTliM2VkM2I4OWE2NDIwZDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ef6e1a5e4add2c4942fa85c29c86abac1bd8b245", "author": {"user": {"login": "ChenSammi", "name": "Sammi Chen"}}, "url": "https://github.com/apache/ozone/commit/ef6e1a5e4add2c4942fa85c29c86abac1bd8b245", "committedDate": "2020-07-04T14:08:44Z", "message": "HDDS-3920. Too many redudant replications due to fail to get node's ancestor in ReplicationManager."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "21e77f3f4784a174263dcca86cab9eb6eca5c9b7", "author": {"user": {"login": "ChenSammi", "name": "Sammi Chen"}}, "url": "https://github.com/apache/ozone/commit/21e77f3f4784a174263dcca86cab9eb6eca5c9b7", "committedDate": "2020-07-04T13:59:48Z", "message": "fix failed UT"}, "afterCommit": {"oid": "ef6e1a5e4add2c4942fa85c29c86abac1bd8b245", "author": {"user": {"login": "ChenSammi", "name": "Sammi Chen"}}, "url": "https://github.com/apache/ozone/commit/ef6e1a5e4add2c4942fa85c29c86abac1bd8b245", "committedDate": "2020-07-04T14:08:44Z", "message": "HDDS-3920. Too many redudant replications due to fail to get node's ancestor in ReplicationManager."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf28429e442adb66f4f5b0055ccfbe04c4cc483d", "author": {"user": {"login": "ChenSammi", "name": "Sammi Chen"}}, "url": "https://github.com/apache/ozone/commit/cf28429e442adb66f4f5b0055ccfbe04c4cc483d", "committedDate": "2020-07-06T06:49:22Z", "message": "Fix failed UT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNDU4MTY3", "url": "https://github.com/apache/ozone/pull/1163#pullrequestreview-443458167", "createdAt": "2020-07-06T23:00:27Z", "commit": {"oid": "cf28429e442adb66f4f5b0055ccfbe04c4cc483d"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMzowMDoyN1rOGtpqzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMzoxNjo0OVrOGtp9sQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyMTgwNg==", "bodyText": "Can we use nodeStateManager.getNode(datanodeDetails) to avoid the UUID->String->UUID conversion?", "url": "https://github.com/apache/ozone/pull/1163#discussion_r450521806", "createdAt": "2020-07-06T23:00:27Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java", "diffHunk": "@@ -260,12 +260,21 @@ public RegisteredCommand register(\n       if (networkLocation != null) {\n         datanodeDetails.setNetworkLocation(networkLocation);\n       }\n-      nodeStateManager.addNode(datanodeDetails);\n-      clusterMap.add(datanodeDetails);\n-      addEntryTodnsToUuidMap(dnsName, datanodeDetails.getUuidString());\n-      // Updating Node Report, as registration is successful\n-      processNodeReport(datanodeDetails, nodeReport);\n-      LOG.info(\"Registered Data node : {}\", datanodeDetails);\n+      if (!isNodeRegistered(datanodeDetails)) {\n+        clusterMap.add(datanodeDetails);\n+        nodeStateManager.addNode(datanodeDetails);\n+        // Check that datanode in nodeStateManager has topology parent set\n+        DatanodeDetails dn =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf28429e442adb66f4f5b0055ccfbe04c4cc483d"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyNDUyMw==", "bodyText": "Can we move isNodeRegistered check at the begin of register() to avoid unnecessary dnsname lookup?", "url": "https://github.com/apache/ozone/pull/1163#discussion_r450524523", "createdAt": "2020-07-06T23:09:45Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java", "diffHunk": "@@ -260,12 +260,21 @@ public RegisteredCommand register(\n       if (networkLocation != null) {\n         datanodeDetails.setNetworkLocation(networkLocation);\n       }\n-      nodeStateManager.addNode(datanodeDetails);\n-      clusterMap.add(datanodeDetails);\n-      addEntryTodnsToUuidMap(dnsName, datanodeDetails.getUuidString());\n-      // Updating Node Report, as registration is successful\n-      processNodeReport(datanodeDetails, nodeReport);\n-      LOG.info(\"Registered Data node : {}\", datanodeDetails);\n+      if (!isNodeRegistered(datanodeDetails)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf28429e442adb66f4f5b0055ccfbe04c4cc483d"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyNjY0MQ==", "bodyText": "When SCM does not have information about a datanode, it is usually the datanode is dead. So skip processing those delayed report makes sense to me .", "url": "https://github.com/apache/ozone/pull/1163#discussion_r450526641", "createdAt": "2020-07-06T23:16:49Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerReportHandler.java", "diffHunk": "@@ -102,8 +102,15 @@ public ContainerReportHandler(final NodeManager nodeManager,\n   public void onMessage(final ContainerReportFromDatanode reportFromDatanode,\n                         final EventPublisher publisher) {\n \n-    final DatanodeDetails datanodeDetails =\n+    final DatanodeDetails dnFromReport =\n         reportFromDatanode.getDatanodeDetails();\n+    DatanodeDetails datanodeDetails =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf28429e442adb66f4f5b0055ccfbe04c4cc483d"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c651c873e0dc65c788e7ecb0b6c1c46bb749302", "author": {"user": {"login": "ChenSammi", "name": "Sammi Chen"}}, "url": "https://github.com/apache/ozone/commit/6c651c873e0dc65c788e7ecb0b6c1c46bb749302", "committedDate": "2020-07-09T08:51:35Z", "message": "Address comments and remove unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e228c6a46f7816868b02ee559b3ed3b89a6420d9", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/e228c6a46f7816868b02ee559b3ed3b89a6420d9", "committedDate": "2020-07-10T07:14:28Z", "message": "trigger new CI check"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3070, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}