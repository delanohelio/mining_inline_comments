{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4NTQ2MDE5", "number": 1434, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNzozMTowN1rOEl9PDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMzoyMToxMVrOEnzDsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MjM2MDQ3OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/exceptions/OMException.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNzozMTowN1rOHVtcxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNzozMTowN1rOHVtcxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUyNjc5MA==", "bodyText": "QUOTA_CHECK_ERROR  -> QUOTA_EXCEEDED", "url": "https://github.com/apache/ozone/pull/1434#discussion_r492526790", "createdAt": "2020-09-22T07:31:07Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/exceptions/OMException.java", "diffHunk": "@@ -229,7 +229,9 @@ public String toString() {\n \n     NOT_SUPPORTED_OPERATION,\n \n-    PARTIAL_RENAME\n+    PARTIAL_RENAME,\n+\n+    QUOTA_CHECK_ERROR", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea519b5d35956b90a0e258b3c40a6e7f03e77582"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MjQwMTAzOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/interface-client/src/main/proto/OmClientProtocol.proto", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNzo0MzozM1rOHVt1UQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNzo0MzozM1rOHVt1UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUzMzA3Mw==", "bodyText": "same as above.", "url": "https://github.com/apache/ozone/pull/1434#discussion_r492533073", "createdAt": "2020-09-22T07:43:33Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/interface-client/src/main/proto/OmClientProtocol.proto", "diffHunk": "@@ -314,6 +314,8 @@ enum Status {\n \n     PARTIAL_RENAME = 65;\n \n+    QUOTA_CHECK_ERROR = 66;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea519b5d35956b90a0e258b3c40a6e7f03e77582"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MjY3NDc3OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo1Mzo1NVrOHVwZlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo1Mzo1NVrOHVwZlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3NTEyNg==", "bodyText": "Can we add used bytes check in each test case?", "url": "https://github.com/apache/ozone/pull/1434#discussion_r492575126", "createdAt": "2020-09-22T08:53:55Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java", "diffHunk": "@@ -707,6 +707,62 @@ public void testPutKey() throws IOException {\n     }\n   }\n \n+  @Test\n+  public void testCheckUsedBytesQuota() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea519b5d35956b90a0e258b3c40a6e7f03e77582"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMTY1NDg0OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMzowNjoxN1rOHYkL-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwNzowNzoxNVrOHYlSBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyMDc2Mg==", "bodyText": "Can we add a isQuotaInBytesSet check in OmVolumeArgs and use this function instead?", "url": "https://github.com/apache/ozone/pull/1434#discussion_r495520762", "createdAt": "2020-09-27T03:06:17Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "diffHunk": "@@ -277,6 +277,16 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           .collect(Collectors.toList());\n       omKeyInfo.appendNewBlocks(newLocationList, false);\n \n+      omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n+      omBucketInfo = getBucketInfo(omMetadataManager, volumeName, bucketName);\n+      // check volume quota\n+      long preAllocatedSpace = newLocationList.size()\n+          * ozoneManager.getScmBlockSize()\n+          * omKeyInfo.getFactor().getNumber();\n+      if (omVolumeArgs.getQuotaInBytes() > OzoneConsts.QUOTA_RESET) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d94b314c26473eb20c56b181684041b239a2d29"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUzODY5NQ==", "bodyText": "I'm going to put the if in checkVolumeQuotaInBytes, which might seem a little more compact.", "url": "https://github.com/apache/ozone/pull/1434#discussion_r495538695", "createdAt": "2020-09-27T07:07:15Z", "author": {"login": "captainzmc"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "diffHunk": "@@ -277,6 +277,16 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           .collect(Collectors.toList());\n       omKeyInfo.appendNewBlocks(newLocationList, false);\n \n+      omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n+      omBucketInfo = getBucketInfo(omMetadataManager, volumeName, bucketName);\n+      // check volume quota\n+      long preAllocatedSpace = newLocationList.size()\n+          * ozoneManager.getScmBlockSize()\n+          * omKeyInfo.getFactor().getNumber();\n+      if (omVolumeArgs.getQuotaInBytes() > OzoneConsts.QUOTA_RESET) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyMDc2Mg=="}, "originalCommit": {"oid": "8d94b314c26473eb20c56b181684041b239a2d29"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMTY1NzY0OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMAllocateBlockRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMzoxMDo0NFrOHYkNQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMzoxMDo0NFrOHYkNQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyMTA4OQ==", "bodyText": "If A object has multiple blocks, and quota_exceeded exception is thrown out at the last block, shall we only deduct the block space size at this step?", "url": "https://github.com/apache/ozone/pull/1434#discussion_r495521089", "createdAt": "2020-09-27T03:10:44Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMAllocateBlockRequest.java", "diffHunk": "@@ -227,6 +232,18 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n     } catch (IOException ex) {\n       omMetrics.incNumBlockAllocateCallFails();\n       exception = ex;\n+      if (exception.toString().contains(\n+          OMException.ResultCodes.QUOTA_EXCEEDED.toString())) {\n+        long keyAllocatedSpace = openKeyInfo.getLatestVersionLocations()\n+            .getLocationListCount() * ozoneManager.getScmBlockSize()\n+            * openKeyInfo.getFactor().getNumber();\n+        // Update usedBytes atomically. ErrorOMResponse does not persist the DB,\n+        // so we update the cache first. The next time another key is written,\n+        // volume Args will be persisted to the DB.\n+        // TODO: There is a delay in updating DB in this way, and if necessary\n+        //  we can modify the ErrorOMResponse to avoid it.\n+        omVolumeArgs.getUsedBytes().add(-keyAllocatedSpace);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d94b314c26473eb20c56b181684041b239a2d29"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMTY1OTAzOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMzoxMzoxMlrOHYkN5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMzoxMzoxMlrOHYkN5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyMTI1Mw==", "bodyText": "Can we add a multiple block write case here\uff0cso the first few block will succeed\uff0c while the later block will fail due to quota exceed?", "url": "https://github.com/apache/ozone/pull/1434#discussion_r495521253", "createdAt": "2020-09-27T03:13:12Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java", "diffHunk": "@@ -707,9 +707,71 @@ public void testPutKey() throws IOException {\n     }\n   }\n \n+  @Test\n+  public void testCheckUsedBytesQuota() throws IOException {\n+    String volumeName = UUID.randomUUID().toString();\n+    String bucketName = UUID.randomUUID().toString();\n+    OzoneVolume volume = null;\n+\n+    String value = \"sample value\";\n+    int blockSize = (int) ozoneManager.getConfiguration().getStorageSize(\n+        OZONE_SCM_BLOCK_SIZE, OZONE_SCM_BLOCK_SIZE_DEFAULT, StorageUnit.BYTES);\n+    int valueLength = value.getBytes().length;\n+    int countException = 0;\n+\n+    store.createVolume(volumeName);\n+    volume = store.getVolume(volumeName);\n+    // Set quota In Bytes for a smaller value\n+    store.getVolume(volumeName).setQuota(\n+        OzoneQuota.parseQuota(\"1 Bytes\", 100));\n+    volume.createBucket(bucketName);\n+    OzoneBucket bucket = volume.getBucket(bucketName);\n+\n+    // Test write key.\n+    // The remaining quota does not satisfy a block size, so the write fails.\n+    try {\n+      writeKey(bucket, UUID.randomUUID().toString(), ONE, value, valueLength);\n+    } catch (IOException ex) {\n+      countException++;\n+      GenericTestUtils.assertExceptionContains(\"QUOTA_EXCEEDED\", ex);\n+    }\n+    // Write failed, volume usedBytes should be 0\n+    Assert.assertEquals(0L, store.getVolume(volumeName).getUsedBytes());\n+\n+    // Test write file.\n+    // The remaining quota does not satisfy a block size, so the write fails.\n+    try {\n+      writeFile(bucket, UUID.randomUUID().toString(), ONE, value, 0);\n+    } catch (IOException ex) {\n+      countException++;\n+      GenericTestUtils.assertExceptionContains(\"QUOTA_EXCEEDED\", ex);\n+    }\n+    // Write failed, volume usedBytes should be 0\n+    Assert.assertEquals(0L, store.getVolume(volumeName).getUsedBytes());\n+\n+    // Write large key, test allocateBlock fails.\n+    store.getVolume(volumeName).setQuota(\n+        OzoneQuota.parseQuota(blockSize + \"Bytes\", 100));\n+    try {\n+      OzoneOutputStream out = bucket.createKey(UUID.randomUUID().toString(),\n+          valueLength, STAND_ALONE, ONE, new HashMap<>());\n+      for(int i=0; i <= blockSize/value.length(); i++) {\n+        out.write(value.getBytes());\n+      }\n+      out.close();\n+    } catch (IOException ex) {\n+      countException++;\n+      GenericTestUtils.assertExceptionContains(\"QUOTA_EXCEEDED\", ex);\n+    }\n+    // AllocateBlock failed, volume usedBytes should be 0\n+    Assert.assertEquals(0L, store.getVolume(volumeName).getUsedBytes());\n+\n+    Assert.assertEquals(3, countException);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d94b314c26473eb20c56b181684041b239a2d29"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMTY2MTcwOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMzoxNjo0OVrOHYkPIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMzoxNjo0OVrOHYkPIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyMTU2OQ==", "bodyText": "unnessary empty line.", "url": "https://github.com/apache/ozone/pull/1434#discussion_r495521569", "createdAt": "2020-09-27T03:16:49Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyRequest.java", "diffHunk": "@@ -533,6 +533,26 @@ protected FileEncryptionInfo getFileEncryptionInfo(KeyArgs keyArgs) {\n     return encryptionInfo;\n   }\n \n+  /**\n+   * Check volume quota in bytes.\n+   * @param omVolumeArgs\n+   * @param allocateSize\n+   * @throws IOException\n+   */\n+  protected void checkVolumeQuotaInBytes(OmVolumeArgs omVolumeArgs,\n+      long allocateSize) throws IOException {\n+    long usedBytes = omVolumeArgs.getUsedBytes().sum();\n+    long quotaInBytes = omVolumeArgs.getQuotaInBytes();\n+    if (quotaInBytes - usedBytes < allocateSize) {\n+      throw new OMException(\"The DiskSpace quota of volume:\"\n+          + omVolumeArgs.getVolume() + \"exceeded: quotaInBytes: \"\n+          + quotaInBytes + \" Bytes but diskspace consumed: \" + (usedBytes\n+          + allocateSize) + \" Bytes.\",\n+          OMException.ResultCodes.QUOTA_EXCEEDED);\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d94b314c26473eb20c56b181684041b239a2d29"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMTY2NDUxOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMAllocateBlockRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMzoyMToxMVrOHYkQag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QwMzoyMToxMVrOHYkQag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUyMTg5OA==", "bodyText": "unnessary blank line.", "url": "https://github.com/apache/ozone/pull/1434#discussion_r495521898", "createdAt": "2020-09-27T03:21:11Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMAllocateBlockRequest.java", "diffHunk": "@@ -239,8 +256,7 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n     auditLog(auditLogger, buildAuditMessage(OMAction.ALLOCATE_BLOCK, auditMap,\n         exception, getOmRequest().getUserInfo()));\n \n-\n-\n     return omClientResponse;\n   }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d94b314c26473eb20c56b181684041b239a2d29"}, "originalPosition": 70}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4920, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}