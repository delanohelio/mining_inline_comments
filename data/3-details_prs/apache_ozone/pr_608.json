{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwMzg1MjEw", "number": 608, "title": "HDDS-3084. Extend network topology acceptance test to read data when datanodes are stopped.", "bodyText": "What changes were proposed in this pull request?\nThis adds a new robot test to the network-topology environment, which:\n\nCreates a volume, bucket and key.\nStops 1 rack and ensures the data is still readable\nRestart the rack and stop the other rack and again check the data is readable\n\nThat way we can have some confidence the data is being written to both racks OK.\nOne issue with a test like this on a small cluster, is that there is a high chance the data will end up on 2 racks naturally, even if no network topology is configured. If that was the case, we would expect intermittent test failures.\nHowever, if network topology is working fine, then we would not expect any failures.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3084\nHow was this patch tested?\nRan the new smoke test locally.", "createdAt": "2020-02-26T16:34:42Z", "url": "https://github.com/apache/ozone/pull/608", "merged": true, "mergeCommit": {"oid": "984bd57e1efb716e1a631c4094bcd7b9a34cf0ec"}, "closed": true, "closedAt": "2020-03-11T09:36:22Z", "author": {"login": "sodonnel"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIa5gMgFqTM2NTY0NjA1Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMS7GWgFqTM3MTk3MjcxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NjQ2MDU3", "url": "https://github.com/apache/ozone/pull/608#pullrequestreview-365646057", "createdAt": "2020-02-27T12:37:57Z", "commit": {"oid": "3e4648d9deec2baab778d04fa2148e0dea0765fe"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjozNzo1N1rOFvQoIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjo0MTo1MlrOFvQvRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA5OTgwOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                ${output} =         Execute          ozone sh key get /topvol1/bucket1/key1\n          \n          \n            \n                ${output} =         Execute          ozone sh key get /topvol1/bucket1/key1 /tmp/key1\n          \n      \n    \n    \n  \n\nThe key get command requires local filename as second argument, so currently it produces this output (trimmed) and does not really verify ability to read data:\nMissing required parameter: <fileName>\n\nNote that on the second run (for the other rack) it will refuse to overwrite /tmp/key1, so\n\ndelete local file after key get OR\nrun test case in different container (eg. om) OR\nuse random local filename (example for random string generation)", "url": "https://github.com/apache/ozone/pull/608#discussion_r385099809", "createdAt": "2020-02-27T12:37:57Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/dist/src/main/smoketest/topology/readdata.robot", "diffHunk": "@@ -0,0 +1,28 @@\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+*** Settings ***\n+Documentation       Smoketest ozone cluster startup\n+Library             OperatingSystem\n+Library             BuiltIn\n+Resource            ../commonlib.robot\n+\n+*** Variables ***\n+\n+\n+*** Test Cases ***\n+Read data from previously created key\n+    ${output} =         Execute          ozone sh key get /topvol1/bucket1/key1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e4648d9deec2baab778d04fa2148e0dea0765fe"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwMTUyMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              docker-compose -f \"$COMPOSE_FILE\" stop $@\n          \n          \n            \n              docker-compose -f \"$COMPOSE_FILE\" --no-ansi stop $@\n          \n      \n    \n    \n  \n\nPlease add --no-ansi to avoid funky characters in the output:\n2020-02-26T17:01:00.9125703Z \ufffd[3BStarting datanode_1 ... \n2020-02-26T17:01:00.9127089Z Starting datanode_2 ... \n2020-02-26T17:01:00.9128127Z Starting datanode_3 ... \n2020-02-26T17:01:01.4869851Z \ufffd[1A\ufffd[2K\n2020-02-26T17:01:01.4870604Z Starting datanode_3 ... \ufffd[32mdone\ufffd[0m\n2020-02-26T17:01:01.5357903Z \ufffd[1B\ufffd[3A\ufffd[2K\n2020-02-26T17:01:01.5359166Z Starting datanode_1 ... \ufffd[32mdone\ufffd[0m\n2020-02-26T17:01:01.6387370Z \ufffd[3B\ufffd[2A\ufffd[2K", "url": "https://github.com/apache/ozone/pull/608#discussion_r385101523", "createdAt": "2020-02-27T12:41:38Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/dist/src/main/compose/testlib.sh", "diffHunk": "@@ -124,6 +124,23 @@ execute_command_in_container(){\n   set +e\n }\n \n+## @description Stop a list of named containers\n+## @param       List of container names, eg datanode_1 datanode_2\n+stop_containers() {\n+  set -e\n+  docker-compose -f \"$COMPOSE_FILE\" stop $@", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e4648d9deec2baab778d04fa2148e0dea0765fe"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwMTYzNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              docker-compose -f \"$COMPOSE_FILE\" start $@\n          \n          \n            \n              docker-compose -f \"$COMPOSE_FILE\" --no-ansi start $@", "url": "https://github.com/apache/ozone/pull/608#discussion_r385101636", "createdAt": "2020-02-27T12:41:52Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/dist/src/main/compose/testlib.sh", "diffHunk": "@@ -124,6 +124,23 @@ execute_command_in_container(){\n   set +e\n }\n \n+## @description Stop a list of named containers\n+## @param       List of container names, eg datanode_1 datanode_2\n+stop_containers() {\n+  set -e\n+  docker-compose -f \"$COMPOSE_FILE\" stop $@\n+  set +e\n+}\n+\n+\n+## @description Start a list of named containers\n+## @param       List of container names, eg datanode_1 datanode_2\n+start_containers() {\n+  set -e\n+  docker-compose -f \"$COMPOSE_FILE\" start $@", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e4648d9deec2baab778d04fa2148e0dea0765fe"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NDM0NTcz", "url": "https://github.com/apache/ozone/pull/608#pullrequestreview-366434573", "createdAt": "2020-02-28T14:27:21Z", "commit": {"oid": "4860931cc6bf968c06851d12b0303199a3665aa3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNDoyNzoyMVrOFv2uNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNDoyNzoyMVrOFv2uNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTcyMzk1OA==", "bodyText": "what about if datanode_1, datanode_2 and datnaode_3 are not yet started / registered but 4-6 are stopped. Do we need some safety check here?\nIn the testlib.sh/start_docker_env we have a wait_for_safemode_exit part. We might need it here.", "url": "https://github.com/apache/ozone/pull/608#discussion_r385723958", "createdAt": "2020-02-28T14:27:21Z", "author": {"login": "elek"}, "path": "hadoop-ozone/dist/src/main/compose/ozone-topology/test.sh", "diffHunk": "@@ -33,6 +33,20 @@ execute_robot_test scm basic/basic.robot\n \n execute_robot_test scm topology/scmcli.robot\n \n+# Ensure data can be read even when a full rack\n+# is stopped.\n+execute_robot_test scm topology/loaddata.robot\n+\n+stop_containers datanode_1 datanode_2 datanode_3\n+\n+execute_robot_test scm topology/readdata.robot\n+\n+start_containers datanode_1 datanode_2 datanode_3\n+\n+stop_containers datanode_4 datanode_5 datanode_6\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4860931cc6bf968c06851d12b0303199a3665aa3"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3MzkyNTQ4", "url": "https://github.com/apache/ozone/pull/608#pullrequestreview-367392548", "createdAt": "2020-03-02T17:39:13Z", "commit": {"oid": "ac926fc10f2ddc78accc52bddf08e40b7dd25e5d"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "688cc29f0a7867c94ef7fb410b845d0712555d82", "author": {"user": null}, "url": "https://github.com/apache/ozone/commit/688cc29f0a7867c94ef7fb410b845d0712555d82", "committedDate": "2020-03-06T15:57:59Z", "message": "Extended Network Topology Robot tests to attempted to read data when each rack is stopped in turn"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25cc6fbe9df51185a0ea55ff35caaa1e6bc495ba", "author": {"user": null}, "url": "https://github.com/apache/ozone/commit/25cc6fbe9df51185a0ea55ff35caaa1e6bc495ba", "committedDate": "2020-03-06T15:57:59Z", "message": "Address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07b97fc89f8342a36a0e03e3f344a35c555ed779", "author": {"user": null}, "url": "https://github.com/apache/ozone/commit/07b97fc89f8342a36a0e03e3f344a35c555ed779", "committedDate": "2020-03-06T15:57:59Z", "message": "Check the DN xceiver port is back online after restarting a DN before continuing the test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9702a1a32b441589e045990d5a7a4eff22d86f44", "author": {"user": null}, "url": "https://github.com/apache/ozone/commit/9702a1a32b441589e045990d5a7a4eff22d86f44", "committedDate": "2020-03-06T15:57:59Z", "message": "Moved new test to the file hdds-3084.sh and reverted test.sh to the original so this change can be committed while the blocking issues are resolved"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c59533d37df22739cf06ca170239b88f14e059bb", "author": {"user": null}, "url": "https://github.com/apache/ozone/commit/c59533d37df22739cf06ca170239b88f14e059bb", "committedDate": "2020-03-06T14:30:28Z", "message": "Moved new test to the file hdds-3084.sh and reverted test.sh to the original so this change can be committed while the blocking issues are resolved"}, "afterCommit": {"oid": "9702a1a32b441589e045990d5a7a4eff22d86f44", "author": {"user": null}, "url": "https://github.com/apache/ozone/commit/9702a1a32b441589e045990d5a7a4eff22d86f44", "committedDate": "2020-03-06T15:57:59Z", "message": "Moved new test to the file hdds-3084.sh and reverted test.sh to the original so this change can be committed while the blocking issues are resolved"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxOTcyNzEx", "url": "https://github.com/apache/ozone/pull/608#pullrequestreview-371972711", "createdAt": "2020-03-10T13:56:01Z", "commit": {"oid": "9702a1a32b441589e045990d5a7a4eff22d86f44"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3634, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}