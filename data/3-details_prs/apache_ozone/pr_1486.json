{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNzUzNDE1", "number": 1486, "title": "HDDS-4296. SCM changes to process Layout Info in heartbeat request/response", "bodyText": "What changes were proposed in this pull request?\nSCM changes to process Layout Info in heartbeat request/response\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4296\nHow was this patch tested?\nUT. I will fix any CI failure.", "createdAt": "2020-10-09T18:26:25Z", "url": "https://github.com/apache/ozone/pull/1486", "merged": true, "mergeCommit": {"oid": "8e29229dc66a0ce5fd63629b08f120c22827cf86"}, "closed": true, "closedAt": "2020-10-30T20:11:37Z", "author": {"login": "prashantpogde"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdRMz4ygFqTUwNjEwNTgzMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXqTFUgH2gAyNTAwNzUzNDE1OjY5MWE1ZDRiN2M4NDE0ZTU1YmMzZDU3NjY5NDZiY2FhMzRkOTdhMWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MTA1ODMy", "url": "https://github.com/apache/ozone/pull/1486#pullrequestreview-506105832", "createdAt": "2020-10-10T15:32:26Z", "commit": {"oid": "6030f093d5418e59de19a7afd97bfaedc6c413da"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQxNTozMjoyNlrOHfgnaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQxNTo0NzoxN1rOHfgtKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjgwMjI4MQ==", "bodyText": "param not used here.", "url": "https://github.com/apache/ozone/pull/1486#discussion_r502802281", "createdAt": "2020-10-10T15:32:26Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/upgrade/AbstractLayoutVersionManager.java", "diffHunk": "@@ -107,6 +121,10 @@ public void doFinalize(Object param) {\n     }\n   }\n \n+  public void completeFinalize(Object param) {\n+    currentUpgradeState = Finalized;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6030f093d5418e59de19a7afd97bfaedc6c413da"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjgwMjUyNA==", "bodyText": "Can we use uppercase letter here, like INVALID, PRE_FINALIZE.. FINALIZED.", "url": "https://github.com/apache/ozone/pull/1486#discussion_r502802524", "createdAt": "2020-10-10T15:34:54Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/upgrade/OzoneUpgradeState.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.upgrade;\n+\n+/**\n+ * Generic UpgradeState or Ozone.\n+ */\n+public enum OzoneUpgradeState {\n+\n+  InValid(0, \"Invalid State\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6030f093d5418e59de19a7afd97bfaedc6c413da"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjgwMjYyOA==", "bodyText": "Wrong log instance name used.", "url": "https://github.com/apache/ozone/pull/1486#discussion_r502802628", "createdAt": "2020-10-10T15:35:47Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/LayoutVersionReportHandler.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hdds.scm.node;\n+\n+import com.google.common.base.Preconditions;\n+import org.apache.hadoop.hdds.protocol.DatanodeDetails;\n+import org.apache.hadoop.hdds.scm.server.SCMDatanodeHeartbeatDispatcher.LayoutReportFromDatanode;\n+import org.apache.hadoop.hdds.server.events.EventHandler;\n+import org.apache.hadoop.hdds.server.events.EventPublisher;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Handles Node Layout Version Reports from DataNode.\n+ */\n+public class LayoutVersionReportHandler implements\n+    EventHandler<LayoutReportFromDatanode> {\n+\n+  private static final Logger LOGGER = LoggerFactory\n+      .getLogger(NodeReportHandler.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6030f093d5418e59de19a7afd97bfaedc6c413da"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjgwMzQ1MA==", "bodyText": "Here the dnSlv is returned in finalize command, is that right? should be scmSlv/scmMlv?", "url": "https://github.com/apache/ozone/pull/1486#discussion_r502803450", "createdAt": "2020-10-10T15:44:23Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java", "diffHunk": "@@ -400,6 +405,66 @@ public void processNodeReport(DatanodeDetails datanodeDetails,\n     }\n   }\n \n+  /**\n+   * Process Layout Version report.\n+   *\n+   * @param datanodeDetails\n+   * @param layoutVersionReport\n+   */\n+  @Override\n+  public void processLayoutVersionReport(DatanodeDetails datanodeDetails,\n+                                LayoutVersionProto layoutVersionReport) {\n+    if (LOG.isDebugEnabled()) {\n+      LOG.debug(\"Processing Layout Version report from [datanode={}]\",\n+          datanodeDetails.getHostName());\n+    }\n+    if (LOG.isTraceEnabled()) {\n+      LOG.trace(\"HB is received from [datanode={}]: <json>{}</json>\",\n+          datanodeDetails.getHostName(),\n+          layoutVersionReport.toString().replaceAll(\"\\n\", \"\\\\\\\\n\"));\n+    }\n+\n+    if (layoutVersionReport != null) {\n+      int scmSlv = scmLayoutVersionManager.getSoftwareLayoutVersion();\n+      int scmMlv = scmLayoutVersionManager.getMetadataLayoutVersion();\n+      OzoneUpgradeState scmUpgradeState =\n+          scmLayoutVersionManager.getUpgradeState();\n+      int dnSlv = layoutVersionReport.getSoftwareLayoutVersion();\n+      int dnMlv = layoutVersionReport.getMetadataLayoutVersion();\n+\n+      // If the data node slv is > scm slv => log error condition\n+      if (dnSlv > scmSlv) {\n+        LOG.error(\"Rogue data node {} in the cluster. \" +\n+                \"DataNode SoftwareLayoutVersion = {}, SCM \" +\n+                \"SoftwareLayoutVersion = {}\",\n+            datanodeDetails.getHostName(), dnSlv, scmSlv);\n+      }\n+\n+      // If the datanode slv < scm slv, it can not be allowed to be part of\n+      // any pipeline. However it can be allowed to join the cluster\n+      if (dnMlv < scmMlv) {\n+        LOG.warn(\"Data node {} can not be used in any pipeline in the \" +\n+                \"cluster. \" + \"DataNode MetadataLayoutVersion = {}, SCM \" +\n+                \"MetadataLayoutVersion = {}\",\n+            datanodeDetails.getHostName(), dnMlv, scmMlv);\n+\n+        // TBD: Add NEED_UPGRADE state and fill out state transitions\n+        // around this state. Fire event to move this data node to\n+        // NEED_UPGRADE state. The DataNode will be considered HEALTHY in\n+        // this state but it can not be made part of any Pipeline.\n+\n+        // Also send Finalize command to the data node. Its OK to\n+        // send Finalize command multiple times.\n+        scmNodeEventPublisher.fireEvent(SCMEvents.DATANODE_COMMAND,\n+            new CommandForDatanode<>(datanodeDetails.getUuid(),\n+                new FinalizeNewLayoutVersionCommand(true,\n+                    LayoutVersionProto.newBuilder()\n+                        .setSoftwareLayoutVersion(dnSlv)\n+                        .setMetadataLayoutVersion(dnSlv).build())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6030f093d5418e59de19a7afd97bfaedc6c413da"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjgwMzc1NQ==", "bodyText": "Can we put this node into exclude list temporarily?  For the lower version, it can be tolerated by SCM. But for high version, SCM should take some action I think.\nAnother question: SCM uses heartbeat to return finalize command to DNs only during DN rolling upgrade step, right? For the normal case, it actually does nothing.", "url": "https://github.com/apache/ozone/pull/1486#discussion_r502803755", "createdAt": "2020-10-10T15:47:17Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java", "diffHunk": "@@ -400,6 +405,66 @@ public void processNodeReport(DatanodeDetails datanodeDetails,\n     }\n   }\n \n+  /**\n+   * Process Layout Version report.\n+   *\n+   * @param datanodeDetails\n+   * @param layoutVersionReport\n+   */\n+  @Override\n+  public void processLayoutVersionReport(DatanodeDetails datanodeDetails,\n+                                LayoutVersionProto layoutVersionReport) {\n+    if (LOG.isDebugEnabled()) {\n+      LOG.debug(\"Processing Layout Version report from [datanode={}]\",\n+          datanodeDetails.getHostName());\n+    }\n+    if (LOG.isTraceEnabled()) {\n+      LOG.trace(\"HB is received from [datanode={}]: <json>{}</json>\",\n+          datanodeDetails.getHostName(),\n+          layoutVersionReport.toString().replaceAll(\"\\n\", \"\\\\\\\\n\"));\n+    }\n+\n+    if (layoutVersionReport != null) {\n+      int scmSlv = scmLayoutVersionManager.getSoftwareLayoutVersion();\n+      int scmMlv = scmLayoutVersionManager.getMetadataLayoutVersion();\n+      OzoneUpgradeState scmUpgradeState =\n+          scmLayoutVersionManager.getUpgradeState();\n+      int dnSlv = layoutVersionReport.getSoftwareLayoutVersion();\n+      int dnMlv = layoutVersionReport.getMetadataLayoutVersion();\n+\n+      // If the data node slv is > scm slv => log error condition\n+      if (dnSlv > scmSlv) {\n+        LOG.error(\"Rogue data node {} in the cluster. \" +\n+                \"DataNode SoftwareLayoutVersion = {}, SCM \" +\n+                \"SoftwareLayoutVersion = {}\",\n+            datanodeDetails.getHostName(), dnSlv, scmSlv);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6030f093d5418e59de19a7afd97bfaedc6c413da"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MDEyMDUw", "url": "https://github.com/apache/ozone/pull/1486#pullrequestreview-508012050", "createdAt": "2020-10-14T05:47:26Z", "commit": {"oid": "6030f093d5418e59de19a7afd97bfaedc6c413da"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8053652a8927d19585c3c29cb37299451e1b5a3b", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/8053652a8927d19585c3c29cb37299451e1b5a3b", "committedDate": "2020-10-21T22:40:05Z", "message": "HDDS-4296. SCM changes to process Layout Info in heartbeat request/response."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6030f093d5418e59de19a7afd97bfaedc6c413da", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/6030f093d5418e59de19a7afd97bfaedc6c413da", "committedDate": "2020-10-09T18:22:58Z", "message": "HDDS-4296. SCM changes to process Layout Info in heartbeat request/response."}, "afterCommit": {"oid": "8053652a8927d19585c3c29cb37299451e1b5a3b", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/8053652a8927d19585c3c29cb37299451e1b5a3b", "committedDate": "2020-10-21T22:40:05Z", "message": "HDDS-4296. SCM changes to process Layout Info in heartbeat request/response."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0NzYyMDEw", "url": "https://github.com/apache/ozone/pull/1486#pullrequestreview-514762010", "createdAt": "2020-10-22T14:02:39Z", "commit": {"oid": "8053652a8927d19585c3c29cb37299451e1b5a3b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNDowMjozOVrOHmjYFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNDowMjozOVrOHmjYFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE4NzU0Mw==", "bodyText": "Do we also need to add the condition (dnMLV > scmMLV) here (and at register step)?", "url": "https://github.com/apache/ozone/pull/1486#discussion_r510187543", "createdAt": "2020-10-22T14:02:39Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java", "diffHunk": "@@ -400,6 +405,66 @@ public void processNodeReport(DatanodeDetails datanodeDetails,\n     }\n   }\n \n+  /**\n+   * Process Layout Version report.\n+   *\n+   * @param datanodeDetails\n+   * @param layoutVersionReport\n+   */\n+  @Override\n+  public void processLayoutVersionReport(DatanodeDetails datanodeDetails,\n+                                LayoutVersionProto layoutVersionReport) {\n+    if (LOG.isDebugEnabled()) {\n+      LOG.debug(\"Processing Layout Version report from [datanode={}]\",\n+          datanodeDetails.getHostName());\n+    }\n+    if (LOG.isTraceEnabled()) {\n+      LOG.trace(\"HB is received from [datanode={}]: <json>{}</json>\",\n+          datanodeDetails.getHostName(),\n+          layoutVersionReport.toString().replaceAll(\"\\n\", \"\\\\\\\\n\"));\n+    }\n+\n+    if (layoutVersionReport != null) {\n+      int scmSlv = scmLayoutVersionManager.getSoftwareLayoutVersion();\n+      int scmMlv = scmLayoutVersionManager.getMetadataLayoutVersion();\n+      UpgradeFinalizer.Status scmUpgradeState =\n+          scmLayoutVersionManager.getUpgradeState();\n+      int dnSlv = layoutVersionReport.getSoftwareLayoutVersion();\n+      int dnMlv = layoutVersionReport.getMetadataLayoutVersion();\n+\n+      // If the data node slv is > scm slv => log error condition\n+      if (dnSlv > scmSlv) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8053652a8927d19585c3c29cb37299451e1b5a3b"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "389253fcc55cfe3bc90c8fb6ed312b9953ccfc3b", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/389253fcc55cfe3bc90c8fb6ed312b9953ccfc3b", "committedDate": "2020-10-29T21:50:07Z", "message": "HDDS-4296. Adding UT for processLayoutVersionReport."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30fc20a5da6f09d05e050a7f1b929c5b5e04432b", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/30fc20a5da6f09d05e050a7f1b929c5b5e04432b", "committedDate": "2020-10-30T03:57:37Z", "message": "HDDS-4296. Fixing CI failure."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNjUyNTI3", "url": "https://github.com/apache/ozone/pull/1486#pullrequestreview-520652527", "createdAt": "2020-10-30T13:13:06Z", "commit": {"oid": "30fc20a5da6f09d05e050a7f1b929c5b5e04432b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b4f3509cb641a7f8c112c3fdd8f3fac262c89e7", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/8b4f3509cb641a7f8c112c3fdd8f3fac262c89e7", "committedDate": "2020-10-30T17:05:52Z", "message": "HDDS-4296. Fixing CI failure part 2."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "691a5d4b7c8414e55bc3d5766946bcaa34d97a1f", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/691a5d4b7c8414e55bc3d5766946bcaa34d97a1f", "committedDate": "2020-10-30T17:34:21Z", "message": "HDDS-4296. CI failure fix part 3."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2355, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}