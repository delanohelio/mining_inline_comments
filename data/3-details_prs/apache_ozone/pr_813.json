{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyNDM4NDE3", "number": 813, "title": "HDDS-3309. Add TimedOutTestsListener to surefire and add timeout to integration tests", "bodyText": "What changes were proposed in this pull request?\nAdd TimedOutTestsListener as a listener to maven-surefire-plugin like Hadoop does. And add timeout to integration tests that are not marked with @Ignore at the time of the patch.\nAlso previously discussed under #750.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3309\nHow was this patch tested?\nThe patch should make the timed out tests print out the stack trace (if any). Checks itself.\nBonus\nTo test if the TimedOutTestsListener is working, you can change the timeout of a class to an impossibly small value like 5 sec (for an integration test to initialize). Then run that integration test. Make sure the test isn't ignored or it won't run with mvn test.\nNote that the timeout must be smaller than surefire.fork.timeout shown below otherwise the fork will still be killed with no stack trace or thread dump.\nhttps://github.com/apache/hadoop-ozone/blob/2e9bae2f8636974c5c0e11a4a3e04d9cbfbb2288/pom.xml#L228\nFor example, in TestOzoneManagerRestart I removed the @Ignore annotation and set the timeout to 5000 ms. Then ran:\nmvn test -e -Dtest=TestOzoneManagerRestart\nMaven output:\n[INFO] -------------------------------------------------------\n[INFO]  T E S T S\n[INFO] -------------------------------------------------------\n[INFO] Running org.apache.hadoop.ozone.om.TestOzoneManagerRestart\n[ERROR] Tests run: 3, Failures: 0, Errors: 3, Skipped: 0, Time elapsed: 15.223 s <<< FAILURE! - in org.apache.hadoop.ozone.om.TestOzoneManagerRestart\n[ERROR] testRestartOMWithVolumeOperation(org.apache.hadoop.ozone.om.TestOzoneManagerRestart)  Time elapsed: 5.019 s  <<< ERROR!\njava.lang.Exception: test timed out after 5000 milliseconds\n\tat java.lang.Thread.sleep(Native Method)\n\tat org.apache.hadoop.test.GenericTestUtils.waitFor(GenericTestUtils.java:218)\n...\n[ERROR] testRestartOMWithBucketOperation(org.apache.hadoop.ozone.om.TestOzoneManagerRestart)  Time elapsed: 5.004 s  <<< ERROR!\njava.lang.Exception: test timed out after 5000 milliseconds\n\tat java.lang.Thread.sleep(Native Method)\n\tat org.apache.hadoop.test.GenericTestUtils.waitFor(GenericTestUtils.java:218)\n...\n[ERROR] testRestartOMWithKeyOperation(org.apache.hadoop.ozone.om.TestOzoneManagerRestart)  Time elapsed: 5.002 s  <<< ERROR!\njava.lang.Exception: test timed out after 5000 milliseconds\n\tat java.lang.Thread.sleep(Native Method)\n\tat org.apache.hadoop.test.GenericTestUtils.waitFor(GenericTestUtils.java:218)\n...\n[INFO]\n[INFO] Results:\n[INFO]\n[ERROR] Errors:\n[ERROR]   TestOzoneManagerRestart.init:90 \u00bb  test timed out after 5000 milliseconds\n[ERROR]   TestOzoneManagerRestart.init:90 \u00bb  test timed out after 5000 milliseconds\n[ERROR]   TestOzoneManagerRestart.init:90 \u00bb  test timed out after 5000 milliseconds\n[INFO]\n[ERROR] Tests run: 3, Failures: 0, Errors: 3, Skipped: 0\nMore importantly, the surefire-reports folder has the detailed logs with thread dump:\n[ERROR] Failed to execute goal org.apache.maven.plugins:maven-surefire-plugin:3.0.0-M1:test (default-test) on project hadoop-ozone-integration-test: There are test failures.\n[ERROR]\n[ERROR] Please refer to /Users/smeng/repo/ozone/hadoop-ozone/integration-test/target/surefire-reports for the individual test results.\n[ERROR] Please refer to dump files (if any exist) [date].dump, [date]-jvmRun[N].dump and [date].dumpstream.\n[ERROR] -> [Help 1]\norg.apache.maven.lifecycle.LifecycleExecutionException: Failed to execute goal org.apache.maven.plugins:maven-surefire-plugin:3.0.0-M1:test (default-test) on project hadoop-ozone-integration-test: There are test failures.\n\nPlease refer to /Users/smeng/repo/ozone/hadoop-ozone/integration-test/target/surefire-reports for the individual test results.\nPlease refer to dump files (if any exist) [date].dump, [date]-jvmRun[N].dump and [date].dumpstream.\n    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:215)\n\nExample thread dump in surefire-reports/org.apache.hadoop.ozone.om.TestOzoneManagerRestart-output.txt:\n====> TEST TIMED OUT. PRINTING THREAD DUMP. <====\n\nTimestamp: 2020-05-22 06:37:20,788\n\n\"qtp494169951-212\" daemon prio=5 tid=212 timed_waiting\njava.lang.Thread.State: TIMED_WAITING\n        at sun.misc.Unsafe.park(Native Method)\n        at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)\n        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2078)\n        at org.eclipse.jetty.util.BlockingArrayQueue.poll(BlockingArrayQueue.java:382)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool$Runner.idleJobPoll(QueuedThreadPool.java:875)\n        at org.eclipse.jetty.util.thread.QueuedThreadPool$Runner.run(QueuedThreadPool.java:925)\n        at java.lang.Thread.run(Thread.java:748)\n\"pool-56-thread-1\"  prio=5 tid=192 timed_waiting\njava.lang.Thread.State: TIMED_WAITING\n        at sun.misc.Unsafe.park(Native Method)\n        at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)\n        at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2078)\n        at java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:1093)\n        at java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:809)\n        at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1074)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1134)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n        at java.lang.Thread.run(Thread.java:748)\n...", "createdAt": "2020-04-13T02:07:49Z", "url": "https://github.com/apache/ozone/pull/813", "merged": true, "mergeCommit": {"oid": "b66869d687bd00e8790cc35e28bbe1ee2e643596"}, "closed": true, "closedAt": "2020-05-28T21:27:14Z", "author": {"login": "smengcl"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXffKTAFqTM5MjcyNDU2Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABclqbOnAH2gAyNDAyNDM4NDE3Ojg0M2YxZDg5NGNjZmFlNzhhNzE3YmQ1ZjVmMWZhYTJjZjc4MmQ0YmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNzI0NTY2", "url": "https://github.com/apache/ozone/pull/813#pullrequestreview-392724566", "createdAt": "2020-04-14T08:47:26Z", "commit": {"oid": "8dbbde83e1485ffe0ece2b40e822fdf17c466638"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MzQzNjY1", "url": "https://github.com/apache/ozone/pull/813#pullrequestreview-395343665", "createdAt": "2020-04-17T10:33:03Z", "commit": {"oid": "6e67832d3fbd9b38e5b57daf7c1f4b6e8c9dabf3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMDozMzowM1rOGHI10w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMDozMzowM1rOGHI10w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEzODA2Nw==", "bodyText": "Unused import.", "url": "https://github.com/apache/ozone/pull/813#discussion_r410138067", "createdAt": "2020-04-17T10:33:03Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/common/src/test/java/org/apache/hadoop/test/TimedOutTestsListener.java", "diffHunk": "@@ -31,6 +31,7 @@\n \n import org.apache.hadoop.util.StringUtils;\n \n+import org.junit.runner.Description;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e67832d3fbd9b38e5b57daf7c1f4b6e8c9dabf3"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6e67832d3fbd9b38e5b57daf7c1f4b6e8c9dabf3", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/6e67832d3fbd9b38e5b57daf7c1f4b6e8c9dabf3", "committedDate": "2020-04-15T16:35:30Z", "message": "[POC] Impl testStarted() in TimedOutTestsListener."}, "afterCommit": {"oid": "3cbd5e0a373359f0a5d3ef42f061192f4ddf46ea", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/3cbd5e0a373359f0a5d3ef42f061192f4ddf46ea", "committedDate": "2020-05-16T14:31:27Z", "message": "Revert \"Add TimedOutTestsListener to hdds and ozone pom.\"\n\nThis reverts commit 8dbbde83e1485ffe0ece2b40e822fdf17c466638."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "34e330cc1a4ebc5fddc0bcc5d9324fc638f27b58", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/34e330cc1a4ebc5fddc0bcc5d9324fc638f27b58", "committedDate": "2020-05-18T16:05:26Z", "message": "Restore timeouts that already exists pre-patch."}, "afterCommit": {"oid": "b84b9a47a3a931eb50c748cbdba74a26125a2c06", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/b84b9a47a3a931eb50c748cbdba74a26125a2c06", "committedDate": "2020-05-18T16:12:22Z", "message": "Restore timeouts that already exists pre-patch."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c98c98161b62ea91a53d0259f651041c3c6ab8b6", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/c98c98161b62ea91a53d0259f651041c3c6ab8b6", "committedDate": "2020-05-18T16:28:22Z", "message": "Add TimedOutTestsListener to hdds and ozone pom."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e9bae2f8636974c5c0e11a4a3e04d9cbfbb2288", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/2e9bae2f8636974c5c0e11a4a3e04d9cbfbb2288", "committedDate": "2020-05-18T16:28:22Z", "message": "Add TimedOutTestsListener to root pom maven-surefire-plugin."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac471f58ff1601fe51d3953e165c3b48600f24d5", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/ac471f58ff1601fe51d3953e165c3b48600f24d5", "committedDate": "2020-05-18T16:28:22Z", "message": "Revert \"Add TimedOutTestsListener to hdds and ozone pom.\"\n\nThis reverts commit 8dbbde83e1485ffe0ece2b40e822fdf17c466638."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6c66c00ad135798702228f84f547da9777d22ef", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/f6c66c00ad135798702228f84f547da9777d22ef", "committedDate": "2020-05-18T16:28:23Z", "message": "All timeouts to all integration tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "105d02080c42abf356f948d9ad9c57bd570f3864", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/105d02080c42abf356f948d9ad9c57bd570f3864", "committedDate": "2020-05-18T16:28:23Z", "message": "Exclude change from ignored freon tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b3e642d976453d2f350da21b8a4023be759c55f", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/7b3e642d976453d2f350da21b8a4023be759c55f", "committedDate": "2020-05-18T16:28:23Z", "message": "Exclude change from all ignored test classes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60c8c79fc93d452109e93baaeba8510e6f7e622a", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/60c8c79fc93d452109e93baaeba8510e6f7e622a", "committedDate": "2020-05-18T16:28:23Z", "message": "Fix checkstyle."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6555667c605e53a235825726756f08e43789081", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/d6555667c605e53a235825726756f08e43789081", "committedDate": "2020-05-18T16:28:23Z", "message": "Restore timeouts that already exists pre-patch."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b2870a973e9b56240e09a13e952134ff11c3505", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/2b2870a973e9b56240e09a13e952134ff11c3505", "committedDate": "2020-05-18T16:28:23Z", "message": "Fix weird checkstyle problem in TestKeyInputStream."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "274c3c651930204a1daebb06fb10f98828ab5f15", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/274c3c651930204a1daebb06fb10f98828ab5f15", "committedDate": "2020-05-18T16:28:23Z", "message": "Remove timeout in TestKeyInputStream because #931 added it already."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4257be493431772833a20a89efc7ae4c11aa9d1c", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/4257be493431772833a20a89efc7ae4c11aa9d1c", "committedDate": "2020-05-18T16:27:34Z", "message": "Remove timeout in TestKeyInputStream because #931 added it already."}, "afterCommit": {"oid": "274c3c651930204a1daebb06fb10f98828ab5f15", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/274c3c651930204a1daebb06fb10f98828ab5f15", "committedDate": "2020-05-18T16:28:23Z", "message": "Remove timeout in TestKeyInputStream because #931 added it already."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1Njc5MzM5", "url": "https://github.com/apache/ozone/pull/813#pullrequestreview-415679339", "createdAt": "2020-05-20T20:12:39Z", "commit": {"oid": "274c3c651930204a1daebb06fb10f98828ab5f15"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1Njc5NTk4", "url": "https://github.com/apache/ozone/pull/813#pullrequestreview-415679598", "createdAt": "2020-05-20T20:13:04Z", "commit": {"oid": "274c3c651930204a1daebb06fb10f98828ab5f15"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c5c918edcc25bd68bf7f0ed8d7fc2770b3702f8", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/4c5c918edcc25bd68bf7f0ed8d7fc2770b3702f8", "committedDate": "2020-05-22T20:11:25Z", "message": "Remove whitespace."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b37422cb4d8e9f42742bdc0374e639f4a76fd97a", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/b37422cb4d8e9f42742bdc0374e639f4a76fd97a", "committedDate": "2020-05-22T20:20:03Z", "message": "Remove change from more ignored tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d570692fee79807257af66777130fb6a6c02467", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/2d570692fee79807257af66777130fb6a6c02467", "committedDate": "2020-05-27T10:25:42Z", "message": "trigger new CI check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "614c372b9358d4738862c1e4b4735299d798cc74", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/614c372b9358d4738862c1e4b4735299d798cc74", "committedDate": "2020-05-28T09:26:57Z", "message": "Merge remote-tracking branch 'origin/master' into HEAD"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "843f1d894ccfae78a717bd5f5f1faa2cf782d4bc", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/843f1d894ccfae78a717bd5f5f1faa2cf782d4bc", "committedDate": "2020-05-28T09:27:02Z", "message": "retrigger build with empty commit"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3351, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}