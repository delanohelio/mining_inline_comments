{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2NzYzNjQ4", "number": 1622, "title": "HDDS-4501. Reload OM State fail should terminate OM for any exceptions.", "bodyText": "What changes were proposed in this pull request?\nDuring reload state for any exception terminate OM, and also cleanup DB backup folder.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4501\nHow was this patch tested?\nExisting tests, this issue is idenitified from one of our customer issues, due to this follower OM went into bad state.", "createdAt": "2020-11-24T20:37:14Z", "url": "https://github.com/apache/ozone/pull/1622", "merged": true, "mergeCommit": {"oid": "4b69f08a8ba40c1bba19fc779f17244ebb48aade"}, "closed": true, "closedAt": "2020-11-24T22:35:12Z", "author": {"login": "bharatviswa504"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfv3ThAH2gAyNTI2NzYzNjQ4Ojc5MDUwM2M0MGE1MGRhZmY4N2U0NjhjMDY0MThlY2JhYzI5NzdmMWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfwHocAFqTUzNzg5NjU5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "790503c40a50daff87e468c06418ecbac2977f1e", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/790503c40a50daff87e468c06418ecbac2977f1e", "committedDate": "2020-11-24T20:34:50Z", "message": "HDDS-4501. Reload OM State fail should terminate OM for any exceptions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c959d6ca9f10c0c79fc1ae66a2177047f62efae1", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/c959d6ca9f10c0c79fc1ae66a2177047f62efae1", "committedDate": "2020-11-24T20:47:22Z", "message": "fix cs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3ODkxMzY2", "url": "https://github.com/apache/ozone/pull/1622#pullrequestreview-537891366", "createdAt": "2020-11-24T20:48:17Z", "commit": {"oid": "790503c40a50daff87e468c06418ecbac2977f1e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMDo0ODoxN1rOH5UlnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMDo0ODoxN1rOH5UlnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg2ODE4OQ==", "bodyText": "Bharat, in this scenario where the OM state was not reloaded with new checkpoint, it would be better to keep the backup also in place. Just in case the OM needs to be manually reversed back to old state.", "url": "https://github.com/apache/ozone/pull/1622#discussion_r529868189", "createdAt": "2020-11-24T20:48:17Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3324,8 +3324,16 @@ TermIndex installCheckpoint(String leaderId, Path checkpointLocation,\n       omRatisServer.getOmStateMachine().unpause(lastAppliedIndex, term);\n       LOG.info(\"Reloaded OM state with Term: {} and Index: {}\", term,\n           lastAppliedIndex);\n-    } catch (IOException ex) {\n+    } catch (Exception ex) {\n       String errorMsg = \"Failed to reload OM state and instantiate services.\";\n+      // Delete the backup DB if exists and then terminate OM.\n+      try {\n+        if (dbBackup != null) {\n+          FileUtils.deleteFully(dbBackup);\n+        }\n+      } catch (Exception e) {\n+        LOG.error(\"Failed to delete the backup of the original DB {}\", dbBackup);\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "790503c40a50daff87e468c06418ecbac2977f1e"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05a6b43970e56349b5a1ac695d6e6fc6325d0bc6", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/05a6b43970e56349b5a1ac695d6e6fc6325d0bc6", "committedDate": "2020-11-24T20:51:26Z", "message": "address review comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3ODk2NTkx", "url": "https://github.com/apache/ozone/pull/1622#pullrequestreview-537896591", "createdAt": "2020-11-24T20:52:40Z", "commit": {"oid": "05a6b43970e56349b5a1ac695d6e6fc6325d0bc6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1969, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}