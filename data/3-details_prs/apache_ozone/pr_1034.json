{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMwODUzODU5", "number": 1034, "title": "HDDS-3749. Improve OM performance with 3.7% by avoid stream.collect", "bodyText": "What changes were proposed in this pull request?\nI start a ozone cluster with 1000 datanodes and 10 s3gateway, and run two weeks with heavy workload, and perf om. There are 4 places use stream.collect which cost 3.7% cpu.\n\n\nstream.collect in Pipeline::getFromProtobuf cost 0.78%\n\n\n\nstream.collect in OmKeyInfo::getFromProtobuf cost 1.76%\n\n\n\n\nstream.collect in OMKeyCommitRequest::validateAndUpdateCache cost 0.42%\n\n\n\nstream.collect in OMKeyInfo::getProtoBuf cost 0.75\n\n\n\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3749\nHow was this patch tested?\nExisted tests.", "createdAt": "2020-06-08T07:21:40Z", "url": "https://github.com/apache/ozone/pull/1034", "merged": true, "mergeCommit": {"oid": "33992bd7f4c16024bb749900e60f3134e980d16a"}, "closed": true, "closedAt": "2020-06-10T22:16:58Z", "author": {"login": "runzhiwang"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpLUZsgBqjM0MTg1NDY4OTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqBOiSgFqTQyODQ2NjE3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c783227dfb2440c5065906446c9b98cefb896a2f", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/c783227dfb2440c5065906446c9b98cefb896a2f", "committedDate": "2020-06-08T07:15:39Z", "message": "HDDS-3749. Improve OM performance with 3% by avoid stream.collect"}, "afterCommit": {"oid": "be8be6e2c150e5af4052c0c423e9e7a6a8a761cc", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/be8be6e2c150e5af4052c0c423e9e7a6a8a761cc", "committedDate": "2020-06-08T07:29:07Z", "message": "HDDS-3749. Improve OM performance with 3% by avoid stream.collect"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be8be6e2c150e5af4052c0c423e9e7a6a8a761cc", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/be8be6e2c150e5af4052c0c423e9e7a6a8a761cc", "committedDate": "2020-06-08T07:29:07Z", "message": "HDDS-3749. Improve OM performance with 3% by avoid stream.collect"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6cf7b12420c38bbb64f587e087fc55b8853196d", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/d6cf7b12420c38bbb64f587e087fc55b8853196d", "committedDate": "2020-06-08T08:37:45Z", "message": "triger ci"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2OTgzMzY3", "url": "https://github.com/apache/ozone/pull/1034#pullrequestreview-426983367", "createdAt": "2020-06-09T09:59:06Z", "commit": {"oid": "d6cf7b12420c38bbb64f587e087fc55b8853196d"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwOTo1OTowNlrOGhCFJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMDowMDo1MFrOGhCJOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI5MDI3Nw==", "bodyText": "We don't need the temporary variable memberList.\nIt can be replaced with\nfor (DatanodeDetailsProto member : pipeline.getMembersList())", "url": "https://github.com/apache/ozone/pull/1034#discussion_r437290277", "createdAt": "2020-06-09T09:59:06Z", "author": {"login": "nandakumar131"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/pipeline/Pipeline.java", "diffHunk": "@@ -289,14 +290,20 @@ public boolean isEmpty() {\n   public static Pipeline getFromProtobuf(HddsProtos.Pipeline pipeline)\n       throws UnknownPipelineStateException {\n     Preconditions.checkNotNull(pipeline, \"Pipeline is null\");\n+\n+    List<DatanodeDetails> nodes = new ArrayList<>();\n+    List<DatanodeDetailsProto> membersList = pipeline.getMembersList();\n+    for (DatanodeDetailsProto member : membersList) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6cf7b12420c38bbb64f587e087fc55b8853196d"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI5MTA0NA==", "bodyText": "Temporary variable keyLocationLists can be removed.", "url": "https://github.com/apache/ozone/pull/1034#discussion_r437291044", "createdAt": "2020-06-09T10:00:23Z", "author": {"login": "nandakumar131"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyInfo.java", "diffHunk": "@@ -411,13 +415,19 @@ public static OmKeyInfo getFromProtobuf(KeyInfo keyInfo) {\n     if (keyInfo == null) {\n       return null;\n     }\n+\n+    List<OmKeyLocationInfoGroup> omKeyLocationInfos = new ArrayList<>();\n+    List<KeyLocationList> keyLocationLists = keyInfo.getKeyLocationListList();\n+    for (KeyLocationList keyLocationList : keyLocationLists) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6cf7b12420c38bbb64f587e087fc55b8853196d"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI5MTMyMA==", "bodyText": "The temporary variable keyLocations  can be removed.", "url": "https://github.com/apache/ozone/pull/1034#discussion_r437291320", "createdAt": "2020-06-09T10:00:50Z", "author": {"login": "nandakumar131"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCommitRequest.java", "diffHunk": "@@ -132,10 +134,13 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           keyName, IAccessAuthorizer.ACLType.WRITE,\n           commitKeyRequest.getClientID());\n \n-      List<OmKeyLocationInfo> locationInfoList = commitKeyArgs\n-          .getKeyLocationsList().stream()\n-          .map(OmKeyLocationInfo::getFromProtobuf)\n-          .collect(Collectors.toList());\n+      List<OmKeyLocationInfo> locationInfoList = new ArrayList<>();\n+      List<KeyLocation> keyLocations = commitKeyArgs\n+          .getKeyLocationsList();\n+\n+      for (KeyLocation keyLocation : keyLocations) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6cf7b12420c38bbb64f587e087fc55b8853196d"}, "originalPosition": 32}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4af9bfce98c507013cc198a0bdc3fb72018c9380", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/4af9bfce98c507013cc198a0bdc3fb72018c9380", "committedDate": "2020-06-09T10:33:54Z", "message": "fix code review"}, "afterCommit": {"oid": "99d4971a827f5c533058e05fbe534c42a6852448", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/99d4971a827f5c533058e05fbe534c42a6852448", "committedDate": "2020-06-10T01:49:10Z", "message": "fix code review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99d4971a827f5c533058e05fbe534c42a6852448", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/99d4971a827f5c533058e05fbe534c42a6852448", "committedDate": "2020-06-10T01:49:10Z", "message": "fix code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NDY2MTcy", "url": "https://github.com/apache/ozone/pull/1034#pullrequestreview-428466172", "createdAt": "2020-06-10T22:16:41Z", "commit": {"oid": "99d4971a827f5c533058e05fbe534c42a6852448"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3158, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}