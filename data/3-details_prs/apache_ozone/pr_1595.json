{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxNzk1OTM2", "number": 1595, "title": "HDDS-4468. Fix Goofys listBucket large than 1000 objects will stuck forever", "bodyText": "Description\nThe following is the ListObjectsOutput, ListObjectsV2Output and ListObjectsInput, ListObjectsV2Input from github.com/aws/aws-sdk-go/service/s3/api.go,\nFor goofys talk to s3g, it use the ListObjectsOutput and ListObjectsInput, so I think s3g should return NextMarker in the ListBucketResult and use mark to list key from.\nFor this PR, I purpose to make BucketEndpoint of s3g can both serve to V1 and V2\ntype ListObjectsOutput struct {\n\t_ struct{} `type:\"structure\"`\n\tCommonPrefixes []*CommonPrefix `type:\"list\" flattened:\"true\"`\n\tContents []*Object `type:\"list\" flattened:\"true\"`\n\tDelimiter *string `type:\"string\"`\n\tEncodingType *string `type:\"string\" enum:\"EncodingType\"`\n\tIsTruncated *bool `type:\"boolean\"`\n\tMarker *string `type:\"string\"`\n\tMaxKeys *int64 `type:\"integer\"`\n\tName *string `type:\"string\"`\n\tNextMarker *string `type:\"string\"`\n\tPrefix *string `type:\"string\"`\n}\n\ntype ListObjectsV2Output struct {\n\t_ struct{} `type:\"structure\"`\n\tCommonPrefixes []*CommonPrefix `type:\"list\" flattened:\"true\"`\n\tContents []*Object `type:\"list\" flattened:\"true\"`\n\tContinuationToken *string `type:\"string\"`\n\tDelimiter *string `type:\"string\"`\n\tEncodingType *string `type:\"string\" enum:\"EncodingType\"`\n\tIsTruncated *bool `type:\"boolean\"`\n\tKeyCount *int64 `type:\"integer\"`\n\tMaxKeys *int64 `type:\"integer\"`\n\tName *string `type:\"string\"`\n\tNextContinuationToken *string `type:\"string\"`\n\tPrefix *string `type:\"string\"`\n\tStartAfter *string `type:\"string\"`\n}\n\ntype ListObjectsInput struct {\n\t_ struct{} `type:\"structure\"`\n\tBucket *string `location:\"uri\" locationName:\"Bucket\" type:\"string\" required:\"true\"`\n\tDelimiter *string `location:\"querystring\" locationName:\"delimiter\" type:\"string\"`\n\tEncodingType *string `location:\"querystring\" locationName:\"encoding-type\" type:\"string\" enum:\"EncodingType\"`\n\tMarker *string `location:\"querystring\" locationName:\"marker\" type:\"string\"`\n\tMaxKeys *int64 `location:\"querystring\" locationName:\"max-keys\" type:\"integer\"`\n\tPrefix *string `location:\"querystring\" locationName:\"prefix\" type:\"string\"`\n\tRequestPayer *string `location:\"header\" locationName:\"x-amz-request-payer\" type:\"string\" enum:\"RequestPayer\"`\n}\n\ntype ListObjectsV2Input struct {\n\t_ struct{} `type:\"structure\"`\n\n\tBucket *string `location:\"uri\" locationName:\"Bucket\" type:\"string\" required:\"true\"`\n\tContinuationToken *string `location:\"querystring\" locationName:\"continuation-token\" type:\"string\"`\n\tDelimiter *string `location:\"querystring\" locationName:\"delimiter\" type:\"string\"`\n\tEncodingType *string `location:\"querystring\" locationName:\"encoding-type\" type:\"string\" enum:\"EncodingType\"`\n\tFetchOwner *bool `location:\"querystring\" locationName:\"fetch-owner\" type:\"boolean\"`\n\tMaxKeys *int64 `location:\"querystring\" locationName:\"max-keys\" type:\"integer\"`\n\tPrefix *string `location:\"querystring\" locationName:\"prefix\" type:\"string\"`\n\tRequestPayer *string `location:\"header\" locationName:\"x-amz-request-payer\" type:\"string\" enum:\"RequestPayer\"`\n\tStartAfter *string `location:\"querystring\" locationName:\"start-after\" type:\"string\"`\n}\nWhat changes were proposed in this pull request?\nFill startAfter with marker parameter when startAfter is null\nFill nextMark to the response, so that Goofys can use the nextMark to list follow-up objects.\nWhat is the link to the Apache JIRA\nHDDS-4468\nHow was this patch tested?\n\nCreate an ozone cluster with s3g.\nStart a goofys with this s3g.\nGenerate more than 1000 file in the test bucket\nlist the goofys mounted path.\n\nI've tested this PR on my local env.", "createdAt": "2020-11-16T16:57:15Z", "url": "https://github.com/apache/ozone/pull/1595", "merged": true, "mergeCommit": {"oid": "6cc4a438a4ba2dcc312e732f244b20847b294f19"}, "closed": true, "closedAt": "2020-11-23T16:33:37Z", "author": {"login": "maobaolong"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddH2rjAH2gAyNTIxNzk1OTM2OmI0OGVkM2MwNWNkODEwMTg2NDNhYjg4MzJiOThiMGNiZGViNjhmYjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfXzkjAFqTUzNjY0NjUzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b48ed3c05cd81018643ab8832b98b0cbdeb68fb0", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/b48ed3c05cd81018643ab8832b98b0cbdeb68fb0", "committedDate": "2020-11-16T16:50:06Z", "message": "HDDS-4468. Fix Goofys listBucket large than 1000 objects will stuck forever"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxOTE3NjA4", "url": "https://github.com/apache/ozone/pull/1595#pullrequestreview-531917608", "createdAt": "2020-11-16T23:57:28Z", "commit": {"oid": "b48ed3c05cd81018643ab8832b98b0cbdeb68fb0"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxOTE3NzU5", "url": "https://github.com/apache/ozone/pull/1595#pullrequestreview-531917759", "createdAt": "2020-11-16T23:57:46Z", "commit": {"oid": "b48ed3c05cd81018643ab8832b98b0cbdeb68fb0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMzo1Nzo0NlrOH0d4ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMzo1Nzo0NlrOH0d4ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDc3NzU5NQ==", "bodyText": "We need some comments here.", "url": "https://github.com/apache/ozone/pull/1595#discussion_r524777595", "createdAt": "2020-11-16T23:57:46Z", "author": {"login": "runzhiwang"}, "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/endpoint/BucketEndpoint.java", "diffHunk": "@@ -112,6 +112,9 @@ public Response list(\n     ContinueToken decodedToken =\n         ContinueToken.decodeFromString(continueToken);\n \n+    if (startAfter == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b48ed3c05cd81018643ab8832b98b0cbdeb68fb0"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fa1b3a63e05949e464e6605902fe1de0d18e320", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/2fa1b3a63e05949e464e6605902fe1de0d18e320", "committedDate": "2020-11-17T08:41:13Z", "message": "HDDS-4468. Add necessary comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMDI4Mzk3", "url": "https://github.com/apache/ozone/pull/1595#pullrequestreview-533028397", "createdAt": "2020-11-18T02:40:08Z", "commit": {"oid": "2fa1b3a63e05949e464e6605902fe1de0d18e320"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMjo0MDowOFrOH1Uogw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMjo0MDowOFrOH1Uogw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTY3NDYyNw==", "bodyText": "LGTM\n// Set nextMarker to be lastKey. for the compatibility  of aws api v1,", "url": "https://github.com/apache/ozone/pull/1595#discussion_r525674627", "createdAt": "2020-11-18T02:40:08Z", "author": {"login": "GlenGeng"}, "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/endpoint/BucketEndpoint.java", "diffHunk": "@@ -187,6 +191,8 @@ public Response list(\n       response.setTruncated(true);\n       ContinueToken nextToken = new ContinueToken(lastKey, prevDir);\n       response.setNextToken(nextToken.encodeToString());\n+      // For aws api v1 compatibility purpose, set nextMarker with lastKey", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2fa1b3a63e05949e464e6605902fe1de0d18e320"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c77886134e2bd039703fb4c8bbfd62edb636e58", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/5c77886134e2bd039703fb4c8bbfd62edb636e58", "committedDate": "2020-11-18T08:35:01Z", "message": "HDDS-4468. Update comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MTU2ODQz", "url": "https://github.com/apache/ozone/pull/1595#pullrequestreview-534156843", "createdAt": "2020-11-19T07:55:33Z", "commit": {"oid": "5c77886134e2bd039703fb4c8bbfd62edb636e58"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNzo1NTozM1rOH2QpCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNzo1NTozM1rOH2QpCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY1NzgwMA==", "bodyText": "After startAfter = marker, could startAfter be null?\nWe may remove duplicated check for startAfter after this null checker.", "url": "https://github.com/apache/ozone/pull/1595#discussion_r526657800", "createdAt": "2020-11-19T07:55:33Z", "author": {"login": "timmylicheng"}, "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/endpoint/BucketEndpoint.java", "diffHunk": "@@ -112,6 +112,10 @@ public Response list(\n     ContinueToken decodedToken =\n         ContinueToken.decodeFromString(continueToken);\n \n+    // stand for startAfter\n+    if (startAfter == null) {\n+      startAfter = marker;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c77886134e2bd039703fb4c8bbfd62edb636e58"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e57920f605206effc29e9025209e68c2bb9f344", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/0e57920f605206effc29e9025209e68c2bb9f344", "committedDate": "2020-11-19T11:01:44Z", "message": "Address comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MzEwMDA2", "url": "https://github.com/apache/ozone/pull/1595#pullrequestreview-534310006", "createdAt": "2020-11-19T11:07:54Z", "commit": {"oid": "0e57920f605206effc29e9025209e68c2bb9f344"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MzQzMTc4", "url": "https://github.com/apache/ozone/pull/1595#pullrequestreview-534343178", "createdAt": "2020-11-19T11:44:11Z", "commit": {"oid": "0e57920f605206effc29e9025209e68c2bb9f344"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MjExMjQy", "url": "https://github.com/apache/ozone/pull/1595#pullrequestreview-535211242", "createdAt": "2020-11-20T08:29:56Z", "commit": {"oid": "0e57920f605206effc29e9025209e68c2bb9f344"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1ODY0MTcy", "url": "https://github.com/apache/ozone/pull/1595#pullrequestreview-535864172", "createdAt": "2020-11-21T01:07:11Z", "commit": {"oid": "0e57920f605206effc29e9025209e68c2bb9f344"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMTowNzoxMVrOH3lTlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQwMTowNzoxMVrOH3lTlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODA0NDk0OQ==", "bodyText": "Below we are not setting marker should we also set that also, if the marker is not null?\nL136: response.setMarker(\"\");", "url": "https://github.com/apache/ozone/pull/1595#discussion_r528044949", "createdAt": "2020-11-21T01:07:11Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/endpoint/BucketEndpoint.java", "diffHunk": "@@ -112,6 +112,10 @@ public Response list(\n     ContinueToken decodedToken =\n         ContinueToken.decodeFromString(continueToken);\n \n+    // Assign marker to startAfter. for the compatibility of aws api v1\n+    if (startAfter == null && marker != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e57920f605206effc29e9025209e68c2bb9f344"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "008c372098aebb77eb8b14a161692416a8330e48", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/008c372098aebb77eb8b14a161692416a8330e48", "committedDate": "2020-11-23T02:00:52Z", "message": "set marker to response also when not null"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NDU2Mzgx", "url": "https://github.com/apache/ozone/pull/1595#pullrequestreview-536456381", "createdAt": "2020-11-23T13:09:29Z", "commit": {"oid": "008c372098aebb77eb8b14a161692416a8330e48"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NjQ2NTMy", "url": "https://github.com/apache/ozone/pull/1595#pullrequestreview-536646532", "createdAt": "2020-11-23T16:33:02Z", "commit": {"oid": "008c372098aebb77eb8b14a161692416a8330e48"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2303, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}