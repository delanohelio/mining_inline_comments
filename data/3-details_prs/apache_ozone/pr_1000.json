{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2MDI0MTY5", "number": 1000, "title": "HDDS-3562. Datanodes should send ICR when a container replica deletion is successful.", "bodyText": "What changes were proposed in this pull request?\nWhenever a datanode executes the delete container command and deletes the container replica, it has to immediately send an ICR to update the container replica state in SCM.\nWhat is the link to the Apache JIRA\nHDDS-3562\nHow was this patch tested?\nRelated unit tests added", "createdAt": "2020-06-01T14:45:19Z", "url": "https://github.com/apache/ozone/pull/1000", "merged": true, "mergeCommit": {"oid": "a800811505bb38b7a238a7a21f0043247dc124cc"}, "closed": true, "closedAt": "2020-06-05T16:09:46Z", "author": {"login": "nandakumar131"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcn1r11gFqTQyNDA4MDI4OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoU-jqgFqTQyNTQzNjI4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MDgwMjg4", "url": "https://github.com/apache/ozone/pull/1000#pullrequestreview-424080288", "createdAt": "2020-06-04T03:40:07Z", "commit": {"oid": "ab84718cf4f99850982ca0c1c5627b2092b64c7d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwMzo0MDowOFrOGe0vHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwMzo0MDowOFrOGe0vHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk3NDQ5NQ==", "bodyText": "NIT: Update javadocs", "url": "https://github.com/apache/ozone/pull/1000#discussion_r434974495", "createdAt": "2020-06-04T03:40:08Z", "author": {"login": "dineshchitlangia"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/AbstractContainerReportHandler.java", "diffHunk": "@@ -225,14 +218,35 @@ private void updateContainerState(final DatanodeDetails datanode,\n     }\n   }\n \n+  private void updateContainerReplica(final DatanodeDetails datanodeDetails,\n+                                      final ContainerID containerId,\n+                                      final ContainerReplicaProto replicaProto)\n+      throws ContainerNotFoundException, ContainerReplicaNotFoundException {\n+    final ContainerReplica replica = ContainerReplica.newBuilder()\n+        .setContainerID(containerId)\n+        .setContainerState(replicaProto.getState())\n+        .setDatanodeDetails(datanodeDetails)\n+        .setOriginNodeId(UUID.fromString(replicaProto.getOriginNodeId()))\n+        .setSequenceId(replicaProto.getBlockCommitSequenceId())\n+        .build();\n+\n+    if (replica.getState().equals(State.DELETED)) {\n+      containerManager.removeContainerReplica(containerId, replica);\n+    } else {\n+      containerManager.updateContainerReplica(containerId, replica);\n+    }\n+  }\n+\n   /**\n    * Returns true if the container replica is not marked as UNHEALTHY.\n    *\n    * @param replicaState State of the container replica.\n    * @return true if unhealthy, false otherwise\n    */\n   private boolean isUnhealthy(final Supplier<State> replicaState) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab84718cf4f99850982ca0c1c5627b2092b64c7d"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0ODM1MzMy", "url": "https://github.com/apache/ozone/pull/1000#pullrequestreview-424835332", "createdAt": "2020-06-04T21:08:20Z", "commit": {"oid": "ab84718cf4f99850982ca0c1c5627b2092b64c7d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77cf3c1f7dc741efe6d3be598827e2b29b853a07", "author": {"user": {"login": "nandakumar131", "name": "Nandakumar"}}, "url": "https://github.com/apache/ozone/commit/77cf3c1f7dc741efe6d3be598827e2b29b853a07", "committedDate": "2020-06-05T14:21:16Z", "message": "HDDS-3562. Datanodes should send ICR when a container replica deletion is successful."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "73b59740e56bfb77e310210a4583030e9d3c51d3", "author": {"user": {"login": "nandakumar131", "name": "Nandakumar"}}, "url": "https://github.com/apache/ozone/commit/73b59740e56bfb77e310210a4583030e9d3c51d3", "committedDate": "2020-06-05T06:15:14Z", "message": "HDDS-3562. Updated javadoc."}, "afterCommit": {"oid": "77cf3c1f7dc741efe6d3be598827e2b29b853a07", "author": {"user": {"login": "nandakumar131", "name": "Nandakumar"}}, "url": "https://github.com/apache/ozone/commit/77cf3c1f7dc741efe6d3be598827e2b29b853a07", "committedDate": "2020-06-05T14:21:16Z", "message": "HDDS-3562. Datanodes should send ICR when a container replica deletion is successful."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NDM2Mjg5", "url": "https://github.com/apache/ozone/pull/1000#pullrequestreview-425436289", "createdAt": "2020-06-05T16:09:30Z", "commit": {"oid": "77cf3c1f7dc741efe6d3be598827e2b29b853a07"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3118, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}