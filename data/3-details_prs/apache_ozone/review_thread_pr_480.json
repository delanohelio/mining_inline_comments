{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1ODg3MzI5", "number": 480, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNjozMzozMlrODaPDIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNjozNzowNVrODaPIqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4ODM2MTI4OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/datanode/RunningDatanodeState.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNjozMzozMlrOFhEyOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwMjozNjoyOVrOFhSnEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIyNTcyMQ==", "bodyText": "Shouldn't this be state instead of endpoint.getState()?  Assuming the endpoint state is constant during initialization, wouldn't this create several instances of the same type (eg. RegisterEndpointTask) for each endpoint?", "url": "https://github.com/apache/ozone/pull/480#discussion_r370225721", "createdAt": "2020-01-23T16:33:32Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/datanode/RunningDatanodeState.java", "diffHunk": "@@ -49,14 +52,62 @@\n   private final SCMConnectionManager connectionManager;\n   private final Configuration conf;\n   private final StateContext context;\n-  private CompletionService<EndpointStateMachine.EndPointStates> ecs;\n+  private CompletionService<EndPointStates> ecs;\n+  /** Cache the end point task per end point per end point state. */\n+  private Map<String, Map<EndPointStates,\n+      Callable<EndPointStates>>> endpointTasks;\n \n   public RunningDatanodeState(Configuration conf,\n       SCMConnectionManager connectionManager,\n       StateContext context) {\n     this.connectionManager = connectionManager;\n     this.conf = conf;\n     this.context = context;\n+    initEndPointTask();\n+  }\n+\n+  /**\n+   * Initialize end point tasks corresponding to each end point,\n+   * each end point state.\n+   */\n+  private void initEndPointTask() {\n+    endpointTasks = new HashMap<String, Map<EndPointStates,\n+        Callable<EndPointStates>>>();\n+    for (EndpointStateMachine endpoint : connectionManager.getValues()) {\n+      Map<EndPointStates, Callable<EndPointStates>> endpointTaskForState\n+          = new HashMap<EndPointStates, Callable<EndPointStates>>();\n+\n+      for (EndPointStates state : EndPointStates.values()) {\n+        Callable<EndPointStates> endPointTask = null;\n+        switch (endpoint.getState()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0885a2b90b750e756698bdd16304d78429532eef"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ1MjI0Mw==", "bodyText": "Yes, it should be state, it's my typo. Here we will create endpoint task for each state type.", "url": "https://github.com/apache/ozone/pull/480#discussion_r370452243", "createdAt": "2020-01-24T02:36:29Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/datanode/RunningDatanodeState.java", "diffHunk": "@@ -49,14 +52,62 @@\n   private final SCMConnectionManager connectionManager;\n   private final Configuration conf;\n   private final StateContext context;\n-  private CompletionService<EndpointStateMachine.EndPointStates> ecs;\n+  private CompletionService<EndPointStates> ecs;\n+  /** Cache the end point task per end point per end point state. */\n+  private Map<String, Map<EndPointStates,\n+      Callable<EndPointStates>>> endpointTasks;\n \n   public RunningDatanodeState(Configuration conf,\n       SCMConnectionManager connectionManager,\n       StateContext context) {\n     this.connectionManager = connectionManager;\n     this.conf = conf;\n     this.context = context;\n+    initEndPointTask();\n+  }\n+\n+  /**\n+   * Initialize end point tasks corresponding to each end point,\n+   * each end point state.\n+   */\n+  private void initEndPointTask() {\n+    endpointTasks = new HashMap<String, Map<EndPointStates,\n+        Callable<EndPointStates>>>();\n+    for (EndpointStateMachine endpoint : connectionManager.getValues()) {\n+      Map<EndPointStates, Callable<EndPointStates>> endpointTaskForState\n+          = new HashMap<EndPointStates, Callable<EndPointStates>>();\n+\n+      for (EndPointStates state : EndPointStates.values()) {\n+        Callable<EndPointStates> endPointTask = null;\n+        switch (endpoint.getState()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIyNTcyMQ=="}, "originalCommit": {"oid": "0885a2b90b750e756698bdd16304d78429532eef"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4ODM2NjQ5OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/datanode/RunningDatanodeState.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNjozNDo1MlrOFhE1aQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwMjozNjo1OFrOFhSneA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIyNjUzNw==", "bodyText": "Nit: no need to store null task for shutdown state.", "url": "https://github.com/apache/ozone/pull/480#discussion_r370226537", "createdAt": "2020-01-23T16:34:52Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/datanode/RunningDatanodeState.java", "diffHunk": "@@ -49,14 +52,62 @@\n   private final SCMConnectionManager connectionManager;\n   private final Configuration conf;\n   private final StateContext context;\n-  private CompletionService<EndpointStateMachine.EndPointStates> ecs;\n+  private CompletionService<EndPointStates> ecs;\n+  /** Cache the end point task per end point per end point state. */\n+  private Map<String, Map<EndPointStates,\n+      Callable<EndPointStates>>> endpointTasks;\n \n   public RunningDatanodeState(Configuration conf,\n       SCMConnectionManager connectionManager,\n       StateContext context) {\n     this.connectionManager = connectionManager;\n     this.conf = conf;\n     this.context = context;\n+    initEndPointTask();\n+  }\n+\n+  /**\n+   * Initialize end point tasks corresponding to each end point,\n+   * each end point state.\n+   */\n+  private void initEndPointTask() {\n+    endpointTasks = new HashMap<String, Map<EndPointStates,\n+        Callable<EndPointStates>>>();\n+    for (EndpointStateMachine endpoint : connectionManager.getValues()) {\n+      Map<EndPointStates, Callable<EndPointStates>> endpointTaskForState\n+          = new HashMap<EndPointStates, Callable<EndPointStates>>();\n+\n+      for (EndPointStates state : EndPointStates.values()) {\n+        Callable<EndPointStates> endPointTask = null;\n+        switch (endpoint.getState()) {\n+        case GETVERSION:\n+          endPointTask = new VersionEndpointTask(endpoint, conf,\n+              context.getParent().getContainer());\n+          break;\n+        case REGISTER:\n+          endPointTask = RegisterEndpointTask.newBuilder()\n+              .setConfig(conf)\n+              .setEndpointStateMachine(endpoint)\n+              .setContext(context)\n+              .setDatanodeDetails(context.getParent().getDatanodeDetails())\n+              .setOzoneContainer(context.getParent().getContainer())\n+              .build();\n+          break;\n+        case HEARTBEAT:\n+          endPointTask = HeartbeatEndpointTask.newBuilder()\n+              .setConfig(conf)\n+              .setEndpointStateMachine(endpoint)\n+              .setDatanodeDetails(context.getParent().getDatanodeDetails())\n+              .setContext(context)\n+              .build();\n+          break;\n+        case SHUTDOWN:\n+          break;\n+        }\n+        endpointTaskForState.put(state, endPointTask);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0885a2b90b750e756698bdd16304d78429532eef"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ1MjM0NA==", "bodyText": "Have removed SHUTDOWN switch case.", "url": "https://github.com/apache/ozone/pull/480#discussion_r370452344", "createdAt": "2020-01-24T02:36:58Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/datanode/RunningDatanodeState.java", "diffHunk": "@@ -49,14 +52,62 @@\n   private final SCMConnectionManager connectionManager;\n   private final Configuration conf;\n   private final StateContext context;\n-  private CompletionService<EndpointStateMachine.EndPointStates> ecs;\n+  private CompletionService<EndPointStates> ecs;\n+  /** Cache the end point task per end point per end point state. */\n+  private Map<String, Map<EndPointStates,\n+      Callable<EndPointStates>>> endpointTasks;\n \n   public RunningDatanodeState(Configuration conf,\n       SCMConnectionManager connectionManager,\n       StateContext context) {\n     this.connectionManager = connectionManager;\n     this.conf = conf;\n     this.context = context;\n+    initEndPointTask();\n+  }\n+\n+  /**\n+   * Initialize end point tasks corresponding to each end point,\n+   * each end point state.\n+   */\n+  private void initEndPointTask() {\n+    endpointTasks = new HashMap<String, Map<EndPointStates,\n+        Callable<EndPointStates>>>();\n+    for (EndpointStateMachine endpoint : connectionManager.getValues()) {\n+      Map<EndPointStates, Callable<EndPointStates>> endpointTaskForState\n+          = new HashMap<EndPointStates, Callable<EndPointStates>>();\n+\n+      for (EndPointStates state : EndPointStates.values()) {\n+        Callable<EndPointStates> endPointTask = null;\n+        switch (endpoint.getState()) {\n+        case GETVERSION:\n+          endPointTask = new VersionEndpointTask(endpoint, conf,\n+              context.getParent().getContainer());\n+          break;\n+        case REGISTER:\n+          endPointTask = RegisterEndpointTask.newBuilder()\n+              .setConfig(conf)\n+              .setEndpointStateMachine(endpoint)\n+              .setContext(context)\n+              .setDatanodeDetails(context.getParent().getDatanodeDetails())\n+              .setOzoneContainer(context.getParent().getContainer())\n+              .build();\n+          break;\n+        case HEARTBEAT:\n+          endPointTask = HeartbeatEndpointTask.newBuilder()\n+              .setConfig(conf)\n+              .setEndpointStateMachine(endpoint)\n+              .setDatanodeDetails(context.getParent().getDatanodeDetails())\n+              .setContext(context)\n+              .build();\n+          break;\n+        case SHUTDOWN:\n+          break;\n+        }\n+        endpointTaskForState.put(state, endPointTask);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIyNjUzNw=="}, "originalCommit": {"oid": "0885a2b90b750e756698bdd16304d78429532eef"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4ODM2OTkyOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/datanode/RunningDatanodeState.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNjozNTo0MlrOFhE3Yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwMjozNzoyNlrOFhSnrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIyNzA0Mw==", "bodyText": "Nit: EnumMap is better suited for maps keyed by enums.", "url": "https://github.com/apache/ozone/pull/480#discussion_r370227043", "createdAt": "2020-01-23T16:35:42Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/datanode/RunningDatanodeState.java", "diffHunk": "@@ -49,14 +52,62 @@\n   private final SCMConnectionManager connectionManager;\n   private final Configuration conf;\n   private final StateContext context;\n-  private CompletionService<EndpointStateMachine.EndPointStates> ecs;\n+  private CompletionService<EndPointStates> ecs;\n+  /** Cache the end point task per end point per end point state. */\n+  private Map<String, Map<EndPointStates,\n+      Callable<EndPointStates>>> endpointTasks;\n \n   public RunningDatanodeState(Configuration conf,\n       SCMConnectionManager connectionManager,\n       StateContext context) {\n     this.connectionManager = connectionManager;\n     this.conf = conf;\n     this.context = context;\n+    initEndPointTask();\n+  }\n+\n+  /**\n+   * Initialize end point tasks corresponding to each end point,\n+   * each end point state.\n+   */\n+  private void initEndPointTask() {\n+    endpointTasks = new HashMap<String, Map<EndPointStates,\n+        Callable<EndPointStates>>>();\n+    for (EndpointStateMachine endpoint : connectionManager.getValues()) {\n+      Map<EndPointStates, Callable<EndPointStates>> endpointTaskForState\n+          = new HashMap<EndPointStates, Callable<EndPointStates>>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0885a2b90b750e756698bdd16304d78429532eef"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ1MjM5OQ==", "bodyText": "Have addressed this comment", "url": "https://github.com/apache/ozone/pull/480#discussion_r370452399", "createdAt": "2020-01-24T02:37:26Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/datanode/RunningDatanodeState.java", "diffHunk": "@@ -49,14 +52,62 @@\n   private final SCMConnectionManager connectionManager;\n   private final Configuration conf;\n   private final StateContext context;\n-  private CompletionService<EndpointStateMachine.EndPointStates> ecs;\n+  private CompletionService<EndPointStates> ecs;\n+  /** Cache the end point task per end point per end point state. */\n+  private Map<String, Map<EndPointStates,\n+      Callable<EndPointStates>>> endpointTasks;\n \n   public RunningDatanodeState(Configuration conf,\n       SCMConnectionManager connectionManager,\n       StateContext context) {\n     this.connectionManager = connectionManager;\n     this.conf = conf;\n     this.context = context;\n+    initEndPointTask();\n+  }\n+\n+  /**\n+   * Initialize end point tasks corresponding to each end point,\n+   * each end point state.\n+   */\n+  private void initEndPointTask() {\n+    endpointTasks = new HashMap<String, Map<EndPointStates,\n+        Callable<EndPointStates>>>();\n+    for (EndpointStateMachine endpoint : connectionManager.getValues()) {\n+      Map<EndPointStates, Callable<EndPointStates>> endpointTaskForState\n+          = new HashMap<EndPointStates, Callable<EndPointStates>>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIyNzA0Mw=="}, "originalCommit": {"oid": "0885a2b90b750e756698bdd16304d78429532eef"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4ODM3NTQ3OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/datanode/RunningDatanodeState.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNjozNzowNVrOFhE6uA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwMjozOToxMFrOFhSo1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIyNzg5Ng==", "bodyText": "Can you please explain why a string-based map is better than using the endpoint itself as a key?", "url": "https://github.com/apache/ozone/pull/480#discussion_r370227896", "createdAt": "2020-01-23T16:37:05Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/datanode/RunningDatanodeState.java", "diffHunk": "@@ -98,35 +148,14 @@ public void execute(ExecutorService executor) {\n       }\n     }\n   }\n-  //TODO : Cache some of these tasks instead of creating them\n-  //all the time.\n-  private Callable<EndpointStateMachine.EndPointStates>\n-      getEndPointTask(EndpointStateMachine endpoint) {\n-    switch (endpoint.getState()) {\n-    case GETVERSION:\n-      return new VersionEndpointTask(endpoint, conf, context.getParent()\n-          .getContainer());\n-    case REGISTER:\n-      return  RegisterEndpointTask.newBuilder()\n-          .setConfig(conf)\n-          .setEndpointStateMachine(endpoint)\n-          .setContext(context)\n-          .setDatanodeDetails(context.getParent().getDatanodeDetails())\n-          .setOzoneContainer(context.getParent().getContainer())\n-          .build();\n-    case HEARTBEAT:\n-      return HeartbeatEndpointTask.newBuilder()\n-          .setConfig(conf)\n-          .setEndpointStateMachine(endpoint)\n-          .setDatanodeDetails(context.getParent().getDatanodeDetails())\n-          .setContext(context)\n-          .build();\n-    case SHUTDOWN:\n-      break;\n-    default:\n-      throw new IllegalArgumentException(\"Illegal Argument.\");\n+\n+  private Callable<EndPointStates> getEndPointTask(\n+      EndpointStateMachine endpoint) {\n+    if (endpointTasks.containsKey(endpoint.toString())) {\n+      return endpointTasks.get(endpoint.toString()).get(endpoint.getState());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0885a2b90b750e756698bdd16304d78429532eef"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ1MjY5Mw==", "bodyText": "I just wan to use a more simple identity to indicate the different  Endpoint instance. So I use the endpoint address. But I have updated this to use Endpoint itself now.", "url": "https://github.com/apache/ozone/pull/480#discussion_r370452693", "createdAt": "2020-01-24T02:39:10Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/datanode/RunningDatanodeState.java", "diffHunk": "@@ -98,35 +148,14 @@ public void execute(ExecutorService executor) {\n       }\n     }\n   }\n-  //TODO : Cache some of these tasks instead of creating them\n-  //all the time.\n-  private Callable<EndpointStateMachine.EndPointStates>\n-      getEndPointTask(EndpointStateMachine endpoint) {\n-    switch (endpoint.getState()) {\n-    case GETVERSION:\n-      return new VersionEndpointTask(endpoint, conf, context.getParent()\n-          .getContainer());\n-    case REGISTER:\n-      return  RegisterEndpointTask.newBuilder()\n-          .setConfig(conf)\n-          .setEndpointStateMachine(endpoint)\n-          .setContext(context)\n-          .setDatanodeDetails(context.getParent().getDatanodeDetails())\n-          .setOzoneContainer(context.getParent().getContainer())\n-          .build();\n-    case HEARTBEAT:\n-      return HeartbeatEndpointTask.newBuilder()\n-          .setConfig(conf)\n-          .setEndpointStateMachine(endpoint)\n-          .setDatanodeDetails(context.getParent().getDatanodeDetails())\n-          .setContext(context)\n-          .build();\n-    case SHUTDOWN:\n-      break;\n-    default:\n-      throw new IllegalArgumentException(\"Illegal Argument.\");\n+\n+  private Callable<EndPointStates> getEndPointTask(\n+      EndpointStateMachine endpoint) {\n+    if (endpointTasks.containsKey(endpoint.toString())) {\n+      return endpointTasks.get(endpoint.toString()).get(endpoint.getState());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIyNzg5Ng=="}, "originalCommit": {"oid": "0885a2b90b750e756698bdd16304d78429532eef"}, "originalPosition": 128}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4987, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}