{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0Mjc5OTgz", "number": 1163, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMzowMDoyN1rOEL3n9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMzoxNjo0OVrOEL30ZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwODgxMTQxOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMzowMDoyN1rOGtpqzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwODozODoyMlrOGvHXSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyMTgwNg==", "bodyText": "Can we use nodeStateManager.getNode(datanodeDetails) to avoid the UUID->String->UUID conversion?", "url": "https://github.com/apache/ozone/pull/1163#discussion_r450521806", "createdAt": "2020-07-06T23:00:27Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java", "diffHunk": "@@ -260,12 +260,21 @@ public RegisteredCommand register(\n       if (networkLocation != null) {\n         datanodeDetails.setNetworkLocation(networkLocation);\n       }\n-      nodeStateManager.addNode(datanodeDetails);\n-      clusterMap.add(datanodeDetails);\n-      addEntryTodnsToUuidMap(dnsName, datanodeDetails.getUuidString());\n-      // Updating Node Report, as registration is successful\n-      processNodeReport(datanodeDetails, nodeReport);\n-      LOG.info(\"Registered Data node : {}\", datanodeDetails);\n+      if (!isNodeRegistered(datanodeDetails)) {\n+        clusterMap.add(datanodeDetails);\n+        nodeStateManager.addNode(datanodeDetails);\n+        // Check that datanode in nodeStateManager has topology parent set\n+        DatanodeDetails dn =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf28429e442adb66f4f5b0055ccfbe04c4cc483d"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA1NjkwNw==", "bodyText": "Sure.", "url": "https://github.com/apache/ozone/pull/1163#discussion_r452056907", "createdAt": "2020-07-09T08:38:22Z", "author": {"login": "ChenSammi"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java", "diffHunk": "@@ -260,12 +260,21 @@ public RegisteredCommand register(\n       if (networkLocation != null) {\n         datanodeDetails.setNetworkLocation(networkLocation);\n       }\n-      nodeStateManager.addNode(datanodeDetails);\n-      clusterMap.add(datanodeDetails);\n-      addEntryTodnsToUuidMap(dnsName, datanodeDetails.getUuidString());\n-      // Updating Node Report, as registration is successful\n-      processNodeReport(datanodeDetails, nodeReport);\n-      LOG.info(\"Registered Data node : {}\", datanodeDetails);\n+      if (!isNodeRegistered(datanodeDetails)) {\n+        clusterMap.add(datanodeDetails);\n+        nodeStateManager.addNode(datanodeDetails);\n+        // Check that datanode in nodeStateManager has topology parent set\n+        DatanodeDetails dn =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyMTgwNg=="}, "originalCommit": {"oid": "cf28429e442adb66f4f5b0055ccfbe04c4cc483d"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwODgyOTE4OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMzowOTo0NVrOGtp1aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwODo0NToyMFrOGvHnZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyNDUyMw==", "bodyText": "Can we move isNodeRegistered check at the begin of register() to avoid unnecessary dnsname lookup?", "url": "https://github.com/apache/ozone/pull/1163#discussion_r450524523", "createdAt": "2020-07-06T23:09:45Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java", "diffHunk": "@@ -260,12 +260,21 @@ public RegisteredCommand register(\n       if (networkLocation != null) {\n         datanodeDetails.setNetworkLocation(networkLocation);\n       }\n-      nodeStateManager.addNode(datanodeDetails);\n-      clusterMap.add(datanodeDetails);\n-      addEntryTodnsToUuidMap(dnsName, datanodeDetails.getUuidString());\n-      // Updating Node Report, as registration is successful\n-      processNodeReport(datanodeDetails, nodeReport);\n-      LOG.info(\"Registered Data node : {}\", datanodeDetails);\n+      if (!isNodeRegistered(datanodeDetails)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf28429e442adb66f4f5b0055ccfbe04c4cc483d"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA2MTAzMA==", "bodyText": "Sure.", "url": "https://github.com/apache/ozone/pull/1163#discussion_r452061030", "createdAt": "2020-07-09T08:45:20Z", "author": {"login": "ChenSammi"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/node/SCMNodeManager.java", "diffHunk": "@@ -260,12 +260,21 @@ public RegisteredCommand register(\n       if (networkLocation != null) {\n         datanodeDetails.setNetworkLocation(networkLocation);\n       }\n-      nodeStateManager.addNode(datanodeDetails);\n-      clusterMap.add(datanodeDetails);\n-      addEntryTodnsToUuidMap(dnsName, datanodeDetails.getUuidString());\n-      // Updating Node Report, as registration is successful\n-      processNodeReport(datanodeDetails, nodeReport);\n-      LOG.info(\"Registered Data node : {}\", datanodeDetails);\n+      if (!isNodeRegistered(datanodeDetails)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyNDUyMw=="}, "originalCommit": {"oid": "cf28429e442adb66f4f5b0055ccfbe04c4cc483d"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwODg0MzI1OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerReportHandler.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMzoxNjo0OVrOGtp9sQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwMzo1OTozNFrOGvpHUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyNjY0MQ==", "bodyText": "When SCM does not have information about a datanode, it is usually the datanode is dead. So skip processing those delayed report makes sense to me .", "url": "https://github.com/apache/ozone/pull/1163#discussion_r450526641", "createdAt": "2020-07-06T23:16:49Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerReportHandler.java", "diffHunk": "@@ -102,8 +102,15 @@ public ContainerReportHandler(final NodeManager nodeManager,\n   public void onMessage(final ContainerReportFromDatanode reportFromDatanode,\n                         final EventPublisher publisher) {\n \n-    final DatanodeDetails datanodeDetails =\n+    final DatanodeDetails dnFromReport =\n         reportFromDatanode.getDatanodeDetails();\n+    DatanodeDetails datanodeDetails =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf28429e442adb66f4f5b0055ccfbe04c4cc483d"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA2NDA5Nw==", "bodyText": "Xiaoyu, the key point here is we need the DatanodeDetails object from the nodeManager which has topology parent  correctly set.  The DatanodeDetails object parsed from container report always has no parent which will make the Replication Manager treat it as a datanode under /default-rack, further treat the container as under-replicated since cross rack requirement is not satisfied.", "url": "https://github.com/apache/ozone/pull/1163#discussion_r452064097", "createdAt": "2020-07-09T08:50:27Z", "author": {"login": "ChenSammi"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerReportHandler.java", "diffHunk": "@@ -102,8 +102,15 @@ public ContainerReportHandler(final NodeManager nodeManager,\n   public void onMessage(final ContainerReportFromDatanode reportFromDatanode,\n                         final EventPublisher publisher) {\n \n-    final DatanodeDetails datanodeDetails =\n+    final DatanodeDetails dnFromReport =\n         reportFromDatanode.getDatanodeDetails();\n+    DatanodeDetails datanodeDetails =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyNjY0MQ=="}, "originalCommit": {"oid": "cf28429e442adb66f4f5b0055ccfbe04c4cc483d"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYwOTg3Mg==", "bodyText": "That's a good catch. Thanks for the details.", "url": "https://github.com/apache/ozone/pull/1163#discussion_r452609872", "createdAt": "2020-07-10T03:59:34Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerReportHandler.java", "diffHunk": "@@ -102,8 +102,15 @@ public ContainerReportHandler(final NodeManager nodeManager,\n   public void onMessage(final ContainerReportFromDatanode reportFromDatanode,\n                         final EventPublisher publisher) {\n \n-    final DatanodeDetails datanodeDetails =\n+    final DatanodeDetails dnFromReport =\n         reportFromDatanode.getDatanodeDetails();\n+    DatanodeDetails datanodeDetails =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUyNjY0MQ=="}, "originalCommit": {"oid": "cf28429e442adb66f4f5b0055ccfbe04c4cc483d"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4164, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}