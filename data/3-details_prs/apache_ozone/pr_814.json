{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyNTc0NDMy", "number": 814, "title": "HDDS-3286. BasicOzoneFileSystem  support batchDelete.", "bodyText": "What changes were proposed in this pull request?\nCurrently delete file is to get all the keys in the directory, and then delete one by one. This makes for poor performance.\nBy tested the deletion directory with 100,000 files, which took 3718.70 sec. And rename it took 7327.936 sec.\nUsing this PR, when batch-size is set to 100, the time of delete and rename's directory of 100,000  files is 62.498 sec and 46.002 sec. Performance improved nearly 100 times\u3002\nRename has the same problem, and I'll add rename to the other PR.\n##What is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3286\nHow was this patch tested?\nAdded UT\nExisting acceptance tests.", "createdAt": "2020-04-13T10:07:37Z", "url": "https://github.com/apache/ozone/pull/814", "merged": true, "mergeCommit": {"oid": "a5556d34365e3bd377f95805e358efdfe9717a8c"}, "closed": true, "closedAt": "2020-06-23T21:21:51Z", "author": {"login": "captainzmc"}, "timelineItems": {"totalCount": 35, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXSOxbAFqTM5MjI0MjQ2MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuBrpvgBqjM0NzE5MjE2NjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMjQyNDYx", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-392242461", "createdAt": "2020-04-13T16:04:45Z", "commit": {"oid": "e66bfea7fe596682d386b78d37af2d67c1cb6900"}, "state": "COMMENTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNjowNDo0NVrOGErYBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzoxOTowMFrOGEt1qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU1ODE0OA==", "bodyText": "Can you please rephrase java comment conveying the list of keys. How about something like below,\n\"Deletes the given list of keys from the bucket\"", "url": "https://github.com/apache/ozone/pull/814#discussion_r407558148", "createdAt": "2020-04-13T16:04:45Z", "author": {"login": "rakeshadr"}, "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneBucket.java", "diffHunk": "@@ -382,11 +382,25 @@ public void deleteKey(String key) throws IOException {\n     proxy.deleteKey(volumeName, name, key);\n   }\n \n+  /**\n+   * Deletes key from the bucket.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e66bfea7fe596682d386b78d37af2d67c1cb6900"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU1ODUwMA==", "bodyText": "Please add javadoc.", "url": "https://github.com/apache/ozone/pull/814#discussion_r407558500", "createdAt": "2020-04-13T16:05:24Z", "author": {"login": "rakeshadr"}, "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneBucket.java", "diffHunk": "@@ -382,11 +382,25 @@ public void deleteKey(String key) throws IOException {\n     proxy.deleteKey(volumeName, name, key);\n   }\n \n+  /**\n+   * Deletes key from the bucket.\n+   * @param keyList List of the key name to be deleted.\n+   * @throws IOException\n+   */\n+  public void deleteKeyList(List<String> keyList) throws IOException {\n+    proxy.deleteKeyList(volumeName, name, keyList);\n+  }\n+\n   public void renameKey(String fromKeyName, String toKeyName)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e66bfea7fe596682d386b78d37af2d67c1cb6900"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2MTE2Mg==", "bodyText": "Can we follow naming convention for the collection APIs?\nHow about something like below. The same comment applicable to delete list api as well.\n#renameKeys\n#deleteKeys", "url": "https://github.com/apache/ozone/pull/814#discussion_r407561162", "createdAt": "2020-04-13T16:10:23Z", "author": {"login": "rakeshadr"}, "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneBucket.java", "diffHunk": "@@ -382,11 +382,25 @@ public void deleteKey(String key) throws IOException {\n     proxy.deleteKey(volumeName, name, key);\n   }\n \n+  /**\n+   * Deletes key from the bucket.\n+   * @param keyList List of the key name to be deleted.\n+   * @throws IOException\n+   */\n+  public void deleteKeyList(List<String> keyList) throws IOException {\n+    proxy.deleteKeyList(volumeName, name, keyList);\n+  }\n+\n   public void renameKey(String fromKeyName, String toKeyName)\n       throws IOException {\n     proxy.renameKey(volumeName, name, fromKeyName, toKeyName);\n   }\n \n+  public void renameKey(Map<String, String> keyMap)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e66bfea7fe596682d386b78d37af2d67c1cb6900"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2MzE0MQ==", "bodyText": "The above comment naming convention exists here as well. Please take care the same in all applicable places. Thanks!", "url": "https://github.com/apache/ozone/pull/814#discussion_r407563141", "createdAt": "2020-04-13T16:13:56Z", "author": {"login": "rakeshadr"}, "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/protocol/ClientProtocol.java", "diffHunk": "@@ -288,6 +288,17 @@ OzoneInputStream getKey(String volumeName, String bucketName, String keyName)\n   void deleteKey(String volumeName, String bucketName, String keyName)\n       throws IOException;\n \n+  /**\n+   * Deletes key List.\n+   * @param volumeName Name of the Volume\n+   * @param bucketName Name of the Bucket\n+   * @param keyNameList List of the Key\n+   * @throws IOException\n+   */\n+  void deleteKeyList(String volumeName, String bucketName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e66bfea7fe596682d386b78d37af2d67c1cb6900"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU2ODk1Mw==", "bodyText": "Do we need String keyName argument ? Can you please incorporate String keyName argument into the keyNameList argument, something similar you have very well refactored for keyNameList.add(keyName); in deleteKey api.", "url": "https://github.com/apache/ozone/pull/814#discussion_r407568953", "createdAt": "2020-04-13T16:24:50Z", "author": {"login": "rakeshadr"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyArgs.java", "diffHunk": "@@ -70,6 +72,8 @@ private OmKeyArgs(String volumeName, String bucketName, String keyName,\n     this.refreshPipeline = refreshPipeline;\n     this.acls = acls;\n     this.sortDatanodesInPipeline = sortDatanode;\n+    this.keyNameList = keyNameList;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e66bfea7fe596682d386b78d37af2d67c1cb6900"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU3MzQwNA==", "bodyText": "Please correct indentation after == symbol.  if (keyNameList.size() == 0) {", "url": "https://github.com/apache/ozone/pull/814#discussion_r407573404", "createdAt": "2020-04-13T16:32:43Z", "author": {"login": "rakeshadr"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyDeleteRequest.java", "diffHunk": "@@ -116,51 +119,53 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n     boolean acquiredLock = false;\n     OMClientResponse omClientResponse = null;\n     Result result = null;\n+    List<OmKeyInfo> omKeyInfoList= new ArrayList<>();\n     try {\n-      // check Acl\n-      checkKeyAcls(ozoneManager, volumeName, bucketName, keyName,\n-          IAccessAuthorizer.ACLType.DELETE, OzoneObj.ResourceType.KEY);\n-\n-      String objectKey = omMetadataManager.getOzoneKey(\n-          volumeName, bucketName, keyName);\n-\n+      if (keyNameList.size() ==0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e66bfea7fe596682d386b78d37af2d67c1cb6900"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU4MTM3MQ==", "bodyText": "What if one of the key not found in the list of keys and assume there are 10keys and the 5th key not found. What is the contract batch api provides executes all or executes till first failure or none of them ?\nPlease consider Check if this transaction is a replay of ratis logs. this validation check also or any other exception. As there is no strict recommendations, I'm keeping this open for discussions:-).", "url": "https://github.com/apache/ozone/pull/814#discussion_r407581371", "createdAt": "2020-04-13T16:47:36Z", "author": {"login": "rakeshadr"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyDeleteRequest.java", "diffHunk": "@@ -116,51 +119,53 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n     boolean acquiredLock = false;\n     OMClientResponse omClientResponse = null;\n     Result result = null;\n+    List<OmKeyInfo> omKeyInfoList= new ArrayList<>();\n     try {\n-      // check Acl\n-      checkKeyAcls(ozoneManager, volumeName, bucketName, keyName,\n-          IAccessAuthorizer.ACLType.DELETE, OzoneObj.ResourceType.KEY);\n-\n-      String objectKey = omMetadataManager.getOzoneKey(\n-          volumeName, bucketName, keyName);\n-\n+      if (keyNameList.size() ==0) {\n+        throw new OMException(\"Key not found\", KEY_NOT_FOUND);\n+      }\n       acquiredLock = omMetadataManager.getLock().acquireWriteLock(BUCKET_LOCK,\n-          volumeName, bucketName);\n-\n+              volumeName, bucketName);\n       // Validate bucket and volume exists or not.\n       validateBucketAndVolume(omMetadataManager, volumeName, bucketName);\n-\n-      OmKeyInfo omKeyInfo = omMetadataManager.getKeyTable().get(objectKey);\n-      if (omKeyInfo == null) {\n-        throw new OMException(\"Key not found\", KEY_NOT_FOUND);\n+      Table<String, OmKeyInfo> keyTable = omMetadataManager.getKeyTable();\n+      for (String keyName : keyNameList) {\n+        // check Acl\n+        checkKeyAcls(ozoneManager, volumeName, bucketName, keyName,\n+                IAccessAuthorizer.ACLType.DELETE, OzoneObj.ResourceType.KEY);\n+        String objectKey = omMetadataManager.getOzoneKey(\n+                volumeName, bucketName, keyName);\n+        OmKeyInfo omKeyInfo = keyTable.get(objectKey);\n+        if (omKeyInfo == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e66bfea7fe596682d386b78d37af2d67c1cb6900"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU4ODE5OA==", "bodyText": "Above comment is applicable renamekeys as well.\nWhat if one of the key not found in the list of keys and assume there are 10keys and the 5th key not found. What is the contract batch api provides executes all or executes till first failure or none of them ?", "url": "https://github.com/apache/ozone/pull/814#discussion_r407588198", "createdAt": "2020-04-13T16:59:39Z", "author": {"login": "rakeshadr"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyRenameRequest.java", "diffHunk": "@@ -127,112 +131,124 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n     OmKeyInfo fromKeyValue = null;\n     String toKey = null, fromKey = null;\n     Result result = null;\n+    List<RenameInfo> renameInfoList = new ArrayList<>();\n     try {\n-      if (toKeyName.length() == 0 || fromKeyName.length() == 0) {\n-        throw new OMException(\"Key name is empty\",\n-            OMException.ResultCodes.INVALID_KEY_NAME);\n+      if (renameKeyMap.size() == 0) {\n+        throw new OMException(\"Key not found \" + fromKey, KEY_NOT_FOUND);\n       }\n-      // check Acls to see if user has access to perform delete operation on\n-      // old key and create operation on new key\n-      checkKeyAcls(ozoneManager, volumeName, bucketName, fromKeyName,\n-          IAccessAuthorizer.ACLType.DELETE, OzoneObj.ResourceType.KEY);\n-      checkKeyAcls(ozoneManager, volumeName, bucketName, toKeyName,\n-          IAccessAuthorizer.ACLType.CREATE, OzoneObj.ResourceType.KEY);\n-\n       acquiredLock = omMetadataManager.getLock().acquireWriteLock(BUCKET_LOCK,\n-          volumeName, bucketName);\n-\n-      // Validate bucket and volume exists or not.\n-      validateBucketAndVolume(omMetadataManager, volumeName, bucketName);\n-\n-      // Check if toKey exists\n-      fromKey = omMetadataManager.getOzoneKey(volumeName, bucketName,\n-          fromKeyName);\n-      toKey = omMetadataManager.getOzoneKey(volumeName, bucketName, toKeyName);\n-      OmKeyInfo toKeyValue = omMetadataManager.getKeyTable().get(toKey);\n-\n-      if (toKeyValue != null) {\n-\n-        // Check if this transaction is a replay of ratis logs.\n-        if (isReplay(ozoneManager, toKeyValue, trxnLogIndex)) {\n-\n-          // Check if fromKey is still in the DB and created before this\n-          // replay.\n-          // For example, lets say we have the following sequence of\n-          // transactions.\n-          //     Trxn 1 : Create Key1\n-          //     Trnx 2 : Rename Key1 to Key2 -> Deletes Key1 and Creates Key2\n-          // Now if these transactions are replayed:\n-          //     Replay Trxn 1 : Creates Key1 again as Key1 does not exist in DB\n-          //     Replay Trxn 2 : Key2 is not created as it exists in DB and the\n-          //                     request would be deemed a replay. But Key1\n-          //                     is still in the DB and needs to be deleted.\n-          fromKeyValue = omMetadataManager.getKeyTable().get(fromKey);\n-          if (fromKeyValue != null) {\n-            // Check if this replay transaction was after the fromKey was\n-            // created. If so, we have to delete the fromKey.\n-            if (ozoneManager.isRatisEnabled() &&\n-                trxnLogIndex > fromKeyValue.getUpdateID()) {\n-              // Add to cache. Only fromKey should be deleted. ToKey already\n-              // exists in DB as this transaction is a replay.\n-              result = Result.DELETE_FROM_KEY_ONLY;\n-              Table<String, OmKeyInfo> keyTable = omMetadataManager\n-                  .getKeyTable();\n-              keyTable.addCacheEntry(new CacheKey<>(fromKey),\n-                  new CacheValue<>(Optional.absent(), trxnLogIndex));\n+              volumeName, bucketName);\n+      for (Map.Entry<String, String> renameKeyEntry : renameKeyMap.entrySet()) {\n+        String fromKeyName = renameKeyEntry.getKey();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e66bfea7fe596682d386b78d37af2d67c1cb6900"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5MDg4MQ==", "bodyText": "Should we need fromKey member variable? Is this duplicate info and we can get it from fromKeyValue.getKeyName(); , right?", "url": "https://github.com/apache/ozone/pull/814#discussion_r407590881", "createdAt": "2020-04-13T17:04:52Z", "author": {"login": "rakeshadr"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/RenameInfo.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.om.helpers;\n+\n+/**\n+ * The data interface needed to the rename operation.\n+ */\n+public class RenameInfo {\n+  private String  fromKey;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e66bfea7fe596682d386b78d37af2d67c1cb6900"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5MTQzNA==", "bodyText": "Can we dofromKeyValue.getKeyName();?", "url": "https://github.com/apache/ozone/pull/814#discussion_r407591434", "createdAt": "2020-04-13T17:05:56Z", "author": {"login": "rakeshadr"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/RenameInfo.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.om.helpers;\n+\n+/**\n+ * The data interface needed to the rename operation.\n+ */\n+public class RenameInfo {\n+  private String  fromKey;\n+  private  OmKeyInfo fromKeyValue;\n+  private String toKey;\n+\n+  public RenameInfo(String fromKey, OmKeyInfo fromKeyValue, String toKey) {\n+    this.fromKey = fromKey;\n+    this.fromKeyValue = fromKeyValue;\n+    this.toKey = toKey;\n+  }\n+\n+  public String getFromKey() {\n+    return fromKey;\n+  }\n+\n+  public OmKeyInfo getFromKeyValue() {\n+    return fromKeyValue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e66bfea7fe596682d386b78d37af2d67c1cb6900"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5Njg5Nw==", "bodyText": "Instead of hard coding, can you do OzoneConfigKeys.OZONE_FS_ITERATE_BATCH_SIZE ?", "url": "https://github.com/apache/ozone/pull/814#discussion_r407596897", "createdAt": "2020-04-13T17:15:59Z", "author": {"login": "rakeshadr"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java", "diffHunk": "@@ -748,19 +751,34 @@ public String toString() {\n      */\n     boolean iterate() throws IOException {\n       LOG.trace(\"Iterating path {}\", path);\n+      List<String> keyList = new ArrayList<>();\n       if (status.isDirectory()) {\n         LOG.trace(\"Iterating directory:{}\", pathKey);\n         while (keyIterator.hasNext()) {\n           BasicKeyInfo key = keyIterator.next();\n           LOG.trace(\"iterating key:{}\", key.getName());\n-          if (!processKey(key.getName())) {\n+          if (!key.getName().equals(\"\")) {\n+            keyList.add(key.getName());\n+          }\n+          int batchSize = getConf().getInt(\"ozone.fs.iterate.batch-size\", 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e66bfea7fe596682d386b78d37af2d67c1cb6900"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5ODUwNg==", "bodyText": "General comment for both delete and rename batch apis.\nPlease add some test cases with all, partial, no success behaviors. Thanks!", "url": "https://github.com/apache/ozone/pull/814#discussion_r407598506", "createdAt": "2020-04-13T17:19:00Z", "author": {"login": "rakeshadr"}, "path": "hadoop-ozone/ozone-manager/src/test/java/org/apache/hadoop/ozone/om/request/key/TestOMKeyRenameRequest.java", "diffHunk": "@@ -327,11 +331,13 @@ private OMRequest doPreExecute(OMRequest originalOmRequest) throws Exception {\n    * @return OMRequest\n    */\n   private OMRequest createRenameKeyRequest(String toKeyName) {\n-    KeyArgs keyArgs = KeyArgs.newBuilder().setKeyName(keyName)\n+    Map<String, String> renameKeyMap = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e66bfea7fe596682d386b78d37af2d67c1cb6900"}, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e66bfea7fe596682d386b78d37af2d67c1cb6900", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/e66bfea7fe596682d386b78d37af2d67c1cb6900", "committedDate": "2020-04-13T09:59:28Z", "message": "fix ut and checkstyle"}, "afterCommit": {"oid": "c927d2b98b663d7c052683b9fd5ea2c416e04933", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/c927d2b98b663d7c052683b9fd5ea2c416e04933", "committedDate": "2020-05-18T13:14:15Z", "message": "BasicOzoneFileSystem support batchDelete and batchRename"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c927d2b98b663d7c052683b9fd5ea2c416e04933", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/c927d2b98b663d7c052683b9fd5ea2c416e04933", "committedDate": "2020-05-18T13:14:15Z", "message": "BasicOzoneFileSystem support batchDelete and batchRename"}, "afterCommit": {"oid": "6208606e7e1a81663889901b98f13335d392c101", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/6208606e7e1a81663889901b98f13335d392c101", "committedDate": "2020-05-19T06:38:25Z", "message": "BasicOzoneFileSystem support batchDelete"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NzAxNzg2", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-416701786", "createdAt": "2020-05-22T07:26:00Z", "commit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNzoyNjowMFrOGZNUMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNzoyNjowMFrOGZNUMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4NTc0NQ==", "bodyText": "Can we have a list of KeyArgs here?", "url": "https://github.com/apache/ozone/pull/814#discussion_r429085745", "createdAt": "2020-05-22T07:26:00Z", "author": {"login": "timmylicheng"}, "path": "hadoop-ozone/common/src/main/proto/OzoneManagerProtocol.proto", "diffHunk": "@@ -830,7 +832,7 @@ message LookupKeyResponse {\n \n message RenameKeyRequest{\n     required KeyArgs keyArgs = 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NzAxOTk0", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-416701994", "createdAt": "2020-05-22T07:26:28Z", "commit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNzoyNjoyOFrOGZNU0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNzoyNjoyOFrOGZNU0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4NTkwNA==", "bodyText": "Why not remain KeyArgs as for single key?", "url": "https://github.com/apache/ozone/pull/814#discussion_r429085904", "createdAt": "2020-05-22T07:26:28Z", "author": {"login": "timmylicheng"}, "path": "hadoop-ozone/common/src/main/proto/OzoneManagerProtocol.proto", "diffHunk": "@@ -695,6 +695,8 @@ message KeyArgs {\n \n     // This will be set by leader OM in HA and update the original request.\n     optional FileEncryptionInfoProto fileEncryptionInfo = 15;\n+    // This is a key list to support the batch operation of keys.\n+    repeated string keyNames = 16;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NzAyMTYw", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-416702160", "createdAt": "2020-05-22T07:26:47Z", "commit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNzoyNjo0N1rOGZNVTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNzoyNjo0N1rOGZNVTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4NjAyOQ==", "bodyText": "Can we use repeated KeyArgs here?", "url": "https://github.com/apache/ozone/pull/814#discussion_r429086029", "createdAt": "2020-05-22T07:26:47Z", "author": {"login": "timmylicheng"}, "path": "hadoop-ozone/common/src/main/proto/OzoneManagerProtocol.proto", "diffHunk": "@@ -848,6 +850,7 @@ message DeleteKeyResponse {\n     // (similar to a cookie).\n     optional uint64 ID = 3;\n     optional uint64 openVersion = 4;\n+    repeated KeyInfo keyInfoList = 5;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NzA0MjAy", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-416704202", "createdAt": "2020-05-22T07:30:32Z", "commit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNzozMDozM1rOGZNbZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNzozMDozM1rOGZNbZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4NzU5MQ==", "bodyText": "We need to iterate all omKeyInfo in the list as well here", "url": "https://github.com/apache/ozone/pull/814#discussion_r429087591", "createdAt": "2020-05-22T07:30:33Z", "author": {"login": "timmylicheng"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyDeleteRequest.java", "diffHunk": "@@ -111,51 +114,53 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n     boolean acquiredLock = false;\n     OMClientResponse omClientResponse = null;\n     Result result = null;\n+    List<OmKeyInfo> omKeyInfoList= new ArrayList<>();\n     try {\n-      // check Acl\n-      checkKeyAcls(ozoneManager, volumeName, bucketName, keyName,\n-          IAccessAuthorizer.ACLType.DELETE, OzoneObj.ResourceType.KEY);\n-\n-      String objectKey = omMetadataManager.getOzoneKey(\n-          volumeName, bucketName, keyName);\n-\n+      if (keyNameList.size() == 0) {\n+        throw new OMException(\"Key not found\", KEY_NOT_FOUND);\n+      }\n       acquiredLock = omMetadataManager.getLock().acquireWriteLock(BUCKET_LOCK,\n-          volumeName, bucketName);\n-\n+              volumeName, bucketName);\n       // Validate bucket and volume exists or not.\n       validateBucketAndVolume(omMetadataManager, volumeName, bucketName);\n-\n-      OmKeyInfo omKeyInfo = omMetadataManager.getKeyTable().get(objectKey);\n-      if (omKeyInfo == null) {\n-        throw new OMException(\"Key not found\", KEY_NOT_FOUND);\n+      Table<String, OmKeyInfo> keyTable = omMetadataManager.getKeyTable();\n+      for (String keyName : keyNameList) {\n+        // check Acl\n+        checkKeyAcls(ozoneManager, volumeName, bucketName, keyName,\n+                IAccessAuthorizer.ACLType.DELETE, OzoneObj.ResourceType.KEY);\n+        String objectKey = omMetadataManager.getOzoneKey(\n+                volumeName, bucketName, keyName);\n+        OmKeyInfo omKeyInfo = keyTable.get(objectKey);\n+        if (omKeyInfo == null) {\n+          throw new OMException(\"Key not found\", KEY_NOT_FOUND);\n+        }\n+\n+        // Check if this transaction is a replay of ratis logs.\n+        if (isReplay(ozoneManager, omKeyInfo, trxnLogIndex)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NzA1ODQx", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-416705841", "createdAt": "2020-05-22T07:33:42Z", "commit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNzozMzo0MlrOGZNgZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNzozMzo0MlrOGZNgZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4ODg3MQ==", "bodyText": "Not related to this class. But you wanna visit TestOzoneManagerHAWithData and see if HA needs a test case for deleting a list of keys.", "url": "https://github.com/apache/ozone/pull/814#discussion_r429088871", "createdAt": "2020-05-22T07:33:42Z", "author": {"login": "timmylicheng"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/fs/ozone/TestOzoneFileSystem.java", "diffHunk": "@@ -157,6 +159,7 @@ public void testFileSystem() throws Exception {\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NzA2MTg2", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-416706186", "createdAt": "2020-05-22T07:34:24Z", "commit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNzozNDoyNFrOGZNhdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNzozNDoyNFrOGZNhdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA4OTE0MQ==", "bodyText": "Why do we keep keyName and keyNameList at the same time?", "url": "https://github.com/apache/ozone/pull/814#discussion_r429089141", "createdAt": "2020-05-22T07:34:24Z", "author": {"login": "timmylicheng"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyArgs.java", "diffHunk": "@@ -256,11 +263,16 @@ public Builder setSortDatanodesInPipeline(boolean sort) {\n       return this;\n     }\n \n+    public Builder setKeyNameList(List<String> keyList) {\n+      this.keyNameList = keyList;\n+      return this;\n+    }\n+\n     public OmKeyArgs build() {\n       return new OmKeyArgs(volumeName, bucketName, keyName, dataSize, type,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NzE0NDMw", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-416714430", "createdAt": "2020-05-22T07:49:14Z", "commit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNzo0OToxNVrOGZN6gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNzo0OToxNVrOGZN6gQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA5NTU1Mw==", "bodyText": "It would be great if we add a failure case here like there is an unknown key in a list of known keys. We would like to also test exceptions.", "url": "https://github.com/apache/ozone/pull/814#discussion_r429095553", "createdAt": "2020-05-22T07:49:15Z", "author": {"login": "timmylicheng"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/fs/ozone/TestOzoneFileSystem.java", "diffHunk": "@@ -248,6 +253,34 @@ private void testDeleteCreatesFakeParentDir() throws Exception {\n     assertEquals(parentKey, parentKeyInfo.getName());\n   }\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MDM0NTY5", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-417034569", "createdAt": "2020-05-22T16:24:48Z", "commit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjoyNDo0OFrOGZc2Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjoyNDo0OFrOGZc2Og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0MDIxOA==", "bodyText": "Change required to option will be an incompatible change.", "url": "https://github.com/apache/ozone/pull/814#discussion_r429340218", "createdAt": "2020-05-22T16:24:48Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/common/src/main/proto/OzoneManagerProtocol.proto", "diffHunk": "@@ -677,7 +677,7 @@ message ListBucketsResponse {\n message KeyArgs {\n     required string volumeName = 1;\n     required string bucketName = 2;\n-    required string keyName = 3;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MDM2MTMx", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-417036131", "createdAt": "2020-05-22T16:27:15Z", "commit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjoyNzoxNlrOGZc69Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjoyNzoxNlrOGZc69Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0MTQyOQ==", "bodyText": "why do we need to change toKeyName from required to optional?", "url": "https://github.com/apache/ozone/pull/814#discussion_r429341429", "createdAt": "2020-05-22T16:27:16Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/common/src/main/proto/OzoneManagerProtocol.proto", "diffHunk": "@@ -830,7 +832,7 @@ message LookupKeyResponse {\n \n message RenameKeyRequest{\n     required KeyArgs keyArgs = 1;\n-    required string toKeyName = 2;\n+    optional string toKeyName = 2;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MDM4MDQ0", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-417038044", "createdAt": "2020-05-22T16:30:10Z", "commit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjozMDoxMFrOGZdAbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjozMDoxMFrOGZdAbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0MjgyOQ==", "bodyText": "When we delete a list of keys, upon failure in the middle, can we return a list of deleted keys and undeleted keys? This may not be an issue when you delete a single key but when batch deleting, it is hard to recover from the failures without that information.", "url": "https://github.com/apache/ozone/pull/814#discussion_r429342829", "createdAt": "2020-05-22T16:30:10Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneBucket.java", "diffHunk": "@@ -382,6 +382,21 @@ public void deleteKey(String key) throws IOException {\n     proxy.deleteKey(volumeName, name, key);\n   }\n \n+  /**\n+   * Deletes the given list of keys from the bucket.\n+   * @param keyList List of the key name to be deleted.\n+   * @throws IOException\n+   */\n+  public void deleteKeys(List<String> keyList) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MDQwNzkw", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-417040790", "createdAt": "2020-05-22T16:34:36Z", "commit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjozNDozNlrOGZdIRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjozNDozNlrOGZdIRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0NDgzNw==", "bodyText": "This is OK with o3fs as we will mount a single bucket. In the context of ofs where you can have multiple volume buckets under the root. This lock can't guarantee atomic across all the delete keyname list.", "url": "https://github.com/apache/ozone/pull/814#discussion_r429344837", "createdAt": "2020-05-22T16:34:36Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyDeleteRequest.java", "diffHunk": "@@ -111,51 +114,53 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n     boolean acquiredLock = false;\n     OMClientResponse omClientResponse = null;\n     Result result = null;\n+    List<OmKeyInfo> omKeyInfoList= new ArrayList<>();\n     try {\n-      // check Acl\n-      checkKeyAcls(ozoneManager, volumeName, bucketName, keyName,\n-          IAccessAuthorizer.ACLType.DELETE, OzoneObj.ResourceType.KEY);\n-\n-      String objectKey = omMetadataManager.getOzoneKey(\n-          volumeName, bucketName, keyName);\n-\n+      if (keyNameList.size() == 0) {\n+        throw new OMException(\"Key not found\", KEY_NOT_FOUND);\n+      }\n       acquiredLock = omMetadataManager.getLock().acquireWriteLock(BUCKET_LOCK,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MDQyNjM3", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-417042637", "createdAt": "2020-05-22T16:37:41Z", "commit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjozNzo0MVrOGZdNaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjozNzo0MVrOGZdNaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0NjE1NQ==", "bodyText": "This will only print the address of the keNameList. You may want to expand the list and also protect the LOG.debug with a if LOG.isDebugEnabled().", "url": "https://github.com/apache/ozone/pull/814#discussion_r429346155", "createdAt": "2020-05-22T16:37:41Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyDeleteRequest.java", "diffHunk": "@@ -187,7 +192,7 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n     case SUCCESS:\n       omMetrics.decNumKeys();\n       LOG.debug(\"Key deleted. Volume:{}, Bucket:{}, Key:{}\", volumeName,\n-          bucketName, keyName);\n+          bucketName, keyNameList);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "originalPosition": 120}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MDQzMTky", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-417043192", "createdAt": "2020-05-22T16:38:34Z", "commit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjozODozNFrOGZdPDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjozODozNFrOGZdPDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0NjU3NQ==", "bodyText": "same as above. we might only want to print the key that failed in the deletion instead of the whole list upon failures. print the whole list can be a debug or trace level log.", "url": "https://github.com/apache/ozone/pull/814#discussion_r429346575", "createdAt": "2020-05-22T16:38:34Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyDeleteRequest.java", "diffHunk": "@@ -196,7 +201,7 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n     case FAILURE:\n       omMetrics.incNumKeyDeleteFails();\n       LOG.error(\"Key delete failed. Volume:{}, Bucket:{}, Key{}. Exception:{}\",\n-          volumeName, bucketName, keyName, exception);\n+          volumeName, bucketName, keyNameList, exception);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "originalPosition": 129}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MDQ4NzEy", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-417048712", "createdAt": "2020-05-22T16:42:55Z", "commit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjo0Mjo1NVrOGZdWow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjo0Mjo1NVrOGZdWow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0ODUxNQ==", "bodyText": "Should we define a new method called deleteObjects to be backward compatible?", "url": "https://github.com/apache/ozone/pull/814#discussion_r429348515", "createdAt": "2020-05-22T16:42:55Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneClientAdapterImpl.java", "diffHunk": "@@ -272,15 +272,15 @@ public boolean createDirectory(String keyName) throws IOException {\n   /**\n    * Helper method to delete an object specified by key name in bucket.\n    *\n-   * @param keyName key name to be deleted\n+   * @param keyNameList key name list to be deleted\n    * @return true if the key is deleted, false otherwise\n    */\n   @Override\n-  public boolean deleteObject(String keyName) {\n-    LOG.trace(\"issuing delete for key {}\", keyName);\n+  public boolean deleteObject(List<String> keyNameList) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MDQ5NzM4", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-417049738", "createdAt": "2020-05-22T16:43:48Z", "commit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjo0Mzo0OVrOGZdYnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjo0Mzo0OVrOGZdYnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0OTAyMA==", "bodyText": "Should we define a new method called deleteObjects to be backward compatible?", "url": "https://github.com/apache/ozone/pull/814#discussion_r429349020", "createdAt": "2020-05-22T16:43:49Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/OzoneClientAdapter.java", "diffHunk": "@@ -48,7 +48,7 @@ OzoneFSOutputStream createFile(String key, short replication,\n \n   boolean createDirectory(String keyName) throws IOException;\n \n-  boolean deleteObject(String keyName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MDQ5OTQ0", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-417049944", "createdAt": "2020-05-22T16:44:09Z", "commit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MDYxMDI1", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-417061025", "createdAt": "2020-05-22T17:02:57Z", "commit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzowMjo1N1rOGZd_cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNzowMjo1N1rOGZd_cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM1ODk2Mg==", "bodyText": "Can we update the title of the JIRA to reflect batch rename?", "url": "https://github.com/apache/ozone/pull/814#discussion_r429358962", "createdAt": "2020-05-22T17:02:57Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/common/src/main/resources/ozone-default.xml", "diffHunk": "@@ -1966,6 +1966,14 @@\n       jar and false for the ozone-filesystem-lib-current.jar\n     </description>\n   </property>\n+  <property>\n+    <name>ozone.fs.iterate.batch-size</name>\n+    <value>1</value>\n+    <tag>OZONE, OZONEFS</tag>\n+    <description>\n+      iterate batch size of delete and rename when use BasicOzoneFileSystem.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/66af6cbb7ebedaefc9c99874c9c207e71d62ea21", "committedDate": "2020-05-19T09:37:40Z", "message": "add ut and fix issues."}, "afterCommit": {"oid": "e89201e399af3ae6cbb114ebb3643eb713174981", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/e89201e399af3ae6cbb114ebb3643eb713174981", "committedDate": "2020-05-28T11:44:40Z", "message": "support batch delete and fix review issues."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e89201e399af3ae6cbb114ebb3643eb713174981", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/e89201e399af3ae6cbb114ebb3643eb713174981", "committedDate": "2020-05-28T11:44:40Z", "message": "support batch delete and fix review issues."}, "afterCommit": {"oid": "c4950d93738e1a683d544da6f696818cb9df2af6", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/c4950d93738e1a683d544da6f696818cb9df2af6", "committedDate": "2020-05-28T12:03:26Z", "message": "support batch delete and fix review issues."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMjE5MTg0", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-422219184", "createdAt": "2020-06-01T22:16:12Z", "commit": {"oid": "109a6ba9bdb6b21244b51cc2818d8ddbce8bafd1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMjoxNjoxM1rOGdb5sQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMjoxNjoxM1rOGdb5sQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxOTAyNQ==", "bodyText": "Note when the batch size is large, this could hold the lock for a longer period of time compare with the individual lock and release.", "url": "https://github.com/apache/ozone/pull/814#discussion_r433519025", "createdAt": "2020-06-01T22:16:13Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMBatchKeyDeleteRequest.java", "diffHunk": "@@ -0,0 +1,226 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.om.request.key;\n+\n+import com.google.common.base.Optional;\n+import com.google.common.base.Preconditions;\n+import org.apache.hadoop.hdds.utils.db.cache.CacheKey;\n+import org.apache.hadoop.hdds.utils.db.cache.CacheValue;\n+import org.apache.hadoop.ozone.audit.AuditLogger;\n+import org.apache.hadoop.ozone.audit.OMAction;\n+import org.apache.hadoop.ozone.om.OMMetadataManager;\n+import org.apache.hadoop.ozone.om.OMMetrics;\n+import org.apache.hadoop.ozone.om.OzoneManager;\n+import org.apache.hadoop.ozone.om.exceptions.OMException;\n+import org.apache.hadoop.ozone.om.exceptions.OMReplayException;\n+import org.apache.hadoop.ozone.om.helpers.OmKeyInfo;\n+import org.apache.hadoop.ozone.om.ratis.utils.OzoneManagerDoubleBufferHelper;\n+import org.apache.hadoop.ozone.om.request.util.OmResponseUtil;\n+import org.apache.hadoop.ozone.om.response.OMClientResponse;\n+import org.apache.hadoop.ozone.om.response.key.OMKeyDeleteResponse;\n+import org.apache.hadoop.ozone.om.response.key.OMBatchKeyDeleteResponse;\n+import org.apache.hadoop.ozone.protocol.proto.OzoneManagerProtocolProtos;\n+import org.apache.hadoop.ozone.protocol.proto.OzoneManagerProtocolProtos.*;\n+import org.apache.hadoop.ozone.security.acl.IAccessAuthorizer;\n+import org.apache.hadoop.ozone.security.acl.OzoneObj;\n+import org.apache.hadoop.util.Time;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.util.*;\n+\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.KEY_NOT_FOUND;\n+import static org.apache.hadoop.ozone.om.lock.OzoneManagerLock.Resource.BUCKET_LOCK;\n+\n+/**\n+ * Handles DeleteKey request.\n+ */\n+public class OMBatchKeyDeleteRequest extends OMKeyRequest {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(OMBatchKeyDeleteRequest.class);\n+\n+  public OMBatchKeyDeleteRequest(OMRequest omRequest) {\n+    super(omRequest);\n+  }\n+\n+  @Override\n+  public OMRequest preExecute(OzoneManager ozoneManager) throws IOException {\n+    DeleteBatchKeyRequest deleteKeyRequest =\n+        getOmRequest().getDeleteBatchKeyRequest();\n+    Preconditions.checkNotNull(deleteKeyRequest);\n+    List<KeyArgs> newKeyArgsList = new ArrayList<>();\n+    for (KeyArgs keyArgs : deleteKeyRequest.getKeyArgsList()) {\n+      newKeyArgsList.add(\n+          keyArgs.toBuilder().setModificationTime(Time.now()).build());\n+    }\n+    DeleteBatchKeyRequest newDeleteKeyRequest = DeleteBatchKeyRequest\n+        .newBuilder().addAllKeyArgs(newKeyArgsList).build();\n+\n+    return getOmRequest().toBuilder()\n+        .setDeleteBatchKeyRequest(newDeleteKeyRequest)\n+        .setUserInfo(getUserInfo()).build();\n+  }\n+\n+  @Override\n+  @SuppressWarnings(\"methodlength\")\n+  public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n+      long trxnLogIndex, OzoneManagerDoubleBufferHelper omDoubleBufferHelper) {\n+    DeleteBatchKeyRequest deleteKeyRequest =\n+        getOmRequest().getDeleteBatchKeyRequest();\n+\n+    List<KeyArgs> deleteKeyArgsList = deleteKeyRequest.getKeyArgsList();\n+    IOException exception = null;\n+    OMClientResponse omClientResponse = null;\n+    Result result = null;\n+\n+    OMMetrics omMetrics = ozoneManager.getMetrics();\n+    omMetrics.incNumKeyDeletes();\n+    List<OmKeyInfo> omKeyInfoList = new ArrayList<>();\n+    Set<String> acquiredLockSet = new HashSet<>();\n+    Map<String, String> auditMap = null;\n+    String volumeName = \"\";\n+    String bucketName = \"\";\n+    String keyName = \"\";\n+\n+    AuditLogger auditLogger = ozoneManager.getAuditLogger();\n+    OzoneManagerProtocolProtos.UserInfo userInfo =\n+        getOmRequest().getUserInfo();\n+\n+    OMResponse.Builder omResponse = OmResponseUtil.getOMResponseBuilder(\n+        getOmRequest());\n+    OMMetadataManager omMetadataManager = ozoneManager.getMetadataManager();\n+    try {\n+      for (KeyArgs deleteKeyArgs : deleteKeyArgsList) {\n+        acquiredLockSet.add(deleteKeyArgs.getVolumeName() + \"_\" +\n+            deleteKeyArgs.getBucketName());\n+      }\n+\n+      for (String volumeAndVolume : acquiredLockSet) {\n+        omMetadataManager.getLock().acquireWriteLock(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "109a6ba9bdb6b21244b51cc2818d8ddbce8bafd1"}, "originalPosition": 117}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5384fd2ebcaf9584ec7c69d10bdacaaaa9b58833", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/5384fd2ebcaf9584ec7c69d10bdacaaaa9b58833", "committedDate": "2020-06-02T11:35:48Z", "message": "fix checkstyle."}, "afterCommit": {"oid": "1149c66f48b445d13d82bf3a8aa6f4e34a11b3b7", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/1149c66f48b445d13d82bf3a8aa6f4e34a11b3b7", "committedDate": "2020-06-02T13:42:33Z", "message": "fix checkstyle."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a543260049fdaebed7cdccabde89ca4e33cceafa", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/a543260049fdaebed7cdccabde89ca4e33cceafa", "committedDate": "2020-06-02T14:48:38Z", "message": "Merge branch 'master' into HDDS-3286-new"}, "afterCommit": {"oid": "fd75e9216288652eac0f9429105abd68a8fcb8ec", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/fd75e9216288652eac0f9429105abd68a8fcb8ec", "committedDate": "2020-06-05T09:10:59Z", "message": "fix checkstyle."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NzY1Mzkz", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-426765393", "createdAt": "2020-06-09T03:32:17Z", "commit": {"oid": "2158a796f08f35f5498943085f053570b26b7ac5"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwMzozMjoxOFrOGg3l3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwODozMDo1NVrOGg-ZGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzExODQzMA==", "bodyText": "Suggest a bigger default size, say 100?", "url": "https://github.com/apache/ozone/pull/814#discussion_r437118430", "createdAt": "2020-06-09T03:32:18Z", "author": {"login": "ChenSammi"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConfigKeys.java", "diffHunk": "@@ -401,6 +401,10 @@\n       \"ozone.s3.token.max.lifetime\";\n   public static final String OZONE_S3_AUTHINFO_MAX_LIFETIME_KEY_DEFAULT = \"3m\";\n \n+  public static final String OZONE_FS_ITERATE_BATCH_SIZE =\n+          \"ozone.fs.iterate.batch-size\";\n+  public static final int OZONE_FS_ITERATE_BATCH_SIZE_DEFAULT = 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2158a796f08f35f5498943085f053570b26b7ac5"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzExODUxOA==", "bodyText": "Will this property be used for batch rename too?", "url": "https://github.com/apache/ozone/pull/814#discussion_r437118518", "createdAt": "2020-06-09T03:32:40Z", "author": {"login": "ChenSammi"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConfigKeys.java", "diffHunk": "@@ -401,6 +401,10 @@\n       \"ozone.s3.token.max.lifetime\";\n   public static final String OZONE_S3_AUTHINFO_MAX_LIFETIME_KEY_DEFAULT = \"3m\";\n \n+  public static final String OZONE_FS_ITERATE_BATCH_SIZE =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2158a796f08f35f5498943085f053570b26b7ac5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzExODgzMQ==", "bodyText": "Indent is incorrect.", "url": "https://github.com/apache/ozone/pull/814#discussion_r437118831", "createdAt": "2020-06-09T03:34:10Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/protocol/ClientProtocol.java", "diffHunk": "@@ -294,6 +294,17 @@ OzoneInputStream getKey(String volumeName, String bucketName, String keyName)\n   void deleteKey(String volumeName, String bucketName, String keyName)\n       throws IOException;\n \n+  /**\n+   * Deletes keys through the list.\n+   * @param volumeName Name of the Volume\n+   * @param bucketName Name of the Bucket\n+   * @param keyNameList List of the Key\n+   * @throws IOException\n+   */\n+  void deleteKeys(String volumeName, String bucketName,\n+                     List<String> keyNameList)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2158a796f08f35f5498943085f053570b26b7ac5"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzExOTczOA==", "bodyText": "Agree with Xiaoyu, we should return a list of deleted key result on failure.", "url": "https://github.com/apache/ozone/pull/814#discussion_r437119738", "createdAt": "2020-06-09T03:38:09Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneBucket.java", "diffHunk": "@@ -382,6 +382,21 @@ public void deleteKey(String key) throws IOException {\n     proxy.deleteKey(volumeName, name, key);\n   }\n \n+  /**\n+   * Deletes the given list of keys from the bucket.\n+   * @param keyList List of the key name to be deleted.\n+   * @throws IOException\n+   */\n+  public void deleteKeys(List<String> keyList) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0MjgyOQ=="}, "originalCommit": {"oid": "66af6cbb7ebedaefc9c99874c9c207e71d62ea21"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIyOTg1MA==", "bodyText": "Can we return the list of deleted keys together with the exception to client so that client knows which keyes are deleted and which key trigger the exception?", "url": "https://github.com/apache/ozone/pull/814#discussion_r437229850", "createdAt": "2020-06-09T08:30:55Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMBatchKeyDeleteRequest.java", "diffHunk": "@@ -0,0 +1,229 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.om.request.key;\n+\n+import com.google.common.base.Optional;\n+import com.google.common.base.Preconditions;\n+import org.apache.hadoop.hdds.utils.db.cache.CacheKey;\n+import org.apache.hadoop.hdds.utils.db.cache.CacheValue;\n+import org.apache.hadoop.ozone.audit.AuditLogger;\n+import org.apache.hadoop.ozone.audit.OMAction;\n+import org.apache.hadoop.ozone.om.OMMetadataManager;\n+import org.apache.hadoop.ozone.om.OMMetrics;\n+import org.apache.hadoop.ozone.om.OzoneManager;\n+import org.apache.hadoop.ozone.om.exceptions.OMException;\n+import org.apache.hadoop.ozone.om.exceptions.OMReplayException;\n+import org.apache.hadoop.ozone.om.helpers.OmKeyInfo;\n+import org.apache.hadoop.ozone.om.ratis.utils.OzoneManagerDoubleBufferHelper;\n+import org.apache.hadoop.ozone.om.request.util.OmResponseUtil;\n+import org.apache.hadoop.ozone.om.response.OMClientResponse;\n+import org.apache.hadoop.ozone.om.response.key.OMKeyDeleteResponse;\n+import org.apache.hadoop.ozone.om.response.key.OMBatchKeyDeleteResponse;\n+import org.apache.hadoop.ozone.protocol.proto.OzoneManagerProtocolProtos;\n+import org.apache.hadoop.ozone.protocol.proto.OzoneManagerProtocolProtos\n+    .DeleteBatchKeyRequest;\n+import org.apache.hadoop.ozone.protocol.proto.OzoneManagerProtocolProtos\n+    .DeleteBatchKeyResponse;\n+import org.apache.hadoop.ozone.protocol.proto.OzoneManagerProtocolProtos\n+    .OMRequest;\n+import org.apache.hadoop.ozone.protocol.proto.OzoneManagerProtocolProtos\n+    .OMResponse;\n+import org.apache.hadoop.ozone.protocol.proto.OzoneManagerProtocolProtos\n+    .KeyArgs;\n+import org.apache.hadoop.ozone.security.acl.IAccessAuthorizer;\n+import org.apache.hadoop.ozone.security.acl.OzoneObj;\n+import org.apache.hadoop.util.Time;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.util.*;\n+\n+import static org.apache.hadoop.ozone.om.exceptions.OMException.ResultCodes.KEY_NOT_FOUND;\n+import static org.apache.hadoop.ozone.om.lock.OzoneManagerLock.Resource.BUCKET_LOCK;\n+\n+/**\n+ * Handles DeleteKey request.\n+ */\n+public class OMBatchKeyDeleteRequest extends OMKeyRequest {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(OMBatchKeyDeleteRequest.class);\n+\n+  public OMBatchKeyDeleteRequest(OMRequest omRequest) {\n+    super(omRequest);\n+  }\n+\n+  @Override\n+  public OMRequest preExecute(OzoneManager ozoneManager) throws IOException {\n+    DeleteBatchKeyRequest deleteKeyRequest =\n+        getOmRequest().getDeleteBatchKeyRequest();\n+    Preconditions.checkNotNull(deleteKeyRequest);\n+    List<KeyArgs> newKeyArgsList = new ArrayList<>();\n+    for (KeyArgs keyArgs : deleteKeyRequest.getKeyArgsList()) {\n+      newKeyArgsList.add(\n+          keyArgs.toBuilder().setModificationTime(Time.now()).build());\n+    }\n+    DeleteBatchKeyRequest newDeleteKeyRequest = DeleteBatchKeyRequest\n+        .newBuilder().addAllKeyArgs(newKeyArgsList).build();\n+\n+    return getOmRequest().toBuilder()\n+        .setDeleteBatchKeyRequest(newDeleteKeyRequest)\n+        .setUserInfo(getUserInfo()).build();\n+  }\n+\n+  @Override\n+  @SuppressWarnings(\"methodlength\")\n+  public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n+      long trxnLogIndex, OzoneManagerDoubleBufferHelper omDoubleBufferHelper) {\n+    DeleteBatchKeyRequest deleteKeyRequest =\n+        getOmRequest().getDeleteBatchKeyRequest();\n+\n+    List<KeyArgs> deleteKeyArgsList = deleteKeyRequest.getKeyArgsList();\n+    IOException exception = null;\n+    boolean acquiredLock = false;\n+    OMClientResponse omClientResponse = null;\n+    Result result = null;\n+\n+    OMMetrics omMetrics = ozoneManager.getMetrics();\n+    omMetrics.incNumKeyDeletes();\n+    List<OmKeyInfo> omKeyInfoList = new ArrayList<>();\n+    Map<String, String> auditMap = null;\n+    String volumeName = \"\";\n+    String bucketName = \"\";\n+    String keyName = \"\";\n+\n+    AuditLogger auditLogger = ozoneManager.getAuditLogger();\n+    OzoneManagerProtocolProtos.UserInfo userInfo =\n+        getOmRequest().getUserInfo();\n+\n+    OMResponse.Builder omResponse = OmResponseUtil.getOMResponseBuilder(\n+        getOmRequest());\n+    OMMetadataManager omMetadataManager = ozoneManager.getMetadataManager();\n+\n+    try {\n+      for (KeyArgs deleteKeyArgs : deleteKeyArgsList) {\n+        volumeName = deleteKeyArgs.getVolumeName();\n+        bucketName = deleteKeyArgs.getBucketName();\n+        keyName = deleteKeyArgs.getKeyName();\n+        auditMap = buildKeyArgsAuditMap(deleteKeyArgs);\n+\n+        // check Acl\n+        checkKeyAcls(ozoneManager, volumeName, bucketName, keyName,\n+            IAccessAuthorizer.ACLType.DELETE, OzoneObj.ResourceType.KEY);\n+\n+        String objectKey = omMetadataManager.getOzoneKey(\n+            volumeName, bucketName, keyName);\n+\n+        acquiredLock = omMetadataManager.getLock().acquireWriteLock(BUCKET_LOCK,\n+            volumeName, bucketName);\n+        // Validate bucket and volume exists or not.\n+        validateBucketAndVolume(omMetadataManager, volumeName, bucketName);\n+\n+        OmKeyInfo omKeyInfo = omMetadataManager.getKeyTable().get(objectKey);\n+        if (omKeyInfo == null) {\n+          throw new OMException(\"Key not found\", KEY_NOT_FOUND);\n+        }\n+\n+        // Check if this transaction is a replay of ratis logs.\n+        if (isReplay(ozoneManager, omKeyInfo, trxnLogIndex)) {\n+          // Replay implies the response has already been returned to\n+          // the client. So take no further action and return a dummy\n+          // OMClientResponse.\n+          throw new OMReplayException();\n+        }\n+\n+        // Set the UpdateID to current transactionLogIndex\n+        omKeyInfo.setUpdateID(trxnLogIndex, ozoneManager.isRatisEnabled());\n+\n+        // Update table cache.\n+        omMetadataManager.getKeyTable().addCacheEntry(\n+            new CacheKey<>(omMetadataManager.getOzoneKey(\n+                volumeName, bucketName, keyName)),\n+            new CacheValue<>(Optional.absent(), trxnLogIndex));\n+\n+        // No need to add cache entries to delete table. As delete table will\n+        // be used by DeleteKeyService only, not used for any client response\n+        // validation, so we don't need to add to cache.\n+        // TODO: Revisit if we need it later.\n+\n+        if (acquiredLock) {\n+          omMetadataManager.getLock().releaseWriteLock(BUCKET_LOCK, volumeName,\n+              bucketName);\n+          acquiredLock = false;\n+        }\n+        omKeyInfoList.add(omKeyInfo);\n+      }\n+      omClientResponse = new OMBatchKeyDeleteResponse(omResponse\n+          .setDeleteBatchKeyResponse(DeleteBatchKeyResponse.newBuilder())\n+          .build(),\n+          omKeyInfoList, ozoneManager.isRatisEnabled());\n+      result = Result.SUCCESS;\n+    } catch (IOException ex) {\n+      if (ex instanceof OMReplayException) {\n+        result = Result.REPLAY;\n+        omClientResponse = new OMKeyDeleteResponse(createReplayOMResponse(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2158a796f08f35f5498943085f053570b26b7ac5"}, "originalPosition": 181}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a2851daa2b119609d390a6c8f1c74d3471861af", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/0a2851daa2b119609d390a6c8f1c74d3471861af", "committedDate": "2020-06-09T15:47:08Z", "message": "add unDeletedKeys and deletedKeys in exception and fix review issues."}, "afterCommit": {"oid": "8604295876cef7c62e51720ba34d90d783c00534", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/8604295876cef7c62e51720ba34d90d783c00534", "committedDate": "2020-06-12T02:00:16Z", "message": "add unDeletedKeys and deletedKeys in exception and fix review issues."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "691eca8fc5948e71701bf1a21f65234e3b7e2b09", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/691eca8fc5948e71701bf1a21f65234e3b7e2b09", "committedDate": "2020-06-18T06:21:10Z", "message": "fix review issues and bugs."}, "afterCommit": {"oid": "3f720f10c256c604b57db2cd6e12bc6cccc9b0ad", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/3f720f10c256c604b57db2cd6e12bc6cccc9b0ad", "committedDate": "2020-06-18T06:40:18Z", "message": "fix review issues and bugs."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3f720f10c256c604b57db2cd6e12bc6cccc9b0ad", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/3f720f10c256c604b57db2cd6e12bc6cccc9b0ad", "committedDate": "2020-06-18T06:40:18Z", "message": "fix review issues and bugs."}, "afterCommit": {"oid": "257a8d4c91d9b922d3aa3589a5165bb071cef822", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/257a8d4c91d9b922d3aa3589a5165bb071cef822", "committedDate": "2020-06-18T08:07:24Z", "message": "fix review issues and bugs and rebase master."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0Mzc0NzMw", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-434374730", "createdAt": "2020-06-19T23:03:10Z", "commit": {"oid": "257a8d4c91d9b922d3aa3589a5165bb071cef822"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQyMzowMzoxMFrOGmjBUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQyMzowMzoxMFrOGmjBUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3Mjg1MA==", "bodyText": "Usually we have a XXXRequest match with XXXResponse. Here we have DeleteKeysRequest->DeleteKeysResponse and UnDeletedKeysResponse.\nNIT: can we keep this consistent to avoid confusion for UnDeleteKeysRequest if any in the future?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            message DeleteKeysResponse {\n          \n          \n            \n            message DeleteKeysResponse {\n          \n          \n            \n                repeated KeyInfo deletedKeys = 1;\n          \n          \n            \n                repeated KeyInfo unDeletedKeys = 2;\n          \n          \n            \n            }```", "url": "https://github.com/apache/ozone/pull/814#discussion_r443072850", "createdAt": "2020-06-19T23:03:10Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/common/src/main/proto/OzoneManagerProtocol.proto", "diffHunk": "@@ -856,6 +864,10 @@ message DeletedKeys {\n     repeated string keys = 3;\n }\n \n+message DeleteKeysResponse {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "257a8d4c91d9b922d3aa3589a5165bb071cef822"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0Mzc1NDc3", "url": "https://github.com/apache/ozone/pull/814#pullrequestreview-434375477", "createdAt": "2020-06-19T23:06:49Z", "commit": {"oid": "257a8d4c91d9b922d3aa3589a5165bb071cef822"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQyMzowNjo0OVrOGmjD1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQyMzowNjo0OVrOGmjD1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA3MzQ5Mw==", "bodyText": "I think put the undeleted keys in OMResponse is good enough. Not sure if we want to append all the key names into the string message, which can hurt the performance when the list is huge.", "url": "https://github.com/apache/ozone/pull/814#discussion_r443073493", "createdAt": "2020-06-19T23:06:49Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/OMClientRequest.java", "diffHunk": "@@ -220,6 +224,39 @@ protected OMResponse createErrorOMResponse(\n     return omResponse.build();\n   }\n \n+  /**\n+   * Set parameters needed for return error response to client.\n+   *\n+   * @param omResponse\n+   * @param ex         - IOException\n+   * @param unDeletedKeys    - Set<OmKeyInfo>\n+   * @return error response need to be returned to client - OMResponse.\n+   */\n+  protected OMResponse createOperationKeysErrorOMResponse(\n+      @Nonnull OMResponse.Builder omResponse,\n+      @Nonnull IOException ex, @Nonnull Set<OmKeyInfo> unDeletedKeys) {\n+    omResponse.setSuccess(false);\n+    StringBuffer errorMsg = new StringBuffer();\n+    errorMsg.append(exceptionErrorMessage(ex) + \"\\n The Keys not deleted: \");\n+    UnDeletedKeysResponse.Builder resp =\n+        UnDeletedKeysResponse.newBuilder();\n+    for (OmKeyInfo key : unDeletedKeys) {\n+      if(key != null) {\n+        resp.addKeyInfo(key.getProtobuf());\n+        errorMsg.append(key.getObjectInfo() + \"\\n\");\n+      }\n+    }\n+    if (errorMsg != null) {\n+      omResponse.setMessage(errorMsg.toString());\n+    }\n+    // TODO: Currently all delete operations in OzoneBucket.java are void. Here\n+    //  we put the List of unDeletedKeys into Response. These KeyInfo can be\n+    //  used to continue deletion if client support delete retry.\n+    omResponse.setUnDeletedKeysResponse(resp.build());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "257a8d4c91d9b922d3aa3589a5165bb071cef822"}, "originalPosition": 55}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9bf3f10c58769e73841570ccb003202e9c4579b4", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/9bf3f10c58769e73841570ccb003202e9c4579b4", "committedDate": "2020-06-23T07:36:56Z", "message": "add suggestion update  in OzoneManagerProtocol.proto\n\nCo-authored-by: Xiaoyu Yao <xyao@apache.org>"}, "afterCommit": {"oid": "078c9d4e621dee0d4cc9a6c8d50cb636470519bc", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/078c9d4e621dee0d4cc9a6c8d50cb636470519bc", "committedDate": "2020-06-23T07:46:03Z", "message": "fix review issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b377791437f65804e96561b07b20bf6f66672f0c", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/b377791437f65804e96561b07b20bf6f66672f0c", "committedDate": "2020-06-23T08:29:28Z", "message": "support batch delete and fix review issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44c578871806ed0b2412d5341093aced907f4e71", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/44c578871806ed0b2412d5341093aced907f4e71", "committedDate": "2020-06-23T09:02:02Z", "message": "fix review issues and resolve the conflict."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "078c9d4e621dee0d4cc9a6c8d50cb636470519bc", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/078c9d4e621dee0d4cc9a6c8d50cb636470519bc", "committedDate": "2020-06-23T07:46:03Z", "message": "fix review issues."}, "afterCommit": {"oid": "44c578871806ed0b2412d5341093aced907f4e71", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/44c578871806ed0b2412d5341093aced907f4e71", "committedDate": "2020-06-23T09:02:02Z", "message": "fix review issues and resolve the conflict."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3355, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}