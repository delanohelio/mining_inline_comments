{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUxMjQ2MjQ0", "number": 1212, "title": "HDDS-3979. Make bufferSize configurable for stream copy", "bodyText": "What changes were proposed in this pull request?\n\nRefactor the code related copy large by using seek to enforce skip method of KeyInputStream and S3WrapperInputStream, the related codes.\n\nWe can use IOUtils#copyLarge to clarify and reduce the duplicated code.\nAfter this, It's easy to specify a buffer by using IOUtils#copyLarge.\n\n\nMake bufferSize configurable for stream copy.\n\nSo that user like s3g can specify a buffer size to balance the memory and performance.\n\n\n\nWhat is the link to the Apache JIRA\nHDDS-3979\nHow was this patch tested?\nUsing awscli or goofys", "createdAt": "2020-07-17T16:25:08Z", "url": "https://github.com/apache/ozone/pull/1212", "merged": true, "mergeCommit": {"oid": "9a702e5c35cfdffe7f0f1a4e2cc7ec97ec8e6d4e"}, "closed": true, "closedAt": "2020-08-11T12:20:18Z", "author": {"login": "maobaolong"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3Xh2_gFqTQ1MzE1NTAzNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc912fcgFqTQ2NTAwOTU4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMTU1MDM3", "url": "https://github.com/apache/ozone/pull/1212#pullrequestreview-453155037", "createdAt": "2020-07-22T09:36:42Z", "commit": {"oid": "49ca2904f75d6e067a691e46e2888a001f54ffeb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwOTozNjo0MlrOG1auUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwOTozNjo0MlrOG1auUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY2NTU1NQ==", "bodyText": "add unit test for skip.", "url": "https://github.com/apache/ozone/pull/1212#discussion_r458665555", "createdAt": "2020-07-22T09:36:42Z", "author": {"login": "runzhiwang"}, "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/KeyInputStream.java", "diffHunk": "@@ -325,62 +323,14 @@ public long getRemainingOfIndex(int index) throws IOException {\n     return blockStreams.get(index).getRemaining();\n   }\n \n-  /**\n-   * Copies some or all bytes from a large (over 2GB) <code>InputStream</code>\n-   * to an <code>OutputStream</code>, optionally skipping input bytes.\n-   * <p>\n-   * Copy the method from IOUtils of commons-io to reimplement skip by seek\n-   * rather than read. The reason why IOUtils of commons-io implement skip\n-   * by read can be found at\n-   * <a href=\"https://issues.apache.org/jira/browse/IO-203\">IO-203</a>.\n-   * </p>\n-   * <p>\n-   * This method uses the provided buffer, so there is no need to use a\n-   * <code>BufferedInputStream</code>.\n-   * </p>\n-   *\n-   * @param output the <code>OutputStream</code> to write to\n-   * @param inputOffset : number of bytes to skip from input before copying\n-   * -ve values are ignored\n-   * @param length : number of bytes to copy. -ve means all\n-   * @param buffer the buffer to use for the copy\n-   * @return the number of bytes copied\n-   * @throws NullPointerException if the input or output is null\n-   * @throws IOException          if an I/O error occurs\n-   */\n-  public long copyLarge(final OutputStream output,\n-      final long inputOffset, final long len, final byte[] buffer)\n-      throws IOException {\n-    if (inputOffset > 0) {\n-      seek(inputOffset);\n-    }\n-\n-    if (len == 0) {\n+  @Override\n+  public long skip(long n) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49ca2904f75d6e067a691e46e2888a001f54ffeb"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6449f6656f593e83621ddc5874696c15be4eee00", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/6449f6656f593e83621ddc5874696c15be4eee00", "committedDate": "2020-07-22T11:32:08Z", "message": "HDDS-3979. Clarify the ObjectEndpoint code of s3g."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "49ca2904f75d6e067a691e46e2888a001f54ffeb", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/49ca2904f75d6e067a691e46e2888a001f54ffeb", "committedDate": "2020-07-18T01:27:09Z", "message": "trigger new ci check"}, "afterCommit": {"oid": "6449f6656f593e83621ddc5874696c15be4eee00", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/6449f6656f593e83621ddc5874696c15be4eee00", "committedDate": "2020-07-22T11:32:08Z", "message": "HDDS-3979. Clarify the ObjectEndpoint code of s3g."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "635a8741311a5d839988f7ffe57ea32cd4fcc464", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/635a8741311a5d839988f7ffe57ea32cd4fcc464", "committedDate": "2020-07-22T12:25:10Z", "message": "Add ut for skip"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMjcxMjEx", "url": "https://github.com/apache/ozone/pull/1212#pullrequestreview-453271211", "createdAt": "2020-07-22T12:33:19Z", "commit": {"oid": "635a8741311a5d839988f7ffe57ea32cd4fcc464"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjozMzoxOVrOG1gTUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjozMzoxOVrOG1gTUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1Njk0NA==", "bodyText": "why { ?", "url": "https://github.com/apache/ozone/pull/1212#discussion_r458756944", "createdAt": "2020-07-22T12:33:19Z", "author": {"login": "runzhiwang"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestKeyInputStream.java", "diffHunk": "@@ -395,4 +334,64 @@ public void testReadChunk() throws Exception {\n     }\n     keyInputStream.close();\n   }\n+\n+  @Test\n+  public void testSkip() throws Exception {\n+    {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "635a8741311a5d839988f7ffe57ea32cd4fcc464"}, "originalPosition": 82}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMjcxNTYw", "url": "https://github.com/apache/ozone/pull/1212#pullrequestreview-453271560", "createdAt": "2020-07-22T12:33:46Z", "commit": {"oid": "635a8741311a5d839988f7ffe57ea32cd4fcc464"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjozMzo0NlrOG1gUZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjozMzo0NlrOG1gUZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1NzIyMw==", "bodyText": "4 space ?", "url": "https://github.com/apache/ozone/pull/1212#discussion_r458757223", "createdAt": "2020-07-22T12:33:46Z", "author": {"login": "runzhiwang"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestKeyInputStream.java", "diffHunk": "@@ -395,4 +334,64 @@ public void testReadChunk() throws Exception {\n     }\n     keyInputStream.close();\n   }\n+\n+  @Test\n+  public void testSkip() throws Exception {\n+    {\n+      XceiverClientManager.resetXceiverClientMetrics();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "635a8741311a5d839988f7ffe57ea32cd4fcc464"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae006e920aab139c0454d4dea513166efc01627d", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/ae006e920aab139c0454d4dea513166efc01627d", "committedDate": "2020-07-22T12:39:26Z", "message": "Address review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMjgwNjI0", "url": "https://github.com/apache/ozone/pull/1212#pullrequestreview-453280624", "createdAt": "2020-07-22T12:45:52Z", "commit": {"oid": "ae006e920aab139c0454d4dea513166efc01627d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjo0NTo1MlrOG1gvbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjo0NTo1MlrOG1gvbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc2NDE0MA==", "bodyText": "We can describe what size can achieve best performance.", "url": "https://github.com/apache/ozone/pull/1212#discussion_r458764140", "createdAt": "2020-07-22T12:45:52Z", "author": {"login": "runzhiwang"}, "path": "hadoop-hdds/common/src/main/resources/ozone-default.xml", "diffHunk": "@@ -2421,6 +2421,14 @@\n       information will be extracted\n     </description>\n   </property>\n+  <property>\n+    <name>ozone.client.buffer.size</name>\n+    <tag>OZONE, S3GATEWAY</tag>\n+    <value>4KB</value>\n+    <description>\n+      The size of the buffer which is for read block. (4KB by default).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae006e920aab139c0454d4dea513166efc01627d"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMjg5MTAz", "url": "https://github.com/apache/ozone/pull/1212#pullrequestreview-453289103", "createdAt": "2020-07-22T12:56:52Z", "commit": {"oid": "ae006e920aab139c0454d4dea513166efc01627d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9edbae595866265c25fca2419a44cbf982be2e1f", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/9edbae595866265c25fca2419a44cbf982be2e1f", "committedDate": "2020-07-22T13:23:31Z", "message": "trigger new ci check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NTMxNzIw", "url": "https://github.com/apache/ozone/pull/1212#pullrequestreview-457531720", "createdAt": "2020-07-29T13:40:45Z", "commit": {"oid": "9edbae595866265c25fca2419a44cbf982be2e1f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMzo0MDo0NlrOG4488A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMzo0MjoxOFrOG45BNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjMwNjU0NA==", "bodyText": "Two things:\n\nozone.client.buffer.size seems to be confusing. This configuration for the Ozone client of the s3g. As we have a global list of configuration keys, I guess we need a s3g prefix here. (For example ozone.s3g.client.buffer.size)\nUsually, I prefer to use annotation based configuration, if possible. (It can be harder here as S3g uses CDI injections. If it's too complex, you can ignore...)", "url": "https://github.com/apache/ozone/pull/1212#discussion_r462306544", "createdAt": "2020-07-29T13:40:46Z", "author": {"login": "elek"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConfigKeys.java", "diffHunk": "@@ -465,6 +465,12 @@\n   public static final String  OZONE_CLIENT_HTTPS_NEED_AUTH_KEY =\n       \"ozone.https.client.need-auth\";\n   public static final boolean OZONE_CLIENT_HTTPS_NEED_AUTH_DEFAULT = false;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9edbae595866265c25fca2419a44cbf982be2e1f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjMwNzYzOQ==", "bodyText": "NIT: It can be slightly better to use\n  @Inject\n  private OzoneConfiguration ozoneConfiguration;\n\nAnd you don't need to expose getClient() in the EndpointBase.\n(Didn't try, but it should work, IMHO).", "url": "https://github.com/apache/ozone/pull/1212#discussion_r462307639", "createdAt": "2020-07-29T13:42:18Z", "author": {"login": "elek"}, "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/endpoint/ObjectEndpoint.java", "diffHunk": "@@ -114,6 +120,13 @@ public ObjectEndpoint() {\n     customizableGetHeaders.add(\"Content-Encoding\");\n   }\n \n+  @PostConstruct\n+  public void init() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9edbae595866265c25fca2419a44cbf982be2e1f"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca7c9c04126fc80d9f53903e8bfa7b1388699529", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/ca7c9c04126fc80d9f53903e8bfa7b1388699529", "committedDate": "2020-07-30T16:28:46Z", "message": "Address comments. Use Injection to get configuration instance and add s3g prefix to the config key."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ec1c7872a6560c8693d30ec2ca9d2ad69ca0689", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/9ec1c7872a6560c8693d30ec2ca9d2ad69ca0689", "committedDate": "2020-07-31T00:59:26Z", "message": "fix test failed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MDA5NTgz", "url": "https://github.com/apache/ozone/pull/1212#pullrequestreview-465009583", "createdAt": "2020-08-11T12:19:57Z", "commit": {"oid": "9ec1c7872a6560c8693d30ec2ca9d2ad69ca0689"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2867, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}