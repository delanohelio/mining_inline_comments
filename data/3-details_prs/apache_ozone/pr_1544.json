{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0Mzg2MzE2", "number": 1544, "title": "HDDS-4337. Implement RocksDB options cache for new datanode DB utilities.", "bodyText": "What changes were proposed in this pull request\nAdd a cache of ColumnFamilyOptions objects to AbstractDatanodeStore, so that each ConfigurationSource object used to construct a container will result in the same RocksDB ColumnFamilyOptions object being used. Since the same configuration instance is used for all containers on a datanode, this results in all containers on a datanode using the same  ColumnFamilyOptions, and by extension the same RocksDB metadata cache. A configuration parameter is added for adjusting the size of this cache. Each RocksDB instance will have its own DBOptions, since this requires the use of RocksDB Statistics objects which are not thread safe and cannot be shared.\nThe DBStoreBuilder class was refactored to make configuration easier. It is now possible to use the same configurable column family options for all column families, and it is easier to reason about which configurations will be applied. It is no longer an error to register a table twice with the builder, the second call will simply override the first, which is usually the expected behavior in setters for builders. There should be no other functionality changes to this class.\nWhat is the link to the Apache JIRA\nHDDS-4337\nHow was this patch tested?\nAutomated Testing\n\nDBStoreBuilder unit tests were updated.\nA unit test was added to TestKeyValueContainer to test that ColumnFamilyOptions objects are shared between containers with the same configuration.\n\nManual Testing\nManual testing was also done with a docker cluster to verify that the same cache is used for all containers on a datanode. Steps:\n\nStart an ozone docker cluster and enter a datanode.\nWrite 100 keys: ozone freon ockg -n 100\nClose the pipeline those keys were written to.\n\nozone admin pipeline list to get the pipeline IDs.\nozone admin pipeline close <id> to close the pipeline.\n\n\nWrite 100 more keys.\nGet the address of the cache object from the RocksDB log for each of the two containers:\ngrep -A5 \"block_cache:\" /data/hdds/hdds/*/current/containerDir0/1/metadata/1-dn-container.db/LOG\nand\ngrep -A5 \"block_cache:\" /data/hdds/hdds/*/current/containerDir0/2/metadata/2-dn-container.db/LOG\n\n\nMake sure that the address listed after block_cache: is the same for both containers.", "createdAt": "2020-11-02T23:14:18Z", "url": "https://github.com/apache/ozone/pull/1544", "merged": true, "mergeCommit": {"oid": "760c1e8f9ecc5daa5cd49c95ca946a415976088e"}, "closed": true, "closedAt": "2020-11-13T10:32:45Z", "author": {"login": "errose28"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYshjCgH2gAyNTE0Mzg2MzE2OmM3NjYxODI2OTFhOTM0ZjRiNWI5ZWU3OTNlY2NhN2NlMDZmMDIyZGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdcEneRgFqTUyOTk0ODA3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c766182691a934f4b5b9ee793ecca7ce06f022dc", "author": {"user": {"login": "errose28", "name": "Ethan Rose"}}, "url": "https://github.com/apache/ozone/commit/c766182691a934f4b5b9ee793ecca7ce06f022dc", "committedDate": "2020-11-02T22:43:53Z", "message": "Outline how static column family options cna be used for datanode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a7cce24feccc443debb33b11c9129d684411de1", "author": {"user": {"login": "errose28", "name": "Ethan Rose"}}, "url": "https://github.com/apache/ozone/commit/0a7cce24feccc443debb33b11c9129d684411de1", "committedDate": "2020-11-02T22:43:53Z", "message": "Remove unused method and make methods not used outside private"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "338aa070ded59a2a6fd40d3ef8be09134dbacad4", "author": {"user": {"login": "errose28", "name": "Ethan Rose"}}, "url": "https://github.com/apache/ozone/commit/338aa070ded59a2a6fd40d3ef8be09134dbacad4", "committedDate": "2020-11-02T22:43:53Z", "message": "Refactor DBStoreBuilder constructors\n\nRemoval of DBProfile also got mixed in here, but not finished."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c481f891623b70e787227da82715050b8d42155", "author": {"user": {"login": "errose28", "name": "Ethan Rose"}}, "url": "https://github.com/apache/ozone/commit/5c481f891623b70e787227da82715050b8d42155", "committedDate": "2020-11-02T22:43:53Z", "message": "Finish reorganizing methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b780ccc312b679e2e2c79c5ad9e6b3701151da9", "author": {"user": {"login": "errose28", "name": "Ethan Rose"}}, "url": "https://github.com/apache/ozone/commit/7b780ccc312b679e2e2c79c5ad9e6b3701151da9", "committedDate": "2020-11-02T22:43:53Z", "message": "Code and comment clean up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "290b5ec96b8b6b58cb50bbcbff09280e5ee580f5", "author": {"user": {"login": "errose28", "name": "Ethan Rose"}}, "url": "https://github.com/apache/ozone/commit/290b5ec96b8b6b58cb50bbcbff09280e5ee580f5", "committedDate": "2020-11-02T22:43:53Z", "message": "Add documentation for profile setter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cba325251787f298948f68dc3fa86a146be4aa3e", "author": {"user": {"login": "errose28", "name": "Ethan Rose"}}, "url": "https://github.com/apache/ozone/commit/cba325251787f298948f68dc3fa86a146be4aa3e", "committedDate": "2020-11-02T22:43:53Z", "message": "Rename column fmaily setting options"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85b0a505fb2afb8cac9ce7d8cc88e0aa7f6edc0f", "author": {"user": {"login": "errose28", "name": "Ethan Rose"}}, "url": "https://github.com/apache/ozone/commit/85b0a505fb2afb8cac9ce7d8cc88e0aa7f6edc0f", "committedDate": "2020-11-02T22:43:53Z", "message": "Add simple test for registering the same table name multiple times"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86a25cfa2f848eda69a6b7895597b699a97a1de4", "author": {"user": {"login": "errose28", "name": "Ethan Rose"}}, "url": "https://github.com/apache/ozone/commit/86a25cfa2f848eda69a6b7895597b699a97a1de4", "committedDate": "2020-11-02T22:43:53Z", "message": "Fix errors when sharing column family options and cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eab4a124b10dd682646b2bdc8542907e6b543a4d", "author": {"user": {"login": "errose28", "name": "Ethan Rose"}}, "url": "https://github.com/apache/ozone/commit/eab4a124b10dd682646b2bdc8542907e6b543a4d", "committedDate": "2020-11-02T22:58:48Z", "message": "Rename static column family options variable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02b81897aebbcf7fea0db69ab17bc97afebcfe15", "author": {"user": {"login": "errose28", "name": "Ethan Rose"}}, "url": "https://github.com/apache/ozone/commit/02b81897aebbcf7fea0db69ab17bc97afebcfe15", "committedDate": "2020-11-03T12:32:21Z", "message": "Fix checkstyle violations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35a6fe102a5c68afc97f93909dd66078159e262e", "author": {"user": {"login": "errose28", "name": "Ethan Rose"}}, "url": "https://github.com/apache/ozone/commit/35a6fe102a5c68afc97f93909dd66078159e262e", "committedDate": "2020-11-03T14:09:58Z", "message": "Retrigger CI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18d90f717e55b76c8695a8cdcd5a7604e7d02c3e", "author": {"user": {"login": "errose28", "name": "Ethan Rose"}}, "url": "https://github.com/apache/ozone/commit/18d90f717e55b76c8695a8cdcd5a7604e7d02c3e", "committedDate": "2020-11-10T19:56:47Z", "message": "Allow cache size to be specified from xml configuration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff1c93a261da055f240b067c2d00bcc0e4b8d600", "author": {"user": {"login": "errose28", "name": "Ethan Rose"}}, "url": "https://github.com/apache/ozone/commit/ff1c93a261da055f240b067c2d00bcc0e4b8d600", "committedDate": "2020-11-10T19:57:09Z", "message": "Add unit test for column family options sharing among containers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e68293a5d67e91af8f3c1bf0d33e597be27e9e4", "author": {"user": {"login": "errose28", "name": "Ethan Rose"}}, "url": "https://github.com/apache/ozone/commit/1e68293a5d67e91af8f3c1bf0d33e597be27e9e4", "committedDate": "2020-11-10T22:27:41Z", "message": "Fix failing unit test by using one static configuration in unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0e65baaf875349b943eb920bab6fbfb78a53294", "author": {"user": {"login": "errose28", "name": "Ethan Rose"}}, "url": "https://github.com/apache/ozone/commit/f0e65baaf875349b943eb920bab6fbfb78a53294", "committedDate": "2020-11-10T22:40:58Z", "message": "Fix checkstyle violation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MDI3MTA3", "url": "https://github.com/apache/ozone/pull/1544#pullrequestreview-528027107", "createdAt": "2020-11-11T10:00:46Z", "commit": {"oid": "18d90f717e55b76c8695a8cdcd5a7604e7d02c3e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMDowMDo0N1rOHxGTpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMDowMDo0N1rOHxGTpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI0NTYwNQ==", "bodyText": "I think a better name for this parameter might be:\n\"hdds.datanode.container.rocksdb.cache.size\"\nThat more clearly says \"this is the cache size for the container rocksDBs\". What do you think?", "url": "https://github.com/apache/ozone/pull/1544#discussion_r521245605", "createdAt": "2020-11-11T10:00:47Z", "author": {"login": "sodonnel"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConfigKeys.java", "diffHunk": "@@ -343,6 +343,11 @@\n   public static final double\n       HDDS_DATANODE_STORAGE_UTILIZATION_CRITICAL_THRESHOLD_DEFAULT = 0.95;\n \n+  public static final String\n+      HDDS_DATANODE_METADATA_CACHE_SIZE = \"hdds.datanode.metadata.cache.size\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18d90f717e55b76c8695a8cdcd5a7604e7d02c3e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MDMzMDky", "url": "https://github.com/apache/ozone/pull/1544#pullrequestreview-528033092", "createdAt": "2020-11-11T10:08:35Z", "commit": {"oid": "18d90f717e55b76c8695a8cdcd5a7604e7d02c3e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMDowODozNVrOHxGlrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMDowODozNVrOHxGlrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI1MDIyMA==", "bodyText": "The usual pattern here is to have a pair of variables name like:\nPARAMETER_KEY\nPARAMETER_DEFAULT\nI think it would be good to change this variable to HDDS_DATANODE_METADATA_CACHE_SIZE_DEFAULT.\nI see some other parameters in this file don't end in \"_KEY\", so I guess it is not essential to rename HDDS_DATANODE_METADATA_CACHE_SIZE to \"HDDS_DATANODE_METADATA_CACHE_SIZE_KEY\".\nIf we change the parameter name to \"hdds.datanode.container.rocksdb.cache.size\" based on the above comment, maybe we should also rename the variables to HDDS_DATANODE_CONTAINER_ROCKSDB_CACHE_SIZE ?", "url": "https://github.com/apache/ozone/pull/1544#discussion_r521250220", "createdAt": "2020-11-11T10:08:35Z", "author": {"login": "sodonnel"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConfigKeys.java", "diffHunk": "@@ -343,6 +343,11 @@\n   public static final double\n       HDDS_DATANODE_STORAGE_UTILIZATION_CRITICAL_THRESHOLD_DEFAULT = 0.95;\n \n+  public static final String\n+      HDDS_DATANODE_METADATA_CACHE_SIZE = \"hdds.datanode.metadata.cache.size\";\n+  public static final String\n+      HDDS_DATANODE_CACHE_SIZE_DEFAULT = \"64MB\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18d90f717e55b76c8695a8cdcd5a7604e7d02c3e"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d99e8c9c7639d2c3c48d7473dfd7ea9a468b0b7", "author": {"user": {"login": "errose28", "name": "Ethan Rose"}}, "url": "https://github.com/apache/ozone/commit/6d99e8c9c7639d2c3c48d7473dfd7ea9a468b0b7", "committedDate": "2020-11-12T20:14:43Z", "message": "Rename cache size configuration to hdds.datanode.metadata.rocksdb.cache.size"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5OTQ4MDcw", "url": "https://github.com/apache/ozone/pull/1544#pullrequestreview-529948070", "createdAt": "2020-11-13T10:29:51Z", "commit": {"oid": "6d99e8c9c7639d2c3c48d7473dfd7ea9a468b0b7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2222, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}