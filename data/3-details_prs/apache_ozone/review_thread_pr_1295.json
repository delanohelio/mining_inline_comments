{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzNzQyOTcx", "number": 1295, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNzowOTo1OVrOEWrZ1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwODoyMzoyOVrOEXGzgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMjE1MjUyOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/container/common/statemachine/commandhandler/TestBlockDeletion.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNzowOTo1OVrOG-DecQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNzowOTo1OVrOG-DecQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcyMTg0MQ==", "bodyText": "Please see #1121 for an attempt to enable this integration test.", "url": "https://github.com/apache/ozone/pull/1295#discussion_r467721841", "createdAt": "2020-08-10T07:09:59Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/container/common/statemachine/commandhandler/TestBlockDeletion.java", "diffHunk": "@@ -82,7 +83,6 @@\n /**\n  * Tests for Block deletion.\n  */\n-@Ignore\n public class TestBlockDeletion {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "194dbf205bc6641d3d2e49f699f1fabbe878615e"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMjIwNDcxOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNzoyOTo0OVrOG-D8bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwNzoyOTo0OVrOG-D8bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzcyOTUxOQ==", "bodyText": "Please extract this block to a new method to keep the level of abstraction consistent.", "url": "https://github.com/apache/ozone/pull/1295#discussion_r467729519", "createdAt": "2020-08-10T07:29:49Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "diffHunk": "@@ -312,6 +312,26 @@ private void processContainer(ContainerID id) {\n           action -> replicas.stream()\n               .noneMatch(r -> r.getDatanodeDetails().equals(action.datanode)));\n \n+      if (state == LifeCycleState.CLOSED) {\n+        // check container key count and bytes used\n+        long maxUsedBytes = 0;\n+        long maxKeyCount = 0;\n+        ContainerReplica[] rps = replicas.toArray(new ContainerReplica[0]);\n+        for (int i = 0; i < rps.length; i++) {\n+          maxUsedBytes = Math.max(maxUsedBytes, rps[i].getBytesUsed());\n+          maxKeyCount = Math.max(maxKeyCount, rps[i].getKeyCount());\n+          LOG.info(\"Replica key count {}, bytes used {}\",\n+              rps[i].getKeyCount(), rps[i].getBytesUsed());\n+        }\n+        if (maxKeyCount < container.getNumberOfKeys()) {\n+          container.setNumberOfKeys(maxKeyCount);\n+        }\n+        if (maxUsedBytes < container.getUsedBytes()) {\n+          container.setUsedBytes(maxUsedBytes);\n+        }\n+        LOG.info(\"Container key count {}, bytes used {}\",\n+            container.getNumberOfKeys(), container.getUsedBytes());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "194dbf205bc6641d3d2e49f699f1fabbe878615e"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMjQxODQ3OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/block/SCMBlockDeletingService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwODozOTozNVrOG-F4ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwODozOTozNVrOG-F4ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc2MTMxMA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      \"Block deletion txnID behinds in datanode {} for containerID {}.\"\n          \n          \n            \n                      \"Block deletion txnID lagging in datanode {} for containerID {}.\"", "url": "https://github.com/apache/ozone/pull/1295#discussion_r467761310", "createdAt": "2020-08-10T08:39:35Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/block/SCMBlockDeletingService.java", "diffHunk": "@@ -109,8 +109,8 @@ public void handlePendingDeletes(PendingDeleteStatusList deletionStatusList) {\n     DatanodeDetails dnDetails = deletionStatusList.getDatanodeDetails();\n     for (PendingDeleteStatusList.PendingDeleteStatus deletionStatus :\n         deletionStatusList.getPendingDeleteStatuses()) {\n-      LOG.info(\n-          \"Block deletion txnID mismatch in datanode {} for containerID {}.\"\n+      LOG.debug(\n+          \"Block deletion txnID behinds in datanode {} for containerID {}.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "194dbf205bc6641d3d2e49f699f1fabbe878615e"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNjY0MTkyOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwODoyMzoyOVrOG-teMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwODoyMzoyOVrOG-teMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQwOTkwNw==", "bodyText": "I think something along the lines of updateContainerStatsFromReplicas would be more descriptive, especially since container state (closed, etc.) is not being changed.", "url": "https://github.com/apache/ozone/pull/1295#discussion_r468409907", "createdAt": "2020-08-11T08:23:29Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "diffHunk": "@@ -766,6 +773,32 @@ private void handleUnstableContainer(final ContainerInfo container,\n \n   }\n \n+  /**\n+   * Check and update Container key count and used bytes based on it's replica's\n+   * data.\n+   */\n+  private void checkAndUpdateContainerState(final ContainerInfo container,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53783daa87d24135aba28ccf9219afe2adc75e72"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4991, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}