{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1MzYzOTYw", "number": 906, "title": "HDDS-3494. Implement ofs://: Support volume and bucket deletion", "bodyText": "What changes were proposed in this pull request?\nSupport volume and bucket deletion directly via ofs://\n\nSupport empty volume and bucket deletion.\nSupport recursive volume and bucket deletion. (see examples below)\n\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3494\nHow was this patch tested?\nTested via contract tests.\nAdded new integration test case.\nExamples", "createdAt": "2020-05-08T18:18:46Z", "url": "https://github.com/apache/ozone/pull/906", "merged": true, "mergeCommit": {"oid": "0773a4aef90d27720c89cdc34dfcba5b0f7de5d5"}, "closed": true, "closedAt": "2020-05-18T16:55:46Z", "author": {"login": "smengcl"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfWAYqAH2gAyNDE1MzYzOTYwOjc2M2JhMjFlYTI3ZmI1MTFjMTYzZGIyN2FkNzlhMjdkYzc5ZWM5OGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchxNVpAH2gAyNDE1MzYzOTYwOmE1YzQyMzM2ODE0MzM1YjFmODExYzJhMjlkZGE0ZTcwMzJlNDA1NWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "763ba21ea27fb511c163db27ad79a27dc79ec98d", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/763ba21ea27fb511c163db27ad79a27dc79ec98d", "committedDate": "2020-05-08T18:16:04Z", "message": "HDDS-3494. Implement ofs://: Support volume and bucket deletion\n\n(cherry picked from commit ac2ffc239b153cbfe54b42fc06c4c5966e131d3e)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dae6acde081a01ee18d676fa14b864890a55bfc7", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/dae6acde081a01ee18d676fa14b864890a55bfc7", "committedDate": "2020-05-08T18:16:20Z", "message": "Improve code readability.\n\n(cherry picked from commit a4fb02933f1d5c103d40561bfe84391b0796aaa8)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c76532e7660ae0a3aec0bca36dae4f1ea0510135", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/c76532e7660ae0a3aec0bca36dae4f1ea0510135", "committedDate": "2020-05-12T18:23:08Z", "message": "Non-recursively deleting volume or bucket should throw PathIsNotEmptyDirectoryException when they are not empty."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "188e06c71937f80a024b82fe7adff6a3cc90bcee", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/188e06c71937f80a024b82fe7adff6a3cc90bcee", "committedDate": "2020-05-12T18:23:54Z", "message": "Fix NPE in delete() where getFileStatus() can return null when a volume doesn't exist."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9716c3b18343c07247951d4f787198ba136a5b91", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/9716c3b18343c07247951d4f787198ba136a5b91", "committedDate": "2020-05-12T18:24:14Z", "message": "Add testDeleteVolumeAndBucket."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMzEzMTM2", "url": "https://github.com/apache/ozone/pull/906#pullrequestreview-411313136", "createdAt": "2020-05-13T21:28:52Z", "commit": {"oid": "9716c3b18343c07247951d4f787198ba136a5b91"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMToyODo1M1rOGVEMJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMToyODo1M1rOGVEMJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc0MTkyNw==", "bodyText": "Replace the rm root logic with a warning. Effectively disallowing admin to use rm -r / to clear the cluster.\nAdmins should re-init the cluster if they really want to clear the cluster.", "url": "https://github.com/apache/ozone/pull/906#discussion_r424741927", "createdAt": "2020-05-13T21:28:53Z", "author": {"login": "smengcl"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java", "diffHunk": "@@ -469,15 +478,76 @@ public boolean delete(Path f, boolean recursive) throws IOException {\n         return false;\n       }\n \n+      OFSPath ofsPath = new OFSPath(key);\n+\n+      // Handle rm root\n+      if (ofsPath.isRoot()) {\n+        Iterator<? extends OzoneVolume> it =\n+            adapterImpl.getObjectStore().listVolumes(\"\");\n+        while (it.hasNext()) {\n+          OzoneVolume volume = it.next();\n+          String nextVolume = addTrailingSlashIfNeeded(\n+              f.toString()) + volume.getName();\n+          delete(new Path(nextVolume), true);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9716c3b18343c07247951d4f787198ba136a5b91"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a8fea368bb67c72a9679845f23664c53d7e1be9", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/8a8fea368bb67c72a9679845f23664c53d7e1be9", "committedDate": "2020-05-13T21:58:29Z", "message": "Drop support for rm root."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNDYwNjc1", "url": "https://github.com/apache/ozone/pull/906#pullrequestreview-411460675", "createdAt": "2020-05-14T04:43:20Z", "commit": {"oid": "8a8fea368bb67c72a9679845f23664c53d7e1be9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNDo0MzoyMFrOGVL3Fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNToyMDoxMFrOGVMZuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg2NzYwNg==", "bodyText": "Before this there is a root validation.\nif (key.equals(\"/\")) {\nLOG.warn(\"Cannot delete root directory.\");\nreturn false;\n}\nIs this above check still needed?", "url": "https://github.com/apache/ozone/pull/906#discussion_r424867606", "createdAt": "2020-05-14T04:43:20Z", "author": {"login": "umamaheswararao"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java", "diffHunk": "@@ -469,15 +478,72 @@ public boolean delete(Path f, boolean recursive) throws IOException {\n         return false;\n       }\n \n+      OFSPath ofsPath = new OFSPath(key);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a8fea368bb67c72a9679845f23664c53d7e1be9"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg2ODIxNg==", "bodyText": "I think we can do this addTrailingSlashIfNeeded(f.toString()) outside of loop once?\npath.toString also does lot of conversions. we can avoid that if we do it outside loop", "url": "https://github.com/apache/ozone/pull/906#discussion_r424868216", "createdAt": "2020-05-14T04:45:56Z", "author": {"login": "umamaheswararao"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java", "diffHunk": "@@ -469,15 +478,72 @@ public boolean delete(Path f, boolean recursive) throws IOException {\n         return false;\n       }\n \n+      OFSPath ofsPath = new OFSPath(key);\n+\n+      // Handle rm root\n+      if (ofsPath.isRoot()) {\n+        // Intentionally drop support for rm root\n+        // because it is too dangerous and doesn't provide much value\n+        LOG.warn(\"delete: OFS does not support rm root. \"\n+            + \"To wipe the cluster, please re-init OM instead.\");\n+        return false;\n+      }\n+\n+      // Handle delete volume\n+      if (ofsPath.isVolume()) {\n+        String volumeName = ofsPath.getVolumeName();\n+        if (recursive) {\n+          // Delete all buckets first\n+          OzoneVolume volume =\n+              adapterImpl.getObjectStore().getVolume(volumeName);\n+          Iterator<? extends OzoneBucket> it = volume.listBuckets(\"\");\n+          while (it.hasNext()) {\n+            OzoneBucket bucket = it.next();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a8fea368bb67c72a9679845f23664c53d7e1be9"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg3MzAzMA==", "bodyText": "Why is this? Do you mind explaining why do we need to create parent dir. Parent dir should not have deleted right? I know its not related to this change, but just for my understanding.", "url": "https://github.com/apache/ozone/pull/906#discussion_r424873030", "createdAt": "2020-05-14T05:06:13Z", "author": {"login": "umamaheswararao"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java", "diffHunk": "@@ -469,15 +478,72 @@ public boolean delete(Path f, boolean recursive) throws IOException {\n         return false;\n       }\n \n+      OFSPath ofsPath = new OFSPath(key);\n+\n+      // Handle rm root\n+      if (ofsPath.isRoot()) {\n+        // Intentionally drop support for rm root\n+        // because it is too dangerous and doesn't provide much value\n+        LOG.warn(\"delete: OFS does not support rm root. \"\n+            + \"To wipe the cluster, please re-init OM instead.\");\n+        return false;\n+      }\n+\n+      // Handle delete volume\n+      if (ofsPath.isVolume()) {\n+        String volumeName = ofsPath.getVolumeName();\n+        if (recursive) {\n+          // Delete all buckets first\n+          OzoneVolume volume =\n+              adapterImpl.getObjectStore().getVolume(volumeName);\n+          Iterator<? extends OzoneBucket> it = volume.listBuckets(\"\");\n+          while (it.hasNext()) {\n+            OzoneBucket bucket = it.next();\n+            String nextBucket = addTrailingSlashIfNeeded(\n+                f.toString()) + bucket.getName();\n+            delete(new Path(nextBucket), true);\n+          }\n+        }\n+        try {\n+          adapterImpl.getObjectStore().deleteVolume(volumeName);\n+          return true;\n+        } catch (OMException ex) {\n+          // volume is not empty\n+          if (ex.getResult() == VOLUME_NOT_EMPTY) {\n+            throw new PathIsNotEmptyDirectoryException(f.toString());\n+          } else {\n+            throw ex;\n+          }\n+        }\n+      }\n+\n       result = innerDelete(f, recursive);\n+\n+      // Handle delete bucket\n+      if (ofsPath.isBucket()) {\n+        OzoneVolume volume =\n+            adapterImpl.getObjectStore().getVolume(ofsPath.getVolumeName());\n+        try {\n+          volume.deleteBucket(ofsPath.getBucketName());\n+          return result;\n+        } catch (OMException ex) {\n+          // bucket is not empty\n+          if (ex.getResult() == BUCKET_NOT_EMPTY) {\n+            throw new PathIsNotEmptyDirectoryException(f.toString());\n+          } else {\n+            throw ex;\n+          }\n+        }\n+      }\n+\n     } else {\n       LOG.debug(\"delete: Path is a file: {}\", f);\n       result = adapter.deleteObject(key);\n     }\n \n     if (result) {\n       // If this delete operation removes all files/directories from the\n-      // parent direcotry, then an empty parent directory must be created.\n+      // parent directory, then an empty parent directory must be created.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a8fea368bb67c72a9679845f23664c53d7e1be9"}, "originalPosition": 138}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg3MzY3NQ==", "bodyText": "I think these test cases should be split into multiple cases?", "url": "https://github.com/apache/ozone/pull/906#discussion_r424873675", "createdAt": "2020-05-14T05:08:54Z", "author": {"login": "umamaheswararao"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/fs/ozone/TestRootedOzoneFileSystem.java", "diffHunk": "@@ -766,4 +768,103 @@ public void testTempMount() throws Exception {\n         fileStatusesInDir1[0].getPath().toUri().getPath());\n   }\n \n+  /**\n+   * Helper function. Check Ozone volume existence.\n+   * @param volumeStr Name of the volume\n+   * @return true if volume exists, false if not\n+   */\n+  private boolean volumeExist(String volumeStr) throws IOException {\n+    try {\n+      objectStore.getVolume(volumeStr);\n+    } catch (OMException ex) {\n+      if (ex.getResult() == VOLUME_NOT_FOUND) {\n+        return false;\n+      } else {\n+        throw ex;\n+      }\n+    }\n+    return true;\n+  }\n+\n+  /**\n+   * Helper function. Delete a path non-recursively and expect failure.\n+   * @param f Path to delete.\n+   * @throws IOException\n+   */\n+  private void deleteNonRecursivelyAndFail(Path f) throws IOException {\n+    try {\n+      fs.delete(f, false);\n+      Assert.fail(\"Should have thrown PathIsNotEmptyDirectoryException!\");\n+    } catch (PathIsNotEmptyDirectoryException ignored) {\n+    }\n+  }\n+\n+  @Test\n+  public void testDeleteVolumeAndBucket() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a8fea368bb67c72a9679845f23664c53d7e1be9"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg3NjQ3Mw==", "bodyText": "Can we add javadoc to delete method here? parent abstract method delete does not provide any javadoc. SO, its good to provide here and explain the behavior?", "url": "https://github.com/apache/ozone/pull/906#discussion_r424876473", "createdAt": "2020-05-14T05:20:10Z", "author": {"login": "umamaheswararao"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java", "diffHunk": "@@ -457,6 +462,10 @@ public boolean delete(Path f, boolean recursive) throws IOException {\n       return false;\n     }\n \n+    if (status == null) {\n+      return false;\n+    }\n+\n     String key = pathToKey(f);\n     boolean result;\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a8fea368bb67c72a9679845f23664c53d7e1be9"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "118dbf6cba9f0a9388f42875fbeea5ae2194d606", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/118dbf6cba9f0a9388f42875fbeea5ae2194d606", "committedDate": "2020-05-14T19:53:42Z", "message": "Split tests. Add testFailToDeleteRoot."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b5b7cae4a86f360ece9ae132444c63361e08f09", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/5b5b7cae4a86f360ece9ae132444c63361e08f09", "committedDate": "2020-05-14T19:56:38Z", "message": "Remove the buggy root check logic inherited from o3fs. Note: o3fs root check is already fixed by HDDS-2973"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88969bb882ed0388ded2a72aa4e5b538c0e554b1", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/88969bb882ed0388ded2a72aa4e5b538c0e554b1", "committedDate": "2020-05-14T19:59:17Z", "message": "Move addTrailingSlashIfNeeded() outside the loop to reduce unnecessary calls."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d7a21b911b7b1ecff3a60443fa72782c5425de0", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/6d7a21b911b7b1ecff3a60443fa72782c5425de0", "committedDate": "2020-05-14T20:43:38Z", "message": "Add appended javadoc for delete()."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8091184c8b34cb2532b3dddf46ff773cd77b3d92", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/8091184c8b34cb2532b3dddf46ff773cd77b3d92", "committedDate": "2020-05-15T18:39:05Z", "message": "Retest 1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5c42336814335b1f811c2a29dda4e7032e4055e", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/a5c42336814335b1f811c2a29dda4e7032e4055e", "committedDate": "2020-05-16T07:05:30Z", "message": "Retest 2"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3233, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}