{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0MTIxMTQx", "number": 1542, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNjozOTowN1rOE4BFcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNjo1OTozMVrOE4BYhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MTczNDg5OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/OzoneClientConfig.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNjozOTowN1rOHxsaow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNjozOTowN1rOHxsaow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg2OTk4Nw==", "bodyText": "Currently validate() is unused.  I think it should have @PostConstruct annotation.", "url": "https://github.com/apache/ozone/pull/1542#discussion_r521869987", "createdAt": "2020-11-12T06:39:07Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/OzoneClientConfig.java", "diffHunk": "@@ -0,0 +1,213 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.\u2002\u2002See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.\u2002\u2002The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ *  with the License.\u2002\u2002You may obtain a copy of the License at\n+ *\n+ * \u2002\u2002\u2002\u2002 http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hdds.scm;\n+\n+import org.apache.hadoop.hdds.conf.Config;\n+import org.apache.hadoop.hdds.conf.ConfigGroup;\n+import org.apache.hadoop.hdds.conf.ConfigTag;\n+import org.apache.hadoop.hdds.conf.ConfigType;\n+import org.apache.hadoop.hdds.protocol.datanode.proto.ContainerProtos.ChecksumType;\n+import org.apache.hadoop.ozone.OzoneConfigKeys;\n+\n+import com.google.common.base.Preconditions;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Configuration values for Ozone Client.\n+ */\n+@ConfigGroup(prefix = \"ozone.client\")\n+public class OzoneClientConfig {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(OzoneClientConfig.class);\n+\n+  @Config(key = \"stream.buffer.flush.size\",\n+      defaultValue = \"16MB\",\n+      type = ConfigType.SIZE,\n+      description = \"Size which determines at what buffer position a partial \"\n+          + \"flush will be initiated during write. It should be a multiple of\"\n+          + \" ozone.client.stream.buffer.size\",\n+      tags = ConfigTag.CLIENT)\n+  private long streamBufferFlushSize = 16 * 1024 * 1024;\n+\n+  @Config(key = \"stream.buffer.size\",\n+      defaultValue = \"4MB\",\n+      type = ConfigType.SIZE,\n+      description = \"The size of chunks the client will send to the server\",\n+      tags = ConfigTag.CLIENT)\n+  private int streamBufferSize = 4 * 1024 * 1024;\n+\n+  @Config(key = \"stream.buffer.flush.delay\",\n+      defaultValue = \"true\",\n+      description = \"Default true, when call flush() and determine whether \"\n+          + \"the data in the current buffer is greater than ozone.client\"\n+          + \".stream.buffer.size, if greater than then send buffer to the \"\n+          + \"datanode. You can  turn this off by setting this configuration \"\n+          + \"to false.\", tags = ConfigTag.CLIENT)\n+  private boolean streamBufferFlushDelay = true;\n+\n+  @Config(key = \"stream.buffer.max.size\",\n+      defaultValue = \"32MB\",\n+      type = ConfigType.SIZE,\n+      description = \"Size which determines at what buffer position write call\"\n+          + \" be blocked till acknowledgement of the first partial flush \"\n+          + \"happens by all servers.\",\n+      tags = ConfigTag.CLIENT)\n+  private long streamBufferMaxSize = 32 * 1024 * 1024;\n+\n+  @Config(key = \"max.retries\",\n+      defaultValue = \"5\",\n+      description = \"Maximum number of retries by Ozone Client on \"\n+          + \"encountering exception while writing a key\",\n+      tags = ConfigTag.CLIENT)\n+  private int maxRetryCount = 5;\n+\n+  @Config(key = \"retry.interval\",\n+      defaultValue = \"0\",\n+      description =\n+          \"Indicates the time duration a client will wait before retrying a \"\n+              + \"write key request on encountering an exception. By default \"\n+              + \"there is no wait\",\n+      tags = ConfigTag.CLIENT)\n+  private int retryInterval = 0;\n+\n+  @Config(key = \"checksum.type\",\n+      defaultValue = \"CRC32\",\n+      description = \"The checksum type [NONE/ CRC32/ CRC32C/ SHA256/ MD5] \"\n+          + \"determines which algorithm would be used to compute checksum for \"\n+          + \"chunk data. Default checksum type is CRC32.\",\n+      tags = ConfigTag.CLIENT)\n+  private String checksumType = ChecksumType.CRC32.name();\n+\n+  @Config(key = \"bytes.per.checksum\",\n+      defaultValue = \"1MB\",\n+      type = ConfigType.SIZE,\n+      description = \"Checksum will be computed for every bytes per checksum \"\n+          + \"number of bytes and stored sequentially. The minimum value for \"\n+          + \"this config is 256KB.\",\n+      tags = ConfigTag.CLIENT)\n+  private int bytesPerChecksum = 1024 * 1024;\n+\n+  @Config(key = \"verify.checksum\",\n+      defaultValue = \"true\",\n+      description = \"Ozone client to verify checksum of the checksum \"\n+          + \"blocksize data.\",\n+      tags = ConfigTag.CLIENT)\n+  private boolean checksumVerify = true;\n+\n+  public OzoneClientConfig() {\n+  }\n+\n+  private void validate() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76d62e56eb4a3bb08c0b26a4e68530109fc18dd3"}, "originalPosition": 117}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MTc1MzIyOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/BlockOutputStreamEntry.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNjo0Njo0MFrOHxsk5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNjo0Njo0MFrOHxsk5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg3MjYxMg==", "bodyText": "This was removed on master in HDDS-4285.  I don't think it should have been restored in the merge.", "url": "https://github.com/apache/ozone/pull/1542#discussion_r521872612", "createdAt": "2020-11-12T06:46:40Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/BlockOutputStreamEntry.java", "diffHunk": "@@ -108,11 +96,12 @@ long getRemaining() {\n    */\n   private void checkStream() throws IOException {\n     if (this.outputStream == null) {\n+      if (getToken() != null) {\n+        UserGroupInformation.getCurrentUser().addToken(getToken());\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76d62e56eb4a3bb08c0b26a4e68530109fc18dd3"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MTc1OTk4OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/rpc/RpcClient.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNjo0OTozNFrOHxsowg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNjo0OTozNFrOHxsowg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg3MzYwMg==", "bodyText": "This condition is not the same as previously.", "url": "https://github.com/apache/ozone/pull/1542#discussion_r521873602", "createdAt": "2020-11-12T06:49:34Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/rpc/RpcClient.java", "diffHunk": "@@ -715,7 +666,7 @@ public OzoneOutputStream createKey(\n       throws IOException {\n     verifyVolumeName(volumeName);\n     verifyBucketName(bucketName);\n-    if(checkKeyNameEnabled) {\n+    if (clientConfig.isStreamBufferFlushDelay()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76d62e56eb4a3bb08c0b26a4e68530109fc18dd3"}, "originalPosition": 131}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MTc3NTA2OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestBlockOutputStream.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNjo1NjowMVrOHxsxYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNjo1NjowMVrOHxsxYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg3NTgxMQ==", "bodyText": "Nit: two blocks of OzoneClientConfig can be merged:\n    OzoneClientConfig clientConfig = conf.getObject(OzoneClientConfig.class);\n    clientConfig.setChecksumType(ChecksumType.NONE);\n    clientConfig.setStreamBufferFlushDelay(false);\n    conf.setFromObject(clientConfig);", "url": "https://github.com/apache/ozone/pull/1542#discussion_r521875811", "createdAt": "2020-11-12T06:56:01Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestBlockOutputStream.java", "diffHunk": "@@ -85,13 +86,20 @@ public static void init() throws Exception {\n     flushSize = 2 * chunkSize;\n     maxFlushSize = 2 * flushSize;\n     blockSize = 2 * maxFlushSize;\n+    OzoneClientConfig config = new OzoneClientConfig();\n+    config.setChecksumType(ChecksumType.NONE);\n+    conf.setFromObject(config);\n+\n     conf.setTimeDuration(HDDS_SCM_WATCHER_TIMEOUT, 1000, TimeUnit.MILLISECONDS);\n     conf.setTimeDuration(OZONE_SCM_STALENODE_INTERVAL, 3, TimeUnit.SECONDS);\n-    conf.set(OzoneConfigKeys.OZONE_CLIENT_CHECKSUM_TYPE, \"NONE\");\n     conf.setQuietMode(false);\n     conf.setStorageSize(OzoneConfigKeys.OZONE_SCM_BLOCK_SIZE, 4,\n         StorageUnit.MB);\n-    conf.setBoolean(OZONE_CLIENT_STREAM_BUFFER_FLUSH_DELAY, false);\n+\n+    OzoneClientConfig clientConfig = conf.getObject(OzoneClientConfig.class);\n+    clientConfig.setStreamBufferFlushDelay(false);\n+    conf.setFromObject(clientConfig);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76d62e56eb4a3bb08c0b26a4e68530109fc18dd3"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MTc4MzcyOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClient.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNjo1OTozMVrOHxs2XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QwODo0NDo1N1rOHylZKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg3NzA4NQ==", "bodyText": "Nit: aren't defaults set automatically without this?", "url": "https://github.com/apache/ozone/pull/1542#discussion_r521877085", "createdAt": "2020-11-12T06:59:31Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClient.java", "diffHunk": "@@ -49,6 +51,7 @@\n   @BeforeClass\n   public static void init() throws Exception {\n     OzoneConfiguration conf = new OzoneConfiguration();\n+    conf.setFromObject(new OzoneClientConfig());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76d62e56eb4a3bb08c0b26a4e68530109fc18dd3"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjgwMzQ5OA==", "bodyText": "Yes, it's supposed to be set. I was confused by the other pattern used elsewhere:\n\ncreate OzoneConfig\nset custom properties by setter\nHere we need to export OzoneClientConfig\nmodify tags\nreset OzoneClientConfig to OzoneConfig", "url": "https://github.com/apache/ozone/pull/1542#discussion_r522803498", "createdAt": "2020-11-13T08:44:57Z", "author": {"login": "elek"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClient.java", "diffHunk": "@@ -49,6 +51,7 @@\n   @BeforeClass\n   public static void init() throws Exception {\n     OzoneConfiguration conf = new OzoneConfiguration();\n+    conf.setFromObject(new OzoneClientConfig());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTg3NzA4NQ=="}, "originalCommit": {"oid": "76d62e56eb4a3bb08c0b26a4e68530109fc18dd3"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4682, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}