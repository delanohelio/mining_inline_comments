{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0MDk4Mjkx", "number": 455, "title": "HDDS-2895. Generate only the required keytabs for docker based secure tests", "bodyText": "What changes were proposed in this pull request?\nWe have acceptance tests with the help of docker/docker-compose where we generate the keytab files on the fly with the help of a lightweight (unsecure) REST endpoint.\nBut this generation can be very slow especially when the DNS is slow. When I start a VPN the secure cluster can't be started in the 90 sec period. (>100 keytabs are generated and one keytab generation is ~5 sec).\nThe solutions is to generate only the required keystabs in each of the containers.\nInstead of request all the possible keytabs in the generic docker-config:\nKERBEROS_KEYTABS=dn om scm HTTP testuser testuser2 s3g \n\nWe can defined the required keytabs per service (in docker-compose.yaml)\nenvironment:\n  KERBEROS_KEYTABS=scm HTTP\n\nWith this approach ~20 keytab file will be generated instead of >100 and the secure tests will be significant faster.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-2895\nHow was this patch tested?\nThis is an acceptance test improvements. If they are passed, it should be fine...", "createdAt": "2020-01-17T11:31:04Z", "url": "https://github.com/apache/ozone/pull/455", "merged": true, "mergeCommit": {"oid": "c8bc3b7aca182ffad7c349d1dad96041359a64b0"}, "closed": true, "closedAt": "2020-01-23T13:34:17Z", "author": {"login": "elek"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7MxhogH2gAyMzY0MDk4MjkxOjViMDAyYWVlYWI5YTUyMTkxNThiYmJjOGI4YmQxMzJhYTI2N2QyY2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9KbdOgFqTM0NzI5NjU3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5b002aeeab9a5219158bbbc8b8bd132aa267d2cd", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/5b002aeeab9a5219158bbbc8b8bd132aa267d2cd", "committedDate": "2020-01-17T11:09:25Z", "message": "HDDS-2895. Generate only the required keytabs for docker based secure tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NTg0MjEx", "url": "https://github.com/apache/ozone/pull/455#pullrequestreview-344584211", "createdAt": "2020-01-17T13:42:45Z", "commit": {"oid": "5b002aeeab9a5219158bbbc8b8bd132aa267d2cd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxMzo0Mjo0NVrOFe5TJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxMzo0Mjo0NVrOFe5TJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzk0MDM4OQ==", "bodyText": "Seems like acceptance test failure is caused by missing HTTP keytab on datanode.\ndatanode_1  | 2020-01-17 12:30:34,899 [main] ERROR ozone.HddsDatanodeService: HttpServer failed to start.\n...\ndatanode_1  | Caused by: javax.servlet.ServletException: javax.servlet.ServletException: Keytab does not exist: /etc/security/keytabs/HTTP.keytab\n\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  KERBEROS_KEYTABS: dn\n          \n          \n            \n                  KERBEROS_KEYTABS: dn HTTP", "url": "https://github.com/apache/ozone/pull/455#discussion_r367940389", "createdAt": "2020-01-17T13:42:45Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/dist/src/main/compose/ozonesecure/docker-compose.yaml", "diffHunk": "@@ -42,6 +41,8 @@ services:\n     command: [\"/opt/hadoop/bin/ozone\",\"datanode\"]\n     env_file:\n       - docker-config\n+    environment:\n+      KERBEROS_KEYTABS: dn", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b002aeeab9a5219158bbbc8b8bd132aa267d2cd"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NzEzMzUw", "url": "https://github.com/apache/ozone/pull/455#pullrequestreview-344713350", "createdAt": "2020-01-17T16:57:28Z", "commit": {"oid": "5b002aeeab9a5219158bbbc8b8bd132aa267d2cd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNjo1NzoyOVrOFe_Q_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNjo1NzoyOVrOFe_Q_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAzODE0Mg==", "bodyText": "should we have recon in the no_proxy list?", "url": "https://github.com/apache/ozone/pull/455#discussion_r368038142", "createdAt": "2020-01-17T16:57:29Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/dist/src/main/compose/ozonesecure/docker-config", "diffHunk": "@@ -80,12 +80,11 @@ HDFS-SITE.XML_rpc.metrics.percentiles.intervals=60,300\n OZONE_DATANODE_SECURE_USER=root\n SECURITY_ENABLED=true\n KEYTAB_DIR=/etc/security/keytabs\n-KERBEROS_KEYTABS=dn om scm HTTP testuser testuser2 s3g\n KERBEROS_KEYSTORES=hadoop\n KERBEROS_SERVER=kdc\n JAVA_HOME=/usr/lib/jvm/jre\n JSVC_HOME=/usr/bin\n SLEEP_SECONDS=5\n KERBEROS_ENABLED=true\n \n-no_proxy=om,scm,s3g,kdc,localhost,127.0.0.1\n\\ No newline at end of file\n+no_proxy=om,scm,s3g,kdc,localhost,127.0.0.1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b002aeeab9a5219158bbbc8b8bd132aa267d2cd"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a451cf2214e44d3a7ac92a00f56f03d31f035ac", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/6a451cf2214e44d3a7ac92a00f56f03d31f035ac", "committedDate": "2020-01-18T12:32:14Z", "message": "Update hadoop-ozone/dist/src/main/compose/ozonesecure/docker-compose.yaml\n\nCo-Authored-By: Doroszlai, Attila <6454655+adoroszlai@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c375ce10276b446b3cd08bbbdbbad49365e989f1", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/c375ce10276b446b3cd08bbbdbbad49365e989f1", "committedDate": "2020-01-20T10:28:11Z", "message": "generate testuser keytab for s3g tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MDcxOTYy", "url": "https://github.com/apache/ozone/pull/455#pullrequestreview-346071962", "createdAt": "2020-01-21T17:49:59Z", "commit": {"oid": "c375ce10276b446b3cd08bbbdbbad49365e989f1"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b43cbb385dccfeecb435e94db805251c2b8ecb9b", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/b43cbb385dccfeecb435e94db805251c2b8ecb9b", "committedDate": "2020-01-22T13:58:01Z", "message": "add testuser2 for secure fs tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3Mjk2NTc5", "url": "https://github.com/apache/ozone/pull/455#pullrequestreview-347296579", "createdAt": "2020-01-23T13:32:42Z", "commit": {"oid": "b43cbb385dccfeecb435e94db805251c2b8ecb9b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMzozMjo0MlrOFg-MYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMzozMjo0MlrOFg-MYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDExNzcyOA==", "bodyText": "This was added in another task, only newline at EOF is changed.  So I think it should be addressed in a new Jira.", "url": "https://github.com/apache/ozone/pull/455#discussion_r370117728", "createdAt": "2020-01-23T13:32:42Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/dist/src/main/compose/ozonesecure/docker-config", "diffHunk": "@@ -80,12 +80,11 @@ HDFS-SITE.XML_rpc.metrics.percentiles.intervals=60,300\n OZONE_DATANODE_SECURE_USER=root\n SECURITY_ENABLED=true\n KEYTAB_DIR=/etc/security/keytabs\n-KERBEROS_KEYTABS=dn om scm HTTP testuser testuser2 s3g\n KERBEROS_KEYSTORES=hadoop\n KERBEROS_SERVER=kdc\n JAVA_HOME=/usr/lib/jvm/jre\n JSVC_HOME=/usr/bin\n SLEEP_SECONDS=5\n KERBEROS_ENABLED=true\n \n-no_proxy=om,scm,s3g,kdc,localhost,127.0.0.1\n\\ No newline at end of file\n+no_proxy=om,scm,s3g,kdc,localhost,127.0.0.1", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAzODE0Mg=="}, "originalCommit": {"oid": "5b002aeeab9a5219158bbbc8b8bd132aa267d2cd"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3696, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}