{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUxMjcxMDgx", "number": 1214, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0MDoyMlrOES8H_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMTo0MToxMlrOEU0DEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4Mjk0OTExOnYy", "diffSide": "LEFT", "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientGrpc.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0MDoyMlrOG4Zm7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMTo0MjozM1rOHQGxFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MzAwNw==", "bodyText": "Full DatanodeDetails.toString() include a lot of information and can hurt the perf on critical path. Consider using either ip or uuid instead.", "url": "https://github.com/apache/ozone/pull/1214#discussion_r461793007", "createdAt": "2020-07-28T18:40:22Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientGrpc.java", "diffHunk": "@@ -354,7 +363,7 @@ private XceiverClientReply sendCommandWithRetry(\n         responseProto = null;\n       } catch (ExecutionException e) {\n         LOG.debug(\"Failed to execute command {} on datanode {}\",\n-            request, dn.getUuid(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a3d7b3fb72011bb512eccfb4f216f239f3f6001"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwNDMxOQ==", "bodyText": "I hope to using ip and uuid like ip/uuid, do you think it is ok for you?\nBecause, i want to get the ip so that i can clearly know the exception related to which datanode, but in local mode, all of ips of datanode are the same, for this situation, an addition uuid can help me to distinguish.", "url": "https://github.com/apache/ozone/pull/1214#discussion_r462704319", "createdAt": "2020-07-30T02:55:38Z", "author": {"login": "maobaolong"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientGrpc.java", "diffHunk": "@@ -354,7 +363,7 @@ private XceiverClientReply sendCommandWithRetry(\n         responseProto = null;\n       } catch (ExecutionException e) {\n         LOG.debug(\"Failed to execute command {} on datanode {}\",\n-            request, dn.getUuid(), e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MzAwNw=="}, "originalCommit": {"oid": "6a3d7b3fb72011bb512eccfb4f216f239f3f6001"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY1MDEzNA==", "bodyText": "I think ip address should be sufficient for production environment. The local mode is for mini clsuter test only.", "url": "https://github.com/apache/ozone/pull/1214#discussion_r486650134", "createdAt": "2020-09-10T21:42:33Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientGrpc.java", "diffHunk": "@@ -354,7 +363,7 @@ private XceiverClientReply sendCommandWithRetry(\n         responseProto = null;\n       } catch (ExecutionException e) {\n         LOG.debug(\"Failed to execute command {} on datanode {}\",\n-            request, dn.getUuid(), e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MzAwNw=="}, "originalCommit": {"oid": "6a3d7b3fb72011bb512eccfb4f216f239f3f6001"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4Mjk1MDYzOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientGrpc.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0MDo0OFrOG4Znxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMTo0MTowMlrOHQGuhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MzIyMw==", "bodyText": "This needs to be guarded by if (LOG.isDebugEnabled())", "url": "https://github.com/apache/ozone/pull/1214#discussion_r461793223", "createdAt": "2020-07-28T18:40:48Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientGrpc.java", "diffHunk": "@@ -354,7 +363,7 @@ private XceiverClientReply sendCommandWithRetry(\n         responseProto = null;\n       } catch (ExecutionException e) {\n         LOG.debug(\"Failed to execute command {} on datanode {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a3d7b3fb72011bb512eccfb4f216f239f3f6001"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwNTc2MQ==", "bodyText": "I think for this case, the if (LOG.isDebugEnabled()) guard is redundancy, because, the L365 have no any need compute parameter, all arguments are reference, for the LOG.debug, lets go into the implementation of Log4jLoggerAdapter, the if (LOG.isDebugEnabled()) is there\n  public void debug(String format, Object... arguments) {\n    if (this.logger.isDebugEnabled()) {\n      FormattingTuple ft = MessageFormatter.arrayFormat(format, arguments);\n      this.logger.log(FQCN, Level.DEBUG, ft.getMessage(), ft.getThrowable());\n    }\n  }", "url": "https://github.com/apache/ozone/pull/1214#discussion_r462705761", "createdAt": "2020-07-30T03:00:52Z", "author": {"login": "maobaolong"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientGrpc.java", "diffHunk": "@@ -354,7 +363,7 @@ private XceiverClientReply sendCommandWithRetry(\n         responseProto = null;\n       } catch (ExecutionException e) {\n         LOG.debug(\"Failed to execute command {} on datanode {}\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MzIyMw=="}, "originalCommit": {"oid": "6a3d7b3fb72011bb512eccfb4f216f239f3f6001"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY0OTQ3OQ==", "bodyText": "Good point, you are right on this.", "url": "https://github.com/apache/ozone/pull/1214#discussion_r486649479", "createdAt": "2020-09-10T21:41:02Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientGrpc.java", "diffHunk": "@@ -354,7 +363,7 @@ private XceiverClientReply sendCommandWithRetry(\n         responseProto = null;\n       } catch (ExecutionException e) {\n         LOG.debug(\"Failed to execute command {} on datanode {}\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MzIyMw=="}, "originalCommit": {"oid": "6a3d7b3fb72011bb512eccfb4f216f239f3f6001"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4Mjk1NjgwOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientGrpc.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0Mjo0MlrOG4Zrow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMToyOTozNFrOHRtLpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NDIxMQ==", "bodyText": "In sendCommandAsync() below we already have a LOG.debug(cmdType, Dn). Can you move this there to avoid duplicate debug log?", "url": "https://github.com/apache/ozone/pull/1214#discussion_r461794211", "createdAt": "2020-07-28T18:42:42Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientGrpc.java", "diffHunk": "@@ -339,6 +343,11 @@ private XceiverClientReply sendCommandWithRetry(\n         // in case these don't exist for the specific datanode.\n         reply.addDatanode(dn);\n         responseProto = sendCommandAsync(request, dn).getResponse().get();\n+        if (LOG.isDebugEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a3d7b3fb72011bb512eccfb4f216f239f3f6001"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcwNTY2Mg==", "bodyText": "@xiaoyuyao I hope so, but I think it would be difficult, because, i want to log the retry index and cost time.\nwhen the sendCommandAsync  return back, the client still doesn't get the result from datanode. the result return until the get return.\nIf i have something wrong, please correct me.", "url": "https://github.com/apache/ozone/pull/1214#discussion_r462705662", "createdAt": "2020-07-30T03:00:30Z", "author": {"login": "maobaolong"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientGrpc.java", "diffHunk": "@@ -339,6 +343,11 @@ private XceiverClientReply sendCommandWithRetry(\n         // in case these don't exist for the specific datanode.\n         reply.addDatanode(dn);\n         responseProto = sendCommandAsync(request, dn).getResponse().get();\n+        if (LOG.isDebugEnabled()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NDIxMQ=="}, "originalCommit": {"oid": "6a3d7b3fb72011bb512eccfb4f216f239f3f6001"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY1MjU3Mw==", "bodyText": "I mean if we could move the LOG for latency around Line 464 where the container op latency metrics are updated. This way, we can piggyback LOG with the existing metrics update.\nmetrics.addContainerOpsLatency(request.getCmdType(),\nSystem.nanoTime() - requestTime);", "url": "https://github.com/apache/ozone/pull/1214#discussion_r486652573", "createdAt": "2020-09-10T21:48:14Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientGrpc.java", "diffHunk": "@@ -339,6 +343,11 @@ private XceiverClientReply sendCommandWithRetry(\n         // in case these don't exist for the specific datanode.\n         reply.addDatanode(dn);\n         responseProto = sendCommandAsync(request, dn).getResponse().get();\n+        if (LOG.isDebugEnabled()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NDIxMQ=="}, "originalCommit": {"oid": "6a3d7b3fb72011bb512eccfb4f216f239f3f6001"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMyODEwMw==", "bodyText": "@xiaoyuyao Thanks you for your reply and suggestion. I tried to add the LOG into the L464, like following\n              public void onNext(ContainerCommandResponseProto value) {\n                replyFuture.complete(value);\n                metrics.decrPendingContainerOpsMetrics(request.getCmdType());\n                long cost = System.nanoTime() - requestTime;\n                metrics.addContainerOpsLatency(request.getCmdType(),\n                    cost);\n                if (LOG.isDebugEnabled()) {\n                  LOG.debug(\"Executed command {} on datanode {}, cost = {}, \"\n                          + \"retryCount = {}\" + \", cmdType = {}\", request, dn,\n                      cost, index, request.getCmdType());\n                }\n                semaphore.release();\n              }\nBut, there are some question\n\nIt cannot print the Index which stand for the retried datanode index of the datanodeList.\nI should add the same log logic to the onError also? Otherwise, when we met error, the onNext won't be executed.\n\nAs index can be calculate from the log context, I drop it.", "url": "https://github.com/apache/ozone/pull/1214#discussion_r488328103", "createdAt": "2020-09-15T01:29:34Z", "author": {"login": "maobaolong"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientGrpc.java", "diffHunk": "@@ -339,6 +343,11 @@ private XceiverClientReply sendCommandWithRetry(\n         // in case these don't exist for the specific datanode.\n         reply.addDatanode(dn);\n         responseProto = sendCommandAsync(request, dn).getResponse().get();\n+        if (LOG.isDebugEnabled()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NDIxMQ=="}, "originalCommit": {"oid": "6a3d7b3fb72011bb512eccfb4f216f239f3f6001"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMjU5NzMwOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientGrpc.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwMTo0MToxMlrOG7OEsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwMjoyMDoyNVrOG9_2Ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0OTc0Nw==", "bodyText": "Correct me if I'm wrong, I think we have already print the same debug message on Line 338-340 from the caller. Print just the IP address should be sufficient.", "url": "https://github.com/apache/ozone/pull/1214#discussion_r464749747", "createdAt": "2020-08-04T01:41:12Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientGrpc.java", "diffHunk": "@@ -433,7 +442,7 @@ public XceiverClientReply sendCommandAsync(\n     UUID dnId = dn.getUuid();\n     if (LOG.isDebugEnabled()) {\n       LOG.debug(\"Send command {} to datanode {}\",\n-          request.getCmdType(), dn.getNetworkFullPath());\n+          request.getCmdType(), dn);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a3d7b3fb72011bb512eccfb4f216f239f3f6001"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2MjM5NQ==", "bodyText": "OK, you are right, the redundancy log content is useless, I've change it to dn.getIpAddress().", "url": "https://github.com/apache/ozone/pull/1214#discussion_r467662395", "createdAt": "2020-08-10T02:20:25Z", "author": {"login": "maobaolong"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/XceiverClientGrpc.java", "diffHunk": "@@ -433,7 +442,7 @@ public XceiverClientReply sendCommandAsync(\n     UUID dnId = dn.getUuid();\n     if (LOG.isDebugEnabled()) {\n       LOG.debug(\"Send command {} to datanode {}\",\n-          request.getCmdType(), dn.getNetworkFullPath());\n+          request.getCmdType(), dn);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc0OTc0Nw=="}, "originalCommit": {"oid": "6a3d7b3fb72011bb512eccfb4f216f239f3f6001"}, "originalPosition": 46}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3995, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}