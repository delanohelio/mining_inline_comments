{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzNDA5NTQw", "number": 1537, "title": "HDDS-4413. Container replication should fail in case of import failure.", "bodyText": "What changes were proposed in this pull request?\nIn case of a failure during the importContainer phase the replication task status should be failed rather than being success.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4413\nHow was this patch tested?\nAdded a UT in TestReplicationSupervisor", "createdAt": "2020-10-31T10:26:03Z", "url": "https://github.com/apache/ozone/pull/1537", "merged": true, "mergeCommit": {"oid": "ca220f96516d7f4036963f8cf1e0f501e09a870a"}, "closed": true, "closedAt": "2020-11-04T03:54:36Z", "author": {"login": "ayushtkn"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdX4tWtgH2gAyNTEzNDA5NTQwOmY3ZjM0ODE4NTg1MDI2MTg3MTFmYzAzNzAxYWMzMjFlMWY0ZTdiYmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY-oXGgFqTUyMjgyNjA3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f7f3481858502618711fc03701ac321e1f4e7bbd", "author": {"user": {"login": "ayushtkn", "name": "Ayush Saxena"}}, "url": "https://github.com/apache/ozone/commit/f7f3481858502618711fc03701ac321e1f4e7bbd", "committedDate": "2020-10-31T10:21:43Z", "message": "HDDS-4413. Container replication logs success despite import failure."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNjc3MDU4", "url": "https://github.com/apache/ozone/pull/1537#pullrequestreview-522677058", "createdAt": "2020-11-03T16:34:17Z", "commit": {"oid": "f7f3481858502618711fc03701ac321e1f4e7bbd"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNjozNDoxOFrOHs3CdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNzowOTowN1rOHs4hIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwMTE0MQ==", "bodyText": "I think we should remove this catch block completely.  Logging the same exception both here and in the caller (replicate()) is IMO unnecessary.", "url": "https://github.com/apache/ozone/pull/1537#discussion_r516801141", "createdAt": "2020-11-03T16:34:18Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/replication/DownloadAndImportReplicator.java", "diffHunk": "@@ -89,6 +91,7 @@ public void importContainer(long containerID, Path tarFilePath) {\n       LOG.error(\n           \"Can't import the downloaded container data id=\" + containerID,\n           e);\n+      throw e;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7f3481858502618711fc03701ac321e1f4e7bbd"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgwMTY1MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  LOG.error(\"Container replication was unsuccessful.\", e);\n          \n          \n            \n                  LOG.error(\"Container {} replication was unsuccessful.\", containerID, e);", "url": "https://github.com/apache/ozone/pull/1537#discussion_r516801651", "createdAt": "2020-11-03T16:35:03Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/replication/DownloadAndImportReplicator.java", "diffHunk": "@@ -122,7 +125,7 @@ public void replicate(ReplicationTask task) {\n       LOG.info(\"Container {} is replicated successfully\", containerID);\n       task.setStatus(Status.DONE);\n     } catch (Exception e) {\n-      LOG.error(\"Container replication was unsuccessful .\", e);\n+      LOG.error(\"Container replication was unsuccessful.\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7f3481858502618711fc03701ac321e1f4e7bbd"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgyNTM3Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                res.complete(Paths.get(\"file:/tmp/file\"));\n          \n          \n            \n                res.complete(Paths.get(\"file:/tmp/no-such-file\"));\n          \n      \n    \n    \n  \n\nThis would document that the expected failure is due to FileNotFoundException.", "url": "https://github.com/apache/ozone/pull/1537#discussion_r516825377", "createdAt": "2020-11-03T17:09:07Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/replication/TestReplicationSupervisor.java", "diffHunk": "@@ -173,6 +178,36 @@ public void stalledDownload() {\n     }\n   }\n \n+  @Test\n+  public void testDownloadAndImportReplicatorFailure() {\n+    ReplicationSupervisor supervisor =\n+        new ReplicationSupervisor(set, mutableReplicator,\n+            newDirectExecutorService());\n+\n+    // Mock to fetch an exception in the importContainer method.\n+    SimpleContainerDownloader moc =\n+        Mockito.mock(SimpleContainerDownloader.class);\n+    CompletableFuture<Path> res = new CompletableFuture<>();\n+    res.complete(Paths.get(\"file:/tmp/file\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7f3481858502618711fc03701ac321e1f4e7bbd"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9839940507602338e1ba98637f50461e19bf685e", "author": {"user": {"login": "ayushtkn", "name": "Ayush Saxena"}}, "url": "https://github.com/apache/ozone/commit/9839940507602338e1ba98637f50461e19bf685e", "committedDate": "2020-11-03T18:55:16Z", "message": "Handle review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyODI2MDc3", "url": "https://github.com/apache/ozone/pull/1537#pullrequestreview-522826077", "createdAt": "2020-11-03T19:49:37Z", "commit": {"oid": "9839940507602338e1ba98637f50461e19bf685e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2201, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}