{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0MjYyMDkx", "number": 1162, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMjozNToyMVrOEL3VPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjoxNzo1MFrOEMDPxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwODc2MzQ4OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMjozNToyMVrOGtpNdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQyMzoyMToxNlrOGvk7gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUxNDI5NQ==", "bodyText": "NIT: this line to move the line to calculate delta from 547->549 is not needed.  Only the line 550 is the core change that breaks out when we've already handle the under replicate container via inflight replication.", "url": "https://github.com/apache/ozone/pull/1162#discussion_r450514295", "createdAt": "2020-07-06T22:35:21Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "diffHunk": "@@ -543,11 +543,15 @@ private void handleUnderReplicatedContainer(final ContainerInfo container,\n         List<DatanodeDetails> targetReplicas = new ArrayList<>(source);\n         // Then add any pending additions\n         targetReplicas.addAll(replicationInFlight);\n-\n-        int delta = replicationFactor - getReplicaCount(id, replicas);\n         final ContainerPlacementStatus placementStatus =\n             containerPlacement.validateContainerPlacement(\n                 targetReplicas, replicationFactor);\n+        int delta = replicationFactor - getReplicaCount(id, replicas);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1aa46bc3e13b64e27058d2afad5f321c9bc57ec"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjAzNTIzMg==", "bodyText": "This delta calculation and check in line 550 is required.  Currenlty placementStatus.isPolicySatisfied() only checks whether topology requirement is satisfied or not. It doesn't check whether it has enough replicas.", "url": "https://github.com/apache/ozone/pull/1162#discussion_r452035232", "createdAt": "2020-07-09T08:00:25Z", "author": {"login": "ChenSammi"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "diffHunk": "@@ -543,11 +543,15 @@ private void handleUnderReplicatedContainer(final ContainerInfo container,\n         List<DatanodeDetails> targetReplicas = new ArrayList<>(source);\n         // Then add any pending additions\n         targetReplicas.addAll(replicationInFlight);\n-\n-        int delta = replicationFactor - getReplicaCount(id, replicas);\n         final ContainerPlacementStatus placementStatus =\n             containerPlacement.validateContainerPlacement(\n                 targetReplicas, replicationFactor);\n+        int delta = replicationFactor - getReplicaCount(id, replicas);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUxNDI5NQ=="}, "originalCommit": {"oid": "e1aa46bc3e13b64e27058d2afad5f321c9bc57ec"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU0MTMxNQ==", "bodyText": "Got it. I agree delta calculation is needed. I mean move delta calculation after placementStatus is not necessary.", "url": "https://github.com/apache/ozone/pull/1162#discussion_r452541315", "createdAt": "2020-07-09T23:21:16Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "diffHunk": "@@ -543,11 +543,15 @@ private void handleUnderReplicatedContainer(final ContainerInfo container,\n         List<DatanodeDetails> targetReplicas = new ArrayList<>(source);\n         // Then add any pending additions\n         targetReplicas.addAll(replicationInFlight);\n-\n-        int delta = replicationFactor - getReplicaCount(id, replicas);\n         final ContainerPlacementStatus placementStatus =\n             containerPlacement.validateContainerPlacement(\n                 targetReplicas, replicationFactor);\n+        int delta = replicationFactor - getReplicaCount(id, replicas);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUxNDI5NQ=="}, "originalCommit": {"oid": "e1aa46bc3e13b64e27058d2afad5f321c9bc57ec"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMDcxNTU4OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjoxNzo1MFrOGt75LQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwODozMDoyMlrOGvHFgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyMDM5Nw==", "bodyText": "Rather than this new IF block here, would it make sense to simply add:\nif (replicasNeeded <= 0) {\n  LOG.debug(...);\n  return;\n}\n\nAt line 554 / 558, just after the line:\n        final int replicasNeeded\n            = delta < misRepDelta ? misRepDelta : delta;\n\nThat would avoid needing to check call placementStatus.isPolicySatisfied() and then placementStatus.misReplicationCount() afterwards, as misReplicationCount() calls isPolicySatisfied() anyway.", "url": "https://github.com/apache/ozone/pull/1162#discussion_r450820397", "createdAt": "2020-07-07T12:17:50Z", "author": {"login": "sodonnel"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "diffHunk": "@@ -543,11 +543,15 @@ private void handleUnderReplicatedContainer(final ContainerInfo container,\n         List<DatanodeDetails> targetReplicas = new ArrayList<>(source);\n         // Then add any pending additions\n         targetReplicas.addAll(replicationInFlight);\n-\n-        int delta = replicationFactor - getReplicaCount(id, replicas);\n         final ContainerPlacementStatus placementStatus =\n             containerPlacement.validateContainerPlacement(\n                 targetReplicas, replicationFactor);\n+        int delta = replicationFactor - getReplicaCount(id, replicas);\n+        if (placementStatus.isPolicySatisfied() && delta <= 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1aa46bc3e13b64e27058d2afad5f321c9bc57ec"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA1MjM1Mg==", "bodyText": "Make sense.", "url": "https://github.com/apache/ozone/pull/1162#discussion_r452052352", "createdAt": "2020-07-09T08:30:22Z", "author": {"login": "ChenSammi"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "diffHunk": "@@ -543,11 +543,15 @@ private void handleUnderReplicatedContainer(final ContainerInfo container,\n         List<DatanodeDetails> targetReplicas = new ArrayList<>(source);\n         // Then add any pending additions\n         targetReplicas.addAll(replicationInFlight);\n-\n-        int delta = replicationFactor - getReplicaCount(id, replicas);\n         final ContainerPlacementStatus placementStatus =\n             containerPlacement.validateContainerPlacement(\n                 targetReplicas, replicationFactor);\n+        int delta = replicationFactor - getReplicaCount(id, replicas);\n+        if (placementStatus.isPolicySatisfied() && delta <= 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyMDM5Nw=="}, "originalCommit": {"oid": "e1aa46bc3e13b64e27058d2afad5f321c9bc57ec"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4161, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}