{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUzOTY0Njg5", "number": 1227, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwMzozOToyNFrOEQc2nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxOToxMDo1NFrOEQwpCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1Njg1NDA0OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwMzozOToyNFrOG0m7kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwMzozOToyNFrOG0m7kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgxNjk3Ng==", "bodyText": "What is the implication of hard-coding the transaction id = 1, especially for existing clusters where the s3 volume may not exist?", "url": "https://github.com/apache/ozone/pull/1227#discussion_r457816976", "createdAt": "2020-07-21T03:39:24Z", "author": {"login": "arp7"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3502,4 +3516,95 @@ public boolean getEnableFileSystemPaths() {\n     return configuration.getBoolean(OZONE_OM_ENABLE_FILESYSTEM_PATHS,\n         OZONE_OM_ENABLE_FILESYSTEM_PATHS_DEFAULT);\n   }\n+\n+  /**\n+   * Create volume which is required for S3Gateway operations.\n+   * @throws IOException\n+   */\n+  private void addS3GVolumeToDB() throws IOException {\n+    String s3VolumeName = HddsClientUtils.getS3VolumeName(configuration);\n+    String dbVolumeKey = metadataManager.getVolumeKey(s3VolumeName);\n+\n+    if (!s3VolumeName.equals(OzoneConfigKeys.OZONE_S3_VOLUME_NAME_DEFAULT)) {\n+      LOG.warn(\"Make sure that all S3Gateway use same volume name.\" +\n+          \" Otherwise user need to manually create/configure Volume \" +\n+          \"configured by S3Gateway\");\n+    }\n+    if (!metadataManager.getVolumeTable().isExist(dbVolumeKey)) {\n+      long transactionID = 1L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19372393899cccecb10730a141b522cc239a092f"}, "originalPosition": 99}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NjkwMTI4OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNDowODo1M1rOG0nXnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNDowODo1M1rOG0nXnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzgyNDE1OQ==", "bodyText": "I looked into this function. I think hard-coding the transaction ID may be risky in a cluster where there are already some Ratis transactions however the s3v volume was not yet created. Perhaps we can set it to a really high value, something that is very unlikely to be hit in a real cluster. Like (MAX_ULONG - 1) >> 8", "url": "https://github.com/apache/ozone/pull/1227#discussion_r457824159", "createdAt": "2020-07-21T04:08:53Z", "author": {"login": "arp7"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3502,4 +3516,95 @@ public boolean getEnableFileSystemPaths() {\n     return configuration.getBoolean(OZONE_OM_ENABLE_FILESYSTEM_PATHS,\n         OZONE_OM_ENABLE_FILESYSTEM_PATHS_DEFAULT);\n   }\n+\n+  /**\n+   * Create volume which is required for S3Gateway operations.\n+   * @throws IOException\n+   */\n+  private void addS3GVolumeToDB() throws IOException {\n+    String s3VolumeName = HddsClientUtils.getS3VolumeName(configuration);\n+    String dbVolumeKey = metadataManager.getVolumeKey(s3VolumeName);\n+\n+    if (!s3VolumeName.equals(OzoneConfigKeys.OZONE_S3_VOLUME_NAME_DEFAULT)) {\n+      LOG.warn(\"Make sure that all S3Gateway use same volume name.\" +\n+          \" Otherwise user need to manually create/configure Volume \" +\n+          \"configured by S3Gateway\");\n+    }\n+    if (!metadataManager.getVolumeTable().isExist(dbVolumeKey)) {\n+      long transactionID = 1L;\n+      long objectID = OMFileRequest.getObjIDFromTxId(transactionID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19372393899cccecb10730a141b522cc239a092f"}, "originalPosition": 100}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MDAyNjk2OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/interface-client/src/main/proto/proto.lock", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxODo1MDo1NVrOG1FaKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxODo1MDo1NVrOG1FaKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMxNjMzMQ==", "bodyText": "Spurious change.", "url": "https://github.com/apache/ozone/pull/1227#discussion_r458316331", "createdAt": "2020-07-21T18:50:55Z", "author": {"login": "arp7"}, "path": "hadoop-hdds/interface-client/src/main/proto/proto.lock", "diffHunk": "@@ -1935,4 +1935,4 @@\n       }\n     }\n   ]\n-}\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2f285fac8d227a4fb14c78dc9e0a98dd857e90d"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MDAyODYxOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/interface-server/src/main/proto/proto.lock", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxODo1MToyMVrOG1FbIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxOToyMjoyNFrOG1GdHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMxNjU3OA==", "bodyText": "Unrelated to this patch? \ud83d\ude42", "url": "https://github.com/apache/ozone/pull/1227#discussion_r458316578", "createdAt": "2020-07-21T18:51:21Z", "author": {"login": "arp7"}, "path": "hadoop-hdds/interface-server/src/main/proto/proto.lock", "diffHunk": "@@ -457,6 +457,12 @@\n                 \"name\": \"storageReport\",\n                 \"type\": \"StorageReportProto\",\n                 \"is_repeated\": true\n+              },\n+              {\n+                \"id\": 2,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2f285fac8d227a4fb14c78dc9e0a98dd857e90d"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMzMzQ2OA==", "bodyText": "Yes, because proto.lock file getting updated. It is causing issues. I have opened a Jira but it is said that we should consider updating proto.lock files should be updated only at end of release.", "url": "https://github.com/apache/ozone/pull/1227#discussion_r458333468", "createdAt": "2020-07-21T19:22:24Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-hdds/interface-server/src/main/proto/proto.lock", "diffHunk": "@@ -457,6 +457,12 @@\n                 \"name\": \"storageReport\",\n                 \"type\": \"StorageReportProto\",\n                 \"is_repeated\": true\n+              },\n+              {\n+                \"id\": 2,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMxNjU3OA=="}, "originalCommit": {"oid": "d2f285fac8d227a4fb14c78dc9e0a98dd857e90d"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MDA5NjA4OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxOToxMDo1NFrOG1GFAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxOToxMDo1NFrOG1GFAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMyNzI5Ng==", "bodyText": "Let's assert in a test case that the generated object ID is correct.", "url": "https://github.com/apache/ozone/pull/1227#discussion_r458327296", "createdAt": "2020-07-21T19:10:54Z", "author": {"login": "arp7"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3502,4 +3517,95 @@ public boolean getEnableFileSystemPaths() {\n     return configuration.getBoolean(OZONE_OM_ENABLE_FILESYSTEM_PATHS,\n         OZONE_OM_ENABLE_FILESYSTEM_PATHS_DEFAULT);\n   }\n+\n+  /**\n+   * Create volume which is required for S3Gateway operations.\n+   * @throws IOException\n+   */\n+  private void addS3GVolumeToDB() throws IOException {\n+    String s3VolumeName = HddsClientUtils.getS3VolumeName(configuration);\n+    String dbVolumeKey = metadataManager.getVolumeKey(s3VolumeName);\n+\n+    if (!s3VolumeName.equals(OzoneConfigKeys.OZONE_S3_VOLUME_NAME_DEFAULT)) {\n+      LOG.warn(\"Make sure that all S3Gateway use same volume name.\" +\n+          \" Otherwise user need to manually create/configure Volume \" +\n+          \"configured by S3Gateway\");\n+    }\n+    if (!metadataManager.getVolumeTable().isExist(dbVolumeKey)) {\n+      long transactionID = (Long.MAX_VALUE - 1) >> 8;\n+      long objectID = OMFileRequest.getObjIDFromTxId(transactionID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2f285fac8d227a4fb14c78dc9e0a98dd857e90d"}, "originalPosition": 101}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4006, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}