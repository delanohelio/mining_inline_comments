{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3OTQ0Nzkx", "number": 675, "title": "HDDS-3170. Fix issues in File count by size task.", "bodyText": "What changes were proposed in this pull request?\nRecon has a task to maintain the number of files created in Ozone across various size bins (https://issues.apache.org/jira/browse/HDDS-1366). However, there are some bugs in the task's handling of DELETE and existing key PUT key operations from OM. This patch fixes the issues and adds tests to capture issues.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3170\nHow was this patch tested?\nManually tested on docker.\nAdded unit tests for the new cases.", "createdAt": "2020-03-13T19:41:26Z", "url": "https://github.com/apache/ozone/pull/675", "merged": true, "mergeCommit": {"oid": "3b5bfd3b167cd75d405c4c53cd119b549d7c62e9"}, "closed": true, "closedAt": "2020-03-16T21:32:17Z", "author": {"login": "avijayanhwx"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNVovMAH2gAyMzg3OTQ0NzkxOjVhNDJhYmYxODJjNGExNDUwNzE5NTA1N2JiNGI2NTg0OWQwMmU2Mzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOT1SEgFqTM3NTU0NjgwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5a42abf182c4a14507195057bb4b65849d02e639", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/5a42abf182c4a14507195057bb4b65849d02e639", "committedDate": "2020-03-13T19:39:36Z", "message": "HDDS-3170. Fix issues in File count by size task."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NTcyNDY2", "url": "https://github.com/apache/ozone/pull/675#pullrequestreview-374572466", "createdAt": "2020-03-13T19:56:13Z", "commit": {"oid": "5a42abf182c4a14507195057bb4b65849d02e639"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxOTo1NjoxM1rOF2Qkww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxOTo1NjoxM1rOF2Qkww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQzODk3OQ==", "bodyText": "Minor: Can be changed to == enum compare instead.", "url": "https://github.com/apache/ozone/pull/675#discussion_r392438979", "createdAt": "2020-03-13T19:56:13Z", "author": {"login": "swagle"}, "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/tasks/OMDBUpdatesHandler.java", "diffHunk": "@@ -88,30 +93,47 @@ private void processEvent(int cfIndex, byte[] keyBytes, byte[]\n       valueBytes, OMDBUpdateEvent.OMDBUpdateAction action)\n       throws IOException {\n     String tableName = tablesNames.get(cfIndex);\n-    Class keyType = getKeyType();\n+    Class<String> keyType = getKeyType();\n     Class valueType = getValueType(tableName);\n     if (valueType != null) {\n       OMDBUpdateEvent.OMUpdateEventBuilder builder =\n           new OMDBUpdateEvent.OMUpdateEventBuilder<>();\n       builder.setTable(tableName);\n+      builder.setAction(action);\n \n-      Object key = codecRegistry.asObject(keyBytes, keyType);\n+      String key = codecRegistry.asObject(keyBytes, keyType);\n       builder.setKey(key);\n \n-      if (!action.equals(OMDBUpdateEvent.OMDBUpdateAction.DELETE)) {\n+      if (action.equals(PUT)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a42abf182c4a14507195057bb4b65849d02e639"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NTcyNjU4", "url": "https://github.com/apache/ozone/pull/675#pullrequestreview-374572658", "createdAt": "2020-03-13T19:56:37Z", "commit": {"oid": "5a42abf182c4a14507195057bb4b65849d02e639"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxOTo1NjozN1rOF2QlVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxOTo1NjozN1rOF2QlVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQzOTEyNg==", "bodyText": "Minor: bad indent", "url": "https://github.com/apache/ozone/pull/675#discussion_r392439126", "createdAt": "2020-03-13T19:56:37Z", "author": {"login": "swagle"}, "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/tasks/FileSizeCountTask.java", "diffHunk": "@@ -229,22 +228,39 @@ void populateFileCountBySizeDB() {\n    * Used by reprocess() and process().\n    *\n    * @param omKeyInfo OmKey being updated for count\n-   * @param operation (PUT, DELETE)\n    */\n-  void updateUpperBoundCount(OmKeyInfo omKeyInfo,\n-      OMDBUpdateEvent.OMDBUpdateAction operation) {\n+  void handlePutKeyEvent(OmKeyInfo omKeyInfo) {\n     int binIndex = calculateBinIndex(omKeyInfo.getDataSize());\n-    if (operation == PUT) {\n-      upperBoundCount[binIndex]++;\n-    } else if (operation == DELETE) {\n-      if (upperBoundCount[binIndex] != 0) {\n+    upperBoundCount[binIndex]++;\n+  }\n+\n+  /**\n+   * Calculate and update the count of files being tracked by\n+   * upperBoundCount[].\n+   * Used by reprocess() and process().\n+   *\n+   * @param omKeyInfo OmKey being updated for count\n+   */\n+  void handleDeleteKeyEvent(String key, OmKeyInfo omKeyInfo) {\n+    if (omKeyInfo == null) {\n+      LOG.warn(\"Unexpected error while handling DELETE key event. Key not \" +\n+          \"found in Recon OM DB : {}\", key);\n+    } else {\n+      int binIndex = calculateBinIndex(omKeyInfo.getDataSize());\n+      if (upperBoundCount[binIndex] > 0) {\n         //decrement only if it had files before, default DB value is 0\n         upperBoundCount[binIndex]--;\n       } else {\n         LOG.warn(\"Unexpected error while updating bin count. Found 0 count \" +\n-            \"for index : {} while processing DELETE event for {}\", binIndex,\n+                \"for index : {} while processing DELETE event for {}\", binIndex,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a42abf182c4a14507195057bb4b65849d02e639"}, "originalPosition": 135}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NTcyOTA3", "url": "https://github.com/apache/ozone/pull/675#pullrequestreview-374572907", "createdAt": "2020-03-13T19:57:06Z", "commit": {"oid": "5a42abf182c4a14507195057bb4b65849d02e639"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "741bceecdad534626b625112012d8c7ee370a7d3", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/741bceecdad534626b625112012d8c7ee370a7d3", "committedDate": "2020-03-15T00:07:04Z", "message": "Merge remote-tracking branch 'upstream/master' into HDDS-3170-master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "377e736a0b42fec73a44a41123e7d103868067a3", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/377e736a0b42fec73a44a41123e7d103868067a3", "committedDate": "2020-03-15T00:11:47Z", "message": "HDDS-3170. Address review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NzYzMDQx", "url": "https://github.com/apache/ozone/pull/675#pullrequestreview-374763041", "createdAt": "2020-03-15T00:34:02Z", "commit": {"oid": "377e736a0b42fec73a44a41123e7d103868067a3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NTQ2ODA5", "url": "https://github.com/apache/ozone/pull/675#pullrequestreview-375546809", "createdAt": "2020-03-16T20:07:25Z", "commit": {"oid": "377e736a0b42fec73a44a41123e7d103868067a3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3464, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}