{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgwMDM2MzM5", "number": 1395, "title": "HDDS-4088. Adding Owner info for Authorizer plugin to honor owner access rights", "bodyText": "What changes were proposed in this pull request?\nadding isowner flag and volume owner info to acl check request context so that Ranger and 3rd party plugin can allow volume owner has full control over the volume\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4088\nHow was this patch tested?\nUT added.", "createdAt": "2020-09-04T19:59:19Z", "url": "https://github.com/apache/ozone/pull/1395", "merged": true, "mergeCommit": {"oid": "6112603aca864bf18243fcfceb1a330ae7ac0587"}, "closed": true, "closedAt": "2020-10-26T17:56:20Z", "author": {"login": "xiaoyuyao"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPF6OGgBqjM4MzcxNDI2Nzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWXH3xgFqTUxNjk2ODIwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fdd6b5691d159040185bdfa3e4b6c4dff5964030", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/fdd6b5691d159040185bdfa3e4b6c4dff5964030", "committedDate": "2020-09-05T03:24:48Z", "message": "fix acceptance test"}, "afterCommit": {"oid": "8884eb7c074bb1cc610697c21c227fd77fc9873b", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/8884eb7c074bb1cc610697c21c227fd77fc9873b", "committedDate": "2020-10-04T02:38:54Z", "message": "HDDS-4088. Adding Owner info for Authorizer plugin to honor owner access rights."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8884eb7c074bb1cc610697c21c227fd77fc9873b", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/8884eb7c074bb1cc610697c21c227fd77fc9873b", "committedDate": "2020-10-04T02:38:54Z", "message": "HDDS-4088. Adding Owner info for Authorizer plugin to honor owner access rights."}, "afterCommit": {"oid": "8bf6065d93422cacb79eeed053c1a758e1ee3ccd", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/8bf6065d93422cacb79eeed053c1a758e1ee3ccd", "committedDate": "2020-10-12T20:14:50Z", "message": "fix locking heriarchy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "148b27c9732868480761e01d093e1478cbc49774", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/148b27c9732868480761e01d093e1478cbc49774", "committedDate": "2020-10-19T22:29:20Z", "message": "HDDS-4088. Adding Owner info for Authorizer plugin to honor owner access rights."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0148aa4260b14f44b5b642f1914d497da24d5fce", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/0148aa4260b14f44b5b642f1914d497da24d5fce", "committedDate": "2020-10-19T22:29:20Z", "message": "refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8b7c31d76a777534f63d82f9c770aec233b862b", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/a8b7c31d76a777534f63d82f9c770aec233b862b", "committedDate": "2020-10-19T22:29:20Z", "message": "fix locking heriarchy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0NjU0OTIx", "url": "https://github.com/apache/ozone/pull/1395#pullrequestreview-514654921", "createdAt": "2020-10-22T12:10:41Z", "commit": {"oid": "8bf6065d93422cacb79eeed053c1a758e1ee3ccd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxMjoxMDo0MlrOHmek2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxMjoxMDo0MlrOHmek2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDEwODg5MQ==", "bodyText": "getVolumeTable().get(vol) seems to return null when volume not found rather than throwing.\nthe exception message in the following catch block needs to be changed.", "url": "https://github.com/apache/ozone/pull/1395#discussion_r510108891", "createdAt": "2020-10-22T12:10:42Z", "author": {"login": "smengcl"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -1642,25 +1644,42 @@ private boolean hasAcls(String userName, ResourceType resType,\n           UserGroupInformation.createRemoteUser(userName),\n           ProtobufRpcEngine.Server.getRemoteIp(),\n           ProtobufRpcEngine.Server.getRemoteIp().getHostName(),\n-          false);\n+          false, getVolumeOwner(vol, acl));\n     } catch (OMException ex) {\n       // Should not trigger exception here at all\n       return false;\n     }\n   }\n \n-  /**\n-   * CheckAcls for the ozone object.\n-   *\n-   * @throws OMException ResultCodes.PERMISSION_DENIED if permission denied.\n-   */\n-  @SuppressWarnings(\"parameternumber\")\n-  public void checkAcls(ResourceType resType, StoreType storeType,\n-      ACLType aclType, String vol, String bucket, String key,\n-      UserGroupInformation ugi, InetAddress remoteAddress, String hostName)\n-      throws OMException {\n-    checkAcls(resType, storeType, aclType, vol, bucket, key,\n-        ugi, remoteAddress, hostName, true);\n+  public String getVolumeOwner(String vol, ACLType type) throws OMException {\n+    String volOwnerName = null;\n+    if (!vol.equals(OzoneConsts.OZONE_ROOT) && (type != ACLType.CREATE)) {\n+      volOwnerName = getVolumeOwner(vol);\n+    }\n+    return volOwnerName;\n+  }\n+\n+  private String getVolumeOwner(String volume) throws OMException {\n+    Boolean lockAcquired = metadataManager.getLock().acquireReadLock(\n+        VOLUME_LOCK, volume);\n+    String dbVolumeKey = metadataManager.getVolumeKey(volume);\n+    OmVolumeArgs volumeArgs = null;\n+    try {\n+      volumeArgs = metadataManager.getVolumeTable().get(dbVolumeKey);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bf6065d93422cacb79eeed053c1a758e1ee3ccd"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MDEyNTE5", "url": "https://github.com/apache/ozone/pull/1395#pullrequestreview-515012519", "createdAt": "2020-10-22T18:35:47Z", "commit": {"oid": "8bf6065d93422cacb79eeed053c1a758e1ee3ccd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxODozNTo0N1rOHmu2YQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxODozNTo0N1rOHmu2YQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM3NTUyMQ==", "bodyText": "I should tag here :) #tag", "url": "https://github.com/apache/ozone/pull/1395#discussion_r510375521", "createdAt": "2020-10-22T18:35:47Z", "author": {"login": "smengcl"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -1642,25 +1644,42 @@ private boolean hasAcls(String userName, ResourceType resType,\n           UserGroupInformation.createRemoteUser(userName),\n           ProtobufRpcEngine.Server.getRemoteIp(),\n           ProtobufRpcEngine.Server.getRemoteIp().getHostName(),\n-          false);\n+          false, getVolumeOwner(vol, acl));\n     } catch (OMException ex) {\n       // Should not trigger exception here at all\n       return false;\n     }\n   }\n \n-  /**\n-   * CheckAcls for the ozone object.\n-   *\n-   * @throws OMException ResultCodes.PERMISSION_DENIED if permission denied.\n-   */\n-  @SuppressWarnings(\"parameternumber\")\n-  public void checkAcls(ResourceType resType, StoreType storeType,\n-      ACLType aclType, String vol, String bucket, String key,\n-      UserGroupInformation ugi, InetAddress remoteAddress, String hostName)\n-      throws OMException {\n-    checkAcls(resType, storeType, aclType, vol, bucket, key,\n-        ugi, remoteAddress, hostName, true);\n+  public String getVolumeOwner(String vol, ACLType type) throws OMException {\n+    String volOwnerName = null;\n+    if (!vol.equals(OzoneConsts.OZONE_ROOT) && (type != ACLType.CREATE)) {\n+      volOwnerName = getVolumeOwner(vol);\n+    }\n+    return volOwnerName;\n+  }\n+\n+  private String getVolumeOwner(String volume) throws OMException {\n+    Boolean lockAcquired = metadataManager.getLock().acquireReadLock(\n+        VOLUME_LOCK, volume);\n+    String dbVolumeKey = metadataManager.getVolumeKey(volume);\n+    OmVolumeArgs volumeArgs = null;\n+    try {\n+      volumeArgs = metadataManager.getVolumeTable().get(dbVolumeKey);\n+    } catch (IOException ioe) {\n+      throw new OMException(\"Volume \" + volume + \" is not found\",\n+          OMException.ResultCodes.VOLUME_NOT_FOUND);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bf6065d93422cacb79eeed053c1a758e1ee3ccd"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d29621850894c1bc4ab38a87f385df1f66de9371", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/d29621850894c1bc4ab38a87f385df1f66de9371", "committedDate": "2020-10-22T19:36:54Z", "message": "address code review feedback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8bf6065d93422cacb79eeed053c1a758e1ee3ccd", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/8bf6065d93422cacb79eeed053c1a758e1ee3ccd", "committedDate": "2020-10-12T20:14:50Z", "message": "fix locking heriarchy"}, "afterCommit": {"oid": "d29621850894c1bc4ab38a87f385df1f66de9371", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/d29621850894c1bc4ab38a87f385df1f66de9371", "committedDate": "2020-10-22T19:36:54Z", "message": "address code review feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTY4MjA3", "url": "https://github.com/apache/ozone/pull/1395#pullrequestreview-516968207", "createdAt": "2020-10-26T16:39:59Z", "commit": {"oid": "d29621850894c1bc4ab38a87f385df1f66de9371"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2459, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}