{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1MzY5MDA5", "number": 1243, "title": "HDDS-4008. Recon should fallback to ozone.om.service.ids when the internal service id is not defined.", "bodyText": "What changes were proposed in this pull request?\nRecon connects to OM via RPC using the \"ozone.om.internal.service.id\" to get updates. If the above config is not defined, but the ozone.om.service.ids is defined, Recon should use the latter as a fallback. Currently, a single Recon instance supports only 1 OM HA cluster at a time. Hence, if multiple ids are defined and the internal service ID is not defined, we throw an error.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4008\nHow was this patch tested?\nManually tested.\nAdded unit test.", "createdAt": "2020-07-22T21:39:10Z", "url": "https://github.com/apache/ozone/pull/1243", "merged": true, "mergeCommit": {"oid": "cf7a5837a7240b7fce30059ec4289df87cf642cf"}, "closed": true, "closedAt": "2020-07-23T20:51:16Z", "author": {"login": "avijayanhwx"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3h2RmAH2gAyNDU1MzY5MDA5OjBlZDJlMTE0OGRhMzNiYTM2MGYzNThjY2U3ZmNiZjA1ODJjYWQ3YWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc30FZ4gFqTQ1NDQwODg5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0ed2e1148da33ba360f358cce7fcbf0582cad7aa", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/0ed2e1148da33ba360f358cce7fcbf0582cad7aa", "committedDate": "2020-07-22T21:38:04Z", "message": "HDDS-4008. Recon should fallback to ozone.om.service.ids when the internal service id is not defined."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a2b5c8801f32ed6e22c612aa38827eaffcb2fe1", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/2a2b5c8801f32ed6e22c612aa38827eaffcb2fe1", "committedDate": "2020-07-23T00:33:45Z", "message": "Move method to common class."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNzgxMTcy", "url": "https://github.com/apache/ozone/pull/1243#pullrequestreview-453781172", "createdAt": "2020-07-23T01:06:23Z", "commit": {"oid": "2a2b5c8801f32ed6e22c612aa38827eaffcb2fe1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwMTowNjoyM1rOG15QKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwMTowNjoyM1rOG15QKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE2NTczOA==", "bodyText": "I think we also need to check if localServiceID value is one of the ozone.om.service.ids value.\nTo find if there is a mistake in the config.", "url": "https://github.com/apache/ozone/pull/1243#discussion_r459165738", "createdAt": "2020-07-23T01:06:23Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/OmUtils.java", "diffHunk": "@@ -527,4 +529,45 @@ public static void validateKeyName(String keyName)\n               OMException.ResultCodes.INVALID_KEY_NAME);\n     }\n   }\n+\n+  /**\n+   * Return configured OzoneManager service id based on the following logic.\n+   * Look at 'ozone.om.internal.service.id' first. If configured, return that.\n+   * If the above is not configured, look at 'ozone.om.service.ids'.\n+   * If count(ozone.om.service.ids) == 1, return that id.\n+   * If count(ozone.om.service.ids) > 1 throw exception\n+   * If 'ozone.om.service.ids' is not configured, return null. (Non HA)\n+   * @param conf configuration\n+   * @return OM service ID.\n+   * @throws IOException on error.\n+   */\n+  public static String getOzoneManagerServiceId(OzoneConfiguration conf)\n+      throws IOException {\n+    Collection<String> omServiceIds;\n+    String localOMServiceId = conf.get(OZONE_OM_INTERNAL_SERVICE_ID);\n+    if (localOMServiceId == null) {\n+      LOG.info(\"{} is not defined, falling back to {} to find serviceID for \"\n+              + \"OzoneManager if it is HA enabled cluster\",\n+          OZONE_OM_INTERNAL_SERVICE_ID, OZONE_OM_SERVICE_IDS_KEY);\n+      omServiceIds = conf.getTrimmedStringCollection(\n+          OZONE_OM_SERVICE_IDS_KEY);\n+      if (omServiceIds.size() > 1) {\n+        throw new IOException(String.format(\n+            \"More than 1 OzoneManager ServiceID (ozone.om.service.ids) \" +\n+                \"configured : %s, but ozone.om.internal.service.id is not \" +\n+                \"configured.\", omServiceIds.toString()));\n+      }\n+    } else {\n+      omServiceIds = Collections.singletonList(localOMServiceId);\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a2b5c8801f32ed6e22c612aa38827eaffcb2fe1"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNzgzNjkw", "url": "https://github.com/apache/ozone/pull/1243#pullrequestreview-453783690", "createdAt": "2020-07-23T01:10:46Z", "commit": {"oid": "2a2b5c8801f32ed6e22c612aa38827eaffcb2fe1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwMToxMDo0NlrOG15UqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwMToxMDo0NlrOG15UqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTE2Njg4OQ==", "bodyText": "Not related to this change??", "url": "https://github.com/apache/ozone/pull/1243#discussion_r459166889", "createdAt": "2020-07-23T01:10:46Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/recon/src/main/resources/webapps/recon/ozone-recon-web/src/views/overview/overview.tsx", "diffHunk": "@@ -180,7 +180,7 @@ export class Overview extends React.Component<Record<string, object>, IOverviewS\n             <OverviewCard loading={loading} title='Buckets' data={buckets.toString()} icon='folder-open'/>\n           </Col>\n           <Col xs={24} sm={18} md={12} lg={12} xl={6}>\n-            <OverviewCard loading={loading} title='Keys' data={keys.toString()} icon='file-text'/>\n+            <OverviewCard loading={loading} title='Keys (Estimated)' data={keys.toString()} icon='file-text'/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a2b5c8801f32ed6e22c612aa38827eaffcb2fe1"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNzgzODE3", "url": "https://github.com/apache/ozone/pull/1243#pullrequestreview-453783817", "createdAt": "2020-07-23T01:11:15Z", "commit": {"oid": "2a2b5c8801f32ed6e22c612aa38827eaffcb2fe1"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzODQwMzk1", "url": "https://github.com/apache/ozone/pull/1243#pullrequestreview-453840395", "createdAt": "2020-07-23T05:16:34Z", "commit": {"oid": "2a2b5c8801f32ed6e22c612aa38827eaffcb2fe1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b943a6b3bb3ccbb0806b5dfb3204d0076d6b3d3", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/1b943a6b3bb3ccbb0806b5dfb3204d0076d6b3d3", "committedDate": "2020-07-23T16:53:59Z", "message": "Merge remote-tracking branch 'upstream/master' into HDDS-4008-master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f721b9a4dab54655c928b0ded2d7bfcc1b5dd30", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/7f721b9a4dab54655c928b0ded2d7bfcc1b5dd30", "committedDate": "2020-07-23T18:26:17Z", "message": "Addressed review comment."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NDA4ODky", "url": "https://github.com/apache/ozone/pull/1243#pullrequestreview-454408892", "createdAt": "2020-07-23T18:52:53Z", "commit": {"oid": "7f721b9a4dab54655c928b0ded2d7bfcc1b5dd30"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2909, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}