{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4NTYwNDIy", "number": 1385, "title": "HDDS-3947: Sort DNs for client when the key is a file for #getFileStatus #listStatus APIs", "bodyText": "What changes were proposed in this pull request?\nSimilar to OzoneManagerFS#lookupFile(OmKeyArgs args, String clientAddress) interface, \"clientAddress\" has been passed as an argument to OzoneManagerFS#listStatus(), OzoneManagerFS#getFileStatus() APIs.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3947\nPlease replace this section with the link to the Apache JIRA)\nHow was this patch tested?\nUsed existing TestKeyManagerImpl unit test cases.", "createdAt": "2020-09-03T11:25:00Z", "url": "https://github.com/apache/ozone/pull/1385", "merged": true, "mergeCommit": {"oid": "1e9ff6cb77b538e3fa1786108b2be92a8c88a482"}, "closed": true, "closedAt": "2020-09-18T13:41:06Z", "author": {"login": "rakeshadr"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFOx00gH2gAyNDc4NTYwNDIyOjk4NjYzYzgzZjlmODc4MTViOTJkMjRmYWY0MWY2MDQxZmFlNzFlNjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdKFuCGgFqTQ5MTQ3MDg2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "98663c83f9f87815b92d24faf41f6041fae71e68", "author": {"user": {"login": "rakeshadr", "name": "Rakesh Radhakrishnan"}}, "url": "https://github.com/apache/ozone/commit/98663c83f9f87815b92d24faf41f6041fae71e68", "committedDate": "2020-09-03T11:19:57Z", "message": "HDDS-3947: Sort DNs for client when the key is a file for #getFileStatus #listStatus APIs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b016bfa01649b9d5d5cb2f98c92980b490c35a6e", "author": {"user": {"login": "rakeshadr", "name": "Rakesh Radhakrishnan"}}, "url": "https://github.com/apache/ozone/commit/b016bfa01649b9d5d5cb2f98c92980b490c35a6e", "committedDate": "2020-09-03T11:34:02Z", "message": "Fixed TestKeyManagerImpl conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ec0ee3c192b491b1bb43091f59f86e313f18db2", "author": {"user": {"login": "rakeshadr", "name": "Rakesh Radhakrishnan"}}, "url": "https://github.com/apache/ozone/commit/0ec0ee3c192b491b1bb43091f59f86e313f18db2", "committedDate": "2020-09-04T05:23:33Z", "message": "Fixed checkstyle warnings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNDM5ODUy", "url": "https://github.com/apache/ozone/pull/1385#pullrequestreview-482439852", "createdAt": "2020-09-04T07:58:04Z", "commit": {"oid": "0ec0ee3c192b491b1bb43091f59f86e313f18db2"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwNzo1ODowNFrOHNDoow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwOTowODoyNVrOHNF85g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ1MzA5MQ==", "bodyText": "I think refreshPipeline condition was removed intentionally in HDDS-3658 and should not be restored.  (This is also causing failure of TestKeyManagerUnit.testLookupFileWithDnFailure unit test.)", "url": "https://github.com/apache/ozone/pull/1385#discussion_r483453091", "createdAt": "2020-09-04T07:58:04Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java", "diffHunk": "@@ -1783,7 +1802,9 @@ private OzoneFileStatus getOzoneFileStatus(String volumeName,\n \n       // if the key is a file then do refresh pipeline info in OM by asking SCM\n       if (fileKeyInfo != null) {\n-        refreshPipeline(fileKeyInfo);\n+        if (refreshPipeline) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ec0ee3c192b491b1bb43091f59f86e313f18db2"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ1MzU2Mw==", "bodyText": "@ChenSammi Was this instance of getRefreshPipeline condition retained in HDDS-3658 intentionally?", "url": "https://github.com/apache/ozone/pull/1385#discussion_r483453563", "createdAt": "2020-09-04T07:58:55Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java", "diffHunk": "@@ -2144,10 +2166,14 @@ private void listStatusFindKeyInTableCache(\n       metadataManager.getLock().releaseReadLock(BUCKET_LOCK, volumeName,\n           bucketName);\n     }\n-    if (args.getRefreshPipeline()) {\n-      for(OzoneFileStatus fileStatus : fileStatusList){\n+\n+    for (OzoneFileStatus fileStatus : fileStatusList) {\n+      if (args.getRefreshPipeline()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ec0ee3c192b491b1bb43091f59f86e313f18db2"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ5MTA0Ng==", "bodyText": "In my comment on the previous PR:\n\nShould we also keep the two original methods?\n\nI meant both getFileStatus and listStatus.  Sorry if it was unclear.", "url": "https://github.com/apache/ozone/pull/1385#discussion_r483491046", "createdAt": "2020-09-04T09:08:25Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/fs/OzoneManagerFS.java", "diffHunk": "@@ -49,6 +69,21 @@ OpenKeySession createFile(OmKeyArgs args, boolean isOverWrite,\n    */\n   OmKeyInfo lookupFile(OmKeyArgs args, String clientAddress) throws IOException;\n \n+  /**\n+   * List the status for a file or a directory and its contents.\n+   *\n+   * @param keyArgs       the args of the key provided by client.\n+   * @param recursive     For a directory if true all the descendants of a\n+   *                      particular directory are listed\n+   * @param startKey      Key from which listing needs to start. If startKey\n+   *                      exists its status is included in the final list.\n+   * @param numEntries    Number of entries to list from the start key\n+   * @param clientAddress a hint to key manager, order the datanode in returned\n+   *                      pipeline by distance between client and datanode.\n+   * @return list of file status\n+   * @throws IOException if file or bucket or volume does not exist\n+   */\n   List<OzoneFileStatus> listStatus(OmKeyArgs keyArgs, boolean recursive,\n-      String startKey, long numEntries) throws IOException;\n+      String startKey, long numEntries, String clientAddress)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ec0ee3c192b491b1bb43091f59f86e313f18db2"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "088e40d2f79ab0e8c6021523fd4e2b8db23127af", "author": {"user": {"login": "rakeshadr", "name": "Rakesh Radhakrishnan"}}, "url": "https://github.com/apache/ozone/commit/088e40d2f79ab0e8c6021523fd4e2b8db23127af", "committedDate": "2020-09-16T09:43:25Z", "message": "Fixed review comments - removed refreshPipeline check and added listStatus overloaded api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NzY2MDUz", "url": "https://github.com/apache/ozone/pull/1385#pullrequestreview-489766053", "createdAt": "2020-09-16T15:49:37Z", "commit": {"oid": "088e40d2f79ab0e8c6021523fd4e2b8db23127af"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5ODU0MDAx", "url": "https://github.com/apache/ozone/pull/1385#pullrequestreview-489854001", "createdAt": "2020-09-16T17:42:26Z", "commit": {"oid": "088e40d2f79ab0e8c6021523fd4e2b8db23127af"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b48a1ba19a1c96c1e83842b59c0cb0ccff2b802c", "author": {"user": {"login": "rakeshadr", "name": "Rakesh Radhakrishnan"}}, "url": "https://github.com/apache/ozone/commit/b48a1ba19a1c96c1e83842b59c0cb0ccff2b802c", "committedDate": "2020-09-17T02:41:43Z", "message": "Addressed comment - added clientAddress to #getFileStatus call from #listStatus"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNDcwODY5", "url": "https://github.com/apache/ozone/pull/1385#pullrequestreview-491470869", "createdAt": "2020-09-18T13:36:17Z", "commit": {"oid": "b48a1ba19a1c96c1e83842b59c0cb0ccff2b802c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2438, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}