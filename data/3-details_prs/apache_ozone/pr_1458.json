{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1MzA1MDY4", "number": 1458, "title": "HDDS-3728. Bucket space: check quotaUsageInBytes when write key and allocate block.", "bodyText": "What changes were proposed in this pull request?\nIn addition, the current Quota setting does not take effect. HDDS-541 gives all the work needed to perfect Quota.\nThis PR is a subtask of HDDS-541.\nBucket has implemented increase usedBytes when write, and this PR is based on #1431.\nIn this PR we judge whether the Bucket can be written when we write the key if the Bucket space quota enable.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3728\nHow was this patch tested?\nut added", "createdAt": "2020-09-30T07:15:08Z", "url": "https://github.com/apache/ozone/pull/1458", "merged": true, "mergeCommit": {"oid": "d08a4c1d973f7752875436f497c4a007bea9f250"}, "closed": true, "closedAt": "2020-10-09T11:42:54Z", "author": {"login": "captainzmc"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdN3S9IAH2gAyNDk1MzA1MDY4OjJiNTNmNjkyMmUyNjRkZmVlMDg1ZGMyNDk5Yzk0MDc4YTA5ZDRmMGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQyG7vgH2gAyNDk1MzA1MDY4Ojc3ZTU3Y2EzMzIzZDcxNGI1OGJmMDM3YTM3M2Y0ZjI2ZmY3NTgwZDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2b53f6922e264dfee085dc2499c94078a09d4f0a", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/2b53f6922e264dfee085dc2499c94078a09d4f0a", "committedDate": "2020-09-30T07:03:44Z", "message": "add bucket quota check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NDE0OTk5", "url": "https://github.com/apache/ozone/pull/1458#pullrequestreview-505414999", "createdAt": "2020-10-09T07:12:12Z", "commit": {"oid": "2b53f6922e264dfee085dc2499c94078a09d4f0a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNzoxMjoxMlrOHe9wSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNzoxMjoxMlrOHe9wSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIzMTExNA==", "bodyText": "Are these two used somewhere?", "url": "https://github.com/apache/ozone/pull/1458#discussion_r502231114", "createdAt": "2020-10-09T07:12:12Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMAllocateBlockRequest.java", "diffHunk": "@@ -218,6 +219,8 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n       // update usedBytes atomically.\n       omVolumeArgs.getUsedBytes().add(preAllocatedSpace);\n       omBucketInfo.getUsedBytes().add(preAllocatedSpace);\n+      long vol = omVolumeArgs.getUsedBytes().sum();\n+      long buk = omBucketInfo.getUsedBytes().sum();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b53f6922e264dfee085dc2499c94078a09d4f0a"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NDE2MzAy", "url": "https://github.com/apache/ozone/pull/1458#pullrequestreview-505416302", "createdAt": "2020-10-09T07:14:34Z", "commit": {"oid": "2b53f6922e264dfee085dc2499c94078a09d4f0a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNzoxNDozNFrOHe90Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwNzoxNDozNFrOHe90Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIzMjA5NA==", "bodyText": "Better check bucket quota before volume quota check.", "url": "https://github.com/apache/ozone/pull/1458#discussion_r502232094", "createdAt": "2020-10-09T07:14:34Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "diffHunk": "@@ -279,11 +279,12 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n \n       omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n       omBucketInfo = getBucketInfo(omMetadataManager, volumeName, bucketName);\n-      // check volume quota\n+      // check volume and bucket quota\n       long preAllocatedSpace = newLocationList.size()\n           * ozoneManager.getScmBlockSize()\n           * omKeyInfo.getFactor().getNumber();\n       checkVolumeQuotaInBytes(omVolumeArgs, preAllocatedSpace);\n+      checkBucketQuotaInBytes(omBucketInfo, preAllocatedSpace);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b53f6922e264dfee085dc2499c94078a09d4f0a"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77e57ca3323d714b58bf037a373f4f26ff7580d1", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/77e57ca3323d714b58bf037a373f4f26ff7580d1", "committedDate": "2020-10-09T08:42:51Z", "message": "fix review issues"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2587, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}