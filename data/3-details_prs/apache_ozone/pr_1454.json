{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0ODg5MDQ5", "number": 1454, "title": "HDDS-4285. Read is slow due to frequent calls to UGI.getCurrentUser() and getTokens()", "bodyText": "What changes were proposed in this pull request?\nReduce the number of getCurrentUser() and getTokens() calls performed during some ContainerProtocolCalls operations.  This is achieved by getting the tokens once in BlockInputStream and BlockOutputStream initialization, and passing them to getBlock, putBlock, readChunk, writeChunk calls.\nhttps://issues.apache.org/jira/browse/HDDS-4285\nHow was this patch tested?\nVerified that time required for the repro unit test is improved.\nWithout the patch:\n[INFO] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 112.829 s - in org.apache.hadoop.ozone.client.io.TestKeyOutputStreamUnit\n\nWith the patch:\n[INFO] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 30.293 s - in org.apache.hadoop.ozone.client.io.TestKeyOutputStreamUnit\n\nRegular CI:\nhttps://github.com/adoroszlai/hadoop-ozone/runs/1181129921", "createdAt": "2020-09-29T14:46:50Z", "url": "https://github.com/apache/ozone/pull/1454", "merged": true, "mergeCommit": {"oid": "35cc6b0f67353910c672b50c6bd48cb08e5a6dbc"}, "closed": true, "closedAt": "2020-10-09T15:28:46Z", "author": {"login": "adoroszlai"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNVt1LgH2gAyNDk0ODg5MDQ5Ojg2ZGJlZTg4MDdjZjVmMDQ5ZWYxMTI3OGRkZDhmNjNjYjA4MDE4MTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQgdgigH2gAyNDk0ODg5MDQ5OjU2MTdmYWMzZDYxMjQ1N2M3NzZlZjBiNGRhYzQyMjY0OGVkNWU0ZmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "86dbee8807cf5f049ef11278ddd8f63cb0801819", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/86dbee8807cf5f049ef11278ddd8f63cb0801819", "committedDate": "2020-09-28T15:56:19Z", "message": "HDDS-4285. Read is slow due to the frequent usage of UGI.getCurrentUserCall()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32387fcaf07af13a71fa4fca000868fc3eaac920", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/32387fcaf07af13a71fa4fca000868fc3eaac920", "committedDate": "2020-09-28T18:16:34Z", "message": "Fix read path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "980842eb0f1377d87decf3fe638fb4874a658830", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/980842eb0f1377d87decf3fe638fb4874a658830", "committedDate": "2020-09-29T08:53:01Z", "message": "trigger new CI check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NjIwNDgx", "url": "https://github.com/apache/ozone/pull/1454#pullrequestreview-498620481", "createdAt": "2020-09-29T15:33:16Z", "commit": {"oid": "980842eb0f1377d87decf3fe638fb4874a658830"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNTozMzoxN1rOHZzd1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNTozMzoxN1rOHZzd1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjgxOTY3MA==", "bodyText": "Can we update the javadoc comment of this method as we new added param tokens here?\nThe same suggestion for methods we changed below:\n\nputBlockAsync\nreadChunk\nwriteChunkAsync", "url": "https://github.com/apache/ozone/pull/1454#discussion_r496819670", "createdAt": "2020-09-29T15:33:17Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/storage/ContainerProtocolCalls.java", "diffHunk": "@@ -84,7 +86,8 @@ private ContainerProtocolCalls() {\n    * @throws IOException if there is an I/O error while performing the call\n    */\n   public static GetBlockResponseProto getBlock(XceiverClientSpi xceiverClient,\n-      DatanodeBlockID datanodeBlockID) throws IOException {\n+      DatanodeBlockID datanodeBlockID,\n+      Collection<Token<? extends TokenIdentifier>> tokens) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "980842eb0f1377d87decf3fe638fb4874a658830"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fd7d07b7d35d2060db5ea5ce1bdfe3fac8e63c1", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/3fd7d07b7d35d2060db5ea5ce1bdfe3fac8e63c1", "committedDate": "2020-09-30T09:15:23Z", "message": "Add javadoc for new param"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NjAwNzIx", "url": "https://github.com/apache/ozone/pull/1454#pullrequestreview-499600721", "createdAt": "2020-09-30T16:17:01Z", "commit": {"oid": "3fd7d07b7d35d2060db5ea5ce1bdfe3fac8e63c1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNjoxNzowMVrOHalVBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNjoxNzowMVrOHalVBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzYzNjYxMw==", "bodyText": "Should we just pass down the token from the caller directly and bypass the UGI addToken/getTokens completely?", "url": "https://github.com/apache/ozone/pull/1454#discussion_r497636613", "createdAt": "2020-09-30T16:17:01Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/storage/BlockInputStream.java", "diffHunk": "@@ -193,10 +196,11 @@ public synchronized void initialize() throws IOException {\n       if (token != null) {\n         UserGroupInformation.getCurrentUser().addToken(token);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fd7d07b7d35d2060db5ea5ce1bdfe3fac8e63c1"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NjA3MTM3", "url": "https://github.com/apache/ozone/pull/1454#pullrequestreview-499607137", "createdAt": "2020-09-30T16:24:27Z", "commit": {"oid": "3fd7d07b7d35d2060db5ea5ce1bdfe3fac8e63c1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNjoyNDoyOFrOHaln5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNjoyNDoyOFrOHaln5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY0MTQ0Nw==", "bodyText": "We can directly encode the pass in token for the specific block id without additional token selection.", "url": "https://github.com/apache/ozone/pull/1454#discussion_r497641447", "createdAt": "2020-09-30T16:24:28Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/storage/ContainerProtocolCalls.java", "diffHunk": "@@ -84,7 +86,8 @@ private ContainerProtocolCalls() {\n    * @throws IOException if there is an I/O error while performing the call\n    */\n   public static GetBlockResponseProto getBlock(XceiverClientSpi xceiverClient,\n-      DatanodeBlockID datanodeBlockID) throws IOException {\n+      DatanodeBlockID datanodeBlockID,\n+      Collection<Token<? extends TokenIdentifier>> tokens) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjgxOTY3MA=="}, "originalCommit": {"oid": "980842eb0f1377d87decf3fe638fb4874a658830"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e05eb00f091c77920d1e6e5f0e06762bca398e3f", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/e05eb00f091c77920d1e6e5f0e06762bca398e3f", "committedDate": "2020-10-08T08:58:23Z", "message": "HDDS-4285. Directly pass block token"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5617fac3d612457c776ef0b4dac422648ed5e4fb", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/5617fac3d612457c776ef0b4dac422648ed5e4fb", "committedDate": "2020-10-08T12:09:13Z", "message": "Merge remote-tracking branch 'origin/master' into HDDS-4285"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2576, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}