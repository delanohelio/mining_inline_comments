{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNDI3ODU3", "number": 1720, "title": "HDDS-4175. Implement Datanode Finalization.", "bodyText": "What changes were proposed in this pull request?\nImplement Datanode Finalization\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4175\nHow was this patch tested?\nBuild/UT. I will address CI failures if any.", "createdAt": "2020-12-16T20:43:22Z", "url": "https://github.com/apache/ozone/pull/1720", "merged": true, "mergeCommit": {"oid": "d36b87d4ee0b2f01fc683cf7301f0dc7d16a2f51"}, "closed": true, "closedAt": "2021-01-11T05:04:38Z", "author": {"login": "prashantpogde"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdm3qBTABqjQxMjIzODg2NjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdu_UeUAFqTU2NTA3MTcxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a43a3a1f54ece2bf175e422eff15358f7a4e24c", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/0a43a3a1f54ece2bf175e422eff15358f7a4e24c", "committedDate": "2020-12-16T20:40:37Z", "message": "HDDS-4175. Implement Datanode Finalization."}, "afterCommit": {"oid": "d3a43742efd0d96719bb21972e2fab5d58b45fef", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/d3a43742efd0d96719bb21972e2fab5d58b45fef", "committedDate": "2020-12-16T23:37:31Z", "message": "HDDS-4175. Implement Datanode Finalization."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d3a43742efd0d96719bb21972e2fab5d58b45fef", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/d3a43742efd0d96719bb21972e2fab5d58b45fef", "committedDate": "2020-12-16T23:37:31Z", "message": "HDDS-4175. Implement Datanode Finalization."}, "afterCommit": {"oid": "084dd9ea6dcb14f90e0cfdc24bef716e6fdfcb0c", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/084dd9ea6dcb14f90e0cfdc24bef716e6fdfcb0c", "committedDate": "2020-12-19T05:14:50Z", "message": "HDDS-4175. Implement Datanode Finalization."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "084dd9ea6dcb14f90e0cfdc24bef716e6fdfcb0c", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/084dd9ea6dcb14f90e0cfdc24bef716e6fdfcb0c", "committedDate": "2020-12-19T05:14:50Z", "message": "HDDS-4175. Implement Datanode Finalization."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NTc3ODc3", "url": "https://github.com/apache/ozone/pull/1720#pullrequestreview-556577877", "createdAt": "2020-12-21T18:24:08Z", "commit": {"oid": "084dd9ea6dcb14f90e0cfdc24bef716e6fdfcb0c"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxODoyNDowOFrOIJhruQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxODo0NDoxNlrOIJiOMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg1OTk2MQ==", "bodyText": "The StorageInfo class generates a new \"clusterId\" for every Version file that it writes down. There is no clusterId with respect to DN now. Can we confirm the implications of adding a clusterId for the DN persistent state even when we need only the layout version?", "url": "https://github.com/apache/ozone/pull/1720#discussion_r546859961", "createdAt": "2020-12-21T18:24:08Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/DataNodeStorageConfig.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.container.common;\n+\n+import static org.apache.hadoop.ozone.OzoneConsts.DATANODE_STORAGE_DIR;\n+import static org.apache.hadoop.ozone.OzoneConsts.DATANODE_UUID;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.Properties;\n+import java.util.UUID;\n+\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos.NodeType;\n+import org.apache.hadoop.hdds.server.ServerUtils;\n+import org.apache.hadoop.ozone.common.Storage;\n+\n+/**\n+ * DataNodeStorageConfig is responsible for management of the\n+ * StorageDirectories used by the DataNode.\n+ */\n+public class DataNodeStorageConfig extends Storage {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "084dd9ea6dcb14f90e0cfdc24bef716e6fdfcb0c"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg2MDkwOA==", "bodyText": "Can we add a unit test for the Datanode layout version startup validation like in TestScmStartupSlvLessThanMlv, TestOmStartupSlvLessThanMlv?", "url": "https://github.com/apache/ozone/pull/1720#discussion_r546860908", "createdAt": "2020-12-21T18:26:07Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/common/Storage.java", "diffHunk": "@@ -145,7 +145,7 @@ protected StorageInfo getStorageInfo() {\n   abstract protected Properties getNodeProperties();\n \n   /**\n-   * Sets the Node properties specific to OM/SCM.\n+   * Sets the Node properties specific to OM/SCM/DataNode.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "084dd9ea6dcb14f90e0cfdc24bef716e6fdfcb0c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg2MTI3Mg==", "bodyText": "Can you please explain how this can happen, and how can a user recover from this?", "url": "https://github.com/apache/ozone/pull/1720#discussion_r546861272", "createdAt": "2020-12-21T18:26:52Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/upgrade/BasicUpgradeFinalizer.java", "diffHunk": "@@ -71,6 +69,11 @@ public synchronized StatusAndMessages preFinalize(String upgradeClientID,\n       return FINALIZATION_IN_PROGRESS_MSG;\n     case FINALIZATION_DONE:\n     case ALREADY_FINALIZED:\n+      if (versionManager.needsFinalization()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "084dd9ea6dcb14f90e0cfdc24bef716e6fdfcb0c"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg2MzY1Nw==", "bodyText": "We currently have a common layout feature hierarchy for SCM and Datanode. It is likely that a feature can either be part of the SCM or the DN. If we call on the onFinalize action in both the SCM and DN for every unfinalized HDDS layout feature, then we may be left with unintended consequences of trying to call on finalize action on an SCM feature on the DN. We should either have a marker on every layout feature to say if it belongs to SCM or DN, or not support finalization actions for DN for the V1 upgrade implementation.", "url": "https://github.com/apache/ozone/pull/1720#discussion_r546863657", "createdAt": "2020-12-21T18:32:13Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/upgrade/DataNodeUpgradeFinalizer.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.container.upgrade;\n+\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_DONE;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_IN_PROGRESS;\n+import static org.apache.hadoop.ozone.upgrade.UpgradeFinalizer.Status.FINALIZATION_REQUIRED;\n+\n+import java.io.IOException;\n+import java.util.concurrent.Callable;\n+\n+import org.apache.hadoop.hdds.upgrade.HDDSLayoutFeatureCatalog.HDDSLayoutFeature;\n+import org.apache.hadoop.ozone.container.common.statemachine.DatanodeStateMachine;\n+import org.apache.hadoop.ozone.upgrade.BasicUpgradeFinalizer;\n+\n+/**\n+ * UpgradeFinalizer for the DataNode.\n+ */\n+public class DataNodeUpgradeFinalizer extends\n+    BasicUpgradeFinalizer<DatanodeStateMachine, DataNodeLayoutVersionManager> {\n+\n+  public DataNodeUpgradeFinalizer(DataNodeLayoutVersionManager versionManager) {\n+    super(versionManager);\n+  }\n+\n+  @Override\n+  public StatusAndMessages finalize(String upgradeClientID,\n+                                    DatanodeStateMachine dsm)\n+      throws IOException {\n+    StatusAndMessages response = preFinalize(upgradeClientID, dsm);\n+    if (response.status() != FINALIZATION_REQUIRED) {\n+      return response;\n+    }\n+    new Worker(dsm).call();\n+    return STARTING_MSG;\n+  }\n+\n+  private class Worker implements Callable<Void> {\n+    private DatanodeStateMachine datanodeStateMachine;\n+\n+    /**\n+     * Initiates the Worker, for the specified DataNode instance.\n+     * @param dsm the DataNodeStateMachine instance on which to finalize the\n+     *           new LayoutFeatures.\n+     */\n+    Worker(DatanodeStateMachine dsm) {\n+      datanodeStateMachine = dsm;\n+    }\n+\n+    @Override\n+    public Void call() throws IOException {\n+      if(!datanodeStateMachine.preFinalizeUpgrade()) {\n+      // datanode is not yet ready to finalize.\n+      // Reset the Finalization state.\n+        versionManager.setUpgradeState(FINALIZATION_REQUIRED);\n+        return null;\n+      }\n+      try {\n+        emitStartingMsg();\n+        versionManager.setUpgradeState(FINALIZATION_IN_PROGRESS);\n+        /*\n+         * Before we can call finalize the feature, we need to make sure that\n+         * all existing pipelines are closed and pipeline Manger would freeze\n+         * all new pipeline creation.\n+         */\n+\n+        for (HDDSLayoutFeature f : versionManager.unfinalizedFeatures()) {\n+          finalizeFeature(f, datanodeStateMachine.getDataNodeStorageConfig());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "084dd9ea6dcb14f90e0cfdc24bef716e6fdfcb0c"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg2NjkzNw==", "bodyText": "With these changes, I believe that HDDSLayoutFeature#FIRST_UPGRADE_VERSION can be removed.", "url": "https://github.com/apache/ozone/pull/1720#discussion_r546866937", "createdAt": "2020-12-21T18:40:02Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/upgrade/DataNodeLayoutVersionManager.java", "diffHunk": "@@ -69,41 +58,15 @@ public static synchronized LayoutVersionManager getInstance() {\n   /**\n    * Initialize DataNode version manager from version file stored on the\n    * DataNode.\n-   * @param conf - Ozone Configuration\n+   * @param dataNodeStorage - DataNode storage config\n    * @return version manager instance.\n    */\n+\n   public static synchronized DataNodeLayoutVersionManager initialize(\n-      ConfigurationSource conf)\n-      throws IOException {\n+      Storage dataNodeStorage) throws IOException {\n     if (dataNodeLayoutVersionManager == null) {\n       dataNodeLayoutVersionManager = new DataNodeLayoutVersionManager();\n-      int layoutVersion = 0;\n-      Collection<String> rawLocations = getDatanodeStorageDirs(conf);\n-      for (String locationString : rawLocations) {\n-        StorageLocation location = StorageLocation.parse(locationString);\n-        File hddsRootDir = new File(location.getUri().getPath(),\n-            HDDS_VOLUME_DIR);\n-        // Read the version from VersionFile Stored on the data node.\n-        File versionFile = HddsVolumeUtil.getVersionFile(hddsRootDir);\n-        if (!versionFile.exists()) {\n-          // Volume Root is non empty but VERSION file does not exist.\n-          LOG.warn(\"VERSION file does not exist in volume {},\"\n-                  + \" current volume state: {}.\",\n-              hddsRootDir.getPath(), HddsVolume.VolumeState.INCONSISTENT);\n-          continue;\n-        } else {\n-          LOG.debug(\"Reading version file {} from disk.\", versionFile);\n-        }\n-        Properties props = DatanodeVersionFile.readFrom(versionFile);\n-        if (props.isEmpty()) {\n-          continue;\n-        }\n-        int storedVersion = HddsVolumeUtil.getLayOutVersion(props, versionFile);\n-        if (storedVersion > layoutVersion) {\n-          layoutVersion = storedVersion;\n-        }\n-      }\n-      dataNodeLayoutVersionManager.init(layoutVersion,\n+      dataNodeLayoutVersionManager.init(dataNodeStorage.getLayoutVersion(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "084dd9ea6dcb14f90e0cfdc24bef716e6fdfcb0c"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg2ODc4Ng==", "bodyText": "There is also a \"datanode.id\" file being created in the Datanode that looks like a metadata yaml file. Can we look into whether we can add our layout version into that file? Reference -> org.apache.hadoop.hdds.utils.HddsServerUtil#getDatanodeIdFilePath", "url": "https://github.com/apache/ozone/pull/1720#discussion_r546868786", "createdAt": "2020-12-21T18:44:16Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "diffHunk": "@@ -42,6 +42,7 @@\n \n   public static final String STORAGE_ID = \"storageID\";\n   public static final String DATANODE_UUID = \"datanodeUuid\";\n+  public static final String DATANODE_STORAGE_DIR = \"datanodeStorageConfig\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "084dd9ea6dcb14f90e0cfdc24bef716e6fdfcb0c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "180492562773544ca9685d502a26cb0b6c9614f5", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/180492562773544ca9685d502a26cb0b6c9614f5", "committedDate": "2021-01-06T07:16:21Z", "message": "HDDS-4175. Addressing review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYzMjI5NjAy", "url": "https://github.com/apache/ozone/pull/1720#pullrequestreview-563229602", "createdAt": "2021-01-07T06:02:07Z", "commit": {"oid": "180492562773544ca9685d502a26cb0b6c9614f5"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwNjowMjowN1rOIPgGFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwNjoyNTozOVrOIPggkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzEyNTM5Nw==", "bodyText": "Can we have DataNodeUpgradeAction and SCMUpgradeAction as an interface or abstract class?", "url": "https://github.com/apache/ozone/pull/1720#discussion_r553125397", "createdAt": "2021-01-07T06:02:07Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/upgrade/DataNodeUpgradeAction.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.ozone.container.upgrade;\n+\n+import org.apache.hadoop.hdds.upgrade.HDDSUpgradeAction;\n+import org.apache.hadoop.ozone.container.common.statemachine.DatanodeStateMachine;\n+\n+/**\n+ * Upgrade Action for DataNode which takes in a 'DataNodeStateMachine' instance.\n+ */\n+public class DataNodeUpgradeAction extends", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "180492562773544ca9685d502a26cb0b6c9614f5"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzEzMjE3Ng==", "bodyText": "I am wondering whether the organization of modules will cause a problem here. The DatanodeStateMachine class is in container-service module, while this class (HDDSLayoutFeatureCatalog) is in hdds-common. The common module is usually shared across the more specific modules. Where does one create an upgrade action for the Datanode? If the action is in container-service, then it cannot be accessed in hdds-common, if the action is in common, then it cannot access the DatanodeStateMachine class.", "url": "https://github.com/apache/ozone/pull/1720#discussion_r553132176", "createdAt": "2021-01-07T06:25:39Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/upgrade/HDDSLayoutFeatureCatalog.java", "diffHunk": "@@ -39,7 +40,11 @@\n \n     private int layoutVersion;\n     private String description;\n-    private Optional< ? extends HDDSUpgradeAction> hddsUpgradeAction =\n+\n+    private Optional<? extends HDDSUpgradeAction> scmUpgradeAction =\n+        Optional.empty();\n+\n+    private Optional<? extends HDDSUpgradeAction> datanodeUpgradeAction =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "180492562773544ca9685d502a26cb0b6c9614f5"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7ac49bff252dcc6cab99fcaaa9de097e3ad3e51", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/d7ac49bff252dcc6cab99fcaaa9de097e3ad3e51", "committedDate": "2021-01-08T06:21:50Z", "message": "HDDS-4175. Addressing review comments: part 2."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb2a9c5e550de28ff2fb07ee3e5a2635886023a2", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/fb2a9c5e550de28ff2fb07ee3e5a2635886023a2", "committedDate": "2021-01-09T04:35:12Z", "message": "HDDS-4175. Addressing CI failures."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY1MDcxNzEx", "url": "https://github.com/apache/ozone/pull/1720#pullrequestreview-565071711", "createdAt": "2021-01-11T05:04:08Z", "commit": {"oid": "fb2a9c5e550de28ff2fb07ee3e5a2635886023a2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1872, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}