{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0NTM2MjM1", "number": 1451, "title": "HDDS-4117. Normalize Keypath for listKeys.", "bodyText": "What changes were proposed in this pull request?\nNormalize Keypath for listKeys.\nWhen ozone.om.enable.filesystem.paths, OM normalizes path, and stores the Keyname in the OM DB KeyTable.\nWhen listKeys uses given keyName(not normalized key path) as prefix and Starkey the list-keys will return an empty results.\nSimilar to HDDS-4102, we should normalize Starkey and keyPrefix.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4117\nHow was this patch tested?\nAdded a test.", "createdAt": "2020-09-29T03:54:05Z", "url": "https://github.com/apache/ozone/pull/1451", "merged": true, "mergeCommit": {"oid": "3861e77dba6077bb8e716269b7e6457d404c98e6"}, "closed": true, "closedAt": "2020-10-28T15:44:25Z", "author": {"login": "bharatviswa504"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNtwgxABqjM4MjE0MzgyMzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUhu-lAH2gAyNDk0NTM2MjM1OjJiOTM5YWZhMTgyMGM4NzdlZTU4MWU5Mjg5ZGZmOWQ2NmUyNzFjOTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "810c8e645f6c70f0f85f18c8674347576b09ee7c", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/810c8e645f6c70f0f85f18c8674347576b09ee7c", "committedDate": "2020-09-29T03:50:32Z", "message": "fix cs and pom update"}, "afterCommit": {"oid": "2be2252dc049911afdba0e8645579f03da7f1ffb", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/2be2252dc049911afdba0e8645579f03da7f1ffb", "committedDate": "2020-09-29T19:56:12Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxOTU3MjU5", "url": "https://github.com/apache/ozone/pull/1451#pullrequestreview-501957259", "createdAt": "2020-10-05T11:23:17Z", "commit": {"oid": "2be2252dc049911afdba0e8645579f03da7f1ffb"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMToyMzoxN1rOHcYpIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMToyNTo0MVrOHcYuFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUyNTkyMg==", "bodyText": "NIT:\nI think it's easier to follow to move the condition to here:\n     if (enableFileSystemPaths) {\n       startKey = normalizeListKeyPath(startKey);\n       keyPrefix = normalizeListKeyPath(keyPrefix);\n    }\n\nDespite the name, the startKey and keyPrefix are not normalized if enableFileSystemPaths is false", "url": "https://github.com/apache/ozone/pull/1451#discussion_r499525922", "createdAt": "2020-10-05T11:23:17Z", "author": {"login": "elek"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java", "diffHunk": "@@ -919,12 +920,32 @@ private boolean isKeyEmpty(OmKeyInfo keyInfo) {\n     // underlying table using an iterator. That automatically creates a\n     // snapshot of the data, so we don't need these locks at a higher level\n     // when we iterate.\n+\n+    startKey = normalizeListKeyPath(startKey);\n+    keyPrefix = normalizeListKeyPath(keyPrefix);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2be2252dc049911afdba0e8645579f03da7f1ffb"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUyNjMwNQ==", "bodyText": "Is there any reason to keep these two features (return empty string for empty string + keep closing /) in here intead of moving to  OmUtils.normalizeKey(keyPath)", "url": "https://github.com/apache/ozone/pull/1451#discussion_r499526305", "createdAt": "2020-10-05T11:24:00Z", "author": {"login": "elek"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java", "diffHunk": "@@ -919,12 +920,32 @@ private boolean isKeyEmpty(OmKeyInfo keyInfo) {\n     // underlying table using an iterator. That automatically creates a\n     // snapshot of the data, so we don't need these locks at a higher level\n     // when we iterate.\n+\n+    startKey = normalizeListKeyPath(startKey);\n+    keyPrefix = normalizeListKeyPath(keyPrefix);\n+\n     List<OmKeyInfo> keyList = metadataManager.listKeys(volumeName, bucketName,\n         startKey, keyPrefix, maxKeys);\n     refreshPipeline(keyList);\n     return keyList;\n   }\n \n+  private String normalizeListKeyPath(String keyPath) {\n+\n+    String normalizeKeyPath = keyPath;\n+    if (enableFileSystemPaths) {\n+      // For empty strings do nothing.\n+      if (StringUtils.isBlank(keyPath)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2be2252dc049911afdba0e8645579f03da7f1ffb"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUyNzE4OA==", "bodyText": "Do we need this method at all? Is it possible to have invalid key path after OmUtils.normalizeKey? Seems to be an unnecessary additional step.", "url": "https://github.com/apache/ozone/pull/1451#discussion_r499527188", "createdAt": "2020-10-05T11:25:41Z", "author": {"login": "elek"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/OMClientRequest.java", "diffHunk": "@@ -298,21 +296,11 @@ public static String validateAndNormalizeKey(boolean enableFileSystemPaths,\n     }\n   }\n \n-  @SuppressFBWarnings(\"DMI_HARDCODED_ABSOLUTE_FILENAME\")\n+\n   public static String validateAndNormalizeKey(String keyName)\n       throws OMException {\n-    String normalizedKeyName;\n-    if (keyName.startsWith(OM_KEY_PREFIX)) {\n-      normalizedKeyName = Paths.get(keyName).toUri().normalize().getPath();\n-    } else {\n-      normalizedKeyName = Paths.get(OM_KEY_PREFIX, keyName).toUri()\n-          .normalize().getPath();\n-    }\n-    if (!keyName.equals(normalizedKeyName)) {\n-      LOG.debug(\"Normalized key {} to {} \", keyName,\n-          normalizedKeyName.substring(1));\n-    }\n-    return isValidKeyPath(normalizedKeyName.substring(1));\n+    String normalizedKeyName = OmUtils.normalizeKey(keyName);\n+    return isValidKeyPath(normalizedKeyName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2be2252dc049911afdba0e8645579f03da7f1ffb"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f1bf22f707bac6c58fe894c8e95b41035f84176", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/6f1bf22f707bac6c58fe894c8e95b41035f84176", "committedDate": "2020-10-20T22:45:11Z", "message": "HDDS-4117. Normalize Keypath for listKeys."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "343a9bc3bc504f061877c0dfdadcc1f2b85ff44d", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/343a9bc3bc504f061877c0dfdadcc1f2b85ff44d", "committedDate": "2020-10-20T22:45:11Z", "message": "fix cs and pom update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03d0de40e03692b85aa67908f550a195a2408639", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/03d0de40e03692b85aa67908f550a195a2408639", "committedDate": "2020-10-20T22:45:12Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d385e99c769280176a2652eaac9bf05f5a774ade", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/d385e99c769280176a2652eaac9bf05f5a774ade", "committedDate": "2020-10-20T23:13:20Z", "message": "fix review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2be2252dc049911afdba0e8645579f03da7f1ffb", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/2be2252dc049911afdba0e8645579f03da7f1ffb", "committedDate": "2020-09-29T19:56:12Z", "message": "fix test"}, "afterCommit": {"oid": "d385e99c769280176a2652eaac9bf05f5a774ade", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/d385e99c769280176a2652eaac9bf05f5a774ade", "committedDate": "2020-10-20T23:13:20Z", "message": "fix review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b939afa1820c877ee581e9289dff9d66e271c95", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/2b939afa1820c877ee581e9289dff9d66e271c95", "committedDate": "2020-10-20T23:53:54Z", "message": "fix cs"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2573, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}