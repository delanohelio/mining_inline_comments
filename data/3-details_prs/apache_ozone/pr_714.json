{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyNjY4ODcz", "number": 714, "title": "HDDS-3164. Add Recon endpoint to serve missing containers and its metadata.", "bodyText": "What changes were proposed in this pull request?\n\nAdd an endpoint (/api/v1/containers/missing) to serve missing containers response\nAdd unit tests\n\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3164\nHow was this patch tested?\n\nUnit test\nManual test:\n\nBring ozone via docker compose\nAdd random keys with RATIS factor ONE using freon (ozone freon rk --replicationType=RATIS --numOfVolumes=10 --numOfBuckets=10 --numOfKeys=10 --factor=ONE --numOfThreads=20)\nBring down one datanode\nAfter 10m, the datanode should be reported as dead in Recon and the next run of MissingContainerTask should catch the missing containers in the dead datanode.", "createdAt": "2020-03-23T22:21:18Z", "url": "https://github.com/apache/ozone/pull/714", "merged": true, "mergeCommit": {"oid": "4682babb6629f93d2d21103e0713fc74b17a0ff3"}, "closed": true, "closedAt": "2020-03-25T21:46:27Z", "author": {"login": "vivekratnavel"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQl0ycgH2gAyMzkyNjY4ODczOjdmOTY2ZjkwNThiZTczM2MxOTVmZmIxZTg5ZmFmNjg1YWI0YWI2YTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRKOPaAH2gAyMzkyNjY4ODczOmY0M2I4NGZhMzQ1OTlkZjU5NDQ3MjdhMzI0NWVjNTI1ZTc2YmI5MmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7f966f9058be733c195ffb1e89faf685ab4ab6a8", "author": {"user": {"login": "vivekratnavel", "name": "Vivek Ratnavel Subramanian"}}, "url": "https://github.com/apache/ozone/commit/7f966f9058be733c195ffb1e89faf685ab4ab6a8", "committedDate": "2020-03-23T22:13:01Z", "message": "HDDS-3164. Add Recon endpoint to serve missing containers and its metadata."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed56e61e2d9827ed1a535a75596e42875557b747", "author": {"user": {"login": "vivekratnavel", "name": "Vivek Ratnavel Subramanian"}}, "url": "https://github.com/apache/ozone/commit/ed56e61e2d9827ed1a535a75596e42875557b747", "committedDate": "2020-03-24T19:43:47Z", "message": "Consider UNHEALTHY state of container replicas while determining missing containers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNzA0Nzcz", "url": "https://github.com/apache/ozone/pull/714#pullrequestreview-380704773", "createdAt": "2020-03-24T21:19:42Z", "commit": {"oid": "ed56e61e2d9827ed1a535a75596e42875557b747"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMToxOTo0M1rOF7DgcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMTozOTo0OFrOF7EH4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ2Nzc2MQ==", "bodyText": "Unintended change?", "url": "https://github.com/apache/ozone/pull/714#discussion_r397467761", "createdAt": "2020-03-24T21:19:43Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/fsck/MissingContainerTask.java", "diffHunk": "@@ -47,7 +48,7 @@\n \n   private ContainerManager containerManager;\n   private MissingContainersDao missingContainersDao;\n-  private static final long INTERVAL = 5 * 60 * 1000L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed56e61e2d9827ed1a535a75596e42875557b747"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3MTAzOA==", "bodyText": "Nit. This may be replaced with something like\nall.forEach(r -> Assert.assertTrue(missingContainerIDs.contains(r.getContainerId())));", "url": "https://github.com/apache/ozone/pull/714#discussion_r397471038", "createdAt": "2020-03-24T21:26:15Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-ozone/recon/src/test/java/org/apache/hadoop/ozone/recon/fsck/TestMissingContainerTask.java", "diffHunk": "@@ -90,15 +102,19 @@ public void testRun() throws Exception {\n     missingContainerTask.start();\n \n     LambdaTestUtils.await(6000, 1000, () ->\n-        (missingContainersTableHandle.findAll().size() == 1));\n+        (missingContainersTableHandle.findAll().size() == 2));\n     all = missingContainersTableHandle.findAll();\n-    Assert.assertEquals(3, all.get(0).getContainerId().longValue());\n-\n+    // Container IDs 2 and 3 should be present in the missing containers table\n+    Set<Long> missingContainerIDs = Collections.unmodifiableSet(\n+        new HashSet<>(Arrays.asList(2L, 3L))\n+    );\n+    Assert.assertTrue(all.stream().allMatch(record ->\n+        missingContainerIDs.stream().anyMatch(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed56e61e2d9827ed1a535a75596e42875557b747"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3NjM2NQ==", "bodyText": "Why not do assertEquals check with \"missingSince\" ?", "url": "https://github.com/apache/ozone/pull/714#discussion_r397476365", "createdAt": "2020-03-24T21:36:47Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-ozone/recon/src/test/java/org/apache/hadoop/ozone/recon/api/TestContainerEndpoint.java", "diffHunk": "@@ -350,24 +407,52 @@ public void testGetContainersWithPrevKey() {\n     assertEquals(1L, containerMetadata.getContainerID());\n \n     // test for negative cases\n-    response = containerKeyService.getContainers(-1, 5L);\n+    response = containerEndpoint.getContainers(-1, 5L);\n     responseObject = (ContainersResponse) response.getEntity();\n     data = responseObject.getContainersResponseData();\n     containers = new ArrayList<>(data.getContainers());\n     assertEquals(0, containers.size());\n     assertEquals(2, data.getTotalCount());\n \n-    response = containerKeyService.getContainers(-1, -1L);\n+    response = containerEndpoint.getContainers(-1, -1L);\n     responseObject = (ContainersResponse) response.getEntity();\n     data = responseObject.getContainersResponseData();\n     containers = new ArrayList<>(data.getContainers());\n     assertEquals(2, containers.size());\n     assertEquals(2, data.getTotalCount());\n   }\n \n+  @Test\n+  public void testGetMissingContainers() {\n+    Response response = containerEndpoint.getMissingContainers();\n+\n+    MissingContainersResponse responseObject =\n+        (MissingContainersResponse) response.getEntity();\n+\n+    assertEquals(0, responseObject.getTotalCount());\n+    assertEquals(Collections.EMPTY_LIST, responseObject.getContainers());\n+\n+    // Add missing containers to the database\n+    long missingSince = System.currentTimeMillis();\n+    MissingContainers newRecord =\n+        new MissingContainers(1L, missingSince);\n+    missingContainersDao.insert(newRecord);\n+\n+    response = containerEndpoint.getMissingContainers();\n+    responseObject = (MissingContainersResponse) response.getEntity();\n+    assertEquals(1, responseObject.getTotalCount());\n+    MissingContainerMetadata container =\n+        responseObject.getContainers().stream().findFirst().orElse(null);\n+    Assert.assertNotNull(container);\n+\n+    assertEquals(containerID.getId(), container.getContainerID());\n+    assertEquals(keyCount, container.getKeys());\n+    assertEquals(pipelineID.getId(), container.getPipelineID());\n+    assertEquals(0, container.getDatanodes().size());\n+    assertTrue(System.currentTimeMillis() > container.getMissingSince());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed56e61e2d9827ed1a535a75596e42875557b747"}, "originalPosition": 319}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3Nzg1Ng==", "bodyText": "Nit. We can probably get rid of this method 'getMockOzoneManagerServiceProvider'.", "url": "https://github.com/apache/ozone/pull/714#discussion_r397477856", "createdAt": "2020-03-24T21:39:48Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-ozone/recon/src/test/java/org/apache/hadoop/ozone/recon/api/TestContainerEndpoint.java", "diffHunk": "@@ -45,66 +48,120 @@\n import org.apache.hadoop.ozone.recon.api.types.ContainersResponse;\n import org.apache.hadoop.ozone.recon.api.types.KeyMetadata;\n import org.apache.hadoop.ozone.recon.api.types.KeysResponse;\n+import org.apache.hadoop.ozone.recon.api.types.MissingContainerMetadata;\n+import org.apache.hadoop.ozone.recon.api.types.MissingContainersResponse;\n import org.apache.hadoop.ozone.recon.recovery.ReconOMMetadataManager;\n+import org.apache.hadoop.ozone.recon.scm.ReconContainerManager;\n+import org.apache.hadoop.ozone.recon.scm.ReconStorageContainerManagerFacade;\n import org.apache.hadoop.ozone.recon.spi.ContainerDBServiceProvider;\n+import org.apache.hadoop.ozone.recon.spi.StorageContainerServiceProvider;\n import org.apache.hadoop.ozone.recon.spi.impl.OzoneManagerServiceProviderImpl;\n+import org.apache.hadoop.ozone.recon.spi.impl.StorageContainerServiceProviderImpl;\n import org.apache.hadoop.ozone.recon.tasks.ContainerKeyMapperTask;\n import org.apache.hadoop.hdds.utils.db.Table;\n+import org.hadoop.ozone.recon.schema.ReconTaskSchemaDefinition;\n import org.hadoop.ozone.recon.schema.StatsSchemaDefinition;\n-import org.jooq.impl.DSL;\n-import org.jooq.impl.DefaultConfiguration;\n+import org.hadoop.ozone.recon.schema.UtilizationSchemaDefinition;\n+import org.hadoop.ozone.recon.schema.tables.daos.MissingContainersDao;\n+import org.hadoop.ozone.recon.schema.tables.daos.ReconTaskStatusDao;\n+import org.hadoop.ozone.recon.schema.tables.pojos.MissingContainers;\n+import org.jooq.Configuration;\n+import org.junit.Assert;\n import org.junit.Before;\n import org.junit.Test;\n \n import com.google.inject.AbstractModule;\n import com.google.inject.Injector;\n \n /**\n- * Test for container key service.\n+ * Test for container endpoint.\n  */\n-public class TestContainerKeyService extends AbstractOMMetadataManagerTest {\n+public class TestContainerEndpoint extends AbstractOMMetadataManagerTest {\n \n   private ContainerDBServiceProvider containerDbServiceProvider;\n-  private Injector injector;\n-  private OzoneManagerServiceProviderImpl ozoneManagerServiceProvider;\n-  private ContainerKeyService containerKeyService;\n+  private ContainerEndpoint containerEndpoint;\n   private GuiceInjectorUtilsForTestsImpl guiceInjectorTest =\n       new GuiceInjectorUtilsForTestsImpl();\n   private boolean isSetupDone = false;\n   private ReconOMMetadataManager reconOMMetadataManager;\n+  private MissingContainersDao missingContainersDao;\n+  private ContainerID containerID = new ContainerID(1L);\n+  private PipelineID pipelineID;\n+  private long keyCount = 5L;\n   private void initializeInjector() throws Exception {\n     reconOMMetadataManager = getTestMetadataManager(\n         initializeNewOmMetadataManager());\n-    ozoneManagerServiceProvider = getMockOzoneManagerServiceProvider();\n+    OzoneManagerServiceProviderImpl ozoneManagerServiceProvider =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed56e61e2d9827ed1a535a75596e42875557b747"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f6210232f5569011a53624c4d9465d4f01f68fc", "author": {"user": {"login": "vivekratnavel", "name": "Vivek Ratnavel Subramanian"}}, "url": "https://github.com/apache/ozone/commit/1f6210232f5569011a53624c4d9465d4f01f68fc", "committedDate": "2020-03-24T22:49:41Z", "message": "Fix review comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7b76bfc5f49afae7c6bb4a095509d1d59137c02", "author": {"user": {"login": "vivekratnavel", "name": "Vivek Ratnavel Subramanian"}}, "url": "https://github.com/apache/ozone/commit/d7b76bfc5f49afae7c6bb4a095509d1d59137c02", "committedDate": "2020-03-25T07:11:52Z", "message": "Empty commit to trigger build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f43b84fa34599df5944727a3245ec525e76bb92c", "author": {"user": {"login": "vivekratnavel", "name": "Vivek Ratnavel Subramanian"}}, "url": "https://github.com/apache/ozone/commit/f43b84fa34599df5944727a3245ec525e76bb92c", "committedDate": "2020-03-25T16:37:24Z", "message": "Merge remote-tracking branch 'apache/master' into HDDS-3164"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3524, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}