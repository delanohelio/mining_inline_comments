{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2MTkxNDg3", "number": 1615, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNTozNjo1NVrOE8yIow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwOToxMjozNVrOFD43CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyMTcxNDI3OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/TrashPolicyOzone.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNTozNjo1NVrOH5HHcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNTozNzoyN1rOH5HKjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY0NzQ3Mg==", "bodyText": "I think this should happen after the thread.sleep at line 117. As for most of the cases, when an OM restart the trash emptier it should check this status and skip doing any Trash processing.", "url": "https://github.com/apache/ozone/pull/1615#discussion_r529647472", "createdAt": "2020-11-24T15:36:55Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/TrashPolicyOzone.java", "diffHunk": "@@ -98,7 +105,8 @@ public Runnable getEmptier() throws IOException {\n \n     @Override\n     public void run() {\n-      if (emptierInterval == 0) {\n+      // if this is not the leader node,don't run the emptier\n+      if (emptierInterval == 0 || !om.isLeader()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0dea3ba4689da4be804ae727c16081091b7f1960"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY0ODI3MA==", "bodyText": "Also lets see if we can add a unit test for this change. Please check with @bharatviswa504 on the test", "url": "https://github.com/apache/ozone/pull/1615#discussion_r529648270", "createdAt": "2020-11-24T15:37:27Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/TrashPolicyOzone.java", "diffHunk": "@@ -98,7 +105,8 @@ public Runnable getEmptier() throws IOException {\n \n     @Override\n     public void run() {\n-      if (emptierInterval == 0) {\n+      // if this is not the leader node,don't run the emptier\n+      if (emptierInterval == 0 || !om.isLeader()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY0NzQ3Mg=="}, "originalCommit": {"oid": "0dea3ba4689da4be804ae727c16081091b7f1960"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5NTQ1MTMzOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/TrashPolicyOzone.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwNDo1Nzo1MlrOIDpK3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwNDo1Nzo1MlrOIDpK3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDY5MTE2Nw==", "bodyText": "This should be continue here ?", "url": "https://github.com/apache/ozone/pull/1615#discussion_r540691167", "createdAt": "2020-12-11T04:57:52Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/TrashPolicyOzone.java", "diffHunk": "@@ -107,6 +136,9 @@ public void run() {\n         end = ceiling(now, emptierInterval);\n         try {                                     // sleep for interval\n           Thread.sleep(end - now);\n+          if (!om.isLeader()){\n+            return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a99449edf2820609680bbaad0c4dcd155fa960a5"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5NjIxNjQwOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwOToxMjozNVrOIDvshg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwOToxMjozNVrOIDvshg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc5ODA4Ng==", "bodyText": "Lets remove this TODO's", "url": "https://github.com/apache/ozone/pull/1615#discussion_r540798086", "createdAt": "2020-12-11T09:12:35Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -1402,10 +1394,7 @@ public void stop() {\n       }\n       // TODO:Also stop this thread if an OM switches from leader to follower.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e74d15722a3b8a747485606e19568c36b2b39b6"}, "originalPosition": 40}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4511, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}