{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzMDcxNzIy", "number": 628, "title": "HDDS-1008. Invalidate closed container replicas on a failed volume.", "bodyText": "What changes were proposed in this pull request?\nThe hdds volume check will now check for the existence of its root directory. Further the containers pertaining to the volume will be marked unhealthy.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-1008\nHow was this patch tested?\nUnit test", "createdAt": "2020-03-03T17:09:13Z", "url": "https://github.com/apache/ozone/pull/628", "merged": true, "mergeCommit": {"oid": "48f6129d87fb88e691968ea763306e2813f79321"}, "closed": true, "closedAt": "2020-03-06T07:45:04Z", "author": {"login": "lokeshj1703"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKFZvdAH2gAyMzgzMDcxNzIyOmZhMzgwYzI3MDIzNjAyZWJmYjdhYzg4ZmRhYmE5NjI4OTNhODI1MWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKm17IgH2gAyMzgzMDcxNzIyOjMyMjUxMzEzYmFjYWZiMDczNmNiMWZhYzlkMjBmMjg4OWM3ZGQxYmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fa380c27023602ebfb7ac88fdaba962893a8251b", "author": {"user": {"login": "lokeshj1703", "name": "Lokesh Jain"}}, "url": "https://github.com/apache/ozone/commit/fa380c27023602ebfb7ac88fdaba962893a8251b", "committedDate": "2020-03-03T17:02:58Z", "message": "HDDS-1008. Invalidate container replicas on volume failure."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "754e62bd5fb810a287f2bf4d355076ec4f6cadba", "author": {"user": {"login": "lokeshj1703", "name": "Lokesh Jain"}}, "url": "https://github.com/apache/ozone/commit/754e62bd5fb810a287f2bf4d355076ec4f6cadba", "committedDate": "2020-03-03T18:45:44Z", "message": "Fixes checkstyle and findbugs."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NTE2NzE3", "url": "https://github.com/apache/ozone/pull/628#pullrequestreview-368516717", "createdAt": "2020-03-04T05:43:20Z", "commit": {"oid": "754e62bd5fb810a287f2bf4d355076ec4f6cadba"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b77278eba3a878a3187bdefbb61d8d30b9bdf33d", "author": {"user": {"login": "lokeshj1703", "name": "Lokesh Jain"}}, "url": "https://github.com/apache/ozone/commit/b77278eba3a878a3187bdefbb61d8d30b9bdf33d", "committedDate": "2020-03-04T10:34:04Z", "message": "Addresses supratim's comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "513ff182fae284020e9d7be386d87bc932ec1ee9", "author": {"user": {"login": "lokeshj1703", "name": "Lokesh Jain"}}, "url": "https://github.com/apache/ozone/commit/513ff182fae284020e9d7be386d87bc932ec1ee9", "committedDate": "2020-03-04T11:31:10Z", "message": "Fixes unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NzY1NDg3", "url": "https://github.com/apache/ozone/pull/628#pullrequestreview-368765487", "createdAt": "2020-03-04T13:14:35Z", "commit": {"oid": "513ff182fae284020e9d7be386d87bc932ec1ee9"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzoxNDozNlrOFxsvuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzozMDoxMlrOFxtQ1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1NzY1Ng==", "bodyText": "This can probably be done outside the writeLock - should be safe.\nalso, we can invoke the listener outside the for loop - perhaps like:\nif (!failedVolumes.isEmpty()) {failedVolumeListener.run();}", "url": "https://github.com/apache/ozone/pull/628#discussion_r387657656", "createdAt": "2020-03-04T13:14:36Z", "author": {"login": "supratimdeka"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/volume/VolumeSet.java", "diffHunk": "@@ -239,23 +249,24 @@ private void checkAllVolumes() throws IOException {\n    * @param failedVolumes\n    */\n   private void handleVolumeFailures(Set<HddsVolume> failedVolumes) {\n-    for (HddsVolume v: failedVolumes) {\n-      this.writeLock();\n-      try {\n+    this.writeLock();\n+    try {\n+      for (HddsVolume v : failedVolumes) {\n         // Immediately mark the volume as failed so it is unavailable\n         // for new containers.\n-        volumeMap.remove(v.getHddsRootDir().getPath());\n-        failedVolumeMap.putIfAbsent(v.getHddsRootDir().getPath(), v);\n-      } finally {\n-        this.writeUnlock();\n+        failVolume(v.getHddsRootDir().getPath());\n       }\n-\n-      // TODO:\n-      // 1. Mark all closed containers on the volume as unhealthy.\n-      // 2. Consider stopping IO on open containers and tearing down\n-      //    active pipelines.\n-      // 3. Handle Ratis log disk failure.\n+      if (failedVolumeListener != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "513ff182fae284020e9d7be386d87bc932ec1ee9"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY2MTcxOQ==", "bodyText": "Good point. But, I think this is how it is already implemented. updateContainerData() on encountering an exception, does not reset the state if the state is UNHEALTHY. Or did I get that wrong?", "url": "https://github.com/apache/ozone/pull/628#discussion_r387661719", "createdAt": "2020-03-04T13:22:13Z", "author": {"login": "supratimdeka"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/keyvalue/KeyValueContainer.java", "diffHunk": "@@ -298,6 +298,8 @@ public void markContainerForClose() throws StorageContainerException {\n   public void markContainerUnhealthy() throws StorageContainerException {\n     writeLock();\n     try {\n+      // TODO: container should be marked UNHEALTHY in memory even if container", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "513ff182fae284020e9d7be386d87bc932ec1ee9"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY2NDM5Mg==", "bodyText": "any reason why we are migrating to this constructor with the additional argument?\nsame question applies to all the other places where this change has been made.", "url": "https://github.com/apache/ozone/pull/628#discussion_r387664392", "createdAt": "2020-03-04T13:26:56Z", "author": {"login": "supratimdeka"}, "path": "hadoop-hdds/container-service/src/test/java/org/apache/hadoop/ozone/container/common/volume/TestVolumeSet.java", "diffHunk": "@@ -64,7 +64,7 @@\n   private static final String DUMMY_IP_ADDR = \"0.0.0.0\";\n \n   private void initializeVolumeSet() throws Exception {\n-    volumeSet = new VolumeSet(UUID.randomUUID().toString(), conf);\n+    volumeSet = new VolumeSet(UUID.randomUUID().toString(), null, conf);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "513ff182fae284020e9d7be386d87bc932ec1ee9"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY2NjEzMg==", "bodyText": "might make sense to add the container id and the volume in this error log.", "url": "https://github.com/apache/ozone/pull/628#discussion_r387666132", "createdAt": "2020-03-04T13:30:12Z", "author": {"login": "supratimdeka"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/impl/ContainerSet.java", "diffHunk": "@@ -122,6 +122,18 @@ public int containerCount() {\n     return containerMap.size();\n   }\n \n+  public void handleVolumeFailures() {\n+    containerMap.values().forEach(c -> {\n+      if (c.getContainerData().getVolume().isFailed()) {\n+        try {\n+          c.markContainerUnhealthy();\n+        } catch (StorageContainerException e) {\n+          LOG.error(\"Failed to move container to UNHEALTHY state\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "513ff182fae284020e9d7be386d87bc932ec1ee9"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4OTQ1NzUz", "url": "https://github.com/apache/ozone/pull/628#pullrequestreview-368945753", "createdAt": "2020-03-04T16:47:36Z", "commit": {"oid": "513ff182fae284020e9d7be386d87bc932ec1ee9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32251313bacafb0736cb1fac9d20f2889c7dd1bc", "author": {"user": {"login": "lokeshj1703", "name": "Lokesh Jain"}}, "url": "https://github.com/apache/ozone/commit/32251313bacafb0736cb1fac9d20f2889c7dd1bc", "committedDate": "2020-03-05T08:00:37Z", "message": "Address review comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3675, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}