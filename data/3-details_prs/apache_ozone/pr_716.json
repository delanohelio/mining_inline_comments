{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzMDEzODE3", "number": 716, "title": "HDDS-3155. Improved ozone client flush implementation to make it faster.", "bodyText": "What changes were proposed in this pull request?\nWhen we run MR Job (with 1000 maps)  based on OzoneFileSystem. After the map and reduce has finished 100%, the appmaster pauses More than 40 minutes .\n20/03/05 14:43:33 INFO mapreduce.Job: map 100% reduce 100% \n20/03/05 15:29:52 INFO mapreduce.Job: Job job_1583385253878_0002 completed successfully\nIt turns out that the appmaster writes all the task events to the log one by one, calling flush once for each one. This operation is very time consuming in ozone.\nHDFS currently has two flush ports, flush () and hflush ().\nflush() : flush the data from client  buffer to the client package (dfs.write.packet.size default 64k). If the package is not full, it will not be sent to the datanode.\nhflush(): each invocation sends the data in the buffer to the datanode.\nNow, ozone's flush is more similar to HDFS's hflush. This PR adds an implementation of flush similar to HDFS\u2018s flush. Using ozone.client.stream.buffer.flush.delay to control whether to enable(not enabled by default). If we enabled it, when we call the flush() method, we will determine whether the data in the current buffer is greater than ozone.client.stream.buffer.size. If greater than, we will send it to the datanode. Otherwise, we will not send it.\nThe flush performance has been significantly improved through testing. The job is no longer blocked, It will take 1 second to exit after MR finished.\n20/03/25 11:04:04 INFO mapreduce.Job:  map 100% reduce 100%\n20/03/25 11:04:05 INFO mapreduce.Job: Job job_1585104739905_0002 completed successfully\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3155\nHow was this patch tested?\nRun yarn on the ozone, perform the testdfsio job below, start a thousand maps. And see the exit time after map and reduce 100%.\nhadoop jar  /path/of/hadoop-mapreduce-client-jobclient-2.8.5-tests.jar TestDFSIO -write -nrFiles 1000 -fileSize 1KB  -resFile /tmp/dfsio-write.out\nAdd the following configuration in ozone-site.xml and repeat the above command to see the execution.\n<property>\n   <name>ozone.client.stream.buffer.flush.delay</name>\n   <value>true</value>\n</property>", "createdAt": "2020-03-24T14:10:01Z", "url": "https://github.com/apache/ozone/pull/716", "merged": true, "mergeCommit": {"oid": "2098516928378418b11f65cf404e3ecebbf46910"}, "closed": true, "closedAt": "2020-04-22T06:59:03Z", "author": {"login": "captainzmc"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQyLvigH2gAyMzkzMDEzODE3OmQyYTFmNTc0YmY3YTBiMTAzYjEzOWZmZmVhNmY3ZDkyYzIzMzdhMWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaCulEAFqTM5Nzg5NDYyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d2a1f574bf7a0b103b139fffea6f7d92c2337a1c", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/d2a1f574bf7a0b103b139fffea6f7d92c2337a1c", "committedDate": "2020-03-24T12:36:57Z", "message": "support for data delay flush in buffers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c32bec8f487992a3bbfcb664e3b66e485bca94d", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/0c32bec8f487992a3bbfcb664e3b66e485bca94d", "committedDate": "2020-03-24T14:39:18Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e02e02b30a726d00715bbd237246e188d5939954", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/e02e02b30a726d00715bbd237246e188d5939954", "committedDate": "2020-03-24T15:38:29Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NjM0MTgz", "url": "https://github.com/apache/ozone/pull/716#pullrequestreview-394634183", "createdAt": "2020-04-16T13:31:12Z", "commit": {"oid": "e02e02b30a726d00715bbd237246e188d5939954"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NjM1NDM4", "url": "https://github.com/apache/ozone/pull/716#pullrequestreview-394635438", "createdAt": "2020-04-16T13:32:35Z", "commit": {"oid": "e02e02b30a726d00715bbd237246e188d5939954"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMzozMjozNVrOGGlc4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMzozMjozNVrOGGlc4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1ODI0Mw==", "bodyText": "let's change \"we will checks\" to \"it checks\"", "url": "https://github.com/apache/ozone/pull/716#discussion_r409558243", "createdAt": "2020-04-16T13:32:35Z", "author": {"login": "bshashikant"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConfigKeys.java", "diffHunk": "@@ -149,6 +149,17 @@\n   public static final TimeDuration OZONE_CLIENT_RETRY_INTERVAL_DEFAULT =\n       TimeDuration.valueOf(0, TimeUnit.MILLISECONDS);\n \n+  /**\n+   * If this value is true, when the client calls the flush() method,\n+   * we will checks whether the data in the buffer is greater than", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e02e02b30a726d00715bbd237246e188d5939954"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ffe86a61ea2e0a27f9c2c04cbfd047b82e90492", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/2ffe86a61ea2e0a27f9c2c04cbfd047b82e90492", "committedDate": "2020-04-18T04:23:18Z", "message": "fix review issue and add ut"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58233acf6aaa91bf78a13613658a6d752f2c7cc9", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/58233acf6aaa91bf78a13613658a6d752f2c7cc9", "committedDate": "2020-04-18T07:12:13Z", "message": "fix ut"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26e27ea5f6581ad51709c670b259ddb20aea1c86", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/26e27ea5f6581ad51709c670b259ddb20aea1c86", "committedDate": "2020-04-22T01:44:30Z", "message": "remove useless metrics in new ut testFlushChunkDelay"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "22baf7918429d7b1506df5d3faec6d0a4d72f4c2", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/22baf7918429d7b1506df5d3faec6d0a4d72f4c2", "committedDate": "2020-04-22T01:34:57Z", "message": "remove useless metrics in new ut testFlushChunkDelay"}, "afterCommit": {"oid": "26e27ea5f6581ad51709c670b259ddb20aea1c86", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/26e27ea5f6581ad51709c670b259ddb20aea1c86", "committedDate": "2020-04-22T01:44:30Z", "message": "remove useless metrics in new ut testFlushChunkDelay"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3ODk0NjIw", "url": "https://github.com/apache/ozone/pull/716#pullrequestreview-397894620", "createdAt": "2020-04-22T06:58:48Z", "commit": {"oid": "26e27ea5f6581ad51709c670b259ddb20aea1c86"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3531, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}