{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2OTU4NTcy", "number": 856, "title": "HDDS-3475. Use transactionInfo table to persist transaction information.", "bodyText": "What changes were proposed in this pull request?\nCommit the transaction info as part of double buffer flush.\nThis requires #855. Posted this for CI run.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3475\nHow was this patch tested?\nAdded UT.", "createdAt": "2020-04-21T23:25:16Z", "url": "https://github.com/apache/ozone/pull/856", "merged": true, "mergeCommit": {"oid": "d3551e28bd76715e4009992f625da9b0d7d5b499"}, "closed": true, "closedAt": "2020-05-29T01:38:21Z", "author": {"login": "bharatviswa504"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcc0KcdAFqTQwMzg5MTI5OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcl0Sk3AH2gAyNDA2OTU4NTcyOjRlODJjMDczOGIyN2MzMDZjNjhkZjNjZTNhZTM4YjVmYzhjOTZjZjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzODkxMjk4", "url": "https://github.com/apache/ozone/pull/856#pullrequestreview-403891298", "createdAt": "2020-04-30T21:29:42Z", "commit": {"oid": "e3c28d2c66bcac8e8db21697de3fc3ae13706dcf"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMToyOTo0MlrOGO7BGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMTozODo1NVrOGO7RKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMwMDE4NA==", "bodyText": "For this constructor, termGet will be null. But a daemon is initialized to flushTransactions. Could it lead to NullPointer?", "url": "https://github.com/apache/ozone/pull/856#discussion_r418300184", "createdAt": "2020-04-30T21:29:42Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerDoubleBuffer.java", "diffHunk": "@@ -86,10 +89,10 @@\n \n   private final boolean isRatisEnabled;\n \n-  public OzoneManagerDoubleBuffer(OMMetadataManager omMetadataManager,\n-      OzoneManagerRatisSnapshot ozoneManagerRatisSnapShot) {\n-    this(omMetadataManager, ozoneManagerRatisSnapShot, true);\n-  }\n+  /**\n+   * function which will get term associated with the transaction index.\n+   */\n+  private Function<Long, Long> termGet = null;\n \n   public OzoneManagerDoubleBuffer(OMMetadataManager omMetadataManager,\n       OzoneManagerRatisSnapshot ozoneManagerRatisSnapShot,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3c28d2c66bcac8e8db21697de3fc3ae13706dcf"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMwNDI5Ng==", "bodyText": "Sorry this comment is not clear. Do you mean sorted Transaction list is not required here?", "url": "https://github.com/apache/ozone/pull/856#discussion_r418304296", "createdAt": "2020-04-30T21:38:55Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerDoubleBuffer.java", "diffHunk": "@@ -173,17 +196,19 @@ private void flushTransactions() {\n                 flushedTransactionsSize);\n           }\n \n-          long lastRatisTransactionIndex =\n-              readyBuffer.stream().map(DoubleBufferEntry::getTrxLogIndex)\n-                  .max(Long::compareTo).get();\n-\n-          List<Long> flushedEpochs =\n-              readyBuffer.stream().map(DoubleBufferEntry::getTrxLogIndex)\n-                  .sorted().collect(Collectors.toList());\n+          // When non-HA do this step here, as the sorted is not require in\n+          // flush to DB. As in non-HA We want to complete futures as quick\n+          // as possible after flush to DB, to release rpc handler threads.\n+          if (!isRatisEnabled) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3c28d2c66bcac8e8db21697de3fc3ae13706dcf"}, "originalPosition": 91}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e3c28d2c66bcac8e8db21697de3fc3ae13706dcf", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/e3c28d2c66bcac8e8db21697de3fc3ae13706dcf", "committedDate": "2020-04-21T23:23:16Z", "message": "HDDS-3475. Use transactionInfo table to persist transaction information."}, "afterCommit": {"oid": "cf5732846aa05b6b097cdecd122515955422782b", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/cf5732846aa05b6b097cdecd122515955422782b", "committedDate": "2020-05-11T19:06:46Z", "message": "HDDS-3475. Use transactionInfo table to persist transaction information to OM DB."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "624cc487417b32bae9c1e538dda4a9add65c0470", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/624cc487417b32bae9c1e538dda4a9add65c0470", "committedDate": "2020-05-11T21:17:10Z", "message": "fix tests and few more changes"}, "afterCommit": {"oid": "746a4453f0f3ca78637bc1fd4c4d0b9d6d8db79b", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/746a4453f0f3ca78637bc1fd4c4d0b9d6d8db79b", "committedDate": "2020-05-11T21:19:20Z", "message": "fix tests and few more changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f3d6cedeaec577b5280baefd1082c489df27dd9", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/5f3d6cedeaec577b5280baefd1082c489df27dd9", "committedDate": "2020-05-22T18:07:49Z", "message": "HDDS-3475. Use transactionInfo table to persist transaction information."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "746a4453f0f3ca78637bc1fd4c4d0b9d6d8db79b", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/746a4453f0f3ca78637bc1fd4c4d0b9d6d8db79b", "committedDate": "2020-05-11T21:19:20Z", "message": "fix tests and few more changes"}, "afterCommit": {"oid": "c1d29fdab73c3274e37b2322bb1eb402ea7a29b0", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/c1d29fdab73c3274e37b2322bb1eb402ea7a29b0", "committedDate": "2020-05-20T17:54:09Z", "message": "HDDS-3475. Use transactionInfo table to persist transaction information to OM DB."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c1d29fdab73c3274e37b2322bb1eb402ea7a29b0", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/c1d29fdab73c3274e37b2322bb1eb402ea7a29b0", "committedDate": "2020-05-20T17:54:09Z", "message": "HDDS-3475. Use transactionInfo table to persist transaction information to OM DB."}, "afterCommit": {"oid": "5f3d6cedeaec577b5280baefd1082c489df27dd9", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/5f3d6cedeaec577b5280baefd1082c489df27dd9", "committedDate": "2020-05-22T18:07:49Z", "message": "HDDS-3475. Use transactionInfo table to persist transaction information."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNDA3NDI1", "url": "https://github.com/apache/ozone/pull/856#pullrequestreview-420407425", "createdAt": "2020-05-28T19:06:41Z", "commit": {"oid": "5f3d6cedeaec577b5280baefd1082c489df27dd9"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxOTowNjo0MVrOGcCvDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxOTozMTowN1rOGcDgTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA1ODEyNA==", "bodyText": "Checking indexToTerm not null instead of omRatisSnapshot", "url": "https://github.com/apache/ozone/pull/856#discussion_r432058124", "createdAt": "2020-05-28T19:06:41Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerDoubleBuffer.java", "diffHunk": "@@ -121,15 +133,27 @@ public Builder enableTracing(boolean enableTracing) {\n       return this;\n     }\n \n+    public Builder setIndexToTerm(Function<Long, Long> termGet) {\n+      this.indexToTerm = termGet;\n+      return this;\n+    }\n+\n     public OzoneManagerDoubleBuffer build() {\n+      if (isRatisEnabled) {\n+        Preconditions.checkNotNull(indexToTerm, \"When ratis is enabled, \" +\n+                \"OzoneManagerRatisSnapshot should not be null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f3d6cedeaec577b5280baefd1082c489df27dd9"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA3MDczMw==", "bodyText": "Time for this sorting should be inconsequential. The readyBuffer would have 10s of transactions at max.\nDo we really need to separate it for HA and non-HA?\nNIT: Can you please fix the typo require -> required and capital W in We.", "url": "https://github.com/apache/ozone/pull/856#discussion_r432070733", "createdAt": "2020-05-28T19:31:07Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerDoubleBuffer.java", "diffHunk": "@@ -173,17 +196,19 @@ private void flushTransactions() {\n                 flushedTransactionsSize);\n           }\n \n-          long lastRatisTransactionIndex =\n-              readyBuffer.stream().map(DoubleBufferEntry::getTrxLogIndex)\n-                  .max(Long::compareTo).get();\n-\n-          List<Long> flushedEpochs =\n-              readyBuffer.stream().map(DoubleBufferEntry::getTrxLogIndex)\n-                  .sorted().collect(Collectors.toList());\n+          // When non-HA do this step here, as the sorted is not require in\n+          // flush to DB. As in non-HA We want to complete futures as quick\n+          // as possible after flush to DB, to release rpc handler threads.\n+          if (!isRatisEnabled) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMwNDI5Ng=="}, "originalCommit": {"oid": "e3c28d2c66bcac8e8db21697de3fc3ae13706dcf"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e82c0738b27c306c68df3ce3ae38b5fc8c96cf0", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/4e82c0738b27c306c68df3ce3ae38b5fc8c96cf0", "committedDate": "2020-05-28T20:56:38Z", "message": "fix review comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3411, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}