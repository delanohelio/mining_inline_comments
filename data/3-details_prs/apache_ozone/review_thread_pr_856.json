{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2OTU4NTcy", "number": 856, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMToyOTo0MlrOD4NrBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxOTowNjo0MVrOEAoxIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMjcwODU0OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerDoubleBuffer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMToyOTo0MlrOGO7BGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxOToyNDoyMFrOGTqHLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMwMDE4NA==", "bodyText": "For this constructor, termGet will be null. But a daemon is initialized to flushTransactions. Could it lead to NullPointer?", "url": "https://github.com/apache/ozone/pull/856#discussion_r418300184", "createdAt": "2020-04-30T21:29:42Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerDoubleBuffer.java", "diffHunk": "@@ -86,10 +89,10 @@\n \n   private final boolean isRatisEnabled;\n \n-  public OzoneManagerDoubleBuffer(OMMetadataManager omMetadataManager,\n-      OzoneManagerRatisSnapshot ozoneManagerRatisSnapShot) {\n-    this(omMetadataManager, ozoneManagerRatisSnapShot, true);\n-  }\n+  /**\n+   * function which will get term associated with the transaction index.\n+   */\n+  private Function<Long, Long> termGet = null;\n \n   public OzoneManagerDoubleBuffer(OMMetadataManager omMetadataManager,\n       OzoneManagerRatisSnapshot ozoneManagerRatisSnapShot,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3c28d2c66bcac8e8db21697de3fc3ae13706dcf"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI2NjA5NQ==", "bodyText": "This constructor is removed, as now we use Builder. And also for non-HA this termGet is not used, so we don't need this to be set. So, skipped setting this in OzoneManagerProtocolServerSideTranslatorPB. (Previously this constructor used to be called from this class)", "url": "https://github.com/apache/ozone/pull/856#discussion_r423266095", "createdAt": "2020-05-11T19:24:20Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerDoubleBuffer.java", "diffHunk": "@@ -86,10 +89,10 @@\n \n   private final boolean isRatisEnabled;\n \n-  public OzoneManagerDoubleBuffer(OMMetadataManager omMetadataManager,\n-      OzoneManagerRatisSnapshot ozoneManagerRatisSnapShot) {\n-    this(omMetadataManager, ozoneManagerRatisSnapShot, true);\n-  }\n+  /**\n+   * function which will get term associated with the transaction index.\n+   */\n+  private Function<Long, Long> termGet = null;\n \n   public OzoneManagerDoubleBuffer(OMMetadataManager omMetadataManager,\n       OzoneManagerRatisSnapshot ozoneManagerRatisSnapShot,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMwMDE4NA=="}, "originalCommit": {"oid": "e3c28d2c66bcac8e8db21697de3fc3ae13706dcf"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMjczNDIwOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerDoubleBuffer.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMTozODo1NVrOGO7RKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMDo1MjozN1rOGcGTHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMwNDI5Ng==", "bodyText": "Sorry this comment is not clear. Do you mean sorted Transaction list is not required here?", "url": "https://github.com/apache/ozone/pull/856#discussion_r418304296", "createdAt": "2020-04-30T21:38:55Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerDoubleBuffer.java", "diffHunk": "@@ -173,17 +196,19 @@ private void flushTransactions() {\n                 flushedTransactionsSize);\n           }\n \n-          long lastRatisTransactionIndex =\n-              readyBuffer.stream().map(DoubleBufferEntry::getTrxLogIndex)\n-                  .max(Long::compareTo).get();\n-\n-          List<Long> flushedEpochs =\n-              readyBuffer.stream().map(DoubleBufferEntry::getTrxLogIndex)\n-                  .sorted().collect(Collectors.toList());\n+          // When non-HA do this step here, as the sorted is not require in\n+          // flush to DB. As in non-HA We want to complete futures as quick\n+          // as possible after flush to DB, to release rpc handler threads.\n+          if (!isRatisEnabled) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3c28d2c66bcac8e8db21697de3fc3ae13706dcf"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI2NjU0Ng==", "bodyText": "Yes, at this point in time we don't require the list to be sorted for non-HA, the sorted list is required for cleanupCache only, so delaying this. The reason for this already explained in the comment.", "url": "https://github.com/apache/ozone/pull/856#discussion_r423266546", "createdAt": "2020-05-11T19:25:13Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerDoubleBuffer.java", "diffHunk": "@@ -173,17 +196,19 @@ private void flushTransactions() {\n                 flushedTransactionsSize);\n           }\n \n-          long lastRatisTransactionIndex =\n-              readyBuffer.stream().map(DoubleBufferEntry::getTrxLogIndex)\n-                  .max(Long::compareTo).get();\n-\n-          List<Long> flushedEpochs =\n-              readyBuffer.stream().map(DoubleBufferEntry::getTrxLogIndex)\n-                  .sorted().collect(Collectors.toList());\n+          // When non-HA do this step here, as the sorted is not require in\n+          // flush to DB. As in non-HA We want to complete futures as quick\n+          // as possible after flush to DB, to release rpc handler threads.\n+          if (!isRatisEnabled) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMwNDI5Ng=="}, "originalCommit": {"oid": "e3c28d2c66bcac8e8db21697de3fc3ae13706dcf"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA3MDczMw==", "bodyText": "Time for this sorting should be inconsequential. The readyBuffer would have 10s of transactions at max.\nDo we really need to separate it for HA and non-HA?\nNIT: Can you please fix the typo require -> required and capital W in We.", "url": "https://github.com/apache/ozone/pull/856#discussion_r432070733", "createdAt": "2020-05-28T19:31:07Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerDoubleBuffer.java", "diffHunk": "@@ -173,17 +196,19 @@ private void flushTransactions() {\n                 flushedTransactionsSize);\n           }\n \n-          long lastRatisTransactionIndex =\n-              readyBuffer.stream().map(DoubleBufferEntry::getTrxLogIndex)\n-                  .max(Long::compareTo).get();\n-\n-          List<Long> flushedEpochs =\n-              readyBuffer.stream().map(DoubleBufferEntry::getTrxLogIndex)\n-                  .sorted().collect(Collectors.toList());\n+          // When non-HA do this step here, as the sorted is not require in\n+          // flush to DB. As in non-HA We want to complete futures as quick\n+          // as possible after flush to DB, to release rpc handler threads.\n+          if (!isRatisEnabled) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMwNDI5Ng=="}, "originalCommit": {"oid": "e3c28d2c66bcac8e8db21697de3fc3ae13706dcf"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExNjUxMQ==", "bodyText": "Some time, we see this list grow up to 100-300. And for non-HA, all rpc handlers are blocked on flush futures, intention here is does not want to spend time on unnecessary operations and make the flush futures complete and unblock rpc handlers. (Even if it is some fraction of time)", "url": "https://github.com/apache/ozone/pull/856#discussion_r432116511", "createdAt": "2020-05-28T20:52:37Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerDoubleBuffer.java", "diffHunk": "@@ -173,17 +196,19 @@ private void flushTransactions() {\n                 flushedTransactionsSize);\n           }\n \n-          long lastRatisTransactionIndex =\n-              readyBuffer.stream().map(DoubleBufferEntry::getTrxLogIndex)\n-                  .max(Long::compareTo).get();\n-\n-          List<Long> flushedEpochs =\n-              readyBuffer.stream().map(DoubleBufferEntry::getTrxLogIndex)\n-                  .sorted().collect(Collectors.toList());\n+          // When non-HA do this step here, as the sorted is not require in\n+          // flush to DB. As in non-HA We want to complete futures as quick\n+          // as possible after flush to DB, to release rpc handler threads.\n+          if (!isRatisEnabled) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMwNDI5Ng=="}, "originalCommit": {"oid": "e3c28d2c66bcac8e8db21697de3fc3ae13706dcf"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MTAzMzkzOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerDoubleBuffer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxOTowNjo0MVrOGcCvDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMDo1NzozMVrOGcGc5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA1ODEyNA==", "bodyText": "Checking indexToTerm not null instead of omRatisSnapshot", "url": "https://github.com/apache/ozone/pull/856#discussion_r432058124", "createdAt": "2020-05-28T19:06:41Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerDoubleBuffer.java", "diffHunk": "@@ -121,15 +133,27 @@ public Builder enableTracing(boolean enableTracing) {\n       return this;\n     }\n \n+    public Builder setIndexToTerm(Function<Long, Long> termGet) {\n+      this.indexToTerm = termGet;\n+      return this;\n+    }\n+\n     public OzoneManagerDoubleBuffer build() {\n+      if (isRatisEnabled) {\n+        Preconditions.checkNotNull(indexToTerm, \"When ratis is enabled, \" +\n+                \"OzoneManagerRatisSnapshot should not be null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f3d6cedeaec577b5280baefd1082c489df27dd9"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExOTAxNA==", "bodyText": "Done", "url": "https://github.com/apache/ozone/pull/856#discussion_r432119014", "createdAt": "2020-05-28T20:57:31Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerDoubleBuffer.java", "diffHunk": "@@ -121,15 +133,27 @@ public Builder enableTracing(boolean enableTracing) {\n       return this;\n     }\n \n+    public Builder setIndexToTerm(Function<Long, Long> termGet) {\n+      this.indexToTerm = termGet;\n+      return this;\n+    }\n+\n     public OzoneManagerDoubleBuffer build() {\n+      if (isRatisEnabled) {\n+        Preconditions.checkNotNull(indexToTerm, \"When ratis is enabled, \" +\n+                \"OzoneManagerRatisSnapshot should not be null\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjA1ODEyNA=="}, "originalCommit": {"oid": "5f3d6cedeaec577b5280baefd1082c489df27dd9"}, "originalPosition": 55}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4424, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}