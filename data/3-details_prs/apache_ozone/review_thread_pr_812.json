{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMjM0MjQy", "number": 812, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwODoyNjozM1rODyz--w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMjowMToyMFrOD3KQmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NjA3MDk5OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/client/HddsClientUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwODoyNjozM1rOGHEu0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNzozMzo0MlrOGIfyuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA3MDczOQ==", "bodyText": "Please move this regex to OzoneConsts and please add a simplified example on what characters are not allowed.", "url": "https://github.com/apache/ozone/pull/812#discussion_r410070739", "createdAt": "2020-04-17T08:26:33Z", "author": {"login": "mukul1987"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/client/HddsClientUtils.java", "diffHunk": "@@ -196,6 +196,27 @@ public static void verifyResourceName(String... resourceNames) {\n     }\n   }\n \n+  /**\n+   * verifies that key name is a valid name.\n+   *\n+   * @param keyName key name to be validated\n+   *\n+   * @throws IllegalArgumentException\n+   */\n+  public static void verifyKeyName(String keyName) {\n+    if (keyName == null) {\n+      throw new IllegalArgumentException(\"Key name is null\");\n+    }\n+    String regex = \"^[^^{}<>^?%~#`\\\\[\\\\]\\\\|\\\\\\\\(\\\\x80-\\\\xff)]$\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2149bc56e20ab04aab00b1539f0d9f057f693115"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2MjY4MQ==", "bodyText": "Thanks, I've moved the regex to OzoneConsts and explained it.", "url": "https://github.com/apache/ozone/pull/812#discussion_r411562681", "createdAt": "2020-04-20T17:33:42Z", "author": {"login": "cku328"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/client/HddsClientUtils.java", "diffHunk": "@@ -196,6 +196,27 @@ public static void verifyResourceName(String... resourceNames) {\n     }\n   }\n \n+  /**\n+   * verifies that key name is a valid name.\n+   *\n+   * @param keyName key name to be validated\n+   *\n+   * @throws IllegalArgumentException\n+   */\n+  public static void verifyKeyName(String keyName) {\n+    if (keyName == null) {\n+      throw new IllegalArgumentException(\"Key name is null\");\n+    }\n+    String regex = \"^[^^{}<>^?%~#`\\\\[\\\\]\\\\|\\\\\\\\(\\\\x80-\\\\xff)]$\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA3MDczOQ=="}, "originalCommit": {"oid": "2149bc56e20ab04aab00b1539f0d9f057f693115"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2NzI3MTUyOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/client/HddsClientUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNTo1NzowOFrOGJ-DJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQyMTo1MjoyM1rOGLqiBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzEwNjk4MQ==", "bodyText": "Converting each character to string and checking separately with a regex seems more expensive than either individual character comparison or full-string regex check.", "url": "https://github.com/apache/ozone/pull/812#discussion_r413106981", "createdAt": "2020-04-22T15:57:08Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/client/HddsClientUtils.java", "diffHunk": "@@ -196,6 +196,27 @@ public static void verifyResourceName(String... resourceNames) {\n     }\n   }\n \n+  /**\n+   * verifies that key name is a valid name.\n+   *\n+   * @param keyName key name to be validated\n+   *\n+   * @throws IllegalArgumentException\n+   */\n+  public static void verifyKeyName(String keyName) {\n+    if (keyName == null) {\n+      throw new IllegalArgumentException(\"Key name is null\");\n+    }\n+    for (int index = 0; index < keyName.length(); index++) {\n+      char currChar = keyName.charAt(index);\n+      if (!(Character.toString(currChar)\n+              .matches(OzoneConsts.KEYNAME_AVOID_CHARACTERS_REGEX))){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fba4369308a5f70c6b466b4bf3e9bd720f693a0"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg4NDM1OA==", "bodyText": "Thanks @adoroszlai for the comment.\nChecking each character independently with regular expressions to know exactly which one is not allowed. But I feel the same way, independently check each character is expensive, so I modified it to use full-string to check.", "url": "https://github.com/apache/ozone/pull/812#discussion_r414884358", "createdAt": "2020-04-24T21:52:23Z", "author": {"login": "cku328"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/client/HddsClientUtils.java", "diffHunk": "@@ -196,6 +196,27 @@ public static void verifyResourceName(String... resourceNames) {\n     }\n   }\n \n+  /**\n+   * verifies that key name is a valid name.\n+   *\n+   * @param keyName key name to be validated\n+   *\n+   * @throws IllegalArgumentException\n+   */\n+  public static void verifyKeyName(String keyName) {\n+    if (keyName == null) {\n+      throw new IllegalArgumentException(\"Key name is null\");\n+    }\n+    for (int index = 0; index < keyName.length(); index++) {\n+      char currChar = keyName.charAt(index);\n+      if (!(Character.toString(currChar)\n+              .matches(OzoneConsts.KEYNAME_AVOID_CHARACTERS_REGEX))){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzEwNjk4MQ=="}, "originalCommit": {"oid": "6fba4369308a5f70c6b466b4bf3e9bd720f693a0"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2NzI4ODMyOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNjowMDoyNFrOGJ-NHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQyMTo1MjozNFrOGLqiTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzEwOTUzNQ==", "bodyText": "Constants for regex patterns should be pre-compiled (Pattern.compile(...)).", "url": "https://github.com/apache/ozone/pull/812#discussion_r413109535", "createdAt": "2020-04-22T16:00:24Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "diffHunk": "@@ -328,5 +328,19 @@ private OzoneConsts() {\n   public static final String GDPR_SECRET = \"secret\";\n   public static final String GDPR_ALGORITHM = \"algorithm\";\n \n+  /**\n+   * Block key name as illegal characters\n+   *\n+   * This regular expression is used to check if key name\n+   * contains illegal characters when creating/renaming key.\n+   *\n+   * Avoid the following characters in a key name:\n+   * \"\\\", \"{\", \"}\", \"^\", \"<\", \">\", \"#\", \"|\", \"%\", \"`\", \"[\", \"]\", \"~\", \"?\"\n+   * and Non-printable ASCII characters (128\u2013255 decimal characters).\n+   * https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingMetadata.html\n+   */\n+  public static final String KEYNAME_AVOID_CHARACTERS_REGEX =\n+          \"^[^^{}<>^?%~#`\\\\[\\\\]\\\\|\\\\\\\\(\\\\x80-\\\\xff)]$\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fba4369308a5f70c6b466b4bf3e9bd720f693a0"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg4NDQyOQ==", "bodyText": "Thanks! I fixed it.", "url": "https://github.com/apache/ozone/pull/812#discussion_r414884429", "createdAt": "2020-04-24T21:52:34Z", "author": {"login": "cku328"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "diffHunk": "@@ -328,5 +328,19 @@ private OzoneConsts() {\n   public static final String GDPR_SECRET = \"secret\";\n   public static final String GDPR_ALGORITHM = \"algorithm\";\n \n+  /**\n+   * Block key name as illegal characters\n+   *\n+   * This regular expression is used to check if key name\n+   * contains illegal characters when creating/renaming key.\n+   *\n+   * Avoid the following characters in a key name:\n+   * \"\\\", \"{\", \"}\", \"^\", \"<\", \">\", \"#\", \"|\", \"%\", \"`\", \"[\", \"]\", \"~\", \"?\"\n+   * and Non-printable ASCII characters (128\u2013255 decimal characters).\n+   * https://docs.aws.amazon.com/AmazonS3/latest/dev/UsingMetadata.html\n+   */\n+  public static final String KEYNAME_AVOID_CHARACTERS_REGEX =\n+          \"^[^^{}<>^?%~#`\\\\[\\\\]\\\\|\\\\\\\\(\\\\x80-\\\\xff)]$\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzEwOTUzNQ=="}, "originalCommit": {"oid": "6fba4369308a5f70c6b466b4bf3e9bd720f693a0"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5MTY2MTY5OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/client/HddsClientUtils.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMjowMDo1M1rOGNQiRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNToxMTo1MFrOGNZA3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU1NTU5MQ==", "bodyText": "I would like to propose making this message consistent with the one in OmUtils, so that ozone fs -put and ozone sh key put both print the same error.  I think it can be most simply done by moving the message from OmUtils here and letting the OMException propagate the underlying exception's message.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  throw new IllegalArgumentException(\"key name contains \" +\n          \n          \n            \n                          \"illegal characters.\");\n          \n          \n            \n                  throw new IllegalArgumentException(\"Invalid key name: \" + keyName);\n          \n      \n    \n    \n  \n\nIf you agree, please feel free to wait for others' reviews before making this change, to reduce the number of rounds.", "url": "https://github.com/apache/ozone/pull/812#discussion_r416555591", "createdAt": "2020-04-28T12:00:53Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/client/HddsClientUtils.java", "diffHunk": "@@ -196,6 +196,24 @@ public static void verifyResourceName(String... resourceNames) {\n     }\n   }\n \n+  /**\n+   * verifies that key name is a valid name.\n+   *\n+   * @param keyName key name to be validated\n+   *\n+   * @throws IllegalArgumentException\n+   */\n+  public static void verifyKeyName(String keyName) {\n+    if (keyName == null) {\n+      throw new IllegalArgumentException(\"Key name is null\");\n+    }\n+    if(!OzoneConsts.KEYNAME_ILLEGAL_CHARACTER_CHECK_REGEX\n+            .matcher(keyName).matches()){\n+      throw new IllegalArgumentException(\"key name contains \" +\n+              \"illegal characters.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ffb4d6347836766dff6130e14043ca0de33db32"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY5NDQ5Mg==", "bodyText": "Thanks for the suggestion, I agree with you.\nI'll wait for others' reviews and suggestions before I make this change.", "url": "https://github.com/apache/ozone/pull/812#discussion_r416694492", "createdAt": "2020-04-28T15:11:50Z", "author": {"login": "cku328"}, "path": "hadoop-hdds/client/src/main/java/org/apache/hadoop/hdds/scm/client/HddsClientUtils.java", "diffHunk": "@@ -196,6 +196,24 @@ public static void verifyResourceName(String... resourceNames) {\n     }\n   }\n \n+  /**\n+   * verifies that key name is a valid name.\n+   *\n+   * @param keyName key name to be validated\n+   *\n+   * @throws IllegalArgumentException\n+   */\n+  public static void verifyKeyName(String keyName) {\n+    if (keyName == null) {\n+      throw new IllegalArgumentException(\"Key name is null\");\n+    }\n+    if(!OzoneConsts.KEYNAME_ILLEGAL_CHARACTER_CHECK_REGEX\n+            .matcher(keyName).matches()){\n+      throw new IllegalArgumentException(\"key name contains \" +\n+              \"illegal characters.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU1NTU5MQ=="}, "originalCommit": {"oid": "9ffb4d6347836766dff6130e14043ca0de33db32"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5MTY2MzYzOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/OmUtils.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMjowMToyMFrOGNQjVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMjowMToyMFrOGNQjVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU1NTg2MQ==", "bodyText": "Corresponding to the suggestion for HddsClientUtils:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  throw new OMException(\"Invalid key name: \" + keyName,\n          \n          \n            \n                  throw new OMException(e.getMessage(),", "url": "https://github.com/apache/ozone/pull/812#discussion_r416555861", "createdAt": "2020-04-28T12:01:20Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/OmUtils.java", "diffHunk": "@@ -506,4 +506,17 @@ public static long getOMClientRpcTimeOut(Configuration configuration) {\n     return OzoneConfiguration.of(configuration)\n         .getObject(OMClientConfig.class).getRpcTimeOut();\n   }\n+\n+  /**\n+   * Verify key name is a valid name.\n+   */\n+  public static void validateKeyName(String keyName)\n+          throws OMException {\n+    try {\n+      HddsClientUtils.verifyKeyName(keyName);\n+    } catch (IllegalArgumentException e) {\n+      throw new OMException(\"Invalid key name: \" + keyName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ffb4d6347836766dff6130e14043ca0de33db32"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4383, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}