{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5NDc1MjYw", "number": 938, "title": "HDDS-3608. NPE while process a pipeline report when PipelineQuery absent in query2OpenPipelines", "bodyText": "What changes were proposed in this pull request?\nFix a NPE while SCM receive and handle a datanode pipeline report, PipelineStateMap will get the pipelineList from query2OpenPipelines, and put the updatedPipeline to the list, but if the list is NULL, NPE will occur.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3608\nHow was this patch tested?\nNo need", "createdAt": "2020-05-18T12:40:48Z", "url": "https://github.com/apache/ozone/pull/938", "merged": true, "mergeCommit": {"oid": "4b2dc09b68b4f7d1bb2e35147dee98bffa0c48e8"}, "closed": true, "closedAt": "2020-05-29T05:22:41Z", "author": {"login": "maobaolong"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABciqqvKAH2gAyNDE5NDc1MjYwOmMxNjNhMTE0MGRiZTAwZjUxYmVhM2ViYTNjNDQ2ZDZkZjY4NjRjYjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclqjkygFqTQxOTkzOTg0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c163a1140dbe00f51bea3eba3c446d6df6864cb1", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/c163a1140dbe00f51bea3eba3c446d6df6864cb1", "committedDate": "2020-05-19T02:02:12Z", "message": "HDDS-3608. NPE while process a pipeline report when PipelineQuery absent in query2OpenPipelines"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4ba981e1822c8ff08c699d2f3de958049062cbc5", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/4ba981e1822c8ff08c699d2f3de958049062cbc5", "committedDate": "2020-05-18T12:35:03Z", "message": "HDDS-3608. NPE while process a pipeline report when PipelineQuery absent in query2OpenPipelines"}, "afterCommit": {"oid": "c163a1140dbe00f51bea3eba3c446d6df6864cb1", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/c163a1140dbe00f51bea3eba3c446d6df6864cb1", "committedDate": "2020-05-19T02:02:12Z", "message": "HDDS-3608. NPE while process a pipeline report when PipelineQuery absent in query2OpenPipelines"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NDY0OTg0", "url": "https://github.com/apache/ozone/pull/938#pullrequestreview-414464984", "createdAt": "2020-05-19T13:49:45Z", "commit": {"oid": "c163a1140dbe00f51bea3eba3c446d6df6864cb1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxMzo0OTo0NVrOGXhX1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxMzo0OTo0NVrOGXhX1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzMxNzIwNQ==", "bodyText": "Besides above change, Can you also do the empty check for another condition branch?\n} else {\n// for transition from OPEN to CLOSED state remove pipeline from\n// query2OpenPipelines\nquery2OpenPipelines.get(query).remove(pipeline);   <---\n}\nThere is also a chance that remove operation can throw NPE.", "url": "https://github.com/apache/ozone/pull/938#discussion_r427317205", "createdAt": "2020-05-19T13:49:45Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineStateMap.java", "diffHunk": "@@ -374,7 +374,12 @@ Pipeline updatePipelineState(PipelineID pipelineID, PipelineState state)\n     PipelineQuery query = new PipelineQuery(pipeline);\n     if (updatedPipeline.getPipelineState() == PipelineState.OPEN) {\n       // for transition to OPEN state add pipeline to query2OpenPipelines\n-      query2OpenPipelines.get(query).add(updatedPipeline);\n+      List<Pipeline> pipelineList = query2OpenPipelines.get(query);\n+      if (pipelineList == null) {\n+        pipelineList = new CopyOnWriteArrayList<>();\n+        query2OpenPipelines.put(query, pipelineList);\n+      }\n+      pipelineList.add(updatedPipeline);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c163a1140dbe00f51bea3eba3c446d6df6864cb1"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6aeffde486bb354e5afe167bff8e63eae9fa113f", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/6aeffde486bb354e5afe167bff8e63eae9fa113f", "committedDate": "2020-05-19T23:32:16Z", "message": "HDDS-3608. Address comments, fix another condition branch NPE."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0OTUwMTA2", "url": "https://github.com/apache/ozone/pull/938#pullrequestreview-414950106", "createdAt": "2020-05-20T02:28:03Z", "commit": {"oid": "6aeffde486bb354e5afe167bff8e63eae9fa113f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NTUwNjEw", "url": "https://github.com/apache/ozone/pull/938#pullrequestreview-416550610", "createdAt": "2020-05-21T23:07:17Z", "commit": {"oid": "6aeffde486bb354e5afe167bff8e63eae9fa113f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMzowNzoxN1rOGZFvmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMzowNzoxN1rOGZFvmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODk2MTY5MA==", "bodyText": "query2OpenPipelines has been initialized in initializeQueryMap() based on the RepType/ReFactor and has never been removed from the map. Correct me if I'm wrong, the pipelineList should never be null unless different RepType/Factor are specified in the query, which is currently impossible.", "url": "https://github.com/apache/ozone/pull/938#discussion_r428961690", "createdAt": "2020-05-21T23:07:17Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineStateMap.java", "diffHunk": "@@ -372,13 +372,20 @@ Pipeline updatePipelineState(PipelineID pipelineID, PipelineState state)\n     Pipeline updatedPipeline = pipelineMap.compute(pipelineID,\n         (id, p) -> Pipeline.newBuilder(pipeline).setState(state).build());\n     PipelineQuery query = new PipelineQuery(pipeline);\n+    List<Pipeline> pipelineList = query2OpenPipelines.get(query);\n     if (updatedPipeline.getPipelineState() == PipelineState.OPEN) {\n       // for transition to OPEN state add pipeline to query2OpenPipelines\n-      query2OpenPipelines.get(query).add(updatedPipeline);\n+      if (pipelineList == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6aeffde486bb354e5afe167bff8e63eae9fa113f"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NTUwNzgw", "url": "https://github.com/apache/ozone/pull/938#pullrequestreview-416550780", "createdAt": "2020-05-21T23:07:46Z", "commit": {"oid": "6aeffde486bb354e5afe167bff8e63eae9fa113f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5OTM5ODQ2", "url": "https://github.com/apache/ozone/pull/938#pullrequestreview-419939846", "createdAt": "2020-05-28T09:36:09Z", "commit": {"oid": "6aeffde486bb354e5afe167bff8e63eae9fa113f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3272, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}