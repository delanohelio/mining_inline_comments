{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2NTUwNTc0", "number": 1257, "title": "HDDS-3970. Enabling TestStorageContainerManager with all failures add\u2026", "bodyText": "What changes were proposed in this pull request?\nContainerStateManager: Addressing test failures\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3970\nHow was this patch tested?\nTesting TestStorageContainerManager several times in a row for failures.", "createdAt": "2020-07-25T02:02:26Z", "url": "https://github.com/apache/ozone/pull/1257", "merged": true, "mergeCommit": {"oid": "9f46fb8f01d0d4585ba6f7b1372f2735189c9767"}, "closed": true, "closedAt": "2020-07-30T08:05:26Z", "author": {"login": "prashantpogde"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc4Oxu5AH2gAyNDU2NTUwNTc0OmExZTc1OThkMzg1N2M0MDk4ODA3ZTUyMzE2NTk1OGVkZWIyMzIxNjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5tG15AFqTQ1NzY2MDM5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a1e7598d3857c4098807e523165958edeb232169", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/a1e7598d3857c4098807e523165958edeb232169", "committedDate": "2020-07-25T01:58:50Z", "message": "HDDS-3970. Enabling TestStorageContainerManager with all failures addressed."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NTc1NDQz", "url": "https://github.com/apache/ozone/pull/1257#pullrequestreview-455575443", "createdAt": "2020-07-27T08:26:34Z", "commit": {"oid": "a1e7598d3857c4098807e523165958edeb232169"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwODoyNjozNFrOG3Yhbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwODozOToxOFrOG3Y_Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcyNjYzOQ==", "bodyText": "Sleep lengths in testCloseContainerCommandOnRestart are being increased.  Why do we need to increase timeout on another test method?", "url": "https://github.com/apache/ozone/pull/1257#discussion_r460726639", "createdAt": "2020-07-27T08:26:34Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java", "diffHunk": "@@ -525,7 +523,7 @@ public void testScmInfo() throws Exception {\n   /**\n    * Test datanode heartbeat well processed with a 4-layer network topology.\n    */\n-  @Test(timeout = 60000)\n+  @Test(timeout = 180000)\n   public void testScmProcessDatanodeHeartbeat() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1e7598d3857c4098807e523165958edeb232169"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcyODI0MA==", "bodyText": "Repeated check (eg. GenericTestUtils.waitFor) should be preferred over fixed length sleep:\n\nallow quicker test execution if possible\nexplicit condition documents what the test is waiting for", "url": "https://github.com/apache/ozone/pull/1257#discussion_r460728240", "createdAt": "2020-07-27T08:29:15Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java", "diffHunk": "@@ -593,7 +591,7 @@ public void testCloseContainerCommandOnRestart() throws Exception {\n           new TestStorageContainerManagerHelper(cluster, conf);\n \n       helper.createKeys(10, 4096);\n-      Thread.sleep(5000);\n+      Thread.sleep(10000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1e7598d3857c4098807e523165958edeb232169"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcyODg4MQ==", "bodyText": "Why not LOG.info(?", "url": "https://github.com/apache/ozone/pull/1257#discussion_r460728881", "createdAt": "2020-07-27T08:30:17Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java", "diffHunk": "@@ -604,8 +602,13 @@ public void testCloseContainerCommandOnRestart() throws Exception {\n       // Stop processing HB\n       scm.getDatanodeProtocolServer().stop();\n \n-      scm.getContainerManager().updateContainerState(selectedContainer\n-          .containerID(), HddsProtos.LifeCycleEvent.FINALIZE);\n+      LoggerFactory.getLogger(TestStorageContainerManager.class).info(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1e7598d3857c4098807e523165958edeb232169"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDczMTYyNg==", "bodyText": "Please use placeholder in log message instead of + to avoid new code warning (sonar).", "url": "https://github.com/apache/ozone/pull/1257#discussion_r460731626", "createdAt": "2020-07-27T08:34:55Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java", "diffHunk": "@@ -604,8 +602,13 @@ public void testCloseContainerCommandOnRestart() throws Exception {\n       // Stop processing HB\n       scm.getDatanodeProtocolServer().stop();\n \n-      scm.getContainerManager().updateContainerState(selectedContainer\n-          .containerID(), HddsProtos.LifeCycleEvent.FINALIZE);\n+      LoggerFactory.getLogger(TestStorageContainerManager.class).info(\n+          \"Current Container State is\" + selectedContainer.getState());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1e7598d3857c4098807e523165958edeb232169"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDczNDIyNw==", "bodyText": "Do you know what other thread changed container state to CLOSING?  Don't we still have a race condition here: in the time window between getState and updateContainerState that other thread could still change state of the container?", "url": "https://github.com/apache/ozone/pull/1257#discussion_r460734227", "createdAt": "2020-07-27T08:39:18Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/TestStorageContainerManager.java", "diffHunk": "@@ -604,8 +602,13 @@ public void testCloseContainerCommandOnRestart() throws Exception {\n       // Stop processing HB\n       scm.getDatanodeProtocolServer().stop();\n \n-      scm.getContainerManager().updateContainerState(selectedContainer\n-          .containerID(), HddsProtos.LifeCycleEvent.FINALIZE);\n+      LoggerFactory.getLogger(TestStorageContainerManager.class).info(\n+          \"Current Container State is\" + selectedContainer.getState());\n+      if (selectedContainer.getState() == HddsProtos.LifeCycleState.OPEN) {\n+        scm.getContainerManager().updateContainerState(selectedContainer\n+            .containerID(), HddsProtos.LifeCycleEvent.FINALIZE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1e7598d3857c4098807e523165958edeb232169"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "141c89e3ff8af93c246aeed1ed2dd82fce499e32", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/141c89e3ff8af93c246aeed1ed2dd82fce499e32", "committedDate": "2020-07-28T07:51:49Z", "message": "HDDS-3970. Changes after addressing code review comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "938db9c601cc62c69efcacc564a7e39c5d01ffbb", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/938db9c601cc62c69efcacc564a7e39c5d01ffbb", "committedDate": "2020-07-28T21:35:44Z", "message": "HDDS-3970. Part3 : Changes after addressing code review comments."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "42471db9aebf9b6aa4172802b60c7694eb91fb01", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/42471db9aebf9b6aa4172802b60c7694eb91fb01", "committedDate": "2020-07-28T12:23:22Z", "message": "trigger new CI check"}, "afterCommit": {"oid": "938db9c601cc62c69efcacc564a7e39c5d01ffbb", "author": {"user": {"login": "prashantpogde", "name": null}}, "url": "https://github.com/apache/ozone/commit/938db9c601cc62c69efcacc564a7e39c5d01ffbb", "committedDate": "2020-07-28T21:35:44Z", "message": "HDDS-3970. Part3 : Changes after addressing code review comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f3dea0f716024c2368ea0c1bb3ef49a97c27ca1", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/6f3dea0f716024c2368ea0c1bb3ef49a97c27ca1", "committedDate": "2020-07-29T13:07:48Z", "message": "trigger new CI check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NjYwMzk0", "url": "https://github.com/apache/ozone/pull/1257#pullrequestreview-457660394", "createdAt": "2020-07-29T15:52:58Z", "commit": {"oid": "938db9c601cc62c69efcacc564a7e39c5d01ffbb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2927, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}