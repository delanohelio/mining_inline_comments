{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyNTM0MjU3", "number": 625, "title": "HDDS-2980. Delete replayed entry from OpenKeyTable during commit", "bodyText": "What changes were proposed in this pull request?\nDuring KeyCreate (and S3InitiateMultipartUpload), we do not check the OpenKeyTable if the key already exists. If it does exist and the transaction is replayed, we just override the key in OpenKeyTable. This is done to avoid extra DB reads.\nDuring KeyCommit (or S3MultipartUploadCommit), if the key was already committed, then we do not replay the transaction. This would result in the OpenKeyTable entry to remain in the DB till it is garbage collected.\nTo avoid storing stale entries in OpenKeyTable, during commit replays, we should check the openKeyTable and delete the entry if it exists.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-2980\nHow was this patch tested?\nAdded unit test.", "createdAt": "2020-03-02T18:17:12Z", "url": "https://github.com/apache/ozone/pull/625", "merged": true, "mergeCommit": {"oid": "79ce00e5c7e2599abadddfca22790a5544349733"}, "closed": true, "closedAt": "2020-03-30T17:30:24Z", "author": {"login": "hanishakoneru"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNEpNoABqjMxMjQ5MzUyODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcSKXZ4AFqTM4MzM0MTUxNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7a91ea3a13821599cbad3816057f7e2aff1db026", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/7a91ea3a13821599cbad3816057f7e2aff1db026", "committedDate": "2020-03-02T18:14:36Z", "message": "build failure fix"}, "afterCommit": {"oid": "7298d3455d0097cdb5908aaab13971f0d5080ff4", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/7298d3455d0097cdb5908aaab13971f0d5080ff4", "committedDate": "2020-03-12T23:51:22Z", "message": "Unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MTA0MzM0", "url": "https://github.com/apache/ozone/pull/625#pullrequestreview-379104334", "createdAt": "2020-03-23T02:48:36Z", "commit": {"oid": "fb7b28918c441e478629a147477b5086b2337e0d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwMjo0ODozNlrOF51fpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwMjo0ODozNlrOF51fpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjE4OTYwNA==", "bodyText": "We can still pass here  clientID and generate openKey. Like how we used to generate open key before.", "url": "https://github.com/apache/ozone/pull/625#discussion_r396189604", "createdAt": "2020-03-23T02:48:36Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCommitRequest.java", "diffHunk": "@@ -183,21 +196,26 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           new CacheKey<>(dbOzoneKey),\n           new CacheValue<>(Optional.of(omKeyInfo), trxnLogIndex));\n \n-      omResponse.setCommitKeyResponse(CommitKeyResponse.newBuilder().build());\n       omClientResponse = new OMKeyCommitResponse(omResponse.build(),\n-          omKeyInfo, commitKeyRequest.getClientID());\n+          omKeyInfo, dbOpenKey);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb7b28918c441e478629a147477b5086b2337e0d"}, "originalPosition": 82}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec0b06c73162f5cdf04397d25f7eb177108c9174", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/ec0b06c73162f5cdf04397d25f7eb177108c9174", "committedDate": "2020-03-23T16:56:45Z", "message": "HDDS-2980. Delete replayed entry from OpenKeyTable during commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f718dd39eb89eef25b2ab0ae39e2916c3919548", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/7f718dd39eb89eef25b2ab0ae39e2916c3919548", "committedDate": "2020-03-23T16:56:46Z", "message": "Unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8926e150bf969f8390c943e4fe1f256e057be196", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/8926e150bf969f8390c943e4fe1f256e057be196", "committedDate": "2020-03-23T16:56:46Z", "message": "unit test fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26d8fe9bb45bdd14f0ab7bc69c57b20c3c7851c7", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/26d8fe9bb45bdd14f0ab7bc69c57b20c3c7851c7", "committedDate": "2020-03-23T16:56:46Z", "message": "checkstyle fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3947e0a1fa3543f10804a27e35699d14b0af05ee", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/3947e0a1fa3543f10804a27e35699d14b0af05ee", "committedDate": "2020-03-23T16:56:46Z", "message": "review comment - Pass ozoneKeyName to OMKeyCommitResponse"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb7b28918c441e478629a147477b5086b2337e0d", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/fb7b28918c441e478629a147477b5086b2337e0d", "committedDate": "2020-03-13T21:08:27Z", "message": "checkstyle fix"}, "afterCommit": {"oid": "3947e0a1fa3543f10804a27e35699d14b0af05ee", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/3947e0a1fa3543f10804a27e35699d14b0af05ee", "committedDate": "2020-03-23T16:56:46Z", "message": "review comment - Pass ozoneKeyName to OMKeyCommitResponse"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNTExNzQ4", "url": "https://github.com/apache/ozone/pull/625#pullrequestreview-382511748", "createdAt": "2020-03-27T00:38:24Z", "commit": {"oid": "3947e0a1fa3543f10804a27e35699d14b0af05ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMDozODoyNFrOF8fV_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwMDozODoyNFrOF8fV_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk3MjQxNA==", "bodyText": "Not understood why this check is removed.", "url": "https://github.com/apache/ozone/pull/625#discussion_r398972414", "createdAt": "2020-03-27T00:38:24Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/s3/multipart/S3MultipartUploadCommitPartRequest.java", "diffHunk": "@@ -147,11 +146,6 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n         throw new OMException(\"Failed to commit Multipart Upload key, as \" +\n             openKey + \"entry is not found in the openKey table\",\n             KEY_NOT_FOUND);\n-      } else {\n-        // Check the OpenKeyTable if this transaction is a replay of ratis logs.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3947e0a1fa3543f10804a27e35699d14b0af05ee"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMzQxNTE0", "url": "https://github.com/apache/ozone/pull/625#pullrequestreview-383341514", "createdAt": "2020-03-28T19:21:20Z", "commit": {"oid": "3947e0a1fa3543f10804a27e35699d14b0af05ee"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3669, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}