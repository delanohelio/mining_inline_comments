{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzNjU3NjY1", "number": 449, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNjowMjozNFrODbdfew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNjoxMToyNlrODbdj7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTIxMzM5OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNjowMjozNFrOFi9b0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMDowNjoxNFrOFksDiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwMjQ0OQ==", "bodyText": "Right now, we have only AWSV4Header authentication only right, so we need the header check.\nOr is there any reason for removal of this check", "url": "https://github.com/apache/ozone/pull/449#discussion_r372202449", "createdAt": "2020-01-29T06:02:34Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java", "diffHunk": "@@ -75,36 +70,31 @@ private OzoneClient getClient(OzoneConfiguration config) throws IOException {\n     try {\n       if (OzoneSecurityUtil.isSecurityEnabled(config)) {\n         LOG.debug(\"Creating s3 auth info for client.\");\n-        if (context.getHeaderString(AUTHORIZATION_HEADER).startsWith(\"AWS4\")) {\n-          try {\n-            AWSV4AuthParser v4RequestParser = new AWSV4AuthParser(context);\n-            v4RequestParser.parse();\n-\n-            OzoneTokenIdentifier identifier = new OzoneTokenIdentifier();\n-            identifier.setTokenType(S3AUTHINFO);\n-            identifier.setStrToSign(v4RequestParser.getStringToSign());\n-            identifier.setSignature(v4RequestParser.getSignature());\n-            identifier.setAwsAccessId(v4RequestParser.getAwsAccessId());\n-            identifier.setOwner(new Text(v4RequestParser.getAwsAccessId()));\n-            if (LOG.isTraceEnabled()) {\n-              LOG.trace(\"Adding token for service:{}\", omService);\n-            }\n-            Token<OzoneTokenIdentifier> token = new Token(identifier.getBytes(),\n-                identifier.getSignature().getBytes(UTF_8),\n-                identifier.getKind(),\n-                omService);\n-            UserGroupInformation remoteUser =\n-                UserGroupInformation.createRemoteUser(\n-                    v4RequestParser.getAwsAccessId());\n-            remoteUser.addToken(token);\n-            UserGroupInformation.setLoginUser(remoteUser);\n-          } catch (OS3Exception | URISyntaxException ex) {\n-            LOG.error(\"S3 auth info creation failed.\");\n-            throw S3_AUTHINFO_CREATION_ERROR;\n+        try {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "258b06c177a48e9ebc641a031ae1ff0cadf73a3a"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAxNDg1Ng==", "bodyText": "The idea was to avoid code duplication. Instead of using AWSV4AuthParser we use the common SignatureProcessor.\nThis particular check is included in the AWS3SignatureProcessor->authorizationHeader->validateAlgorithm() which will throw an exception if it's anything else than AWS4.", "url": "https://github.com/apache/ozone/pull/449#discussion_r374014856", "createdAt": "2020-02-03T10:06:14Z", "author": {"login": "elek"}, "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java", "diffHunk": "@@ -75,36 +70,31 @@ private OzoneClient getClient(OzoneConfiguration config) throws IOException {\n     try {\n       if (OzoneSecurityUtil.isSecurityEnabled(config)) {\n         LOG.debug(\"Creating s3 auth info for client.\");\n-        if (context.getHeaderString(AUTHORIZATION_HEADER).startsWith(\"AWS4\")) {\n-          try {\n-            AWSV4AuthParser v4RequestParser = new AWSV4AuthParser(context);\n-            v4RequestParser.parse();\n-\n-            OzoneTokenIdentifier identifier = new OzoneTokenIdentifier();\n-            identifier.setTokenType(S3AUTHINFO);\n-            identifier.setStrToSign(v4RequestParser.getStringToSign());\n-            identifier.setSignature(v4RequestParser.getSignature());\n-            identifier.setAwsAccessId(v4RequestParser.getAwsAccessId());\n-            identifier.setOwner(new Text(v4RequestParser.getAwsAccessId()));\n-            if (LOG.isTraceEnabled()) {\n-              LOG.trace(\"Adding token for service:{}\", omService);\n-            }\n-            Token<OzoneTokenIdentifier> token = new Token(identifier.getBytes(),\n-                identifier.getSignature().getBytes(UTF_8),\n-                identifier.getKind(),\n-                omService);\n-            UserGroupInformation remoteUser =\n-                UserGroupInformation.createRemoteUser(\n-                    v4RequestParser.getAwsAccessId());\n-            remoteUser.addToken(token);\n-            UserGroupInformation.setLoginUser(remoteUser);\n-          } catch (OS3Exception | URISyntaxException ex) {\n-            LOG.error(\"S3 auth info creation failed.\");\n-            throw S3_AUTHINFO_CREATION_ERROR;\n+        try {\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwMjQ0OQ=="}, "originalCommit": {"oid": "258b06c177a48e9ebc641a031ae1ff0cadf73a3a"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTIxNjQ0OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/util/OzoneS3Util.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNjowNTowOVrOFi9dyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxODowMjozNlrOFoTUMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwMjk1NA==", "bodyText": "Can we rename this getVolumeName, as it is converting to md5Hex, and we use that as volume name.", "url": "https://github.com/apache/ozone/pull/449#discussion_r372202954", "createdAt": "2020-01-29T06:05:09Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/util/OzoneS3Util.java", "diffHunk": "@@ -38,9 +38,9 @@\n   private OzoneS3Util() {\n   }\n \n-  public static String getVolumeName(String userName) {\n+  public static String getS3Username(String userName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "258b06c177a48e9ebc641a031ae1ff0cadf73a3a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAxODcwMg==", "bodyText": "I am not sure what is the right name, I renamed after a long debug session when I was totally confused what is in a variable.\nThis method doesn't return with a volumeName it returns with and unique (and safe) identifier of the s3 user. It will be converted to an s3 volume name on the server side (\"s3\" + this unique id).\nThis string is used as a parameter of the createS3Bucket(String userName, String bucketName) which clearly shows that this is not a volumeName. This is a unique ID / username.\nDuring the debug I was very confused as I expected to have the final volumeName from this method, but didn't get it.\nBut please let me know if you have any better suggestion for the name.", "url": "https://github.com/apache/ozone/pull/449#discussion_r374018702", "createdAt": "2020-02-03T10:14:28Z", "author": {"login": "elek"}, "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/util/OzoneS3Util.java", "diffHunk": "@@ -38,9 +38,9 @@\n   private OzoneS3Util() {\n   }\n \n-  public static String getVolumeName(String userName) {\n+  public static String getS3Username(String userName) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwMjk1NA=="}, "originalCommit": {"oid": "258b06c177a48e9ebc641a031ae1ff0cadf73a3a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwMzgyNw==", "bodyText": "Agreed. I am fine with current way.", "url": "https://github.com/apache/ozone/pull/449#discussion_r377803827", "createdAt": "2020-02-11T18:02:36Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/util/OzoneS3Util.java", "diffHunk": "@@ -38,9 +38,9 @@\n   private OzoneS3Util() {\n   }\n \n-  public static String getVolumeName(String userName) {\n+  public static String getS3Username(String userName) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwMjk1NA=="}, "originalCommit": {"oid": "258b06c177a48e9ebc641a031ae1ff0cadf73a3a"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTIyNDc3OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/RootPageDisplayFilter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNjoxMToyNlrOFi9isA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMDowODo1NVrOFksIqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwNDIwOA==", "bodyText": "What does else part do, for other HTTP method requests?\nOr we should fail the request as it is not a valid request.\nOr I am not sure if my understanding is not correct, could you provide some info here.", "url": "https://github.com/apache/ozone/pull/449#discussion_r372204208", "createdAt": "2020-01-29T06:11:26Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/RootPageDisplayFilter.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.s3;\n+\n+import javax.servlet.Filter;\n+import javax.servlet.FilterChain;\n+import javax.servlet.FilterConfig;\n+import javax.servlet.ServletException;\n+import javax.servlet.ServletRequest;\n+import javax.servlet.ServletResponse;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+\n+/**\n+ * This redirect helps to show and info page in case the endpoint is opened\n+ * from the browser.\n+ */\n+public class RootPageDisplayFilter implements Filter {\n+\n+  @Override\n+  public void init(FilterConfig filterConfig) throws ServletException {\n+\n+  }\n+\n+  @Override\n+  public void doFilter(ServletRequest servletRequest,\n+      ServletResponse servletResponse, FilterChain filterChain)\n+      throws IOException, ServletException {\n+    HttpServletRequest httpRequest = (HttpServletRequest) servletRequest;\n+    String httpMethod = httpRequest.getMethod();\n+    String uri = httpRequest.getRequestURI();\n+    String authorizationHeader = httpRequest.getHeader(\"Authorization\");\n+    if (httpMethod.equalsIgnoreCase(\"GET\") && authorizationHeader == null && uri\n+        .equals(\"/\")) {\n+      ((HttpServletResponse) servletResponse).sendRedirect(\"/static/\");\n+    } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "258b06c177a48e9ebc641a031ae1ff0cadf73a3a"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAxNjE3MA==", "bodyText": "filterChain.doFilter (else branch) means: \"do all the other stuff defined by other filters/servlets/jaxrs classes.\nThis condition has a short-circuit response for the \"GET /\" page (without Authorization header). In this case it immediately redirect to the internal documentation page.\nFor any other case it does the normal work. (else)", "url": "https://github.com/apache/ozone/pull/449#discussion_r374016170", "createdAt": "2020-02-03T10:08:55Z", "author": {"login": "elek"}, "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/RootPageDisplayFilter.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.s3;\n+\n+import javax.servlet.Filter;\n+import javax.servlet.FilterChain;\n+import javax.servlet.FilterConfig;\n+import javax.servlet.ServletException;\n+import javax.servlet.ServletRequest;\n+import javax.servlet.ServletResponse;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+\n+/**\n+ * This redirect helps to show and info page in case the endpoint is opened\n+ * from the browser.\n+ */\n+public class RootPageDisplayFilter implements Filter {\n+\n+  @Override\n+  public void init(FilterConfig filterConfig) throws ServletException {\n+\n+  }\n+\n+  @Override\n+  public void doFilter(ServletRequest servletRequest,\n+      ServletResponse servletResponse, FilterChain filterChain)\n+      throws IOException, ServletException {\n+    HttpServletRequest httpRequest = (HttpServletRequest) servletRequest;\n+    String httpMethod = httpRequest.getMethod();\n+    String uri = httpRequest.getRequestURI();\n+    String authorizationHeader = httpRequest.getHeader(\"Authorization\");\n+    if (httpMethod.equalsIgnoreCase(\"GET\") && authorizationHeader == null && uri\n+        .equals(\"/\")) {\n+      ((HttpServletResponse) servletResponse).sendRedirect(\"/static/\");\n+    } else {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwNDIwOA=="}, "originalCommit": {"oid": "258b06c177a48e9ebc641a031ae1ff0cadf73a3a"}, "originalPosition": 52}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 126, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}