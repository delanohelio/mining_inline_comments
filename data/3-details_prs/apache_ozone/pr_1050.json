{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyNDY2OTUx", "number": 1050, "title": "HDDS-3757. Add test coverage of the acceptance tests to overall test coverage ", "bodyText": "What changes were proposed in this pull request?\nThis patch adds the coverage data from the acceptance test to the generic coverage measurement.\nThere was one question during the implementation: I decided to add the required HADOOP_OPTS to all the docker-compose file without using tricky docker-compose extension. I found that I need to add a few lines anyway, and I preferred to keep it simple, even if a possible change would require slightly more work (but can be done with easy search and replace)\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3757\nHow was this patch tested?\nPushed the branch to apache repo and checked sonar cloud.\nhttps://sonarcloud.io/dashboard?branch=HDDS-3757&id=hadoop-ozone", "createdAt": "2020-06-10T13:44:13Z", "url": "https://github.com/apache/ozone/pull/1050", "merged": true, "mergeCommit": {"oid": "0f2a11827db011eb9902adcf867cbe8f6af5116c"}, "closed": true, "closedAt": "2020-06-27T07:53:51Z", "author": {"login": "elek"}, "timelineItems": {"totalCount": 44, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcp9if2AFqTQyODMwMDc3OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvI4y-AFqTQzODU2MTg4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MzAwNzc5", "url": "https://github.com/apache/ozone/pull/1050#pullrequestreview-428300779", "createdAt": "2020-06-10T17:58:52Z", "commit": {"oid": "20ae3ed05b2b29ff8bb831b9a7cc28c974fa92fc"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NjUyNDQz", "url": "https://github.com/apache/ozone/pull/1050#pullrequestreview-428652443", "createdAt": "2020-06-11T07:19:44Z", "commit": {"oid": "20ae3ed05b2b29ff8bb831b9a7cc28c974fa92fc"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNzoxOTo0NFrOGiRa5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQwNzoyNDowNVrOGiRi1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU5MDE4MQ==", "bodyText": "Now acceptance.sh requires jacoco-agent.jar, which is only built when invoked with -Pjacoco.  I would like to suggest moving this definition to the GitHub Actions definition (in the env section, where KEEP_IMAGE is defined, too).", "url": "https://github.com/apache/ozone/pull/1050#discussion_r438590181", "createdAt": "2020-06-11T07:19:44Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/dev-support/checks/acceptance.sh", "diffHunk": "@@ -17,19 +17,32 @@ DIR=\"$( cd \"$( dirname \"${BASH_SOURCE[0]}\" )\" >/dev/null 2>&1 && pwd )\"\n cd \"$DIR/../../..\" || exit 1\n \n REPORT_DIR=${OUTPUT_DIR:-\"$DIR/../../../target/acceptance\"}\n-mkdir -p \"$REPORT_DIR\"\n \n OZONE_VERSION=$(grep \"<ozone.version>\" \"pom.xml\" | sed 's/<[^>]*>//g'|  sed 's/^[ \\t]*//')\n DIST_DIR=\"$DIR/../../dist/target/ozone-$OZONE_VERSION\"\n \n if [ ! -d \"$DIST_DIR\" ]; then\n     echo \"Distribution dir is missing. Doing a full build\"\n-    \"$DIR/build.sh\"\n+    \"$DIR/build.sh\" -Pjacoco\n fi\n \n+mkdir -p \"$REPORT_DIR\"\n+\n+export HADOOP_OPTS='-javaagent:/opt/hadoop/share/jacoco/jacoco-agent.jar=destfile=/tmp/jacoco.exec,includes=org.apache.hadoop.ozone.*:org.apache.hadoop.hdds'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20ae3ed05b2b29ff8bb831b9a7cc28c974fa92fc"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU5MjIxNA==", "bodyText": "I think we can avoid these by passing the variable via -e option of docker-compose, similar to how it is done for some other variables (SECURITY_ENABLED, etc.):\nhttps://github.com/apache/hadoop-ozone/blob/53395a0ed75d96575a7dc26a7adec4eefabb2b74/hadoop-ozone/dist/src/main/compose/testlib.sh#L107", "url": "https://github.com/apache/ozone/pull/1050#discussion_r438592214", "createdAt": "2020-06-11T07:24:05Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/dist/src/main/compose/ozone-csi/docker-compose.yaml", "diffHunk": "@@ -23,6 +23,8 @@ services:\n       - ../..:/opt/hadoop\n     env_file:\n       - docker-config\n+    environment:\n+      HADOOP_OPTS: ${HADOOP_OPTS}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20ae3ed05b2b29ff8bb831b9a7cc28c974fa92fc"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97213e350f00152236a1c8609dd86aee3d696c87", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/97213e350f00152236a1c8609dd86aee3d696c87", "committedDate": "2020-06-15T15:39:49Z", "message": "HDDS-3757. Add test coverage of the acceptance tests to overall test coverage"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "569cabb78a5c37ae21edb35eb8debe84a02a0995", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/569cabb78a5c37ae21edb35eb8debe84a02a0995", "committedDate": "2020-06-15T13:41:54Z", "message": "add skip.npx"}, "afterCommit": {"oid": "97213e350f00152236a1c8609dd86aee3d696c87", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/97213e350f00152236a1c8609dd86aee3d696c87", "committedDate": "2020-06-15T15:39:49Z", "message": "HDDS-3757. Add test coverage of the acceptance tests to overall test coverage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d266ab46939d4a0213b59747b20f5fc292525b4", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/1d266ab46939d4a0213b59747b20f5fc292525b4", "committedDate": "2020-06-16T16:58:25Z", "message": "fix thread problem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ddef62c11d916ae6eaf3b3befc4b9829f28e0fa", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/2ddef62c11d916ae6eaf3b3befc4b9829f28e0fa", "committedDate": "2020-06-16T19:56:20Z", "message": "checkstyle fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28d9cdf2e0e73598a9c6997c501f0e12255bc3db", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/28d9cdf2e0e73598a9c6997c501f0e12255bc3db", "committedDate": "2020-06-17T12:04:52Z", "message": "retrigger build with empty commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b7a5582b0cba046198bbbccbf9651132826cf72", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/8b7a5582b0cba046198bbbccbf9651132826cf72", "committedDate": "2020-06-17T15:56:44Z", "message": "supress checkstye problem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6886c22c521098747a98ac0042d09ca653d49437", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/6886c22c521098747a98ac0042d09ca653d49437", "committedDate": "2020-06-17T16:07:32Z", "message": "cleanup unnecessary changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0a27c7f5881cc154cbfeff406b690ec9a0e406a", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/b0a27c7f5881cc154cbfeff406b690ec9a0e406a", "committedDate": "2020-06-17T16:08:12Z", "message": "Merge remote-tracking branch 'elek/HDDS-3757' into HDDS-3757"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ab7fd30f15c42e4094e9176f8d30d186d51acb2", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/5ab7fd30f15c42e4094e9176f8d30d186d51acb2", "committedDate": "2020-06-18T09:06:31Z", "message": "retrigger build with empty commit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMjkwNzYx", "url": "https://github.com/apache/ozone/pull/1050#pullrequestreview-433290761", "createdAt": "2020-06-18T13:37:29Z", "commit": {"oid": "5ab7fd30f15c42e4094e9176f8d30d186d51acb2"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxMzozNzozMFrOGlvrVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxMzo0Mjo0M1rOGlv5lA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIzMTYzOA==", "bodyText": "I don't see any *.exec files in acceptance.zip for the latest run.  Am I missing something?", "url": "https://github.com/apache/ozone/pull/1050#discussion_r442231638", "createdAt": "2020-06-18T13:37:30Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/dist/src/main/compose/test-all.sh", "diffHunk": "@@ -41,8 +46,13 @@ for test in $(find \"$SCRIPT_DIR\" -name test.sh | sort); do\n       echo \"ERROR: Test execution of $(dirname \"$test\") is FAILED!!!!\"\n   fi\n   RESULT_DIR=\"$(dirname \"$test\")/result\"\n-  cp \"$RESULT_DIR\"/robot-*.xml \"$RESULT_DIR\"/docker-*.log \"$RESULT_DIR\"/*.out* \"$ALL_RESULT_DIR\"/\n+  cp \"$RESULT_DIR\"/robot-*.xml \"$RESULT_DIR\"/docker-*.log \"$RESULT_DIR\"/*.out* \"$RESULT_DIR\"/*.exec \"$ALL_RESULT_DIR\"/\n done\n \n rebot -N \"smoketests\" -d \"$SCRIPT_DIR/result\" \"$SCRIPT_DIR/result/robot-*.xml\"\n+if [ \"$OZONE_WITH_COVERAGE\" ]; then\n+  cp /tmp/jacoco-combined.exec \"$SCRIPT_DIR/result/\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ab7fd30f15c42e4094e9176f8d30d186d51acb2"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIzNTI4NA==", "bodyText": "Some of the compose environments have a dedicated network.  I think those would have problems starting SCM:\nhadoop-ozone/dist/src/main/compose/ozone-topology/docker-compose.yaml\nhadoop-ozone/dist/src/main/compose/ozonesecure-om-ha/docker-compose.yaml\nhadoop-ozone/dist/src/main/compose/ozonesecure-mr/docker-compose.yaml\n\n(I'm not sure because I have trouble starting any of the environments with coverage enabled.)", "url": "https://github.com/apache/ozone/pull/1050#discussion_r442235284", "createdAt": "2020-06-18T13:42:43Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/dist/src/main/compose/test-all.sh", "diffHunk": "@@ -19,17 +19,22 @@\n #\n # Test executor to test all the compose/*/test.sh test scripts.\n #\n-\n SCRIPT_DIR=$( cd \"$( dirname \"${BASH_SOURCE[0]}\" )\" >/dev/null && pwd )\n ALL_RESULT_DIR=\"$SCRIPT_DIR/result\"\n-\n+PROJECT_DIR=\"$SCRIPT_DIR/..\"\n mkdir -p \"$ALL_RESULT_DIR\"\n-rm \"$ALL_RESULT_DIR/*\"\n+rm \"$ALL_RESULT_DIR/*\" || true\n+\n+if [ \"$OZONE_WITH_COVERAGE\" ]; then\n+   java -cp \"$PROJECT_DIR\"/share/coverage/$(ls \"$PROJECT_DIR\"/share/coverage | grep test-util):\"$PROJECT_DIR\"/share/coverage/jacoco-core.jar org.apache.hadoop.test.JacocoServer &\n+   DOCKER_BRIDGE_IP=$(docker network inspect bridge --format='{{(index .IPAM.Config 0).Gateway}}')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ab7fd30f15c42e4094e9176f8d30d186d51acb2"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31b28aa10e2babad8e54b14804d2a80f456a152f", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/31b28aa10e2babad8e54b14804d2a80f456a152f", "committedDate": "2020-06-19T13:16:21Z", "message": "fix path of the jacoco file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76f2aefbda4d79b516c7035344a065566ae788ce", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/76f2aefbda4d79b516c7035344a065566ae788ce", "committedDate": "2020-06-19T13:16:39Z", "message": "Merge remote-tracking branch 'elek/HDDS-3757' into HDDS-3757"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f7198ecfd7a0246d49470a85ebdba9b6094dc98", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/3f7198ecfd7a0246d49470a85ebdba9b6094dc98", "committedDate": "2020-06-19T17:53:34Z", "message": "use new style of testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c27a22b5f2865a7984ca4070dd370bd4ac06211c", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/c27a22b5f2865a7984ca4070dd370bd4ac06211c", "committedDate": "2020-06-19T17:54:23Z", "message": "acceptance only test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1457eb90de01aca3d4ef99110f31f49a56e4fcc6", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/1457eb90de01aca3d4ef99110f31f49a56e4fcc6", "committedDate": "2020-06-22T10:24:39Z", "message": "Revert \"acceptance only test\"\n\nThis reverts commit c27a22b5f2865a7984ca4070dd370bd4ac06211c."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b82507d2aa333d932eb82119febc2ff2d760bd6c", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/b82507d2aa333d932eb82119febc2ff2d760bd6c", "committedDate": "2020-06-22T10:24:50Z", "message": "Merge remote-tracking branch 'origin/master' into HDDS-3757"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d36ffb1990ede2541a56a9aafc960363d74201b7", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/d36ffb1990ede2541a56a9aafc960363d74201b7", "committedDate": "2020-06-22T10:25:58Z", "message": "run acceptance tests only"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f96a8f3d7efe4cacdb08fe6424c121e514f18812", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/f96a8f3d7efe4cacdb08fe6424c121e514f18812", "committedDate": "2020-06-22T11:54:32Z", "message": "Merge remote-tracking branch 'origin/master' into HDDS-3757"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fd961cf195a62183ff5320f13e9c8457032a33c", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/1fd961cf195a62183ff5320f13e9c8457032a33c", "committedDate": "2020-06-22T12:03:04Z", "message": "no longer needs build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31b2f0e3a98efe91635ce114f8b99d6387356623", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/31b2f0e3a98efe91635ce114f8b99d6387356623", "committedDate": "2020-06-22T13:11:17Z", "message": "fix checkout for PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "feb74c36db9530d5326de05612cecf48b903062a", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/feb74c36db9530d5326de05612cecf48b903062a", "committedDate": "2020-06-22T15:14:16Z", "message": "restore other checks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c804260884244543162488db703a29cce343127", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/4c804260884244543162488db703a29cce343127", "committedDate": "2020-06-22T15:15:05Z", "message": "coverage depends on acceptance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f0ae379f5ff50ceff8a2cb72192db61daefe205", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/4f0ae379f5ff50ceff8a2cb72192db61daefe205", "committedDate": "2020-06-22T17:51:20Z", "message": "trigger new CI check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8cace0450c0b81d284ceb2c95b8640c662993f4", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/e8cace0450c0b81d284ceb2c95b8640c662993f4", "committedDate": "2020-06-23T12:58:53Z", "message": "retrigger build with empty commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3dcd13a50ec0f4b808d20172ed44e036e3dbae58", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/3dcd13a50ec0f4b808d20172ed44e036e3dbae58", "committedDate": "2020-06-25T15:38:46Z", "message": "retrigger build with empty commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9aa004aa8fcbcf6c91f788c00c2d7fe29efbf567", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/9aa004aa8fcbcf6c91f788c00c2d7fe29efbf567", "committedDate": "2020-06-25T18:29:20Z", "message": "Do not skip npx"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2858ea0935c68053427f5fef0189b0c2ccf92cf8", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/2858ea0935c68053427f5fef0189b0c2ccf92cf8", "committedDate": "2020-06-25T20:51:22Z", "message": "trigger new CI check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b06c431fbbca626e7748ef8eaf3d3591511b054", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/3b06c431fbbca626e7748ef8eaf3d3591511b054", "committedDate": "2020-06-26T01:38:12Z", "message": "trigger new CI check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0fc1bc017c1b00242d4c2c1c2994e26ef8dfda1", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/f0fc1bc017c1b00242d4c2c1c2994e26ef8dfda1", "committedDate": "2020-06-26T03:00:33Z", "message": "trigger new CI check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "539d2e03c84a4a9522f65a42feb682e9621c1e34", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/539d2e03c84a4a9522f65a42feb682e9621c1e34", "committedDate": "2020-06-26T06:31:18Z", "message": "retrigger build with empty commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "760f0c6f6939dde1687a2090ea9db67ea5fdda5f", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/760f0c6f6939dde1687a2090ea9db67ea5fdda5f", "committedDate": "2020-06-26T08:18:16Z", "message": "trigger new CI check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4MTAxNTk0", "url": "https://github.com/apache/ozone/pull/1050#pullrequestreview-438101594", "createdAt": "2020-06-26T08:17:43Z", "commit": {"oid": "539d2e03c84a4a9522f65a42feb682e9621c1e34"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwODoxNzo0NFrOGpX_YA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwODoxNzo0NFrOGpX_YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjAzNzg1Ng==", "bodyText": "I've found that these calls to ExecutionDataWriter's methods should be synchronized to avoid producing garbage files, which result in the following exception when trying to read them:\nException in thread \"main\" java.io.UTFDataFormatException: malformed input around byte 2\n  at java.io.DataInputStream.readUTF(DataInputStream.java:634)\n  at java.io.DataInputStream.readUTF(DataInputStream.java:564)\n  at org.jacoco.cli.internal.core.data.ExecutionDataReader.readExecutionData(ExecutionDataReader.java:149)\n\nor similar Unknown block type error.", "url": "https://github.com/apache/ozone/pull/1050#discussion_r446037856", "createdAt": "2020-06-26T08:17:44Z", "author": {"login": "adoroszlai"}, "path": "hadoop-hdds/test-utils/src/main/java/org/apache/hadoop/test/JacocoServer.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.test;\n+\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.net.ServerSocket;\n+import java.net.Socket;\n+\n+import org.jacoco.core.data.ExecutionDataWriter;\n+import org.jacoco.core.runtime.RemoteControlReader;\n+import org.jacoco.core.runtime.RemoteControlWriter;\n+\n+/**\n+ * Simple TPC server to collect all the Jacoco coverage data.\n+ */\n+public final class JacocoServer {\n+\n+  private static int port = 6300;\n+\n+  private static String destinationFile = \"/tmp/jacoco-combined.exec\";\n+\n+  private JacocoServer() {\n+  }\n+\n+  @SuppressWarnings(\"checkstyle:EmptyStatement\")\n+  public static void main(String[] args) throws IOException {\n+    ExecutionDataWriter destination =\n+        new ExecutionDataWriter(new FileOutputStream(destinationFile));\n+    ServerSocket serverSocket = new ServerSocket(port);\n+    Runtime.getRuntime().addShutdownHook(new Thread(() -> {\n+      try {\n+        destination.flush();\n+        serverSocket.close();\n+      } catch (Exception ex) {\n+        ex.printStackTrace();\n+      }\n+    }));\n+\n+    while (true) {\n+      final Socket socket = serverSocket.accept();\n+      new Thread(() -> {\n+        try {\n+          RemoteControlWriter writer =\n+              new RemoteControlWriter(socket.getOutputStream());\n+          RemoteControlReader reader =\n+              new RemoteControlReader(socket.getInputStream());\n+          reader.setSessionInfoVisitor(destination::visitSessionInfo);\n+          reader.setExecutionDataVisitor(destination::visitClassExecution);\n+          while (reader.read()) {\n+            ;//read until the end of the stream.\n+          }\n+          destination.flush();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "539d2e03c84a4a9522f65a42feb682e9621c1e34"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20d61e6b8c7981b7d0c61d4257c4001b115725a8", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/20d61e6b8c7981b7d0c61d4257c4001b115725a8", "committedDate": "2020-06-26T10:27:00Z", "message": "syncrhonize jacoco file writes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b96dc4656b1b5e296ba7720596107d70cda7f972", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/b96dc4656b1b5e296ba7720596107d70cda7f972", "committedDate": "2020-06-26T10:29:06Z", "message": "Merge remote-tracking branch 'elek/HDDS-3757' into HDDS-3757"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5583f82af36d540083d121bfeac9fc2aa20d8b27", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/5583f82af36d540083d121bfeac9fc2aa20d8b27", "committedDate": "2020-06-26T12:10:41Z", "message": "retrigger build with empty commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0da23f2fb0b299204e404cea3fc508815789c2fe", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/0da23f2fb0b299204e404cea3fc508815789c2fe", "committedDate": "2020-06-26T12:58:17Z", "message": "fix recon test (move it before admincli)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3991ed34a375a5f0af0ebdbee48b56f39a9350ab", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/3991ed34a375a5f0af0ebdbee48b56f39a9350ab", "committedDate": "2020-06-26T13:00:08Z", "message": "Merge remote-tracking branch 'elek/HDDS-3757' into HDDS-3757"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36eff2eabad93adf169364b14c013283b6bfd8e7", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/36eff2eabad93adf169364b14c013283b6bfd8e7", "committedDate": "2020-06-26T15:30:29Z", "message": "retrigger build with empty commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f9146f79b92793a34a8f802578559b99904f7fc", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/5f9146f79b92793a34a8f802578559b99904f7fc", "committedDate": "2020-06-26T16:57:42Z", "message": "retrigger build with empty commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af9874b924ff3f60bcb1b98fa5e11833f8fb0dc9", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/af9874b924ff3f60bcb1b98fa5e11833f8fb0dc9", "committedDate": "2020-06-26T17:00:38Z", "message": "syncrhonize flush"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "507dcf811bc1cc407b8d095fe3272ddeed31e256", "author": {"user": {"login": "elek", "name": "Elek, M\u00e1rton"}}, "url": "https://github.com/apache/ozone/commit/507dcf811bc1cc407b8d095fe3272ddeed31e256", "committedDate": "2020-06-26T17:02:20Z", "message": "Merge remote-tracking branch 'elek/HDDS-3757' into HDDS-3757"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NTYxODg1", "url": "https://github.com/apache/ozone/pull/1050#pullrequestreview-438561885", "createdAt": "2020-06-26T20:01:49Z", "commit": {"oid": "507dcf811bc1cc407b8d095fe3272ddeed31e256"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3171, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}