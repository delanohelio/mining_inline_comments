{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgwMTI4MTQ1", "number": 1398, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQwOTowMToyNFrOEgleuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMToxMDowMVrOEjE0Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyNjAzOTYxOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/om/TestOzoneManagerHAWithData.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQwOTowMToyNFrOHNgviw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNzoxNzo0NFrOHQnOmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkyOTk5NQ==", "bodyText": "We already have acceptance test for links, but currently it is only run in non-HA setup.  Instead of adding integration test, I think we should run the existing test in HA setup, too:\nexecute_robot_test scm basic/links.robot\n\ncould be added to hadoop-ozone/dist/src/main/compose/ozonesecure-om-ha/test.sh and maybe hadoop-ozone/dist/src/main/compose/ozone-om-ha-s3/test.sh.\nThis confirms the bug and the fix.\nHowever, I also see two of the test cases failing with the fix:\nCannot follow link without read access                                | FAIL |\nACL verified on source bucket                                         | FAIL |", "url": "https://github.com/apache/ozone/pull/1398#discussion_r483929995", "createdAt": "2020-09-05T09:01:24Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/om/TestOzoneManagerHAWithData.java", "diffHunk": "@@ -69,6 +70,38 @@ public void testAllOMNodesRunning() throws Exception {\n     createKeyTest(true);\n   }\n \n+  @Test\n+  public void testBucketLinkOps() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e966ddf5c91376f8bd7f6b2d4a396d8c55a2afab"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE4MTk3Nw==", "bodyText": "Thanks for the tip. Enabled docker-compose tests.", "url": "https://github.com/apache/ozone/pull/1398#discussion_r487181977", "createdAt": "2020-09-11T17:17:44Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/om/TestOzoneManagerHAWithData.java", "diffHunk": "@@ -69,6 +70,38 @@ public void testAllOMNodesRunning() throws Exception {\n     createKeyTest(true);\n   }\n \n+  @Test\n+  public void testBucketLinkOps() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkyOTk5NQ=="}, "originalCommit": {"oid": "e966ddf5c91376f8bd7f6b2d4a396d8c55a2afab"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyNjA0MDMxOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQwOTowMjozM1rOHNgv6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMToxNjoyMlrOHRPEfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkzMDA5MQ==", "bodyText": "Would it be possible to replace the original resolveBucketLink method with this one, instead of duplicating it?", "url": "https://github.com/apache/ozone/pull/1398#discussion_r483930091", "createdAt": "2020-09-05T09:02:33Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3523,6 +3533,47 @@ public ResolvedBucket resolveBucketLink(Pair<String, String> requested)\n         visited);\n   }\n \n+  /**\n+   * Resolves bucket symlinks. Read permission is required for following links.\n+   *\n+   * @param volumeAndBucket the bucket to be resolved (if it is a link)\n+   * @param {@link OMClientRequest}  which has information required to check\n+   * permission.\n+   * @param visited collects link buckets visited during the resolution to\n+   *   avoid infinite loops\n+   * @return bucket location possibly updated with its actual volume and bucket\n+   *   after following bucket links\n+   * @throws IOException (most likely OMException) if ACL check fails, bucket is\n+   *   not found, loop is detected in the links, etc.\n+   */\n+  private Pair<String, String> resolveBucketLink(\n+      Pair<String, String> volumeAndBucket,\n+      Set<Pair<String, String>> visited,\n+      OMClientRequest omClientRequest) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e966ddf5c91376f8bd7f6b2d4a396d8c55a2afab"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEwMDU0MQ==", "bodyText": "+1 for that. Also suggest separate related members from OMCleintRequest (HA) before passing them to OzoneManager (non-HA).", "url": "https://github.com/apache/ozone/pull/1398#discussion_r485100541", "createdAt": "2020-09-08T17:59:55Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3523,6 +3533,47 @@ public ResolvedBucket resolveBucketLink(Pair<String, String> requested)\n         visited);\n   }\n \n+  /**\n+   * Resolves bucket symlinks. Read permission is required for following links.\n+   *\n+   * @param volumeAndBucket the bucket to be resolved (if it is a link)\n+   * @param {@link OMClientRequest}  which has information required to check\n+   * permission.\n+   * @param visited collects link buckets visited during the resolution to\n+   *   avoid infinite loops\n+   * @return bucket location possibly updated with its actual volume and bucket\n+   *   after following bucket links\n+   * @throws IOException (most likely OMException) if ACL check fails, bucket is\n+   *   not found, loop is detected in the links, etc.\n+   */\n+  private Pair<String, String> resolveBucketLink(\n+      Pair<String, String> volumeAndBucket,\n+      Set<Pair<String, String>> visited,\n+      OMClientRequest omClientRequest) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkzMDA5MQ=="}, "originalCommit": {"oid": "e966ddf5c91376f8bd7f6b2d4a396d8c55a2afab"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE3ODI1OA==", "bodyText": "Made few changes to not to duplicate code.", "url": "https://github.com/apache/ozone/pull/1398#discussion_r487178258", "createdAt": "2020-09-11T17:10:25Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3523,6 +3533,47 @@ public ResolvedBucket resolveBucketLink(Pair<String, String> requested)\n         visited);\n   }\n \n+  /**\n+   * Resolves bucket symlinks. Read permission is required for following links.\n+   *\n+   * @param volumeAndBucket the bucket to be resolved (if it is a link)\n+   * @param {@link OMClientRequest}  which has information required to check\n+   * permission.\n+   * @param visited collects link buckets visited during the resolution to\n+   *   avoid infinite loops\n+   * @return bucket location possibly updated with its actual volume and bucket\n+   *   after following bucket links\n+   * @throws IOException (most likely OMException) if ACL check fails, bucket is\n+   *   not found, loop is detected in the links, etc.\n+   */\n+  private Pair<String, String> resolveBucketLink(\n+      Pair<String, String> volumeAndBucket,\n+      Set<Pair<String, String>> visited,\n+      OMClientRequest omClientRequest) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkzMDA5MQ=="}, "originalCommit": {"oid": "e966ddf5c91376f8bd7f6b2d4a396d8c55a2afab"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzgzNDc0OA==", "bodyText": "Thanks!", "url": "https://github.com/apache/ozone/pull/1398#discussion_r487834748", "createdAt": "2020-09-14T11:16:22Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3523,6 +3533,47 @@ public ResolvedBucket resolveBucketLink(Pair<String, String> requested)\n         visited);\n   }\n \n+  /**\n+   * Resolves bucket symlinks. Read permission is required for following links.\n+   *\n+   * @param volumeAndBucket the bucket to be resolved (if it is a link)\n+   * @param {@link OMClientRequest}  which has information required to check\n+   * permission.\n+   * @param visited collects link buckets visited during the resolution to\n+   *   avoid infinite loops\n+   * @return bucket location possibly updated with its actual volume and bucket\n+   *   after following bucket links\n+   * @throws IOException (most likely OMException) if ACL check fails, bucket is\n+   *   not found, loop is detected in the links, etc.\n+   */\n+  private Pair<String, String> resolveBucketLink(\n+      Pair<String, String> volumeAndBucket,\n+      Set<Pair<String, String>> visited,\n+      OMClientRequest omClientRequest) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkzMDA5MQ=="}, "originalCommit": {"oid": "e966ddf5c91376f8bd7f6b2d4a396d8c55a2afab"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0OTUzNDA3OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/dist/src/main/compose/ozonesecure-om-ha/test.sh", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xM1QwMTo0NzowOVrOHQ4uuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNjowMToxMFrOHRcDig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ2ODczMQ==", "bodyText": "Out of curiosity: why adding this robot test to both\n hadoop-ozone/dist/src/main/compose/ozone-om-ha-s3/test.sh and\nhadoop-ozone/dist/src/main/compose/ozonesecure-om-ha/test.sh.\nWill it just run the same test twice on each CI?", "url": "https://github.com/apache/ozone/pull/1398#discussion_r487468731", "createdAt": "2020-09-13T01:47:09Z", "author": {"login": "amaliujia"}, "path": "hadoop-ozone/dist/src/main/compose/ozonesecure-om-ha/test.sh", "diffHunk": "@@ -30,6 +30,8 @@ execute_robot_test scm kinit.robot\n \n execute_robot_test scm freon\n \n+execute_robot_test scm basic/links.robot", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f174a2583bffccfce85feec59f3a97704ae91d1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzYzNDUxNw==", "bodyText": "Good question might be it is good to run only during security-enabled cluster.\nBut it has some tests which are bucket link features, so I thought it might be good to run in both secure and non-secure.", "url": "https://github.com/apache/ozone/pull/1398#discussion_r487634517", "createdAt": "2020-09-14T03:38:33Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/dist/src/main/compose/ozonesecure-om-ha/test.sh", "diffHunk": "@@ -30,6 +30,8 @@ execute_robot_test scm kinit.robot\n \n execute_robot_test scm freon\n \n+execute_robot_test scm basic/links.robot", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ2ODczMQ=="}, "originalCommit": {"oid": "1f174a2583bffccfce85feec59f3a97704ae91d1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcwMDE3Nw==", "bodyText": "I think it's useful to run the same test in different environments: secure and non-secure, non-HA and HA.  It increases coverage.  Also, non-secure versions provide some kind of baseline: if it works and secure one does not, we might know the problem is security-related.\nIf it takes too much time, we can tweak acceptance test splits (currently we have 3 concurrent runs in CI).", "url": "https://github.com/apache/ozone/pull/1398#discussion_r487700177", "createdAt": "2020-09-14T07:20:04Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/dist/src/main/compose/ozonesecure-om-ha/test.sh", "diffHunk": "@@ -30,6 +30,8 @@ execute_robot_test scm kinit.robot\n \n execute_robot_test scm freon\n \n+execute_robot_test scm basic/links.robot", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ2ODczMQ=="}, "originalCommit": {"oid": "1f174a2583bffccfce85feec59f3a97704ae91d1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODA0NzQ5OA==", "bodyText": "Makes sense. Thanks for all your clarification!", "url": "https://github.com/apache/ozone/pull/1398#discussion_r488047498", "createdAt": "2020-09-14T16:01:10Z", "author": {"login": "amaliujia"}, "path": "hadoop-ozone/dist/src/main/compose/ozonesecure-om-ha/test.sh", "diffHunk": "@@ -30,6 +30,8 @@ execute_robot_test scm kinit.robot\n \n execute_robot_test scm freon\n \n+execute_robot_test scm basic/links.robot", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQ2ODczMQ=="}, "originalCommit": {"oid": "1f174a2583bffccfce85feec59f3a97704ae91d1"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1MjE0NTUxOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMToxMDowMVrOHRO37w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMToxMDowMVrOHRO37w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzgzMTUzNQ==", "bodyText": "Nit: to avoid Sonar warning that \"static\" base class members should not be accessed via derived types.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          ProtobufRpcEngine.Server.getRemoteUser(),\n          \n          \n            \n                          ProtobufRpcEngine.Server.getRemoteIp(),\n          \n          \n            \n                          ProtobufRpcEngine.Server.getRemoteIp().getHostName());\n          \n          \n            \n                          Server.getRemoteUser(),\n          \n          \n            \n                          Server.getRemoteIp(),\n          \n          \n            \n                          Server.getRemoteIp().getHostName());", "url": "https://github.com/apache/ozone/pull/1398#discussion_r487831535", "createdAt": "2020-09-14T11:10:01Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3479,10 +3481,35 @@ public ResolvedBucket resolveBucketLink(OmKeyArgs args)\n         Pair.of(args.getVolumeName(), args.getBucketName()));\n   }\n \n+  public ResolvedBucket resolveBucketLink(Pair<String, String> requested,\n+      OMClientRequest omClientRequest)\n+      throws IOException {\n+    Pair<String, String> resolved;\n+    if (isAclEnabled) {\n+      resolved = resolveBucketLink(requested, new HashSet<>(),\n+              omClientRequest.createUGI(), omClientRequest.getRemoteAddress(),\n+              omClientRequest.getHostName());\n+    } else {\n+      resolved = resolveBucketLink(requested, new HashSet<>(),\n+          null, null, null);\n+    }\n+    return new ResolvedBucket(requested, resolved);\n+  }\n+\n+\n   public ResolvedBucket resolveBucketLink(Pair<String, String> requested)\n       throws IOException {\n-    Pair<String, String> resolved =\n-        resolveBucketLink(requested, new HashSet<>());\n+\n+    Pair<String, String> resolved;\n+    if (isAclEnabled) {\n+      resolved = resolveBucketLink(requested, new HashSet<>(),\n+              ProtobufRpcEngine.Server.getRemoteUser(),\n+              ProtobufRpcEngine.Server.getRemoteIp(),\n+              ProtobufRpcEngine.Server.getRemoteIp().getHostName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f174a2583bffccfce85feec59f3a97704ae91d1"}, "originalPosition": 51}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4860, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}