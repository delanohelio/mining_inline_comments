{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4NzIwOTQ0", "number": 1569, "title": "HDDS-4448. Duplicate refreshPipeline in listStatus", "bodyText": "What changes were proposed in this pull request?\nCurrently KeyManagerImpl#listStatus issues duplicate refreshPipeline for each file.  HDDS-3824 moved refreshPipeline outside the bucket lock.  But HDDS-3658 added it back, while keeping the one outside the lock, probably as a result of merge conflict resolution.\nThis PR removes the refreshPipeline call which is made while holding the bucket lock.  It also converts the remaining one to batched (single call with list, instead of N times with single OM key info).\nhttps://issues.apache.org/jira/browse/HDDS-4448\nHow was this patch tested?\nAdded unit test to verify that a single batched refreshPipeline call is made from listStatus.\nhttps://github.com/adoroszlai/hadoop-ozone/runs/1381172579", "createdAt": "2020-11-10T19:40:04Z", "url": "https://github.com/apache/ozone/pull/1569", "merged": true, "mergeCommit": {"oid": "bbeaf65f6c135caa4d2854bab14b117878a77a3e"}, "closed": true, "closedAt": "2020-11-19T05:20:51Z", "author": {"login": "adoroszlai"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbLjCagH2gAyNTE4NzIwOTQ0OmExZmRiZTU0MTk1YTM1ZDY3NTU4ODU0YTc5MWZlZDE2YjdiZjkwZmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdd7ymBAFqTUzNDA4OTM2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a1fdbe54195a35d67558854a791fed16b7bf90fb", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/a1fdbe54195a35d67558854a791fed16b7bf90fb", "committedDate": "2020-11-10T16:00:25Z", "message": "HDDS-4448. Duplicate refreshPipeline in listStatus"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a50000a2992d45596c571bbeec9040c7118458d", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/7a50000a2992d45596c571bbeec9040c7118458d", "committedDate": "2020-11-10T17:38:01Z", "message": "Always refresh pipeline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3911ce77eff5ceb28d627b4591698b122f0fa4d1", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/3911ce77eff5ceb28d627b4591698b122f0fa4d1", "committedDate": "2020-11-10T20:27:32Z", "message": "trigger new CI check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MTUyMTAy", "url": "https://github.com/apache/ozone/pull/1569#pullrequestreview-528152102", "createdAt": "2020-11-11T13:03:14Z", "commit": {"oid": "3911ce77eff5ceb28d627b4591698b122f0fa4d1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxOTA3MDUy", "url": "https://github.com/apache/ozone/pull/1569#pullrequestreview-531907052", "createdAt": "2020-11-16T23:31:19Z", "commit": {"oid": "3911ce77eff5ceb28d627b4591698b122f0fa4d1"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMzozMToxOVrOH0cPNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMzozMzo0N1rOH0cZPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDc1MDY0NQ==", "bodyText": "This call still makes number of entries in listStatus call to put nodes in sorted order in pipeline when ozone.network.topology.aware.read is set. (Default false, so this will not be a problem, but we have still the problem of making number of entries in listStatus calls to SCM.", "url": "https://github.com/apache/ozone/pull/1569#discussion_r524750645", "createdAt": "2020-11-16T23:31:19Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java", "diffHunk": "@@ -2209,14 +2205,18 @@ private void listStatusFindKeyInTableCache(\n           bucketName);\n     }\n \n+    List<OmKeyInfo> keyInfoList = new ArrayList<>(fileStatusList.size());\n     for (OzoneFileStatus fileStatus : fileStatusList) {\n-      if (args.getRefreshPipeline()) {\n-        refreshPipeline(fileStatus.getKeyInfo());\n-      }\n-      if (args.getSortDatanodes()) {\n+      keyInfoList.add(fileStatus.getKeyInfo());\n+    }\n+    refreshPipeline(keyInfoList);\n+\n+    if (args.getSortDatanodes()) {\n+      for (OzoneFileStatus fileStatus : fileStatusList) {\n         sortDatanodeInPipeline(fileStatus.getKeyInfo(), clientAddress);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3911ce77eff5ceb28d627b4591698b122f0fa4d1"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDc1MzIxMg==", "bodyText": "Just a question listStatus is limited by batch size.\nBut we are making a single Rpc Call to SCM for all the containers we got from this list, is this fine here? (My question is if it has a large number of containerIDs due to larger key sizes, will it have an issue in Rpc Response size.", "url": "https://github.com/apache/ozone/pull/1569#discussion_r524753212", "createdAt": "2020-11-16T23:33:47Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java", "diffHunk": "@@ -2209,14 +2205,18 @@ private void listStatusFindKeyInTableCache(\n           bucketName);\n     }\n \n+    List<OmKeyInfo> keyInfoList = new ArrayList<>(fileStatusList.size());\n     for (OzoneFileStatus fileStatus : fileStatusList) {\n-      if (args.getRefreshPipeline()) {\n-        refreshPipeline(fileStatus.getKeyInfo());\n-      }\n-      if (args.getSortDatanodes()) {\n+      keyInfoList.add(fileStatus.getKeyInfo());\n+    }\n+    refreshPipeline(keyInfoList);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3911ce77eff5ceb28d627b4591698b122f0fa4d1"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MDg5MzYx", "url": "https://github.com/apache/ozone/pull/1569#pullrequestreview-534089361", "createdAt": "2020-11-19T05:20:42Z", "commit": {"oid": "3911ce77eff5ceb28d627b4591698b122f0fa4d1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2265, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}