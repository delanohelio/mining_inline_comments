{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3MTg3MzQ3", "number": 749, "title": "HDDS-3322. StandAlone Pipelines are created in an infinite loop", "bodyText": "What changes were proposed in this pull request?\nBackgroundPipelineCreator keeps creating pipelines of configured Replication type and all available Replication factors until some exception occurs while creating the pipeline such as no more available nodes.\nWhen Replication Type is set to STAND_ALONE, we do not check if a DN has already been used to create a pipeline of same factor or not and keep reusing the same DNs to create new pipelines. This causes the pipeline creation to happen in an infinite loop.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3322\nHow was this patch tested?\nTested on a real cluster.", "createdAt": "2020-04-01T19:26:12Z", "url": "https://github.com/apache/ozone/pull/749", "merged": true, "mergeCommit": {"oid": "2f37a25bf02518bb4484b608f803c6ce4a4656d4"}, "closed": true, "closedAt": "2020-04-17T04:18:33Z", "author": {"login": "hanishakoneru"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVgb-ygFqTM4OTY0OTAyNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYU-WSAFqTM5NTA1ODQyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5NjQ5MDI1", "url": "https://github.com/apache/ozone/pull/749#pullrequestreview-389649025", "createdAt": "2020-04-08T04:46:00Z", "commit": {"oid": "d1ec432554f6050dd34d126133e76ee251a65422"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNDo0NjowMVrOGCe1BQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNDo0NjowMVrOGCe1BQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI1NTQyOQ==", "bodyText": "And also for Simple Pipeline Provider, we should not create pipeline with factor 3.\nThis is an existing issue, but when looking into this patch found it.", "url": "https://github.com/apache/ozone/pull/749#discussion_r405255429", "createdAt": "2020-04-08T04:46:01Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/SimplePipelineProvider.java", "diffHunk": "@@ -32,18 +31,18 @@\n /**\n  * Implements Api for creating stand alone pipelines.\n  */\n-public class SimplePipelineProvider implements PipelineProvider {\n+public class SimplePipelineProvider extends PipelineProvider {\n \n-  private final NodeManager nodeManager;\n-\n-  public SimplePipelineProvider(NodeManager nodeManager) {\n-    this.nodeManager = nodeManager;\n+  public SimplePipelineProvider(NodeManager nodeManager,\n+      PipelineStateManager stateManager) {\n+    super(nodeManager, stateManager);\n   }\n \n   @Override\n   public Pipeline create(ReplicationFactor factor) throws IOException {\n-    List<DatanodeDetails> dns =\n-        nodeManager.getNodes(NodeState.HEALTHY);\n+    List<DatanodeDetails> dns = pickNodesNeverUsed(ReplicationType.STAND_ALONE,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1ec432554f6050dd34d126133e76ee251a65422"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5NjQ5NDg5", "url": "https://github.com/apache/ozone/pull/749#pullrequestreview-389649489", "createdAt": "2020-04-08T04:47:42Z", "commit": {"oid": "d1ec432554f6050dd34d126133e76ee251a65422"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d1ec432554f6050dd34d126133e76ee251a65422", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/d1ec432554f6050dd34d126133e76ee251a65422", "committedDate": "2020-04-01T19:23:58Z", "message": "HDDS-3322. StandAlone Pipelines are created in an infinite loop"}, "afterCommit": {"oid": "983013f74a4ac07e2411e9b22ac6031ede3828ad", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/983013f74a4ac07e2411e9b22ac6031ede3828ad", "committedDate": "2020-04-13T20:16:22Z", "message": "Avoid creation of StandAlone pipeline with factor THREE"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "755cd11aeae2b3dbf499679564871fe6bd21a8a2", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/755cd11aeae2b3dbf499679564871fe6bd21a8a2", "committedDate": "2020-04-16T15:52:39Z", "message": "HDDS-3322. StandAlone Pipelines are created in an infinite loop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7e739d713655ab62b2a131ca5b539463e2d6205", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/f7e739d713655ab62b2a131ca5b539463e2d6205", "committedDate": "2020-04-16T15:52:39Z", "message": "Avoid creation of StandAlone pipeline with factor THREE"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2b1c5a41fd6301364b9a2c850f79cf5c3caebd7", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/e2b1c5a41fd6301364b9a2c850f79cf5c3caebd7", "committedDate": "2020-04-16T16:01:42Z", "message": "checkstyle fixes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "983013f74a4ac07e2411e9b22ac6031ede3828ad", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/983013f74a4ac07e2411e9b22ac6031ede3828ad", "committedDate": "2020-04-13T20:16:22Z", "message": "Avoid creation of StandAlone pipeline with factor THREE"}, "afterCommit": {"oid": "e2b1c5a41fd6301364b9a2c850f79cf5c3caebd7", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/e2b1c5a41fd6301364b9a2c850f79cf5c3caebd7", "committedDate": "2020-04-16T16:01:42Z", "message": "checkstyle fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MDU4NDI2", "url": "https://github.com/apache/ozone/pull/749#pullrequestreview-395058426", "createdAt": "2020-04-16T23:06:28Z", "commit": {"oid": "e2b1c5a41fd6301364b9a2c850f79cf5c3caebd7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3579, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}