{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3OTQ0Nzkx", "number": 675, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxOTo1NjoxM1rODn9MjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxOTo1NjozN1rODn9M7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMjIzNjkyOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/tasks/OMDBUpdatesHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxOTo1NjoxM1rOF2Qkww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxOTo1NjoxM1rOF2Qkww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQzODk3OQ==", "bodyText": "Minor: Can be changed to == enum compare instead.", "url": "https://github.com/apache/ozone/pull/675#discussion_r392438979", "createdAt": "2020-03-13T19:56:13Z", "author": {"login": "swagle"}, "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/tasks/OMDBUpdatesHandler.java", "diffHunk": "@@ -88,30 +93,47 @@ private void processEvent(int cfIndex, byte[] keyBytes, byte[]\n       valueBytes, OMDBUpdateEvent.OMDBUpdateAction action)\n       throws IOException {\n     String tableName = tablesNames.get(cfIndex);\n-    Class keyType = getKeyType();\n+    Class<String> keyType = getKeyType();\n     Class valueType = getValueType(tableName);\n     if (valueType != null) {\n       OMDBUpdateEvent.OMUpdateEventBuilder builder =\n           new OMDBUpdateEvent.OMUpdateEventBuilder<>();\n       builder.setTable(tableName);\n+      builder.setAction(action);\n \n-      Object key = codecRegistry.asObject(keyBytes, keyType);\n+      String key = codecRegistry.asObject(keyBytes, keyType);\n       builder.setKey(key);\n \n-      if (!action.equals(OMDBUpdateEvent.OMDBUpdateAction.DELETE)) {\n+      if (action.equals(PUT)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a42abf182c4a14507195057bb4b65849d02e639"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMjIzNzg4OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/tasks/FileSizeCountTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxOTo1NjozN1rOF2QlVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxOTo1NjozN1rOF2QlVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQzOTEyNg==", "bodyText": "Minor: bad indent", "url": "https://github.com/apache/ozone/pull/675#discussion_r392439126", "createdAt": "2020-03-13T19:56:37Z", "author": {"login": "swagle"}, "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/tasks/FileSizeCountTask.java", "diffHunk": "@@ -229,22 +228,39 @@ void populateFileCountBySizeDB() {\n    * Used by reprocess() and process().\n    *\n    * @param omKeyInfo OmKey being updated for count\n-   * @param operation (PUT, DELETE)\n    */\n-  void updateUpperBoundCount(OmKeyInfo omKeyInfo,\n-      OMDBUpdateEvent.OMDBUpdateAction operation) {\n+  void handlePutKeyEvent(OmKeyInfo omKeyInfo) {\n     int binIndex = calculateBinIndex(omKeyInfo.getDataSize());\n-    if (operation == PUT) {\n-      upperBoundCount[binIndex]++;\n-    } else if (operation == DELETE) {\n-      if (upperBoundCount[binIndex] != 0) {\n+    upperBoundCount[binIndex]++;\n+  }\n+\n+  /**\n+   * Calculate and update the count of files being tracked by\n+   * upperBoundCount[].\n+   * Used by reprocess() and process().\n+   *\n+   * @param omKeyInfo OmKey being updated for count\n+   */\n+  void handleDeleteKeyEvent(String key, OmKeyInfo omKeyInfo) {\n+    if (omKeyInfo == null) {\n+      LOG.warn(\"Unexpected error while handling DELETE key event. Key not \" +\n+          \"found in Recon OM DB : {}\", key);\n+    } else {\n+      int binIndex = calculateBinIndex(omKeyInfo.getDataSize());\n+      if (upperBoundCount[binIndex] > 0) {\n         //decrement only if it had files before, default DB value is 0\n         upperBoundCount[binIndex]--;\n       } else {\n         LOG.warn(\"Unexpected error while updating bin count. Found 0 count \" +\n-            \"for index : {} while processing DELETE event for {}\", binIndex,\n+                \"for index : {} while processing DELETE event for {}\", binIndex,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a42abf182c4a14507195057bb4b65849d02e639"}, "originalPosition": 135}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4826, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}