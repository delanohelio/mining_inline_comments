{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3NzAyNDMz", "number": 1197, "title": "HDDS-3925. SCM Pipeline DB should directly use UUID bytes for key rather than rely on proto serialization for key.", "bodyText": "What changes were proposed in this pull request?\nAs we recently learned, protoBuf serialization is not needed to produce the same byte array over the wire, and therefore the toByteArray method's return value should not be used to byte array based comparison of protobuf serializations.\nIn the SCM's RocksDB we use the PipelineID as a key in the Pipeline table, and the key is created using the byte array representation of the protobuf serialization of the PipelineID, which can lead to mismatches when we access anything from the table based on a key. At the moment this can prevent us to delete a Pipeline from the table if there is a change in the byte array representation.\nIn order to avoid this situation, the way how we create the key to this table from the PipelineID needs to be changed, this is one part of this PR, and covered in the PipelineIDCodec related changes.\nThe other part is to clean up the DB from the old keys, as SCM will not be able to close and remove those Pipeline based on the ID as after we change the key serialization the byte array matched and stored will not be the same for the same PipelineID, that is used in the delete method which the code uses. So SCM can end up with pipelines that will never be cleaned up from the DB, and are polluting the in memory structures at startup until they are considered invalid.\nIn order to avoid this, SCMPipelineManager from now on checks if the key deserialization results in the same PipelineID as the one stored in the value in the table which is a Pipeline object. If the two are different, we remove the old version from the table, and add it with the new key, so that the pipelines are still preserved, but later can be deleted from RocksDB as well by the SCM when appropriate.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3925\nHow was this patch tested?\nJUnit tests are added to new things. And to check key migration happens properly.", "createdAt": "2020-07-11T01:46:53Z", "url": "https://github.com/apache/ozone/pull/1197", "merged": true, "mergeCommit": {"oid": "0a1cce5b98c22f72b31ca13a8ef2734f86b0bec4"}, "closed": true, "closedAt": "2020-07-14T21:30:46Z", "author": {"login": "fapifta"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczlZsHAH2gAyNDQ3NzAyNDMzOmNhZjYwZmRiNDJiYmE1OGVjZGZkOGYxNGI2NzI5MTVlY2JlNjIzNzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc05lSwAH2gAyNDQ3NzAyNDMzOjAxZmNlYzE0MjEwMjgwNjk2Y2M2ZGU4YzY5OTJjYWE3YjYwYzYzODU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "caf60fdb42bba58ecdfd8f14b672915ecbe62373", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/caf60fdb42bba58ecdfd8f14b672915ecbe62373", "committedDate": "2020-07-10T15:30:46Z", "message": "HDDS-3925. Add first implementation that uses the approach that removes via the iterator."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f989cbbb836296c2aa6d0ae7420cbda2f755087", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/9f989cbbb836296c2aa6d0ae7420cbda2f755087", "committedDate": "2020-07-10T18:30:27Z", "message": "HDDS-3925. Addressing comments from internal review and design discussion."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fb4dc0bbb1464b3a40a6e30d7998f403807694b", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/4fb4dc0bbb1464b3a40a6e30d7998f403807694b", "committedDate": "2020-07-10T22:26:34Z", "message": "Add tests to the codec conversion methods, and change the conversion approach."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5838fa37f6b0c3a5ba76679e24a94710d01d616", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/d5838fa37f6b0c3a5ba76679e24a94710d01d616", "committedDate": "2020-07-11T01:18:23Z", "message": "HDDs-3925. Added test to changes in SCMPipelineManager."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74df1ac556eeb247a88ddc9e7282d23addb9d863", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/74df1ac556eeb247a88ddc9e7282d23addb9d863", "committedDate": "2020-07-11T01:27:24Z", "message": "HDDS-3925. Added missing license, and fixed checkstyle issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78f955a5600543be826e26e94d9d3b3ff9b12715", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/78f955a5600543be826e26e94d9d3b3ff9b12715", "committedDate": "2020-07-11T02:15:03Z", "message": "Add javadoc to newly added method on TableIterator interface."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09c24775947b9a41c48a8d683153c98f0a1a4ef2", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/09c24775947b9a41c48a8d683153c98f0a1a4ef2", "committedDate": "2020-07-11T02:15:36Z", "message": "Fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e15f7612dfa06d481db745c9d78866aa1b712a28", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/e15f7612dfa06d481db745c9d78866aa1b712a28", "committedDate": "2020-07-11T10:34:53Z", "message": "Trigger a new test run."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44b9c1c66ec618a94e37c9b272c1853e107795b4", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/44b9c1c66ec618a94e37c9b272c1853e107795b4", "committedDate": "2020-07-14T00:43:35Z", "message": "HDDS-3925. Review request. Add tests to verify RDBStoreIterator interactions with the underlying RocksIterator and RocksDBTable."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acd7ba909cc9e70f8428707a2fec8592b9806f28", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/acd7ba909cc9e70f8428707a2fec8592b9806f28", "committedDate": "2020-07-14T00:48:27Z", "message": "Added license. Removed unused import."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da6ef7282cf54c700c701b58dad7fb6b0931b166", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/da6ef7282cf54c700c701b58dad7fb6b0931b166", "committedDate": "2020-07-14T00:57:59Z", "message": "Fix missing javadoc."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10c6209405c1a9edfdfba20d8777ad971613f62e", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/10c6209405c1a9edfdfba20d8777ad971613f62e", "committedDate": "2020-07-14T07:05:35Z", "message": "Trigger a new test run."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4cba4ef381a35eee2b88465f0321dd1c35b9d2d", "author": {"user": {"login": "web-flow", "name": "GitHub Web Flow"}}, "url": "https://github.com/apache/ozone/commit/b4cba4ef381a35eee2b88465f0321dd1c35b9d2d", "committedDate": "2020-07-14T08:53:40Z", "message": "empty commit to retest build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8344923512918ee987c937f369e31a0f23522f72", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/8344923512918ee987c937f369e31a0f23522f72", "committedDate": "2020-07-14T09:15:00Z", "message": "Trigger a new test run."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84eaec1f7c8e12a5f53ddc8a3f07d6080e18fa6d", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/84eaec1f7c8e12a5f53ddc8a3f07d6080e18fa6d", "committedDate": "2020-07-14T09:15:13Z", "message": "Merge branch 'HDDS-3925' of github.com:fapifta/hadoop-ozone into HDDS-3925"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4Mjk1MTIx", "url": "https://github.com/apache/ozone/pull/1197#pullrequestreview-448295121", "createdAt": "2020-07-14T17:00:29Z", "commit": {"oid": "84eaec1f7c8e12a5f53ddc8a3f07d6080e18fa6d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNzowMDoyOVrOGxczYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNzowMDoyOVrOGxczYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUwNTMxMg==", "bodyText": "Thanks for adding this test @fapifta.", "url": "https://github.com/apache/ozone/pull/1197#discussion_r454505312", "createdAt": "2020-07-14T17:00:29Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/framework/src/test/java/org/apache/hadoop/hdds/utils/db/TestRDBStoreIterator.java", "diffHunk": "@@ -0,0 +1,224 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84eaec1f7c8e12a5f53ddc8a3f07d6080e18fa6d"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94ade5bc13809122f6efac8414d120bc97027d6d", "author": {"user": {"login": "web-flow", "name": "GitHub Web Flow"}}, "url": "https://github.com/apache/ozone/commit/94ade5bc13809122f6efac8414d120bc97027d6d", "committedDate": "2020-07-14T17:04:49Z", "message": "empty commit to retest build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bce3d4935238b0833ece51a465a2d1e84db0742", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/4bce3d4935238b0833ece51a465a2d1e84db0742", "committedDate": "2020-07-14T17:34:04Z", "message": "Trigger a new test run."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01fcec14210280696cc6de8c6992caa7b60c6385", "author": {"user": {"login": "fapifta", "name": "Istvan Fajth"}}, "url": "https://github.com/apache/ozone/commit/01fcec14210280696cc6de8c6992caa7b60c6385", "committedDate": "2020-07-14T17:35:28Z", "message": "Merge branch 'HDDS-3925' of github.com:fapifta/hadoop-ozone into HDDS-3925"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2853, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}