{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyMTg5MzQ5", "number": 963, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwMDo0OToyOFrOD_POtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMjo1NzowNFrOEAEx4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NjM2NDA3OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/keys/CpKeyHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwMDo0OToyOFrOGZybgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwMzoyNzo1MFrOGZz3ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY5MzgyNg==", "bodyText": "Redundant import statements.\nAvoid using * and instead import the specific classes/members needed.", "url": "https://github.com/apache/ozone/pull/963#discussion_r429693826", "createdAt": "2020-05-25T00:49:28Z", "author": {"login": "dineshchitlangia"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/keys/CpKeyHandler.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.shell.keys;\n+\n+import org.apache.hadoop.conf.StorageUnit;\n+import org.apache.hadoop.hdds.client.ReplicationFactor;\n+import org.apache.hadoop.hdds.client.ReplicationType;\n+import org.apache.hadoop.io.IOUtils;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.client.OzoneBucket;\n+import org.apache.hadoop.ozone.client.OzoneClient;\n+import org.apache.hadoop.ozone.client.OzoneClientException;\n+import org.apache.hadoop.ozone.client.OzoneVolume;\n+import org.apache.hadoop.ozone.shell.OzoneAddress;\n+import org.apache.hadoop.ozone.shell.bucket.BucketHandler;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Option;\n+import picocli.CommandLine.Parameters;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.OZONE_SCM_CHUNK_SIZE_DEFAULT;\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.OZONE_SCM_CHUNK_SIZE_KEY;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.*;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.OZONE_REPLICATION_TYPE_DEFAULT;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb6ecb1faa395f8564e83c93c66ee439443e924f"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTcxNzM4Ng==", "bodyText": "Done", "url": "https://github.com/apache/ozone/pull/963#discussion_r429717386", "createdAt": "2020-05-25T03:27:50Z", "author": {"login": "maobaolong"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/keys/CpKeyHandler.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.shell.keys;\n+\n+import org.apache.hadoop.conf.StorageUnit;\n+import org.apache.hadoop.hdds.client.ReplicationFactor;\n+import org.apache.hadoop.hdds.client.ReplicationType;\n+import org.apache.hadoop.io.IOUtils;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.client.OzoneBucket;\n+import org.apache.hadoop.ozone.client.OzoneClient;\n+import org.apache.hadoop.ozone.client.OzoneClientException;\n+import org.apache.hadoop.ozone.client.OzoneVolume;\n+import org.apache.hadoop.ozone.shell.OzoneAddress;\n+import org.apache.hadoop.ozone.shell.bucket.BucketHandler;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Option;\n+import picocli.CommandLine.Parameters;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.OZONE_SCM_CHUNK_SIZE_DEFAULT;\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.OZONE_SCM_CHUNK_SIZE_KEY;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.*;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.OZONE_REPLICATION_TYPE_DEFAULT;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY5MzgyNg=="}, "originalCommit": {"oid": "cb6ecb1faa395f8564e83c93c66ee439443e924f"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NjM2NDc3OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/keys/CpKeyHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwMDo1MDowNlrOGZyb2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwMzoyODowMVrOGZz3sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY5MzkxNQ==", "bodyText": "Can we rename the class to CopyKeyHandler ?", "url": "https://github.com/apache/ozone/pull/963#discussion_r429693915", "createdAt": "2020-05-25T00:50:06Z", "author": {"login": "dineshchitlangia"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/keys/CpKeyHandler.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.shell.keys;\n+\n+import org.apache.hadoop.conf.StorageUnit;\n+import org.apache.hadoop.hdds.client.ReplicationFactor;\n+import org.apache.hadoop.hdds.client.ReplicationType;\n+import org.apache.hadoop.io.IOUtils;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.client.OzoneBucket;\n+import org.apache.hadoop.ozone.client.OzoneClient;\n+import org.apache.hadoop.ozone.client.OzoneClientException;\n+import org.apache.hadoop.ozone.client.OzoneVolume;\n+import org.apache.hadoop.ozone.shell.OzoneAddress;\n+import org.apache.hadoop.ozone.shell.bucket.BucketHandler;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Option;\n+import picocli.CommandLine.Parameters;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.OZONE_SCM_CHUNK_SIZE_DEFAULT;\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.OZONE_SCM_CHUNK_SIZE_KEY;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.*;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.OZONE_REPLICATION_TYPE_DEFAULT;\n+\n+/**\n+ * Copy an existing key to another one.\n+ */\n+@Command(name = \"cp\",\n+    description = \"copies an existing key to another one\")\n+public class CpKeyHandler extends BucketHandler {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb6ecb1faa395f8564e83c93c66ee439443e924f"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTcxNzQyNg==", "bodyText": "Done.", "url": "https://github.com/apache/ozone/pull/963#discussion_r429717426", "createdAt": "2020-05-25T03:28:01Z", "author": {"login": "maobaolong"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/keys/CpKeyHandler.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.shell.keys;\n+\n+import org.apache.hadoop.conf.StorageUnit;\n+import org.apache.hadoop.hdds.client.ReplicationFactor;\n+import org.apache.hadoop.hdds.client.ReplicationType;\n+import org.apache.hadoop.io.IOUtils;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.client.OzoneBucket;\n+import org.apache.hadoop.ozone.client.OzoneClient;\n+import org.apache.hadoop.ozone.client.OzoneClientException;\n+import org.apache.hadoop.ozone.client.OzoneVolume;\n+import org.apache.hadoop.ozone.shell.OzoneAddress;\n+import org.apache.hadoop.ozone.shell.bucket.BucketHandler;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Option;\n+import picocli.CommandLine.Parameters;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.OZONE_SCM_CHUNK_SIZE_DEFAULT;\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.OZONE_SCM_CHUNK_SIZE_KEY;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.*;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.OZONE_REPLICATION_TYPE_DEFAULT;\n+\n+/**\n+ * Copy an existing key to another one.\n+ */\n+@Command(name = \"cp\",\n+    description = \"copies an existing key to another one\")\n+public class CpKeyHandler extends BucketHandler {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY5MzkxNQ=="}, "originalCommit": {"oid": "cb6ecb1faa395f8564e83c93c66ee439443e924f"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NjM3Mzc1OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/keys/CpKeyHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwMTowMDo1NlrOGZygww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwMzoyODoxNlrOGZz38g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY5NTE3MQ==", "bodyText": "Since we are assuming that the copy command is to copy a key in within the same bucket, this GDPR piece of code won't cause any problem.\nCan we pls add comments in the javadoc to state the copy will only for copying keys within the same bucket?\nThis will be a safeguard for users attempting to doing something like:\nozone sh key cp /vol1/bucket1/key1 /vol1/bucket5/newkey", "url": "https://github.com/apache/ozone/pull/963#discussion_r429695171", "createdAt": "2020-05-25T01:00:56Z", "author": {"login": "dineshchitlangia"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/keys/CpKeyHandler.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.shell.keys;\n+\n+import org.apache.hadoop.conf.StorageUnit;\n+import org.apache.hadoop.hdds.client.ReplicationFactor;\n+import org.apache.hadoop.hdds.client.ReplicationType;\n+import org.apache.hadoop.io.IOUtils;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.client.OzoneBucket;\n+import org.apache.hadoop.ozone.client.OzoneClient;\n+import org.apache.hadoop.ozone.client.OzoneClientException;\n+import org.apache.hadoop.ozone.client.OzoneVolume;\n+import org.apache.hadoop.ozone.shell.OzoneAddress;\n+import org.apache.hadoop.ozone.shell.bucket.BucketHandler;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Option;\n+import picocli.CommandLine.Parameters;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.OZONE_SCM_CHUNK_SIZE_DEFAULT;\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.OZONE_SCM_CHUNK_SIZE_KEY;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.*;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.OZONE_REPLICATION_TYPE_DEFAULT;\n+\n+/**\n+ * Copy an existing key to another one.\n+ */\n+@Command(name = \"cp\",\n+    description = \"copies an existing key to another one\")\n+public class CpKeyHandler extends BucketHandler {\n+\n+  @Parameters(index = \"1\", arity = \"1..1\",\n+      description = \"The existing key to be renamed\")\n+  private String fromKey;\n+\n+  @Parameters(index = \"2\", arity = \"1..1\",\n+      description = \"The new desired name of the key\")\n+  private String toKey;\n+\n+  @Option(names = {\"-r\", \"--replication\"},\n+      description = \"Replication factor of the new key. (use ONE or THREE) \"\n+          + \"Default is specified in the cluster-wide config.\")\n+  private ReplicationFactor replicationFactor;\n+\n+  @Option(names = {\"-t\", \"--type\"},\n+      description = \"Replication type of the new key. (use RATIS or \" +\n+          \"STAND_ALONE) Default is specified in the cluster-wide config.\")\n+  private ReplicationType replicationType;\n+\n+  @Override\n+  protected void execute(OzoneClient client, OzoneAddress address)\n+      throws IOException, OzoneClientException {\n+\n+    String volumeName = address.getVolumeName();\n+    String bucketName = address.getBucketName();\n+\n+    OzoneVolume vol = client.getObjectStore().getVolume(volumeName);\n+    OzoneBucket bucket = vol.getBucket(bucketName);\n+\n+    if (replicationFactor == null) {\n+      replicationFactor = ReplicationFactor.valueOf(\n+          getConf().getInt(OZONE_REPLICATION, OZONE_REPLICATION_DEFAULT));\n+    }\n+\n+    if (replicationType == null) {\n+      replicationType = ReplicationType.valueOf(\n+          getConf().get(OZONE_REPLICATION_TYPE,\n+              OZONE_REPLICATION_TYPE_DEFAULT));\n+    }\n+\n+    Map<String, String> keyMetadata = new HashMap<>();\n+    String gdprEnabled = bucket.getMetadata().get(OzoneConsts.GDPR_FLAG);\n+    if (Boolean.parseBoolean(gdprEnabled)) {\n+      keyMetadata.put(OzoneConsts.GDPR_FLAG, Boolean.TRUE.toString());\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb6ecb1faa395f8564e83c93c66ee439443e924f"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTcxNzQ5MA==", "bodyText": "Done.", "url": "https://github.com/apache/ozone/pull/963#discussion_r429717490", "createdAt": "2020-05-25T03:28:16Z", "author": {"login": "maobaolong"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/keys/CpKeyHandler.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.shell.keys;\n+\n+import org.apache.hadoop.conf.StorageUnit;\n+import org.apache.hadoop.hdds.client.ReplicationFactor;\n+import org.apache.hadoop.hdds.client.ReplicationType;\n+import org.apache.hadoop.io.IOUtils;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.client.OzoneBucket;\n+import org.apache.hadoop.ozone.client.OzoneClient;\n+import org.apache.hadoop.ozone.client.OzoneClientException;\n+import org.apache.hadoop.ozone.client.OzoneVolume;\n+import org.apache.hadoop.ozone.shell.OzoneAddress;\n+import org.apache.hadoop.ozone.shell.bucket.BucketHandler;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Option;\n+import picocli.CommandLine.Parameters;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.OZONE_SCM_CHUNK_SIZE_DEFAULT;\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.OZONE_SCM_CHUNK_SIZE_KEY;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.*;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.OZONE_REPLICATION_TYPE_DEFAULT;\n+\n+/**\n+ * Copy an existing key to another one.\n+ */\n+@Command(name = \"cp\",\n+    description = \"copies an existing key to another one\")\n+public class CpKeyHandler extends BucketHandler {\n+\n+  @Parameters(index = \"1\", arity = \"1..1\",\n+      description = \"The existing key to be renamed\")\n+  private String fromKey;\n+\n+  @Parameters(index = \"2\", arity = \"1..1\",\n+      description = \"The new desired name of the key\")\n+  private String toKey;\n+\n+  @Option(names = {\"-r\", \"--replication\"},\n+      description = \"Replication factor of the new key. (use ONE or THREE) \"\n+          + \"Default is specified in the cluster-wide config.\")\n+  private ReplicationFactor replicationFactor;\n+\n+  @Option(names = {\"-t\", \"--type\"},\n+      description = \"Replication type of the new key. (use RATIS or \" +\n+          \"STAND_ALONE) Default is specified in the cluster-wide config.\")\n+  private ReplicationType replicationType;\n+\n+  @Override\n+  protected void execute(OzoneClient client, OzoneAddress address)\n+      throws IOException, OzoneClientException {\n+\n+    String volumeName = address.getVolumeName();\n+    String bucketName = address.getBucketName();\n+\n+    OzoneVolume vol = client.getObjectStore().getVolume(volumeName);\n+    OzoneBucket bucket = vol.getBucket(bucketName);\n+\n+    if (replicationFactor == null) {\n+      replicationFactor = ReplicationFactor.valueOf(\n+          getConf().getInt(OZONE_REPLICATION, OZONE_REPLICATION_DEFAULT));\n+    }\n+\n+    if (replicationType == null) {\n+      replicationType = ReplicationType.valueOf(\n+          getConf().get(OZONE_REPLICATION_TYPE,\n+              OZONE_REPLICATION_TYPE_DEFAULT));\n+    }\n+\n+    Map<String, String> keyMetadata = new HashMap<>();\n+    String gdprEnabled = bucket.getMetadata().get(OzoneConsts.GDPR_FLAG);\n+    if (Boolean.parseBoolean(gdprEnabled)) {\n+      keyMetadata.put(OzoneConsts.GDPR_FLAG, Boolean.TRUE.toString());\n+    }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY5NTE3MQ=="}, "originalCommit": {"oid": "cb6ecb1faa395f8564e83c93c66ee439443e924f"}, "originalPosition": 97}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NjM3Mzc4OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/keys/CpKeyHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwMTowMDo1N1rOGZygxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwMzoyOTowM1rOGZz4YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY5NTE3NA==", "bodyText": "Why is the size hardcoded as 0 ?", "url": "https://github.com/apache/ozone/pull/963#discussion_r429695174", "createdAt": "2020-05-25T01:00:57Z", "author": {"login": "dineshchitlangia"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/keys/CpKeyHandler.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.shell.keys;\n+\n+import org.apache.hadoop.conf.StorageUnit;\n+import org.apache.hadoop.hdds.client.ReplicationFactor;\n+import org.apache.hadoop.hdds.client.ReplicationType;\n+import org.apache.hadoop.io.IOUtils;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.client.OzoneBucket;\n+import org.apache.hadoop.ozone.client.OzoneClient;\n+import org.apache.hadoop.ozone.client.OzoneClientException;\n+import org.apache.hadoop.ozone.client.OzoneVolume;\n+import org.apache.hadoop.ozone.shell.OzoneAddress;\n+import org.apache.hadoop.ozone.shell.bucket.BucketHandler;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Option;\n+import picocli.CommandLine.Parameters;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.OZONE_SCM_CHUNK_SIZE_DEFAULT;\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.OZONE_SCM_CHUNK_SIZE_KEY;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.*;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.OZONE_REPLICATION_TYPE_DEFAULT;\n+\n+/**\n+ * Copy an existing key to another one.\n+ */\n+@Command(name = \"cp\",\n+    description = \"copies an existing key to another one\")\n+public class CpKeyHandler extends BucketHandler {\n+\n+  @Parameters(index = \"1\", arity = \"1..1\",\n+      description = \"The existing key to be renamed\")\n+  private String fromKey;\n+\n+  @Parameters(index = \"2\", arity = \"1..1\",\n+      description = \"The new desired name of the key\")\n+  private String toKey;\n+\n+  @Option(names = {\"-r\", \"--replication\"},\n+      description = \"Replication factor of the new key. (use ONE or THREE) \"\n+          + \"Default is specified in the cluster-wide config.\")\n+  private ReplicationFactor replicationFactor;\n+\n+  @Option(names = {\"-t\", \"--type\"},\n+      description = \"Replication type of the new key. (use RATIS or \" +\n+          \"STAND_ALONE) Default is specified in the cluster-wide config.\")\n+  private ReplicationType replicationType;\n+\n+  @Override\n+  protected void execute(OzoneClient client, OzoneAddress address)\n+      throws IOException, OzoneClientException {\n+\n+    String volumeName = address.getVolumeName();\n+    String bucketName = address.getBucketName();\n+\n+    OzoneVolume vol = client.getObjectStore().getVolume(volumeName);\n+    OzoneBucket bucket = vol.getBucket(bucketName);\n+\n+    if (replicationFactor == null) {\n+      replicationFactor = ReplicationFactor.valueOf(\n+          getConf().getInt(OZONE_REPLICATION, OZONE_REPLICATION_DEFAULT));\n+    }\n+\n+    if (replicationType == null) {\n+      replicationType = ReplicationType.valueOf(\n+          getConf().get(OZONE_REPLICATION_TYPE,\n+              OZONE_REPLICATION_TYPE_DEFAULT));\n+    }\n+\n+    Map<String, String> keyMetadata = new HashMap<>();\n+    String gdprEnabled = bucket.getMetadata().get(OzoneConsts.GDPR_FLAG);\n+    if (Boolean.parseBoolean(gdprEnabled)) {\n+      keyMetadata.put(OzoneConsts.GDPR_FLAG, Boolean.TRUE.toString());\n+    }\n+\n+    int chunkSize = (int) getConf().getStorageSize(OZONE_SCM_CHUNK_SIZE_KEY,\n+        OZONE_SCM_CHUNK_SIZE_DEFAULT, StorageUnit.BYTES);\n+    try (InputStream input = bucket.readKey(fromKey);\n+         OutputStream output = bucket.createKey(toKey, 0,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb6ecb1faa395f8564e83c93c66ee439443e924f"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTcxNzYwMA==", "bodyText": "Sorry, i replace it to the input stream size.", "url": "https://github.com/apache/ozone/pull/963#discussion_r429717600", "createdAt": "2020-05-25T03:29:03Z", "author": {"login": "maobaolong"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/keys/CpKeyHandler.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.shell.keys;\n+\n+import org.apache.hadoop.conf.StorageUnit;\n+import org.apache.hadoop.hdds.client.ReplicationFactor;\n+import org.apache.hadoop.hdds.client.ReplicationType;\n+import org.apache.hadoop.io.IOUtils;\n+import org.apache.hadoop.ozone.OzoneConsts;\n+import org.apache.hadoop.ozone.client.OzoneBucket;\n+import org.apache.hadoop.ozone.client.OzoneClient;\n+import org.apache.hadoop.ozone.client.OzoneClientException;\n+import org.apache.hadoop.ozone.client.OzoneVolume;\n+import org.apache.hadoop.ozone.shell.OzoneAddress;\n+import org.apache.hadoop.ozone.shell.bucket.BucketHandler;\n+import picocli.CommandLine.Command;\n+import picocli.CommandLine.Option;\n+import picocli.CommandLine.Parameters;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.OZONE_SCM_CHUNK_SIZE_DEFAULT;\n+import static org.apache.hadoop.hdds.scm.ScmConfigKeys.OZONE_SCM_CHUNK_SIZE_KEY;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.*;\n+import static org.apache.hadoop.ozone.OzoneConfigKeys.OZONE_REPLICATION_TYPE_DEFAULT;\n+\n+/**\n+ * Copy an existing key to another one.\n+ */\n+@Command(name = \"cp\",\n+    description = \"copies an existing key to another one\")\n+public class CpKeyHandler extends BucketHandler {\n+\n+  @Parameters(index = \"1\", arity = \"1..1\",\n+      description = \"The existing key to be renamed\")\n+  private String fromKey;\n+\n+  @Parameters(index = \"2\", arity = \"1..1\",\n+      description = \"The new desired name of the key\")\n+  private String toKey;\n+\n+  @Option(names = {\"-r\", \"--replication\"},\n+      description = \"Replication factor of the new key. (use ONE or THREE) \"\n+          + \"Default is specified in the cluster-wide config.\")\n+  private ReplicationFactor replicationFactor;\n+\n+  @Option(names = {\"-t\", \"--type\"},\n+      description = \"Replication type of the new key. (use RATIS or \" +\n+          \"STAND_ALONE) Default is specified in the cluster-wide config.\")\n+  private ReplicationType replicationType;\n+\n+  @Override\n+  protected void execute(OzoneClient client, OzoneAddress address)\n+      throws IOException, OzoneClientException {\n+\n+    String volumeName = address.getVolumeName();\n+    String bucketName = address.getBucketName();\n+\n+    OzoneVolume vol = client.getObjectStore().getVolume(volumeName);\n+    OzoneBucket bucket = vol.getBucket(bucketName);\n+\n+    if (replicationFactor == null) {\n+      replicationFactor = ReplicationFactor.valueOf(\n+          getConf().getInt(OZONE_REPLICATION, OZONE_REPLICATION_DEFAULT));\n+    }\n+\n+    if (replicationType == null) {\n+      replicationType = ReplicationType.valueOf(\n+          getConf().get(OZONE_REPLICATION_TYPE,\n+              OZONE_REPLICATION_TYPE_DEFAULT));\n+    }\n+\n+    Map<String, String> keyMetadata = new HashMap<>();\n+    String gdprEnabled = bucket.getMetadata().get(OzoneConsts.GDPR_FLAG);\n+    if (Boolean.parseBoolean(gdprEnabled)) {\n+      keyMetadata.put(OzoneConsts.GDPR_FLAG, Boolean.TRUE.toString());\n+    }\n+\n+    int chunkSize = (int) getConf().getStorageSize(OZONE_SCM_CHUNK_SIZE_KEY,\n+        OZONE_SCM_CHUNK_SIZE_DEFAULT, StorageUnit.BYTES);\n+    try (InputStream input = bucket.readKey(fromKey);\n+         OutputStream output = bucket.createKey(toKey, 0,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY5NTE3NA=="}, "originalCommit": {"oid": "cb6ecb1faa395f8564e83c93c66ee439443e924f"}, "originalPosition": 101}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3NjU4MDMxOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/keys/CopyKeyHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNDoyODowMlrOGZ0bng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwNDoyODowMlrOGZ0bng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTcyNjYyMg==", "bodyText": "Your previous code was fine. The bucket metadata object may have properties that may not be needed for the key. So, if we copy the bucket metadata to be saved as key metadata, that is basically the piece of data which is mostly irrelevant for the key.\nSo you can replace bucket.getMetadata() with keyMetadata.", "url": "https://github.com/apache/ozone/pull/963#discussion_r429726622", "createdAt": "2020-05-25T04:28:02Z", "author": {"login": "dineshchitlangia"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/keys/CopyKeyHandler.java", "diffHunk": "@@ -89,17 +89,11 @@ protected void execute(OzoneClient client, OzoneAddress address)\n               OZONE_REPLICATION_TYPE_DEFAULT));\n     }\n \n-    Map<String, String> keyMetadata = new HashMap<>();\n-    String gdprEnabled = bucket.getMetadata().get(OzoneConsts.GDPR_FLAG);\n-    if (Boolean.parseBoolean(gdprEnabled)) {\n-      keyMetadata.put(OzoneConsts.GDPR_FLAG, Boolean.TRUE.toString());\n-    }\n-\n     int chunkSize = (int) getConf().getStorageSize(OZONE_SCM_CHUNK_SIZE_KEY,\n         OZONE_SCM_CHUNK_SIZE_DEFAULT, StorageUnit.BYTES);\n     try (InputStream input = bucket.readKey(fromKey);\n-         OutputStream output = bucket.createKey(toKey, 0,\n-             replicationType, replicationFactor, keyMetadata)) {\n+         OutputStream output = bucket.createKey(toKey, input.available(),\n+             replicationType, replicationFactor, bucket.getMetadata())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc292969e79e9a8d865dbbed1e643c27eadf43fd"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NDkyODExOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/dist/src/main/smoketest/basic/ozone-shell.robot", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMTo1ODoyMFrOGbF6NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMTo1ODoyMFrOGbF6NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA2MTU1Nw==", "bodyText": "cp requires bucket URI and key names to be supplied separately:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                Execute             ozone sh key cp ${protocol}${server}/${volume}/bb1/key1 ${protocol}${server}/${volume}/bb1/key1-copy\n          \n          \n            \n                                Execute             ozone sh key cp ${protocol}${server}/${volume}/bb1 key1 key1-copy", "url": "https://github.com/apache/ozone/pull/963#discussion_r431061557", "createdAt": "2020-05-27T11:58:20Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/dist/src/main/smoketest/basic/ozone-shell.robot", "diffHunk": "@@ -114,6 +114,10 @@ Test key handling\n                     Execute             rm -f /tmp/NOTICE.txt.1\n                     Execute             ozone sh key get ${protocol}${server}/${volume}/bb1/key1 /tmp/NOTICE.txt.1\n                     Execute             diff -q /opt/hadoop/NOTICE.txt /tmp/NOTICE.txt.1\n+                    Execute             ozone sh key cp ${protocol}${server}/${volume}/bb1/key1 ${protocol}${server}/${volume}/bb1/key1-copy", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7768690f1570931deb8b1a5f66e53d6163b6bfe9"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NTEzNzYzOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/keys/CopyKeyHandler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMjo1NzowNFrOGbH_zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMzo1NjoxNlrOGbLZFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA5NTc1OA==", "bodyText": "One more thing: I think instead of building key metadata from scratch, cp should copy actual metadata of the existing key, which it can get via OzoneKeyDetails (except GDPR_SECRET and GDPR_ALGORITHM should be removed).  This would ensure that any user-supplied custom metadata is transferred, as well as reduce the need for future changes in case new default metadata is added in PutKeyHandler.", "url": "https://github.com/apache/ozone/pull/963#discussion_r431095758", "createdAt": "2020-05-27T12:57:04Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/keys/CopyKeyHandler.java", "diffHunk": "@@ -89,11 +92,17 @@ protected void execute(OzoneClient client, OzoneAddress address)\n               OZONE_REPLICATION_TYPE_DEFAULT));\n     }\n \n+    Map<String, String> keyMetadata = new HashMap<>();\n+    String gdprEnabled = bucket.getMetadata().get(OzoneConsts.GDPR_FLAG);\n+    if (Boolean.parseBoolean(gdprEnabled)) {\n+      keyMetadata.put(OzoneConsts.GDPR_FLAG, Boolean.TRUE.toString());\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7768690f1570931deb8b1a5f66e53d6163b6bfe9"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE1MTM4MQ==", "bodyText": "Thank you for your advice, done.", "url": "https://github.com/apache/ozone/pull/963#discussion_r431151381", "createdAt": "2020-05-27T13:56:16Z", "author": {"login": "maobaolong"}, "path": "hadoop-ozone/tools/src/main/java/org/apache/hadoop/ozone/shell/keys/CopyKeyHandler.java", "diffHunk": "@@ -89,11 +92,17 @@ protected void execute(OzoneClient client, OzoneAddress address)\n               OZONE_REPLICATION_TYPE_DEFAULT));\n     }\n \n+    Map<String, String> keyMetadata = new HashMap<>();\n+    String gdprEnabled = bucket.getMetadata().get(OzoneConsts.GDPR_FLAG);\n+    if (Boolean.parseBoolean(gdprEnabled)) {\n+      keyMetadata.put(OzoneConsts.GDPR_FLAG, Boolean.TRUE.toString());\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTA5NTc1OA=="}, "originalCommit": {"oid": "7768690f1570931deb8b1a5f66e53d6163b6bfe9"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4336, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}