{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyMzA1MTY5", "number": 1723, "title": "HDDS-4588. If volume's quota is enabled then bucket's quota cannot be cleared", "bodyText": "What changes were proposed in this pull request?\nIf volume's quota is enabled then bucket's quota cannot be cleared. We need to prompt the user to clear volume quota first.\nFor more details.\nTo prevent conflicts, I have updated the usage and behavior of clear space quota in #1677.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4588\nHow was this patch tested?\nut added", "createdAt": "2020-12-18T05:53:46Z", "url": "https://github.com/apache/ozone/pull/1723", "merged": true, "mergeCommit": {"oid": "2e4caa26a5ccf61e140dac24f6c99498865134cd"}, "closed": true, "closedAt": "2020-12-29T09:56:51Z", "author": {"login": "captainzmc"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnTwhygBqjQxMjg2NTAxMTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdqgHIEABqjQxNTExMTgzNzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f22893d5700f90853bd5db1f19cc41823999dcac", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/f22893d5700f90853bd5db1f19cc41823999dcac", "committedDate": "2020-12-18T07:01:38Z", "message": "fix ut."}, "afterCommit": {"oid": "415023fae4fa235474afd0c419336aff9e94452f", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/415023fae4fa235474afd0c419336aff9e94452f", "committedDate": "2020-12-18T08:19:22Z", "message": "fix clear bucket quota."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "abdbfbe42277f2992eeedc8f05b44ebf9a7ce892", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/abdbfbe42277f2992eeedc8f05b44ebf9a7ce892", "committedDate": "2020-12-18T08:41:19Z", "message": "fix ci"}, "afterCommit": {"oid": "331219c104a833d4d5b7207097789e4d40250c0c", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/331219c104a833d4d5b7207097789e4d40250c0c", "committedDate": "2020-12-18T12:50:24Z", "message": "fix ci"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1OTE1NTkz", "url": "https://github.com/apache/ozone/pull/1723#pullrequestreview-555915593", "createdAt": "2020-12-19T04:32:24Z", "commit": {"oid": "331219c104a833d4d5b7207097789e4d40250c0c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOVQwNDozMjoyNVrOII4yYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOVQwNDozMjo0OVrOII4yhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE4OTkyMA==", "bodyText": "Nit: will it better to use more descriptive names than variable names. For example, replace quotaInBytes by space quota?", "url": "https://github.com/apache/ozone/pull/1723#discussion_r546189920", "createdAt": "2020-12-19T04:32:25Z", "author": {"login": "amaliujia"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java", "diffHunk": "@@ -228,6 +228,13 @@ public boolean checkQuotaBytesValid(OMMetadataManager metadataManager,\n       throws IOException {\n     long quotaInBytes = omBucketArgs.getQuotaInBytes();\n \n+    if (quotaInBytes == OzoneConsts.QUOTA_RESET &&\n+        omVolumeArgs.getQuotaInBytes() != OzoneConsts.QUOTA_RESET) {\n+      throw new OMException(\"Before clear bucket quotaInBytes,\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "331219c104a833d4d5b7207097789e4d40250c0c"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE4OTk1OQ==", "bodyText": "Nit: same, maybe replace quotaInNamespace by namespace quota?", "url": "https://github.com/apache/ozone/pull/1723#discussion_r546189959", "createdAt": "2020-12-19T04:32:49Z", "author": {"login": "amaliujia"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java", "diffHunk": "@@ -259,9 +266,16 @@ public boolean checkQuotaBytesValid(OMMetadataManager metadataManager,\n   }\n \n   public boolean checkQuotaNamespaceValid(OmVolumeArgs omVolumeArgs,\n-      OmBucketArgs omBucketArgs) {\n+      OmBucketArgs omBucketArgs) throws IOException{\n     long quotaInNamespace = omBucketArgs.getQuotaInNamespace();\n \n+    if (quotaInNamespace == OzoneConsts.QUOTA_RESET &&\n+        omVolumeArgs.getQuotaInNamespace() != OzoneConsts.QUOTA_RESET) {\n+      throw new OMException(\"Before clear bucket \" +\n+          \"quotaInNamespace, volume quotaInNamespace need to be clear first.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "331219c104a833d4d5b7207097789e4d40250c0c"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1OTMzNzI5", "url": "https://github.com/apache/ozone/pull/1723#pullrequestreview-555933729", "createdAt": "2020-12-19T10:53:01Z", "commit": {"oid": "331219c104a833d4d5b7207097789e4d40250c0c"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2ODM0OTk0", "url": "https://github.com/apache/ozone/pull/1723#pullrequestreview-556834994", "createdAt": "2020-12-22T05:52:44Z", "commit": {"oid": "331219c104a833d4d5b7207097789e4d40250c0c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwNTo1Mjo0NFrOIJvQzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwNTo1Njo1MlrOIJvV8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA4MjQ0NA==", "bodyText": "Can try something like this -\n  LambdaTestUtils.intercept(IOException.class, \"Before clear bucket \"\n            + \"quotaInBytes, volume quotaInBytes need to be clear first.\",\n        () -> ozoneBucket.clearSpaceQuota());\n\nShall save lines and looks better", "url": "https://github.com/apache/ozone/pull/1723#discussion_r547082444", "createdAt": "2020-12-22T05:52:44Z", "author": {"login": "ayushtkn"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java", "diffHunk": "@@ -311,6 +311,23 @@ public void testSetAndClrQuota() throws IOException {\n         ozoneBucket.getQuotaInBytes());\n     Assert.assertEquals(1000L, ozoneBucket.getQuotaInNamespace());\n \n+    try {\n+      ozoneBucket.clearSpaceQuota();\n+      Assert.fail(\"clear quota should be failed\");\n+    } catch (IOException ex) {\n+      GenericTestUtils.assertExceptionContains(\"Before clear bucket \" +\n+          \"quotaInBytes, volume quotaInBytes need to be clear first.\", ex);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "331219c104a833d4d5b7207097789e4d40250c0c"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA4MjYzOA==", "bodyText": "Similarly here -\n    LambdaTestUtils.intercept(IOException.class, \"Before clear bucket \"\n            + \"quotaInNamespace, volume quotaInNamespace need to be clear first.\",\n        () -> ozoneBucket.clearCountQuota());", "url": "https://github.com/apache/ozone/pull/1723#discussion_r547082638", "createdAt": "2020-12-22T05:53:20Z", "author": {"login": "ayushtkn"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestOzoneRpcClientAbstract.java", "diffHunk": "@@ -311,6 +311,23 @@ public void testSetAndClrQuota() throws IOException {\n         ozoneBucket.getQuotaInBytes());\n     Assert.assertEquals(1000L, ozoneBucket.getQuotaInNamespace());\n \n+    try {\n+      ozoneBucket.clearSpaceQuota();\n+      Assert.fail(\"clear quota should be failed\");\n+    } catch (IOException ex) {\n+      GenericTestUtils.assertExceptionContains(\"Before clear bucket \" +\n+          \"quotaInBytes, volume quotaInBytes need to be clear first.\", ex);\n+    }\n+\n+    try {\n+      ozoneBucket.clearCountQuota();\n+      Assert.fail(\"clear quota should be failed\");\n+    } catch (IOException ex) {\n+      GenericTestUtils.assertExceptionContains(\"Before clear bucket \" +\n+          \"quotaInNamespace, volume quotaInNamespace need to be clear first.\",\n+          ex);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "331219c104a833d4d5b7207097789e4d40250c0c"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA4Mzc2MQ==", "bodyText": "Seems some grammatical  error in the message, Can you check and reframe if possible,\nMay be something like a warning, Can not clear bucket namespace quota because volume namespace quota is not unset. Or may be something better....", "url": "https://github.com/apache/ozone/pull/1723#discussion_r547083761", "createdAt": "2020-12-22T05:56:52Z", "author": {"login": "ayushtkn"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/bucket/OMBucketSetPropertyRequest.java", "diffHunk": "@@ -259,9 +266,16 @@ public boolean checkQuotaBytesValid(OMMetadataManager metadataManager,\n   }\n \n   public boolean checkQuotaNamespaceValid(OmVolumeArgs omVolumeArgs,\n-      OmBucketArgs omBucketArgs) {\n+      OmBucketArgs omBucketArgs) throws IOException{\n     long quotaInNamespace = omBucketArgs.getQuotaInNamespace();\n \n+    if (quotaInNamespace == OzoneConsts.QUOTA_RESET &&\n+        omVolumeArgs.getQuotaInNamespace() != OzoneConsts.QUOTA_RESET) {\n+      throw new OMException(\"Before clear bucket \" +\n+          \"quotaInNamespace, volume quotaInNamespace need to be clear first.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "331219c104a833d4d5b7207097789e4d40250c0c"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4ODU0ODAx", "url": "https://github.com/apache/ozone/pull/1723#pullrequestreview-558854801", "createdAt": "2020-12-26T09:21:40Z", "commit": {"oid": "dcf44ffbf3b65bbeb40de67bf7240a22abf6afcb"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MDAwODI1", "url": "https://github.com/apache/ozone/pull/1723#pullrequestreview-559000825", "createdAt": "2020-12-28T05:28:04Z", "commit": {"oid": "dcf44ffbf3b65bbeb40de67bf7240a22abf6afcb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba7d0fc0de999d858a83794e7bb86fa26a10ac38", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/ba7d0fc0de999d858a83794e7bb86fa26a10ac38", "committedDate": "2020-12-28T06:18:23Z", "message": "fix clear bucket quota."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f71cdb471940440053abb791fae74abf9dbfe390", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/f71cdb471940440053abb791fae74abf9dbfe390", "committedDate": "2020-12-28T06:18:23Z", "message": "fix style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4847f7145ad004facd01044a3de8f448dc0ac324", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/4847f7145ad004facd01044a3de8f448dc0ac324", "committedDate": "2020-12-28T06:18:23Z", "message": "fix ci"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48c29cf17f1d4eb7f13c901829ff336e26103822", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/48c29cf17f1d4eb7f13c901829ff336e26103822", "committedDate": "2020-12-28T06:18:23Z", "message": "fix review issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec5984e677356e0f4866c4565be4ed2c89863126", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/ec5984e677356e0f4866c4565be4ed2c89863126", "committedDate": "2020-12-28T06:22:54Z", "message": "rebae and fix namespace."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dcf44ffbf3b65bbeb40de67bf7240a22abf6afcb", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/dcf44ffbf3b65bbeb40de67bf7240a22abf6afcb", "committedDate": "2020-12-22T09:47:32Z", "message": "fix review issues"}, "afterCommit": {"oid": "ec5984e677356e0f4866c4565be4ed2c89863126", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/ec5984e677356e0f4866c4565be4ed2c89863126", "committedDate": "2020-12-28T06:22:54Z", "message": "rebae and fix namespace."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1884, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}