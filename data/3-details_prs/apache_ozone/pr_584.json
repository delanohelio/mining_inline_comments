{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4NTY0MDA2", "number": 584, "title": "HDDS-3054. OzoneFileStatus#getModificationTime should return actual directory modification time when its OmKeyInfo is available", "bodyText": "What changes were proposed in this pull request?\nAs of current implementation, getModificationTime() always returns \"fake\" modification time (current time) for directory due to the reason that a directory in Ozone might be faked from a file key.\nBut, there are cases where real directory key exists in OzoneBucket. For example when user calls fs.mkdirs(directory). In this case, a reasonable thing to do would be getting the modification time from the OmInfoKey, rather than faking it.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3054\nHow was this patch tested?\nSo far passed manual test.\nWill add a integration test case later.", "createdAt": "2020-02-22T07:47:00Z", "url": "https://github.com/apache/ozone/pull/584", "merged": true, "mergeCommit": {"oid": "cc168444d52e0d690ff1d51351e5cfebc388c953"}, "closed": true, "closedAt": "2020-02-28T21:41:02Z", "author": {"login": "smengcl"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGu3PgAH2gAyMzc4NTY0MDA2OjlkM2NjNjI5ZGJjZGU1NTJiNTNmNDE0YTRjNGI2YzQ0YmM2MWI4NGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIRQHgAH2gAyMzc4NTY0MDA2OmFjZjUzMTIwOTNjMWQxNzY2Yzk5YzhhNWQxOTIyYzQzZjZjODVkNzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9d3cc629dbcde552b53f414a4c4b6c44bc61b84b", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/9d3cc629dbcde552b53f414a4c4b6c44bc61b84b", "committedDate": "2020-02-22T07:05:36Z", "message": "getModificationTime: Only return current time for directory when `super.getModificationTime` return 0 (implies client actually doesn't get this info from OM)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed8d758a016b97e85dad488b82c1b026a2fccc69", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/ed8d758a016b97e85dad488b82c1b026a2fccc69", "committedDate": "2020-02-22T07:43:18Z", "message": "KeyManagerImpl#listStatus: if the dir OmKeyInfo exists, use it."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d18281e31e2ffa1c03db5229bdd54c8fdbebd22", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/9d18281e31e2ffa1c03db5229bdd54c8fdbebd22", "committedDate": "2020-02-22T08:03:36Z", "message": "(Forced to) Refactor KeyManagerImpl#listStatusFindKeyInTableCache a bit due to checkstyle method 150 lines length limit exceeded."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cac75a3078d58467731c524b77e3ff1cfe337198", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/cac75a3078d58467731c524b77e3ff1cfe337198", "committedDate": "2020-02-22T08:17:42Z", "message": "Retrigger test. TestRDBStore#testRocksDBKeyMayExistApi passed on my forked repo's run: https://github.com/smengcl/hadoop-ozone/runs/461774268"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22d58b4f336da0c5a5b8796c77d084d6eed140eb", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/22d58b4f336da0c5a5b8796c77d084d6eed140eb", "committedDate": "2020-02-22T09:09:03Z", "message": "Fix existing test TestOzoneFileInterfaces#testOzoneManagerFileSystemInterface."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7d88eeba5f5a95e38bec2541216fd8f9bbf057d", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/e7d88eeba5f5a95e38bec2541216fd8f9bbf057d", "committedDate": "2020-02-22T09:10:46Z", "message": "Add unit test testGetDirectoryModificationTime."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNzI5MTg3", "url": "https://github.com/apache/ozone/pull/584#pullrequestreview-363729187", "createdAt": "2020-02-24T21:54:42Z", "commit": {"oid": "e7d88eeba5f5a95e38bec2541216fd8f9bbf057d"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMTo1NDo0MlrOFtxSig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxODoxMDoyNFrOFuPoXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUzNzgwMg==", "bodyText": "Can we add a small sleep (maybe 100-200 ms) between each check.", "url": "https://github.com/apache/ozone/pull/584#discussion_r383537802", "createdAt": "2020-02-24T21:54:42Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/fs/ozone/TestOzoneFileSystem.java", "diffHunk": "@@ -354,4 +356,45 @@ private OzoneKeyDetails getKey(Path keyPath, boolean isDirectory)\n   private void assertKeyNotFoundException(IOException ex) {\n     GenericTestUtils.assertExceptionContains(\"KEY_NOT_FOUND\", ex);\n   }\n+\n+  private void testGetDirectoryModificationTime() throws IOException {\n+    Path mdir1 = new Path(\"/mdir1\");\n+    Path mdir11 = new Path(mdir1, \"mdir11\");\n+    Path mdir111 = new Path(mdir11, \"mdir111\");\n+    fs.mkdirs(mdir111);\n+    rootItemCount++; // mdir1\n+\n+    // Case 1: Dir key exist on server\n+    FileStatus[] fileStatuses = o3fs.listStatus(mdir11);\n+    // Above listStatus result should only have one entry: mdir111\n+    assertEquals(1, fileStatuses.length);\n+    assertEquals(mdir111.toString(),\n+        fileStatuses[0].getPath().toUri().getPath());\n+    assertTrue(fileStatuses[0].isDirectory());\n+    // The dir key is actually created on server,\n+    // so modification time should always be the same value.\n+    long modificationTime = fileStatuses[0].getModificationTime();\n+    // Check modification time in a small loop, it should always be the same\n+    for (int i = 0; i < 5; i++) {\n+      fileStatuses = o3fs.listStatus(mdir11);\n+      assertEquals(modificationTime, fileStatuses[0].getModificationTime());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7d88eeba5f5a95e38bec2541216fd8f9bbf057d"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUzODI0Ng==", "bodyText": "Let's add a sleep here too.", "url": "https://github.com/apache/ozone/pull/584#discussion_r383538246", "createdAt": "2020-02-24T21:55:36Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/fs/ozone/TestOzoneFileSystem.java", "diffHunk": "@@ -354,4 +356,45 @@ private OzoneKeyDetails getKey(Path keyPath, boolean isDirectory)\n   private void assertKeyNotFoundException(IOException ex) {\n     GenericTestUtils.assertExceptionContains(\"KEY_NOT_FOUND\", ex);\n   }\n+\n+  private void testGetDirectoryModificationTime() throws IOException {\n+    Path mdir1 = new Path(\"/mdir1\");\n+    Path mdir11 = new Path(mdir1, \"mdir11\");\n+    Path mdir111 = new Path(mdir11, \"mdir111\");\n+    fs.mkdirs(mdir111);\n+    rootItemCount++; // mdir1\n+\n+    // Case 1: Dir key exist on server\n+    FileStatus[] fileStatuses = o3fs.listStatus(mdir11);\n+    // Above listStatus result should only have one entry: mdir111\n+    assertEquals(1, fileStatuses.length);\n+    assertEquals(mdir111.toString(),\n+        fileStatuses[0].getPath().toUri().getPath());\n+    assertTrue(fileStatuses[0].isDirectory());\n+    // The dir key is actually created on server,\n+    // so modification time should always be the same value.\n+    long modificationTime = fileStatuses[0].getModificationTime();\n+    // Check modification time in a small loop, it should always be the same\n+    for (int i = 0; i < 5; i++) {\n+      fileStatuses = o3fs.listStatus(mdir11);\n+      assertEquals(modificationTime, fileStatuses[0].getModificationTime());\n+    }\n+\n+    // Case 2: Dir key doesn't exist on server\n+    fileStatuses = o3fs.listStatus(mdir1);\n+    // Above listStatus result should only have one entry: mdir11\n+    assertEquals(1, fileStatuses.length);\n+    assertEquals(mdir11.toString(),\n+        fileStatuses[0].getPath().toUri().getPath());\n+    assertTrue(fileStatuses[0].isDirectory());\n+    // Since the dir key doesn't exist on server, the modification time is\n+    // set to current time upon every listStatus request.\n+    modificationTime = fileStatuses[0].getModificationTime();\n+    // Check modification time in a small loop, it should be slightly larger\n+    // each time\n+    for (int i = 0; i < 5; i++) {\n+      fileStatuses = o3fs.listStatus(mdir1);\n+      assertTrue(modificationTime <= fileStatuses[0].getModificationTime());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7d88eeba5f5a95e38bec2541216fd8f9bbf057d"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDAzNDkwOA==", "bodyText": "Could you please explain this change.", "url": "https://github.com/apache/ozone/pull/584#discussion_r384034908", "createdAt": "2020-02-25T18:10:24Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java", "diffHunk": "@@ -2005,15 +2016,21 @@ public OmKeyInfo lookupFile(OmKeyArgs args, String clientAddress)\n               if (isFile) {\n                 if (!deletedKeySet.contains(entryInDb)) {\n                   cacheKeyMap.put(entryInDb,\n-                      new OzoneFileStatus(value, scmBlockSize, !isFile));\n+                      new OzoneFileStatus(omKeyInfo, scmBlockSize, !isFile));\n                   countEntries++;\n                 }\n                 iterator.next();\n               } else {\n                 // if entry is a directory\n                 if (!deletedKeySet.contains(entryInDb)) {\n-                  cacheKeyMap.put(entryInDb,\n-                      new OzoneFileStatus(immediateChild));\n+                  if (!entryKeyName.equals(immediateChild)) {\n+                    cacheKeyMap.put(entryInDb,\n+                        new OzoneFileStatus(immediateChild));\n+                  } else {\n+                    // If entryKeyName matches dir name, we have the info\n+                    cacheKeyMap.put(entryInDb,\n+                        new OzoneFileStatus(omKeyInfo, 0, true));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7d88eeba5f5a95e38bec2541216fd8f9bbf057d"}, "originalPosition": 120}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c9dea7edaf1eb435a98126e1fc874f3ffd6e963", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/1c9dea7edaf1eb435a98126e1fc874f3ffd6e963", "committedDate": "2020-02-27T00:55:01Z", "message": "Add 10ms sleep in check loop."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acf5312093c1d1766c99c8a5d1922c43f6c85d77", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/acf5312093c1d1766c99c8a5d1922c43f6c85d77", "committedDate": "2020-02-27T01:43:28Z", "message": "Throw InterruptedException in test to make compiler happy."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3605, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}