{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwMTM2MjYx", "number": 691, "title": "HDDS-3226. Tracing Ozone Manager DB write batch operations.", "bodyText": "What changes were proposed in this pull request?\nCurrently the OM DB write is asynchronously handled in OzoneManagerDoubleBuffer. But the OM response does not have traceID properly populated. As a result, we can't get insight for the DB part of the OM request handling.\nThis ticket is opened to add traceID properly so that the addBatch and commitBatch cost of the request can be shown up in properly in Opentracing/Jaeger.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3226\nHow was this patch tested?\ndocker-compose with jaeger\nozone freon ockg -n100\nozone freon rk --factor=THREE --replicationType=RATIS --numOfVolumes=10 --numOfBuckets=10 --numOfKeys=5 --keySize=512", "createdAt": "2020-03-17T23:48:03Z", "url": "https://github.com/apache/ozone/pull/691", "merged": true, "mergeCommit": {"oid": "946cca5c853231fb2494c42e096d0a668274b96d"}, "closed": true, "closedAt": "2020-05-07T00:15:31Z", "author": {"login": "xiaoyuyao"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUB67JAFqTM4NzMxNjk5NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABceNkRuAH2gAyMzkwMTM2MjYxOjg2ZDYyMDc0YzJkYWIyMmZlNTY3NDNhOTlhMjIzOTZhN2VkMTA1MzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MzE2OTk1", "url": "https://github.com/apache/ozone/pull/691#pullrequestreview-387316995", "createdAt": "2020-04-03T14:38:50Z", "commit": {"oid": "4285520c082e5ef66dc3489aba397575ce5fb821"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3ODAyNDY5", "url": "https://github.com/apache/ozone/pull/691#pullrequestreview-397802469", "createdAt": "2020-04-22T02:37:08Z", "commit": {"oid": "4285520c082e5ef66dc3489aba397575ce5fb821"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjozNzowOFrOGJgqgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjozNzowOFrOGJgqgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYyNTUzNg==", "bodyText": "AtomicReference Do we need atomic here? As this is just used in a single thread.", "url": "https://github.com/apache/ozone/pull/691#discussion_r412625536", "createdAt": "2020-04-22T02:37:08Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerDoubleBuffer.java", "diffHunk": "@@ -135,10 +138,20 @@ private void flushTransactions() {\n           try(BatchOperation batchOperation = omMetadataManager.getStore()\n               .initBatchOperation()) {\n \n+            AtomicReference<String> lastTraceId = new AtomicReference<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4285520c082e5ef66dc3489aba397575ce5fb821"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3ODA1NjIw", "url": "https://github.com/apache/ozone/pull/691#pullrequestreview-397805620", "createdAt": "2020-04-22T02:47:51Z", "commit": {"oid": "4285520c082e5ef66dc3489aba397575ce5fb821"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjo0Nzo1MVrOGJg37w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwMjo0Nzo1MVrOGJg37w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjYyODk3NQ==", "bodyText": "One more question, here for DB commit Batch we are using last trace id, so DB Batch commit span will be linked with the last operation in the queue?", "url": "https://github.com/apache/ozone/pull/691#discussion_r412628975", "createdAt": "2020-04-22T02:47:51Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerDoubleBuffer.java", "diffHunk": "@@ -147,7 +160,11 @@ private void flushTransactions() {\n             });\n \n             long startTime = Time.monotonicNowNanos();\n-            omMetadataManager.getStore().commitBatchOperation(batchOperation);\n+            try (Scope s2 = TracingUtil.importAndCreateScope(\n+                \"DB-commitWriteBatch\", lastTraceId.get())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4285520c082e5ef66dc3489aba397575ce5fb821"}, "originalPosition": 42}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4285520c082e5ef66dc3489aba397575ce5fb821", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/4285520c082e5ef66dc3489aba397575ce5fb821", "committedDate": "2020-03-17T23:45:30Z", "message": "HDDS-3226. Tracing Ozone Manager DB write batch operations."}, "afterCommit": {"oid": "45277a16db46fd28d634eb3d6b639911670e470f", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/45277a16db46fd28d634eb3d6b639911670e470f", "committedDate": "2020-05-05T00:34:38Z", "message": "Refactor to honor hdds.tracing.enabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a58ffcfd75aa4bc86dc74422c36d04fb529b8fb9", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/a58ffcfd75aa4bc86dc74422c36d04fb529b8fb9", "committedDate": "2020-05-05T03:09:30Z", "message": "HDDS-3226. Tracing Ozone Manager DB write batch operations."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3d9df760db96f24d815b9191ed9102562013298", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/a3d9df760db96f24d815b9191ed9102562013298", "committedDate": "2020-05-05T03:09:30Z", "message": "fix after HDDS-3399."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db826d786fd129d25855aa46715234be8764ca27", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/db826d786fd129d25855aa46715234be8764ca27", "committedDate": "2020-05-05T03:09:30Z", "message": "Refactor to honor hdds.tracing.enabled"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "45277a16db46fd28d634eb3d6b639911670e470f", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/45277a16db46fd28d634eb3d6b639911670e470f", "committedDate": "2020-05-05T00:34:38Z", "message": "Refactor to honor hdds.tracing.enabled"}, "afterCommit": {"oid": "db826d786fd129d25855aa46715234be8764ca27", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/db826d786fd129d25855aa46715234be8764ca27", "committedDate": "2020-05-05T03:09:30Z", "message": "Refactor to honor hdds.tracing.enabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b865455bc7b3b35b89733d3b61a192d163c6ee34", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/b865455bc7b3b35b89733d3b61a192d163c6ee34", "committedDate": "2020-05-05T03:30:27Z", "message": "clean up TracingUtil usage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ae13c85adb90f7cf3d593ce494497f8e471f98c", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/0ae13c85adb90f7cf3d593ce494497f8e471f98c", "committedDate": "2020-05-05T04:39:41Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86d62074c2dab22fe56743a99a22396a7ed10534", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/86d62074c2dab22fe56743a99a22396a7ed10534", "committedDate": "2020-05-05T05:52:12Z", "message": "Fix unit test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3491, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}