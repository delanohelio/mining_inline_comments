{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5MjI0NjU3", "number": 510, "title": "HDDS-2958. Handle replay of OM Volume ACL requests", "bodyText": "What changes were proposed in this pull request?\nTo ensure that volume acl operations are idempotent, compare the transactionID with the objectID and updateID to make sure that the transaction is not a replay. If the transactionID <= updateID, then it implies that the transaction is a replay and hence it should be skipped.\nOMVolumeAclRequests (Add, Remove and Set ACL requests) are made idempotent in this Jira.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-2958\nHow was this patch tested?\nUnit test added.", "createdAt": "2020-01-30T18:35:34Z", "url": "https://github.com/apache/ozone/pull/510", "merged": true, "mergeCommit": {"oid": "c654a83693ab7abdfee7714c7cdc8ee808cb4e4e"}, "closed": true, "closedAt": "2020-02-10T23:04:49Z", "author": {"login": "hanishakoneru"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_pXKfAFqTM1MTMxNjkwNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDDyiLABqjMwMjQzODU4ODQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMzE2OTA0", "url": "https://github.com/apache/ozone/pull/510#pullrequestreview-351316904", "createdAt": "2020-01-31T06:43:34Z", "commit": {"oid": "b7f1f51fb225dc8526b9d9cc8e927069cb5e7b64"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwNjo0MzozNFrOFkCmYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwNjo0MzozNFrOFkCmYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMzNTY0OQ==", "bodyText": "Now no use of exception here. Unused param", "url": "https://github.com/apache/ozone/pull/510#discussion_r373335649", "createdAt": "2020-01-31T06:43:34Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/acl/OMVolumeSetAclRequest.java", "diffHunk": "@@ -80,29 +80,36 @@ public String getVolumeName() {\n \n   @Override\n   OMClientResponse onSuccess(OMResponse.Builder omResponse,\n-      OmVolumeArgs omVolumeArgs, boolean result){\n+      OmVolumeArgs omVolumeArgs, boolean aclApplied){\n     omResponse.setSetAclResponse(OzoneManagerProtocolProtos.SetAclResponse\n-        .newBuilder().setResponse(result).build());\n-    return new OMVolumeAclOpResponse(omVolumeArgs, omResponse.build());\n+        .newBuilder().setResponse(aclApplied).build());\n+    return new OMVolumeAclOpResponse(omResponse.build(), omVolumeArgs);\n   }\n \n   @Override\n   OMClientResponse onFailure(OMResponse.Builder omResponse,\n       IOException ex) {\n-    return new OMVolumeAclOpResponse(null,\n-        createErrorOMResponse(omResponse, ex));\n+    return new OMVolumeAclOpResponse(createErrorOMResponse(omResponse, ex));\n   }\n \n   @Override\n-  void onComplete(IOException ex) {\n-    if (ex == null) {\n-      if (LOG.isDebugEnabled()) {\n-        LOG.debug(\"Set acls: {} to volume: {} success!\",\n-            getAcls(), getVolumeName());\n-      }\n-    } else {\n-      LOG.error(\"Set acls {} to volume {} failed!\",\n-          getAcls(), getVolumeName(), ex);\n+  void onComplete(Result result, IOException ex, long trxnLogIndex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7f1f51fb225dc8526b9d9cc8e927069cb5e7b64"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMzE4MTEy", "url": "https://github.com/apache/ozone/pull/510#pullrequestreview-351318112", "createdAt": "2020-01-31T06:47:53Z", "commit": {"oid": "b7f1f51fb225dc8526b9d9cc8e927069cb5e7b64"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwNjo0Nzo1M1rOFkCqFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwNjo0Nzo1M1rOFkCqFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMzNjU5OA==", "bodyText": "We need to set updateID even in the case of applyAcl false.\nScenario:\n\nAdd Acl T1\nAdd existing Acl T2\n\nNow replay T2 it will not be considered as replay as updateID will be still 1.", "url": "https://github.com/apache/ozone/pull/510#discussion_r373336598", "createdAt": "2020-01-31T06:47:53Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/acl/OMVolumeAclRequest.java", "diffHunk": "@@ -73,53 +74,71 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n \n     OMMetadataManager omMetadataManager = ozoneManager.getMetadataManager();\n     boolean lockAcquired = false;\n+    Result result = null;\n     try {\n       // check Acl\n       if (ozoneManager.getAclsEnabled()) {\n         checkAcls(ozoneManager, OzoneObj.ResourceType.VOLUME,\n             OzoneObj.StoreType.OZONE, IAccessAuthorizer.ACLType.WRITE_ACL,\n             volume, null, null);\n       }\n-      lockAcquired =\n-          omMetadataManager.getLock().acquireWriteLock(VOLUME_LOCK, volume);\n+      lockAcquired = omMetadataManager.getLock().acquireWriteLock(\n+          VOLUME_LOCK, volume);\n       String dbVolumeKey = omMetadataManager.getVolumeKey(volume);\n       omVolumeArgs = omMetadataManager.getVolumeTable().get(dbVolumeKey);\n       if (omVolumeArgs == null) {\n         throw new OMException(OMException.ResultCodes.VOLUME_NOT_FOUND);\n       }\n \n+      // Check if this transaction is a replay of ratis logs.\n+      // If this is a replay, then the response has already been returned to\n+      // the client. So take no further action and return a dummy\n+      // OMClientResponse.\n+      if (isReplay(ozoneManager, omVolumeArgs.getUpdateID(),\n+          trxnLogIndex)) {\n+        throw new OMReplayException();\n+      }\n+\n       // result is false upon add existing acl or remove non-existing acl\n-      boolean result = true;\n+      boolean applyAcl = true;\n       try {\n         omVolumeAclOp.apply(ozoneAcls, omVolumeArgs);\n       } catch (OMException ex) {\n-        result = false;\n+        applyAcl = false;\n       }\n \n-      if (result) {\n+      if (applyAcl) {\n+        omVolumeArgs.setUpdateID(trxnLogIndex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7f1f51fb225dc8526b9d9cc8e927069cb5e7b64"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMzE5MjIz", "url": "https://github.com/apache/ozone/pull/510#pullrequestreview-351319223", "createdAt": "2020-01-31T06:52:27Z", "commit": {"oid": "b7f1f51fb225dc8526b9d9cc8e927069cb5e7b64"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMzIwOTcx", "url": "https://github.com/apache/ozone/pull/510#pullrequestreview-351320971", "createdAt": "2020-01-31T06:58:56Z", "commit": {"oid": "b7f1f51fb225dc8526b9d9cc8e927069cb5e7b64"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwNjo1ODo1NlrOFkCzYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwNjo1ODo1NlrOFkCzYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMzODk3OA==", "bodyText": "Removed isDebugEnabled.\nNeed same in other requests also. (I see it is missing in other requests)", "url": "https://github.com/apache/ozone/pull/510#discussion_r373338978", "createdAt": "2020-01-31T06:58:56Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/volume/acl/OMVolumeSetAclRequest.java", "diffHunk": "@@ -80,29 +80,36 @@ public String getVolumeName() {\n \n   @Override\n   OMClientResponse onSuccess(OMResponse.Builder omResponse,\n-      OmVolumeArgs omVolumeArgs, boolean result){\n+      OmVolumeArgs omVolumeArgs, boolean aclApplied){\n     omResponse.setSetAclResponse(OzoneManagerProtocolProtos.SetAclResponse\n-        .newBuilder().setResponse(result).build());\n-    return new OMVolumeAclOpResponse(omVolumeArgs, omResponse.build());\n+        .newBuilder().setResponse(aclApplied).build());\n+    return new OMVolumeAclOpResponse(omResponse.build(), omVolumeArgs);\n   }\n \n   @Override\n   OMClientResponse onFailure(OMResponse.Builder omResponse,\n       IOException ex) {\n-    return new OMVolumeAclOpResponse(null,\n-        createErrorOMResponse(omResponse, ex));\n+    return new OMVolumeAclOpResponse(createErrorOMResponse(omResponse, ex));\n   }\n \n   @Override\n-  void onComplete(IOException ex) {\n-    if (ex == null) {\n-      if (LOG.isDebugEnabled()) {\n-        LOG.debug(\"Set acls: {} to volume: {} success!\",\n-            getAcls(), getVolumeName());\n-      }\n-    } else {\n-      LOG.error(\"Set acls {} to volume {} failed!\",\n-          getAcls(), getVolumeName(), ex);\n+  void onComplete(Result result, IOException ex, long trxnLogIndex) {\n+    switch (result) {\n+    case SUCCESS:\n+      LOG.debug(\"Set acls: {} to volume: {} success!\", getAcls(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7f1f51fb225dc8526b9d9cc8e927069cb5e7b64"}, "originalPosition": 34}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c9d75e3814cd3e34ab894f8894751d5dd92793f", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/5c9d75e3814cd3e34ab894f8894751d5dd92793f", "committedDate": "2020-01-31T18:00:50Z", "message": "Adding debug enabled check"}, "afterCommit": {"oid": "22e359aa2a2a9487d7e16b539789df1235d88ff0", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/22e359aa2a2a9487d7e16b539789df1235d88ff0", "committedDate": "2020-02-04T23:25:15Z", "message": "UpdateDB even if applyAcl is false"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMzk2MDEx", "url": "https://github.com/apache/ozone/pull/510#pullrequestreview-353396011", "createdAt": "2020-02-05T00:24:06Z", "commit": {"oid": "22e359aa2a2a9487d7e16b539789df1235d88ff0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aaf782218fe0151485aef22aec8a6dc7fd6d3a82", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/aaf782218fe0151485aef22aec8a6dc7fd6d3a82", "committedDate": "2020-02-10T21:04:27Z", "message": "HDDS-2958. Handle replay of OM Volume ACL requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8ec13f313ef274dac5d991317650e684f70d8d2", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/a8ec13f313ef274dac5d991317650e684f70d8d2", "committedDate": "2020-02-10T21:04:27Z", "message": "CI unit test fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd035cebd428e006a7cf6dd970e8198940c7846a", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/cd035cebd428e006a7cf6dd970e8198940c7846a", "committedDate": "2020-02-10T21:04:27Z", "message": "Unit tests for Remove and Set ACL requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "328d53956dd9656e9ee5956334031156a63e946e", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/328d53956dd9656e9ee5956334031156a63e946e", "committedDate": "2020-02-10T21:04:27Z", "message": "Adding debug enabled check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a3a5c77be2cc059b685c53d093f1186eb39d9b2", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/5a3a5c77be2cc059b685c53d093f1186eb39d9b2", "committedDate": "2020-02-10T21:04:27Z", "message": "UpdateDB even if applyAcl is false"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87179bebbb940b89b72049230177804fa075c3f5", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/87179bebbb940b89b72049230177804fa075c3f5", "committedDate": "2020-02-10T21:12:19Z", "message": "rebase"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "22e359aa2a2a9487d7e16b539789df1235d88ff0", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/22e359aa2a2a9487d7e16b539789df1235d88ff0", "committedDate": "2020-02-04T23:25:15Z", "message": "UpdateDB even if applyAcl is false"}, "afterCommit": {"oid": "87179bebbb940b89b72049230177804fa075c3f5", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/87179bebbb940b89b72049230177804fa075c3f5", "committedDate": "2020-02-10T21:12:19Z", "message": "rebase"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3799, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}