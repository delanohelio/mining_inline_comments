{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5MjAwOTc0", "number": 596, "title": "HDDS-3066. SCM crash during loading containers to DB.", "bodyText": "What changes were proposed in this pull request?\nThis is happening because pipeline scrubber came and removed pipeline, and it closed pipeline and removed from DB and triggered close containers to set them to CLOSING. When SCM is restarted before close container command is handled and change the state to CLOSING, the below issue can happen.\nThis can happen in other scenarios like when safeModeHandler calls finalizeAndDestroyPipeline and do SCM restart.\nThe root cause for this is Pipeline removed from DB and the container is in open state in this scenario, and when trying to get pipeline we will crash SCM due to the PipelineNotFoundException error.\n2020-02-21 13:57:34,888 [main] ERROR org.apache.hadoop.hdds.scm.server.StorageContainerManagerStarter: SCM start failed with exception org.apache.hadoop.hdds.scm.pipeline.PipelineNotFoundException: PipelineID=35dff62d-9bfa-449b-b6e8-6f00cc8c1b6e not found at org.apache.hadoop.hdds.scm.pipeline.PipelineStateMap.getPipeline(PipelineStateMap.java:133) at org.apache.hadoop.hdds.scm.pipeline.PipelineStateMap.addContainerToPipeline(PipelineStateMap.java:110) at org.apache.hadoop.hdds.scm.pipeline.PipelineStateManager.addContainerToPipeline(PipelineStateManager.java:59) at org.apache.hadoop.hdds.scm.pipeline.SCMPipelineManager.addContainerToPipeline(SCMPipelineManager.java:309) at org.apache.hadoop.hdds.scm.container.SCMContainerManager.loadExistingContainers(SCMContainerManager.java:121) at org.apache.hadoop.hdds.scm.container.SCMContainerManager.<init>(SCMContainerManager.java:107) at org.apache.hadoop.hdds.scm.server.StorageContainerManager.initializeSystemManagers(StorageContainerManager.java:412) at org.apache.hadoop.hdds.scm.server.StorageContainerManager.<init>(StorageContainerManager.java:283) at org.apache.hadoop.hdds.scm.server.StorageContainerManager.<init>(StorageContainerManager.java:215) at org.apache.hadoop.hdds.scm.server.StorageContainerManager.createSCM(StorageContainerManager.java:612) at org.apache.hadoop.hdds.scm.server.StorageContainerManagerStarter$SCMStarterHelper.start(StorageContainerManagerStarter.java:142) at org.apache.hadoop.hdds.scm.server.StorageContainerManagerStarter.startScm(StorageContainerManagerStarter.java:117) at org.apache.hadoop.hdds.scm.server.StorageContainerManagerStarter.call(StorageContainerManagerStarter.java:66) at org.apache.hadoop.hdds.scm.server.StorageContainerManagerStarter.call(StorageContainerManagerStarter.java:42) at picocli.CommandLine.execute(CommandLine.java:1173) at picocli.CommandLine.access$800(CommandLine.java:141) at picocli.CommandLine$RunLast.handle(CommandLine.java:1367) at picocli.CommandLine$RunLast.handle(CommandLine.java:1335) at picocli.CommandLine$AbstractParseResultHandler.handleParseResult(CommandLine.java:1243) at picocli.CommandLine.parseWithHandlers(CommandLine.java:1526) at picocli.CommandLine.parseWithHandler(CommandLine.java:1465) at org.apache.hadoop.hdds.cli.GenericCli.execute(GenericCli.java:65) at org.apache.hadoop.hdds.cli.GenericCli.run(GenericCli.java:56) at org.apache.hadoop.hdds.scm.server.StorageContainerManagerStarter.main(StorageContainerManagerStarter.java:55) 2020-02-21 13:57:34,892 [shutdown-hook-0] INFO org.apache.hadoop.hdds.scm.server.StorageContainerManagerStarter: SHUTDOWN_MSG: /************************************************************ SHUTDOWN_MSG: Shutting down StorageContainerManager at om-ha-1.vpc.cloudera.com/10.65.51.49 ************************************************************/ \nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3066\nHow was this patch tested?\nThank You @nandakumar131 for the offline discussion.\nExisting tests. Deployed the fix on the cluster, and SCM able to boot up.\n2020-02-24 12:02:12,531 [main] WARN org.apache.hadoop.hdds.scm.container.SCMContainerManager: Found a Container ContainerInfo{id=3, state=OPEN, pipelineID=PipelineID=afb60e8a-0a69-410a-8699-d2a75e053225, stateEnterTime=1159646, owner=om2} which is in OPEN state with out a pipeline PipelineID=afb60e8a-0a69-410a-8699-d2a75e053225. Triggering Close Container.", "createdAt": "2020-02-24T20:04:13Z", "url": "https://github.com/apache/ozone/pull/596", "merged": true, "mergeCommit": {"oid": "b4419546499596543c2094a75263638f027faee6"}, "closed": true, "closedAt": "2020-02-28T21:38:52Z", "author": {"login": "bharatviswa504"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHlHLmgFqTM2Mzc0MTgxNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIs4TkAH2gAyMzc5MjAwOTc0OmY4ZDY0ZDIyNWZhZmVlYjU2MzFkZjFlZWFiOWZkYmQ0ZmNiNWRhMTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNzQxODE0", "url": "https://github.com/apache/ozone/pull/596#pullrequestreview-363741814", "createdAt": "2020-02-24T22:17:52Z", "commit": {"oid": "ff0eef45745e5e73fff5c0cb750507b981762786"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMjoxNzo1MlrOFtx6gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMjoxNzo1MlrOFtx6gQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzU0ODAzMw==", "bodyText": "Pipeline scrubber only destroy pipeline that has been in ALLOCATED for too long. And the container loader only call addContainerToPipeline if the container is in OPEN state.\nIf I understand correctly, we should not have OPEN container assigned on an ALLOCATED pipeline.", "url": "https://github.com/apache/ozone/pull/596#discussion_r383548033", "createdAt": "2020-02-24T22:17:52Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/SCMContainerManager.java", "diffHunk": "@@ -117,9 +126,17 @@ private void loadExistingContainers() throws IOException {\n           ContainerInfoProto.PARSER.parseFrom(entry.getValue()));\n       Preconditions.checkNotNull(container);\n       containerStateManager.loadContainer(container);\n-      if (container.getState() == LifeCycleState.OPEN) {\n-        pipelineManager.addContainerToPipeline(container.getPipelineID(),\n-            ContainerID.valueof(container.getContainerID()));\n+      try {\n+        if (container.getState() == LifeCycleState.OPEN) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff0eef45745e5e73fff5c0cb750507b981762786"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a7c8ffcea75b77c53e2bbb65e8557702552a31d", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/4a7c8ffcea75b77c53e2bbb65e8557702552a31d", "committedDate": "2020-02-24T23:08:31Z", "message": "HDDS-3066. SCM crash during loading containers to DB."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85ce437aa10fa0b42b179d4bfc362d85f4f375c5", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/85ce437aa10fa0b42b179d4bfc362d85f4f375c5", "committedDate": "2020-02-24T23:08:31Z", "message": "more changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b499ab44b7defa587b0bb658581feb5a23940543", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/b499ab44b7defa587b0bb658581feb5a23940543", "committedDate": "2020-02-24T23:08:31Z", "message": "fix checkstyle."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7571b84dc6fbab83385d8986e03ab05cde036017", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/7571b84dc6fbab83385d8986e03ab05cde036017", "committedDate": "2020-02-24T23:08:32Z", "message": "fix test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "246a84dc91e65e5c86e04b7c0dc2fd1aac6e5099", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/246a84dc91e65e5c86e04b7c0dc2fd1aac6e5099", "committedDate": "2020-02-24T22:46:02Z", "message": "more changes"}, "afterCommit": {"oid": "7571b84dc6fbab83385d8986e03ab05cde036017", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/7571b84dc6fbab83385d8986e03ab05cde036017", "committedDate": "2020-02-24T23:08:32Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4895bf73e6709da0d541a62f522a3ee9bfff9a8", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/c4895bf73e6709da0d541a62f522a3ee9bfff9a8", "committedDate": "2020-02-24T23:11:11Z", "message": "remove not needed code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "591a129f6f5c7801be03b326d3d16d2acffce6d8", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/591a129f6f5c7801be03b326d3d16d2acffce6d8", "committedDate": "2020-02-24T23:12:05Z", "message": "check style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cecc04cbc0eb7010089d985da0c2d0a9fd0bfce6", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/cecc04cbc0eb7010089d985da0c2d0a9fd0bfce6", "committedDate": "2020-02-24T23:15:30Z", "message": "reword"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NDI5OTA3", "url": "https://github.com/apache/ozone/pull/596#pullrequestreview-364429907", "createdAt": "2020-02-25T20:36:45Z", "commit": {"oid": "cecc04cbc0eb7010089d985da0c2d0a9fd0bfce6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMDozNjo0NVrOFuUVpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMDozNjo0NVrOFuUVpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDExMjAzNw==", "bodyText": "NIT: can we reword \"with out a pipeline {}\" to \"with pipeline {} that does not exist\"", "url": "https://github.com/apache/ozone/pull/596#discussion_r384112037", "createdAt": "2020-02-25T20:36:45Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/SCMContainerManager.java", "diffHunk": "@@ -117,9 +119,28 @@ private void loadExistingContainers() throws IOException {\n           ContainerInfoProto.PARSER.parseFrom(entry.getValue()));\n       Preconditions.checkNotNull(container);\n       containerStateManager.loadContainer(container);\n-      if (container.getState() == LifeCycleState.OPEN) {\n-        pipelineManager.addContainerToPipeline(container.getPipelineID(),\n-            ContainerID.valueof(container.getContainerID()));\n+      try {\n+        if (container.getState() == LifeCycleState.OPEN) {\n+          pipelineManager.addContainerToPipeline(container.getPipelineID(),\n+              ContainerID.valueof(container.getContainerID()));\n+        }\n+      } catch (PipelineNotFoundException ex) {\n+        LOG.warn(\"Found a Container {} which is in {} state with out a \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cecc04cbc0eb7010089d985da0c2d0a9fd0bfce6"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NDM0MjIz", "url": "https://github.com/apache/ozone/pull/596#pullrequestreview-364434223", "createdAt": "2020-02-25T20:44:05Z", "commit": {"oid": "cecc04cbc0eb7010089d985da0c2d0a9fd0bfce6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMDo0NDowNlrOFuUirQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQyMDo0NDowNlrOFuUirQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDExNTM3Mw==", "bodyText": "This comment does not match with the code any more. Should we remove it?\n\"// Not firing CLOSE_CONTAINER event ...\"", "url": "https://github.com/apache/ozone/pull/596#discussion_r384115373", "createdAt": "2020-02-25T20:44:06Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/SCMContainerManager.java", "diffHunk": "@@ -117,9 +119,28 @@ private void loadExistingContainers() throws IOException {\n           ContainerInfoProto.PARSER.parseFrom(entry.getValue()));\n       Preconditions.checkNotNull(container);\n       containerStateManager.loadContainer(container);\n-      if (container.getState() == LifeCycleState.OPEN) {\n-        pipelineManager.addContainerToPipeline(container.getPipelineID(),\n-            ContainerID.valueof(container.getContainerID()));\n+      try {\n+        if (container.getState() == LifeCycleState.OPEN) {\n+          pipelineManager.addContainerToPipeline(container.getPipelineID(),\n+              ContainerID.valueof(container.getContainerID()));\n+        }\n+      } catch (PipelineNotFoundException ex) {\n+        LOG.warn(\"Found a Container {} which is in {} state with out a \" +\n+            \"pipeline {}. Close Container.\", container, container.getState(),\n+            container.getPipelineID());\n+\n+        // Not firing CLOSE_CONTAINER event because CloseContainer Event", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cecc04cbc0eb7010089d985da0c2d0a9fd0bfce6"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34ee16ff8cd1ade8ff2be6ea8f5a6c6e45209043", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/34ee16ff8cd1ade8ff2be6ea8f5a6c6e45209043", "committedDate": "2020-02-26T00:11:38Z", "message": "review comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1OTI2MTg4", "url": "https://github.com/apache/ozone/pull/596#pullrequestreview-365926188", "createdAt": "2020-02-27T19:12:09Z", "commit": {"oid": "34ee16ff8cd1ade8ff2be6ea8f5a6c6e45209043"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxOToxMjowOVrOFvdxQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxOToxNTowOVrOFvd3BQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxNTEzOQ==", "bodyText": "We don't need this comment. As SCMContainerManager is the one which is taking this decision, it should not file an event to close the container. It is logical to directly update the container state.\nIt is very explicit that we are performing this in case of PipelineNotFoundException, so there is no need to repeat it again.", "url": "https://github.com/apache/ozone/pull/596#discussion_r385315139", "createdAt": "2020-02-27T19:12:09Z", "author": {"login": "nandakumar131"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/SCMContainerManager.java", "diffHunk": "@@ -117,9 +119,28 @@ private void loadExistingContainers() throws IOException {\n           ContainerInfoProto.PARSER.parseFrom(entry.getValue()));\n       Preconditions.checkNotNull(container);\n       containerStateManager.loadContainer(container);\n-      if (container.getState() == LifeCycleState.OPEN) {\n-        pipelineManager.addContainerToPipeline(container.getPipelineID(),\n-            ContainerID.valueof(container.getContainerID()));\n+      try {\n+        if (container.getState() == LifeCycleState.OPEN) {\n+          pipelineManager.addContainerToPipeline(container.getPipelineID(),\n+              ContainerID.valueof(container.getContainerID()));\n+        }\n+      } catch (PipelineNotFoundException ex) {\n+        LOG.warn(\"Found a Container {} which is in {} state with pipeline {} \" +\n+                \"that does not exist. Closing Container.\", container,\n+            container.getState(), container.getPipelineID());\n+\n+        // Not firing CLOSE_CONTAINER event because CloseContainer event\n+        // handler is not registered by the time when we come\n+        // here. So, we are calling update Container state to set\n+        // container state to CLOSING, and later replication manager takes care\n+        // of send close commands to datanode to close containers on the\n+        // datanode.\n+\n+        // Skipping pipeline to container removal because, we got a\n+        // pipelineNotFoundException when adding container to\n+        // pipeline. So, we can only update container state.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34ee16ff8cd1ade8ff2be6ea8f5a6c6e45209043"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxNjYxMw==", "bodyText": "We don't have to introduce a new method to updateContainerState. Since we are doing this inside a constructor, we don't need any lock.\nWe can directly call containerStateManager.updateContainerState(container.containerID(), HddsProtos.LifeCycleEvent.FINALIZE)", "url": "https://github.com/apache/ozone/pull/596#discussion_r385316613", "createdAt": "2020-02-27T19:15:09Z", "author": {"login": "nandakumar131"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/SCMContainerManager.java", "diffHunk": "@@ -117,9 +119,28 @@ private void loadExistingContainers() throws IOException {\n           ContainerInfoProto.PARSER.parseFrom(entry.getValue()));\n       Preconditions.checkNotNull(container);\n       containerStateManager.loadContainer(container);\n-      if (container.getState() == LifeCycleState.OPEN) {\n-        pipelineManager.addContainerToPipeline(container.getPipelineID(),\n-            ContainerID.valueof(container.getContainerID()));\n+      try {\n+        if (container.getState() == LifeCycleState.OPEN) {\n+          pipelineManager.addContainerToPipeline(container.getPipelineID(),\n+              ContainerID.valueof(container.getContainerID()));\n+        }\n+      } catch (PipelineNotFoundException ex) {\n+        LOG.warn(\"Found a Container {} which is in {} state with pipeline {} \" +\n+                \"that does not exist. Closing Container.\", container,\n+            container.getState(), container.getPipelineID());\n+\n+        // Not firing CLOSE_CONTAINER event because CloseContainer event\n+        // handler is not registered by the time when we come\n+        // here. So, we are calling update Container state to set\n+        // container state to CLOSING, and later replication manager takes care\n+        // of send close commands to datanode to close containers on the\n+        // datanode.\n+\n+        // Skipping pipeline to container removal because, we got a\n+        // pipelineNotFoundException when adding container to\n+        // pipeline. So, we can only update container state.\n+        updateContainerState(container.containerID(),\n+            HddsProtos.LifeCycleEvent.FINALIZE, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34ee16ff8cd1ade8ff2be6ea8f5a6c6e45209043"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5ee13ae4f77de79a224b305fd943809267fa696", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/c5ee13ae4f77de79a224b305fd943809267fa696", "committedDate": "2020-02-27T22:10:28Z", "message": "review comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2Mjc1MzY0", "url": "https://github.com/apache/ozone/pull/596#pullrequestreview-366275364", "createdAt": "2020-02-28T09:52:53Z", "commit": {"oid": "c5ee13ae4f77de79a224b305fd943809267fa696"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8d64d225fafeeb5631df1eeab9fdbd4fcb5da19", "author": {"user": {"login": "web-flow", "name": "GitHub Web Flow"}}, "url": "https://github.com/apache/ozone/commit/f8d64d225fafeeb5631df1eeab9fdbd4fcb5da19", "committedDate": "2020-02-28T09:54:48Z", "message": "empty commit to retest build"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3620, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}