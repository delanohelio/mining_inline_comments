{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyMzc5MDMy", "number": 1049, "title": "HDDS-3662 Decouple finalizeAndDestroyPipeline.", "bodyText": "What changes were proposed in this pull request?\nDecouple finalizeAndDestroyPipeline.\nClose pipeline should only update the pipeline state, it\u2019s the job of the caller to issue close container commands to all the containers in the pipeline.\nDestroy pipeline should be called from pipeline scrubber, once a pipeline has spent enough time in closed state the pipeline scrubber should call destroy pipeline.\n(Please fill in changes proposed in this fix)\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3662\n(Please create an issue in ASF JIRA before opening a pull request,\nand you need to set the title of the pull request which starts with\nthe corresponding JIRA issue number. (e.g. HDDS-XXXX. Fix a typo in YYY.)\nPlease replace this section with the link to the Apache JIRA)\nHow was this patch tested?\nUT\n(Please explain how this patch was tested. Ex: unit tests, manual tests)\n(If this patch involves UI changes, please attach a screen-shot; otherwise, remove this)", "createdAt": "2020-06-10T11:03:04Z", "url": "https://github.com/apache/ozone/pull/1049", "merged": true, "mergeCommit": {"oid": "565dabc9237a646a8ddb9c9aa4784c99ed7a56c0"}, "closed": true, "closedAt": "2020-07-10T22:45:22Z", "author": {"login": "timmylicheng"}, "timelineItems": {"totalCount": 39, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcp3_UZgBqjM0MjkxOTI1NTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczgKdCABqjM1MzMxMTM2MTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bafefb67e434e1f95dd44ce7d062dcec24bf658e", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/bafefb67e434e1f95dd44ce7d062dcec24bf658e", "committedDate": "2020-06-10T08:27:35Z", "message": "HDDS-3662 Decouple finalizeAndDestroyPipeline."}, "afterCommit": {"oid": "c315b7470a45665090dd6ddcea56752f7fb00570", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/c315b7470a45665090dd6ddcea56752f7fb00570", "committedDate": "2020-06-10T11:30:40Z", "message": "HDDS-3662 Decouple finalizeAndDestroyPipeline."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c315b7470a45665090dd6ddcea56752f7fb00570", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/c315b7470a45665090dd6ddcea56752f7fb00570", "committedDate": "2020-06-10T11:30:40Z", "message": "HDDS-3662 Decouple finalizeAndDestroyPipeline."}, "afterCommit": {"oid": "0348af883a6331e8f5d36705990d7dd326901f3e", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/0348af883a6331e8f5d36705990d7dd326901f3e", "committedDate": "2020-06-10T11:58:41Z", "message": "HDDS-3662 Decouple finalizeAndDestroyPipeline."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0348af883a6331e8f5d36705990d7dd326901f3e", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/0348af883a6331e8f5d36705990d7dd326901f3e", "committedDate": "2020-06-10T11:58:41Z", "message": "HDDS-3662 Decouple finalizeAndDestroyPipeline."}, "afterCommit": {"oid": "315f3cc7fa447125c8a47e85d22d6c44d7bfda26", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/315f3cc7fa447125c8a47e85d22d6c44d7bfda26", "committedDate": "2020-06-11T09:25:26Z", "message": "HDDS-3662 Decouple finalizeAndDestroyPipeline."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "315f3cc7fa447125c8a47e85d22d6c44d7bfda26", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/315f3cc7fa447125c8a47e85d22d6c44d7bfda26", "committedDate": "2020-06-11T09:25:26Z", "message": "HDDS-3662 Decouple finalizeAndDestroyPipeline."}, "afterCommit": {"oid": "5b5194c8826267eedc2c8c63bc0ca7956aec958f", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/5b5194c8826267eedc2c8c63bc0ca7956aec958f", "committedDate": "2020-06-11T10:59:24Z", "message": "HDDS-3662 Decouple finalizeAndDestroyPipeline."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b5194c8826267eedc2c8c63bc0ca7956aec958f", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/5b5194c8826267eedc2c8c63bc0ca7956aec958f", "committedDate": "2020-06-11T10:59:24Z", "message": "HDDS-3662 Decouple finalizeAndDestroyPipeline."}, "afterCommit": {"oid": "94027105f4d5781045a892306363313fa1422c41", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/94027105f4d5781045a892306363313fa1422c41", "committedDate": "2020-06-11T12:27:49Z", "message": "HDDS-3662 Decouple finalizeAndDestroyPipeline."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MzY2ODkw", "url": "https://github.com/apache/ozone/pull/1049#pullrequestreview-429366890", "createdAt": "2020-06-11T23:49:45Z", "commit": {"oid": "94027105f4d5781045a892306363313fa1422c41"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzo0OTo0NVrOGiyYlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzo0OTo0NVrOGiyYlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEzMDI2MA==", "bodyText": "onTimeout is  not necessary here as this is just a state update now.", "url": "https://github.com/apache/ozone/pull/1049#discussion_r439130260", "createdAt": "2020-06-11T23:49:45Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java", "diffHunk": "@@ -310,102 +315,69 @@ public void openPipeline(PipelineID pipelineId) throws IOException {\n   }\n \n   /**\n-   * Finalizes pipeline in the SCM. Removes pipeline and makes rpc call to\n-   * destroy pipeline on the datanodes immediately or after timeout based on the\n-   * value of onTimeout parameter.\n-   *\n-   * @param pipeline        - Pipeline to be destroyed\n-   * @param onTimeout       - if true pipeline is removed and destroyed on\n-   *                        datanodes after timeout\n-   * @throws IOException\n-   */\n-  @Override\n-  public void finalizeAndDestroyPipeline(Pipeline pipeline, boolean onTimeout)\n-      throws IOException {\n-    LOG.info(\"Destroying pipeline:{}\", pipeline);\n-    finalizePipeline(pipeline.getId());\n-    if (onTimeout) {\n-      long pipelineDestroyTimeoutInMillis =\n-          conf.getTimeDuration(ScmConfigKeys.OZONE_SCM_PIPELINE_DESTROY_TIMEOUT,\n-              ScmConfigKeys.OZONE_SCM_PIPELINE_DESTROY_TIMEOUT_DEFAULT,\n-              TimeUnit.MILLISECONDS);\n-      scheduler.schedule(() -> destroyPipeline(pipeline),\n-          pipelineDestroyTimeoutInMillis, TimeUnit.MILLISECONDS, LOG,\n-          String.format(\"Destroy pipeline failed for pipeline:%s\", pipeline));\n-    } else {\n-      destroyPipeline(pipeline);\n-    }\n-  }\n-\n-  /**\n-   * Moves the pipeline to CLOSED state and sends close container command for\n-   * all the containers in the pipeline.\n+   * Removes the pipeline from the db and pipeline state map.\n    *\n-   * @param pipelineId - ID of the pipeline to be moved to CLOSED state.\n+   * @param pipeline - pipeline to be removed\n    * @throws IOException\n    */\n-  private void finalizePipeline(PipelineID pipelineId) throws IOException {\n+  protected void removePipeline(Pipeline pipeline) throws IOException {\n+    pipelineFactory.close(pipeline.getType(), pipeline);\n+    PipelineID pipelineID = pipeline.getId();\n+    closeContainersForPipeline(pipelineID);\n     lock.writeLock().lock();\n     try {\n-      Pipeline pipeline = stateManager.getPipeline(pipelineId);\n-      if (!pipeline.isClosed()) {\n-        stateManager.updatePipelineState(pipelineId.getProtobuf(),\n-            HddsProtos.PipelineState.PIPELINE_CLOSED);\n-        LOG.info(\"Pipeline {} moved to CLOSED state\", pipeline);\n-      }\n-\n-      // TODO fire events to datanodes for closing pipelines\n-//      Set<ContainerID> containerIDs = stateManager.getContainers(pipelineId);\n-//      for (ContainerID containerID : containerIDs) {\n-//        eventPublisher.fireEvent(SCMEvents.CLOSE_CONTAINER, containerID);\n-//      }\n-      metrics.removePipelineMetrics(pipelineId);\n+      stateManager.removePipeline(pipelineID.getProtobuf());\n+      metrics.incNumPipelineDestroyed();\n+    } catch (IOException ex) {\n+      metrics.incNumPipelineDestroyFailed();\n+      throw ex;\n     } finally {\n       lock.writeLock().unlock();\n     }\n   }\n \n   /**\n-   * Removes pipeline from SCM. Sends ratis command to destroy pipeline on all\n-   * the datanodes for ratis pipelines.\n-   *\n-   * @param pipeline        - Pipeline to be destroyed\n+   * Fire events to close all containers related to the input pipeline.\n+   * @param pipelineId - ID of the pipeline.\n    * @throws IOException\n    */\n-  protected void destroyPipeline(Pipeline pipeline) throws IOException {\n-    pipelineFactory.close(pipeline.getType(), pipeline);\n-    // remove the pipeline from the pipeline manager\n-    removePipeline(pipeline.getId());\n-    triggerPipelineCreation();\n+  protected void closeContainersForPipeline(final PipelineID pipelineId)\n+      throws IOException {\n+    Set<ContainerID> containerIDs = stateManager.getContainers(pipelineId);\n+    for (ContainerID containerID : containerIDs) {\n+      eventPublisher.fireEvent(SCMEvents.CLOSE_CONTAINER, containerID);\n+    }\n   }\n \n   /**\n-   * Removes the pipeline from the db and pipeline state map.\n-   *\n-   * @param pipelineId - ID of the pipeline to be removed\n+   * put pipeline in CLOSED state.\n+   * @param pipeline - ID of the pipeline.\n+   * @param onTimeout - whether to remove pipeline after some time.\n    * @throws IOException\n    */\n-  protected void removePipeline(PipelineID pipelineId) throws IOException {\n+  @Override\n+  public void closePipeline(Pipeline pipeline, boolean onTimeout)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94027105f4d5781045a892306363313fa1422c41"}, "originalPosition": 151}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MzcxNTM3", "url": "https://github.com/apache/ozone/pull/1049#pullrequestreview-429371537", "createdAt": "2020-06-11T23:57:23Z", "commit": {"oid": "94027105f4d5781045a892306363313fa1422c41"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzo1NzoyM1rOGiygjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzo1NzoyM1rOGiygjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEzMjMwMw==", "bodyText": "pipeline in allocated state should not have container associate with it. So I think closeContainersForPipeline is only needed for scrubClosedPipeline.", "url": "https://github.com/apache/ozone/pull/1049#discussion_r439132303", "createdAt": "2020-06-11T23:57:23Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java", "diffHunk": "@@ -420,10 +392,50 @@ public void scrubPipeline(ReplicationType type, ReplicationFactor factor)\n           \" since it stays at ALLOCATED stage for \" +\n           Duration.between(currentTime, p.getCreationTimestamp()).toMinutes() +\n           \" mins.\");\n-      finalizeAndDestroyPipeline(p, false);\n+      closePipeline(p, false);\n+      closeContainersForPipeline(p.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94027105f4d5781045a892306363313fa1422c41"}, "originalPosition": 195}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MzcyNzYx", "url": "https://github.com/apache/ozone/pull/1049#pullrequestreview-429372761", "createdAt": "2020-06-11T23:58:26Z", "commit": {"oid": "94027105f4d5781045a892306363313fa1422c41"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzo1ODoyN1rOGiyhsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzo1ODoyN1rOGiyhsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEzMjU5Mw==", "bodyText": "is it possible to dudup the code between scrub closed and allocated pipeline?", "url": "https://github.com/apache/ozone/pull/1049#discussion_r439132593", "createdAt": "2020-06-11T23:58:27Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java", "diffHunk": "@@ -310,102 +315,69 @@ public void openPipeline(PipelineID pipelineId) throws IOException {\n   }\n \n   /**\n-   * Finalizes pipeline in the SCM. Removes pipeline and makes rpc call to\n-   * destroy pipeline on the datanodes immediately or after timeout based on the\n-   * value of onTimeout parameter.\n-   *\n-   * @param pipeline        - Pipeline to be destroyed\n-   * @param onTimeout       - if true pipeline is removed and destroyed on\n-   *                        datanodes after timeout\n-   * @throws IOException\n-   */\n-  @Override\n-  public void finalizeAndDestroyPipeline(Pipeline pipeline, boolean onTimeout)\n-      throws IOException {\n-    LOG.info(\"Destroying pipeline:{}\", pipeline);\n-    finalizePipeline(pipeline.getId());\n-    if (onTimeout) {\n-      long pipelineDestroyTimeoutInMillis =\n-          conf.getTimeDuration(ScmConfigKeys.OZONE_SCM_PIPELINE_DESTROY_TIMEOUT,\n-              ScmConfigKeys.OZONE_SCM_PIPELINE_DESTROY_TIMEOUT_DEFAULT,\n-              TimeUnit.MILLISECONDS);\n-      scheduler.schedule(() -> destroyPipeline(pipeline),\n-          pipelineDestroyTimeoutInMillis, TimeUnit.MILLISECONDS, LOG,\n-          String.format(\"Destroy pipeline failed for pipeline:%s\", pipeline));\n-    } else {\n-      destroyPipeline(pipeline);\n-    }\n-  }\n-\n-  /**\n-   * Moves the pipeline to CLOSED state and sends close container command for\n-   * all the containers in the pipeline.\n+   * Removes the pipeline from the db and pipeline state map.\n    *\n-   * @param pipelineId - ID of the pipeline to be moved to CLOSED state.\n+   * @param pipeline - pipeline to be removed\n    * @throws IOException\n    */\n-  private void finalizePipeline(PipelineID pipelineId) throws IOException {\n+  protected void removePipeline(Pipeline pipeline) throws IOException {\n+    pipelineFactory.close(pipeline.getType(), pipeline);\n+    PipelineID pipelineID = pipeline.getId();\n+    closeContainersForPipeline(pipelineID);\n     lock.writeLock().lock();\n     try {\n-      Pipeline pipeline = stateManager.getPipeline(pipelineId);\n-      if (!pipeline.isClosed()) {\n-        stateManager.updatePipelineState(pipelineId.getProtobuf(),\n-            HddsProtos.PipelineState.PIPELINE_CLOSED);\n-        LOG.info(\"Pipeline {} moved to CLOSED state\", pipeline);\n-      }\n-\n-      // TODO fire events to datanodes for closing pipelines\n-//      Set<ContainerID> containerIDs = stateManager.getContainers(pipelineId);\n-//      for (ContainerID containerID : containerIDs) {\n-//        eventPublisher.fireEvent(SCMEvents.CLOSE_CONTAINER, containerID);\n-//      }\n-      metrics.removePipelineMetrics(pipelineId);\n+      stateManager.removePipeline(pipelineID.getProtobuf());\n+      metrics.incNumPipelineDestroyed();\n+    } catch (IOException ex) {\n+      metrics.incNumPipelineDestroyFailed();\n+      throw ex;\n     } finally {\n       lock.writeLock().unlock();\n     }\n   }\n \n   /**\n-   * Removes pipeline from SCM. Sends ratis command to destroy pipeline on all\n-   * the datanodes for ratis pipelines.\n-   *\n-   * @param pipeline        - Pipeline to be destroyed\n+   * Fire events to close all containers related to the input pipeline.\n+   * @param pipelineId - ID of the pipeline.\n    * @throws IOException\n    */\n-  protected void destroyPipeline(Pipeline pipeline) throws IOException {\n-    pipelineFactory.close(pipeline.getType(), pipeline);\n-    // remove the pipeline from the pipeline manager\n-    removePipeline(pipeline.getId());\n-    triggerPipelineCreation();\n+  protected void closeContainersForPipeline(final PipelineID pipelineId)\n+      throws IOException {\n+    Set<ContainerID> containerIDs = stateManager.getContainers(pipelineId);\n+    for (ContainerID containerID : containerIDs) {\n+      eventPublisher.fireEvent(SCMEvents.CLOSE_CONTAINER, containerID);\n+    }\n   }\n \n   /**\n-   * Removes the pipeline from the db and pipeline state map.\n-   *\n-   * @param pipelineId - ID of the pipeline to be removed\n+   * put pipeline in CLOSED state.\n+   * @param pipeline - ID of the pipeline.\n+   * @param onTimeout - whether to remove pipeline after some time.\n    * @throws IOException\n    */\n-  protected void removePipeline(PipelineID pipelineId) throws IOException {\n+  @Override\n+  public void closePipeline(Pipeline pipeline, boolean onTimeout)\n+      throws IOException {\n+    PipelineID pipelineID = pipeline.getId();\n     lock.writeLock().lock();\n     try {\n-      stateManager.removePipeline(pipelineId.getProtobuf());\n-      metrics.incNumPipelineDestroyed();\n-    } catch (IOException ex) {\n-      metrics.incNumPipelineDestroyFailed();\n-      throw ex;\n+      if (!pipeline.isClosed()) {\n+        stateManager.updatePipelineState(pipelineID.getProtobuf(),\n+            HddsProtos.PipelineState.PIPELINE_CLOSED);\n+        LOG.info(\"Pipeline {} moved to CLOSED state\", pipeline);\n+      }\n+      metrics.removePipelineMetrics(pipelineID);\n     } finally {\n       lock.writeLock().unlock();\n     }\n+    if (!onTimeout) {\n+      removePipeline(pipeline);\n+    }\n   }\n \n-  @Override\n-  public void scrubPipeline(ReplicationType type, ReplicationFactor factor)\n-      throws IOException{\n-    if (type != ReplicationType.RATIS || factor != ReplicationFactor.THREE) {\n-      // Only srub pipeline for RATIS THREE pipeline\n-      return;\n-    }\n-    Instant currentTime = Instant.now();\n+  private void scrubAllocatedPipeline(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94027105f4d5781045a892306363313fa1422c41"}, "originalPosition": 183}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MzczMzk2", "url": "https://github.com/apache/ozone/pull/1049#pullrequestreview-429373396", "createdAt": "2020-06-11T23:59:01Z", "commit": {"oid": "94027105f4d5781045a892306363313fa1422c41"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzo1OTowMVrOGiyiSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQyMzo1OTowMVrOGiyiSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTEzMjc0Ng==", "bodyText": "Should we avoid the stream api for better performance ?", "url": "https://github.com/apache/ozone/pull/1049#discussion_r439132746", "createdAt": "2020-06-11T23:59:01Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java", "diffHunk": "@@ -420,10 +392,50 @@ public void scrubPipeline(ReplicationType type, ReplicationFactor factor)\n           \" since it stays at ALLOCATED stage for \" +\n           Duration.between(currentTime, p.getCreationTimestamp()).toMinutes() +\n           \" mins.\");\n-      finalizeAndDestroyPipeline(p, false);\n+      closePipeline(p, false);\n+      closeContainersForPipeline(p.getId());\n     }\n   }\n \n+  private void scrubClosedPipeline(\n+      ReplicationType type, ReplicationFactor factor, Instant currentTime)\n+      throws IOException {\n+    long pipelineDestroyTimeoutInMillis =\n+        conf.getTimeDuration(ScmConfigKeys.OZONE_SCM_PIPELINE_DESTROY_TIMEOUT,\n+            ScmConfigKeys.OZONE_SCM_PIPELINE_DESTROY_TIMEOUT_DEFAULT,\n+            TimeUnit.MILLISECONDS);\n+    List<Pipeline> closedPipelines = stateManager.getPipelines(type, factor,\n+        Pipeline.PipelineState.CLOSED).stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94027105f4d5781045a892306363313fa1422c41"}, "originalPosition": 207}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5Mzc5ODYw", "url": "https://github.com/apache/ozone/pull/1049#pullrequestreview-429379860", "createdAt": "2020-06-12T00:04:49Z", "commit": {"oid": "94027105f4d5781045a892306363313fa1422c41"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "472297b6778c821117e4ed3cd7966ddb1cfd2194", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/472297b6778c821117e4ed3cd7966ddb1cfd2194", "committedDate": "2020-06-12T04:12:46Z", "message": "Update scrubPipeline."}, "afterCommit": {"oid": "0bd964bf09b8bf5bb4485f9164ccf6027ce437a7", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/0bd964bf09b8bf5bb4485f9164ccf6027ce437a7", "committedDate": "2020-06-12T06:51:25Z", "message": "Update scrubPipeline."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0bd964bf09b8bf5bb4485f9164ccf6027ce437a7", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/0bd964bf09b8bf5bb4485f9164ccf6027ce437a7", "committedDate": "2020-06-12T06:51:25Z", "message": "Update scrubPipeline."}, "afterCommit": {"oid": "8afdf270d2a9f06c6e7e4793fc7c0786d526a736", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/8afdf270d2a9f06c6e7e4793fc7c0786d526a736", "committedDate": "2020-06-12T07:59:09Z", "message": "Update scrubPipeline."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8afdf270d2a9f06c6e7e4793fc7c0786d526a736", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/8afdf270d2a9f06c6e7e4793fc7c0786d526a736", "committedDate": "2020-06-12T07:59:09Z", "message": "Update scrubPipeline."}, "afterCommit": {"oid": "23297f0be1cb3bacd15572f1510648048865f747", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/23297f0be1cb3bacd15572f1510648048865f747", "committedDate": "2020-06-12T08:27:46Z", "message": "Update scrubPipeline."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "23297f0be1cb3bacd15572f1510648048865f747", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/23297f0be1cb3bacd15572f1510648048865f747", "committedDate": "2020-06-12T08:27:46Z", "message": "Update scrubPipeline."}, "afterCommit": {"oid": "ab4fb499e898a91c6d4474b6888220982ab0cd40", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/ab4fb499e898a91c6d4474b6888220982ab0cd40", "committedDate": "2020-06-16T08:36:45Z", "message": "Update scrubPipeline."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab4fb499e898a91c6d4474b6888220982ab0cd40", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/ab4fb499e898a91c6d4474b6888220982ab0cd40", "committedDate": "2020-06-16T08:36:45Z", "message": "Update scrubPipeline."}, "afterCommit": {"oid": "a872a58f000058acc2867e4616e7392c931df962", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/a872a58f000058acc2867e4616e7392c931df962", "committedDate": "2020-06-16T09:08:48Z", "message": "Update scrubPipeline."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a872a58f000058acc2867e4616e7392c931df962", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/a872a58f000058acc2867e4616e7392c931df962", "committedDate": "2020-06-16T09:08:48Z", "message": "Update scrubPipeline."}, "afterCommit": {"oid": "97657491abb66878ab11d6f25d568b6d79226d01", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/97657491abb66878ab11d6f25d568b6d79226d01", "committedDate": "2020-06-17T07:42:03Z", "message": "Update scrubPipeline."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "97657491abb66878ab11d6f25d568b6d79226d01", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/97657491abb66878ab11d6f25d568b6d79226d01", "committedDate": "2020-06-17T07:42:03Z", "message": "Update scrubPipeline."}, "afterCommit": {"oid": "629ad3c20d3562b72fa6fcb5fdd54df34f2fb32b", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/629ad3c20d3562b72fa6fcb5fdd54df34f2fb32b", "committedDate": "2020-06-18T02:45:59Z", "message": "Update scrubPipeline."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "629ad3c20d3562b72fa6fcb5fdd54df34f2fb32b", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/629ad3c20d3562b72fa6fcb5fdd54df34f2fb32b", "committedDate": "2020-06-18T02:45:59Z", "message": "Update scrubPipeline."}, "afterCommit": {"oid": "1c0e37de88275935a4d98246ad46344b072edf99", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/1c0e37de88275935a4d98246ad46344b072edf99", "committedDate": "2020-06-18T09:14:29Z", "message": "Update scrubPipeline."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1c0e37de88275935a4d98246ad46344b072edf99", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/1c0e37de88275935a4d98246ad46344b072edf99", "committedDate": "2020-06-18T09:14:29Z", "message": "Update scrubPipeline."}, "afterCommit": {"oid": "f1b59c0177ff340e4a35d3c8eb6d1a7280aec861", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/f1b59c0177ff340e4a35d3c8eb6d1a7280aec861", "committedDate": "2020-06-19T08:42:06Z", "message": "Update scrubPipeline."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "df08240e2004cc086ef707c9b275a35f76f3bab8", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/df08240e2004cc086ef707c9b275a35f76f3bab8", "committedDate": "2020-06-19T09:56:46Z", "message": "Let srubber remove pipeline right away."}, "afterCommit": {"oid": "87c6bd7009540b4d5dcb554be5d9f5402491701a", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/87c6bd7009540b4d5dcb554be5d9f5402491701a", "committedDate": "2020-06-19T10:53:36Z", "message": "Let srubber remove pipeline right away."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87c6bd7009540b4d5dcb554be5d9f5402491701a", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/87c6bd7009540b4d5dcb554be5d9f5402491701a", "committedDate": "2020-06-19T10:53:36Z", "message": "Let srubber remove pipeline right away."}, "afterCommit": {"oid": "ad436974dc96e44c55904b45ce8518090dbde8a0", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/ad436974dc96e44c55904b45ce8518090dbde8a0", "committedDate": "2020-06-19T11:27:58Z", "message": "Let srubber remove pipeline right away."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ad436974dc96e44c55904b45ce8518090dbde8a0", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/ad436974dc96e44c55904b45ce8518090dbde8a0", "committedDate": "2020-06-19T11:27:58Z", "message": "Let srubber remove pipeline right away."}, "afterCommit": {"oid": "947557da97857357f146fdaa7e219e6e7d97c98e", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/947557da97857357f146fdaa7e219e6e7d97c98e", "committedDate": "2020-06-22T02:13:51Z", "message": "Let srubber remove pipeline right away."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "947557da97857357f146fdaa7e219e6e7d97c98e", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/947557da97857357f146fdaa7e219e6e7d97c98e", "committedDate": "2020-06-22T02:13:51Z", "message": "Let srubber remove pipeline right away."}, "afterCommit": {"oid": "64bab17faae576a7aaebc9c4aea71e3b557b5f9e", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/64bab17faae576a7aaebc9c4aea71e3b557b5f9e", "committedDate": "2020-06-22T02:40:10Z", "message": "Let srubber remove pipeline right away."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3b95aff74e60b5627e38f398424c86d440967ec", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/b3b95aff74e60b5627e38f398424c86d440967ec", "committedDate": "2020-06-30T10:59:38Z", "message": "HDDS-3662 Decouple finalizeAndDestroyPipeline."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfd1168646aa9079095a3f7b9cc7296210107a02", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/bfd1168646aa9079095a3f7b9cc7296210107a02", "committedDate": "2020-06-30T10:59:38Z", "message": "Update scrubPipeline."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "64bab17faae576a7aaebc9c4aea71e3b557b5f9e", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/64bab17faae576a7aaebc9c4aea71e3b557b5f9e", "committedDate": "2020-06-22T02:40:10Z", "message": "Let srubber remove pipeline right away."}, "afterCommit": {"oid": "7fdcc1218223f330325285ea1f3f6669ead835fa", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/7fdcc1218223f330325285ea1f3f6669ead835fa", "committedDate": "2020-06-30T10:59:38Z", "message": "Let srubber remove pipeline right away."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7fdcc1218223f330325285ea1f3f6669ead835fa", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/7fdcc1218223f330325285ea1f3f6669ead835fa", "committedDate": "2020-06-30T10:59:38Z", "message": "Let srubber remove pipeline right away."}, "afterCommit": {"oid": "604240f2e3f9e3680e3442ba257693c84d7737ef", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/604240f2e3f9e3680e3442ba257693c84d7737ef", "committedDate": "2020-07-02T12:07:18Z", "message": "Let srubber remove pipeline right away."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50929247a1da2eb3a36bff075cf447114a62ae28", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/50929247a1da2eb3a36bff075cf447114a62ae28", "committedDate": "2020-07-03T02:11:06Z", "message": "Let srubber remove pipeline right away."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "604240f2e3f9e3680e3442ba257693c84d7737ef", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/604240f2e3f9e3680e3442ba257693c84d7737ef", "committedDate": "2020-07-02T12:07:18Z", "message": "Let srubber remove pipeline right away."}, "afterCommit": {"oid": "50929247a1da2eb3a36bff075cf447114a62ae28", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/50929247a1da2eb3a36bff075cf447114a62ae28", "committedDate": "2020-07-03T02:11:06Z", "message": "Let srubber remove pipeline right away."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNzU2MTI1", "url": "https://github.com/apache/ozone/pull/1049#pullrequestreview-442756125", "createdAt": "2020-07-06T03:36:28Z", "commit": {"oid": "50929247a1da2eb3a36bff075cf447114a62ae28"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwMzozNjoyOFrOGtH23w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwMzo1NDoyNlrOGtIDow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk2NzgzOQ==", "bodyText": "this synchronized seems not necessary ?", "url": "https://github.com/apache/ozone/pull/1049#discussion_r449967839", "createdAt": "2020-07-06T03:36:28Z", "author": {"login": "GlenGeng"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java", "diffHunk": "@@ -130,7 +134,7 @@ public static PipelineManagerV2Impl newPipelineManager(\n   }\n \n   @Override\n-  public Pipeline createPipeline(ReplicationType type,\n+  public synchronized Pipeline createPipeline(ReplicationType type,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50929247a1da2eb3a36bff075cf447114a62ae28"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk3MTEwNw==", "bodyText": "From a Datanode side, will it be better if close container before close pipeline? Call pipelineFactory.close() before closeContainersForPipeline()  will send out ClosePipelineCommand ahead of CloseContainerCommand, which will make container unhealthy.\nRefer to CloseContainerCommandHandler\n      switch (container.getContainerState()) {\n      case OPEN:\n      case CLOSING:\n        // If the container is part of open pipeline, close it via write channel\n        if (ozoneContainer.getWriteChannel()\n            .isExist(closeCommand.getPipelineID())) {\n          ContainerCommandRequestProto request =\n              getContainerCommandRequestProto(datanodeDetails,\n                  closeCommand.getContainerID());\n          ozoneContainer.getWriteChannel()\n              .submitRequest(request, closeCommand.getPipelineID());\n        } else {\n          // Container should not exist in CLOSING state without a pipeline\n          controller.markContainerUnhealthy(containerId);\n        }", "url": "https://github.com/apache/ozone/pull/1049#discussion_r449971107", "createdAt": "2020-07-06T03:54:26Z", "author": {"login": "GlenGeng"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java", "diffHunk": "@@ -310,94 +321,72 @@ public void openPipeline(PipelineID pipelineId) throws IOException {\n   }\n \n   /**\n-   * Finalizes pipeline in the SCM. Removes pipeline and makes rpc call to\n-   * destroy pipeline on the datanodes immediately or after timeout based on the\n-   * value of onTimeout parameter.\n-   *\n-   * @param pipeline        - Pipeline to be destroyed\n-   * @param onTimeout       - if true pipeline is removed and destroyed on\n-   *                        datanodes after timeout\n-   * @throws IOException\n-   */\n-  @Override\n-  public void finalizeAndDestroyPipeline(Pipeline pipeline, boolean onTimeout)\n-      throws IOException {\n-    LOG.info(\"Destroying pipeline:{}\", pipeline);\n-    finalizePipeline(pipeline.getId());\n-    if (onTimeout) {\n-      long pipelineDestroyTimeoutInMillis =\n-          conf.getTimeDuration(ScmConfigKeys.OZONE_SCM_PIPELINE_DESTROY_TIMEOUT,\n-              ScmConfigKeys.OZONE_SCM_PIPELINE_DESTROY_TIMEOUT_DEFAULT,\n-              TimeUnit.MILLISECONDS);\n-      scheduler.schedule(() -> destroyPipeline(pipeline),\n-          pipelineDestroyTimeoutInMillis, TimeUnit.MILLISECONDS, LOG,\n-          String.format(\"Destroy pipeline failed for pipeline:%s\", pipeline));\n-    } else {\n-      destroyPipeline(pipeline);\n-    }\n-  }\n-\n-  /**\n-   * Moves the pipeline to CLOSED state and sends close container command for\n-   * all the containers in the pipeline.\n+   * Removes the pipeline from the db and pipeline state map.\n    *\n-   * @param pipelineId - ID of the pipeline to be moved to CLOSED state.\n+   * @param pipeline - pipeline to be removed\n    * @throws IOException\n    */\n-  private void finalizePipeline(PipelineID pipelineId) throws IOException {\n+  protected void removePipeline(Pipeline pipeline) throws IOException {\n+    pipelineFactory.close(pipeline.getType(), pipeline);\n+    PipelineID pipelineID = pipeline.getId();\n     lock.writeLock().lock();\n     try {\n-      Pipeline pipeline = stateManager.getPipeline(pipelineId);\n-      if (!pipeline.isClosed()) {\n-        stateManager.updatePipelineState(\n-            pipelineId.getProtobuf(), HddsProtos.PipelineState.PIPELINE_CLOSED);\n-        LOG.info(\"Pipeline {} moved to CLOSED state\", pipeline);\n-      }\n-\n-      // TODO fire events to datanodes for closing pipelines\n-//      Set<ContainerID> containerIDs = stateManager.getContainers(pipelineId);\n-//      for (ContainerID containerID : containerIDs) {\n-//        eventPublisher.fireEvent(SCMEvents.CLOSE_CONTAINER, containerID);\n-//      }\n-      metrics.removePipelineMetrics(pipelineId);\n+      closeContainersForPipeline(pipelineID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50929247a1da2eb3a36bff075cf447114a62ae28"}, "originalPosition": 137}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a7a822b3b7f7e1b6934cca992ec28ae6fe77f1e", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/5a7a822b3b7f7e1b6934cca992ec28ae6fe77f1e", "committedDate": "2020-07-06T06:40:10Z", "message": "Update PipelineManagerV2 close container sequence."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MDk4ODQ5", "url": "https://github.com/apache/ozone/pull/1049#pullrequestreview-444098849", "createdAt": "2020-07-07T17:20:25Z", "commit": {"oid": "5a7a822b3b7f7e1b6934cca992ec28ae6fe77f1e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzoyMDoyNlrOGuITAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzoyMDoyNlrOGuITAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAyMzYxNw==", "bodyText": "Do we need to check the time against ScmConfigKeys.OZONE_SCM_PIPELINE_DESTROY_TIMEOUT since it enter into the CLOSED state before closecontainer and removepipeline?", "url": "https://github.com/apache/ozone/pull/1049#discussion_r451023617", "createdAt": "2020-07-07T17:20:26Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java", "diffHunk": "@@ -410,18 +399,29 @@ public void scrubPipeline(ReplicationType type, ReplicationFactor factor)\n         ScmConfigKeys.OZONE_SCM_PIPELINE_ALLOCATED_TIMEOUT,\n         ScmConfigKeys.OZONE_SCM_PIPELINE_ALLOCATED_TIMEOUT_DEFAULT,\n         TimeUnit.MILLISECONDS);\n-    List<Pipeline> needToSrubPipelines = stateManager.getPipelines(type, factor,\n-        Pipeline.PipelineState.ALLOCATED).stream()\n-        .filter(p -> currentTime.toEpochMilli() - p.getCreationTimestamp()\n-            .toEpochMilli() >= pipelineScrubTimeoutInMills)\n-        .collect(Collectors.toList());\n-    for (Pipeline p : needToSrubPipelines) {\n-      LOG.info(\"Scrubbing pipeline: id: \" + p.getId().toString() +\n-          \" since it stays at ALLOCATED stage for \" +\n-          Duration.between(currentTime, p.getCreationTimestamp()).toMinutes() +\n-          \" mins.\");\n-      finalizeAndDestroyPipeline(p, false);\n+\n+    List<Pipeline> candidates = stateManager.getPipelines(type, factor);\n+\n+    for (Pipeline p : candidates) {\n+      // scrub pipelines who stay ALLOCATED for too long.\n+      if (p.getPipelineState() == Pipeline.PipelineState.ALLOCATED &&\n+          (currentTime.toEpochMilli() - p.getCreationTimestamp()\n+              .toEpochMilli() >= pipelineScrubTimeoutInMills)) {\n+        LOG.info(\"Scrubbing pipeline: id: \" + p.getId().toString() +\n+            \" since it stays at ALLOCATED stage for \" +\n+            Duration.between(currentTime, p.getCreationTimestamp())\n+                .toMinutes() + \" mins.\");\n+        closePipeline(p, false);\n+      }\n+      // scrub pipelines who stay CLOSED for too long.\n+      if (p.getPipelineState() == Pipeline.PipelineState.CLOSED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a7a822b3b7f7e1b6934cca992ec28ae6fe77f1e"}, "originalPosition": 235}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MDk5Njky", "url": "https://github.com/apache/ozone/pull/1049#pullrequestreview-444099692", "createdAt": "2020-07-07T17:21:36Z", "commit": {"oid": "5a7a822b3b7f7e1b6934cca992ec28ae6fe77f1e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzoyMTozN1rOGuIVmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzoyMTozN1rOGuIVmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAyNDI4Mg==", "bodyText": "how do we handle onTimeout==True? Do we assume pipeline scrubber to handle this below?", "url": "https://github.com/apache/ozone/pull/1049#discussion_r451024282", "createdAt": "2020-07-07T17:21:37Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelineManagerV2Impl.java", "diffHunk": "@@ -310,94 +321,72 @@ public void openPipeline(PipelineID pipelineId) throws IOException {\n   }\n \n   /**\n-   * Finalizes pipeline in the SCM. Removes pipeline and makes rpc call to\n-   * destroy pipeline on the datanodes immediately or after timeout based on the\n-   * value of onTimeout parameter.\n-   *\n-   * @param pipeline        - Pipeline to be destroyed\n-   * @param onTimeout       - if true pipeline is removed and destroyed on\n-   *                        datanodes after timeout\n-   * @throws IOException\n-   */\n-  @Override\n-  public void finalizeAndDestroyPipeline(Pipeline pipeline, boolean onTimeout)\n-      throws IOException {\n-    LOG.info(\"Destroying pipeline:{}\", pipeline);\n-    finalizePipeline(pipeline.getId());\n-    if (onTimeout) {\n-      long pipelineDestroyTimeoutInMillis =\n-          conf.getTimeDuration(ScmConfigKeys.OZONE_SCM_PIPELINE_DESTROY_TIMEOUT,\n-              ScmConfigKeys.OZONE_SCM_PIPELINE_DESTROY_TIMEOUT_DEFAULT,\n-              TimeUnit.MILLISECONDS);\n-      scheduler.schedule(() -> destroyPipeline(pipeline),\n-          pipelineDestroyTimeoutInMillis, TimeUnit.MILLISECONDS, LOG,\n-          String.format(\"Destroy pipeline failed for pipeline:%s\", pipeline));\n-    } else {\n-      destroyPipeline(pipeline);\n-    }\n-  }\n-\n-  /**\n-   * Moves the pipeline to CLOSED state and sends close container command for\n-   * all the containers in the pipeline.\n+   * Removes the pipeline from the db and pipeline state map.\n    *\n-   * @param pipelineId - ID of the pipeline to be moved to CLOSED state.\n+   * @param pipeline - pipeline to be removed\n    * @throws IOException\n    */\n-  private void finalizePipeline(PipelineID pipelineId) throws IOException {\n+  protected void removePipeline(Pipeline pipeline) throws IOException {\n+    pipelineFactory.close(pipeline.getType(), pipeline);\n+    PipelineID pipelineID = pipeline.getId();\n     lock.writeLock().lock();\n     try {\n-      Pipeline pipeline = stateManager.getPipeline(pipelineId);\n-      if (!pipeline.isClosed()) {\n-        stateManager.updatePipelineState(\n-            pipelineId.getProtobuf(), HddsProtos.PipelineState.PIPELINE_CLOSED);\n-        LOG.info(\"Pipeline {} moved to CLOSED state\", pipeline);\n-      }\n-\n-      // TODO fire events to datanodes for closing pipelines\n-//      Set<ContainerID> containerIDs = stateManager.getContainers(pipelineId);\n-//      for (ContainerID containerID : containerIDs) {\n-//        eventPublisher.fireEvent(SCMEvents.CLOSE_CONTAINER, containerID);\n-//      }\n-      metrics.removePipelineMetrics(pipelineId);\n+      stateManager.removePipeline(pipelineID.getProtobuf());\n+      metrics.incNumPipelineDestroyed();\n+    } catch (IOException ex) {\n+      metrics.incNumPipelineDestroyFailed();\n+      throw ex;\n     } finally {\n       lock.writeLock().unlock();\n     }\n   }\n \n   /**\n-   * Removes pipeline from SCM. Sends ratis command to destroy pipeline on all\n-   * the datanodes for ratis pipelines.\n-   *\n-   * @param pipeline        - Pipeline to be destroyed\n+   * Fire events to close all containers related to the input pipeline.\n+   * @param pipelineId - ID of the pipeline.\n    * @throws IOException\n    */\n-  protected void destroyPipeline(Pipeline pipeline) throws IOException {\n-    pipelineFactory.close(pipeline.getType(), pipeline);\n-    // remove the pipeline from the pipeline manager\n-    removePipeline(pipeline.getId());\n-    triggerPipelineCreation();\n+  protected void closeContainersForPipeline(final PipelineID pipelineId)\n+      throws IOException {\n+    Set<ContainerID> containerIDs = stateManager.getContainers(pipelineId);\n+    for (ContainerID containerID : containerIDs) {\n+      eventPublisher.fireEvent(SCMEvents.CLOSE_CONTAINER, containerID);\n+    }\n   }\n \n   /**\n-   * Removes the pipeline from the db and pipeline state map.\n-   *\n-   * @param pipelineId - ID of the pipeline to be removed\n+   * put pipeline in CLOSED state.\n+   * @param pipeline - ID of the pipeline.\n+   * @param onTimeout - whether to remove pipeline after some time.\n    * @throws IOException\n    */\n-  protected void removePipeline(PipelineID pipelineId) throws IOException {\n+  @Override\n+  public void closePipeline(Pipeline pipeline, boolean onTimeout)\n+      throws IOException {\n+    PipelineID pipelineID = pipeline.getId();\n     lock.writeLock().lock();\n     try {\n-      stateManager.removePipeline(pipelineId.getProtobuf());\n-      metrics.incNumPipelineDestroyed();\n-    } catch (IOException ex) {\n-      metrics.incNumPipelineDestroyFailed();\n-      throw ex;\n+      if (!pipeline.isClosed()) {\n+        stateManager.updatePipelineState(pipelineID.getProtobuf(),\n+            HddsProtos.PipelineState.PIPELINE_CLOSED);\n+        LOG.info(\"Pipeline {} moved to CLOSED state\", pipeline);\n+      }\n+      metrics.removePipelineMetrics(pipelineID);\n     } finally {\n       lock.writeLock().unlock();\n     }\n+    if (!onTimeout) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a7a822b3b7f7e1b6934cca992ec28ae6fe77f1e"}, "originalPosition": 190}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MTAwNDIw", "url": "https://github.com/apache/ozone/pull/1049#pullrequestreview-444100420", "createdAt": "2020-07-07T17:22:37Z", "commit": {"oid": "5a7a822b3b7f7e1b6934cca992ec28ae6fe77f1e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzoyMjozN1rOGuIX9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzoyMjozN1rOGuIX9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAyNDg4Ng==", "bodyText": "Same as the comments for V2 manager.", "url": "https://github.com/apache/ozone/pull/1049#discussion_r451024886", "createdAt": "2020-07-07T17:22:37Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/SCMPipelineManager.java", "diffHunk": "@@ -421,18 +438,29 @@ public void scrubPipeline(ReplicationType type, ReplicationFactor factor)\n         ScmConfigKeys.OZONE_SCM_PIPELINE_ALLOCATED_TIMEOUT,\n         ScmConfigKeys.OZONE_SCM_PIPELINE_ALLOCATED_TIMEOUT_DEFAULT,\n         TimeUnit.MILLISECONDS);\n-    List<Pipeline> needToSrubPipelines = stateManager.getPipelines(type, factor,\n-        Pipeline.PipelineState.ALLOCATED).stream()\n-        .filter(p -> currentTime.toEpochMilli() - p.getCreationTimestamp()\n-            .toEpochMilli() >= pipelineScrubTimeoutInMills)\n-        .collect(Collectors.toList());\n-    for (Pipeline p : needToSrubPipelines) {\n-      LOG.info(\"Scrubbing pipeline: id: \" + p.getId().toString() +\n-          \" since it stays at ALLOCATED stage for \" +\n-          Duration.between(currentTime, p.getCreationTimestamp()).toMinutes() +\n-          \" mins.\");\n-      finalizeAndDestroyPipeline(p, false);\n+\n+    List<Pipeline> candidates = stateManager.getPipelines(type, factor);\n+\n+    for (Pipeline p : candidates) {\n+      // scrub pipelines who stay ALLOCATED for too long.\n+      if (p.getPipelineState() == Pipeline.PipelineState.ALLOCATED &&\n+          (currentTime.toEpochMilli() - p.getCreationTimestamp()\n+              .toEpochMilli() >= pipelineScrubTimeoutInMills)) {\n+        LOG.info(\"Scrubbing pipeline: id: \" + p.getId().toString() +\n+            \" since it stays at ALLOCATED stage for \" +\n+            Duration.between(currentTime, p.getCreationTimestamp())\n+                .toMinutes() + \" mins.\");\n+        closePipeline(p, false);\n+      }\n+      // scrub pipelines who stay CLOSED for too long.\n+      if (p.getPipelineState() == Pipeline.PipelineState.CLOSED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a7a822b3b7f7e1b6934cca992ec28ae6fe77f1e"}, "originalPosition": 110}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MTA4MzM5", "url": "https://github.com/apache/ozone/pull/1049#pullrequestreview-444108339", "createdAt": "2020-07-07T17:33:50Z", "commit": {"oid": "5a7a822b3b7f7e1b6934cca992ec28ae6fe77f1e"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "525eee77e7e1a17fcd3cde01c72e6bf67f5b51e2", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/525eee77e7e1a17fcd3cde01c72e6bf67f5b51e2", "committedDate": "2020-07-09T09:08:13Z", "message": "Add delayed action for closing pipeline after closing containers."}, "afterCommit": {"oid": "9ef6254f2d03053d5079aa900aa3e20865787eba", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/9ef6254f2d03053d5079aa900aa3e20865787eba", "committedDate": "2020-07-10T04:00:34Z", "message": "Add delayed action for closing pipeline after closing containers."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ef6254f2d03053d5079aa900aa3e20865787eba", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/9ef6254f2d03053d5079aa900aa3e20865787eba", "committedDate": "2020-07-10T04:00:34Z", "message": "Add delayed action for closing pipeline after closing containers."}, "afterCommit": {"oid": "36e9c89895cb95f29043497e0f88aec06dab6794", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/36e9c89895cb95f29043497e0f88aec06dab6794", "committedDate": "2020-07-10T07:28:08Z", "message": "Add delayed action for closing pipeline after closing containers."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a99c83eb28287f0f5e2ac7b801c5db5bc69445b", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/5a99c83eb28287f0f5e2ac7b801c5db5bc69445b", "committedDate": "2020-07-10T09:24:21Z", "message": "Add delayed action for closing pipeline after closing containers."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "36e9c89895cb95f29043497e0f88aec06dab6794", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/36e9c89895cb95f29043497e0f88aec06dab6794", "committedDate": "2020-07-10T07:28:08Z", "message": "Add delayed action for closing pipeline after closing containers."}, "afterCommit": {"oid": "5a99c83eb28287f0f5e2ac7b801c5db5bc69445b", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/5a99c83eb28287f0f5e2ac7b801c5db5bc69445b", "committedDate": "2020-07-10T09:24:21Z", "message": "Add delayed action for closing pipeline after closing containers."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3168, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}