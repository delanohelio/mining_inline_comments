{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5Nzg4Nzgx", "number": 605, "title": "HDDS-3072. SCM scrub pipeline should be started after coming out of safe mode.", "bodyText": "What changes were proposed in this pull request?\n\nStart scrubbing once we are out of safe mode.\nRemove clean up pipeline logic, as scrubber is taking care of that.\nCall trigger pipeline creation once after safe mode time out.\n\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3072\nHow was this patch tested?\nExisting tests should cover this. I will see if I can add integration test.", "createdAt": "2020-02-25T20:38:51Z", "url": "https://github.com/apache/ozone/pull/605", "merged": true, "mergeCommit": {"oid": "252f56d63d157eeb8b0da05e5fbb535783468b99"}, "closed": true, "closedAt": "2020-03-06T15:53:17Z", "author": {"login": "bharatviswa504"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcH4VyZABqjMwNzA5MjkzMzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKcGHmgBqjMwOTgxNDY1OTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "76cb4169eedff0177be255360388da36412c40a6", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/76cb4169eedff0177be255360388da36412c40a6", "committedDate": "2020-02-25T20:36:31Z", "message": "HDDS-3072. SCM scrub pipeline should be started after coming out of safe mode."}, "afterCommit": {"oid": "cdeec024bc5b42d7f8f8f36f7f6ec62f16de797c", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/cdeec024bc5b42d7f8f8f36f7f6ec62f16de797c", "committedDate": "2020-02-25T20:41:51Z", "message": "HDDS-3072. SCM scrub pipeline should be started after coming out of safe mode."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cdeec024bc5b42d7f8f8f36f7f6ec62f16de797c", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/cdeec024bc5b42d7f8f8f36f7f6ec62f16de797c", "committedDate": "2020-02-25T20:41:51Z", "message": "HDDS-3072. SCM scrub pipeline should be started after coming out of safe mode."}, "afterCommit": {"oid": "9fe0ae46f11703ef52b228bbc97a47121e16c4ec", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/9fe0ae46f11703ef52b228bbc97a47121e16c4ec", "committedDate": "2020-02-25T20:42:50Z", "message": "HDDS-3072. SCM scrub pipeline should be started after coming out of safe mode."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NjU0OTEx", "url": "https://github.com/apache/ozone/pull/605#pullrequestreview-368654911", "createdAt": "2020-03-04T10:17:41Z", "commit": {"oid": "96c35a6b0fd4600c03f09821e83ea1e0f0dcc3c6"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDoxNzo0MVrOFxnaWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDoyMDozNlrOFxngmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3MDI2NA==", "bodyText": "We can save this step as most likely it's still in safe mode at the time.", "url": "https://github.com/apache/ozone/pull/605#discussion_r387570264", "createdAt": "2020-03-04T10:17:41Z", "author": {"login": "ChenSammi"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/server/StorageContainerManager.java", "diffHunk": "@@ -358,6 +358,9 @@ public StorageContainerManager(OzoneConfiguration conf,\n     eventQueue.addHandler(SCMEvents.PIPELINE_ACTIONS, pipelineActionHandler);\n     eventQueue.addHandler(SCMEvents.PIPELINE_REPORT, pipelineReportHandler);\n     eventQueue.addHandler(SCMEvents.SAFE_MODE_STATUS, safeModeHandler);\n+\n+    // Emit initial safe mode status, as now handlers are registered.\n+    scmSafeModeManager.emitSafeModeStatus();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96c35a6b0fd4600c03f09821e83ea1e0f0dcc3c6"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU3MTg2Ng==", "bodyText": "Thanks @bharatviswa504 for the detail explanation.\nWhen add triggerPipelineCreation() here,  we'd better remove the pipelineManager.startPipelineCreator(); in SCMSafeModeManager#exitSafeMode, otherwise, the time wait actually doesn't has effect on pipeline scrubber in PipelineManager.\nAlso, I would suggest move the scmPipelineManager.setSafeModeStatus(isInSafeMode.get()); into the safeModeExitThread run.", "url": "https://github.com/apache/ozone/pull/605#discussion_r387571866", "createdAt": "2020-03-04T10:20:36Z", "author": {"login": "ChenSammi"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/safemode/SafeModeHandler.java", "diffHunk": "@@ -115,7 +113,7 @@ public void onMessage(SafeModeStatus safeModeStatus,\n           Thread.currentThread().interrupt();\n         }\n         replicationManager.start();\n-        cleanupPipelines();\n+        scmPipelineManager.triggerPipelineCreation();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96c35a6b0fd4600c03f09821e83ea1e0f0dcc3c6"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87ba67a0d18e96c4689f88393df8808dc21b9dae", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/87ba67a0d18e96c4689f88393df8808dc21b9dae", "committedDate": "2020-03-04T18:47:02Z", "message": "HDDS-3072. SCM scrub pipeline should be started after coming out of safe mode."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8d5fee8e889bb0b0848ac9231e3927054eecc7a", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/b8d5fee8e889bb0b0848ac9231e3927054eecc7a", "committedDate": "2020-03-04T18:47:03Z", "message": "remove test change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "486a3cb4d7c3553ee60d2f4ba0311d20e69da3c0", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/486a3cb4d7c3553ee60d2f4ba0311d20e69da3c0", "committedDate": "2020-03-04T18:47:03Z", "message": "check style."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a247b0ecf6a5fcf220795c7bbeb24cae0fa1bd7c", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/a247b0ecf6a5fcf220795c7bbeb24cae0fa1bd7c", "committedDate": "2020-03-04T19:29:06Z", "message": "fix sammi comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "96c35a6b0fd4600c03f09821e83ea1e0f0dcc3c6", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/96c35a6b0fd4600c03f09821e83ea1e0f0dcc3c6", "committedDate": "2020-02-26T00:28:54Z", "message": "check style."}, "afterCommit": {"oid": "a247b0ecf6a5fcf220795c7bbeb24cae0fa1bd7c", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/a247b0ecf6a5fcf220795c7bbeb24cae0fa1bd7c", "committedDate": "2020-03-04T19:29:06Z", "message": "fix sammi comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3631, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}