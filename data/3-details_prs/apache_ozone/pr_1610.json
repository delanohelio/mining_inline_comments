{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1OTEwMzk1", "number": 1610, "title": "HDDS-4473. Reduce number of sortDatanodes RPC calls", "bodyText": "What changes were proposed in this pull request?\nKeyManagerImpl#listStatus and the sortDatanodeInPipeline helper method sort datanodes using individual RPC call for each key location info.\nImprovements in this change:\n\nProcess only the \"latest\" location version instead of all versions.  If I understand correctly, only the \"latest\" version is used for read.\nKeep track of processed pipelines.  If another key or location refers to the same pipeline, avoid repeating the query.\n\nPossible improvement left for later: send a single sortDatanodes request for all datanodes in all relevant pipelines, then create the per-pipeline lists locally.\nhttps://issues.apache.org/jira/browse/HDDS-4473\nHow was this patch tested?\nAdded unit test for sortDatanodes and added check in existing test case for listStatus.", "createdAt": "2020-11-23T18:13:58Z", "url": "https://github.com/apache/ozone/pull/1610", "merged": true, "mergeCommit": {"oid": "90944636e6ca143dace266d066fbf00a7a56f263"}, "closed": true, "closedAt": "2020-12-01T15:57:21Z", "author": {"login": "adoroszlai"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdd_dRjAH2gAyNTI1OTEwMzk1OjdhODU1ZTcwMjY4OTA0ZjdlNWM4Y2I2MWYyMDYzNTljMjNmNTQxNjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdh4LdOAFqTU0MTgwMTQyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7a855e70268904f7e5c8cb61f206359c23f54165", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/7a855e70268904f7e5c8cb61f206359c23f54165", "committedDate": "2020-11-19T09:37:02Z", "message": "HDDS-4473. Reduce number of sortDatanodes RPC calls"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1272b064c355d3116c1937971ba428e185e2b4f5", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/1272b064c355d3116c1937971ba428e185e2b4f5", "committedDate": "2020-11-30T18:44:02Z", "message": "Merge remote-tracking branch 'origin/master' into HDDS-4473"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfd96934d13d53d987fa4097b549254b3a6244e3", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/cfd96934d13d53d987fa4097b549254b3a6244e3", "committedDate": "2020-11-30T19:18:04Z", "message": "Use node ID set as key for sorted pipeline cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "457acb6974d48c780346ae4e857f2f7c2220029c", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/457acb6974d48c780346ae4e857f2f7c2220029c", "committedDate": "2020-11-30T21:52:48Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "102a57a9b7cd1b70d3e32ca93367398a33ec0592", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/102a57a9b7cd1b70d3e32ca93367398a33ec0592", "committedDate": "2020-12-01T07:51:01Z", "message": "trigger new CI check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNzcxMTg2", "url": "https://github.com/apache/ozone/pull/1610#pullrequestreview-541771186", "createdAt": "2020-12-01T10:43:48Z", "commit": {"oid": "cfd96934d13d53d987fa4097b549254b3a6244e3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMDo0Mzo0OFrOH8ms3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMDo0Mzo0OFrOH8ms3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzMxMDY4Nw==", "bodyText": "Do you think it would be better to return a Set directly in toNodeUuid(...), rather than return a list and then create a set from it? Its a tiny optimisation but I don't think we really need the intermediate list - its just used in the log message later and we can probably just use \"nodes\" rather than nodeList in the log as it was before.", "url": "https://github.com/apache/ozone/pull/1610#discussion_r533310687", "createdAt": "2020-12-01T10:43:48Z", "author": {"login": "sodonnel"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java", "diffHunk": "@@ -2322,21 +2322,22 @@ void sortDatanodes(String clientMachine, OmKeyInfo... keyInfos) {\n         }\n         for (OmKeyLocationInfo k : key.getLocationList()) {\n           Pipeline pipeline = k.getPipeline();\n-          PipelineID pipelineId = pipeline.getId();\n-          List<DatanodeDetails> sortedNodes = sortedPipelines.get(pipelineId);\n+          List<DatanodeDetails> nodes = pipeline.getNodes();\n+          List<String> uuidList = toNodeUuid(nodes);\n+          Set<String> uuidSet = new HashSet<>(uuidList);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfd96934d13d53d987fa4097b549254b3a6244e3"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxODAxNDI0", "url": "https://github.com/apache/ozone/pull/1610#pullrequestreview-541801424", "createdAt": "2020-12-01T11:23:56Z", "commit": {"oid": "102a57a9b7cd1b70d3e32ca93367398a33ec0592"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1939, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}