{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4MDgzODE2", "number": 1378, "title": "HDDS-4133. Use new ContainerManager in SCM.", "bodyText": "What changes were proposed in this pull request?\nUse new ContainerManager implementation in SCM\nWhat is the link to the Apache JIRA\nHDDS-4133\nHow was this patch tested?\nUnit tests", "createdAt": "2020-09-02T18:46:58Z", "url": "https://github.com/apache/ozone/pull/1378", "merged": true, "mergeCommit": {"oid": "8b16a3531a81d6fdf932e4896ebd6308fceec32b"}, "closed": true, "closedAt": "2020-12-16T06:32:29Z", "author": {"login": "nandakumar131"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJC4ebgFqTQ4NzQ5NjMyMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmfNtFgBqjQxMTYyMDQyMDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NDk2MzIz", "url": "https://github.com/apache/ozone/pull/1378#pullrequestreview-487496323", "createdAt": "2020-09-14T07:44:07Z", "commit": {"oid": "a824b1b4dd3829f451cf8828d93914646e9ca0ba"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNzo0NDowN1rOHRHqyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwNjowOToxNVrOHRyHAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcxMzQ4Mw==", "bodyText": "Is 0 a valid containerID ?", "url": "https://github.com/apache/ozone/pull/1378#discussion_r487713483", "createdAt": "2020-09-14T07:44:07Z", "author": {"login": "GlenGeng"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerID.java", "diffHunk": "@@ -41,8 +41,8 @@\n    * @param id int\n    */\n   private ContainerID(long id) {\n-    Preconditions.checkState(id > 0,\n-        \"Container ID should be a positive. %s.\", id);\n+    Preconditions.checkState(id >= 0,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a824b1b4dd3829f451cf8828d93914646e9ca0ba"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQwODgzMw==", "bodyText": "why not synchronize on pipeline ?", "url": "https://github.com/apache/ozone/pull/1378#discussion_r488408833", "createdAt": "2020-09-15T06:09:15Z", "author": {"login": "GlenGeng"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerImpl.java", "diffHunk": "@@ -242,19 +286,82 @@ public void removeContainerReplica(final ContainerID id,\n   @Override\n   public void updateDeleteTransactionId(\n       final Map<ContainerID, Long> deleteTransactionMap) throws IOException {\n-    throw new UnsupportedOperationException(\"Not yet implemented!\");\n+    lock.writeLock().lock();\n+    try {\n+      containerStateManager.updateDeleteTransactionId(deleteTransactionMap);\n+    } finally {\n+      lock.writeLock().unlock();\n+    }\n   }\n \n   @Override\n   public ContainerInfo getMatchingContainer(final long size, final String owner,\n-      final Pipeline pipeline, final List<ContainerID> excludedContainerIDS) {\n-    throw new UnsupportedOperationException(\"Not yet implemented!\");\n+      final Pipeline pipeline, final Set<ContainerID> excludedContainerIDs) {\n+    NavigableSet<ContainerID> containerIDs;\n+    ContainerInfo containerInfo;\n+    try {\n+      synchronized (pipeline.getId()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a824b1b4dd3829f451cf8828d93914646e9ca0ba"}, "originalPosition": 184}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a824b1b4dd3829f451cf8828d93914646e9ca0ba", "author": {"user": {"login": "nandakumar131", "name": "Nandakumar"}}, "url": "https://github.com/apache/ozone/commit/a824b1b4dd3829f451cf8828d93914646e9ca0ba", "committedDate": "2020-09-02T18:44:49Z", "message": "HDDS-4133. Use new ContainerManager in SCM."}, "afterCommit": {"oid": "52d93a069da553930163c7a46c0f3fa273dbc336", "author": {"user": {"login": "nandakumar131", "name": "Nandakumar"}}, "url": "https://github.com/apache/ozone/commit/52d93a069da553930163c7a46c0f3fa273dbc336", "committedDate": "2020-12-13T18:57:56Z", "message": "HDDS-4133. Use new ContainerManager in SCM."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "52d93a069da553930163c7a46c0f3fa273dbc336", "author": {"user": {"login": "nandakumar131", "name": "Nandakumar"}}, "url": "https://github.com/apache/ozone/commit/52d93a069da553930163c7a46c0f3fa273dbc336", "committedDate": "2020-12-13T18:57:56Z", "message": "HDDS-4133. Use new ContainerManager in SCM."}, "afterCommit": {"oid": "17da350a47d85981a474e4b8e833089de3c3ab1e", "author": {"user": {"login": "nandakumar131", "name": "Nandakumar"}}, "url": "https://github.com/apache/ozone/commit/17da350a47d85981a474e4b8e833089de3c3ab1e", "committedDate": "2020-12-14T06:13:16Z", "message": "HDDS-4133. Use new ContainerManager in SCM."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b523583bbae485564781d5a60107f5764b2c05aa", "author": {"user": {"login": "nandakumar131", "name": "Nandakumar"}}, "url": "https://github.com/apache/ozone/commit/b523583bbae485564781d5a60107f5764b2c05aa", "committedDate": "2020-12-14T07:18:09Z", "message": "HDDS-4133. Use new ContainerManager in SCM."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "17da350a47d85981a474e4b8e833089de3c3ab1e", "author": {"user": {"login": "nandakumar131", "name": "Nandakumar"}}, "url": "https://github.com/apache/ozone/commit/17da350a47d85981a474e4b8e833089de3c3ab1e", "committedDate": "2020-12-14T06:13:16Z", "message": "HDDS-4133. Use new ContainerManager in SCM."}, "afterCommit": {"oid": "b523583bbae485564781d5a60107f5764b2c05aa", "author": {"user": {"login": "nandakumar131", "name": "Nandakumar"}}, "url": "https://github.com/apache/ozone/commit/b523583bbae485564781d5a60107f5764b2c05aa", "committedDate": "2020-12-14T07:18:09Z", "message": "HDDS-4133. Use new ContainerManager in SCM."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMTU5ODY4", "url": "https://github.com/apache/ozone/pull/1378#pullrequestreview-551159868", "createdAt": "2020-12-14T08:58:45Z", "commit": {"oid": "b523583bbae485564781d5a60107f5764b2c05aa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwODo1ODo0NVrOIFGG9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwODo1ODo0NVrOIFGG9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIxMzg3OQ==", "bodyText": "Why call incNumListContainersOps() twice here ?", "url": "https://github.com/apache/ozone/pull/1378#discussion_r542213879", "createdAt": "2020-12-14T08:58:45Z", "author": {"login": "GlenGeng"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerManagerImpl.java", "diffHunk": "@@ -111,14 +135,18 @@ public ContainerInfo getContainer(final ContainerID id)\n   }\n \n   @Override\n-  public List<ContainerInfo> listContainers(final ContainerID startID,\n-                                            final int count) {\n+  public List<ContainerInfo> getContainers(final ContainerID startID,\n+                                           final int count) {\n     lock.readLock().lock();\n+    scmContainerManagerMetrics.incNumListContainersOps();\n     try {\n+      // TODO: Remove the null check, startID should not be null. Fix the unit\n+      //  test before removing the check.\n       final long start = startID == null ? 0 : startID.getId();\n       final List<ContainerID> containersIds =\n           new ArrayList<>(containerStateManager.getContainerIDs());\n       Collections.sort(containersIds);\n+      scmContainerManagerMetrics.incNumListContainersOps();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b523583bbae485564781d5a60107f5764b2c05aa"}, "originalPosition": 84}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d475d9956fd9bebe2e03ee2f7500b1a6eb080891", "author": {"user": {"login": "nandakumar131", "name": "Nandakumar"}}, "url": "https://github.com/apache/ozone/commit/d475d9956fd9bebe2e03ee2f7500b1a6eb080891", "committedDate": "2020-12-15T12:12:49Z", "message": "Fixed Recon related issues."}, "afterCommit": {"oid": "e8281664c585ce0253306e0e3cbff07d1e704365", "author": {"user": {"login": "nandakumar131", "name": "Nandakumar"}}, "url": "https://github.com/apache/ozone/commit/e8281664c585ce0253306e0e3cbff07d1e704365", "committedDate": "2020-12-15T18:55:28Z", "message": "Fixed Recon related issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2019297853d9b41f81cf253c1bec4712dce9cc93", "author": {"user": {"login": "nandakumar131", "name": "Nandakumar"}}, "url": "https://github.com/apache/ozone/commit/2019297853d9b41f81cf253c1bec4712dce9cc93", "committedDate": "2020-12-15T19:08:10Z", "message": "Fixed Recon related issues."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e8281664c585ce0253306e0e3cbff07d1e704365", "author": {"user": {"login": "nandakumar131", "name": "Nandakumar"}}, "url": "https://github.com/apache/ozone/commit/e8281664c585ce0253306e0e3cbff07d1e704365", "committedDate": "2020-12-15T18:55:28Z", "message": "Fixed Recon related issues."}, "afterCommit": {"oid": "2019297853d9b41f81cf253c1bec4712dce9cc93", "author": {"user": {"login": "nandakumar131", "name": "Nandakumar"}}, "url": "https://github.com/apache/ozone/commit/2019297853d9b41f81cf253c1bec4712dce9cc93", "committedDate": "2020-12-15T19:08:10Z", "message": "Fixed Recon related issues."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2421, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}