{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0NzY5NjE1", "number": 988, "title": "HDDS-3681. Recon: Add support to store file size counts in each volum\u2026", "bodyText": "\u2026e/bucket\nWhat changes were proposed in this pull request?\n\nupdate utilization schema to include volume and bucket information\nupdate filesizecount task to persist volume and bucket information\nupdate utilization endpoint\n\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3681\nHow was this patch tested?\nAdded unit tests and tested the endpoint response from a docker-compose cluster.", "createdAt": "2020-05-28T22:29:40Z", "url": "https://github.com/apache/ozone/pull/988", "merged": true, "mergeCommit": {"oid": "aec7a9345e8cecdacc1367562fdd82dd4dfc34df"}, "closed": true, "closedAt": "2020-06-03T22:18:26Z", "author": {"login": "vivekratnavel"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcl1kdGAH2gAyNDI0NzY5NjE1OmM5YmY5N2JlYTBlOGRkYjcyOTJhYmMxZGVkMzNkOTBhZjUyNWUzMGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnvQBZAFqTQyMzg5MzY5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c9bf97bea0e8ddb7292abc1ded33d90af525e30c", "author": {"user": {"login": "vivekratnavel", "name": "Vivek Ratnavel Subramanian"}}, "url": "https://github.com/apache/ozone/commit/c9bf97bea0e8ddb7292abc1ded33d90af525e30c", "committedDate": "2020-05-28T22:26:04Z", "message": "HDDS-3681. Recon: Add support to store file size counts in each volume/bucket"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMTIwNTYy", "url": "https://github.com/apache/ozone/pull/988#pullrequestreview-421120562", "createdAt": "2020-05-29T16:49:20Z", "commit": {"oid": "c9bf97bea0e8ddb7292abc1ded33d90af525e30c"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNjo0OToyMFrOGckbEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNzoxMTowMFrOGclRPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYxMDA2Ng==", "bodyText": "Do we know if 64 is the actual volume & bucket name length limit as enforced by OM? If not, we have to change this to handle longer lengths.", "url": "https://github.com/apache/ozone/pull/988#discussion_r432610066", "createdAt": "2020-05-29T16:49:20Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-ozone/recon-codegen/src/main/java/org/hadoop/ozone/recon/schema/UtilizationSchemaDefinition.java", "diffHunk": "@@ -83,11 +86,17 @@ private void createClusterGrowthTable(Connection conn) {\n   }\n \n   private void createFileSizeCountTable(Connection conn) {\n-    DSL.using(conn).createTableIfNotExists(FILE_COUNT_BY_SIZE_TABLE_NAME)\n+    dslContext.createTableIfNotExists(FILE_COUNT_BY_SIZE_TABLE_NAME)\n+        .column(\"volume\", SQLDataType.VARCHAR(64))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9bf97bea0e8ddb7292abc1ded33d90af525e30c"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYxODgwOA==", "bodyText": "Good test to see how much we can handle!", "url": "https://github.com/apache/ozone/pull/988#discussion_r432618808", "createdAt": "2020-05-29T17:02:31Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-ozone/recon/src/test/java/org/apache/hadoop/ozone/recon/tasks/TestFileSizeCountTask.java", "diffHunk": "@@ -206,10 +216,189 @@ public void testProcess() {\n         Arrays.asList(updateEvent, putEvent, deleteEvent));\n     fileSizeCountTask.process(omUpdateEventBatch);\n \n-    upperBoundCount = fileSizeCountTask.getUpperBoundCount();\n-    assertEquals(1, upperBoundCount[0]); // newKey\n-    assertEquals(0, upperBoundCount[1]); // deletedKey\n-    assertEquals(0, upperBoundCount[4]); // updatedKey old\n-    assertEquals(1, upperBoundCount[6]); // updatedKey new\n+    assertEquals(4, fileCountBySizeDao.count());\n+    recordToFind.value3(1024L);\n+    assertEquals(1, fileCountBySizeDao.findById(recordToFind)\n+        .getCount().longValue());\n+    recordToFind.value3(2048L);\n+    assertEquals(0, fileCountBySizeDao.findById(recordToFind)\n+        .getCount().longValue());\n+    recordToFind.value3(16384L);\n+    assertEquals(0, fileCountBySizeDao.findById(recordToFind)\n+        .getCount().longValue());\n+    recordToFind.value3(65536L);\n+    assertEquals(1, fileCountBySizeDao.findById(recordToFind)\n+        .getCount().longValue());\n+  }\n+\n+  @Test\n+  public void testReprocessAtScale() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9bf97bea0e8ddb7292abc1ded33d90af525e30c"}, "originalPosition": 261}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYyMDc4Mw==", "bodyText": "Since we don't read everything from the DB at init time, 'fileSizeCountMap' can be a local variable created inside the 'process' and 'reprocess' methods.", "url": "https://github.com/apache/ozone/pull/988#discussion_r432620783", "createdAt": "2020-05-29T17:06:16Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/tasks/FileSizeCountTask.java", "diffHunk": "@@ -49,33 +52,28 @@\n   private static final Logger LOG =\n       LoggerFactory.getLogger(FileSizeCountTask.class);\n \n-  private int maxBinSize = -1;\n-  private long maxFileSizeUpperBound = 1125899906842624L; // 1 PB\n-  private long[] upperBoundCount;\n-  private long oneKb = 1024L;\n+  // 1125899906842624L = 1PB\n+  private static final long MAX_FILE_SIZE_UPPER_BOUND = 1125899906842624L;\n   private FileCountBySizeDao fileCountBySizeDao;\n+  // Map to store file counts in each <volume,bucket,fileSizeUpperBound>\n+  private Map<FileSizeCountKey, Long> fileSizeCountMap;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9bf97bea0e8ddb7292abc1ded33d90af525e30c"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYyMzkzMw==", "bodyText": "Can we add an endpoint for getFileCounts(volume, bucket, fileSize(Default = null)) here?", "url": "https://github.com/apache/ozone/pull/988#discussion_r432623933", "createdAt": "2020-05-29T17:11:00Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/api/UtilizationEndpoint.java", "diffHunk": "@@ -34,7 +34,7 @@\n  */\n @Path(\"/utilization\")\n @Produces(MediaType.APPLICATION_JSON)\n-public class UtilizationService {\n+public class UtilizationEndpoint {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c9bf97bea0e8ddb7292abc1ded33d90af525e30c"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e550e172c9d40154e47208a553a8825bce0d6ba0", "author": {"user": {"login": "vivekratnavel", "name": "Vivek Ratnavel Subramanian"}}, "url": "https://github.com/apache/ozone/commit/e550e172c9d40154e47208a553a8825bce0d6ba0", "committedDate": "2020-05-29T22:31:48Z", "message": "support query params for filecounts endpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a7079b74387383106b3cde1800acda1801f8862", "author": {"user": {"login": "vivekratnavel", "name": "Vivek Ratnavel Subramanian"}}, "url": "https://github.com/apache/ozone/commit/7a7079b74387383106b3cde1800acda1801f8862", "committedDate": "2020-06-01T17:38:28Z", "message": "Empty commit to retrigger CI checks."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f696119a195501f3a422efa1053f6e9f3d10b09", "author": {"user": {"login": "vivekratnavel", "name": "Vivek Ratnavel Subramanian"}}, "url": "https://github.com/apache/ozone/commit/6f696119a195501f3a422efa1053f6e9f3d10b09", "committedDate": "2020-06-01T19:42:50Z", "message": "Fix review comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9a9f641a988345b91752a3f389370d0e6c4dc03", "author": {"user": {"login": "vivekratnavel", "name": "Vivek Ratnavel Subramanian"}}, "url": "https://github.com/apache/ozone/commit/c9a9f641a988345b91752a3f389370d0e6c4dc03", "committedDate": "2020-06-02T19:15:39Z", "message": "Merge remote-tracking branch 'apache/master' into HDDS-3681"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzODkzNjkx", "url": "https://github.com/apache/ozone/pull/988#pullrequestreview-423893691", "createdAt": "2020-06-03T20:12:10Z", "commit": {"oid": "c9a9f641a988345b91752a3f389370d0e6c4dc03"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3102, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}