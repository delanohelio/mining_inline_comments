{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5OTE4MTYy", "number": 516, "title": "HDDS-2923 Add fall-back protection for rack awareness in pipeline creation.", "bodyText": "What changes were proposed in this pull request?\n#HDDS-2923 Add fall-back protection for rack awareness in pipeline creation.\n(Please fill in changes proposed in this fix)\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-2923\n(Please create an issue in ASF JIRA before opening a pull request,\nand you need to set the title of the pull request which starts with\nthe corresponding JIRA issue number. (e.g. HDDS-XXXX. Fix a typo in YYY.)\nPlease replace this section with the link to the Apache JIRA)\nHow was this patch tested?\nUT. Test in actual env.\n(Please explain how this patch was tested. Ex: unit tests, manual tests)\n(If this patch involves UI changes, please attach a screen-shot; otherwise, remove this)", "createdAt": "2020-02-01T17:09:20Z", "url": "https://github.com/apache/ozone/pull/516", "merged": true, "mergeCommit": {"oid": "43845daa30822c9fb259acaafc1748d633e76fc6"}, "closed": true, "closedAt": "2020-02-10T01:13:58Z", "author": {"login": "timmylicheng"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcAG282AH2gAyMzY5OTE4MTYyOjIzZjZjOGJmMmExNzY1NjM1YjBkMDk3NDE1NTEzZWVkNTBiYzE2NDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcCltj7gH2gAyMzY5OTE4MTYyOjc2YWVmYjkxYWZmMmVlMTJlMzQzYmQ3ODQ1MDhhMDI5NDE3NDY3MzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "23f6c8bf2a1765635b0d097415513eed50bc1646", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/23f6c8bf2a1765635b0d097415513eed50bc1646", "committedDate": "2020-02-01T17:05:32Z", "message": "HDDS-2923 Add fall-back protection for rack awareness in pipeline creation."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxOTU1MjA5", "url": "https://github.com/apache/ozone/pull/516#pullrequestreview-351955209", "createdAt": "2020-02-02T17:22:20Z", "commit": {"oid": "23f6c8bf2a1765635b0d097415513eed50bc1646"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMlQxNzoyMjoyMFrOFkis8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMlQxNzoyMjoyMFrOFkis8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzg2MTYxOA==", "bodyText": "NIT: I think we can change to check positive instead and let the for loop handle the remaining node picking naturally based on the results set size.\nboolean rackAwareness = false;\nif (nextNode != null) {\n  rackAwareness = true;\n  results.add(nextNode);\n  exclude.add(nextNode);\n}", "url": "https://github.com/apache/ozone/pull/516#discussion_r373861618", "createdAt": "2020-02-02T17:22:20Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelinePlacementPolicy.java", "diffHunk": "@@ -241,29 +269,30 @@ boolean meetCriteria(DatanodeDetails datanodeDetails, int nodesRequired) {\n     exclude.add(anchor);\n \n     // Choose the second node on different racks from anchor.\n-    DatanodeDetails nodeOnDifferentRack = chooseNodeBasedOnRackAwareness(\n+    DatanodeDetails nextNode = chooseNodeBasedOnRackAwareness(\n         healthyNodes, exclude,\n         nodeManager.getClusterNetworkTopologyMap(), anchor);\n-    if (nodeOnDifferentRack == null) {\n-      LOG.warn(\"Pipeline Placement: Unable to find 2nd node on different \" +\n-          \"racks that meets the criteria. Required nodes: {}, Found nodes:\" +\n-          \" {}\", nodesRequired, results.size());\n-      throw new SCMException(\"Unable to find required number of nodes.\",\n-          SCMException.ResultCodes.FAILED_TO_FIND_SUITABLE_NODE);\n+    if (nextNode == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23f6c8bf2a1765635b0d097415513eed50bc1646"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxOTU1MzU0", "url": "https://github.com/apache/ozone/pull/516#pullrequestreview-351955354", "createdAt": "2020-02-02T17:24:57Z", "commit": {"oid": "23f6c8bf2a1765635b0d097415513eed50bc1646"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMlQxNzoyNDo1OFrOFkitog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMlQxNzoyNDo1OFrOFkitog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzg2MTc5NA==", "bodyText": "can we add a test simple test case with topology that all nodes on the same rack with topology aware and fall back enabled?", "url": "https://github.com/apache/ozone/pull/516#discussion_r373861794", "createdAt": "2020-02-02T17:24:58Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/server-scm/src/test/java/org/apache/hadoop/hdds/scm/pipeline/TestPipelinePlacementPolicy.java", "diffHunk": "@@ -83,10 +83,36 @@ public void testChooseNodeBasedOnRackAwareness() {\n     DatanodeDetails nextNode = placementPolicy.chooseNodeBasedOnRackAwareness(\n         healthyNodes, new ArrayList<>(PIPELINE_PLACEMENT_MAX_NODES_COUNT),\n         topologyWithDifRacks, anchor);\n+    Assert.assertNotNull(nextNode);\n     Assert.assertFalse(anchor.getNetworkLocation().equals(\n         nextNode.getNetworkLocation()));\n   }\n \n+  @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23f6c8bf2a1765635b0d097415513eed50bc1646"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxOTU1MzYx", "url": "https://github.com/apache/ozone/pull/516#pullrequestreview-351955361", "createdAt": "2020-02-02T17:25:10Z", "commit": {"oid": "23f6c8bf2a1765635b0d097415513eed50bc1646"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "572195da277f70d9db62ec76a4516fd6a7692c6e", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/572195da277f70d9db62ec76a4516fd6a7692c6e", "committedDate": "2020-02-06T08:26:57Z", "message": "Add tests for pipeline placement policy when rack awareness is not enaled."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9e2e181bc81230e232fbc64e43cc3c74f5f36806", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/9e2e181bc81230e232fbc64e43cc3c74f5f36806", "committedDate": "2020-02-06T03:54:36Z", "message": "Add tests for pipeline placement policy when rack awareness is not enaled."}, "afterCommit": {"oid": "572195da277f70d9db62ec76a4516fd6a7692c6e", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/572195da277f70d9db62ec76a4516fd6a7692c6e", "committedDate": "2020-02-06T08:26:57Z", "message": "Add tests for pipeline placement policy when rack awareness is not enaled."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTg3OTcy", "url": "https://github.com/apache/ozone/pull/516#pullrequestreview-355587972", "createdAt": "2020-02-09T07:07:41Z", "commit": {"oid": "572195da277f70d9db62ec76a4516fd6a7692c6e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQwNzowNzo0MVrOFnTo_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQwNzowNzo0MVrOFnTo_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc2MDU3NA==", "bodyText": "Better to move this if statement into if (nextNode != null).", "url": "https://github.com/apache/ozone/pull/516#discussion_r376760574", "createdAt": "2020-02-09T07:07:41Z", "author": {"login": "ChenSammi"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelinePlacementPolicy.java", "diffHunk": "@@ -220,50 +243,57 @@ boolean meetCriteria(DatanodeDetails datanodeDetails, int nodesRequired) {\n   public List<DatanodeDetails> getResultSet(\n       int nodesRequired, List<DatanodeDetails> healthyNodes)\n       throws SCMException {\n+    if (nodesRequired != HddsProtos.ReplicationFactor.THREE.getNumber()) {\n+      throw new SCMException(\"Nodes required number is not supported: \" +\n+          nodesRequired, SCMException.ResultCodes.INVALID_CAPACITY);\n+    }\n+\n+    // Assume rack awareness is not enabled.\n+    boolean rackAwareness = false;\n     List <DatanodeDetails> results = new ArrayList<>(nodesRequired);\n     // Since nodes are widely distributed, the results should be selected\n     // base on distance in topology, rack awareness and load balancing.\n     List<DatanodeDetails> exclude = new ArrayList<>();\n     // First choose an anchor nodes randomly\n     DatanodeDetails anchor = chooseNode(healthyNodes);\n-    if (anchor == null) {\n-      LOG.warn(\"Unable to find healthy node for anchor(first) node.\" +\n-              \" Required nodes: {}, Found nodes: {}\",\n-          nodesRequired, results.size());\n-      throw new SCMException(\"Unable to find required number of nodes.\",\n+    if (anchor != null) {\n+      results.add(anchor);\n+      exclude.add(anchor);\n+    } else {\n+      LOG.warn(\"Unable to find healthy node for anchor(first) node.\");\n+      throw new SCMException(\"Unable to find anchor node.\",\n           SCMException.ResultCodes.FAILED_TO_FIND_SUITABLE_NODE);\n     }\n     if (LOG.isDebugEnabled()) {\n       LOG.debug(\"First node chosen: {}\", anchor);\n     }\n \n-    results.add(anchor);\n-    exclude.add(anchor);\n \n     // Choose the second node on different racks from anchor.\n-    DatanodeDetails nodeOnDifferentRack = chooseNodeBasedOnRackAwareness(\n+    DatanodeDetails nextNode = chooseNodeBasedOnRackAwareness(\n         healthyNodes, exclude,\n         nodeManager.getClusterNetworkTopologyMap(), anchor);\n-    if (nodeOnDifferentRack == null) {\n-      LOG.warn(\"Pipeline Placement: Unable to find 2nd node on different \" +\n-          \"racks that meets the criteria. Required nodes: {}, Found nodes:\" +\n-          \" {}\", nodesRequired, results.size());\n-      throw new SCMException(\"Unable to find required number of nodes.\",\n-          SCMException.ResultCodes.FAILED_TO_FIND_SUITABLE_NODE);\n+    if (nextNode != null) {\n+      // Rack awareness is detected.\n+      rackAwareness = true;\n+      results.add(nextNode);\n+      exclude.add(nextNode);\n+    } else {\n+      LOG.debug(\"Pipeline Placement: Unable to find 2nd node on different \" +\n+          \"rack based on rack awareness.\");\n     }\n     if (LOG.isDebugEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "572195da277f70d9db62ec76a4516fd6a7692c6e"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76aefb91aff2ee12e343bd784508a02941746736", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/76aefb91aff2ee12e343bd784508a02941746736", "committedDate": "2020-02-09T10:10:11Z", "message": "Modify debug message."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3810, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}