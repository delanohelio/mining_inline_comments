{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1ODQ3OTE1", "number": 654, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMjo0NjozMVrODmh0Pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMjo0NjozMVrODmh0Pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNzI2NTI2OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBTable.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMjo0NjozMVrOFz_xiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMzozNDoyN1rOF0kpOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA2NjU3MQ==", "bodyText": "whats the reason for the illegal arguement exception ? Do we have a stack trace?", "url": "https://github.com/apache/ozone/pull/654#discussion_r390066571", "createdAt": "2020-03-10T02:46:31Z", "author": {"login": "mukul1987"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBTable.java", "diffHunk": "@@ -155,6 +155,32 @@ public boolean isExist(byte[] key) throws IOException {\n     }\n   }\n \n+  @Override\n+  public byte[] getIfExist(byte[] key) throws IOException {\n+    try {\n+      // RocksDB#keyMayExist\n+      // If the key definitely does not exist in the database, then this\n+      // method returns false, else true.\n+      rdbMetrics.incNumDBKeyGetIfExistChecks();\n+      StringBuilder outValue = new StringBuilder();\n+      boolean keyMayExist = db.keyMayExist(handle, key, outValue);\n+      if (keyMayExist) {\n+        // Not using out value from string builder, as that is causing\n+        // IllegalArgumentException during protobuf parsing.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faa0c88371d544882ca7c23464fe8b18c4ac0020"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA4OTE1Mw==", "bodyText": "Because value returned from StringBuilder then to a string, which is converted to bytes[] and then later if it is used in parseFrom byte[] data.\njava.lang.IllegalArgumentException: Can't encode the the raw data from the byte array\n\tat org.apache.hadoop.ozone.om.codec.OmKeyInfoCodec.fromPersistedFormat(OmKeyInfoCodec.java:48)\n\tat org.apache.hadoop.ozone.om.codec.OmKeyInfoCodec.fromPersistedFormat(OmKeyInfoCodec.java:31)\n\tat org.apache.hadoop.hdds.utils.db.CodecRegistry.asObject(CodecRegistry.java:55)\n\tat org.apache.hadoop.hdds.utils.db.TypedTable.getFromTableIfExist(TypedTable.java:207)\n\tat org.apache.hadoop.hdds.utils.db.TypedTable.getIfExist(TypedTable.java:194)\n\tat org.apache.hadoop.ozone.om.request.key.OMKeyCreateRequest.validateAndUpdateCache(OMKeyCreateRequest.java:196)\n\tat org.apache.hadoop.ozone.protocolPB.OzoneManagerRequestHandler.handleWriteRequest(OzoneManagerRequestHandler.java:230)\n\tat org.apache.hadoop.ozone.protocolPB.OzoneManagerProtocolServerSideTranslatorPB.submitRequestDirectlyToOM(OzoneManagerProtocolServerSideTranslatorPB.java:210)\n\tat org.apache.hadoop.ozone.protocolPB.OzoneManagerProtocolServerSideTranslatorPB.processRequest(OzoneManagerProtocolServerSideTranslatorPB.java:130)\n\tat org.apache.hadoop.hdds.server.OzoneProtocolMessageDispatcher.processRequest(OzoneProtocolMessageDispatcher.java:72)\n\tat org.apache.hadoop.ozone.protocolPB.OzoneManagerProtocolServerSideTranslatorPB.submitRequest(OzoneManagerProtocolServerSideTranslatorPB.java:98)\n\tat org.apache.hadoop.ozone.protocol.proto.OzoneManagerProtocolProtos$OzoneManagerService$2.callBlockingMethod(OzoneManagerProtocolProtos.java)\n\tat org.apache.hadoop.ipc.ProtobufRpcEngine$Server$ProtoBufRpcInvoker.call(ProtobufRpcEngine.java:524)\n\tat org.apache.hadoop.ipc.RPC$Server.call(RPC.java:1025)\n\tat org.apache.hadoop.ipc.Server$RpcCall.run(Server.java:876)\n\tat org.apache.hadoop.ipc.Server$RpcCall.run(Server.java:822)\n\tat java.security.AccessController.doPrivileged(Native Method)\n\tat javax.security.auth.Subject.doAs(Subject.java:422)", "url": "https://github.com/apache/ozone/pull/654#discussion_r390089153", "createdAt": "2020-03-10T04:25:52Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBTable.java", "diffHunk": "@@ -155,6 +155,32 @@ public boolean isExist(byte[] key) throws IOException {\n     }\n   }\n \n+  @Override\n+  public byte[] getIfExist(byte[] key) throws IOException {\n+    try {\n+      // RocksDB#keyMayExist\n+      // If the key definitely does not exist in the database, then this\n+      // method returns false, else true.\n+      rdbMetrics.incNumDBKeyGetIfExistChecks();\n+      StringBuilder outValue = new StringBuilder();\n+      boolean keyMayExist = db.keyMayExist(handle, key, outValue);\n+      if (keyMayExist) {\n+        // Not using out value from string builder, as that is causing\n+        // IllegalArgumentException during protobuf parsing.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA2NjU3MQ=="}, "originalCommit": {"oid": "faa0c88371d544882ca7c23464fe8b18c4ac0020"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY2NDQ4Nw==", "bodyText": "Does this mean we cannot use the outValue that we pass in? If 'keyMayExist' returns true, and the value is indeed present in the block cache, I believe the outValue will have the data.", "url": "https://github.com/apache/ozone/pull/654#discussion_r390664487", "createdAt": "2020-03-10T23:15:44Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBTable.java", "diffHunk": "@@ -155,6 +155,32 @@ public boolean isExist(byte[] key) throws IOException {\n     }\n   }\n \n+  @Override\n+  public byte[] getIfExist(byte[] key) throws IOException {\n+    try {\n+      // RocksDB#keyMayExist\n+      // If the key definitely does not exist in the database, then this\n+      // method returns false, else true.\n+      rdbMetrics.incNumDBKeyGetIfExistChecks();\n+      StringBuilder outValue = new StringBuilder();\n+      boolean keyMayExist = db.keyMayExist(handle, key, outValue);\n+      if (keyMayExist) {\n+        // Not using out value from string builder, as that is causing\n+        // IllegalArgumentException during protobuf parsing.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA2NjU3MQ=="}, "originalCommit": {"oid": "faa0c88371d544882ca7c23464fe8b18c4ac0020"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY2OTg2MA==", "bodyText": "Yes, using that is causing the issue.", "url": "https://github.com/apache/ozone/pull/654#discussion_r390669860", "createdAt": "2020-03-10T23:31:42Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBTable.java", "diffHunk": "@@ -155,6 +155,32 @@ public boolean isExist(byte[] key) throws IOException {\n     }\n   }\n \n+  @Override\n+  public byte[] getIfExist(byte[] key) throws IOException {\n+    try {\n+      // RocksDB#keyMayExist\n+      // If the key definitely does not exist in the database, then this\n+      // method returns false, else true.\n+      rdbMetrics.incNumDBKeyGetIfExistChecks();\n+      StringBuilder outValue = new StringBuilder();\n+      boolean keyMayExist = db.keyMayExist(handle, key, outValue);\n+      if (keyMayExist) {\n+        // Not using out value from string builder, as that is causing\n+        // IllegalArgumentException during protobuf parsing.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA2NjU3MQ=="}, "originalCommit": {"oid": "faa0c88371d544882ca7c23464fe8b18c4ac0020"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY3MDY1MA==", "bodyText": "@Override\npublic byte[] get(byte[] key) throws IOException {\n  try {\n    // RocksDB#keyMayExist\n    // If the key definitely does not exist in the database, then this\n    // method returns false, else true.\n    rdbMetrics.incNumDBKeyIfExistChecks();\n    StringBuilder outValue = new StringBuilder();\n    boolean keyMayExist = db.keyMayExist(handle, key, outValue);\n    if (keyMayExist) {\n      byte[] val;\n      if (outValue.length() > 0) {\n        val = outValue.toString().getBytes(UTF_8);\n      } else {\n        val = db.get(handle, key);\n      }\n      if (val != null) {\n        rdbMetrics.incNumDBKeyIfExistMisses();\n      }\n      return val;\n    }\n    return null;\n  } catch (RocksDBException e) {\n    throw toIOException(\n        \"Error in accessing DB. \", e);\n  }\n}\n\nI tried with the above code, getting IllegalException during parsing. So, for now, removed not to use outVal.", "url": "https://github.com/apache/ozone/pull/654#discussion_r390670650", "createdAt": "2020-03-10T23:34:27Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/utils/db/RDBTable.java", "diffHunk": "@@ -155,6 +155,32 @@ public boolean isExist(byte[] key) throws IOException {\n     }\n   }\n \n+  @Override\n+  public byte[] getIfExist(byte[] key) throws IOException {\n+    try {\n+      // RocksDB#keyMayExist\n+      // If the key definitely does not exist in the database, then this\n+      // method returns false, else true.\n+      rdbMetrics.incNumDBKeyGetIfExistChecks();\n+      StringBuilder outValue = new StringBuilder();\n+      boolean keyMayExist = db.keyMayExist(handle, key, outValue);\n+      if (keyMayExist) {\n+        // Not using out value from string builder, as that is causing\n+        // IllegalArgumentException during protobuf parsing.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA2NjU3MQ=="}, "originalCommit": {"oid": "faa0c88371d544882ca7c23464fe8b18c4ac0020"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4808, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}