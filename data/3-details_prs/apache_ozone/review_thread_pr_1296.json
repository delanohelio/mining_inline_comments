{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0MDM1NTk4", "number": 1296, "reviewThreads": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwMTo0NToyM1rOEhDYAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMToyNzozMFrOEheHIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMDkzNzYzOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/interface-client/src/main/proto/OmClientProtocol.proto", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwMTo0NToyM1rOHOKE3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwMTo0NToyM1rOHOKE3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYwNzE5Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                optional uint64 quotaUsageInBytes = 12;\n          \n          \n            \n                optional uint64 quotaUsage = 12;", "url": "https://github.com/apache/ozone/pull/1296#discussion_r484607197", "createdAt": "2020-09-08T01:45:23Z", "author": {"login": "cxorm"}, "path": "hadoop-ozone/interface-client/src/main/proto/OmClientProtocol.proto", "diffHunk": "@@ -360,6 +360,8 @@ message VolumeInfo {\n     optional uint64 updateID = 9;\n     optional uint64 modificationTime = 10;\n     optional uint64 quotaInCounts = 11;\n+    optional uint64 quotaUsageInBytes = 12;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMDkzODg1OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwMTo0NjoxN1rOHOKFnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMTo0NzowOFrOHPDeAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYwNzM4OQ==", "bodyText": "How do we use QUOTA_USAGE = \"quotaUsage\" here ?\nCould you please update the rest part if you agree the idea ?", "url": "https://github.com/apache/ozone/pull/1296#discussion_r484607389", "createdAt": "2020-09-08T01:46:17Z", "author": {"login": "cxorm"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "diffHunk": "@@ -269,6 +269,7 @@ private OzoneConsts() {\n   public static final String KEY = \"key\";\n   public static final String SRC_KEY = \"srcKey\";\n   public static final String DST_KEY = \"dstKey\";\n+  public static final String QUOTA_USAGE_IN_BYTES = \"quotaUsageInBytes\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU0NzUyMg==", "bodyText": "Using quotaUsage here may not be appropriate because it makes it impossible to distinguish between QuotaUsageInBytes and later QuotaUsageInCount.\nHere we can use the usage in ContainerInfo, use usedBytes.", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485547522", "createdAt": "2020-09-09T11:47:08Z", "author": {"login": "captainzmc"}, "path": "hadoop-hdds/common/src/main/java/org/apache/hadoop/ozone/OzoneConsts.java", "diffHunk": "@@ -269,6 +269,7 @@ private OzoneConsts() {\n   public static final String KEY = \"key\";\n   public static final String SRC_KEY = \"srcKey\";\n   public static final String DST_KEY = \"dstKey\";\n+  public static final String QUOTA_USAGE_IN_BYTES = \"quotaUsageInBytes\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYwNzM4OQ=="}, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMDk1MDYwOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneVolume.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwMTo1NDowOVrOHOKMlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwMTo1NDowOVrOHOKMlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYwOTE3Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                this(conf, proxy, name, admin, owner, quotaInBytes, quotaInCounts,\n          \n          \n            \n                    creationTime, acls, metadata);\n          \n          \n            \n                this.modificationTime = Instant.ofEpochMilli(modificationTime);\n          \n          \n            \n                this.quotaUsageInBytes = quotaUsageInBytes;\n          \n          \n            \n                this(conf, proxy, name, admin, owner, quotaInBytes, quotaInCounts,\n          \n          \n            \n                    creationTime, modificationTime, acls, metadata);\n          \n          \n            \n                this.quotaUsageInBytes = quotaUsageInBytes;", "url": "https://github.com/apache/ozone/pull/1296#discussion_r484609173", "createdAt": "2020-09-08T01:54:09Z", "author": {"login": "cxorm"}, "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneVolume.java", "diffHunk": "@@ -131,6 +133,18 @@ public OzoneVolume(ConfigurationSource conf, ClientProtocol proxy,\n     this.modificationTime = Instant.ofEpochMilli(modificationTime);\n   }\n \n+  @SuppressWarnings(\"parameternumber\")\n+  public OzoneVolume(ConfigurationSource conf, ClientProtocol proxy,\n+      String name, String admin, String owner, long quotaInBytes,\n+      long quotaInCounts, long creationTime, long modificationTime,\n+      List<OzoneAcl> acls, Map<String, String> metadata,\n+      long quotaUsageInBytes) {\n+    this(conf, proxy, name, admin, owner, quotaInBytes, quotaInCounts,\n+        creationTime, acls, metadata);\n+    this.modificationTime = Instant.ofEpochMilli(modificationTime);\n+    this.quotaUsageInBytes = quotaUsageInBytes;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMDk4NTQwOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmVolumeArgs.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwMjoxNzozN1rOHOKgpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMjoyNzo0MVrOHPE4Ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYxNDMwOQ==", "bodyText": "I'm fine with the LongAdder here.\nOut of curiosity,\nCould you be so kind to tell me why we use it here ?\n(Or please describe the bad pattern if we use just long or Long)", "url": "https://github.com/apache/ozone/pull/1296#discussion_r484614309", "createdAt": "2020-09-08T02:17:37Z", "author": {"login": "cxorm"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmVolumeArgs.java", "diffHunk": "@@ -46,6 +47,7 @@\n   private long quotaInBytes;\n   private long quotaInCounts;\n   private final OmOzoneAclMap aclMap;\n+  private LongAdder quotaUsageInBytes = new LongAdder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU3MDY1MQ==", "bodyText": "QuotaUsageInBytes is a property of Volume that needs to be updated each time when CreateKey, AllocateBlock, CommitKey, DeleteKey. and at the beginning, we used the volume lock.\nBut, Previously, only Bucket locks were used for these operation, and use volume lock greatly affect the concurrency performance of different buckets under same volume.\nSo to avoid Volume locking for poor performance, LongAdder is used here to complete the atomic update of quotaUsageInBytes.\nI did a performance test with freon. Multi-threading wrote different buckets under the same volume, and using LongAdder had little impact on the original performance.", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485570651", "createdAt": "2020-09-09T12:27:41Z", "author": {"login": "captainzmc"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmVolumeArgs.java", "diffHunk": "@@ -46,6 +47,7 @@\n   private long quotaInBytes;\n   private long quotaInCounts;\n   private final OmOzoneAclMap aclMap;\n+  private LongAdder quotaUsageInBytes = new LongAdder();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYxNDMwOQ=="}, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMTEwNzU0OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCreateRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwMzozODoxMVrOHOLngQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwMzozODoxMVrOHOLngQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzMjQ0OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change", "url": "https://github.com/apache/ozone/pull/1296#discussion_r484632449", "createdAt": "2020-09-08T03:38:11Z", "author": {"login": "cxorm"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCreateRequest.java", "diffHunk": "@@ -222,6 +218,7 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n \n       acquireLock = omMetadataManager.getLock().acquireWriteLock(BUCKET_LOCK,\n           volumeName, bucketName);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMTEyOTA5OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCreateRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwMzo1Mjo1OVrOHOL0Eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwMzo1Mjo1OVrOHOL0Eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzNTY2Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  long updateNum = newLocationList.size() * scmBlockSize\n          \n          \n            \n                  long preAllocatedSpace = newLocationList.size() * scmBlockSize", "url": "https://github.com/apache/ozone/pull/1296#discussion_r484635666", "createdAt": "2020-09-08T03:52:59Z", "author": {"login": "cxorm"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCreateRequest.java", "diffHunk": "@@ -295,14 +293,28 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           new CacheKey<>(dbOpenKeyName),\n           new CacheValue<>(Optional.of(omKeyInfo), trxnLogIndex));\n \n+      long scmBlockSize = ozoneManager.getScmBlockSize();\n+      omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n+\n+      // Here we refer to the implementation of HDFS:\n+      // If the key size is 600MB, when createKey, keyLocationList is 3, and\n+      // the every pre-allocated block length is 256MB. If the number of factor\n+      // is 3, the total pre-allocated block size is 256MB*3*3.\n+      // We will allocate more 256MB*3* 3-600mb *3 = 504MB in advance, and we\n+      // will subtract this part when we finally commitKey.\n+      long updateNum = newLocationList.size() * scmBlockSize", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMTEzMjU4OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCreateRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwMzo1NToyMVrOHOL2DQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwMzo1NToyMVrOHOL2DQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDYzNjE3Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  // Here we refer to the implementation of HDFS:\n          \n          \n            \n                  // If the key size is 600MB, when createKey, keyLocationList is 3, and\n          \n          \n            \n                  // the every pre-allocated block length is 256MB. If the number of factor\n          \n          \n            \n                  // is 3, the total pre-allocated block size is 256MB*3*3.\n          \n          \n            \n                  // We will allocate more 256MB*3* 3-600mb *3 = 504MB in advance, and we\n          \n          \n            \n                  // will subtract this part when we finally commitKey.\n          \n          \n            \n                  // Here we refer to the implementation of HDFS:\n          \n          \n            \n                  // If the key size is 600MB, when createKey, keyLocationInfo in keyLocationList is 3, and\n          \n          \n            \n                  // the every pre-allocated block length is 256MB. If the number of factor\n          \n          \n            \n                  // is 3, the total pre-allocated block size is 256MB * 3 * 3.\n          \n          \n            \n                  // We will allocate more 256MB * 3 * 3 - 600MB * 3 = 504MB in advance, and we\n          \n          \n            \n                  // will subtract this part when we finally commitKey.", "url": "https://github.com/apache/ozone/pull/1296#discussion_r484636173", "createdAt": "2020-09-08T03:55:21Z", "author": {"login": "cxorm"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCreateRequest.java", "diffHunk": "@@ -295,14 +293,28 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           new CacheKey<>(dbOpenKeyName),\n           new CacheValue<>(Optional.of(omKeyInfo), trxnLogIndex));\n \n+      long scmBlockSize = ozoneManager.getScmBlockSize();\n+      omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n+\n+      // Here we refer to the implementation of HDFS:\n+      // If the key size is 600MB, when createKey, keyLocationList is 3, and\n+      // the every pre-allocated block length is 256MB. If the number of factor\n+      // is 3, the total pre-allocated block size is 256MB*3*3.\n+      // We will allocate more 256MB*3* 3-600mb *3 = 504MB in advance, and we\n+      // will subtract this part when we finally commitKey.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMjUxMDcyOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmVolumeArgs.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMTozNTo0N1rOHOYz4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMTozNTo0N1rOHOYz4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg0ODYwOQ==", "bodyText": "add final", "url": "https://github.com/apache/ozone/pull/1296#discussion_r484848609", "createdAt": "2020-09-08T11:35:47Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmVolumeArgs.java", "diffHunk": "@@ -46,6 +47,7 @@\n   private long quotaInBytes;\n   private long quotaInCounts;\n   private final OmOzoneAclMap aclMap;\n+  private LongAdder quotaUsageInBytes = new LongAdder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMjUxMzA3OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmVolumeArgs.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMTozNjoyOFrOHOY1Nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMTozNjoyOFrOHOY1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg0ODk1MQ==", "bodyText": "setQuotaUsageInBytes -> increase***", "url": "https://github.com/apache/ozone/pull/1296#discussion_r484848951", "createdAt": "2020-09-08T11:36:28Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmVolumeArgs.java", "diffHunk": "@@ -172,6 +176,14 @@ public long getQuotaInCounts() {\n   public OmOzoneAclMap getAclMap() {\n     return aclMap;\n   }\n+\n+  public LongAdder getQuotaUsageInBytes() {\n+    return quotaUsageInBytes;\n+  }\n+\n+  public void setQuotaUsageInBytes(long quotaUsageInBytes) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMjYyNDcwOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmVolumeArgs.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMjowOTo0NlrOHOZ43A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMjowOTo0NlrOHOZ43A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg2NjI2OA==", "bodyText": "Should getObjectInfo also be changed?", "url": "https://github.com/apache/ozone/pull/1296#discussion_r484866268", "createdAt": "2020-09-08T12:09:46Z", "author": {"login": "ChenSammi"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmVolumeArgs.java", "diffHunk": "@@ -386,7 +408,7 @@ public OmVolumeArgs copyObject() {\n     OmOzoneAclMap cloneAclMap = aclMap.copyObject();\n \n     return new OmVolumeArgs(adminName, ownerName, volume, quotaInBytes,\n-        quotaInCounts, cloneMetadata, cloneAclMap, creationTime,\n-        modificationTime, objectID, updateID);\n+        quotaInCounts, cloneMetadata, quotaUsageInBytes.sum(), cloneAclMap,\n+        creationTime, modificationTime, objectID, updateID);\n   }\n }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 122}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMzgxMDQ5OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneVolume.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNjozMTo0MFrOHOlLpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNTowNDoxM1rOHQOZ3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA1MTMwMA==", "bodyText": "NIT: Can we add a builder to avoid managing constructors with different parameters?", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485051300", "createdAt": "2020-09-08T16:31:40Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneVolume.java", "diffHunk": "@@ -131,6 +133,18 @@ public OzoneVolume(ConfigurationSource conf, ClientProtocol proxy,\n     this.modificationTime = Instant.ofEpochMilli(modificationTime);\n   }\n \n+  @SuppressWarnings(\"parameternumber\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ0NzM0Mg==", "bodyText": "I think that's good advice, and that's a problem that also exists in OzoneBucket. We can optimize these problems separately, I opened a JIRA HDDS-4223 to follow and optimize this part.", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485447342", "createdAt": "2020-09-09T08:51:14Z", "author": {"login": "captainzmc"}, "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneVolume.java", "diffHunk": "@@ -131,6 +133,18 @@ public OzoneVolume(ConfigurationSource conf, ClientProtocol proxy,\n     this.modificationTime = Instant.ofEpochMilli(modificationTime);\n   }\n \n+  @SuppressWarnings(\"parameternumber\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA1MTMwMA=="}, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc3NTI2Mw==", "bodyText": "sounds good to me.", "url": "https://github.com/apache/ozone/pull/1296#discussion_r486775263", "createdAt": "2020-09-11T05:04:13Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/OzoneVolume.java", "diffHunk": "@@ -131,6 +133,18 @@ public OzoneVolume(ConfigurationSource conf, ClientProtocol proxy,\n     this.modificationTime = Instant.ofEpochMilli(modificationTime);\n   }\n \n+  @SuppressWarnings(\"parameternumber\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA1MTMwMA=="}, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNTI0MDQwOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyDeleteRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMDo0NDo1MFrOHOyoHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMDo0NDo1MFrOHOyoHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI3MTU4Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  long totalKeySize = 0;\n          \n          \n            \n                  long quotaReleased = 0;\n          \n      \n    \n    \n  \n\nWe could name the variable in a proper meaning IMHO,\nfeel free to rename it if you have an idea.", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485271582", "createdAt": "2020-09-09T00:44:50Z", "author": {"login": "cxorm"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyDeleteRequest.java", "diffHunk": "@@ -143,14 +143,25 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n               keyName)),\n           new CacheValue<>(Optional.absent(), trxnLogIndex));\n \n+      long totalKeySize = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNTI0NjQzOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyDeleteRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMDo0ODoxN1rOHOyrrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMDo0ODoxN1rOHOyrrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI3MjQ5NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  // atom update quotaUsage.\n          \n          \n            \n                  // update quotaUsage atomically.", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485272494", "createdAt": "2020-09-09T00:48:17Z", "author": {"login": "cxorm"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyDeleteRequest.java", "diffHunk": "@@ -143,14 +143,25 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n               keyName)),\n           new CacheValue<>(Optional.absent(), trxnLogIndex));\n \n+      long totalKeySize = 0;\n+      int keyFactor = omKeyInfo.getFactor().getNumber();\n+      omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n+      OmKeyLocationInfoGroup keyLocationGroup =\n+          omKeyInfo.getLatestVersionLocations();\n+      for(OmKeyLocationInfo locationInfo: keyLocationGroup.getLocationList()){\n+        totalKeySize += locationInfo.getLength() * keyFactor;\n+      }\n+      // atom update quotaUsage.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNTI0ODczOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeysDeleteRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMDo0OTo0NVrOHOytCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMDo0OTo0NVrOHOytCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI3Mjg0Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  long totalKeySize = 0;\n          \n          \n            \n                  long quotaReleased = 0;", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485272842", "createdAt": "2020-09-09T00:49:45Z", "author": {"login": "cxorm"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeysDeleteRequest.java", "diffHunk": "@@ -151,21 +154,32 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n         }\n       }\n \n+      long totalKeySize = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNTI1NTE0OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeysDeleteRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMDo1MzoyOFrOHOyw7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMDo1MzoyOFrOHOyw7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI3MzgzNg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  // atom update quotaUsage.\n          \n          \n            \n                  // update quotaUsage atomically.", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485273836", "createdAt": "2020-09-09T00:53:28Z", "author": {"login": "cxorm"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeysDeleteRequest.java", "diffHunk": "@@ -151,21 +154,32 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n         }\n       }\n \n+      long totalKeySize = 0;\n+      OmVolumeArgs omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n+\n       // Mark all keys which can be deleted, in cache as deleted.\n       for (OmKeyInfo omKeyInfo : omKeyInfoList) {\n         omMetadataManager.getKeyTable().addCacheEntry(\n             new CacheKey<>(omMetadataManager.getOzoneKey(volumeName, bucketName,\n                 omKeyInfo.getKeyName())),\n             new CacheValue<>(Optional.absent(), trxnLogIndex));\n+\n+        int keyFactor = omKeyInfo.getFactor().getNumber();\n+        OmKeyLocationInfoGroup keyLocationGroup =\n+            omKeyInfo.getLatestVersionLocations();\n+        for(OmKeyLocationInfo locationInfo: keyLocationGroup.getLocationList()){\n+          totalKeySize += locationInfo.getLength() * keyFactor;\n+        }\n       }\n+      // atom update quotaUsage.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNTI1OTI1OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/key/OMKeysDeleteResponse.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMDo1NTozNFrOHOyzPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMDo1NTozNFrOHOyzPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI3NDQyOA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            }\n          \n          \n            \n            }", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485274428", "createdAt": "2020-09-09T00:55:34Z", "author": {"login": "cxorm"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/response/key/OMKeysDeleteResponse.java", "diffHunk": "@@ -105,5 +108,10 @@ public void addToDBBatch(OMMetadataManager omMetadataManager,\n       omMetadataManager.getDeletedTable().putWithBatch(batchOperation,\n           deleteKey, repeatedOmKeyInfo);\n     }\n+\n+    // update volume quotaUsageInBytes.\n+    omMetadataManager.getVolumeTable().putWithBatch(batchOperation,\n+        omMetadataManager.getVolumeKey(omVolumeArgs.getVolume()),\n+        omVolumeArgs);\n   }\n }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNTMwNjYxOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCommitRequest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMToyMToxMVrOHOzOOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMjozMjo1N1rOHPFEhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI4MTMzOA==", "bodyText": "I'm confused about the meaning of the variable.\n(Please let me know the meaning of the variable if I miss something.)\nCould you please add some comments about it ?", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485281338", "createdAt": "2020-09-09T01:21:11Z", "author": {"login": "cxorm"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCommitRequest.java", "diffHunk": "@@ -182,8 +179,16 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           new CacheKey<>(dbOzoneKey),\n           new CacheValue<>(Optional.of(omKeyInfo), trxnLogIndex));\n \n+      long scmBlockSize = ozoneManager.getScmBlockSize();\n+      int factor = omKeyInfo.getFactor().getNumber();\n+      omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n+      long updateNum = omKeyInfo.getDataSize() * factor -\n+          locationInfoList.size() * scmBlockSize * factor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU3Mzc2NQ==", "bodyText": "I will add comment to describe the calculation here.", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485573765", "createdAt": "2020-09-09T12:32:57Z", "author": {"login": "captainzmc"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCommitRequest.java", "diffHunk": "@@ -182,8 +179,16 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           new CacheKey<>(dbOzoneKey),\n           new CacheValue<>(Optional.of(omKeyInfo), trxnLogIndex));\n \n+      long scmBlockSize = ozoneManager.getScmBlockSize();\n+      int factor = omKeyInfo.getFactor().getNumber();\n+      omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n+      long updateNum = omKeyInfo.getDataSize() * factor -\n+          locationInfoList.size() * scmBlockSize * factor;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI4MTMzOA=="}, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNTMwODQzOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMToyMjoxMVrOHOzPQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMToyMjoxMVrOHOzPQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI4MTYwMw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  long updateNum = newLocationList.size() * scmBlockSize\n          \n          \n            \n                  long preAllocatedSpace = newLocationList.size() * scmBlockSize", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485281603", "createdAt": "2020-09-09T01:22:11Z", "author": {"login": "cxorm"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/file/OMFileCreateRequest.java", "diffHunk": "@@ -292,14 +289,21 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           bucketName, Optional.absent(), Optional.of(missingParentInfos),\n           trxnLogIndex);\n \n+      long scmBlockSize = ozoneManager.getScmBlockSize();\n+      omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n+      long updateNum = newLocationList.size() * scmBlockSize", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNTMxMDE4OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMAllocateBlockRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMToyMzoxMVrOHOzQQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMToyMzoxMVrOHOzQQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI4MTg1OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  long updateNum = newLocationList.size() * scmBlockSize\n          \n          \n            \n                  long preAllocatedSpace = newLocationList.size() * scmBlockSize", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485281859", "createdAt": "2020-09-09T01:23:11Z", "author": {"login": "cxorm"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMAllocateBlockRequest.java", "diffHunk": "@@ -210,10 +206,17 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           new CacheKey<>(openKeyName),\n           new CacheValue<>(Optional.of(openKeyInfo), trxnLogIndex));\n \n+      long scmBlockSize = ozoneManager.getScmBlockSize();\n+      omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n+      long updateNum = newLocationList.size() * scmBlockSize", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNTMxMTcwOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/s3/multipart/S3MultipartUploadCommitPartRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMToyNDoxNFrOHOzROA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMToyNDoxNFrOHOzROA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI4MjEwNA==", "bodyText": "The same as OMKeyCommitRequest", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485282104", "createdAt": "2020-09-09T01:24:14Z", "author": {"login": "cxorm"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/s3/multipart/S3MultipartUploadCommitPartRequest.java", "diffHunk": "@@ -207,13 +209,21 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           new CacheKey<>(openKey),\n           new CacheValue<>(Optional.absent(), trxnLogIndex));\n \n+      long scmBlockSize = ozoneManager.getScmBlockSize();\n+      int factor = omKeyInfo.getFactor().getNumber();\n+      omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n+      long updateNum = omKeyInfo.getDataSize() * factor -\n+          keyArgs.getKeyLocationsList().size() * scmBlockSize * factor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNTMxODA5OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMAllocateBlockRequest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMToyNzozMFrOHOzUvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMToyNzozMFrOHOzUvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI4MzAwNg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  // atom update quotaUsage.\n          \n          \n            \n                  // update quotaUsage atomically.", "url": "https://github.com/apache/ozone/pull/1296#discussion_r485283006", "createdAt": "2020-09-09T01:27:30Z", "author": {"login": "cxorm"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMAllocateBlockRequest.java", "diffHunk": "@@ -210,10 +206,17 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n           new CacheKey<>(openKeyName),\n           new CacheValue<>(Optional.of(openKeyInfo), trxnLogIndex));\n \n+      long scmBlockSize = ozoneManager.getScmBlockSize();\n+      omVolumeArgs = getVolumeInfo(omMetadataManager, volumeName);\n+      long updateNum = newLocationList.size() * scmBlockSize\n+          * openKeyInfo.getFactor().getNumber();\n+      // atom update quotaUsage.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc4327ad6b151ea3b86d549ccebcc7ecd50cfeff"}, "originalPosition": 65}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4997, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}