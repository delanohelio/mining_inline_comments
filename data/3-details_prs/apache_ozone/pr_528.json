{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxMDQ5MzM1", "number": 528, "title": "HDDS-2979. Implement ofs://: Fix getFileStatus for mkdir volume", "bodyText": "What changes were proposed in this pull request?\nXiaoyu Yao discovered that when running ozone fs -mkdir -p ofs://om/vol1/ (only volume name is given, no bucket name or key path), the command would fail in getFileStatus (before reaching createDirectory()) in Hadoop common code:\nbash-4.2$ ozone fs -mkdir -p ofs://om/vol1/\n-mkdir: Bucket or Volume length is illegal, valid length is 3-63 characters\n\n# Same w/o -p\nbash-4.2$ ozone fs -mkdir ofs://om/vol1/\n-mkdir: Bucket or Volume length is illegal, valid length is 3-63 characters\nAnd we discovered with debugger attached that the root cause is that getFileStatus() is not behaving as expected.\n\nSolution: Patch existing OFS code, throw proper exception in getBucket() code to make Hadoop common happy.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-2979\nHow was this patch tested?\nManually ran ozone fs -mkdir -p ofs://om/vol1/ in docker-compose cluster:\nbash-4.2$ ozone fs -mkdir -p ofs://om/vol1/\n2020-02-04 20:58:25,828 [main] INFO rpc.RpcClient: Creating Volume: vol1, with hadoop as owner.\n\nWill add a new unit test for this case.", "createdAt": "2020-02-04T21:03:21Z", "url": "https://github.com/apache/ozone/pull/528", "merged": true, "mergeCommit": {"oid": "3e4782d3aaeb5b4d4b7429f39a8ce867d3481be4"}, "closed": true, "closedAt": "2020-02-07T00:51:18Z", "author": {"login": "smengcl"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBIMTSgBqjMwMDc3MjM3NTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcB0g1YAFqTM1NDg3MjI4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "787d4aaaa3d91f87511b28e48974a80f3b22110d", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/787d4aaaa3d91f87511b28e48974a80f3b22110d", "committedDate": "2020-02-04T21:02:12Z", "message": "HDDS-2979. Implement ofs://: Fix getFileStatus for mkdir volume"}, "afterCommit": {"oid": "dfe44c8a1eb2f822642dc1acf8a15417e2e40ff8", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/dfe44c8a1eb2f822642dc1acf8a15417e2e40ff8", "committedDate": "2020-02-04T21:11:46Z", "message": "HDDS-2979. Implement ofs://: Fix getFileStatus for mkdir volume"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNDYxNzEw", "url": "https://github.com/apache/ozone/pull/528#pullrequestreview-353461710", "createdAt": "2020-02-05T04:36:07Z", "commit": {"oid": "4677eefba096ae3d926c03234210137b6ab620d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwNDozNjowOFrOFlrkQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwNDozNjowOFrOFlrkQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTA1NTQyNg==", "bodyText": "should we make this static final?", "url": "https://github.com/apache/ozone/pull/528#discussion_r375055426", "createdAt": "2020-02-05T04:36:08Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java", "diffHunk": "@@ -648,4 +663,20 @@ private FileStatusAdapter toFileStatusAdapter(OzoneFileStatus status) {\n         status.getPath()\n     );\n   }\n+\n+  private FileStatusAdapter rootFileStatusAdapter() {\n+    return new FileStatusAdapter(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4677eefba096ae3d926c03234210137b6ab620d7"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNDYxOTIy", "url": "https://github.com/apache/ozone/pull/528#pullrequestreview-353461922", "createdAt": "2020-02-05T04:37:05Z", "commit": {"oid": "4677eefba096ae3d926c03234210137b6ab620d7"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MDkzNTQz", "url": "https://github.com/apache/ozone/pull/528#pullrequestreview-354093543", "createdAt": "2020-02-05T22:43:38Z", "commit": {"oid": "c7e4ab28d4734807352c0678d87be5a7029e0459"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMjo0MzozOFrOFmJwDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMjo0MzozOFrOFmJwDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU0OTk2NQ==", "bodyText": "Try 755", "url": "https://github.com/apache/ozone/pull/528#discussion_r375549965", "createdAt": "2020-02-05T22:43:38Z", "author": {"login": "smengcl"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java", "diffHunk": "@@ -648,4 +663,27 @@ private FileStatusAdapter toFileStatusAdapter(OzoneFileStatus status) {\n         status.getPath()\n     );\n   }\n+\n+  /**\n+   * Generate a FileStatusAdapter for OFS root.\n+   * @return FileStatusAdapter for root.\n+   */\n+  private static FileStatusAdapter rootFileStatusAdapter() {\n+    // Note that most fields are mimicked from HDFS FileStatus for root,\n+    //  except modification time, permission, owner and group.\n+    // TODO: Revisit the return value.\n+    return new FileStatusAdapter(\n+        0L,\n+        null,\n+        true,\n+        (short)0,\n+        0L,\n+        0L,\n+        0L,\n+        (short)0,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7e4ab28d4734807352c0678d87be5a7029e0459"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MDkzNjYw", "url": "https://github.com/apache/ozone/pull/528#pullrequestreview-354093660", "createdAt": "2020-02-05T22:43:51Z", "commit": {"oid": "c7e4ab28d4734807352c0678d87be5a7029e0459"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMjo0Mzo1MVrOFmJwdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMjo0Mzo1MVrOFmJwdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU1MDA2OA==", "bodyText": "use ozone admin", "url": "https://github.com/apache/ozone/pull/528#discussion_r375550068", "createdAt": "2020-02-05T22:43:51Z", "author": {"login": "smengcl"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java", "diffHunk": "@@ -648,4 +663,27 @@ private FileStatusAdapter toFileStatusAdapter(OzoneFileStatus status) {\n         status.getPath()\n     );\n   }\n+\n+  /**\n+   * Generate a FileStatusAdapter for OFS root.\n+   * @return FileStatusAdapter for root.\n+   */\n+  private static FileStatusAdapter rootFileStatusAdapter() {\n+    // Note that most fields are mimicked from HDFS FileStatus for root,\n+    //  except modification time, permission, owner and group.\n+    // TODO: Revisit the return value.\n+    return new FileStatusAdapter(\n+        0L,\n+        null,\n+        true,\n+        (short)0,\n+        0L,\n+        0L,\n+        0L,\n+        (short)0,\n+        null,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7e4ab28d4734807352c0678d87be5a7029e0459"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MDkzNzc1", "url": "https://github.com/apache/ozone/pull/528#pullrequestreview-354093775", "createdAt": "2020-02-05T22:44:05Z", "commit": {"oid": "c7e4ab28d4734807352c0678d87be5a7029e0459"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMjo0NDowNlrOFmJwxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQyMjo0NDowNlrOFmJwxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTU1MDE0OA==", "bodyText": "ozone admin group?", "url": "https://github.com/apache/ozone/pull/528#discussion_r375550148", "createdAt": "2020-02-05T22:44:06Z", "author": {"login": "smengcl"}, "path": "hadoop-ozone/ozonefs/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneClientAdapterImpl.java", "diffHunk": "@@ -648,4 +663,27 @@ private FileStatusAdapter toFileStatusAdapter(OzoneFileStatus status) {\n         status.getPath()\n     );\n   }\n+\n+  /**\n+   * Generate a FileStatusAdapter for OFS root.\n+   * @return FileStatusAdapter for root.\n+   */\n+  private static FileStatusAdapter rootFileStatusAdapter() {\n+    // Note that most fields are mimicked from HDFS FileStatus for root,\n+    //  except modification time, permission, owner and group.\n+    // TODO: Revisit the return value.\n+    return new FileStatusAdapter(\n+        0L,\n+        null,\n+        true,\n+        (short)0,\n+        0L,\n+        0L,\n+        0L,\n+        (short)0,\n+        null,\n+        null,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7e4ab28d4734807352c0678d87be5a7029e0459"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4349060c0dccbc89da37225091971b49b84e3864", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/4349060c0dccbc89da37225091971b49b84e3864", "committedDate": "2020-02-06T23:50:33Z", "message": "HDDS-2979. Implement ofs://: Fix getFileStatus for mkdir volume"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46f5a90be635077fb04278c120e94022b39f2bc9", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/46f5a90be635077fb04278c120e94022b39f2bc9", "committedDate": "2020-02-06T23:50:33Z", "message": "Clean up code; create flag check unnecessary in getBucket"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2df43bd7880e2f5004c1c5c39c621554a679c811", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/2df43bd7880e2f5004c1c5c39c621554a679c811", "committedDate": "2020-02-06T23:50:33Z", "message": "Handle the case where getFileStatus is called for root. mkdir without -p should work for volume creation now."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd33c8a73cf5f7c9989848518f954251508dc078", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/dd33c8a73cf5f7c9989848518f954251508dc078", "committedDate": "2020-02-06T23:50:33Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26d096c72e2001aa5e60f0a36deef1d49dd53ff2", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/26d096c72e2001aa5e60f0a36deef1d49dd53ff2", "committedDate": "2020-02-06T23:50:33Z", "message": "Add testGetListStatusRoot; minor comment tweaks."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c03d7177b11f5c8d463d1944c55ef41b83ac6bd5", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/c03d7177b11f5c8d463d1944c55ef41b83ac6bd5", "committedDate": "2020-02-06T23:50:33Z", "message": "Clean up test code."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e580893ab38684067683805ed3ad9a91cfae93c9", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/e580893ab38684067683805ed3ad9a91cfae93c9", "committedDate": "2020-02-06T23:50:33Z", "message": "Fix typo in test name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4cb0798b9e0db83a99069ab3fafe3950ec3c5b2", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/a4cb0798b9e0db83a99069ab3fafe3950ec3c5b2", "committedDate": "2020-02-06T23:50:33Z", "message": "Fix typo in comment."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29819181553b46329955ba504fc01e2207801093", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/29819181553b46329955ba504fc01e2207801093", "committedDate": "2020-02-06T23:50:33Z", "message": "Make rootFileStatusAdapter static."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70f2e799ff1fe8969c21a57b69203962649c61ed", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/70f2e799ff1fe8969c21a57b69203962649c61ed", "committedDate": "2020-02-06T23:50:33Z", "message": "Set OFS root FileStatus return permission to 00755."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eee681b2e3cb3050694e48baf0cd78c32833a7d9", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/eee681b2e3cb3050694e48baf0cd78c32833a7d9", "committedDate": "2020-02-06T23:50:33Z", "message": "Cosmetic: Tweak class-wide global variable order, as ozoneClient <- proxy <- objectStore"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84fd2663473d0879876afe80ca03c85a13c4b752", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/84fd2663473d0879876afe80ca03c85a13c4b752", "committedDate": "2020-02-06T00:17:30Z", "message": "Cosmetic: Tweak class-wide global variable order, as ozoneClient <- proxy <- objectStore"}, "afterCommit": {"oid": "eee681b2e3cb3050694e48baf0cd78c32833a7d9", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/eee681b2e3cb3050694e48baf0cd78c32833a7d9", "committedDate": "2020-02-06T23:50:33Z", "message": "Cosmetic: Tweak class-wide global variable order, as ozoneClient <- proxy <- objectStore"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0ODcyMjg4", "url": "https://github.com/apache/ozone/pull/528#pullrequestreview-354872288", "createdAt": "2020-02-07T00:50:56Z", "commit": {"oid": "eee681b2e3cb3050694e48baf0cd78c32833a7d9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3841, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}