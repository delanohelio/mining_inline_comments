{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzMjE2MTg5", "number": 1495, "title": "HDDS-4343: ReplicationManager.handleOverReplicatedContainer() does not handle unhealthyReplicas properly.", "bodyText": "What changes were proposed in this pull request?\nReplicationManager.handleOverReplicatedContainer() does not handle unhealthyReplicas properly\n      // If there are unhealthy replicas, then we should remove them even if it\n      // makes the container violate the placement policy, as excess unhealthy\n      // containers are not really useful. It will be corrected later as a\n      // mis-replicated container will be seen as under-replicated.\n      for (ContainerReplica r : unhealthyReplicas) {\n        if (excess > 0) {\n          sendDeleteCommand(container, r.getDatanodeDetails(), true);\n          excess -= 1;\n        }\n        break;\n      }\n      // After removing all unhealthy replicas, if the container is still over\n      // replicated then we need to check if it is already mis-replicated.\n      // If it is, we do no harm by removing excess replicas. However, if it is\n      // not mis-replicated, then we can only remove replicas if they don't\n      // make the container become mis-replicated.\n\nFrom the comment, it wants to remove all unhealthy replicas until excess reach 0 ? It should be\n      for (ContainerReplica r : unhealthyReplicas) {\n        if (excess > 0) {\n          sendDeleteCommand(container, r.getDatanodeDetails(), true);\n          excess -= 1;\n        } else {\n          break;\n        }\n      }\n\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4343#\nHow was this patch tested?\nCI", "createdAt": "2020-10-14T08:51:42Z", "url": "https://github.com/apache/ozone/pull/1495", "merged": true, "mergeCommit": {"oid": "26507233e4f60f5d123d5bd315aba3c6bb90d570"}, "closed": true, "closedAt": "2020-10-14T20:13:01Z", "author": {"login": "GlenGeng"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSZMh1gH2gAyNTAzMjE2MTg5OmU3MzA0MmUyNGUxZTNlNGM0YzQyYjhkMmMyNjIzNWQxMjFiZTI2ZTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSbAX5gFqTUwODIyNjcyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e73042e24e1e3e4c4c42b8d2c26235d121be26e4", "author": {"user": {"login": "GlenGeng", "name": "Glen Geng"}}, "url": "https://github.com/apache/ozone/commit/e73042e24e1e3e4c4c42b8d2c26235d121be26e4", "committedDate": "2020-10-14T08:49:11Z", "message": "HDDS-4343: ReplicationManager.handleOverReplicatedContainer() does not handle unhealthyReplicas properly."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MTY4NDg4", "url": "https://github.com/apache/ozone/pull/1495#pullrequestreview-508168488", "createdAt": "2020-10-14T09:36:48Z", "commit": {"oid": "e73042e24e1e3e4c4c42b8d2c26235d121be26e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwOTozNjo0OFrOHhKqkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwOTozNjo0OFrOHhKqkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzOTc5Mw==", "bodyText": "Looking into this PR change, I am thinking if we still need to do excess check before sending delete command for unhealthy containers. As we want to remove all unhealthy container replicas, we can just send delete command and decrease the excess count by the way.\nI prefer simplified the logic like below:\n      for (ContainerReplica r : unhealthyReplicas) {\n          sendDeleteCommand(container, r.getDatanodeDetails(), true);\n          excess -= 1;\n      }\nThe unhealthyReplicas will also removed in ReplicationManager#handleUnstableContainer if we don't remove all them here.", "url": "https://github.com/apache/ozone/pull/1495#discussion_r504539793", "createdAt": "2020-10-14T09:36:48Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "diffHunk": "@@ -746,8 +746,9 @@ private void handleOverReplicatedContainer(final ContainerInfo container,\n         if (excess > 0) {\n           sendDeleteCommand(container, r.getDatanodeDetails(), true);\n           excess -= 1;\n+        } else {\n+          break;\n         }\n-        break;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e73042e24e1e3e4c4c42b8d2c26235d121be26e4"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MjA3ODIz", "url": "https://github.com/apache/ozone/pull/1495#pullrequestreview-508207823", "createdAt": "2020-10-14T10:28:18Z", "commit": {"oid": "e73042e24e1e3e4c4c42b8d2c26235d121be26e4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MjI2NzI2", "url": "https://github.com/apache/ozone/pull/1495#pullrequestreview-508226726", "createdAt": "2020-10-14T10:55:26Z", "commit": {"oid": "e73042e24e1e3e4c4c42b8d2c26235d121be26e4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMDo1NToyNlrOHhNaFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMDo1NToyNlrOHhNaFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU4NDcyNg==", "bodyText": "Okay, get it. Thanks @sodonnel.", "url": "https://github.com/apache/ozone/pull/1495#discussion_r504584726", "createdAt": "2020-10-14T10:55:26Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "diffHunk": "@@ -746,8 +746,9 @@ private void handleOverReplicatedContainer(final ContainerInfo container,\n         if (excess > 0) {\n           sendDeleteCommand(container, r.getDatanodeDetails(), true);\n           excess -= 1;\n+        } else {\n+          break;\n         }\n-        break;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzOTc5Mw=="}, "originalCommit": {"oid": "e73042e24e1e3e4c4c42b8d2c26235d121be26e4"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2376, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}