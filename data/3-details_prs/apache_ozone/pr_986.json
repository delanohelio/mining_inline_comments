{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0NjcxMDQ3", "number": 986, "title": "HDDS-3476. Use persisted transaction info during OM startup in OM StateMachine.", "bodyText": "What changes were proposed in this pull request?\nHDDS-3474 and HDDS-3475 persisted transaction info to OM DB. This jira is to use the transaction info in OM during OMStateMachine's initialization.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3476\nHow was this patch tested?\nUpdated tests.", "createdAt": "2020-05-28T18:55:15Z", "url": "https://github.com/apache/ozone/pull/986", "merged": true, "mergeCommit": {"oid": "78255ddc7053bb470c7663993d5ce0aecd635f2d"}, "closed": true, "closedAt": "2020-06-11T20:05:51Z", "author": {"login": "bharatviswa504"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclzCNTgBqjMzODQzMDY5NTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqRHNrAH2gAyNDI0NjcxMDQ3OjczZTZlZDgwNzdlOGM3MmFlNDRhZDk5NDliMzZkMWYzMWFhMzI4NzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b1bfc85b0dd7481eb2630196ea3bddf14ea955c7", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/b1bfc85b0dd7481eb2630196ea3bddf14ea955c7", "committedDate": "2020-05-28T18:52:50Z", "message": "HDDS-3476. Use persisted transaction info during OM startup in OM StateMachine."}, "afterCommit": {"oid": "3f88df1c24fdd5fc9608efb64e64a804bcc9ed64", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/3f88df1c24fdd5fc9608efb64e64a804bcc9ed64", "committedDate": "2020-05-28T19:28:35Z", "message": "HDDS-3476. Use persisted transaction info during OM startup in OM StateMachine."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3f88df1c24fdd5fc9608efb64e64a804bcc9ed64", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/3f88df1c24fdd5fc9608efb64e64a804bcc9ed64", "committedDate": "2020-05-28T19:28:35Z", "message": "HDDS-3476. Use persisted transaction info during OM startup in OM StateMachine."}, "afterCommit": {"oid": "2c3be122da1e6210d2e2c04fc4c7a227acdbcb33", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/2c3be122da1e6210d2e2c04fc4c7a227acdbcb33", "committedDate": "2020-05-28T19:50:45Z", "message": "HDDS-3476. Use persisted transaction info during OM startup in OM StateMachine."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c3be122da1e6210d2e2c04fc4c7a227acdbcb33", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/2c3be122da1e6210d2e2c04fc4c7a227acdbcb33", "committedDate": "2020-05-28T19:50:45Z", "message": "HDDS-3476. Use persisted transaction info during OM startup in OM StateMachine."}, "afterCommit": {"oid": "d36348f889c0a1ecf85292a5be89d487358858cd", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/d36348f889c0a1ecf85292a5be89d487358858cd", "committedDate": "2020-05-28T20:31:59Z", "message": "HDDS-3476. Use persisted transaction info during OM startup in OM StateMachine."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d36348f889c0a1ecf85292a5be89d487358858cd", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/d36348f889c0a1ecf85292a5be89d487358858cd", "committedDate": "2020-05-28T20:31:59Z", "message": "HDDS-3476. Use persisted transaction info during OM startup in OM StateMachine."}, "afterCommit": {"oid": "bf0b8ac5fd4d12de820d2d10fa372f9aa57392d8", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/bf0b8ac5fd4d12de820d2d10fa372f9aa57392d8", "committedDate": "2020-05-28T20:49:19Z", "message": "HDDS-3476. Use persisted transaction info during OM startup in OM StateMachine."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf0b8ac5fd4d12de820d2d10fa372f9aa57392d8", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/bf0b8ac5fd4d12de820d2d10fa372f9aa57392d8", "committedDate": "2020-05-28T20:49:19Z", "message": "HDDS-3476. Use persisted transaction info during OM startup in OM StateMachine."}, "afterCommit": {"oid": "93e0638d08a9dde55e47756fe4666c70c0691fbe", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/93e0638d08a9dde55e47756fe4666c70c0691fbe", "committedDate": "2020-05-29T04:40:18Z", "message": "HDDS-3476. Use persisted transaction info during OM startup in OM StateMachine."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMTAzMTA1", "url": "https://github.com/apache/ozone/pull/986#pullrequestreview-422103105", "createdAt": "2020-06-01T19:02:34Z", "commit": {"oid": "93e0638d08a9dde55e47756fe4666c70c0691fbe"}, "state": "COMMENTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxOTowMjozNVrOGdWbDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMTo1ODo1NVrOGdbhjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQyOTI2MA==", "bodyText": "We need this config to be able to control the snapshot trigger from Ratis side for testing purposes. For some tests (TestOzoneManagerHA, OM HA robot tests) we need to set a lower value for auto trigger threshold so that logs can be purged which in turn can instantiate install snapshots.\nWe can keep it as an internal config and not expose it to users.", "url": "https://github.com/apache/ozone/pull/986#discussion_r433429260", "createdAt": "2020-06-01T19:02:35Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/OMConfigKeys.java", "diffHunk": "@@ -133,13 +133,6 @@ private OMConfigKeys() {\n       \"ozone.om.ratis.log.purge.gap\";\n   public static final int OZONE_OM_RATIS_LOG_PURGE_GAP_DEFAULT = 1000000;\n \n-  // OM Snapshot configurations\n-  public static final String OZONE_OM_RATIS_SNAPSHOT_AUTO_TRIGGER_THRESHOLD_KEY\n-      = \"ozone.om.ratis.snapshot.auto.trigger.threshold\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93e0638d08a9dde55e47756fe4666c70c0691fbe"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQzMTYyNQ==", "bodyText": "Can we not call the OzoneManager#getRatisSnapshotIndex() method here?", "url": "https://github.com/apache/ozone/pull/986#discussion_r433431625", "createdAt": "2020-06-01T19:07:22Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/om/snapshot/TestOzoneManagerSnapshotProvider.java", "diffHunk": "@@ -111,23 +113,43 @@ public void testDownloadCheckpoint() throws Exception {\n         .getFailoverProxyProvider(objectStore.getClientProxy())\n         .getCurrentProxyOMNodeId();\n \n-    OzoneManager ozoneManager = cluster.getOzoneManager(leaderOMNodeId);\n+    OzoneManager leaderOM = cluster.getOzoneManager(leaderOMNodeId);\n \n     // Get a follower OM\n-    String followerNodeId = ozoneManager.getPeerNodes().get(0).getOMNodeId();\n+    String followerNodeId = leaderOM.getPeerNodes().get(0).getOMNodeId();\n     OzoneManager followerOM = cluster.getOzoneManager(followerNodeId);\n \n     // Download latest checkpoint from leader OM to follower OM\n     DBCheckpoint omSnapshot = followerOM.getOmSnapshotProvider()\n         .getOzoneManagerDBSnapshot(leaderOMNodeId);\n \n-    long leaderSnapshotIndex = ozoneManager.getRatisSnapshotIndex();\n-    long downloadedSnapshotIndex = omSnapshot.getRatisSnapshotIndex();\n+    long leaderSnapshotIndex =\n+        OMTransactionInfo.readTransactionInfo(leaderOM.getMetadataManager())\n+            .getTransactionIndex();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93e0638d08a9dde55e47756fe4666c70c0691fbe"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ1Njk1OQ==", "bodyText": "Instead of instantiating a new MetadataManagerImpl, can we not directly load the RocksDB and read the transactionInfo?", "url": "https://github.com/apache/ozone/pull/986#discussion_r433456959", "createdAt": "2020-06-01T19:58:49Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3027,30 +3017,59 @@ public TermIndex installSnapshot(String leaderId) {\n     DBCheckpoint omDBcheckpoint = getDBCheckpointFromLeader(leaderId);\n     Path newDBlocation = omDBcheckpoint.getCheckpointLocation();\n \n-    // Check if current ratis log index is smaller than the downloaded\n-    // snapshot index. If yes, proceed by stopping the ratis server so that\n-    // the OM state can be re-initialized. If no, then do not proceed with\n-    // installSnapshot.\n     long lastAppliedIndex = omRatisServer.getLastAppliedTermIndex().getIndex();\n-    long checkpointSnapshotIndex = omDBcheckpoint.getRatisSnapshotIndex();\n-    long checkpointSnapshotTermIndex =\n-        omDBcheckpoint.getRatisSnapshotTerm();\n-    if (checkpointSnapshotIndex <= lastAppliedIndex) {\n-      LOG.error(\"Failed to install checkpoint from OM leader: {}. The last \" +\n-          \"applied index: {} is greater than or equal to the checkpoint's \" +\n-          \"snapshot index: {}. Deleting the downloaded checkpoint {}\", leaderId,\n-          lastAppliedIndex, checkpointSnapshotIndex,\n-          newDBlocation);\n-      try {\n-        FileUtils.deleteFully(newDBlocation);\n-      } catch (IOException e) {\n-        LOG.error(\"Failed to fully delete the downloaded DB checkpoint {} \" +\n-            \"from OM leader {}.\", newDBlocation,\n-            leaderId, e);\n+\n+    // Check if current ratis log index is smaller than the downloaded\n+    // checkpoint transaction index. If yes, proceed by stopping the ratis\n+    // server so that the OM state can be re-initialized. If no, then do not\n+    // proceed with installSnapshot.\n+\n+    OMTransactionInfo omTransactionInfo = null;\n+    try {\n+      // Set new DB location as DB path\n+      OzoneConfiguration tempConfig = getConfiguration();\n+\n+      Path dbDir = newDBlocation.getParent();\n+      if (dbDir != null) {\n+        tempConfig.set(OZONE_OM_DB_DIRS, dbDir.toString());\n+      } else {\n+        LOG.error(\"Incorrect DB location path {} received from checkpoint.\",\n+            newDBlocation);\n+        return null;\n+      }\n+\n+      OMMetadataManager tempMetadataMgr =\n+          new OmMetadataManagerImpl(configuration);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93e0638d08a9dde55e47756fe4666c70c0691fbe"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ2MDM0Ng==", "bodyText": "The exception caught here could be due to varied reasons. Can we have a more generic error message or have different try blocks. Also, if there is an exception, we should delete the downloaded checkpoint.", "url": "https://github.com/apache/ozone/pull/986#discussion_r433460346", "createdAt": "2020-06-01T20:05:56Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3027,30 +3017,59 @@ public TermIndex installSnapshot(String leaderId) {\n     DBCheckpoint omDBcheckpoint = getDBCheckpointFromLeader(leaderId);\n     Path newDBlocation = omDBcheckpoint.getCheckpointLocation();\n \n-    // Check if current ratis log index is smaller than the downloaded\n-    // snapshot index. If yes, proceed by stopping the ratis server so that\n-    // the OM state can be re-initialized. If no, then do not proceed with\n-    // installSnapshot.\n     long lastAppliedIndex = omRatisServer.getLastAppliedTermIndex().getIndex();\n-    long checkpointSnapshotIndex = omDBcheckpoint.getRatisSnapshotIndex();\n-    long checkpointSnapshotTermIndex =\n-        omDBcheckpoint.getRatisSnapshotTerm();\n-    if (checkpointSnapshotIndex <= lastAppliedIndex) {\n-      LOG.error(\"Failed to install checkpoint from OM leader: {}. The last \" +\n-          \"applied index: {} is greater than or equal to the checkpoint's \" +\n-          \"snapshot index: {}. Deleting the downloaded checkpoint {}\", leaderId,\n-          lastAppliedIndex, checkpointSnapshotIndex,\n-          newDBlocation);\n-      try {\n-        FileUtils.deleteFully(newDBlocation);\n-      } catch (IOException e) {\n-        LOG.error(\"Failed to fully delete the downloaded DB checkpoint {} \" +\n-            \"from OM leader {}.\", newDBlocation,\n-            leaderId, e);\n+\n+    // Check if current ratis log index is smaller than the downloaded\n+    // checkpoint transaction index. If yes, proceed by stopping the ratis\n+    // server so that the OM state can be re-initialized. If no, then do not\n+    // proceed with installSnapshot.\n+\n+    OMTransactionInfo omTransactionInfo = null;\n+    try {\n+      // Set new DB location as DB path\n+      OzoneConfiguration tempConfig = getConfiguration();\n+\n+      Path dbDir = newDBlocation.getParent();\n+      if (dbDir != null) {\n+        tempConfig.set(OZONE_OM_DB_DIRS, dbDir.toString());\n+      } else {\n+        LOG.error(\"Incorrect DB location path {} received from checkpoint.\",\n+            newDBlocation);\n+        return null;\n+      }\n+\n+      OMMetadataManager tempMetadataMgr =\n+          new OmMetadataManagerImpl(configuration);\n+\n+      omTransactionInfo =\n+          OMTransactionInfo.readTransactionInfo(tempMetadataMgr);\n+      tempMetadataMgr.stop();\n+\n+      if (omTransactionInfo.getTransactionIndex() <= lastAppliedIndex) {\n+        LOG.error(\"Failed to install checkpoint from OM leader: {}. The last \" +\n+                \"applied index: {} is greater than or equal to the \" +\n+                \"checkpoint's applied index: {}. Deleting the downloaded \" +\n+                \"checkpoint {}\", leaderId, lastAppliedIndex,\n+            omTransactionInfo.getTransactionIndex(), newDBlocation);\n+        try {\n+          FileUtils.deleteFully(newDBlocation);\n+        } catch (IOException e) {\n+          LOG.error(\"Failed to fully delete the downloaded DB checkpoint {} \" +\n+                  \"from OM leader {}.\", newDBlocation,\n+              leaderId, e);\n+          return null;\n+        }\n       }\n+    } catch (Exception ex) {\n+      LOG.error(\"Failed during checking downloaded leader transaction index \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93e0638d08a9dde55e47756fe4666c70c0691fbe"}, "originalPosition": 139}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ2MTYwOA==", "bodyText": "Question: In case of some failure after OM is paused, should we unpause with the old DB?", "url": "https://github.com/apache/ozone/pull/986#discussion_r433461608", "createdAt": "2020-06-01T20:08:32Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3073,9 +3092,8 @@ public TermIndex installSnapshot(String leaderId) {\n     // Restart (unpause) the state machine and update its last applied index\n     // to the installed checkpoint's snapshot index.\n     try {\n-      reloadOMState(checkpointSnapshotIndex, checkpointSnapshotTermIndex);\n-      omRatisServer.getOmStateMachine().unpause(checkpointSnapshotIndex,\n-          checkpointSnapshotTermIndex);\n+      reloadOMState(leaderIndex, leaderTerm);\n+      omRatisServer.getOmStateMachine().unpause(leaderIndex, leaderTerm);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93e0638d08a9dde55e47756fe4666c70c0691fbe"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ4NTQ5Mw==", "bodyText": "This class seems redundant now. The getTermIndex() is only used in tests.\nThere are two options:\n\nWe can either update OMRatisSnapshotInfo on every DB flush when transactionInfo is updated to keep snapshotInfo in memory. But this update and DB update operation would need to be atomic and there is not mych used for it too.\nThe second option is to get rid of OMRatisSnapshotInfo and always read from DB for snapshotIndex.", "url": "https://github.com/apache/ozone/pull/986#discussion_r433485493", "createdAt": "2020-06-01T20:56:58Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OMRatisSnapshotInfo.java", "diffHunk": "@@ -49,81 +39,15 @@\n   private volatile long term = 0;\n   private volatile long snapshotIndex = -1;\n \n-  private final File ratisSnapshotFile;\n-\n-  public OMRatisSnapshotInfo(File ratisDir) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93e0638d08a9dde55e47756fe4666c70c0691fbe"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQ5MDcyOQ==", "bodyText": "getLatestSnapshot is used internally in Ratis during state reload. During reload or restart, getLastAppliedTermIndex would be 0,-1. The TransactionInfo stored in DB should be returned here instead.", "url": "https://github.com/apache/ozone/pull/986#discussion_r433490729", "createdAt": "2020-06-01T21:07:14Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerStateMachine.java", "diffHunk": "@@ -139,6 +139,10 @@ public void initialize(RaftServer server, RaftGroupId id,\n \n   @Override\n   public SnapshotInfo getLatestSnapshot() {\n+    TermIndex lastAppliedIndex = getLastAppliedTermIndex();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93e0638d08a9dde55e47756fe4666c70c0691fbe"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUwNTg2Mg==", "bodyText": "We should return the flushed TransactionInfo#logIndex here too. TransactionIndex returned via getLastAppliedIndex() might not have been flushed to DB yet. And logs could be purged upto this index. And if OM crashes before the transactions are flushed to disk by OMDoubleBuffer, there could be data loss.", "url": "https://github.com/apache/ozone/pull/986#discussion_r433505862", "createdAt": "2020-06-01T21:41:24Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerStateMachine.java", "diffHunk": "@@ -338,20 +341,17 @@ public void unpause(long newLastAppliedSnaphsotIndex,\n   }\n \n   /**\n-   * Take OM Ratis snapshot. Write the snapshot index to file. Snapshot index\n-   * is the log index corresponding to the last applied transaction on the OM\n-   * State Machine.\n+   * Take OM Ratis snapshot is a dummy operation as when double buffer\n+   * flushes the lastAppliedIndex is flushed to DB and that is used as\n+   * snapshot index.\n    *\n    * @return the last applied index on the state machine which has been\n    * stored in the snapshot file.\n    */\n   @Override\n   public long takeSnapshot() throws IOException {\n-    LOG.info(\"Saving Ratis snapshot on the OM.\");\n-    if (ozoneManager != null) {\n-      return ozoneManager.saveRatisSnapshot().getIndex();\n-    }\n-    return 0;\n+    LOG.info(\"Current Snapshot Index {}\", getLastAppliedTermIndex());\n+    return getLastAppliedTermIndex().getIndex();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93e0638d08a9dde55e47756fe4666c70c0691fbe"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUwNzUwNw==", "bodyText": "On a newly setup OM, snapshotInfo is initialized to 0,-1 and so is LastAppliedTermIndex. This step is not required as it is setting the same values again.", "url": "https://github.com/apache/ozone/pull/986#discussion_r433507507", "createdAt": "2020-06-01T21:45:15Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerStateMachine.java", "diffHunk": "@@ -515,13 +515,29 @@ private synchronized void computeAndUpdateLastAppliedIndex(\n     }\n   }\n \n-  public void updateLastAppliedIndexWithSnaphsotIndex() {\n+  public void updateLastAppliedIndexWithSnaphsotIndex() throws IOException {\n     // This is done, as we have a check in Ratis for not throwing\n     // LeaderNotReadyException, it checks stateMachineIndex >= raftLog\n     // nextIndex (placeHolderIndex).\n-    setLastAppliedTermIndex(TermIndex.newTermIndex(snapshotInfo.getTerm(),\n-        snapshotInfo.getIndex()));\n-    LOG.info(\"LastAppliedIndex set from SnapShotInfo {}\",\n+\n+    OMTransactionInfo omTransactionInfo =\n+        OMTransactionInfo.readTransactionInfo(\n+            ozoneManager.getMetadataManager());\n+\n+    if (omTransactionInfo != null) {\n+      setLastAppliedTermIndex(TermIndex.newTermIndex(\n+          omTransactionInfo.getCurrentTerm(),\n+          omTransactionInfo.getTransactionIndex()));\n+      snapshotInfo.updateTermIndex(omTransactionInfo.getCurrentTerm(),\n+          omTransactionInfo.getTransactionIndex());\n+    } else {\n+      // On a newly setup OM,it will not have any transaction info in DB,\n+      // use default values.\n+      setLastAppliedTermIndex(TermIndex.newTermIndex(snapshotInfo.getTerm(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93e0638d08a9dde55e47756fe4666c70c0691fbe"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUwNzg4OQ==", "bodyText": "Typo: as {}", "url": "https://github.com/apache/ozone/pull/986#discussion_r433507889", "createdAt": "2020-06-01T21:46:14Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerStateMachine.java", "diffHunk": "@@ -515,13 +515,29 @@ private synchronized void computeAndUpdateLastAppliedIndex(\n     }\n   }\n \n-  public void updateLastAppliedIndexWithSnaphsotIndex() {\n+  public void updateLastAppliedIndexWithSnaphsotIndex() throws IOException {\n     // This is done, as we have a check in Ratis for not throwing\n     // LeaderNotReadyException, it checks stateMachineIndex >= raftLog\n     // nextIndex (placeHolderIndex).\n-    setLastAppliedTermIndex(TermIndex.newTermIndex(snapshotInfo.getTerm(),\n-        snapshotInfo.getIndex()));\n-    LOG.info(\"LastAppliedIndex set from SnapShotInfo {}\",\n+\n+    OMTransactionInfo omTransactionInfo =\n+        OMTransactionInfo.readTransactionInfo(\n+            ozoneManager.getMetadataManager());\n+\n+    if (omTransactionInfo != null) {\n+      setLastAppliedTermIndex(TermIndex.newTermIndex(\n+          omTransactionInfo.getCurrentTerm(),\n+          omTransactionInfo.getTransactionIndex()));\n+      snapshotInfo.updateTermIndex(omTransactionInfo.getCurrentTerm(),\n+          omTransactionInfo.getTransactionIndex());\n+    } else {\n+      // On a newly setup OM,it will not have any transaction info in DB,\n+      // use default values.\n+      setLastAppliedTermIndex(TermIndex.newTermIndex(snapshotInfo.getTerm(),\n+          snapshotInfo.getIndex()));\n+    }\n+\n+    LOG.info(\"LastAppliedIndex is set from TransactionInfo from OM DB is {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93e0638d08a9dde55e47756fe4666c70c0691fbe"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxMDk4Mg==", "bodyText": "Any reason for changing the naming convention here?\nThe new naming scheme would be <OM_Ratis_Dir>//om.db.\nI think it would be more readable to have the timestamp at the end of file name instead of as a parent directory. What do you think?", "url": "https://github.com/apache/ozone/pull/986#discussion_r433510982", "createdAt": "2020-06-01T21:54:06Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/snapshot/OzoneManagerSnapshotProvider.java", "diffHunk": "@@ -112,16 +112,16 @@ public OzoneManagerSnapshotProvider(ConfigurationSource conf,\n    */\n   public DBCheckpoint getOzoneManagerDBSnapshot(String leaderOMNodeID)\n       throws IOException {\n-    String snapshotFileName = OM_SNAPSHOT_DB + \"_\" + System.currentTimeMillis();\n-    File targetFile = new File(omSnapshotDir, snapshotFileName + \".tar.gz\");\n+    String snapshotTime = Long.toString(System.currentTimeMillis());\n+    String snapshotFileName = Paths.get(omSnapshotDir.getAbsolutePath(),\n+        snapshotTime, OM_DB_NAME).toFile().getAbsolutePath();\n+    File targetFile = new File(snapshotFileName + \".tar.gz\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93e0638d08a9dde55e47756fe4666c70c0691fbe"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxMjg0NQ==", "bodyText": "Can we add a Info Log here. Something to say \"Downloaded checkpoint with OMTransactionInfo - {}\". This would help with debugging as the downloaded checkpoint's snapshotIndex is not logged in OMSnapshotProvider anymore.", "url": "https://github.com/apache/ozone/pull/986#discussion_r433512845", "createdAt": "2020-06-01T21:58:55Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3027,30 +3017,59 @@ public TermIndex installSnapshot(String leaderId) {\n     DBCheckpoint omDBcheckpoint = getDBCheckpointFromLeader(leaderId);\n     Path newDBlocation = omDBcheckpoint.getCheckpointLocation();\n \n-    // Check if current ratis log index is smaller than the downloaded\n-    // snapshot index. If yes, proceed by stopping the ratis server so that\n-    // the OM state can be re-initialized. If no, then do not proceed with\n-    // installSnapshot.\n     long lastAppliedIndex = omRatisServer.getLastAppliedTermIndex().getIndex();\n-    long checkpointSnapshotIndex = omDBcheckpoint.getRatisSnapshotIndex();\n-    long checkpointSnapshotTermIndex =\n-        omDBcheckpoint.getRatisSnapshotTerm();\n-    if (checkpointSnapshotIndex <= lastAppliedIndex) {\n-      LOG.error(\"Failed to install checkpoint from OM leader: {}. The last \" +\n-          \"applied index: {} is greater than or equal to the checkpoint's \" +\n-          \"snapshot index: {}. Deleting the downloaded checkpoint {}\", leaderId,\n-          lastAppliedIndex, checkpointSnapshotIndex,\n-          newDBlocation);\n-      try {\n-        FileUtils.deleteFully(newDBlocation);\n-      } catch (IOException e) {\n-        LOG.error(\"Failed to fully delete the downloaded DB checkpoint {} \" +\n-            \"from OM leader {}.\", newDBlocation,\n-            leaderId, e);\n+\n+    // Check if current ratis log index is smaller than the downloaded\n+    // checkpoint transaction index. If yes, proceed by stopping the ratis\n+    // server so that the OM state can be re-initialized. If no, then do not\n+    // proceed with installSnapshot.\n+\n+    OMTransactionInfo omTransactionInfo = null;\n+    try {\n+      // Set new DB location as DB path\n+      OzoneConfiguration tempConfig = getConfiguration();\n+\n+      Path dbDir = newDBlocation.getParent();\n+      if (dbDir != null) {\n+        tempConfig.set(OZONE_OM_DB_DIRS, dbDir.toString());\n+      } else {\n+        LOG.error(\"Incorrect DB location path {} received from checkpoint.\",\n+            newDBlocation);\n+        return null;\n+      }\n+\n+      OMMetadataManager tempMetadataMgr =\n+          new OmMetadataManagerImpl(configuration);\n+\n+      omTransactionInfo =\n+          OMTransactionInfo.readTransactionInfo(tempMetadataMgr);\n+      tempMetadataMgr.stop();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93e0638d08a9dde55e47756fe4666c70c0691fbe"}, "originalPosition": 122}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93e0638d08a9dde55e47756fe4666c70c0691fbe", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/93e0638d08a9dde55e47756fe4666c70c0691fbe", "committedDate": "2020-05-29T04:40:18Z", "message": "HDDS-3476. Use persisted transaction info during OM startup in OM StateMachine."}, "afterCommit": {"oid": "72966bd33b5524c7438e7da93d020ac2961d70a2", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/72966bd33b5524c7438e7da93d020ac2961d70a2", "committedDate": "2020-06-08T23:31:30Z", "message": "review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MzU2NDgx", "url": "https://github.com/apache/ozone/pull/986#pullrequestreview-428356481", "createdAt": "2020-06-10T19:17:26Z", "commit": {"oid": "630bf31ed01ceb7f3162159f2bdcc845154c8c3a"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxOToxNzoyN1rOGiC8ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQyMDo0OTozOFrOGiFz7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM1MzA4Mg==", "bodyText": "We can remove this comment now.", "url": "https://github.com/apache/ozone/pull/986#discussion_r438353082", "createdAt": "2020-06-10T19:17:27Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OmMetadataManagerImpl.java", "diffHunk": "@@ -259,16 +261,25 @@ public void start(OzoneConfiguration configuration) throws IOException {\n         rocksDBConfiguration.setSyncOption(true);\n       }\n \n-      DBStoreBuilder dbStoreBuilder = DBStoreBuilder.newBuilder(configuration,\n-          rocksDBConfiguration).setName(OM_DB_NAME)\n-          .setPath(Paths.get(metaDir.getPath()));\n+      this.store = loadDB(configuration, metaDir);\n \n-      this.store = addOMTablesAndCodecs(dbStoreBuilder).build();\n+      // This value will be used internally, not to be exposed to end users.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "630bf31ed01ceb7f3162159f2bdcc845154c8c3a"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM2NzQ4OA==", "bodyText": "The lastAppliedIndex could have been updated between its assignment and the canProceed check. This check should be synchronous. Or at least the assignment should happen after reading the transactionInfo from DB.", "url": "https://github.com/apache/ozone/pull/986#discussion_r438367488", "createdAt": "2020-06-10T19:45:29Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3033,32 +3024,47 @@ public TermIndex installSnapshot(String leaderId) {\n     DBCheckpoint omDBcheckpoint = getDBCheckpointFromLeader(leaderId);\n     Path newDBlocation = omDBcheckpoint.getCheckpointLocation();\n \n-    // Check if current ratis log index is smaller than the downloaded\n-    // snapshot index. If yes, proceed by stopping the ratis server so that\n-    // the OM state can be re-initialized. If no, then do not proceed with\n-    // installSnapshot.\n+    LOG.info(\"Downloaded checkpoint from Leader {}, in to the location {}\",\n+        leaderId, newDBlocation);\n+\n     long lastAppliedIndex = omRatisServer.getLastAppliedTermIndex().getIndex();\n-    long checkpointSnapshotIndex = omDBcheckpoint.getRatisSnapshotIndex();\n-    long checkpointSnapshotTermIndex =\n-        omDBcheckpoint.getRatisSnapshotTerm();\n-    if (checkpointSnapshotIndex <= lastAppliedIndex) {\n-      LOG.error(\"Failed to install checkpoint from OM leader: {}. The last \" +\n-              \"applied index: {} is greater than or equal to the checkpoint's\"\n-              + \" \" +\n-              \"snapshot index: {}. Deleting the downloaded checkpoint {}\",\n-          leaderId,\n-          lastAppliedIndex, checkpointSnapshotIndex,\n+\n+    // Check if current ratis log index is smaller than the downloaded\n+    // checkpoint transaction index. If yes, proceed by stopping the ratis\n+    // server so that the OM state can be re-initialized. If no, then do not\n+    // proceed with installSnapshot.\n+\n+    OMTransactionInfo omTransactionInfo = null;\n+\n+    Path dbDir = newDBlocation.getParent();\n+    if (dbDir == null) {\n+      LOG.error(\"Incorrect DB location path {} received from checkpoint.\",\n           newDBlocation);\n-      try {\n-        FileUtils.deleteFully(newDBlocation);\n-      } catch (IOException e) {\n-        LOG.error(\"Failed to fully delete the downloaded DB checkpoint {} \" +\n-                \"from OM leader {}.\", newDBlocation,\n-            leaderId, e);\n-      }\n       return null;\n     }\n \n+    try {\n+      omTransactionInfo =\n+          OzoneManagerRatisUtils.getTransactionInfoFromDownloadedSnapshot(\n+              configuration, dbDir);\n+    } catch (Exception ex) {\n+      LOG.error(\"Failed during opening downloaded snapshot from \" +\n+          \"{} to obtain transaction index\", newDBlocation, ex);\n+      return null;\n+    }\n+\n+    boolean canProceed =\n+        OzoneManagerRatisUtils.verifyTransactionInfo(omTransactionInfo,\n+        lastAppliedIndex, leaderId, newDBlocation);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b67cba16ecac7156620c21db959e20cfa0b0a709"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM2ODAzOA==", "bodyText": "NIT: SnapShot -> Snapshot", "url": "https://github.com/apache/ozone/pull/986#discussion_r438368038", "createdAt": "2020-06-10T19:46:27Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/OzoneManager.java", "diffHunk": "@@ -3168,8 +3172,8 @@ File replaceOMDBWithCheckpoint(long lastAppliedIndex, Path checkpointPath)\n    * All the classes which use/ store MetadataManager should also be updated\n    * with the new MetadataManager instance.\n    */\n-  void reloadOMState(long newSnapshotIndex,\n-      long newSnapShotTermIndex) throws IOException {\n+  void reloadOMState(long newSnapshotIndex, long newSnapShotTermIndex)\n+      throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b67cba16ecac7156620c21db959e20cfa0b0a709"}, "originalPosition": 168}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM4MjQ1OQ==", "bodyText": "Can we rename this method to something like loadSnapshotInfo or loadSnapshotInfoFromDB?\nAlso I think we should move the logic inside reinitialize() here and call this function from reinitialize(). It feels offbeat to call reinitialize() during initialization.", "url": "https://github.com/apache/ozone/pull/986#discussion_r438382459", "createdAt": "2020-06-10T20:14:48Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerStateMachine.java", "diffHunk": "@@ -515,13 +528,12 @@ private synchronized void computeAndUpdateLastAppliedIndex(\n     }\n   }\n \n-  public void updateLastAppliedIndexWithSnaphsotIndex() {\n+  public void updateLastAppliedIndexWithSnaphsotIndex() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b67cba16ecac7156620c21db959e20cfa0b0a709"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM4ODI4Mw==", "bodyText": "Can we revert this now that we don't need this to loadDB.", "url": "https://github.com/apache/ozone/pull/986#discussion_r438388283", "createdAt": "2020-06-10T20:26:26Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/snapshot/OzoneManagerSnapshotProvider.java", "diffHunk": "@@ -112,16 +112,16 @@ public OzoneManagerSnapshotProvider(ConfigurationSource conf,\n    */\n   public DBCheckpoint getOzoneManagerDBSnapshot(String leaderOMNodeID)\n       throws IOException {\n-    String snapshotFileName = OM_SNAPSHOT_DB + \"_\" + System.currentTimeMillis();\n-    File targetFile = new File(omSnapshotDir, snapshotFileName + \".tar.gz\");\n+    String snapshotTime = Long.toString(System.currentTimeMillis());\n+    String snapshotFileName = Paths.get(omSnapshotDir.getAbsolutePath(),\n+        snapshotTime, OM_DB_NAME).toFile().getAbsolutePath();\n+    File targetFile = new File(snapshotFileName + \".tar.gz\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUxMDk4Mg=="}, "originalCommit": {"oid": "93e0638d08a9dde55e47756fe4666c70c0691fbe"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM5NzE5NQ==", "bodyText": "We should return the flushed TransactionInfo#logIndex here too. TransactionIndex returned via getLastAppliedIndex() might not have been flushed to DB yet. And logs could be purged upto this index. And if OM crashes before the transactions are flushed to disk by OMDoubleBuffer, there could be data loss.\n\nDBStore.flush() would not flush all the transactions in OMDoubleBuffer to disk, right?", "url": "https://github.com/apache/ozone/pull/986#discussion_r438397195", "createdAt": "2020-06-10T20:43:54Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerStateMachine.java", "diffHunk": "@@ -338,20 +352,19 @@ public void unpause(long newLastAppliedSnaphsotIndex,\n   }\n \n   /**\n-   * Take OM Ratis snapshot. Write the snapshot index to file. Snapshot index\n-   * is the log index corresponding to the last applied transaction on the OM\n-   * State Machine.\n+   * Take OM Ratis snapshot is a dummy operation as when double buffer\n+   * flushes the lastAppliedIndex is flushed to DB and that is used as\n+   * snapshot index.\n    *\n    * @return the last applied index on the state machine which has been\n    * stored in the snapshot file.\n    */\n   @Override\n   public long takeSnapshot() throws IOException {\n-    LOG.info(\"Saving Ratis snapshot on the OM.\");\n-    if (ozoneManager != null) {\n-      return ozoneManager.saveRatisSnapshot().getIndex();\n-    }\n-    return 0;\n+    LOG.info(\"Current Snapshot Index {}\", getLastAppliedTermIndex());\n+    long lastAppliedIndex = getLastAppliedTermIndex().getIndex();\n+    ozoneManager.getMetadataManager().getStore().flush();\n+    return lastAppliedIndex;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b67cba16ecac7156620c21db959e20cfa0b0a709"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM5OTk4Mg==", "bodyText": "We should update the snapshotInfo also here.", "url": "https://github.com/apache/ozone/pull/986#discussion_r438399982", "createdAt": "2020-06-10T20:49:38Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerStateMachine.java", "diffHunk": "@@ -338,20 +352,19 @@ public void unpause(long newLastAppliedSnaphsotIndex,\n   }\n \n   /**\n-   * Take OM Ratis snapshot. Write the snapshot index to file. Snapshot index\n-   * is the log index corresponding to the last applied transaction on the OM\n-   * State Machine.\n+   * Take OM Ratis snapshot is a dummy operation as when double buffer\n+   * flushes the lastAppliedIndex is flushed to DB and that is used as\n+   * snapshot index.\n    *\n    * @return the last applied index on the state machine which has been\n    * stored in the snapshot file.\n    */\n   @Override\n   public long takeSnapshot() throws IOException {\n-    LOG.info(\"Saving Ratis snapshot on the OM.\");\n-    if (ozoneManager != null) {\n-      return ozoneManager.saveRatisSnapshot().getIndex();\n-    }\n-    return 0;\n+    LOG.info(\"Current Snapshot Index {}\", getLastAppliedTermIndex());\n+    long lastAppliedIndex = getLastAppliedTermIndex().getIndex();\n+    ozoneManager.getMetadataManager().getStore().flush();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b67cba16ecac7156620c21db959e20cfa0b0a709"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc1dc0789094f9c610598fc140e3c83ec1e81f5d", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/fc1dc0789094f9c610598fc140e3c83ec1e81f5d", "committedDate": "2020-06-10T23:56:16Z", "message": "HDDS-3476. Use persisted transaction info during OM startup in OM StateMachine."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a98a43c9f5d0e6c0e6ff7fa01058ea1a2a2a8296", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/a98a43c9f5d0e6c0e6ff7fa01058ea1a2a2a8296", "committedDate": "2020-06-10T23:56:17Z", "message": "review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e88b0a3cf4c01a8494c397c7ca7c1df7a0236964", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/e88b0a3cf4c01a8494c397c7ca7c1df7a0236964", "committedDate": "2020-06-10T23:56:17Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84298838f0d468118d5cf739fa4053ab86fac2f1", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/84298838f0d468118d5cf739fa4053ab86fac2f1", "committedDate": "2020-06-10T23:56:17Z", "message": "find bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5eada966ae091474b4ca0154a2fff466c895de8f", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/5eada966ae091474b4ca0154a2fff466c895de8f", "committedDate": "2020-06-10T23:56:17Z", "message": "use reinitialize and update snapshot info, as during reload sm, reinitialize is called"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "959d6115664e09d0ca3119fbfbde7472b027ac4f", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/959d6115664e09d0ca3119fbfbde7472b027ac4f", "committedDate": "2020-06-10T23:56:18Z", "message": "skip few more with skip initialize flag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa040b9633cbda62370fa1116806a623bc27a5b8", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/aa040b9633cbda62370fa1116806a623bc27a5b8", "committedDate": "2020-06-10T23:56:18Z", "message": "add on"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bde965a8b153548f04625ae023f50c206a467eb8", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/bde965a8b153548f04625ae023f50c206a467eb8", "committedDate": "2020-06-10T23:56:18Z", "message": "review comments and test fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e10eead49eec857adacf7aed25325e9dd5ffd10", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/9e10eead49eec857adacf7aed25325e9dd5ffd10", "committedDate": "2020-06-10T23:56:18Z", "message": "fix findbug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59e59f6934f6558c313a0eacf1ab5f9f27897558", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/59e59f6934f6558c313a0eacf1ab5f9f27897558", "committedDate": "2020-06-10T23:56:18Z", "message": "check style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32a217b7afbe2b2e507c983a38ffa7efe5b5d0db", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/32a217b7afbe2b2e507c983a38ffa7efe5b5d0db", "committedDate": "2020-06-10T23:56:18Z", "message": "Remove db path set and new config creation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "097a8aaf8f6830fb3823af5b5f6aca33e857677c", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/097a8aaf8f6830fb3823af5b5f6aca33e857677c", "committedDate": "2020-06-10T23:56:19Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6285a00b6e1b4340eb19cecc23431fc9ef1095a", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/c6285a00b6e1b4340eb19cecc23431fc9ef1095a", "committedDate": "2020-06-10T23:56:19Z", "message": "review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d9da285f66de8c37162485476fa2a9273fdf0cb", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/4d9da285f66de8c37162485476fa2a9273fdf0cb", "committedDate": "2020-06-10T23:56:19Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db7c370b22292e9d0be25443941987d2a6d20a4b", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/db7c370b22292e9d0be25443941987d2a6d20a4b", "committedDate": "2020-06-10T23:56:19Z", "message": "fix checkstyle"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b2bda391cdaeda9bf0b3dc71c6a1d274ac12ce22", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/b2bda391cdaeda9bf0b3dc71c6a1d274ac12ce22", "committedDate": "2020-06-10T22:27:09Z", "message": "fix checkstyle"}, "afterCommit": {"oid": "db7c370b22292e9d0be25443941987d2a6d20a4b", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/db7c370b22292e9d0be25443941987d2a6d20a4b", "committedDate": "2020-06-10T23:56:19Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MDkxOTcz", "url": "https://github.com/apache/ozone/pull/986#pullrequestreview-429091973", "createdAt": "2020-06-11T16:37:43Z", "commit": {"oid": "db7c370b22292e9d0be25443941987d2a6d20a4b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNjozNzo0M1rOGilroA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNjozNzo0M1rOGilroA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODkyMjE0NA==", "bodyText": "The lastAppliedIndex returned to Ratis and updated in snapshotInfo could be different. We should call getLastAppliedTermIndex() only once and set the same value in snapshotInfo which is being returned to ratis.", "url": "https://github.com/apache/ozone/pull/986#discussion_r438922144", "createdAt": "2020-06-11T16:37:43Z", "author": {"login": "hanishakoneru"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/ratis/OzoneManagerStateMachine.java", "diffHunk": "@@ -338,20 +352,19 @@ public void unpause(long newLastAppliedSnaphsotIndex,\n   }\n \n   /**\n-   * Take OM Ratis snapshot. Write the snapshot index to file. Snapshot index\n-   * is the log index corresponding to the last applied transaction on the OM\n-   * State Machine.\n+   * Take OM Ratis snapshot is a dummy operation as when double buffer\n+   * flushes the lastAppliedIndex is flushed to DB and that is used as\n+   * snapshot index.\n    *\n    * @return the last applied index on the state machine which has been\n    * stored in the snapshot file.\n    */\n   @Override\n   public long takeSnapshot() throws IOException {\n-    LOG.info(\"Saving Ratis snapshot on the OM.\");\n-    if (ozoneManager != null) {\n-      return ozoneManager.saveRatisSnapshot().getIndex();\n-    }\n-    return 0;\n+    LOG.info(\"Current Snapshot Index {}\", getLastAppliedTermIndex());\n+    long lastAppliedIndex = getLastAppliedTermIndex().getIndex();\n+    ozoneManager.getMetadataManager().getStore().flush();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM5OTk4Mg=="}, "originalCommit": {"oid": "b67cba16ecac7156620c21db959e20cfa0b0a709"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73e6ed8077e8c72ae44ad9949b36d1f31aa32873", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/73e6ed8077e8c72ae44ad9949b36d1f31aa32873", "committedDate": "2020-06-11T16:47:10Z", "message": "address review comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3100, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}