{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwMTgxNjE3", "number": 880, "title": "HDDS-3327. Fix s3api  create bucket BUCKET_NOT_FOUND and acl initialization problem when enable acl.", "bodyText": "What changes were proposed in this pull request?\nWhen the acl is enabled(not enable security), It report an error of BUCKET_NOT_FOUND, when execute the following command to create the bucket. This is successful when the acl is not enabled.\naws s3api --endpoint-url http://localhost:9878 create-bucket --bucket=bucket1\nWhen creating a bucket through s3g, the volume name is determined by the md5Hex value of awsAccessId.\nAfter the bucket is created, the location of that bucket is retrieved and returned to the client. When acls enabled, checkaccess is executed when we get the location. IF we are not set UserGroupInformation.setLoginUser(remoteUser), ozone will get s3g start the user as a username(this username will be used to determine the volume name). When this user is  different with awsAccessId, checkaccess will get BUCKET_NOT_FOUND exception.\nFor example:\nWhen we create a bucket, the bucket is (test_user is the value of awsAccessId):\nMd5Hex (test_user)/bucket1\nWhen get location and checkaccess , the bucket is (root is the start user of s3g):\nMd5Hex (root)/bucket1\nBecause the user is different, the volume is different, so the om can't find the bucket.\nThis PR will get awsAccessId as the current user.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3327\nHow was this patch tested?\n1\u3001enable ozone acl without security.\n2\u3001create bucket use s3api(Make sure the s3g startup user is different with awsAccessId)\uff1a\naws s3api --endpoint-url http://s3g-host:9878 create-bucket --bucket=test", "createdAt": "2020-04-28T15:10:00Z", "url": "https://github.com/apache/ozone/pull/880", "merged": true, "mergeCommit": {"oid": "15910a19e98e1ea1d4aa5d071a3d557b8e79e78f"}, "closed": true, "closedAt": "2020-05-13T23:15:00Z", "author": {"login": "captainzmc"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccHSZ6AFqTQwMjA1NDQwMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfZLligFqTQwODU1MTEzMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMDU0NDAy", "url": "https://github.com/apache/ozone/pull/880#pullrequestreview-402054402", "createdAt": "2020-04-28T17:24:27Z", "commit": {"oid": "b2d28b458712de4a2889aa5ddf7b4bc5a8a2756c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNzoyNDoyN1rOGNe7fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNzoyNDozMlrOGNe7sQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc5MTQyMw==", "bodyText": "Move this statement before if and use awsAccessId to check not null in if\nString awsAccessId = v4RequestParser.getAwsAccessId();\nif (awsAccessId != null) {", "url": "https://github.com/apache/ozone/pull/880#discussion_r416791423", "createdAt": "2020-04-28T17:24:27Z", "author": {"login": "vivekratnavel"}, "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java", "diffHunk": "@@ -103,6 +107,13 @@ private OzoneClient getClient(OzoneConfiguration config) throws IOException {\n           throw S3_AUTHINFO_CREATION_ERROR;\n         }\n \n+      } else if (isAclenable) {\n+        if (v4RequestParser.getAwsAccessId() != null) {\n+          String awsAccessId = v4RequestParser.getAwsAccessId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2d28b458712de4a2889aa5ddf7b4bc5a8a2756c"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc5MTQ3Mw==", "bodyText": "Rename variable to isAclEnabled for consistency in casing.", "url": "https://github.com/apache/ozone/pull/880#discussion_r416791473", "createdAt": "2020-04-28T17:24:32Z", "author": {"login": "vivekratnavel"}, "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java", "diffHunk": "@@ -76,6 +78,8 @@ public void destory() throws IOException {\n \n   private OzoneClient getClient(OzoneConfiguration config) throws IOException {\n     try {\n+      Boolean isAclenable = config.getBoolean(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2d28b458712de4a2889aa5ddf7b4bc5a8a2756c"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7c77c79b38fb9671c2fe48f34366437f93a6730", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/d7c77c79b38fb9671c2fe48f34366437f93a6730", "committedDate": "2020-04-29T02:04:40Z", "message": "fix BUCKET_NOT_FOUND"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b2d28b458712de4a2889aa5ddf7b4bc5a8a2756c", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/b2d28b458712de4a2889aa5ddf7b4bc5a8a2756c", "committedDate": "2020-04-28T13:25:30Z", "message": "fix BUCKET_NOT_FOUND"}, "afterCommit": {"oid": "d7c77c79b38fb9671c2fe48f34366437f93a6730", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/d7c77c79b38fb9671c2fe48f34366437f93a6730", "committedDate": "2020-04-29T02:04:40Z", "message": "fix BUCKET_NOT_FOUND"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6917de3a70945a2db7a5341b80038f943d3beb7d", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/6917de3a70945a2db7a5341b80038f943d3beb7d", "committedDate": "2020-04-29T09:38:24Z", "message": "Always use awsAccessId to update the acl info."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2MTI4NjE2", "url": "https://github.com/apache/ozone/pull/880#pullrequestreview-406128616", "createdAt": "2020-05-05T20:25:17Z", "commit": {"oid": "6917de3a70945a2db7a5341b80038f943d3beb7d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQyMDoyNToxN1rOGQ6Nbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQyMDoyNToxN1rOGQ6Nbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM4NDExMA==", "bodyText": "Should we move the createRemoteUser, setLoginUser outside the if condition and addToken when security is enabled?", "url": "https://github.com/apache/ozone/pull/880#discussion_r420384110", "createdAt": "2020-05-05T20:25:17Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java", "diffHunk": "@@ -103,6 +107,13 @@ private OzoneClient getClient(OzoneConfiguration config) throws IOException {\n           throw S3_AUTHINFO_CREATION_ERROR;\n         }\n \n+      } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6917de3a70945a2db7a5341b80038f943d3beb7d"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2MTI4NzI5", "url": "https://github.com/apache/ozone/pull/880#pullrequestreview-406128729", "createdAt": "2020-05-05T20:25:29Z", "commit": {"oid": "6917de3a70945a2db7a5341b80038f943d3beb7d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQyMDoyNToyOVrOGQ6N2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQyMDoyNToyOVrOGQ6N2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM4NDIxNg==", "bodyText": "Do we still need this?", "url": "https://github.com/apache/ozone/pull/880#discussion_r420384216", "createdAt": "2020-05-05T20:25:29Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java", "diffHunk": "@@ -76,6 +78,8 @@ public void destory() throws IOException {\n \n   private OzoneClient getClient(OzoneConfiguration config) throws IOException {\n     try {\n+      Boolean isAclEnable = config.getBoolean(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6917de3a70945a2db7a5341b80038f943d3beb7d"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2MTI4ODY2", "url": "https://github.com/apache/ozone/pull/880#pullrequestreview-406128866", "createdAt": "2020-05-05T20:25:42Z", "commit": {"oid": "6917de3a70945a2db7a5341b80038f943d3beb7d"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa8fa747781ff83aabeac6c9ebdb848afe0325d2", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/fa8fa747781ff83aabeac6c9ebdb848afe0325d2", "committedDate": "2020-05-06T01:22:59Z", "message": "fix review issues."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4NTUxMTMx", "url": "https://github.com/apache/ozone/pull/880#pullrequestreview-408551131", "createdAt": "2020-05-08T21:58:01Z", "commit": {"oid": "fa8fa747781ff83aabeac6c9ebdb848afe0325d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3205, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}