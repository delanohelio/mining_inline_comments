{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM4OTQxNzc1", "number": 1697, "title": "HDDS-4013. FLAKY-UT: TestWatchForCommit#testWatchForCommitForGroupMismatchException", "bodyText": "What changes were proposed in this pull request?\ntestWatchForCommitForGroupMismatchException may fail with Group ... not found in waitForPipelineClose.  The method destroys pipelines via regular SCM -> datanodes path, but then also calls removeGroup for each member manually.\n\n  \n    \n      ozone/hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/commandhandler/ClosePipelineCommandHandler.java\n    \n    \n         Line 74\n      in\n      f30aba7\n    \n    \n    \n    \n\n        \n          \n           server.removeGroup(pipelineID.getProtobuf()); \n        \n    \n  \n\n\n\n  \n    \n      ozone/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/container/TestHelper.java\n    \n    \n         Line 242\n      in\n      f30aba7\n    \n    \n    \n    \n\n        \n          \n           server.removeGroup(pipeline.getId().getProtobuf()); \n        \n    \n  \n\n\nOnly one of these can succeed, the group cannot be removed twice.  If test code wins, we see this error in the output:\n2020-12-11 11:59:14,841 [Command processor thread] ERROR commandhandler.ClosePipelineCommandHandler (ClosePipelineCommandHandler.java:handle(78)) - Can't close pipeline PipelineID=82ba59fa-dd35-4d4e-a61e-59b281828b58\njava.io.IOException: 675d35ba-bb57-4ae2-b121-2cd47ec358f4: Group group-59B281828B58 not found.\n\tat org.apache.hadoop.ozone.container.common.transport.server.ratis.XceiverServerRatis.removeGroup(XceiverServerRatis.java:774)\n\tat org.apache.hadoop.ozone.container.common.statemachine.commandhandler.ClosePipelineCommandHandler.handle(ClosePipelineCommandHandler.java:74)\n\nBut if ClosePipelineCommandHandler is first to remove, the test fails:\ntestWatchForCommitForGroupMismatchException(org.apache.hadoop.ozone.client.rpc.TestWatchForCommit)  Time elapsed: 39.399 s  <<< ERROR!\njava.io.IOException: 14058016-3fcf-4920-991e-a5361899d5d7: Group group-59B281828B58 not found.\n\tat org.apache.hadoop.ozone.container.common.transport.server.ratis.XceiverServerRatis.removeGroup(XceiverServerRatis.java:774)\n\tat org.apache.hadoop.ozone.container.TestHelper.waitForPipelineClose(TestHelper.java:242)\n\tat org.apache.hadoop.ozone.client.rpc.TestWatchForCommit.testWatchForCommitForGroupMismatchException(TestWatchForCommit.java:353)\n\nhttps://issues.apache.org/jira/browse/HDDS-4013\nHow was this patch tested?\nRan TestWatchForCommit 50x - never failed, only timed out once:\nhttps://github.com/adoroszlai/hadoop-ozone/runs/1544890660\nRegular CI:\nhttps://github.com/adoroszlai/hadoop-ozone/actions/runs/418502626", "createdAt": "2020-12-13T12:15:58Z", "url": "https://github.com/apache/ozone/pull/1697", "merged": true, "mergeCommit": {"oid": "327c148582a793860ad97d46bf55997cc1f15029"}, "closed": true, "closedAt": "2020-12-14T12:56:49Z", "author": {"login": "adoroszlai"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdlroW9AH2gAyNTM4OTQxNzc1OjUxMzA3Nzc5M2M5MzVhZTFjODAwMTlkYjg2NGZjZmUzM2QyYjdhNDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmDyq0gFqTU1MTI2NzY2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "513077793c935ae1c80019db864fcfe33d2b7a40", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/513077793c935ae1c80019db864fcfe33d2b7a40", "committedDate": "2020-12-13T07:02:26Z", "message": "HDDS-4013. FLAKY-UT: TestWatchForCommit#testWatchForCommitForGroupMismatchException"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMDQyMTk4", "url": "https://github.com/apache/ozone/pull/1697#pullrequestreview-551042198", "createdAt": "2020-12-14T04:53:03Z", "commit": {"oid": "513077793c935ae1c80019db864fcfe33d2b7a40"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwNDo1MzowM1rOIE_z3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwNDo1MzowM1rOIE_z3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjExMDY4Nw==", "bodyText": "Thanx @adoroszlai for the fix, I am able to repro this, changes seems fair enough.\nDoes it makes sense to removeGroup explicitly in case server.isExist(pipelineId) is true, rather than waiting? Might speed up test? We can ignore the exception from removeGroup in the wait and retry to counter the race condition", "url": "https://github.com/apache/ozone/pull/1697#discussion_r542110687", "createdAt": "2020-12-14T04:53:03Z", "author": {"login": "ayushtkn"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/container/TestHelper.java", "diffHunk": "@@ -234,12 +235,14 @@ public static void waitForPipelineClose(List<Pipeline> pipelineList,\n \n     // wait for the pipeline to get destroyed in the datanodes\n     for (Pipeline pipeline : pipelineList) {\n+      HddsProtos.PipelineID pipelineId = pipeline.getId().getProtobuf();\n       for (DatanodeDetails dn : pipeline.getNodes()) {\n         XceiverServerSpi server =\n             cluster.getHddsDatanodes().get(cluster.getHddsDatanodeIndex(dn))\n                 .getDatanodeStateMachine().getContainer().getWriteChannel();\n         Assert.assertTrue(server instanceof XceiverServerRatis);\n-        server.removeGroup(pipeline.getId().getProtobuf());\n+        GenericTestUtils.waitFor(() -> !server.isExist(pipelineId),\n+            100, 30_000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "513077793c935ae1c80019db864fcfe33d2b7a40"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMjY3NjY4", "url": "https://github.com/apache/ozone/pull/1697#pullrequestreview-551267668", "createdAt": "2020-12-14T11:11:25Z", "commit": {"oid": "513077793c935ae1c80019db864fcfe33d2b7a40"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2112, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}