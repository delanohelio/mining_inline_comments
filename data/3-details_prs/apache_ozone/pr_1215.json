{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUxMzgwMTE1", "number": 1215, "title": "HDDS-3982. Disable moveToTrash in o3fs and ofs temporarily", "bodyText": "What changes were proposed in this pull request?\nA proper server-side trash cleanup solution (HDDS-3915) might not land any time soon.\nThis jira aims to completely disable \"move to trash\" when a client is deleting files and {{fs.trash.interval > 0}} by intercepting the deprecated {{fs.rename(src, dst, options)}} call used by {{TrashPolicyDefault#moveToTrash}}.\nThis should be reverted when trash cleanup is implemented.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3982\nHow was this patch tested?\n\n\nAdded new tests.\n\n\nAlso tested manually:\n\n\nAs usual, compile -> launch docker-compose cluster -> exec bash on om\n$ mvn clean install -Pdist -DskipTests -e -Dmaven.javadoc.skip=true -DskipShade\n$ cd hadoop-ozone/dist/target/ozone-*-SNAPSHOT/compose/ozone\n$ docker-compose up -d\n$ docker-compose exec om /bin/bash\n\nAdd fs.trash.interval to client config:\n$ vi /etc/hadoop/core-site.xml\n# Add a line in <configuration> tag and save:\n<property><name>fs.trash.interval</name><value>1</value></property>\n\no3fs\n$ ozone sh volume create volume1\n$ ozone sh bucket create /volume1/bucket2\n$ ozone fs -mkdir -p o3fs://bucket2.volume1.om/dir3\n$ ozone fs -touch o3fs://bucket2.volume1.om/dir3/key5\n$ ozone fs -rm o3fs://bucket2.volume1.om/dir3/key5\n2020-07-17 19:22:29,778 [main] INFO Configuration.deprecation: io.bytes.per.checksum is deprecated. Instead, use dfs.bytes-per-checksum\n2020-07-17 19:22:29,867 [main] INFO ozone.BasicOzoneFileSystem: Move to trash is disabled for o3fs, deleting instead: o3fs://bucket2.volume1.om/dir3/key5\n2020-07-17 19:22:29,881 [main] INFO fs.TrashPolicyDefault: Moved: 'o3fs://bucket2.volume1.om/dir3/key5' to trash at: /.Trash/hadoop/Current/dir3/key5\n\nVerification: key is deleted, but trash directory is created:\n$ ozone fs -ls -R o3fs://bucket2.volume1.om/.Trash/hadoop/Current/\ndrwxrwxrwx   - hadoop hadoop          0 2020-07-17 19:22 o3fs://bucket2.volume1.om/.Trash/hadoop/Current/dir3\n\nOFS\n$ ozone fs -mkdir -p ofs://om/volume1/bucket2/dir3\n$ ozone fs -touch ofs://om/volume1/bucket2/dir3/key5\n$ ozone fs -rm ofs://om/volume1/bucket2/dir3/key5\n2020-07-17 19:26:59,193 [main] INFO Configuration.deprecation: io.bytes.per.checksum is deprecated. Instead, use dfs.bytes-per-checksum\n2020-07-17 19:26:59,306 [main] INFO ozone.BasicRootedOzoneFileSystem: Move to trash is disabled for ofs, deleting instead: ofs://om/volume1/bucket2/dir3/key5\n2020-07-17 19:26:59,334 [main] INFO fs.TrashPolicyDefault: Moved: 'ofs://om/volume1/bucket2/dir3/key5' to trash at: ofs://om/volume1/bucket2/.Trash/hadoop/Current/volume1/bucket2/dir3/key5\n\nVerification: key is deleted, but trash directory is created:\n$ ozone fs -ls -R ofs://om/volume1/bucket2/.Trash/hadoop/Current/\ndrwxrwxrwx   - hadoop hadoop          0 2020-07-17 19:26 ofs://om/volume1/bucket2/.Trash/hadoop/Current/volume1\ndrwxrwxrwx   - hadoop hadoop          0 2020-07-17 19:26 ofs://om/volume1/bucket2/.Trash/hadoop/Current/volume1/bucket2\ndrwxrwxrwx   - hadoop hadoop          0 2020-07-17 19:26 ofs://om/volume1/bucket2/.Trash/hadoop/Current/volume1/bucket2/dir3\n\nKnown Issues\n\nTrashPolicyDefault already creates the empty directories in trash before calling fs.rename(src, dst, options).\n\nThese are empty dirs so they shouldn't be a big problem.\nWe could do something about fs.mkdirs as well to solve this but I'm not sure if we should go down this path.\n\n\nTrashPolicyDefault still prints \"Moved ... to trash\" message, as shown above, which may be confusing to users.", "createdAt": "2020-07-17T19:14:09Z", "url": "https://github.com/apache/ozone/pull/1215", "merged": true, "mergeCommit": {"oid": "fbd125cd7cb1aea7941d251d31772ba3f37696b4"}, "closed": true, "closedAt": "2020-07-21T03:11:24Z", "author": {"login": "smengcl"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc14wVogH2gAyNDUxMzgwMTE1OjZmNGVhZDUyMGQ1Yjk3OWY0M2I3NjM1ZTgwODg3OTQ1ZTU2ZGY4N2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc26tzdgFqTQ1MjAzNzc2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6f4ead520d5b979f43b7635e80887945e56df87e", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/6f4ead520d5b979f43b7635e80887945e56df87e", "committedDate": "2020-07-17T19:11:33Z", "message": "BasicOzoneFileSystem#rename(src, dst, options)\nBasicRootedOzoneFileSystem#rename(src, dst, options)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMDE4NjI4", "url": "https://github.com/apache/ozone/pull/1215#pullrequestreview-451018628", "createdAt": "2020-07-18T01:12:00Z", "commit": {"oid": "6f4ead520d5b979f43b7635e80887945e56df87e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQwMToxMjowMFrOGzkoRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQwMToxMjowMFrOGzkoRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjczMDY5Mw==", "bodyText": "Please check my above comment.", "url": "https://github.com/apache/ozone/pull/1215#discussion_r456730693", "createdAt": "2020-07-18T01:12:00Z", "author": {"login": "umamaheswararao"}, "path": "hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicOzoneFileSystem.java", "diffHunk": "@@ -397,6 +398,32 @@ public boolean rename(Path src, Path dst) throws IOException {\n     return result;\n   }\n \n+  /**\n+   * Intercept rename to trash calls from TrashPolicyDefault,\n+   * convert them to delete calls instead.\n+   */\n+  @Deprecated\n+  protected void rename(final Path src, final Path dst,\n+      final Rename... options) throws IOException {\n+    boolean hasMoveToTrash = false;\n+    if (options != null) {\n+      for (Rename option : options) {\n+        if (option == Rename.TO_TRASH) {\n+          hasMoveToTrash = true;\n+          break;\n+        }\n+      }\n+    }\n+    if (!hasMoveToTrash) {\n+      // if doesn't have TO_TRASH option, just pass the call to super\n+      super.rename(src, dst, options);\n+    } else {\n+      // intercept when TO_TRASH is found", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f4ead520d5b979f43b7635e80887945e56df87e"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a929357c62a60bdfccfb48f1c65f5adf47c30069", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/a929357c62a60bdfccfb48f1c65f5adf47c30069", "committedDate": "2020-07-20T18:03:34Z", "message": "Improve user message.\n\nChange-Id: I594717fd5895efb59ff0f9646fcee328122747c6"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6829a7094215f78d39bcf9d81aa5f39185123c1d", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/6829a7094215f78d39bcf9d81aa5f39185123c1d", "committedDate": "2020-07-20T18:33:57Z", "message": "if any\n\nChange-Id: I347583f47a4f4f9a3558243f9fea72403631c653"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c625dfb30cd9e706bd1e51920d7de9372236b21", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/7c625dfb30cd9e706bd1e51920d7de9372236b21", "committedDate": "2020-07-20T18:34:08Z", "message": "Add testRenameToTrashDisabled for o3fs.\n\nChange-Id: Ie5a4a7f622561aaae0baf1e045508041cf616d26"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc161c8115172f09c6f82164ac793a0b1f39b407", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/fc161c8115172f09c6f82164ac793a0b1f39b407", "committedDate": "2020-07-20T19:49:41Z", "message": "Add testRenameToTrashDisabled for ofs.\n\nChange-Id: I9e37b8a1d6e18f236cc3e861cdb9ae33ca84ca43"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62dc794061f8fcc51e75382419be4f642170cc09", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/62dc794061f8fcc51e75382419be4f642170cc09", "committedDate": "2020-07-20T19:58:28Z", "message": "Ignore existing test testDeleteToTrashOrSkipTrash because we have disabled trash."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxOTM0Mjkw", "url": "https://github.com/apache/ozone/pull/1215#pullrequestreview-451934290", "createdAt": "2020-07-20T20:27:05Z", "commit": {"oid": "7c625dfb30cd9e706bd1e51920d7de9372236b21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMDoyNzowNVrOG0eEfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMDoyNzowNVrOG0eEfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY3MTgwNQ==", "bodyText": "One last thing: Currently we are straight a way deleting files. Since users coming from Hadoop shell, there could be assumptions that files may move to trash if no -skipTrash flag. But we will be deleting instead of trashing them.\nUser may realize after looking at this log message, but by this time already things happened.\nThere should be a way to shout out this behavior to users. One way is documenting and any other better way?", "url": "https://github.com/apache/ozone/pull/1215#discussion_r457671805", "createdAt": "2020-07-20T20:27:05Z", "author": {"login": "umamaheswararao"}, "path": "hadoop-ozone/ozonefs-common/src/main/java/org/apache/hadoop/fs/ozone/BasicRootedOzoneFileSystem.java", "diffHunk": "@@ -372,6 +373,34 @@ public boolean rename(Path src, Path dst) throws IOException {\n     return result;\n   }\n \n+  /**\n+   * Intercept rename to trash calls from TrashPolicyDefault,\n+   * convert them to delete calls instead.\n+   */\n+  @Deprecated\n+  protected void rename(final Path src, final Path dst,\n+      final Options.Rename... options) throws IOException {\n+    boolean hasMoveToTrash = false;\n+    if (options != null) {\n+      for (Options.Rename option : options) {\n+        if (option == Options.Rename.TO_TRASH) {\n+          hasMoveToTrash = true;\n+          break;\n+        }\n+      }\n+    }\n+    if (!hasMoveToTrash) {\n+      // if doesn't have TO_TRASH option, just pass the call to super\n+      super.rename(src, dst, options);\n+    } else {\n+      // intercept when TO_TRASH is found\n+      LOG.info(\"Move to trash is disabled for ofs, deleting instead: {}. \"\n+          + \"Files or directories will NOT be retained in trash. \"\n+          + \"Ignore the following TrashPolicyDefault message, if any.\", src);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c625dfb30cd9e706bd1e51920d7de9372236b21"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82d5af280b87b02123071f56dc2c61b78627bec2", "author": {"user": {"login": "smengcl", "name": "Siyao Meng"}}, "url": "https://github.com/apache/ozone/commit/82d5af280b87b02123071f56dc2c61b78627bec2", "committedDate": "2020-07-20T21:08:43Z", "message": "Add doc.\n\nChange-Id: I29fcc402b03b8abc2fc0325c9daf568b6e6c2329"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMDM3NzY3", "url": "https://github.com/apache/ozone/pull/1215#pullrequestreview-452037767", "createdAt": "2020-07-21T00:02:31Z", "commit": {"oid": "82d5af280b87b02123071f56dc2c61b78627bec2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2873, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}