{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2NzU2OTQ0", "number": 1370, "title": "HDDS-4176. Fix failed UT: test2WayCommitForTimeoutException", "bodyText": "What changes were proposed in this pull request?\nWhat's the problem ?\n\nWhat's the reason of the failed ut ?\nWhen cluster create 9 nodes, the following code try to shutdown the follower of the pipeline. Actually, the pipeline only exist in 3 nodes, but the following code check 9 nodes, so the pipeline can not found in the other 6 nodes.\n    for (HddsDatanodeService dn : cluster.getHddsDatanodes()) {\n      // shutdown the ratis follower\n      if (ContainerTestHelper.isRatisFollower(dn, pipeline)) {\n        cluster.shutdownHddsDatanode(dn.getDatanodeDetails());\n        break;\n      }\n    }\n\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4176\nHow was this patch tested?\nExisted ut.", "createdAt": "2020-09-01T01:58:39Z", "url": "https://github.com/apache/ozone/pull/1370", "merged": true, "mergeCommit": {"oid": "9cef3f63384d643ca8d25ea70d87f5415f92bc88"}, "closed": true, "closedAt": "2020-09-02T02:15:02Z", "author": {"login": "runzhiwang"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEf6pjgFqTQ3OTM5NjIxMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEwQp5ABqjM3MTcyNDU1NTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5Mzk2MjEx", "url": "https://github.com/apache/ozone/pull/1370#pullrequestreview-479396211", "createdAt": "2020-09-01T04:44:03Z", "commit": {"oid": "e9d0ddc89ae1f4c1f8088cade45d7a7705b272a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwNDo0NDowM1rOHKhY5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwNDo0NDowM1rOHKhY5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDc5NDg1NA==", "bodyText": "This logic looks right to me.\nCan you bump up the number of DN to make tests run against higher number DN: https://github.com/apache/hadoop-ozone/blob/34ee8311b0d0a37878fe1fd2e5d8c1b91aa8cc8f/hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/Test2WayCommitInRatis.java#L109\nWhich seems will cover your change?", "url": "https://github.com/apache/ozone/pull/1370#discussion_r480794854", "createdAt": "2020-09-01T04:44:03Z", "author": {"login": "amaliujia"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestWatchForCommit.java", "diffHunk": "@@ -297,9 +298,11 @@ public void test2WayCommitForTimeoutException() throws Exception {\n             xceiverClient.getPipeline()));\n     reply.getResponse().get();\n     Assert.assertEquals(3, ratisClient.getCommitInfoMap().size());\n+    List<DatanodeDetails> datanodeDetails = pipeline.getNodes();\n     for (HddsDatanodeService dn : cluster.getHddsDatanodes()) {\n       // shutdown the ratis follower\n-      if (ContainerTestHelper.isRatisFollower(dn, pipeline)) {\n+      if (datanodeDetails.contains(dn.getDatanodeDetails())\n+          && ContainerTestHelper.isRatisFollower(dn, pipeline)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9d0ddc89ae1f4c1f8088cade45d7a7705b272a8"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwMTA5MzQw", "url": "https://github.com/apache/ozone/pull/1370#pullrequestreview-480109340", "createdAt": "2020-09-01T20:56:53Z", "commit": {"oid": "e9d0ddc89ae1f4c1f8088cade45d7a7705b272a8"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMDo1Njo1M1rOHLH8Sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMDo1Njo1M1rOHLH8Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyNjUwNg==", "bodyText": "Nit: nodesInPipeline may be a better name.", "url": "https://github.com/apache/ozone/pull/1370#discussion_r481426506", "createdAt": "2020-09-01T20:56:53Z", "author": {"login": "adoroszlai"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/ozone/client/rpc/TestWatchForCommit.java", "diffHunk": "@@ -297,9 +298,11 @@ public void test2WayCommitForTimeoutException() throws Exception {\n             xceiverClient.getPipeline()));\n     reply.getResponse().get();\n     Assert.assertEquals(3, ratisClient.getCommitInfoMap().size());\n+    List<DatanodeDetails> datanodeDetails = pipeline.getNodes();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9d0ddc89ae1f4c1f8088cade45d7a7705b272a8"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "491c95625617a68cae2970a1a29b8a54c47251a6", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/491c95625617a68cae2970a1a29b8a54c47251a6", "committedDate": "2020-09-01T23:45:25Z", "message": "HDDS-4176. Fix failed UT: test2WayCommitForTimeoutException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "391ef3d8741aee6e83dc8c4a29563510c495ff7e", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/391ef3d8741aee6e83dc8c4a29563510c495ff7e", "committedDate": "2020-09-01T23:46:04Z", "message": "fix code review"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e9d0ddc89ae1f4c1f8088cade45d7a7705b272a8", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/e9d0ddc89ae1f4c1f8088cade45d7a7705b272a8", "committedDate": "2020-09-01T01:45:42Z", "message": "HDDS-4176. Fix failed UT: test2WayCommitForTimeoutException"}, "afterCommit": {"oid": "391ef3d8741aee6e83dc8c4a29563510c495ff7e", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/391ef3d8741aee6e83dc8c4a29563510c495ff7e", "committedDate": "2020-09-01T23:46:04Z", "message": "fix code review"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2405, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}