{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzMzA4OTYz", "number": 1497, "title": "HDDS-4345. Replace the deprecated Lock method", "bodyText": "What changes were proposed in this pull request?\n\n\nAcquireLock has been Deprecated and replaced by acquireWriteLock. This PR unifies this usage.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4345\nHow was this patch tested?\nUse existing UT", "createdAt": "2020-10-14T11:35:26Z", "url": "https://github.com/apache/ozone/pull/1497", "merged": true, "mergeCommit": {"oid": "d8f4dc145318288cb978ee30f3e66c9e0689ed9d"}, "closed": true, "closedAt": "2020-10-30T17:05:31Z", "author": {"login": "captainzmc"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSaD6wgH2gAyNTAzMzA4OTYzOjUxOGJjYjlhMzZjYjlkYTllMWEzMTEwYTVkMjcyZDYxZDg0NTNmZWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXpuR2gFqTUyMDg1NTkzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "518bcb9a36cb9da9e1a3110a5d272d61d8453fee", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/518bcb9a36cb9da9e1a3110a5d272d61d8453fee", "committedDate": "2020-10-14T09:49:41Z", "message": "fix an expired lock method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2MDUzMTgw", "url": "https://github.com/apache/ozone/pull/1497#pullrequestreview-516053180", "createdAt": "2020-10-23T23:05:49Z", "commit": {"oid": "518bcb9a36cb9da9e1a3110a5d272d61d8453fee"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QyMzowNTo0OVrOHngoZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QyMzowNjowN1rOHngouQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE5MTE0MQ==", "bodyText": "Should we use acquireReadLock here?", "url": "https://github.com/apache/ozone/pull/1497#discussion_r511191141", "createdAt": "2020-10-23T23:05:49Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/PrefixManagerImpl.java", "diffHunk": "@@ -232,7 +232,7 @@ public boolean checkAccess(OzoneObj ozObject, RequestContext context)\n     Objects.requireNonNull(context);\n \n     String prefixPath = ozObject.getPath();\n-    metadataManager.getLock().acquireLock(PREFIX_LOCK, prefixPath);\n+    metadataManager.getLock().acquireWriteLock(PREFIX_LOCK, prefixPath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "518bcb9a36cb9da9e1a3110a5d272d61d8453fee"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTE5MTIyNQ==", "bodyText": "Same as above.", "url": "https://github.com/apache/ozone/pull/1497#discussion_r511191225", "createdAt": "2020-10-23T23:06:07Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/PrefixManagerImpl.java", "diffHunk": "@@ -253,18 +253,18 @@ public boolean checkAccess(OzoneObj ozObject, RequestContext context)\n         return true;\n       }\n     } finally {\n-      metadataManager.getLock().releaseLock(PREFIX_LOCK, prefixPath);\n+      metadataManager.getLock().releaseWriteLock(PREFIX_LOCK, prefixPath);\n     }\n   }\n \n   @Override\n   public List<OmPrefixInfo> getLongestPrefixPath(String path) {\n     String prefixPath = prefixTree.getLongestPrefix(path);\n-    metadataManager.getLock().acquireLock(PREFIX_LOCK, prefixPath);\n+    metadataManager.getLock().acquireWriteLock(PREFIX_LOCK, prefixPath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "518bcb9a36cb9da9e1a3110a5d272d61d8453fee"}, "originalPosition": 94}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c78988b58c264d101fe07d0a95cc7dd709cf9c3", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/4c78988b58c264d101fe07d0a95cc7dd709cf9c3", "committedDate": "2020-10-26T06:54:33Z", "message": "fix review issues."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MTE4NzI0", "url": "https://github.com/apache/ozone/pull/1497#pullrequestreview-517118724", "createdAt": "2020-10-26T19:44:01Z", "commit": {"oid": "4c78988b58c264d101fe07d0a95cc7dd709cf9c3"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxOTo0NDowMlrOHofpFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxOTo0NDowOVrOHofpdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIyMzUxMA==", "bodyText": "This should be a ReadLock", "url": "https://github.com/apache/ozone/pull/1497#discussion_r512223510", "createdAt": "2020-10-26T19:44:02Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/VolumeManagerImpl.java", "diffHunk": "@@ -620,7 +620,7 @@ public boolean checkAccess(OzoneObj ozObject, RequestContext context)\n     Objects.requireNonNull(context);\n \n     String volume = ozObject.getVolumeName();\n-    metadataManager.getLock().acquireLock(VOLUME_LOCK, volume);\n+    metadataManager.getLock().acquireWriteLock(VOLUME_LOCK, volume);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c78988b58c264d101fe07d0a95cc7dd709cf9c3"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIyMzYwNA==", "bodyText": "This should be a ReadLock", "url": "https://github.com/apache/ozone/pull/1497#discussion_r512223604", "createdAt": "2020-10-26T19:44:09Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/VolumeManagerImpl.java", "diffHunk": "@@ -647,7 +647,7 @@ public boolean checkAccess(OzoneObj ozObject, RequestContext context)\n       throw new OMException(\"Check access operation failed for \" +\n           \"volume:\" + volume, ex, ResultCodes.INTERNAL_ERROR);\n     } finally {\n-      metadataManager.getLock().releaseLock(VOLUME_LOCK, volume);\n+      metadataManager.getLock().releaseWriteLock(VOLUME_LOCK, volume);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c78988b58c264d101fe07d0a95cc7dd709cf9c3"}, "originalPosition": 137}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51f1790769304142d2b48e4bf4f3b8313c8c478e", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/51f1790769304142d2b48e4bf4f3b8313c8c478e", "committedDate": "2020-10-27T02:51:22Z", "message": "Fix review issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e4807f862c58ce516e22dab491f1aaebd71b8ce", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/3e4807f862c58ce516e22dab491f1aaebd71b8ce", "committedDate": "2020-10-27T06:45:31Z", "message": "trigger CI"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4OTQ1MjE1", "url": "https://github.com/apache/ozone/pull/1497#pullrequestreview-518945215", "createdAt": "2020-10-28T18:00:50Z", "commit": {"oid": "51f1790769304142d2b48e4bf4f3b8313c8c478e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxODowMDo1MFrOHp29Gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMDo0OToxMlrOHp82XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY1NDA0Mg==", "bodyText": "This should be a WriteLock.", "url": "https://github.com/apache/ozone/pull/1497#discussion_r513654042", "createdAt": "2020-10-28T18:00:50Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/S3SecretManagerImpl.java", "diffHunk": "@@ -61,7 +61,7 @@ public S3SecretValue getS3Secret(String kerberosID) throws IOException {\n     Preconditions.checkArgument(Strings.isNotBlank(kerberosID),\n         \"kerberosID cannot be null or empty.\");\n     S3SecretValue result = null;\n-    omMetadataManager.getLock().acquireWriteLock(S3_SECRET_LOCK, kerberosID);\n+    omMetadataManager.getLock().acquireReadLock(S3_SECRET_LOCK, kerberosID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51f1790769304142d2b48e4bf4f3b8313c8c478e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc1MDYyMQ==", "bodyText": "This needs a WriteLock.", "url": "https://github.com/apache/ozone/pull/1497#discussion_r513750621", "createdAt": "2020-10-28T20:49:12Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/KeyManagerImpl.java", "diffHunk": "@@ -459,7 +459,7 @@ public OpenKeySession openKey(OmKeyArgs args) throws IOException {\n         args.getVolumeName(), args.getBucketName(), args.getKeyName());\n \n     FileEncryptionInfo encInfo;\n-    metadataManager.getLock().acquireWriteLock(BUCKET_LOCK, volumeName,\n+    metadataManager.getLock().acquireReadLock(BUCKET_LOCK, volumeName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51f1790769304142d2b48e4bf4f3b8313c8c478e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dd7c3d000093069c2efad0d56fd8bf1d96d9260", "author": {"user": {"login": "captainzmc", "name": "micah zhao"}}, "url": "https://github.com/apache/ozone/commit/1dd7c3d000093069c2efad0d56fd8bf1d96d9260", "committedDate": "2020-10-29T06:13:26Z", "message": "fix review issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwODU1OTMw", "url": "https://github.com/apache/ozone/pull/1497#pullrequestreview-520855930", "createdAt": "2020-10-30T16:54:09Z", "commit": {"oid": "1dd7c3d000093069c2efad0d56fd8bf1d96d9260"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2380, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}