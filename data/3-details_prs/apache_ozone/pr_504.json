{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4Nzk3NjQ1", "number": 504, "title": "HDDS-2953. Handle replay of S3 requests", "bodyText": "What changes were proposed in this pull request?\nTo ensure that S3 operations is idempotent, compare the transactionID with the objectID and updateID to make sure that the transaction is not a replay. If the transactionID <= updateID, then it implies that the transaction is a replay and hence it should be skipped.\nIn this Jira, the following requests are made idempotent:\nS3InitiateMultipartUploadRequest\nS3MultipartUploadCommitPartRequest\nS3MultipartUploadCompleteRequest\nS3MultipartUploadAbortRequest\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-2953\nHow was this patch tested?\nWill add unit tests in next commit", "createdAt": "2020-01-29T22:25:22Z", "url": "https://github.com/apache/ozone/pull/504", "merged": true, "mergeCommit": {"oid": "3ddcdbbef58ffe9a2931d1c9258cc4f69abde0a5"}, "closed": true, "closedAt": "2020-02-11T01:05:26Z", "author": {"login": "hanishakoneru"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_4F7ZgFqTM1MTgzOTAzNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDHHaMgFqTM1NjM3MTYyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxODM5MDM1", "url": "https://github.com/apache/ozone/pull/504#pullrequestreview-351839035", "createdAt": "2020-01-31T23:53:18Z", "commit": {"oid": "7663b8d605b68e3eb619e898f931df5c28f59a33"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQyMzo1MzoxOVrOFka5_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQyMzo1MzoxOVrOFka5_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzczMzg4NQ==", "bodyText": "Looks like checking keyTable is not required here. I feel we can ignore it here, as unnecessary extra DB read for all MPU initate cases.", "url": "https://github.com/apache/ozone/pull/504#discussion_r373733885", "createdAt": "2020-01-31T23:53:19Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/s3/multipart/S3InitiateMultipartUploadRequest.java", "diffHunk": "@@ -118,6 +127,28 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n \n       validateBucketAndVolume(omMetadataManager, volumeName, bucketName);\n \n+      // Check if this transaction is a replay.\n+      // We check only the KeyTable here and not the OpenKeyTable. In case\n+      // this transaction is a replay but the transaction was not committed\n+      // to the KeyTable, then we recreate the key in OpenKey table. This is\n+      // okay as all the subsequent transactions would also be replayed and\n+      // the openKey table would eventually reach the same state.\n+      // The reason we do not check the OpenKey table is to avoid a DB read\n+      // in regular non-replay scenario.\n+      String dbKeyName = omMetadataManager.getOzoneKey(volumeName, bucketName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7663b8d605b68e3eb619e898f931df5c28f59a33"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNzI1MzI1", "url": "https://github.com/apache/ozone/pull/504#pullrequestreview-352725325", "createdAt": "2020-02-04T05:02:10Z", "commit": {"oid": "7663b8d605b68e3eb619e898f931df5c28f59a33"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwNTowMjoxMVrOFlIKIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwNTowMjoxMVrOFlIKIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQ3NTI5OQ==", "bodyText": "How this check will help here, as we don't set updateID for open key OmKeyInfo in the below logic similar to multipartKeyInfo.\nExample:\nT1 -> MPU Initiate\nT2 -> MPU abort\nNow replay, T2 will not be considered as a replay. As OmKeyInfo will have updateID as 1.", "url": "https://github.com/apache/ozone/pull/504#discussion_r374475299", "createdAt": "2020-02-04T05:02:11Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/s3/multipart/S3MultipartUploadAbortRequest.java", "diffHunk": "@@ -116,36 +122,51 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n         throw new OMException(\"Abort Multipart Upload Failed: volume: \" +\n             volumeName + \"bucket: \" + bucketName + \"key: \" + keyName,\n             OMException.ResultCodes.NO_SUCH_MULTIPART_UPLOAD_ERROR);\n-      } else {\n-        multipartKeyInfo = omMetadataManager\n-            .getMultipartInfoTable().get(multipartKey);\n-\n-        multipartKeyInfo.setUpdateID(transactionLogIndex);\n-\n-        // Update cache of openKeyTable and multipartInfo table.\n-        // No need to add the cache entries to delete table, as the entries\n-        // in delete table are not used by any read/write operations.\n-        omMetadataManager.getOpenKeyTable().addCacheEntry(\n-            new CacheKey<>(multipartKey),\n-            new CacheValue<>(Optional.absent(), transactionLogIndex));\n-        omMetadataManager.getMultipartInfoTable().addCacheEntry(\n-            new CacheKey<>(multipartKey),\n-            new CacheValue<>(Optional.absent(), transactionLogIndex));\n       }\n \n-      omClientResponse = new S3MultipartUploadAbortResponse(multipartKey,\n-          multipartKeyInfo,\n+      // Check the OpenKeyTable if this transaction is a replay of ratis logs.\n+      if (isReplay(ozoneManager, omKeyInfo.getUpdateID(), trxnLogIndex)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7663b8d605b68e3eb619e898f931df5c28f59a33"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNzI2OTQw", "url": "https://github.com/apache/ozone/pull/504#pullrequestreview-352726940", "createdAt": "2020-02-04T05:09:27Z", "commit": {"oid": "7663b8d605b68e3eb619e898f931df5c28f59a33"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7663b8d605b68e3eb619e898f931df5c28f59a33", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/7663b8d605b68e3eb619e898f931df5c28f59a33", "committedDate": "2020-01-30T00:06:48Z", "message": "checkstyle fix"}, "afterCommit": {"oid": "a6e0f5bf5edc6080d5cb6cce2ab7faccfaba1f47", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/a6e0f5bf5edc6080d5cb6cce2ab7faccfaba1f47", "committedDate": "2020-02-04T23:06:32Z", "message": "Removing replay check from Initiate and Abort requests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0ODM1Nzgx", "url": "https://github.com/apache/ozone/pull/504#pullrequestreview-354835781", "createdAt": "2020-02-06T23:07:17Z", "commit": {"oid": "a6e0f5bf5edc6080d5cb6cce2ab7faccfaba1f47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMzowNzoxN1rOFmtTbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMzowNzoxN1rOFmtTbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjEzMjQ2MQ==", "bodyText": "This looks brittle, if someone mistakenly sent for normal key deletes trxnLogIndex we will update it. (I think no harm)\nSo, make this logic generic for all requests, instead of special cases, and remove the above method.", "url": "https://github.com/apache/ozone/pull/504#discussion_r376132461", "createdAt": "2020-02-06T23:07:17Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/OmUtils.java", "diffHunk": "@@ -453,20 +453,32 @@ public static File createOMDir(String dirPath) {\n     return dirFile;\n   }\n \n+  public static RepeatedOmKeyInfo prepareKeyForDelete(OmKeyInfo keyInfo,\n+      RepeatedOmKeyInfo repeatedOmKeyInfo) throws IOException {\n+    return prepareKeyForDelete(keyInfo, repeatedOmKeyInfo, 0L);\n+  }\n+\n   /**\n    * Prepares key info to be moved to deletedTable.\n    * 1. It strips GDPR metadata from key info\n    * 2. For given object key, if the repeatedOmKeyInfo instance is null, it\n    * implies that no entry for the object key exists in deletedTable so we\n    * create a new instance to include this key, else we update the existing\n    * repeatedOmKeyInfo instance.\n+   * 3. Set the updateID to the transactionLogIndex\n    * @param keyInfo args supplied by client\n    * @param repeatedOmKeyInfo key details from deletedTable\n+   * @param trxnLogIndex For Multipart keys, this is the transactionLogIndex\n+   *                     of the MultipartUploadAbort request which needs to\n+   *                     be set as the updateID of the partKeyInfos.\n+   *                     For regular Key deletes, this value should be passed\n+   *                     as 0 as the updateID is already set.\n    * @return {@link RepeatedOmKeyInfo}\n    * @throws IOException if I/O Errors when checking for key\n    */\n   public static RepeatedOmKeyInfo prepareKeyForDelete(OmKeyInfo keyInfo,\n-      RepeatedOmKeyInfo repeatedOmKeyInfo) throws IOException{\n+      RepeatedOmKeyInfo repeatedOmKeyInfo, long trxnLogIndex)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6e0f5bf5edc6080d5cb6cce2ab7faccfaba1f47"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0ODU5MDA1", "url": "https://github.com/apache/ozone/pull/504#pullrequestreview-354859005", "createdAt": "2020-02-07T00:08:42Z", "commit": {"oid": "a6e0f5bf5edc6080d5cb6cce2ab7faccfaba1f47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMDowODo0M1rOFmufMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMDowODo0M1rOFmufMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE1MTg1OQ==", "bodyText": "Can we mention this as TODO? (As still it is not addressed)", "url": "https://github.com/apache/ozone/pull/504#discussion_r376151859", "createdAt": "2020-02-07T00:08:43Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/s3/multipart/S3InitiateMultipartUploadRequest.java", "diffHunk": "@@ -118,6 +126,11 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n \n       validateBucketAndVolume(omMetadataManager, volumeName, bucketName);\n \n+      // We do not check if this transaction is a replay here to avoid extra\n+      // DB reads. Even if this transaction is replayed, in\n+      // S3MultipartUploadComplete request, we would delete this entry from", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6e0f5bf5edc6080d5cb6cce2ab7faccfaba1f47"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "306a9b624dd2f414e34e8bb5111d32c01cd5b74a", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/306a9b624dd2f414e34e8bb5111d32c01cd5b74a", "committedDate": "2020-02-10T20:43:39Z", "message": "HDDS-2953. Handle replay of S3 requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a7fec26d9fffb26c913b23d48112d6f096a389a", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/5a7fec26d9fffb26c913b23d48112d6f096a389a", "committedDate": "2020-02-10T20:43:39Z", "message": "checkstyle fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87ea599905b907ed9aeae7e47b234a700d45a0c7", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/87ea599905b907ed9aeae7e47b234a700d45a0c7", "committedDate": "2020-02-10T20:43:39Z", "message": "Removing replay check from Initiate and Abort requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1f2e29fd0b49a4d8a8d542e5b336010bf27bb10", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/b1f2e29fd0b49a4d8a8d542e5b336010bf27bb10", "committedDate": "2020-02-10T20:56:14Z", "message": "rebase and review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a6e0f5bf5edc6080d5cb6cce2ab7faccfaba1f47", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/a6e0f5bf5edc6080d5cb6cce2ab7faccfaba1f47", "committedDate": "2020-02-04T23:06:32Z", "message": "Removing replay check from Initiate and Abort requests"}, "afterCommit": {"oid": "b1f2e29fd0b49a4d8a8d542e5b336010bf27bb10", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/b1f2e29fd0b49a4d8a8d542e5b336010bf27bb10", "committedDate": "2020-02-10T20:56:14Z", "message": "rebase and review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e804eab9e0cda95f391932548b482103bb613a98", "author": {"user": {"login": "hanishakoneru", "name": "Hanisha Koneru"}}, "url": "https://github.com/apache/ozone/commit/e804eab9e0cda95f391932548b482103bb613a98", "committedDate": "2020-02-10T22:46:22Z", "message": "unit test fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MzcxNjI3", "url": "https://github.com/apache/ozone/pull/504#pullrequestreview-356371627", "createdAt": "2020-02-11T01:05:17Z", "commit": {"oid": "e804eab9e0cda95f391932548b482103bb613a98"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3785, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}