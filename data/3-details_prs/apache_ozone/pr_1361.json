{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0OTYzNjMw", "number": 1361, "title": "HDDS-4155. Directory and filename can end up with same name in a path.", "bodyText": "What changes were proposed in this pull request?\nDisallow creation/complete MPU when a directory already exists with same name.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4155\nHow was this patch tested?\nAdded integration tests. These tests replicate the scenario of MPU.\nTested with S3 with this flag manually. Tests for this with enable will be added as part of HDDS-4154\nWhen complete MPU, before that create directory with same name returns below error.\nbash-4.2$ aws s3api --endpoint http://s3g:9878 complete-multipart-upload --upload-id b00242fc-e972-4bef-a183-8042777e4c88-104763231993856000 --bucket b1234 --key a/b/c/file1 --multipart-upload 'Parts=[{ETag=/s3v/b1234/a/b/c/key1104763236752556033, PartNumber=1}]'\n\nAn error occurred (InvalidRequest) when calling the CompleteMultipartUpload operation: An error occurred (InvalidRequest) when calling the CompleteMultipartUpload operation: ozone.om.enable.filesystem.paths is enabled Keys are considered as Unix Paths. A directory already exists with a give KeyName caused failure for MPU", "createdAt": "2020-08-27T21:33:55Z", "url": "https://github.com/apache/ozone/pull/1361", "merged": true, "mergeCommit": {"oid": "68869d1743484826136a85ce07263a70979b26ef"}, "closed": true, "closedAt": "2020-09-14T18:42:28Z", "author": {"login": "bharatviswa504"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdG5j3ugFqTQ4NDI3MTQ4NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdI3kqNgFqTQ4ODAzOTQ3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MjcxNDg1", "url": "https://github.com/apache/ozone/pull/1361#pullrequestreview-484271485", "createdAt": "2020-09-08T15:44:33Z", "commit": {"oid": "9ad3fd1b898f2b5ce41035a4475c97a138944604"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNTo0NDozM1rOHOjUuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNTo0NDozM1rOHOjUuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyMDg1OQ==", "bodyText": "@bharatviswa504 can you please reword this comment? I couldn't understand what it is saying.", "url": "https://github.com/apache/ozone/pull/1361#discussion_r485020859", "createdAt": "2020-09-08T15:44:33Z", "author": {"login": "arp7"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCommitRequest.java", "diffHunk": "@@ -158,6 +159,23 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n \n       validateBucketAndVolume(omMetadataManager, volumeName, bucketName);\n \n+      // Check by the time we commit this file, is there any directory", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ad3fd1b898f2b5ce41035a4475c97a138944604"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MjcyNjcx", "url": "https://github.com/apache/ozone/pull/1361#pullrequestreview-484272671", "createdAt": "2020-09-08T15:45:55Z", "commit": {"oid": "9ad3fd1b898f2b5ce41035a4475c97a138944604"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNTo0NTo1NVrOHOjYZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNTo0NTo1NVrOHOjYZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyMTc5Ng==", "bodyText": "Does the directory name have a trailing / in RocksDB? If so, do we need to append it to keyname before calling checkDirectoryAlreadyExists?", "url": "https://github.com/apache/ozone/pull/1361#discussion_r485021796", "createdAt": "2020-09-08T15:45:55Z", "author": {"login": "arp7"}, "path": "hadoop-ozone/ozone-manager/src/main/java/org/apache/hadoop/ozone/om/request/key/OMKeyCommitRequest.java", "diffHunk": "@@ -158,6 +159,23 @@ public OMClientResponse validateAndUpdateCache(OzoneManager ozoneManager,\n \n       validateBucketAndVolume(omMetadataManager, volumeName, bucketName);\n \n+      // Check by the time we commit this file, is there any directory\n+      // created if then fail it. This is being done for correctness.\n+\n+      // For now we are taking this approach similar to local file creation.\n+      // TODO: In future this can be revisited to come up with an advanced\n+      // approach.\n+\n+\n+      if (ozoneManager.getEnableFileSystemPaths()) {\n+        if (checkDirectoryAlreadyExists(volumeName, bucketName, keyName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ad3fd1b898f2b5ce41035a4475c97a138944604"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MjczMjE2", "url": "https://github.com/apache/ozone/pull/1361#pullrequestreview-484273216", "createdAt": "2020-09-08T15:46:35Z", "commit": {"oid": "9ad3fd1b898f2b5ce41035a4475c97a138944604"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNTo0NjozNVrOHOjaCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNTo0NjozNVrOHOjaCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyMjIxOA==", "bodyText": "Nice detailed explanation, thanks for adding this!", "url": "https://github.com/apache/ozone/pull/1361#discussion_r485022218", "createdAt": "2020-09-08T15:46:35Z", "author": {"login": "arp7"}, "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/endpoint/ObjectEndpoint.java", "diffHunk": "@@ -197,6 +198,18 @@ public Response put(\n           .build();\n     } catch (IOException ex) {\n       LOG.error(\"Exception occurred in PutObject\", ex);\n+      if (ex instanceof  OMException) {\n+        if (((OMException) ex).getResult() == ResultCodes.NOT_A_FILE) {\n+          OS3Exception os3Exception = S3ErrorTable.newError(INVALID_REQUEST,\n+              keyPath);\n+          os3Exception.setErrorMessage(\"An error occurred (InvalidRequest) \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ad3fd1b898f2b5ce41035a4475c97a138944604"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NjU0NzQx", "url": "https://github.com/apache/ozone/pull/1361#pullrequestreview-484654741", "createdAt": "2020-09-09T04:37:09Z", "commit": {"oid": "1e9ead87e8b0df104e0d718db20767d084256e59"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNDozNzowOVrOHO2Vzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwNDozNzowOVrOHO2Vzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMzMjQzMA==", "bodyText": "Do we have a test case that tests the reverse scenario? i.e. create the dir first, then try to create a file with the same name. Also are we testing this via the object store interface with the flag enabled?", "url": "https://github.com/apache/ozone/pull/1361#discussion_r485332430", "createdAt": "2020-09-09T04:37:09Z", "author": {"login": "arp7"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/fs/ozone/TestOzoneFSWithObjectStoreCreate.java", "diffHunk": "@@ -209,6 +215,94 @@ public void testObjectStoreCreateWithO3fs() throws Exception {\n \n   }\n \n+\n+  @Test\n+  public void testKeyCreationFailDuetoDirectoryCreationBeforeCommit()\n+      throws Exception {\n+    OzoneVolume ozoneVolume =\n+        cluster.getRpcClient().getObjectStore().getVolume(volumeName);\n+\n+    OzoneBucket ozoneBucket = ozoneVolume.getBucket(bucketName);\n+\n+    OzoneOutputStream ozoneOutputStream =\n+        ozoneBucket.createKey(\"/a/b/c\", 10);\n+    byte[] b = new byte[10];\n+    Arrays.fill(b, (byte)96);\n+    ozoneOutputStream.write(b);\n+\n+    // Before close create directory with same name.\n+    o3fs.mkdirs(new Path(\"/a/b/c\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e9ead87e8b0df104e0d718db20767d084256e59"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MTgzNzA1", "url": "https://github.com/apache/ozone/pull/1361#pullrequestreview-485183705", "createdAt": "2020-09-09T16:14:30Z", "commit": {"oid": "1213423decf0237b844a7ab5a8805005a68a4fb3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNjoxNDozMFrOHPPJxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNjoxNDozMFrOHPPJxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTczODk0OA==", "bodyText": "Thanks for the additional test. Can we also add a test case that exercises the REST API to create a file and dir with the same name, in both orders?", "url": "https://github.com/apache/ozone/pull/1361#discussion_r485738948", "createdAt": "2020-09-09T16:14:30Z", "author": {"login": "arp7"}, "path": "hadoop-ozone/integration-test/src/test/java/org/apache/hadoop/fs/ozone/TestOzoneFSWithObjectStoreCreate.java", "diffHunk": "@@ -303,6 +304,12 @@ public void testMPUFailDuetoDirectoryCreationBeforeComplete()\n \n   }\n \n+  @Test(expected = FileAlreadyExistsException.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1213423decf0237b844a7ab5a8805005a68a4fb3"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "035c9c864dfeea4d3d847f4cc957b20664ea4f6d", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/035c9c864dfeea4d3d847f4cc957b20664ea4f6d", "committedDate": "2020-09-11T19:24:20Z", "message": "HDDS-4155. Directory and filename can end up with same name in a path.\"\n\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14b7a68b41cb90006114d1a8cc1c5f44dace5a3a", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/14b7a68b41cb90006114d1a8cc1c5f44dace5a3a", "committedDate": "2020-09-11T19:24:20Z", "message": "fix cs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c82a83b5ddc7bd88aca7688d185f9ba155eea6da", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/c82a83b5ddc7bd88aca7688d185f9ba155eea6da", "committedDate": "2020-09-11T19:24:20Z", "message": "fix cs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c259d72af6d0eee925766b621dfe0b03226e4660", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/c259d72af6d0eee925766b621dfe0b03226e4660", "committedDate": "2020-09-11T19:24:20Z", "message": "Update OMKeyCommitRequest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "729537b5a4a263344f0d494876b7b719c11fa68e", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/729537b5a4a263344f0d494876b7b719c11fa68e", "committedDate": "2020-09-11T19:24:21Z", "message": "Update S3MultipartUploadCompleteRequest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97ab0e80df3fa20bcdeda4b0e71b2eb0fbbef5c7", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/97ab0e80df3fa20bcdeda4b0e71b2eb0fbbef5c7", "committedDate": "2020-09-11T19:24:21Z", "message": "new test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b217b3c5f70445df4db86c1ced0b5e66bf3620a5", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/b217b3c5f70445df4db86c1ced0b5e66bf3620a5", "committedDate": "2020-09-11T19:24:21Z", "message": "add key test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1213423decf0237b844a7ab5a8805005a68a4fb3", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/1213423decf0237b844a7ab5a8805005a68a4fb3", "committedDate": "2020-09-09T05:18:10Z", "message": "new test"}, "afterCommit": {"oid": "b217b3c5f70445df4db86c1ced0b5e66bf3620a5", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/b217b3c5f70445df4db86c1ced0b5e66bf3620a5", "committedDate": "2020-09-11T19:24:21Z", "message": "add key test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MDM5NDc2", "url": "https://github.com/apache/ozone/pull/1361#pullrequestreview-488039476", "createdAt": "2020-09-14T18:33:27Z", "commit": {"oid": "b217b3c5f70445df4db86c1ced0b5e66bf3620a5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2795, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}