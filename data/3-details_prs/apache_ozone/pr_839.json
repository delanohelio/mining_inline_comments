{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0ODk4NDcx", "number": 839, "title": "HDDS-3411. Switch Recon SQL DB to Derby.", "bodyText": "What changes were proposed in this pull request?\nRecon currently uses Sqlite as its defacto SQL DB with an option to configure other JDBC compatible databases. However, on some platforms like the IBM power pc, this causes problems from compile time since it does not have the sqlite native driver. This task aims to change the default SQL DB used by Recon to Derby, but retains the out of the box support (no need to supply the driver) for Sqlite as well.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3411\nHow was this patch tested?\nAdded unit tests.\nManually tested on docker with Derby and Sqlite.\nBuilt the recon modules on IBM PPC host.", "createdAt": "2020-04-17T03:18:52Z", "url": "https://github.com/apache/ozone/pull/839", "merged": true, "mergeCommit": {"oid": "3a1681bd7ab32fc6f08d194af80620b659f9133d"}, "closed": true, "closedAt": "2020-04-30T19:53:21Z", "author": {"login": "avijayanhwx"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYYd1_gH2gAyNDA0ODk4NDcxOjFkODIyZDcyMThkMmVhZGMwNGRhMDYwOTg3NGVhOWNhMTczOTFhNzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccyluKgFqTQwMzgzMDM3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1d822d7218d2eadc04da0609874ea9ca17391a74", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/1d822d7218d2eadc04da0609874ea9ca17391a74", "committedDate": "2020-04-17T03:10:35Z", "message": "HDDS-3411. Switch Recon SQL DB to Derby."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MTQ4Mzg0", "url": "https://github.com/apache/ozone/pull/839#pullrequestreview-395148384", "createdAt": "2020-04-17T04:08:31Z", "commit": {"oid": "1d822d7218d2eadc04da0609874ea9ca17391a74"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNDowODozMVrOGG_SCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNDowODozMVrOGG_SCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MTQ0OQ==", "bodyText": "Why does this class only provide 1 configuration item? The JooqPersistence module properties should not be moved here?", "url": "https://github.com/apache/ozone/pull/839#discussion_r409981449", "createdAt": "2020-04-17T04:08:31Z", "author": {"login": "swagle"}, "path": "hadoop-ozone/recon-codegen/src/main/java/org/hadoop/ozone/recon/codegen/ReconSqlDbConfig.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.hadoop.ozone.recon.codegen;\n+\n+import org.apache.hadoop.hdds.conf.Config;\n+import org.apache.hadoop.hdds.conf.ConfigGroup;\n+import org.apache.hadoop.hdds.conf.ConfigTag;\n+import org.apache.hadoop.hdds.conf.ConfigType;\n+\n+/**\n+ * The configuration class for the Recon SQL DB.\n+ */\n+@ConfigGroup(prefix = \"ozone.recon.sql.db\")\n+public class ReconSqlDbConfig {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d822d7218d2eadc04da0609874ea9ca17391a74"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MTQ5MDkx", "url": "https://github.com/apache/ozone/pull/839#pullrequestreview-395149091", "createdAt": "2020-04-17T04:11:21Z", "commit": {"oid": "1d822d7218d2eadc04da0609874ea9ca17391a74"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNDoxMToyMVrOGG_UbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNDoxMToyMVrOGG_UbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MjA2MQ==", "bodyText": "Generally, schemas are lowercase.", "url": "https://github.com/apache/ozone/pull/839#discussion_r409982061", "createdAt": "2020-04-17T04:11:21Z", "author": {"login": "swagle"}, "path": "hadoop-ozone/recon-codegen/src/main/java/org/hadoop/ozone/recon/codegen/JooqCodeGenerator.java", "diffHunk": "@@ -55,10 +60,11 @@\n   private static final Logger LOG =\n       LoggerFactory.getLogger(JooqCodeGenerator.class);\n \n-  private static final String SQLITE_DB =\n-      System.getProperty(\"java.io.tmpdir\") + \"/recon-generated-schema\";\n-  private static final String JDBC_URL = \"jdbc:sqlite:\" + SQLITE_DB;\n-\n+  private static final String DB = Paths.get(\n+      System.getProperty(\"java.io.tmpdir\"),\n+      \"recon-generated-schema-\" + Time.monotonicNow()).toString();\n+  public static final String RECON_SCHEMA_NAME = \"RECON\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d822d7218d2eadc04da0609874ea9ca17391a74"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MTQ5Mjg2", "url": "https://github.com/apache/ozone/pull/839#pullrequestreview-395149286", "createdAt": "2020-04-17T04:12:07Z", "commit": {"oid": "1d822d7218d2eadc04da0609874ea9ca17391a74"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNDoxMjowOFrOGG_VEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNDoxMjowOFrOGG_VEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MjIyNw==", "bodyText": "Any reason to use a timestamp-based path?", "url": "https://github.com/apache/ozone/pull/839#discussion_r409982227", "createdAt": "2020-04-17T04:12:08Z", "author": {"login": "swagle"}, "path": "hadoop-ozone/recon-codegen/src/main/java/org/hadoop/ozone/recon/codegen/JooqCodeGenerator.java", "diffHunk": "@@ -55,10 +60,11 @@\n   private static final Logger LOG =\n       LoggerFactory.getLogger(JooqCodeGenerator.class);\n \n-  private static final String SQLITE_DB =\n-      System.getProperty(\"java.io.tmpdir\") + \"/recon-generated-schema\";\n-  private static final String JDBC_URL = \"jdbc:sqlite:\" + SQLITE_DB;\n-\n+  private static final String DB = Paths.get(\n+      System.getProperty(\"java.io.tmpdir\"),\n+      \"recon-generated-schema-\" + Time.monotonicNow()).toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d822d7218d2eadc04da0609874ea9ca17391a74"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MTUwMjEy", "url": "https://github.com/apache/ozone/pull/839#pullrequestreview-395150212", "createdAt": "2020-04-17T04:15:39Z", "commit": {"oid": "1d822d7218d2eadc04da0609874ea9ca17391a74"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNDoxNTo0MFrOGG_Ydg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNDoxNTo0MFrOGG_Ydg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk4MzA5NA==", "bodyText": "This is actually an antipattern :-) Although I am guilty of this as well. Instead of the if we should have a DerbyDataSourceProvider, SqliteDataSourceProvider and Default one. Can be left as a TODO for later as well, upto you.", "url": "https://github.com/apache/ozone/pull/839#discussion_r409983094", "createdAt": "2020-04-17T04:15:40Z", "author": {"login": "swagle"}, "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/persistence/DefaultDataSourceProvider.java", "diffHunk": "@@ -43,14 +52,26 @@\n    */\n   @Override\n   public DataSource get() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d822d7218d2eadc04da0609874ea9ca17391a74"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MTk2NDU0", "url": "https://github.com/apache/ozone/pull/839#pullrequestreview-395196454", "createdAt": "2020-04-17T06:40:57Z", "commit": {"oid": "1d822d7218d2eadc04da0609874ea9ca17391a74"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNjo0MDo1N1rOGHBsfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNjo0MjowOFrOGHBuNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDAyMDk4OA==", "bodyText": "License is missing.", "url": "https://github.com/apache/ozone/pull/839#discussion_r410020988", "createdAt": "2020-04-17T06:40:57Z", "author": {"login": "vivekratnavel"}, "path": "hadoop-ozone/recon/src/test/java/org/apache/hadoop/ozone/recon/persistence/TestReconWithDifferentSqlDBs.java", "diffHunk": "@@ -0,0 +1,142 @@\n+package org.apache.hadoop.ozone.recon.persistence;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d822d7218d2eadc04da0609874ea9ca17391a74"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDAyMTQzMQ==", "bodyText": "Why should we set schema name as user?", "url": "https://github.com/apache/ozone/pull/839#discussion_r410021431", "createdAt": "2020-04-17T06:42:08Z", "author": {"login": "vivekratnavel"}, "path": "hadoop-ozone/recon-codegen/src/main/java/org/hadoop/ozone/recon/codegen/JooqCodeGenerator.java", "diffHunk": "@@ -109,20 +113,25 @@ private void generateSourceCode(String outputDir) throws Exception {\n    * Provider for embedded datasource.\n    */\n   static class LocalDataSourceProvider implements Provider<DataSource> {\n-    private static SQLiteDataSource db;\n-\n+    private static EmbeddedDataSource dataSource;\n     static {\n-      db = new SQLiteDataSource();\n-      db.setUrl(JDBC_URL);\n+      try {\n+        createNewDerbyDatabase(JDBC_URL, RECON_SCHEMA_NAME);\n+      } catch (Exception e) {\n+        LOG.error(\"Error creating Recon Derby DB.\", e);\n+      }\n+      dataSource = new EmbeddedDataSource();\n+      dataSource.setDatabaseName(DB);\n+      dataSource.setUser(RECON_SCHEMA_NAME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d822d7218d2eadc04da0609874ea9ca17391a74"}, "originalPosition": 86}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MjI1OTA2", "url": "https://github.com/apache/ozone/pull/839#pullrequestreview-395225906", "createdAt": "2020-04-17T07:36:01Z", "commit": {"oid": "1d822d7218d2eadc04da0609874ea9ca17391a74"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNzozNjowMVrOGHDJzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNzozNjowMVrOGHDJzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA0NDg3Ng==", "bodyText": "Thanks the patch @avijayanhwx\nCan we remove old sqlite dependency from here and from hadoop-ozone/dist/src/main/license/LICENSE.txt?\nIs it still required?\nOne other question: do you have any performance numbers between sqlite vs derby? (I don't think it's a big problem, just interested if you know sg.)", "url": "https://github.com/apache/ozone/pull/839#discussion_r410044876", "createdAt": "2020-04-17T07:36:01Z", "author": {"login": "elek"}, "path": "hadoop-ozone/recon/pom.xml", "diffHunk": "@@ -331,6 +331,11 @@\n       <artifactId>bonecp</artifactId>\n       <version>0.8.0.RELEASE</version>\n     </dependency>\n+    <dependency>\n+      <groupId>org.apache.derby</groupId>\n+      <artifactId>derby</artifactId>\n+      <version>10.14.2.0</version>\n+    </dependency>\n     <dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d822d7218d2eadc04da0609874ea9ca17391a74"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17f56a7ec8a5dc68ac8e48ebaa0a016e7c8e6f6c", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/17f56a7ec8a5dc68ac8e48ebaa0a016e7c8e6f6c", "committedDate": "2020-04-23T00:53:59Z", "message": "Fix integration test failure."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83a85a6c96160c56ef7b0962f9f4acf4fc131c74", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/83a85a6c96160c56ef7b0962f9f4acf4fc131c74", "committedDate": "2020-04-23T00:59:32Z", "message": "Rat check."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NTUxODc5", "url": "https://github.com/apache/ozone/pull/839#pullrequestreview-399551879", "createdAt": "2020-04-23T23:46:50Z", "commit": {"oid": "83a85a6c96160c56ef7b0962f9f4acf4fc131c74"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMzo0Njo1MVrOGLAmcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMzo0OToyNFrOGLAqQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5NzM2Mw==", "bodyText": "Can we rename to createReconTaskStatusTable for consistency?", "url": "https://github.com/apache/ozone/pull/839#discussion_r414197363", "createdAt": "2020-04-23T23:46:51Z", "author": {"login": "vivekratnavel"}, "path": "hadoop-ozone/recon-codegen/src/main/java/org/hadoop/ozone/recon/schema/ReconTaskSchemaDefinition.java", "diffHunk": "@@ -48,7 +50,9 @@\n   @Override\n   public void initializeSchema() throws SQLException {\n     Connection conn = dataSource.getConnection();\n-    createReconTaskStatus(conn);\n+    if (!TABLE_EXISTS_CHECK.test(conn, RECON_TASK_STATUS_TABLE_NAME)) {\n+      createReconTaskStatus(conn);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83a85a6c96160c56ef7b0962f9f4acf4fc131c74"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE5ODMzOA==", "bodyText": "Can we rename to createFileSizeCountTable for consistency?", "url": "https://github.com/apache/ozone/pull/839#discussion_r414198338", "createdAt": "2020-04-23T23:49:24Z", "author": {"login": "vivekratnavel"}, "path": "hadoop-ozone/recon-codegen/src/main/java/org/hadoop/ozone/recon/schema/UtilizationSchemaDefinition.java", "diffHunk": "@@ -52,8 +59,12 @@\n   @Transactional\n   public void initializeSchema() throws SQLException {\n     Connection conn = dataSource.getConnection();\n-    createClusterGrowthTable(conn);\n-    createFileSizeCount(conn);\n+    if (!TABLE_EXISTS_CHECK.test(conn, FILE_COUNT_BY_SIZE_TABLE_NAME)) {\n+      createFileSizeCount(conn);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83a85a6c96160c56ef7b0962f9f4acf4fc131c74"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fed115d473fc731e54094a921b94afde1fe24702", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/fed115d473fc731e54094a921b94afde1fe24702", "committedDate": "2020-04-24T21:21:08Z", "message": "Merge remote-tracking branch 'upstream/master' into HDDS-3411-master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d61cbd88bd90948f83e907fa769333d87d4785b0", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/d61cbd88bd90948f83e907fa769333d87d4785b0", "committedDate": "2020-04-27T19:19:21Z", "message": "Merge remote-tracking branch 'upstream/master' into HDDS-3411-master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e22f0905691b3b79d860ea8ae112a352372fd516", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/e22f0905691b3b79d860ea8ae112a352372fd516", "committedDate": "2020-04-27T19:32:20Z", "message": "Address review comments, move SQL DB configs to Java based."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "523f50b4dc19a8b0da5fd185004811e59f236dab", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/523f50b4dc19a8b0da5fd185004811e59f236dab", "committedDate": "2020-04-27T21:48:45Z", "message": "trigger new CI check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa85ecd7376a8ca34598a68a52f9c6fb2d3206ef", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/fa85ecd7376a8ca34598a68a52f9c6fb2d3206ef", "committedDate": "2020-04-27T23:04:06Z", "message": "Fix TestOzoneConfigurationFields integration test failure."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98ebd2675be7660d7355aec5d3557bfcea8f8d03", "author": {"user": {"login": "avijayanhwx", "name": null}}, "url": "https://github.com/apache/ozone/commit/98ebd2675be7660d7355aec5d3557bfcea8f8d03", "committedDate": "2020-04-30T18:25:59Z", "message": "Merge branch 'master' into HDDS-3411-master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzODMwMzc5", "url": "https://github.com/apache/ozone/pull/839#pullrequestreview-403830379", "createdAt": "2020-04-30T19:52:25Z", "commit": {"oid": "98ebd2675be7660d7355aec5d3557bfcea8f8d03"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3395, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}