{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMjk5OTc2", "number": 1291, "title": "HDDS-4062. Non rack aware pipelines should not be created if multiple racks are alive", "bodyText": "What changes were proposed in this pull request?\nIf we have a scenario where one rack has more nodes that others, it is possible for all hosts in the cluster to have reached their pipeline limit, while 3 nodes on the larger rack have not.\nThe current fallback logic will then allow a pipeline to be created which uses only the 3 nodes on the same rack, violating the rack placement policy.\nThere may be other ways this could happen with cluster load too, were the pipeline capacity has reached its limit on some nodes but not others.\nThe proposal here, is that if the cluster has multiple racks AND there are healthy nodes covering at least 2 racks, where healthy is defined as a node which is registered and not stale or dead, then we should not allow \"fallback\" (pipelines which span only 1 rack) pipelines to be created.\nThis means if you have a badly configured cluster - eg Rack 1 = 10 nodes; Rack 2 = 1 node, the pipeline limit will be constrained by the capacity of that 1 node on rack 2. Even a setup like Rack 1 = 10 nodes, Rack 2 = 5 would be constrained by this.\nThis constraint is better than creating non rack aware pipelines, and the rule above will handle the case when the cluster degrades to 1 rack, as the healthy node definition will notice only 1 rack is alive.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4062\nHow was this patch tested?\nNew unit test added to reproduce the issue without the patch and ensure the patch fixes it.", "createdAt": "2020-08-05T10:40:56Z", "url": "https://github.com/apache/ozone/pull/1291", "merged": true, "mergeCommit": {"oid": "8102ac799816f417e096873b6f351fd531f7bfbf"}, "closed": true, "closedAt": "2020-08-26T08:21:52Z", "author": {"login": "sodonnel"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc74ygkAH2gAyNDYzMjk5OTc2OjVhMzA2YzEwNDgzMGI2Zjc4YmE1Y2I3ZTY0MDRjZjc0YmIxY2JiZmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCnbaBgFqTQ3NTI2MDIzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5a306c104830b6f78ba5cb7e6404cf74bb1cbbfb", "author": {"user": null}, "url": "https://github.com/apache/ozone/commit/5a306c104830b6f78ba5cb7e6404cf74bb1cbbfb", "committedDate": "2020-08-05T10:37:28Z", "message": "Initial changes to implement feature"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MTgyNDY0", "url": "https://github.com/apache/ozone/pull/1291#pullrequestreview-466182464", "createdAt": "2020-08-12T18:47:51Z", "commit": {"oid": "5a306c104830b6f78ba5cb7e6404cf74bb1cbbfb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxODo0Nzo1MlrOG_uGSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxODo0Nzo1MlrOG_uGSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTQ2ODc0NA==", "bodyText": "Should we also consider excludedNodes here?", "url": "https://github.com/apache/ozone/pull/1291#discussion_r469468744", "createdAt": "2020-08-12T18:47:52Z", "author": {"login": "nandakumar131"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/pipeline/PipelinePlacementPolicy.java", "diffHunk": "@@ -163,9 +163,42 @@ int currentPipelineCount(DatanodeDetails datanodeDetails, int nodesRequired) {\n       throw new SCMException(msg,\n           SCMException.ResultCodes.FAILED_TO_FIND_SUITABLE_NODE);\n     }\n+\n+    if (!checkAllNodesAreEqual(nodeManager.getClusterNetworkTopologyMap())) {\n+      boolean multipleRacks = multipleRacksAvailable(healthyNodes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a306c104830b6f78ba5cb7e6404cf74bb1cbbfb"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca74ee6feb2e316ac73d2a8117eb9b47619606b3", "author": {"user": null}, "url": "https://github.com/apache/ozone/commit/ca74ee6feb2e316ac73d2a8117eb9b47619606b3", "committedDate": "2020-08-14T09:24:45Z", "message": "Refactor tests based on review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a80d91f1e93ef14bb4571833097c100cf7307ed3", "author": {"user": null}, "url": "https://github.com/apache/ozone/commit/a80d91f1e93ef14bb4571833097c100cf7307ed3", "committedDate": "2020-08-17T10:45:07Z", "message": "Handle excluded nodes correctly"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1MjYwMjMy", "url": "https://github.com/apache/ozone/pull/1291#pullrequestreview-475260232", "createdAt": "2020-08-26T08:21:19Z", "commit": {"oid": "a80d91f1e93ef14bb4571833097c100cf7307ed3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2643, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}