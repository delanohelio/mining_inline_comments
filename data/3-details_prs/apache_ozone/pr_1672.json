{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzOTQ0OTEw", "number": 1672, "title": "HDDS-4558. Support Ozone block token with access mode check.", "bodyText": "What changes were proposed in this pull request?\nAdding read/write access mode check for ozone block token.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4558\nHow was this patch tested?\nadding unit tests and existing acceptance test.", "createdAt": "2020-12-07T21:00:08Z", "url": "https://github.com/apache/ozone/pull/1672", "merged": true, "mergeCommit": {"oid": "c3f6b4b96a5c50834df223d36d2fe691da0e67ee"}, "closed": true, "closedAt": "2021-01-04T22:30:05Z", "author": {"login": "xiaoyuyao"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkfMltgFqTU0ODIwMjQ1Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmduqFABqjQxMTU3NjM4OTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MjAyNDU2", "url": "https://github.com/apache/ozone/pull/1672#pullrequestreview-548202456", "createdAt": "2020-12-09T13:52:53Z", "commit": {"oid": "13486412b1d032fffa11508acdb3a11da92ec252"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMzo1Mjo1NFrOICVrNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMzo1Mjo1NFrOICVrNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMyMzE5MQ==", "bodyText": "NIT: may be safer to throw an exception from a third, generic  }else {. Today there is no other option but if somebody implements a new message type, it will be forced to add condition for the new message.", "url": "https://github.com/apache/ozone/pull/1672#discussion_r539323191", "createdAt": "2020-12-09T13:52:54Z", "author": {"login": "elek"}, "path": "hadoop-hdds/framework/src/main/java/org/apache/hadoop/hdds/security/token/BlockTokenVerifier.java", "diffHunk": "@@ -118,7 +125,19 @@ public void verify(String user, String tokenStr,\n           \" by user: \" + tokenUser);\n     }\n \n-    // TODO: check cmd type and the permissions(AccessMode) in the token\n+    if (cmd == ReadChunk || cmd == GetBlock || cmd == GetSmallFile) {\n+      if (!tokenId.getAccessModes().contains(\n+          HddsProtos.BlockTokenSecretProto.AccessModeProto.READ)) {\n+        throw new BlockTokenException(\"Block token with \" + id\n+            + \" doesn't have READ permission\");\n+      }\n+    } else if (cmd == WriteChunk || cmd == PutBlock || cmd == PutSmallFile) {\n+      if (!tokenId.getAccessModes().contains(\n+          HddsProtos.BlockTokenSecretProto.AccessModeProto.WRITE)) {\n+        throw new BlockTokenException(\"Block token with \" + id\n+            + \" doesn't have WRITE permission\");\n+      }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13486412b1d032fffa11508acdb3a11da92ec252"}, "originalPosition": 57}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "671c997b34a4ccabd12cb4258f81b65eabf609b5", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/671c997b34a4ccabd12cb4258f81b65eabf609b5", "committedDate": "2020-12-09T18:40:01Z", "message": "address code review feedback"}, "afterCommit": {"oid": "8f5282db662ffdd327a584fed1ce81e8724f7d96", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/8f5282db662ffdd327a584fed1ce81e8724f7d96", "committedDate": "2020-12-14T23:13:38Z", "message": "address code review feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c36e3e39bdab659f8f6df58fd1a8aefa136423c9", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/c36e3e39bdab659f8f6df58fd1a8aefa136423c9", "committedDate": "2020-12-15T17:24:04Z", "message": "HDDS-4558. Support Ozone block token with access mode check."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "570246ade7b4a260aa714444e0fa577927253446", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/570246ade7b4a260aa714444e0fa577927253446", "committedDate": "2020-12-15T17:24:04Z", "message": "add block token for file read via hcfs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8e0d223ef5a958f0acdb29c56b9d0e568f5e04b", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/b8e0d223ef5a958f0acdb29c56b9d0e568f5e04b", "committedDate": "2020-12-15T17:24:04Z", "message": "improve the debug log for block token"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b93b5cff64f0c0212ecc772275acd70351f6b113", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/b93b5cff64f0c0212ecc772275acd70351f6b113", "committedDate": "2020-12-15T17:24:10Z", "message": "address code review feedback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f5282db662ffdd327a584fed1ce81e8724f7d96", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/8f5282db662ffdd327a584fed1ce81e8724f7d96", "committedDate": "2020-12-14T23:13:38Z", "message": "address code review feedback"}, "afterCommit": {"oid": "b93b5cff64f0c0212ecc772275acd70351f6b113", "author": {"user": {"login": "xiaoyuyao", "name": "Xiaoyu Yao"}}, "url": "https://github.com/apache/ozone/commit/b93b5cff64f0c0212ecc772275acd70351f6b113", "committedDate": "2020-12-15T17:24:10Z", "message": "address code review feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2061, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}