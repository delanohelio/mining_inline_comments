{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyNjY4ODcz", "number": 714, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMToxOTo0M1rODq-YLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMTozOTo0OFrODq-xjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2Mzg4NzgwOnYy", "diffSide": "LEFT", "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/fsck/MissingContainerTask.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMToxOTo0M1rOF7DgcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMjozODo0NVrOF7Fuyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ2Nzc2MQ==", "bodyText": "Unintended change?", "url": "https://github.com/apache/ozone/pull/714#discussion_r397467761", "createdAt": "2020-03-24T21:19:43Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/fsck/MissingContainerTask.java", "diffHunk": "@@ -47,7 +48,7 @@\n \n   private ContainerManager containerManager;\n   private MissingContainersDao missingContainersDao;\n-  private static final long INTERVAL = 5 * 60 * 1000L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed56e61e2d9827ed1a535a75596e42875557b747"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzUwNDIwMw==", "bodyText": "Good catch :)", "url": "https://github.com/apache/ozone/pull/714#discussion_r397504203", "createdAt": "2020-03-24T22:38:45Z", "author": {"login": "vivekratnavel"}, "path": "hadoop-ozone/recon/src/main/java/org/apache/hadoop/ozone/recon/fsck/MissingContainerTask.java", "diffHunk": "@@ -47,7 +48,7 @@\n \n   private ContainerManager containerManager;\n   private MissingContainersDao missingContainersDao;\n-  private static final long INTERVAL = 5 * 60 * 1000L;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ2Nzc2MQ=="}, "originalCommit": {"oid": "ed56e61e2d9827ed1a535a75596e42875557b747"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MzkwODY4OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/recon/src/test/java/org/apache/hadoop/ozone/recon/fsck/TestMissingContainerTask.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMToyNjoxNVrOF7DtPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMToyNjoxNVrOF7DtPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3MTAzOA==", "bodyText": "Nit. This may be replaced with something like\nall.forEach(r -> Assert.assertTrue(missingContainerIDs.contains(r.getContainerId())));", "url": "https://github.com/apache/ozone/pull/714#discussion_r397471038", "createdAt": "2020-03-24T21:26:15Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-ozone/recon/src/test/java/org/apache/hadoop/ozone/recon/fsck/TestMissingContainerTask.java", "diffHunk": "@@ -90,15 +102,19 @@ public void testRun() throws Exception {\n     missingContainerTask.start();\n \n     LambdaTestUtils.await(6000, 1000, () ->\n-        (missingContainersTableHandle.findAll().size() == 1));\n+        (missingContainersTableHandle.findAll().size() == 2));\n     all = missingContainersTableHandle.findAll();\n-    Assert.assertEquals(3, all.get(0).getContainerId().longValue());\n-\n+    // Container IDs 2 and 3 should be present in the missing containers table\n+    Set<Long> missingContainerIDs = Collections.unmodifiableSet(\n+        new HashSet<>(Arrays.asList(2L, 3L))\n+    );\n+    Assert.assertTrue(all.stream().allMatch(record ->\n+        missingContainerIDs.stream().anyMatch(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed56e61e2d9827ed1a535a75596e42875557b747"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2Mzk0MzMxOnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/recon/src/test/java/org/apache/hadoop/ozone/recon/api/TestContainerEndpoint.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMTozNjo0N1rOF7ECDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMTozNjo0N1rOF7ECDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3NjM2NQ==", "bodyText": "Why not do assertEquals check with \"missingSince\" ?", "url": "https://github.com/apache/ozone/pull/714#discussion_r397476365", "createdAt": "2020-03-24T21:36:47Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-ozone/recon/src/test/java/org/apache/hadoop/ozone/recon/api/TestContainerEndpoint.java", "diffHunk": "@@ -350,24 +407,52 @@ public void testGetContainersWithPrevKey() {\n     assertEquals(1L, containerMetadata.getContainerID());\n \n     // test for negative cases\n-    response = containerKeyService.getContainers(-1, 5L);\n+    response = containerEndpoint.getContainers(-1, 5L);\n     responseObject = (ContainersResponse) response.getEntity();\n     data = responseObject.getContainersResponseData();\n     containers = new ArrayList<>(data.getContainers());\n     assertEquals(0, containers.size());\n     assertEquals(2, data.getTotalCount());\n \n-    response = containerKeyService.getContainers(-1, -1L);\n+    response = containerEndpoint.getContainers(-1, -1L);\n     responseObject = (ContainersResponse) response.getEntity();\n     data = responseObject.getContainersResponseData();\n     containers = new ArrayList<>(data.getContainers());\n     assertEquals(2, containers.size());\n     assertEquals(2, data.getTotalCount());\n   }\n \n+  @Test\n+  public void testGetMissingContainers() {\n+    Response response = containerEndpoint.getMissingContainers();\n+\n+    MissingContainersResponse responseObject =\n+        (MissingContainersResponse) response.getEntity();\n+\n+    assertEquals(0, responseObject.getTotalCount());\n+    assertEquals(Collections.EMPTY_LIST, responseObject.getContainers());\n+\n+    // Add missing containers to the database\n+    long missingSince = System.currentTimeMillis();\n+    MissingContainers newRecord =\n+        new MissingContainers(1L, missingSince);\n+    missingContainersDao.insert(newRecord);\n+\n+    response = containerEndpoint.getMissingContainers();\n+    responseObject = (MissingContainersResponse) response.getEntity();\n+    assertEquals(1, responseObject.getTotalCount());\n+    MissingContainerMetadata container =\n+        responseObject.getContainers().stream().findFirst().orElse(null);\n+    Assert.assertNotNull(container);\n+\n+    assertEquals(containerID.getId(), container.getContainerID());\n+    assertEquals(keyCount, container.getKeys());\n+    assertEquals(pipelineID.getId(), container.getPipelineID());\n+    assertEquals(0, container.getDatanodes().size());\n+    assertTrue(System.currentTimeMillis() > container.getMissingSince());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed56e61e2d9827ed1a535a75596e42875557b747"}, "originalPosition": 319}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2Mzk1Mjc2OnYy", "diffSide": "RIGHT", "path": "hadoop-ozone/recon/src/test/java/org/apache/hadoop/ozone/recon/api/TestContainerEndpoint.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMTozOTo0OFrOF7EH4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMTozOTo0OFrOF7EH4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ3Nzg1Ng==", "bodyText": "Nit. We can probably get rid of this method 'getMockOzoneManagerServiceProvider'.", "url": "https://github.com/apache/ozone/pull/714#discussion_r397477856", "createdAt": "2020-03-24T21:39:48Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-ozone/recon/src/test/java/org/apache/hadoop/ozone/recon/api/TestContainerEndpoint.java", "diffHunk": "@@ -45,66 +48,120 @@\n import org.apache.hadoop.ozone.recon.api.types.ContainersResponse;\n import org.apache.hadoop.ozone.recon.api.types.KeyMetadata;\n import org.apache.hadoop.ozone.recon.api.types.KeysResponse;\n+import org.apache.hadoop.ozone.recon.api.types.MissingContainerMetadata;\n+import org.apache.hadoop.ozone.recon.api.types.MissingContainersResponse;\n import org.apache.hadoop.ozone.recon.recovery.ReconOMMetadataManager;\n+import org.apache.hadoop.ozone.recon.scm.ReconContainerManager;\n+import org.apache.hadoop.ozone.recon.scm.ReconStorageContainerManagerFacade;\n import org.apache.hadoop.ozone.recon.spi.ContainerDBServiceProvider;\n+import org.apache.hadoop.ozone.recon.spi.StorageContainerServiceProvider;\n import org.apache.hadoop.ozone.recon.spi.impl.OzoneManagerServiceProviderImpl;\n+import org.apache.hadoop.ozone.recon.spi.impl.StorageContainerServiceProviderImpl;\n import org.apache.hadoop.ozone.recon.tasks.ContainerKeyMapperTask;\n import org.apache.hadoop.hdds.utils.db.Table;\n+import org.hadoop.ozone.recon.schema.ReconTaskSchemaDefinition;\n import org.hadoop.ozone.recon.schema.StatsSchemaDefinition;\n-import org.jooq.impl.DSL;\n-import org.jooq.impl.DefaultConfiguration;\n+import org.hadoop.ozone.recon.schema.UtilizationSchemaDefinition;\n+import org.hadoop.ozone.recon.schema.tables.daos.MissingContainersDao;\n+import org.hadoop.ozone.recon.schema.tables.daos.ReconTaskStatusDao;\n+import org.hadoop.ozone.recon.schema.tables.pojos.MissingContainers;\n+import org.jooq.Configuration;\n+import org.junit.Assert;\n import org.junit.Before;\n import org.junit.Test;\n \n import com.google.inject.AbstractModule;\n import com.google.inject.Injector;\n \n /**\n- * Test for container key service.\n+ * Test for container endpoint.\n  */\n-public class TestContainerKeyService extends AbstractOMMetadataManagerTest {\n+public class TestContainerEndpoint extends AbstractOMMetadataManagerTest {\n \n   private ContainerDBServiceProvider containerDbServiceProvider;\n-  private Injector injector;\n-  private OzoneManagerServiceProviderImpl ozoneManagerServiceProvider;\n-  private ContainerKeyService containerKeyService;\n+  private ContainerEndpoint containerEndpoint;\n   private GuiceInjectorUtilsForTestsImpl guiceInjectorTest =\n       new GuiceInjectorUtilsForTestsImpl();\n   private boolean isSetupDone = false;\n   private ReconOMMetadataManager reconOMMetadataManager;\n+  private MissingContainersDao missingContainersDao;\n+  private ContainerID containerID = new ContainerID(1L);\n+  private PipelineID pipelineID;\n+  private long keyCount = 5L;\n   private void initializeInjector() throws Exception {\n     reconOMMetadataManager = getTestMetadataManager(\n         initializeNewOmMetadataManager());\n-    ozoneManagerServiceProvider = getMockOzoneManagerServiceProvider();\n+    OzoneManagerServiceProviderImpl ozoneManagerServiceProvider =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed56e61e2d9827ed1a535a75596e42875557b747"}, "originalPosition": 80}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4870, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}