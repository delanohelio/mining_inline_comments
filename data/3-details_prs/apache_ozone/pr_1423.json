{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg2OTkzMjY5", "number": 1423, "title": "HDDS-4244. Container deleted wrong replica cause mis-replicated.", "bodyText": "What changes were proposed in this pull request?\nContainer deleted wrong replica cause mis-replicated.\nWhat is the link to the Apache JIRA\nHDDS-4244\nHow was this patch tested?\n\nRelated config file\n\nozone-site.xml\n\n\n\n  <property>\n    <name>ozone.scm.container.placement.impl</name>\n    <value>org.apache.hadoop.hdds.scm.container.placement.algorithms.SCMContainerPlacementRackAware</value>\n  </property>\n  <property>\n    <name>net.topology.node.switch.mapping.impl</name>\n    <value>org.apache.hadoop.net.TableMapping</value>\n  </property>\n  <property>\n    <name>net.topology.table.file.name</name>\n    <value>/data/ozoneadmin/ozoneenv/ozone/etc/hadoop/network-config</value>\n  </property>\n\nnetwork-config\n\n192.168.1.100 /racks1\n192.168.1.101 /racks1\n192.168.1.102 /racks1\n192.168.1.103 /racks2\n192.168.1.104 /racks2\n192.168.1.106 /racks2\n\nFirst you should make the 3 replicas of the tested container on the same racks, like racks1.\nsecondly, change the config file update the request config.\n2 ReplicationManager interval, you can use the following command to verify the container replicas are in the 2 racks.\nozone admin container info #xxx", "createdAt": "2020-09-15T02:38:09Z", "url": "https://github.com/apache/ozone/pull/1423", "merged": true, "mergeCommit": {"oid": "570d34c521d0c236d4acbaca4fcfd992ca6bad3e"}, "closed": true, "closedAt": "2020-09-16T09:56:56Z", "author": {"login": "maobaolong"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdI-QusgH2gAyNDg2OTkzMjY5OmEzNTMxOGY5YjE3YjU3MTViMzAwYThjZjE5YmZmZmUyZTMxN2ZiNDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdK_4rIAFqTQ5MjQxNDM4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a35318f9b17b5715b300a8cf19bfffe2e317fb46", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/a35318f9b17b5715b300a8cf19bfffe2e317fb46", "committedDate": "2020-09-15T02:21:01Z", "message": "HDDS-4244. Container deleted wrong replica cause mis-replicated."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c560209277098e849aea6bcbeb83897e543bef3", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/2c560209277098e849aea6bcbeb83897e543bef3", "committedDate": "2020-09-15T03:23:20Z", "message": "HDDS-4244. Container deleted wrong replica cause mis-replicated."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5758e15e0af8c5a83ae81f54e5982d629c722e69", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/5758e15e0af8c5a83ae81f54e5982d629c722e69", "committedDate": "2020-09-15T03:41:06Z", "message": "Fix style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38233103f81973ce112bba7c03369f567293d1ba", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/38233103f81973ce112bba7c03369f567293d1ba", "committedDate": "2020-09-15T09:25:17Z", "message": "add a test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fd1d9e5eba1b97e20cc2ea3f91346c279fd30ee", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/2fd1d9e5eba1b97e20cc2ea3f91346c279fd30ee", "committedDate": "2020-09-16T03:49:46Z", "message": "add an testOverReplicatedAndPolicyUnSatisfied test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8111f0f8456f13ffeee051eeafd2205452ba2142", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/8111f0f8456f13ffeee051eeafd2205452ba2142", "committedDate": "2020-09-16T08:11:45Z", "message": "add an testOverReplicatedAndPolicyUnSatisfiedAndDeleted test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c56cdd1b9b990546db2f08ba0b9f7c0e71e3299c", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/c56cdd1b9b990546db2f08ba0b9f7c0e71e3299c", "committedDate": "2020-09-16T08:33:16Z", "message": "Remove the testOverReplicatedAndPolicyUnSatisfied test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecc8c6d9a5fcc1b540a0ad2c93ea16fb6a916abc", "author": {"user": {"login": "maobaolong", "name": "maobaolong"}}, "url": "https://github.com/apache/ozone/commit/ecc8c6d9a5fcc1b540a0ad2c93ea16fb6a916abc", "committedDate": "2020-09-16T08:34:38Z", "message": "Fix style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNDE0Mzgz", "url": "https://github.com/apache/ozone/pull/1423#pullrequestreview-492414383", "createdAt": "2020-09-21T09:22:24Z", "commit": {"oid": "ecc8c6d9a5fcc1b540a0ad2c93ea16fb6a916abc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwOToyMjoyNFrOHVHMaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwOToyMjoyNFrOHVHMaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkwMDAwOQ==", "bodyText": "Why do we need such a complex condition check?\nWon't fixing the previous check solve the problem?\nif (misReplicated || !nowMisRep) to if (!misReplicated || nowMisRep)", "url": "https://github.com/apache/ozone/pull/1423#discussion_r491900009", "createdAt": "2020-09-21T09:22:24Z", "author": {"login": "nandakumar131"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ReplicationManager.java", "diffHunk": "@@ -660,21 +660,23 @@ private void handleOverReplicatedContainer(final ContainerInfo container,\n       if (excess > 0) {\n         eligibleReplicas.removeAll(unhealthyReplicas);\n         Set<ContainerReplica> replicaSet = new HashSet<>(eligibleReplicas);\n-        boolean misReplicated =\n-            getPlacementStatus(replicaSet, replicationFactor)\n-                .isPolicySatisfied();\n+        ContainerPlacementStatus ps =\n+            getPlacementStatus(replicaSet, replicationFactor);\n         for (ContainerReplica r : eligibleReplicas) {\n           if (excess <= 0) {\n             break;\n           }\n           // First remove the replica we are working on from the set, and then\n           // check if the set is now mis-replicated.\n           replicaSet.remove(r);\n-          boolean nowMisRep = getPlacementStatus(replicaSet, replicationFactor)\n-              .isPolicySatisfied();\n-          if (misReplicated || !nowMisRep) {\n-            // Remove the replica if the container was already mis-replicated\n-            // OR if losing this replica does not make it become mis-replicated\n+          ContainerPlacementStatus nowPS =\n+              getPlacementStatus(replicaSet, replicationFactor);\n+          if ((!ps.isPolicySatisfied()\n+                && nowPS.actualPlacementCount() == ps.actualPlacementCount())\n+              || (ps.isPolicySatisfied() && nowPS.isPolicySatisfied())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecc8c6d9a5fcc1b540a0ad2c93ea16fb6a916abc"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2520, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}