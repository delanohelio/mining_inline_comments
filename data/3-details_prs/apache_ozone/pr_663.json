{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2NTUxOTEy", "number": 663, "title": "HDDS-3156 update allocateContainer to remove additional createPipeline step.", "bodyText": "What changes were proposed in this pull request?\nUpate allocateContainer not to try creating pipeline every time.\n(Please fill in changes proposed in this fix)\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3156\n(Please create an issue in ASF JIRA before opening a pull request,\nand you need to set the title of the pull request which starts with\nthe corresponding JIRA issue number. (e.g. HDDS-XXXX. Fix a typo in YYY.)\nPlease replace this section with the link to the Apache JIRA)\nHow was this patch tested?\nNot needed.\n(Please explain how this patch was tested. Ex: unit tests, manual tests)\n(If this patch involves UI changes, please attach a screen-shot; otherwise, remove this)", "createdAt": "2020-03-11T08:37:42Z", "url": "https://github.com/apache/ozone/pull/663", "merged": true, "mergeCommit": {"oid": "f2343f176a52254a6fb595f02c6b097a106e5d06"}, "closed": true, "closedAt": "2020-03-31T17:38:53Z", "author": {"login": "timmylicheng"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMjUiagBqjMxMTc4NzM2MTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNHssXgBqjMxMjUyNTk0NDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9e0a322f44a85987818e6f185dc0eba58865196c", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/9e0a322f44a85987818e6f185dc0eba58865196c", "committedDate": "2020-03-11T08:34:39Z", "message": "HDDS-3156 Remove additional createPipeline call in allocateContainer."}, "afterCommit": {"oid": "0d847c8307beab85bcf96a149ad47e544c2d4865", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/0d847c8307beab85bcf96a149ad47e544c2d4865", "committedDate": "2020-03-11T09:02:03Z", "message": "HDDS-3156 Remove additional createPipeline call in allocateContainer."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d847c8307beab85bcf96a149ad47e544c2d4865", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/0d847c8307beab85bcf96a149ad47e544c2d4865", "committedDate": "2020-03-11T09:02:03Z", "message": "HDDS-3156 Remove additional createPipeline call in allocateContainer."}, "afterCommit": {"oid": "adc4dc5dfa9f6a60e615bcdb13eb84a808e06e47", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/adc4dc5dfa9f6a60e615bcdb13eb84a808e06e47", "committedDate": "2020-03-11T10:36:22Z", "message": "HDDS-3156 Remove additional createPipeline call in allocateContainer."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "adc4dc5dfa9f6a60e615bcdb13eb84a808e06e47", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/adc4dc5dfa9f6a60e615bcdb13eb84a808e06e47", "committedDate": "2020-03-11T10:36:22Z", "message": "HDDS-3156 Remove additional createPipeline call in allocateContainer."}, "afterCommit": {"oid": "2a827cf2593797b016fe1ee0b2e2c8c85969054c", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/2a827cf2593797b016fe1ee0b2e2c8c85969054c", "committedDate": "2020-03-11T13:23:04Z", "message": "HDDS-3156 Remove additional createPipeline call in allocateContainer."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab3f2a047e424d51f63e77d3a4da190f14344d55", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/ab3f2a047e424d51f63e77d3a4da190f14344d55", "committedDate": "2020-03-11T16:21:06Z", "message": "HDDS-3156 update allocateContainer to remove additional createPipeline step."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2a827cf2593797b016fe1ee0b2e2c8c85969054c", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/2a827cf2593797b016fe1ee0b2e2c8c85969054c", "committedDate": "2020-03-11T13:23:04Z", "message": "HDDS-3156 Remove additional createPipeline call in allocateContainer."}, "afterCommit": {"oid": "ab3f2a047e424d51f63e77d3a4da190f14344d55", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/ab3f2a047e424d51f63e77d3a4da190f14344d55", "committedDate": "2020-03-11T16:21:06Z", "message": "HDDS-3156 update allocateContainer to remove additional createPipeline step."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMjE3ODcy", "url": "https://github.com/apache/ozone/pull/663#pullrequestreview-373217872", "createdAt": "2020-03-12T00:54:22Z", "commit": {"oid": "ab3f2a047e424d51f63e77d3a4da190f14344d55"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwMDo1NDoyMlrOF1OFAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwMDo1NDoyMlrOF1OFAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM0OTUwNw==", "bodyText": "If ozone.scm.pipeline.creation.auto.factor.one is not disabled even ratis with factor one pipeline creation is taken care by BackGroundPipelineCreator.", "url": "https://github.com/apache/ozone/pull/663#discussion_r391349507", "createdAt": "2020-03-12T00:54:22Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-hdds/server-scm/src/main/java/org/apache/hadoop/hdds/scm/container/ContainerStateManager.java", "diffHunk": "@@ -247,23 +247,29 @@ ContainerInfo allocateContainer(final PipelineManager pipelineManager,\n       final HddsProtos.ReplicationType type,\n       final HddsProtos.ReplicationFactor replicationFactor, final String owner)\n       throws IOException {\n-\n+    final List<Pipeline> pipelines = pipelineManager\n+        .getPipelines(type, replicationFactor, Pipeline.PipelineState.OPEN);\n     Pipeline pipeline;\n-    try {\n-      // TODO: #CLUTIL remove creation logic when all replication types and\n-      // factors are handled by pipeline creator job.\n-      pipeline = pipelineManager.createPipeline(type, replicationFactor);\n-      pipelineManager.waitPipelineReady(pipeline.getId(), 0);\n-    } catch (IOException e) {\n-      final List<Pipeline> pipelines = pipelineManager\n-          .getPipelines(type, replicationFactor, Pipeline.PipelineState.OPEN);\n-      if (pipelines.isEmpty()) {\n-        throw new IOException(\"Could not allocate container. Cannot get any\" +\n-            \" matching pipeline for Type:\" + type +\n-            \", Factor:\" + replicationFactor + \", State:PipelineState.OPEN\");\n-      }\n+\n+    if (!pipelines.isEmpty() && replicationFactor == ReplicationFactor.THREE\n+        && type == ReplicationType.RATIS) {\n+      // Let background create Ratis THREE pipelines.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab3f2a047e424d51f63e77d3a4da190f14344d55"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a37e2a320abb5eb9e0192c9221254400fb037357", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/a37e2a320abb5eb9e0192c9221254400fb037357", "committedDate": "2020-03-13T03:24:59Z", "message": "Consider ratis one pipeline when auto creatiom is disabled."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "532361bc7ee73cf588ca3746a2211d34d497be98", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/532361bc7ee73cf588ca3746a2211d34d497be98", "committedDate": "2020-03-12T09:21:14Z", "message": "Consider ratis one pipeline when auto creatiom is disabled."}, "afterCommit": {"oid": "a37e2a320abb5eb9e0192c9221254400fb037357", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/a37e2a320abb5eb9e0192c9221254400fb037357", "committedDate": "2020-03-13T03:24:59Z", "message": "Consider ratis one pipeline when auto creatiom is disabled."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3453, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}