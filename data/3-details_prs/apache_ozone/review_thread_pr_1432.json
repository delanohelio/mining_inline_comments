{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4MzcxMjQ1", "number": 1432, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwODozNjowMVrOEk30yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNzowNzozNFrOElwqFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MDk4ODI3OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/DataNodeStorageConfig.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwODozNjowMVrOHUDg3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMzo0Mjo0NVrOHUetwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc5MTEzMw==", "bodyText": "As OMStorage has om id(uuid), SCMStorageConfig has scm id(uuid). Can we also set/get datanode id (datanode uuid) as NodeProperties here?", "url": "https://github.com/apache/ozone/pull/1432#discussion_r490791133", "createdAt": "2020-09-18T08:36:01Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/DataNodeStorageConfig.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.container.common;\n+\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos.NodeType;\n+import org.apache.hadoop.ozone.common.Storage;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.Properties;\n+\n+import static org.apache.hadoop.hdds.server.ServerUtils.getOzoneMetaDirPath;\n+import static org.apache.hadoop.ozone.OzoneConsts.DATANODE_STORAGE_CONFIG;\n+\n+/**\n+ * DataNodeStorageConfig is responsible for management of the\n+ * StorageDirectories used by the DataNode.\n+ */\n+public class DataNodeStorageConfig extends Storage {\n+\n+  /**\n+   * Construct DataNodeStorageConfig.\n+   * @throws IOException if any directories are inaccessible.\n+   */\n+  public DataNodeStorageConfig(OzoneConfiguration conf) throws IOException {\n+    super(NodeType.DATANODE, getOzoneMetaDirPath(conf),\n+        DATANODE_STORAGE_CONFIG);\n+  }\n+\n+  public DataNodeStorageConfig(NodeType type, File root, String sdName)\n+      throws IOException {\n+    super(type, root, sdName);\n+  }\n+\n+  @Override\n+  protected Properties getNodeProperties() {\n+    // No additional properties for now.\n+    return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39213d18b279cab71f5353807610ce3840a49a0d"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIzNjgwMQ==", "bodyText": "Yes, it can be added over time as needed.", "url": "https://github.com/apache/ozone/pull/1432#discussion_r491236801", "createdAt": "2020-09-18T23:42:45Z", "author": {"login": "prashantpogde"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/DataNodeStorageConfig.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.container.common;\n+\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos.NodeType;\n+import org.apache.hadoop.ozone.common.Storage;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.Properties;\n+\n+import static org.apache.hadoop.hdds.server.ServerUtils.getOzoneMetaDirPath;\n+import static org.apache.hadoop.ozone.OzoneConsts.DATANODE_STORAGE_CONFIG;\n+\n+/**\n+ * DataNodeStorageConfig is responsible for management of the\n+ * StorageDirectories used by the DataNode.\n+ */\n+public class DataNodeStorageConfig extends Storage {\n+\n+  /**\n+   * Construct DataNodeStorageConfig.\n+   * @throws IOException if any directories are inaccessible.\n+   */\n+  public DataNodeStorageConfig(OzoneConfiguration conf) throws IOException {\n+    super(NodeType.DATANODE, getOzoneMetaDirPath(conf),\n+        DATANODE_STORAGE_CONFIG);\n+  }\n+\n+  public DataNodeStorageConfig(NodeType type, File root, String sdName)\n+      throws IOException {\n+    super(type, root, sdName);\n+  }\n+\n+  @Override\n+  protected Properties getNodeProperties() {\n+    // No additional properties for now.\n+    return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc5MTEzMw=="}, "originalCommit": {"oid": "39213d18b279cab71f5353807610ce3840a49a0d"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MTAwNjgwOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/commandhandler/FinalizeNewLayoutVersionCommandHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwODo0MTozMlrOHUDsfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMzo0NTo1MlrOHUev8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc5NDEwOQ==", "bodyText": "The variable name containerId seems not related, can we rename to finalizeUpgrade?", "url": "https://github.com/apache/ozone/pull/1432#discussion_r490794109", "createdAt": "2020-09-18T08:41:32Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/commandhandler/FinalizeNewLayoutVersionCommandHandler.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.ozone.container.common.statemachine.commandhandler;\n+\n+import org.apache.hadoop.hdds.protocol.DatanodeDetails;\n+import org.apache.hadoop.hdds.protocol.proto\n+    .StorageContainerDatanodeProtocolProtos.SCMCommandProto;\n+import org.apache.hadoop.hdds.protocol.proto\n+    .StorageContainerDatanodeProtocolProtos\n+    .FinalizeNewLayoutVersionCommandProto;\n+import org.apache.hadoop.ozone.container.common.statemachine\n+    .SCMConnectionManager;\n+import org.apache.hadoop.ozone.container.common.statemachine.StateContext;\n+import org.apache.hadoop.ozone.container.ozoneimpl.ContainerController;\n+import org.apache.hadoop.ozone.container.ozoneimpl.OzoneContainer;\n+import org.apache.hadoop.ozone.protocol.commands.FinalizeNewLayoutVersionCommand;\n+import org.apache.hadoop.ozone.protocol.commands.SCMCommand;\n+import org.apache.hadoop.util.Time;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+/**\n+ * Handler for FinalizeNewLayoutVersion command received from SCM.\n+ */\n+public class FinalizeNewLayoutVersionCommandHandler implements CommandHandler {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(FinalizeNewLayoutVersionCommandHandler.class);\n+\n+  private AtomicLong invocationCount = new AtomicLong(0);\n+  private long totalTime;\n+\n+  /**\n+   * Constructs a FinalizeNewLayoutVersionCommandHandler.\n+   */\n+  public FinalizeNewLayoutVersionCommandHandler() {\n+  }\n+\n+  /**\n+   * Handles a given SCM command.\n+   *\n+   * @param command           - SCM Command\n+   * @param ozoneContainer         - Ozone Container.\n+   * @param context           - Current Context.\n+   * @param connectionManager - The SCMs that we are talking to.\n+   */\n+  @Override\n+  public void handle(SCMCommand command, OzoneContainer ozoneContainer,\n+      StateContext context, SCMConnectionManager connectionManager) {\n+    LOG.debug(\"Processing FinalizeNewLayoutVersionCommandHandler command.\");\n+    invocationCount.incrementAndGet();\n+    final long startTime = Time.monotonicNow();\n+    final DatanodeDetails datanodeDetails = context.getParent()\n+        .getDatanodeDetails();\n+    final FinalizeNewLayoutVersionCommandProto finalizeCommand =\n+        ((FinalizeNewLayoutVersionCommand)command).getProto();\n+    final ContainerController controller = ozoneContainer.getController();\n+    final boolean containerId = finalizeCommand.getFinalizeNewLayoutVersion();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39213d18b279cab71f5353807610ce3840a49a0d"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIzNzM2Mg==", "bodyText": "Yup.", "url": "https://github.com/apache/ozone/pull/1432#discussion_r491237362", "createdAt": "2020-09-18T23:45:52Z", "author": {"login": "prashantpogde"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/commandhandler/FinalizeNewLayoutVersionCommandHandler.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership.  The ASF\n+ * licenses this file to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ * <p>\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ * <p>\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.hadoop.ozone.container.common.statemachine.commandhandler;\n+\n+import org.apache.hadoop.hdds.protocol.DatanodeDetails;\n+import org.apache.hadoop.hdds.protocol.proto\n+    .StorageContainerDatanodeProtocolProtos.SCMCommandProto;\n+import org.apache.hadoop.hdds.protocol.proto\n+    .StorageContainerDatanodeProtocolProtos\n+    .FinalizeNewLayoutVersionCommandProto;\n+import org.apache.hadoop.ozone.container.common.statemachine\n+    .SCMConnectionManager;\n+import org.apache.hadoop.ozone.container.common.statemachine.StateContext;\n+import org.apache.hadoop.ozone.container.ozoneimpl.ContainerController;\n+import org.apache.hadoop.ozone.container.ozoneimpl.OzoneContainer;\n+import org.apache.hadoop.ozone.protocol.commands.FinalizeNewLayoutVersionCommand;\n+import org.apache.hadoop.ozone.protocol.commands.SCMCommand;\n+import org.apache.hadoop.util.Time;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+/**\n+ * Handler for FinalizeNewLayoutVersion command received from SCM.\n+ */\n+public class FinalizeNewLayoutVersionCommandHandler implements CommandHandler {\n+\n+  private static final Logger LOG =\n+      LoggerFactory.getLogger(FinalizeNewLayoutVersionCommandHandler.class);\n+\n+  private AtomicLong invocationCount = new AtomicLong(0);\n+  private long totalTime;\n+\n+  /**\n+   * Constructs a FinalizeNewLayoutVersionCommandHandler.\n+   */\n+  public FinalizeNewLayoutVersionCommandHandler() {\n+  }\n+\n+  /**\n+   * Handles a given SCM command.\n+   *\n+   * @param command           - SCM Command\n+   * @param ozoneContainer         - Ozone Container.\n+   * @param context           - Current Context.\n+   * @param connectionManager - The SCMs that we are talking to.\n+   */\n+  @Override\n+  public void handle(SCMCommand command, OzoneContainer ozoneContainer,\n+      StateContext context, SCMConnectionManager connectionManager) {\n+    LOG.debug(\"Processing FinalizeNewLayoutVersionCommandHandler command.\");\n+    invocationCount.incrementAndGet();\n+    final long startTime = Time.monotonicNow();\n+    final DatanodeDetails datanodeDetails = context.getParent()\n+        .getDatanodeDetails();\n+    final FinalizeNewLayoutVersionCommandProto finalizeCommand =\n+        ((FinalizeNewLayoutVersionCommand)command).getProto();\n+    final ContainerController controller = ozoneContainer.getController();\n+    final boolean containerId = finalizeCommand.getFinalizeNewLayoutVersion();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc5NDEwOQ=="}, "originalCommit": {"oid": "39213d18b279cab71f5353807610ce3840a49a0d"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MTAzMTQ4OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/endpoint/HeartbeatEndpointTask.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwODo0ODo0MlrOHUD8OQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMzo0NzoxN1rOHUew4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc5ODEzNw==", "bodyText": "Can we add a new constructor method without HDDSLayoutVersionManager passed in?\nBy default case, it can extract from DatanodeStateMachine.\nHeartbeatEndpointTask(EndpointStateMachine rpcEndpoint, ConfigurationSource conf, StateContext context,\nHDDSLayoutVersionManager versionManager) should only be visible for test.", "url": "https://github.com/apache/ozone/pull/1432#discussion_r490798137", "createdAt": "2020-09-18T08:48:42Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/endpoint/HeartbeatEndpointTask.java", "diffHunk": "@@ -83,21 +87,28 @@\n   private StateContext context;\n   private int maxContainerActionsPerHB;\n   private int maxPipelineActionsPerHB;\n+  private HDDSLayoutVersionManager layoutVersionManager;\n \n   /**\n    * Constructs a SCM heart beat.\n    *\n    * @param conf Config.\n    */\n   public HeartbeatEndpointTask(EndpointStateMachine rpcEndpoint,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39213d18b279cab71f5353807610ce3840a49a0d"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIzNzYwMA==", "bodyText": "ok. I will add another constructor.", "url": "https://github.com/apache/ozone/pull/1432#discussion_r491237600", "createdAt": "2020-09-18T23:47:17Z", "author": {"login": "prashantpogde"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/endpoint/HeartbeatEndpointTask.java", "diffHunk": "@@ -83,21 +87,28 @@\n   private StateContext context;\n   private int maxContainerActionsPerHB;\n   private int maxPipelineActionsPerHB;\n+  private HDDSLayoutVersionManager layoutVersionManager;\n \n   /**\n    * Constructs a SCM heart beat.\n    *\n    * @param conf Config.\n    */\n   public HeartbeatEndpointTask(EndpointStateMachine rpcEndpoint,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc5ODEzNw=="}, "originalCommit": {"oid": "39213d18b279cab71f5353807610ce3840a49a0d"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MTA0Mjg1OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/endpoint/RegisterEndpointTask.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwODo1MTozOVrOHUEDQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMzo0ODo1MlrOHUex1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc5OTkzOA==", "bodyText": "Same review comment for RegisterEndpointTask construction method like above.", "url": "https://github.com/apache/ozone/pull/1432#discussion_r490799938", "createdAt": "2020-09-18T08:51:39Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/endpoint/RegisterEndpointTask.java", "diffHunk": "@@ -65,12 +69,17 @@\n   @VisibleForTesting\n   public RegisterEndpointTask(EndpointStateMachine rpcEndPoint,\n       ConfigurationSource conf, OzoneContainer ozoneContainer,\n-      StateContext context) {\n+      StateContext context, HDDSLayoutVersionManager layoutVersionManager) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39213d18b279cab71f5353807610ce3840a49a0d"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIzNzg0NQ==", "bodyText": "yup, I will add another constructor.", "url": "https://github.com/apache/ozone/pull/1432#discussion_r491237845", "createdAt": "2020-09-18T23:48:52Z", "author": {"login": "prashantpogde"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/endpoint/RegisterEndpointTask.java", "diffHunk": "@@ -65,12 +69,17 @@\n   @VisibleForTesting\n   public RegisterEndpointTask(EndpointStateMachine rpcEndPoint,\n       ConfigurationSource conf, OzoneContainer ozoneContainer,\n-      StateContext context) {\n+      StateContext context, HDDSLayoutVersionManager layoutVersionManager) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc5OTkzOA=="}, "originalCommit": {"oid": "39213d18b279cab71f5353807610ce3840a49a0d"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3Mzk2NzgzOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/endpoint/HeartbeatEndpointTask.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQwMToyODoxMFrOHUfofg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQwMTo0NjoyNVrOHUfvcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI1MTgzOA==", "bodyText": "We can reuse the lines of constructor method, like this\npublic HeartbeatEndpointTask(EndpointStateMachine rpcEndpoint,\nConfigurationSource conf, StateContext context) {\nthis(rpcEndpoint, conf, context, context.getParent().getDataNodeVersionManager())\n}\npublic HeartbeatEndpointTask(EndpointStateMachine rpcEndpoint,\nConfigurationSource conf, StateContext context,\nHDDSLayoutVersionManager versionManager) {\n...\nlayoutVersionManager = versionManager;\n}", "url": "https://github.com/apache/ozone/pull/1432#discussion_r491251838", "createdAt": "2020-09-19T01:28:10Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/endpoint/HeartbeatEndpointTask.java", "diffHunk": "@@ -83,21 +87,50 @@\n   private StateContext context;\n   private int maxContainerActionsPerHB;\n   private int maxPipelineActionsPerHB;\n+  private HDDSLayoutVersionManager layoutVersionManager;\n \n   /**\n    * Constructs a SCM heart beat.\n    *\n+   * @param rpcEndpoint rpc Endpoint\n    * @param conf Config.\n+   * @param context State context\n    */\n   public HeartbeatEndpointTask(EndpointStateMachine rpcEndpoint,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "579e95ff765567e6d5a7988fcf479b1ddcc9a98d"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI1MzYxOQ==", "bodyText": "yup", "url": "https://github.com/apache/ozone/pull/1432#discussion_r491253619", "createdAt": "2020-09-19T01:46:25Z", "author": {"login": "prashantpogde"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/endpoint/HeartbeatEndpointTask.java", "diffHunk": "@@ -83,21 +87,50 @@\n   private StateContext context;\n   private int maxContainerActionsPerHB;\n   private int maxPipelineActionsPerHB;\n+  private HDDSLayoutVersionManager layoutVersionManager;\n \n   /**\n    * Constructs a SCM heart beat.\n    *\n+   * @param rpcEndpoint rpc Endpoint\n    * @param conf Config.\n+   * @param context State context\n    */\n   public HeartbeatEndpointTask(EndpointStateMachine rpcEndpoint,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI1MTgzOA=="}, "originalCommit": {"oid": "579e95ff765567e6d5a7988fcf479b1ddcc9a98d"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3Mzk2OTQ0OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/endpoint/RegisterEndpointTask.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQwMTozMDowNFrOHUfpOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOVQwMTo0NjozNVrOHUfvfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI1MjAyNw==", "bodyText": "Same suggestion comment for constructor method like above.", "url": "https://github.com/apache/ozone/pull/1432#discussion_r491252027", "createdAt": "2020-09-19T01:30:04Z", "author": {"login": "linyiqun"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/endpoint/RegisterEndpointTask.java", "diffHunk": "@@ -54,23 +57,52 @@\n   private DatanodeDetails datanodeDetails;\n   private final OzoneContainer datanodeContainerManager;\n   private StateContext stateContext;\n+  private HDDSLayoutVersionManager layoutVersionManager;\n \n   /**\n    * Creates a register endpoint task.\n    *\n    * @param rpcEndPoint - endpoint\n    * @param conf - conf\n    * @param ozoneContainer - container\n+   * @param context - State context\n    */\n   @VisibleForTesting\n   public RegisterEndpointTask(EndpointStateMachine rpcEndPoint,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "579e95ff765567e6d5a7988fcf479b1ddcc9a98d"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI1MzYzMQ==", "bodyText": "yup", "url": "https://github.com/apache/ozone/pull/1432#discussion_r491253631", "createdAt": "2020-09-19T01:46:35Z", "author": {"login": "prashantpogde"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/endpoint/RegisterEndpointTask.java", "diffHunk": "@@ -54,23 +57,52 @@\n   private DatanodeDetails datanodeDetails;\n   private final OzoneContainer datanodeContainerManager;\n   private StateContext stateContext;\n+  private HDDSLayoutVersionManager layoutVersionManager;\n \n   /**\n    * Creates a register endpoint task.\n    *\n    * @param rpcEndPoint - endpoint\n    * @param conf - conf\n    * @param ozoneContainer - container\n+   * @param context - State context\n    */\n   @VisibleForTesting\n   public RegisterEndpointTask(EndpointStateMachine rpcEndPoint,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI1MjAyNw=="}, "originalCommit": {"oid": "579e95ff765567e6d5a7988fcf479b1ddcc9a98d"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MDI0MDczOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/DataNodeStorageConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNjo1MToxM1rOHVZ6Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNjo1MToxM1rOHVZ6Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIwNjYyMg==", "bodyText": "Nit. Can we return empty list here?", "url": "https://github.com/apache/ozone/pull/1432#discussion_r492206622", "createdAt": "2020-09-21T16:51:13Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/DataNodeStorageConfig.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.container.common;\n+\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos.NodeType;\n+import org.apache.hadoop.ozone.common.Storage;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.Properties;\n+\n+import static org.apache.hadoop.hdds.server.ServerUtils.getOzoneMetaDirPath;\n+import static org.apache.hadoop.ozone.OzoneConsts.DATANODE_STORAGE_CONFIG;\n+\n+/**\n+ * DataNodeStorageConfig is responsible for management of the\n+ * StorageDirectories used by the DataNode.\n+ */\n+public class DataNodeStorageConfig extends Storage {\n+\n+  /**\n+   * Construct DataNodeStorageConfig.\n+   * @throws IOException if any directories are inaccessible.\n+   */\n+  public DataNodeStorageConfig(OzoneConfiguration conf) throws IOException {\n+    super(NodeType.DATANODE, getOzoneMetaDirPath(conf),\n+        DATANODE_STORAGE_CONFIG);\n+  }\n+\n+  public DataNodeStorageConfig(NodeType type, File root, String sdName)\n+      throws IOException {\n+    super(type, root, sdName);\n+  }\n+\n+  @Override\n+  protected Properties getNodeProperties() {\n+    // No additional properties for now.\n+    return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1382acb19d90c5b29d43d245f669d9fb9dbd1bd7"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MDI2MTgzOnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/DataNodeStorageConfig.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNjo1NzowNFrOHVaHVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNjoxNToxNlrOHWX25g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxMDAwNg==", "bodyText": "There is already a Datanode Version file managed by the org.apache.hadoop.ozone.container.common.helpers.DatanodeVersionFile class. This is supposed to manage the clusterId, Datanode ID, layout version etc. If we create a new class to be passed into the Layout Version Manager, then we end up creating 2 Version files on disk for DN.", "url": "https://github.com/apache/ozone/pull/1432#discussion_r492210006", "createdAt": "2020-09-21T16:57:04Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/DataNodeStorageConfig.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.container.common;\n+\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos.NodeType;\n+import org.apache.hadoop.ozone.common.Storage;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.Properties;\n+\n+import static org.apache.hadoop.hdds.server.ServerUtils.getOzoneMetaDirPath;\n+import static org.apache.hadoop.ozone.OzoneConsts.DATANODE_STORAGE_CONFIG;\n+\n+/**\n+ * DataNodeStorageConfig is responsible for management of the\n+ * StorageDirectories used by the DataNode.\n+ */\n+public class DataNodeStorageConfig extends Storage {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1382acb19d90c5b29d43d245f669d9fb9dbd1bd7"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIyMTYwNg==", "bodyText": "Earlier I was thinking of refactoring that so that the mechanism is consistent across OM/SCM/Datanode.\nBut I will go ahead and used the DataNodeVersionFile for now.", "url": "https://github.com/apache/ozone/pull/1432#discussion_r493221606", "createdAt": "2020-09-23T06:15:16Z", "author": {"login": "prashantpogde"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/DataNodeStorageConfig.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.ozone.container.common;\n+\n+import org.apache.hadoop.hdds.conf.OzoneConfiguration;\n+import org.apache.hadoop.hdds.protocol.proto.HddsProtos.NodeType;\n+import org.apache.hadoop.ozone.common.Storage;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.Properties;\n+\n+import static org.apache.hadoop.hdds.server.ServerUtils.getOzoneMetaDirPath;\n+import static org.apache.hadoop.ozone.OzoneConsts.DATANODE_STORAGE_CONFIG;\n+\n+/**\n+ * DataNodeStorageConfig is responsible for management of the\n+ * StorageDirectories used by the DataNode.\n+ */\n+public class DataNodeStorageConfig extends Storage {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxMDAwNg=="}, "originalCommit": {"oid": "1382acb19d90c5b29d43d245f669d9fb9dbd1bd7"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MDI5OTc1OnYy", "diffSide": "RIGHT", "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/StorageContainerDatanodeProtocol.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNzowNzozNFrOHVae5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNjoxNToyN1rOHWX3Rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxNjAzOA==", "bodyText": "Why do we need to create a new 'register' method with Layout Version arg, without changing the existing method? We would always need a Layout Version during registering.", "url": "https://github.com/apache/ozone/pull/1432#discussion_r492216038", "createdAt": "2020-09-21T17:07:34Z", "author": {"login": "avijayanhwx"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/StorageContainerDatanodeProtocol.java", "diffHunk": "@@ -84,4 +86,19 @@ SCMRegisteredResponseProto register(\n           ContainerReportsProto containerReportsRequestProto,\n           PipelineReportsProto pipelineReports) throws IOException;\n \n+  /**\n+   * Register Datanode.\n+   * @param datanodeDetails - Datanode Details.\n+   * @param nodeReport - Node Report.\n+   * @param containerReportsRequestProto - Container Reports.\n+   * @param layoutInfo - Layout Version Information.\n+   * @return SCM Command.\n+   */\n+  SCMRegisteredResponseProto register(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1382acb19d90c5b29d43d245f669d9fb9dbd1bd7"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIyMTcwMg==", "bodyText": "yup. Done.", "url": "https://github.com/apache/ozone/pull/1432#discussion_r493221702", "createdAt": "2020-09-23T06:15:27Z", "author": {"login": "prashantpogde"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/protocol/StorageContainerDatanodeProtocol.java", "diffHunk": "@@ -84,4 +86,19 @@ SCMRegisteredResponseProto register(\n           ContainerReportsProto containerReportsRequestProto,\n           PipelineReportsProto pipelineReports) throws IOException;\n \n+  /**\n+   * Register Datanode.\n+   * @param datanodeDetails - Datanode Details.\n+   * @param nodeReport - Node Report.\n+   * @param containerReportsRequestProto - Container Reports.\n+   * @param layoutInfo - Layout Version Information.\n+   * @return SCM Command.\n+   */\n+  SCMRegisteredResponseProto register(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxNjAzOA=="}, "originalCommit": {"oid": "1382acb19d90c5b29d43d245f669d9fb9dbd1bd7"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4917, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}