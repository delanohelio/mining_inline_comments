{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4OTI2MzI3", "number": 507, "title": "HDDS-2936. Hive queries fail at readFully", "bodyText": "What changes were proposed in this pull request?\nIt fixes in the retry path of ozone client where length of data written was getting updated incorrectly while write in KeyouputStream.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-2936\nHow was this patch tested?\nThe existing test \"TestCloseContainerHandlingByClient\" was failing because the issue. All these tests are executing successfully with the fix. The patch also tested in a real deployment where HIve workload was run and all hive queries succeed now.", "createdAt": "2020-01-30T07:30:53Z", "url": "https://github.com/apache/ozone/pull/507", "merged": true, "mergeCommit": {"oid": "54c4adfb5fbf994607c07c3dcf840d0d3ab46e4e"}, "closed": true, "closedAt": "2020-02-10T23:43:47Z", "author": {"login": "bshashikant"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_aIP9AFqTM1MDgwMDMxOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDF77JAFqTM1NjM0NDkwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwODAwMzE5", "url": "https://github.com/apache/ozone/pull/507#pullrequestreview-350800319", "createdAt": "2020-01-30T12:55:34Z", "commit": {"oid": "dd753bcc4d6ce443e0687bec0990e791558bcb50"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMjo1NTozNFrOFjp58g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMjo1NzoxM1rOFjp9cA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjkzMTA1OA==", "bodyText": "writeLen, goes in both as an agrument as well as a return value to the function. Can we change this to something like expectedWritelen, and writtenLen", "url": "https://github.com/apache/ozone/pull/507#discussion_r372931058", "createdAt": "2020-01-30T12:55:34Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/KeyOutputStream.java", "diffHunk": "@@ -201,7 +209,11 @@ private void handleWrite(byte[] b, int off, long len, boolean retry)\n         // comes via Exception path.\n         int writeLen = Math.min((int) len, (int) current.getRemaining());\n         long currentPos = current.getWrittenDataLength();\n-        writeToOutputStream(current, retry, len, b, writeLen, off, currentPos);\n+        // writeLen will be updated based on whether the write was succeeded\n+        // or if it sees an exception, how much the actual write was\n+        // acknowledged.\n+        writeLen = writeToOutputStream(current, retry, len, b, writeLen,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd753bcc4d6ce443e0687bec0990e791558bcb50"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjkzMTk1Mg==", "bodyText": "Lets put\nisException &  throw new IOException(msg, exception); into one function. So that both of these are always updated together.", "url": "https://github.com/apache/ozone/pull/507#discussion_r372931952", "createdAt": "2020-01-30T12:57:13Z", "author": {"login": "mukul1987"}, "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/KeyOutputStream.java", "diffHunk": "@@ -356,6 +370,7 @@ private void handleRetry(IOException exception, long len) throws IOException {\n         msg = \"Retry request failed. \" + action.reason;\n         LOG.error(msg, exception);\n       }\n+      isException = true;\n       throw new IOException(msg, exception);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd753bcc4d6ce443e0687bec0990e791558bcb50"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwODgzNjY0", "url": "https://github.com/apache/ozone/pull/507#pullrequestreview-350883664", "createdAt": "2020-01-30T14:54:12Z", "commit": {"oid": "dd753bcc4d6ce443e0687bec0990e791558bcb50"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNDo1NDoxMlrOFjt1tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNDo1NDoxMlrOFjt1tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk5NTUxMA==", "bodyText": "At this point in the code I am not the fan of throwing an IllegalArgumentException, wouldn't it be better to keep this as an IOException with a specific explaining message?", "url": "https://github.com/apache/ozone/pull/507#discussion_r372995510", "createdAt": "2020-01-30T14:54:12Z", "author": {"login": "fapifta"}, "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/io/KeyOutputStream.java", "diffHunk": "@@ -484,6 +499,9 @@ public void close() throws IOException {\n     closed = true;\n     try {\n       handleFlushOrClose(StreamAction.CLOSE);\n+      if (!isException) {\n+        Preconditions.checkArgument(writeOffset == offset);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd753bcc4d6ce443e0687bec0990e791558bcb50"}, "originalPosition": 80}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "75f1ebafb51ce07e843222329304ac525f1b3f74", "author": {"user": {"login": "bshashikant", "name": null}}, "url": "https://github.com/apache/ozone/commit/75f1ebafb51ce07e843222329304ac525f1b3f74", "committedDate": "2020-01-31T10:27:20Z", "message": "Addressed checkstyle issues."}, "afterCommit": {"oid": "a967de23c0a2bffaef8be1827001315646ef928b", "author": {"user": {"login": "adoroszlai", "name": "Doroszlai, Attila"}}, "url": "https://github.com/apache/ozone/commit/a967de23c0a2bffaef8be1827001315646ef928b", "committedDate": "2020-01-31T09:03:02Z", "message": "HDDS-2833. Enable integrations tests for github actions\n\nCloses #416"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10f0715157c5c9f0709aca7abd620bb956a18a16", "author": {"user": {"login": "bshashikant", "name": null}}, "url": "https://github.com/apache/ozone/commit/10f0715157c5c9f0709aca7abd620bb956a18a16", "committedDate": "2020-01-31T12:21:01Z", "message": "Addressed review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MzQ0OTA3", "url": "https://github.com/apache/ozone/pull/507#pullrequestreview-356344907", "createdAt": "2020-02-10T23:42:50Z", "commit": {"oid": "10f0715157c5c9f0709aca7abd620bb956a18a16"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3792, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}