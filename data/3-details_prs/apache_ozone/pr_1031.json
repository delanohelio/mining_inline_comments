{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI5MDA1Mzk0", "number": 1031, "title": "HDDS-3745. Improve OM and SCM performance with 64% by avoid collect datanode information  to s3g", "bodyText": "What changes were proposed in this pull request?\nWhat's the problem ?\nI start a ozone cluster with 1000 datanodes and 10 s3gateway, and run two weeks with heavy workload, and perf om and scm.\n\nFrom om perf, getServiceList cost 63.75% cpu.\n\n\n2.From scm perf, queryNode come from om::getServiceList cost 33.20% cpu\n\nWhat's the reason ?\nNow s3g create a client for each request (we should improve it in the future). when create each RpcClient, s3g will call ozoneManagerClient.getServiceInfo(), getServiceInfo will call getServiceList.  getServiceList is a very heavy call, because it need to get DatanodeDetails of 1000 Datanodes, so om and scm are very busy with getServiceList.\nBut s3g does not use the List(ServiceInfo) which got from getServiceList at all.\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3745\nHow was this patch tested?\nExisted tests.", "createdAt": "2020-06-06T06:00:53Z", "url": "https://github.com/apache/ozone/pull/1031", "merged": true, "mergeCommit": {"oid": "3ca7f5c6c8bf167f0147bcd2a1e0c53a881c43d6"}, "closed": true, "closedAt": "2020-06-24T00:14:07Z", "author": {"login": "runzhiwang"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcog8SgABqjM0MTQyMzY1Njg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcrV6w0gH2gAyNDI5MDA1Mzk0OjEzZmI3NDJjYmJlM2E5YzUzNWVhMjg0Y2Y5NWI5MzkwNDRhOGM0MjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b89739ea1d9b80a70159badb14cc6b13913e6912", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/b89739ea1d9b80a70159badb14cc6b13913e6912", "committedDate": "2020-06-06T05:57:47Z", "message": "HDDS-3745. Improve OM and SCM performance with 50% by avoid call getServiceList in s3g"}, "afterCommit": {"oid": "5757fd14494105daa947cc530164a63b4c62cb6a", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/5757fd14494105daa947cc530164a63b4c62cb6a", "committedDate": "2020-06-06T06:06:36Z", "message": "HDDS-3745. Improve OM and SCM performance with 50% by avoid call getServiceList in s3g"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5757fd14494105daa947cc530164a63b4c62cb6a", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/5757fd14494105daa947cc530164a63b4c62cb6a", "committedDate": "2020-06-06T06:06:36Z", "message": "HDDS-3745. Improve OM and SCM performance with 50% by avoid call getServiceList in s3g"}, "afterCommit": {"oid": "5e11bb45bb0ecc7396bd8e217b8c3555b55623eb", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/5e11bb45bb0ecc7396bd8e217b8c3555b55623eb", "committedDate": "2020-06-06T07:13:55Z", "message": "HDDS-3745. Improve OM and SCM performance with 50% by avoid call getServiceList in s3g"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1ODk5ODY1", "url": "https://github.com/apache/ozone/pull/1031#pullrequestreview-425899865", "createdAt": "2020-06-08T03:45:10Z", "commit": {"oid": "5e11bb45bb0ecc7396bd8e217b8c3555b55623eb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwMzo0NToxMVrOGgObKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwMzo0NToxMVrOGgObKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQ0Mzk0NQ==", "bodyText": "how about\ncaCertPem = ozoneManagerClient.getCaCertificate();\n\nonly invoke when security is enabled.", "url": "https://github.com/apache/ozone/pull/1031#discussion_r436443945", "createdAt": "2020-06-08T03:45:11Z", "author": {"login": "GlenGeng"}, "path": "hadoop-ozone/client/src/main/java/org/apache/hadoop/ozone/client/rpc/RpcClient.java", "diffHunk": "@@ -170,10 +169,10 @@ public RpcClient(ConfigurationSource conf, String omServiceId)\n         OzoneManagerProtocol.class, conf\n     );\n     dtService = omTransport.getDelegationTokenService();\n-    ServiceInfoEx serviceInfoEx = ozoneManagerClient.getServiceInfo();\n+    String certificate = ozoneManagerClient.getCaCertificate();\n     String caCertPem = null;\n     if (OzoneSecurityUtil.isSecurityEnabled(conf)) {\n-      caCertPem = serviceInfoEx.getCaCertificate();\n+      caCertPem = certificate;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e11bb45bb0ecc7396bd8e217b8c3555b55623eb"}, "originalPosition": 17}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e11bb45bb0ecc7396bd8e217b8c3555b55623eb", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/5e11bb45bb0ecc7396bd8e217b8c3555b55623eb", "committedDate": "2020-06-06T07:13:55Z", "message": "HDDS-3745. Improve OM and SCM performance with 50% by avoid call getServiceList in s3g"}, "afterCommit": {"oid": "3325a78390d6cd1c600a21e503c699b639fac230", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/3325a78390d6cd1c600a21e503c699b639fac230", "committedDate": "2020-06-08T11:08:16Z", "message": "HDDS-3745. Improve OM and SCM performance with 64% by avoid call getServiceList in s3g"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e78b07bb66f094dc5dac5c0fbac86f57cdb03a7", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/5e78b07bb66f094dc5dac5c0fbac86f57cdb03a7", "committedDate": "2020-06-09T08:17:33Z", "message": "triger ci"}, "afterCommit": {"oid": "a002f5f03f58213e2fe714e7be1e7c6519061bb9", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/a002f5f03f58213e2fe714e7be1e7c6519061bb9", "committedDate": "2020-06-14T10:18:14Z", "message": "Improve OM and SCM performance with 64% by avoid collect datanode information to s3g"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a002f5f03f58213e2fe714e7be1e7c6519061bb9", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/a002f5f03f58213e2fe714e7be1e7c6519061bb9", "committedDate": "2020-06-14T10:18:14Z", "message": "Improve OM and SCM performance with 64% by avoid collect datanode information to s3g"}, "afterCommit": {"oid": "636e6d5249b7133fa4fd619bae1d482e246262a8", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/636e6d5249b7133fa4fd619bae1d482e246262a8", "committedDate": "2020-06-14T10:58:37Z", "message": "Improve OM and SCM performance with 64% by avoid collect datanode information to s3g"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f7963c4a74b048708c91b83e7b6663ff21683bf5", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/f7963c4a74b048708c91b83e7b6663ff21683bf5", "committedDate": "2020-06-14T12:16:08Z", "message": "triger ci"}, "afterCommit": {"oid": "f333972f188b41b5315dbb120bf0a46882a62ccb", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/f333972f188b41b5315dbb120bf0a46882a62ccb", "committedDate": "2020-06-15T00:02:14Z", "message": "Improve OM and SCM performance with 64% by avoid collect datanode information to s3g"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f333972f188b41b5315dbb120bf0a46882a62ccb", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/f333972f188b41b5315dbb120bf0a46882a62ccb", "committedDate": "2020-06-15T00:02:14Z", "message": "Improve OM and SCM performance with 64% by avoid collect datanode information to s3g"}, "afterCommit": {"oid": "13fb742cbbe3a9c535ea284cf95b939044a8c424", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/13fb742cbbe3a9c535ea284cf95b939044a8c424", "committedDate": "2020-06-15T00:57:01Z", "message": "Improve OM and SCM performance with 64% by avoid collect datanode information to s3g"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13fb742cbbe3a9c535ea284cf95b939044a8c424", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/13fb742cbbe3a9c535ea284cf95b939044a8c424", "committedDate": "2020-06-15T00:57:01Z", "message": "Improve OM and SCM performance with 64% by avoid collect datanode information to s3g"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3152, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}