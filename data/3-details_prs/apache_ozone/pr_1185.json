{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3MjE3Njgy", "number": 1185, "title": "HDDS-3933. Fix memory leak because of too many Datanode State Machine Thread", "bodyText": "What changes were proposed in this pull request?\nWhat's problem ?\nDatanode creates more than 20K Datanode State Machine Thread, then OOM happened.\n\nWhat's the reason ?\n20K Datanode State Machine Thread were created by newCachedThreadPool\n\nAlmost all of them were wait lock.\n\nOnly one Datanode State Machine Thread got the lock, and block when submitRequest. Because this thread was blocked and can not free the lock, newCachedThreadPool will create new thread infinitely.\n\nHow to fix ?\n\nAvoid use newCachedThreadPool, because it will create new thread infinitely, if no thread available in pool.\nCancel future when task time out.\nBesides there is bug in such following code which want to loop until timeout or returned >= count.\nBut timeout can not work, for example when init startTime = 0 and timeLeft = 100, if monotonicNow = 10, timeLeft = 100 - (10 - 0) = 90, and then if monotonicNow = 11, timeLeft = 90 - (11 - 0) = 79 which actually should be 89.\n\n while (returned < count && timeLeft > 0) {\n    timeLeft = timeLeft - (Time.monotonicNow() - startTime);\n }\n\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-3933\nHow was this patch tested?\nExisted UT.", "createdAt": "2020-07-10T04:33:53Z", "url": "https://github.com/apache/ozone/pull/1185", "merged": true, "mergeCommit": {"oid": "ff7b5a3367eccc0969bfd92a2cafe48899a2aaa5"}, "closed": true, "closedAt": "2020-07-22T12:40:04Z", "author": {"login": "runzhiwang"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0tU4mgBqjM1NDIyNzQxOTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3WpMCgH2gAyNDQ3MjE3NjgyOmY0ZjM0NTIzZTNjZDI1Y2U4MTI5N2VkM2JmNDc5YTE2ZTQ5ZmNmNjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bca90af691ebc07350f832389d25d5a511407686", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/bca90af691ebc07350f832389d25d5a511407686", "committedDate": "2020-07-14T01:54:41Z", "message": "1"}, "afterCommit": {"oid": "2d15f95a64181e04300518db3046ebf0bcf70387", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/2d15f95a64181e04300518db3046ebf0bcf70387", "committedDate": "2020-07-14T03:18:03Z", "message": "HDDS-3933. Fix memory leak because of too many Datanode State Machine Thread"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3ODk3OTA1", "url": "https://github.com/apache/ozone/pull/1185#pullrequestreview-447897905", "createdAt": "2020-07-14T08:29:27Z", "commit": {"oid": "2d15f95a64181e04300518db3046ebf0bcf70387"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwODoyOToyN1rOGxJqrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwODozMDo0NlrOGxJtow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE5MTc5MA==", "bodyText": "Can we add more details about what's the proper value for this proerpty if user want to change it?", "url": "https://github.com/apache/ozone/pull/1185#discussion_r454191790", "createdAt": "2020-07-14T08:29:27Z", "author": {"login": "ChenSammi"}, "path": "hadoop-hdds/common/src/main/resources/ozone-default.xml", "diffHunk": "@@ -268,6 +268,13 @@\n       datanode periodically send node report to SCM. Unit could be\n       defined with postfix (ns,ms,s,m,h,d)</description>\n   </property>\n+  <property>\n+    <name>hdds.statemachine.endpoint.task.thread.count</name>\n+    <value>2</value>\n+    <tag>OZONE, DATANODE, MANAGEMENT</tag>\n+    <description>Maximum number of threads in the thread pool that Datanode\n+      will use for GETVERSION, REGISTER, HEARTBEAT to SCMs.</description>\n+  </property>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d15f95a64181e04300518db3046ebf0bcf70387"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE5MjU0Nw==", "bodyText": "Instead of cancel the future, I would suggest to skip the next time execution, and let the current future finish it.  Also, please add LOG if this case happens.", "url": "https://github.com/apache/ozone/pull/1185#discussion_r454192547", "createdAt": "2020-07-14T08:30:46Z", "author": {"login": "ChenSammi"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/states/datanode/RunningDatanodeState.java", "diffHunk": "@@ -200,22 +203,31 @@ public void execute(ExecutorService executor) {\n   @Override\n   public DatanodeStateMachine.DatanodeStates\n       await(long duration, TimeUnit timeUnit)\n-      throws InterruptedException, ExecutionException, TimeoutException {\n+      throws InterruptedException {\n     int count = connectionManager.getValues().size();\n     int returned = 0;\n-    long timeLeft = timeUnit.toMillis(duration);\n+    long durationMS = timeUnit.toMillis(duration);\n     long startTime = Time.monotonicNow();\n-    List<Future<EndPointStates>> results = new LinkedList<>();\n-\n-    while (returned < count && timeLeft > 0) {\n-      Future<EndPointStates> result =\n-          ecs.poll(timeLeft, TimeUnit.MILLISECONDS);\n-      if (result != null) {\n-        results.add(result);\n-        returned++;\n+    Set<Future<EndPointStates>> results = new HashSet<>();\n+\n+    while (returned < count\n+        && (durationMS - (Time.monotonicNow() - startTime))> 0) {\n+      for (Future<EndPointStates> future : futures) {\n+        if (future != null && future.isDone() && !results.contains(future)) {\n+          results.add(future);\n+          returned++;\n+        }\n       }\n-      timeLeft = timeLeft - (Time.monotonicNow() - startTime);\n+\n+      Thread.sleep(durationMS / 10);\n     }\n+\n+    for (Future<EndPointStates> future : futures) {\n+      if (future != null && !future.isDone()) {\n+        future.cancel(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d15f95a64181e04300518db3046ebf0bcf70387"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "013f5f6648328b258c4ede54ecd2e354660a985c", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/013f5f6648328b258c4ede54ecd2e354660a985c", "committedDate": "2020-07-15T08:55:02Z", "message": "HDDS-3933. Fix memory leak because of too many Datanode State Machine Thread"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24091491f0808f51464f5a253ca8ffb6acf280f4", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/24091491f0808f51464f5a253ca8ffb6acf280f4", "committedDate": "2020-07-15T08:56:01Z", "message": "fix code review"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d15f95a64181e04300518db3046ebf0bcf70387", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/2d15f95a64181e04300518db3046ebf0bcf70387", "committedDate": "2020-07-14T03:18:03Z", "message": "HDDS-3933. Fix memory leak because of too many Datanode State Machine Thread"}, "afterCommit": {"oid": "24091491f0808f51464f5a253ca8ffb6acf280f4", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/24091491f0808f51464f5a253ca8ffb6acf280f4", "committedDate": "2020-07-15T08:56:01Z", "message": "fix code review"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ba75a24782ad8bf88ed5a7002ba1cc4234108f7b", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/ba75a24782ad8bf88ed5a7002ba1cc4234108f7b", "committedDate": "2020-07-15T11:14:14Z", "message": "triger ci"}, "afterCommit": {"oid": "24091491f0808f51464f5a253ca8ffb6acf280f4", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/24091491f0808f51464f5a253ca8ffb6acf280f4", "committedDate": "2020-07-15T08:56:01Z", "message": "fix code review"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8381d73d410bb0504272379b08f0b38d2daec51e", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/8381d73d410bb0504272379b08f0b38d2daec51e", "committedDate": "2020-07-15T23:42:49Z", "message": "triger ci"}, "afterCommit": {"oid": "24091491f0808f51464f5a253ca8ffb6acf280f4", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/24091491f0808f51464f5a253ca8ffb6acf280f4", "committedDate": "2020-07-15T08:56:01Z", "message": "fix code review"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "23e126325f2011537c0841acfb5f8f4344fa9501", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/23e126325f2011537c0841acfb5f8f4344fa9501", "committedDate": "2020-07-16T03:27:38Z", "message": "triger ci"}, "afterCommit": {"oid": "24091491f0808f51464f5a253ca8ffb6acf280f4", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/24091491f0808f51464f5a253ca8ffb6acf280f4", "committedDate": "2020-07-15T08:56:01Z", "message": "fix code review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ff1d5299c2c44cb0790ecde0112336ef7028fe8", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/9ff1d5299c2c44cb0790ecde0112336ef7028fe8", "committedDate": "2020-07-16T23:54:37Z", "message": "triger ci"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMzAyNjYw", "url": "https://github.com/apache/ozone/pull/1185#pullrequestreview-450302660", "createdAt": "2020-07-17T00:35:31Z", "commit": {"oid": "9ff1d5299c2c44cb0790ecde0112336ef7028fe8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMDozNTozMVrOGzBY3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwMDozNTozMVrOGzBY3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjE1MzMxMA==", "bodyText": "In a similar case of endpoint task locked up, will we end up with flooding of warning logs here?", "url": "https://github.com/apache/ozone/pull/1185#discussion_r456153310", "createdAt": "2020-07-17T00:35:31Z", "author": {"login": "xiaoyuyao"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/StateContext.java", "diffHunk": "@@ -415,7 +431,14 @@ public void execute(ExecutorService service, long time, TimeUnit unit)\n       if (this.isEntering()) {\n         task.onEnter();\n       }\n-      task.execute(service);\n+\n+      if (isThreadPoolAvailable(service)) {\n+        task.execute(service);\n+      } else {\n+        LOG.warn(\"No available thread in pool, duration:\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ff1d5299c2c44cb0790ecde0112336ef7028fe8"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMzA0NDc2", "url": "https://github.com/apache/ozone/pull/1185#pullrequestreview-450304476", "createdAt": "2020-07-17T00:42:07Z", "commit": {"oid": "9ff1d5299c2c44cb0790ecde0112336ef7028fe8"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c381fa32eed28861e3c7970eebe6663199c4b66", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/2c381fa32eed28861e3c7970eebe6663199c4b66", "committedDate": "2020-07-20T03:06:43Z", "message": "log with interval"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMDI1MjEw", "url": "https://github.com/apache/ozone/pull/1185#pullrequestreview-453025210", "createdAt": "2020-07-22T06:22:49Z", "commit": {"oid": "2c381fa32eed28861e3c7970eebe6663199c4b66"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNjoyMjo0OVrOG1UViA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNjoyMjo0OVrOG1UViA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU2MDkwNA==", "bodyText": "Can we switch theset two statement?", "url": "https://github.com/apache/ozone/pull/1185#discussion_r458560904", "createdAt": "2020-07-22T06:22:49Z", "author": {"login": "ChenSammi"}, "path": "hadoop-hdds/container-service/src/main/java/org/apache/hadoop/ozone/container/common/statemachine/StateContext.java", "diffHunk": "@@ -434,9 +438,14 @@ public void execute(ExecutorService service, long time, TimeUnit unit)\n \n       if (isThreadPoolAvailable(service)) {\n         task.execute(service);\n+        threadPoolNotAvailableCount.set(0);\n       } else {\n-        LOG.warn(\"No available thread in pool, duration:\" +\n-            unit.toMillis(time));\n+        threadPoolNotAvailableCount.incrementAndGet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c381fa32eed28861e3c7970eebe6663199c4b66"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d9b1064c5dd263fb250d4cfc0a23aaa4c7afc9d", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/0d9b1064c5dd263fb250d4cfc0a23aaa4c7afc9d", "committedDate": "2020-07-22T06:48:58Z", "message": "fix code review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "717040e6179946fc126d25cd491d3fc23aec0b92", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/717040e6179946fc126d25cd491d3fc23aec0b92", "committedDate": "2020-07-22T08:29:22Z", "message": "fix code review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4f34523e3cd25ce81297ed3bf479a16e49fcf67", "author": {"user": {"login": "runzhiwang", "name": null}}, "url": "https://github.com/apache/ozone/commit/f4f34523e3cd25ce81297ed3bf479a16e49fcf67", "committedDate": "2020-07-22T08:34:49Z", "message": "fix code review"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2832, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}