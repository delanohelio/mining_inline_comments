{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzMzI4MDc4", "number": 1498, "title": "HDDS-4339. Allow AWSSignatureProcessor init when aws signature is absent.", "bodyText": "What changes were proposed in this pull request?\nSkip aws signature retrieval in AWSSignatureProcessor. It was causing NPE when signature is absent in header.\n(Please fill in changes proposed in this fix)\nWhat is the link to the Apache JIRA\nhttps://issues.apache.org/jira/browse/HDDS-4339\n(Please create an issue in ASF JIRA before opening a pull request,\nand you need to set the title of the pull request which starts with\nthe corresponding JIRA issue number. (e.g. HDDS-XXXX. Fix a typo in YYY.)\nPlease replace this section with the link to the Apache JIRA)\nHow was this patch tested?\nUT\n(Please explain how this patch was tested. Ex: unit tests, manual tests)\n(If this patch involves UI changes, please attach a screen-shot; otherwise, remove this)", "createdAt": "2020-10-14T12:11:55Z", "url": "https://github.com/apache/ozone/pull/1498", "merged": true, "mergeCommit": {"oid": "e800303e2dd5acac46bb133dcaa0c8f59936fa0f"}, "closed": true, "closedAt": "2020-11-03T04:34:15Z", "author": {"login": "timmylicheng"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSuRf0gBqjM4ODA0OTA3MDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYuaRmgBqjM5NTA2OTAxODg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b4740b5d6762fef6f6f6c53603e55de54bb07a5b", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/b4740b5d6762fef6f6f6c53603e55de54bb07a5b", "committedDate": "2020-10-14T12:04:19Z", "message": "HDDS-4339. Skip aws signature when it's absent in header."}, "afterCommit": {"oid": "d12bdf68fd5a86164f2b23ec47a6030d26b0ed67", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/d12bdf68fd5a86164f2b23ec47a6030d26b0ed67", "committedDate": "2020-10-15T09:22:22Z", "message": "HDDS-4339. Skip aws signature when it's absent in header."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d12bdf68fd5a86164f2b23ec47a6030d26b0ed67", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/d12bdf68fd5a86164f2b23ec47a6030d26b0ed67", "committedDate": "2020-10-15T09:22:22Z", "message": "HDDS-4339. Skip aws signature when it's absent in header."}, "afterCommit": {"oid": "07fd22f08007c0e4dd276e9b78b0f6be87a4a4cf", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/07fd22f08007c0e4dd276e9b78b0f6be87a4a4cf", "committedDate": "2020-10-15T09:59:08Z", "message": "HDDS-4339. Skip aws signature when it's absent in header."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExMzU0OTMz", "url": "https://github.com/apache/ozone/pull/1498#pullrequestreview-511354933", "createdAt": "2020-10-19T00:45:56Z", "commit": {"oid": "07fd22f08007c0e4dd276e9b78b0f6be87a4a4cf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwMDo0NTo1NlrOHjyuvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwMDo0NTo1NlrOHjyuvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzI5MzM3Mg==", "bodyText": "#1110 (comment)\nWhen S3 misses the auth header error returned is AuthorizationHeaderMalformedHeader. Refer for more info the above comment link.\nQuestion: After this fix, will it show this error when the auth header is missing or it will be just logged in S3G logs?", "url": "https://github.com/apache/ozone/pull/1498#discussion_r507293372", "createdAt": "2020-10-19T00:45:56Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java", "diffHunk": "@@ -116,6 +116,13 @@ private OzoneClient getClient(OzoneConfiguration config) throws IOException {\n     }\n   }\n \n+  // ONLY validate aws access id when needed.\n+  private void validateAccessId(String awsAccessId) throws Exception {\n+    if (awsAccessId == null || awsAccessId.equals(\"\")) {\n+      throw S3_AUTHINFO_CREATION_ERROR;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07fd22f08007c0e4dd276e9b78b0f6be87a4a4cf"}, "originalPosition": 16}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1face8c05b3b47a131dbfb7cbe698e869f9446c4", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/1face8c05b3b47a131dbfb7cbe698e869f9446c4", "committedDate": "2020-10-20T03:19:13Z", "message": "Use MALFORMED_HEADER as exception."}, "afterCommit": {"oid": "e51118a199de5885d4494fc6a4098dce22c34cab", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/e51118a199de5885d4494fc6a4098dce22c34cab", "committedDate": "2020-10-20T06:14:52Z", "message": "Use MALFORMED_HEADER as exception."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MzA3NzQ5", "url": "https://github.com/apache/ozone/pull/1498#pullrequestreview-518307749", "createdAt": "2020-10-28T03:58:57Z", "commit": {"oid": "e51118a199de5885d4494fc6a4098dce22c34cab"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwMzo1ODo1OFrOHpZL6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwMzo1ODo1OFrOHpZL6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE2NjMxMw==", "bodyText": "This will throw NPE when awsAccessId is null, do we need to move validateAccessId before remoteUser creation.", "url": "https://github.com/apache/ozone/pull/1498#discussion_r513166313", "createdAt": "2020-10-28T03:58:58Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/OzoneClientProducer.java", "diffHunk": "@@ -80,9 +81,15 @@ private OzoneClient getClient(OzoneConfiguration config) throws IOException {\n       UserGroupInformation remoteUser =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e51118a199de5885d4494fc6a4098dce22c34cab"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMzY1NDEx", "url": "https://github.com/apache/ozone/pull/1498#pullrequestreview-520365411", "createdAt": "2020-10-30T04:10:48Z", "commit": {"oid": "098cdef90e7e0dc6d2885048b52bf3a29ab5b1bf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNDoxMDo0OFrOHq-IFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNDoxMDo0OFrOHq-IFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDgyMDExOQ==", "bodyText": "Minor NIT: do we still need this precondition check.\nSorry missed it earlier?", "url": "https://github.com/apache/ozone/pull/1498#discussion_r514820119", "createdAt": "2020-10-30T04:10:48Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/AWSSignatureProcessor.java", "diffHunk": "@@ -108,23 +109,29 @@ public void init()\n \n     this.method = context.getMethod();\n     String authHeader = headers.get(AUTHORIZATION_HEADER);\n-    String[] split = authHeader.split(\" \");\n-    if (split[0].equals(AuthorizationHeaderV2.IDENTIFIER)) {\n-      if (v2Header == null) {\n-        v2Header = new AuthorizationHeaderV2(authHeader);\n-      }\n-    } else {\n-      if (v4Header == null) {\n-        v4Header = new AuthorizationHeaderV4(authHeader);\n+    if (authHeader != null) {\n+      String[] split = authHeader.split(\" \");\n+      if (split[0].equals(AuthorizationHeaderV2.IDENTIFIER)) {\n+        if (v2Header == null) {\n+          v2Header = new AuthorizationHeaderV2(authHeader);\n+        }\n+      } else {\n+        if (v4Header == null) {\n+          v4Header = new AuthorizationHeaderV4(authHeader);\n+        }\n+        parse();\n       }\n-      parse();\n+    } else { // no auth header\n+      v4Header = null;\n+      v2Header = null;\n     }\n   }\n \n \n-  public void parse() throws Exception {\n-    StringBuilder strToSign = new StringBuilder();\n+  private void parse() throws Exception {\n+    Preconditions.checkNotNull(v4Header);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "098cdef90e7e0dc6d2885048b52bf3a29ab5b1bf"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMzY1NjQw", "url": "https://github.com/apache/ozone/pull/1498#pullrequestreview-520365640", "createdAt": "2020-10-30T04:11:39Z", "commit": {"oid": "098cdef90e7e0dc6d2885048b52bf3a29ab5b1bf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNDoxMTozOVrOHq-LsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNDoxMTozOVrOHq-LsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDgyMTA0MA==", "bodyText": "Minor NIT: do we still need this precondition check.\nSame here.", "url": "https://github.com/apache/ozone/pull/1498#discussion_r514821040", "createdAt": "2020-10-30T04:11:39Z", "author": {"login": "bharatviswa504"}, "path": "hadoop-ozone/s3gateway/src/main/java/org/apache/hadoop/ozone/s3/AWSSignatureProcessor.java", "diffHunk": "@@ -167,7 +174,9 @@ public void parse() throws Exception {\n   }\n \n   @VisibleForTesting\n-  public String buildCanonicalRequest() throws OS3Exception {\n+  protected String buildCanonicalRequest() throws OS3Exception {\n+    Preconditions.checkNotNull(v4Header);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "098cdef90e7e0dc6d2885048b52bf3a29ab5b1bf"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMzY1Nzc1", "url": "https://github.com/apache/ozone/pull/1498#pullrequestreview-520365775", "createdAt": "2020-10-30T04:12:13Z", "commit": {"oid": "098cdef90e7e0dc6d2885048b52bf3a29ab5b1bf"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxOTUxNzEy", "url": "https://github.com/apache/ozone/pull/1498#pullrequestreview-521951712", "createdAt": "2020-11-02T19:59:58Z", "commit": {"oid": "f47cb7e34e4af8bd2967332fcc34fa9647bb1c9e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8cc0aa52c12c30ed2369797a73e7fb36eb5bb29", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/c8cc0aa52c12c30ed2369797a73e7fb36eb5bb29", "committedDate": "2020-11-02T23:27:53Z", "message": "HDDS-4339. Skip aws signature when it's absent in header."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "644f9e7d50c3cb4b279e82fbbe588079dce84aab", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/644f9e7d50c3cb4b279e82fbbe588079dce84aab", "committedDate": "2020-11-02T23:27:53Z", "message": "Use MALFORMED_HEADER as exception."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f2562f77b0f3b8bc057cbbdc5c30f7aa11cb027", "author": {"user": {"login": "timmylicheng", "name": "Li Cheng"}}, "url": "https://github.com/apache/ozone/commit/4f2562f77b0f3b8bc057cbbdc5c30f7aa11cb027", "committedDate": "2020-11-02T23:27:54Z", "message": "Validate accessID earlier."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8699d2fe1f5edd99c1ab90535933d550170015c", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/e8699d2fe1f5edd99c1ab90535933d550170015c", "committedDate": "2020-11-02T23:27:54Z", "message": "S3G unauthorized client able to access"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f47cb7e34e4af8bd2967332fcc34fa9647bb1c9e", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/f47cb7e34e4af8bd2967332fcc34fa9647bb1c9e", "committedDate": "2020-10-30T23:24:08Z", "message": "S3G unauthorized client able to access"}, "afterCommit": {"oid": "7b26fb85e042f85fd443c9cd450459c8364583ee", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/7b26fb85e042f85fd443c9cd450459c8364583ee", "committedDate": "2020-11-03T00:39:19Z", "message": "fix test and also handle error of creation of signature processor\""}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7b26fb85e042f85fd443c9cd450459c8364583ee", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/7b26fb85e042f85fd443c9cd450459c8364583ee", "committedDate": "2020-11-03T00:39:19Z", "message": "fix test and also handle error of creation of signature processor\""}, "afterCommit": {"oid": "46a74a6d1aad7abaacded68382ad7f7d4a4f8fda", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/46a74a6d1aad7abaacded68382ad7f7d4a4f8fda", "committedDate": "2020-11-03T00:40:46Z", "message": "fix test and also handle error of creation of signature processor\""}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "46a74a6d1aad7abaacded68382ad7f7d4a4f8fda", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/46a74a6d1aad7abaacded68382ad7f7d4a4f8fda", "committedDate": "2020-11-03T00:40:46Z", "message": "fix test and also handle error of creation of signature processor\""}, "afterCommit": {"oid": "6f600ca6f5c69a8d0af12ff95fa28c65d347d659", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/6f600ca6f5c69a8d0af12ff95fa28c65d347d659", "committedDate": "2020-11-03T00:52:15Z", "message": "fix test and also handle error of creation of signature processor\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1693bad8c495048b3d24158266fbd138e66a31e", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/b1693bad8c495048b3d24158266fbd138e66a31e", "committedDate": "2020-11-03T00:55:37Z", "message": "fix test and also handle error of creation of signature processor\""}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f600ca6f5c69a8d0af12ff95fa28c65d347d659", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/6f600ca6f5c69a8d0af12ff95fa28c65d347d659", "committedDate": "2020-11-03T00:52:15Z", "message": "fix test and also handle error of creation of signature processor\""}, "afterCommit": {"oid": "b1693bad8c495048b3d24158266fbd138e66a31e", "author": {"user": {"login": "bharatviswa504", "name": "Bharat Viswanadham"}}, "url": "https://github.com/apache/ozone/commit/b1693bad8c495048b3d24158266fbd138e66a31e", "committedDate": "2020-11-03T00:55:37Z", "message": "fix test and also handle error of creation of signature processor\""}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2384, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}