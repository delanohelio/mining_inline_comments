{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzMTM3Mjg0", "number": 427, "title": "Ccs 3768", "bodyText": "non ascii character text is getting corrupted on preview of the module\"", "createdAt": "2020-09-25T15:07:06Z", "url": "https://github.com/redhataccess/pantheon/pull/427", "merged": true, "mergeCommit": {"oid": "8a747ee382401e84006a7ed9f4d814ffce878794"}, "closed": true, "closedAt": "2020-10-08T04:29:45Z", "author": {"login": "rednitish"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNk_YqAFqTQ5ODI5NDIzMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQPfgogFqTUwNDA1NTk5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4Mjk0MjMw", "url": "https://github.com/redhataccess/pantheon/pull/427#pullrequestreview-498294230", "createdAt": "2020-09-29T09:44:03Z", "commit": {"oid": "0f362a7ca25ec037710eb45bfb539da50a47f5a3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQwOTo0NDowNFrOHZlEdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQwOTo0NDowNFrOHZlEdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU4Mzc5Nw==", "bodyText": "This test can be used for utf-8 testing.", "url": "https://github.com/redhataccess/pantheon/pull/427#discussion_r496583797", "createdAt": "2020-09-29T09:44:04Z", "author": {"login": "aprajshekhar"}, "path": "pantheon-bundle/src/test/java/com/redhat/pantheon/servlet/module/ModuleVersionUploadTest.java", "diffHunk": "@@ -87,57 +87,6 @@ void createFirstVersion() throws Exception {\n         );\n         verify(asciidoctorService).getDocumentHtml(any(Module.class), any(Locale.class), anyString(), eq(true), anyMap(), eq(true));\n     }\n-\n-    @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f362a7ca25ec037710eb45bfb539da50a47f5a3"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMzQxMjc5", "url": "https://github.com/redhataccess/pantheon/pull/427#pullrequestreview-500341279", "createdAt": "2020-10-01T13:23:34Z", "commit": {"oid": "8bebb1c41b93a7383bcf57a35a55c7fd775d29db"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxMzoyMzozNFrOHbKLVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxMzozMjowOVrOHbKkEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI0MDM0Mw==", "bodyText": "@rednitish I'm worried that we're breaking support for non-UTF-8 encodings by doing this. Can you share your thought process behind this change?", "url": "https://github.com/redhataccess/pantheon/pull/427#discussion_r498240343", "createdAt": "2020-10-01T13:23:34Z", "author": {"login": "benradey"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/assembly/AssemblyVersionUpload.java", "diffHunk": "@@ -62,10 +62,7 @@ protected void doRun(SlingHttpServletRequest request, PostResponse response, Lis\n             String locale = ServletUtils.paramValue(request, \"locale\", GlobalConfig.DEFAULT_MODULE_LOCALE.toString());\n //            String contentType = ServletUtils.paramValue(request, \"type\", \"assembly\");\n \n-            String encoding = request.getCharacterEncoding();\n-            if (encoding == null) {\n-                encoding = StandardCharsets.UTF_8.name();\n-            }\n+            String encoding = StandardCharsets.UTF_8.name();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bebb1c41b93a7383bcf57a35a55c7fd775d29db"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI0MDUyMQ==", "bodyText": "(same comment as above)", "url": "https://github.com/redhataccess/pantheon/pull/427#discussion_r498240521", "createdAt": "2020-10-01T13:23:49Z", "author": {"login": "benradey"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/module/ModuleVersionUpload.java", "diffHunk": "@@ -73,10 +73,7 @@ protected void doRun(SlingHttpServletRequest request, PostResponse response, Lis\n \n         try {\n             String locale = ServletUtils.paramValue(request, \"locale\", GlobalConfig.DEFAULT_MODULE_LOCALE.toString());\n-            String encoding = request.getCharacterEncoding();\n-            if (encoding == null) {\n-                encoding = StandardCharsets.UTF_8.name();\n-            }\n+            String encoding = StandardCharsets.UTF_8.name();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bebb1c41b93a7383bcf57a35a55c7fd775d29db"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI0MzIzMA==", "bodyText": "Echoing my previous concern - it's nice that we have a test to confirm that UTF-8 works, but we should also have tests to make sure that other encodings work as well. It seems like with these changes, we're forcing all uploads to use UTF-8 and I don't think that's the correct design decision for the system.", "url": "https://github.com/redhataccess/pantheon/pull/427#discussion_r498243230", "createdAt": "2020-10-01T13:27:29Z", "author": {"login": "benradey"}, "path": "pantheon-bundle/src/test/java/com/redhat/pantheon/servlet/module/ModuleVersionUploadTest.java", "diffHunk": "@@ -105,10 +105,10 @@ void createFirstVersionUnicodeIso() throws Exception {\n         ModuleVersionUpload upload = new ModuleVersionUpload(asciidoctorService);\n         Map<String, Object> params = newHashMap();\n         params.put(\"locale\", Locale.SIMPLIFIED_CHINESE.toString());\n-        params.put(\"asciidoc\", \"\u00e5\\u008D\\u0097\u00e4\u00ba\u00ac\u00e9\\u0098\u00b2\u00e7\\u0096\u00ab\u00e7\\u008E\u00b0\u00e5\\u009C\u00ba\");\n+        params.put(\"asciidoc\", \"d'agua per toles partes, por exemplu: Sicilia y Cuba; al otrud\u00eda  decat\u00e1ronse  d'\u00fa  ven\u00eden  les  voces:  de  dientro  la  casa;  nun  foi  aaguantar aquel perru: vendi\u00f3lu.\");\n         slingContext.request().setParameterMap(params);\n         slingContext.request().setResource(new NonExistingResource(slingContext.resourceResolver(), \"/content/repositories/test_workspace/entities/new/proc_module\"));\n-        slingContext.request().setCharacterEncoding(StandardCharsets.ISO_8859_1.toString());\n+        slingContext.request().setCharacterEncoding(StandardCharsets.UTF_8.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bebb1c41b93a7383bcf57a35a55c7fd775d29db"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI0NjY3NQ==", "bodyText": "@xdavidson - although I agree with you when you say \"authors don't write their content as \u00e5\\u008D\\u0097\u00e4\u00ba\u00ac\u00e9\\u0098\u00b2\u00e7\\u0096\u00ab\u00e7\\u008E\u00b0\u00e5\\u009C\u00ba\" - I do think that it is appropriate to test using that format. The reason is that from the author's perspective, they will write \"\u5357\u4eac\u9632\u75ab\u73b0\u573a\" in their document, BUT as we have seen in the past, it's quite possible that those characters will be sent using the wrong encoding and the string will get mangled. We need to be sure that sling will unmangle the content correctly, which is the rationale for structuring the test the way it was.\nI think that by rewriting the test the way that it is proposed in this PR, we are weakening our assurance that the system handles such scenarios correctly.", "url": "https://github.com/redhataccess/pantheon/pull/427#discussion_r498246675", "createdAt": "2020-10-01T13:32:09Z", "author": {"login": "benradey"}, "path": "pantheon-bundle/src/test/java/com/redhat/pantheon/servlet/module/ModuleVersionUploadTest.java", "diffHunk": "@@ -87,57 +87,6 @@ void createFirstVersion() throws Exception {\n         );\n         verify(asciidoctorService).getDocumentHtml(any(Module.class), any(Locale.class), anyString(), eq(true), anyMap(), eq(true));\n     }\n-\n-    @Test", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU4Mzc5Nw=="}, "originalCommit": {"oid": "0f362a7ca25ec037710eb45bfb539da50a47f5a3"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMjg0MTM1", "url": "https://github.com/redhataccess/pantheon/pull/427#pullrequestreview-501284135", "createdAt": "2020-10-02T16:35:11Z", "commit": {"oid": "8bebb1c41b93a7383bcf57a35a55c7fd775d29db"}, "state": "DISMISSED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNjozNToxMVrOHb0L6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNjozNzozM1rOHb0Q4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyODYxNg==", "bodyText": "@rednitish Please remove the encoding variable completely and all subsequent references to it.", "url": "https://github.com/redhataccess/pantheon/pull/427#discussion_r498928616", "createdAt": "2020-10-02T16:35:11Z", "author": {"login": "benradey"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/assembly/AssemblyVersionUpload.java", "diffHunk": "@@ -62,10 +62,7 @@ protected void doRun(SlingHttpServletRequest request, PostResponse response, Lis\n             String locale = ServletUtils.paramValue(request, \"locale\", GlobalConfig.DEFAULT_MODULE_LOCALE.toString());\n //            String contentType = ServletUtils.paramValue(request, \"type\", \"assembly\");\n \n-            String encoding = request.getCharacterEncoding();\n-            if (encoding == null) {\n-                encoding = StandardCharsets.UTF_8.name();\n-            }\n+            String encoding = StandardCharsets.UTF_8.name();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI0MDM0Mw=="}, "originalCommit": {"oid": "8bebb1c41b93a7383bcf57a35a55c7fd775d29db"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyODkxNQ==", "bodyText": "@rednitish Same, please remove this variable and all subsequent references.", "url": "https://github.com/redhataccess/pantheon/pull/427#discussion_r498928915", "createdAt": "2020-10-02T16:35:36Z", "author": {"login": "benradey"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/module/ModuleVersionUpload.java", "diffHunk": "@@ -73,10 +73,7 @@ protected void doRun(SlingHttpServletRequest request, PostResponse response, Lis\n \n         try {\n             String locale = ServletUtils.paramValue(request, \"locale\", GlobalConfig.DEFAULT_MODULE_LOCALE.toString());\n-            String encoding = request.getCharacterEncoding();\n-            if (encoding == null) {\n-                encoding = StandardCharsets.UTF_8.name();\n-            }\n+            String encoding = StandardCharsets.UTF_8.name();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI0MDUyMQ=="}, "originalCommit": {"oid": "8bebb1c41b93a7383bcf57a35a55c7fd775d29db"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkyOTg4OA==", "bodyText": "@rednitish, rather than overwriting the ISO_8859_1 test, can you copy/paste it so that your new test for the accented characters becomes an additional test?", "url": "https://github.com/redhataccess/pantheon/pull/427#discussion_r498929888", "createdAt": "2020-10-02T16:37:33Z", "author": {"login": "benradey"}, "path": "pantheon-bundle/src/test/java/com/redhat/pantheon/servlet/module/ModuleVersionUploadTest.java", "diffHunk": "@@ -105,10 +105,10 @@ void createFirstVersionUnicodeIso() throws Exception {\n         ModuleVersionUpload upload = new ModuleVersionUpload(asciidoctorService);\n         Map<String, Object> params = newHashMap();\n         params.put(\"locale\", Locale.SIMPLIFIED_CHINESE.toString());\n-        params.put(\"asciidoc\", \"\u00e5\\u008D\\u0097\u00e4\u00ba\u00ac\u00e9\\u0098\u00b2\u00e7\\u0096\u00ab\u00e7\\u008E\u00b0\u00e5\\u009C\u00ba\");\n+        params.put(\"asciidoc\", \"d'agua per toles partes, por exemplu: Sicilia y Cuba; al otrud\u00eda  decat\u00e1ronse  d'\u00fa  ven\u00eden  les  voces:  de  dientro  la  casa;  nun  foi  aaguantar aquel perru: vendi\u00f3lu.\");\n         slingContext.request().setParameterMap(params);\n         slingContext.request().setResource(new NonExistingResource(slingContext.resourceResolver(), \"/content/repositories/test_workspace/entities/new/proc_module\"));\n-        slingContext.request().setCharacterEncoding(StandardCharsets.ISO_8859_1.toString());\n+        slingContext.request().setCharacterEncoding(StandardCharsets.UTF_8.toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI0MzIzMA=="}, "originalCommit": {"oid": "8bebb1c41b93a7383bcf57a35a55c7fd775d29db"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2895f368e1add2df66e93cba38c7ab0378a35b0c", "author": {"user": {"login": "rednitish", "name": "Nitish Sharma"}}, "url": "https://github.com/redhataccess/pantheon/commit/2895f368e1add2df66e93cba38c7ab0378a35b0c", "committedDate": "2020-10-05T11:25:17Z", "message": " ccs_3768 encoding issues review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8bebb1c41b93a7383bcf57a35a55c7fd775d29db", "author": {"user": {"login": "rednitish", "name": "Nitish Sharma"}}, "url": "https://github.com/redhataccess/pantheon/commit/8bebb1c41b93a7383bcf57a35a55c7fd775d29db", "committedDate": "2020-10-01T09:05:56Z", "message": " ccs_3768 test case for accented characters"}, "afterCommit": {"oid": "2895f368e1add2df66e93cba38c7ab0378a35b0c", "author": {"user": {"login": "rednitish", "name": "Nitish Sharma"}}, "url": "https://github.com/redhataccess/pantheon/commit/2895f368e1add2df66e93cba38c7ab0378a35b0c", "committedDate": "2020-10-05T11:25:17Z", "message": " ccs_3768 encoding issues review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNzEyODA3", "url": "https://github.com/redhataccess/pantheon/pull/427#pullrequestreview-502712807", "createdAt": "2020-10-06T08:42:34Z", "commit": {"oid": "2895f368e1add2df66e93cba38c7ab0378a35b0c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwODo0MjozNFrOHc8Bkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwODo0MjozNFrOHc8Bkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEwNTYxOA==", "bodyText": "This approach is good for short term approach until we find how to pass charset as header with multipart data. However, use some other name rather than content-type. My suggestion is to use encoding", "url": "https://github.com/redhataccess/pantheon/pull/427#discussion_r500105618", "createdAt": "2020-10-06T08:42:34Z", "author": {"login": "aprajshekhar"}, "path": "uploader/pantheon.py", "diffHunk": "@@ -250,6 +250,7 @@ def process_file(path, filetype):\n         data = _generate_data(jcr_primary_type, base_name, path.name, asccidoc_type='nt:file')\n         # This is needed to add a new module version, otherwise it won't be handled\n         data[':operation'] = 'pant:newModuleVersion'\n+        data['Content-Type'] = 'UTF-8'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2895f368e1add2df66e93cba38c7ab0378a35b0c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79e743d98c398dcfc0180635948de06350e422b1", "author": {"user": {"login": "rednitish", "name": "Nitish Sharma"}}, "url": "https://github.com/redhataccess/pantheon/commit/79e743d98c398dcfc0180635948de06350e422b1", "committedDate": "2020-10-06T11:20:32Z", "message": "CCS-3768 fix AP_review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48c8afd4920c70613e5892c008b360d96c72df98", "author": {"user": {"login": "rednitish", "name": "Nitish Sharma"}}, "url": "https://github.com/redhataccess/pantheon/commit/48c8afd4920c70613e5892c008b360d96c72df98", "committedDate": "2020-10-07T13:52:04Z", "message": " CCS-3768 , fixes suggested by ben"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52afc37286657a2b52674576283011fada334f2f", "author": {"user": {"login": "rednitish", "name": "Nitish Sharma"}}, "url": "https://github.com/redhataccess/pantheon/commit/52afc37286657a2b52674576283011fada334f2f", "committedDate": "2020-10-07T13:55:48Z", "message": " CCS-3768 , fixes suggested by ben"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MDU1OTkx", "url": "https://github.com/redhataccess/pantheon/pull/427#pullrequestreview-504055991", "createdAt": "2020-10-07T16:23:01Z", "commit": {"oid": "52afc37286657a2b52674576283011fada334f2f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1884, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}