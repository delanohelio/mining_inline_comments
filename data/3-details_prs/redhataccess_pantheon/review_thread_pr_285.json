{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzNjkxNzMx", "number": 285, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNTo1NTo1OFrOD54h5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNTo1NTo1OFrOD54h5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyMDIxNjA2OnYy", "diffSide": "RIGHT", "path": "pantheon-bundle/src/test/java/com/redhat/pantheon/servlet/module/ModuleVersionUploadTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNTo1NTo1OFrOGRZ6JQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwNzoyMzo1M1rOGRxp7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkwMzQ2MQ==", "bodyText": "ooff... this formating \ud83e\udd22", "url": "https://github.com/redhataccess/pantheon/pull/285#discussion_r420903461", "createdAt": "2020-05-06T15:55:58Z", "author": {"login": "carlosmunoz"}, "path": "pantheon-bundle/src/test/java/com/redhat/pantheon/servlet/module/ModuleVersionUploadTest.java", "diffHunk": "@@ -280,6 +280,139 @@ void uploadIdenticalDraftVersion() throws Exception {\n         slingContext.resourceResolver().getResource(\"/new/module/es_ES\").adaptTo(ModifiableValueMap.class)\n                 .put(\"released\", slingContext.resourceResolver().getResource(\"/new/module/es_ES/1\").getValueMap().get(\"jcr:uuid\"));\n \n+        slingContext.resourceResolver().getResource(\"/new/module/es_ES/1\").adaptTo(ModifiableValueMap.class)\n+                .put(\"pant:hash\", \"bd7b5944327dce6ee8eb9573cb856d7528fbf8d634a4e8389a09f982571bf6c699f6dfefcd34fa6234e0acb19f46d1ee6d333a951476f1a712566bbc8d3552a2\");\n+        slingContext.resourceResolver().getResource(\"/new/module/es_ES/2\").adaptTo(ModifiableValueMap.class)\n+                .put(\"pant:hash\", \"bd7b5944327dce6ee8eb9573cb856d7528fbf8d634a4e8389a09f982571bf6c699f6dfefcd34fa6234e0acb19f46d1ee6d333a951476f1a712566bbc8d3552a2\");\n+\n+        lenient().when(\n+                asciidoctorService.getModuleHtml(\n+                        any(ModuleVersion.class), any(Resource.class), anyMap(), anyBoolean()))\n+                .thenReturn(\"A generated html string\");\n+        lenient().when(serviceResourceResolverProvider.getServiceResourceResolver())\n+                .thenReturn(slingContext.resourceResolver());\n+        ModuleVersionUpload upload = new ModuleVersionUpload(asciidoctorService, serviceResourceResolverProvider);\n+        Map<String, Object> params = newHashMap();\n+        params.put(\"locale\", \"es_ES\");\n+        params.put(\"asciidoc\", \"This is the draft adoc content\");\n+        registerMockAdapter(Module.class, slingContext);\n+        slingContext.request().setParameterMap(params);\n+        slingContext.request().setResource(new NonExistingResource(slingContext.resourceResolver(), \"/new/module\"));\n+\n+        // when\n+        upload.doRun(slingContext.request(), new HtmlResponse(), null);\n+\n+        // Then\n+        assertNotNull(slingContext.resourceResolver().getResource(\"/new/module/es_ES/2/content\"));\n+        assertNotNull(slingContext.resourceResolver().getResource(\"/new/module/es_ES/2/metadata\"));\n+        assertNotNull(slingContext.resourceResolver().getResource(\"/new/module/es_ES/1/content\"));\n+        assertNotNull(slingContext.resourceResolver().getResource(\"/new/module/es_ES/1/metadata\"));\n+\n+        Module module =\n+                SlingModels.getModel(slingContext.resourceResolver().getResource(\"/new/module\"), Module.class);\n+        assertEquals(\"This is the draft adoc content\",\n+                module.getDraftContent(LocaleUtils.toLocale(\"es_ES\")).get().asciidocContent().get()\n+        );\n+        assertEquals(\"This is the draft html content\",\n+                module.getDraftContent(LocaleUtils.toLocale(\"es_ES\")).get().cachedHtml().get().data().get()\n+        );\n+        assertEquals(\"This is the released adoc content\",\n+                module.getReleasedContent(LocaleUtils.toLocale(\"es_ES\")).get().asciidocContent().get()\n+        );\n+        verify(asciidoctorService, never()).getModuleHtml(\n+                any(ModuleVersion.class), any(Resource.class), anyMap(), anyBoolean());\n+    }\n+        @Test\n+    void uploadIdenticalDraftVersionWithDifferentHash() throws Exception {\n+        // Given\n+        slingContext.build()\n+                .resource(\"/new/module/es_ES/1\",\n+                        \"jcr:primaryType\", \"pant:moduleVersion\") // released\n+                .resource(\"/new/module/es_ES/2\",\n+                        \"jcr:primaryType\", \"pant:moduleVersion\") // draft\n+                // Draft version\n+                .resource(\"/new/module/es_ES/2/metadata\")\n+                .resource(\"/new/module/es_ES/2/content/asciidoc/jcr:content\",\n+                        \"jcr:data\", \"This is the draft adoc content\")\n+                .resource(\"/new/module/es_ES/2/content/cachedHtml\",\n+                        \"jcr:data\", \"This is the draft html content\")\n+                // Released version\n+                .resource(\"/new/module/es_ES/1/metadata\")\n+                .resource(\"/new/module/es_ES/1/content/asciidoc/jcr:content\",\n+                        \"jcr:data\", \"This is the released adoc content\")\n+                .commit();\n+        // set the draft and released 'pointers'\n+        slingContext.resourceResolver().getResource(\"/new/module/es_ES\").adaptTo(ModifiableValueMap.class)\n+                .put(\"draft\", slingContext.resourceResolver().getResource(\"/new/module/es_ES/2\").getValueMap().get(\"jcr:uuid\"));\n+        slingContext.resourceResolver().getResource(\"/new/module/es_ES\").adaptTo(ModifiableValueMap.class)\n+                .put(\"released\", slingContext.resourceResolver().getResource(\"/new/module/es_ES/1\").getValueMap().get(\"jcr:uuid\"));\n+\n+        slingContext.resourceResolver().getResource(\"/new/module/es_ES/1\").adaptTo(ModifiableValueMap.class)\n+                .put(\"pant:hash\", \"bd7b5944327dce6ee8eb9573cb856d7528fbf8d634a4e8389a09f982571bf6c699f6dfefcd34fa6234e0acb19f46d1ee6d333a951476f1a712566bbc8d3552a2\");\n+        slingContext.resourceResolver().getResource(\"/new/module/es_ES/2\").adaptTo(ModifiableValueMap.class)\n+                .put(\"pant:hash\", \"cd7b5944327dce6ee8eb9573cb856d7528fbf8d634a4e8389a09f982571bf6c699f6dfefcd34fa6234e0acb19f46d1ee6d333a951476f1a712566bbc8d3552a2\");\n+\n+        lenient().when(\n+                asciidoctorService.getModuleHtml(\n+                        any(ModuleVersion.class), any(Resource.class), anyMap(), anyBoolean()))\n+                .thenReturn(\"A generated html string\");\n+        lenient().when(serviceResourceResolverProvider.getServiceResourceResolver())\n+                .thenReturn(slingContext.resourceResolver());\n+        ModuleVersionUpload upload = new ModuleVersionUpload(asciidoctorService, serviceResourceResolverProvider);\n+        Map<String, Object> params = newHashMap();\n+        params.put(\"locale\", \"es_ES\");\n+        params.put(\"asciidoc\", \"This is the draft adoc content\");\n+        registerMockAdapter(Module.class, slingContext);\n+        slingContext.request().setParameterMap(params);\n+        slingContext.request().setResource(new NonExistingResource(slingContext.resourceResolver(), \"/new/module\"));\n+\n+        // when\n+        upload.doRun(slingContext.request(), new HtmlResponse(), null);\n+\n+        // Then\n+        assertNotNull(slingContext.resourceResolver().getResource(\"/new/module/es_ES/2/content\"));\n+        assertNotNull(slingContext.resourceResolver().getResource(\"/new/module/es_ES/2/metadata\"));\n+        assertNotNull(slingContext.resourceResolver().getResource(\"/new/module/es_ES/1/content\"));\n+        assertNotNull(slingContext.resourceResolver().getResource(\"/new/module/es_ES/1/metadata\"));\n+\n+        Module module =\n+                SlingModels.getModel(slingContext.resourceResolver().getResource(\"/new/module\"), Module.class);\n+        assertEquals(\"This is the draft adoc content\",\n+                module.getDraftContent(LocaleUtils.toLocale(\"es_ES\")).get().asciidocContent().get()\n+        );\n+        assertEquals(\"This is the draft html content\",\n+                module.getDraftContent(LocaleUtils.toLocale(\"es_ES\")).get().cachedHtml().get().data().get()\n+        );\n+        assertEquals(\"This is the released adoc content\",\n+                module.getReleasedContent(LocaleUtils.toLocale(\"es_ES\")).get().asciidocContent().get()\n+        );\n+        verify(asciidoctorService, never()).getModuleHtml(\n+                any(ModuleVersion.class), any(Resource.class), anyMap(), anyBoolean());\n+    }        @Test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd04370d8c1b3042aae5f00adef5a0364634ecee"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTI5MjUyNg==", "bodyText": "Auto formatting sometimes does  strange things :)", "url": "https://github.com/redhataccess/pantheon/pull/285#discussion_r421292526", "createdAt": "2020-05-07T07:23:53Z", "author": {"login": "rednitish"}, "path": "pantheon-bundle/src/test/java/com/redhat/pantheon/servlet/module/ModuleVersionUploadTest.java", "diffHunk": "@@ -280,6 +280,139 @@ void uploadIdenticalDraftVersion() throws Exception {\n         slingContext.resourceResolver().getResource(\"/new/module/es_ES\").adaptTo(ModifiableValueMap.class)\n                 .put(\"released\", slingContext.resourceResolver().getResource(\"/new/module/es_ES/1\").getValueMap().get(\"jcr:uuid\"));\n \n+        slingContext.resourceResolver().getResource(\"/new/module/es_ES/1\").adaptTo(ModifiableValueMap.class)\n+                .put(\"pant:hash\", \"bd7b5944327dce6ee8eb9573cb856d7528fbf8d634a4e8389a09f982571bf6c699f6dfefcd34fa6234e0acb19f46d1ee6d333a951476f1a712566bbc8d3552a2\");\n+        slingContext.resourceResolver().getResource(\"/new/module/es_ES/2\").adaptTo(ModifiableValueMap.class)\n+                .put(\"pant:hash\", \"bd7b5944327dce6ee8eb9573cb856d7528fbf8d634a4e8389a09f982571bf6c699f6dfefcd34fa6234e0acb19f46d1ee6d333a951476f1a712566bbc8d3552a2\");\n+\n+        lenient().when(\n+                asciidoctorService.getModuleHtml(\n+                        any(ModuleVersion.class), any(Resource.class), anyMap(), anyBoolean()))\n+                .thenReturn(\"A generated html string\");\n+        lenient().when(serviceResourceResolverProvider.getServiceResourceResolver())\n+                .thenReturn(slingContext.resourceResolver());\n+        ModuleVersionUpload upload = new ModuleVersionUpload(asciidoctorService, serviceResourceResolverProvider);\n+        Map<String, Object> params = newHashMap();\n+        params.put(\"locale\", \"es_ES\");\n+        params.put(\"asciidoc\", \"This is the draft adoc content\");\n+        registerMockAdapter(Module.class, slingContext);\n+        slingContext.request().setParameterMap(params);\n+        slingContext.request().setResource(new NonExistingResource(slingContext.resourceResolver(), \"/new/module\"));\n+\n+        // when\n+        upload.doRun(slingContext.request(), new HtmlResponse(), null);\n+\n+        // Then\n+        assertNotNull(slingContext.resourceResolver().getResource(\"/new/module/es_ES/2/content\"));\n+        assertNotNull(slingContext.resourceResolver().getResource(\"/new/module/es_ES/2/metadata\"));\n+        assertNotNull(slingContext.resourceResolver().getResource(\"/new/module/es_ES/1/content\"));\n+        assertNotNull(slingContext.resourceResolver().getResource(\"/new/module/es_ES/1/metadata\"));\n+\n+        Module module =\n+                SlingModels.getModel(slingContext.resourceResolver().getResource(\"/new/module\"), Module.class);\n+        assertEquals(\"This is the draft adoc content\",\n+                module.getDraftContent(LocaleUtils.toLocale(\"es_ES\")).get().asciidocContent().get()\n+        );\n+        assertEquals(\"This is the draft html content\",\n+                module.getDraftContent(LocaleUtils.toLocale(\"es_ES\")).get().cachedHtml().get().data().get()\n+        );\n+        assertEquals(\"This is the released adoc content\",\n+                module.getReleasedContent(LocaleUtils.toLocale(\"es_ES\")).get().asciidocContent().get()\n+        );\n+        verify(asciidoctorService, never()).getModuleHtml(\n+                any(ModuleVersion.class), any(Resource.class), anyMap(), anyBoolean());\n+    }\n+        @Test\n+    void uploadIdenticalDraftVersionWithDifferentHash() throws Exception {\n+        // Given\n+        slingContext.build()\n+                .resource(\"/new/module/es_ES/1\",\n+                        \"jcr:primaryType\", \"pant:moduleVersion\") // released\n+                .resource(\"/new/module/es_ES/2\",\n+                        \"jcr:primaryType\", \"pant:moduleVersion\") // draft\n+                // Draft version\n+                .resource(\"/new/module/es_ES/2/metadata\")\n+                .resource(\"/new/module/es_ES/2/content/asciidoc/jcr:content\",\n+                        \"jcr:data\", \"This is the draft adoc content\")\n+                .resource(\"/new/module/es_ES/2/content/cachedHtml\",\n+                        \"jcr:data\", \"This is the draft html content\")\n+                // Released version\n+                .resource(\"/new/module/es_ES/1/metadata\")\n+                .resource(\"/new/module/es_ES/1/content/asciidoc/jcr:content\",\n+                        \"jcr:data\", \"This is the released adoc content\")\n+                .commit();\n+        // set the draft and released 'pointers'\n+        slingContext.resourceResolver().getResource(\"/new/module/es_ES\").adaptTo(ModifiableValueMap.class)\n+                .put(\"draft\", slingContext.resourceResolver().getResource(\"/new/module/es_ES/2\").getValueMap().get(\"jcr:uuid\"));\n+        slingContext.resourceResolver().getResource(\"/new/module/es_ES\").adaptTo(ModifiableValueMap.class)\n+                .put(\"released\", slingContext.resourceResolver().getResource(\"/new/module/es_ES/1\").getValueMap().get(\"jcr:uuid\"));\n+\n+        slingContext.resourceResolver().getResource(\"/new/module/es_ES/1\").adaptTo(ModifiableValueMap.class)\n+                .put(\"pant:hash\", \"bd7b5944327dce6ee8eb9573cb856d7528fbf8d634a4e8389a09f982571bf6c699f6dfefcd34fa6234e0acb19f46d1ee6d333a951476f1a712566bbc8d3552a2\");\n+        slingContext.resourceResolver().getResource(\"/new/module/es_ES/2\").adaptTo(ModifiableValueMap.class)\n+                .put(\"pant:hash\", \"cd7b5944327dce6ee8eb9573cb856d7528fbf8d634a4e8389a09f982571bf6c699f6dfefcd34fa6234e0acb19f46d1ee6d333a951476f1a712566bbc8d3552a2\");\n+\n+        lenient().when(\n+                asciidoctorService.getModuleHtml(\n+                        any(ModuleVersion.class), any(Resource.class), anyMap(), anyBoolean()))\n+                .thenReturn(\"A generated html string\");\n+        lenient().when(serviceResourceResolverProvider.getServiceResourceResolver())\n+                .thenReturn(slingContext.resourceResolver());\n+        ModuleVersionUpload upload = new ModuleVersionUpload(asciidoctorService, serviceResourceResolverProvider);\n+        Map<String, Object> params = newHashMap();\n+        params.put(\"locale\", \"es_ES\");\n+        params.put(\"asciidoc\", \"This is the draft adoc content\");\n+        registerMockAdapter(Module.class, slingContext);\n+        slingContext.request().setParameterMap(params);\n+        slingContext.request().setResource(new NonExistingResource(slingContext.resourceResolver(), \"/new/module\"));\n+\n+        // when\n+        upload.doRun(slingContext.request(), new HtmlResponse(), null);\n+\n+        // Then\n+        assertNotNull(slingContext.resourceResolver().getResource(\"/new/module/es_ES/2/content\"));\n+        assertNotNull(slingContext.resourceResolver().getResource(\"/new/module/es_ES/2/metadata\"));\n+        assertNotNull(slingContext.resourceResolver().getResource(\"/new/module/es_ES/1/content\"));\n+        assertNotNull(slingContext.resourceResolver().getResource(\"/new/module/es_ES/1/metadata\"));\n+\n+        Module module =\n+                SlingModels.getModel(slingContext.resourceResolver().getResource(\"/new/module\"), Module.class);\n+        assertEquals(\"This is the draft adoc content\",\n+                module.getDraftContent(LocaleUtils.toLocale(\"es_ES\")).get().asciidocContent().get()\n+        );\n+        assertEquals(\"This is the draft html content\",\n+                module.getDraftContent(LocaleUtils.toLocale(\"es_ES\")).get().cachedHtml().get().data().get()\n+        );\n+        assertEquals(\"This is the released adoc content\",\n+                module.getReleasedContent(LocaleUtils.toLocale(\"es_ES\")).get().asciidocContent().get()\n+        );\n+        verify(asciidoctorService, never()).getModuleHtml(\n+                any(ModuleVersion.class), any(Resource.class), anyMap(), anyBoolean());\n+    }        @Test", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkwMzQ2MQ=="}, "originalCommit": {"oid": "dd04370d8c1b3042aae5f00adef5a0364634ecee"}, "originalPosition": 121}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 288, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}