{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MjIwODgy", "number": 218, "title": "[CCS-2965] update unpublish event message", "bodyText": "This PR updates the message we send to Hydra for unpublished events.", "createdAt": "2020-01-28T20:45:17Z", "url": "https://github.com/redhataccess/pantheon/pull/218", "merged": true, "mergeCommit": {"oid": "b59353723d3feb3e363d04a32b275d18990aaccf"}, "closed": true, "closedAt": "2020-01-29T20:51:44Z", "author": {"login": "xdavidson"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-2Wj6gH2gAyMzY4MjIwODgyOjcwOTBmOWM1Y2RlOTM5OTgxNGUyYWUzOTIxYTQwMzM5N2ZhZDNhYjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_MOgmAFqTM1MDQxMjgyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7090f9c5cde9399814e2ae3921a403397fad3ab2", "author": {"user": {"login": "xdavidson", "name": "Lisa Davidson"}}, "url": "https://github.com/redhataccess/pantheon/commit/7090f9c5cde9399814e2ae3921a403397fad3ab2", "committedDate": "2020-01-28T19:17:45Z", "message": "[CCS-2965] update unpublish event message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5Njk0MDEy", "url": "https://github.com/redhataccess/pantheon/pull/218#pullrequestreview-349694012", "createdAt": "2020-01-28T20:53:45Z", "commit": {"oid": "7090f9c5cde9399814e2ae3921a403397fad3ab2"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMDo1Mzo0NVrOFi0HOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMDo1ODo0N1rOFi0QOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA0OTcyMw==", "bodyText": "what  happens if the portal URL is not defined? seems like it would still seek to publish an empty id.\nShould we abort the message in that case?", "url": "https://github.com/redhataccess/pantheon/pull/218#discussion_r372049723", "createdAt": "2020-01-28T20:53:45Z", "author": {"login": "carlosmunoz"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/extension/HydraIntegration.java", "diffHunk": "@@ -104,11 +113,26 @@ public void processEvent(Event event) throws Exception {\n         MessageProducer producer = session.createProducer(session.createTopic(HYDRA_TOPIC));\n         String moduleUUID = module.getValueMap().get(UUID_FIELD, String.class);\n         String eventValue = ModuleVersionPublishedEvent.class.equals(event.getClass()) ? EVENT_PUBLISH_VALUE : EVENT_UNPUBLISH_VALUE;\n-        String msg = \"{\\\"\"\n-                + ID_KEY + \"\\\":\" + \"\\\"\" + this.getPantheonHost() + PANTHEON_MODULE_API_PATH + moduleUUID +\"\\\",\"\n-                + \"\\\"\" + EVENT_KEY + \"\\\":\" + \"\\\"\" + eventValue + \"\\\"}\";\n+        String idValue = ModuleVersionPublishedEvent.class.equals(event.getClass()) ? this.getPantheonHost() + PANTHEON_MODULE_API_PATH\n+                + moduleUUID : \"\";\n+        String uriValue = \"\";\n+        String msg = \"\";\n+        if (System.getenv(PORTAL_URL) != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7090f9c5cde9399814e2ae3921a403397fad3ab2"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA1MDY1OA==", "bodyText": "So, this will NOT be appearing in the API anymore?\nJust confirming...", "url": "https://github.com/redhataccess/pantheon/pull/218#discussion_r372050658", "createdAt": "2020-01-28T20:55:50Z", "author": {"login": "carlosmunoz"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/ModuleJsonServlet.java", "diffHunk": "@@ -158,12 +158,6 @@ protected boolean isValidResource(@Nonnull SlingHttpServletRequest request, @Non\n             moduleMap.put(VIEW_URI, view_uri);\n         }\n \n-        // Process view_uri\n-        if (System.getenv(\"PORTAL_URL\") != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7090f9c5cde9399814e2ae3921a403397fad3ab2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA1MjAyNQ==", "bodyText": "I'm having a bit of trouble following these event types. Could you explain what the difference is between ModuleVersionPublishStateEvent and ModuleVerisonPublishedEvent? they seem to be the same thing", "url": "https://github.com/redhataccess/pantheon/pull/218#discussion_r372052025", "createdAt": "2020-01-28T20:58:47Z", "author": {"login": "carlosmunoz"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/extension/HydraIntegration.java", "diffHunk": "@@ -23,19 +22,27 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import com.redhat.pantheon.extension.events.ModuleVersionPublishStateEvent;\n import com.redhat.pantheon.extension.events.ModuleVersionPublishedEvent;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7090f9c5cde9399814e2ae3921a403397fad3ab2"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMjY5OTE2", "url": "https://github.com/redhataccess/pantheon/pull/218#pullrequestreview-350269916", "createdAt": "2020-01-29T16:59:40Z", "commit": {"oid": "7090f9c5cde9399814e2ae3921a403397fad3ab2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNjo1OTo0MVrOFjQJGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNjo1OTo0MVrOFjQJGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUwODk1NQ==", "bodyText": "Ok, I think I understand now.... in this case I would turn this into an else if for the specific implementation class, and have the else statement log some sort of warning. It will help us identify when we have an event type that is not being handled by the code.", "url": "https://github.com/redhataccess/pantheon/pull/218#discussion_r372508955", "createdAt": "2020-01-29T16:59:41Z", "author": {"login": "carlosmunoz"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/extension/HydraIntegration.java", "diffHunk": "@@ -104,11 +113,26 @@ public void processEvent(Event event) throws Exception {\n         MessageProducer producer = session.createProducer(session.createTopic(HYDRA_TOPIC));\n         String moduleUUID = module.getValueMap().get(UUID_FIELD, String.class);\n         String eventValue = ModuleVersionPublishedEvent.class.equals(event.getClass()) ? EVENT_PUBLISH_VALUE : EVENT_UNPUBLISH_VALUE;\n-        String msg = \"{\\\"\"\n-                + ID_KEY + \"\\\":\" + \"\\\"\" + this.getPantheonHost() + PANTHEON_MODULE_API_PATH + moduleUUID +\"\\\",\"\n-                + \"\\\"\" + EVENT_KEY + \"\\\":\" + \"\\\"\" + eventValue + \"\\\"}\";\n+        String idValue = ModuleVersionPublishedEvent.class.equals(event.getClass()) ? this.getPantheonHost() + PANTHEON_MODULE_API_PATH\n+                + moduleUUID : \"\";\n+        String uriValue = \"\";\n+        String msg = \"\";\n+        if (System.getenv(PORTAL_URL) != null) {\n+            uriValue = System.getenv(PORTAL_URL) + \"/topics/\" + ServletUtils.toLanguageTag(DEFAULT_MODULE_LOCALE) + \"/\" + moduleUUID;\n+        }\n+        if (ModuleVersionPublishedEvent.class.equals(event.getClass())) {\n+            msg = \"{\\\"\"\n+                    + ID_KEY + \"\\\":\" + \"\\\"\" + idValue +\"\\\",\"\n+                    + \"\\\"\" + EVENT_KEY + \"\\\":\" + \"\\\"\" + eventValue + \"\\\"}\";\n+        } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7090f9c5cde9399814e2ae3921a403397fad3ab2"}, "originalPosition": 86}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMjcwMjM1", "url": "https://github.com/redhataccess/pantheon/pull/218#pullrequestreview-350270235", "createdAt": "2020-01-29T17:00:06Z", "commit": {"oid": "7090f9c5cde9399814e2ae3921a403397fad3ab2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67dfb817c65a5a09bb037d725adbabefb495fc0a", "author": {"user": {"login": "xdavidson", "name": "Lisa Davidson"}}, "url": "https://github.com/redhataccess/pantheon/commit/67dfb817c65a5a09bb037d725adbabefb495fc0a", "committedDate": "2020-01-29T17:54:56Z", "message": "refactor code for unpublish event"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e38360359f89d7c59fc03bb2a41084130e7bcae", "author": {"user": {"login": "xdavidson", "name": "Lisa Davidson"}}, "url": "https://github.com/redhataccess/pantheon/commit/6e38360359f89d7c59fc03bb2a41084130e7bcae", "committedDate": "2020-01-29T20:44:12Z", "message": "add warning message for unhandled event type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNDEyODIx", "url": "https://github.com/redhataccess/pantheon/pull/218#pullrequestreview-350412821", "createdAt": "2020-01-29T20:46:52Z", "commit": {"oid": "6e38360359f89d7c59fc03bb2a41084130e7bcae"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2179, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}