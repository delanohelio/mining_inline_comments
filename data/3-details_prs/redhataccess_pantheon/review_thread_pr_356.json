{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4NTY1Njg5", "number": 356, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMDo0Mjo0NVrOEToE7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMDo0OTo0MFrOEToNBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MDE1MDIzOnYy", "diffSide": "RIGHT", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/module/PublishDraftVersion.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMDo0Mjo0NVrOG5dxWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMDo1NzowMFrOG5eLsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkwOTc4Ng==", "bodyText": "Do we need this as info rather than debug? Just curious.", "url": "https://github.com/redhataccess/pantheon/pull/356#discussion_r462909786", "createdAt": "2020-07-30T10:42:45Z", "author": {"login": "aprajshekhar"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/module/PublishDraftVersion.java", "diffHunk": "@@ -75,64 +84,74 @@ public void run(SlingHttpServletRequest request, PostResponse response, SlingPos\n             asciidoctorService.getModuleHtml(module, locale, variant, false, new HashMap(), true);\n             events.fireEvent(new ModuleVersionPublishedEvent(moduleVersion), 15);\n         }\n+        log.debug(\"Operation Publishinging draft version,  completed\");\n+        long elapseTime = System.currentTimeMillis() - startTime;\n+        log.info(\"Total elapsed http request/response time in milliseconds: \" + elapseTime);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65d0b1b5d241b4b5846b82d50cc1a761cf8a653e"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkxNjUyOQ==", "bodyText": "Changed level of logger to debug,", "url": "https://github.com/redhataccess/pantheon/pull/356#discussion_r462916529", "createdAt": "2020-07-30T10:57:00Z", "author": {"login": "rednitish"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/module/PublishDraftVersion.java", "diffHunk": "@@ -75,64 +84,74 @@ public void run(SlingHttpServletRequest request, PostResponse response, SlingPos\n             asciidoctorService.getModuleHtml(module, locale, variant, false, new HashMap(), true);\n             events.fireEvent(new ModuleVersionPublishedEvent(moduleVersion), 15);\n         }\n+        log.debug(\"Operation Publishinging draft version,  completed\");\n+        long elapseTime = System.currentTimeMillis() - startTime;\n+        log.info(\"Total elapsed http request/response time in milliseconds: \" + elapseTime);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkwOTc4Ng=="}, "originalCommit": {"oid": "65d0b1b5d241b4b5846b82d50cc1a761cf8a653e"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MDE2NTI1OnYy", "diffSide": "RIGHT", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/module/PublishDraftVersion.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMDo0Nzo0M1rOG5d6Sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMDo0Nzo0M1rOG5d6Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkxMjA3NA==", "bodyText": "Rather than if/else if,  if and return  would be better as you don't want the process to go further after setting response.", "url": "https://github.com/redhataccess/pantheon/pull/356#discussion_r462912074", "createdAt": "2020-07-30T10:47:43Z", "author": {"login": "aprajshekhar"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/module/PublishDraftVersion.java", "diffHunk": "@@ -75,64 +84,74 @@ public void run(SlingHttpServletRequest request, PostResponse response, SlingPos\n             asciidoctorService.getModuleHtml(module, locale, variant, false, new HashMap(), true);\n             events.fireEvent(new ModuleVersionPublishedEvent(moduleVersion), 15);\n         }\n+        log.debug(\"Operation Publishinging draft version,  completed\");\n+        long elapseTime = System.currentTimeMillis() - startTime;\n+        log.info(\"Total elapsed http request/response time in milliseconds: \" + elapseTime);\n     }\n \n     @Override\n-    protected void doRun(SlingHttpServletRequest request, PostResponse response, List<Modification> changes) {\n-        Locale locale = getLocale(request);\n-        Module module = getModule(request);\n-        String variant = getVariant(request);\n+    protected void doRun(SlingHttpServletRequest request, PostResponse response, List<Modification> changes) throws  RepositoryException{\n+        try (ResourceResolver serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver()) {\n+            Module module = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Module.class);\n+            Locale locale = getLocale(request);\n+            String variant = getVariant(request);\n \n-        // Get the draft version, there should be one\n-        Optional<ModuleVersion> versionToRelease = module.getDraftVersion(locale, variant);\n-        if( !versionToRelease.isPresent() ) {\n-            response.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n-                    \"The module doesn't have a draft version to be released\");\n-        } else if (versionToRelease.get().metadata().getOrCreate().productVersion().get() == null\n-        \t\t||  versionToRelease.get().metadata().getOrCreate().productVersion().get().isEmpty()) {\n-        \t// Check if productVersion is set\n-        \tresponse.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n-                    \"The version to be released doesn't have productVersion metadata\");\n-        } else if (versionToRelease.get().metadata().getOrCreate().urlFragment().get() == null\n-        \t\t||  versionToRelease.get().metadata().getOrCreate().urlFragment().get().isEmpty()) {\n-        \t// Check if urlFragment is set\n-        \tresponse.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n-                    \"The version to be released doesn't have urlFragment metadata\");\n-        } else {\n-            // Draft becomes the new released version\n-            ModuleVariant moduleVariant = traverseFrom(module)\n-                    .toChild(m -> module.locale(locale))\n-                    .toChild(ModuleLocale::variants)\n-                    .toChild(variants -> variants.variant(variant))\n-                    .get();\n-            moduleVariant.releaseDraft();\n-            changes.add(Modification.onModified(module.getPath()));\n-            // source/draft becomes source/released\n-            FileResource draftSource = traverseFrom(module)\n-                    .toChild(m -> module.locale(locale))\n-                    .toChild(ModuleLocale::source)\n-                    .toChild(sourceContent -> sourceContent.draft())\n-                    .get();\n-            // Check for released version\n-            Optional<HashableFileResource> releasedSource = traverseFrom(module)\n-                    .toChild(m -> module.locale(locale))\n-                    .toChild(ModuleLocale::source)\n-                    .toChild(sourceContent -> sourceContent.released())\n-                    .getAsOptional();\n-            if (draftSource != null) {\n-                if (releasedSource.isPresent()) {\n+            // Get the draft version, there should be one\n+            Optional<ModuleVersion> versionToRelease = module.getDraftVersion(locale, variant);\n+            if (!versionToRelease.isPresent()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65d0b1b5d241b4b5846b82d50cc1a761cf8a653e"}, "originalPosition": 115}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MDE3MDk0OnYy", "diffSide": "RIGHT", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/module/UnpublishVersion.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMDo0OTo0MFrOG5d91w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMDo0OTo0MFrOG5d91w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkxMjk4Mw==", "bodyText": "Return would be better as processing need not to run after setting the status.", "url": "https://github.com/redhataccess/pantheon/pull/356#discussion_r462912983", "createdAt": "2020-07-30T10:49:40Z", "author": {"login": "aprajshekhar"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/module/UnpublishVersion.java", "diffHunk": "@@ -81,52 +91,62 @@ public void run(SlingHttpServletRequest request, PostResponse response, SlingPos\n             // TODO We need to change the event so that the right variant is processed\n             events.fireEvent(new ModuleVersionUnpublishedEvent(moduleVersion), 15);\n         }\n+        log.debug(\"Operation UnPublishinging draft version,  completed\");\n+        long elapseTime = System.currentTimeMillis() - startTime;\n+        log.info(\"Total elapsed http request/response time in milliseconds: \" + elapseTime);\n     }\n \n     @Override\n-    protected void doRun(SlingHttpServletRequest request, PostResponse response, List<Modification> changes) {\n-        Locale locale = getLocale(request);\n-        Module module = getModule(request);\n-        String variant = getVariant(request);\n-\n-        // Get the released version, there should be one\n-        Optional<? extends DocumentVersion> foundVariant = module.getReleasedVersion(locale, variant);\n-\n-        if(!foundVariant.isPresent()) {\n-            response.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n-                    \"The module is not released (published)\");\n-        } else {\n-            foundVariant.get()\n-                    .getParent()\n-                    .revertReleased();\n-\n-            changes.add(Modification.onModified(module.getPath()));\n-            // Change source/released to source/draft\n-            Optional<HashableFileResource> draftSource = traverseFrom(module)\n-                    .toChild(m -> module.locale(locale))\n-                    .toChild(ModuleLocale::source)\n-                    .toChild(sourceContent -> sourceContent.draft())\n-                    .getAsOptional();\n-            FileResource releasedSource = traverseFrom(module)\n-                    .toChild(m -> module.locale(locale))\n-                    .toChild(ModuleLocale::source)\n-                    .toChild(sourceContent -> sourceContent.released())\n-                    .get();\n-            if (draftSource.isPresent()) {\n-                // Delete released\n-                try {\n-                    releasedSource.delete();\n-                } catch (PersistenceException e) {\n-                    throw new RuntimeException(\"Failed to delete source/released: \" + releasedSource.getPath());\n-                }\n+    protected void doRun(SlingHttpServletRequest request, PostResponse response, List<Modification> changes) throws RepositoryException{\n+        try (ResourceResolver serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver()) {\n+            Module module = serviceResourceResolver.getResource(request.getResource().getPath()).adaptTo(Module.class);\n+            Locale locale = getLocale(request);\n+            String variant = getVariant(request);\n \n+            // Get the released version, there should be one\n+            Optional<? extends DocumentVersion> foundVariant = module.getReleasedVersion(locale, variant);\n+\n+            if(!foundVariant.isPresent()) {\n+                response.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED,\n+                        \"The module is not released (published)\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65d0b1b5d241b4b5846b82d50cc1a761cf8a653e"}, "originalPosition": 101}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 152, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}