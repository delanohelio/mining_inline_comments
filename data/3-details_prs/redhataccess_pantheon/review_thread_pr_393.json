{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1OTY5ODg5", "number": 393, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxOTo0Njo1MVrOE_UADw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNToxODoxNlrOFA2PJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0ODIzNDM5OnYy", "diffSide": "RIGHT", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/model/api/Child.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxOTo0Njo1MVrOH89E-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMDo0MDoyNlrOH8-5wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY3NzMwNw==", "bodyText": "I think this warrants some further explanation. It's easy to think that the isPresent() call applies to the child, when I think this must apply to the parent.\nI realized this when I was trying to get to the bottom of why your changes help to make things null-safe. For example, if you have this chain:\nChild.from(A)\n.toChild(B)\n.toChild(C)\n.toChild(D)\n.toChild(E)\n.getAsOptional()\n\n...and let's say that you get a null on C, then what the heck stops us from getting an NPE on the call to D?\nI guess the answer must be that there's some code that makes sure that once C becomes a NullChild, then the call to get D must also return a NullChild, and the same for the call down into E. The code that I have attached this comment to must be what does that. But like I said, it's easy to misread at first glance, so if I'm right then I'd like to request something that makes this look less innocuous and more critically important (which I believe it is). Maybe some enhanced javadoc, or some // INLINE COMMENTS IN ALL CAPS or something - whatever you think would be most fitting.", "url": "https://github.com/redhataccess/pantheon/pull/393#discussion_r533677307", "createdAt": "2020-12-01T19:46:51Z", "author": {"login": "benradey"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/model/api/Child.java", "diffHunk": "@@ -37,28 +41,92 @@\n      * Indicates if the child exists.\n      * @return True, if the child exists. False otherwise.\n      */\n-    boolean isPresent();\n+    default boolean isPresent() {\n+        return get() != null;\n+    }\n \n     /**\n-     * Provides a null-safe way to operate on the value of the child, and return an\n-     * {@link Optional} with the result of the operation. This allowes the caller to\n-     * continue to operate in a null-safe fashion.\n-     * @param func The function to apply to the value\n+     * Convert this Child to an {@link Optional}\n+     * @return An {@link Optional} with the contained value.\n+     */\n+    default Optional<T> asOptional() {\n+        return Optional.ofNullable(get());\n+    }\n+\n+    /**\n+     * Navigates to the {@link Child} provided by an accessor function.\n+     * @param childAccessor A function which given a {@link SlingModel} type, will\n+     *                      yield a child\n      * @param <R>\n-     * @return An optional indicating the result of the operation. If the operation\n-     * returns null, or if the value of this child was not present in the first place,\n-     * this returns an empty Optional\n-     * @deprecated Use {@link ResourceTraversal#traverseFrom(SlingModel)}\n-     * for safe resource traversals\n+     * @return A {@link Child} (may be non-existent) as indicated by the accessor.\n      */\n-    @Deprecated\n-    <R> Optional<R> map(Function<? super T, ? extends R> func);\n+    default <R extends SlingModel> Child<R> toChild(Function<? super T, Child<R>> childAccessor) {\n+        if(isPresent()) {\n+            return childAccessor.apply(get());\n+        }\n+        return (Child<R>) NullObjects.nullChild();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ead9c636484d33d92ff39c1530a4c7820250480"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzcwNzIwMQ==", "bodyText": "You are correct in your interpretation. This code is applying the Null Object pattern (https://en.wikipedia.org/wiki/Null_object_pattern) to ensure the null-safety. So let me make a few points which may clarify your questions:\n\nIn line 64 above, the call to isPresent() is done on the parent (aka the current node in the navigation). Perhaps it would be more self-explanatory to replace that with this.isPresent().\nLine 67 above is where the \"magic\" begins. If the current node is not present, then any child will inevitably not exist either, and so a NullChild is returned every time.\nThe code never throws an NPE because it never returns a null, instead it returns a NullChild which has some specific behaviours to represent the fact that it is an empty node.\n\nHappy to add more context and javadocs, just let me know where so I can do it in the right places where things were not clear. It's hard to identify those when you're the author.", "url": "https://github.com/redhataccess/pantheon/pull/393#discussion_r533707201", "createdAt": "2020-12-01T20:40:26Z", "author": {"login": "carlosmunoz"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/model/api/Child.java", "diffHunk": "@@ -37,28 +41,92 @@\n      * Indicates if the child exists.\n      * @return True, if the child exists. False otherwise.\n      */\n-    boolean isPresent();\n+    default boolean isPresent() {\n+        return get() != null;\n+    }\n \n     /**\n-     * Provides a null-safe way to operate on the value of the child, and return an\n-     * {@link Optional} with the result of the operation. This allowes the caller to\n-     * continue to operate in a null-safe fashion.\n-     * @param func The function to apply to the value\n+     * Convert this Child to an {@link Optional}\n+     * @return An {@link Optional} with the contained value.\n+     */\n+    default Optional<T> asOptional() {\n+        return Optional.ofNullable(get());\n+    }\n+\n+    /**\n+     * Navigates to the {@link Child} provided by an accessor function.\n+     * @param childAccessor A function which given a {@link SlingModel} type, will\n+     *                      yield a child\n      * @param <R>\n-     * @return An optional indicating the result of the operation. If the operation\n-     * returns null, or if the value of this child was not present in the first place,\n-     * this returns an empty Optional\n-     * @deprecated Use {@link ResourceTraversal#traverseFrom(SlingModel)}\n-     * for safe resource traversals\n+     * @return A {@link Child} (may be non-existent) as indicated by the accessor.\n      */\n-    @Deprecated\n-    <R> Optional<R> map(Function<? super T, ? extends R> func);\n+    default <R extends SlingModel> Child<R> toChild(Function<? super T, Child<R>> childAccessor) {\n+        if(isPresent()) {\n+            return childAccessor.apply(get());\n+        }\n+        return (Child<R>) NullObjects.nullChild();\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY3NzMwNw=="}, "originalCommit": {"oid": "1ead9c636484d33d92ff39c1530a4c7820250480"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2NDMyMjgyOnYy", "diffSide": "RIGHT", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/model/api/Child.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNToxNzowM1rOH_VW_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNToxNzowM1rOH_VW_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE3MjI4Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Navigates to the {@link Child} provided by an accessor function.\n          \n          \n            \n                 * Navigates to the {@link Child} provided by an accessor function.\n          \n          \n            \n                 * Uses the Null Object pattern to avoid throwing an NPE in a long chain of navigation.\n          \n          \n            \n                 * For example:\n          \n          \n            \n                 * Child.from(A)\n          \n          \n            \n                 * .toChild(B)\n          \n          \n            \n                 * .toChild(C)\n          \n          \n            \n                 * .toChild(D)\n          \n          \n            \n                 * .toChild(E)\n          \n          \n            \n                 * .getAsOptional()\n          \n          \n            \n                 * If C does not exist, the chain will not throw an exception because the nullChild will be returned for the remainder of the calls.", "url": "https://github.com/redhataccess/pantheon/pull/393#discussion_r536172287", "createdAt": "2020-12-04T15:17:03Z", "author": {"login": "benradey"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/model/api/Child.java", "diffHunk": "@@ -37,28 +41,92 @@\n      * Indicates if the child exists.\n      * @return True, if the child exists. False otherwise.\n      */\n-    boolean isPresent();\n+    default boolean isPresent() {\n+        return get() != null;\n+    }\n \n     /**\n-     * Provides a null-safe way to operate on the value of the child, and return an\n-     * {@link Optional} with the result of the operation. This allowes the caller to\n-     * continue to operate in a null-safe fashion.\n-     * @param func The function to apply to the value\n+     * Convert this Child to an {@link Optional}\n+     * @return An {@link Optional} with the contained value.\n+     */\n+    default Optional<T> asOptional() {\n+        return Optional.ofNullable(get());\n+    }\n+\n+    /**\n+     * Navigates to the {@link Child} provided by an accessor function.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ead9c636484d33d92ff39c1530a4c7820250480"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2NDMyOTM0OnYy", "diffSide": "RIGHT", "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/model/api/Child.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNToxODoxNlrOH_VarQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNToxODoxNlrOH_VarQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE3MzIyOQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(isPresent()) {\n          \n          \n            \n                    if(isPresent()) {  // <-- Applies to the parent (aka the current node in navigation)", "url": "https://github.com/redhataccess/pantheon/pull/393#discussion_r536173229", "createdAt": "2020-12-04T15:18:16Z", "author": {"login": "benradey"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/model/api/Child.java", "diffHunk": "@@ -37,28 +41,92 @@\n      * Indicates if the child exists.\n      * @return True, if the child exists. False otherwise.\n      */\n-    boolean isPresent();\n+    default boolean isPresent() {\n+        return get() != null;\n+    }\n \n     /**\n-     * Provides a null-safe way to operate on the value of the child, and return an\n-     * {@link Optional} with the result of the operation. This allowes the caller to\n-     * continue to operate in a null-safe fashion.\n-     * @param func The function to apply to the value\n+     * Convert this Child to an {@link Optional}\n+     * @return An {@link Optional} with the contained value.\n+     */\n+    default Optional<T> asOptional() {\n+        return Optional.ofNullable(get());\n+    }\n+\n+    /**\n+     * Navigates to the {@link Child} provided by an accessor function.\n+     * @param childAccessor A function which given a {@link SlingModel} type, will\n+     *                      yield a child\n      * @param <R>\n-     * @return An optional indicating the result of the operation. If the operation\n-     * returns null, or if the value of this child was not present in the first place,\n-     * this returns an empty Optional\n-     * @deprecated Use {@link ResourceTraversal#traverseFrom(SlingModel)}\n-     * for safe resource traversals\n+     * @return A {@link Child} (may be non-existent) as indicated by the accessor.\n      */\n-    @Deprecated\n-    <R> Optional<R> map(Function<? super T, ? extends R> func);\n+    default <R extends SlingModel> Child<R> toChild(Function<? super T, Child<R>> childAccessor) {\n+        if(isPresent()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ead9c636484d33d92ff39c1530a4c7820250480"}, "originalPosition": 71}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 204, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}