{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4MDc3NDAw", "number": 265, "title": " CCS-3494: API endpoint for Hydra to send acknowledgement", "bodyText": "This PR is for CCS-3494. It implements the following functionality:\n\nTo make the API consistent the endpoint is be /api/status.\nThe request would be POST and no path param would be needed.\nThe request body would be: {\"id\":\"$UUID\", \"status\": \"$status\", \"message\": \"Some helpful information\", \"sender\": \"hydra\" }\nSaving of acknowledgement is supported, ATM, only for en_US locale\nThe acknowledgement is saved as a node named status that would be sibling to metadata node.\nIf a new request comes with same UUID, the existing node data would be updated.", "createdAt": "2020-04-03T09:57:59Z", "url": "https://github.com/redhataccess/pantheon/pull/265", "merged": true, "mergeCommit": {"oid": "64a40515f3cbfedb56000e7b05561e44ef7b4af1"}, "closed": true, "closedAt": "2020-04-07T15:21:24Z", "author": {"login": "aprajshekhar"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcT90kIAH2gAyMzk4MDc3NDAwOmM0OGNmNGRjYWFkOTkyNDRkYmJiOWFkODYyYzkxZjlkMzllM2VhNjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVULphgFqTM4OTE3NDAzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c48cf4dcaad99244dbbb9ad862c91f9d39e3ea65", "author": {"user": {"login": "aprajshekhar", "name": "A.P.Rajshekhar"}}, "url": "https://github.com/redhataccess/pantheon/commit/c48cf4dcaad99244dbbb9ad862c91f9d39e3ea65", "committedDate": "2020-04-03T09:52:16Z", "message": " CCS-3494: API endpoint for Hydra to send acknowledgement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee391fd70e011aa5d0c251e8f094eb27c81dee07", "author": {"user": {"login": "aprajshekhar", "name": "A.P.Rajshekhar"}}, "url": "https://github.com/redhataccess/pantheon/commit/ee391fd70e011aa5d0c251e8f094eb27c81dee07", "committedDate": "2020-04-03T10:05:45Z", "message": " CCS-3494: API endpoint for Hydra to send acknowledgement. Adding files into git"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MTY5Njg2", "url": "https://github.com/redhataccess/pantheon/pull/265#pullrequestreview-387169686", "createdAt": "2020-04-03T11:21:51Z", "commit": {"oid": "ee391fd70e011aa5d0c251e8f094eb27c81dee07"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMToyMTo1MVrOGARU9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMToyMTo1MVrOGARU9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkzNzA3Ng==", "bodyText": "I wonder if this method (which is generic enough to be useful in other places) would be better suited to live in the JcrQueryHelper class.", "url": "https://github.com/redhataccess/pantheon/pull/265#discussion_r402937076", "createdAt": "2020-04-03T11:21:51Z", "author": {"login": "carlosmunoz"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/StatusAcknowledgeServlet.java", "diffHunk": "@@ -0,0 +1,154 @@\n+package com.redhat.pantheon.servlet;\n+\n+import com.redhat.pantheon.model.Acknowledgement;\n+import com.redhat.pantheon.model.module.Module;\n+import com.redhat.pantheon.model.module.Status;\n+import com.redhat.pantheon.helper.TransformToPojo;\n+import org.apache.commons.lang3.LocaleUtils;\n+import org.apache.sling.api.SlingHttpServletRequest;\n+import org.apache.sling.api.SlingHttpServletResponse;\n+import org.apache.sling.api.resource.PersistenceException;\n+import org.apache.sling.api.resource.Resource;\n+import org.apache.sling.api.servlets.HttpConstants;\n+import org.apache.sling.api.servlets.SlingAllMethodsServlet;\n+import org.apache.sling.servlets.annotations.SlingServletPaths;\n+import org.jetbrains.annotations.NotNull;\n+import org.osgi.framework.Constants;\n+import org.osgi.service.component.annotations.Component;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.jcr.Node;\n+import javax.jcr.RepositoryException;\n+import javax.jcr.Session;\n+import javax.servlet.Servlet;\n+import javax.servlet.ServletException;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+\n+import static org.apache.sling.query.SlingQuery.$;\n+\n+/**\n+ * Simple servlet that saves the status acknowledgement send by\n+ * an endsystem to a status node\n+ *\n+ * @author A.P.Rajshekhar\n+ */\n+@Component(\n+        service = Servlet.class,\n+        property = {\n+                Constants.SERVICE_DESCRIPTION +\"=Servlet which accepts acknowledgement and status for a published Module\",\n+                \"sling.servlet.methods=\" + HttpConstants.METHOD_POST,\n+                Constants.SERVICE_VENDOR + \"=Red Hat Content Tooling team\"\n+        }\n+)\n+@SlingServletPaths(value = \"/api/status\")\n+public class StatusAcknowledgeServlet extends SlingAllMethodsServlet {\n+    private final Logger logger = LoggerFactory.getLogger(StatusAcknowledgeServlet.class);\n+    @Override\n+    protected void doPost(@NotNull SlingHttpServletRequest request, @NotNull SlingHttpServletResponse response) throws ServletException, IOException {\n+\n+        Acknowledgement acknowledgement = getAcknowledgementData(request);\n+\n+        if(isObjectNullOrEmpty(acknowledgement)){\n+            getLogger().error(\"The request did not provide all the fiields \"+acknowledgement.toString());\n+            response.sendError(HttpServletResponse.SC_BAD_REQUEST, \"All the fields are required\");\n+            return;\n+        }\n+        try {\n+            Resource resource = getResourceByUuid(acknowledgement.getId(), request);\n+            Module module =  resource.adaptTo(Module.class);\n+            List<Resource> moduleLocale =  $(module).find(\"pant:moduleLocale\").asList();\n+\n+            if(!hasLocale(moduleLocale, \"en_US\")){\n+                getLogger().error(\"The module with id=\"+acknowledgement.getId()+\" does not have en_US locale\");\n+                response.sendError(HttpServletResponse.SC_BAD_REQUEST, \"Locale other than en_US is not supported\");\n+                return;\n+            }\n+            processAcknowledgementRequest(acknowledgement, module, moduleLocale);\n+\n+        } catch (RepositoryException|PersistenceException e) {\n+            getLogger().error(\"The request could not be processed because of error=\"+e.getMessage(), e);\n+            response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR, e.getMessage());\n+        }\n+    }\n+\n+    /**\n+     *  Checks whether all the fields are present\n+     * @param acknowledgement the acknowledement object containing request data\n+     * @return true if not all fields have data else return false\n+     */\n+    private boolean isObjectNullOrEmpty(Acknowledgement acknowledgement) {\n+        return null == acknowledgement ||\n+                Stream.of(acknowledgement.getId(), acknowledgement.getMessage(),\n+                        acknowledgement.getSender(),acknowledgement.getStatus())\n+                        .anyMatch(Objects::isNull);\n+    }\n+\n+    /**\n+     * Process the data in acknowldegment and create node if the module\n+     * for which the acknowledgement has data contains supported locale\n+     * @param acknowledgement request data\n+     * @param module module corresponding to the UUID in the request data\n+     * @param moduleLocale list of locales in the module\n+     * @throws PersistenceException signals that request data could not be saved\n+     */\n+    private void processAcknowledgementRequest(Acknowledgement acknowledgement, Module module,\n+                                               List<Resource> moduleLocale) throws PersistenceException {\n+\n+        for (Resource locale : moduleLocale) {\n+            //defensive programming: double check that only for en_US locale the status node is created\n+            if(locale.getName().equalsIgnoreCase(\"en_US\")) {\n+                createStatusNode(locale, module, acknowledgement);\n+                break;\n+            }\n+        }\n+    }\n+\n+    private boolean hasLocale(List<Resource> moduleLocale, String locale) {\n+        return moduleLocale.stream().anyMatch(ml -> ml.getName().equalsIgnoreCase(locale));\n+    }\n+\n+    private Acknowledgement getAcknowledgementData(@NotNull SlingHttpServletRequest request) throws IOException {\n+        TransformToPojo transformToPojo = new TransformToPojo();\n+        return transformToPojo.fromJson(Acknowledgement.class, request.getReader());\n+    }\n+\n+    private void createStatusNode(Resource moduleLocale, Module module, Acknowledgement acknowledgement) throws PersistenceException {\n+        Locale locale = LocaleUtils.toLocale(moduleLocale.getName());\n+        Status status = module.getReleasedVersion(locale).get().status().getOrCreate();\n+        status.status().set(acknowledgement.getStatus());\n+        status.message().set(acknowledgement.getMessage());\n+        status.sender().set(acknowledgement.getSender());\n+        status.getResourceResolver().commit();\n+    }\n+\n+    /**\n+     * Retrieves the module corresponding to the uuid\n+     * @param uuid id of the module\n+     * @param request sling request\n+     * @return resource correponding to the uuid\n+     * @throws RepositoryException\n+     */\n+    private Resource getResourceByUuid(String uuid, SlingHttpServletRequest request) throws RepositoryException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee391fd70e011aa5d0c251e8f094eb27c81dee07"}, "originalPosition": 137}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MTcxOTcz", "url": "https://github.com/redhataccess/pantheon/pull/265#pullrequestreview-387171973", "createdAt": "2020-04-03T11:25:54Z", "commit": {"oid": "ee391fd70e011aa5d0c251e8f094eb27c81dee07"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMToyNTo1NFrOGARcWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMToyNTo1NFrOGARcWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkzODk3MA==", "bodyText": "I wonder if this dependency should be provided and added instead to the provisioning files in the pantheon-slingstart maven module. I think it's already an OSGI bundle.", "url": "https://github.com/redhataccess/pantheon/pull/265#discussion_r402938970", "createdAt": "2020-04-03T11:25:54Z", "author": {"login": "carlosmunoz"}, "path": "pantheon-bundle/pom.xml", "diffHunk": "@@ -287,6 +287,11 @@\n             <groupId>org.apache.activemq</groupId>\n             <artifactId>activemq-client</artifactId>\n             <version>5.15.11</version>\n+        </dependency>\n+        <dependency>\n+            <groupId>org.apache.sling</groupId>\n+            <artifactId>org.apache.sling.query</artifactId>\n+            <version>3.0.0</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee391fd70e011aa5d0c251e8f094eb27c81dee07"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4ODEzNjk2", "url": "https://github.com/redhataccess/pantheon/pull/265#pullrequestreview-388813696", "createdAt": "2020-04-07T06:21:40Z", "commit": {"oid": "ee391fd70e011aa5d0c251e8f094eb27c81dee07"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NTY0Mzg0", "url": "https://github.com/redhataccess/pantheon/pull/265#pullrequestreview-388564384", "createdAt": "2020-04-06T19:47:06Z", "commit": {"oid": "ee391fd70e011aa5d0c251e8f094eb27c81dee07"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxOTo0NzowNlrOGBnRLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMDowMDo0NFrOGBnunQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM0NTEzMg==", "bodyText": "This Servlet accepts acknowlegement and status for both publish and unpublish actions", "url": "https://github.com/redhataccess/pantheon/pull/265#discussion_r404345132", "createdAt": "2020-04-06T19:47:06Z", "author": {"login": "xdavidson"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/StatusAcknowledgeServlet.java", "diffHunk": "@@ -0,0 +1,154 @@\n+package com.redhat.pantheon.servlet;\n+\n+import com.redhat.pantheon.model.Acknowledgement;\n+import com.redhat.pantheon.model.module.Module;\n+import com.redhat.pantheon.model.module.Status;\n+import com.redhat.pantheon.helper.TransformToPojo;\n+import org.apache.commons.lang3.LocaleUtils;\n+import org.apache.sling.api.SlingHttpServletRequest;\n+import org.apache.sling.api.SlingHttpServletResponse;\n+import org.apache.sling.api.resource.PersistenceException;\n+import org.apache.sling.api.resource.Resource;\n+import org.apache.sling.api.servlets.HttpConstants;\n+import org.apache.sling.api.servlets.SlingAllMethodsServlet;\n+import org.apache.sling.servlets.annotations.SlingServletPaths;\n+import org.jetbrains.annotations.NotNull;\n+import org.osgi.framework.Constants;\n+import org.osgi.service.component.annotations.Component;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import javax.jcr.Node;\n+import javax.jcr.RepositoryException;\n+import javax.jcr.Session;\n+import javax.servlet.Servlet;\n+import javax.servlet.ServletException;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+\n+import static org.apache.sling.query.SlingQuery.$;\n+\n+/**\n+ * Simple servlet that saves the status acknowledgement send by\n+ * an endsystem to a status node\n+ *\n+ * @author A.P.Rajshekhar\n+ */\n+@Component(\n+        service = Servlet.class,\n+        property = {\n+                Constants.SERVICE_DESCRIPTION +\"=Servlet which accepts acknowledgement and status for a published Module\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee391fd70e011aa5d0c251e8f094eb27c81dee07"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM1MTA3NQ==", "bodyText": "it's interesting you use \"pant:hash\" instead of \"jcr:uuid\". To keep things consistent, can you rename it to be \"jcr:uuid\"?", "url": "https://github.com/redhataccess/pantheon/pull/265#discussion_r404351075", "createdAt": "2020-04-06T19:57:51Z", "author": {"login": "xdavidson"}, "path": "pantheon-bundle/src/test/java/com/redhat/pantheon/servlet/StatusAcknowledgementServletTest.java", "diffHunk": "@@ -0,0 +1,143 @@\n+package com.redhat.pantheon.servlet;\n+\n+import com.redhat.pantheon.model.api.SlingModels;\n+import com.redhat.pantheon.model.module.Module;\n+import org.apache.commons.lang3.LocaleUtils;\n+import org.apache.sling.api.resource.ModifiableValueMap;\n+import org.apache.sling.testing.mock.sling.ResourceResolverType;\n+import org.apache.sling.testing.mock.sling.junit5.SlingContext;\n+import org.apache.sling.testing.mock.sling.junit5.SlingContextExtension;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import javax.servlet.ServletException;\n+import java.io.IOException;\n+import java.nio.charset.Charset;\n+\n+import static com.redhat.pantheon.util.TestUtils.registerMockAdapter;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+\n+@ExtendWith({SlingContextExtension.class})\n+public class StatusAcknowledgementServletTest {\n+    SlingContext slingContext = new SlingContext(ResourceResolverType.JCR_OAK);\n+    String testHTML = \"<!DOCTYPE html> <html lang=\\\"en\\\"> <head><title>test title</title></head> <body \" +\n+            \"class=\\\"article\\\"><h1>test title</h1> </header> </body> </html>\";\n+\n+    @BeforeEach\n+    public void setUp(){\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module\",\n+                        \"jcr:primaryType\", \"pant:module\", \"pant:hash\",\"3815bd73-3d57-41d5-9300-9726fdd0f4b7\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee391fd70e011aa5d0c251e8f094eb27c81dee07"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM1MTc0Ng==", "bodyText": "Here is another pant:hash instead of \"jcr:uuid\"", "url": "https://github.com/redhataccess/pantheon/pull/265#discussion_r404351746", "createdAt": "2020-04-06T19:59:03Z", "author": {"login": "xdavidson"}, "path": "pantheon-bundle/src/test/java/com/redhat/pantheon/servlet/StatusAcknowledgementServletTest.java", "diffHunk": "@@ -0,0 +1,143 @@\n+package com.redhat.pantheon.servlet;\n+\n+import com.redhat.pantheon.model.api.SlingModels;\n+import com.redhat.pantheon.model.module.Module;\n+import org.apache.commons.lang3.LocaleUtils;\n+import org.apache.sling.api.resource.ModifiableValueMap;\n+import org.apache.sling.testing.mock.sling.ResourceResolverType;\n+import org.apache.sling.testing.mock.sling.junit5.SlingContext;\n+import org.apache.sling.testing.mock.sling.junit5.SlingContextExtension;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import javax.servlet.ServletException;\n+import java.io.IOException;\n+import java.nio.charset.Charset;\n+\n+import static com.redhat.pantheon.util.TestUtils.registerMockAdapter;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+\n+@ExtendWith({SlingContextExtension.class})\n+public class StatusAcknowledgementServletTest {\n+    SlingContext slingContext = new SlingContext(ResourceResolverType.JCR_OAK);\n+    String testHTML = \"<!DOCTYPE html> <html lang=\\\"en\\\"> <head><title>test title</title></head> <body \" +\n+            \"class=\\\"article\\\"><h1>test title</h1> </header> </body> </html>\";\n+\n+    @BeforeEach\n+    public void setUp(){\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module\",\n+                        \"jcr:primaryType\", \"pant:module\", \"pant:hash\",\"3815bd73-3d57-41d5-9300-9726fdd0f4b7\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US\",\n+                        \"jcr:primaryType\", \"pant:moduleLocale\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US/1\",\n+                        \"jcr:primaryType\", \"pant:moduleVersion\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US/1/metadata\",\n+                        \"jcr:title\", \"A title\",\n+                        \"jcr:description\", \"A description\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US/1/content/asciidoc\",\n+                        \"jcr:content\", testHTML);\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US/1/content/cachedHtml\",\n+                        \"jcr:data\", testHTML,\n+                        \"pant:hash\", \"3815bd73-3d57-41d5-9300-9726fdd0f4b7\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee391fd70e011aa5d0c251e8f094eb27c81dee07"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM1MjQ5Mw==", "bodyText": "another \"pant:hash\" instead of \"jcr:uuid\"", "url": "https://github.com/redhataccess/pantheon/pull/265#discussion_r404352493", "createdAt": "2020-04-06T20:00:24Z", "author": {"login": "xdavidson"}, "path": "pantheon-bundle/src/test/java/com/redhat/pantheon/servlet/StatusAcknowledgementServletTest.java", "diffHunk": "@@ -0,0 +1,143 @@\n+package com.redhat.pantheon.servlet;\n+\n+import com.redhat.pantheon.model.api.SlingModels;\n+import com.redhat.pantheon.model.module.Module;\n+import org.apache.commons.lang3.LocaleUtils;\n+import org.apache.sling.api.resource.ModifiableValueMap;\n+import org.apache.sling.testing.mock.sling.ResourceResolverType;\n+import org.apache.sling.testing.mock.sling.junit5.SlingContext;\n+import org.apache.sling.testing.mock.sling.junit5.SlingContextExtension;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import javax.servlet.ServletException;\n+import java.io.IOException;\n+import java.nio.charset.Charset;\n+\n+import static com.redhat.pantheon.util.TestUtils.registerMockAdapter;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+\n+@ExtendWith({SlingContextExtension.class})\n+public class StatusAcknowledgementServletTest {\n+    SlingContext slingContext = new SlingContext(ResourceResolverType.JCR_OAK);\n+    String testHTML = \"<!DOCTYPE html> <html lang=\\\"en\\\"> <head><title>test title</title></head> <body \" +\n+            \"class=\\\"article\\\"><h1>test title</h1> </header> </body> </html>\";\n+\n+    @BeforeEach\n+    public void setUp(){\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module\",\n+                        \"jcr:primaryType\", \"pant:module\", \"pant:hash\",\"3815bd73-3d57-41d5-9300-9726fdd0f4b7\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US\",\n+                        \"jcr:primaryType\", \"pant:moduleLocale\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US/1\",\n+                        \"jcr:primaryType\", \"pant:moduleVersion\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US/1/metadata\",\n+                        \"jcr:title\", \"A title\",\n+                        \"jcr:description\", \"A description\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US/1/content/asciidoc\",\n+                        \"jcr:content\", testHTML);\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US/1/content/cachedHtml\",\n+                        \"jcr:data\", testHTML,\n+                        \"pant:hash\", \"3815bd73-3d57-41d5-9300-9726fdd0f4b7\");\n+\n+        slingContext.resourceResolver().getResource(\"/content/repositories/repo/module/en_US\").adaptTo(ModifiableValueMap.class)\n+                .put(\"released\", slingContext.resourceResolver().getResource(\"/content/repositories/repo/module/en_US/1\").getValueMap()\n+                        .get(\"jcr:uuid\"));\n+        registerMockAdapter(Module.class, slingContext);\n+    }\n+    @Test\n+    public void testAddAcknowledgement() throws ServletException, IOException {\n+\n+        String resourceUuid = slingContext.resourceResolver()\n+                .getResource(\"/content/repositories/repo/module\")\n+                .getValueMap()\n+                .get(\"jcr:uuid\")\n+                .toString();\n+\n+        Charset utf8 = Charset.forName(\"UTF-8\");\n+        String data = \"{\\\"id\\\":\\\"\"+resourceUuid+\"\\\",\\\"status\\\": \\\"received\\\",\\\"sender\\\":\\\"hydra\\\",\\\"message\\\":\\\"from hydra\\\"}\";\n+        slingContext.request().setContent(data.getBytes(utf8));\n+        StatusAcknowledgeServlet statusAcknowledgeServlet = new StatusAcknowledgeServlet();\n+        statusAcknowledgeServlet.doPost(slingContext.request(), slingContext.response());\n+        Assertions.assertEquals(200, slingContext.response().getStatus(), \"Status should be 200\");\n+        Module module =\n+                SlingModels.getModel(\n+                        slingContext.resourceResolver().getResource(\"/content/repositories/repo/module\"),\n+                        Module.class);\n+        assertNotNull(module.getReleasedVersion(LocaleUtils.toLocale(\"en_US\")).get().status().get());\n+        assertEquals(\"received\", module.getReleasedVersion(LocaleUtils.toLocale(\"en_US\"))\n+                .get().status()\n+                .get().status().get());\n+        assertEquals(\"from hydra\", module.getReleasedVersion(LocaleUtils.toLocale(\"en_US\")).get().status().get().message().get());\n+        assertEquals(\"hydra\", module.getReleasedVersion(LocaleUtils.toLocale(\"en_US\")).get().status().get().sender().get());\n+    }\n+\n+    @Test\n+    public void testAddAcknowledgementWithoutRequiredFields() throws ServletException, IOException {\n+\n+        String resourceUuid = slingContext.resourceResolver()\n+                .getResource(\"/content/repositories/repo/module\")\n+                .getValueMap()\n+                .get(\"jcr:uuid\")\n+                .toString();\n+\n+        Charset utf8 = Charset.forName(\"UTF-8\");\n+        String data = \"{\\\"id\\\":\\\"\" + resourceUuid + \"\\\",\\\"status\\\": \\\"received\\\",\\\"sender\\\":\\\"hydra\\\"}\";\n+        slingContext.request().setContent(data.getBytes(utf8));\n+        StatusAcknowledgeServlet statusAcknowledgeServlet = new StatusAcknowledgeServlet();\n+        statusAcknowledgeServlet.doPost(slingContext.request(), slingContext.response());\n+        Assertions.assertEquals( 400, slingContext.response().getStatus(), \"Status should be 400\");\n+    }\n+\n+    @Test\n+    public void testAddAcknowledgementWhenTheLocaleIsNotSupported() throws ServletException, IOException {\n+\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module1\",\n+                        \"jcr:primaryType\", \"pant:module\", \"pant:hash\",\"3815bd73-3d57-41d5-9300-9726fdd0f4b7\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee391fd70e011aa5d0c251e8f094eb27c81dee07"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM1MjY2OQ==", "bodyText": "\"pant:hash\" instead of \"jcr:uuid\"", "url": "https://github.com/redhataccess/pantheon/pull/265#discussion_r404352669", "createdAt": "2020-04-06T20:00:44Z", "author": {"login": "xdavidson"}, "path": "pantheon-bundle/src/test/java/com/redhat/pantheon/servlet/StatusAcknowledgementServletTest.java", "diffHunk": "@@ -0,0 +1,143 @@\n+package com.redhat.pantheon.servlet;\n+\n+import com.redhat.pantheon.model.api.SlingModels;\n+import com.redhat.pantheon.model.module.Module;\n+import org.apache.commons.lang3.LocaleUtils;\n+import org.apache.sling.api.resource.ModifiableValueMap;\n+import org.apache.sling.testing.mock.sling.ResourceResolverType;\n+import org.apache.sling.testing.mock.sling.junit5.SlingContext;\n+import org.apache.sling.testing.mock.sling.junit5.SlingContextExtension;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import javax.servlet.ServletException;\n+import java.io.IOException;\n+import java.nio.charset.Charset;\n+\n+import static com.redhat.pantheon.util.TestUtils.registerMockAdapter;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+\n+@ExtendWith({SlingContextExtension.class})\n+public class StatusAcknowledgementServletTest {\n+    SlingContext slingContext = new SlingContext(ResourceResolverType.JCR_OAK);\n+    String testHTML = \"<!DOCTYPE html> <html lang=\\\"en\\\"> <head><title>test title</title></head> <body \" +\n+            \"class=\\\"article\\\"><h1>test title</h1> </header> </body> </html>\";\n+\n+    @BeforeEach\n+    public void setUp(){\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module\",\n+                        \"jcr:primaryType\", \"pant:module\", \"pant:hash\",\"3815bd73-3d57-41d5-9300-9726fdd0f4b7\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US\",\n+                        \"jcr:primaryType\", \"pant:moduleLocale\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US/1\",\n+                        \"jcr:primaryType\", \"pant:moduleVersion\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US/1/metadata\",\n+                        \"jcr:title\", \"A title\",\n+                        \"jcr:description\", \"A description\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US/1/content/asciidoc\",\n+                        \"jcr:content\", testHTML);\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module/en_US/1/content/cachedHtml\",\n+                        \"jcr:data\", testHTML,\n+                        \"pant:hash\", \"3815bd73-3d57-41d5-9300-9726fdd0f4b7\");\n+\n+        slingContext.resourceResolver().getResource(\"/content/repositories/repo/module/en_US\").adaptTo(ModifiableValueMap.class)\n+                .put(\"released\", slingContext.resourceResolver().getResource(\"/content/repositories/repo/module/en_US/1\").getValueMap()\n+                        .get(\"jcr:uuid\"));\n+        registerMockAdapter(Module.class, slingContext);\n+    }\n+    @Test\n+    public void testAddAcknowledgement() throws ServletException, IOException {\n+\n+        String resourceUuid = slingContext.resourceResolver()\n+                .getResource(\"/content/repositories/repo/module\")\n+                .getValueMap()\n+                .get(\"jcr:uuid\")\n+                .toString();\n+\n+        Charset utf8 = Charset.forName(\"UTF-8\");\n+        String data = \"{\\\"id\\\":\\\"\"+resourceUuid+\"\\\",\\\"status\\\": \\\"received\\\",\\\"sender\\\":\\\"hydra\\\",\\\"message\\\":\\\"from hydra\\\"}\";\n+        slingContext.request().setContent(data.getBytes(utf8));\n+        StatusAcknowledgeServlet statusAcknowledgeServlet = new StatusAcknowledgeServlet();\n+        statusAcknowledgeServlet.doPost(slingContext.request(), slingContext.response());\n+        Assertions.assertEquals(200, slingContext.response().getStatus(), \"Status should be 200\");\n+        Module module =\n+                SlingModels.getModel(\n+                        slingContext.resourceResolver().getResource(\"/content/repositories/repo/module\"),\n+                        Module.class);\n+        assertNotNull(module.getReleasedVersion(LocaleUtils.toLocale(\"en_US\")).get().status().get());\n+        assertEquals(\"received\", module.getReleasedVersion(LocaleUtils.toLocale(\"en_US\"))\n+                .get().status()\n+                .get().status().get());\n+        assertEquals(\"from hydra\", module.getReleasedVersion(LocaleUtils.toLocale(\"en_US\")).get().status().get().message().get());\n+        assertEquals(\"hydra\", module.getReleasedVersion(LocaleUtils.toLocale(\"en_US\")).get().status().get().sender().get());\n+    }\n+\n+    @Test\n+    public void testAddAcknowledgementWithoutRequiredFields() throws ServletException, IOException {\n+\n+        String resourceUuid = slingContext.resourceResolver()\n+                .getResource(\"/content/repositories/repo/module\")\n+                .getValueMap()\n+                .get(\"jcr:uuid\")\n+                .toString();\n+\n+        Charset utf8 = Charset.forName(\"UTF-8\");\n+        String data = \"{\\\"id\\\":\\\"\" + resourceUuid + \"\\\",\\\"status\\\": \\\"received\\\",\\\"sender\\\":\\\"hydra\\\"}\";\n+        slingContext.request().setContent(data.getBytes(utf8));\n+        StatusAcknowledgeServlet statusAcknowledgeServlet = new StatusAcknowledgeServlet();\n+        statusAcknowledgeServlet.doPost(slingContext.request(), slingContext.response());\n+        Assertions.assertEquals( 400, slingContext.response().getStatus(), \"Status should be 400\");\n+    }\n+\n+    @Test\n+    public void testAddAcknowledgementWhenTheLocaleIsNotSupported() throws ServletException, IOException {\n+\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module1\",\n+                        \"jcr:primaryType\", \"pant:module\", \"pant:hash\",\"3815bd73-3d57-41d5-9300-9726fdd0f4b7\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module1/es_ES\",\n+                        \"jcr:primaryType\", \"pant:moduleLocale\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module1/es_ES/1\",\n+                        \"jcr:primaryType\", \"pant:moduleVersion\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module1/es_ES/1/metadata\",\n+                        \"jcr:title\", \"A title\",\n+                        \"jcr:description\", \"A description\");\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module1/es_ES/1/content/asciidoc\",\n+                        \"jcr:content\", testHTML);\n+        slingContext.create()\n+                .resource(\"/content/repositories/repo/module1/es_ES/1/content/cachedHtml\",\n+                        \"jcr:data\", testHTML,\n+                        \"pant:hash\", \"3815bd73-3d57-41d5-9300-9726fdd0f4b7\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee391fd70e011aa5d0c251e8f094eb27c81dee07"}, "originalPosition": 123}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a6c57187e84dc38a3e7904281215688254e41d8", "author": {"user": {"login": "aprajshekhar", "name": "A.P.Rajshekhar"}}, "url": "https://github.com/redhataccess/pantheon/commit/6a6c57187e84dc38a3e7904281215688254e41d8", "committedDate": "2020-04-07T13:46:28Z", "message": " CCS-3494: API endpoint for Hydra to send acknowledgement. Code review changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MTc0MDMy", "url": "https://github.com/redhataccess/pantheon/pull/265#pullrequestreview-389174032", "createdAt": "2020-04-07T14:29:19Z", "commit": {"oid": "6a6c57187e84dc38a3e7904281215688254e41d8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2087, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}