{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMzQ4MTc3", "number": 361, "title": "CCS-3683) unable to publish module when logged in as a demo user", "bodyText": "Publish / unpublish operation should not be allowed by user other than publisher.", "createdAt": "2020-08-05T12:20:56Z", "url": "https://github.com/redhataccess/pantheon/pull/361", "merged": true, "mergeCommit": {"oid": "8f553071b4ddeef88c53a1dfc8256342edfa0a99"}, "closed": true, "closedAt": "2020-08-05T13:26:08Z", "author": {"login": "rednitish"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5uBRJgH2gAyNDYzMzQ4MTc3OjY1ZDBiMWI1ZDI0MWI0YjU4NDZiODJkNTBjYzFhNzYxY2Y4YTY1M2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc77KRdAFqTQ2MTY1ODcwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "65d0b1b5d241b4b5846b82d50cc1a761cf8a653e", "author": {"user": {"login": "rednitish", "name": "Nitish Sharma"}}, "url": "https://github.com/redhataccess/pantheon/commit/65d0b1b5d241b4b5846b82d50cc1a761cf8a653e", "committedDate": "2020-07-29T16:56:47Z", "message": "PnT JIRA (CCS-3683) unable to publish module when logged in as a demo user"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0995302e7f46cbf30523ddc222649c38ba3d66f4", "author": {"user": {"login": "rednitish", "name": "Nitish Sharma"}}, "url": "https://github.com/redhataccess/pantheon/commit/0995302e7f46cbf30523ddc222649c38ba3d66f4", "committedDate": "2020-07-30T10:38:10Z", "message": "Fix: resoure resolver closed with try with resource block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a44de84898cf20f93ad8ad518cd5507b285893dc", "author": {"user": {"login": "rednitish", "name": "Nitish Sharma"}}, "url": "https://github.com/redhataccess/pantheon/commit/a44de84898cf20f93ad8ad518cd5507b285893dc", "committedDate": "2020-07-30T10:55:45Z", "message": "Fix: resoure resolver closed with try with resource block : review comments from AP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f19c98d18b0c32d126f8468c70d1ec20261f86bc", "author": {"user": {"login": "rednitish", "name": "Nitish Sharma"}}, "url": "https://github.com/redhataccess/pantheon/commit/f19c98d18b0c32d126f8468c70d1ec20261f86bc", "committedDate": "2020-08-04T11:24:52Z", "message": "Merge remote-tracking branch 'refs/remotes/upstream/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e53a109270b7b7be55c6ab3eba329802165ecb92", "author": {"user": {"login": "rednitish", "name": "Nitish Sharma"}}, "url": "https://github.com/redhataccess/pantheon/commit/e53a109270b7b7be55c6ab3eba329802165ecb92", "committedDate": "2020-08-05T11:50:15Z", "message": "demo user publish allowed by other users"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2bce6698660c7eb41eb86efd892d9d4ceb5aa22", "author": {"user": {"login": "rednitish", "name": "Nitish Sharma"}}, "url": "https://github.com/redhataccess/pantheon/commit/b2bce6698660c7eb41eb86efd892d9d4ceb5aa22", "committedDate": "2020-08-05T12:17:37Z", "message": "unpublish by user other than publishers should not be allowed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNjExMTg2", "url": "https://github.com/redhataccess/pantheon/pull/361#pullrequestreview-461611186", "createdAt": "2020-08-05T12:23:09Z", "commit": {"oid": "b2bce6698660c7eb41eb86efd892d9d4ceb5aa22"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMjoyMzowOVrOG8HRNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMjoyNDowNFrOG8HTCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY4NjgzNw==", "bodyText": "Why Boolean and not boolean is being used?", "url": "https://github.com/redhataccess/pantheon/pull/361#discussion_r465686837", "createdAt": "2020-08-05T12:23:09Z", "author": {"login": "aprajshekhar"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/module/PublishDraftVersion.java", "diffHunk": "@@ -92,11 +99,23 @@ public void run(SlingHttpServletRequest request, PostResponse response, SlingPos\n     @Override\n     protected void doRun(SlingHttpServletRequest request, PostResponse response, List<Modification> changes) throws  RepositoryException{\n         try {\n-            ResourceResolver serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver();\n+            Boolean canPublish = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2bce6698660c7eb41eb86efd892d9d4ceb5aa22"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY4NzMwNg==", "bodyText": "Same as above.", "url": "https://github.com/redhataccess/pantheon/pull/361#discussion_r465687306", "createdAt": "2020-08-05T12:24:04Z", "author": {"login": "aprajshekhar"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/module/UnpublishVersion.java", "diffHunk": "@@ -99,7 +106,20 @@ public void run(SlingHttpServletRequest request, PostResponse response, SlingPos\n     @Override\n     protected void doRun(SlingHttpServletRequest request, PostResponse response, List<Modification> changes) throws RepositoryException{\n         try {\n-            ResourceResolver serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver();\n+            Boolean canUnPublish = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2bce6698660c7eb41eb86efd892d9d4ceb5aa22"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cdcbad34964e4a5388fa8e1d010475baf17b615", "author": {"user": {"login": "rednitish", "name": "Nitish Sharma"}}, "url": "https://github.com/redhataccess/pantheon/commit/3cdcbad34964e4a5388fa8e1d010475baf17b615", "committedDate": "2020-08-05T12:36:30Z", "message": "unpublish by user other than publishers should not be allowed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNjI1OTQ5", "url": "https://github.com/redhataccess/pantheon/pull/361#pullrequestreview-461625949", "createdAt": "2020-08-05T12:43:49Z", "commit": {"oid": "3cdcbad34964e4a5388fa8e1d010475baf17b615"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMjo0Mzo1MFrOG8H-Dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMjo0NDozM1rOG8H_tQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY5ODMxOQ==", "bodyText": "It will be better to break once you set canPublish", "url": "https://github.com/redhataccess/pantheon/pull/361#discussion_r465698319", "createdAt": "2020-08-05T12:43:50Z", "author": {"login": "aprajshekhar"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/module/PublishDraftVersion.java", "diffHunk": "@@ -92,11 +99,23 @@ public void run(SlingHttpServletRequest request, PostResponse response, SlingPos\n     @Override\n     protected void doRun(SlingHttpServletRequest request, PostResponse response, List<Modification> changes) throws  RepositoryException{\n         try {\n-            ResourceResolver serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver();\n+            boolean canPublish = false;\n+            Session session = request.getResourceResolver().adaptTo(Session.class);\n+            UserManager userManager = AccessControlUtil.getUserManager(session);\n+            Iterator<Group> groupIterator = userManager.getAuthorizable(session.getUserID()).memberOf();\n+            while (groupIterator.hasNext()) {\n+                Authorizable group = groupIterator.next();\n+                if (group.isGroup() && PantheonConstants.PANTHEON_PUBLISHERS.equalsIgnoreCase(group.getID())) {\n+                    canPublish = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cdcbad34964e4a5388fa8e1d010475baf17b615"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY5ODc0MQ==", "bodyText": "It will be better to break once you set canPublish as check is done and we have the required state.", "url": "https://github.com/redhataccess/pantheon/pull/361#discussion_r465698741", "createdAt": "2020-08-05T12:44:33Z", "author": {"login": "aprajshekhar"}, "path": "pantheon-bundle/src/main/java/com/redhat/pantheon/servlet/module/UnpublishVersion.java", "diffHunk": "@@ -99,7 +106,20 @@ public void run(SlingHttpServletRequest request, PostResponse response, SlingPos\n     @Override\n     protected void doRun(SlingHttpServletRequest request, PostResponse response, List<Modification> changes) throws RepositoryException{\n         try {\n-            ResourceResolver serviceResourceResolver = serviceResourceResolverProvider.getServiceResourceResolver();\n+            boolean canUnPublish = false;\n+            Session session = request.getResourceResolver().adaptTo(Session.class);\n+            UserManager userManager = AccessControlUtil.getUserManager(session);\n+            Iterator<Group> groupIterator = userManager.getAuthorizable(session.getUserID()).memberOf();\n+            while (groupIterator.hasNext()) {\n+                Authorizable group = groupIterator.next();\n+                if (group.isGroup() && PantheonConstants.PANTHEON_PUBLISHERS.equalsIgnoreCase(group.getID())) {\n+                    canUnPublish = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3cdcbad34964e4a5388fa8e1d010475baf17b615"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea7456d0a9f47a6a2290144c2be69baf0c9628b1", "author": {"user": {"login": "rednitish", "name": "Nitish Sharma"}}, "url": "https://github.com/redhataccess/pantheon/commit/ea7456d0a9f47a6a2290144c2be69baf0c9628b1", "committedDate": "2020-08-05T13:19:57Z", "message": "unpublish by user other than publishers should not be allowed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNjU4NzA2", "url": "https://github.com/redhataccess/pantheon/pull/361#pullrequestreview-461658706", "createdAt": "2020-08-05T13:23:14Z", "commit": {"oid": "ea7456d0a9f47a6a2290144c2be69baf0c9628b1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1979, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}