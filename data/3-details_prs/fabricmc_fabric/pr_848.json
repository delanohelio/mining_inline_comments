{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwODYzMjY4", "number": 848, "title": "Lifecycle Events: Part 2, Electric Boogaloo", "bodyText": "Adds all the some events from #445, thereby superseding it:\n\nServerLifecycleEvents.START_DATA_PACK_RELOAD\nServerLifecycleEvents.END_DATA_PACK_RELOAD\nServerLifecycleEvents.SAVE\n\nAlso adds:\n\nServerWorldEvents.WORLD_LOAD (Called when a world is loaded onto a server)\nServerLifecycleEvents.SERVER_STARTING (Cannot be backported to 1.15 or 1.14 because of dedicated server entrypoint occuring after this).\n\nAlso adds system properties to enable load and unload debug messaging for entity and block entity events (So we can debug the other stuff in peace lol).", "createdAt": "2020-06-27T05:21:29Z", "url": "https://github.com/FabricMC/fabric/pull/848", "merged": true, "mergeCommit": {"oid": "144d3847c09bd5e1c5ac4fde3e60ce3043181799"}, "closed": true, "closedAt": "2020-07-17T13:51:06Z", "author": {"login": "i509VCB"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwwzO5gBqjM1MDQyNDYyMTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1F8SxgFqTQ0ODcxNjg3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c3f4b39ddb6de392f0327c84651c9930cdc00a40", "author": {"user": {"login": "i509VCB", "name": null}}, "url": "https://github.com/FabricMC/fabric/commit/c3f4b39ddb6de392f0327c84651c9930cdc00a40", "committedDate": "2020-06-27T05:15:45Z", "message": "Save event"}, "afterCommit": {"oid": "9fd59207a70b9b5696bce11a7963fa78763e56f8", "author": {"user": {"login": "i509VCB", "name": null}}, "url": "https://github.com/FabricMC/fabric/commit/9fd59207a70b9b5696bce11a7963fa78763e56f8", "committedDate": "2020-07-01T21:05:34Z", "message": "Save event"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjUwMTIw", "url": "https://github.com/FabricMC/fabric/pull/848#pullrequestreview-441250120", "createdAt": "2020-07-01T23:08:32Z", "commit": {"oid": "9fd59207a70b9b5696bce11a7963fa78763e56f8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f3e31c611fe1cb2b3c7a30dcad88dcb7a4f0d72", "author": {"user": {"login": "i509VCB", "name": null}}, "url": "https://github.com/FabricMC/fabric/commit/5f3e31c611fe1cb2b3c7a30dcad88dcb7a4f0d72", "committedDate": "2020-07-09T21:08:38Z", "message": "Add a few new server lifecycle events\n\nServer starting, Load World, Before server resource reload, After server resource reload"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ccbfca50d4192eabc2d1ca81899ae908c1362d8", "author": {"user": {"login": "i509VCB", "name": null}}, "url": "https://github.com/FabricMC/fabric/commit/2ccbfca50d4192eabc2d1ca81899ae908c1362d8", "committedDate": "2020-07-09T21:08:38Z", "message": "Save event"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8f30a142dcc41e961448798a059253240248ab2", "author": {"user": {"login": "i509VCB", "name": null}}, "url": "https://github.com/FabricMC/fabric/commit/b8f30a142dcc41e961448798a059253240248ab2", "committedDate": "2020-07-09T22:21:21Z", "message": "Split world load into ServerWorldEvents, add failure event for data pack reload"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9fd59207a70b9b5696bce11a7963fa78763e56f8", "author": {"user": {"login": "i509VCB", "name": null}}, "url": "https://github.com/FabricMC/fabric/commit/9fd59207a70b9b5696bce11a7963fa78763e56f8", "committedDate": "2020-07-01T21:05:34Z", "message": "Save event"}, "afterCommit": {"oid": "b8f30a142dcc41e961448798a059253240248ab2", "author": {"user": {"login": "i509VCB", "name": null}}, "url": "https://github.com/FabricMC/fabric/commit/b8f30a142dcc41e961448798a059253240248ab2", "committedDate": "2020-07-09T22:21:21Z", "message": "Split world load into ServerWorldEvents, add failure event for data pack reload"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d124329f73633ebf4bb032b186e971004b77cea", "author": {"user": {"login": "i509VCB", "name": null}}, "url": "https://github.com/FabricMC/fabric/commit/4d124329f73633ebf4bb032b186e971004b77cea", "committedDate": "2020-07-09T22:24:13Z", "message": "cause"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8fbd13d2964f5982627e1db07713cf21ea583918", "author": {"user": {"login": "i509VCB", "name": null}}, "url": "https://github.com/FabricMC/fabric/commit/8fbd13d2964f5982627e1db07713cf21ea583918", "committedDate": "2020-07-09T22:23:29Z", "message": "cause"}, "afterCommit": {"oid": "4d124329f73633ebf4bb032b186e971004b77cea", "author": {"user": {"login": "i509VCB", "name": null}}, "url": "https://github.com/FabricMC/fabric/commit/4d124329f73633ebf4bb032b186e971004b77cea", "committedDate": "2020-07-09T22:24:13Z", "message": "cause"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37da944dcce4820477c5542ac1ac6a53bff265c0", "author": {"user": {"login": "i509VCB", "name": null}}, "url": "https://github.com/FabricMC/fabric/commit/37da944dcce4820477c5542ac1ac6a53bff265c0", "committedDate": "2020-07-09T22:55:17Z", "message": "Merge fail and regular end."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74fed6336426fafdbab54205474a381c2115f805", "author": {"user": {"login": "i509VCB", "name": null}}, "url": "https://github.com/FabricMC/fabric/commit/74fed6336426fafdbab54205474a381c2115f805", "committedDate": "2020-07-09T22:57:45Z", "message": "Present tense lol"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9097c148da72e7311ab00635a1d2cad54942e061", "author": {"user": {"login": "i509VCB", "name": null}}, "url": "https://github.com/FabricMC/fabric/commit/9097c148da72e7311ab00635a1d2cad54942e061", "committedDate": "2020-07-09T23:00:50Z", "message": "So we can just plainly specify the system properties"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDIzMjY2", "url": "https://github.com/FabricMC/fabric/pull/848#pullrequestreview-446023266", "createdAt": "2020-07-09T23:01:01Z", "commit": {"oid": "74fed6336426fafdbab54205474a381c2115f805"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDI4Mjc0", "url": "https://github.com/FabricMC/fabric/pull/848#pullrequestreview-446028274", "createdAt": "2020-07-09T23:15:26Z", "commit": {"oid": "9097c148da72e7311ab00635a1d2cad54942e061"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDgxMzM0", "url": "https://github.com/FabricMC/fabric/pull/848#pullrequestreview-446081334", "createdAt": "2020-07-10T02:19:35Z", "commit": {"oid": "9097c148da72e7311ab00635a1d2cad54942e061"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwMjoxOTozNVrOGvntSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwMjoxOTozNVrOGvntSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU4NjgyNQ==", "bodyText": "I highly doubt the function passed to exceptionally runs on completable future's default executor's thread than on the server thread.", "url": "https://github.com/FabricMC/fabric/pull/848#discussion_r452586825", "createdAt": "2020-07-10T02:19:35Z", "author": {"login": "liach"}, "path": "fabric-lifecycle-events-v1/src/main/java/net/fabricmc/fabric/mixin/event/lifecycle/MinecraftServerMixin.java", "diffHunk": "@@ -73,4 +89,33 @@ private void closeWorld(CallbackInfo ci, Iterator<ServerWorld> worlds, ServerWor\n \t\t\tServerBlockEntityEvents.BLOCK_ENTITY_UNLOAD.invoker().onUnload(blockEntity, serverWorld);\n \t\t}\n \t}\n+\n+\t// The locals you have to manage for an inject are insane. And do it twice. A redirect is much cleaner.\n+\t// Here is what it looks like with an inject: https://gist.github.com/i509VCB/f80077cc536eb4dba62b794eba5611c1\n+\t@Redirect(method = \"createWorlds\", at = @At(value = \"INVOKE\", target = \"Ljava/util/Map;put(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;\"))\n+\tprivate <K, V> V onLoadWorld(Map<K, V> worlds, K registryKey, V serverWorld) {\n+\t\tfinal V result = worlds.put(registryKey, serverWorld);\n+\t\tServerWorldEvents.LOAD.invoker().onWorldLoad((MinecraftServer) (Object) this, (ServerWorld) serverWorld);\n+\n+\t\treturn result;\n+\t}\n+\n+\t@Inject(method = \"reloadResources\", at = @At(\"HEAD\"))\n+\tprivate void beforeResourceReload(Collection<String> collection, CallbackInfoReturnable<CompletableFuture<Void>> cir) {\n+\t\tServerLifecycleEvents.START_DATA_PACK_RELOAD.invoker().startDataPackReload((MinecraftServer) (Object) this, this.serverResourceManager);\n+\t}\n+\n+\t@Inject(method = \"method_29440(Ljava/util/Collection;Lnet/minecraft/resource/ServerResourceManager;)V\", at = @At(\"TAIL\"))\n+\tprivate void afterResourceReload(Collection<String> enabledPacks, ServerResourceManager serverResourceManager, CallbackInfo ci) {\n+\t\tServerLifecycleEvents.END_DATA_PACK_RELOAD.invoker().endDataPackReload((MinecraftServer) (Object) this, this.serverResourceManager, true);\n+\t}\n+\n+\t@Inject(method = \"reloadResources\", at = @At(\"TAIL\"))\n+\tprivate void addResourceReloadFailureCallback(Collection<String> collection, CallbackInfoReturnable<CompletableFuture<Void>> cir) {\n+\t\t// Hook into fail\n+\t\tcir.getReturnValue().exceptionally(throwable -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9097c148da72e7311ab00635a1d2cad54942e061"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec5435801caba381fc0cff8271e441e500243bba", "author": {"user": {"login": "i509VCB", "name": null}}, "url": "https://github.com/FabricMC/fabric/commit/ec5435801caba381fc0cff8271e441e500243bba", "committedDate": "2020-07-10T05:59:08Z", "message": "use handleAsync instead"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzA2NjUz", "url": "https://github.com/FabricMC/fabric/pull/848#pullrequestreview-446706653", "createdAt": "2020-07-10T21:19:13Z", "commit": {"oid": "ec5435801caba381fc0cff8271e441e500243bba"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NzIxMjM1", "url": "https://github.com/FabricMC/fabric/pull/848#pullrequestreview-446721235", "createdAt": "2020-07-10T21:55:21Z", "commit": {"oid": "ec5435801caba381fc0cff8271e441e500243bba"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2ODIxMzM4", "url": "https://github.com/FabricMC/fabric/pull/848#pullrequestreview-446821338", "createdAt": "2020-07-11T18:44:00Z", "commit": {"oid": "ec5435801caba381fc0cff8271e441e500243bba"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQxODo0NDowMFrOGwOiCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMVQxODo0NDowMFrOGwOiCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzIyMjkyMQ==", "bodyText": "Doesn't that @At need a remap = false so that the mixin AP doesn't complain?", "url": "https://github.com/FabricMC/fabric/pull/848#discussion_r453222921", "createdAt": "2020-07-11T18:44:00Z", "author": {"login": "Juuxel"}, "path": "fabric-lifecycle-events-v1/src/main/java/net/fabricmc/fabric/mixin/event/lifecycle/MinecraftServerMixin.java", "diffHunk": "@@ -73,4 +89,28 @@ private void closeWorld(CallbackInfo ci, Iterator<ServerWorld> worlds, ServerWor\n \t\t\tServerBlockEntityEvents.BLOCK_ENTITY_UNLOAD.invoker().onUnload(blockEntity, serverWorld);\n \t\t}\n \t}\n+\n+\t// The locals you have to manage for an inject are insane. And do it twice. A redirect is much cleaner.\n+\t// Here is what it looks like with an inject: https://gist.github.com/i509VCB/f80077cc536eb4dba62b794eba5611c1\n+\t@Redirect(method = \"createWorlds\", at = @At(value = \"INVOKE\", target = \"Ljava/util/Map;put(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec5435801caba381fc0cff8271e441e500243bba"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NzE2ODc3", "url": "https://github.com/FabricMC/fabric/pull/848#pullrequestreview-448716877", "createdAt": "2020-07-15T07:59:27Z", "commit": {"oid": "ec5435801caba381fc0cff8271e441e500243bba"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3580, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}