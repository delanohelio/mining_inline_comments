{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2Mjk4NTIy", "number": 1245, "title": "Update networking API to 20w46a+, simplify mixin impl", "bodyText": "What broke?\nMojang introduced a new API class, that I am donning \"Observer\" which wraps a tracking server player, providing a getter for it, and a simple packet dispatching method alongside. The API was still mixing in expecting a collection of server players to expose for PlayerLookup#tracking(Entity) which has since been replaced which this new observer type. This generic type mismatch results in a class cast exception at runtime when this API method is called. This pull request migrates the mixins and PlayerLookup implementation to support this change and fix the crash.\nWhat changed?\nThere has been a migration to the new API class internally, and a refactor of entity tracker access. Previously the networking API had a mixin into TACS that shadowed the field and added a non-null lookup. The shadow has been replaced with an accessor mixin and the null checking migrated to the PlayerLookup call site.", "createdAt": "2020-12-29T02:27:37Z", "url": "https://github.com/FabricMC/fabric/pull/1245", "merged": true, "mergeCommit": {"oid": "fd9375dd4f51add95a3d22ce318869b5a2238fb7"}, "closed": true, "closedAt": "2020-12-30T16:46:03Z", "author": {"login": "ChloeDawn"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdqxRj3gH2gAyNTQ2Mjk4NTIyOjcyYzI5NDgwMDY2YTk5OGZjYmM1OTU1MTVlZTdlY2JiZTgyMzk4NjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdq7CmzAFqTU1OTU0MDAxNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "72c29480066a998fcbc595515ee7ecbbe8239866", "author": {"user": {"login": "ChloeDawn", "name": "Chloe"}}, "url": "https://github.com/FabricMC/fabric/commit/72c29480066a998fcbc595515ee7ecbbe8239866", "committedDate": "2020-12-29T02:26:35Z", "message": "Update networking API to 20w46a+, simplify mixin impl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MzU5MjYw", "url": "https://github.com/FabricMC/fabric/pull/1245#pullrequestreview-559359260", "createdAt": "2020-12-29T02:39:44Z", "commit": {"oid": "72c29480066a998fcbc595515ee7ecbbe8239866"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MzYwODUx", "url": "https://github.com/FabricMC/fabric/pull/1245#pullrequestreview-559360851", "createdAt": "2020-12-29T02:51:00Z", "commit": {"oid": "72c29480066a998fcbc595515ee7ecbbe8239866"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwMjo1MTowMVrOIMF0Mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwMjo1MTowMVrOIMF0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU0OTEwNw==", "bodyText": "Should this be returning an empty set or fail since the entity is not being tracked at all by the server world.", "url": "https://github.com/FabricMC/fabric/pull/1245#discussion_r549549107", "createdAt": "2020-12-29T02:51:01Z", "author": {"login": "i509VCB"}, "path": "fabric-networking-api-v1/src/main/java/net/fabricmc/fabric/api/networking/v1/PlayerLookup.java", "diffHunk": "@@ -111,9 +113,15 @@\n \n \t\tif (manager instanceof ServerChunkManager) {\n \t\t\tThreadedAnvilChunkStorage storage = ((ServerChunkManager) manager).threadedAnvilChunkStorage;\n+\t\t\tEntityTrackerAccessor tracker = ((ThreadedAnvilChunkStorageAccessor) storage).getEntityTrackers().get(entity.getEntityId());\n \n \t\t\t// return an immutable collection to guard against accidental removals.\n-\t\t\treturn Collections.unmodifiableCollection(((ThreadedAnvilChunkStorageTrackingExtensions) storage).fabric_getTrackingPlayers(entity));\n+\t\t\tif (tracker != null) {\n+\t\t\t\treturn Collections.unmodifiableCollection(tracker.getPlayersTracking()\n+\t\t\t\t\t\t.stream().map(class_5629::method_32311).collect(Collectors.toSet()));\n+\t\t\t}\n+\n+\t\t\treturn Collections.emptySet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72c29480066a998fcbc595515ee7ecbbe8239866"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MzYxNTM0", "url": "https://github.com/FabricMC/fabric/pull/1245#pullrequestreview-559361534", "createdAt": "2020-12-29T02:55:11Z", "commit": {"oid": "72c29480066a998fcbc595515ee7ecbbe8239866"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5Mzc2MzQ5", "url": "https://github.com/FabricMC/fabric/pull/1245#pullrequestreview-559376349", "createdAt": "2020-12-29T04:46:30Z", "commit": {"oid": "72c29480066a998fcbc595515ee7ecbbe8239866"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwNDo0NjozMFrOIMG3UA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwNDo0NjozMFrOIMG3UA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU2NjI4OA==", "bodyText": "pre-sized output collection with manual for-each please, the Stream is needless overhead+debugging hazard", "url": "https://github.com/FabricMC/fabric/pull/1245#discussion_r549566288", "createdAt": "2020-12-29T04:46:30Z", "author": {"login": "sfPlayer1"}, "path": "fabric-networking-api-v1/src/main/java/net/fabricmc/fabric/api/networking/v1/PlayerLookup.java", "diffHunk": "@@ -111,9 +113,15 @@\n \n \t\tif (manager instanceof ServerChunkManager) {\n \t\t\tThreadedAnvilChunkStorage storage = ((ServerChunkManager) manager).threadedAnvilChunkStorage;\n+\t\t\tEntityTrackerAccessor tracker = ((ThreadedAnvilChunkStorageAccessor) storage).getEntityTrackers().get(entity.getEntityId());\n \n \t\t\t// return an immutable collection to guard against accidental removals.\n-\t\t\treturn Collections.unmodifiableCollection(((ThreadedAnvilChunkStorageTrackingExtensions) storage).fabric_getTrackingPlayers(entity));\n+\t\t\tif (tracker != null) {\n+\t\t\t\treturn Collections.unmodifiableCollection(tracker.getPlayersTracking()\n+\t\t\t\t\t\t.stream().map(class_5629::method_32311).collect(Collectors.toSet()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72c29480066a998fcbc595515ee7ecbbe8239866"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NDcyMzA3", "url": "https://github.com/FabricMC/fabric/pull/1245#pullrequestreview-559472307", "createdAt": "2020-12-29T10:33:24Z", "commit": {"oid": "72c29480066a998fcbc595515ee7ecbbe8239866"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NTE2NDQ1", "url": "https://github.com/FabricMC/fabric/pull/1245#pullrequestreview-559516445", "createdAt": "2020-12-29T12:44:55Z", "commit": {"oid": "72c29480066a998fcbc595515ee7ecbbe8239866"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NTQwMDE0", "url": "https://github.com/FabricMC/fabric/pull/1245#pullrequestreview-559540014", "createdAt": "2020-12-29T13:49:18Z", "commit": {"oid": "72c29480066a998fcbc595515ee7ecbbe8239866"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3553, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}