{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyNTQxMDI5", "number": 6756, "title": "KEYCLOAK-12579: LDAP groups duplicated during UI listing of user groups", "bodyText": "Fix for KEYCLOAK-12579. Just the database check is implemented. Some comments:\n\nThe column PARENT_GROUP is now defined as not null and top level groups are marked with an empty string instead of NULL. This way the SIBLING_NAMES unique key also considers the top level group names.\nAs a consequence of the previous unique key, the group cannot be created first at top level and then moved (previously a group creation always consisted in a createGroup, top level, and then moveGroup). Although it was done in the same transaction the INSERT was executed first and now with the active unique key it gave an error (violation of the unique key). I have modified the RealmModel and RealmProvider interfaces to add two more createGroup variants that let pass the final parent. The moveGroup is just needed to real movements (from one parent to a new one, once the group is already created).\nI have added the database changes for 9.0.0 version for the moment, we can change it later on if 9.0.0 is released.\n\nTested with internal H2 database, MySQL and postgres. Please try to test this with the other databases. DB2 is a bit special because it needs a different database modifications (the unique key was dropped in a previous version because it doesn't allows NULLs in unique keys). So for DB2 the three columns are set as not null (NAME and PARENT_GROUP) and the unique key is re-created. I did this without any testing cos I don't have any DB2 box, so it can fail.", "createdAt": "2020-02-07T18:24:26Z", "url": "https://github.com/keycloak/keycloak/pull/6756", "merged": true, "mergeCommit": {"oid": "ad3b9fc3898f31408c54ffd3bdf0e62a4be7bce2"}, "closed": true, "closedAt": "2020-03-11T05:14:31Z", "author": {"login": "rmartinc"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcC7rwBgFqTM1NTg3NDUyMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMgD37AFqTM3MjQ3OTk4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1ODc0NTIw", "url": "https://github.com/keycloak/keycloak/pull/6756#pullrequestreview-355874520", "createdAt": "2020-02-10T11:46:07Z", "commit": {"oid": "1532ce66a1fc318cd99fb8fdba079a584a4aa581"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1532ce66a1fc318cd99fb8fdba079a584a4aa581", "author": {"user": {"login": "rmartinc", "name": null}}, "url": "https://github.com/keycloak/keycloak/commit/1532ce66a1fc318cd99fb8fdba079a584a4aa581", "committedDate": "2020-02-07T11:58:57Z", "message": "KEYCLOAK-12579: LDAP groups duplicated during UI listing of user groups"}, "afterCommit": {"oid": "f0bc0a594b8cf567628730845a0287249470783f", "author": {"user": {"login": "rmartinc", "name": null}}, "url": "https://github.com/keycloak/keycloak/commit/f0bc0a594b8cf567628730845a0287249470783f", "committedDate": "2020-02-11T16:56:40Z", "message": "KEYCLOAK-12579: LDAP groups duplicated during UI listing of user groups"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNDIwMzA3", "url": "https://github.com/keycloak/keycloak/pull/6756#pullrequestreview-370420307", "createdAt": "2020-03-06T15:44:03Z", "commit": {"oid": "f0bc0a594b8cf567628730845a0287249470783f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNTo0NDowM1rOFy9Vjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNTo0NjozMlrOFy9bBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk3ODA2Mg==", "bodyText": "Yes, as you pointed, this may need to be added into separate file though as keycloak 9.0.0 is already released.", "url": "https://github.com/keycloak/keycloak/pull/6756#discussion_r388978062", "createdAt": "2020-03-06T15:44:03Z", "author": {"login": "mposolda"}, "path": "model/jpa/src/main/resources/META-INF/jpa-changelog-9.0.0.xml", "diffHunk": "@@ -64,4 +64,10 @@\n         <addPrimaryKey columnNames=\"USER_SESSION_ID, CLIENT_ID, CLIENT_STORAGE_PROVIDER, EXTERNAL_CLIENT_ID, OFFLINE_FLAG\" constraintName=\"CONSTRAINT_OFFL_CL_SES_PK3\" tableName=\"OFFLINE_CLIENT_SESSION\"/>\n     </changeSet>\n \n+    <changeSet author=\"keycloak\" id=\"9.0.0-KEYCLOAK-12579\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0bc0a594b8cf567628730845a0287249470783f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk3OTQ2Mw==", "bodyText": "I have some fear of the Oracle DB with this constraint. Oracle doesn't know the difference between null and empty strings, so my guess is, that it won't work with \"\" as default empty string. Maybe \" \" will work better...\nI will try to run DB tests and will let you know.", "url": "https://github.com/keycloak/keycloak/pull/6756#discussion_r388979463", "createdAt": "2020-03-06T15:46:32Z", "author": {"login": "mposolda"}, "path": "model/jpa/src/main/resources/META-INF/jpa-changelog-9.0.0.xml", "diffHunk": "@@ -64,4 +64,10 @@\n         <addPrimaryKey columnNames=\"USER_SESSION_ID, CLIENT_ID, CLIENT_STORAGE_PROVIDER, EXTERNAL_CLIENT_ID, OFFLINE_FLAG\" constraintName=\"CONSTRAINT_OFFL_CL_SES_PK3\" tableName=\"OFFLINE_CLIENT_SESSION\"/>\n     </changeSet>\n \n+    <changeSet author=\"keycloak\" id=\"9.0.0-KEYCLOAK-12579\">\n+        <!-- Now the parent group cannot be NULL to make SIBLING_NAMES unique constraint work -->\n+        <!-- Top level groups are now marked with the empty string -->\n+        <addNotNullConstraint tableName=\"KEYCLOAK_GROUP\" columnName=\"PARENT_GROUP\" columnDataType=\"VARCHAR(36)\" defaultNullValue=\"\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0bc0a594b8cf567628730845a0287249470783f"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b371564bc0be835695724df1e6c05ebd837127e", "author": {"user": {"login": "rmartinc", "name": null}}, "url": "https://github.com/keycloak/keycloak/commit/0b371564bc0be835695724df1e6c05ebd837127e", "committedDate": "2020-03-10T08:13:19Z", "message": "KEYCLOAK-12579: LDAP groups duplicated during UI listing of user groups"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f0bc0a594b8cf567628730845a0287249470783f", "author": {"user": {"login": "rmartinc", "name": null}}, "url": "https://github.com/keycloak/keycloak/commit/f0bc0a594b8cf567628730845a0287249470783f", "committedDate": "2020-02-11T16:56:40Z", "message": "KEYCLOAK-12579: LDAP groups duplicated during UI listing of user groups"}, "afterCommit": {"oid": "0b371564bc0be835695724df1e6c05ebd837127e", "author": {"user": {"login": "rmartinc", "name": null}}, "url": "https://github.com/keycloak/keycloak/commit/0b371564bc0be835695724df1e6c05ebd837127e", "committedDate": "2020-03-10T08:13:19Z", "message": "KEYCLOAK-12579: LDAP groups duplicated during UI listing of user groups"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNDc5OTgy", "url": "https://github.com/keycloak/keycloak/pull/6756#pullrequestreview-372479982", "createdAt": "2020-03-11T05:14:22Z", "commit": {"oid": "0b371564bc0be835695724df1e6c05ebd837127e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2649, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}