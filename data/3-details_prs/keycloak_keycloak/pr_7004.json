{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4NTE5NjU1", "number": 7004, "title": "KEYCLOAK-13950 SAML2 Identity Provider - Send Subject in SAML requests", "bodyText": "Motivation\nWhen working with SAML IDPs, it is currently not possible to send a Subject. This subject can prefill the username input field during the login process.\nAs mentionned by @hmlnarik in KEYCLOAK-13858, the Subject is an optional standard element of SAML requests: See https://docs.oasis-open.org/security/saml/v2.0/saml-core-2.0-os.pdf, line 2017 and below.\nAnother motivation: this is impossible to achieve this using SamlAuthenticationPreprocessor because:\n\nThere is nothing from the request url available in the clientSession\nSAMLRequestWriter does not write the subject in the request\n\nSolution\nThis PR takes a query parameter named login_hint into account and add it to the SAML Request as a Subject element. When no login_hint is provided, no Subject is added to the request.\nThis does not require any change in the identity provider configuration.\nLimitations\nPay attention that several IDPs do not support the Subject element of SAML. For instance: ADFS simply ignores it: https://docs.microsoft.com/en-us/azure/active-directory/develop/single-sign-on-saml-protocol#subject\nlogin_hint\nWhy a login_hint and not a subject query parameter? I believe Keycloak exposes its Identity Providers (SAML or not) as an OpenID facade and then redirect the requests to the appropriate providers.\nConsidering OpenID already has a standard login_hint query parameter, this makes sense to support the same contract.\nUsage\nBy default, a social button pointing to a SAML Identity Provider redirects the user to a login URL http[s]://{host:port}/auth/realms/{realm-name}/broker/{broker-alias}/login?<query-parameters>\nAdding a login_hint query parameter to this URL will add its value to SAML request as a Subject attribute.", "createdAt": "2020-04-24T12:23:40Z", "url": "https://github.com/keycloak/keycloak/pull/7004", "merged": true, "mergeCommit": {"oid": "e82fe7d9e317b689d1746f9efbcb4f9285bc38c0"}, "closed": true, "closedAt": "2020-07-24T19:41:58Z", "author": {"login": "looorent"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcb_4c5gFqTQwMTYyNjA0MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc4JX2LAFqTQ1NTE0MTYwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNjI2MDQw", "url": "https://github.com/keycloak/keycloak/pull/7004#pullrequestreview-401626040", "createdAt": "2020-04-28T08:47:43Z", "commit": {"oid": "b819b7b4d046c846c86071bd32c256288fd3c7e5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwODo0Nzo0M1rOGNJiVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwODo0Nzo0M1rOGNJiVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ0MDkxNg==", "bodyText": "Is there some input validation / escaping required here after reading loginHint from the request parameters?", "url": "https://github.com/keycloak/keycloak/pull/7004#discussion_r416440916", "createdAt": "2020-04-28T08:47:43Z", "author": {"login": "thomasdarimont"}, "path": "services/src/main/java/org/keycloak/broker/saml/SAMLIdentityProvider.java", "diffHunk": "@@ -91,13 +93,15 @@ public Response performLogin(AuthenticationRequest request) {\n                 protocolBinding = JBossSAMLURIConstants.SAML_HTTP_POST_BINDING.get();\n             }\n \n+            String loginHint = request.getHttpRequest().getUri().getQueryParameters().getFirst(LOGIN_HINT_QUERY_PARAMETER);\n             SAML2AuthnRequestBuilder authnRequestBuilder = new SAML2AuthnRequestBuilder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b819b7b4d046c846c86071bd32c256288fd3c7e5"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b819b7b4d046c846c86071bd32c256288fd3c7e5", "author": {"user": {"login": "looorent", "name": "Lorent Lempereur"}}, "url": "https://github.com/keycloak/keycloak/commit/b819b7b4d046c846c86071bd32c256288fd3c7e5", "committedDate": "2020-04-24T12:20:10Z", "message": "KEYCLOAK-13950 SAML2 Identity Provider - Send Subject in SAML requests"}, "afterCommit": {"oid": "e4c119b22082371de461067bed1d6d2b4dd789f1", "author": {"user": {"login": "looorent", "name": "Lorent Lempereur"}}, "url": "https://github.com/keycloak/keycloak/commit/e4c119b22082371de461067bed1d6d2b4dd789f1", "committedDate": "2020-05-05T06:45:49Z", "message": "KEYCLOAK-13950 SAML2 Identity Provider - Send Subject in SAML requests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b2b23911720e78ca426ef25d518f93067523bf0c", "author": {"user": {"login": "looorent", "name": "Lorent Lempereur"}}, "url": "https://github.com/keycloak/keycloak/commit/b2b23911720e78ca426ef25d518f93067523bf0c", "committedDate": "2020-05-05T07:14:55Z", "message": "KEYCLOAK-13950 SAML2 Identity Provider - Send Subject in SAML requests"}, "afterCommit": {"oid": "56bb48a352abed44773114f0b66902321d51e71c", "author": {"user": {"login": "looorent", "name": "Lorent Lempereur"}}, "url": "https://github.com/keycloak/keycloak/commit/56bb48a352abed44773114f0b66902321d51e71c", "committedDate": "2020-05-05T07:22:34Z", "message": "KEYCLOAK-13950 SAML2 Identity Provider - Send Subject in SAML requests\n\nKEYCLOAK-13950 SAML2 Identity Provider - Send Subject in SAML requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2856461b721bb10312e70d9f5795f0bf3ed32054", "author": {"user": {"login": "looorent", "name": "Lorent Lempereur"}}, "url": "https://github.com/keycloak/keycloak/commit/2856461b721bb10312e70d9f5795f0bf3ed32054", "committedDate": "2020-07-03T14:25:19Z", "message": "KEYCLOAK-13950 SAML2 Identity Provider - Send Subject in SAML requests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "56bb48a352abed44773114f0b66902321d51e71c", "author": {"user": {"login": "looorent", "name": "Lorent Lempereur"}}, "url": "https://github.com/keycloak/keycloak/commit/56bb48a352abed44773114f0b66902321d51e71c", "committedDate": "2020-05-05T07:22:34Z", "message": "KEYCLOAK-13950 SAML2 Identity Provider - Send Subject in SAML requests\n\nKEYCLOAK-13950 SAML2 Identity Provider - Send Subject in SAML requests"}, "afterCommit": {"oid": "2856461b721bb10312e70d9f5795f0bf3ed32054", "author": {"user": {"login": "looorent", "name": "Lorent Lempereur"}}, "url": "https://github.com/keycloak/keycloak/commit/2856461b721bb10312e70d9f5795f0bf3ed32054", "committedDate": "2020-07-03T14:25:19Z", "message": "KEYCLOAK-13950 SAML2 Identity Provider - Send Subject in SAML requests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NDM1ODA1", "url": "https://github.com/keycloak/keycloak/pull/7004#pullrequestreview-445435805", "createdAt": "2020-07-09T09:17:29Z", "commit": {"oid": "2856461b721bb10312e70d9f5795f0bf3ed32054"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwOToxNzoyOVrOGvIyOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwOToxNzo0NlrOGvIy4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA4MDE4NQ==", "bodyText": "This needs to be guarded by a configuration that mimics OIDC identity provider loginHint configuration which will be disabled by default:\n\nMove OAuth2IdentityProviderConfig's isLoginHint and setLoginHint to IdentityProviderModel\nAdd a QueryParam(OIDCLoginProtocol.LOGIN_HINT_PARAM) to authentication session in IdentityBrokerService.performLogin similarly to https://github.com/keycloak/keycloak/blob/master/services/src/main/java/org/keycloak/protocol/oidc/endpoints/AuthorizationEndpoint.java#L445\nIn this place, only use request.getAuthenticationSession().getClientNote(OIDCLoginProtocol.LOGIN_HINT_PARAM)\n\nAlso update realm-identity-provider-saml.html to configure loginHint similarly to realm-identity-provider-oidc.html, and ensure that the label and label hint are properly adjusted to SAML terms.\nThe tests need to check that the settings of the loginHint configuration in SAML identity provider respect the settings.", "url": "https://github.com/keycloak/keycloak/pull/7004#discussion_r452080185", "createdAt": "2020-07-09T09:17:29Z", "author": {"login": "hmlnarik"}, "path": "services/src/main/java/org/keycloak/broker/saml/SAMLIdentityProvider.java", "diffHunk": "@@ -91,13 +93,15 @@ public Response performLogin(AuthenticationRequest request) {\n                 protocolBinding = JBossSAMLURIConstants.SAML_HTTP_POST_BINDING.get();\n             }\n \n+            String loginHint = request.getHttpRequest().getUri().getQueryParameters().getFirst(LOGIN_HINT_QUERY_PARAMETER);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2856461b721bb10312e70d9f5795f0bf3ed32054"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA4MDM1NA==", "bodyText": "Please remove, use existing constant instead (see below)", "url": "https://github.com/keycloak/keycloak/pull/7004#discussion_r452080354", "createdAt": "2020-07-09T09:17:46Z", "author": {"login": "hmlnarik"}, "path": "services/src/main/java/org/keycloak/broker/saml/SAMLIdentityProvider.java", "diffHunk": "@@ -59,6 +59,8 @@\n  */\n public class SAMLIdentityProvider extends AbstractIdentityProvider<SAMLIdentityProviderConfig> {\n     protected static final Logger logger = Logger.getLogger(SAMLIdentityProvider.class);\n+    private static final String LOGIN_HINT_QUERY_PARAMETER = \"login_hint\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2856461b721bb10312e70d9f5795f0bf3ed32054"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9865b410106720fd6b3046894d7019ba2faf7ec9", "author": {"user": {"login": "looorent", "name": "Lorent Lempereur"}}, "url": "https://github.com/keycloak/keycloak/commit/9865b410106720fd6b3046894d7019ba2faf7ec9", "committedDate": "2020-07-09T16:59:08Z", "message": "KEYCLOAK-13950 SAML2 Identity Provider - Send Subject in SAML requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b32ba313c272272e817f6400b863e8cf302c861d", "author": {"user": {"login": "looorent", "name": "Lorent Lempereur"}}, "url": "https://github.com/keycloak/keycloak/commit/b32ba313c272272e817f6400b863e8cf302c861d", "committedDate": "2020-07-09T19:26:53Z", "message": "KEYCLOAK-13950 SAML2 Identity Provider - Send Subject in SAML requests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MTQxNjA1", "url": "https://github.com/keycloak/keycloak/pull/7004#pullrequestreview-455141605", "createdAt": "2020-07-24T19:41:02Z", "commit": {"oid": "b32ba313c272272e817f6400b863e8cf302c861d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3176, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}