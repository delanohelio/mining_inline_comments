{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3MzgxMTE1", "number": 6698, "title": "KEYCLOAK-10884: Need clock skew for SAML identity provider", "bodyText": "Adding allowedClockSkew to the SAML broker configuration. I have used a number input instead of the default text used in OIDC (because I think it's better). Added two tests to check a expired assertion, one should fail and the other should be OK because of the skew time.", "createdAt": "2020-01-27T09:05:47Z", "url": "https://github.com/keycloak/keycloak/pull/6698", "merged": true, "mergeCommit": {"oid": "5b9eb0fe190eaa34ec914f9383bcc798d8ebaefa"}, "closed": true, "closedAt": "2020-02-03T21:00:45Z", "author": {"login": "rmartinc"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-yEQQAFqTM0OTMzNTQzMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcAza4SAFqTM1MjU1OTAxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MzM1NDMw", "url": "https://github.com/keycloak/keycloak/pull/6698#pullrequestreview-349335430", "createdAt": "2020-01-28T12:27:31Z", "commit": {"oid": "c3e61d8392c87df5f2751b602fe6925cbffa453a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMjoyNzozMVrOFijLMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMzoxMDo1MVrOFikYBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc3MjIxMQ==", "bodyText": "We are not using static waits in testsuite, we have a possibility to \"move\" in time. You can just use this method: https://github.com/keycloak/keycloak/blob/master/testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/AbstractKeycloakTest.java#L581 You can look for usages of the method to see how it works. It basically changes the time in Keycloak server, so you don't need to wait.", "url": "https://github.com/keycloak/keycloak/pull/6698#discussion_r371772211", "createdAt": "2020-01-28T12:27:31Z", "author": {"login": "mhajas"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/broker/KcSamlBrokerTest.java", "diffHunk": "@@ -256,6 +262,75 @@ public void loginClientWithDotsInName() throws Exception {\n         Assert.assertThat(samlResponse.getSamlObject(), isSamlResponse(JBossSAMLURIConstants.STATUS_SUCCESS));\n     }\n \n+    @Test\n+    public void loginClientExpiredResponseFromIdP() throws Exception {\n+        // set the provider realm lifespans to 1 sec, this way the SAML response will be expired\n+        try (AutoCloseable c = new RealmAttributeUpdater(adminClient.realm(bc.providerRealmName()))\n+                .setAccessTokenLifespan(1)\n+                .setAccessCodeLifespan(1)\n+                .update()) {\n+\n+            AuthnRequestType loginRep = SamlClient.createLoginRequestDocument(AbstractSamlTest.SAML_CLIENT_ID_SALES_POST + \".dot/ted\", getAuthServerContextRoot() + \"/sales-post/saml\", null);\n+\n+            Document doc = SAML2Request.convert(loginRep);\n+\n+            new SamlClientBuilder()\n+              .authnRequest(getAuthServerSamlEndpoint(bc.consumerRealmName()), doc, Binding.POST).build()   // Request to consumer IdP\n+              .login().idp(bc.getIDPAlias()).build()\n+\n+              .processSamlResponse(Binding.POST)    // AuthnRequest to producer IdP\n+                .targetAttributeSamlRequest()\n+                .build()\n+\n+              .login().user(bc.getUserLogin(), bc.getUserPassword()).build()\n+\n+              .sleep(1500)    // sleep 1.5 seconds to expire the document", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3e61d8392c87df5f2751b602fe6925cbffa453a"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc3NzExMg==", "bodyText": "I would prefer to create a new test class for these two tests and remove it from general KcSamlBrokerTest. You can have a look at https://github.com/keycloak/keycloak/blob/master/testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/broker/KcSamlBrokerSessionNotOnOrAfterTest.java to see what is needed for a new class.", "url": "https://github.com/keycloak/keycloak/pull/6698#discussion_r371777112", "createdAt": "2020-01-28T12:38:57Z", "author": {"login": "mhajas"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/broker/KcSamlBrokerTest.java", "diffHunk": "@@ -256,6 +262,75 @@ public void loginClientWithDotsInName() throws Exception {\n         Assert.assertThat(samlResponse.getSamlObject(), isSamlResponse(JBossSAMLURIConstants.STATUS_SUCCESS));\n     }\n \n+    @Test\n+    public void loginClientExpiredResponseFromIdP() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3e61d8392c87df5f2751b602fe6925cbffa453a"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc3NzkxNA==", "bodyText": "Not needed remove please. See comment in test.", "url": "https://github.com/keycloak/keycloak/pull/6698#discussion_r371777914", "createdAt": "2020-01-28T12:40:43Z", "author": {"login": "mhajas"}, "path": "testsuite/integration-arquillian/tests/base/src/main/java/org/keycloak/testsuite/util/SamlClient.java", "diffHunk": "@@ -86,6 +86,23 @@ public HttpUriRequest perform(CloseableHttpClient client, URI uri, CloseableHttp\n         }\n     }\n \n+    public static final class Sleep implements Step {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3e61d8392c87df5f2751b602fe6925cbffa453a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc5MTg3OA==", "bodyText": "If I understand it correctly, this is here so that identityProvider.config.allowedClockSkew is stored as a number not as a String. However, when I try to save a provider with clockskew it is a String in the request. Also in the database it is stored as a String, so we can't avoid parsing the value in Java code. I looked at other places we are having numbers in forms and it is not needed, for example see: https://github.com/keycloak/keycloak/blob/master/themes/src/main/resources/theme/base/admin/resources/partials/realm-tokens.html#L34 @rmartinc is there something I am missing?", "url": "https://github.com/keycloak/keycloak/pull/6698#discussion_r371791878", "createdAt": "2020-01-28T13:10:51Z", "author": {"login": "mhajas"}, "path": "themes/src/main/resources/theme/base/admin/resources/js/app.js", "diffHunk": "@@ -3270,6 +3270,21 @@ module.directive('kcValidPage', function() {\n    }\n });\n \n+// Directive to parse/format strings into numbers\n+module.directive('stringToNumber', function() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3e61d8392c87df5f2751b602fe6925cbffa453a"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c3e61d8392c87df5f2751b602fe6925cbffa453a", "author": {"user": {"login": "rmartinc", "name": null}}, "url": "https://github.com/keycloak/keycloak/commit/c3e61d8392c87df5f2751b602fe6925cbffa453a", "committedDate": "2020-01-27T08:52:40Z", "message": "KEYCLOAK-10884: Need clock skew for SAML identity provider"}, "afterCommit": {"oid": "08eb01bbbc143b83cea50d4c7f5cebf506d60daa", "author": {"user": {"login": "rmartinc", "name": null}}, "url": "https://github.com/keycloak/keycloak/commit/08eb01bbbc143b83cea50d4c7f5cebf506d60daa", "committedDate": "2020-01-29T14:13:25Z", "message": "KEYCLOAK-10884: Need clock skew for SAML identity provider"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a6bd4bbda7afbe46ffcb41f8ff48150cf2648a5", "author": {"user": {"login": "rmartinc", "name": null}}, "url": "https://github.com/keycloak/keycloak/commit/4a6bd4bbda7afbe46ffcb41f8ff48150cf2648a5", "committedDate": "2020-02-03T08:43:31Z", "message": "KEYCLOAK-10884: Need clock skew for SAML identity provider"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "08eb01bbbc143b83cea50d4c7f5cebf506d60daa", "author": {"user": {"login": "rmartinc", "name": null}}, "url": "https://github.com/keycloak/keycloak/commit/08eb01bbbc143b83cea50d4c7f5cebf506d60daa", "committedDate": "2020-01-29T14:13:25Z", "message": "KEYCLOAK-10884: Need clock skew for SAML identity provider"}, "afterCommit": {"oid": "4a6bd4bbda7afbe46ffcb41f8ff48150cf2648a5", "author": {"user": {"login": "rmartinc", "name": null}}, "url": "https://github.com/keycloak/keycloak/commit/4a6bd4bbda7afbe46ffcb41f8ff48150cf2648a5", "committedDate": "2020-02-03T08:43:31Z", "message": "KEYCLOAK-10884: Need clock skew for SAML identity provider"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNTU5MDE2", "url": "https://github.com/keycloak/keycloak/pull/6698#pullrequestreview-352559016", "createdAt": "2020-02-03T21:00:36Z", "commit": {"oid": "4a6bd4bbda7afbe46ffcb41f8ff48150cf2648a5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2741, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}