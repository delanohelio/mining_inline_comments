{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzOTY0MjEw", "number": 6980, "title": "KEYCLOAK-13817 Fix X509 auth fails when attribute value is always read from LDAP and import is enabled", "bodyText": "When userattribute value is always read from LDAP, then the value is not\navailable in the local store. Therfore, KC will not find a user by that\nattribute in the local store. When querying the LDAP storage\nprovider, the user will be found. However, when it is also available in\nthe local store (though without the attribute) it will not get imported\nand therefore not returned with the result set of the LDAP storage\nprovider. Hence, the user will not be found at all.\nThis change adds the user to the result set of the LDAP user stoage\nprovider, iff the attribute used for searching is set to always read\nvalue from LDAP.", "createdAt": "2020-04-15T20:08:32Z", "url": "https://github.com/keycloak/keycloak/pull/6980", "merged": true, "mergeCommit": {"oid": "82d3251ab453c7d10fe5efcbbbc35d57ca6afa6c"}, "closed": true, "closedAt": "2020-05-12T18:50:19Z", "author": {"login": "sventorben"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYMo2ugFqTM5NDYyNDg2NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgmC5egBqjMzMjgwNzI4MjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NjI0ODY0", "url": "https://github.com/keycloak/keycloak/pull/6980#pullrequestreview-394624864", "createdAt": "2020-04-16T13:21:00Z", "commit": {"oid": "eadd80d94ff2d4bf181947afe688e25fb69d1d04"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMzoyMTowMFrOGGk9Cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMzoyMTowMFrOGGk9Cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1MDA5MA==", "bodyText": "I think it will be good to remove method \"shouldUserAttributeBeAlwaysReadFromLdap\" (and any new things related to that added in this PR) and just always add the proxy to the results.\nRegarding this, it may be also good to update a bit method UserStorageManager.query and make sure that duplicates are not returned. As currently UserStorageMAnager.query returns stuff from multiple providers, so it can probably return duplicated stuff in some cases (EG. in case that LDAP user was imported and attribute \"foo\" with value \"bar\" is available in both the DB and LDAP)", "url": "https://github.com/keycloak/keycloak/pull/6980#discussion_r409550090", "createdAt": "2020-04-16T13:21:00Z", "author": {"login": "mposolda"}, "path": "federation/ldap/src/main/java/org/keycloak/storage/ldap/LDAPStorageProvider.java", "diffHunk": "@@ -237,16 +233,33 @@ public boolean supportsCredentialAuthenticationFor(String type) {\n \n              for (LDAPObject ldapUser : ldapObjects) {\n                  String ldapUsername = LDAPUtils.getUsername(ldapUser, this.ldapIdentityStore.getConfig());\n-                 if (session.userLocalStorage().getUserByUsername(ldapUsername, realm) == null) {\n+                 UserModel localUser = session.userLocalStorage().getUserByUsername(ldapUsername, realm);\n+                 if (localUser == null) {\n                      UserModel imported = importUserFromLDAP(session, realm, ldapUser);\n                      searchResults.add(imported);\n+                 } else if (shouldUserAttributeBeAlwaysReadFromLdap(realm, attrName)) {\n+                     searchResults.add(proxy(realm, localUser, ldapUser));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eadd80d94ff2d4bf181947afe688e25fb69d1d04"}, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eadd80d94ff2d4bf181947afe688e25fb69d1d04", "author": {"user": {"login": "sventorben", "name": "Sven-Torben Janus"}}, "url": "https://github.com/keycloak/keycloak/commit/eadd80d94ff2d4bf181947afe688e25fb69d1d04", "committedDate": "2020-04-15T20:04:38Z", "message": "KEYCLOAK-13817 Fix X509 auth fails\n\nwhen attribute value is always read from LDAP and import is enabled\n\nWhen userattribute value is always read from LDAP, then the value is not\navailable in the local store. Therfore, KC will not find a user by that\nattribute in the local store. When querying the LDAP storage\nprovider, the user will be found. However, when it is also available in\nthe local store (though without the attribute) it will not get imported\nand therefore not returned with the result set of the LDAP storage\nprovider. Hence, the user will not be found at all.\n\nThis change adds the user to the result set of the LDAP user stoage\nprovider, iff the attribute user by the search is set to always read\nvalue from LDAP."}, "afterCommit": {"oid": "54865a66ab555f60dd0b09b9b5c133aebccf5363", "author": {"user": {"login": "sventorben", "name": "Sven-Torben Janus"}}, "url": "https://github.com/keycloak/keycloak/commit/54865a66ab555f60dd0b09b9b5c133aebccf5363", "committedDate": "2020-04-21T19:33:34Z", "message": "KEYCLOAK-13817 Return local user from LDAPStorageProvider"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMDk5MDcw", "url": "https://github.com/keycloak/keycloak/pull/6980#pullrequestreview-410099070", "createdAt": "2020-05-12T14:26:35Z", "commit": {"oid": "54865a66ab555f60dd0b09b9b5c133aebccf5363"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNDoyNjozNVrOGUJW_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNDoyNjo0N1rOGUJXjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc3ODA0NQ==", "bodyText": "Please remove star imports and replace with individual classes", "url": "https://github.com/keycloak/keycloak/pull/6980#discussion_r423778045", "createdAt": "2020-05-12T14:26:35Z", "author": {"login": "mposolda"}, "path": "federation/ldap/src/main/java/org/keycloak/storage/ldap/LDAPStorageProvider.java", "diffHunk": "@@ -58,10 +57,7 @@\n import org.keycloak.storage.ldap.idm.query.internal.LDAPQueryConditionsBuilder;\n import org.keycloak.storage.ldap.idm.store.ldap.LDAPIdentityStore;\n import org.keycloak.storage.ldap.kerberos.LDAPProviderKerberosConfig;\n-import org.keycloak.storage.ldap.mappers.LDAPOperationDecorator;\n-import org.keycloak.storage.ldap.mappers.LDAPStorageMapper;\n-import org.keycloak.storage.ldap.mappers.LDAPStorageMapperManager;\n-import org.keycloak.storage.ldap.mappers.PasswordUpdateCallback;\n+import org.keycloak.storage.ldap.mappers.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54865a66ab555f60dd0b09b9b5c133aebccf5363"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc3ODE4OQ==", "bodyText": "Please remove star imports and replace with individual classes", "url": "https://github.com/keycloak/keycloak/pull/6980#discussion_r423778189", "createdAt": "2020-05-12T14:26:47Z", "author": {"login": "mposolda"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/federation/ldap/LDAPNoCacheTest.java", "diffHunk": "@@ -52,7 +53,12 @@\n import org.keycloak.testsuite.util.LDAPTestUtils;\n import org.keycloak.testsuite.util.MailUtils;\n \n+import static org.hamcrest.CoreMatchers.is;\n+import static org.hamcrest.CoreMatchers.not;\n+import static org.hamcrest.Matchers.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54865a66ab555f60dd0b09b9b5c133aebccf5363"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9699bd539f788757baab1efd6e57b55e3d1c1fd2", "author": {"user": {"login": "sventorben", "name": "Sven-Torben Janus"}}, "url": "https://github.com/keycloak/keycloak/commit/9699bd539f788757baab1efd6e57b55e3d1c1fd2", "committedDate": "2020-05-12T15:29:52Z", "message": "KEYCLOAK-13817 Fix X509 auth fails\n\nwhen attribute value is always read from LDAP and import is enabled\n\nWhen userattribute value is always read from LDAP, then the value is not\navailable in the local store. Therfore, KC will not find a user by that\nattribute in the local store. When querying the LDAP storage\nprovider, the user will be found. However, when it is also available in\nthe local store (though without the attribute) it will not get imported\nand therefore not returned with the result set of the LDAP storage\nprovider. Hence, the user will not be found at all.\n\nThis change adds the user to the result set of the LDAP user stoage\nprovider, iff the attribute user by the search is set to always read\nvalue from LDAP."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abd34c7d078da4ba522c8b1de981f4cca828adc9", "author": {"user": {"login": "sventorben", "name": "Sven-Torben Janus"}}, "url": "https://github.com/keycloak/keycloak/commit/abd34c7d078da4ba522c8b1de981f4cca828adc9", "committedDate": "2020-05-12T15:29:52Z", "message": "KEYCLOAK-13817 Return local user from LDAPStorageProvider"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b07518e0b697af34b0133a9b91eb2e2cc43b079a", "author": {"user": {"login": "sventorben", "name": "Sven-Torben Janus"}}, "url": "https://github.com/keycloak/keycloak/commit/b07518e0b697af34b0133a9b91eb2e2cc43b079a", "committedDate": "2020-05-12T15:29:53Z", "message": "Remove *-imports"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "54865a66ab555f60dd0b09b9b5c133aebccf5363", "author": {"user": {"login": "sventorben", "name": "Sven-Torben Janus"}}, "url": "https://github.com/keycloak/keycloak/commit/54865a66ab555f60dd0b09b9b5c133aebccf5363", "committedDate": "2020-04-21T19:33:34Z", "message": "KEYCLOAK-13817 Return local user from LDAPStorageProvider"}, "afterCommit": {"oid": "b07518e0b697af34b0133a9b91eb2e2cc43b079a", "author": {"user": {"login": "sventorben", "name": "Sven-Torben Janus"}}, "url": "https://github.com/keycloak/keycloak/commit/b07518e0b697af34b0133a9b91eb2e2cc43b079a", "committedDate": "2020-05-12T15:29:53Z", "message": "Remove *-imports"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3144, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}