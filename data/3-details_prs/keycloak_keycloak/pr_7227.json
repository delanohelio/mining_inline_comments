{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzNjUxODcz", "number": 7227, "title": "[KEYCLOAK-14646] - Improving permission resolution and evaluation", "bodyText": "", "createdAt": "2020-07-02T17:25:00Z", "url": "https://github.com/keycloak/keycloak/pull/7227", "merged": true, "mergeCommit": {"oid": "3631618b245fa768bff7009b9e87d01dd4387fe3"}, "closed": true, "closedAt": "2020-07-21T12:22:11Z", "author": {"login": "pedroigor"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxDFH8gBqjM1MDgyNzYxOTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3FNOKgFqTQ1MjM5NDY1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d3842a3d056558007161683f091fb335da0475c9", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/d3842a3d056558007161683f091fb335da0475c9", "committedDate": "2020-07-02T17:24:24Z", "message": "[KEYCLOAK-14646] - Improving permission resolution and evaluation"}, "afterCommit": {"oid": "dfd18fe97332014c14482f243f8265a1240ade7e", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/dfd18fe97332014c14482f243f8265a1240ade7e", "committedDate": "2020-07-02T18:23:33Z", "message": "[KEYCLOAK-14646] - Improving permission resolution and evaluation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dfd18fe97332014c14482f243f8265a1240ade7e", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/dfd18fe97332014c14482f243f8265a1240ade7e", "committedDate": "2020-07-02T18:23:33Z", "message": "[KEYCLOAK-14646] - Improving permission resolution and evaluation"}, "afterCommit": {"oid": "88283ca8b1ebece93ce649c74ea6c22c7c237593", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/88283ca8b1ebece93ce649c74ea6c22c7c237593", "committedDate": "2020-07-03T00:27:59Z", "message": "[KEYCLOAK-14646] - Improving permission resolution and evaluation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "88283ca8b1ebece93ce649c74ea6c22c7c237593", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/88283ca8b1ebece93ce649c74ea6c22c7c237593", "committedDate": "2020-07-03T00:27:59Z", "message": "[KEYCLOAK-14646] - Improving permission resolution and evaluation"}, "afterCommit": {"oid": "387d02ebf03c271e8aeea411997ce182eb989834", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/387d02ebf03c271e8aeea411997ce182eb989834", "committedDate": "2020-07-03T01:17:43Z", "message": "[KEYCLOAK-14646] - Improving permission resolution and evaluation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MTM5NTcz", "url": "https://github.com/keycloak/keycloak/pull/7227#pullrequestreview-448139573", "createdAt": "2020-07-14T14:05:59Z", "commit": {"oid": "387d02ebf03c271e8aeea411997ce182eb989834"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNDowNjowMFrOGxVRcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNDozODozNlrOGxWv4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM4MTkzNg==", "bodyText": "Not sure this is intentional, but currently the named query used here is not returning id but whole ResourceEntity, so I believe this should be possible:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    query.getResultStream().map(id -> resourceStore.findById(id.getId(), resourceServerId)).forEach(consumer);\n          \n          \n            \n                    query.getResultStream().map(resourceEntity -> new ResourceAdapter(resourceEntity, entityManager, provider.getStoreFactory())).forEach(consumer);\n          \n      \n    \n    \n  \n\nOr if we want to make it possible to use cache for getting ResourceEntities, we should probably make the NamedQueries to return id only.", "url": "https://github.com/keycloak/keycloak/pull/7227#discussion_r454381936", "createdAt": "2020-07-14T14:06:00Z", "author": {"login": "mhajas"}, "path": "model/jpa/src/main/java/org/keycloak/authorization/jpa/store/JPAResourceStore.java", "diffHunk": "@@ -145,15 +145,7 @@ private void findByOwnerFilter(String ownerId, String resourceServerId, Consumer\n         }\n \n         ResourceStore resourceStore = provider.getStoreFactory().getResourceStore();\n-        List<String> result = query.getResultList();\n-\n-        for (String entity : result) {\n-            Resource cached = resourceStore.findById(entity, resourceServerId);\n-            \n-            if (cached != null) {\n-                consumer.accept(cached);\n-            }\n-        }\n+        query.getResultStream().map(id -> resourceStore.findById(id.getId(), resourceServerId)).forEach(consumer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "387d02ebf03c271e8aeea411997ce182eb989834"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM4NzYzNw==", "bodyText": "I am not sure I have enough knowledge of the Infinispan layer to review this. @hmlnarik @slaskawi Could you please help me on this line?", "url": "https://github.com/keycloak/keycloak/pull/7227#discussion_r454387637", "createdAt": "2020-07-14T14:14:09Z", "author": {"login": "mhajas"}, "path": "model/infinispan/src/main/java/org/keycloak/connections/infinispan/InfinispanConnectionProvider.java", "diffHunk": "@@ -43,7 +43,7 @@\n     String WORK_CACHE_NAME = \"work\";\n     String AUTHORIZATION_CACHE_NAME = \"authorization\";\n     String AUTHORIZATION_REVISIONS_CACHE_NAME = \"authorizationRevisions\";\n-    int AUTHORIZATION_REVISIONS_CACHE_DEFAULT_MAX = 20000;\n+    int AUTHORIZATION_REVISIONS_CACHE_DEFAULT_MAX = 1000000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "387d02ebf03c271e8aeea411997ce182eb989834"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5ODE1Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                (revision, resources) -> new ResourceListQuery(revision, cacheKey, resources.stream().map(resource -> resource.getId()).collect(Collectors.toSet()), resourceServerId), resourceServerId, consumer);\n          \n          \n            \n                                (revision, resources) -> new ResourceListQuery(revision, cacheKey, resources.stream().map(Resource::getId).collect(Collectors.toSet()), resourceServerId), resourceServerId, consumer);", "url": "https://github.com/keycloak/keycloak/pull/7227#discussion_r454398156", "createdAt": "2020-07-14T14:28:26Z", "author": {"login": "mhajas"}, "path": "model/infinispan/src/main/java/org/keycloak/models/cache/infinispan/authorization/StoreFactoryCacheSession.java", "diffHunk": "@@ -672,7 +672,17 @@ public Resource findByName(String name, String ownerId, String resourceServerId)\n         @Override\n         public void findByOwner(String ownerId, String resourceServerId, Consumer<Resource> consumer) {\n             String cacheKey = getResourceByOwnerCacheKey(ownerId, resourceServerId);\n-            cacheQuery(cacheKey, ResourceListQuery.class, () -> getResourceStoreDelegate().findByOwner(ownerId, resourceServerId),\n+            cacheQuery(cacheKey, ResourceListQuery.class, () -> {\n+                        List<Resource> resources = new ArrayList<>();\n+                        getResourceStoreDelegate().findByOwner(ownerId, resourceServerId, new Consumer<Resource>() {\n+                            @Override\n+                            public void accept(Resource resource) {\n+                                resources.add(resource);\n+                                consumer.accept(resource);\n+                            }\n+                        });\n+                        return resources;\n+                    },\n                     (revision, resources) -> new ResourceListQuery(revision, cacheKey, resources.stream().map(resource -> resource.getId()).collect(Collectors.toSet()), resourceServerId), resourceServerId, consumer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "387d02ebf03c271e8aeea411997ce182eb989834"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQwNjExNQ==", "bodyText": "This was not necessary before, why do we need it now? cacheQuery method is calling consumer.accept()", "url": "https://github.com/keycloak/keycloak/pull/7227#discussion_r454406115", "createdAt": "2020-07-14T14:38:36Z", "author": {"login": "mhajas"}, "path": "model/infinispan/src/main/java/org/keycloak/models/cache/infinispan/authorization/StoreFactoryCacheSession.java", "diffHunk": "@@ -943,7 +998,17 @@ public void findByResource(String resourceId, String resourceServerId, Consumer<\n         @Override\n         public void findByResourceType(String resourceType, String resourceServerId, Consumer<Policy> consumer) {\n             String cacheKey = getPolicyByResourceType(resourceType, resourceServerId);\n-            cacheQuery(cacheKey, PolicyResourceListQuery.class, () -> getPolicyStoreDelegate().findByResourceType(resourceType, resourceServerId),\n+            cacheQuery(cacheKey, PolicyResourceListQuery.class, () -> {\n+                        List<Policy> policies = new ArrayList<>();\n+                        getPolicyStoreDelegate().findByResourceType(resourceType, resourceServerId, new Consumer<Policy>() {\n+                            @Override\n+                            public void accept(Policy policy) {\n+                                policies.add(policy);\n+                                consumer.accept(policy);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "387d02ebf03c271e8aeea411997ce182eb989834"}, "originalPosition": 148}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56c0a7372278bf9a7dbb07eed0e55576bad79e17", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/56c0a7372278bf9a7dbb07eed0e55576bad79e17", "committedDate": "2020-07-16T13:45:33Z", "message": "[KEYCLOAK-14646] - Improving permission resolution and evaluation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e572ac2869001fa871d3e46ec453415df64e312", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/8e572ac2869001fa871d3e46ec453415df64e312", "committedDate": "2020-07-14T19:51:03Z", "message": "Update model/infinispan/src/main/java/org/keycloak/models/cache/infinispan/authorization/StoreFactoryCacheSession.java\n\nCo-authored-by: Michal Hajas <mhajas@redhat.com>"}, "afterCommit": {"oid": "56c0a7372278bf9a7dbb07eed0e55576bad79e17", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/56c0a7372278bf9a7dbb07eed0e55576bad79e17", "committedDate": "2020-07-16T13:45:33Z", "message": "[KEYCLOAK-14646] - Improving permission resolution and evaluation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8146d18d6daaa48bf3daa81f6f5af2603b47157c", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/8146d18d6daaa48bf3daa81f6f5af2603b47157c", "committedDate": "2020-07-17T14:27:14Z", "message": "[KEYCLOAK-14646] - Changing cacheQuery"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0fee786869634334b2ecdf15c11b7879372e110f", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/0fee786869634334b2ecdf15c11b7879372e110f", "committedDate": "2020-07-17T12:27:32Z", "message": "[KEYCLOAK-14646] - Changing cacheQuery"}, "afterCommit": {"oid": "8146d18d6daaa48bf3daa81f6f5af2603b47157c", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/8146d18d6daaa48bf3daa81f6f5af2603b47157c", "committedDate": "2020-07-17T14:27:14Z", "message": "[KEYCLOAK-14646] - Changing cacheQuery"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwODMxMDcy", "url": "https://github.com/keycloak/keycloak/pull/7227#pullrequestreview-450831072", "createdAt": "2020-07-17T17:21:56Z", "commit": {"oid": "8146d18d6daaa48bf3daa81f6f5af2603b47157c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMzk0NjU3", "url": "https://github.com/keycloak/keycloak/pull/7227#pullrequestreview-452394657", "createdAt": "2020-07-21T12:15:53Z", "commit": {"oid": "8146d18d6daaa48bf3daa81f6f5af2603b47157c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3023, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}