{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1OTgyNTE0", "number": 7177, "title": "KEYCLOAK-13206 Session Status iframe cannot access cookies when 3rd party cookies are blocked", "bodyText": "I didn't eventually take the suggested approach to set KEYCLOAK_SESSION to a special value when logging out instead of removing it. It turned out to be problematic because we couldn't differ between the case when cookies are blocked and when they just expired.", "createdAt": "2020-06-17T17:04:40Z", "url": "https://github.com/keycloak/keycloak/pull/7177", "merged": true, "mergeCommit": {"oid": "001fe9eb11b508abfd52229bd277509ea96a2348"}, "closed": true, "closedAt": "2020-06-30T20:11:21Z", "author": {"login": "vmuzikar"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsNAmJABqjM0NTQ1ODUzMjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWW1h8gFqTUxNjk0OTE0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30092a95f41e130b875134de6be3aa9cb7090356", "author": {"user": {"login": "vmuzikar", "name": "V\u00e1clav Muzik\u00e1\u0159"}}, "url": "https://github.com/keycloak/keycloak/commit/30092a95f41e130b875134de6be3aa9cb7090356", "committedDate": "2020-06-17T17:03:58Z", "message": "KEYCLOAK-13206 Session Status iframe cannot access cookies when 3rd party cookies are blocked\n\nCo-authored-by: mhajas <mhajas@redhat.com>"}, "afterCommit": {"oid": "b9433660b5f413c0d8e3332c13f55c2b764794e5", "author": {"user": {"login": "vmuzikar", "name": "V\u00e1clav Muzik\u00e1\u0159"}}, "url": "https://github.com/keycloak/keycloak/commit/b9433660b5f413c0d8e3332c13f55c2b764794e5", "committedDate": "2020-06-17T17:07:31Z", "message": "KEYCLOAK-13206 Session Status iframe cannot access cookies when 3rd party cookies are blocked\n\nCo-authored-by: mhajas <mhajas@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMDU0MTM5", "url": "https://github.com/keycloak/keycloak/pull/7177#pullrequestreview-433054139", "createdAt": "2020-06-18T08:27:19Z", "commit": {"oid": "b9433660b5f413c0d8e3332c13f55c2b764794e5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwODoyNzoyMFrOGlk-GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwODoyNzoyMFrOGlk-GA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA1NjIxNg==", "bodyText": "You can't do this I'm afraid, as it is not correct behaviour with regards to the spec. According to the spec it should send unchanged if expected session matches actual state, or changed if it doesn't. See https://openid.net/specs/openid-connect-session-1_0.html#RPiframe", "url": "https://github.com/keycloak/keycloak/pull/7177#discussion_r442056216", "createdAt": "2020-06-18T08:27:20Z", "author": {"login": "stianst"}, "path": "adapters/oidc/js/src/main/resources/login-status-iframe.html", "diffHunk": "@@ -54,7 +54,11 @@\n                         }\n                         if (!cookie) {\n                             if (sessionState != '') {\n-                                callback('changed');\n+                                // Adapter was authenticated (session ID exists) but session cookie is not found.\n+                                // Either user was logged out shortly after authentication but before this iframe could be\n+                                // loaded (usually just a few seconds), which is really a corner case, or 3rd part cookies\n+                                // are blocked which is the most probable scenario.\n+                                callback('cookie_not_found');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9433660b5f413c0d8e3332c13f55c2b764794e5"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMTI4MzMz", "url": "https://github.com/keycloak/keycloak/pull/7177#pullrequestreview-433128333", "createdAt": "2020-06-18T09:59:11Z", "commit": {"oid": "b9433660b5f413c0d8e3332c13f55c2b764794e5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwOTo1OToxMVrOGloXCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwOTo1OToxMVrOGloXCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjExMTc1NA==", "bodyText": "Not sure this has any other simple solution but tests using this boolean will start failing once chrome will block 3rd party cookies by default. Do you have any idea, how to avoid this? Maybe some simple app with iframe within testsuite-providers which will check this? WDYT?", "url": "https://github.com/keycloak/keycloak/pull/7177#discussion_r442111754", "createdAt": "2020-06-18T09:59:11Z", "author": {"login": "mhajas"}, "path": "testsuite/integration-arquillian/tests/base/src/main/java/org/keycloak/testsuite/arquillian/SuiteContext.java", "diffHunk": "@@ -58,7 +60,9 @@\n      * True if the testsuite is running in the adapter backward compatibility testing mode,\n      * i.e. if the tests are running against newer auth server\n      */\n-    private static final boolean adapterCompatTesting = Boolean.parseBoolean(System.getProperty(\"testsuite.adapter.compat.testing\"));\n+    private static final boolean adapterCompatTesting = parseBoolean(System.getProperty(\"testsuite.adapter.compat.testing\"));\n+\n+    private static final boolean browserStrictCookies = parseBoolean(System.getProperty(\"browser.strict.cookies\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9433660b5f413c0d8e3332c13f55c2b764794e5"}, "originalPosition": 16}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b9433660b5f413c0d8e3332c13f55c2b764794e5", "author": {"user": {"login": "vmuzikar", "name": "V\u00e1clav Muzik\u00e1\u0159"}}, "url": "https://github.com/keycloak/keycloak/commit/b9433660b5f413c0d8e3332c13f55c2b764794e5", "committedDate": "2020-06-17T17:07:31Z", "message": "KEYCLOAK-13206 Session Status iframe cannot access cookies when 3rd party cookies are blocked\n\nCo-authored-by: mhajas <mhajas@redhat.com>"}, "afterCommit": {"oid": "990b091e2ab101af4922dbfa09e740454deaa368", "author": {"user": {"login": "vmuzikar", "name": "V\u00e1clav Muzik\u00e1\u0159"}}, "url": "https://github.com/keycloak/keycloak/commit/990b091e2ab101af4922dbfa09e740454deaa368", "committedDate": "2020-06-22T14:40:30Z", "message": "KEYCLOAK-13206 Session Status iframe cannot access cookies when 3rd party cookies are blocked\n\nCo-authored-by: mhajas <mhajas@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MDU4Mzk2", "url": "https://github.com/keycloak/keycloak/pull/7177#pullrequestreview-435058396", "createdAt": "2020-06-22T15:52:21Z", "commit": {"oid": "990b091e2ab101af4922dbfa09e740454deaa368"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4OTY4NjE2", "url": "https://github.com/keycloak/keycloak/pull/7177#pullrequestreview-438968616", "createdAt": "2020-06-29T07:59:18Z", "commit": {"oid": "990b091e2ab101af4922dbfa09e740454deaa368"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cc0e25da6f4ea311bbdc7eb81ba8500b8a28577", "author": {"user": {"login": "vmuzikar", "name": "V\u00e1clav Muzik\u00e1\u0159"}}, "url": "https://github.com/keycloak/keycloak/commit/8cc0e25da6f4ea311bbdc7eb81ba8500b8a28577", "committedDate": "2020-06-30T15:10:56Z", "message": "KEYCLOAK-13206 Session Status iframe cannot access cookies when 3rd party cookies are blocked\n\nCo-authored-by: mhajas <mhajas@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "990b091e2ab101af4922dbfa09e740454deaa368", "author": {"user": {"login": "vmuzikar", "name": "V\u00e1clav Muzik\u00e1\u0159"}}, "url": "https://github.com/keycloak/keycloak/commit/990b091e2ab101af4922dbfa09e740454deaa368", "committedDate": "2020-06-22T14:40:30Z", "message": "KEYCLOAK-13206 Session Status iframe cannot access cookies when 3rd party cookies are blocked\n\nCo-authored-by: mhajas <mhajas@redhat.com>"}, "afterCommit": {"oid": "8cc0e25da6f4ea311bbdc7eb81ba8500b8a28577", "author": {"user": {"login": "vmuzikar", "name": "V\u00e1clav Muzik\u00e1\u0159"}}, "url": "https://github.com/keycloak/keycloak/commit/8cc0e25da6f4ea311bbdc7eb81ba8500b8a28577", "committedDate": "2020-06-30T15:10:56Z", "message": "KEYCLOAK-13206 Session Status iframe cannot access cookies when 3rd party cookies are blocked\n\nCo-authored-by: mhajas <mhajas@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMzQ5Nzgy", "url": "https://github.com/keycloak/keycloak/pull/7177#pullrequestreview-440349782", "createdAt": "2020-06-30T20:11:12Z", "commit": {"oid": "8cc0e25da6f4ea311bbdc7eb81ba8500b8a28577"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2OTQ5MTQy", "url": "https://github.com/keycloak/keycloak/pull/7177#pullrequestreview-516949142", "createdAt": "2020-10-26T16:19:56Z", "commit": {"oid": "8cc0e25da6f4ea311bbdc7eb81ba8500b8a28577"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoxOTo1NlrOHoXfGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjoxOTo1NlrOHoXfGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA4OTg4Mw==", "bodyText": "This breaks with any browser extension (e.g. FoxyGestures or React Dev Tools in Firefox) hat sends messages to new windows. Your code needs to be resilient to any message it does not recognize and not consider it an error.", "url": "https://github.com/keycloak/keycloak/pull/7177#discussion_r512089883", "createdAt": "2020-10-26T16:19:56Z", "author": {"login": "ThiefMaster"}, "path": "adapters/oidc/js/src/main/resources/keycloak.js", "diffHunk": "@@ -1276,6 +1294,45 @@\n             return promise.promise;\n         }\n \n+        function check3pCookiesSupported() {\n+            var promise = createPromise();\n+\n+            if (loginIframe.enable || kc.silentCheckSsoRedirectUri) {\n+                var iframe = document.createElement('iframe');\n+                iframe.setAttribute('src', kc.endpoints.thirdPartyCookiesIframe());\n+                iframe.setAttribute('title', 'keycloak-3p-check-iframe' );\n+                iframe.style.display = 'none';\n+                document.body.appendChild(iframe);\n+\n+                var messageCallback = function(event) {\n+                    if (iframe.contentWindow !== event.source) {\n+                        return;\n+                    }\n+\n+                    if (event.data !== \"supported\" && event.data !== \"unsupported\") {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cc0e25da6f4ea311bbdc7eb81ba8500b8a28577"}, "originalPosition": 60}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2976, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}