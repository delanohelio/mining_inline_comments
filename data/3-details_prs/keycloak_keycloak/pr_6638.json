{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5NTc5OTY4", "number": 6638, "title": "KEYCLOAK-7014 - Correctly handle null-values in UserAttributes", "bodyText": "This PR is replacement of #5138 I've added integration tests instead of mock unit test which prevented the original PR to be merged.", "createdAt": "2020-01-06T15:03:32Z", "url": "https://github.com/keycloak/keycloak/pull/6638", "merged": true, "mergeCommit": {"oid": "a2b3747d0e0305d1a6d60b62ed2f46898b407933"}, "closed": true, "closedAt": "2020-01-10T11:44:53Z", "author": {"login": "vramik"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4CX8VgFqTMzOTMwMDM2Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb49FNLgFqTM0MTExMjgxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MzAwMzY3", "url": "https://github.com/keycloak/keycloak/pull/6638#pullrequestreview-339300367", "createdAt": "2020-01-07T15:15:42Z", "commit": {"oid": "2588db4cc48a4fb153362594155c34144188e2ee"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNToxNTo0MlrOFa8XMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNToxOTowOVrOFa8eSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc5NjI3NQ==", "bodyText": "nit: assertThat(users, hasSize(1));", "url": "https://github.com/keycloak/keycloak/pull/6638#discussion_r363796275", "createdAt": "2020-01-07T15:15:42Z", "author": {"login": "hmlnarik"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/admin/UserTest.java", "diffHunk": "@@ -716,6 +718,19 @@ public void attributes() {\n         assertNull(user1.getAttributes());\n     }\n \n+    @Test\n+    public void testImportUserWithNullAttribute() {\n+        RealmRepresentation rep = loadJson(getClass().getResourceAsStream(\"/import/testrealm-user-null-attr.json\"), RealmRepresentation.class);\n+\n+        try (Creator<RealmResource> c = Creator.create(adminClient, rep)) {\n+            List<UserRepresentation> users = c.resource().users().list();\n+            // there should be only one user\n+            assertThat(users.size(), equalTo(1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2588db4cc48a4fb153362594155c34144188e2ee"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc5NjQxNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // test there are only 2 attibutes imported from json file, attribute \"key3\" : [ null ] shoudn't be imported\n          \n          \n            \n                        // test there are only 2 attributes imported from json file, attribute \"key3\" : [ null ] shoudn't be imported", "url": "https://github.com/keycloak/keycloak/pull/6638#discussion_r363796414", "createdAt": "2020-01-07T15:15:58Z", "author": {"login": "hmlnarik"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/admin/UserTest.java", "diffHunk": "@@ -716,6 +718,19 @@ public void attributes() {\n         assertNull(user1.getAttributes());\n     }\n \n+    @Test\n+    public void testImportUserWithNullAttribute() {\n+        RealmRepresentation rep = loadJson(getClass().getResourceAsStream(\"/import/testrealm-user-null-attr.json\"), RealmRepresentation.class);\n+\n+        try (Creator<RealmResource> c = Creator.create(adminClient, rep)) {\n+            List<UserRepresentation> users = c.resource().users().list();\n+            // there should be only one user\n+            assertThat(users.size(), equalTo(1));\n+            // test there are only 2 attibutes imported from json file, attribute \"key3\" : [ null ] shoudn't be imported", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2588db4cc48a4fb153362594155c34144188e2ee"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc5ODA5MA==", "bodyText": "No need to realize this list into memory via .collect. you can either obtain a stream iterator() or use Stream.forEach().", "url": "https://github.com/keycloak/keycloak/pull/6638#discussion_r363798090", "createdAt": "2020-01-07T15:19:09Z", "author": {"login": "hmlnarik"}, "path": "model/jpa/src/main/java/org/keycloak/models/jpa/UserAdapter.java", "diffHunk": "@@ -147,8 +152,9 @@ public void setAttribute(String name, List<String> values) {\n         // Remove all existing\n         removeAttribute(name);\n \n-        // Put all new\n-        for (String value : values) {\n+        List<String> nonNullValues = values.stream().filter(Objects::nonNull).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2588db4cc48a4fb153362594155c34144188e2ee"}, "originalPosition": 81}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2588db4cc48a4fb153362594155c34144188e2ee", "author": {"user": {"login": "vramik", "name": "Vlasta Ramik"}}, "url": "https://github.com/keycloak/keycloak/commit/2588db4cc48a4fb153362594155c34144188e2ee", "committedDate": "2020-01-06T14:57:41Z", "message": "KEYCLOAK-7014 - Correctly handle null-values in UserAttributes"}, "afterCommit": {"oid": "bc144b6a198aab57fe3c721eb7569fb9c93896b3", "author": {"user": {"login": "vramik", "name": "Vlasta Ramik"}}, "url": "https://github.com/keycloak/keycloak/commit/bc144b6a198aab57fe3c721eb7569fb9c93896b3", "committedDate": "2020-01-08T12:03:19Z", "message": "KEYCLOAK-7014 - Correctly handle null-values in UserAttributes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c9705411aa344dcbeb80133b5f2fc93db5df2a2", "author": {"user": {"login": "vramik", "name": "Vlasta Ramik"}}, "url": "https://github.com/keycloak/keycloak/commit/5c9705411aa344dcbeb80133b5f2fc93db5df2a2", "committedDate": "2020-01-08T12:45:56Z", "message": "KEYCLOAK-7014 - Correctly handle null-values in UserAttributes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bc144b6a198aab57fe3c721eb7569fb9c93896b3", "author": {"user": {"login": "vramik", "name": "Vlasta Ramik"}}, "url": "https://github.com/keycloak/keycloak/commit/bc144b6a198aab57fe3c721eb7569fb9c93896b3", "committedDate": "2020-01-08T12:03:19Z", "message": "KEYCLOAK-7014 - Correctly handle null-values in UserAttributes"}, "afterCommit": {"oid": "5c9705411aa344dcbeb80133b5f2fc93db5df2a2", "author": {"user": {"login": "vramik", "name": "Vlasta Ramik"}}, "url": "https://github.com/keycloak/keycloak/commit/5c9705411aa344dcbeb80133b5f2fc93db5df2a2", "committedDate": "2020-01-08T12:45:56Z", "message": "KEYCLOAK-7014 - Correctly handle null-values in UserAttributes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMTEyODE5", "url": "https://github.com/keycloak/keycloak/pull/6638#pullrequestreview-341112819", "createdAt": "2020-01-10T11:44:35Z", "commit": {"oid": "5c9705411aa344dcbeb80133b5f2fc93db5df2a2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2687, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}