{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxODk3ODcz", "number": 6743, "title": "KEYCLOAK-9632 Improve handling of user locale", "bodyText": "There's a few bugs reported around how we handle retrieving and updating the locale. It's pretty much impossible to resolve these without refactoring the way we handle locales, hence the refactor.\nThis PR is not following the proposed solution in KEYCLOAK-9632 as I believe I have a better way now.\nFirst the DefaultLocaleSelectorProvider will only find the locale, and will not perform any updates. It follows this logic (returning the first that is available):\n\nUser requested (if user has selected the drop-down on the login form)\nUser profile\nClient selected (ui_locales param from OIDC)\nCookie\nAccepted Languages header\nRealm default\n\nUpdating the locale is done in a required action instead, which makes it happen at the correct time. It does the following updates:\n\nIf user has requested a locale update the user to that locale\nIf user has a locale then update the locale cookie (so next time the user opens the login form before authenticating it will be in the previous selected locale)\n\nTODO\n\n Enable update locale action by default in new and existing realms\n Add some tests for relevant bugs that this is aiming to resolve\n Review how this affects account console, and possibly admin console", "createdAt": "2020-02-06T13:25:32Z", "url": "https://github.com/keycloak/keycloak/pull/6743", "merged": true, "mergeCommit": {"oid": "42773592ca61bca3953d274e6f6053f4f792361c"}, "closed": true, "closedAt": "2020-02-14T07:32:21Z", "author": {"login": "stianst"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBw6hJABqjMwMTU0MDI2OTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcD9inAAFqTM1ODM2MTA3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b8a77e63eeed5137fe949636e7665c7c79f4a586", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/b8a77e63eeed5137fe949636e7665c7c79f4a586", "committedDate": "2020-02-06T20:38:38Z", "message": "Updates"}, "afterCommit": {"oid": "dbaabe55d4e54dcca487c5a85b04328c61e5326e", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/dbaabe55d4e54dcca487c5a85b04328c61e5326e", "committedDate": "2020-02-06T20:39:15Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dbaabe55d4e54dcca487c5a85b04328c61e5326e", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/dbaabe55d4e54dcca487c5a85b04328c61e5326e", "committedDate": "2020-02-06T20:39:15Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}, "afterCommit": {"oid": "65b56684ac1a859af1195377d84e2d786e83e4db", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/65b56684ac1a859af1195377d84e2d786e83e4db", "committedDate": "2020-02-06T20:42:35Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "65b56684ac1a859af1195377d84e2d786e83e4db", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/65b56684ac1a859af1195377d84e2d786e83e4db", "committedDate": "2020-02-06T20:42:35Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}, "afterCommit": {"oid": "a8eb3be4e1c7bf8bcbd81512ebfbe24528fe4fbc", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/a8eb3be4e1c7bf8bcbd81512ebfbe24528fe4fbc", "committedDate": "2020-02-06T20:46:24Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a8eb3be4e1c7bf8bcbd81512ebfbe24528fe4fbc", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/a8eb3be4e1c7bf8bcbd81512ebfbe24528fe4fbc", "committedDate": "2020-02-06T20:46:24Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}, "afterCommit": {"oid": "5c11c268f91474bc3316d6487f42500a0755894f", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/5c11c268f91474bc3316d6487f42500a0755894f", "committedDate": "2020-02-06T20:50:36Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NzgxMTg5", "url": "https://github.com/keycloak/keycloak/pull/6743#pullrequestreview-354781189", "createdAt": "2020-02-06T21:22:48Z", "commit": {"oid": "5c11c268f91474bc3316d6487f42500a0755894f"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMToyMjo0OFrOFmqqWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQyMToyMjo0OFrOFmqqWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA4OTE3Nw==", "bodyText": "You also need to do this on line 199.", "url": "https://github.com/keycloak/keycloak/pull/6743#discussion_r376089177", "createdAt": "2020-02-06T21:22:48Z", "author": {"login": "ssilvert"}, "path": "themes/src/main/resources/theme/keycloak-preview/account/index.ftl", "diffHunk": "@@ -155,7 +155,7 @@\n             </div>\n             </#if>\n \n-            <#if realm.internationalizationEnabled  && supportedLocales?size gt 1>\n+            <#if false && realm.internationalizationEnabled  && supportedLocales?size gt 1>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c11c268f91474bc3316d6487f42500a0755894f"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c11c268f91474bc3316d6487f42500a0755894f", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/5c11c268f91474bc3316d6487f42500a0755894f", "committedDate": "2020-02-06T20:50:36Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}, "afterCommit": {"oid": "dc0a324e75023cd6576e40f3399f838edf9abce1", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/dc0a324e75023cd6576e40f3399f838edf9abce1", "committedDate": "2020-02-07T06:06:13Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dc0a324e75023cd6576e40f3399f838edf9abce1", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/dc0a324e75023cd6576e40f3399f838edf9abce1", "committedDate": "2020-02-07T06:06:13Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}, "afterCommit": {"oid": "14592aa5030f3d2702b86998811479c06f2f87c6", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/14592aa5030f3d2702b86998811479c06f2f87c6", "committedDate": "2020-02-07T08:37:41Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "14592aa5030f3d2702b86998811479c06f2f87c6", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/14592aa5030f3d2702b86998811479c06f2f87c6", "committedDate": "2020-02-07T08:37:41Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}, "afterCommit": {"oid": "7dfe9af1cf049810360d31479a6e23b14fa2d1b7", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/7dfe9af1cf049810360d31479a6e23b14fa2d1b7", "committedDate": "2020-02-07T14:09:18Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7dfe9af1cf049810360d31479a6e23b14fa2d1b7", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/7dfe9af1cf049810360d31479a6e23b14fa2d1b7", "committedDate": "2020-02-07T14:09:18Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}, "afterCommit": {"oid": "af454df3986b080261e1ab201274708477930ee3", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/af454df3986b080261e1ab201274708477930ee3", "committedDate": "2020-02-10T08:48:46Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "af454df3986b080261e1ab201274708477930ee3", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/af454df3986b080261e1ab201274708477930ee3", "committedDate": "2020-02-10T08:48:46Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}, "afterCommit": {"oid": "f9f9e6307e3b6c8c591ee0b27782a5c3520df256", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/f9f9e6307e3b6c8c591ee0b27782a5c3520df256", "committedDate": "2020-02-10T08:50:28Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f9f9e6307e3b6c8c591ee0b27782a5c3520df256", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/f9f9e6307e3b6c8c591ee0b27782a5c3520df256", "committedDate": "2020-02-10T08:50:28Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}, "afterCommit": {"oid": "cf22c6b7c04e1f9f287c59c123b44fd24b21c887", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/cf22c6b7c04e1f9f287c59c123b44fd24b21c887", "committedDate": "2020-02-10T10:09:33Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MDk4Mzcw", "url": "https://github.com/keycloak/keycloak/pull/6743#pullrequestreview-356098370", "createdAt": "2020-02-10T16:52:10Z", "commit": {"oid": "cf22c6b7c04e1f9f287c59c123b44fd24b21c887"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NTg1NjEz", "url": "https://github.com/keycloak/keycloak/pull/6743#pullrequestreview-356585613", "createdAt": "2020-02-11T11:32:20Z", "commit": {"oid": "cf22c6b7c04e1f9f287c59c123b44fd24b21c887"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cf22c6b7c04e1f9f287c59c123b44fd24b21c887", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/cf22c6b7c04e1f9f287c59c123b44fd24b21c887", "committedDate": "2020-02-10T10:09:33Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}, "afterCommit": {"oid": "3785884249083620c35d217d339fd62e91ecf54d", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/3785884249083620c35d217d339fd62e91ecf54d", "committedDate": "2020-02-12T08:17:21Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd727e2071c8f6b932fba07419667d281004e302", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/fd727e2071c8f6b932fba07419667d281004e302", "committedDate": "2020-02-13T15:47:42Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3785884249083620c35d217d339fd62e91ecf54d", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/3785884249083620c35d217d339fd62e91ecf54d", "committedDate": "2020-02-12T08:17:21Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}, "afterCommit": {"oid": "fd727e2071c8f6b932fba07419667d281004e302", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/fd727e2071c8f6b932fba07419667d281004e302", "committedDate": "2020-02-13T15:47:42Z", "message": "KEYCLOAK-9632 Improve handling of user locale"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MzYxMDc5", "url": "https://github.com/keycloak/keycloak/pull/6743#pullrequestreview-358361079", "createdAt": "2020-02-13T16:25:25Z", "commit": {"oid": "fd727e2071c8f6b932fba07419667d281004e302"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNjoyNToyNVrOFpahnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNjoyNToyNVrOFpahnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MDUyNA==", "bodyText": "RequiredAction is basically used here as a callback to be triggered after authentication. This works fine, on the other hand it looks to me as a workaround. It has some unneeded side-effects (EG. administrator will see \"update user locale\" as requiredAction and they will be able to set it to users. This won't have any effect and might be slightly confusing etc).\nIt may be better to have something like \"Interceptor SPI\" or possibly re-use our EventSPI. However using Event SPI in it's current form looks also as a workaround an I guess we don't have proper event yet for \"POST_REQUIRED_ACTIONS\", which is triggered after success of all required actions etc.\nIn shortcut, consider that we don't have better SPI right now, I am fine with using it as it for this PR :)", "url": "https://github.com/keycloak/keycloak/pull/6743#discussion_r378970524", "createdAt": "2020-02-13T16:25:25Z", "author": {"login": "mposolda"}, "path": "services/src/main/java/org/keycloak/authentication/requiredactions/UpdateUserLocaleAction.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package org.keycloak.authentication.requiredactions;\n+\n+import org.keycloak.Config;\n+import org.keycloak.authentication.RequiredActionContext;\n+import org.keycloak.authentication.RequiredActionFactory;\n+import org.keycloak.authentication.RequiredActionProvider;\n+import org.keycloak.locale.LocaleSelectorProvider;\n+import org.keycloak.models.KeycloakSession;\n+import org.keycloak.models.KeycloakSessionFactory;\n+import org.keycloak.models.UserModel;\n+\n+public class UpdateUserLocaleAction implements RequiredActionProvider, RequiredActionFactory {\n+\n+    @Override\n+    public String getDisplayText() {\n+        return \"Update User Locale\";\n+    }\n+\n+    @Override\n+    public void evaluateTriggers(RequiredActionContext context) {\n+        String userRequestedLocale = context.getAuthenticationSession().getAuthNote(LocaleSelectorProvider.USER_REQUEST_LOCALE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd727e2071c8f6b932fba07419667d281004e302"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2639, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}