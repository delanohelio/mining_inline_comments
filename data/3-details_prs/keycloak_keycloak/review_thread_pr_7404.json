{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyNzE5NTEw", "number": 7404, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNzoyNDo1NlrOEhyBIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNzoyNTozOVrOEhyCLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzODU3OTUzOnYy", "diffSide": "RIGHT", "path": "services/src/main/java/org/keycloak/services/resources/admin/AdminConsole.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNzoyNDo1NlrOHPSajg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNTozNzo1NVrOHPjxdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5MjM5OA==", "bodyText": "Isn't there a NPE waiting to happen here if set1 is null? IIRC the HasSet constructor raises an NPE if the collection specified in the constructor is null.", "url": "https://github.com/keycloak/keycloak/pull/7404#discussion_r485792398", "createdAt": "2020-09-09T17:24:56Z", "author": {"login": "sguilhen"}, "path": "services/src/main/java/org/keycloak/services/resources/admin/AdminConsole.java", "diffHunk": "@@ -232,28 +233,36 @@ public Response whoAmI(final @Context HttpHeaders headers) {\n     private void addRealmAccess(RealmModel realm, UserModel user, Map<String, Set<String>> realmAdminAccess) {\n         RealmManager realmManager = new RealmManager(session);\n         ClientModel realmAdminApp = realm.getClientByClientId(realmManager.getRealmAdminClientId(realm));\n-        getRealmAdminAccess(realmAdminApp, user, realmAdminAccess);\n+        getRealmAdminAccess(realm, realmAdminApp, user, realmAdminAccess);\n     }\n \n     private void addMasterRealmAccess(UserModel user, Map<String, Set<String>> realmAdminAccess) {\n         List<RealmModel> realms = session.realms().getRealms();\n         for (RealmModel realm : realms) {\n             ClientModel realmAdminApp = realm.getMasterAdminClient();\n-            getRealmAdminAccess(realmAdminApp, user, realmAdminAccess);\n+            getRealmAdminAccess(realm, realmAdminApp, user, realmAdminAccess);\n         }\n     }\n \n-    private void getRealmAdminAccess(ClientModel client, UserModel user, Map<String, Set<String>> realmAdminAccess) {\n-        Set<String> roles = client.getRolesStream().filter(user::hasRole)\n-                .map(RoleModel::getName).collect(Collectors.toSet());\n \n-        if (!roles.isEmpty()) {\n-            if (!realmAdminAccess.containsKey(realm.getName())) {\n-                realmAdminAccess.put(realm.getName(), roles);\n-            } else {\n-                realmAdminAccess.get(realm.getName()).addAll(roles);\n-            }\n+    private static <T> HashSet<T> union(Set<T> set1, Set<T> set2) {\n+        if (set1 == null && set2 == null) {\n+            return null;\n+        }\n+        HashSet<T> res = (set1 instanceof HashSet) ? (HashSet <T>) set1 : new HashSet<>(set1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "926c535f98dd1ff34e57984cf7d688c4860b2a1f"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA3Njc5MA==", "bodyText": "Good catch, indeed!", "url": "https://github.com/keycloak/keycloak/pull/7404#discussion_r486076790", "createdAt": "2020-09-10T05:37:55Z", "author": {"login": "hmlnarik"}, "path": "services/src/main/java/org/keycloak/services/resources/admin/AdminConsole.java", "diffHunk": "@@ -232,28 +233,36 @@ public Response whoAmI(final @Context HttpHeaders headers) {\n     private void addRealmAccess(RealmModel realm, UserModel user, Map<String, Set<String>> realmAdminAccess) {\n         RealmManager realmManager = new RealmManager(session);\n         ClientModel realmAdminApp = realm.getClientByClientId(realmManager.getRealmAdminClientId(realm));\n-        getRealmAdminAccess(realmAdminApp, user, realmAdminAccess);\n+        getRealmAdminAccess(realm, realmAdminApp, user, realmAdminAccess);\n     }\n \n     private void addMasterRealmAccess(UserModel user, Map<String, Set<String>> realmAdminAccess) {\n         List<RealmModel> realms = session.realms().getRealms();\n         for (RealmModel realm : realms) {\n             ClientModel realmAdminApp = realm.getMasterAdminClient();\n-            getRealmAdminAccess(realmAdminApp, user, realmAdminAccess);\n+            getRealmAdminAccess(realm, realmAdminApp, user, realmAdminAccess);\n         }\n     }\n \n-    private void getRealmAdminAccess(ClientModel client, UserModel user, Map<String, Set<String>> realmAdminAccess) {\n-        Set<String> roles = client.getRolesStream().filter(user::hasRole)\n-                .map(RoleModel::getName).collect(Collectors.toSet());\n \n-        if (!roles.isEmpty()) {\n-            if (!realmAdminAccess.containsKey(realm.getName())) {\n-                realmAdminAccess.put(realm.getName(), roles);\n-            } else {\n-                realmAdminAccess.get(realm.getName()).addAll(roles);\n-            }\n+    private static <T> HashSet<T> union(Set<T> set1, Set<T> set2) {\n+        if (set1 == null && set2 == null) {\n+            return null;\n+        }\n+        HashSet<T> res = (set1 instanceof HashSet) ? (HashSet <T>) set1 : new HashSet<>(set1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5MjM5OA=="}, "originalCommit": {"oid": "926c535f98dd1ff34e57984cf7d688c4860b2a1f"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzODU4MjIyOnYy", "diffSide": "RIGHT", "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/admin/AdminConsolePermissionsCalculatedTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNzoyNTozOVrOHPScQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNzoyNTozOVrOHPScQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5MjgzNA==", "bodyText": "License header", "url": "https://github.com/keycloak/keycloak/pull/7404#discussion_r485792834", "createdAt": "2020-09-09T17:25:39Z", "author": {"login": "sguilhen"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/admin/AdminConsolePermissionsCalculatedTest.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package org.keycloak.testsuite.admin;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "926c535f98dd1ff34e57984cf7d688c4860b2a1f"}, "originalPosition": 1}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3430, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}