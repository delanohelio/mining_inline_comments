{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM4NTA1NDg2", "number": 7675, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxMToyMzoyNFrOFE7ztg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxODo1NDoyNlrOFFwJrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQwNzE4NTE4OnYy", "diffSide": "RIGHT", "path": "services/src/main/java/org/keycloak/broker/saml/mappers/UsernameTemplateMapper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxMToyMzoyNFrOIFL9Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxMToyMzoyNFrOIFL9Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwOTY3OA==", "bodyText": "Please add this to the helptext above (line 79).", "url": "https://github.com/keycloak/keycloak/pull/7675#discussion_r542309678", "createdAt": "2020-12-14T11:23:24Z", "author": {"login": "hmlnarik"}, "path": "services/src/main/java/org/keycloak/broker/saml/mappers/UsernameTemplateMapper.java", "diffHunk": "@@ -92,10 +92,15 @@\n \n         TRANSFORMERS.put(\"uppercase\", String::toUpperCase);\n         TRANSFORMERS.put(\"lowercase\", String::toLowerCase);\n+        TRANSFORMERS.put(\"localpart\", UsernameTemplateMapper::getEmailLocalPart);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11659aec370f1b576ebf74c869a8e509e642a656"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMjU0NjA2OnYy", "diffSide": "RIGHT", "path": "services/src/main/java/org/keycloak/broker/saml/mappers/UsernameTemplateMapper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNzo1MDo0NVrOIF9W4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMDo1ODo0MlrOIGFF3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzExOTA3NA==", "bodyText": "Apologies, I missed a potential for IndexOutOfBoundsException here in my preview review. lastIndexOf can return negative value and this would lead to the exception because -1 < 0\nWhen at it, prefer the character form over the String one, ie.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  return email.substring(0, email.lastIndexOf(\"@\"));\n          \n          \n            \n                  return email.substring(0, email.lastIndexOf('@'));", "url": "https://github.com/keycloak/keycloak/pull/7675#discussion_r543119074", "createdAt": "2020-12-15T07:50:45Z", "author": {"login": "hmlnarik"}, "path": "services/src/main/java/org/keycloak/broker/saml/mappers/UsernameTemplateMapper.java", "diffHunk": "@@ -92,10 +93,15 @@\n \n         TRANSFORMERS.put(\"uppercase\", String::toUpperCase);\n         TRANSFORMERS.put(\"lowercase\", String::toLowerCase);\n+        TRANSFORMERS.put(\"localpart\", UsernameTemplateMapper::getEmailLocalPart);\n     }\n \n     public static final String PROVIDER_ID = \"saml-username-idp-mapper\";\n \n+    public static String getEmailLocalPart(String email) {\n+      return email.substring(0, email.lastIndexOf(\"@\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "112222aa826ae4f16a2056b8f8752fdfa952924c"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI0NTc4OQ==", "bodyText": "Good point. This should resolve it.\nI made the transformer a no-op for such case and modified help text accordingly.", "url": "https://github.com/keycloak/keycloak/pull/7675#discussion_r543245789", "createdAt": "2020-12-15T10:58:42Z", "author": {"login": "jiri-lunacek"}, "path": "services/src/main/java/org/keycloak/broker/saml/mappers/UsernameTemplateMapper.java", "diffHunk": "@@ -92,10 +93,15 @@\n \n         TRANSFORMERS.put(\"uppercase\", String::toUpperCase);\n         TRANSFORMERS.put(\"lowercase\", String::toLowerCase);\n+        TRANSFORMERS.put(\"localpart\", UsernameTemplateMapper::getEmailLocalPart);\n     }\n \n     public static final String PROVIDER_ID = \"saml-username-idp-mapper\";\n \n+    public static String getEmailLocalPart(String email) {\n+      return email.substring(0, email.lastIndexOf(\"@\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzExOTA3NA=="}, "originalCommit": {"oid": "112222aa826ae4f16a2056b8f8752fdfa952924c"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxNTc2MTEwOnYy", "diffSide": "RIGHT", "path": "services/src/main/java/org/keycloak/broker/saml/mappers/UsernameTemplateMapper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxODo1NDoyNlrOIGa1pQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxODo1NDoyNlrOIGa1pQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzYwMjA4NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    int index = email.lastIndexOf(\"@\");\n          \n          \n            \n                    if (index >= 0) {\n          \n          \n            \n                        return email.substring(0, email.lastIndexOf(\"@\"));\n          \n          \n            \n                    int index = email == null ? -1 : email.lastIndexOf('@');\n          \n          \n            \n                    if (index >= 0) {\n          \n          \n            \n                        return email.substring(0, index);", "url": "https://github.com/keycloak/keycloak/pull/7675#discussion_r543602085", "createdAt": "2020-12-15T18:54:26Z", "author": {"login": "hmlnarik"}, "path": "services/src/main/java/org/keycloak/broker/saml/mappers/UsernameTemplateMapper.java", "diffHunk": "@@ -92,10 +93,20 @@\n \n         TRANSFORMERS.put(\"uppercase\", String::toUpperCase);\n         TRANSFORMERS.put(\"lowercase\", String::toLowerCase);\n+        TRANSFORMERS.put(\"localpart\", UsernameTemplateMapper::getEmailLocalPart);\n     }\n \n     public static final String PROVIDER_ID = \"saml-username-idp-mapper\";\n \n+    public static String getEmailLocalPart(String email) {\n+        int index = email.lastIndexOf(\"@\");\n+        if (index >= 0) {\n+            return email.substring(0, email.lastIndexOf(\"@\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95a40c0de10c2c0c63b02301a1ab0398b9f32f1f"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3253, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}