{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2MDM0MDc2", "number": 7241, "title": "KEYCLOAK-14234 KEYCLOAK-13666 support for running adapter tests with different hostnames for auth and app servers", "bodyText": "This is quite an extensive change. It makes the testsuite running with two separate hosts (for app and auth server) and also it fixes some issues with enabling SSL for app server. The main reason is to be able to properly test the newest changes to the SameSite cookie attribute.\nTo test the changes run any adapter test for example with:\n-Dauth.server.host=auth-server.127.0.0.1.nip.io -Dapp.server.host=app-server.127.0.0.1.xip.io -Dapp.server.ssl.required=true\n\nAfter all reviews, I will squash the commits together. For reviewing it will be probably better to have it in more commits.\nResults from Jenkins:\nAdapter: https://keycloak-jenkins.com/job/universal-test-pipeline-adapters/1534/\nServer: https://keycloak-jenkins.com/job/universal-test-pipeline-server/1937/", "createdAt": "2020-07-08T06:50:12Z", "url": "https://github.com/keycloak/keycloak/pull/7241", "merged": true, "mergeCommit": {"oid": "93149d6b478d313e60e970ea4970fa6fb342fe0a"}, "closed": true, "closedAt": "2020-07-20T09:22:18Z", "author": {"login": "mhajas"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczSLvUAFqTQ0NTc1OTIwNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc2uG70AFqTQ1MTQzNzQ0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NzU5MjA0", "url": "https://github.com/keycloak/keycloak/pull/7241#pullrequestreview-445759204", "createdAt": "2020-07-09T16:02:42Z", "commit": {"oid": "6cd6fc8220c0b633c5ee48b1598372c53885f4cc"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNjowMjo0MlrOGvX0Rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNjoxNzozNlrOGvYYlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMyNjQ3MA==", "bodyText": "Just to double check. Is this change intentional? Seems a bit suspicious to me. :)", "url": "https://github.com/keycloak/keycloak/pull/7241#discussion_r452326470", "createdAt": "2020-07-09T16:02:42Z", "author": {"login": "vmuzikar"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/adapter/example/cors/CorsExampleAdapterTest.java", "diffHunk": "@@ -190,7 +184,6 @@ private String getAuthServerVersion() {\n                 \"/auth/admin/master/console/#/server-info\");\n         jsDriverTestRealmLoginPage.form().login(\"admin\", \"admin\");\n \n-        WaitUtils.waitUntilElement(By.tagName(\"body\")).is().visible();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cd6fc8220c0b633c5ee48b1598372c53885f4cc"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMzMzMxMg==", "bodyText": "I think we can remove this test completely now that we we run all SAML tests with different hostnames + SSL.", "url": "https://github.com/keycloak/keycloak/pull/7241#discussion_r452333312", "createdAt": "2020-07-09T16:13:55Z", "author": {"login": "vmuzikar"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/adapter/servlet/SAMLSameSiteTest.java", "diffHunk": "@@ -38,9 +39,10 @@\n @AppServerContainer(ContainerConstants.APP_SERVER_TOMCAT9)\n @AuthServerContainerExclude(AuthServerContainerExclude.AuthServer.REMOTE)\n public class SAMLSameSiteTest extends AbstractSAMLServletAdapterTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cd6fc8220c0b633c5ee48b1598372c53885f4cc"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjMzNTc2NA==", "bodyText": "Just a nitpick. :) Should we use ServletTestUtils.APP_SERVER_HOST instead?", "url": "https://github.com/keycloak/keycloak/pull/7241#discussion_r452335764", "createdAt": "2020-07-09T16:17:36Z", "author": {"login": "vmuzikar"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/adapter/AbstractAdapterClusteredTest.java", "diffHunk": "@@ -84,14 +86,15 @@ public static void checkPropertiesSet() {\n         Assume.assumeThat(PORT_OFFSET_NODE_1, not(is(-1)));\n         Assume.assumeThat(PORT_OFFSET_NODE_2, not(is(-1)));\n         Assume.assumeThat(PORT_OFFSET_NODE_REVPROXY, not(is(-1)));\n+        ContainerAssume.assumeNotAppServerSSL();\n     }\n \n     @Before\n     public void prepareReverseProxy() throws Exception {\n         loadBalancerToNodes = new LoadBalancingProxyClient().addHost(NODE_1_URI, NODE_1_NAME).setConnectionsPerThread(10);\n         int maxTime = 3600000; // 1 hour for proxy request timeout, so we can debug the backend keycloak servers\n         reverseProxyToNodes = Undertow.builder()\n-          .addHttpListener(HTTP_PORT_NODE_REVPROXY, \"localhost\")\n+          .addHttpListener(HTTP_PORT_NODE_REVPROXY, System.getProperty(\"app.server.host\", \"localhost\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cd6fc8220c0b633c5ee48b1598372c53885f4cc"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NzU0NDU0", "url": "https://github.com/keycloak/keycloak/pull/7241#pullrequestreview-449754454", "createdAt": "2020-07-16T11:21:51Z", "commit": {"oid": "b0e04064d4fde3d98ad136c13a3be24e2d1ff8a5"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MTEzMjYy", "url": "https://github.com/keycloak/keycloak/pull/7241#pullrequestreview-445113262", "createdAt": "2020-07-08T20:41:31Z", "commit": {"oid": "fb874d8c0adc8ca5a05f4f602a3359707eb193b1"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQyMDo0MTozMVrOGu4e3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMToxNDo0OFrOGymWeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTgxMzA4Ng==", "bodyText": "This TODO becomes irrelevant after these changes, right?", "url": "https://github.com/keycloak/keycloak/pull/7241#discussion_r451813086", "createdAt": "2020-07-08T20:41:31Z", "author": {"login": "vramik"}, "path": "testsuite/integration-arquillian/test-apps/servlets/src/main/java/org/keycloak/testsuite/adapter/servlet/ServletTestUtils.java", "diffHunk": "@@ -17,40 +17,33 @@\n \n package org.keycloak.testsuite.adapter.servlet;\n \n-import javax.servlet.http.HttpServletRequest;\n-\n-import org.keycloak.common.util.UriUtils;\n+import static java.lang.Integer.parseInt;\n \n /**\n  * @author <a href=\"mailto:mposolda@redhat.com\">Marek Posolda</a>\n  */\n public class ServletTestUtils {\n \n+    public static final boolean AUTH_SERVER_SSL_REQUIRED = Boolean.parseBoolean(System.getProperty(\"auth.server.ssl.required\", \"true\"));\n+    public static final String AUTH_SERVER_PORT = AUTH_SERVER_SSL_REQUIRED ? System.getProperty(\"auth.server.https.port\", \"8543\") : System.getProperty(\"auth.server.http.port\", \"8180\");\n+    public static final String AUTH_SERVER_SCHEME = AUTH_SERVER_SSL_REQUIRED ? \"https\" : \"http\";\n+    public static final String AUTH_SERVER_HOST = System.getProperty(\"auth.server.host\", \"localhost\");\n+\n+    public static final boolean APP_SERVER_SSL_REQUIRED = Boolean.parseBoolean(System.getProperty(\"app.server.ssl.required\", \"false\"));\n+    public static final String APP_SERVER_PORT = APP_SERVER_SSL_REQUIRED ? System.getProperty(\"app.server.https.port\", \"8643\") : System.getProperty(\"app.server.http.port\", \"8280\");\n+    public static final String APP_SERVER_SCHEME = APP_SERVER_SSL_REQUIRED ? \"https\" : \"http\";\n+    public static final String APP_SERVER_HOST = System.getProperty(\"app.server.host\", \"localhost\");\n+\n     // TODO: Couldn't just always read urlBase from req.getRequestURI() ?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb874d8c0adc8ca5a05f4f602a3359707eb193b1"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTcxMDMyOA==", "bodyText": "@mhajas, can you please clear for me why this change is important?", "url": "https://github.com/keycloak/keycloak/pull/7241#discussion_r455710328", "createdAt": "2020-07-16T11:14:48Z", "author": {"login": "vramik"}, "path": "testsuite/integration-arquillian/tests/base/pom.xml", "diffHunk": "@@ -982,7 +982,7 @@\n                                     <configuration>\n                                         <keystore>${app.server.keystore}</keystore>\n                                         <storepass>${app.server.keystore.password}</storepass>\n-                                        <alias>localhost</alias>\n+                                        <alias>localhost3</alias>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0e04064d4fde3d98ad136c13a3be24e2d1ff8a5"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d153d0dfb686dce7c8ce8457b75ce8a43c2c6d6", "author": {"user": {"login": "mhajas", "name": "Michal Hajas"}}, "url": "https://github.com/keycloak/keycloak/commit/2d153d0dfb686dce7c8ce8457b75ce8a43c2c6d6", "committedDate": "2020-07-17T18:21:53Z", "message": "KEYCLOAK-14234 Adjust Adapter testsuite to work with app/auth.server.host including TLS configured"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aaf5c38097d55cc740dbe4ba2836271da0e122b2", "author": {"user": {"login": "mhajas", "name": "Michal Hajas"}}, "url": "https://github.com/keycloak/keycloak/commit/aaf5c38097d55cc740dbe4ba2836271da0e122b2", "committedDate": "2020-07-17T18:19:43Z", "message": "KEYCLOAK-14234 Remove unnecessary TODO"}, "afterCommit": {"oid": "2d153d0dfb686dce7c8ce8457b75ce8a43c2c6d6", "author": {"user": {"login": "mhajas", "name": "Michal Hajas"}}, "url": "https://github.com/keycloak/keycloak/commit/2d153d0dfb686dce7c8ce8457b75ce8a43c2c6d6", "committedDate": "2020-07-17T18:21:53Z", "message": "KEYCLOAK-14234 Adjust Adapter testsuite to work with app/auth.server.host including TLS configured"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMzMyMDY0", "url": "https://github.com/keycloak/keycloak/pull/7241#pullrequestreview-451332064", "createdAt": "2020-07-20T06:40:59Z", "commit": {"oid": "2d153d0dfb686dce7c8ce8457b75ce8a43c2c6d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMzU2MDE3", "url": "https://github.com/keycloak/keycloak/pull/7241#pullrequestreview-451356017", "createdAt": "2020-07-20T07:25:07Z", "commit": {"oid": "2d153d0dfb686dce7c8ce8457b75ce8a43c2c6d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNDM3NDQ4", "url": "https://github.com/keycloak/keycloak/pull/7241#pullrequestreview-451437448", "createdAt": "2020-07-20T09:21:12Z", "commit": {"oid": "2d153d0dfb686dce7c8ce8457b75ce8a43c2c6d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2838, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}