{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5NjYyNjI5", "number": 7678, "title": "KEYCLOAK-14718 Adding test case for User Client Role Mapper", "bodyText": "JIRA: KEYCLOAK-14718 Creating a Protocol Mapper for a Client via REST api does not fill the Client ID\nOriginal JIRA issue is not valid, but there is missing test case for roles from different clients. In order to improve the test coverage of the feature, it should be included. Attribute clientID is not so clear in the context of the UserClientRoleMapper, so it's changed to Specific Client ID, which should be better, because there's a bigger probability the user will read the tooltip of the attribute.\nMore details in JIRA.", "createdAt": "2020-12-14T16:56:11Z", "url": "https://github.com/keycloak/keycloak/pull/7678", "merged": true, "mergeCommit": {"oid": "9df7fdbc5554bf1c88ea7c78e9491654d7f9d86b"}, "closed": true, "closedAt": "2021-01-19T16:49:37Z", "author": {"login": "mabartos"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdvefKeAFqTU2NjUwMDU0Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdxuNEfAFqTU3MTQ0MzM4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY2NTAwNTQ3", "url": "https://github.com/keycloak/keycloak/pull/7678#pullrequestreview-566500547", "createdAt": "2021-01-12T17:22:40Z", "commit": {"oid": "4f76a322457b006cbe0642fa8828047b2428111e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQxNzoyMjo0MFrOISMJbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQxNzoyMjo0MFrOISMJbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk0NDMwMg==", "bodyText": "Ensure that this part is executed always, either by leveraging Creator in try-with-resources, or via try-finally block, or via test cleanup methods. The cleanup also needs to update directAccessGrant back to original value.", "url": "https://github.com/keycloak/keycloak/pull/7678#discussion_r555944302", "createdAt": "2021-01-12T17:22:40Z", "author": {"login": "hmlnarik"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/oauth/OIDCProtocolMappersTest.java", "diffHunk": "@@ -784,6 +785,45 @@ public void testUserGroupRoleToAttributeMappersScopedClientNotSet() throws Excep\n         deleteMappers(protocolMappers);\n     }\n \n+    @Test\n+    public void testUserGroupRoleToAttributeMappersScopedWithDifferentClient() throws Exception {\n+        String clientId = \"test-app-scope\";\n+        String diffClient = \"test-app\";\n+\n+        ProtocolMapperRepresentation realmMapper = ProtocolMapperUtil.createUserRealmRoleMappingMapper(\"pref.\", \"Realm roles mapper\", \"roles-custom.realm\", true, true);\n+        ProtocolMapperRepresentation clientMapper = ProtocolMapperUtil.createUserClientRoleMappingMapper(diffClient, null, \"Client roles mapper\", \"roles-custom.test-app\", true, true);\n+\n+        ClientResource clientResource = ApiUtil.findClientResourceByClientId(adminClient.realm(\"test\"), clientId);\n+        assertThat(clientResource, notNullValue());\n+\n+        ProtocolMappersResource protocolMappers = clientResource.getProtocolMappers();\n+        protocolMappers.createMapper(Arrays.asList(realmMapper, clientMapper));\n+\n+        // Login user\n+        ClientManager.realm(adminClient.realm(\"test\")).clientId(clientId).directAccessGrant(true);\n+        oauth.clientId(clientId);\n+        OAuthClient.AccessTokenResponse response = browserLogin(\"password\", \"rich.roles@redhat.com\", \"password\");\n+        IDToken idToken = oauth.verifyIDToken(response.getIdToken());\n+\n+        // Verify attribute is filled\n+        Map<String, Object> roleMappings = (Map<String, Object>) idToken.getOtherClaims().get(\"roles-custom\");\n+        Assert.assertThat(roleMappings.keySet(), containsInAnyOrder(\"realm\", diffClient));\n+        String realmRoleMappings = (String) roleMappings.get(\"realm\");\n+        String testAppScopeMappings = (String) roleMappings.get(diffClient);\n+        assertRolesString(realmRoleMappings,\n+                \"pref.admin\",\n+                \"pref.user\",\n+                \"pref.customer-user-premium\"\n+        );\n+        assertRolesString(testAppScopeMappings,\n+                \"customer-admin-composite-role\",\n+                \"customer-admin\"\n+        );\n+\n+        // Revert\n+        deleteMappers(protocolMappers);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f76a322457b006cbe0642fa8828047b2428111e"}, "originalPosition": 48}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4f76a322457b006cbe0642fa8828047b2428111e", "author": {"user": {"login": "mabartos", "name": "Martin Barto\u0161"}}, "url": "https://github.com/keycloak/keycloak/commit/4f76a322457b006cbe0642fa8828047b2428111e", "committedDate": "2020-12-14T16:30:56Z", "message": "KEYCLOAK-14718 Adding test case for User Client Role Mapper"}, "afterCommit": {"oid": "fb833872a618d0843093e04ece303fa5dc0d3d25", "author": {"user": {"login": "mabartos", "name": "Martin Barto\u0161"}}, "url": "https://github.com/keycloak/keycloak/commit/fb833872a618d0843093e04ece303fa5dc0d3d25", "committedDate": "2021-01-12T18:10:52Z", "message": "KEYCLOAK-14718 Adding test case for User Client Role Mapper"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY3NTUxOTM0", "url": "https://github.com/keycloak/keycloak/pull/7678#pullrequestreview-567551934", "createdAt": "2021-01-13T19:30:48Z", "commit": {"oid": "fb833872a618d0843093e04ece303fa5dc0d3d25"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxOTozMDo0OFrOIS-9cQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QxOTozMDo0OFrOIS-9cQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njc3NjgxNw==", "bodyText": "Thank you for the change. You can completely get rid of the clientResource this way:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ClientResource clientResource = ApiUtil.findClientResourceByClientId(adminClient.realm(realmName), clientId);\n          \n          \n            \n                    assertThat(clientResource, notNullValue());\n          \n          \n            \n            \n          \n          \n            \n                    try (ProtocolMappersUpdater protocolMappers = new ProtocolMappersUpdater(clientResource.getProtocolMappers());\n          \n          \n            \n                         ClientAttributeUpdater cau = ClientAttributeUpdater.forClient(adminClient, realmName, clientId).setDirectAccessGrantsEnabled(true)) {\n          \n          \n            \n                    try (ClientAttributeUpdater cau = ClientAttributeUpdater.forClient(adminClient, realmName, clientId).setDirectAccessGrantsEnabled(true);\n          \n          \n            \n                      ProtocolMappersUpdater protocolMappers = new ProtocolMappersUpdater(cau.getResource().getProtocolMappers())) {", "url": "https://github.com/keycloak/keycloak/pull/7678#discussion_r556776817", "createdAt": "2021-01-13T19:30:48Z", "author": {"login": "hmlnarik"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/oauth/OIDCProtocolMappersTest.java", "diffHunk": "@@ -784,6 +787,46 @@ public void testUserGroupRoleToAttributeMappersScopedClientNotSet() throws Excep\n         deleteMappers(protocolMappers);\n     }\n \n+    @Test\n+    public void testUserGroupRoleToAttributeMappersScopedWithDifferentClient() throws Exception {\n+        final String clientId = \"test-app-scope\";\n+        final String diffClient = \"test-app\";\n+        final String realmName = \"test\";\n+\n+        final ProtocolMapperRepresentation realmMapper = ProtocolMapperUtil.createUserRealmRoleMappingMapper(\"pref.\", \"Realm roles mapper\", \"roles-custom.realm\", true, true);\n+        final ProtocolMapperRepresentation clientMapper = ProtocolMapperUtil.createUserClientRoleMappingMapper(diffClient, null, \"Client roles mapper\", \"roles-custom.test-app\", true, true);\n+\n+        ClientResource clientResource = ApiUtil.findClientResourceByClientId(adminClient.realm(realmName), clientId);\n+        assertThat(clientResource, notNullValue());\n+\n+        try (ProtocolMappersUpdater protocolMappers = new ProtocolMappersUpdater(clientResource.getProtocolMappers());\n+             ClientAttributeUpdater cau = ClientAttributeUpdater.forClient(adminClient, realmName, clientId).setDirectAccessGrantsEnabled(true)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb833872a618d0843093e04ece303fa5dc0d3d25"}, "originalPosition": 34}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb833872a618d0843093e04ece303fa5dc0d3d25", "author": {"user": {"login": "mabartos", "name": "Martin Barto\u0161"}}, "url": "https://github.com/keycloak/keycloak/commit/fb833872a618d0843093e04ece303fa5dc0d3d25", "committedDate": "2021-01-12T18:10:52Z", "message": "KEYCLOAK-14718 Adding test case for User Client Role Mapper"}, "afterCommit": {"oid": "73ea6754e504b89614d48a6b4b0a2ee31441b2cb", "author": {"user": {"login": "mabartos", "name": "Martin Barto\u0161"}}, "url": "https://github.com/keycloak/keycloak/commit/73ea6754e504b89614d48a6b4b0a2ee31441b2cb", "committedDate": "2021-01-15T08:58:59Z", "message": "KEYCLOAK-14718 Adding test case for User Client Role Mapper"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcwNjQ1ODUx", "url": "https://github.com/keycloak/keycloak/pull/7678#pullrequestreview-570645851", "createdAt": "2021-01-18T16:35:03Z", "commit": {"oid": "73ea6754e504b89614d48a6b4b0a2ee31441b2cb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcwNjQ4MjE0", "url": "https://github.com/keycloak/keycloak/pull/7678#pullrequestreview-570648214", "createdAt": "2021-01-18T16:38:24Z", "commit": {"oid": "73ea6754e504b89614d48a6b4b0a2ee31441b2cb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOFQxNjozODoyNFrOIVwqmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOFQxNjozODoyNFrOIVwqmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTY4ODM0Nw==", "bodyText": "Please revert to Client ID to be consistent with the rest of the code. Apologies I didn't spot this earlier - this is the very last change :)", "url": "https://github.com/keycloak/keycloak/pull/7678#discussion_r559688347", "createdAt": "2021-01-18T16:38:24Z", "author": {"login": "hmlnarik"}, "path": "themes/src/main/resources/theme/base/admin/messages/admin-messages_en.properties", "diffHunk": "@@ -254,7 +254,7 @@ includeInAccessToken.label=Add to access token\n includeInAccessToken.tooltip=Should the claim be added to the access token?\n includeInUserInfo.label=Add to userinfo\n includeInUserInfo.tooltip=Should the claim be added to the userinfo?\n-usermodel.clientRoleMapping.clientId.label=Client ID\n+usermodel.clientRoleMapping.clientId.label=Specific Client ID", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73ea6754e504b89614d48a6b4b0a2ee31441b2cb"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0365b6b776f0fe7a6ac591408bc37d3194fc662b", "author": {"user": {"login": "mabartos", "name": "Martin Barto\u0161"}}, "url": "https://github.com/keycloak/keycloak/commit/0365b6b776f0fe7a6ac591408bc37d3194fc662b", "committedDate": "2021-01-19T15:23:33Z", "message": "KEYCLOAK-14718 Adding test case for User Client Role Mapper"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "73ea6754e504b89614d48a6b4b0a2ee31441b2cb", "author": {"user": {"login": "mabartos", "name": "Martin Barto\u0161"}}, "url": "https://github.com/keycloak/keycloak/commit/73ea6754e504b89614d48a6b4b0a2ee31441b2cb", "committedDate": "2021-01-15T08:58:59Z", "message": "KEYCLOAK-14718 Adding test case for User Client Role Mapper"}, "afterCommit": {"oid": "0365b6b776f0fe7a6ac591408bc37d3194fc662b", "author": {"user": {"login": "mabartos", "name": "Martin Barto\u0161"}}, "url": "https://github.com/keycloak/keycloak/commit/0365b6b776f0fe7a6ac591408bc37d3194fc662b", "committedDate": "2021-01-19T15:23:33Z", "message": "KEYCLOAK-14718 Adding test case for User Client Role Mapper"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcxNDQzMzgx", "url": "https://github.com/keycloak/keycloak/pull/7678#pullrequestreview-571443381", "createdAt": "2021-01-19T16:49:26Z", "commit": {"oid": "0365b6b776f0fe7a6ac591408bc37d3194fc662b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3335, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}