{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0Mzg4NjAx", "number": 7278, "title": "KEYCLOAK-14190 Client Policy - Condition : The way of creating/updating a client", "bodyText": "This PR is for KEYCLOAK-14190 Client Policy - Condition : The way of creating/updating a client that is a sub task of KEYCLOAK-13933 Client Policies whose design document is Client Policies .", "createdAt": "2020-07-21T11:00:42Z", "url": "https://github.com/keycloak/keycloak/pull/7278", "merged": true, "mergeCommit": {"oid": "1d8230d438c14696b53025446ef016c9390ec57c"}, "closed": true, "closedAt": "2020-09-04T07:54:56Z", "author": {"login": "tnorimat"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_1qHigFqTQ2ODU3MTMwOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFNJm5gFqTQ4MTY1OTM1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NTcxMzA4", "url": "https://github.com/keycloak/keycloak/pull/7278#pullrequestreview-468571308", "createdAt": "2020-08-17T15:33:49Z", "commit": {"oid": "620edd84f5482aaf518e914a94b0c2268ca6e86c"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNTozMzo0OVrOHBt2PA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNTo1OTo1MlrOHBu6tQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU2MTc4OA==", "bodyText": "Call to stream().forEach() can be simplified by removing stream:\ncomponentModel.getConfig().get(UpdatingClientSourceConditionFactory.UPDATE_CLIENT_SOURCE).forEach(i -> ClientPolicyLogger.log(logger, \"auth method expected = \" + i));", "url": "https://github.com/keycloak/keycloak/pull/7278#discussion_r471561788", "createdAt": "2020-08-17T15:33:49Z", "author": {"login": "valb3r"}, "path": "services/src/main/java/org/keycloak/services/clientpolicy/condition/UpdatingClientSourceCondition.java", "diffHunk": "@@ -58,9 +58,9 @@ private boolean isAuthMethodMatched(String authMethod) {\n         if (authMethod == null) return false;\n \n         ClientPolicyLogger.log(logger, \"auth method = \" + authMethod);\n-        componentModel.getConfig().get(TestAuthnMethodsConditionFactory.AUTH_METHOD).stream().forEach(i -> ClientPolicyLogger.log(logger, \"auth method expected = \" + i));\n+        componentModel.getConfig().get(UpdatingClientSourceConditionFactory.UPDATE_CLIENT_SOURCE).stream().forEach(i -> ClientPolicyLogger.log(logger, \"auth method expected = \" + i));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620edd84f5482aaf518e914a94b0c2268ca6e86c"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU2MzUzNw==", "bodyText": "i -> i.equals(authMethod) can be inverted to i -> authMethod.equals(i) to avoid theoretically possible NullpointerException as authMethod can't be null - if (authMethod == null) return false; at the function start", "url": "https://github.com/keycloak/keycloak/pull/7278#discussion_r471563537", "createdAt": "2020-08-17T15:36:21Z", "author": {"login": "valb3r"}, "path": "services/src/main/java/org/keycloak/services/clientpolicy/condition/UpdatingClientSourceCondition.java", "diffHunk": "@@ -58,9 +58,9 @@ private boolean isAuthMethodMatched(String authMethod) {\n         if (authMethod == null) return false;\n \n         ClientPolicyLogger.log(logger, \"auth method = \" + authMethod);\n-        componentModel.getConfig().get(TestAuthnMethodsConditionFactory.AUTH_METHOD).stream().forEach(i -> ClientPolicyLogger.log(logger, \"auth method expected = \" + i));\n+        componentModel.getConfig().get(UpdatingClientSourceConditionFactory.UPDATE_CLIENT_SOURCE).stream().forEach(i -> ClientPolicyLogger.log(logger, \"auth method expected = \" + i));\n \n-        boolean isMatched = componentModel.getConfig().get(TestAuthnMethodsConditionFactory.AUTH_METHOD).stream().anyMatch(i -> i.equals(authMethod));\n+        boolean isMatched = componentModel.getConfig().get(UpdatingClientSourceConditionFactory.UPDATE_CLIENT_SOURCE).stream().anyMatch(i -> i.equals(authMethod));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620edd84f5482aaf518e914a94b0c2268ca6e86c"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU3Nzc2Mw==", "bodyText": "new ArrayList<>(Arrays.asList(UpdatingClientSourceConditionFactory.BY_AUTHENTICATED_USER))\nThis collection seems to be an immutable list - maybe we could use Collections.singletonList(UpdatingClientSourceConditionFactory.BY_AUTHENTICATED_USER)\nSince the collection will be immutable it will reduce possible states of the tests that will make it more 'specific'", "url": "https://github.com/keycloak/keycloak/pull/7278#discussion_r471577763", "createdAt": "2020-08-17T15:57:31Z", "author": {"login": "valb3r"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/client/ClientPolicyBasicsTest.java", "diffHunk": "@@ -496,11 +496,11 @@ public void testMultiplePolicies() throws ClientRegistrationException, ClientPol\n         registerCondition(\"TestClientRolesCondition-alpha\", policyAlphaName);\n         logger.info(\"... Registered Condition : TestClientRolesCondition-alpha\");\n \n-        createCondition(\"TestAuthnMethodsCondition-alpha\", TestAuthnMethodsConditionFactory.PROVIDER_ID, null, (ComponentRepresentation provider) -> {\n-            setConditionRegistrationMethods(provider, new ArrayList<>(Arrays.asList(TestAuthnMethodsConditionFactory.BY_AUTHENTICATED_USER)));\n+        createCondition(\"UpdatingClientSourceCondition-alpha\", UpdatingClientSourceConditionFactory.PROVIDER_ID, null, (ComponentRepresentation provider) -> {\n+            setConditionRegistrationMethods(provider, new ArrayList<>(Arrays.asList(UpdatingClientSourceConditionFactory.BY_AUTHENTICATED_USER)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620edd84f5482aaf518e914a94b0c2268ca6e86c"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU3ODUzNw==", "bodyText": "new ArrayList<>(Arrays.asList(UpdatingClientSourceConditionFactory.BY_AUTHENTICATED_USER))\nThis collection seems to be an immutable list - maybe we could use\nCollections.singletonList(UpdatingClientSourceConditionFactory.BY_AUTHENTICATED_USER)\nSince the collection will be immutable it will reduce possible states of the tests that will make it more 'specific'", "url": "https://github.com/keycloak/keycloak/pull/7278#discussion_r471578537", "createdAt": "2020-08-17T15:58:30Z", "author": {"login": "valb3r"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/client/ClientPolicyBasicsTest.java", "diffHunk": "@@ -433,11 +433,11 @@ public void testCreateUpdateDeleteExecutorRuntime() throws ClientRegistrationExc\n         registerCondition(\"TestClientRolesCondition\", policyName);\n         logger.info(\"... Registered Condition : TestClientRolesCondition\");\n \n-        createCondition(\"TestAuthnMethodsCondition\", TestAuthnMethodsConditionFactory.PROVIDER_ID, null, (ComponentRepresentation provider) -> {\n-            setConditionRegistrationMethods(provider, new ArrayList<>(Arrays.asList(TestAuthnMethodsConditionFactory.BY_AUTHENTICATED_USER)));\n+        createCondition(\"UpdatingClientSourceCondition\", UpdatingClientSourceConditionFactory.PROVIDER_ID, null, (ComponentRepresentation provider) -> {\n+            setConditionRegistrationMethods(provider, new ArrayList<>(Arrays.asList(UpdatingClientSourceConditionFactory.BY_AUTHENTICATED_USER)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620edd84f5482aaf518e914a94b0c2268ca6e86c"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU3OTA5OA==", "bodyText": "new ArrayList<>(Arrays.asList(UpdatingClientSourceConditionFactory.BY_AUTHENTICATED_USER))\nThis collection seems to be an immutable list - maybe we could use Collections.singletonList(UpdatingClientSourceConditionFactory.BY_AUTHENTICATED_USER)\nSince the collection will be immutable it will reduce possible states of the tests that will make it more 'specific'", "url": "https://github.com/keycloak/keycloak/pull/7278#discussion_r471579098", "createdAt": "2020-08-17T15:59:31Z", "author": {"login": "valb3r"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/client/ClientPolicyBasicsTest.java", "diffHunk": "@@ -579,11 +579,11 @@ private void setupPolicyAcceptableAuthType(String policyName) {\n         createPolicy(policyName, DefaultClientPolicyProviderFactory.PROVIDER_ID, null, null, null);\n         logger.info(\"... Created Policy : \" + policyName);\n \n-        createCondition(\"TestAuthnMethodsCondition\", TestAuthnMethodsConditionFactory.PROVIDER_ID, null, (ComponentRepresentation provider) -> {\n-            setConditionRegistrationMethods(provider, new ArrayList<>(Arrays.asList(TestAuthnMethodsConditionFactory.BY_AUTHENTICATED_USER)));\n+        createCondition(\"UpdatingClientSourceCondition\", UpdatingClientSourceConditionFactory.PROVIDER_ID, null, (ComponentRepresentation provider) -> {\n+            setConditionRegistrationMethods(provider, new ArrayList<>(Arrays.asList(UpdatingClientSourceConditionFactory.BY_AUTHENTICATED_USER)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620edd84f5482aaf518e914a94b0c2268ca6e86c"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU3OTMxNw==", "bodyText": "ArrayList<>(Arrays.asList(UpdatingClientSourceConditionFactory.BY_INITIAL_ACCESS_TOKEN))\nThis collection seems to be an immutable list - maybe we could use Collections.singletonList(UpdatingClientSourceConditionFactory.BY_INITIAL_ACCESS_TOKEN)\nSince the collection will be immutable it will reduce possible states of the tests that will make it more 'specific'", "url": "https://github.com/keycloak/keycloak/pull/7278#discussion_r471579317", "createdAt": "2020-08-17T15:59:52Z", "author": {"login": "valb3r"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/client/ClientPolicyBasicsTest.java", "diffHunk": "@@ -601,11 +601,11 @@ private void setupPolicyAuthzCodeFlowUnderMultiPhasePolicy(String policyName) {\n         createPolicy(policyName, DefaultClientPolicyProviderFactory.PROVIDER_ID, null, null, null);\n         logger.info(\"... Created Policy : \" + policyName);\n \n-        createCondition(\"TestAuthnMethodsCondition\", TestAuthnMethodsConditionFactory.PROVIDER_ID, null, (ComponentRepresentation provider) -> {\n-            setConditionRegistrationMethods(provider, new ArrayList<>(Arrays.asList(TestAuthnMethodsConditionFactory.BY_INITIAL_ACCESS_TOKEN)));\n+        createCondition(\"UpdatingClientSourceCondition\", UpdatingClientSourceConditionFactory.PROVIDER_ID, null, (ComponentRepresentation provider) -> {\n+            setConditionRegistrationMethods(provider, new ArrayList<>(Arrays.asList(UpdatingClientSourceConditionFactory.BY_INITIAL_ACCESS_TOKEN)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620edd84f5482aaf518e914a94b0c2268ca6e86c"}, "originalPosition": 69}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "620edd84f5482aaf518e914a94b0c2268ca6e86c", "author": {"user": {"login": "tnorimat", "name": "Takashi Norimatsu"}}, "url": "https://github.com/keycloak/keycloak/commit/620edd84f5482aaf518e914a94b0c2268ca6e86c", "committedDate": "2020-07-21T10:56:17Z", "message": "KEYCLOAK-14190 Client Policy - Condition : The way of creating/updating a client"}, "afterCommit": {"oid": "ace13c61108c097d3c038359a94bbf207ddff328", "author": {"user": {"login": "tnorimat", "name": "Takashi Norimatsu"}}, "url": "https://github.com/keycloak/keycloak/commit/ace13c61108c097d3c038359a94bbf207ddff328", "committedDate": "2020-08-19T00:19:21Z", "message": "KEYCLOAK-14190 Client Policy - Condition : The way of creating/updating a client"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNjM0MDIw", "url": "https://github.com/keycloak/keycloak/pull/7278#pullrequestreview-480634020", "createdAt": "2020-09-02T09:15:40Z", "commit": {"oid": "ace13c61108c097d3c038359a94bbf207ddff328"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwOToxNTo0MFrOHLmWBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwOToxNTo0MFrOHLmWBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkyNDYxMw==", "bodyText": "I suggest to make the help text a bit more clear as it will be displayed in the UI and will be nice to make it a bit more obvious what exactly it means?\nFor example \"The condition checks the context how is client created/updated to determine whether the policy is applied. For example it checks if client is created with admin REST API or OIDC dynamic client registration. And for the letter case if it is ANONYMOUS client registration or AUTHENTICATED client registration with Initial access token or Registration access token and so on.\"\nAlso my vote is to rename the class to \"UpdatingClientContextCondition\" (and similarly rename the provider ID) as the \"source\" implies that condition is interested about concrete user, who creates/updatest the client rather about the \"context\" how is the client created/updated (admin REST API, OIDC dynamic client registration etc).\n@stianst @valb3r What is your though on the above?", "url": "https://github.com/keycloak/keycloak/pull/7278#discussion_r481924613", "createdAt": "2020-09-02T09:15:40Z", "author": {"login": "mposolda"}, "path": "services/src/main/java/org/keycloak/services/clientpolicy/condition/UpdatingClientSourceConditionFactory.java", "diffHunk": "@@ -74,7 +74,7 @@ public String getId() {\n \n     @Override\n     public String getHelpText() {\n-        return null;\n+        return \"It uses the source of updating client to determine whether the policy is applied.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ace13c61108c097d3c038359a94bbf207ddff328"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35c63e7d13de455ac15167efa9db936800823c59", "author": {"user": {"login": "tnorimat", "name": "Takashi Norimatsu"}}, "url": "https://github.com/keycloak/keycloak/commit/35c63e7d13de455ac15167efa9db936800823c59", "committedDate": "2020-09-03T08:50:15Z", "message": "KEYCLOAK-14190 Client Policy - Condition : The way of creating/updating a client"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ace13c61108c097d3c038359a94bbf207ddff328", "author": {"user": {"login": "tnorimat", "name": "Takashi Norimatsu"}}, "url": "https://github.com/keycloak/keycloak/commit/ace13c61108c097d3c038359a94bbf207ddff328", "committedDate": "2020-08-19T00:19:21Z", "message": "KEYCLOAK-14190 Client Policy - Condition : The way of creating/updating a client"}, "afterCommit": {"oid": "35c63e7d13de455ac15167efa9db936800823c59", "author": {"user": {"login": "tnorimat", "name": "Takashi Norimatsu"}}, "url": "https://github.com/keycloak/keycloak/commit/35c63e7d13de455ac15167efa9db936800823c59", "committedDate": "2020-09-03T08:50:15Z", "message": "KEYCLOAK-14190 Client Policy - Condition : The way of creating/updating a client"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNjU5MzU1", "url": "https://github.com/keycloak/keycloak/pull/7278#pullrequestreview-481659355", "createdAt": "2020-09-03T09:26:07Z", "commit": {"oid": "35c63e7d13de455ac15167efa9db936800823c59"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2862, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}