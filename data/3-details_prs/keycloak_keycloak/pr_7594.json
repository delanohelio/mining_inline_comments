{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4ODQ5NzY0", "number": 7594, "title": "KEYCLOAK-14206 Client Policy - Executor : Enforce more secure state and nonce treatment for preventing CSRF", "bodyText": "This PR is for KEYCLOAK-14206 Client Policy - Executor : Enforce more secure state and nonce treatment for preventing CSRF in KEYCLOAK-13933 Client Policies, also is the part of the project Client Policy Official Support of FAPI-SIG activity.\nGenerally speaking, the aim of this PR is to support policy conditions defined in Client Policy design document", "createdAt": "2020-11-11T00:14:33Z", "url": "https://github.com/keycloak/keycloak/pull/7594", "merged": true, "mergeCommit": {"oid": "e35a4bcefce09a57659d4470ac42b2675f515d38"}, "closed": true, "closedAt": "2020-11-11T20:11:35Z", "author": {"login": "tnorimat"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbSki-AH2gAyNTE4ODQ5NzY0OmQ2MDQ2YTA0YTJmN2JkMGYxNjE2YjA5YzQwYzY1MTI0NWVmY2JjNWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbjvPYAFqTUyODQ5OTc0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d6046a04a2f7bd0f1616b09c40c651245efcbc5c", "author": {"user": {"login": "tnorimat", "name": "Takashi Norimatsu"}}, "url": "https://github.com/keycloak/keycloak/commit/d6046a04a2f7bd0f1616b09c40c651245efcbc5c", "committedDate": "2020-11-11T00:11:24Z", "message": "KEYCLOAK-14206 Client Policy - Executor : Enforce more secure state and nonce treatment for preventing CSRF"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3OTQyOTE0", "url": "https://github.com/keycloak/keycloak/pull/7594#pullrequestreview-527942914", "createdAt": "2020-11-11T08:02:57Z", "commit": {"oid": "d6046a04a2f7bd0f1616b09c40c651245efcbc5c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwODowMjo1N1rOHxCWuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwODoxNDowMFrOHxCqQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE4MDg1Ng==", "bodyText": "Just to doublechec, wouldn't it be better to check that \"state\" parameter is always there? In other words, remove it from the \"else\" branch? This would mean that for OIDC clients, both \"state\" and \"nonce\" will be enforced, which IMO is fine behaviour?", "url": "https://github.com/keycloak/keycloak/pull/7594#discussion_r521180856", "createdAt": "2020-11-11T08:02:57Z", "author": {"login": "mposolda"}, "path": "services/src/main/java/org/keycloak/services/clientpolicy/executor/SecureSessionEnforceExecutor.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates\n+ * and other contributors as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.keycloak.services.clientpolicy.executor;\n+\n+import org.jboss.logging.Logger;\n+import org.keycloak.OAuthErrorException;\n+import org.keycloak.component.ComponentModel;\n+import org.keycloak.models.KeycloakSession;\n+import org.keycloak.protocol.oidc.endpoints.request.AuthorizationEndpointRequest;\n+import org.keycloak.protocol.oidc.utils.OIDCResponseType;\n+import org.keycloak.services.clientpolicy.AuthorizationRequestContext;\n+import org.keycloak.services.clientpolicy.ClientPolicyContext;\n+import org.keycloak.services.clientpolicy.ClientPolicyException;\n+import org.keycloak.services.clientpolicy.ClientPolicyLogger;\n+import org.keycloak.util.TokenUtil;\n+\n+public class SecureSessionEnforceExecutor implements ClientPolicyExecutorProvider {\n+\n+    private static final Logger logger = Logger.getLogger(SecureSessionEnforceExecutor.class);\n+\n+    private final KeycloakSession session;\n+    private final ComponentModel componentModel;\n+\n+    public SecureSessionEnforceExecutor(KeycloakSession session, ComponentModel componentModel) {\n+        this.session = session;\n+        this.componentModel = componentModel;\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return componentModel.getName();\n+    }\n+\n+    @Override\n+    public String getProviderId() {\n+        return componentModel.getProviderId();\n+    }\n+\n+    @Override\n+    public void executeOnEvent(ClientPolicyContext context) throws ClientPolicyException {\n+        switch (context.getEvent()) {\n+            case AUTHORIZATION_REQUEST:\n+                AuthorizationRequestContext authorizationRequestContext = (AuthorizationRequestContext)context;\n+                executeOnAuthorizationRequest(authorizationRequestContext.getparsedResponseType(),\n+                    authorizationRequestContext.getAuthorizationEndpointRequest(),\n+                    authorizationRequestContext.getRedirectUri());\n+                return;\n+            default:\n+                return;\n+        }\n+    }\n+\n+    private void executeOnAuthorizationRequest(\n+            OIDCResponseType parsedResponseType,\n+            AuthorizationEndpointRequest request,\n+            String redirectUri) throws ClientPolicyException {\n+        ClientPolicyLogger.log(logger, \"Authz Endpoint - authz request\");\n+        if (TokenUtil.isOIDCRequest(request.getScope())) {\n+            if(request.getNonce() == null) {\n+                ClientPolicyLogger.log(logger, \"Missing parameter: nonce\");\n+                throw new ClientPolicyException(OAuthErrorException.INVALID_REQUEST, \"Missing parameter: nonce\");\n+            }\n+        } else {\n+            if(request.getState() == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6046a04a2f7bd0f1616b09c40c651245efcbc5c"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE4NTg1Nw==", "bodyText": "This is out of scope of this PR, but I wonder if we plan to have the condition, which will always evaluate to true? Or something like this... I can imagine that enforcing \"state\" and \"nonce\" parameter is something, which many deployments may want by default without a need for the client to match any special condition. WDYT? Just an idea for the future, nothing needed in this PR :-)", "url": "https://github.com/keycloak/keycloak/pull/7594#discussion_r521185857", "createdAt": "2020-11-11T08:14:00Z", "author": {"login": "mposolda"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/client/ClientPolicyBasicsTest.java", "diffHunk": "@@ -812,6 +813,61 @@ public void testClientIpAddressCondition() throws ClientRegistrationException, C\n         }\n     }\n \n+    @Test\n+    public void testSecureSessionEnforceExecutor() throws ClientRegistrationException, ClientPolicyException {\n+        String policyBetaName = \"MyPolicy-beta\";\n+        createPolicy(policyBetaName, DefaultClientPolicyProviderFactory.PROVIDER_ID, null, null, null);\n+        logger.info(\"... Created Policy : \" + policyBetaName);\n+\n+        createCondition(\"ClientRolesCondition-beta\", ClientRolesConditionFactory.PROVIDER_ID, null, (ComponentRepresentation provider) -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6046a04a2f7bd0f1616b09c40c651245efcbc5c"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NDk5NzQ1", "url": "https://github.com/keycloak/keycloak/pull/7594#pullrequestreview-528499745", "createdAt": "2020-11-11T20:11:28Z", "commit": {"oid": "d6046a04a2f7bd0f1616b09c40c651245efcbc5c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3234, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}