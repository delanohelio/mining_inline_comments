{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMjU2NDgx", "number": 7358, "title": "[KEYCLOAK-14432] Unhandled NPE in identity broker auth response", "bodyText": "JIRA: KEYCLOAK-14432 Unhandled NullPointerException if state is missing in Auth. Response (Identity Brokerage)\nBy OAuth2 and OIDC spec, the state parameter in auth response is required only when it's included in auth request to identity provider too. But Keycloak always send state parameter in request to identity provider. So, if there's no state parameter in response, it's bug on the 3rd party OAuth2/OIDC provider side, as @mposolda said in the JIRA issue. It follows that the parameter is required for the type of identity providers. So, purpose of this PR is properly handle error, when it happens.\nI think, it's not necessary to provide test case for that. AFAIK, It'd be difficult to simulate identity provider, which would provide response without the state parameter.", "createdAt": "2020-08-19T15:46:08Z", "url": "https://github.com/keycloak/keycloak/pull/7358", "merged": true, "mergeCommit": {"oid": "9c847ab176b17a0e6bedfbfb1afe491d4f310aae"}, "closed": true, "closedAt": "2020-08-31T12:14:43Z", "author": {"login": "mabartos"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAgUqbAFqTQ3MDc1MDI5NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdERwkTAFqTQ3ODU2MTg0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNzUwMjk1", "url": "https://github.com/keycloak/keycloak/pull/7358#pullrequestreview-470750295", "createdAt": "2020-08-19T18:56:46Z", "commit": {"oid": "5bffc1ef30027918ba7473b36edc817ab509c582"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5bffc1ef30027918ba7473b36edc817ab509c582", "author": {"user": {"login": "mabartos", "name": "Martin Barto\u0161"}}, "url": "https://github.com/keycloak/keycloak/commit/5bffc1ef30027918ba7473b36edc817ab509c582", "committedDate": "2020-08-19T15:32:43Z", "message": "[KEYCLOAK-14432] Unhandled NPE in identity broker auth response"}, "afterCommit": {"oid": "11a01d204a6a60ede1203d8b3bd1851cc822d842", "author": {"user": {"login": "mabartos", "name": "Martin Barto\u0161"}}, "url": "https://github.com/keycloak/keycloak/commit/11a01d204a6a60ede1203d8b3bd1851cc822d842", "committedDate": "2020-08-20T18:20:57Z", "message": "[KEYCLOAK-14432] Unhandled NPE in identity broker auth response"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNDU5MTk2", "url": "https://github.com/keycloak/keycloak/pull/7358#pullrequestreview-472459196", "createdAt": "2020-08-21T12:48:46Z", "commit": {"oid": "11a01d204a6a60ede1203d8b3bd1851cc822d842"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxMjo0ODo0NlrOHEr3pA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxMjo1MDo1OVrOHEr8Iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDY3NTEwOA==", "bodyText": "Is it possible to move the test to some test under package \"org.keycloak.testsuite.broker\" ? For example KcOidcBrokerTest? The IdentityProviderTest is used rather for testing admin REST API related to IdentityProvider CRUD rather than for testing identity brokering logic itself.", "url": "https://github.com/keycloak/keycloak/pull/7358#discussion_r474675108", "createdAt": "2020-08-21T12:48:46Z", "author": {"login": "mposolda"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/admin/IdentityProviderTest.java", "diffHunk": "@@ -850,6 +856,28 @@ public void testInstalledIdentityProviders() {\n         Assert.assertEquals(\"Status\", 400, response.getStatus());\n     }\n \n+    @Test\n+    public void testMissingStateParameter() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11a01d204a6a60ede1203d8b3bd1851cc822d842"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDY3NjI1OQ==", "bodyText": "Is it possible to just visit the URL with webDriver instead of using Apache HTTP client? Something like \"driver.navigate().to(LINK)\" . I am not sure if you use Apache HTTP Clinet due some issues with using WebDriver, but it will be ideal to use it, as normally this functionality is also tested by users in the \"browser\" itself.", "url": "https://github.com/keycloak/keycloak/pull/7358#discussion_r474676259", "createdAt": "2020-08-21T12:50:59Z", "author": {"login": "mposolda"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/admin/IdentityProviderTest.java", "diffHunk": "@@ -850,6 +856,28 @@ public void testInstalledIdentityProviders() {\n         Assert.assertEquals(\"Status\", 400, response.getStatus());\n     }\n \n+    @Test\n+    public void testMissingStateParameter() throws IOException {\n+        final String IDP_NAME = \"github\";\n+        final String LINK = oauth.AUTH_SERVER_ROOT + \"/realms/\" + REALM_NAME + \"/broker/\" + IDP_NAME + \"/endpoint?code=foo123\";\n+\n+        create(createRep(IDP_NAME, IDP_NAME));\n+        IdentityProviderResource provider = realm.identityProviders().get(IDP_NAME);\n+        assertNotNull(provider);\n+\n+        try (CloseableHttpClient client = HttpClientBuilder.create().build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11a01d204a6a60ede1203d8b3bd1851cc822d842"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49b1a131d3dd01beedb9e3045e05eada3a80bb3d", "author": {"user": {"login": "mabartos", "name": "Martin Barto\u0161"}}, "url": "https://github.com/keycloak/keycloak/commit/49b1a131d3dd01beedb9e3045e05eada3a80bb3d", "committedDate": "2020-08-21T15:58:39Z", "message": "[KEYCLOAK-14432] Unhandled NPE in identity broker auth response"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "11a01d204a6a60ede1203d8b3bd1851cc822d842", "author": {"user": {"login": "mabartos", "name": "Martin Barto\u0161"}}, "url": "https://github.com/keycloak/keycloak/commit/11a01d204a6a60ede1203d8b3bd1851cc822d842", "committedDate": "2020-08-20T18:20:57Z", "message": "[KEYCLOAK-14432] Unhandled NPE in identity broker auth response"}, "afterCommit": {"oid": "49b1a131d3dd01beedb9e3045e05eada3a80bb3d", "author": {"user": {"login": "mabartos", "name": "Martin Barto\u0161"}}, "url": "https://github.com/keycloak/keycloak/commit/49b1a131d3dd01beedb9e3045e05eada3a80bb3d", "committedDate": "2020-08-21T15:58:39Z", "message": "[KEYCLOAK-14432] Unhandled NPE in identity broker auth response"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NTYxODQw", "url": "https://github.com/keycloak/keycloak/pull/7358#pullrequestreview-478561840", "createdAt": "2020-08-31T12:14:22Z", "commit": {"oid": "49b1a131d3dd01beedb9e3045e05eada3a80bb3d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2765, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}