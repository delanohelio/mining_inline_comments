{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwMTc2MTc5", "number": 7272, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxOTozMjo0OVrOEQxEhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0yMVQwMzo0Nzo0NVrOF0fB5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MDE2NjQ2OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/keycloak/util/TokenUtil.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxOTozMjo0OVrOG1GyEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjo0NzoxMVrOG1gyXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMzODgzMw==", "bodyText": "I would just reuse org.keycloak.representations.IDToken#NONCE.", "url": "https://github.com/keycloak/keycloak/pull/7272#discussion_r458338833", "createdAt": "2020-07-21T19:32:49Z", "author": {"login": "pedroigor"}, "path": "core/src/main/java/org/keycloak/util/TokenUtil.java", "diffHunk": "@@ -48,6 +48,11 @@\n \n     public static final String TOKEN_TYPE_OFFLINE = \"Offline\";\n \n+    public static final String TOKEN_TYPE_LOGOUT = \"Logout\";\n+\n+    public static final String TOKEN_BACKCHANNEL_LOGOUT_EVENT = \"http://schemas.openid.net/event/backchannel-logout\";\n+\n+    public static final String TOKEN_CLAIM_NONCE = \"nonce\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe222ac49c388259b909d1b6ced803e93307d08a"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYwMzI4Ng==", "bodyText": "sure i will change that to the IDToken#NONCE", "url": "https://github.com/keycloak/keycloak/pull/7272#discussion_r458603286", "createdAt": "2020-07-22T07:52:14Z", "author": {"login": "DaSmoo"}, "path": "core/src/main/java/org/keycloak/util/TokenUtil.java", "diffHunk": "@@ -48,6 +48,11 @@\n \n     public static final String TOKEN_TYPE_OFFLINE = \"Offline\";\n \n+    public static final String TOKEN_TYPE_LOGOUT = \"Logout\";\n+\n+    public static final String TOKEN_BACKCHANNEL_LOGOUT_EVENT = \"http://schemas.openid.net/event/backchannel-logout\";\n+\n+    public static final String TOKEN_CLAIM_NONCE = \"nonce\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMzODgzMw=="}, "originalCommit": {"oid": "fe222ac49c388259b909d1b6ced803e93307d08a"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc2NDg5NQ==", "bodyText": "done", "url": "https://github.com/keycloak/keycloak/pull/7272#discussion_r458764895", "createdAt": "2020-07-22T12:47:11Z", "author": {"login": "benjamin37"}, "path": "core/src/main/java/org/keycloak/util/TokenUtil.java", "diffHunk": "@@ -48,6 +48,11 @@\n \n     public static final String TOKEN_TYPE_OFFLINE = \"Offline\";\n \n+    public static final String TOKEN_TYPE_LOGOUT = \"Logout\";\n+\n+    public static final String TOKEN_BACKCHANNEL_LOGOUT_EVENT = \"http://schemas.openid.net/event/backchannel-logout\";\n+\n+    public static final String TOKEN_CLAIM_NONCE = \"nonce\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMzODgzMw=="}, "originalCommit": {"oid": "fe222ac49c388259b909d1b6ced803e93307d08a"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MDE3NjI2OnYy", "diffSide": "RIGHT", "path": "model/jpa/src/main/java/org/keycloak/models/jpa/entities/ClientEntity.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxOTozNTo1MVrOG1G3_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjo0ODowOFrOG1g0iQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM0MDM0OA==", "bodyText": "Instead of changing DDL, could we just persist the new data as client attributes? Similar to what we do with org.keycloak.protocol.oidc.OIDCConfigAttributes#JWKS_URL.\nIt should help to avoid all the migration-related code herein ...", "url": "https://github.com/keycloak/keycloak/pull/7272#discussion_r458340348", "createdAt": "2020-07-21T19:35:51Z", "author": {"login": "pedroigor"}, "path": "model/jpa/src/main/java/org/keycloak/models/jpa/entities/ClientEntity.java", "diffHunk": "@@ -130,6 +130,12 @@\n     @Column(name=\"BASE_URL\")\n     private String baseUrl;\n \n+    @Column(name=\"BACKCHANNEL_LOGOUT_URL\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe222ac49c388259b909d1b6ced803e93307d08a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc2NTQ0OQ==", "bodyText": "Done, we also removed the database migration files. No need to do database changes any more.", "url": "https://github.com/keycloak/keycloak/pull/7272#discussion_r458765449", "createdAt": "2020-07-22T12:48:08Z", "author": {"login": "benjamin37"}, "path": "model/jpa/src/main/java/org/keycloak/models/jpa/entities/ClientEntity.java", "diffHunk": "@@ -130,6 +130,12 @@\n     @Column(name=\"BASE_URL\")\n     private String baseUrl;\n \n+    @Column(name=\"BACKCHANNEL_LOGOUT_URL\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM0MDM0OA=="}, "originalCommit": {"oid": "fe222ac49c388259b909d1b6ced803e93307d08a"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MDE4MzE5OnYy", "diffSide": "LEFT", "path": "server-spi-private/src/main/java/org/keycloak/events/EventType.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxOTozODoxNVrOG1G8ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjo0OToxM1rOG1g28A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM0MTUxNA==", "bodyText": "Nitpick, but it helps to have a more concise set of changes and make review easier. Could you revert this change?\nThere are other few places that seem to be changing formatting only.", "url": "https://github.com/keycloak/keycloak/pull/7272#discussion_r458341514", "createdAt": "2020-07-21T19:38:15Z", "author": {"login": "pedroigor"}, "path": "server-spi-private/src/main/java/org/keycloak/events/EventType.java", "diffHunk": "@@ -36,7 +36,8 @@\n     CLIENT_LOGIN_ERROR(true),\n \n     REFRESH_TOKEN(false),\n-    REFRESH_TOKEN_ERROR(false),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe222ac49c388259b909d1b6ced803e93307d08a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc2NjA2NA==", "bodyText": "Sure, we reverted all formatting changes we found. Hope it's fine like this.", "url": "https://github.com/keycloak/keycloak/pull/7272#discussion_r458766064", "createdAt": "2020-07-22T12:49:13Z", "author": {"login": "benjamin37"}, "path": "server-spi-private/src/main/java/org/keycloak/events/EventType.java", "diffHunk": "@@ -36,7 +36,8 @@\n     CLIENT_LOGIN_ERROR(true),\n \n     REFRESH_TOKEN(false),\n-    REFRESH_TOKEN_ERROR(false),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM0MTUxNA=="}, "originalCommit": {"oid": "fe222ac49c388259b909d1b6ced803e93307d08a"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3MTU1MjU0OnYy", "diffSide": "RIGHT", "path": "services/src/main/java/org/keycloak/jose/jws/DefaultTokenManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNDo0OToyN1rOG2yWgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxMDoyMzo0NlrOG3cmZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEwMTI0OQ==", "bodyText": "Would be the case to have a specific attribute to configure logout signatures instead of re-using the same attribute for ID tokens?\nFor me, looks like what you did is OK where the client should already support any signature set for ID tokens already. The same goes for de cek and encryption ...", "url": "https://github.com/keycloak/keycloak/pull/7272#discussion_r460101249", "createdAt": "2020-07-24T14:49:27Z", "author": {"login": "pedroigor"}, "path": "services/src/main/java/org/keycloak/jose/jws/DefaultTokenManager.java", "diffHunk": "@@ -129,6 +135,7 @@ public String signatureAlgorithm(TokenCategory category) {\n             case ACCESS:\n                 return getSignatureAlgorithm(OIDCConfigAttributes.ACCESS_TOKEN_SIGNED_RESPONSE_ALG);\n             case ID:\n+            case LOGOUT:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b7cee069f4a5a35dd92c5109e8ca9fad557bc30"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDc5MzQ0Nw==", "bodyText": "We used the ID token implementation because in the specification it says that the logout token should be encrypted and validated similar to the id token. In particular 2.6 \"Logout Token Validation\" it describes the use of the encryption, used for the ID token during client registration. So we tried to reuse the current id token implementation parts instead of adding new ones.", "url": "https://github.com/keycloak/keycloak/pull/7272#discussion_r460793447", "createdAt": "2020-07-27T10:23:46Z", "author": {"login": "DaSmoo"}, "path": "services/src/main/java/org/keycloak/jose/jws/DefaultTokenManager.java", "diffHunk": "@@ -129,6 +135,7 @@ public String signatureAlgorithm(TokenCategory category) {\n             case ACCESS:\n                 return getSignatureAlgorithm(OIDCConfigAttributes.ACCESS_TOKEN_SIGNED_RESPONSE_ALG);\n             case ID:\n+            case LOGOUT:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEwMTI0OQ=="}, "originalCommit": {"oid": "9b7cee069f4a5a35dd92c5109e8ca9fad557bc30"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3MTU4Mzk2OnYy", "diffSide": "RIGHT", "path": "services/src/main/java/org/keycloak/protocol/oidc/OIDCLoginProtocolService.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNDo1NzoxOVrOG2yptw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxMzoxNzo1NFrOG3iB4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEwNjE2Nw==", "bodyText": "Wouldn't be better if we just add the backchannel-logout endpoint from LogoutV2Endpoint to the LogoutEndpoint ?", "url": "https://github.com/keycloak/keycloak/pull/7272#discussion_r460106167", "createdAt": "2020-07-24T14:57:19Z", "author": {"login": "pedroigor"}, "path": "services/src/main/java/org/keycloak/protocol/oidc/OIDCLoginProtocolService.java", "diffHunk": "@@ -240,13 +250,23 @@ public Object issueUserInfo() {\n         return endpoint;\n     }\n \n+    /* old deprecated logout endpoint needs to be removed in the future\n+    * https://issues.redhat.com/browse/KEYCLOAK-2940 */\n     @Path(\"logout\")\n     public Object logout() {\n         LogoutEndpoint endpoint = new LogoutEndpoint(tokenManager, realm, event);\n         ResteasyProviderFactory.getInstance().injectProperties(endpoint);\n         return endpoint;\n     }\n \n+    /* new logout endpoint  */\n+    @Path(\"logout-v2\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b7cee069f4a5a35dd92c5109e8ca9fad557bc30"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDc5NDI3MQ==", "bodyText": "Sure, we will add the logout parts to the existing logout endpoint. This was the part where we didn't know how far the deprecation will go, that's why we create a new Endpoint class. Just to be clear, from @stianst comment \"You can ignore updating the logout endpoint as part of this, we'll handle that as a separate issue. Take a look at https://issues.redhat.com/browse/KEYCLOAK-11603 for more detail\", i understand now that we ignore the deprecation but add all methods to the existing LogoutEndpoint() is that correct?", "url": "https://github.com/keycloak/keycloak/pull/7272#discussion_r460794271", "createdAt": "2020-07-27T10:25:28Z", "author": {"login": "DaSmoo"}, "path": "services/src/main/java/org/keycloak/protocol/oidc/OIDCLoginProtocolService.java", "diffHunk": "@@ -240,13 +250,23 @@ public Object issueUserInfo() {\n         return endpoint;\n     }\n \n+    /* old deprecated logout endpoint needs to be removed in the future\n+    * https://issues.redhat.com/browse/KEYCLOAK-2940 */\n     @Path(\"logout\")\n     public Object logout() {\n         LogoutEndpoint endpoint = new LogoutEndpoint(tokenManager, realm, event);\n         ResteasyProviderFactory.getInstance().injectProperties(endpoint);\n         return endpoint;\n     }\n \n+    /* new logout endpoint  */\n+    @Path(\"logout-v2\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEwNjE2Nw=="}, "originalCommit": {"oid": "9b7cee069f4a5a35dd92c5109e8ca9fad557bc30"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDg4MjQwMw==", "bodyText": "Yes, we can always refactor later to deprecate and have a new endpoint,", "url": "https://github.com/keycloak/keycloak/pull/7272#discussion_r460882403", "createdAt": "2020-07-27T13:17:54Z", "author": {"login": "pedroigor"}, "path": "services/src/main/java/org/keycloak/protocol/oidc/OIDCLoginProtocolService.java", "diffHunk": "@@ -240,13 +250,23 @@ public Object issueUserInfo() {\n         return endpoint;\n     }\n \n+    /* old deprecated logout endpoint needs to be removed in the future\n+    * https://issues.redhat.com/browse/KEYCLOAK-2940 */\n     @Path(\"logout\")\n     public Object logout() {\n         LogoutEndpoint endpoint = new LogoutEndpoint(tokenManager, realm, event);\n         ResteasyProviderFactory.getInstance().injectProperties(endpoint);\n         return endpoint;\n     }\n \n+    /* new logout endpoint  */\n+    @Path(\"logout-v2\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEwNjE2Nw=="}, "originalCommit": {"oid": "9b7cee069f4a5a35dd92c5109e8ca9fad557bc30"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3MTczNjM4OnYy", "diffSide": "RIGHT", "path": "services/src/main/java/org/keycloak/services/managers/AuthenticationManager.java", "isResolved": true, "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNTozNjoyN1rOG20IDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMTo1MjoxN1rOG8GTuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEzMDMxOA==", "bodyText": "I think we could at least return a 504 to indicate that a client wasn't successful? Wdyt?\nAs per 2.8.  Back-Channel Logout Response.", "url": "https://github.com/keycloak/keycloak/pull/7272#discussion_r460130318", "createdAt": "2020-07-24T15:36:27Z", "author": {"login": "pedroigor"}, "path": "services/src/main/java/org/keycloak/services/managers/AuthenticationManager.java", "diffHunk": "@@ -404,7 +420,13 @@ private static boolean backchannelLogoutClientSession(KeycloakSession session, R\n             protocol.setRealm(realm)\n                     .setHttpHeaders(headers)\n                     .setUriInfo(uriInfo);\n-            protocol.backchannelLogout(userSession, clientSession);\n+\n+            /*\n+             * if we want to implement the specification to 100%, we would have to return the return correctly here. But\n+             * since the actual session of the client cannot be distinguished from the underlying ones we decided to\n+             * leave the value as it is for the first review of the pullrequest.\n+             */\n+            boolean clientSessionLogout = protocol.backchannelLogout(userSession, clientSession);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b7cee069f4a5a35dd92c5109e8ca9fad557bc30"}, "originalPosition": 142}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDgwMTQwNw==", "bodyText": "From the point of the specification we would return an an 501 (see 2.7 Back-Channel Logout Actions). The problem here is that if we only have one client session (the OPs for example) a back-channel logout wouldn't make sense. In the past this part of the code has been always triggert and if it failed no actions or returns has been performed. But now it would be nice to know if this session that gets triggert with a back-channel logout is really a session that needs to be logout out via the back-channel logout or if it's just the OP's session that will be logged out later in the logout process ( see the method \"backchannelLogout(KeycloakSession session, RealmModel realm, UserSessionModel userSession, UriInfo uriInfo,\nClientConnection connection, HttpHeaders headers, boolean logoutBroker, boolean offlineSession\" Class: AuthenticationManager.java line 233). If we now trigger a back-channel logout on the ops session it would fail because no IDP is configured.", "url": "https://github.com/keycloak/keycloak/pull/7272#discussion_r460801407", "createdAt": "2020-07-27T10:39:38Z", "author": {"login": "DaSmoo"}, "path": "services/src/main/java/org/keycloak/services/managers/AuthenticationManager.java", "diffHunk": "@@ -404,7 +420,13 @@ private static boolean backchannelLogoutClientSession(KeycloakSession session, R\n             protocol.setRealm(realm)\n                     .setHttpHeaders(headers)\n                     .setUriInfo(uriInfo);\n-            protocol.backchannelLogout(userSession, clientSession);\n+\n+            /*\n+             * if we want to implement the specification to 100%, we would have to return the return correctly here. But\n+             * since the actual session of the client cannot be distinguished from the underlying ones we decided to\n+             * leave the value as it is for the first review of the pullrequest.\n+             */\n+            boolean clientSessionLogout = protocol.backchannelLogout(userSession, clientSession);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEzMDMxOA=="}, "originalCommit": {"oid": "9b7cee069f4a5a35dd92c5109e8ca9fad557bc30"}, "originalPosition": 142}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk2NjgxOA==", "bodyText": "I see. I meant 504 to indicate whether or not some of the downstream sessions were not invalidated. 501 seems to be related to a failure during when processing the logout request?\nCould you elaborate a bit more about the failure if no IDP is configured, please ?", "url": "https://github.com/keycloak/keycloak/pull/7272#discussion_r460966818", "createdAt": "2020-07-27T15:16:10Z", "author": {"login": "pedroigor"}, "path": "services/src/main/java/org/keycloak/services/managers/AuthenticationManager.java", "diffHunk": "@@ -404,7 +420,13 @@ private static boolean backchannelLogoutClientSession(KeycloakSession session, R\n             protocol.setRealm(realm)\n                     .setHttpHeaders(headers)\n                     .setUriInfo(uriInfo);\n-            protocol.backchannelLogout(userSession, clientSession);\n+\n+            /*\n+             * if we want to implement the specification to 100%, we would have to return the return correctly here. But\n+             * since the actual session of the client cannot be distinguished from the underlying ones we decided to\n+             * leave the value as it is for the first review of the pullrequest.\n+             */\n+            boolean clientSessionLogout = protocol.backchannelLogout(userSession, clientSession);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEzMDMxOA=="}, "originalCommit": {"oid": "9b7cee069f4a5a35dd92c5109e8ca9fad557bc30"}, "originalPosition": 142}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAxNTk3MQ==", "bodyText": "yes, the idea from the openID specification is when an error happens in the back-channel logout happens, an 501 should be returned. I would agree that it would be better to give a more detailed feedback which session failed.\nThe problem is that this \"back-channel logout light\" (lets call it like that) is always used when an logout has been triggert.\nCurrently the protocol.backchannelLogout() gets triggert but no boolean or any response getting returned. To fulfil the openID back-channel logout specification, we would need to return an http status. Now with our change we saw in a test scenario that, when there is only one session (the OP itself) and the logout gets triggert through the @get public logout() this line of code also gets triggert and results in a false positive test with an incorrect return.\nBecause at the end the session gets removed by \"session.sessions().removeUserSession(realm, userSession);\" even if the back-channel logout failed. The return would be 5xx but the session had been successfully removed through the removeUserSession() method.\nMaybe the best way would be to find an attribute or something that indicates the session as a non back-channel logout session. Then it would be easy when the logout process loops over all client sessions to decide which sessions should also be logout with the back-channel process. You will find this loop in the method AuthenticationManager.backchannelLogoutAll() line 324.\nBut we wasn't able to find something like that. Maybe this is only an problem when the OP is an Keycloak.\nIf the OP is a Keycloak it always have an back-channel logout URL and supports the back-channel logout. So the OP would try to logout it self through a back-channel logout request. Which also results in a 5xx or 4xx error.\nIf it would help, we could for sure set up a call and discuss about that.", "url": "https://github.com/keycloak/keycloak/pull/7272#discussion_r461015971", "createdAt": "2020-07-27T16:29:31Z", "author": {"login": "DaSmoo"}, "path": "services/src/main/java/org/keycloak/services/managers/AuthenticationManager.java", "diffHunk": "@@ -404,7 +420,13 @@ private static boolean backchannelLogoutClientSession(KeycloakSession session, R\n             protocol.setRealm(realm)\n                     .setHttpHeaders(headers)\n                     .setUriInfo(uriInfo);\n-            protocol.backchannelLogout(userSession, clientSession);\n+\n+            /*\n+             * if we want to implement the specification to 100%, we would have to return the return correctly here. But\n+             * since the actual session of the client cannot be distinguished from the underlying ones we decided to\n+             * leave the value as it is for the first review of the pullrequest.\n+             */\n+            boolean clientSessionLogout = protocol.backchannelLogout(userSession, clientSession);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEzMDMxOA=="}, "originalCommit": {"oid": "9b7cee069f4a5a35dd92c5109e8ca9fad557bc30"}, "originalPosition": 142}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA0OTczMQ==", "bodyText": "I think I get it, see if it makes sense:\n\n\nI guess you mean org.keycloak.protocol.oidc.OIDCLoginProtocol#backchannelLogout, which we could change to return some information that the logout endpoint could use to decide which status code to return. At the very end of the method call you have a call to org.keycloak.services.managers.ResourceAdminManager#sendLogoutRequest which could return the status code that we could then use to build a Map where the key is the clientId and the value the status code. With this information, we could decide which status code to return.\n\n\nWhen there is a single session (the OP itself) and the current logout endpoint is called, I won't care much. But for the new endpoint, the expected behavior I think would be to just remove the session without involving a new logout request.\n\n\nBut yeah, I do think that proper status code is important for this new endpoint (not really for the current one).", "url": "https://github.com/keycloak/keycloak/pull/7272#discussion_r461049731", "createdAt": "2020-07-27T17:24:34Z", "author": {"login": "pedroigor"}, "path": "services/src/main/java/org/keycloak/services/managers/AuthenticationManager.java", "diffHunk": "@@ -404,7 +420,13 @@ private static boolean backchannelLogoutClientSession(KeycloakSession session, R\n             protocol.setRealm(realm)\n                     .setHttpHeaders(headers)\n                     .setUriInfo(uriInfo);\n-            protocol.backchannelLogout(userSession, clientSession);\n+\n+            /*\n+             * if we want to implement the specification to 100%, we would have to return the return correctly here. But\n+             * since the actual session of the client cannot be distinguished from the underlying ones we decided to\n+             * leave the value as it is for the first review of the pullrequest.\n+             */\n+            boolean clientSessionLogout = protocol.backchannelLogout(userSession, clientSession);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEzMDMxOA=="}, "originalCommit": {"oid": "9b7cee069f4a5a35dd92c5109e8ca9fad557bc30"}, "originalPosition": 142}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzYwMzgzMg==", "bodyText": "I'm not sure about returning a JSON with clientId as Key and HTTP Status of the downstream backchannel logout as value as response body of the backchannel logout REST call.\nGiven the scenario you have an OP Keycloak with multiple Clients connected which are called by downstream RPs. Someone sends a backchannel logout request to the OP Keycloak. This someone does typically not know which clients are configured in the OP Keycloak. OP sends backchannel logout requests to downstream clients, let's assume one returns 200 and one 501. The respose of OP Keycloak would look something like this:\nStatus: 504 Gateway Timeout\nBody:\n{\n  \"client_1\": 200,\n  \"client_2\": 501\n}\n\nThe first problem we see is that there can be multiple sessions in each downstream client that need to be logged out with one backchannel logout request. So one status code would not be enough. We could also add session id's and so on to the json to get rid of that problem.\nThe second problem is that \"someone\" who called the backchannel logout at the Keycloak OP does normally not know about client ids and session ids of the Keycloak OP. So that's not the kind of information that should be passed as a response right?\n\nOur suggestion is to just return a 504 in case of a downstream client failing to logout but leaving the response body empty. What do you think?", "url": "https://github.com/keycloak/keycloak/pull/7272#discussion_r463603832", "createdAt": "2020-07-31T13:15:45Z", "author": {"login": "benjamin37"}, "path": "services/src/main/java/org/keycloak/services/managers/AuthenticationManager.java", "diffHunk": "@@ -404,7 +420,13 @@ private static boolean backchannelLogoutClientSession(KeycloakSession session, R\n             protocol.setRealm(realm)\n                     .setHttpHeaders(headers)\n                     .setUriInfo(uriInfo);\n-            protocol.backchannelLogout(userSession, clientSession);\n+\n+            /*\n+             * if we want to implement the specification to 100%, we would have to return the return correctly here. But\n+             * since the actual session of the client cannot be distinguished from the underlying ones we decided to\n+             * leave the value as it is for the first review of the pullrequest.\n+             */\n+            boolean clientSessionLogout = protocol.backchannelLogout(userSession, clientSession);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEzMDMxOA=="}, "originalCommit": {"oid": "9b7cee069f4a5a35dd92c5109e8ca9fad557bc30"}, "originalPosition": 142}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzYxMDY3Mg==", "bodyText": "Yeah, let's keep 504 and no body.\nLet's try to come up with something that solves the original idea as a follow-up. We can do other things here like returning a link for force/retry logout to specific clients, etc.", "url": "https://github.com/keycloak/keycloak/pull/7272#discussion_r463610672", "createdAt": "2020-07-31T13:28:44Z", "author": {"login": "pedroigor"}, "path": "services/src/main/java/org/keycloak/services/managers/AuthenticationManager.java", "diffHunk": "@@ -404,7 +420,13 @@ private static boolean backchannelLogoutClientSession(KeycloakSession session, R\n             protocol.setRealm(realm)\n                     .setHttpHeaders(headers)\n                     .setUriInfo(uriInfo);\n-            protocol.backchannelLogout(userSession, clientSession);\n+\n+            /*\n+             * if we want to implement the specification to 100%, we would have to return the return correctly here. But\n+             * since the actual session of the client cannot be distinguished from the underlying ones we decided to\n+             * leave the value as it is for the first review of the pullrequest.\n+             */\n+            boolean clientSessionLogout = protocol.backchannelLogout(userSession, clientSession);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEzMDMxOA=="}, "originalCommit": {"oid": "9b7cee069f4a5a35dd92c5109e8ca9fad557bc30"}, "originalPosition": 142}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY3MTA5Ng==", "bodyText": "Done", "url": "https://github.com/keycloak/keycloak/pull/7272#discussion_r465671096", "createdAt": "2020-08-05T11:52:17Z", "author": {"login": "benjamin37"}, "path": "services/src/main/java/org/keycloak/services/managers/AuthenticationManager.java", "diffHunk": "@@ -404,7 +420,13 @@ private static boolean backchannelLogoutClientSession(KeycloakSession session, R\n             protocol.setRealm(realm)\n                     .setHttpHeaders(headers)\n                     .setUriInfo(uriInfo);\n-            protocol.backchannelLogout(userSession, clientSession);\n+\n+            /*\n+             * if we want to implement the specification to 100%, we would have to return the return correctly here. But\n+             * since the actual session of the client cannot be distinguished from the underlying ones we decided to\n+             * leave the value as it is for the first review of the pullrequest.\n+             */\n+            boolean clientSessionLogout = protocol.backchannelLogout(userSession, clientSession);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDEzMDMxOA=="}, "originalCommit": {"oid": "9b7cee069f4a5a35dd92c5109e8ca9fad557bc30"}, "originalPosition": 142}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzkwNTc4NjYxOnYy", "diffSide": "RIGHT", "path": "testsuite/integration-arquillian/tests/base/src/main/java/org/keycloak/testsuite/util/OAuthClient.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0yMVQwMzo0Nzo0NVrOJMltYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0yMVQwMzo0Nzo0NVrOJMltYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzE4MDUxMg==", "bodyText": "There is a typo here. It was meant to be logoutToken instead of logoutTokon.", "url": "https://github.com/keycloak/keycloak/pull/7272#discussion_r617180512", "createdAt": "2021-04-21T03:47:45Z", "author": {"login": "CG-ANY"}, "path": "testsuite/integration-arquillian/tests/base/src/main/java/org/keycloak/testsuite/util/OAuthClient.java", "diffHunk": "@@ -663,6 +723,32 @@ public CloseableHttpResponse doLogout(String refreshToken, String clientSecret,\n         return client.execute(post);\n     }\n \n+    public CloseableHttpResponse doBackchannelLogout(String logoutTokon) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d54e79f3ce62dcc17c8505558d451e86fa3adb1"}, "originalPosition": 122}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3480, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}