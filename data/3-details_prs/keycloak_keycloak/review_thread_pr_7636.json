{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1NjgwNTI5", "number": 7636, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwODo1Nzo1MFrOFAshCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNDozMToyN1rOFBzudQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MjczNjc1OnYy", "diffSide": "RIGHT", "path": "model/jpa/src/main/java/org/keycloak/models/jpa/RealmAdapter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwODo1Nzo1MFrOH_HEiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQxOTozMDo0NlrOIAOaPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkzODE4NQ==", "bodyText": "Is this flush call needed?", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r535938185", "createdAt": "2020-12-04T08:57:50Z", "author": {"login": "hmlnarik"}, "path": "model/jpa/src/main/java/org/keycloak/models/jpa/RealmAdapter.java", "diffHunk": "@@ -1204,6 +1159,20 @@ public void setMasterAdminClient(ClientModel client) {\n         em.flush();\n     }\n \n+    @Override\n+    public void setDefaultRole(RoleModel role) {\n+        realm.setDefaultRoleId(role.getId());\n+        em.flush();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b77443f88b2cb572c1d9cd4332c2c50625ec326d"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEwNzAwNQ==", "bodyText": "no, it isn't, thank you", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r537107005", "createdAt": "2020-12-06T19:30:46Z", "author": {"login": "vramik"}, "path": "model/jpa/src/main/java/org/keycloak/models/jpa/RealmAdapter.java", "diffHunk": "@@ -1204,6 +1159,20 @@ public void setMasterAdminClient(ClientModel client) {\n         em.flush();\n     }\n \n+    @Override\n+    public void setDefaultRole(RoleModel role) {\n+        realm.setDefaultRoleId(role.getId());\n+        em.flush();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkzODE4NQ=="}, "originalCommit": {"oid": "b77443f88b2cb572c1d9cd4332c2c50625ec326d"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2Mjc2NzQ4OnYy", "diffSide": "RIGHT", "path": "testsuite/integration-arquillian/tests/base/src/test/resources/migration-test/migration-realm-1.9.8.Final.json", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwOTowNToxNlrOH_HWQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxOTo1NjoxOVrOIA4Ftg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk0MjcyMQ==", "bodyText": "Can we do without this change?", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r535942721", "createdAt": "2020-12-04T09:05:16Z", "author": {"login": "hmlnarik"}, "path": "testsuite/integration-arquillian/tests/base/src/test/resources/migration-test/migration-realm-1.9.8.Final.json", "diffHunk": "@@ -324,7 +324,7 @@\n     \"clientRoles\" : { },\n     \"subGroups\" : [ ]\n   } ],\n-  \"defaultRoles\" : [ \"offline_access\" ],\n+  \"defaultRoles\" : [ \"offline_access\", \"master-test-realm-role\" ],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b77443f88b2cb572c1d9cd4332c2c50625ec326d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEwODgyOQ==", "bodyText": "Yes we can, but I think it's still good way for testing migration of default roles. I've used roles which are already presented in the realm json files and also it's in a format which is still compatible with the particular version, so if you try to import the json file to 1.9.8, you should succeed and if you had the role in the previous version the json would end up exactly how it's.\nSo I've re-used those role to be able to test all migration within single method: AbstractMigrationTest.testDefaultRoles\nI also plan to create one more role with name 'default-roles' in json files to test that newly created default role will have 'default-roles1' name. WDYT?", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r537108829", "createdAt": "2020-12-06T19:41:20Z", "author": {"login": "vramik"}, "path": "testsuite/integration-arquillian/tests/base/src/test/resources/migration-test/migration-realm-1.9.8.Final.json", "diffHunk": "@@ -324,7 +324,7 @@\n     \"clientRoles\" : { },\n     \"subGroups\" : [ ]\n   } ],\n-  \"defaultRoles\" : [ \"offline_access\" ],\n+  \"defaultRoles\" : [ \"offline_access\", \"master-test-realm-role\" ],", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk0MjcyMQ=="}, "originalCommit": {"oid": "b77443f88b2cb572c1d9cd4332c2c50625ec326d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzc4OTg3OA==", "bodyText": "This sounds good to me, thanks!", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r537789878", "createdAt": "2020-12-07T19:56:19Z", "author": {"login": "hmlnarik"}, "path": "testsuite/integration-arquillian/tests/base/src/test/resources/migration-test/migration-realm-1.9.8.Final.json", "diffHunk": "@@ -324,7 +324,7 @@\n     \"clientRoles\" : { },\n     \"subGroups\" : [ ]\n   } ],\n-  \"defaultRoles\" : [ \"offline_access\" ],\n+  \"defaultRoles\" : [ \"offline_access\", \"master-test-realm-role\" ],", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk0MjcyMQ=="}, "originalCommit": {"oid": "b77443f88b2cb572c1d9cd4332c2c50625ec326d"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3MzY0MDI5OnYy", "diffSide": "RIGHT", "path": "model/infinispan/src/main/java/org/keycloak/models/cache/infinispan/RealmAdapter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMTozNzo1NlrOIAionA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDozMDo1MlrOIBSYoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQzODM2NA==", "bodyText": "Should be this commented block removed? If no should we add some comment why it is there?", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r537438364", "createdAt": "2020-12-07T11:37:56Z", "author": {"login": "mhajas"}, "path": "model/infinispan/src/main/java/org/keycloak/models/cache/infinispan/RealmAdapter.java", "diffHunk": "@@ -724,29 +724,39 @@ public void removeDefaultGroup(GroupModel group) {\n \n     }\n \n-    @Override\n-    public Stream<String> getDefaultRolesStream() {\n-        if (isUpdated()) return updated.getDefaultRolesStream();\n-        return cached.getDefaultRoles().stream();\n-    }\n-\n-    @Override\n-    public void addDefaultRole(String name) {\n-        getDelegateForUpdate();\n-        updated.addDefaultRole(name);\n-    }\n-\n-    @Override\n-    public void updateDefaultRoles(String... defaultRoles) {\n-        getDelegateForUpdate();\n-        updated.updateDefaultRoles(defaultRoles);\n-    }\n-\n-    @Override\n-    public void removeDefaultRoles(String... defaultRoles) {\n-        getDelegateForUpdate();\n-        updated.removeDefaultRoles(defaultRoles);\n-\n+//    @Override", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5314d629274ceb03556244c15f0dfefaeb6d71d6"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIyMDcwNQ==", "bodyText": "done", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r538220705", "createdAt": "2020-12-08T10:30:52Z", "author": {"login": "vramik"}, "path": "model/infinispan/src/main/java/org/keycloak/models/cache/infinispan/RealmAdapter.java", "diffHunk": "@@ -724,29 +724,39 @@ public void removeDefaultGroup(GroupModel group) {\n \n     }\n \n-    @Override\n-    public Stream<String> getDefaultRolesStream() {\n-        if (isUpdated()) return updated.getDefaultRolesStream();\n-        return cached.getDefaultRoles().stream();\n-    }\n-\n-    @Override\n-    public void addDefaultRole(String name) {\n-        getDelegateForUpdate();\n-        updated.addDefaultRole(name);\n-    }\n-\n-    @Override\n-    public void updateDefaultRoles(String... defaultRoles) {\n-        getDelegateForUpdate();\n-        updated.updateDefaultRoles(defaultRoles);\n-    }\n-\n-    @Override\n-    public void removeDefaultRoles(String... defaultRoles) {\n-        getDelegateForUpdate();\n-        updated.removeDefaultRoles(defaultRoles);\n-\n+//    @Override", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQzODM2NA=="}, "originalCommit": {"oid": "5314d629274ceb03556244c15f0dfefaeb6d71d6"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3MzY2ODkyOnYy", "diffSide": "RIGHT", "path": "server-spi/src/main/java/org/keycloak/models/RoleContainerModel.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMTo0NToyNFrOIAi5Yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMDozMTowMlrOIBSZRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ0MjY1OQ==", "bodyText": "If I understand this correctly, this interface will basically stop working in newer versions. Should we provide an implementation of this that uses the composite default role in the background to stay backward compatible?", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r537442659", "createdAt": "2020-12-07T11:45:24Z", "author": {"login": "mhajas"}, "path": "server-spi/src/main/java/org/keycloak/models/RoleContainerModel.java", "diffHunk": "@@ -71,60 +67,40 @@\n     Stream<RoleModel> searchForRolesStream(String search, Integer first, Integer max);\n \n     /**\n-     * Returns all the default role names of this object.\n-     * @return List of the default role names of this object. Never returns {@code null}.\n-     * @deprecated use the stream variant instead\n+     * @deprecated Default roles are now managed by {@link org.keycloak.models.RealmModel#getDefaultRole()}\n      */\n     @Deprecated\n     default List<String> getDefaultRoles() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5314d629274ceb03556244c15f0dfefaeb6d71d6"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIyMDg2OA==", "bodyText": "Yes, you're right. It started by the fact that I've relialized we don't need to have possibility to manage default roles of each client separately so I've sent a mail to keycloak-dev about that and got confirmation I can remove the possibility from clients. Then we decided we should add RoleModel RealmModel.getDefaultRole() and it basically means all these methods could be potentionaly removed. But in the end it ended up like this. I've introduced those implementations you've asked for in separate commit for better re-review.", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r538220868", "createdAt": "2020-12-08T10:31:02Z", "author": {"login": "vramik"}, "path": "server-spi/src/main/java/org/keycloak/models/RoleContainerModel.java", "diffHunk": "@@ -71,60 +67,40 @@\n     Stream<RoleModel> searchForRolesStream(String search, Integer first, Integer max);\n \n     /**\n-     * Returns all the default role names of this object.\n-     * @return List of the default role names of this object. Never returns {@code null}.\n-     * @deprecated use the stream variant instead\n+     * @deprecated Default roles are now managed by {@link org.keycloak.models.RealmModel#getDefaultRole()}\n      */\n     @Deprecated\n     default List<String> getDefaultRoles() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ0MjY1OQ=="}, "originalCommit": {"oid": "5314d629274ceb03556244c15f0dfefaeb6d71d6"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3Mzc2Nzc2OnYy", "diffSide": "RIGHT", "path": "services/src/main/java/org/keycloak/services/resources/admin/RoleByIdResource.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMjowOToyM1rOIAjy5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMTowMzo1OVrOIBT7uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1NzM4Mg==", "bodyText": "Is it possible that defaultRole is null? Or we can be sure default role always exists?", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r537457382", "createdAt": "2020-12-07T12:09:23Z", "author": {"login": "mhajas"}, "path": "services/src/main/java/org/keycloak/services/resources/admin/RoleByIdResource.java", "diffHunk": "@@ -104,6 +106,11 @@ protected RoleModel getRoleModel(String id) {\n     @DELETE\n     @NoCache\n     public void deleteRole(final @PathParam(\"role-id\") String id) {\n+        if (realm.getDefaultRole().getId().equals(id)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5314d629274ceb03556244c15f0dfefaeb6d71d6"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIxMjM5Mw==", "bodyText": "The default role should always exist, in case it doesn't the server is in illegal state. But I get your point.\nNot sure if it'll be better to handle null possibility here rather than later face NPE or rely on the fact the role has to exist. wdyt?\nAnd if the former the question is what would be correct way to handle it. I lean towards to do nothing: if (realm.getDefaultRole == null) return; wdyt?", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r538212393", "createdAt": "2020-12-08T10:19:17Z", "author": {"login": "vramik"}, "path": "services/src/main/java/org/keycloak/services/resources/admin/RoleByIdResource.java", "diffHunk": "@@ -104,6 +106,11 @@ protected RoleModel getRoleModel(String id) {\n     @DELETE\n     @NoCache\n     public void deleteRole(final @PathParam(\"role-id\") String id) {\n+        if (realm.getDefaultRole().getId().equals(id)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1NzM4Mg=="}, "originalCommit": {"oid": "5314d629274ceb03556244c15f0dfefaeb6d71d6"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIyMDY1NA==", "bodyText": "I'd say the right way is to log a warning if the default role does not exist, and then return.", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r538220654", "createdAt": "2020-12-08T10:30:48Z", "author": {"login": "hmlnarik"}, "path": "services/src/main/java/org/keycloak/services/resources/admin/RoleByIdResource.java", "diffHunk": "@@ -104,6 +106,11 @@ protected RoleModel getRoleModel(String id) {\n     @DELETE\n     @NoCache\n     public void deleteRole(final @PathParam(\"role-id\") String id) {\n+        if (realm.getDefaultRole().getId().equals(id)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1NzM4Mg=="}, "originalCommit": {"oid": "5314d629274ceb03556244c15f0dfefaeb6d71d6"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIyMzk2NA==", "bodyText": "@hmlnarik sounds good, thank you", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r538223964", "createdAt": "2020-12-08T10:34:23Z", "author": {"login": "vramik"}, "path": "services/src/main/java/org/keycloak/services/resources/admin/RoleByIdResource.java", "diffHunk": "@@ -104,6 +106,11 @@ protected RoleModel getRoleModel(String id) {\n     @DELETE\n     @NoCache\n     public void deleteRole(final @PathParam(\"role-id\") String id) {\n+        if (realm.getDefaultRole().getId().equals(id)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1NzM4Mg=="}, "originalCommit": {"oid": "5314d629274ceb03556244c15f0dfefaeb6d71d6"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODI0NjA3NQ==", "bodyText": "Thinking about it a bit deeper, I wonder whether we should not just allow deleting the role in case there is no default role defined. Yes, log a warning, but preventing to delete any role when default role is not set on realm seems too much on the second thought. WDYT?", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r538246075", "createdAt": "2020-12-08T11:03:59Z", "author": {"login": "hmlnarik"}, "path": "services/src/main/java/org/keycloak/services/resources/admin/RoleByIdResource.java", "diffHunk": "@@ -104,6 +106,11 @@ protected RoleModel getRoleModel(String id) {\n     @DELETE\n     @NoCache\n     public void deleteRole(final @PathParam(\"role-id\") String id) {\n+        if (realm.getDefaultRole().getId().equals(id)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1NzM4Mg=="}, "originalCommit": {"oid": "5314d629274ceb03556244c15f0dfefaeb6d71d6"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NDQwMzczOnYy", "diffSide": "RIGHT", "path": "themes/src/main/resources/theme/base/admin/resources/js/controllers/realm.js", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNDozMToyN1rOIAphiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMToyNTo1MFrOICPw8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU1MTI0MA==", "bodyText": "This seems like a duplicity of this: https://github.com/keycloak/keycloak/blob/master/themes/src/main/resources/theme/base/admin/resources/js/services.js#L1059\nIf I understand it correctly this function should provide all functionality necessary for default tab to work, so we could remove almost all code from here and add just call to roleControl() function. Have you tried it?", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r537551240", "createdAt": "2020-12-07T14:31:27Z", "author": {"login": "mhajas"}, "path": "themes/src/main/resources/theme/base/admin/resources/js/controllers/realm.js", "diffHunk": "@@ -747,99 +747,119 @@ module.controller('RealmPasswordPolicyCtrl', function($scope, Realm, realm, $htt\n     };\n });\n \n-module.controller('RealmDefaultRolesCtrl', function ($scope, $route, Realm, realm, roles, Notifications, ClientRole, Client) {\n+module.controller('RealmDefaultRolesCtrl', function ($scope, $route, realm, roles, Notifications, ClientRole, Client, RoleRealmComposites, RoleClientComposites, ComponentUtils, $http) {\n \n     console.log('RealmDefaultRolesCtrl');\n \n     $scope.realm = realm;\n-\n-    $scope.availableRealmRoles = [];\n+    $scope.availableRealmRoles = angular.copy(roles);\n     $scope.selectedRealmRoles = [];\n     $scope.selectedRealmDefRoles = [];\n \n     $scope.availableClientRoles = [];\n     $scope.selectedClientRoles = [];\n     $scope.selectedClientDefRoles = [];\n \n-    if (!$scope.realm.hasOwnProperty('defaultRoles') || $scope.realm.defaultRoles === null) {\n-        $scope.realm.defaultRoles = [];\n+    for (var j = 0; j < $scope.availableRealmRoles.length; j++) {\n+        if ($scope.availableRealmRoles[j].id === realm.defaultRole.id) {\n+            var realmRole = $scope.availableRealmRoles[j];\n+            var idx = $scope.availableRealmRoles.indexOf(realmRole);\n+            $scope.availableRealmRoles.splice(idx, 1);\n+            break;\n+        }\n     }\n \n-    // Populate available roles. Available roles are neither already assigned\n-    for (var i = 0; i < roles.length; i++) {\n-        var item = roles[i].name;\n-\n-        if ($scope.realm.defaultRoles.indexOf(item) < 0) {\n-            $scope.availableRealmRoles.push(item);\n+    $scope.realmMappings = RoleRealmComposites.query({realm : realm.realm, role : realm.defaultRole.id}, function(){\n+        for (var i = 0; i < $scope.realmMappings.length; i++) {\n+            var role = $scope.realmMappings[i];\n+            for (var j = 0; j < $scope.availableRealmRoles.length; j++) {\n+                var realmRole = $scope.availableRealmRoles[j];\n+                if (realmRole.id === role.id) {\n+                    var idx = $scope.availableRealmRoles.indexOf(realmRole);\n+                    if (idx !== -1) {\n+                        $scope.availableRealmRoles.splice(idx, 1);\n+                        break;\n+                    }\n+                }\n+            }\n         }\n-    }\n+    });\n \n     $scope.addRealmDefaultRole = function () {\n \n-        // Remove selected roles from the Available roles and add them to realm default roles (move from left to right).\n-        for (var i = 0; i < $scope.selectedRealmRoles.length; i++) {\n-            var selectedRole = $scope.selectedRealmRoles[i];\n-\n-            $scope.realm.defaultRoles.push(selectedRole);\n-\n-            var index = $scope.availableRealmRoles.indexOf(selectedRole);\n-            if (index > -1) {\n-                $scope.availableRealmRoles.splice(index, 1);\n+        $scope.selectedRealmRolesToAdd = JSON.parse('[' + $scope.selectedRealmRoles + ']');\n+        $http.post(authUrl + '/admin/realms/' + realm.realm + '/roles-by-id/' + realm.defaultRole.id + '/composites',\n+            $scope.selectedRealmRolesToAdd).then(function() {\n+            // Remove selected roles from the Available roles and add them to realm default roles (move from left to right).\n+            for (var i = 0; i < $scope.selectedRealmRolesToAdd.length; i++) {\n+                var selectedRole = $scope.selectedRealmRolesToAdd[i];\n+                var index = ComponentUtils.findIndexById($scope.availableRealmRoles, selectedRole.id);\n+                if (index > -1) {\n+                    $scope.availableRealmRoles.splice(index, 1);\n+                    $scope.realmMappings.push(selectedRole);\n+                }\n             }\n-        }\n-\n-        $scope.selectedRealmRoles = [];\n \n-        // Update/save the realm with new default roles.\n-        Realm.update($scope.realm, function () {\n-            Notifications.success(\"Realm default roles updated.\");\n+            $scope.selectedRealmRoles = [];\n+            $scope.selectedRealmRolesToAdd = [];\n+            Notifications.success(\"Default roles updated.\");\n         });\n     };\n \n     $scope.deleteRealmDefaultRole = function () {\n \n-        // Remove selected roles from the realm default roles and add them to available roles (move from right to left).\n-        for (var i = 0; i < $scope.selectedRealmDefRoles.length; i++) {\n-            $scope.availableRealmRoles.push($scope.selectedRealmDefRoles[i]);\n-\n-            var index = $scope.realm.defaultRoles.indexOf($scope.selectedRealmDefRoles[i]);\n-            if (index > -1) {\n-                $scope.realm.defaultRoles.splice(index, 1);\n+        $scope.selectedClientRolesToRemove = JSON.parse('[' + $scope.selectedRealmDefRoles + ']');\n+        $http.delete(authUrl + '/admin/realms/' + realm.realm + '/roles-by-id/' + realm.defaultRole.id + '/composites',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5314d629274ceb03556244c15f0dfefaeb6d71d6"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIxNzg0MQ==", "bodyText": "I was trying to re-use roleControl method [1] but I wasn't able to do it successfully. So I ended up with current state. But if you know how to do it, I'll be grateful for the advise (or contribution :) ).\n[1] https://github.com/keycloak/keycloak/blob/master/themes/src/main/resources/theme/base/admin/resources/js/services.js#L965", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r538217841", "createdAt": "2020-12-08T10:27:23Z", "author": {"login": "vramik"}, "path": "themes/src/main/resources/theme/base/admin/resources/js/controllers/realm.js", "diffHunk": "@@ -747,99 +747,119 @@ module.controller('RealmPasswordPolicyCtrl', function($scope, Realm, realm, $htt\n     };\n });\n \n-module.controller('RealmDefaultRolesCtrl', function ($scope, $route, Realm, realm, roles, Notifications, ClientRole, Client) {\n+module.controller('RealmDefaultRolesCtrl', function ($scope, $route, realm, roles, Notifications, ClientRole, Client, RoleRealmComposites, RoleClientComposites, ComponentUtils, $http) {\n \n     console.log('RealmDefaultRolesCtrl');\n \n     $scope.realm = realm;\n-\n-    $scope.availableRealmRoles = [];\n+    $scope.availableRealmRoles = angular.copy(roles);\n     $scope.selectedRealmRoles = [];\n     $scope.selectedRealmDefRoles = [];\n \n     $scope.availableClientRoles = [];\n     $scope.selectedClientRoles = [];\n     $scope.selectedClientDefRoles = [];\n \n-    if (!$scope.realm.hasOwnProperty('defaultRoles') || $scope.realm.defaultRoles === null) {\n-        $scope.realm.defaultRoles = [];\n+    for (var j = 0; j < $scope.availableRealmRoles.length; j++) {\n+        if ($scope.availableRealmRoles[j].id === realm.defaultRole.id) {\n+            var realmRole = $scope.availableRealmRoles[j];\n+            var idx = $scope.availableRealmRoles.indexOf(realmRole);\n+            $scope.availableRealmRoles.splice(idx, 1);\n+            break;\n+        }\n     }\n \n-    // Populate available roles. Available roles are neither already assigned\n-    for (var i = 0; i < roles.length; i++) {\n-        var item = roles[i].name;\n-\n-        if ($scope.realm.defaultRoles.indexOf(item) < 0) {\n-            $scope.availableRealmRoles.push(item);\n+    $scope.realmMappings = RoleRealmComposites.query({realm : realm.realm, role : realm.defaultRole.id}, function(){\n+        for (var i = 0; i < $scope.realmMappings.length; i++) {\n+            var role = $scope.realmMappings[i];\n+            for (var j = 0; j < $scope.availableRealmRoles.length; j++) {\n+                var realmRole = $scope.availableRealmRoles[j];\n+                if (realmRole.id === role.id) {\n+                    var idx = $scope.availableRealmRoles.indexOf(realmRole);\n+                    if (idx !== -1) {\n+                        $scope.availableRealmRoles.splice(idx, 1);\n+                        break;\n+                    }\n+                }\n+            }\n         }\n-    }\n+    });\n \n     $scope.addRealmDefaultRole = function () {\n \n-        // Remove selected roles from the Available roles and add them to realm default roles (move from left to right).\n-        for (var i = 0; i < $scope.selectedRealmRoles.length; i++) {\n-            var selectedRole = $scope.selectedRealmRoles[i];\n-\n-            $scope.realm.defaultRoles.push(selectedRole);\n-\n-            var index = $scope.availableRealmRoles.indexOf(selectedRole);\n-            if (index > -1) {\n-                $scope.availableRealmRoles.splice(index, 1);\n+        $scope.selectedRealmRolesToAdd = JSON.parse('[' + $scope.selectedRealmRoles + ']');\n+        $http.post(authUrl + '/admin/realms/' + realm.realm + '/roles-by-id/' + realm.defaultRole.id + '/composites',\n+            $scope.selectedRealmRolesToAdd).then(function() {\n+            // Remove selected roles from the Available roles and add them to realm default roles (move from left to right).\n+            for (var i = 0; i < $scope.selectedRealmRolesToAdd.length; i++) {\n+                var selectedRole = $scope.selectedRealmRolesToAdd[i];\n+                var index = ComponentUtils.findIndexById($scope.availableRealmRoles, selectedRole.id);\n+                if (index > -1) {\n+                    $scope.availableRealmRoles.splice(index, 1);\n+                    $scope.realmMappings.push(selectedRole);\n+                }\n             }\n-        }\n-\n-        $scope.selectedRealmRoles = [];\n \n-        // Update/save the realm with new default roles.\n-        Realm.update($scope.realm, function () {\n-            Notifications.success(\"Realm default roles updated.\");\n+            $scope.selectedRealmRoles = [];\n+            $scope.selectedRealmRolesToAdd = [];\n+            Notifications.success(\"Default roles updated.\");\n         });\n     };\n \n     $scope.deleteRealmDefaultRole = function () {\n \n-        // Remove selected roles from the realm default roles and add them to available roles (move from right to left).\n-        for (var i = 0; i < $scope.selectedRealmDefRoles.length; i++) {\n-            $scope.availableRealmRoles.push($scope.selectedRealmDefRoles[i]);\n-\n-            var index = $scope.realm.defaultRoles.indexOf($scope.selectedRealmDefRoles[i]);\n-            if (index > -1) {\n-                $scope.realm.defaultRoles.splice(index, 1);\n+        $scope.selectedClientRolesToRemove = JSON.parse('[' + $scope.selectedRealmDefRoles + ']');\n+        $http.delete(authUrl + '/admin/realms/' + realm.realm + '/roles-by-id/' + realm.defaultRole.id + '/composites',", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU1MTI0MA=="}, "originalCommit": {"oid": "5314d629274ceb03556244c15f0dfefaeb6d71d6"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIyNjM1Mg==", "bodyText": "I don't know how to do it, I just saw it has some similar parts so I was wondering whether it is possible to use it.  But if you tried it and it didn't work, lets leave it as it is.", "url": "https://github.com/keycloak/keycloak/pull/7636#discussion_r539226352", "createdAt": "2020-12-09T11:25:50Z", "author": {"login": "mhajas"}, "path": "themes/src/main/resources/theme/base/admin/resources/js/controllers/realm.js", "diffHunk": "@@ -747,99 +747,119 @@ module.controller('RealmPasswordPolicyCtrl', function($scope, Realm, realm, $htt\n     };\n });\n \n-module.controller('RealmDefaultRolesCtrl', function ($scope, $route, Realm, realm, roles, Notifications, ClientRole, Client) {\n+module.controller('RealmDefaultRolesCtrl', function ($scope, $route, realm, roles, Notifications, ClientRole, Client, RoleRealmComposites, RoleClientComposites, ComponentUtils, $http) {\n \n     console.log('RealmDefaultRolesCtrl');\n \n     $scope.realm = realm;\n-\n-    $scope.availableRealmRoles = [];\n+    $scope.availableRealmRoles = angular.copy(roles);\n     $scope.selectedRealmRoles = [];\n     $scope.selectedRealmDefRoles = [];\n \n     $scope.availableClientRoles = [];\n     $scope.selectedClientRoles = [];\n     $scope.selectedClientDefRoles = [];\n \n-    if (!$scope.realm.hasOwnProperty('defaultRoles') || $scope.realm.defaultRoles === null) {\n-        $scope.realm.defaultRoles = [];\n+    for (var j = 0; j < $scope.availableRealmRoles.length; j++) {\n+        if ($scope.availableRealmRoles[j].id === realm.defaultRole.id) {\n+            var realmRole = $scope.availableRealmRoles[j];\n+            var idx = $scope.availableRealmRoles.indexOf(realmRole);\n+            $scope.availableRealmRoles.splice(idx, 1);\n+            break;\n+        }\n     }\n \n-    // Populate available roles. Available roles are neither already assigned\n-    for (var i = 0; i < roles.length; i++) {\n-        var item = roles[i].name;\n-\n-        if ($scope.realm.defaultRoles.indexOf(item) < 0) {\n-            $scope.availableRealmRoles.push(item);\n+    $scope.realmMappings = RoleRealmComposites.query({realm : realm.realm, role : realm.defaultRole.id}, function(){\n+        for (var i = 0; i < $scope.realmMappings.length; i++) {\n+            var role = $scope.realmMappings[i];\n+            for (var j = 0; j < $scope.availableRealmRoles.length; j++) {\n+                var realmRole = $scope.availableRealmRoles[j];\n+                if (realmRole.id === role.id) {\n+                    var idx = $scope.availableRealmRoles.indexOf(realmRole);\n+                    if (idx !== -1) {\n+                        $scope.availableRealmRoles.splice(idx, 1);\n+                        break;\n+                    }\n+                }\n+            }\n         }\n-    }\n+    });\n \n     $scope.addRealmDefaultRole = function () {\n \n-        // Remove selected roles from the Available roles and add them to realm default roles (move from left to right).\n-        for (var i = 0; i < $scope.selectedRealmRoles.length; i++) {\n-            var selectedRole = $scope.selectedRealmRoles[i];\n-\n-            $scope.realm.defaultRoles.push(selectedRole);\n-\n-            var index = $scope.availableRealmRoles.indexOf(selectedRole);\n-            if (index > -1) {\n-                $scope.availableRealmRoles.splice(index, 1);\n+        $scope.selectedRealmRolesToAdd = JSON.parse('[' + $scope.selectedRealmRoles + ']');\n+        $http.post(authUrl + '/admin/realms/' + realm.realm + '/roles-by-id/' + realm.defaultRole.id + '/composites',\n+            $scope.selectedRealmRolesToAdd).then(function() {\n+            // Remove selected roles from the Available roles and add them to realm default roles (move from left to right).\n+            for (var i = 0; i < $scope.selectedRealmRolesToAdd.length; i++) {\n+                var selectedRole = $scope.selectedRealmRolesToAdd[i];\n+                var index = ComponentUtils.findIndexById($scope.availableRealmRoles, selectedRole.id);\n+                if (index > -1) {\n+                    $scope.availableRealmRoles.splice(index, 1);\n+                    $scope.realmMappings.push(selectedRole);\n+                }\n             }\n-        }\n-\n-        $scope.selectedRealmRoles = [];\n \n-        // Update/save the realm with new default roles.\n-        Realm.update($scope.realm, function () {\n-            Notifications.success(\"Realm default roles updated.\");\n+            $scope.selectedRealmRoles = [];\n+            $scope.selectedRealmRolesToAdd = [];\n+            Notifications.success(\"Default roles updated.\");\n         });\n     };\n \n     $scope.deleteRealmDefaultRole = function () {\n \n-        // Remove selected roles from the realm default roles and add them to available roles (move from right to left).\n-        for (var i = 0; i < $scope.selectedRealmDefRoles.length; i++) {\n-            $scope.availableRealmRoles.push($scope.selectedRealmDefRoles[i]);\n-\n-            var index = $scope.realm.defaultRoles.indexOf($scope.selectedRealmDefRoles[i]);\n-            if (index > -1) {\n-                $scope.realm.defaultRoles.splice(index, 1);\n+        $scope.selectedClientRolesToRemove = JSON.parse('[' + $scope.selectedRealmDefRoles + ']');\n+        $http.delete(authUrl + '/admin/realms/' + realm.realm + '/roles-by-id/' + realm.defaultRole.id + '/composites',", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU1MTI0MA=="}, "originalCommit": {"oid": "5314d629274ceb03556244c15f0dfefaeb6d71d6"}, "originalPosition": 100}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3200, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}