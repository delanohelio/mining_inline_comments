{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxMDkyMjU1", "number": 6846, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNjoxOTowOVrODk7FuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNjoyNDoxNlrODk7JMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMDQzNDQ5OnYy", "diffSide": "RIGHT", "path": "services/src/main/java/org/keycloak/broker/oidc/OIDCIdentityProviderConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNjoxOTowOVrOFxhKNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNjoxOTowOVrOFxhKNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ2NzgyOQ==", "bodyText": "Why are these being added? Looks like they are not used.", "url": "https://github.com/keycloak/keycloak/pull/6846#discussion_r387467829", "createdAt": "2020-03-04T06:19:09Z", "author": {"login": "stianst"}, "path": "services/src/main/java/org/keycloak/broker/oidc/OIDCIdentityProviderConfig.java", "diffHunk": "@@ -27,12 +30,18 @@\n \n     public static final String USE_JWKS_URL = \"useJwksUrl\";\n     public static final String VALIDATE_SIGNATURE = \"validateSignature\";\n+    public static final String PUBLIC_KEY_SIGNATURE_VERIFIER = \"publicKeySignatureVerifier\";\n+    public static final String PUBLIC_KEY_SIGNATURE_VERIFIER_KEY_ID = \"publicKeySignatureVerifierKeyId\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "464f05f2eb3e6f5be40b57975af164a418d685e9"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMDQzODc4OnYy", "diffSide": "RIGHT", "path": "services/src/main/java/org/keycloak/services/Urls.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNjoyMToyN1rOFxhMtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMTo0MjowMlrOFxqB7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ2ODQ3MA==", "bodyText": "I don't think this is the correct place to add validation for Urls. How about adding it to org.keycloak.validation.UrlValidation instead?", "url": "https://github.com/keycloak/keycloak/pull/6846#discussion_r387468470", "createdAt": "2020-03-04T06:21:27Z", "author": {"login": "stianst"}, "path": "services/src/main/java/org/keycloak/services/Urls.java", "diffHunk": "@@ -273,4 +277,33 @@ private static UriBuilder themeBase(URI baseUri) {\n     public static URI samlRequestEndpoint(final URI baseUri, final String realmName) {\n         return realmBase(baseUri).path(RealmsResource.class, \"getProtocol\").build(realmName, SamlProtocol.LOGIN_PROTOCOL);\n     }\n+\n+    public static void checkUrl(KeycloakSession session, String url, String name) throws IllegalArgumentException{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "464f05f2eb3e6f5be40b57975af164a418d685e9"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYxMzE2Ng==", "bodyText": "What if we move to org.keycloak.common.util.UriUtils instead of creating a new class?", "url": "https://github.com/keycloak/keycloak/pull/6846#discussion_r387613166", "createdAt": "2020-03-04T11:42:02Z", "author": {"login": "pedroigor"}, "path": "services/src/main/java/org/keycloak/services/Urls.java", "diffHunk": "@@ -273,4 +277,33 @@ private static UriBuilder themeBase(URI baseUri) {\n     public static URI samlRequestEndpoint(final URI baseUri, final String realmName) {\n         return realmBase(baseUri).path(RealmsResource.class, \"getProtocol\").build(realmName, SamlProtocol.LOGIN_PROTOCOL);\n     }\n+\n+    public static void checkUrl(KeycloakSession session, String url, String name) throws IllegalArgumentException{", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ2ODQ3MA=="}, "originalCommit": {"oid": "464f05f2eb3e6f5be40b57975af164a418d685e9"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMDQ0MDUzOnYy", "diffSide": "RIGHT", "path": "services/src/main/java/org/keycloak/services/Urls.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNjoyMjoyOVrOFxhNtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMjowNzozMFrOFxqucg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ2ODcyNw==", "bodyText": "Should this not be an exact match on http or https? Otherwise the accepted protocol could be \"httpasdfsadfsafdsadfasdfsafdsadfsafdsadf\".", "url": "https://github.com/keycloak/keycloak/pull/6846#discussion_r387468727", "createdAt": "2020-03-04T06:22:29Z", "author": {"login": "stianst"}, "path": "services/src/main/java/org/keycloak/services/Urls.java", "diffHunk": "@@ -273,4 +277,33 @@ private static UriBuilder themeBase(URI baseUri) {\n     public static URI samlRequestEndpoint(final URI baseUri, final String realmName) {\n         return realmBase(baseUri).path(RealmsResource.class, \"getProtocol\").build(realmName, SamlProtocol.LOGIN_PROTOCOL);\n     }\n+\n+    public static void checkUrl(KeycloakSession session, String url, String name) throws IllegalArgumentException{\n+        if (url == null) {\n+            return;\n+        }\n+\n+        URL parsed;\n+\n+        try {\n+            parsed = new URL(url);\n+        } catch (MalformedURLException e) {\n+            throw new IllegalArgumentException(\"The url [\" + name + \"] is malformed\", e);\n+        }\n+\n+        String protocol = parsed.getProtocol().toLowerCase();\n+\n+        if (!protocol.startsWith(\"http\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "464f05f2eb3e6f5be40b57975af164a418d685e9"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYxNTQyNw==", "bodyText": "How you would even accept requests for a protocol that is unknown by the server? It would be either http or https, right?", "url": "https://github.com/keycloak/keycloak/pull/6846#discussion_r387615427", "createdAt": "2020-03-04T11:47:11Z", "author": {"login": "pedroigor"}, "path": "services/src/main/java/org/keycloak/services/Urls.java", "diffHunk": "@@ -273,4 +277,33 @@ private static UriBuilder themeBase(URI baseUri) {\n     public static URI samlRequestEndpoint(final URI baseUri, final String realmName) {\n         return realmBase(baseUri).path(RealmsResource.class, \"getProtocol\").build(realmName, SamlProtocol.LOGIN_PROTOCOL);\n     }\n+\n+    public static void checkUrl(KeycloakSession session, String url, String name) throws IllegalArgumentException{\n+        if (url == null) {\n+            return;\n+        }\n+\n+        URL parsed;\n+\n+        try {\n+            parsed = new URL(url);\n+        } catch (MalformedURLException e) {\n+            throw new IllegalArgumentException(\"The url [\" + name + \"] is malformed\", e);\n+        }\n+\n+        String protocol = parsed.getProtocol().toLowerCase();\n+\n+        if (!protocol.startsWith(\"http\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ2ODcyNw=="}, "originalCommit": {"oid": "464f05f2eb3e6f5be40b57975af164a418d685e9"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzYyNDU2Mg==", "bodyText": "Forget about it. This is about validating input and not incoming connections.", "url": "https://github.com/keycloak/keycloak/pull/6846#discussion_r387624562", "createdAt": "2020-03-04T12:07:30Z", "author": {"login": "pedroigor"}, "path": "services/src/main/java/org/keycloak/services/Urls.java", "diffHunk": "@@ -273,4 +277,33 @@ private static UriBuilder themeBase(URI baseUri) {\n     public static URI samlRequestEndpoint(final URI baseUri, final String realmName) {\n         return realmBase(baseUri).path(RealmsResource.class, \"getProtocol\").build(realmName, SamlProtocol.LOGIN_PROTOCOL);\n     }\n+\n+    public static void checkUrl(KeycloakSession session, String url, String name) throws IllegalArgumentException{\n+        if (url == null) {\n+            return;\n+        }\n+\n+        URL parsed;\n+\n+        try {\n+            parsed = new URL(url);\n+        } catch (MalformedURLException e) {\n+            throw new IllegalArgumentException(\"The url [\" + name + \"] is malformed\", e);\n+        }\n+\n+        String protocol = parsed.getProtocol().toLowerCase();\n+\n+        if (!protocol.startsWith(\"http\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ2ODcyNw=="}, "originalCommit": {"oid": "464f05f2eb3e6f5be40b57975af164a418d685e9"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMDQ0MzM5OnYy", "diffSide": "RIGHT", "path": "services/src/main/java/org/keycloak/services/Urls.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNjoyNDoxNlrOFxhPfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNjoyNDoxNlrOFxhPfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ2OTE4Mg==", "bodyText": "This is not correct. You are checking here if SSL is required to the IP address of the admin that is adding the identity provider. It should be checking if SSL is required for the address of the identity provider.", "url": "https://github.com/keycloak/keycloak/pull/6846#discussion_r387469182", "createdAt": "2020-03-04T06:24:16Z", "author": {"login": "stianst"}, "path": "services/src/main/java/org/keycloak/services/Urls.java", "diffHunk": "@@ -273,4 +277,33 @@ private static UriBuilder themeBase(URI baseUri) {\n     public static URI samlRequestEndpoint(final URI baseUri, final String realmName) {\n         return realmBase(baseUri).path(RealmsResource.class, \"getProtocol\").build(realmName, SamlProtocol.LOGIN_PROTOCOL);\n     }\n+\n+    public static void checkUrl(KeycloakSession session, String url, String name) throws IllegalArgumentException{\n+        if (url == null) {\n+            return;\n+        }\n+\n+        URL parsed;\n+\n+        try {\n+            parsed = new URL(url);\n+        } catch (MalformedURLException e) {\n+            throw new IllegalArgumentException(\"The url [\" + name + \"] is malformed\", e);\n+        }\n+\n+        String protocol = parsed.getProtocol().toLowerCase();\n+\n+        if (!protocol.startsWith(\"http\")) {\n+            throw new IllegalArgumentException(\"Invalid protocol/scheme for url [\" + name + \"]\");\n+        }\n+\n+        ClientConnection connection = session.getContext().getConnection();\n+\n+        if (connection != null) {\n+            if (!\"https\".equals(protocol) && session.getContext().getRealm()\n+                    .getSslRequired().isRequired(connection)) {\n+                throw new IllegalArgumentException(\"The url [\" + name + \"] requires secure connections\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "464f05f2eb3e6f5be40b57975af164a418d685e9"}, "originalPosition": 50}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3801, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}