{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxMzkzNTk0", "number": 7153, "title": "[KEYCLOAK-11330] - Quarkus clustering tests", "bodyText": "Depends on #7143 (SSL Support). Included here for testing purposes.\nWith this changeset, we should be able to run cluster tests from org.keycloak.testsuite.cluster. More information about how to run cluster tests using Quarkus is in the HOW-TO-RUN.md guide.\nNot yet using the final Quarkus configuration. Just like the SSL changeset, I hope we can work on that next now that we have a good overview of what we need as well as the tests to make sure the configuration changes are OK.\nRight now, using an H2 database during tests until we decide the configuration and perform any change to test suite to make it possible to configure other databases to Quarkus (I've added a temporary note to the HOW-TO-RUN.md about this).", "createdAt": "2020-06-08T20:58:46Z", "url": "https://github.com/keycloak/keycloak/pull/7153", "merged": true, "mergeCommit": {"oid": "a8bad5b9bbaae0633d5e5a4ee36ac80f3cd6f0ee"}, "closed": true, "closedAt": "2020-06-16T13:07:25Z", "author": {"login": "pedroigor"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpjr2YgFqTQyNzA1ODQwNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcr0ut5gFqTQzMTQ2ODMxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MDU4NDA3", "url": "https://github.com/keycloak/keycloak/pull/7153#pullrequestreview-427058407", "createdAt": "2020-06-09T11:49:34Z", "commit": {"oid": "f0d777354f8019b5ab8f2c3755c784090c15ee92"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMTo0OTozNVrOGhFj0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMTo0OTozNVrOGhFj0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM0NzI4MQ==", "bodyText": "@mposolda or @hmlnarik can you comment if this is okay?", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r437347281", "createdAt": "2020-06-09T11:49:35Z", "author": {"login": "stianst"}, "path": "model/infinispan/src/main/java/org/keycloak/connections/infinispan/TopologyInfo.java", "diffHunk": "@@ -63,7 +63,7 @@ public TopologyInfo(EmbeddedCacheManager cacheManager, Config.Scope config, bool\n         if (!embedded) {\n             Transport transport = cacheManager.getTransport();\n             if (transport != null) {\n-                nodeName = transport.getAddress().toString();\n+                nodeName = cacheManager.getCacheManagerConfiguration().transport().nodeName();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0d777354f8019b5ab8f2c3755c784090c15ee92"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f0d777354f8019b5ab8f2c3755c784090c15ee92", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/f0d777354f8019b5ab8f2c3755c784090c15ee92", "committedDate": "2020-06-08T20:57:22Z", "message": "[KEYCLOAK-11330] - Quarkus clustering tests"}, "afterCommit": {"oid": "2d45917d090e3bc83c6bff92080e4df251c512d9", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/2d45917d090e3bc83c6bff92080e4df251c512d9", "committedDate": "2020-06-09T12:30:07Z", "message": "[KEYCLOAK-11330] - Quarkus clustering tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1715832fe5392a9bca89990dada34e3f20c54a70", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/1715832fe5392a9bca89990dada34e3f20c54a70", "committedDate": "2020-06-09T13:24:05Z", "message": "[KEYCLOAK-11330] - Database docker wait using port"}, "afterCommit": {"oid": "44856ccb99175e2e6b9fecabd5742614b59324fa", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/44856ccb99175e2e6b9fecabd5742614b59324fa", "committedDate": "2020-06-09T16:29:44Z", "message": "[KEYCLOAK-11330] - Database docker wait using port"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "44856ccb99175e2e6b9fecabd5742614b59324fa", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/44856ccb99175e2e6b9fecabd5742614b59324fa", "committedDate": "2020-06-09T16:29:44Z", "message": "[KEYCLOAK-11330] - Database docker wait using port"}, "afterCommit": {"oid": "8a2703b3b5912c1f1528003071ffa11b2d612ff5", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/8a2703b3b5912c1f1528003071ffa11b2d612ff5", "committedDate": "2020-06-09T16:29:44Z", "message": "[KEYCLOAK-11330] - Quarkus clustering tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NzQ0Mzk3", "url": "https://github.com/keycloak/keycloak/pull/7153#pullrequestreview-427744397", "createdAt": "2020-06-10T06:28:23Z", "commit": {"oid": "8a2703b3b5912c1f1528003071ffa11b2d612ff5"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwNjoyODoyNFrOGhmhbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwNjoyOTo1OFrOGhmj4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4NzM0Mg==", "bodyText": "Shouldn't we rather ignore this test for now and fix the problem properly instead of adding a work around to the test?", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r437887342", "createdAt": "2020-06-10T06:28:24Z", "author": {"login": "stianst"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/cluster/AuthenticationSessionFailoverClusterTest.java", "diffHunk": "@@ -83,8 +84,17 @@ public void setup() {\n                 .build();\n \n         userId = ApiUtil.createUserAndResetPasswordWithAdminClient(adminClient.realm(\"test\"), user, \"password\");\n-        getCleanup().addUserId(userId);\n+        \n+        //TODO: weird behavior when doing Quarkus where only one of the required actions above are persisted, so we workaround by forcing an update to the user with the 2 actions we want\n+        UserResource userResource = adminClient.realm(testRealm.getRealm()).users().get(userId);\n+        UserRepresentation userRepresentation = userResource.toRepresentation();\n+        \n+        if (userRepresentation.getRequiredActions().size() < 2) {\n+            userRepresentation.setRequiredActions(user.getRequiredActions());\n+            userResource.update(userRepresentation);\n+        }\n \n+        getCleanup().addUserId(userId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a2703b3b5912c1f1528003071ffa11b2d612ff5"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4NzY0OQ==", "bodyText": "Not convinced about this change. Doesn't it suggest perhaps different behaviour on Quarkus?", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r437887649", "createdAt": "2020-06-10T06:29:07Z", "author": {"login": "stianst"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/cluster/ClientInvalidationClusterTest.java", "diffHunk": "@@ -58,24 +59,38 @@ protected ClientRepresentation createEntity(ClientRepresentation client, Contain\n \n     @Override\n     protected ClientRepresentation readEntity(ClientRepresentation client, ContainerInfo node) {\n-        ClientRepresentation u = null;\n-        try {\n-            u = entityResource(client, node).toRepresentation();\n-        } catch (NotFoundException nfe) {\n-            // expected when client doesn't exist\n-        }\n+        ClientRepresentation u = Retry.call(new Retry.Supplier<ClientRepresentation>() {\n+            @Override\n+            public ClientRepresentation get(int iteration) {\n+                try {\n+                    return entityResource(client, node).toRepresentation();\n+                } catch (NotFoundException nfe) {\n+                    return null;\n+                }\n+            }\n+        }, 3, 5000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a2703b3b5912c1f1528003071ffa11b2d612ff5"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4Nzc2Ng==", "bodyText": "Same as above - this seems to indicate some strange behaviour on Quarkus", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r437887766", "createdAt": "2020-06-10T06:29:30Z", "author": {"login": "stianst"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/cluster/GroupInvalidationClusterTest.java", "diffHunk": "@@ -66,24 +67,38 @@ protected GroupRepresentation createEntity(GroupRepresentation group, ContainerI\n \n     @Override\n     protected GroupRepresentation readEntity(GroupRepresentation group, ContainerInfo node) {\n-        GroupRepresentation u = null;\n-        try {\n-            u = entityResource(group, node).toRepresentation();\n-        } catch (NotFoundException nfe) {\n-            // expected when group doesn't exist\n-        }\n+        GroupRepresentation u = Retry.call(new Retry.Supplier<GroupRepresentation>() {\n+            @Override\n+            public GroupRepresentation get(int iteration) {\n+                try {\n+                    return entityResource(group, node).toRepresentation();\n+                } catch (NotFoundException nfe) {\n+                    return null;\n+                }\n+            }\n+        }, 3, 5000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a2703b3b5912c1f1528003071ffa11b2d612ff5"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4Nzk3MA==", "bodyText": "Could it be as simple as async vs sync replication in Infinispan?", "url": "https://github.com/keycloak/keycloak/pull/7153#discussion_r437887970", "createdAt": "2020-06-10T06:29:58Z", "author": {"login": "stianst"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/cluster/ClientInvalidationClusterTest.java", "diffHunk": "@@ -58,24 +59,38 @@ protected ClientRepresentation createEntity(ClientRepresentation client, Contain\n \n     @Override\n     protected ClientRepresentation readEntity(ClientRepresentation client, ContainerInfo node) {\n-        ClientRepresentation u = null;\n-        try {\n-            u = entityResource(client, node).toRepresentation();\n-        } catch (NotFoundException nfe) {\n-            // expected when client doesn't exist\n-        }\n+        ClientRepresentation u = Retry.call(new Retry.Supplier<ClientRepresentation>() {\n+            @Override\n+            public ClientRepresentation get(int iteration) {\n+                try {\n+                    return entityResource(client, node).toRepresentation();\n+                } catch (NotFoundException nfe) {\n+                    return null;\n+                }\n+            }\n+        }, 3, 5000);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg4NzY0OQ=="}, "originalCommit": {"oid": "8a2703b3b5912c1f1528003071ffa11b2d612ff5"}, "originalPosition": 27}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8a2703b3b5912c1f1528003071ffa11b2d612ff5", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/8a2703b3b5912c1f1528003071ffa11b2d612ff5", "committedDate": "2020-06-09T16:29:44Z", "message": "[KEYCLOAK-11330] - Quarkus clustering tests"}, "afterCommit": {"oid": "ac1abcbf7bb8b74baed7e4ab8d3b8e5eb64605cb", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/ac1abcbf7bb8b74baed7e4ab8d3b8e5eb64605cb", "committedDate": "2020-06-10T13:06:56Z", "message": "[KEYCLOAK-11330] - Quarkus clustering tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ac1abcbf7bb8b74baed7e4ab8d3b8e5eb64605cb", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/ac1abcbf7bb8b74baed7e4ab8d3b8e5eb64605cb", "committedDate": "2020-06-10T13:06:56Z", "message": "[KEYCLOAK-11330] - Quarkus clustering tests"}, "afterCommit": {"oid": "6c4d4a5b9cb5f6eafe527111332a893661828343", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/6c4d4a5b9cb5f6eafe527111332a893661828343", "committedDate": "2020-06-10T18:57:08Z", "message": "[KEYCLOAK-11330] - Quarkus clustering tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16f171fe1f8e88c93cc745c33991c61cd2399386", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/16f171fe1f8e88c93cc745c33991c61cd2399386", "committedDate": "2020-06-10T18:58:53Z", "message": "[KEYCLOAK-11330] - Quarkus clustering tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c4d4a5b9cb5f6eafe527111332a893661828343", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/6c4d4a5b9cb5f6eafe527111332a893661828343", "committedDate": "2020-06-10T18:57:08Z", "message": "[KEYCLOAK-11330] - Quarkus clustering tests"}, "afterCommit": {"oid": "16f171fe1f8e88c93cc745c33991c61cd2399386", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/16f171fe1f8e88c93cc745c33991c61cd2399386", "committedDate": "2020-06-10T18:58:53Z", "message": "[KEYCLOAK-11330] - Quarkus clustering tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNDY4MzEy", "url": "https://github.com/keycloak/keycloak/pull/7153#pullrequestreview-431468312", "createdAt": "2020-06-16T12:50:55Z", "commit": {"oid": "16f171fe1f8e88c93cc745c33991c61cd2399386"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2951, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}