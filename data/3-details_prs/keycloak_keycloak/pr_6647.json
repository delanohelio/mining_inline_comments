{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwODQ1MDMx", "number": 6647, "title": "KEYCLOAK-6817 Ignore SniSSLSocketFactory exception for IBM jdk", "bodyText": "", "createdAt": "2020-01-09T09:01:06Z", "url": "https://github.com/keycloak/keycloak/pull/6647", "merged": true, "mergeCommit": {"oid": "fc7b769b6e9dd3b858dab861c52d410543d9699a"}, "closed": true, "closedAt": "2020-01-31T08:08:45Z", "author": {"login": "mhajas"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4myR8AFqTM0MDM5NjY0MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_qlC3AFqTM1MTM0MzQ3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMzk2NjQw", "url": "https://github.com/keycloak/keycloak/pull/6647#pullrequestreview-340396640", "createdAt": "2020-01-09T09:46:00Z", "commit": {"oid": "2806f95124f77a7bf259d147472247c9a21dce08"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4940195aabc46749ea48f360f7c5af54d6312369", "author": {"user": {"login": "mhajas", "name": "Michal Hajas"}}, "url": "https://github.com/keycloak/keycloak/commit/4940195aabc46749ea48f360f7c5af54d6312369", "committedDate": "2020-01-13T09:34:00Z", "message": "KEYCLOAK-6817 Other approach"}, "afterCommit": {"oid": "d50a8ddece821c1840bda24dc12b33bfc8761492", "author": {"user": {"login": "mhajas", "name": "Michal Hajas"}}, "url": "https://github.com/keycloak/keycloak/commit/d50a8ddece821c1840bda24dc12b33bfc8761492", "committedDate": "2020-01-13T10:56:59Z", "message": "KEYCLOAK-6817 Ignore SniSSLSocketFactory exception for IBM jdk"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d50a8ddece821c1840bda24dc12b33bfc8761492", "author": {"user": {"login": "mhajas", "name": "Michal Hajas"}}, "url": "https://github.com/keycloak/keycloak/commit/d50a8ddece821c1840bda24dc12b33bfc8761492", "committedDate": "2020-01-13T10:56:59Z", "message": "KEYCLOAK-6817 Ignore SniSSLSocketFactory exception for IBM jdk"}, "afterCommit": {"oid": "edcbd407f146e0ce04284dc4762413798cf496ee", "author": {"user": {"login": "mhajas", "name": "Michal Hajas"}}, "url": "https://github.com/keycloak/keycloak/commit/edcbd407f146e0ce04284dc4762413798cf496ee", "committedDate": "2020-01-13T11:01:24Z", "message": "KEYCLOAK-6817 Ignore SniSSLSocketFactory exception for IBM jdk"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNzg0NTE5", "url": "https://github.com/keycloak/keycloak/pull/6647#pullrequestreview-342784519", "createdAt": "2020-01-14T19:31:11Z", "commit": {"oid": "edcbd407f146e0ce04284dc4762413798cf496ee"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTozMToxMVrOFdjRwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTozNDoxNlrOFdjXdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMTAwOQ==", "bodyText": "Should be final\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static AtomicBoolean skipSNIApplication = new AtomicBoolean(false);\n          \n          \n            \n                private static final AtomicBoolean skipSNIApplicationToSslSocket = new AtomicBoolean(false);", "url": "https://github.com/keycloak/keycloak/pull/6647#discussion_r366531009", "createdAt": "2020-01-14T19:31:11Z", "author": {"login": "hmlnarik"}, "path": "adapters/oidc/adapter-core/src/main/java/org/keycloak/adapters/SniSSLSocketFactory.java", "diffHunk": "@@ -46,7 +50,8 @@\n  */\n public class SniSSLSocketFactory extends SSLSocketFactory {\n \n-    private static Logger log = Logger.getLogger(SniSSLSocketFactory.class.getName());\n+    private static final Logger LOG = Logger.getLogger(SniSSLSocketFactory.class.getName());\n+    private static AtomicBoolean skipSNIApplication = new AtomicBoolean(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edcbd407f146e0ce04284dc4762413798cf496ee"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMTI2Ng==", "bodyText": "This is not necessarily only IBM JDK, please improve the message.", "url": "https://github.com/keycloak/keycloak/pull/6647#discussion_r366531266", "createdAt": "2020-01-14T19:31:43Z", "author": {"login": "hmlnarik"}, "path": "adapters/oidc/adapter-core/src/main/java/org/keycloak/adapters/SniSSLSocketFactory.java", "diffHunk": "@@ -115,18 +120,34 @@ public Socket createLayeredSocket(Socket socket, String target, int port, HttpCo\n     }\n \n     private Socket applySNI(final Socket socket, String hostname) {\n+        if (skipSNIApplication.get()) {\n+            LOG.log(Level.FINE, \"Skipping application of SNI because IBM JDK is missing setHost() method.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edcbd407f146e0ce04284dc4762413798cf496ee"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMTUzMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if (e.getCause() instanceof NoSuchMethodException && Environment.IS_IBM_JAVA) {\n          \n          \n            \n                            if (e.getCause() instanceof NoSuchMethodException) {", "url": "https://github.com/keycloak/keycloak/pull/6647#discussion_r366531530", "createdAt": "2020-01-14T19:32:14Z", "author": {"login": "hmlnarik"}, "path": "adapters/oidc/adapter-core/src/main/java/org/keycloak/adapters/SniSSLSocketFactory.java", "diffHunk": "@@ -115,18 +120,34 @@ public Socket createLayeredSocket(Socket socket, String target, int port, HttpCo\n     }\n \n     private Socket applySNI(final Socket socket, String hostname) {\n+        if (skipSNIApplication.get()) {\n+            LOG.log(Level.FINE, \"Skipping application of SNI because IBM JDK is missing setHost() method.\");\n+            return socket;\n+        }\n+\n         if (socket instanceof SSLSocket) {\n             try {\n                 Method setHostMethod = AccessController.doPrivileged(new PrivilegedExceptionAction<Method>() {\n+                    @Override\n                     public Method run() throws NoSuchMethodException {\n                         return socket.getClass().getMethod(\"setHost\", String.class);\n                     }\n                 });\n \n                 setHostMethod.invoke(socket, hostname);\n-                log.finest(\"Applied SNI to socket for: \" + hostname);\n-            } catch (Exception e) {\n-                log.log(Level.WARNING, \"Failed to apply SNI to SSLSocket\", e);\n+                LOG.log(Level.FINEST, \"Applied SNI to socket for host {0}\", hostname);\n+            } catch (PrivilegedActionException e) {\n+                if (e.getCause() instanceof NoSuchMethodException && Environment.IS_IBM_JAVA) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edcbd407f146e0ce04284dc4762413798cf496ee"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMjQ2OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            LOG.log(Level.FINEST, \"Applied SNI to socket for host {0}\", hostname);\n          \n          \n            \n                            LOG.log(Level.FINE, \"Applied SNI to socket for host {0}\", hostname);", "url": "https://github.com/keycloak/keycloak/pull/6647#discussion_r366532468", "createdAt": "2020-01-14T19:34:16Z", "author": {"login": "hmlnarik"}, "path": "adapters/oidc/adapter-core/src/main/java/org/keycloak/adapters/SniSSLSocketFactory.java", "diffHunk": "@@ -115,18 +120,34 @@ public Socket createLayeredSocket(Socket socket, String target, int port, HttpCo\n     }\n \n     private Socket applySNI(final Socket socket, String hostname) {\n+        if (skipSNIApplication.get()) {\n+            LOG.log(Level.FINE, \"Skipping application of SNI because IBM JDK is missing setHost() method.\");\n+            return socket;\n+        }\n+\n         if (socket instanceof SSLSocket) {\n             try {\n                 Method setHostMethod = AccessController.doPrivileged(new PrivilegedExceptionAction<Method>() {\n+                    @Override\n                     public Method run() throws NoSuchMethodException {\n                         return socket.getClass().getMethod(\"setHost\", String.class);\n                     }\n                 });\n \n                 setHostMethod.invoke(socket, hostname);\n-                log.finest(\"Applied SNI to socket for: \" + hostname);\n-            } catch (Exception e) {\n-                log.log(Level.WARNING, \"Failed to apply SNI to SSLSocket\", e);\n+                LOG.log(Level.FINEST, \"Applied SNI to socket for host {0}\", hostname);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edcbd407f146e0ce04284dc4762413798cf496ee"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecf35d9d6d7feb07a15740bdb03a640938c54278", "author": {"user": {"login": "mhajas", "name": "Michal Hajas"}}, "url": "https://github.com/keycloak/keycloak/commit/ecf35d9d6d7feb07a15740bdb03a640938c54278", "committedDate": "2020-01-30T10:53:13Z", "message": "KEYCLOAK-6817 Ignore SniSSLSocketFactory exception for IBM jdk"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "edcbd407f146e0ce04284dc4762413798cf496ee", "author": {"user": {"login": "mhajas", "name": "Michal Hajas"}}, "url": "https://github.com/keycloak/keycloak/commit/edcbd407f146e0ce04284dc4762413798cf496ee", "committedDate": "2020-01-13T11:01:24Z", "message": "KEYCLOAK-6817 Ignore SniSSLSocketFactory exception for IBM jdk"}, "afterCommit": {"oid": "ecf35d9d6d7feb07a15740bdb03a640938c54278", "author": {"user": {"login": "mhajas", "name": "Michal Hajas"}}, "url": "https://github.com/keycloak/keycloak/commit/ecf35d9d6d7feb07a15740bdb03a640938c54278", "committedDate": "2020-01-30T10:53:13Z", "message": "KEYCLOAK-6817 Ignore SniSSLSocketFactory exception for IBM jdk"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNzU4OTY3", "url": "https://github.com/keycloak/keycloak/pull/6647#pullrequestreview-350758967", "createdAt": "2020-01-30T11:37:31Z", "commit": {"oid": "ecf35d9d6d7feb07a15740bdb03a640938c54278"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMzQzNDcz", "url": "https://github.com/keycloak/keycloak/pull/6647#pullrequestreview-351343473", "createdAt": "2020-01-31T08:08:38Z", "commit": {"oid": "ecf35d9d6d7feb07a15740bdb03a640938c54278"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2695, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}