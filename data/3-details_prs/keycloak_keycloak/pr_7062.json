{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2NzY5MzIz", "number": 7062, "title": "[KEYCLOAK-11784] - Hibermate ORM Extension and Improvements to JPA and LiquiBase", "bodyText": "This pull request brings two main things:\n\nQuarkus ORM Extension to Quarkus Distribution\nImprovements for both JPA and Liquibase layers for better startup and footprint\n\nThe improvements should be noticed even for Keycloak on top of Wildfly.\nFor Liquibase, I'm basically:\n\nAvoid running changelogs (validate and update) when the database is already initialized\nMaking Liquibase's ServiceLocator smarter in regards to the database and parsers for changelogs\nDisabling XML validation when parsing database changelogs (I should provide a test for running validation on changelogs)\nWhen initializing the database, avoid redundant calls for obtaining the \"unrun\" changesets\n\nFor JPA:\n\nAllowing an EntityManagerFactory to be provided so that we can use the optimized EMF from Quarkus\nCheck whether or not the database is initialized (by checking the migration model table) so that Liquibase runs accordingly\nRun migration when bootstrapping the JPA provider and not from KeycloakApplication", "createdAt": "2020-05-12T14:38:18Z", "url": "https://github.com/keycloak/keycloak/pull/7062", "merged": true, "mergeCommit": {"oid": "bae802bcfa1e8aca2ae0ebb4f601ab4b6c417b9c"}, "closed": true, "closedAt": "2020-05-14T09:10:47Z", "author": {"login": "pedroigor"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcglWtWgBqjMzMjc4NDI5MDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchJdeBgFqTQxMTU4Nzc0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "54a91353e90b62ba34ab66c3341b0485419f64aa", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/54a91353e90b62ba34ab66c3341b0485419f64aa", "committedDate": "2020-05-12T14:37:55Z", "message": "[KEYCLOAK-11784] - Improvements to JPA and LiquiBase"}, "afterCommit": {"oid": "455659937a23c5fdc5b8091d3e5c0da080791fde", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/455659937a23c5fdc5b8091d3e5c0da080791fde", "committedDate": "2020-05-12T14:42:46Z", "message": "[KEYCLOAK-11784] - Improvements to JPA and LiquiBase"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "455659937a23c5fdc5b8091d3e5c0da080791fde", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/455659937a23c5fdc5b8091d3e5c0da080791fde", "committedDate": "2020-05-12T14:42:46Z", "message": "[KEYCLOAK-11784] - Improvements to JPA and LiquiBase"}, "afterCommit": {"oid": "8cd3422802c43be355720ab33a3a4c3617605549", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/8cd3422802c43be355720ab33a3a4c3617605549", "committedDate": "2020-05-12T14:56:15Z", "message": "[KEYCLOAK-11784] - Improvements to JPA and LiquiBase"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8cd3422802c43be355720ab33a3a4c3617605549", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/8cd3422802c43be355720ab33a3a4c3617605549", "committedDate": "2020-05-12T14:56:15Z", "message": "[KEYCLOAK-11784] - Improvements to JPA and LiquiBase"}, "afterCommit": {"oid": "bf516e8e14e1a869ebfad60dd9c038c03b97911c", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/bf516e8e14e1a869ebfad60dd9c038c03b97911c", "committedDate": "2020-05-12T15:22:23Z", "message": "[KEYCLOAK-11784] - Improvements to JPA and LiquiBase"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf516e8e14e1a869ebfad60dd9c038c03b97911c", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/bf516e8e14e1a869ebfad60dd9c038c03b97911c", "committedDate": "2020-05-12T15:22:23Z", "message": "[KEYCLOAK-11784] - Improvements to JPA and LiquiBase"}, "afterCommit": {"oid": "2078b46a7dafe3a503e6b1f86949ede31cddff93", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/2078b46a7dafe3a503e6b1f86949ede31cddff93", "committedDate": "2020-05-12T16:28:32Z", "message": "[KEYCLOAK-11784] - Improvements to JPA and LiquiBase"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNzczOTkx", "url": "https://github.com/keycloak/keycloak/pull/7062#pullrequestreview-410773991", "createdAt": "2020-05-13T10:01:02Z", "commit": {"oid": "2078b46a7dafe3a503e6b1f86949ede31cddff93"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMDowMTowMlrOGUqdrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMDowNzowM1rOGUqq3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMDQzMA==", "bodyText": "Introducing yet another \"connection provider\" is not the correct approach here. Looking at this PR a lot of changes/refactoring are done to the WF distribution, while if this wasn't introduced and the \"copy\" of DefaultJpaConnectionProviderFactory kept the WF distribution would have been more or less untouched by these changes and it would have been a lot easier and safer to review/merge this PR", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424320430", "createdAt": "2020-05-13T10:01:02Z", "author": {"login": "stianst"}, "path": "model/jpa/src/main/java/org/keycloak/connections/jpa/EntityManagerFactoryProvider.java", "diffHunk": "@@ -0,0 +1,8 @@\n+package org.keycloak.connections.jpa;\n+\n+import javax.persistence.EntityManagerFactory;\n+\n+public interface EntityManagerFactoryProvider {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2078b46a7dafe3a503e6b1f86949ede31cddff93"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMDY2NQ==", "bodyText": "Why the need to introduce verifyAndRunMasterChangelog? What does it do?", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424320665", "createdAt": "2020-05-13T10:01:25Z", "author": {"login": "stianst"}, "path": "model/jpa/src/main/java/org/keycloak/connections/jpa/updater/JpaUpdaterProvider.java", "diffHunk": "@@ -49,23 +49,26 @@\n      * Updates the Keycloak database\n      * @param connection DB connection\n      * @param defaultSchema DB connection\n+     * @param verifyAndRunMasterChangelog if master changelog should be verified and run \n      */\n-    void update(Connection connection, String defaultSchema);\n+    void update(Connection connection, String defaultSchema, boolean verifyAndRunMasterChangelog);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2078b46a7dafe3a503e6b1f86949ede31cddff93"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMTU2Mw==", "bodyText": "?", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424321563", "createdAt": "2020-05-13T10:03:01Z", "author": {"login": "stianst"}, "path": "model/jpa/src/main/resources/META-INF/persistence.xml", "diffHunk": "@@ -85,8 +85,11 @@\n         \n         <exclude-unlisted-classes>true</exclude-unlisted-classes>\n \n+        <!-- These properties are overridden when Keycloak is managing the persistence unit by itself -->\n         <properties>\n             <property name=\"jboss.as.jpa.managed\" value=\"false\"/>\n+            <property name=\"hibernate.dialect\" value=\"org.hibernate.dialect.H2Dialect\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2078b46a7dafe3a503e6b1f86949ede31cddff93"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMTYzNw==", "bodyText": "?", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424321637", "createdAt": "2020-05-13T10:03:08Z", "author": {"login": "stianst"}, "path": "model/jpa/src/main/resources/META-INF/persistence.xml", "diffHunk": "@@ -85,8 +85,11 @@\n         \n         <exclude-unlisted-classes>true</exclude-unlisted-classes>\n \n+        <!-- These properties are overridden when Keycloak is managing the persistence unit by itself -->\n         <properties>\n             <property name=\"jboss.as.jpa.managed\" value=\"false\"/>\n+            <property name=\"hibernate.dialect\" value=\"org.hibernate.dialect.H2Dialect\"/>\n+            <property name=\"hibernate.query.startup_check\" value=\"false\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2078b46a7dafe3a503e6b1f86949ede31cddff93"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMjA3MA==", "bodyText": "This is used by the config test that Dmitry added, not sure why it doesn't fail without it. Kinda not related to this PR though?", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424322070", "createdAt": "2020-05-13T10:03:57Z", "author": {"login": "stianst"}, "path": "quarkus/extensions/pom.xml", "diffHunk": "@@ -89,15 +112,6 @@\n                     </execution>\n                 </executions>\n             </plugin>\n-            <plugin>\n-                <groupId>org.apache.maven.plugins</groupId>\n-                <artifactId>maven-surefire-plugin</artifactId>\n-                <configuration>\n-                    <environmentVariables>\n-                        <KEYCLOAK_CAMEL_CASE_SCOPE_CAMEL_CASE_PROP>foobar</KEYCLOAK_CAMEL_CASE_SCOPE_CAMEL_CASE_PROP>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2078b46a7dafe3a503e6b1f86949ede31cddff93"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMjI3Mw==", "bodyText": "I noticed beans.xml earlier, I think we should use a consistent approach shouldn't we? Either use beans.xml or use jandex plugin?", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424322273", "createdAt": "2020-05-13T10:04:21Z", "author": {"login": "stianst"}, "path": "quarkus/extensions/pom.xml", "diffHunk": "@@ -79,7 +103,6 @@\n             <plugin>\n                 <groupId>org.jboss.jandex</groupId>\n                 <artifactId>jandex-maven-plugin</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2078b46a7dafe3a503e6b1f86949ede31cddff93"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMjU2NQ==", "bodyText": "Does this have anything to do with JPA or Liquibase?", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424322565", "createdAt": "2020-05-13T10:04:51Z", "author": {"login": "stianst"}, "path": "quarkus/extensions/src/main/java/org/keycloak/provider/quarkus/QuarkusCacheManagerProvider.java", "diffHunk": "@@ -44,12 +44,13 @@\n         try {\n             InputStream configurationStream = loadConfiguration(config);\n             ConfigurationBuilderHolder builder = new ParserRegistry().parse(configurationStream);\n+            boolean isClustered = builder.getNamedConfigurationBuilders().get(\"sessions\").clustering().cacheMode().isClustered();\n \n-            if (builder.getNamedConfigurationBuilders().get(\"sessions\").clustering().cacheMode().isClustered()) {\n+            if (isClustered) {\n                 configureTransportStack(config, builder);\n             }\n \n-            return (C) new DefaultCacheManager(builder, true);\n+            return (C) new DefaultCacheManager(builder, isClustered);\n         } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2078b46a7dafe3a503e6b1f86949ede31cddff93"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMzAyNg==", "bodyText": "I'm confused here. Don't we need at least a transaction manager dummy or something? Otherwise session.getTransactionManager won't work", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424323026", "createdAt": "2020-05-13T10:05:41Z", "author": {"login": "stianst"}, "path": "quarkus/extensions/src/main/java/org/keycloak/transaction/QuarkusJtaTransactionManagerLookup.java", "diffHunk": "@@ -32,16 +32,20 @@\n \n     @Override\n     public TransactionManager getTransactionManager() {\n-        return tm;\n+        if (tm == null) {\n+//            tm = CDI.current().select(TransactionManager.class).get();\n+//            logger.tracev(\"TransactionManager = {0}\", tm);\n+//            if (tm == null) {\n+//                logger.debug(\"could not locate transactionmanager\");\n+//            }\n+        }\n+        // we need to check whether or not the datasource supports XA as well as if configuration tells that\n+        return null;\n     }\n \n     @Override\n     public void init(Config.Scope config) {\n-        tm = CDI.current().select(TransactionManager.class).get();\n-        logger.tracev(\"TransactionManager = {0}\", tm);\n-        if (tm == null) {\n-            logger.debug(\"Could not locate TransactionManager\");\n-        }\n+        ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2078b46a7dafe3a503e6b1f86949ede31cddff93"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMzM0OQ==", "bodyText": "Don't think we should require folks to build their own Quarkus to use Keycloak should we?", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424323349", "createdAt": "2020-05-13T10:06:12Z", "author": {"login": "stianst"}, "path": "quarkus/pom.xml", "diffHunk": "@@ -31,10 +31,11 @@\n     <packaging>pom</packaging>\n \n     <properties>\n-        <quarkus.version>1.2.1.Final</quarkus.version>\n+        <quarkus.version>999-SNAPSHOT</quarkus.version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2078b46a7dafe3a503e6b1f86949ede31cddff93"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMzU3NA==", "bodyText": "??", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424323574", "createdAt": "2020-05-13T10:06:38Z", "author": {"login": "stianst"}, "path": "quarkus/server/src/main/java/org/keycloak/services/resources/NoopResource.java", "diffHunk": "@@ -0,0 +1,26 @@\n+package org.keycloak.services.resources;\n+\n+import javax.inject.Inject;\n+import javax.inject.Singleton;\n+import javax.persistence.EntityManagerFactory;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.core.Response;\n+import javax.ws.rs.core.UriBuilder;\n+\n+/**\n+ * Quarkus doesn't pick up the Application if there's no JAX-RS endpoints\n+ */\n+@Singleton\n+@Path(\"/noop\")\n+public class NoopResource {\n+\n+    @Inject\n+    EntityManagerFactory entityManagerFactory;\n+\n+    @GET\n+    public Response redirect() {\n+        return Response.seeOther(UriBuilder.fromResource(WelcomeResource.class).build()).build();\n+    }\n+\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2078b46a7dafe3a503e6b1f86949ede31cddff93"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMyMzgwNw==", "bodyText": "Why move this?", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424323807", "createdAt": "2020-05-13T10:07:03Z", "author": {"login": "stianst"}, "path": "services/src/main/java/org/keycloak/services/resources/KeycloakApplication.java", "diffHunk": "@@ -182,7 +182,6 @@ protected void shutdown() {\n     protected ExportImportManager migrateAndBootstrap() {\n         ExportImportManager exportImportManager;\n         logger.debug(\"Calling migrateModel\");\n-        migrateModel();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2078b46a7dafe3a503e6b1f86949ede31cddff93"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2078b46a7dafe3a503e6b1f86949ede31cddff93", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/2078b46a7dafe3a503e6b1f86949ede31cddff93", "committedDate": "2020-05-12T16:28:32Z", "message": "[KEYCLOAK-11784] - Improvements to JPA and LiquiBase"}, "afterCommit": {"oid": "bda4270b9d1f5f2d08e668a5b0b8d79e058e5d05", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/bda4270b9d1f5f2d08e668a5b0b8d79e058e5d05", "committedDate": "2020-05-13T19:56:09Z", "message": "[KEYCLOAK-11784] - Using Hibernate Extension"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bda4270b9d1f5f2d08e668a5b0b8d79e058e5d05", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/bda4270b9d1f5f2d08e668a5b0b8d79e058e5d05", "committedDate": "2020-05-13T19:56:09Z", "message": "[KEYCLOAK-11784] - Using Hibernate Extension"}, "afterCommit": {"oid": "9a88a259ca7e405e2e0f5a9566f16017a8ab22b9", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/9a88a259ca7e405e2e0f5a9566f16017a8ab22b9", "committedDate": "2020-05-13T20:13:41Z", "message": "[KEYCLOAK-11784] - Using Hibernate Extension"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fdef7a9291d993952af6d2c665422ff94a70e43", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/6fdef7a9291d993952af6d2c665422ff94a70e43", "committedDate": "2020-05-13T20:49:20Z", "message": "[KEYCLOAK-11784] - Using Hibernate Extension"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a88a259ca7e405e2e0f5a9566f16017a8ab22b9", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/9a88a259ca7e405e2e0f5a9566f16017a8ab22b9", "committedDate": "2020-05-13T20:13:41Z", "message": "[KEYCLOAK-11784] - Using Hibernate Extension"}, "afterCommit": {"oid": "6fdef7a9291d993952af6d2c665422ff94a70e43", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/6fdef7a9291d993952af6d2c665422ff94a70e43", "committedDate": "2020-05-13T20:49:20Z", "message": "[KEYCLOAK-11784] - Using Hibernate Extension"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNTg3NzQ4", "url": "https://github.com/keycloak/keycloak/pull/7062#pullrequestreview-411587748", "createdAt": "2020-05-14T08:42:04Z", "commit": {"oid": "6fdef7a9291d993952af6d2c665422ff94a70e43"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODo0MjowNFrOGVSA6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODo0MjowNFrOGVSA6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk2ODQyNw==", "bodyText": "??", "url": "https://github.com/keycloak/keycloak/pull/7062#discussion_r424968427", "createdAt": "2020-05-14T08:42:04Z", "author": {"login": "stianst"}, "path": "quarkus/server/src/main/java/org/keycloak/services/resources/Dummy.java", "diffHunk": "@@ -9,6 +11,9 @@\n @Path(\"/dummy\")\n public class Dummy {\n \n+    @Inject", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fdef7a9291d993952af6d2c665422ff94a70e43"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3042, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}