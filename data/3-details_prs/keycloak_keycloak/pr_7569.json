{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0NzAzMDM3", "number": 7569, "title": "Keycloak 9551 refresh token client cred", "bodyText": "", "createdAt": "2020-11-03T12:33:51Z", "url": "https://github.com/keycloak/keycloak/pull/7569", "merged": true, "mergeCommit": {"oid": "de208304123d6360969c97f08d025d95ec4afd3d"}, "closed": true, "closedAt": "2020-11-06T08:15:35Z", "author": {"login": "mposolda"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZJrMaABqjM5NTY0NDEyOTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZiyAWABqjM5NjI1MTQ2ODg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c71a11479c0c2af3fbe457d93c134fb7167eba13", "author": {"user": {"login": "mposolda", "name": "Marek Posolda"}}, "url": "https://github.com/keycloak/keycloak/commit/c71a11479c0c2af3fbe457d93c134fb7167eba13", "committedDate": "2020-11-03T21:14:00Z", "message": "More fixes"}, "afterCommit": {"oid": "5af485a11a3eeb66046f46b6cc065b07a71da256", "author": {"user": {"login": "mposolda", "name": "Marek Posolda"}}, "url": "https://github.com/keycloak/keycloak/commit/5af485a11a3eeb66046f46b6cc065b07a71da256", "committedDate": "2020-11-04T08:41:20Z", "message": "More fixes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5af485a11a3eeb66046f46b6cc065b07a71da256", "author": {"user": {"login": "mposolda", "name": "Marek Posolda"}}, "url": "https://github.com/keycloak/keycloak/commit/5af485a11a3eeb66046f46b6cc065b07a71da256", "committedDate": "2020-11-04T08:41:20Z", "message": "More fixes"}, "afterCommit": {"oid": "8bcba2142d634daf9ac3a662376fab993ddeb901", "author": {"user": {"login": "mposolda", "name": "Marek Posolda"}}, "url": "https://github.com/keycloak/keycloak/commit/8bcba2142d634daf9ac3a662376fab993ddeb901", "committedDate": "2020-11-04T14:50:37Z", "message": "More fixes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6458fa8908856bd56c08ebef94b1c9488d42a4c3", "author": {"user": {"login": "mposolda", "name": "Marek Posolda"}}, "url": "https://github.com/keycloak/keycloak/commit/6458fa8908856bd56c08ebef94b1c9488d42a4c3", "committedDate": "2020-11-05T09:47:17Z", "message": "Fix KcAdm"}, "afterCommit": {"oid": "f6461b305e968e03dba7b614b7c0f4fcf84e9fba", "author": {"user": {"login": "mposolda", "name": "Marek Posolda"}}, "url": "https://github.com/keycloak/keycloak/commit/f6461b305e968e03dba7b614b7c0f4fcf84e9fba", "committedDate": "2020-11-05T10:49:19Z", "message": "Fx KcReg"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0MTcyNjk2", "url": "https://github.com/keycloak/keycloak/pull/7569#pullrequestreview-524172696", "createdAt": "2020-11-05T11:34:41Z", "commit": {"oid": "f6461b305e968e03dba7b614b7c0f4fcf84e9fba"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxMTozNDo0MVrOHt_PLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxMTozNDo0MVrOHt_PLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk4NDA0Ng==", "bodyText": "Nice one the removal of duplicates for this piece.", "url": "https://github.com/keycloak/keycloak/pull/7569#discussion_r517984046", "createdAt": "2020-11-05T11:34:41Z", "author": {"login": "pedroigor"}, "path": "model/infinispan/src/main/java/org/keycloak/models/sessions/infinispan/InfinispanSingleUseTokenStoreProviderFactory.java", "diffHunk": "@@ -52,28 +52,32 @@ private void lazyInit(KeycloakSession session) {\n         if (tokenCache == null) {\n             synchronized (this) {\n                 if (tokenCache == null) {\n-                    InfinispanConnectionProvider connections = session.getProvider(InfinispanConnectionProvider.class);\n-                    Cache cache = connections.getCache(InfinispanConnectionProvider.ACTION_TOKEN_CACHE);\n-\n-                    RemoteCache remoteCache = InfinispanUtil.getRemoteCache(cache);\n-\n-                    if (remoteCache != null) {\n-                        LOG.debugf(\"Having remote stores. Using remote cache '%s' for single-use cache of token\", remoteCache.getName());\n-                        this.tokenCache = () -> {\n-                            // Doing this way as flag is per invocation\n-                            return remoteCache.withFlags(Flag.FORCE_RETURN_VALUE);\n-                        };\n-                    } else {\n-                        LOG.debugf(\"Not having remote stores. Using normal cache '%s' for single-use cache of token\", cache.getName());\n-                        this.tokenCache = () -> {\n-                            return cache;\n-                        };\n-                    }\n+                    this.tokenCache = getActionTokenCache(session);\n                 }\n             }\n         }\n     }\n \n+    static Supplier getActionTokenCache(KeycloakSession session) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6461b305e968e03dba7b614b7c0f4fcf84e9fba"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0MTg4NzUy", "url": "https://github.com/keycloak/keycloak/pull/7569#pullrequestreview-524188752", "createdAt": "2020-11-05T11:56:29Z", "commit": {"oid": "f6461b305e968e03dba7b614b7c0f4fcf84e9fba"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxMTo1NjoyOVrOHt_-zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxMTo1NjoyOVrOHt_-zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk5NjIzOA==", "bodyText": "Just to confirm my understanding.\nNow that token revocation supports access tokens, we have this check to revoke them although in case the token is stateful the session will still be alive. So clients would be forced to refresh the token.\nMakes sense ?", "url": "https://github.com/keycloak/keycloak/pull/7569#discussion_r517996238", "createdAt": "2020-11-05T11:56:29Z", "author": {"login": "pedroigor"}, "path": "services/src/main/java/org/keycloak/protocol/oidc/TokenManager.java", "diffHunk": "@@ -233,28 +235,43 @@ public boolean checkTokenValidForIntrospection(KeycloakSession session, RealmMod\n             return false;\n         }\n \n-        boolean valid = false;\n+        TokenRevocationStoreProvider revocationStore = session.getProvider(TokenRevocationStoreProvider.class);\n+        if (revocationStore.isRevoked(token.getId())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6461b305e968e03dba7b614b7c0f4fcf84e9fba"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0MTk4NzU4", "url": "https://github.com/keycloak/keycloak/pull/7569#pullrequestreview-524198758", "createdAt": "2020-11-05T12:10:07Z", "commit": {"oid": "f6461b305e968e03dba7b614b7c0f4fcf84e9fba"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ef25c5c5a02ed251945278eca64390510ffcb40", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/6ef25c5c5a02ed251945278eca64390510ffcb40", "committedDate": "2020-11-05T13:56:08Z", "message": "KEYCLOAK-9551 KEYCLOAK-16159 Make refresh_token generation for client_credentials optional. Support for revocation of access tokens.\n\nCo-authored-by: mposolda <mposolda@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f6461b305e968e03dba7b614b7c0f4fcf84e9fba", "author": {"user": {"login": "mposolda", "name": "Marek Posolda"}}, "url": "https://github.com/keycloak/keycloak/commit/f6461b305e968e03dba7b614b7c0f4fcf84e9fba", "committedDate": "2020-11-05T10:49:19Z", "message": "Fx KcReg"}, "afterCommit": {"oid": "6ef25c5c5a02ed251945278eca64390510ffcb40", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/6ef25c5c5a02ed251945278eca64390510ffcb40", "committedDate": "2020-11-05T13:56:08Z", "message": "KEYCLOAK-9551 KEYCLOAK-16159 Make refresh_token generation for client_credentials optional. Support for revocation of access tokens.\n\nCo-authored-by: mposolda <mposolda@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3404, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}