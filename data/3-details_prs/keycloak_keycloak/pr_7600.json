{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5NzQ1MjU2", "number": 7600, "title": "KEYCLOAK-13644. Added healthcheck endpoints tests.", "bodyText": "This PR includes positive tests for new healthcheck and metrics endpoints. I couldn't find a way to disable H2 database at runtime for negative cases.", "createdAt": "2020-11-12T09:26:28Z", "url": "https://github.com/keycloak/keycloak/pull/7600", "merged": true, "mergeCommit": {"oid": "b35cd9beee69e5795f988f294eccca7318ec431e"}, "closed": true, "closedAt": "2020-11-13T18:04:16Z", "author": {"login": "miquelsi"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbwt7cAFqTUyODk4ODA3NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdcLHbXgFqTUzMDI4OTY5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4OTg4MDc0", "url": "https://github.com/keycloak/keycloak/pull/7600#pullrequestreview-528988074", "createdAt": "2020-11-12T11:18:37Z", "commit": {"oid": "4d194d34b9aaf1ad3f83991847b80daca2efbd0e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMToxODozN1rOHx2M1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMToxODozN1rOHx2M1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjAzMDI5Mw==", "bodyText": "I believe one more test - simulate that a database is down and check if the Readiness Probe returns a failure.\nI believe the easiest way to do it is to modify the way we wire the Agroal bean. Maybe we should create an adapter there (e.g. DelegatingDatasource) and inject a mock during testing there.", "url": "https://github.com/keycloak/keycloak/pull/7600#discussion_r522030293", "createdAt": "2020-11-12T11:18:37Z", "author": {"login": "slaskawi"}, "path": "quarkus/deployment/src/test/java/test/org/keycloak/quarkus/services/health/KeycloakReadyHealthCheckTest.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates\n+ * and other contributors as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package test.org.keycloak.quarkus.services.health;\n+\n+import io.quarkus.test.QuarkusUnitTest;\n+import org.hamcrest.Matchers;\n+import org.jboss.shrinkwrap.api.ShrinkWrap;\n+import org.jboss.shrinkwrap.api.spec.JavaArchive;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+\n+import java.sql.SQLException;\n+\n+import static io.restassured.RestAssured.given;\n+\n+public class KeycloakReadyHealthCheckTest {\n+\n+    @RegisterExtension\n+    static final QuarkusUnitTest test = new QuarkusUnitTest()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d194d34b9aaf1ad3f83991847b80daca2efbd0e"}, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4d194d34b9aaf1ad3f83991847b80daca2efbd0e", "author": {"user": {"login": "miquelsi", "name": "Miquel Simon"}}, "url": "https://github.com/keycloak/keycloak/commit/4d194d34b9aaf1ad3f83991847b80daca2efbd0e", "committedDate": "2020-11-12T09:12:54Z", "message": "KEYCLOAK-13644. Added healthcheck endpoints tests."}, "afterCommit": {"oid": "d5c8190317eba6d766ea663ceb3d833773125797", "author": {"user": {"login": "miquelsi", "name": "Miquel Simon"}}, "url": "https://github.com/keycloak/keycloak/commit/d5c8190317eba6d766ea663ceb3d833773125797", "committedDate": "2020-11-13T08:23:25Z", "message": "KEYCLOAK-13644. Added healthcheck endpoints tests."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d5c8190317eba6d766ea663ceb3d833773125797", "author": {"user": {"login": "miquelsi", "name": "Miquel Simon"}}, "url": "https://github.com/keycloak/keycloak/commit/d5c8190317eba6d766ea663ceb3d833773125797", "committedDate": "2020-11-13T08:23:25Z", "message": "KEYCLOAK-13644. Added healthcheck endpoints tests."}, "afterCommit": {"oid": "200ef1c92172c974450173ae4874b4ca50c0406f", "author": {"user": {"login": "miquelsi", "name": "Miquel Simon"}}, "url": "https://github.com/keycloak/keycloak/commit/200ef1c92172c974450173ae4874b4ca50c0406f", "committedDate": "2020-11-13T12:46:32Z", "message": "KEYCLOAK-13644. Added healthcheck endpoints tests."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "200ef1c92172c974450173ae4874b4ca50c0406f", "author": {"user": {"login": "miquelsi", "name": "Miquel Simon"}}, "url": "https://github.com/keycloak/keycloak/commit/200ef1c92172c974450173ae4874b4ca50c0406f", "committedDate": "2020-11-13T12:46:32Z", "message": "KEYCLOAK-13644. Added healthcheck endpoints tests."}, "afterCommit": {"oid": "debe874c98db0aa14cb3d7e535bb9c070466933b", "author": {"user": {"login": "miquelsi", "name": "Miquel Simon"}}, "url": "https://github.com/keycloak/keycloak/commit/debe874c98db0aa14cb3d7e535bb9c070466933b", "committedDate": "2020-11-13T12:47:49Z", "message": "KEYCLOAK-13644. Added healthcheck endpoints tests."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "debe874c98db0aa14cb3d7e535bb9c070466933b", "author": {"user": {"login": "miquelsi", "name": "Miquel Simon"}}, "url": "https://github.com/keycloak/keycloak/commit/debe874c98db0aa14cb3d7e535bb9c070466933b", "committedDate": "2020-11-13T12:47:49Z", "message": "KEYCLOAK-13644. Added healthcheck endpoints tests."}, "afterCommit": {"oid": "9fda04110016781a96a0479788e5f01f03c96593", "author": {"user": {"login": "miquelsi", "name": "Miquel Simon"}}, "url": "https://github.com/keycloak/keycloak/commit/9fda04110016781a96a0479788e5f01f03c96593", "committedDate": "2020-11-13T14:30:53Z", "message": "KEYCLOAK-13644. Added healthcheck endpoints tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f80119be1584bd4daac34ae0e7fcf11f85fdbfb", "author": {"user": {"login": "miquelsi", "name": "Miquel Simon"}}, "url": "https://github.com/keycloak/keycloak/commit/7f80119be1584bd4daac34ae0e7fcf11f85fdbfb", "committedDate": "2020-11-13T15:21:37Z", "message": "KEYCLOAK-13644. Added healthcheck endpoints tests."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9fda04110016781a96a0479788e5f01f03c96593", "author": {"user": {"login": "miquelsi", "name": "Miquel Simon"}}, "url": "https://github.com/keycloak/keycloak/commit/9fda04110016781a96a0479788e5f01f03c96593", "committedDate": "2020-11-13T14:30:53Z", "message": "KEYCLOAK-13644. Added healthcheck endpoints tests."}, "afterCommit": {"oid": "7f80119be1584bd4daac34ae0e7fcf11f85fdbfb", "author": {"user": {"login": "miquelsi", "name": "Miquel Simon"}}, "url": "https://github.com/keycloak/keycloak/commit/7f80119be1584bd4daac34ae0e7fcf11f85fdbfb", "committedDate": "2020-11-13T15:21:37Z", "message": "KEYCLOAK-13644. Added healthcheck endpoints tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMjg5Njk0", "url": "https://github.com/keycloak/keycloak/pull/7600#pullrequestreview-530289694", "createdAt": "2020-11-13T18:04:11Z", "commit": {"oid": "7f80119be1584bd4daac34ae0e7fcf11f85fdbfb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3247, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}