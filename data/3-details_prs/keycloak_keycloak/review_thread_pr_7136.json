{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3MDY0NzUx", "number": 7136, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwOTowNDoxN1rOEENTpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNDoyMDoxNVrOEMGYeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyODQ3NzgzOnYy", "diffSide": "RIGHT", "path": "wildfly/extensions/src/main/java/org/keycloak/provider/wildfly/KeycloakSessionServletFilter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwOTowNDoxN1rOGhr0GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwOTowNDoxN1rOGhr0GA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk3NDA0MA==", "bodyText": "The response is available in the AsyncEvent object and should not be part of the AsyncListener", "url": "https://github.com/keycloak/keycloak/pull/7136#discussion_r437974040", "createdAt": "2020-06-10T09:04:17Z", "author": {"login": "hmlnarik"}, "path": "wildfly/extensions/src/main/java/org/keycloak/provider/wildfly/KeycloakSessionServletFilter.java", "diffHunk": "@@ -91,28 +94,28 @@ public int getLocalPort() {\n             filterChain.doFilter(servletRequest, servletResponse);\n         } finally {\n             if (servletRequest.isAsyncStarted()) {\n-                servletRequest.getAsyncContext().addListener(createAsyncLifeCycleListener(session));\n+                servletRequest.getAsyncContext().addListener(createAsyncLifeCycleListener(session, response));\n             } else {\n-                closeSession(session);\n+                closeSession(session, response);\n             }\n         }\n     }\n \n-    private AsyncListener createAsyncLifeCycleListener(final KeycloakSession session) {\n+    private AsyncListener createAsyncLifeCycleListener(final KeycloakSession session, final HttpServletResponse response) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1f95738da3ac5fb23ac6430e625af2f443b5257"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyOTYwNzY2OnYy", "diffSide": "RIGHT", "path": "wildfly/extensions/src/main/java/org/keycloak/provider/wildfly/KeycloakSessionServletFilter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNDoxNjo1NlrOGh2_0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNDoxNjo1NlrOGh2_0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE1NzI2NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (transactionManager != null) {\n          \n          \n            \n                    if (transactionManager != null && transactionManager.isActive()) {", "url": "https://github.com/keycloak/keycloak/pull/7136#discussion_r438157265", "createdAt": "2020-06-10T14:16:56Z", "author": {"login": "hmlnarik"}, "path": "wildfly/extensions/src/main/java/org/keycloak/provider/wildfly/KeycloakSessionServletFilter.java", "diffHunk": "@@ -122,10 +124,17 @@ public void onStartAsync(AsyncEvent event) {\n     }\n \n     private void closeSession(KeycloakSession session) {\n-        // KeycloakTransactionCommitter is responsible for committing the transaction, but if an exception is thrown it's not invoked and transaction\n-        // should be rolled back\n-        if (session.getTransactionManager() != null && session.getTransactionManager().isActive()) {\n-            session.getTransactionManager().rollback();\n+        KeycloakTransactionManager transactionManager = session.getTransactionManager();\n+        if (transactionManager != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4c9f7972ec5c21eee66f5e6255e32389a72abd3"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyOTYwODg5OnYy", "diffSide": "RIGHT", "path": "wildfly/extensions/src/main/java/org/keycloak/provider/wildfly/KeycloakSessionServletFilter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNDoxNzoxNVrOGh3ArQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNDoxNzoxNVrOGh3ArQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE1NzQ4NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        } else if (transactionManager.isActive()){\n          \n          \n            \n                        } else {", "url": "https://github.com/keycloak/keycloak/pull/7136#discussion_r438157485", "createdAt": "2020-06-10T14:17:15Z", "author": {"login": "hmlnarik"}, "path": "wildfly/extensions/src/main/java/org/keycloak/provider/wildfly/KeycloakSessionServletFilter.java", "diffHunk": "@@ -122,10 +124,17 @@ public void onStartAsync(AsyncEvent event) {\n     }\n \n     private void closeSession(KeycloakSession session) {\n-        // KeycloakTransactionCommitter is responsible for committing the transaction, but if an exception is thrown it's not invoked and transaction\n-        // should be rolled back\n-        if (session.getTransactionManager() != null && session.getTransactionManager().isActive()) {\n-            session.getTransactionManager().rollback();\n+        KeycloakTransactionManager transactionManager = session.getTransactionManager();\n+        if (transactionManager != null) {\n+            // transaction was postponed in KeycloakTransactionCommitter, commit it here\n+            if ((transactionManager instanceof SupportsPostponedCommit) &&\n+                    ((SupportsPostponedCommit) transactionManager).isPostponedCommit()) {\n+                transactionManager.commit();\n+            } else if (transactionManager.isActive()){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4c9f7972ec5c21eee66f5e6255e32389a72abd3"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyOTcyMzU3OnYy", "diffSide": "RIGHT", "path": "services/src/main/java/org/keycloak/services/filters/KeycloakTransactionCommitter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNDo0MDoyNlrOGh4KRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNDo0MDoyNlrOGh4KRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE3NjMyNw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    KeycloakTransaction tx =  Resteasy.getContextData(KeycloakTransaction.class);\n          \n          \n            \n                    KeycloakTransaction tx = Resteasy.getContextData(KeycloakTransaction.class);", "url": "https://github.com/keycloak/keycloak/pull/7136#discussion_r438176327", "createdAt": "2020-06-10T14:40:26Z", "author": {"login": "hmlnarik"}, "path": "services/src/main/java/org/keycloak/services/filters/KeycloakTransactionCommitter.java", "diffHunk": "@@ -36,13 +36,20 @@\n public class KeycloakTransactionCommitter implements ContainerResponseFilter {\n \n     @Override\n-    public void filter(ContainerRequestContext containerRequestContext, ContainerResponseContext containerResponseContext) throws IOException {\n-        KeycloakTransaction tx = Resteasy.getContextData(KeycloakTransaction.class);\n+    public void filter(ContainerRequestContext containerRequestContext, ContainerResponseContext containerResponseContext) {\n+        KeycloakTransaction tx =  Resteasy.getContextData(KeycloakTransaction.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4c9f7972ec5c21eee66f5e6255e32389a72abd3"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NDIwMzM2OnYy", "diffSide": "RIGHT", "path": "quarkus/runtime/src/main/java/org/keycloak/provider/quarkus/QuarkusClientConnectionFilter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxMTo0MDozNVrOGriV8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwMTowMzoxM1rOGsg03w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMwNDYyNw==", "bodyText": "Ideally this would be addEndHandler but this method is only available with Vert.x 3.9.1 while current quarkus version is on 3.9.0.\n@stianst / @pedroigor Is it possible / how feasible is to update quarkus?", "url": "https://github.com/keycloak/keycloak/pull/7136#discussion_r448304627", "createdAt": "2020-07-01T11:40:35Z", "author": {"login": "hmlnarik"}, "path": "quarkus/runtime/src/main/java/org/keycloak/provider/quarkus/QuarkusClientConnectionFilter.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2019 Red Hat, Inc. and/or its affiliates\n+ * and other contributors as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.keycloak.provider.quarkus;\n+\n+import io.quarkus.vertx.web.RouteFilter;\n+import io.vertx.core.Handler;\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.RoutingContext;\n+import org.keycloak.common.ClientConnection;\n+import org.keycloak.common.util.Resteasy;\n+import org.keycloak.models.KeycloakSession;\n+import org.keycloak.services.filters.AbstractClientConnectionServletFilter;\n+\n+import javax.inject.Inject;\n+import javax.ws.rs.container.ContainerRequestContext;\n+import javax.ws.rs.container.PreMatching;\n+import javax.ws.rs.ext.Provider;\n+\n+@PreMatching\n+@Provider\n+public class QuarkusClientConnectionFilter implements javax.ws.rs.container.ContainerRequestFilter {\n+\n+    @Inject\n+    RoutingContext routingContext;\n+\n+    @Override\n+    public void filter(ContainerRequestContext containerRequestContext) {\n+        HttpServerRequest request = routingContext.request();\n+        ClientConnection connection = createConnection(request);\n+\n+        AbstractClientConnectionServletFilter servletFilter = new AbstractClientConnectionServletFilter() {\n+            @Override\n+            protected void nextFilter(KeycloakSession session) {\n+                Resteasy.pushContext(KeycloakSession.class, session);\n+                Resteasy.pushContext(ClientConnection.class, connection);\n+\n+                routingContext.put(\"KeycloakSession\", session);\n+            }\n+        };\n+        routingContext.put(\"AbstractClientConnectionServletFilter\", servletFilter);\n+        servletFilter.filter();\n+    }\n+\n+    @RouteFilter()\n+    public void vertxFilter(RoutingContext rc) {\n+        rc.addHeadersEndHandler((Handler) e -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10dc9fc1104fa95a1c1f5076fee83c730655fae9"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTMyODM1MQ==", "bodyText": "We are upgrading every time there is a new release. I'm still developing using Quarkus upstream due to ongoing work that requires upstream.\nBut in general, version upgrade is not a problem.", "url": "https://github.com/keycloak/keycloak/pull/7136#discussion_r449328351", "createdAt": "2020-07-03T01:03:13Z", "author": {"login": "pedroigor"}, "path": "quarkus/runtime/src/main/java/org/keycloak/provider/quarkus/QuarkusClientConnectionFilter.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2019 Red Hat, Inc. and/or its affiliates\n+ * and other contributors as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.keycloak.provider.quarkus;\n+\n+import io.quarkus.vertx.web.RouteFilter;\n+import io.vertx.core.Handler;\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.RoutingContext;\n+import org.keycloak.common.ClientConnection;\n+import org.keycloak.common.util.Resteasy;\n+import org.keycloak.models.KeycloakSession;\n+import org.keycloak.services.filters.AbstractClientConnectionServletFilter;\n+\n+import javax.inject.Inject;\n+import javax.ws.rs.container.ContainerRequestContext;\n+import javax.ws.rs.container.PreMatching;\n+import javax.ws.rs.ext.Provider;\n+\n+@PreMatching\n+@Provider\n+public class QuarkusClientConnectionFilter implements javax.ws.rs.container.ContainerRequestFilter {\n+\n+    @Inject\n+    RoutingContext routingContext;\n+\n+    @Override\n+    public void filter(ContainerRequestContext containerRequestContext) {\n+        HttpServerRequest request = routingContext.request();\n+        ClientConnection connection = createConnection(request);\n+\n+        AbstractClientConnectionServletFilter servletFilter = new AbstractClientConnectionServletFilter() {\n+            @Override\n+            protected void nextFilter(KeycloakSession session) {\n+                Resteasy.pushContext(KeycloakSession.class, session);\n+                Resteasy.pushContext(ClientConnection.class, connection);\n+\n+                routingContext.put(\"KeycloakSession\", session);\n+            }\n+        };\n+        routingContext.put(\"AbstractClientConnectionServletFilter\", servletFilter);\n+        servletFilter.filter();\n+    }\n+\n+    @RouteFilter()\n+    public void vertxFilter(RoutingContext rc) {\n+        rc.addHeadersEndHandler((Handler) e -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODMwNDYyNw=="}, "originalCommit": {"oid": "10dc9fc1104fa95a1c1f5076fee83c730655fae9"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwMDc4NjE5OnYy", "diffSide": "RIGHT", "path": "quarkus/runtime/src/main/java/org/keycloak/provider/quarkus/KeycloakConfigSourceProvider.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwMjoyNTo1MFrOGsh33g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwMjoyNTo1MFrOGsh33g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM0NTUwMg==", "bodyText": "I'm doing similar changes in another PR. I'm wondering if we should get first my changes even though we need some more discussion around configuration.\nIt should not be a problem as most of the changes are necessary.", "url": "https://github.com/keycloak/keycloak/pull/7136#discussion_r449345502", "createdAt": "2020-07-03T02:25:50Z", "author": {"login": "pedroigor"}, "path": "quarkus/runtime/src/main/java/org/keycloak/provider/quarkus/KeycloakConfigSourceProvider.java", "diffHunk": "@@ -58,23 +55,16 @@\n         }\n \n         if (filePath != null) {\n-            sources.add(wrap(new KeycloakPropertiesConfigSource.InFileSystem(filePath)));\n+            sources.add(new KeycloakPropertiesConfigSource.InFileSystem(filePath));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5b2fe44387681117990cf50aa3f2317f28bfe10"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwMDc5MzE0OnYy", "diffSide": "RIGHT", "path": "quarkus/runtime/src/main/java/org/keycloak/provider/quarkus/QuarkusClientConnectionFilter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwMjozMDo0OVrOGsh7zA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwMjozMDo0OVrOGsh7zA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM0NjUwOA==", "bodyText": "I remember using filter differently where we basically dispatch the request from the eventloop so that we can control all the request lifecycle.\nI think it should work better as well as serve as an important point for any other change we might need that affects the thread execution.", "url": "https://github.com/keycloak/keycloak/pull/7136#discussion_r449346508", "createdAt": "2020-07-03T02:30:49Z", "author": {"login": "pedroigor"}, "path": "quarkus/runtime/src/main/java/org/keycloak/provider/quarkus/QuarkusClientConnectionFilter.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2019 Red Hat, Inc. and/or its affiliates\n+ * and other contributors as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.keycloak.provider.quarkus;\n+\n+import io.quarkus.vertx.web.RouteFilter;\n+import io.vertx.core.Handler;\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.RoutingContext;\n+import org.keycloak.common.ClientConnection;\n+import org.keycloak.common.util.Resteasy;\n+import org.keycloak.models.KeycloakSession;\n+import org.keycloak.services.filters.AbstractClientConnectionServletFilter;\n+\n+import javax.inject.Inject;\n+import javax.ws.rs.container.ContainerRequestContext;\n+import javax.ws.rs.container.PreMatching;\n+import javax.ws.rs.ext.Provider;\n+\n+@PreMatching\n+@Provider\n+public class QuarkusClientConnectionFilter implements javax.ws.rs.container.ContainerRequestFilter {\n+\n+    @Inject\n+    RoutingContext routingContext;\n+\n+    @Override\n+    public void filter(ContainerRequestContext containerRequestContext) {\n+        HttpServerRequest request = routingContext.request();\n+        ClientConnection connection = createConnection(request);\n+\n+        AbstractClientConnectionServletFilter servletFilter = new AbstractClientConnectionServletFilter() {\n+            @Override\n+            protected void nextFilter(KeycloakSession session) {\n+                Resteasy.pushContext(KeycloakSession.class, session);\n+                Resteasy.pushContext(ClientConnection.class, connection);\n+\n+                routingContext.put(\"KeycloakSession\", session);\n+            }\n+        };\n+        routingContext.put(\"AbstractClientConnectionServletFilter\", servletFilter);\n+        servletFilter.filter();\n+    }\n+\n+    @RouteFilter()\n+    public void vertxFilter(RoutingContext rc) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5b2fe44387681117990cf50aa3f2317f28bfe10"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwMDc5NTQwOnYy", "diffSide": "RIGHT", "path": "quarkus/runtime/src/main/java/org/keycloak/provider/quarkus/QuarkusLifecycleObserver.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwMjozMjoxNVrOGsh8-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwMjozMjoxNVrOGsh8-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM0NjgxMQ==", "bodyText": "If you use private you are forcing reflection. That is why the method is marked with default/package.", "url": "https://github.com/keycloak/keycloak/pull/7136#discussion_r449346811", "createdAt": "2020-07-03T02:32:15Z", "author": {"login": "pedroigor"}, "path": "quarkus/runtime/src/main/java/org/keycloak/provider/quarkus/QuarkusLifecycleObserver.java", "diffHunk": "@@ -38,10 +37,7 @@\n     private static final String KEYCLOAK_ADMIN_ENV_VAR = \"KEYCLOAK_ADMIN\";\n     private static final String KEYCLOAK_ADMIN_PASSWORD_ENV_VAR = \"KEYCLOAK_ADMIN_PASSWORD\";\n \n-    @Inject\n-    KeycloakApplication application;\n-\n-    void onStartupEvent(@Observes StartupEvent event) {\n+    private void onStartupEvent(@Observes StartupEvent event) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5b2fe44387681117990cf50aa3f2317f28bfe10"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwMjUxMTM4OnYy", "diffSide": "RIGHT", "path": "quarkus/runtime/src/main/java/org/keycloak/provider/quarkus/QuarkusClientConnectionFilter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNDozMjo0M1rOGsyKdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxNjoxNTozN1rOGs0cMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYxMjQwNg==", "bodyText": "The fact we are creating instances of AbstractClientConnectionServletFilter on every request is not ideal. As well as duplicating code when pushing context data.\nWe could potentially override methods and have the main logic from the abstract class.", "url": "https://github.com/keycloak/keycloak/pull/7136#discussion_r449612406", "createdAt": "2020-07-03T14:32:43Z", "author": {"login": "pedroigor"}, "path": "quarkus/runtime/src/main/java/org/keycloak/provider/quarkus/QuarkusClientConnectionFilter.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2019 Red Hat, Inc. and/or its affiliates\n+ * and other contributors as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.keycloak.provider.quarkus;\n+\n+import io.quarkus.vertx.web.RouteFilter;\n+import io.vertx.core.Handler;\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.RoutingContext;\n+import org.keycloak.common.ClientConnection;\n+import org.keycloak.common.util.Resteasy;\n+import org.keycloak.models.KeycloakSession;\n+import org.keycloak.services.filters.AbstractClientConnectionServletFilter;\n+\n+import javax.inject.Inject;\n+import javax.ws.rs.container.ContainerRequestContext;\n+import javax.ws.rs.container.PreMatching;\n+import javax.ws.rs.ext.Provider;\n+\n+@PreMatching\n+@Provider\n+public class QuarkusClientConnectionFilter implements javax.ws.rs.container.ContainerRequestFilter {\n+\n+    @Inject\n+    RoutingContext routingContext;\n+\n+    @Override\n+    public void filter(ContainerRequestContext containerRequestContext) {\n+        HttpServerRequest request = routingContext.request();\n+        ClientConnection connection = createConnection(request);\n+\n+        AbstractClientConnectionServletFilter servletFilter = new AbstractClientConnectionServletFilter() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5b2fe44387681117990cf50aa3f2317f28bfe10"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY0OTcxMg==", "bodyText": "That would be ideal if the same approach could be used in Wildfly, however it seems that this is not possible, servlet filter approach is not compatible with the vert.x filters, and it does not seem possible to use a common approach. So instantiating a small instance seemed an acceptable alternative. Yet if you find a better alternative that would work for both, that would be indeed better.", "url": "https://github.com/keycloak/keycloak/pull/7136#discussion_r449649712", "createdAt": "2020-07-03T16:15:37Z", "author": {"login": "hmlnarik"}, "path": "quarkus/runtime/src/main/java/org/keycloak/provider/quarkus/QuarkusClientConnectionFilter.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2019 Red Hat, Inc. and/or its affiliates\n+ * and other contributors as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.keycloak.provider.quarkus;\n+\n+import io.quarkus.vertx.web.RouteFilter;\n+import io.vertx.core.Handler;\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.RoutingContext;\n+import org.keycloak.common.ClientConnection;\n+import org.keycloak.common.util.Resteasy;\n+import org.keycloak.models.KeycloakSession;\n+import org.keycloak.services.filters.AbstractClientConnectionServletFilter;\n+\n+import javax.inject.Inject;\n+import javax.ws.rs.container.ContainerRequestContext;\n+import javax.ws.rs.container.PreMatching;\n+import javax.ws.rs.ext.Provider;\n+\n+@PreMatching\n+@Provider\n+public class QuarkusClientConnectionFilter implements javax.ws.rs.container.ContainerRequestFilter {\n+\n+    @Inject\n+    RoutingContext routingContext;\n+\n+    @Override\n+    public void filter(ContainerRequestContext containerRequestContext) {\n+        HttpServerRequest request = routingContext.request();\n+        ClientConnection connection = createConnection(request);\n+\n+        AbstractClientConnectionServletFilter servletFilter = new AbstractClientConnectionServletFilter() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYxMjQwNg=="}, "originalCommit": {"oid": "f5b2fe44387681117990cf50aa3f2317f28bfe10"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMTIyOTM2OnYy", "diffSide": "RIGHT", "path": "services/src/main/java/org/keycloak/services/filters/AbstractClientConnectionFilter.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNDoyMDoxNVrOGuA2QA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNDoyMDoxNVrOGuA2QA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDkwMTU2OA==", "bodyText": "Rename to something like AbstractRequestFilter, including renaming subclasses.", "url": "https://github.com/keycloak/keycloak/pull/7136#discussion_r450901568", "createdAt": "2020-07-07T14:20:15Z", "author": {"login": "stianst"}, "path": "services/src/main/java/org/keycloak/services/filters/AbstractClientConnectionFilter.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package org.keycloak.services.filters;\n+\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates\n+ * and other contributors as indicated by the @author tags.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+import java.util.function.Consumer;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+\n+import org.keycloak.common.ClientConnection;\n+import org.keycloak.common.util.Resteasy;\n+import org.keycloak.models.KeycloakSession;\n+import org.keycloak.models.KeycloakSessionFactory;\n+import org.keycloak.models.KeycloakTransactionManager;\n+import org.keycloak.services.resources.KeycloakApplication;\n+\n+\n+public abstract class AbstractClientConnectionFilter {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1c4669538808b351fce6c63ce4fa539205face1"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3525, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}