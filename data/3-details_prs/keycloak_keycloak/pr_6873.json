{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0NjczOTU5", "number": 6873, "title": "KEYCLOAK-8141 Fix issue where attribute values are duplicated if upda\u2026", "bodyText": "In the past when a user was updated all attributes was removed and re-added. This updates it to only update an attribute if indeed the values have changed, which prevents the issue of duplicating values. It is still not ideal though, but good enough for now, and should be done better in the new store.", "createdAt": "2020-03-06T07:28:49Z", "url": "https://github.com/keycloak/keycloak/pull/6873", "merged": true, "mergeCommit": {"oid": "49db2c13a5782ac7bccec6f57976ff5df248e1c7"}, "closed": true, "closedAt": "2020-05-12T07:06:45Z", "author": {"login": "stianst"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcM4SHvgBqjMxMjIwMjk3NTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcge09BgFqTQwOTc1NDQ2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6129219a66fa15c77ab7c827b43b0075aae36b75", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/6129219a66fa15c77ab7c827b43b0075aae36b75", "committedDate": "2020-03-06T07:28:34Z", "message": "KEYCLOAK-8141 Fix issue where attribute values are duplicated if updates to user are done in parallell"}, "afterCommit": {"oid": "dbf2c2494bdb7c74f85fc882782e5538916bc3b2", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/dbf2c2494bdb7c74f85fc882782e5538916bc3b2", "committedDate": "2020-03-12T09:27:29Z", "message": "KEYCLOAK-8141 Fix issue where attribute values are duplicated if updates to user are done in parallell"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNTM1NzI0", "url": "https://github.com/keycloak/keycloak/pull/6873#pullrequestreview-402535724", "createdAt": "2020-04-29T10:18:27Z", "commit": {"oid": "dbf2c2494bdb7c74f85fc882782e5538916bc3b2"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d2bcc9b64c381c65fe69975f67a971ff3d15eb3", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/0d2bcc9b64c381c65fe69975f67a971ff3d15eb3", "committedDate": "2020-04-29T10:20:51Z", "message": "Update ConcurrencyTest.java"}, "afterCommit": {"oid": "30e84c563620a50cd6302e8774f929f147f3dbe1", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/30e84c563620a50cd6302e8774f929f147f3dbe1", "committedDate": "2020-04-30T06:41:42Z", "message": "KEYCLOAK-8141 Fix issue where attribute values are duplicated if updates to user are done in parallell"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NzMwNTYz", "url": "https://github.com/keycloak/keycloak/pull/6873#pullrequestreview-405730563", "createdAt": "2020-05-05T12:17:17Z", "commit": {"oid": "30e84c563620a50cd6302e8774f929f147f3dbe1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMjoxNzoxN1rOGQmpiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMjoxOTozOVrOGQmuvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA2MzYyNQ==", "bodyText": "The response is never closed and causes connection leak.\nCreator relieves you from boilerplate code, see e.g. https://github.com/keycloak/keycloak/blob/master/testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/admin/UserTest.java#L2047.", "url": "https://github.com/keycloak/keycloak/pull/6873#discussion_r420063625", "createdAt": "2020-05-05T12:17:17Z", "author": {"login": "hmlnarik"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/admin/concurrency/ConcurrencyTest.java", "diffHunk": "@@ -51,6 +62,38 @@ public void concurrentTest(KeycloakRunnable... tasks) throws Throwable {\n         System.out.println(\"took \" + end + \" ms\");\n     }\n \n+    // KEYCLOAK-8141 Verify that no attribute values are duplicated, and there are no locking exceptions when adding attributes in parallell\n+    @Test\n+    @Ignore\n+    public void createUserAttributes() throws Throwable {\n+        AtomicInteger c = new AtomicInteger();\n+\n+        UsersResource users = testRealm().users();\n+\n+        UserRepresentation u = UserBuilder.create().username(\"attributes\").build();\n+        Response response = users.create(u);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30e84c563620a50cd6302e8774f929f147f3dbe1"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA2NDQ4NQ==", "bodyText": "assertThat(rep.getAttributes(), Matchers.hasSize(lessThanOrEqualTo(c.get()) has better error reporting.", "url": "https://github.com/keycloak/keycloak/pull/6873#discussion_r420064485", "createdAt": "2020-05-05T12:18:50Z", "author": {"login": "hmlnarik"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/admin/concurrency/ConcurrencyTest.java", "diffHunk": "@@ -51,6 +62,38 @@ public void concurrentTest(KeycloakRunnable... tasks) throws Throwable {\n         System.out.println(\"took \" + end + \" ms\");\n     }\n \n+    // KEYCLOAK-8141 Verify that no attribute values are duplicated, and there are no locking exceptions when adding attributes in parallell\n+    @Test\n+    @Ignore\n+    public void createUserAttributes() throws Throwable {\n+        AtomicInteger c = new AtomicInteger();\n+\n+        UsersResource users = testRealm().users();\n+\n+        UserRepresentation u = UserBuilder.create().username(\"attributes\").build();\n+        Response response = users.create(u);\n+        String userId = ApiUtil.getCreatedId(response);\n+\n+        UserResource user = users.get(userId);\n+\n+        concurrentTest((threadIndex, keycloak, realm) -> {\n+            UserRepresentation rep = user.toRepresentation();\n+            rep.singleAttribute(\"a-\" + c.getAndIncrement(), \"value\");\n+            user.update(rep);\n+        });\n+\n+        UserRepresentation rep = user.toRepresentation();\n+\n+        // Number of attributes should be equal to created attributes, or less (concurrent requests may drop attributes added by other threads)\n+        assertTrue(rep.getAttributes().size() <= c.get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30e84c563620a50cd6302e8774f929f147f3dbe1"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA2NDk1OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        assertEquals(1, e.getValue().size());\n          \n          \n            \n                        assertThat(e.getValue(), Matchers.hasSize(1));\n          \n      \n    \n    \n  \n\nfor better error reporting.", "url": "https://github.com/keycloak/keycloak/pull/6873#discussion_r420064959", "createdAt": "2020-05-05T12:19:39Z", "author": {"login": "hmlnarik"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/admin/concurrency/ConcurrencyTest.java", "diffHunk": "@@ -51,6 +62,38 @@ public void concurrentTest(KeycloakRunnable... tasks) throws Throwable {\n         System.out.println(\"took \" + end + \" ms\");\n     }\n \n+    // KEYCLOAK-8141 Verify that no attribute values are duplicated, and there are no locking exceptions when adding attributes in parallell\n+    @Test\n+    @Ignore\n+    public void createUserAttributes() throws Throwable {\n+        AtomicInteger c = new AtomicInteger();\n+\n+        UsersResource users = testRealm().users();\n+\n+        UserRepresentation u = UserBuilder.create().username(\"attributes\").build();\n+        Response response = users.create(u);\n+        String userId = ApiUtil.getCreatedId(response);\n+\n+        UserResource user = users.get(userId);\n+\n+        concurrentTest((threadIndex, keycloak, realm) -> {\n+            UserRepresentation rep = user.toRepresentation();\n+            rep.singleAttribute(\"a-\" + c.getAndIncrement(), \"value\");\n+            user.update(rep);\n+        });\n+\n+        UserRepresentation rep = user.toRepresentation();\n+\n+        // Number of attributes should be equal to created attributes, or less (concurrent requests may drop attributes added by other threads)\n+        assertTrue(rep.getAttributes().size() <= c.get());\n+\n+        // All attributes should have a single value\n+        for (Map.Entry<String, List<String>> e : rep.getAttributes().entrySet()) {\n+            assertEquals(1, e.getValue().size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30e84c563620a50cd6302e8774f929f147f3dbe1"}, "originalPosition": 59}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04d380136f575c94a7873a422ba610bf77879902", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/04d380136f575c94a7873a422ba610bf77879902", "committedDate": "2020-05-08T08:10:18Z", "message": "KEYCLOAK-8141 Fix issue where attribute values are duplicated if updates to user are done in parallell"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30e84c563620a50cd6302e8774f929f147f3dbe1", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/30e84c563620a50cd6302e8774f929f147f3dbe1", "committedDate": "2020-04-30T06:41:42Z", "message": "KEYCLOAK-8141 Fix issue where attribute values are duplicated if updates to user are done in parallell"}, "afterCommit": {"oid": "04d380136f575c94a7873a422ba610bf77879902", "author": {"user": {"login": "stianst", "name": "Stian Thorgersen"}}, "url": "https://github.com/keycloak/keycloak/commit/04d380136f575c94a7873a422ba610bf77879902", "committedDate": "2020-05-08T08:10:18Z", "message": "KEYCLOAK-8141 Fix issue where attribute values are duplicated if updates to user are done in parallell"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NzU0NDYz", "url": "https://github.com/keycloak/keycloak/pull/6873#pullrequestreview-409754463", "createdAt": "2020-05-12T07:06:39Z", "commit": {"oid": "04d380136f575c94a7873a422ba610bf77879902"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2569, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}