{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyNzE5NTEw", "number": 7404, "title": "KEYCLOAK-15477 Fix permission evaluation logic", "bodyText": "", "createdAt": "2020-09-09T09:50:59Z", "url": "https://github.com/keycloak/keycloak/pull/7404", "merged": true, "mergeCommit": {"oid": "a05066d567fdfa0be94fe7b085370e3de4e3627c"}, "closed": true, "closedAt": "2020-09-14T18:53:47Z", "author": {"login": "hmlnarik"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHPm8UgFqTQ4NTI0MzA0NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdI32b6AFqTQ4ODA1Mjc0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MjQzMDQ0", "url": "https://github.com/keycloak/keycloak/pull/7404#pullrequestreview-485243044", "createdAt": "2020-09-09T17:24:55Z", "commit": {"oid": "926c535f98dd1ff34e57984cf7d688c4860b2a1f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNzoyNDo1NlrOHPSajg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNzoyNTozOVrOHPScQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5MjM5OA==", "bodyText": "Isn't there a NPE waiting to happen here if set1 is null? IIRC the HasSet constructor raises an NPE if the collection specified in the constructor is null.", "url": "https://github.com/keycloak/keycloak/pull/7404#discussion_r485792398", "createdAt": "2020-09-09T17:24:56Z", "author": {"login": "sguilhen"}, "path": "services/src/main/java/org/keycloak/services/resources/admin/AdminConsole.java", "diffHunk": "@@ -232,28 +233,36 @@ public Response whoAmI(final @Context HttpHeaders headers) {\n     private void addRealmAccess(RealmModel realm, UserModel user, Map<String, Set<String>> realmAdminAccess) {\n         RealmManager realmManager = new RealmManager(session);\n         ClientModel realmAdminApp = realm.getClientByClientId(realmManager.getRealmAdminClientId(realm));\n-        getRealmAdminAccess(realmAdminApp, user, realmAdminAccess);\n+        getRealmAdminAccess(realm, realmAdminApp, user, realmAdminAccess);\n     }\n \n     private void addMasterRealmAccess(UserModel user, Map<String, Set<String>> realmAdminAccess) {\n         List<RealmModel> realms = session.realms().getRealms();\n         for (RealmModel realm : realms) {\n             ClientModel realmAdminApp = realm.getMasterAdminClient();\n-            getRealmAdminAccess(realmAdminApp, user, realmAdminAccess);\n+            getRealmAdminAccess(realm, realmAdminApp, user, realmAdminAccess);\n         }\n     }\n \n-    private void getRealmAdminAccess(ClientModel client, UserModel user, Map<String, Set<String>> realmAdminAccess) {\n-        Set<String> roles = client.getRolesStream().filter(user::hasRole)\n-                .map(RoleModel::getName).collect(Collectors.toSet());\n \n-        if (!roles.isEmpty()) {\n-            if (!realmAdminAccess.containsKey(realm.getName())) {\n-                realmAdminAccess.put(realm.getName(), roles);\n-            } else {\n-                realmAdminAccess.get(realm.getName()).addAll(roles);\n-            }\n+    private static <T> HashSet<T> union(Set<T> set1, Set<T> set2) {\n+        if (set1 == null && set2 == null) {\n+            return null;\n+        }\n+        HashSet<T> res = (set1 instanceof HashSet) ? (HashSet <T>) set1 : new HashSet<>(set1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "926c535f98dd1ff34e57984cf7d688c4860b2a1f"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc5MjgzNA==", "bodyText": "License header", "url": "https://github.com/keycloak/keycloak/pull/7404#discussion_r485792834", "createdAt": "2020-09-09T17:25:39Z", "author": {"login": "sguilhen"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/admin/AdminConsolePermissionsCalculatedTest.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package org.keycloak.testsuite.admin;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "926c535f98dd1ff34e57984cf7d688c4860b2a1f"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "041430765f28af8ca89d66f08fea2e6047311f07", "author": {"user": {"login": "hmlnarik", "name": "Hynek Mlna\u0159\u00edk"}}, "url": "https://github.com/keycloak/keycloak/commit/041430765f28af8ca89d66f08fea2e6047311f07", "committedDate": "2020-09-10T05:37:12Z", "message": "KEYCLOAK-15477 Fix permission evaluation logic"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "926c535f98dd1ff34e57984cf7d688c4860b2a1f", "author": {"user": {"login": "hmlnarik", "name": "Hynek Mlna\u0159\u00edk"}}, "url": "https://github.com/keycloak/keycloak/commit/926c535f98dd1ff34e57984cf7d688c4860b2a1f", "committedDate": "2020-09-09T09:50:17Z", "message": "KEYCLOAK-15477 Fix permission evaluation logic"}, "afterCommit": {"oid": "041430765f28af8ca89d66f08fea2e6047311f07", "author": {"user": {"login": "hmlnarik", "name": "Hynek Mlna\u0159\u00edk"}}, "url": "https://github.com/keycloak/keycloak/commit/041430765f28af8ca89d66f08fea2e6047311f07", "committedDate": "2020-09-10T05:37:12Z", "message": "KEYCLOAK-15477 Fix permission evaluation logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1ODYxMjU2", "url": "https://github.com/keycloak/keycloak/pull/7404#pullrequestreview-485861256", "createdAt": "2020-09-10T12:08:01Z", "commit": {"oid": "041430765f28af8ca89d66f08fea2e6047311f07"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1ODkyNzg1", "url": "https://github.com/keycloak/keycloak/pull/7404#pullrequestreview-485892785", "createdAt": "2020-09-10T12:48:38Z", "commit": {"oid": "041430765f28af8ca89d66f08fea2e6047311f07"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2Mjc3Njc0", "url": "https://github.com/keycloak/keycloak/pull/7404#pullrequestreview-486277674", "createdAt": "2020-09-10T20:16:02Z", "commit": {"oid": "041430765f28af8ca89d66f08fea2e6047311f07"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MDUyNzQ5", "url": "https://github.com/keycloak/keycloak/pull/7404#pullrequestreview-488052749", "createdAt": "2020-09-14T18:52:52Z", "commit": {"oid": "041430765f28af8ca89d66f08fea2e6047311f07"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2803, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}