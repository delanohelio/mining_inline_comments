{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyMjM3NTg0", "number": 7032, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMTo1NDoxMlrOEAVW7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMTo1NDoxMlrOEAVW7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4Nzg1MzkxOnYy", "diffSide": "LEFT", "path": "model/jpa/src/main/java/org/keycloak/models/jpa/JpaRealmProvider.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMTo1NDoxMlrOGbjC6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxOToyMTo1N1rOGyMf4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzODkyMw==", "bodyText": "Removing this flush inside the for loop decreased the whoamI request a lot....", "url": "https://github.com/keycloak/keycloak/pull/7032#discussion_r431538923", "createdAt": "2020-05-28T01:54:12Z", "author": {"login": "YaoFu-ea"}, "path": "model/jpa/src/main/java/org/keycloak/models/jpa/JpaRealmProvider.java", "diffHunk": "@@ -120,7 +120,6 @@ public RealmModel getRealm(String id) {\n         for (String id : entities) {\n             RealmModel realm = session.realms().getRealm(id);\n             if (realm != null) realms.add(realm);\n-            em.flush();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24d6362296ccde8dc282dfc3d5dcf6403896641e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY2OTc0Mg==", "bodyText": "This is interesting point. See #6012, the call to flush reportedly improved the performance for bigger number of realms.  As I mentioned in the #6012 (review) comment, I'd rather have no flush whatsoever in the JPA layer. Yet now I wonder which of the alternatives is better.\nCould you please try the same patch without this flush and report the results here?", "url": "https://github.com/keycloak/keycloak/pull/7032#discussion_r449669742", "createdAt": "2020-07-03T17:45:12Z", "author": {"login": "hmlnarik"}, "path": "model/jpa/src/main/java/org/keycloak/models/jpa/JpaRealmProvider.java", "diffHunk": "@@ -120,7 +120,6 @@ public RealmModel getRealm(String id) {\n         for (String id : entities) {\n             RealmModel realm = session.realms().getRealm(id);\n             if (realm != null) realms.add(realm);\n-            em.flush();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzODkyMw=="}, "originalCommit": {"oid": "24d6362296ccde8dc282dfc3d5dcf6403896641e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI4Njc1Mw==", "bodyText": "Hi, @hmlnarik\nI've tested with 560 realms in KC 9.0.4 where the fix is originally committed:\n\nWith flush: Takes around 11min\nWithout flush: Takes around 1min\nPlease let me know if more results are needed. Thanks!", "url": "https://github.com/keycloak/keycloak/pull/7032#discussion_r455286753", "createdAt": "2020-07-15T19:21:57Z", "author": {"login": "YaoFu-ea"}, "path": "model/jpa/src/main/java/org/keycloak/models/jpa/JpaRealmProvider.java", "diffHunk": "@@ -120,7 +120,6 @@ public RealmModel getRealm(String id) {\n         for (String id : entities) {\n             RealmModel realm = session.realms().getRealm(id);\n             if (realm != null) realms.add(realm);\n-            em.flush();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUzODkyMw=="}, "originalCommit": {"oid": "24d6362296ccde8dc282dfc3d5dcf6403896641e"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3608, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}