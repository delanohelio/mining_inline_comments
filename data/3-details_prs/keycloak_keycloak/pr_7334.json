{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3MjQ5Mjcz", "number": 7334, "title": "KEYCLOAK-14767 OpenShift Review Endpoint audience fix", "bodyText": "https://issues.redhat.com/browse/KEYCLOAK-14767\nThis Pull Request replaces #7268. It introduces a mandatory audience check for OpenShift Token Review Endpoint.", "createdAt": "2020-08-13T08:59:07Z", "url": "https://github.com/keycloak/keycloak/pull/7334", "merged": true, "mergeCommit": {"oid": "e01159a94363bf88e460cf2febc0809f99073585"}, "closed": true, "closedAt": "2020-09-09T14:57:25Z", "author": {"login": "slaskawi"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-cKXXgH2gAyNDY3MjQ5MjczOjM5YjA1YjQ5OWMyMzg4OTliYjlkMDJlZjY4MWU1MDBkYzU4ZmQzOGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHNe9MgFqTQ4NTA5OTM3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "39b05b499c238899bb9d02ef681e500dc58fd38e", "author": {"user": {"login": "slaskawi", "name": "Sebastian \u0141askawiec"}}, "url": "https://github.com/keycloak/keycloak/commit/39b05b499c238899bb9d02ef681e500dc58fd38e", "committedDate": "2020-08-13T08:58:03Z", "message": "KEYCLOAK-14767 OpenShift Review Endpoint audience fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NzI0MDEw", "url": "https://github.com/keycloak/keycloak/pull/7334#pullrequestreview-466724010", "createdAt": "2020-08-13T12:44:00Z", "commit": {"oid": "39b05b499c238899bb9d02ef681e500dc58fd38e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNDQ2NjU2", "url": "https://github.com/keycloak/keycloak/pull/7334#pullrequestreview-473446656", "createdAt": "2020-08-24T13:07:56Z", "commit": {"oid": "39b05b499c238899bb9d02ef681e500dc58fd38e"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMzowNzo1N1rOHFjgxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMzozOToyMFrOHFk0iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU4Njc1Nw==", "bodyText": "Why to remove this test? Is it not valid anymore?", "url": "https://github.com/keycloak/keycloak/pull/7334#discussion_r475586757", "createdAt": "2020-08-24T13:07:57Z", "author": {"login": "vmuzikar"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/openshift/OpenShiftTokenReviewEndpointTest.java", "diffHunk": "@@ -228,29 +241,10 @@ public void customScopes() {\n     }\n \n     @Test\n-    public void emptyScope() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39b05b499c238899bb9d02ef681e500dc58fd38e"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYwMzcwMQ==", "bodyText": "Is this really invoked without audience? I can see it added here:\n\n  \n    \n      keycloak/testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/openshift/OpenShiftTokenReviewEndpointTest.java\n    \n    \n         Line 379\n      in\n      39b05b4\n    \n    \n    \n    \n\n        \n          \n           spec.setAudiences(new String[]{\"account\"}); \n        \n    \n  \n\n\nBut maybe I'm just missing something. :)", "url": "https://github.com/keycloak/keycloak/pull/7334#discussion_r475603701", "createdAt": "2020-08-24T13:35:31Z", "author": {"login": "vmuzikar"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/openshift/OpenShiftTokenReviewEndpointTest.java", "diffHunk": "@@ -228,29 +241,10 @@ public void customScopes() {\n     }\n \n     @Test\n-    public void emptyScope() throws Exception {\n-        ClientRepresentation clientRep = testRealm().clients().findByClientId(\"test-app\").get(0);\n-        List<ClientScopeRepresentation> scopesBefore = testRealm().clients().get(clientRep.getId()).getDefaultClientScopes();\n-\n-        try (ClientAttributeUpdater cau = ClientAttributeUpdater.forClient(adminClient, \"test\", clientRep.getClientId())\n-                .setConsentRequired(false)\n-                .setFullScopeAllowed(false)\n-                .setDefaultClientScopes(Collections.EMPTY_LIST)\n-                .update()) {\n-\n-            oauth.openid(false);\n-            try {\n-                new Review()\n-                        .invoke()\n-                        .assertSuccess()\n-                        .assertEmptyScope();\n-            } finally {\n-                oauth.openid(true);\n-            }\n-        }\n-        // The default client scopes should be same like before.\n-        int scopesAfterSize = testRealm().clients().get(clientRep.getId()).getDefaultClientScopes().size();\n-        assertEquals(scopesBefore.size(), scopesAfterSize);\n+    public void emptyAudience() {\n+        new Review().username(\"empty-audience\")\n+                .invoke()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39b05b499c238899bb9d02ef681e500dc58fd38e"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYwODIwMw==", "bodyText": "Just a silly question. For some reason, originally it was prohibited for expectedAudience to be null. Why to allow it now? And are we 100% sure this doesn't create e.g. some vulnerability?", "url": "https://github.com/keycloak/keycloak/pull/7334#discussion_r475608203", "createdAt": "2020-08-24T13:39:20Z", "author": {"login": "vmuzikar"}, "path": "core/src/main/java/org/keycloak/TokenVerifier.java", "diffHunk": "@@ -366,11 +366,18 @@ private void removeCheck(Predicate<? super T> check) {\n     /**\n      * Add check for verifying that token contains the expectedAudience\n      *\n-     * @param expectedAudience Audience, which needs to be in the target token. Can't be null\n+     * @param expectedAudiences Audiences, which needs to be in the target token. Can be <code>null</code>.\n      * @return This token verifier\n      */\n-    public TokenVerifier<T> audience(String expectedAudience) {\n-        return this.replaceCheck(AudienceCheck.class, true, new AudienceCheck(expectedAudience));\n+    public TokenVerifier<T> audience(String... expectedAudiences) {\n+        if (expectedAudiences == null || expectedAudiences.length == 0) {\n+            return this.replaceCheck(AudienceCheck.class, true, new AudienceCheck(null));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39b05b499c238899bb9d02ef681e500dc58fd38e"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNjI1MzMw", "url": "https://github.com/keycloak/keycloak/pull/7334#pullrequestreview-473625330", "createdAt": "2020-08-24T15:43:15Z", "commit": {"oid": "39b05b499c238899bb9d02ef681e500dc58fd38e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MDk5Mzc0", "url": "https://github.com/keycloak/keycloak/pull/7334#pullrequestreview-485099374", "createdAt": "2020-09-09T14:57:17Z", "commit": {"oid": "39b05b499c238899bb9d02ef681e500dc58fd38e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2747, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}