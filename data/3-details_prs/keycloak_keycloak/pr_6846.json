{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxMDkyMjU1", "number": 6846, "title": "[KEYCLOAK-12192] - Missing Input Validation in IDP Urls", "bodyText": "", "createdAt": "2020-02-27T21:53:16Z", "url": "https://github.com/keycloak/keycloak/pull/6846", "merged": true, "mergeCommit": {"oid": "2f489a41ebd06eb14197f8a66afae86ac1397f42"}, "closed": true, "closedAt": "2020-03-05T05:32:37Z", "author": {"login": "pedroigor"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIimdBgBqjMwNzk2NTU2NzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKkuPigFqTM2OTMwNDIwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "56cef1a1137391cbe6d6544698cf11109594b183", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/56cef1a1137391cbe6d6544698cf11109594b183", "committedDate": "2020-02-27T21:50:44Z", "message": "[KEYCLOAK-12192] - Missing Input Validation in IDP Authorization URLs (Info)"}, "afterCommit": {"oid": "38260e4aa52c50e8a4d12c6424e486616c46b72a", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/38260e4aa52c50e8a4d12c6424e486616c46b72a", "committedDate": "2020-02-27T21:56:05Z", "message": "[KEYCLOAK-12192] - Missing Input Validation in IDP Authorization URLs (Info)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "38260e4aa52c50e8a4d12c6424e486616c46b72a", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/38260e4aa52c50e8a4d12c6424e486616c46b72a", "committedDate": "2020-02-27T21:56:05Z", "message": "[KEYCLOAK-12192] - Missing Input Validation in IDP Authorization URLs (Info)"}, "afterCommit": {"oid": "464f05f2eb3e6f5be40b57975af164a418d685e9", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/464f05f2eb3e6f5be40b57975af164a418d685e9", "committedDate": "2020-02-28T13:05:19Z", "message": "[KEYCLOAK-12192] - Missing Input Validation in IDP Authorization URLs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NTI3NDk1", "url": "https://github.com/keycloak/keycloak/pull/6846#pullrequestreview-368527495", "createdAt": "2020-03-04T06:19:09Z", "commit": {"oid": "464f05f2eb3e6f5be40b57975af164a418d685e9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNjoxOTowOVrOFxhKNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNjoyNDoxNlrOFxhPfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ2NzgyOQ==", "bodyText": "Why are these being added? Looks like they are not used.", "url": "https://github.com/keycloak/keycloak/pull/6846#discussion_r387467829", "createdAt": "2020-03-04T06:19:09Z", "author": {"login": "stianst"}, "path": "services/src/main/java/org/keycloak/broker/oidc/OIDCIdentityProviderConfig.java", "diffHunk": "@@ -27,12 +30,18 @@\n \n     public static final String USE_JWKS_URL = \"useJwksUrl\";\n     public static final String VALIDATE_SIGNATURE = \"validateSignature\";\n+    public static final String PUBLIC_KEY_SIGNATURE_VERIFIER = \"publicKeySignatureVerifier\";\n+    public static final String PUBLIC_KEY_SIGNATURE_VERIFIER_KEY_ID = \"publicKeySignatureVerifierKeyId\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "464f05f2eb3e6f5be40b57975af164a418d685e9"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ2ODQ3MA==", "bodyText": "I don't think this is the correct place to add validation for Urls. How about adding it to org.keycloak.validation.UrlValidation instead?", "url": "https://github.com/keycloak/keycloak/pull/6846#discussion_r387468470", "createdAt": "2020-03-04T06:21:27Z", "author": {"login": "stianst"}, "path": "services/src/main/java/org/keycloak/services/Urls.java", "diffHunk": "@@ -273,4 +277,33 @@ private static UriBuilder themeBase(URI baseUri) {\n     public static URI samlRequestEndpoint(final URI baseUri, final String realmName) {\n         return realmBase(baseUri).path(RealmsResource.class, \"getProtocol\").build(realmName, SamlProtocol.LOGIN_PROTOCOL);\n     }\n+\n+    public static void checkUrl(KeycloakSession session, String url, String name) throws IllegalArgumentException{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "464f05f2eb3e6f5be40b57975af164a418d685e9"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ2ODcyNw==", "bodyText": "Should this not be an exact match on http or https? Otherwise the accepted protocol could be \"httpasdfsadfsafdsadfasdfsafdsadfsafdsadf\".", "url": "https://github.com/keycloak/keycloak/pull/6846#discussion_r387468727", "createdAt": "2020-03-04T06:22:29Z", "author": {"login": "stianst"}, "path": "services/src/main/java/org/keycloak/services/Urls.java", "diffHunk": "@@ -273,4 +277,33 @@ private static UriBuilder themeBase(URI baseUri) {\n     public static URI samlRequestEndpoint(final URI baseUri, final String realmName) {\n         return realmBase(baseUri).path(RealmsResource.class, \"getProtocol\").build(realmName, SamlProtocol.LOGIN_PROTOCOL);\n     }\n+\n+    public static void checkUrl(KeycloakSession session, String url, String name) throws IllegalArgumentException{\n+        if (url == null) {\n+            return;\n+        }\n+\n+        URL parsed;\n+\n+        try {\n+            parsed = new URL(url);\n+        } catch (MalformedURLException e) {\n+            throw new IllegalArgumentException(\"The url [\" + name + \"] is malformed\", e);\n+        }\n+\n+        String protocol = parsed.getProtocol().toLowerCase();\n+\n+        if (!protocol.startsWith(\"http\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "464f05f2eb3e6f5be40b57975af164a418d685e9"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ2OTE4Mg==", "bodyText": "This is not correct. You are checking here if SSL is required to the IP address of the admin that is adding the identity provider. It should be checking if SSL is required for the address of the identity provider.", "url": "https://github.com/keycloak/keycloak/pull/6846#discussion_r387469182", "createdAt": "2020-03-04T06:24:16Z", "author": {"login": "stianst"}, "path": "services/src/main/java/org/keycloak/services/Urls.java", "diffHunk": "@@ -273,4 +277,33 @@ private static UriBuilder themeBase(URI baseUri) {\n     public static URI samlRequestEndpoint(final URI baseUri, final String realmName) {\n         return realmBase(baseUri).path(RealmsResource.class, \"getProtocol\").build(realmName, SamlProtocol.LOGIN_PROTOCOL);\n     }\n+\n+    public static void checkUrl(KeycloakSession session, String url, String name) throws IllegalArgumentException{\n+        if (url == null) {\n+            return;\n+        }\n+\n+        URL parsed;\n+\n+        try {\n+            parsed = new URL(url);\n+        } catch (MalformedURLException e) {\n+            throw new IllegalArgumentException(\"The url [\" + name + \"] is malformed\", e);\n+        }\n+\n+        String protocol = parsed.getProtocol().toLowerCase();\n+\n+        if (!protocol.startsWith(\"http\")) {\n+            throw new IllegalArgumentException(\"Invalid protocol/scheme for url [\" + name + \"]\");\n+        }\n+\n+        ClientConnection connection = session.getContext().getConnection();\n+\n+        if (connection != null) {\n+            if (!\"https\".equals(protocol) && session.getContext().getRealm()\n+                    .getSslRequired().isRequired(connection)) {\n+                throw new IllegalArgumentException(\"The url [\" + name + \"] requires secure connections\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "464f05f2eb3e6f5be40b57975af164a418d685e9"}, "originalPosition": 50}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "464f05f2eb3e6f5be40b57975af164a418d685e9", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/464f05f2eb3e6f5be40b57975af164a418d685e9", "committedDate": "2020-02-28T13:05:19Z", "message": "[KEYCLOAK-12192] - Missing Input Validation in IDP Authorization URLs"}, "afterCommit": {"oid": "b41419151f31d34bd987a72faf386a98606b7589", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/b41419151f31d34bd987a72faf386a98606b7589", "committedDate": "2020-03-04T12:21:25Z", "message": "[KEYCLOAK-12192] - Missing Input Validation in IDP Authorization URLs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NzM3NTE3", "url": "https://github.com/keycloak/keycloak/pull/6846#pullrequestreview-368737517", "createdAt": "2020-03-04T12:30:26Z", "commit": {"oid": "b41419151f31d34bd987a72faf386a98606b7589"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b41419151f31d34bd987a72faf386a98606b7589", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/b41419151f31d34bd987a72faf386a98606b7589", "committedDate": "2020-03-04T12:21:25Z", "message": "[KEYCLOAK-12192] - Missing Input Validation in IDP Authorization URLs"}, "afterCommit": {"oid": "06d8bc66bb022642d8ef11b12c9dfb4ffc078e27", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/06d8bc66bb022642d8ef11b12c9dfb4ffc078e27", "committedDate": "2020-03-04T19:22:13Z", "message": "[KEYCLOAK-12192] - Missing Input Validation in IDP Authorization URLs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fde518a5cfbd647f06ac1132b5a75b6a5b60dfe6", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/fde518a5cfbd647f06ac1132b5a75b6a5b60dfe6", "committedDate": "2020-03-04T21:22:15Z", "message": "[KEYCLOAK-12192] - Missing Input Validation in IDP Authorization URLs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "06d8bc66bb022642d8ef11b12c9dfb4ffc078e27", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/06d8bc66bb022642d8ef11b12c9dfb4ffc078e27", "committedDate": "2020-03-04T19:22:13Z", "message": "[KEYCLOAK-12192] - Missing Input Validation in IDP Authorization URLs"}, "afterCommit": {"oid": "fde518a5cfbd647f06ac1132b5a75b6a5b60dfe6", "author": {"user": {"login": "pedroigor", "name": "Pedro Igor"}}, "url": "https://github.com/keycloak/keycloak/commit/fde518a5cfbd647f06ac1132b5a75b6a5b60dfe6", "committedDate": "2020-03-04T21:22:15Z", "message": "[KEYCLOAK-12192] - Missing Input Validation in IDP Authorization URLs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MzA0MjA4", "url": "https://github.com/keycloak/keycloak/pull/6846#pullrequestreview-369304208", "createdAt": "2020-03-05T05:32:25Z", "commit": {"oid": "fde518a5cfbd647f06ac1132b5a75b6a5b60dfe6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2555, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}