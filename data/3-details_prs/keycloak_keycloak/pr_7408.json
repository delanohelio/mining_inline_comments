{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0MDI0NTY4", "number": 7408, "title": "KEYCLOAK-9874 include realm and client roles in user info response", "bodyText": "This fixes the bug that roles can not be included to the user info endpoint with their default claim names.", "createdAt": "2020-09-10T15:46:46Z", "url": "https://github.com/keycloak/keycloak/pull/7408", "merged": true, "mergeCommit": {"oid": "f874e9a43ca9b4f35ed21c234e4db480d8da9f6f"}, "closed": true, "closedAt": "2020-09-16T08:01:03Z", "author": {"login": "benjamin37"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHvj3UgBqjM3NTQ1ODQyNTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJXuRtgFqTQ4OTM3MDk1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "895f658d01f26489d4376885aefcfed22c25844a", "author": {"user": {"login": "benjamin37", "name": "Benjamin Weimer"}}, "url": "https://github.com/keycloak/keycloak/commit/895f658d01f26489d4376885aefcfed22c25844a", "committedDate": "2020-09-10T15:45:22Z", "message": "KEYCLOAK-9874 include realm and client roles in user info response"}, "afterCommit": {"oid": "1d354f4cc52657568808016811bb8ae6a3a57b7a", "author": {"user": {"login": "benjamin37", "name": "Benjamin Weimer"}}, "url": "https://github.com/keycloak/keycloak/commit/1d354f4cc52657568808016811bb8ae6a3a57b7a", "committedDate": "2020-09-11T06:37:53Z", "message": "KEYCLOAK-9874 include realm and client roles in user info response"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NDM0NTYy", "url": "https://github.com/keycloak/keycloak/pull/7408#pullrequestreview-487434562", "createdAt": "2020-09-14T05:58:03Z", "commit": {"oid": "1d354f4cc52657568808016811bb8ae6a3a57b7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNTo1ODowM1rOHRE3IA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNTo1ODowM1rOHRE3IA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY2NzQ4OA==", "bodyText": "Looks like a workaround to me and not a proper fix. Roles should be added by protocol mappers and not hardcoded here.", "url": "https://github.com/keycloak/keycloak/pull/7408#discussion_r487667488", "createdAt": "2020-09-14T05:58:03Z", "author": {"login": "stianst"}, "path": "services/src/main/java/org/keycloak/protocol/oidc/endpoints/UserInfoEndpoint.java", "diffHunk": "@@ -225,6 +226,24 @@ private Response issueUserInfo(String tokenString) {\n         // any attempt to customize the value of this field should be done through a different claim\n         claims.put(\"sub\", userInfo.getSubject());\n \n+        if (userInfo.getRealmAccess() != null) {\n+            Map<String, Set<String>> realmAccess = new HashMap<>();\n+            realmAccess.put(\"roles\", userInfo.getRealmAccess().getRoles());\n+            claims.put(\"realm_access\", realmAccess);\n+        }\n+\n+        if (userInfo.getResourceAccess() != null && !userInfo.getResourceAccess().isEmpty()) {\n+            Map<String, Map<String, Set<String>>> resourceAccessMap = new HashMap<>();\n+\n+            for (Map.Entry<String, AccessToken.Access> resourceAccessMapEntry : userInfo.getResourceAccess()\n+                    .entrySet()) {\n+                Map<String, Set<String>> resourceAccess = new HashMap<>();\n+                resourceAccess.put(\"roles\", resourceAccessMapEntry.getValue().getRoles());\n+                resourceAccessMap.put(resourceAccessMapEntry.getKey(), resourceAccess);\n+            }\n+            claims.put(\"resource_access\", resourceAccessMap);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d354f4cc52657568808016811bb8ae6a3a57b7a"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NTA4MjIx", "url": "https://github.com/keycloak/keycloak/pull/7408#pullrequestreview-487508221", "createdAt": "2020-09-14T08:00:32Z", "commit": {"oid": "1d354f4cc52657568808016811bb8ae6a3a57b7a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1d354f4cc52657568808016811bb8ae6a3a57b7a", "author": {"user": {"login": "benjamin37", "name": "Benjamin Weimer"}}, "url": "https://github.com/keycloak/keycloak/commit/1d354f4cc52657568808016811bb8ae6a3a57b7a", "committedDate": "2020-09-11T06:37:53Z", "message": "KEYCLOAK-9874 include realm and client roles in user info response"}, "afterCommit": {"oid": "766b8ebada492b5801993f14f0507d8d7a4ac0d9", "author": {"user": {"login": "benjamin37", "name": "Benjamin Weimer"}}, "url": "https://github.com/keycloak/keycloak/commit/766b8ebada492b5801993f14f0507d8d7a4ac0d9", "committedDate": "2020-09-14T08:16:23Z", "message": "KEYCLOAK-9874 include realm and client roles in user info response"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "766b8ebada492b5801993f14f0507d8d7a4ac0d9", "author": {"user": {"login": "benjamin37", "name": "Benjamin Weimer"}}, "url": "https://github.com/keycloak/keycloak/commit/766b8ebada492b5801993f14f0507d8d7a4ac0d9", "committedDate": "2020-09-14T08:16:23Z", "message": "KEYCLOAK-9874 include realm and client roles in user info response"}, "afterCommit": {"oid": "ed0b29f9054a3911e862f32fd2f6c2d56e18c5d6", "author": {"user": {"login": "benjamin37", "name": "Benjamin Weimer"}}, "url": "https://github.com/keycloak/keycloak/commit/ed0b29f9054a3911e862f32fd2f6c2d56e18c5d6", "committedDate": "2020-09-14T09:43:04Z", "message": "KEYCLOAK-9874 include realm and client roles in user info response"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MDM5MjM5", "url": "https://github.com/keycloak/keycloak/pull/7408#pullrequestreview-488039239", "createdAt": "2020-09-14T18:33:08Z", "commit": {"oid": "ed0b29f9054a3911e862f32fd2f6c2d56e18c5d6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxODozMzowOVrOHRhrxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxODozMzowOVrOHRhrxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODEzOTcxOA==", "bodyText": "Is it possible to merge methods includeRolesInUserInfoEndpoint and excludeRolesInUserInfoEndpoint into single method with the boolean parameter? Something like:\nprivate void switchIncludeRolesInUserInfoEndpoint(boolean includeRoles)\n\nThis should avoid some code duplications as both methods are quite similar (with the exception of true/false when switching INCLUDE_IN_USERINFO flag).", "url": "https://github.com/keycloak/keycloak/pull/7408#discussion_r488139718", "createdAt": "2020-09-14T18:33:09Z", "author": {"login": "mposolda"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/oidc/UserInfoTest.java", "diffHunk": "@@ -675,4 +703,73 @@ private void testSuccessSignedResponse(Algorithm sigAlg) throws Exception {\n \n         return tokenResponse;\n     }\n+\n+    private void includeRolesInUserInfoEndpoint() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed0b29f9054a3911e862f32fd2f6c2d56e18c5d6"}, "originalPosition": 98}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f276bb6af67ecd53301515cc1ab98a0585283f6", "author": {"user": {"login": "benjamin37", "name": "Benjamin Weimer"}}, "url": "https://github.com/keycloak/keycloak/commit/1f276bb6af67ecd53301515cc1ab98a0585283f6", "committedDate": "2020-09-15T06:23:55Z", "message": "KEYCLOAK-9874 include realm and client roles in user info response"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed0b29f9054a3911e862f32fd2f6c2d56e18c5d6", "author": {"user": {"login": "benjamin37", "name": "Benjamin Weimer"}}, "url": "https://github.com/keycloak/keycloak/commit/ed0b29f9054a3911e862f32fd2f6c2d56e18c5d6", "committedDate": "2020-09-14T09:43:04Z", "message": "KEYCLOAK-9874 include realm and client roles in user info response"}, "afterCommit": {"oid": "1f276bb6af67ecd53301515cc1ab98a0585283f6", "author": {"user": {"login": "benjamin37", "name": "Benjamin Weimer"}}, "url": "https://github.com/keycloak/keycloak/commit/1f276bb6af67ecd53301515cc1ab98a0585283f6", "committedDate": "2020-09-15T06:23:55Z", "message": "KEYCLOAK-9874 include realm and client roles in user info response"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MzcwOTU2", "url": "https://github.com/keycloak/keycloak/pull/7408#pullrequestreview-489370956", "createdAt": "2020-09-16T08:00:56Z", "commit": {"oid": "1f276bb6af67ecd53301515cc1ab98a0585283f6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2809, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}