{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzMDUzNDEx", "number": 6658, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMzoxNToxN1rODYf5pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDoyNjo0MVrODYhS-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3MDE1MDc4OnYy", "diffSide": "RIGHT", "path": "adapters/oidc/js/src/main/resources/login-status-iframe.html", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMzoxNToxOFrOFeY6zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNToxNjo0MVrOFec8AQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQwOTg3MQ==", "bodyText": "There is no need to re-assign cookie here, instead the result of getCookieByName('KEYCLOAK_SESSION_LEGACY') can be returned immediately.", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367409871", "createdAt": "2020-01-16T13:15:18Z", "author": {"login": "jonkoops"}, "path": "adapters/oidc/js/src/main/resources/login-status-iframe.html", "diffHunk": "@@ -81,7 +81,16 @@\n \n     function getCookie()\n     {\n-        var name = 'KEYCLOAK_SESSION=';\n+        var cookie = getCookieByName('KEYCLOAK_SESSION');\n+        if (cookie === null) {\n+            cookie = getCookieByName('KEYCLOAK_SESSION_LEGACY');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16302ca08fa20eeb2f739907db306196b0156fd2"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQyNjk3NA==", "bodyText": "@jonkoops The legacy cookie is basically the same cookie as we set before this PR, i.e. it doesn't have the SameSite attribute. Chrome >80 won't send cookies in iframes that have no SameSite attribute set (which defaults to SameSite=Lax). In other words Chrome won't see the legacy cookie and at the same time some other browsers \u2013 especially older Apple browsers \u2013 reject the non-legacy cookie, so they see only the legacy cookie.", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367426974", "createdAt": "2020-01-16T13:51:10Z", "author": {"login": "vmuzikar"}, "path": "adapters/oidc/js/src/main/resources/login-status-iframe.html", "diffHunk": "@@ -81,7 +81,16 @@\n \n     function getCookie()\n     {\n-        var name = 'KEYCLOAK_SESSION=';\n+        var cookie = getCookieByName('KEYCLOAK_SESSION');\n+        if (cookie === null) {\n+            cookie = getCookieByName('KEYCLOAK_SESSION_LEGACY');", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQwOTg3MQ=="}, "originalCommit": {"oid": "16302ca08fa20eeb2f739907db306196b0156fd2"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQyOTA3OA==", "bodyText": "Yes, that I understand. I meant that this code could be written as follows:\nvar cookie = getCookieByName('KEYCLOAK_SESSION');\n\nif (cookie === null) {\n  return getCookieByName('KEYCLOAK_SESSION_LEGACY');\n}\n\nreturn cookie;", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367429078", "createdAt": "2020-01-16T13:55:13Z", "author": {"login": "jonkoops"}, "path": "adapters/oidc/js/src/main/resources/login-status-iframe.html", "diffHunk": "@@ -81,7 +81,16 @@\n \n     function getCookie()\n     {\n-        var name = 'KEYCLOAK_SESSION=';\n+        var cookie = getCookieByName('KEYCLOAK_SESSION');\n+        if (cookie === null) {\n+            cookie = getCookieByName('KEYCLOAK_SESSION_LEGACY');", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQwOTg3MQ=="}, "originalCommit": {"oid": "16302ca08fa20eeb2f739907db306196b0156fd2"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ1ODExMQ==", "bodyText": "@jonkoops I'm sorry, I got it wrong the first time. You're correct, technically there's no need to re-assign the variable. But to me it seems more clear to have only one return but I don't really insist on it. Do you think this impacts performance?", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367458111", "createdAt": "2020-01-16T14:47:24Z", "author": {"login": "vmuzikar"}, "path": "adapters/oidc/js/src/main/resources/login-status-iframe.html", "diffHunk": "@@ -81,7 +81,16 @@\n \n     function getCookie()\n     {\n-        var name = 'KEYCLOAK_SESSION=';\n+        var cookie = getCookieByName('KEYCLOAK_SESSION');\n+        if (cookie === null) {\n+            cookie = getCookieByName('KEYCLOAK_SESSION_LEGACY');", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQwOTg3MQ=="}, "originalCommit": {"oid": "16302ca08fa20eeb2f739907db306196b0156fd2"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2MjEzMA==", "bodyText": "No apology needed, hahah. It's a code-style thing, so I would not worry about it too much.\nIn the JavaScript community early returns are generally preferred over re-assigning a variable. This is emphasised by the preferred usage of const over var and  let in modern codebases, which is inherently not able to be re-assigned.", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367462130", "createdAt": "2020-01-16T14:54:10Z", "author": {"login": "jonkoops"}, "path": "adapters/oidc/js/src/main/resources/login-status-iframe.html", "diffHunk": "@@ -81,7 +81,16 @@\n \n     function getCookie()\n     {\n-        var name = 'KEYCLOAK_SESSION=';\n+        var cookie = getCookieByName('KEYCLOAK_SESSION');\n+        if (cookie === null) {\n+            cookie = getCookieByName('KEYCLOAK_SESSION_LEGACY');", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQwOTg3MQ=="}, "originalCommit": {"oid": "16302ca08fa20eeb2f739907db306196b0156fd2"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ3NTcxMw==", "bodyText": "Ok, fair enough. ;) Updated per your suggestion.", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367475713", "createdAt": "2020-01-16T15:16:41Z", "author": {"login": "vmuzikar"}, "path": "adapters/oidc/js/src/main/resources/login-status-iframe.html", "diffHunk": "@@ -81,7 +81,16 @@\n \n     function getCookie()\n     {\n-        var name = 'KEYCLOAK_SESSION=';\n+        var cookie = getCookieByName('KEYCLOAK_SESSION');\n+        if (cookie === null) {\n+            cookie = getCookieByName('KEYCLOAK_SESSION_LEGACY');", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQwOTg3MQ=="}, "originalCommit": {"oid": "16302ca08fa20eeb2f739907db306196b0156fd2"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3MDI2OTE5OnYy", "diffSide": "RIGHT", "path": "adapters/oidc/js/src/main/resources/login-status-iframe.html", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMzo1NDowMVrOFeaDcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDo0NDozNVrOFebxBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQyODQ2Ng==", "bodyText": "Where does this value end up being used? Are we sure this separator doesn't accidentally break other code that depends on the structure of the value somewhere else?", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367428466", "createdAt": "2020-01-16T13:54:01Z", "author": {"login": "jonkoops"}, "path": "adapters/oidc/js/src/main/resources/login-status-iframe.html", "diffHunk": "@@ -81,7 +81,16 @@\n \n     function getCookie()\n     {\n-        var name = 'KEYCLOAK_SESSION=';\n+        var cookie = getCookieByName('KEYCLOAK_SESSION');\n+        if (cookie === null) {\n+            cookie = getCookieByName('KEYCLOAK_SESSION_LEGACY');\n+        }\n+        return cookie;\n+    }\n+\n+    function getCookieByName(name)\n+    {\n+        name = name + '=';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16302ca08fa20eeb2f739907db306196b0156fd2"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ1NTA1MA==", "bodyText": "If you mean the separator =, we used that before so I didn't want to change that.\n\n  \n    \n      keycloak/adapters/oidc/js/src/main/resources/login-status-iframe.html\n    \n    \n         Line 84\n      in\n      05c428f\n    \n    \n    \n    \n\n        \n          \n           var name = 'KEYCLOAK_SESSION=';", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367455050", "createdAt": "2020-01-16T14:42:20Z", "author": {"login": "vmuzikar"}, "path": "adapters/oidc/js/src/main/resources/login-status-iframe.html", "diffHunk": "@@ -81,7 +81,16 @@\n \n     function getCookie()\n     {\n-        var name = 'KEYCLOAK_SESSION=';\n+        var cookie = getCookieByName('KEYCLOAK_SESSION');\n+        if (cookie === null) {\n+            cookie = getCookieByName('KEYCLOAK_SESSION_LEGACY');\n+        }\n+        return cookie;\n+    }\n+\n+    function getCookieByName(name)\n+    {\n+        name = name + '=';", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQyODQ2Ng=="}, "originalCommit": {"oid": "16302ca08fa20eeb2f739907db306196b0156fd2"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ1NjUxNg==", "bodyText": "Ah, yes I see now. My diff was messed up, thanks for clarifying.", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367456516", "createdAt": "2020-01-16T14:44:35Z", "author": {"login": "jonkoops"}, "path": "adapters/oidc/js/src/main/resources/login-status-iframe.html", "diffHunk": "@@ -81,7 +81,16 @@\n \n     function getCookie()\n     {\n-        var name = 'KEYCLOAK_SESSION=';\n+        var cookie = getCookieByName('KEYCLOAK_SESSION');\n+        if (cookie === null) {\n+            cookie = getCookieByName('KEYCLOAK_SESSION_LEGACY');\n+        }\n+        return cookie;\n+    }\n+\n+    function getCookieByName(name)\n+    {\n+        name = name + '=';", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQyODQ2Ng=="}, "originalCommit": {"oid": "16302ca08fa20eeb2f739907db306196b0156fd2"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3MDMyODcxOnYy", "diffSide": "RIGHT", "path": "common/src/main/java/org/keycloak/common/util/ServerCookie.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDoxMjoyMlrOFeao8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDoxODowM1rOFea0gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQzODA2Ng==", "bodyText": "If we only support NONE at the moment, I'd rather to make it a constant and not advertise LAX or STRICT in the code.", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367438066", "createdAt": "2020-01-16T14:12:22Z", "author": {"login": "abstractj"}, "path": "common/src/main/java/org/keycloak/common/util/ServerCookie.java", "diffHunk": "@@ -32,6 +32,22 @@\n     private static final String tspecials = \",; \";\n     private static final String tspecials2 = \"()<>@,;:\\\\\\\"/[]?={} \\t\";\n \n+    public enum SameSiteAttributeValue {\n+        NONE(\"None\"), // we currently support only SameSite=None; this might change in the future\n+        STRICT(\"Strict\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16302ca08fa20eeb2f739907db306196b0156fd2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0MTAyNg==", "bodyText": "@abstractj Done. (We actually had only the NONE value there at some point during the development. ;))", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367441026", "createdAt": "2020-01-16T14:18:03Z", "author": {"login": "vmuzikar"}, "path": "common/src/main/java/org/keycloak/common/util/ServerCookie.java", "diffHunk": "@@ -32,6 +32,22 @@\n     private static final String tspecials = \",; \";\n     private static final String tspecials2 = \"()<>@,;:\\\\\\\"/[]?={} \\t\";\n \n+    public enum SameSiteAttributeValue {\n+        NONE(\"None\"), // we currently support only SameSite=None; this might change in the future\n+        STRICT(\"Strict\"),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQzODA2Ng=="}, "originalCommit": {"oid": "16302ca08fa20eeb2f739907db306196b0156fd2"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3MDM3OTQ2OnYy", "diffSide": "RIGHT", "path": "common/src/main/java/org/keycloak/common/util/ServerCookie.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDoyNjo0MVrOFebHpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDo1MTowNVrOFeb_qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0NTkyNg==", "bodyText": "A minor nitpick, but StringBuilder is faster than StringBuffer, plus it seems that's our preferred choice into the codebase.", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367445926", "createdAt": "2020-01-16T14:26:41Z", "author": {"login": "abstractj"}, "path": "common/src/main/java/org/keycloak/common/util/ServerCookie.java", "diffHunk": "@@ -173,7 +187,8 @@ public static void appendCookieValue(StringBuffer headerBuf,\n                                          String comment,\n                                          int maxAge,\n                                          boolean isSecure,\n-                                         boolean httpOnly) {\n+                                         boolean httpOnly,\n+                                         SameSiteAttributeValue sameSite) {\n         StringBuffer buf = new StringBuffer();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "492c5c1348102ce04bd6ee83ec22e261bf629893"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0Njk3Ng==", "bodyText": "@abstractj It was like this before, I wanted to change as little things as possible so I haven't touched this. Do you want me to switch it for StringBuilder?", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367446976", "createdAt": "2020-01-16T14:28:30Z", "author": {"login": "vmuzikar"}, "path": "common/src/main/java/org/keycloak/common/util/ServerCookie.java", "diffHunk": "@@ -173,7 +187,8 @@ public static void appendCookieValue(StringBuffer headerBuf,\n                                          String comment,\n                                          int maxAge,\n                                          boolean isSecure,\n-                                         boolean httpOnly) {\n+                                         boolean httpOnly,\n+                                         SameSiteAttributeValue sameSite) {\n         StringBuffer buf = new StringBuffer();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0NTkyNg=="}, "originalCommit": {"oid": "492c5c1348102ce04bd6ee83ec22e261bf629893"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ2MDI2Nw==", "bodyText": "@vmuzikar I overlooked this. That's not a deal breaker, we can leave it as is.", "url": "https://github.com/keycloak/keycloak/pull/6658#discussion_r367460267", "createdAt": "2020-01-16T14:51:05Z", "author": {"login": "abstractj"}, "path": "common/src/main/java/org/keycloak/common/util/ServerCookie.java", "diffHunk": "@@ -173,7 +187,8 @@ public static void appendCookieValue(StringBuffer headerBuf,\n                                          String comment,\n                                          int maxAge,\n                                          boolean isSecure,\n-                                         boolean httpOnly) {\n+                                         boolean httpOnly,\n+                                         SameSiteAttributeValue sameSite) {\n         StringBuffer buf = new StringBuffer();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ0NTkyNg=="}, "originalCommit": {"oid": "492c5c1348102ce04bd6ee83ec22e261bf629893"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3939, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}