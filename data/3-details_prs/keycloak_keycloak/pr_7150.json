{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxMjQxMjA3", "number": 7150, "title": "KEYCLOAK-14412 Keycloak.js should honor configured default scopes when onload 'require-login' is used", "bodyText": "We now add the configured default scopes to the login url when onload 'require-login' is used.\nPreviously, the configured default scopes were ignored when when\nonLoad: 'login-required' is used in the Keycloak configuration.", "createdAt": "2020-06-08T15:58:55Z", "url": "https://github.com/keycloak/keycloak/pull/7150", "merged": true, "mergeCommit": {"oid": "d2060913be47659b6448c934e508ae15432f3195"}, "closed": true, "closedAt": "2021-03-11T16:03:09Z", "author": {"login": "thomasdarimont"}, "timelineItems": {"totalCount": 42, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpSpPjgFqTQyNjM4NzAzMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABeCIGy7AFqTYwOTkzMTI0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2Mzg3MDMx", "url": "https://github.com/keycloak/keycloak/pull/7150#pullrequestreview-426387031", "createdAt": "2020-06-08T16:00:18Z", "commit": {"oid": "6e8cad5ec62c12a7a36e2ac04842b5a61f05e309"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjowMDoxOFrOGglQpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjowMDoxOFrOGglQpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgxODA4NQ==", "bodyText": "If the current options already has a scope configured use that, otherwise use the scope that is configured on the kc (keycloak object) directly, if present.", "url": "https://github.com/keycloak/keycloak/pull/7150#discussion_r436818085", "createdAt": "2020-06-08T16:00:18Z", "author": {"login": "thomasdarimont"}, "path": "adapters/oidc/js/src/main/resources/keycloak.js", "diffHunk": "@@ -438,15 +438,13 @@\n                 baseUrl = kc.endpoints.authorize();\n             }\n \n-            var scope;\n-            if (options && options.scope) {\n-                if (options.scope.indexOf(\"openid\") != -1) {\n-                    scope = options.scope;\n-                } else {\n-                    scope = \"openid \" + options.scope;\n-                }\n-            } else {\n+            var scope = options && options.scope ? options.scope : kc.scope;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e8cad5ec62c12a7a36e2ac04842b5a61f05e309"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2Mzg4MTcz", "url": "https://github.com/keycloak/keycloak/pull/7150#pullrequestreview-426388173", "createdAt": "2020-06-08T16:01:31Z", "commit": {"oid": "6e8cad5ec62c12a7a36e2ac04842b5a61f05e309"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjowMTozMVrOGglT6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjowMTozMVrOGglT6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgxODkyMA==", "bodyText": "Store default scope from config object into keycloak instance as kc.scope", "url": "https://github.com/keycloak/keycloak/pull/7150#discussion_r436818920", "createdAt": "2020-06-08T16:01:31Z", "author": {"login": "thomasdarimont"}, "path": "adapters/oidc/js/src/main/resources/keycloak.js", "diffHunk": "@@ -825,6 +823,10 @@\n                 configUrl = 'keycloak.json';\n             } else if (typeof config === 'string') {\n                 configUrl = config;\n+            } else if (typeof config === \"object\") {\n+                if (config.scope) {\n+                    kc.scope = config.scope;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e8cad5ec62c12a7a36e2ac04842b5a61f05e309"}, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6e8cad5ec62c12a7a36e2ac04842b5a61f05e309", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/6e8cad5ec62c12a7a36e2ac04842b5a61f05e309", "committedDate": "2020-06-08T15:56:06Z", "message": "KEYCLOAK-14412 Keycloak.js should honor configured default scopes when onload 'require-login' is used\n\nWe now add the configured default scopes to the login url when onload 'require-login' is used.\nPreviously, the configured default scopes were ignored when when\nonLoad: 'login-required' is used in the Keycloak configuration."}, "afterCommit": {"oid": "5a8d8c97aca6ed39af638c81dff24ac6d9347ebe", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/5a8d8c97aca6ed39af638c81dff24ac6d9347ebe", "committedDate": "2020-06-08T16:06:34Z", "message": "KEYCLOAK-14412 Keycloak.js should honor configured default scopes when onload 'require-login' is used\n\nWe now add the configured default scopes to the login url when onload 'require-login' is used.\nPreviously, the configured default scopes were ignored when when\nonLoad: 'login-required' is used in the Keycloak configuration."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2ODQ0MjIx", "url": "https://github.com/keycloak/keycloak/pull/7150#pullrequestreview-426844221", "createdAt": "2020-06-09T07:06:23Z", "commit": {"oid": "5a8d8c97aca6ed39af638c81dff24ac6d9347ebe"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2ODg4OTY5", "url": "https://github.com/keycloak/keycloak/pull/7150#pullrequestreview-426888969", "createdAt": "2020-06-09T08:09:33Z", "commit": {"oid": "5a8d8c97aca6ed39af638c81dff24ac6d9347ebe"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5a8d8c97aca6ed39af638c81dff24ac6d9347ebe", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/5a8d8c97aca6ed39af638c81dff24ac6d9347ebe", "committedDate": "2020-06-08T16:06:34Z", "message": "KEYCLOAK-14412 Keycloak.js should honor configured default scopes when onload 'require-login' is used\n\nWe now add the configured default scopes to the login url when onload 'require-login' is used.\nPreviously, the configured default scopes were ignored when when\nonLoad: 'login-required' is used in the Keycloak configuration."}, "afterCommit": {"oid": "0ce69d0a92478970609c53eaba79e9bb097e7ecf", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/0ce69d0a92478970609c53eaba79e9bb097e7ecf", "committedDate": "2020-06-11T09:56:51Z", "message": "KEYCLOAK-14412 Keycloak.js should honor configured default scopes when onload 'require-login' is used\n\nWe now add the configured default scopes to the login url when onload 'require-login' is used.\nPreviously, the configured default scopes were ignored when when\nonLoad: 'login-required' is used in the Keycloak configuration."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MDEyNzEy", "url": "https://github.com/keycloak/keycloak/pull/7150#pullrequestreview-429012712", "createdAt": "2020-06-11T15:15:13Z", "commit": {"oid": "0ce69d0a92478970609c53eaba79e9bb097e7ecf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNToxNToxM1rOGih9Fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxNToxNToxM1rOGih9Fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg2MTA3OQ==", "bodyText": "Be carefull here as typeof null === \"object\" as well.", "url": "https://github.com/keycloak/keycloak/pull/7150#discussion_r438861079", "createdAt": "2020-06-11T15:15:13Z", "author": {"login": "jonkoops"}, "path": "adapters/oidc/js/src/main/resources/keycloak.js", "diffHunk": "@@ -825,6 +823,10 @@\n                 configUrl = 'keycloak.json';\n             } else if (typeof config === 'string') {\n                 configUrl = config;\n+            } else if (typeof config === \"object\") {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ce69d0a92478970609c53eaba79e9bb097e7ecf"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMTM5ODE0", "url": "https://github.com/keycloak/keycloak/pull/7150#pullrequestreview-430139814", "createdAt": "2020-06-13T13:32:22Z", "commit": {"oid": "0ce69d0a92478970609c53eaba79e9bb097e7ecf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QxMzozMjoyMlrOGjXk8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xM1QxNDoxNDoxNlrOGjXu2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTczOTYzNA==", "bodyText": "I think this can do the same without using a ternary operation here.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        var scope = options && options.scope ? options.scope : kc.scope;\n          \n          \n            \n                        var scope = options && options.scope || kc.scope;\n          \n      \n    \n    \n  \n\nIt also looks like we can access the config passed into the constructor directly here so we don't need the kc.scope member.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        var scope = options && options.scope ? options.scope : kc.scope;\n          \n          \n            \n                        var scope = options && options.scope || config.scope;", "url": "https://github.com/keycloak/keycloak/pull/7150#discussion_r439739634", "createdAt": "2020-06-13T13:32:22Z", "author": {"login": "jonkoops"}, "path": "adapters/oidc/js/src/main/resources/keycloak.js", "diffHunk": "@@ -438,15 +438,13 @@\n                 baseUrl = kc.endpoints.authorize();\n             }\n \n-            var scope;\n-            if (options && options.scope) {\n-                if (options.scope.indexOf(\"openid\") != -1) {\n-                    scope = options.scope;\n-                } else {\n-                    scope = \"openid \" + options.scope;\n-                }\n-            } else {\n+            var scope = options && options.scope ? options.scope : kc.scope;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ce69d0a92478970609c53eaba79e9bb097e7ecf"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc0MjE2OQ==", "bodyText": "If we're going to make these changes we also need to make sure that the TypeScript definitions are updated.\nThe JSDoc on the scope field on the KeycloakLoginOptions interface must no longer be private and include some descriptive text for the field itself.\nAnd we'll have to add the same scope field to the KeycloakConfig interface which is used for the configuration passed into the constructor.", "url": "https://github.com/keycloak/keycloak/pull/7150#discussion_r439742169", "createdAt": "2020-06-13T14:14:16Z", "author": {"login": "jonkoops"}, "path": "adapters/oidc/js/src/main/resources/keycloak.js", "diffHunk": "@@ -438,15 +438,13 @@\n                 baseUrl = kc.endpoints.authorize();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ce69d0a92478970609c53eaba79e9bb097e7ecf"}, "originalPosition": 1}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "80d33aedf311146b7f8a20546b5d7247df4fd65b", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/80d33aedf311146b7f8a20546b5d7247df4fd65b", "committedDate": "2020-06-15T21:56:06Z", "message": "KEYCLOAK-14412 Keycloak.js should honor configured default scopes when onload 'require-login' is used\n\nAdd support for passing scope to login URL creation from:\n- Configuration derived from `Keycloak.json`\n- Explicit keycloak configuration via `new Keycloak({...,scope:\"...\"})`\n- Keycloak init via `keycloak.init({...,scope:\"...\"})`"}, "afterCommit": {"oid": "b161a68c50908d8d2744d437430369f2565077cd", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/b161a68c50908d8d2744d437430369f2565077cd", "committedDate": "2020-06-15T21:59:22Z", "message": "KEYCLOAK-14412 Keycloak.js should honor configured default scopes when onload 'require-login' is used\n\nAdd support for passing scope to login URL creation from:\n- Configuration derived from `Keycloak.json`\n- Explicit keycloak configuration via `new Keycloak({...,scope:\"...\"})`\n- Keycloak init via `keycloak.init({...,scope:\"...\"})`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMDI2MzAw", "url": "https://github.com/keycloak/keycloak/pull/7150#pullrequestreview-431026300", "createdAt": "2020-06-15T22:06:10Z", "commit": {"oid": "b161a68c50908d8d2744d437430369f2565077cd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMjowNjoxMFrOGkEXMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMjowNjoxMFrOGkEXMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ3MzM5NA==", "bodyText": "we check the scope parameter for:\n\noptions are the login options\nkc.scope potentially derived from keycloak.json\nconfig.scope the explicit keycloak configuration.", "url": "https://github.com/keycloak/keycloak/pull/7150#discussion_r440473394", "createdAt": "2020-06-15T22:06:10Z", "author": {"login": "thomasdarimont"}, "path": "adapters/oidc/js/src/main/resources/keycloak.js", "diffHunk": "@@ -432,21 +436,19 @@\n             }\n \n             var baseUrl;\n-            if (options && options.action == 'register') {\n+            if (options && options.action === 'register') {\n                 baseUrl = kc.endpoints.register();\n             } else {\n                 baseUrl = kc.endpoints.authorize();\n             }\n \n-            var scope;\n-            if (options && options.scope) {\n-                if (options.scope.indexOf(\"openid\") != -1) {\n-                    scope = options.scope;\n-                } else {\n-                    scope = \"openid \" + options.scope;\n-                }\n-            } else {\n+            var scope = options && options.scope || kc.scope || config.scope;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b161a68c50908d8d2744d437430369f2565077cd"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNzcxMzA2", "url": "https://github.com/keycloak/keycloak/pull/7150#pullrequestreview-431771306", "createdAt": "2020-06-16T18:13:50Z", "commit": {"oid": "b161a68c50908d8d2744d437430369f2565077cd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxODoxMzo1MVrOGknbXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxODoyMzoyNFrOGkn5LA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0NzkwMw==", "bodyText": "Do we need the scope parameter in both KeycloakConfig and KeycloakInitOptions? KeycloakConfig is an equivalent of AdapterConfig class for Java adapters and it contains no scope parameter, so I would prefer to remove it, WDYT?", "url": "https://github.com/keycloak/keycloak/pull/7150#discussion_r441047903", "createdAt": "2020-06-16T18:13:51Z", "author": {"login": "mhajas"}, "path": "adapters/oidc/js/src/main/resources/keycloak.d.ts", "diffHunk": "@@ -49,9 +49,22 @@ declare namespace Keycloak {\n \t\t * Client identifier, example: 'myapp'\r\n \t\t */\r\n \t\tclientId: string;\r\n+\r\n+\t\t/**\r\n+\t\t * Scope to use for the 'scope' login url parameter.\r\n+\t\t * The scope 'openid' will be added to the scope if it is missing or undefined.\r\n+\t\t */\r\n+\t\tscope?: string;\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b161a68c50908d8d2744d437430369f2565077cd"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1MTA2MA==", "bodyText": "If I am not mistaken, before this line, you can do also something like that.\nassertThat(jsDriver.getCurrentUrl(), constainsString(\"&scope=profile email phone\"))", "url": "https://github.com/keycloak/keycloak/pull/7150#discussion_r441051060", "createdAt": "2020-06-16T18:18:16Z", "author": {"login": "mhajas"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/javascript/JavascriptAdapterTest.java", "diffHunk": "@@ -400,6 +397,69 @@ public void loginRequiredAction() {\n                 .init(defaultArguments(), this::assertSuccessfullyLoggedIn);\n     }\n \n+    /**\n+     * Test for scope handling via explicit Keycloak configuration: <pre>{@code\n+     * new Keycloak({.... scope: \"profile email phone\"})\n+     * }</pre>\n+     * See KEYCLOAK-14412\n+     */\n+    @Test\n+    public void testOnLoadRequireLoginShouldHonorScopes() {\n+\n+        JSObjectBuilder config = JSObjectBuilder.create()\n+                .add(\"url\", authServerContextRootPage + \"/auth\")\n+                .add(\"realm\", REALM_NAME)\n+                .add(\"clientId\", CLIENT_ID)\n+                .add(\"scope\", \"profile email phone\") // phone is optional client scope\n+                ;\n+\n+        JSObjectBuilder initOptions = defaultArguments().loginRequiredOnLoad();\n+\n+        try {\n+            testExecutor.configure(config)\n+                        .init(initOptions);\n+            // This throws exception because when JavascriptExecutor waits for AsyncScript to finish\n+            // it is redirected to login page and executor gets no response\n+\n+            throw new RuntimeException(\"Probably the login-required OnLoad mode doesn't work, because testExecutor should fail with error that page was redirected.\");\n+        } catch (WebDriverException ex) {\n+            // should happen\n+        }\n+\n+        testExecutor.loginForm(testUser, this::assertOnTestAppUrl)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b161a68c50908d8d2744d437430369f2565077cd"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1NDAwNg==", "bodyText": "This doesn't need to be async script, it is used if we need an output from asynchronous function, in this case you can use simple return like this:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    .executeAsyncScript(\"var callback = arguments[arguments.length - 1];\" +\n          \n          \n            \n                   .executeScript(\"return window.keycloak.tokenParsed.scope\", assertOutputContains(\"phone\"));", "url": "https://github.com/keycloak/keycloak/pull/7150#discussion_r441054006", "createdAt": "2020-06-16T18:21:35Z", "author": {"login": "mhajas"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/javascript/JavascriptAdapterTest.java", "diffHunk": "@@ -400,6 +397,69 @@ public void loginRequiredAction() {\n                 .init(defaultArguments(), this::assertSuccessfullyLoggedIn);\n     }\n \n+    /**\n+     * Test for scope handling via explicit Keycloak configuration: <pre>{@code\n+     * new Keycloak({.... scope: \"profile email phone\"})\n+     * }</pre>\n+     * See KEYCLOAK-14412\n+     */\n+    @Test\n+    public void testOnLoadRequireLoginShouldHonorScopes() {\n+\n+        JSObjectBuilder config = JSObjectBuilder.create()\n+                .add(\"url\", authServerContextRootPage + \"/auth\")\n+                .add(\"realm\", REALM_NAME)\n+                .add(\"clientId\", CLIENT_ID)\n+                .add(\"scope\", \"profile email phone\") // phone is optional client scope\n+                ;\n+\n+        JSObjectBuilder initOptions = defaultArguments().loginRequiredOnLoad();\n+\n+        try {\n+            testExecutor.configure(config)\n+                        .init(initOptions);\n+            // This throws exception because when JavascriptExecutor waits for AsyncScript to finish\n+            // it is redirected to login page and executor gets no response\n+\n+            throw new RuntimeException(\"Probably the login-required OnLoad mode doesn't work, because testExecutor should fail with error that page was redirected.\");\n+        } catch (WebDriverException ex) {\n+            // should happen\n+        }\n+\n+        testExecutor.loginForm(testUser, this::assertOnTestAppUrl)\n+                .init(initOptions, this::assertSuccessfullyLoggedIn)\n+        .executeAsyncScript(\"var callback = arguments[arguments.length - 1];\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b161a68c50908d8d2744d437430369f2565077cd"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA1NTUzMg==", "bodyText": "Could you add a test also for the init function?", "url": "https://github.com/keycloak/keycloak/pull/7150#discussion_r441055532", "createdAt": "2020-06-16T18:23:24Z", "author": {"login": "mhajas"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/javascript/JavascriptAdapterTest.java", "diffHunk": "@@ -400,6 +397,69 @@ public void loginRequiredAction() {\n                 .init(defaultArguments(), this::assertSuccessfullyLoggedIn);\n     }\n \n+    /**\n+     * Test for scope handling via explicit Keycloak configuration: <pre>{@code\n+     * new Keycloak({.... scope: \"profile email phone\"})\n+     * }</pre>\n+     * See KEYCLOAK-14412\n+     */\n+    @Test\n+    public void testOnLoadRequireLoginShouldHonorScopes() {\n+\n+        JSObjectBuilder config = JSObjectBuilder.create()\n+                .add(\"url\", authServerContextRootPage + \"/auth\")\n+                .add(\"realm\", REALM_NAME)\n+                .add(\"clientId\", CLIENT_ID)\n+                .add(\"scope\", \"profile email phone\") // phone is optional client scope\n+                ;\n+\n+        JSObjectBuilder initOptions = defaultArguments().loginRequiredOnLoad();\n+\n+        try {\n+            testExecutor.configure(config)\n+                        .init(initOptions);\n+            // This throws exception because when JavascriptExecutor waits for AsyncScript to finish\n+            // it is redirected to login page and executor gets no response\n+\n+            throw new RuntimeException(\"Probably the login-required OnLoad mode doesn't work, because testExecutor should fail with error that page was redirected.\");\n+        } catch (WebDriverException ex) {\n+            // should happen\n+        }\n+\n+        testExecutor.loginForm(testUser, this::assertOnTestAppUrl)\n+                .init(initOptions, this::assertSuccessfullyLoggedIn)\n+        .executeAsyncScript(\"var callback = arguments[arguments.length - 1];\" +\n+                \"callback(window.keycloak.tokenParsed.scope)\", assertOutputContains(\"phone\"));\n+    }\n+\n+    /**\n+     * Test for scope handling via Keycloak configuration from {@code keycloak.json} : <pre>{@code\n+     * new Keycloak() -> keycloak.json {.... \"scope\": \"profile email phone\"}\n+     * }</pre>\n+     * See KEYCLOAK-14412\n+     */\n+    @Test // TODO findout why this test fails\n+    public void testConfigFromKeycloakJsonShouldHonorScopes() {\n+\n+        JSObjectBuilder initOptions = defaultArguments().loginRequiredOnLoad();\n+\n+        try {\n+            testExecutor.configure() // use keycloak.json from testsuite/integration-arquillian/servers/auth-server/services/testsuite-providers/src/main/resources/javascript/keycloak.json\n+                    .init(initOptions);\n+            // This throws exception because when JavascriptExecutor waits for AsyncScript to finish\n+            // it is redirected to login page and executor gets no response\n+\n+            throw new RuntimeException(\"Probably the login-required OnLoad mode doesn't work, because testExecutor should fail with error that page was redirected.\");\n+        } catch (WebDriverException ex) {\n+            // should happen\n+        }\n+\n+        testExecutor.loginForm(testUser, this::assertOnTestAppUrl)\n+                .init(initOptions, this::assertSuccessfullyLoggedIn)\n+                .executeAsyncScript(\"var callback = arguments[arguments.length - 1];\" +\n+                        \"callback(window.keycloak.tokenParsed.scope)\", assertOutputContains(\"phone\"));\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b161a68c50908d8d2744d437430369f2565077cd"}, "originalPosition": 83}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b161a68c50908d8d2744d437430369f2565077cd", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/b161a68c50908d8d2744d437430369f2565077cd", "committedDate": "2020-06-15T21:59:22Z", "message": "KEYCLOAK-14412 Keycloak.js should honor configured default scopes when onload 'require-login' is used\n\nAdd support for passing scope to login URL creation from:\n- Configuration derived from `Keycloak.json`\n- Explicit keycloak configuration via `new Keycloak({...,scope:\"...\"})`\n- Keycloak init via `keycloak.init({...,scope:\"...\"})`"}, "afterCommit": {"oid": "c19c0571fc4877569ec332ba4e9c8d573ce7b490", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/c19c0571fc4877569ec332ba4e9c8d573ce7b490", "committedDate": "2020-06-16T23:22:57Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c19c0571fc4877569ec332ba4e9c8d573ce7b490", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/c19c0571fc4877569ec332ba4e9c8d573ce7b490", "committedDate": "2020-06-16T23:22:57Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}, "afterCommit": {"oid": "4e3d80d3cee89ed2052d334c6ccb458293a2f676", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/4e3d80d3cee89ed2052d334c6ccb458293a2f676", "committedDate": "2020-06-16T23:26:02Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4e3d80d3cee89ed2052d334c6ccb458293a2f676", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/4e3d80d3cee89ed2052d334c6ccb458293a2f676", "committedDate": "2020-06-16T23:26:02Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}, "afterCommit": {"oid": "6ebef5a3432fb4ec09106b38dc65ebd7186da290", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/6ebef5a3432fb4ec09106b38dc65ebd7186da290", "committedDate": "2020-06-16T23:29:45Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6ebef5a3432fb4ec09106b38dc65ebd7186da290", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/6ebef5a3432fb4ec09106b38dc65ebd7186da290", "committedDate": "2020-06-16T23:29:45Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}, "afterCommit": {"oid": "7b7d4428104268fea1f61e8c9a17281c919e4e3b", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/7b7d4428104268fea1f61e8c9a17281c919e4e3b", "committedDate": "2020-06-16T23:30:28Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7b7d4428104268fea1f61e8c9a17281c919e4e3b", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/7b7d4428104268fea1f61e8c9a17281c919e4e3b", "committedDate": "2020-06-16T23:30:28Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}, "afterCommit": {"oid": "2c8ead9df393e4656106ee31a9d49338db5562a2", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/2c8ead9df393e4656106ee31a9d49338db5562a2", "committedDate": "2020-06-16T23:31:56Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMDk2Mzkz", "url": "https://github.com/keycloak/keycloak/pull/7150#pullrequestreview-432096393", "createdAt": "2020-06-17T06:34:17Z", "commit": {"oid": "2c8ead9df393e4656106ee31a9d49338db5562a2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNjozNDoxOFrOGk3gLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNjozNDoxOFrOGk3gLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMxMTI3OA==", "bodyText": "I think this is not necessary. kc.skope will be used within the login function directly.", "url": "https://github.com/keycloak/keycloak/pull/7150#discussion_r441311278", "createdAt": "2020-06-17T06:34:18Z", "author": {"login": "mhajas"}, "path": "adapters/oidc/js/src/main/resources/keycloak.js", "diffHunk": "@@ -276,6 +280,7 @@\n                 };\n \n                 var options = {};\n+                options.scope = kc.scope;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c8ead9df393e4656106ee31a9d49338db5562a2"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c8ead9df393e4656106ee31a9d49338db5562a2", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/2c8ead9df393e4656106ee31a9d49338db5562a2", "committedDate": "2020-06-16T23:31:56Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}, "afterCommit": {"oid": "282e86964e1736037d97ba59b58163a6053fc2a0", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/282e86964e1736037d97ba59b58163a6053fc2a0", "committedDate": "2020-06-17T06:46:51Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "282e86964e1736037d97ba59b58163a6053fc2a0", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/282e86964e1736037d97ba59b58163a6053fc2a0", "committedDate": "2020-06-17T06:46:51Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}, "afterCommit": {"oid": "8e29cc8dbe3b4fc7ec808fb2570cd34618d6270c", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/8e29cc8dbe3b4fc7ec808fb2570cd34618d6270c", "committedDate": "2020-06-17T06:50:41Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMTA2Njk0", "url": "https://github.com/keycloak/keycloak/pull/7150#pullrequestreview-432106694", "createdAt": "2020-06-17T06:53:32Z", "commit": {"oid": "2c8ead9df393e4656106ee31a9d49338db5562a2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNjo1NDoyN1rOGk4B6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNjo1NDoyN1rOGk4B6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMxOTkxMw==", "bodyText": "The JavascriptAdapter tests are a little bit confusing in this. They are mixing two variable names driver and jsDriver. Out testsuite has two browsers because JS adapter doesn't work in Htmlunit, which is the default browser for majority of tests (it is default because it is fast). So we added jsDriver as the second browser, which defaults to Phantomjs. This browser is able to work with JS adapter.\nNow the JavascriptStateValidator is there for checking the state after some Javascript piece of code was executed. It has three parameters (driver, output, events). At the moment, the driver parameter is maybe a little bit redundant here as we always use jsDriver, but this can change in the future. So it would be better to use it here like this:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        assertThat(jsDriver.getCurrentUrl(), containsString(\"&scope=openid%20profile%20email%20phone\"));\n          \n          \n            \n                        assertThat(driver.getCurrentUrl(), containsString(\"&scope=openid%20profile%20email%20phone\"));\n          \n      \n    \n    \n  \n\nthis way you use a webdriver provided by testExecutor and function (in this case login()) can decide what browser to use for validating the condition.\nOne more thing, you don't need to use the testExecutor for everything, the jsDriver (do not use driver outside of) is available even outside of testExecutor and it is perfectly ok to use it.", "url": "https://github.com/keycloak/keycloak/pull/7150#discussion_r441319913", "createdAt": "2020-06-17T06:54:27Z", "author": {"login": "mhajas"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/javascript/JavascriptAdapterTest.java", "diffHunk": "@@ -400,6 +398,58 @@ public void loginRequiredAction() {\n                 .init(defaultArguments(), this::assertSuccessfullyLoggedIn);\n     }\n \n+    /**\n+     * Test for scope handling via {@code initOptions}: <pre>{@code\n+     * Keycloak keycloak = new Keycloak(); keycloak.init({.... scope: \"profile email phone\"})\n+     * }</pre>\n+     * See KEYCLOAK-14412\n+     */\n+    @Test\n+    public void testScopeInInitOptionsShouldBeConsideredByLoginUrl() {\n+\n+        JSObjectBuilder initOptions = defaultArguments()\n+                .loginRequiredOnLoad()\n+                // phone is optional client scope\n+                .add(\"scope\", \"profile email phone\");\n+\n+        try {\n+            testExecutor.init(initOptions);\n+            // This throws exception because when JavascriptExecutor waits for AsyncScript to finish\n+            // it is redirected to login page and executor gets no response\n+\n+            throw new RuntimeException(\"Probably the login-required OnLoad mode doesn't work, because testExecutor should fail with error that page was redirected.\");\n+        } catch (WebDriverException ex) {\n+            // should happen\n+        }\n+\n+        testExecutor.loginForm(testUser, this::assertOnTestAppUrl)\n+                .init(initOptions, this::assertSuccessfullyLoggedIn)\n+        .executeScript(\"return window.keycloak.tokenParsed.scope\", assertOutputContains(\"phone\"));\n+    }\n+\n+    /**\n+     * Test for scope handling via {@code loginOptions}: <pre>{@code\n+     * Keycloak keycloak = new Keycloak(); keycloak.login({.... scope: \"profile email phone\"})\n+     * }</pre>\n+     * See KEYCLOAK-14412\n+     */\n+    @Test\n+    public void testScopeInLoginOptionsShouldBeConsideredByLoginUrl() {\n+\n+        try {\n+            testExecutor.configure()\n+                        .init(defaultArguments());\n+        } catch (WebDriverException ex) {\n+            // should happen\n+        }\n+\n+        JSObjectBuilder loginOptions = JSObjectBuilder.create().add(\"scope\", \"profile email phone\");\n+\n+        testExecutor.login(loginOptions.build(), (JavascriptStateValidator) (driver, output, events) -> {\n+            assertThat(jsDriver.getCurrentUrl(), containsString(\"&scope=openid%20profile%20email%20phone\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e29cc8dbe3b4fc7ec808fb2570cd34618d6270c"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMTA4MDUz", "url": "https://github.com/keycloak/keycloak/pull/7150#pullrequestreview-432108053", "createdAt": "2020-06-17T06:55:54Z", "commit": {"oid": "8e29cc8dbe3b4fc7ec808fb2570cd34618d6270c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNjo1NTo1NVrOGk4FLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNjo1NTo1NVrOGk4FLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMyMDc0OQ==", "bodyText": "You can put this here as well:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n            assertThat(jsDriver.getCurrentUrl(), containsString(\"&scope=openid%20profile%20email%20phone\"));", "url": "https://github.com/keycloak/keycloak/pull/7150#discussion_r441320749", "createdAt": "2020-06-17T06:55:55Z", "author": {"login": "mhajas"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/javascript/JavascriptAdapterTest.java", "diffHunk": "@@ -400,6 +398,58 @@ public void loginRequiredAction() {\n                 .init(defaultArguments(), this::assertSuccessfullyLoggedIn);\n     }\n \n+    /**\n+     * Test for scope handling via {@code initOptions}: <pre>{@code\n+     * Keycloak keycloak = new Keycloak(); keycloak.init({.... scope: \"profile email phone\"})\n+     * }</pre>\n+     * See KEYCLOAK-14412\n+     */\n+    @Test\n+    public void testScopeInInitOptionsShouldBeConsideredByLoginUrl() {\n+\n+        JSObjectBuilder initOptions = defaultArguments()\n+                .loginRequiredOnLoad()\n+                // phone is optional client scope\n+                .add(\"scope\", \"profile email phone\");\n+\n+        try {\n+            testExecutor.init(initOptions);\n+            // This throws exception because when JavascriptExecutor waits for AsyncScript to finish\n+            // it is redirected to login page and executor gets no response\n+\n+            throw new RuntimeException(\"Probably the login-required OnLoad mode doesn't work, because testExecutor should fail with error that page was redirected.\");\n+        } catch (WebDriverException ex) {\n+            // should happen\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e29cc8dbe3b4fc7ec808fb2570cd34618d6270c"}, "originalPosition": 52}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e29cc8dbe3b4fc7ec808fb2570cd34618d6270c", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/8e29cc8dbe3b4fc7ec808fb2570cd34618d6270c", "committedDate": "2020-06-17T06:50:41Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}, "afterCommit": {"oid": "0c0b5798cc53a4ba2a2b81b75960d95627b04adf", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/0c0b5798cc53a4ba2a2b81b75960d95627b04adf", "committedDate": "2020-06-17T06:59:42Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0c0b5798cc53a4ba2a2b81b75960d95627b04adf", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/0c0b5798cc53a4ba2a2b81b75960d95627b04adf", "committedDate": "2020-06-17T06:59:42Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}, "afterCommit": {"oid": "47bf49f833b5a7ef20ce8fb3f9bc939884230a0d", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/47bf49f833b5a7ef20ce8fb3f9bc939884230a0d", "committedDate": "2020-06-17T08:38:40Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "47bf49f833b5a7ef20ce8fb3f9bc939884230a0d", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/47bf49f833b5a7ef20ce8fb3f9bc939884230a0d", "committedDate": "2020-06-17T08:38:40Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}, "afterCommit": {"oid": "969c014001a9f239a8d10c3bdfc0733b24050729", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/969c014001a9f239a8d10c3bdfc0733b24050729", "committedDate": "2020-06-17T08:41:00Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNDgyNjk3", "url": "https://github.com/keycloak/keycloak/pull/7150#pullrequestreview-432482697", "createdAt": "2020-06-17T14:50:22Z", "commit": {"oid": "969c014001a9f239a8d10c3bdfc0733b24050729"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNDo1MDoyMlrOGlJeJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNToyNzoyNlrOGlLOqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYwNTY3MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return login((JSObjectBuilder)null, null);\n          \n          \n            \n                    return login((String)null, null);", "url": "https://github.com/keycloak/keycloak/pull/7150#discussion_r441605671", "createdAt": "2020-06-17T14:50:22Z", "author": {"login": "mhajas"}, "path": "testsuite/integration-arquillian/tests/base/src/main/java/org/keycloak/testsuite/util/javascript/JavascriptTestExecutor.java", "diffHunk": "@@ -39,13 +39,17 @@ protected JavascriptTestExecutor(WebDriver driver, OIDCLogin loginPage) {\n     }\n \n     public JavascriptTestExecutor login() {\n-        return login(null, null);\n+        return login((JSObjectBuilder)null, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "969c014001a9f239a8d10c3bdfc0733b24050729"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYwNTgwNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return login((JSObjectBuilder)null, validator);\n          \n          \n            \n                    return login((String)null, validator);", "url": "https://github.com/keycloak/keycloak/pull/7150#discussion_r441605807", "createdAt": "2020-06-17T14:50:32Z", "author": {"login": "mhajas"}, "path": "testsuite/integration-arquillian/tests/base/src/main/java/org/keycloak/testsuite/util/javascript/JavascriptTestExecutor.java", "diffHunk": "@@ -39,13 +39,17 @@ protected JavascriptTestExecutor(WebDriver driver, OIDCLogin loginPage) {\n     }\n \n     public JavascriptTestExecutor login() {\n-        return login(null, null);\n+        return login((JSObjectBuilder)null, null);\n     }\n     \n     public JavascriptTestExecutor login(JavascriptStateValidator validator) {\n-        return login(null, validator);\n+        return login((JSObjectBuilder)null, validator);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "969c014001a9f239a8d10c3bdfc0733b24050729"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYwNjU2Mw==", "bodyText": "This try-catch block is not necessary. It is necessary only when you are using onLoad: login-required.", "url": "https://github.com/keycloak/keycloak/pull/7150#discussion_r441606563", "createdAt": "2020-06-17T14:51:33Z", "author": {"login": "mhajas"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/javascript/JavascriptAdapterTest.java", "diffHunk": "@@ -400,6 +398,58 @@ public void loginRequiredAction() {\n                 .init(defaultArguments(), this::assertSuccessfullyLoggedIn);\n     }\n \n+    /**\n+     * Test for scope handling via {@code initOptions}: <pre>{@code\n+     * Keycloak keycloak = new Keycloak(); keycloak.init({.... scope: \"profile email phone\"})\n+     * }</pre>\n+     * See KEYCLOAK-14412\n+     */\n+    @Test\n+    public void testScopeInInitOptionsShouldBeConsideredByLoginUrl() {\n+\n+        JSObjectBuilder initOptions = defaultArguments()\n+                .loginRequiredOnLoad()\n+                // phone is optional client scope\n+                .add(\"scope\", \"profile email phone\");\n+\n+        try {\n+            testExecutor.init(initOptions);\n+            // This throws exception because when JavascriptExecutor waits for AsyncScript to finish\n+            // it is redirected to login page and executor gets no response\n+\n+            throw new RuntimeException(\"Probably the login-required OnLoad mode doesn't work, because testExecutor should fail with error that page was redirected.\");\n+        } catch (WebDriverException ex) {\n+            // should happen\n+        }\n+\n+        testExecutor.loginForm(testUser, this::assertOnTestAppUrl)\n+                    .init(initOptions, this::assertSuccessfullyLoggedIn)\n+                    .executeScript(\"return window.keycloak.tokenParsed.scope\", assertOutputContains(\"phone\"));\n+    }\n+\n+    /**\n+     * Test for scope handling via {@code loginOptions}: <pre>{@code\n+     * Keycloak keycloak = new Keycloak(); keycloak.login({.... scope: \"profile email phone\"})\n+     * }</pre>\n+     * See KEYCLOAK-14412\n+     */\n+    @Test\n+    public void testScopeInLoginOptionsShouldBeConsideredByLoginUrl() {\n+\n+        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "969c014001a9f239a8d10c3bdfc0733b24050729"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYzNDQ3Mg==", "bodyText": "Weird. This works for me, are you sure you used the exact line I pasted here?", "url": "https://github.com/keycloak/keycloak/pull/7150#discussion_r441634472", "createdAt": "2020-06-17T15:27:26Z", "author": {"login": "mhajas"}, "path": "testsuite/integration-arquillian/tests/base/src/test/java/org/keycloak/testsuite/javascript/JavascriptAdapterTest.java", "diffHunk": "@@ -400,6 +398,58 @@ public void loginRequiredAction() {\n                 .init(defaultArguments(), this::assertSuccessfullyLoggedIn);\n     }\n \n+    /**\n+     * Test for scope handling via {@code initOptions}: <pre>{@code\n+     * Keycloak keycloak = new Keycloak(); keycloak.init({.... scope: \"profile email phone\"})\n+     * }</pre>\n+     * See KEYCLOAK-14412\n+     */\n+    @Test\n+    public void testScopeInInitOptionsShouldBeConsideredByLoginUrl() {\n+\n+        JSObjectBuilder initOptions = defaultArguments()\n+                .loginRequiredOnLoad()\n+                // phone is optional client scope\n+                .add(\"scope\", \"profile email phone\");\n+\n+        try {\n+            testExecutor.init(initOptions);\n+            // This throws exception because when JavascriptExecutor waits for AsyncScript to finish\n+            // it is redirected to login page and executor gets no response\n+\n+            throw new RuntimeException(\"Probably the login-required OnLoad mode doesn't work, because testExecutor should fail with error that page was redirected.\");\n+        } catch (WebDriverException ex) {\n+            // should happen\n+        }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMyMDc0OQ=="}, "originalCommit": {"oid": "8e29cc8dbe3b4fc7ec808fb2570cd34618d6270c"}, "originalPosition": 52}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "969c014001a9f239a8d10c3bdfc0733b24050729", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/969c014001a9f239a8d10c3bdfc0733b24050729", "committedDate": "2020-06-17T08:41:00Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}, "afterCommit": {"oid": "87a644e21f45464e44a14df9d8f9ed4ee9d13323", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/87a644e21f45464e44a14df9d8f9ed4ee9d13323", "committedDate": "2020-06-17T17:42:38Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87a644e21f45464e44a14df9d8f9ed4ee9d13323", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/87a644e21f45464e44a14df9d8f9ed4ee9d13323", "committedDate": "2020-06-17T17:42:38Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}, "afterCommit": {"oid": "c2f257bdb0c02f10d0ae9c65b34e98c6270e0ded", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/c2f257bdb0c02f10d0ae9c65b34e98c6270e0ded", "committedDate": "2020-06-18T12:38:24Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c2f257bdb0c02f10d0ae9c65b34e98c6270e0ded", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/c2f257bdb0c02f10d0ae9c65b34e98c6270e0ded", "committedDate": "2020-06-18T12:38:24Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}, "afterCommit": {"oid": "8e5f1520ca2439dc188e8d53fb7c5f8a5476a992", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/8e5f1520ca2439dc188e8d53fb7c5f8a5476a992", "committedDate": "2020-07-02T20:32:19Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMjgxNTI1", "url": "https://github.com/keycloak/keycloak/pull/7150#pullrequestreview-442281525", "createdAt": "2020-07-03T09:31:08Z", "commit": {"oid": "8e5f1520ca2439dc188e8d53fb7c5f8a5476a992"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e5f1520ca2439dc188e8d53fb7c5f8a5476a992", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/8e5f1520ca2439dc188e8d53fb7c5f8a5476a992", "committedDate": "2020-07-02T20:32:19Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}, "afterCommit": {"oid": "d3d605e0091d08b779c996dabf419496bb120e71", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/d3d605e0091d08b779c996dabf419496bb120e71", "committedDate": "2020-10-20T22:41:53Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d636eefc188ff1d6a9912e4a77be93dda8f4e78a", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/d636eefc188ff1d6a9912e4a77be93dda8f4e78a", "committedDate": "2020-10-20T23:16:15Z", "message": "KEYCLOAK-14412 Fixed compiler error in JavascriptAdapterTests"}, "afterCommit": {"oid": "5a91287c59544e9e812f13e1ff99f47f3d43e10a", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/5a91287c59544e9e812f13e1ff99f47f3d43e10a", "committedDate": "2020-10-20T23:23:03Z", "message": "KEYCLOAK-14412 Fixed compiler error in JavascriptAdapterTests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2Njc1MzA1", "url": "https://github.com/keycloak/keycloak/pull/7150#pullrequestreview-516675305", "createdAt": "2020-10-26T11:13:44Z", "commit": {"oid": "5a91287c59544e9e812f13e1ff99f47f3d43e10a"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5a91287c59544e9e812f13e1ff99f47f3d43e10a", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/5a91287c59544e9e812f13e1ff99f47f3d43e10a", "committedDate": "2020-10-20T23:23:03Z", "message": "KEYCLOAK-14412 Fixed compiler error in JavascriptAdapterTests"}, "afterCommit": {"oid": "f294518fbe5137c56642876192f21ef2239944c6", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/f294518fbe5137c56642876192f21ef2239944c6", "committedDate": "2020-10-26T23:31:29Z", "message": "KEYCLOAK-14412 Fixed compiler error in JavascriptAdapterTests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NDIyNTA4", "url": "https://github.com/keycloak/keycloak/pull/7150#pullrequestreview-517422508", "createdAt": "2020-10-27T07:51:23Z", "commit": {"oid": "f294518fbe5137c56642876192f21ef2239944c6"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNDIwNjg0", "url": "https://github.com/keycloak/keycloak/pull/7150#pullrequestreview-533420684", "createdAt": "2020-11-18T13:01:18Z", "commit": {"oid": "f294518fbe5137c56642876192f21ef2239944c6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNDIxNzg5", "url": "https://github.com/keycloak/keycloak/pull/7150#pullrequestreview-533421789", "createdAt": "2020-11-18T13:02:40Z", "commit": {"oid": "f294518fbe5137c56642876192f21ef2239944c6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f294518fbe5137c56642876192f21ef2239944c6", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/f294518fbe5137c56642876192f21ef2239944c6", "committedDate": "2020-10-26T23:31:29Z", "message": "KEYCLOAK-14412 Fixed compiler error in JavascriptAdapterTests"}, "afterCommit": {"oid": "433b6d4a77e0fabf06b85617dce5d8ec6c79c0d4", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/433b6d4a77e0fabf06b85617dce5d8ec6c79c0d4", "committedDate": "2020-11-18T13:44:13Z", "message": "KEYCLOAK-14412 Fixed compiler error in JavascriptAdapterTests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba0b6ff282cdac5592a2f9f41b8d14fea9620751", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/ba0b6ff282cdac5592a2f9f41b8d14fea9620751", "committedDate": "2020-11-18T13:44:11Z", "message": "KEYCLOAK-14412 Keycloak.js should honor scopes configured in initOptions and loginOptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "433b6d4a77e0fabf06b85617dce5d8ec6c79c0d4", "author": {"user": {"login": "thomasdarimont", "name": "Thomas Darimont"}}, "url": "https://github.com/keycloak/keycloak/commit/433b6d4a77e0fabf06b85617dce5d8ec6c79c0d4", "committedDate": "2020-11-18T13:44:13Z", "message": "KEYCLOAK-14412 Fixed compiler error in JavascriptAdapterTests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY1Mjc1MjEz", "url": "https://github.com/keycloak/keycloak/pull/7150#pullrequestreview-565275213", "createdAt": "2021-01-11T11:37:55Z", "commit": {"oid": "433b6d4a77e0fabf06b85617dce5d8ec6c79c0d4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjA5ODY2Nzc4", "url": "https://github.com/keycloak/keycloak/pull/7150#pullrequestreview-609866778", "createdAt": "2021-03-11T15:08:33Z", "commit": {"oid": "433b6d4a77e0fabf06b85617dce5d8ec6c79c0d4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjA5OTMxMjQw", "url": "https://github.com/keycloak/keycloak/pull/7150#pullrequestreview-609931240", "createdAt": "2021-03-11T16:02:54Z", "commit": {"oid": "433b6d4a77e0fabf06b85617dce5d8ec6c79c0d4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2946, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}