{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNjE3MDIz", "number": 3770, "title": "Determine pubsub event timestamp correctly in retry-timeout.", "bodyText": "In the retry-timeout sample for GCF java11, we should determine\nthe event timestamp from the Context parameter, not from properties\nof the passed-in PubSub object.\nFixes #3734.", "createdAt": "2020-09-21T23:49:51Z", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3770", "merged": true, "mergeCommit": {"oid": "5e6957310960384ee13bab368d4af45e17b10ea1"}, "closed": true, "closedAt": "2020-09-22T16:45:14Z", "author": {"login": "eamonnmcmanus"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLMRH7AH2gAyNDkwNjE3MDIzOjY4Y2VmZGIzOGE1ZjljN2RjZDhlYjc2YzdhMmU0NjY3NDY4ZjE0NWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLaywBAFqTQ5MzY1NTc5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "68cefdb38a5f9c7dcd8eb76c7a2e4667468f145e", "author": {"user": {"login": "eamonnmcmanus", "name": "\u00c9amonn McManus"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/68cefdb38a5f9c7dcd8eb76c7a2e4667468f145e", "committedDate": "2020-09-21T23:47:58Z", "message": "Determine pubsub event timestamp correctly in retry-timeout.\n\nIn the retry-timeout sample for GCF java11, we should determine\nthe event timestamp from the Context parameter, not from properties\nof the passed-in PubSub object.\n\nFixes #3734."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDYzMjM3", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3770#pullrequestreview-493063237", "createdAt": "2020-09-22T00:21:02Z", "commit": {"oid": "68cefdb38a5f9c7dcd8eb76c7a2e4667468f145e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMDoyMTowMlrOHVmsQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMDoyMTowMlrOHVmsQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxNjA2Nw==", "bodyText": "Shouldn't there be some kind of comment discussing these two and why they are different and when you want to use one and not the other?", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3770#discussion_r492416067", "createdAt": "2020-09-22T00:21:02Z", "author": {"login": "lesv"}, "path": "functions/concepts/retry-timeout/src/main/java/functions/RetryTimeout.java", "diffHunk": "@@ -42,25 +41,19 @@\n   @Override\n   public void accept(PubSubMessage message, Context context) {\n     ZonedDateTime utcNow = ZonedDateTime.now(ZoneOffset.UTC);\n-    ZonedDateTime timestamp = utcNow;\n+    ZonedDateTime timestamp = ZonedDateTime.parse(context.timestamp());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68cefdb38a5f9c7dcd8eb76c7a2e4667468f145e"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMDY0ODQ2", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3770#pullrequestreview-493064846", "createdAt": "2020-09-22T00:27:23Z", "commit": {"oid": "68cefdb38a5f9c7dcd8eb76c7a2e4667468f145e"}, "state": "DISMISSED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMDoyNzoyM1rOHVmyGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMDoyODo1OVrOHVmzeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxNzU2Mg==", "bodyText": "@lesv I suspect @eamonnmcmanus meant to delete the utcNow declaration?", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3770#discussion_r492417562", "createdAt": "2020-09-22T00:27:23Z", "author": {"login": "ace-n"}, "path": "functions/concepts/retry-timeout/src/main/java/functions/RetryTimeout.java", "diffHunk": "@@ -42,25 +41,19 @@\n   @Override\n   public void accept(PubSubMessage message, Context context) {\n     ZonedDateTime utcNow = ZonedDateTime.now(ZoneOffset.UTC);\n-    ZonedDateTime timestamp = utcNow;\n+    ZonedDateTime timestamp = ZonedDateTime.parse(context.timestamp());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxNjA2Nw=="}, "originalCommit": {"oid": "68cefdb38a5f9c7dcd8eb76c7a2e4667468f145e"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxNzY3Ng==", "bodyText": "@eamonnmcmanus did you mean to delete this?", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3770#discussion_r492417676", "createdAt": "2020-09-22T00:27:53Z", "author": {"login": "ace-n"}, "path": "functions/concepts/retry-timeout/src/main/java/functions/RetryTimeout.java", "diffHunk": "@@ -42,25 +41,19 @@\n   @Override\n   public void accept(PubSubMessage message, Context context) {\n     ZonedDateTime utcNow = ZonedDateTime.now(ZoneOffset.UTC);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68cefdb38a5f9c7dcd8eb76c7a2e4667468f145e"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxNzkxMg==", "bodyText": "Should this test contain an assertion? (I don't think it does right now.)", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3770#discussion_r492417912", "createdAt": "2020-09-22T00:28:59Z", "author": {"login": "ace-n"}, "path": "functions/concepts/retry-timeout/src/test/java/functions/RetryTimeoutTest.java", "diffHunk": "@@ -65,41 +64,29 @@ public void afterTest() {\n \n   @Test\n   public void retryTimeout_handlesRetryMsg() {\n-    String timestampData = gson.toJson(Map.of(\n-        \"timestamp\", ZonedDateTime.now(ZoneOffset.UTC).toString()));\n+    ZonedDateTime timestamp = ZonedDateTime.now(ZoneOffset.UTC);\n+    Context mockContext = mock(Context.class);\n+    when(mockContext.timestamp()).thenReturn(timestamp.toString());\n \n     PubSubMessage pubsubMessage = new PubSubMessage();\n-    pubsubMessage.setData(timestampData);\n \n-    new RetryTimeout().accept(pubsubMessage, null);\n+    new RetryTimeout().accept(pubsubMessage, mockContext);\n \n     String logMessage = LOG_HANDLER.getStoredLogRecords().get(0).getMessage();\n-    assertThat(String.format(\"Processing event %s.\", timestampData)).isEqualTo(logMessage);\n+    assertThat(logMessage).contains(\"Processing event with timestamp \" + timestamp);\n   }\n \n   @Test\n   public void retryTimeout_handlesStopMsg() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68cefdb38a5f9c7dcd8eb76c7a2e4667468f145e"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNjU1Nzk1", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3770#pullrequestreview-493655795", "createdAt": "2020-09-22T16:43:22Z", "commit": {"oid": "68cefdb38a5f9c7dcd8eb76c7a2e4667468f145e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 487, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}