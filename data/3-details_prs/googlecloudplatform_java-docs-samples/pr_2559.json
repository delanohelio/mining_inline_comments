{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4Mjk2ODQ4", "number": 2559, "title": "docs: add additional samples for Spanner JDBC", "bodyText": "Adds additional samples for the Cloud Spanner open source JDBC driver.", "createdAt": "2020-04-03T17:27:26Z", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2559", "merged": true, "mergeCommit": {"oid": "50e3d719d1092427e71a685c566baaa7b9c4d735"}, "closed": true, "closedAt": "2020-04-13T08:57:19Z", "author": {"login": "olavloite"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUzUOYgFqTM4Nzg3ODg0OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXKOZbgH2gAyMzk4Mjk2ODQ4OjgyMWUwNWU5NTczZDIyMGU5ZGMwM2ViZTI0NDEyNjFhNzg2MDAyZGM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3ODc4ODQ5", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2559#pullrequestreview-387878849", "createdAt": "2020-04-06T00:11:49Z", "commit": {"oid": "ad22a2d8e5f128d68f6fc9e3336912202950eb66"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08470fcd1fbd7f1ddd9309f1076c5f54a1ddcfe0", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/08470fcd1fbd7f1ddd9309f1076c5f54a1ddcfe0", "committedDate": "2020-04-10T05:48:13Z", "message": "docs: add additional samples for Spanner JDBC"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3a78b67b9a09fe3eb82bee9434e9626fffae85c", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/a3a78b67b9a09fe3eb82bee9434e9626fffae85c", "committedDate": "2020-04-10T05:48:13Z", "message": "fix: fix checkstyle problems"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "229597f9068ee3f4f69fb0e430a244643bac6cb5", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/229597f9068ee3f4f69fb0e430a244643bac6cb5", "committedDate": "2020-04-10T05:48:13Z", "message": "fix: remove code tags"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f4ffe6fea7e4db3be52e141806fc2c1dc0bf357", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/6f4ffe6fea7e4db3be52e141806fc2c1dc0bf357", "committedDate": "2020-04-10T05:48:13Z", "message": "fix: add a small wait to prevent flaky failures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab54a312b4dbe8dcc665b88b35327d5c6bc4a71d", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/ab54a312b4dbe8dcc665b88b35327d5c6bc4a71d", "committedDate": "2020-04-10T14:13:55Z", "message": "refactor: follow the current sample style"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ad22a2d8e5f128d68f6fc9e3336912202950eb66", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/ad22a2d8e5f128d68f6fc9e3336912202950eb66", "committedDate": "2020-04-03T18:26:13Z", "message": "Merge branch 'spanner-jdbc-add-additional-samples' of github.com:olavloite/java-docs-samples into spanner-jdbc-add-additional-samples"}, "afterCommit": {"oid": "ab54a312b4dbe8dcc665b88b35327d5c6bc4a71d", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/ab54a312b4dbe8dcc665b88b35327d5c6bc4a71d", "committedDate": "2020-04-10T14:13:55Z", "message": "refactor: follow the current sample style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTcxOTYy", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2559#pullrequestreview-391571962", "createdAt": "2020-04-10T17:45:20Z", "commit": {"oid": "ab54a312b4dbe8dcc665b88b35327d5c6bc4a71d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNzo0NToyMFrOGEBMog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNzo0NToyMFrOGEBMog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2NzEwNg==", "bodyText": "I'm sure there will be text explaining this in the docs, but a comment or two might be helpful here.", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2559#discussion_r406867106", "createdAt": "2020-04-10T17:45:20Z", "author": {"login": "lesv"}, "path": "spanner/jdbc/src/main/java/com/example/spanner/jdbc/CreateConnectionWithCustomHostExample.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright 2020 Google Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.spanner.jdbc;\n+\n+import com.google.cloud.spanner.jdbc.CloudSpannerJdbcConnection;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+\n+class CreateConnectionWithCustomHostExample {\n+\n+  static void createConnectionWithCustomHost() throws SQLException {\n+    // TODO(developer): Replace these variables before running the sample.\n+    String projectId = \"my-project\";\n+    String instanceId = \"my-instance\";\n+    String databaseId = \"my-database\";\n+    int port = 9020;\n+    createConnectionWithCustomHost(projectId, instanceId, databaseId, port);\n+  }\n+\n+  @SuppressFBWarnings(\n+      value = \"OBL_UNSATISFIED_OBLIGATION\",\n+      justification = \"https://github.com/spotbugs/spotbugs/issues/293\")\n+  // Creates a JDBC connection to a Cloud Spanner database on a custom host.\n+  static void createConnectionWithCustomHost(\n+      String projectId, String instanceId, String databaseId, int port) throws SQLException {\n+    try (Connection connection =\n+        DriverManager.getConnection(\n+            String.format(\n+                \"jdbc:cloudspanner://localhost:%d/projects/%s/instances/%s/databases/%s\"\n+                    + \"?usePlainText=true\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab54a312b4dbe8dcc665b88b35327d5c6bc4a71d"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTczODU1", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2559#pullrequestreview-391573855", "createdAt": "2020-04-10T17:49:26Z", "commit": {"oid": "ab54a312b4dbe8dcc665b88b35327d5c6bc4a71d"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNzo0OToyNlrOGEBSzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNzo1MTozMlrOGEBWWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2ODY4Nw==", "bodyText": "It appears the assumption is that it will eventually succeed, that might not be true in all cases.  Or is it?", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2559#discussion_r406868687", "createdAt": "2020-04-10T17:49:26Z", "author": {"login": "lesv"}, "path": "spanner/jdbc/src/main/java/com/example/spanner/jdbc/TransactionWithRetryLoopExample.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright 2020 Google Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.spanner.jdbc;\n+\n+import com.google.cloud.spanner.Mutation;\n+import com.google.cloud.spanner.jdbc.CloudSpannerJdbcConnection;\n+import com.google.cloud.spanner.jdbc.JdbcSqlExceptionFactory.JdbcAbortedException;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.util.Arrays;\n+\n+class TransactionWithRetryLoopExample {\n+\n+  static void transactionWithRetryLoop() throws SQLException {\n+    // TODO(developer): Replace these variables before running the sample.\n+    String projectId = \"my-project\";\n+    String instanceId = \"my-instance\";\n+    String databaseId = \"my-database\";\n+    transactionWithRetryLoop(projectId, instanceId, databaseId);\n+  }\n+\n+  static void transactionWithRetryLoop(String projectId, String instanceId, String databaseId)\n+      throws SQLException {\n+    // Create a connection that has automatic retry for aborted transactions disabled.\n+    String connectionUrl =\n+        String.format(\n+            \"jdbc:cloudspanner:/projects/%s/instances/%s/databases/%s\"\n+                + \";retryAbortsInternally=false\",\n+            projectId, instanceId, databaseId);\n+    long singerId = 31;\n+    long albumId = 11;\n+    try (Connection connection = DriverManager.getConnection(connectionUrl)) {\n+      while (true) {\n+        try {\n+          CloudSpannerJdbcConnection spannerConnection =\n+              connection.unwrap(CloudSpannerJdbcConnection.class);\n+          spannerConnection.setAutoCommit(false);\n+          Mutation mutationSingers =\n+              Mutation.newInsertBuilder(\"Singers\")\n+                  .set(\"SingerId\")\n+                  .to(singerId)\n+                  .set(\"FirstName\")\n+                  .to(\"Breanna\")\n+                  .set(\"LastName\")\n+                  .to(\"Fountain\")\n+                  .build();\n+          Mutation mutationAlbums =\n+              Mutation.newInsertBuilder(\"Albums\")\n+                  .set(\"SingerId\")\n+                  .to(singerId)\n+                  .set(\"AlbumId\")\n+                  .to(albumId)\n+                  .set(\"AlbumTitle\")\n+                  .to(\"No discounts\")\n+                  .set(\"MarketingBudget\")\n+                  .to(1000)\n+                  .build();\n+          spannerConnection.bufferedWrite(Arrays.asList(mutationSingers, mutationAlbums));\n+          spannerConnection.commit();\n+          System.out.printf(\n+              \"Transaction committed at [%s]%n\", spannerConnection.getCommitTimestamp().toString());\n+          break;\n+        } catch (JdbcAbortedException e) {\n+          // Transaction aborted, retry.\n+          System.out.println(\"Transaction aborted, starting retry\");\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab54a312b4dbe8dcc665b88b35327d5c6bc4a71d"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2OTU5NA==", "bodyText": "I really like this, but I wonder again if an infinite loop is possible here?", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2559#discussion_r406869594", "createdAt": "2020-04-10T17:51:32Z", "author": {"login": "lesv"}, "path": "spanner/jdbc/src/main/java/com/example/spanner/jdbc/TransactionWithRetryLoopUsingOnlyJdbcExample.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Copyright 2020 Google Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.spanner.jdbc;\n+\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import io.grpc.Status.Code;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+\n+class TransactionWithRetryLoopUsingOnlyJdbcExample {\n+\n+  static void genericJdbcTransactionWithRetryLoop() throws SQLException {\n+    // TODO(developer): Replace these variables before running the sample.\n+    String projectId = \"my-project\";\n+    String instanceId = \"my-instance\";\n+    String databaseId = \"my-database\";\n+    genericJdbcTransactionWithRetryLoop(projectId, instanceId, databaseId);\n+  }\n+\n+  @SuppressFBWarnings(value = \"SIL_SQL_IN_LOOP\")\n+  static void genericJdbcTransactionWithRetryLoop(\n+      String projectId, String instanceId, String databaseId) throws SQLException {\n+    // Create a connection that has automatic retry for aborted transactions disabled.\n+    String connectionUrl =\n+        String.format(\n+            \"jdbc:cloudspanner:/projects/%s/instances/%s/databases/%s\"\n+                + \";retryAbortsInternally=false\",\n+            projectId, instanceId, databaseId);\n+    long singerId = 32;\n+    try (Connection connection = DriverManager.getConnection(connectionUrl)) {\n+      while (true) {\n+        try {\n+          connection.setAutoCommit(false);\n+          try (PreparedStatement ps =\n+              connection.prepareStatement(\n+                  \"INSERT INTO Singers (SingerId, FirstName, LastName) VALUES (?, ?, ?)\")) {\n+            ps.setLong(1, singerId);\n+            ps.setString(2, \"Marsha\");\n+            ps.setString(3, \"Roberts\");\n+            ps.executeUpdate();\n+          }\n+          connection.commit();\n+          try (Statement statement = connection.createStatement();\n+              ResultSet rs = statement.executeQuery(\"SHOW VARIABLE COMMIT_TIMESTAMP\")) {\n+            if (rs.next()) {\n+              System.out.printf(\n+                  \"Transaction committed at [%s]%n\",\n+                  rs.getTimestamp(\"COMMIT_TIMESTAMP\").toString());\n+            }\n+          }\n+          break;\n+        } catch (SQLException e) {\n+          if (e.getErrorCode() == Code.ABORTED.value()) {\n+            // Transaction aborted, retry.\n+            System.out.println(\"Transaction aborted, starting retry\");\n+          } else {\n+            throw e;\n+          }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab54a312b4dbe8dcc665b88b35327d5c6bc4a71d"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "821e05e9573d220e9dc03ebe2441261a786002dc", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/821e05e9573d220e9dc03ebe2441261a786002dc", "committedDate": "2020-04-13T08:01:07Z", "message": "fix: add comment for usePlainText"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 897, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}