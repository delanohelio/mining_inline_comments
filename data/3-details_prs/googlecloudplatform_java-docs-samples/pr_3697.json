{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0MzA1MDQ2", "number": 3697, "title": "Update Monitoring sample tests", "bodyText": "Fixes #3696\n\nIt's a good idea to open an issue first for discussion.\n\n\n I have followed Sample Format Guide\n pom.xml parent set to latest shared-configuration\n Appropriate changes to README are included in PR\n API's need to be enabled to test (tell us)\n Environment Variables need to be set (ask us to set them)\n Tests pass:   mvn clean verify required\n Lint  passes: mvn -P lint checkstyle:check required\n Static Analysis:  mvn -P lint clean compile pmd:cpd-check spotbugs:check advisory only\n Please merge this PR for me once it is approved.", "createdAt": "2020-09-10T20:37:00Z", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3697", "merged": true, "mergeCommit": {"oid": "5b18a34bf1b60e157c36d2d12a0c15cc753f4135"}, "closed": true, "closedAt": "2020-09-10T23:06:32Z", "author": {"login": "averikitsch"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHm7kpAH2gAyNDg0MzA1MDQ2OmViN2Y5YTk2NTA0NTliNzhhN2Y0MDg3MGZhZmJjMGJmNDYyMDdmZTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdP-PgYgFqTUwMzMyNDkxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "eb7f9a9650459b78a7f40870fafbc0bf46207fe3", "author": {"user": {"login": "averikitsch", "name": "Averi Kitsch"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/eb7f9a9650459b78a7f40870fafbc0bf46207fe3", "committedDate": "2020-09-10T20:36:10Z", "message": "Update sample"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2Mjk1NDgx", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3697#pullrequestreview-486295481", "createdAt": "2020-09-10T20:43:06Z", "commit": {"oid": "eb7f9a9650459b78a7f40870fafbc0bf46207fe3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMDo0MzowN1rOHQFCsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMDo0MzowN1rOHQFCsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYyMTg3NA==", "bodyText": "Should we have a list of commands and potential args somewhere?", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3697#discussion_r486621874", "createdAt": "2020-09-10T20:43:07Z", "author": {"login": "lesv"}, "path": "monitoring/v3/README.md", "diffHunk": "@@ -5,22 +5,25 @@ Monitoring API to retrieve and modify Alerts data.\n \n ## Prerequisites to run locally:\n \n-    * [Maven 3](https://maven.apache.org)\n-    * [GCloud CLI](https://cloud.google.com/sdk/gcloud/)\n-    * Create a Cloud project\n+* [Maven 3](https://maven.apache.org)\n+* [GCloud CLI](https://cloud.google.com/sdk/gcloud/)\n+* Create a Cloud project\n \n # Set Up Your Local Dev Environment\n \n Create local credentials by running the following command and following the oauth2 flow:\n \n-    gcloud beta auth application-default login\n+```bash\n+gcloud auth application-default login\n+```\n \n To run:\n \n-    * `mvn clean install`\n-    * `./manage_alerts_sample.sh <YOUR-PROJECT-ID> <command> <args>\n-\n-## Running on GCE, GAE, or other environments\n+```bash\n+mvn clean install  \n+./manage_alerts_sample.sh \"<command> <args>\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb7f9a9650459b78a7f40870fafbc0bf46207fe3"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2Mjk1NzA5", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3697#pullrequestreview-486295709", "createdAt": "2020-09-10T20:43:27Z", "commit": {"oid": "eb7f9a9650459b78a7f40870fafbc0bf46207fe3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e22d88c48ca8e722a94f6ce496945285a17f375a", "author": {"user": {"login": "averikitsch", "name": "Averi Kitsch"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/e22d88c48ca8e722a94f6ce496945285a17f375a", "committedDate": "2020-09-10T21:34:11Z", "message": "Update pattern"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea83286ded77671cb4d8fcb46f12c6e3a0cc5b45", "author": {"user": {"login": "averikitsch", "name": "Averi Kitsch"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/ea83286ded77671cb4d8fcb46f12c6e3a0cc5b45", "committedDate": "2020-09-10T21:37:49Z", "message": "Update readme"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e7d4af0712e1473793b1c4b1b1a20414553f5d9", "author": {"user": {"login": "averikitsch", "name": "Averi Kitsch"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/9e7d4af0712e1473793b1c4b1b1a20414553f5d9", "committedDate": "2020-09-10T22:43:06Z", "message": "Add retry"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MzY4OTQw", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3697#pullrequestreview-486368940", "createdAt": "2020-09-10T23:05:10Z", "commit": {"oid": "9e7d4af0712e1473793b1c4b1b1a20414553f5d9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMzI0OTEz", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3697#pullrequestreview-503324913", "createdAt": "2020-10-06T20:16:53Z", "commit": {"oid": "9e7d4af0712e1473793b1c4b1b1a20414553f5d9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMDoxNjo1NFrOHdYXaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMDoxNjo1NFrOHdYXaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU2OTk2Mw==", "bodyText": "Start at 1300 * a random value * factor <-- so that multiple tests running at the same time don't do this at the same time. (ie at least one will break free / round).\nhttps://cloud.google.com/storage/docs/exponential-backoff for more info", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/3697#discussion_r500569963", "createdAt": "2020-10-06T20:16:54Z", "author": {"login": "lesv"}, "path": "monitoring/v3/src/test/java/com/example/AlertIT.java", "diffHunk": "@@ -94,24 +95,42 @@ public void testReplaceChannels() throws IOException {\n   }\n \n   @Test\n-  public void testDisableEnablePolicies() throws IOException {\n+  public void testDisableEnablePolicies() throws IOException, InterruptedException {\n     AlertSample.main(new String[] {\"enable\", \"-d\", \"display_name='test-policy'\"});\n-    \n+\n     // check the current state of policy to make sure\n     // not to enable the policy that is already enabled.\n     boolean isEnabled = bout.toString().contains(\"already\");\n-    if (isEnabled) {\n-      AlertSample.main(new String[] {\"disable\", \"-d\", \"display_name='test-policy'\"});\n-      assertTrue(bout.toString().contains(\"disabled\"));\n+    int maxAttempts = 10;\n+    int attempt = 0;\n+    int factor = 1;\n+    Boolean retry = true;\n+    while (retry) {\n+      try {\n+        if (isEnabled) {\n+          AlertSample.main(new String[] {\"disable\", \"-d\", \"display_name='test-policy'\"});\n+          assertTrue(bout.toString().contains(\"disabled\"));\n \n-      AlertSample.main(new String[] {\"enable\", \"-d\", \"display_name='test-policy'\"});\n-      assertTrue(bout.toString().contains(\"enabled\"));\n-    } else {\n-      AlertSample.main(new String[] {\"enable\", \"-d\", \"display_name='test-policy'\"});\n-      assertTrue(bout.toString().contains(\"enabled\"));\n+          AlertSample.main(new String[] {\"enable\", \"-d\", \"display_name='test-policy'\"});\n+          assertTrue(bout.toString().contains(\"enabled\"));\n+        } else {\n+          AlertSample.main(new String[] {\"enable\", \"-d\", \"display_name='test-policy'\"});\n+          assertTrue(bout.toString().contains(\"enabled\"));\n \n-      AlertSample.main(new String[] {\"disable\", \"-d\", \"display_name='test-policy'\"});\n-      assertTrue(bout.toString().contains(\"disabled\"));\n+          AlertSample.main(new String[] {\"disable\", \"-d\", \"display_name='test-policy'\"});\n+          assertTrue(bout.toString().contains(\"disabled\"));\n+        }\n+        retry = false;\n+      } catch (StatusRuntimeException e) {\n+        System.out.println(\"Error: \" + e.toString());\n+        System.out.println(\"Retrying...\");\n+        Thread.sleep(2300 * factor);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e7d4af0712e1473793b1c4b1b1a20414553f5d9"}, "originalPosition": 79}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 468, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}