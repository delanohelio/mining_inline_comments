{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0NzYwMzM0", "number": 2986, "title": "refactor: use new verify token functionality from google-auth-library", "bodyText": "google-auth-library 0.21.0 is available, so this is ready to go.", "createdAt": "2020-05-28T22:04:08Z", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2986", "merged": true, "mergeCommit": {"oid": "8fd966992feae98e855a7a2df942c4e654856288"}, "closed": true, "closedAt": "2020-06-25T17:38:54Z", "author": {"login": "chingor13"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcl1PgRgH2gAyNDI0NzYwMzM0OmM3YTI1ZDZhOGI5ODMzZjgzODllNGJjMjA5NGM5ZmU5NjYwN2VjM2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcux0vMgH2gAyNDI0NzYwMzM0Ojc4M2M1ODc0MTYxYjg0MjcwNGI2MDAzYTEyYTM2MWVmNTQ2YjFiNmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c7a25d6a8b9833f8389e4bc2094c9fe96607ec3a", "author": {"user": {"login": "chingor13", "name": "Jeff Ching"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/c7a25d6a8b9833f8389e4bc2094c9fe96607ec3a", "committedDate": "2020-05-28T22:03:11Z", "message": "refactor: use new verify token functionality from google-auth-library"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMTkzMDgx", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2986#pullrequestreview-421193081", "createdAt": "2020-05-29T18:32:08Z", "commit": {"oid": "c7a25d6a8b9833f8389e4bc2094c9fe96607ec3a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxODozMjowOVrOGcnx-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxODozMjowOVrOGcnx-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY2NTA4Mw==", "bodyText": "This is beautiful!", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2986#discussion_r432665083", "createdAt": "2020-05-29T18:32:09Z", "author": {"login": "bshaffer"}, "path": "iap/src/main/java/com/example/iap/VerifyIapRequestHeader.java", "diffHunk": "@@ -97,37 +55,15 @@ boolean verifyJwtForComputeEngine(\n   }\n \n   private boolean verifyJwt(String jwtToken, String expectedAudience) throws Exception {\n-\n-    // parse signed token into header / claims\n-    SignedJWT signedJwt = SignedJWT.parse(jwtToken);\n-    JWSHeader jwsHeader = signedJwt.getHeader();\n-\n-    // header must have algorithm(\"alg\") and \"kid\"\n-    Preconditions.checkNotNull(jwsHeader.getAlgorithm());\n-    Preconditions.checkNotNull(jwsHeader.getKeyID());\n-\n-    JWTClaimsSet claims = signedJwt.getJWTClaimsSet();\n-\n-    // claims must have audience, issuer\n-    Preconditions.checkArgument(claims.getAudience().contains(expectedAudience));\n-    Preconditions.checkArgument(claims.getIssuer().equals(IAP_ISSUER_URL));\n-\n-    // claim must have issued at time in the past\n-    Date currentTime = Date.from(Instant.now(clock));\n-    Preconditions.checkArgument(claims.getIssueTime().before(currentTime));\n-    // claim must have expiration time in the future\n-    Preconditions.checkArgument(claims.getExpirationTime().after(currentTime));\n-\n-    // must have subject, email\n-    Preconditions.checkNotNull(claims.getSubject());\n-    Preconditions.checkNotNull(claims.getClaim(\"email\"));\n-\n-    // verify using public key : lookup with key id, algorithm name provided\n-    ECPublicKey publicKey = getKey(jwsHeader.getKeyID(), jwsHeader.getAlgorithm().getName());\n-\n-    Preconditions.checkNotNull(publicKey);\n-    JWSVerifier jwsVerifier = new ECDSAVerifier(publicKey);\n-    return signedJwt.verify(jwsVerifier);\n+    TokenVerifier tokenVerifier = TokenVerifier.newBuilder()\n+        .setAudience(expectedAudience)\n+        .build();\n+    try {\n+      tokenVerifier.verify(jwtToken);\n+      return true;\n+    } catch (TokenVerifier.VerificationException e) {\n+      return false;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7a25d6a8b9833f8389e4bc2094c9fe96607ec3a"}, "originalPosition": 98}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMTk3NDk5", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2986#pullrequestreview-421197499", "createdAt": "2020-05-29T18:39:18Z", "commit": {"oid": "c7a25d6a8b9833f8389e4bc2094c9fe96607ec3a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxODozOToxOFrOGcn--w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxODozOToxOFrOGcn--w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY2ODQxMQ==", "bodyText": "What is the recommended way to verify the claims (e.g. pull the email and sub field from the verified JWT)? It would be good to include this.", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2986#discussion_r432668411", "createdAt": "2020-05-29T18:39:18Z", "author": {"login": "bshaffer"}, "path": "iap/src/main/java/com/example/iap/VerifyIapRequestHeader.java", "diffHunk": "@@ -97,37 +55,15 @@ boolean verifyJwtForComputeEngine(\n   }\n \n   private boolean verifyJwt(String jwtToken, String expectedAudience) throws Exception {\n-\n-    // parse signed token into header / claims\n-    SignedJWT signedJwt = SignedJWT.parse(jwtToken);\n-    JWSHeader jwsHeader = signedJwt.getHeader();\n-\n-    // header must have algorithm(\"alg\") and \"kid\"\n-    Preconditions.checkNotNull(jwsHeader.getAlgorithm());\n-    Preconditions.checkNotNull(jwsHeader.getKeyID());\n-\n-    JWTClaimsSet claims = signedJwt.getJWTClaimsSet();\n-\n-    // claims must have audience, issuer\n-    Preconditions.checkArgument(claims.getAudience().contains(expectedAudience));\n-    Preconditions.checkArgument(claims.getIssuer().equals(IAP_ISSUER_URL));\n-\n-    // claim must have issued at time in the past\n-    Date currentTime = Date.from(Instant.now(clock));\n-    Preconditions.checkArgument(claims.getIssueTime().before(currentTime));\n-    // claim must have expiration time in the future\n-    Preconditions.checkArgument(claims.getExpirationTime().after(currentTime));\n-\n-    // must have subject, email\n-    Preconditions.checkNotNull(claims.getSubject());\n-    Preconditions.checkNotNull(claims.getClaim(\"email\"));\n-\n-    // verify using public key : lookup with key id, algorithm name provided\n-    ECPublicKey publicKey = getKey(jwsHeader.getKeyID(), jwsHeader.getAlgorithm().getName());\n-\n-    Preconditions.checkNotNull(publicKey);\n-    JWSVerifier jwsVerifier = new ECDSAVerifier(publicKey);\n-    return signedJwt.verify(jwsVerifier);\n+    TokenVerifier tokenVerifier = TokenVerifier.newBuilder()\n+        .setAudience(expectedAudience)\n+        .build();\n+    try {\n+      tokenVerifier.verify(jwtToken);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7a25d6a8b9833f8389e4bc2094c9fe96607ec3a"}, "originalPosition": 94}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMTk5NzM1", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2986#pullrequestreview-421199735", "createdAt": "2020-05-29T18:42:56Z", "commit": {"oid": "c7a25d6a8b9833f8389e4bc2094c9fe96607ec3a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxODo0Mjo1NlrOGcoFyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxODo0Mjo1NlrOGcoFyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY3MDE1Mw==", "bodyText": "this should also set the issuer https://cloud.google.com/iap so this is verified as well!", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2986#discussion_r432670153", "createdAt": "2020-05-29T18:42:56Z", "author": {"login": "bshaffer"}, "path": "iap/src/main/java/com/example/iap/VerifyIapRequestHeader.java", "diffHunk": "@@ -97,37 +55,15 @@ boolean verifyJwtForComputeEngine(\n   }\n \n   private boolean verifyJwt(String jwtToken, String expectedAudience) throws Exception {\n-\n-    // parse signed token into header / claims\n-    SignedJWT signedJwt = SignedJWT.parse(jwtToken);\n-    JWSHeader jwsHeader = signedJwt.getHeader();\n-\n-    // header must have algorithm(\"alg\") and \"kid\"\n-    Preconditions.checkNotNull(jwsHeader.getAlgorithm());\n-    Preconditions.checkNotNull(jwsHeader.getKeyID());\n-\n-    JWTClaimsSet claims = signedJwt.getJWTClaimsSet();\n-\n-    // claims must have audience, issuer\n-    Preconditions.checkArgument(claims.getAudience().contains(expectedAudience));\n-    Preconditions.checkArgument(claims.getIssuer().equals(IAP_ISSUER_URL));\n-\n-    // claim must have issued at time in the past\n-    Date currentTime = Date.from(Instant.now(clock));\n-    Preconditions.checkArgument(claims.getIssueTime().before(currentTime));\n-    // claim must have expiration time in the future\n-    Preconditions.checkArgument(claims.getExpirationTime().after(currentTime));\n-\n-    // must have subject, email\n-    Preconditions.checkNotNull(claims.getSubject());\n-    Preconditions.checkNotNull(claims.getClaim(\"email\"));\n-\n-    // verify using public key : lookup with key id, algorithm name provided\n-    ECPublicKey publicKey = getKey(jwsHeader.getKeyID(), jwsHeader.getAlgorithm().getName());\n-\n-    Preconditions.checkNotNull(publicKey);\n-    JWSVerifier jwsVerifier = new ECDSAVerifier(publicKey);\n-    return signedJwt.verify(jwsVerifier);\n+    TokenVerifier tokenVerifier = TokenVerifier.newBuilder()\n+        .setAudience(expectedAudience)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7a25d6a8b9833f8389e4bc2094c9fe96607ec3a"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "660c13cb5a368beea79214f9f5082a8360e961b2", "author": {"user": {"login": "chingor13", "name": "Jeff Ching"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/660c13cb5a368beea79214f9f5082a8360e961b2", "committedDate": "2020-05-29T19:42:02Z", "message": "fix: restore check for subject and email"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4Mzc1MTI2", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2986#pullrequestreview-428375126", "createdAt": "2020-06-10T19:45:53Z", "commit": {"oid": "660c13cb5a368beea79214f9f5082a8360e961b2"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxOTo0NTo1M1rOGiD19A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxOTo0NTo1M1rOGiD19A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODM2NzczMg==", "bodyText": "nit: Update comment to be more informative", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2986#discussion_r438367732", "createdAt": "2020-06-10T19:45:53Z", "author": {"login": "averikitsch"}, "path": "iap/src/main/java/com/example/iap/VerifyIapRequestHeader.java", "diffHunk": "@@ -96,38 +57,20 @@ boolean verifyJwtForComputeEngine(\n             Long.toUnsignedString(projectNumber), Long.toUnsignedString(backendServiceId)));\n   }\n \n-  private boolean verifyJwt(String jwtToken, String expectedAudience) throws Exception {\n-\n-    // parse signed token into header / claims\n-    SignedJWT signedJwt = SignedJWT.parse(jwtToken);\n-    JWSHeader jwsHeader = signedJwt.getHeader();\n-\n-    // header must have algorithm(\"alg\") and \"kid\"\n-    Preconditions.checkNotNull(jwsHeader.getAlgorithm());\n-    Preconditions.checkNotNull(jwsHeader.getKeyID());\n-\n-    JWTClaimsSet claims = signedJwt.getJWTClaimsSet();\n-\n-    // claims must have audience, issuer\n-    Preconditions.checkArgument(claims.getAudience().contains(expectedAudience));\n-    Preconditions.checkArgument(claims.getIssuer().equals(IAP_ISSUER_URL));\n-\n-    // claim must have issued at time in the past\n-    Date currentTime = Date.from(Instant.now(clock));\n-    Preconditions.checkArgument(claims.getIssueTime().before(currentTime));\n-    // claim must have expiration time in the future\n-    Preconditions.checkArgument(claims.getExpirationTime().after(currentTime));\n-\n-    // must have subject, email\n-    Preconditions.checkNotNull(claims.getSubject());\n-    Preconditions.checkNotNull(claims.getClaim(\"email\"));\n-\n-    // verify using public key : lookup with key id, algorithm name provided\n-    ECPublicKey publicKey = getKey(jwsHeader.getKeyID(), jwsHeader.getAlgorithm().getName());\n-\n-    Preconditions.checkNotNull(publicKey);\n-    JWSVerifier jwsVerifier = new ECDSAVerifier(publicKey);\n-    return signedJwt.verify(jwsVerifier);\n+  private boolean verifyJwt(String jwtToken, String expectedAudience) {\n+    TokenVerifier tokenVerifier = TokenVerifier.newBuilder()\n+        .setAudience(expectedAudience)\n+        .setIssuer(IAP_ISSUER_URL)\n+        .build();\n+    try {\n+      JsonWebToken jsonWebToken = tokenVerifier.verify(jwtToken);\n+\n+      // must have subject, email", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "660c13cb5a368beea79214f9f5082a8360e961b2"}, "originalPosition": 100}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12c7574ecddfcc981be54bcec5db3d197c59bf12", "author": {"user": {"login": "chingor13", "name": "Jeff Ching"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/12c7574ecddfcc981be54bcec5db3d197c59bf12", "committedDate": "2020-06-24T20:45:14Z", "message": "Merge branch 'master' into verify-iap-auth-library"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b8783de903c5dd9b0aa3d1112753567e676b5fd", "author": {"user": {"login": "chingor13", "name": "Jeff Ching"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/8b8783de903c5dd9b0aa3d1112753567e676b5fd", "committedDate": "2020-06-24T20:50:12Z", "message": "docs: clarify comment about subject/email claims"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MDA0NzI0", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2986#pullrequestreview-437004724", "createdAt": "2020-06-24T21:03:06Z", "commit": {"oid": "8b8783de903c5dd9b0aa3d1112753567e676b5fd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebf4587f3961afb23c2be72d6bd9e514f80645d9", "author": {"user": {"login": "chingor13", "name": "Jeff Ching"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/ebf4587f3961afb23c2be72d6bd9e514f80645d9", "committedDate": "2020-06-25T16:24:00Z", "message": "Merge branch 'master' into verify-iap-auth-library"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NjcyODgy", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2986#pullrequestreview-437672882", "createdAt": "2020-06-25T16:42:01Z", "commit": {"oid": "ebf4587f3961afb23c2be72d6bd9e514f80645d9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNjo0MjowMVrOGpDA3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNjo0MjowMVrOGpDA3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY5NDE3Mg==", "bodyText": "Do we want to print the exception message so the user knows why verification failed?", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2986#discussion_r445694172", "createdAt": "2020-06-25T16:42:01Z", "author": {"login": "bshaffer"}, "path": "iap/src/main/java/com/example/iap/VerifyIapRequestHeader.java", "diffHunk": "@@ -96,38 +57,20 @@ boolean verifyJwtForComputeEngine(\n             Long.toUnsignedString(projectNumber), Long.toUnsignedString(backendServiceId)));\n   }\n \n-  private boolean verifyJwt(String jwtToken, String expectedAudience) throws Exception {\n-\n-    // parse signed token into header / claims\n-    SignedJWT signedJwt = SignedJWT.parse(jwtToken);\n-    JWSHeader jwsHeader = signedJwt.getHeader();\n-\n-    // header must have algorithm(\"alg\") and \"kid\"\n-    Preconditions.checkNotNull(jwsHeader.getAlgorithm());\n-    Preconditions.checkNotNull(jwsHeader.getKeyID());\n-\n-    JWTClaimsSet claims = signedJwt.getJWTClaimsSet();\n-\n-    // claims must have audience, issuer\n-    Preconditions.checkArgument(claims.getAudience().contains(expectedAudience));\n-    Preconditions.checkArgument(claims.getIssuer().equals(IAP_ISSUER_URL));\n-\n-    // claim must have issued at time in the past\n-    Date currentTime = Date.from(Instant.now(clock));\n-    Preconditions.checkArgument(claims.getIssueTime().before(currentTime));\n-    // claim must have expiration time in the future\n-    Preconditions.checkArgument(claims.getExpirationTime().after(currentTime));\n-\n-    // must have subject, email\n-    Preconditions.checkNotNull(claims.getSubject());\n-    Preconditions.checkNotNull(claims.getClaim(\"email\"));\n-\n-    // verify using public key : lookup with key id, algorithm name provided\n-    ECPublicKey publicKey = getKey(jwsHeader.getKeyID(), jwsHeader.getAlgorithm().getName());\n-\n-    Preconditions.checkNotNull(publicKey);\n-    JWSVerifier jwsVerifier = new ECDSAVerifier(publicKey);\n-    return signedJwt.verify(jwsVerifier);\n+  private boolean verifyJwt(String jwtToken, String expectedAudience) {\n+    TokenVerifier tokenVerifier = TokenVerifier.newBuilder()\n+        .setAudience(expectedAudience)\n+        .setIssuer(IAP_ISSUER_URL)\n+        .build();\n+    try {\n+      JsonWebToken jsonWebToken = tokenVerifier.verify(jwtToken);\n+\n+      // Verify that the token contain subject and email claims\n+      JsonWebToken.Payload payload = jsonWebToken.getPayload();\n+      return payload.getSubject() != null && payload.get(\"email\") != null;\n+    } catch (TokenVerifier.VerificationException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebf4587f3961afb23c2be72d6bd9e514f80645d9"}, "originalPosition": 103}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "783c5874161b842704b6003a12a361ef546b1b6c", "author": {"user": {"login": "chingor13", "name": "Jeff Ching"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/783c5874161b842704b6003a12a361ef546b1b6c", "committedDate": "2020-06-25T17:09:33Z", "message": "fix: print verification exception message to stdout"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 670, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}