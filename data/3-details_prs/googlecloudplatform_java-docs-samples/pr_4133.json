{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0ODY1NDQ5", "number": 4133, "title": "test: delete stale test databases", "bodyText": "Delete stale test databases that have the same name as those being created by this test.\nFixes #4103", "createdAt": "2020-11-03T16:49:29Z", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/4133", "merged": true, "mergeCommit": {"oid": "f8a99e0a61e87bbda7d41e3322679655ead16136"}, "closed": true, "closedAt": "2020-11-06T23:17:40Z", "author": {"login": "olavloite"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdY8Bz7AH2gAyNTE0ODY1NDQ5OmU4NTFiM2RkNmE5NGNmMTMwYzc3Y2U2ZGM4MmVlYTYzYzNjNGEzZmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZ-iU6gFqTUyNTUyOTA4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e851b3dd6a94cf130c77ce6dc82eea63c3c4a3fc", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/e851b3dd6a94cf130c77ce6dc82eea63c3c4a3fc", "committedDate": "2020-11-03T16:47:42Z", "message": "test: delete stale test databases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4cffc84fde8afc434eef43c91939cbf0ac82acb", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/c4cffc84fde8afc434eef43c91939cbf0ac82acb", "committedDate": "2020-11-04T07:19:23Z", "message": "test: actually delete databases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db8c1684db487a4c45b3e1e610b60fc81a45dc76", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/db8c1684db487a4c45b3e1e610b60fc81a45dc76", "committedDate": "2020-11-04T09:19:20Z", "message": "fix: fix NPE"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0872b64bdb4da0dc1d9d1a435f8ba86313874dce", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/0872b64bdb4da0dc1d9d1a435f8ba86313874dce", "committedDate": "2020-11-04T10:22:45Z", "message": "fix: only remove stale databases once"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNTkzNDk5", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/4133#pullrequestreview-523593499", "createdAt": "2020-11-04T17:42:15Z", "commit": {"oid": "0872b64bdb4da0dc1d9d1a435f8ba86313874dce"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNzo0MjoxNVrOHti7Jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNzo0NjowOVrOHtjEUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUyMDE2Nw==", "bodyText": "Can we reuse baseDbId here instead of the property again?", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/4133#discussion_r517520167", "createdAt": "2020-11-04T17:42:15Z", "author": {"login": "kurtisvg"}, "path": "spanner/cloud-client/src/test/java/com/example/spanner/SpannerSampleIT.java", "diffHunk": "@@ -69,9 +71,21 @@ public static void setUp() throws Exception {\n     spanner = options.getService();\n     dbClient = spanner.getDatabaseAdminClient();\n     dbId = DatabaseId.of(options.getProjectId(), instanceId, databaseId);\n-    dbClient.dropDatabase(dbId.getInstanceId().getInstance(), dbId.getDatabase());\n-    dbClient.dropDatabase(\n-        dbId.getInstanceId().getInstance(), SpannerSample.createRestoredSampleDbId(dbId));\n+    // Delete stale test databases that have been created earlier by this test, but not deleted.\n+    deleteStaleTestDatabases(instanceId, System.getProperty(\"spanner.sample.database\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0872b64bdb4da0dc1d9d1a435f8ba86313874dce"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzUyMjUxNQ==", "bodyText": "Would it be less fragile to just use:\nif db.getId.getDatabase().startsWith(baseDbID)?\nOtherwise any adjustments to the formatForTest UUID will break this without any immediate feedback.", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/4133#discussion_r517522515", "createdAt": "2020-11-04T17:46:09Z", "author": {"login": "kurtisvg"}, "path": "spanner/cloud-client/src/test/java/com/example/spanner/SpannerSampleIT.java", "diffHunk": "@@ -69,9 +71,21 @@ public static void setUp() throws Exception {\n     spanner = options.getService();\n     dbClient = spanner.getDatabaseAdminClient();\n     dbId = DatabaseId.of(options.getProjectId(), instanceId, databaseId);\n-    dbClient.dropDatabase(dbId.getInstanceId().getInstance(), dbId.getDatabase());\n-    dbClient.dropDatabase(\n-        dbId.getInstanceId().getInstance(), SpannerSample.createRestoredSampleDbId(dbId));\n+    // Delete stale test databases that have been created earlier by this test, but not deleted.\n+    deleteStaleTestDatabases(instanceId, System.getProperty(\"spanner.sample.database\"));\n+  }\n+  \n+  static void deleteStaleTestDatabases(String instanceId, String baseDbId) {\n+    Timestamp now = Timestamp.now();\n+    Pattern pattern = getTestDbIdPattern(baseDbId);\n+    for (Database db : dbClient.listDatabases(instanceId).iterateAll()) {\n+      if (db.getCreateTime().getSeconds() > 0 && TimeUnit.HOURS\n+          .convert(now.getSeconds() - db.getCreateTime().getSeconds(), TimeUnit.SECONDS) > 24) {\n+        if (pattern.matcher(toComparableId(baseDbId, db.getId().getDatabase())).matches()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0872b64bdb4da0dc1d9d1a435f8ba86313874dce"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0816514d6d8670fd17a8feb1f6c721e7ec82c20d", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/0816514d6d8670fd17a8feb1f6c721e7ec82c20d", "committedDate": "2020-11-04T19:06:00Z", "message": "fix: reuse baseDbId"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0ODIzOTQ1", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/4133#pullrequestreview-524823945", "createdAt": "2020-11-06T02:55:44Z", "commit": {"oid": "0816514d6d8670fd17a8feb1f6c721e7ec82c20d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0ODI5MTQw", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/4133#pullrequestreview-524829140", "createdAt": "2020-11-06T03:12:58Z", "commit": {"oid": "0816514d6d8670fd17a8feb1f6c721e7ec82c20d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d14233f629da67b523932621e2ba10d5580ca1e", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/8d14233f629da67b523932621e2ba10d5580ca1e", "committedDate": "2020-11-06T09:08:22Z", "message": "fix: also delete stale restored databases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34efac7aa04fe5618fa78f8f858d85555009b4d7", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/34efac7aa04fe5618fa78f8f858d85555009b4d7", "committedDate": "2020-11-06T09:17:15Z", "message": "test: force logging of non-deleted db"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "008f634dc68921e2fe7bc6bdb5e331b0a26da871", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/008f634dc68921e2fe7bc6bdb5e331b0a26da871", "committedDate": "2020-11-06T09:30:09Z", "message": "fix: log non-deleted databases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78b593e44b8bc92fd4e42e76f88f8b099ddbe140", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/78b593e44b8bc92fd4e42e76f88f8b099ddbe140", "committedDate": "2020-11-06T09:50:06Z", "message": "fix: show age in hours"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49d14ee9bf92940bc6546a3852e6d5177c9ada84", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/49d14ee9bf92940bc6546a3852e6d5177c9ada84", "committedDate": "2020-11-06T09:58:52Z", "message": "fix: drop dbs with length at least 20"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc0ba7a902b9966605bc16ee1ecce17370d9e0a0", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/dc0ba7a902b9966605bc16ee1ecce17370d9e0a0", "committedDate": "2020-11-06T10:11:19Z", "message": "fix: drop dbs with length at least 20"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "619674debac60b922a6cdc2f474bedac79858a1a", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/619674debac60b922a6cdc2f474bedac79858a1a", "committedDate": "2020-11-06T10:25:34Z", "message": "fix: delete all restored db's that have a long name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b98b43e1770a9db8c604de4d0d84e241243f8ebf", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/b98b43e1770a9db8c604de4d0d84e241243f8ebf", "committedDate": "2020-11-06T10:39:26Z", "message": "fix: use different patterns for sample and restored"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37c88162338113d46d8b348f5781fc63e8fc3cd0", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/37c88162338113d46d8b348f5781fc63e8fc3cd0", "committedDate": "2020-11-06T10:48:18Z", "message": "fix: remove deleted check as it is no longer needed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NTI5MDg5", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/4133#pullrequestreview-525529089", "createdAt": "2020-11-06T22:16:57Z", "commit": {"oid": "37c88162338113d46d8b348f5781fc63e8fc3cd0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 454, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}