{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3ODI4OTg0", "number": 2557, "title": "[Cloud Run] Auth Snippet", "bodyText": "Fixes #<issue_number_goes_here>\n\nIt's a good idea to open an issue first for discussion.\n\n\n Tests pass\n Appropriate changes to README are included in PR\n API's need to be enabled to test (tell us)\n Environment Variables need to be set (ask us to set them)", "createdAt": "2020-04-02T21:58:19Z", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2557", "merged": true, "mergeCommit": {"oid": "65177a529a334d18bf14cd4c905db48750046028"}, "closed": true, "closedAt": "2020-04-03T19:52:07Z", "author": {"login": "averikitsch"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTzmDdAH2gAyMzk3ODI4OTg0OjUyZWYxZjM4Y2VlMDVlMGRjNGMyZDgzZTc1OGQyZDQwODRhZDE3MGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcUGWiggFqTM4NzUzNjgyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "52ef1f38cee05e0dc4c2d83e758d2d4084ad170f", "author": {"user": {"login": "averikitsch", "name": "Averi Kitsch"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/52ef1f38cee05e0dc4c2d83e758d2d4084ad170f", "committedDate": "2020-04-02T21:57:22Z", "message": "sample"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8cd3b542a558ca98bbef15b68668e3604084cf6", "author": {"user": {"login": "averikitsch", "name": "Averi Kitsch"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/a8cd3b542a558ca98bbef15b68668e3604084cf6", "committedDate": "2020-04-02T21:57:32Z", "message": "update kokoro tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2ODIyNzYw", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2557#pullrequestreview-386822760", "createdAt": "2020-04-02T22:30:22Z", "commit": {"oid": "a8cd3b542a558ca98bbef15b68668e3604084cf6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c0673400e0f78e91a3d76bc79e184ff51876e33", "author": {"user": {"login": "averikitsch", "name": "Averi Kitsch"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/3c0673400e0f78e91a3d76bc79e184ff51876e33", "committedDate": "2020-04-03T00:32:53Z", "message": "Merge branch 'master' into auth-sample"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MzcyNTkz", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2557#pullrequestreview-387372593", "createdAt": "2020-04-03T15:44:17Z", "commit": {"oid": "3c0673400e0f78e91a3d76bc79e184ff51876e33"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNTo0NDoxN1rOGAbGjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNjowMTo0OVrOGAbxGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA5NzIzMQ==", "bodyText": "There are some edge case circumstances noted in Node.js and Golang where the timeout can take longer than 5 seconds. For purposes of the sample may be worth making this 10.", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2557#discussion_r403097231", "createdAt": "2020-04-03T15:44:17Z", "author": {"login": "grayside"}, "path": "run/authentication/src/main/java/com/example/cloudrun/Authentication.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.cloudrun;\n+\n+// [START run_service_to_service_auth]\n+import java.io.IOException;\n+import java.util.concurrent.TimeUnit;\n+import okhttp3.OkHttpClient;\n+import okhttp3.Request;\n+import okhttp3.Response;\n+\n+public class Authentication {\n+\n+  // Instantiate OkHttpClient\n+  private static final OkHttpClient ok =\n+      new OkHttpClient.Builder()\n+          .readTimeout(500, TimeUnit.MILLISECONDS)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c0673400e0f78e91a3d76bc79e184ff51876e33"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzA5ODAyMw==", "bodyText": "I have not tested, but the domain without protocol may work as well.", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2557#discussion_r403098023", "createdAt": "2020-04-03T15:45:27Z", "author": {"login": "grayside"}, "path": "run/authentication/src/main/java/com/example/cloudrun/Authentication.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.cloudrun;\n+\n+// [START run_service_to_service_auth]\n+import java.io.IOException;\n+import java.util.concurrent.TimeUnit;\n+import okhttp3.OkHttpClient;\n+import okhttp3.Request;\n+import okhttp3.Response;\n+\n+public class Authentication {\n+\n+  // Instantiate OkHttpClient\n+  private static final OkHttpClient ok =\n+      new OkHttpClient.Builder()\n+          .readTimeout(500, TimeUnit.MILLISECONDS)\n+          .writeTimeout(500, TimeUnit.MILLISECONDS)\n+          .build();\n+\n+  // makeGetRequest makes a GET request to the specified Cloud Run endpoint,\n+  // serviceUrl (must be a complete URL), by authenticating with the Id token", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c0673400e0f78e91a3d76bc79e184ff51876e33"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEwNjk4MQ==", "bodyText": "This seems like a good direction for an integration test of whether the metadata server is responding as expected. However, tests with variable expected behavior makes the definition of a passing ambiguous. Maybe the test could log the context around metadata server existing?", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2557#discussion_r403106981", "createdAt": "2020-04-03T15:59:55Z", "author": {"login": "grayside"}, "path": "run/authentication/src/test/java/com/example/cloudrun/AuthenticationTest.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.cloudrun;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.core.StringContains.containsString;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.PrintStream;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class AuthenticationTest {\n+  private ByteArrayOutputStream bout;\n+  private PrintStream out;\n+\n+  @Before\n+  public void setUp() {\n+    bout = new ByteArrayOutputStream();\n+    out = new PrintStream(bout);\n+    System.setOut(out);\n+  }\n+\n+  @After\n+  public void tearDown() {\n+    System.setOut(null);\n+  }\n+\n+  @Test\n+  public void canMakeGetRequest() throws IOException {\n+    String url = \"http://example.com/\";\n+    String expectedResp;\n+    if (System.getenv(\"GOOGLE_CLOUD_PROJECT\") != null) {\n+      expectedResp = \"Id token query succeeded\";\n+    } else {\n+      expectedResp = \"Id token query failed\";\n+    }\n+    Authentication.makeGetRequest(url);\n+    String got = bout.toString();\n+    assertThat(got, containsString(expectedResp));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c0673400e0f78e91a3d76bc79e184ff51876e33"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzEwODEyMA==", "bodyText": "If run locally, GOOGLE_CLOUD_PROJECT is completely optional. If run without that variable set it may be worth logging some corrective instruction.", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2557#discussion_r403108120", "createdAt": "2020-04-03T16:01:49Z", "author": {"login": "grayside"}, "path": "run/authentication/src/test/java/com/example/cloudrun/AuthenticationTest.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.cloudrun;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.core.StringContains.containsString;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.PrintStream;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+public class AuthenticationTest {\n+  private ByteArrayOutputStream bout;\n+  private PrintStream out;\n+\n+  @Before\n+  public void setUp() {\n+    bout = new ByteArrayOutputStream();\n+    out = new PrintStream(bout);\n+    System.setOut(out);\n+  }\n+\n+  @After\n+  public void tearDown() {\n+    System.setOut(null);\n+  }\n+\n+  @Test\n+  public void canMakeGetRequest() throws IOException {\n+    String url = \"http://example.com/\";\n+    String expectedResp;\n+    if (System.getenv(\"GOOGLE_CLOUD_PROJECT\") != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c0673400e0f78e91a3d76bc79e184ff51876e33"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0ec26a2576d93c34b72684554b16111c9343091", "author": {"user": {"login": "averikitsch", "name": "Averi Kitsch"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/b0ec26a2576d93c34b72684554b16111c9343091", "committedDate": "2020-04-03T18:46:28Z", "message": "Update and comment tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc07b4ec5fd7d9963cb0ba0cdd022be694770f93", "author": {"user": {"login": "averikitsch", "name": "Averi Kitsch"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/bc07b4ec5fd7d9963cb0ba0cdd022be694770f93", "committedDate": "2020-04-03T18:46:40Z", "message": "Update timeout just in case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcd5c78530f84318001ea8cc9e550b2d4b921f2e", "author": {"user": {"login": "averikitsch", "name": "Averi Kitsch"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/dcd5c78530f84318001ea8cc9e550b2d4b921f2e", "committedDate": "2020-04-03T18:47:17Z", "message": "Merge branch 'auth-sample' of https://github.com/GoogleCloudPlatform/java-docs-samples into auth-sample"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1745e15320bfb9a2532a1ef144e087f003747f79", "author": {"user": {"login": "averikitsch", "name": "Averi Kitsch"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/1745e15320bfb9a2532a1ef144e087f003747f79", "committedDate": "2020-04-03T18:53:24Z", "message": "Update tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1b5668e548fd71eb66d2b4df67fd0438867ce5a", "author": {"user": {"login": "averikitsch", "name": "Averi Kitsch"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/d1b5668e548fd71eb66d2b4df67fd0438867ce5a", "committedDate": "2020-04-03T19:05:55Z", "message": "Merge branch 'master' into auth-sample"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NTM2ODIy", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2557#pullrequestreview-387536822", "createdAt": "2020-04-03T19:48:37Z", "commit": {"oid": "d1b5668e548fd71eb66d2b4df67fd0438867ce5a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 895, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}