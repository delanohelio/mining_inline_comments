{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5MDcwNTI3", "number": 2413, "title": "GCF: retries samples", "bodyText": "Do not merge until exception-throwing retry behavior is tested with GCF itself. (Those tests are likely blocked on b/148506815.)\nObviates #1807", "createdAt": "2020-03-16T08:33:54Z", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2413", "merged": true, "mergeCommit": {"oid": "0edfd205e9dfd4d5cb1243faf31270ba97a85a85"}, "closed": true, "closedAt": "2020-03-24T23:40:24Z", "author": {"login": "ace-n"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOJtl7AH2gAyMzg5MDcwNTI3OjJkMTUyNTFmNTJmMjFmY2JjZDM2ZjQyNzU5YmQzZWRiNjgyYTc3NmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQ7j-lAH2gAyMzg5MDcwNTI3OmVkMDI3YTk4ZmIwN2UyMTcyZDljNWYzZDMwYWQwODU5NmFjNzk0Yzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2d15251f52f21fcbcd36f42759bd3edb682a776f", "author": {"user": {"login": "ace-n", "name": "Ace Nassri"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/2d15251f52f21fcbcd36f42759bd3edb682a776f", "committedDate": "2020-03-16T08:19:58Z", "message": "First draft of retries samples"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24ffac43784dbc3defbb19d023a0029448c1a0c1", "author": {"user": {"login": "ace-n", "name": "Ace Nassri"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/24ffac43784dbc3defbb19d023a0029448c1a0c1", "committedDate": "2020-03-16T09:31:17Z", "message": "Remove stray comment + fix test failures"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NTkzODM3", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2413#pullrequestreview-375593837", "createdAt": "2020-03-16T21:26:20Z", "commit": {"oid": "24ffac43784dbc3defbb19d023a0029448c1a0c1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMToyNjoyMFrOF3GT3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMToyNjoyMFrOF3GT3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzMxOTM5MA==", "bodyText": "If this wasn't in a test, I'd be unhappy as it's assuming a lot.  Ok here, however.", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2413#discussion_r393319390", "createdAt": "2020-03-16T21:26:20Z", "author": {"login": "lesv"}, "path": "functions/snippets/src/test/java/com/example/functions/SnippetsTests.java", "diffHunk": "@@ -293,6 +288,75 @@ public void helloHttp_bodyParamsPost() throws IOException {\n     assertThat(responseOut.toString()).isEqualTo(\"Hello Jane!\");\n   }\n \n+  @Test(expected = RuntimeException.class)\n+  public void retryPubsub_handlesRetryMsg() throws IOException {\n+    PubSubMessage pubsubMessage = new PubSubMessage();\n+    pubsubMessage.setData(\"{\\\"retry\\\": true}\");\n+\n+    new RetryPubSub().accept(pubsubMessage, null);\n+\n+    String logMessage = logHandler.getStoredLogRecords().get(0).getMessage();\n+  }\n+\n+  @Test\n+  public void retryPubsub_handlesStopMsg() throws IOException {\n+    PubSubMessage pubsubMessage = new PubSubMessage();\n+    pubsubMessage.setData(\"{\\\"retry\\\": false}\");\n+\n+    new RetryPubSub().accept(pubsubMessage, null);\n+\n+    String logMessage = logHandler.getStoredLogRecords().get(0).getMessage();\n+    assertThat(\"Not retrying...\").isEqualTo(logMessage);\n+  }\n+\n+  @Test\n+  public void retryPubsub_handlesEmptyMsg() throws IOException {\n+    new RetryPubSub().accept(new PubSubMessage(), null);\n+\n+    String logMessage = logHandler.getStoredLogRecords().get(0).getMessage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24ffac43784dbc3defbb19d023a0029448c1a0c1"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3ODQxODkz", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2413#pullrequestreview-377841893", "createdAt": "2020-03-19T15:38:36Z", "commit": {"oid": "24ffac43784dbc3defbb19d023a0029448c1a0c1"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNTozODozNlrOF40TMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNTozODo1OFrOF40UHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEyMTQ1Ng==", "bodyText": "nit: Can you import com.example.functions.PubSubMessage so this can be cleaner?", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2413#discussion_r395121456", "createdAt": "2020-03-19T15:38:36Z", "author": {"login": "averikitsch"}, "path": "functions/snippets/src/main/java/com/example/functions/InfiniteRetryPubSub.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_tips_infinite_retries]\n+import com.google.api.client.util.DateTime;\n+import com.google.cloud.functions.BackgroundFunction;\n+import com.google.cloud.functions.Context;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonObject;\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.time.LocalDateTime;\n+import java.time.ZoneOffset;\n+import java.time.ZonedDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+\n+public class InfiniteRetryPubSub implements BackgroundFunction<PubSubMessage> {\n+  private static final Logger LOGGER = Logger.getLogger(InfiniteRetryPubSub.class.getName());\n+  private static final long MAX_EVENT_AGE = 10_000;\n+\n+  // Use Gson (https://github.com/google/gson) to parse JSON content.\n+  private Gson gsonParser = new Gson();\n+\n+  /**\n+   * Background Cloud Function that only executes within\n+   * a certain time period after the triggering event\n+   */\n+  @Override\n+  public void accept(com.example.functions.PubSubMessage message, Context context) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24ffac43784dbc3defbb19d023a0029448c1a0c1"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEyMTY5Mw==", "bodyText": "nit: improve this comment", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2413#discussion_r395121693", "createdAt": "2020-03-19T15:38:58Z", "author": {"login": "averikitsch"}, "path": "functions/snippets/src/main/java/com/example/functions/InfiniteRetryPubSub.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_tips_infinite_retries]\n+import com.google.api.client.util.DateTime;\n+import com.google.cloud.functions.BackgroundFunction;\n+import com.google.cloud.functions.Context;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonObject;\n+import java.time.Duration;\n+import java.time.Instant;\n+import java.time.LocalDateTime;\n+import java.time.ZoneOffset;\n+import java.time.ZonedDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+\n+public class InfiniteRetryPubSub implements BackgroundFunction<PubSubMessage> {\n+  private static final Logger LOGGER = Logger.getLogger(InfiniteRetryPubSub.class.getName());\n+  private static final long MAX_EVENT_AGE = 10_000;\n+\n+  // Use Gson (https://github.com/google/gson) to parse JSON content.\n+  private Gson gsonParser = new Gson();\n+\n+  /**\n+   * Background Cloud Function that only executes within\n+   * a certain time period after the triggering event\n+   */\n+  @Override\n+  public void accept(com.example.functions.PubSubMessage message, Context context) {\n+    ZonedDateTime utcNow = ZonedDateTime.now(ZoneOffset.UTC);\n+    ZonedDateTime timestamp = utcNow;\n+\n+    JsonObject body = gsonParser.fromJson(message.data, JsonObject.class);\n+    if (body != null && body.has(\"timestamp\")) {\n+      String tz = body.get(\"timestamp\").getAsString();\n+      timestamp = ZonedDateTime.parse(tz);\n+    }\n+    long eventAge = Duration.between(timestamp, utcNow).toMillis();\n+\n+    // Ignore events that are too old\n+    if (eventAge > MAX_EVENT_AGE) {\n+      LOGGER.info(String.format(\"Dropping event %s.\", body));\n+      return;\n+    }\n+\n+    // Do what the function is supposed to do", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24ffac43784dbc3defbb19d023a0029448c1a0c1"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5adb2d79f3268ac7e6b9a0d8054ad4d3f9d0c73", "author": {"user": {"login": "ace-n", "name": "Ace Nassri"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/f5adb2d79f3268ac7e6b9a0d8054ad4d3f9d0c73", "committedDate": "2020-03-20T03:27:59Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "911f5b234974379789d7a76308d3fd12ea9c1bf7", "author": {"user": {"login": "ace-n", "name": "Ace Nassri"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/911f5b234974379789d7a76308d3fd12ea9c1bf7", "committedDate": "2020-03-21T00:47:02Z", "message": "Merge branch 'master' into gcf-retries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f183a3c4404bdb38121814485fbd8feccd7d61b1", "author": {"user": {"login": "ace-n", "name": "Ace Nassri"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/f183a3c4404bdb38121814485fbd8feccd7d61b1", "committedDate": "2020-03-21T03:17:10Z", "message": "Fix base64 issues on CF itself"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NzU3Mzk4", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2413#pullrequestreview-379757398", "createdAt": "2020-03-23T19:32:28Z", "commit": {"oid": "f183a3c4404bdb38121814485fbd8feccd7d61b1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxOTozMjoyOFrOF6U8qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxOTozMjoyOFrOF6U8qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcwNDkzOQ==", "bodyText": "Can you add more comments here since it's confusing what it's doing. Also this should document the thrown error.", "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/pull/2413#discussion_r396704939", "createdAt": "2020-03-23T19:32:28Z", "author": {"login": "averikitsch"}, "path": "functions/snippets/src/main/java/com/example/functions/RetryPubSub.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.example.functions;\n+\n+// [START functions_tips_retry]\n+import com.google.cloud.functions.BackgroundFunction;\n+import com.google.cloud.functions.Context;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonElement;\n+import com.google.gson.JsonObject;\n+import java.util.Base64;\n+import java.util.logging.Logger;\n+\n+public class RetryPubSub implements BackgroundFunction<PubSubMessage> {\n+  private static final Logger LOGGER = Logger.getLogger(RetryPubSub.class.getName());\n+\n+  // Use Gson (https://github.com/google/gson) to parse JSON content.\n+  private Gson gsonParser = new Gson();\n+\n+  @Override\n+  public void accept(PubSubMessage message, Context context) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f183a3c4404bdb38121814485fbd8feccd7d61b1"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aea4d04bcd1aa6cba2bd8ee34ad3ac5ee3b3ad04", "author": {"user": {"login": "ace-n", "name": "Ace Nassri"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/aea4d04bcd1aa6cba2bd8ee34ad3ac5ee3b3ad04", "committedDate": "2020-03-23T20:32:43Z", "message": "Add explainer comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd1eb677f11fda003fa382dcbf56cae920410345", "author": {"user": {"login": "ace-n", "name": "Ace Nassri"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/dd1eb677f11fda003fa382dcbf56cae920410345", "committedDate": "2020-03-23T21:53:22Z", "message": "Merge branch 'master' into gcf-retries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2353badb7398ac7a18dcbe8dd8b426d8ec4b3b51", "author": {"user": {"login": "ace-n", "name": "Ace Nassri"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/2353badb7398ac7a18dcbe8dd8b426d8ec4b3b51", "committedDate": "2020-03-23T22:49:01Z", "message": "Merge branch 'master' into gcf-retries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed027a98fb07e2172d9c5f3d30ad08596ac794c8", "author": {"user": {"login": "ace-n", "name": "Ace Nassri"}}, "url": "https://github.com/GoogleCloudPlatform/java-docs-samples/commit/ed027a98fb07e2172d9c5f3d30ad08596ac794c8", "committedDate": "2020-03-24T23:32:34Z", "message": "Merge branch 'master' into gcf-retries"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 926, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}