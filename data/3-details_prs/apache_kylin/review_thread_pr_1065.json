{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzNDMxNjYz", "number": 1065, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwOTo1NDo0NVrODd996g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwOTo1OTozNFrODd-Dnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNzUwNTcwOnYy", "diffSide": "RIGHT", "path": "engine-mr/src/main/java/org/apache/kylin/engine/mr/streaming/RowRecordReader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwOTo1NDo0NVrOFm3ytA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwOTo1NDo0NVrOFm3ytA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwNDMwOA==", "bodyText": "Should NOT close dimInputStream here, otherwise dimensionColumnReaderItrs will be broken. These InputStream will be closed in close method of RowRecordReader.java.", "url": "https://github.com/apache/kylin/pull/1065#discussion_r376304308", "createdAt": "2020-02-07T09:54:45Z", "author": {"login": "hit-lacus"}, "path": "engine-mr/src/main/java/org/apache/kylin/engine/mr/streaming/RowRecordReader.java", "diffHunk": "@@ -82,51 +82,72 @@ public RowRecordReader(CubeDesc cubeDesc, Path path, FileSystem fileSystem) thro\n     }\n \n     public void initReaders() throws IOException {\n-        FSDataInputStream in = fs.open(metaFilePath);\n-        FragmentMetaInfo fragmentMetaInfo = JsonUtil.readValue(in, FragmentMetaInfo.class);\n-        CuboidMetaInfo basicCuboidMetaInfo = fragmentMetaInfo.getBasicCuboidMetaInfo();\n-        FSDataInputStream dictInputStream = fs.open(dataFilePath);\n+        FSDataInputStream in = null;\n+        try {\n+            in = fs.open(metaFilePath);\n+            FragmentMetaInfo fragmentMetaInfo = JsonUtil.readValue(in, FragmentMetaInfo.class);\n+            CuboidMetaInfo basicCuboidMetaInfo = fragmentMetaInfo.getBasicCuboidMetaInfo();\n+            FSDataInputStream dictInputStream = fs.open(dataFilePath);\n \n-        List<DimensionMetaInfo> allDimensions = basicCuboidMetaInfo.getDimensionsInfo();\n-        Map<String, DimensionEncoding> dimensionEncodingMap = getDimensionEncodings(fragmentMetaInfo, allDimensions,\n-                dictInputStream);\n-        dimensionColumnReaders = Lists.newArrayList();\n-        dimensionColumnReaderItrs = Lists.newArrayList();\n-        dimensionEncodings = Lists.newArrayList();\n-        for (DimensionMetaInfo dimensionMetaInfo : allDimensions) {\n-            FSDataInputStream dimInputStream = fs.open(dataFilePath);\n-            String dimName = dimensionMetaInfo.getName();\n-            DimensionEncoding dimEncoding = dimensionEncodingMap.get(dimName);\n-            ColumnarStoreDimDesc dimDesc = new ColumnarStoreDimDesc(dimEncoding.getLengthOfEncoding(),\n-                    dimensionMetaInfo.getCompressionType());\n-            ColumnDataReader dimDataReader = dimDesc.getDimReaderFromFSInput(dimInputStream,\n-                    dimensionMetaInfo.getStartOffset(), dimensionMetaInfo.getDataLength(),\n-                    (int) basicCuboidMetaInfo.getNumberOfRows());\n-            dimensionColumnReaders.add(dimDataReader);\n-            dimensionColumnReaderItrs.add(dimDataReader.iterator());\n-            dimensionEncodings.add(dimEncoding);\n-        }\n-        rowDimensionValues = new String[dimensionColumnReaders.size()];\n+            List<DimensionMetaInfo> allDimensions = basicCuboidMetaInfo.getDimensionsInfo();\n+            Map<String, DimensionEncoding> dimensionEncodingMap = getDimensionEncodings(fragmentMetaInfo, allDimensions,\n+                    dictInputStream);\n+            dimensionColumnReaders = Lists.newArrayList();\n+            dimensionColumnReaderItrs = Lists.newArrayList();\n+            dimensionEncodings = Lists.newArrayList();\n+            for (DimensionMetaInfo dimensionMetaInfo : allDimensions) {\n+                FSDataInputStream dimInputStream = null;\n+                try {\n+                    dimInputStream = fs.open(dataFilePath);\n+                    String dimName = dimensionMetaInfo.getName();\n+                    DimensionEncoding dimEncoding = dimensionEncodingMap.get(dimName);\n+                    ColumnarStoreDimDesc dimDesc = new ColumnarStoreDimDesc(dimEncoding.getLengthOfEncoding(),\n+                            dimensionMetaInfo.getCompressionType());\n+                    ColumnDataReader dimDataReader = dimDesc.getDimReaderFromFSInput(dimInputStream,\n+                            dimensionMetaInfo.getStartOffset(), dimensionMetaInfo.getDataLength(),\n+                            (int) basicCuboidMetaInfo.getNumberOfRows());\n+                    dimensionColumnReaders.add(dimDataReader);\n+                    dimensionColumnReaderItrs.add(dimDataReader.iterator());\n+                    dimensionEncodings.add(dimEncoding);\n+                } finally {\n+                    if (null != dimInputStream) {\n+                        dimInputStream.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a2ecde43662553338ce99a3921005b1077dff80"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNzUyMDMxOnYy", "diffSide": "RIGHT", "path": "engine-mr/src/main/java/org/apache/kylin/engine/mr/streaming/RowRecordReader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwOTo1OTozNFrOFm37gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwOTo1OTozNFrOFm37gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwNjU2Mw==", "bodyText": "metricsInputStream  should not be closed for the same reason.", "url": "https://github.com/apache/kylin/pull/1065#discussion_r376306563", "createdAt": "2020-02-07T09:59:34Z", "author": {"login": "hit-lacus"}, "path": "engine-mr/src/main/java/org/apache/kylin/engine/mr/streaming/RowRecordReader.java", "diffHunk": "@@ -82,51 +82,72 @@ public RowRecordReader(CubeDesc cubeDesc, Path path, FileSystem fileSystem) thro\n     }\n \n     public void initReaders() throws IOException {\n-        FSDataInputStream in = fs.open(metaFilePath);\n-        FragmentMetaInfo fragmentMetaInfo = JsonUtil.readValue(in, FragmentMetaInfo.class);\n-        CuboidMetaInfo basicCuboidMetaInfo = fragmentMetaInfo.getBasicCuboidMetaInfo();\n-        FSDataInputStream dictInputStream = fs.open(dataFilePath);\n+        FSDataInputStream in = null;\n+        try {\n+            in = fs.open(metaFilePath);\n+            FragmentMetaInfo fragmentMetaInfo = JsonUtil.readValue(in, FragmentMetaInfo.class);\n+            CuboidMetaInfo basicCuboidMetaInfo = fragmentMetaInfo.getBasicCuboidMetaInfo();\n+            FSDataInputStream dictInputStream = fs.open(dataFilePath);\n \n-        List<DimensionMetaInfo> allDimensions = basicCuboidMetaInfo.getDimensionsInfo();\n-        Map<String, DimensionEncoding> dimensionEncodingMap = getDimensionEncodings(fragmentMetaInfo, allDimensions,\n-                dictInputStream);\n-        dimensionColumnReaders = Lists.newArrayList();\n-        dimensionColumnReaderItrs = Lists.newArrayList();\n-        dimensionEncodings = Lists.newArrayList();\n-        for (DimensionMetaInfo dimensionMetaInfo : allDimensions) {\n-            FSDataInputStream dimInputStream = fs.open(dataFilePath);\n-            String dimName = dimensionMetaInfo.getName();\n-            DimensionEncoding dimEncoding = dimensionEncodingMap.get(dimName);\n-            ColumnarStoreDimDesc dimDesc = new ColumnarStoreDimDesc(dimEncoding.getLengthOfEncoding(),\n-                    dimensionMetaInfo.getCompressionType());\n-            ColumnDataReader dimDataReader = dimDesc.getDimReaderFromFSInput(dimInputStream,\n-                    dimensionMetaInfo.getStartOffset(), dimensionMetaInfo.getDataLength(),\n-                    (int) basicCuboidMetaInfo.getNumberOfRows());\n-            dimensionColumnReaders.add(dimDataReader);\n-            dimensionColumnReaderItrs.add(dimDataReader.iterator());\n-            dimensionEncodings.add(dimEncoding);\n-        }\n-        rowDimensionValues = new String[dimensionColumnReaders.size()];\n+            List<DimensionMetaInfo> allDimensions = basicCuboidMetaInfo.getDimensionsInfo();\n+            Map<String, DimensionEncoding> dimensionEncodingMap = getDimensionEncodings(fragmentMetaInfo, allDimensions,\n+                    dictInputStream);\n+            dimensionColumnReaders = Lists.newArrayList();\n+            dimensionColumnReaderItrs = Lists.newArrayList();\n+            dimensionEncodings = Lists.newArrayList();\n+            for (DimensionMetaInfo dimensionMetaInfo : allDimensions) {\n+                FSDataInputStream dimInputStream = null;\n+                try {\n+                    dimInputStream = fs.open(dataFilePath);\n+                    String dimName = dimensionMetaInfo.getName();\n+                    DimensionEncoding dimEncoding = dimensionEncodingMap.get(dimName);\n+                    ColumnarStoreDimDesc dimDesc = new ColumnarStoreDimDesc(dimEncoding.getLengthOfEncoding(),\n+                            dimensionMetaInfo.getCompressionType());\n+                    ColumnDataReader dimDataReader = dimDesc.getDimReaderFromFSInput(dimInputStream,\n+                            dimensionMetaInfo.getStartOffset(), dimensionMetaInfo.getDataLength(),\n+                            (int) basicCuboidMetaInfo.getNumberOfRows());\n+                    dimensionColumnReaders.add(dimDataReader);\n+                    dimensionColumnReaderItrs.add(dimDataReader.iterator());\n+                    dimensionEncodings.add(dimEncoding);\n+                } finally {\n+                    if (null != dimInputStream) {\n+                        dimInputStream.close();\n+                    }\n+                }\n+            }\n+            rowDimensionValues = new String[dimensionColumnReaders.size()];\n \n-        metricsColumnReaders = Lists.newArrayList();\n-        metricsColumnReaderItrs = Lists.newArrayList();\n-        metricsDataTransformers = Lists.newArrayList();\n-        for (MetricMetaInfo metricMetaInfo : basicCuboidMetaInfo.getMetricsInfo()) {\n-            FSDataInputStream metricsInputStream = fs.open(dataFilePath);\n-            MeasureDesc measure = findMeasure(metricMetaInfo.getName());\n-            DataType metricsDataType = measure.getFunction().getReturnDataType();\n-            ColumnarMetricsEncoding metricsEncoding = ColumnarMetricsEncodingFactory.create(metricsDataType);\n-            ColumnarStoreMetricsDesc metricsDesc = new ColumnarStoreMetricsDesc(metricsEncoding,\n-                    metricMetaInfo.getCompressionType());\n-            ColumnDataReader metricsDataReader = metricsDesc.getMetricsReaderFromFSInput(metricsInputStream,\n-                    metricMetaInfo.getStartOffset(), metricMetaInfo.getMetricLength(),\n-                    (int) basicCuboidMetaInfo.getNumberOfRows());\n-            metricsColumnReaders.add(metricsDataReader);\n-            metricsColumnReaderItrs.add(metricsDataReader.iterator());\n-            metricsDataTransformers.add(new MetricsDataTransformer(metricsEncoding.asDataTypeSerializer(),\n-                    DataTypeSerializer.create(metricsDataType)));\n+            metricsColumnReaders = Lists.newArrayList();\n+            metricsColumnReaderItrs = Lists.newArrayList();\n+            metricsDataTransformers = Lists.newArrayList();\n+            for (MetricMetaInfo metricMetaInfo : basicCuboidMetaInfo.getMetricsInfo()) {\n+                FSDataInputStream metricsInputStream = null;\n+                try {\n+                    metricsInputStream = fs.open(dataFilePath);\n+                    MeasureDesc measure = findMeasure(metricMetaInfo.getName());\n+                    DataType metricsDataType = measure.getFunction().getReturnDataType();\n+                    ColumnarMetricsEncoding metricsEncoding = ColumnarMetricsEncodingFactory.create(metricsDataType);\n+                    ColumnarStoreMetricsDesc metricsDesc = new ColumnarStoreMetricsDesc(metricsEncoding,\n+                            metricMetaInfo.getCompressionType());\n+                    ColumnDataReader metricsDataReader = metricsDesc.getMetricsReaderFromFSInput(metricsInputStream,\n+                            metricMetaInfo.getStartOffset(), metricMetaInfo.getMetricLength(),\n+                            (int) basicCuboidMetaInfo.getNumberOfRows());\n+                    metricsColumnReaders.add(metricsDataReader);\n+                    metricsColumnReaderItrs.add(metricsDataReader.iterator());\n+                    metricsDataTransformers.add(new MetricsDataTransformer(metricsEncoding.asDataTypeSerializer(),\n+                            DataTypeSerializer.create(metricsDataType)));\n+                } finally {\n+                    if (null != metricsInputStream) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a2ecde43662553338ce99a3921005b1077dff80"}, "originalPosition": 100}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1541, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}