{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzNDMxNjYz", "number": 1065, "title": "KYLIN-4349 Close InputStream in RowRecordReader.initReaders()", "bodyText": "", "createdAt": "2020-01-16T02:59:21Z", "url": "https://github.com/apache/kylin/pull/1065", "merged": true, "mergeCommit": {"oid": "3eff292e7d0ecfca5a68d55f5c62243da719ac89"}, "closed": true, "closedAt": "2020-02-05T12:55:36Z", "author": {"login": "weibin0516"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6xLOqgH2gAyMzYzNDMxNjYzOjNhMmVjZGU0MzY2MjU1MzMzOGNlOTlhMzkyMTAwNWIxMDc3ZGZmODA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcB8XH3AFqTM1NTA0NjEyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3a2ecde43662553338ce99a3921005b1077dff80", "author": {"user": {"login": "weibin0516", "name": "weibinzhu"}}, "url": "https://github.com/apache/kylin/commit/3a2ecde43662553338ce99a3921005b1077dff80", "committedDate": "2020-01-16T03:00:09Z", "message": "KYLIN-4349 Close InputStream in RowRecordReader.initReaders()"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03cf5dcf3e2d1145594c936b87a8414820fb10e6", "author": {"user": {"login": "weibin0516", "name": "weibinzhu"}}, "url": "https://github.com/apache/kylin/commit/03cf5dcf3e2d1145594c936b87a8414820fb10e6", "committedDate": "2020-01-16T02:58:32Z", "message": "KYLIN-4349 Close InputStream in RowRecordReader.initReaders()"}, "afterCommit": {"oid": "3a2ecde43662553338ce99a3921005b1077dff80", "author": {"user": {"login": "weibin0516", "name": "weibinzhu"}}, "url": "https://github.com/apache/kylin/commit/3a2ecde43662553338ce99a3921005b1077dff80", "committedDate": "2020-01-16T03:00:09Z", "message": "KYLIN-4349 Close InputStream in RowRecordReader.initReaders()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNjkyNzE3", "url": "https://github.com/apache/kylin/pull/1065#pullrequestreview-353692717", "createdAt": "2020-02-05T12:55:23Z", "commit": {"oid": "3a2ecde43662553338ce99a3921005b1077dff80"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MDQzMjE3", "url": "https://github.com/apache/kylin/pull/1065#pullrequestreview-355043217", "createdAt": "2020-02-07T09:54:45Z", "commit": {"oid": "3a2ecde43662553338ce99a3921005b1077dff80"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwOTo1NDo0NVrOFm3ytA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwOTo1NDo0NVrOFm3ytA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwNDMwOA==", "bodyText": "Should NOT close dimInputStream here, otherwise dimensionColumnReaderItrs will be broken. These InputStream will be closed in close method of RowRecordReader.java.", "url": "https://github.com/apache/kylin/pull/1065#discussion_r376304308", "createdAt": "2020-02-07T09:54:45Z", "author": {"login": "hit-lacus"}, "path": "engine-mr/src/main/java/org/apache/kylin/engine/mr/streaming/RowRecordReader.java", "diffHunk": "@@ -82,51 +82,72 @@ public RowRecordReader(CubeDesc cubeDesc, Path path, FileSystem fileSystem) thro\n     }\n \n     public void initReaders() throws IOException {\n-        FSDataInputStream in = fs.open(metaFilePath);\n-        FragmentMetaInfo fragmentMetaInfo = JsonUtil.readValue(in, FragmentMetaInfo.class);\n-        CuboidMetaInfo basicCuboidMetaInfo = fragmentMetaInfo.getBasicCuboidMetaInfo();\n-        FSDataInputStream dictInputStream = fs.open(dataFilePath);\n+        FSDataInputStream in = null;\n+        try {\n+            in = fs.open(metaFilePath);\n+            FragmentMetaInfo fragmentMetaInfo = JsonUtil.readValue(in, FragmentMetaInfo.class);\n+            CuboidMetaInfo basicCuboidMetaInfo = fragmentMetaInfo.getBasicCuboidMetaInfo();\n+            FSDataInputStream dictInputStream = fs.open(dataFilePath);\n \n-        List<DimensionMetaInfo> allDimensions = basicCuboidMetaInfo.getDimensionsInfo();\n-        Map<String, DimensionEncoding> dimensionEncodingMap = getDimensionEncodings(fragmentMetaInfo, allDimensions,\n-                dictInputStream);\n-        dimensionColumnReaders = Lists.newArrayList();\n-        dimensionColumnReaderItrs = Lists.newArrayList();\n-        dimensionEncodings = Lists.newArrayList();\n-        for (DimensionMetaInfo dimensionMetaInfo : allDimensions) {\n-            FSDataInputStream dimInputStream = fs.open(dataFilePath);\n-            String dimName = dimensionMetaInfo.getName();\n-            DimensionEncoding dimEncoding = dimensionEncodingMap.get(dimName);\n-            ColumnarStoreDimDesc dimDesc = new ColumnarStoreDimDesc(dimEncoding.getLengthOfEncoding(),\n-                    dimensionMetaInfo.getCompressionType());\n-            ColumnDataReader dimDataReader = dimDesc.getDimReaderFromFSInput(dimInputStream,\n-                    dimensionMetaInfo.getStartOffset(), dimensionMetaInfo.getDataLength(),\n-                    (int) basicCuboidMetaInfo.getNumberOfRows());\n-            dimensionColumnReaders.add(dimDataReader);\n-            dimensionColumnReaderItrs.add(dimDataReader.iterator());\n-            dimensionEncodings.add(dimEncoding);\n-        }\n-        rowDimensionValues = new String[dimensionColumnReaders.size()];\n+            List<DimensionMetaInfo> allDimensions = basicCuboidMetaInfo.getDimensionsInfo();\n+            Map<String, DimensionEncoding> dimensionEncodingMap = getDimensionEncodings(fragmentMetaInfo, allDimensions,\n+                    dictInputStream);\n+            dimensionColumnReaders = Lists.newArrayList();\n+            dimensionColumnReaderItrs = Lists.newArrayList();\n+            dimensionEncodings = Lists.newArrayList();\n+            for (DimensionMetaInfo dimensionMetaInfo : allDimensions) {\n+                FSDataInputStream dimInputStream = null;\n+                try {\n+                    dimInputStream = fs.open(dataFilePath);\n+                    String dimName = dimensionMetaInfo.getName();\n+                    DimensionEncoding dimEncoding = dimensionEncodingMap.get(dimName);\n+                    ColumnarStoreDimDesc dimDesc = new ColumnarStoreDimDesc(dimEncoding.getLengthOfEncoding(),\n+                            dimensionMetaInfo.getCompressionType());\n+                    ColumnDataReader dimDataReader = dimDesc.getDimReaderFromFSInput(dimInputStream,\n+                            dimensionMetaInfo.getStartOffset(), dimensionMetaInfo.getDataLength(),\n+                            (int) basicCuboidMetaInfo.getNumberOfRows());\n+                    dimensionColumnReaders.add(dimDataReader);\n+                    dimensionColumnReaderItrs.add(dimDataReader.iterator());\n+                    dimensionEncodings.add(dimEncoding);\n+                } finally {\n+                    if (null != dimInputStream) {\n+                        dimInputStream.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a2ecde43662553338ce99a3921005b1077dff80"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MDQ2MTIx", "url": "https://github.com/apache/kylin/pull/1065#pullrequestreview-355046121", "createdAt": "2020-02-07T09:59:33Z", "commit": {"oid": "3a2ecde43662553338ce99a3921005b1077dff80"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwOTo1OTozNFrOFm37gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwOTo1OTozNFrOFm37gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwNjU2Mw==", "bodyText": "metricsInputStream  should not be closed for the same reason.", "url": "https://github.com/apache/kylin/pull/1065#discussion_r376306563", "createdAt": "2020-02-07T09:59:34Z", "author": {"login": "hit-lacus"}, "path": "engine-mr/src/main/java/org/apache/kylin/engine/mr/streaming/RowRecordReader.java", "diffHunk": "@@ -82,51 +82,72 @@ public RowRecordReader(CubeDesc cubeDesc, Path path, FileSystem fileSystem) thro\n     }\n \n     public void initReaders() throws IOException {\n-        FSDataInputStream in = fs.open(metaFilePath);\n-        FragmentMetaInfo fragmentMetaInfo = JsonUtil.readValue(in, FragmentMetaInfo.class);\n-        CuboidMetaInfo basicCuboidMetaInfo = fragmentMetaInfo.getBasicCuboidMetaInfo();\n-        FSDataInputStream dictInputStream = fs.open(dataFilePath);\n+        FSDataInputStream in = null;\n+        try {\n+            in = fs.open(metaFilePath);\n+            FragmentMetaInfo fragmentMetaInfo = JsonUtil.readValue(in, FragmentMetaInfo.class);\n+            CuboidMetaInfo basicCuboidMetaInfo = fragmentMetaInfo.getBasicCuboidMetaInfo();\n+            FSDataInputStream dictInputStream = fs.open(dataFilePath);\n \n-        List<DimensionMetaInfo> allDimensions = basicCuboidMetaInfo.getDimensionsInfo();\n-        Map<String, DimensionEncoding> dimensionEncodingMap = getDimensionEncodings(fragmentMetaInfo, allDimensions,\n-                dictInputStream);\n-        dimensionColumnReaders = Lists.newArrayList();\n-        dimensionColumnReaderItrs = Lists.newArrayList();\n-        dimensionEncodings = Lists.newArrayList();\n-        for (DimensionMetaInfo dimensionMetaInfo : allDimensions) {\n-            FSDataInputStream dimInputStream = fs.open(dataFilePath);\n-            String dimName = dimensionMetaInfo.getName();\n-            DimensionEncoding dimEncoding = dimensionEncodingMap.get(dimName);\n-            ColumnarStoreDimDesc dimDesc = new ColumnarStoreDimDesc(dimEncoding.getLengthOfEncoding(),\n-                    dimensionMetaInfo.getCompressionType());\n-            ColumnDataReader dimDataReader = dimDesc.getDimReaderFromFSInput(dimInputStream,\n-                    dimensionMetaInfo.getStartOffset(), dimensionMetaInfo.getDataLength(),\n-                    (int) basicCuboidMetaInfo.getNumberOfRows());\n-            dimensionColumnReaders.add(dimDataReader);\n-            dimensionColumnReaderItrs.add(dimDataReader.iterator());\n-            dimensionEncodings.add(dimEncoding);\n-        }\n-        rowDimensionValues = new String[dimensionColumnReaders.size()];\n+            List<DimensionMetaInfo> allDimensions = basicCuboidMetaInfo.getDimensionsInfo();\n+            Map<String, DimensionEncoding> dimensionEncodingMap = getDimensionEncodings(fragmentMetaInfo, allDimensions,\n+                    dictInputStream);\n+            dimensionColumnReaders = Lists.newArrayList();\n+            dimensionColumnReaderItrs = Lists.newArrayList();\n+            dimensionEncodings = Lists.newArrayList();\n+            for (DimensionMetaInfo dimensionMetaInfo : allDimensions) {\n+                FSDataInputStream dimInputStream = null;\n+                try {\n+                    dimInputStream = fs.open(dataFilePath);\n+                    String dimName = dimensionMetaInfo.getName();\n+                    DimensionEncoding dimEncoding = dimensionEncodingMap.get(dimName);\n+                    ColumnarStoreDimDesc dimDesc = new ColumnarStoreDimDesc(dimEncoding.getLengthOfEncoding(),\n+                            dimensionMetaInfo.getCompressionType());\n+                    ColumnDataReader dimDataReader = dimDesc.getDimReaderFromFSInput(dimInputStream,\n+                            dimensionMetaInfo.getStartOffset(), dimensionMetaInfo.getDataLength(),\n+                            (int) basicCuboidMetaInfo.getNumberOfRows());\n+                    dimensionColumnReaders.add(dimDataReader);\n+                    dimensionColumnReaderItrs.add(dimDataReader.iterator());\n+                    dimensionEncodings.add(dimEncoding);\n+                } finally {\n+                    if (null != dimInputStream) {\n+                        dimInputStream.close();\n+                    }\n+                }\n+            }\n+            rowDimensionValues = new String[dimensionColumnReaders.size()];\n \n-        metricsColumnReaders = Lists.newArrayList();\n-        metricsColumnReaderItrs = Lists.newArrayList();\n-        metricsDataTransformers = Lists.newArrayList();\n-        for (MetricMetaInfo metricMetaInfo : basicCuboidMetaInfo.getMetricsInfo()) {\n-            FSDataInputStream metricsInputStream = fs.open(dataFilePath);\n-            MeasureDesc measure = findMeasure(metricMetaInfo.getName());\n-            DataType metricsDataType = measure.getFunction().getReturnDataType();\n-            ColumnarMetricsEncoding metricsEncoding = ColumnarMetricsEncodingFactory.create(metricsDataType);\n-            ColumnarStoreMetricsDesc metricsDesc = new ColumnarStoreMetricsDesc(metricsEncoding,\n-                    metricMetaInfo.getCompressionType());\n-            ColumnDataReader metricsDataReader = metricsDesc.getMetricsReaderFromFSInput(metricsInputStream,\n-                    metricMetaInfo.getStartOffset(), metricMetaInfo.getMetricLength(),\n-                    (int) basicCuboidMetaInfo.getNumberOfRows());\n-            metricsColumnReaders.add(metricsDataReader);\n-            metricsColumnReaderItrs.add(metricsDataReader.iterator());\n-            metricsDataTransformers.add(new MetricsDataTransformer(metricsEncoding.asDataTypeSerializer(),\n-                    DataTypeSerializer.create(metricsDataType)));\n+            metricsColumnReaders = Lists.newArrayList();\n+            metricsColumnReaderItrs = Lists.newArrayList();\n+            metricsDataTransformers = Lists.newArrayList();\n+            for (MetricMetaInfo metricMetaInfo : basicCuboidMetaInfo.getMetricsInfo()) {\n+                FSDataInputStream metricsInputStream = null;\n+                try {\n+                    metricsInputStream = fs.open(dataFilePath);\n+                    MeasureDesc measure = findMeasure(metricMetaInfo.getName());\n+                    DataType metricsDataType = measure.getFunction().getReturnDataType();\n+                    ColumnarMetricsEncoding metricsEncoding = ColumnarMetricsEncodingFactory.create(metricsDataType);\n+                    ColumnarStoreMetricsDesc metricsDesc = new ColumnarStoreMetricsDesc(metricsEncoding,\n+                            metricMetaInfo.getCompressionType());\n+                    ColumnDataReader metricsDataReader = metricsDesc.getMetricsReaderFromFSInput(metricsInputStream,\n+                            metricMetaInfo.getStartOffset(), metricMetaInfo.getMetricLength(),\n+                            (int) basicCuboidMetaInfo.getNumberOfRows());\n+                    metricsColumnReaders.add(metricsDataReader);\n+                    metricsColumnReaderItrs.add(metricsDataReader.iterator());\n+                    metricsDataTransformers.add(new MetricsDataTransformer(metricsEncoding.asDataTypeSerializer(),\n+                            DataTypeSerializer.create(metricsDataType)));\n+                } finally {\n+                    if (null != metricsInputStream) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a2ecde43662553338ce99a3921005b1077dff80"}, "originalPosition": 100}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2725, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}