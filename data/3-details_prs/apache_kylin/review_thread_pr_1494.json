{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwNzcyMTA1", "number": 1494, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQxMzozNDo1OFrOFI7xQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwMjo1MjozMlrOFJqmig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0OTEyMTkyOnYy", "diffSide": "RIGHT", "path": "storage-hbase/src/main/java/org/apache/kylin/storage/hbase/steps/HBaseJobSteps.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQxMzozNDo1OFrOILHv5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQxMzozNDo1OFrOILHv5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUzMjE5OQ==", "bodyText": "remove commented code if not needed , will help in code readability going forward.", "url": "https://github.com/apache/kylin/pull/1494#discussion_r548532199", "createdAt": "2020-12-24T13:34:58Z", "author": {"login": "nyshthefantastic"}, "path": "storage-hbase/src/main/java/org/apache/kylin/storage/hbase/steps/HBaseJobSteps.java", "diffHunk": "@@ -72,6 +80,26 @@ public HadoopShellExecutable createCreateHTableStep(String jobId, CuboidModeEnum\n         return createHtableStep;\n     }\n \n+    public AbstractExecutable createDistcpHFileStep(String jobId){\n+        String inputPath = getRealizationRootPath(jobId) + \"/hfile\";\n+        MapReduceExecutable createHFilesStep = new MapReduceExecutable();\n+        createHFilesStep.setName(ExecutableConstants.STEP_NAME_HFILE_DISTCP);\n+        StringBuilder cmd = new StringBuilder();\n+\n+        appendMapReduceParameters(cmd);\n+        appendExecCmdParameters(cmd, BatchConstants.ARG_CUBE_NAME, seg.getRealization().getName());\n+//        appendExecCmdParameters(cmd, BatchConstants.ARG_PARTITION, getRowkeyDistributionOutputPath(jobId) + \"/part-r-00000_hfile\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf233c4be4135621107799ee8902dc6787cea043"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0OTEyMzY2OnYy", "diffSide": "RIGHT", "path": "storage-hbase/src/main/java/org/apache/kylin/storage/hbase/steps/HDFSPathGarbageCollectionStep.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQxMzozNjowNFrOILHw2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQxMzozNjowNFrOILHw2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUzMjQ0MQ==", "bodyText": "good to use final if variable is not mutated : final Path parentPath", "url": "https://github.com/apache/kylin/pull/1494#discussion_r548532441", "createdAt": "2020-12-24T13:36:04Z", "author": {"login": "nyshthefantastic"}, "path": "storage-hbase/src/main/java/org/apache/kylin/storage/hbase/steps/HDFSPathGarbageCollectionStep.java", "diffHunk": "@@ -91,7 +91,8 @@ private void dropHdfsPathOnCluster(List<String> oldHdfsPaths, FileSystem fileSys\n                 }\n                 // If hbase was deployed on another cluster, the job dir is empty and should be dropped,\n                 // because of rowkey_stats and hfile dirs are both dropped.\n-                if (fileSystem.listStatus(oldPath.getParent()).length == 0) {\n+                Path parentPath = oldPath.getParent();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf233c4be4135621107799ee8902dc6787cea043"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0OTEyNjI0OnYy", "diffSide": "RIGHT", "path": "storage-hbase/src/main/java/org/apache/kylin/storage/hbase/steps/HFileDistcpJob.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQxMzozNzoyNFrOILHyIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQxMzozNzoyNFrOILHyIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODUzMjc3MA==", "bodyText": "good to change to final", "url": "https://github.com/apache/kylin/pull/1494#discussion_r548532770", "createdAt": "2020-12-24T13:37:24Z", "author": {"login": "nyshthefantastic"}, "path": "storage-hbase/src/main/java/org/apache/kylin/storage/hbase/steps/HFileDistcpJob.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\r\n+ * Licensed to the Apache Software Foundation (ASF) under one\r\n+ * or more contributor license agreements.  See the NOTICE file\r\n+ * distributed with this work for additional information\r\n+ * regarding copyright ownership.  The ASF licenses this file\r\n+ * to you under the Apache License, Version 2.0 (the\r\n+ * \"License\"); you may not use this file except in compliance\r\n+ * with the License.  You may obtain a copy of the License at\r\n+ *\r\n+ *     http://www.apache.org/licenses/LICENSE-2.0\r\n+ *\r\n+ * Unless required by applicable law or agreed to in writing, software\r\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n+ * See the License for the specific language governing permissions and\r\n+ * limitations under the License.\r\n+ */\r\n+\r\n+package org.apache.kylin.storage.hbase.steps;\r\n+\r\n+import com.google.common.collect.Lists;\r\n+import org.apache.commons.cli.Options;\r\n+import org.apache.hadoop.conf.Configuration;\r\n+import org.apache.hadoop.fs.FileSystem;\r\n+import org.apache.hadoop.fs.Path;\r\n+import org.apache.hadoop.mapred.JobContext;\r\n+import org.apache.hadoop.tools.DistCp;\r\n+import org.apache.hadoop.tools.DistCpOptions;\r\n+import org.apache.hadoop.util.ToolRunner;\r\n+import org.apache.kylin.common.KylinConfig;\r\n+import org.apache.kylin.common.util.HadoopUtil;\r\n+import org.apache.kylin.cube.CubeInstance;\r\n+import org.apache.kylin.cube.CubeManager;\r\n+import org.apache.kylin.engine.mr.common.AbstractHadoopJob;\r\n+import org.apache.kylin.engine.mr.common.BatchConstants;\r\n+import org.apache.kylin.storage.hbase.HBaseConnection;\r\n+import org.slf4j.Logger;\r\n+import org.slf4j.LoggerFactory;\r\n+\r\n+import java.util.List;\r\n+\r\n+/**\r\n+ * @author fengpod\r\n+ */\r\n+public class HFileDistcpJob extends AbstractHadoopJob {\r\n+\r\n+    protected static final Logger logger = LoggerFactory.getLogger(HFileDistcpJob.class);\r\n+\r\n+    public int run(String[] args) throws Exception {\r\n+        Options options = new Options();\r\n+\r\n+        try {\r\n+            options.addOption(OPTION_CUBE_NAME);\r\n+            options.addOption(OPTION_JOB_NAME);\r\n+            options.addOption(OPTION_INPUT_PATH);\r\n+            options.addOption(OPTION_OUTPUT_PATH);\r\n+            options.addOption(OPTION_HTABLE_NAME);\r\n+            parseOptions(options, args);\r\n+\r\n+            // use current hbase configuration\r\n+            Configuration configuration = new Configuration();\r\n+            HBaseConnection.addHBaseClusterNNHAConfiguration(configuration);\r\n+\r\n+            Path input = new Path(getOptionValue(OPTION_INPUT_PATH));\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf233c4be4135621107799ee8902dc6787cea043"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ1Njc5NDk4OnYy", "diffSide": "RIGHT", "path": "storage-hbase/src/main/java/org/apache/kylin/storage/hbase/steps/HBaseJobSteps.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwMjo1MjozMlrOIMF1Jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQwMzoyNTowMlrOIMcmQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU0OTM1MQ==", "bodyText": "Append paramters twice for BatchConstants.ARG_PARTITION .", "url": "https://github.com/apache/kylin/pull/1494#discussion_r549549351", "createdAt": "2020-12-29T02:52:32Z", "author": {"login": "hit-lacus"}, "path": "storage-hbase/src/main/java/org/apache/kylin/storage/hbase/steps/HBaseJobSteps.java", "diffHunk": "@@ -63,6 +64,13 @@ public HadoopShellExecutable createCreateHTableStep(String jobId, CuboidModeEnum\n         appendExecCmdParameters(cmd, BatchConstants.ARG_SEGMENT_ID, seg.getUuid());\n         appendExecCmdParameters(cmd, BatchConstants.ARG_PARTITION,\n                 getRowkeyDistributionOutputPath(jobId) + \"/part-r-00000\");\n+        if(this.seg.getConfig().isHFileDistCP()){\n+            String partitionOutputPath = getRealizationRootPath(jobId) + \"/rowkey_stats/part-r-00000_hfile\";\n+            appendExecCmdParameters(cmd, BatchConstants.ARG_PARTITION, partitionOutputPath);\n+        }else {\n+            appendExecCmdParameters(cmd, BatchConstants.ARG_PARTITION,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf233c4be4135621107799ee8902dc6787cea043"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTkyMjM2OQ==", "bodyText": "new commit fixed this", "url": "https://github.com/apache/kylin/pull/1494#discussion_r549922369", "createdAt": "2020-12-30T03:25:02Z", "author": {"login": "fengpod"}, "path": "storage-hbase/src/main/java/org/apache/kylin/storage/hbase/steps/HBaseJobSteps.java", "diffHunk": "@@ -63,6 +64,13 @@ public HadoopShellExecutable createCreateHTableStep(String jobId, CuboidModeEnum\n         appendExecCmdParameters(cmd, BatchConstants.ARG_SEGMENT_ID, seg.getUuid());\n         appendExecCmdParameters(cmd, BatchConstants.ARG_PARTITION,\n                 getRowkeyDistributionOutputPath(jobId) + \"/part-r-00000\");\n+        if(this.seg.getConfig().isHFileDistCP()){\n+            String partitionOutputPath = getRealizationRootPath(jobId) + \"/rowkey_stats/part-r-00000_hfile\";\n+            appendExecCmdParameters(cmd, BatchConstants.ARG_PARTITION, partitionOutputPath);\n+        }else {\n+            appendExecCmdParameters(cmd, BatchConstants.ARG_PARTITION,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU0OTM1MQ=="}, "originalCommit": {"oid": "bf233c4be4135621107799ee8902dc6787cea043"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1568, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}