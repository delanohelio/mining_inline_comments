{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5NDA2ODk3", "number": 225, "title": "DEV-1645 Automate tool upgrade, image creation and docker image", "bodyText": "Simple script to copy the new jar into the common-tools bucket and start the image creation process. This now\nis broken up into two sets of commands: base and tools. Passing the -t flag will create an image from the\nprevious build in the family, only overlaying the tools dir.\nOtherwise the upgrade script does a maven build to create a docker container and push it to GCR (rather than\ndocker hub).", "createdAt": "2020-11-11T19:32:39Z", "url": "https://github.com/hartwigmedical/pipeline5/pull/225", "merged": true, "mergeCommit": {"oid": "d315e6e7ea56bcf928ce09ac250fceb25f5aab22"}, "closed": true, "closedAt": "2020-11-13T19:31:59Z", "author": {"login": "pauldwolfe"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbjJeYgH2gAyNTE5NDA2ODk3OmFkMzlhNmJkNDRiN2ZjMDY0NTgyNjAwMDc5ZWU2MDc5NWI4NzBhYzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdcMWf6gH2gAyNTE5NDA2ODk3OjgyNzgyOTEyZGE1OTQ1OTFiMmQ2NDE4Nzc5YmIyYjE3NzA3ZTg4OTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ad39a6bd44b7fc064582600079ee60795b870ac6", "author": {"user": null}, "url": "https://github.com/hartwigmedical/pipeline5/commit/ad39a6bd44b7fc064582600079ee60795b870ac6", "committedDate": "2020-11-11T19:30:13Z", "message": "DEV-1645 Automate tool upgrade, image creation and docker image\n\nSimple script to copy the new jar into the common-tools bucket and start the image creation process. This now\nis broken up into two sets of commands: base and tools. Passing the -t flag will create an image from the\nprevious build in the family, only overlaying the tools dir.\n\nOtherwise the upgrade script does a maven build to create a docker container and push it to GCR (rather than\ndocker hub)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51da400dfcce52b1f8d012556fa8185c874d68f7", "author": {"user": null}, "url": "https://github.com/hartwigmedical/pipeline5/commit/51da400dfcce52b1f8d012556fa8185c874d68f7", "committedDate": "2020-11-11T19:31:34Z", "message": "DEV-1645 Set the version back to local-SNAPSHOT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NTQyMjA1", "url": "https://github.com/hartwigmedical/pipeline5/pull/225#pullrequestreview-528542205", "createdAt": "2020-11-11T21:19:23Z", "commit": {"oid": "51da400dfcce52b1f8d012556fa8185c874d68f7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMToxOToyM1rOHxeq9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMTozNToxNVrOHxfHcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY0NDc5MA==", "bodyText": "This can be written as all_cmds=\"$base_image_cmds $tools_image_cmds\"", "url": "https://github.com/hartwigmedical/pipeline5/pull/225#discussion_r521644790", "createdAt": "2020-11-11T21:19:23Z", "author": {"login": "nedleitch"}, "path": "cluster/images/generate_imaging_script.sh", "diffHunk": "@@ -4,29 +4,41 @@\n \n LOCATION=\"europe-west4\"\n ZONE=\"${LOCATION}-a\"\n-PROJECT=\"hmf-pipeline-development\" \n-TYPE=\"pipeline5\"\n+PROJECT=\"hmf-pipeline-development\"\n VERSION=5-17\n \n-if [ -n \"$1\" ]; then\n-    FLAVOUR=\"$1\"\n+TOOLS_ONLY=false\n+while getopts ':tf:' flag; do\n+    case \"${flag}\" in\n+        t) TOOLS_ONLY=true ;;\n+        f) FLAVOUR=${OPTARG} ;;\n+        *) ;;\n+    esac\n+done\n+sourceInstance=\"pipeline5-${VERSION}${FLAVOUR+\"-$FLAVOUR\"}\"\n+image_project=\"debian-cloud\"\n+image_family=\"debian-9\"\n+base_image_cmds=\"$(dirname \"$0\")/base.cmds\"\n+tools_image_cmds=\"$(dirname \"$0\")/tools.cmds\"\n+all_cmds=$(echo $base_image_cmds $tools_image_cmds)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51da400dfcce52b1f8d012556fa8185c874d68f7"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY0OTY1MQ==", "bodyText": "Missing $", "url": "https://github.com/hartwigmedical/pipeline5/pull/225#discussion_r521649651", "createdAt": "2020-11-11T21:29:46Z", "author": {"login": "nedleitch"}, "path": "cluster/upgrade_tool.sh", "diffHunk": "@@ -0,0 +1,19 @@\n+tool=$1\n+version=$2\n+full=${tool}-${version}\n+local_jar=\"${full}.jar\"\n+if [ -n \"$3\" ]; then\n+  local_jar=\"$3\"\n+else\n+  wget \"https://github.com/hartwigmedical/hmftools/releases/download/${tool}-v${version}/${full}.jar\"\n+fi\n+gsutil cp $local_jar \"gs://common-tools/${tool}/${version}/${tool}.jar\"\n+if [ -z \"$3\" ]; then\n+  rm local_jar", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51da400dfcce52b1f8d012556fa8185c874d68f7"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1MDY5NQ==", "bodyText": "Recommend starting with this preamble given how many things could potentially fail in this script:\n#!/usr/bin/env bash\n\nset -e\n\nThat way it will die straight away if say the wget fails.", "url": "https://github.com/hartwigmedical/pipeline5/pull/225#discussion_r521650695", "createdAt": "2020-11-11T21:32:00Z", "author": {"login": "nedleitch"}, "path": "cluster/upgrade_tool.sh", "diffHunk": "@@ -0,0 +1,19 @@\n+tool=$1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51da400dfcce52b1f8d012556fa8185c874d68f7"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1MjA4MQ==", "bodyText": "Would prefer something a little more robust here, like \"$(dirname $0)/images/create_custom_image.sh -t\" so we've made a reasonable effort to allow it to be run from outside the directory it lives in.", "url": "https://github.com/hartwigmedical/pipeline5/pull/225#discussion_r521652081", "createdAt": "2020-11-11T21:35:15Z", "author": {"login": "nedleitch"}, "path": "cluster/upgrade_tool.sh", "diffHunk": "@@ -0,0 +1,19 @@\n+tool=$1\n+version=$2\n+full=${tool}-${version}\n+local_jar=\"${full}.jar\"\n+if [ -n \"$3\" ]; then\n+  local_jar=\"$3\"\n+else\n+  wget \"https://github.com/hartwigmedical/hmftools/releases/download/${tool}-v${version}/${full}.jar\"\n+fi\n+gsutil cp $local_jar \"gs://common-tools/${tool}/${version}/${tool}.jar\"\n+if [ -z \"$3\" ]; then\n+  rm local_jar\n+fi\n+\n+./images/create_custom_image.sh -t", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51da400dfcce52b1f8d012556fa8185c874d68f7"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82782912da594591b2d6418779bb2b17707e8896", "author": {"user": null}, "url": "https://github.com/hartwigmedical/pipeline5/commit/82782912da594591b2d6418779bb2b17707e8896", "committedDate": "2020-11-13T19:30:33Z", "message": "DEV-1645 Review comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3679, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}