{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1NDU0MjIw", "number": 138, "title": "DEV-1163 Make CMEK a required argument", "bodyText": "Better to require every invocation to have a key (even if it is just a\ndevelopment one) than risk not having one on a run that requires it.", "createdAt": "2020-03-09T08:46:14Z", "url": "https://github.com/hartwigmedical/pipeline5/pull/138", "merged": true, "mergeCommit": {"oid": "bf601c4ad5e7a1650f85e715ed057bf27a580aff"}, "closed": true, "closedAt": "2020-03-16T15:13:14Z", "author": {"login": "nedleitch"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcL53ckAH2gAyMzg1NDU0MjIwOmFkMjY5N2QzZTk4MTdiMWY4M2EzMTA0NDVmOWI5MzQ1Yjc1MWMwZGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOPcdagH2gAyMzg1NDU0MjIwOmEwMzI0MzNjYzA5ZDgwOTE1MTE2Njc4ZTQ1Nzg0NDQ5ZWE1NDRjNDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ad2697d3e9817b1f83a310445f9b9345b751c0da", "author": {"user": null}, "url": "https://github.com/hartwigmedical/pipeline5/commit/ad2697d3e9817b1f83a310445f9b9345b751c0da", "committedDate": "2020-03-09T08:44:24Z", "message": "DEV-1163 Make CMEK a required argument\n\nBetter to require every invocation to have a key (even if it is just a\ndevelopment one) than risk not having one on a run that requires it."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMzg0OTEx", "url": "https://github.com/hartwigmedical/pipeline5/pull/138#pullrequestreview-371384911", "createdAt": "2020-03-09T17:29:39Z", "commit": {"oid": "ad2697d3e9817b1f83a310445f9b9345b751c0da"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNzoyOTozOVrOFzyU7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNzozNDo0NFrOFzyhbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg0NjI1NA==", "bodyText": "better to pull these up into CommonArguments than to introduce a dependency on pipeline Arguments", "url": "https://github.com/hartwigmedical/pipeline5/pull/138#discussion_r389846254", "createdAt": "2020-03-09T17:29:39Z", "author": {"login": "pauldwolfe"}, "path": "batch/src/main/java/com/hartwig/batch/BatchArguments.java", "diffHunk": "@@ -41,8 +33,8 @@ static BatchArguments from(String[] args) {\n             CommandLine commandLine = new DefaultParser().parse(options(), args);\n             return ImmutableBatchArguments.builder()\n                     .command(args[0])\n-                    .project(commandLine.getOptionValue(PROJECT, \"hmf-pipeline-development\"))\n-                    .region(commandLine.getOptionValue(REGION, \"europe-west4\"))\n+                    .project(commandLine.getOptionValue(PROJECT, Arguments.DEFAULT_DEVELOPMENT_PROJECT))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad2697d3e9817b1f83a310445f9b9345b751c0da"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg0NzE2Nw==", "bodyText": "Normal the CMEK is actually just the name of the key used ie. projects/project/location/blah/blah. Does this actually work having it a json file? I don't see why running in Docker would need to impact CMEK (it's more like the prokect or location setttings).", "url": "https://github.com/hartwigmedical/pipeline5/pull/138#discussion_r389847167", "createdAt": "2020-03-09T17:31:06Z", "author": {"login": "pauldwolfe"}, "path": "cluster/src/main/java/com/hartwig/pipeline/Arguments.java", "diffHunk": "@@ -17,6 +17,120 @@\n \n     boolean cleanup();\n \n+    String DEFAULT_DOCKER_CMEK = \"/secrets/storage-cmek.json\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad2697d3e9817b1f83a310445f9b9345b751c0da"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg0NzcxMA==", "bodyText": "Why are these all \"new lines\"?", "url": "https://github.com/hartwigmedical/pipeline5/pull/138#discussion_r389847710", "createdAt": "2020-03-09T17:32:02Z", "author": {"login": "pauldwolfe"}, "path": "cluster/src/main/java/com/hartwig/pipeline/Arguments.java", "diffHunk": "@@ -17,6 +17,120 @@\n \n     boolean cleanup();\n \n+    String DEFAULT_DOCKER_CMEK = \"/secrets/storage-cmek.json\";\n+\n+    boolean upload();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad2697d3e9817b1f83a310445f9b9345b751c0da"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg0ODEyMQ==", "bodyText": "use cmek().trim().isEmpty()", "url": "https://github.com/hartwigmedical/pipeline5/pull/138#discussion_r389848121", "createdAt": "2020-03-09T17:32:39Z", "author": {"login": "pauldwolfe"}, "path": "cluster/src/main/java/com/hartwig/pipeline/storage/RuntimeBucket.java", "diffHunk": "@@ -49,10 +48,11 @@ private synchronized static RuntimeBucket createBucketIfNeeded(final Storage sto\n             LOGGER.debug(\"Creating runtime bucket [{}] in Google Storage\", runId);\n             BucketInfo.Builder builder =\n                     BucketInfo.newBuilder(runId).setStorageClass(StorageClass.REGIONAL).setLocation(arguments.region());\n-            arguments.cmek().ifPresent(key -> {\n-                LOGGER.info(\"Using CMEK key [{}] to encrypt all buckets\", key);\n-                builder.setDefaultKmsKeyName(key);\n-            });\n+            if (\"\".equals(arguments.cmek().trim())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad2697d3e9817b1f83a310445f9b9345b751c0da"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg0OTQ1NQ==", "bodyText": "As you pointed out this doesn't make it very external friendly. But... I don't think that's the most important thing right now so we can decide later whether its worth the additional complexity of having a separate flag to disable cmek and make this an optional again.", "url": "https://github.com/hartwigmedical/pipeline5/pull/138#discussion_r389849455", "createdAt": "2020-03-09T17:34:44Z", "author": {"login": "pauldwolfe"}, "path": "cluster/src/main/java/com/hartwig/pipeline/CommonArguments.java", "diffHunk": "@@ -39,7 +39,7 @@\n \n     String serviceAccountEmail();\n \n-    Optional<String> cmek();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad2697d3e9817b1f83a310445f9b9345b751c0da"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d2cb2cf39c55999dc812d5c5e8d90256550248d", "author": {"user": null}, "url": "https://github.com/hartwigmedical/pipeline5/commit/1d2cb2cf39c55999dc812d5c5e8d90256550248d", "committedDate": "2020-03-14T06:51:14Z", "message": "DEV-1163 Refactor CMEK arguments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fac7cda6bbbc39af43f94f4e5bbdf042875ee7a", "author": {"user": null}, "url": "https://github.com/hartwigmedical/pipeline5/commit/8fac7cda6bbbc39af43f94f4e5bbdf042875ee7a", "committedDate": "2020-03-14T07:06:51Z", "message": "DEV-1163 Move default region to CommonArguments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1Mjk3NzE4", "url": "https://github.com/hartwigmedical/pipeline5/pull/138#pullrequestreview-375297718", "createdAt": "2020-03-16T14:57:48Z", "commit": {"oid": "8fac7cda6bbbc39af43f94f4e5bbdf042875ee7a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a032433cc09d80915116678e45784449ea544c44", "author": {"user": {"login": "pauldwolfe", "name": null}}, "url": "https://github.com/hartwigmedical/pipeline5/commit/a032433cc09d80915116678e45784449ea544c44", "committedDate": "2020-03-16T15:00:41Z", "message": "Merge branch 'master' into DEV-1163"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3699, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}