{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzMzQ3NjM2", "number": 4056, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMDoyMzo0M1rOEAUc5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMTowNDoxN1rOEAU3Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NzcwNTM1OnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/table/metadata/DefaultColumnModel.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMDoyMzo0M1rOGbhoQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMDoyMzo0M1rOGbhoQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUxNTcxNA==", "bodyText": "I would be okay with a for loop here.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4056#discussion_r431515714", "createdAt": "2020-05-28T00:23:43Z", "author": {"login": "john-hill"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/table/metadata/DefaultColumnModel.java", "diffHunk": "@@ -37,14 +49,47 @@ public ViewObjectType getObjectType() {\n \t\treturn objectType;\r\n \t}\r\n \r\n+\t/**\r\n+\t * @return The default object fields included\r\n+\t */\r\n \tpublic List<ObjectField> getDefaultFields() {\r\n \t\treturn defaultFields;\r\n \t}\r\n \r\n+\t/**\r\n+\t * @return The custom fields included\r\n+\t */\r\n \tpublic List<ColumnModel> getCustomFields() {\r\n \t\treturn customFields;\r\n \t}\r\n \r\n+\t/**\r\n+\t * @param columnName The column name\r\n+\t * @return An optional with the column model in the custom fields that matches\r\n+\t *         the given column name\r\n+\t */\r\n+\tpublic Optional<ColumnModel> findCustomFieldByColumnName(String columnName) {\r\n+\t\treturn findCustomField(columNameMatcher(columnName));\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd60710ee35990b68611c154c76f5821a8d81382"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NzczMjQ5OnYy", "diffSide": "RIGHT", "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dao/SubmissionDAOImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMDozOTozNlrOGbh4mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMDozOTozNlrOGbh4mA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUxOTg5Ng==", "bodyText": "keep here but remove from default columns", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4056#discussion_r431519896", "createdAt": "2020-05-28T00:39:36Z", "author": {"login": "john-hill"}, "path": "lib/jdomodels/src/main/java/org/sagebionetworks/evaluation/dao/SubmissionDAOImpl.java", "diffHunk": "@@ -254,6 +281,43 @@\n \t\t\" and acl.\"+COL_ACL_OWNER_TYPE+\"='\"+ObjectType.EVALUATION+\"'\"+\n \t\t\" and ra.\"+COL_RESOURCE_ACCESS_GROUP_ID+\" in (:\"+COL_RESOURCE_ACCESS_GROUP_ID+\") \"+\n \t\t\" and at.\"+COL_RESOURCE_ACCESS_TYPE_ELEMENT+\"=:\"+COL_RESOURCE_ACCESS_TYPE_ELEMENT;\n+\t\n+\tprivate static final String SELECT_SUBMISSION_ID_AND_ETAG = \"SELECT s.\" + COL_SUBMISSION_ID + \", r.\" + COL_SUBSTATUS_ETAG \n+\t\t\t+ BUNDLES_BY_EVALUATION_SQL;\n+\t\n+\tprivate static final String SELECT_SUM_CRC_SUBMISSIONS = \"SELECT \"+COL_SUBMISSION_EVAL_ID+\",\"\n+\t\t\t+ \" SUM(CRC32(CONCAT(s.\"+COL_SUBMISSION_ID + \",'-', r.\"+COL_SUBSTATUS_ETAG + \"))) AS \" + CRC\n+\t\t\t+ \" FROM \"+ TABLE_SUBMISSION + \" s INNER JOIN \" + TABLE_SUBSTATUS + \" r\"\n+\t\t\t+ \" ON (s.\" + COL_SUBMISSION_ID + \" = r.\"+ COL_SUBSTATUS_SUBMISSION_ID +\") \"\n+\t\t\t+ \" WHERE s.\"+ COL_SUBMISSION_EVAL_ID + \" IN (:\"+ EVAL_ID +\")\"\n+\t\t\t+ \" GROUP BY \"+COL_SUBMISSION_EVAL_ID;\n+\t\n+\tprivate static final String SELECT_SUBMISSION_DATA = \"SELECT\"\n+\t\t\t+ \" s.\" + COL_SUBMISSION_ID\n+\t\t\t+ \", s.\" + COL_SUBMISSION_NAME\n+\t\t\t+ \", r.\" + COL_SUBSTATUS_ETAG\n+\t\t\t+ \", s.\" + COL_SUBMISSION_EVAL_ID + \" AS \" + SubmissionField.evaluationid.getColumnAlias()\n+\t\t\t+ \", e.\" + COL_EVALUATION_CONTENT_SOURCE + \" AS \" + PROJECT_ID\n+\t\t\t+ \", r.\" + COL_SUBSTATUS_VERSION\n+\t\t\t+ \", s.\" + COL_SUBMISSION_CREATED_ON\n+\t\t\t+ \", s. \" + COL_SUBMISSION_USER_ID + \" AS \" + CREATED_BY\n+\t\t\t+ \", r.\" + COL_SUBSTATUS_MODIFIED_ON\n+\t\t\t// We do not store who modified a status, just use the owner of the evaluation queue\n+\t\t\t+ \", e.\" + COL_EVALUATION_OWNER_ID + \" AS \" + MODIFIED_BY", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd60710ee35990b68611c154c76f5821a8d81382"}, "originalPosition": 99}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4Nzc1Njg4OnYy", "diffSide": "RIGHT", "path": "lib/jdomodels/src/test/java/org/sagebionetworks/evaluation/dao/SubmissionDAOImplTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMDo1NDozMlrOGbiH5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMDo1NDozMlrOGbiH5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUyMzgxNA==", "bodyText": "not using these annotations.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4056#discussion_r431523814", "createdAt": "2020-05-28T00:54:32Z", "author": {"login": "john-hill"}, "path": "lib/jdomodels/src/test/java/org/sagebionetworks/evaluation/dao/SubmissionDAOImplTest.java", "diffHunk": "@@ -917,4 +980,255 @@ public void testIsDockerRepoNameInAnyEvaluationWithAccess() throws Exception {\n \n \n \t}\n+\t\n+\t@Test\n+\tpublic void testGetSubmissionIdAndEtag() {\n+\n+\t\tString subId1 = submissionDAO.create(submission);\n+\t\tcreateSubmissionStatus(subId1, SubmissionStatusEnum.SCORED);\n+\t\tString etag1 = submissionStatusDAO.get(subId1).getEtag();\n+\t\tString subId2 = submissionDAO.create(submission2);\n+\t\tcreateSubmissionStatus(subId2, SubmissionStatusEnum.SCORED);\n+\t\tString etag2 = submissionStatusDAO.get(subId2).getEtag();\n+\t\tString subId3 = submissionDAO.create(submission3);\n+\t\tcreateSubmissionStatus(subId3, SubmissionStatusEnum.SCORED);\n+\t\tString etag3 = submissionStatusDAO.get(subId3).getEtag();\n+\t\t\n+\t\tLong evaluationId = Long.valueOf(evalId);\n+\t\t\n+\t\tList<IdAndEtag> expected = ImmutableList.of(\n+\t\t\tnew IdAndEtag(Long.valueOf(subId1), etag1, evaluationId),\n+\t\t\tnew IdAndEtag(Long.valueOf(subId2), etag2, evaluationId),\n+\t\t\tnew IdAndEtag(Long.valueOf(subId3), etag3, evaluationId)\n+\t\t);\n+\t\t\n+\t\t// Call under test\n+\t\tList<IdAndEtag> result = submissionDAO.getSubmissionIdAndEtag(evaluationId);\n+\t\t\n+\t\tassertEquals(expected, result);\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testGetSubmissionIdAndEtagWithNullInput() {\n+\t\t\n+\t\tLong evaluationId = null;\n+\n+\t\tString errorMessage = assertThrows(IllegalArgumentException.class, () -> {\n+\t\t\t// Call under test\n+\t\t\tsubmissionDAO.getSubmissionIdAndEtag(evaluationId);\n+\t\t\t\n+\t\t}).getMessage();\n+\t\t\n+\t\tassertEquals(\"evaluationId is required.\", errorMessage);\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testGetSumOfSubmissionCRCsForEachEvaluation() {\n+\t\tLong evaluationId1 = Long.valueOf(evalId);\n+\t\tLong evaluationId2 = Long.valueOf(evalId2);\n+\t\t\n+\t\t// Creates 3 submissions for evalId\n+\t\tsubmissionDAO.create(submission);\n+\t\tcreateSubmissionStatus(SUBMISSION_ID, SubmissionStatusEnum.SCORED);\n+\t\tsubmissionDAO.create(submission2);\n+\t\tcreateSubmissionStatus(SUBMISSION_2_ID, SubmissionStatusEnum.SCORED);\n+\t\tsubmissionDAO.create(submission3);\n+\t\tcreateSubmissionStatus(SUBMISSION_3_ID, SubmissionStatusEnum.SCORED);\n+\t\t\n+\t\tList<Long> ids = ImmutableList.of(evaluationId1, evaluationId2);\n+\t\t\n+\t\tMap<Long, Long> result = submissionDAO.getSumOfSubmissionCRCsForEachEvaluation(ids);\n+\t\t\n+\t\tassertEquals(1L, result.size());\n+\t\tassertNotNull(result.get(evaluationId1));\n+\t}\n+\t\n+\t@Test\n+\tpublic void testGetSumOfSubmissionCRCsForEachEvaluationWithNullInput() {\n+\t\t\n+\t\tList<Long> ids = null;\n+\t\t\n+\t\tString errorMessage = assertThrows(IllegalArgumentException.class, () -> {\n+\t\t\tsubmissionDAO.getSumOfSubmissionCRCsForEachEvaluation(ids);\n+\t\t}).getMessage();\n+\t\t\n+\t\tassertEquals(\"evaluationIds is required.\", errorMessage);\n+\t\t\n+\t}\n+\t\n+\t@Test\n+\tpublic void testGetSumOfSubmissionCRCsForEachEvaluationWithEmptyInput() {\n+\t\t\n+\t\tList<Long> ids = Collections.emptyList();\n+\t\t\n+\t\tMap<Long, Long> result = submissionDAO.getSumOfSubmissionCRCsForEachEvaluation(ids);\n+\t\t\n+\t\tassertTrue(result.isEmpty());\n+\t\t\n+\t}\n+\n+\t@Test\n+\tpublic void testGetSubmissionData() {\n+\n+\t\tAnnotations annotations = AnnotationsV2Utils.emptyAnnotations();\n+\n+\t\tAnnotationsV2TestUtils.putAnnotations(annotations, \"foo\", \"fooValue\", AnnotationsValueType.STRING);\n+\t\tAnnotationsV2TestUtils.putAnnotations(annotations, \"bar\", \"42\", AnnotationsValueType.LONG);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd60710ee35990b68611c154c76f5821a8d81382"}, "originalPosition": 394}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4Nzc3MTIwOnYy", "diffSide": "RIGHT", "path": "lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SQLTranslatorUtils.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMTowMzoxOFrOGbiQlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMTowMzoxOFrOGbiQlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUyNjAzNg==", "bodyText": "add test for the new types", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4056#discussion_r431526036", "createdAt": "2020-05-28T01:03:18Z", "author": {"login": "john-hill"}, "path": "lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SQLTranslatorUtils.java", "diffHunk": "@@ -202,6 +202,8 @@ public static boolean isNumericType(ColumnType columnType){\n \t\tcase DATE:\r\n \t\tcase FILEHANDLEID:\r\n \t\tcase USERID:\r\n+\t\tcase SUBMISSIONID:\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd60710ee35990b68611c154c76f5821a8d81382"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4Nzc3MjE1OnYy", "diffSide": "RIGHT", "path": "lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SQLUtils.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMTowMzo1OFrOGbiRMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMTowMzo1OFrOGbiRMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUyNjE5Mg==", "bodyText": "tests for new types", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4056#discussion_r431526192", "createdAt": "2020-05-28T01:03:58Z", "author": {"login": "john-hill"}, "path": "lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/SQLUtils.java", "diffHunk": "@@ -1353,6 +1353,8 @@ public static String translateColumnTypeToAnnotationValueName(ColumnType type){\n \t\tcase DATE:\r\n \t\tcase INTEGER:\r\n \t\tcase ENTITYID:\r\n+\t\tcase SUBMISSIONID:\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd60710ee35990b68611c154c76f5821a8d81382"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4Nzc3MjYyOnYy", "diffSide": "RIGHT", "path": "lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/utils/TableModelUtils.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMTowNDoxN1rOGbiRgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwMTowNDoxN1rOGbiRgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTUyNjI3NA==", "bodyText": "test for new types", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4056#discussion_r431526274", "createdAt": "2020-05-28T01:04:17Z", "author": {"login": "john-hill"}, "path": "lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/utils/TableModelUtils.java", "diffHunk": "@@ -766,6 +766,8 @@ public static int calculateMaxSizeForType(ColumnType type, Long maxSize, Long ma\n \t\t\tcase BOOLEAN:\r\n \t\t\t\treturn ColumnConstants.MAX_BOOLEAN_BYTES_AS_STRING;\r\n \t\t\tcase INTEGER:\r\n+\t\t\tcase SUBMISSIONID:\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd60710ee35990b68611c154c76f5821a8d81382"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3048, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}