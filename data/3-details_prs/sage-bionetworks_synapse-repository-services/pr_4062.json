{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MTU2ODc5", "number": 4062, "title": "PLFM-6159 - Part C: New submission view entity", "bodyText": "This builds on top of #4056 which should be merged back before reviewing.", "createdAt": "2020-05-27T23:03:14Z", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4062", "merged": true, "mergeCommit": {"oid": "f249dbf396141bb66ccda2b342ff9488ba05c2e0"}, "closed": true, "closedAt": "2020-05-29T00:48:27Z", "author": {"login": "marcomarasca"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcljnzbAH2gAyNDI0MTU2ODc5OmNkNGFkMGRkMzE5ZjMwNjJkODYyZmUwMzFiODBkZGVmNzlhZGRlMzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcl3mu_AFqTQyMDU4NDgwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cd4ad0dd319f3062d862fe031b80ddef79adde39", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/cd4ad0dd319f3062d862fe031b80ddef79adde39", "committedDate": "2020-05-28T01:31:26Z", "message": "PLFM-6159: Added new entity type, submissionview"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b6a9af6a863e6af7a4f0d693a8c8a3eada43595", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/6b6a9af6a863e6af7a4f0d693a8c8a3eada43595", "committedDate": "2020-05-28T01:31:27Z", "message": "PLFM-6159: Use the EntityType for the ViewScope"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8c2f6dc375bf9d9273477e8340111fc449f305a", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/e8c2f6dc375bf9d9273477e8340111fc449f305a", "committedDate": "2020-05-28T01:31:27Z", "message": "PLFM-6159: Added validation for submission views"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2be22976b514dc18ce4c3bf708a6c32ac171ea0c", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/2be22976b514dc18ce4c3bf708a6c32ac171ea0c", "committedDate": "2020-05-28T01:31:28Z", "message": "PLFM-6159: Removed temp migration block"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e14267552af7db6bdbe81e604587a022d0bc4bb7", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/e14267552af7db6bdbe81e604587a022d0bc4bb7", "committedDate": "2020-05-27T22:57:39Z", "message": "PLFM-6159: Move type mask validation logic into provider"}, "afterCommit": {"oid": "1b149a92a677e247e103f6c2f587e2fd01480ad6", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/1b149a92a677e247e103f6c2f587e2fd01480ad6", "committedDate": "2020-05-28T01:34:38Z", "message": "Increase the timeout for long running tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6aff65e4e7de0246d09988bbfd3c5f27a077402", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/f6aff65e4e7de0246d09988bbfd3c5f27a077402", "committedDate": "2020-05-28T02:19:48Z", "message": "PLFM-6159: Submission view integration test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c79da6985dc06a0c63f0dcd12308ede9c7705df", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/6c79da6985dc06a0c63f0dcd12308ede9c7705df", "committedDate": "2020-05-28T02:19:57Z", "message": "PLFM-6159: Move type mask validation logic into provider"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a109151970ea19dbe5370342c7b87da8343813d9", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/a109151970ea19dbe5370342c7b87da8343813d9", "committedDate": "2020-05-28T02:19:58Z", "message": "Increase the timeout for long running tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1b149a92a677e247e103f6c2f587e2fd01480ad6", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/1b149a92a677e247e103f6c2f587e2fd01480ad6", "committedDate": "2020-05-28T01:34:38Z", "message": "Increase the timeout for long running tests"}, "afterCommit": {"oid": "a109151970ea19dbe5370342c7b87da8343813d9", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/a109151970ea19dbe5370342c7b87da8343813d9", "committedDate": "2020-05-28T02:19:58Z", "message": "Increase the timeout for long running tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNTY3Njky", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4062#pullrequestreview-420567692", "createdAt": "2020-05-28T23:53:50Z", "commit": {"oid": "a109151970ea19dbe5370342c7b87da8343813d9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMzo1Mzo1MVrOGcKgcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMzo1Mzo1MVrOGcKgcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE4NTQ1Ng==", "bodyText": "new ViewEntityType (too many unused options in EntityType)", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4062#discussion_r432185456", "createdAt": "2020-05-28T23:53:51Z", "author": {"login": "john-hill"}, "path": "lib/lib-auto-generated/src/main/resources/schema/org/sagebionetworks/repo/model/table/ViewScope.json", "diffHunk": "@@ -7,15 +7,15 @@\n \t],\r\n \t\"properties\": {\r\n \t\t\"scope\": {\r\n-\t\t\t\"description\": \"List of parent IDs that define a view scope.\",\r\n+\t\t\t\"description\": \"List of parent IDs that define a view scope. For an entityview the ids should point to entities, for a submissionview the ids should point to evaluation ids\",\r\n \t\t\t\"type\": \"array\",\r\n \t\t\t\"items\": {\r\n \t\t\t\t\"type\": \"string\"\r\n \t\t\t}\r\n \t\t},\r\n-\t\t\"objectType\": {\r\n-\t\t\t\"description\": \"The type of the objects in the rows of a view (E.g. ENTITY for entity views)\",\r\n-\t\t\t\"$ref\": \"org.sagebionetworks.repo.model.table.ViewObjectType\"\r\n+\t\t\"viewEntityType\": {\r\n+\t\t\t\"description\": \"The entity type of the view, if not supplied defaults to entityview. Supported values are entityview and submissionview\",\r\n+\t\t\t\"$ref\": \"org.sagebionetworks.repo.model.EntityType\"\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a109151970ea19dbe5370342c7b87da8343813d9"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNTc2NTA0", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4062#pullrequestreview-420576504", "createdAt": "2020-05-29T00:21:10Z", "commit": {"oid": "a109151970ea19dbe5370342c7b87da8343813d9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwMDoyMToxMFrOGcK9Sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQwMDoyMToxMFrOGcK9Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE5Mjg0Mg==", "bodyText": "is there a way to pass the scope and get back the sub-set the user has the  passed permission.  That would be a single call instead of n calls.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4062#discussion_r432192842", "createdAt": "2020-05-29T00:21:10Z", "author": {"login": "john-hill"}, "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/service/metadata/SubmissionViewMetadataProvider.java", "diffHunk": "@@ -0,0 +1,57 @@\n+package org.sagebionetworks.repo.web.service.metadata;\r\n+\r\n+import java.util.List;\r\n+\r\n+import org.sagebionetworks.evaluation.manager.EvaluationPermissionsManager;\r\n+import org.sagebionetworks.repo.manager.table.TableViewManager;\r\n+import org.sagebionetworks.repo.model.ACCESS_TYPE;\r\n+import org.sagebionetworks.repo.model.DatastoreException;\r\n+import org.sagebionetworks.repo.model.EntityType;\r\n+import org.sagebionetworks.repo.model.InvalidModelException;\r\n+import org.sagebionetworks.repo.model.UnauthorizedException;\r\n+import org.sagebionetworks.repo.model.UserInfo;\r\n+import org.sagebionetworks.repo.model.table.SubmissionView;\r\n+import org.sagebionetworks.repo.model.table.ViewScope;\r\n+import org.sagebionetworks.repo.web.NotFoundException;\r\n+import org.springframework.beans.factory.annotation.Autowired;\r\n+import org.springframework.stereotype.Service;\r\n+\r\n+@Service(\"submissionViewMetadataProvider\")\r\n+public class SubmissionViewMetadataProvider extends ViewMetadataProvider<SubmissionView> implements EntityValidator<SubmissionView> {\r\n+\t\r\n+\t@Autowired\r\n+\tprivate EvaluationPermissionsManager evaluationPermissionManager;\r\n+\t\r\n+\t@Autowired\r\n+\tpublic SubmissionViewMetadataProvider(TableViewManager viewManager, EvaluationPermissionsManager evaluationPermissionManager) {\r\n+\t\tsuper(viewManager);\r\n+\t\tthis.evaluationPermissionManager = evaluationPermissionManager;\r\n+\t}\r\n+\t\r\n+\t@Override\r\n+\tpublic ViewScope createViewScope(UserInfo userInfo, SubmissionView view) {\r\n+\t\tViewScope scope = new ViewScope();\r\n+\t\t\r\n+\t\tscope.setViewEntityType(EntityType.submissionview);\r\n+\t\tscope.setScope(view.getScopeIds());\r\n+\t\tscope.setViewTypeMask(0L);\r\n+\t\t\r\n+\t\treturn scope;\r\n+\t}\r\n+\t\r\n+\t@Override\r\n+\tpublic void validateEntity(SubmissionView view, EntityEvent event)\r\n+\t\t\tthrows InvalidModelException, NotFoundException, DatastoreException, UnauthorizedException {\r\n+\t\tvalidateScopeAccess(event.getUserInfo(), view.getScopeIds());\t\t\r\n+\t}\r\n+\t\r\n+\tprivate void validateScopeAccess(UserInfo userInfo, List<String> scope) {\r\n+\t\tif (scope == null || scope.isEmpty()) {\r\n+\t\t\treturn;\r\n+\t\t}\r\n+\t\tscope.forEach((evaluationId) -> {\r\n+\t\t\tevaluationPermissionManager.hasAccess(userInfo, evaluationId, ACCESS_TYPE.READ_PRIVATE_SUBMISSION);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a109151970ea19dbe5370342c7b87da8343813d9"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNTg0ODAx", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4062#pullrequestreview-420584801", "createdAt": "2020-05-29T00:48:22Z", "commit": {"oid": "a109151970ea19dbe5370342c7b87da8343813d9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4731, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}