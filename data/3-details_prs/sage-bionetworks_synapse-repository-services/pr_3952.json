{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4MDgzNzE1", "number": 3952, "title": "PLFM-3590: Extend owner.txt to multiple users", "bodyText": "Allows the owner.txt to contain as a valid identifier:\n\nid of the user (new)\nid of a team the user is part of (new)\nusername\nemail\n\nNote: I added the id in place of the team name since the name can be changed and reused", "createdAt": "2020-02-21T03:22:23Z", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3952", "merged": true, "mergeCommit": {"oid": "1ea9a14e73d758673e875dff0bbff2a968b8b528"}, "closed": true, "closedAt": "2020-02-27T21:22:23Z", "author": {"login": "marcomarasca"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGVs4BgH2gAyMzc4MDgzNzE1Ojk1NjUwZDRmZjhhM2NlYTEzMjhiODA5NTA1ZDM3N2JiMzZkZjlmZDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIiHWygFqTM2NjAwNzU3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "95650d4ff8a3cea1328b809505d377bb36df9fd0", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/95650d4ff8a3cea1328b809505d377bb36df9fd0", "committedDate": "2020-02-21T01:46:39Z", "message": "PLFM-3590: Allows multiple users in owner.txt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3307f94e8b8f6b8439b11cc588f06b4985f4acf2", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/3307f94e8b8f6b8439b11cc588f06b4985f4acf2", "committedDate": "2020-02-21T02:11:42Z", "message": "PLFM-3590: Additional integration test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1OTcxMzkw", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3952#pullrequestreview-365971390", "createdAt": "2020-02-27T20:22:05Z", "commit": {"oid": "3307f94e8b8f6b8439b11cc588f06b4985f4acf2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMDoyMjowNVrOFvf81A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMDoyMjowNVrOFvf81A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM1MDg2OA==", "bodyText": "doc that it must be a team ID or a user ID.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3952#discussion_r385350868", "createdAt": "2020-02-27T20:22:05Z", "author": {"login": "john-hill"}, "path": "lib/lib-auto-generated/src/main/resources/schema/org/sagebionetworks/repo/model/project/BucketOwnerStorageLocationSetting.json", "diffHunk": "@@ -1,5 +1,5 @@\n {\n-\t\"description\": \"A storage location that defines an external bucket that needs to be verified for ownership. For this type of storage location, upon creation there is a process of verification that will check that a owner.txt file is uploaded to the bucket (and if present within the baseKey folder) that contains the username of requesting user.\",\n+\t\"description\": \"A storage location that defines an external bucket that needs to be verified for ownership. For this type of storage location, upon creation there is a process of verification that will check that a owner.txt file is uploaded to the bucket (and if present within the baseKey folder) and that contains a line separated list of user identifiers. Valid user identifiers for verifications are: user id, user name, user email address or id of a team the user is part of.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3307f94e8b8f6b8439b11cc588f06b4985f4acf2"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1OTk3NzEw", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3952#pullrequestreview-365997710", "createdAt": "2020-02-27T21:06:19Z", "commit": {"oid": "3307f94e8b8f6b8439b11cc588f06b4985f4acf2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMTowNjoxOVrOFvhMAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMTowNjoxOVrOFvhMAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM3MTEzNg==", "bodyText": "teamId and userId only.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3952#discussion_r385371136", "createdAt": "2020-02-27T21:06:19Z", "author": {"login": "john-hill"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/storagelocation/BucketOwnerVerifierImpl.java", "diffHunk": "@@ -19,14 +22,24 @@\n import org.springframework.beans.factory.annotation.Autowired;\r\n import org.springframework.stereotype.Service;\r\n \r\n+import com.google.common.collect.ImmutableSet;\r\n+\r\n @Service\r\n public class BucketOwnerVerifierImpl implements BucketOwnerVerifier {\r\n-\r\n+\t\r\n \tpublic static final String EXTERNAL_STORAGE_HELP = \"http://docs.synapse.org/articles/custom_storage_location.html for more information on how to create a new external upload destination.\";\r\n \r\n-\tprivate static final String SECURITY_EXPLANATION = \"For security purposes, Synapse needs to establish that %s has permission to write to the bucket. Please create an object in bucket '%s' with key '%s' that contains the text '%s'. Also see \"\r\n+\tprivate static final String SECURITY_EXPLANATION = \"For security purposes, Synapse needs to establish that the user has permission to write to the bucket. Please create an object in bucket '%s' with key '%s' that contains a \"\r\n+\t\t\t+ \"line separated list of identifiers for the user. Valid identifiers are the id of the user, its username, email address or id of a team the user is part of. Also see \"\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3307f94e8b8f6b8439b11cc588f06b4985f4acf2"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MDAxOTQ3", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3952#pullrequestreview-366001947", "createdAt": "2020-02-27T21:13:15Z", "commit": {"oid": "3307f94e8b8f6b8439b11cc588f06b4985f4acf2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMToxMzoxNVrOFvhYWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMToxMzoxNVrOFvhYWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM3NDI5OQ==", "bodyText": "verify negative case", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3952#discussion_r385374299", "createdAt": "2020-02-27T21:13:15Z", "author": {"login": "john-hill"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/storagelocation/BucketOwnerVerifierImplAutowireTest.java", "diffHunk": "@@ -46,4 +84,86 @@ public void testUnsupportedStorageLocation() {\n \t\tassertEquals(\"Unsupported storage location type: \" + storageLocation.getClass().getSimpleName(), e.getMessage());\r\n \t}\r\n \t\r\n+\t@Test\r\n+\tpublic void testVerificationWithMultipleUsers() throws Exception {\r\n+\t\tUserInfo user1 = createUser();\r\n+\t\tUserInfo user2 = createUser();\r\n+\t\t\r\n+\t\tList<String> ownerList = ImmutableList.of(user1.getId().toString(), user2.getId().toString());\r\n+\t\t\r\n+\t\tBucketOwnerStorageLocationSetting storageLocation = linkBucket(ownerList);\r\n+\t\t\r\n+\t\tbucketOwnerVerifier.verifyBucketOwnership(user1, storageLocation);\r\n+\t\tbucketOwnerVerifier.verifyBucketOwnership(user2, storageLocation);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3307f94e8b8f6b8439b11cc588f06b4985f4acf2"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MDA3NTc4", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3952#pullrequestreview-366007578", "createdAt": "2020-02-27T21:22:17Z", "commit": {"oid": "3307f94e8b8f6b8439b11cc588f06b4985f4acf2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4814, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}