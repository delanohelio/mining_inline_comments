{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3NzU4MjE0", "number": 3916, "title": "PLFM-6005 and PLFM-6006", "bodyText": "https://sagebionetworks.jira.com/browse/PLFM-6005 Can't override ACLs on children of STS folders\nhttps://sagebionetworks.jira.com/browse/PLFM-6006 STS Upload Restrictions", "createdAt": "2020-01-27T23:37:59Z", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916", "merged": true, "mergeCommit": {"oid": "4f707812a7784ac85276453fcce03ce3dcd43c02"}, "closed": true, "closedAt": "2020-01-28T23:54:06Z", "author": {"login": "DwayneJengSage"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABbxwL7AgH2gAyMzY3NzU4MjE0OjFjNWU4OTJiMzJiNmY1YmFiMGFjMGEwNWUwMDJmODRmZDZiOTA5NzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-6TXmgFqTM0OTc4NjA0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1c5e892b32b6f5bab0ac0a05e002f84fd6b90970", "author": {"user": {"login": "DwayneJengSage", "name": "Dwayne Jeng"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/1c5e892b32b6f5bab0ac0a05e002f84fd6b90970", "committedDate": "2019-12-19T02:45:41Z", "message": "PLFM-6005 Can't override ACLs on children of STS folders"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a736ead39d791b7a3774e00ef64d146fe670dfb", "author": {"user": {"login": "DwayneJengSage", "name": "Dwayne Jeng"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/9a736ead39d791b7a3774e00ef64d146fe670dfb", "committedDate": "2020-01-08T05:10:26Z", "message": "PLFM-6006 STS Upload Restrictions (work in progress)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a802a8c0daeb248151637f7b175531dc8818278f", "author": {"user": {"login": "DwayneJengSage", "name": "Dwayne Jeng"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/a802a8c0daeb248151637f7b175531dc8818278f", "committedDate": "2020-01-08T05:27:45Z", "message": "Merge remote-tracking branch 'origin/project-settings-sql' into plfm-6005\n\nConflicts:\n\tintegration-test/src/test/java/org/sagebionetworks/IT049FileHandleTest.java\n\tintegration-test/src/test/java/org/sagebionetworks/ITStorageLocation.java\n\tservices/repository-managers/src/main/java/org/sagebionetworks/repo/manager/ProjectSettingsManagerImpl.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ba32cb6d5cc17679b25f45f4bedd24f19ec0bb4", "author": {"user": {"login": "DwayneJengSage", "name": "Dwayne Jeng"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/5ba32cb6d5cc17679b25f45f4bedd24f19ec0bb4", "committedDate": "2020-01-22T01:13:54Z", "message": "clean up tests for PLFM-6005 Can't override ACLs on children of STS folders"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c91d8e973affe0ae4554cf7fe32b3af0a05f16c6", "author": {"user": {"login": "DwayneJengSage", "name": "Dwayne Jeng"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/c91d8e973affe0ae4554cf7fe32b3af0a05f16c6", "committedDate": "2020-01-22T06:37:21Z", "message": "PLFM-6006 STS Upload Restrictions (tests)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e888ee0ecacd195f366ec38b24153316c1232efe", "author": {"user": {"login": "DwayneJengSage", "name": "Dwayne Jeng"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/e888ee0ecacd195f366ec38b24153316c1232efe", "committedDate": "2020-01-22T06:43:12Z", "message": "Merge branch 'develop' of https://github.com/Sage-Bionetworks/Synapse-Repository-Services into plfm-6005\n\nConflicts:\n\tservices/repository-managers/src/test/java/org/sagebionetworks/repo/manager/ProjectSettingsManagerImplUnitTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc3f82e3bb9ce4d6bf3ffc5c118b705ad40dac9a", "author": {"user": {"login": "DwayneJengSage", "name": "Dwayne Jeng"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/fc3f82e3bb9ce4d6bf3ffc5c118b705ad40dac9a", "committedDate": "2020-01-24T00:20:17Z", "message": "Merge branch 'develop' of https://github.com/Sage-Bionetworks/Synapse-Repository-Services into plfm-6005"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31a36bb0baa28855e993e3a10cb86b335d4f0b2e", "author": {"user": {"login": "DwayneJengSage", "name": "Dwayne Jeng"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/31a36bb0baa28855e993e3a10cb86b335d4f0b2e", "committedDate": "2020-01-27T23:00:48Z", "message": "PLFM-6006 STS Upload Restrictions (clean up integ tests)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cef7f4066cf3c5d898031802ec165e68a5aeaf90", "author": {"user": {"login": "DwayneJengSage", "name": "Dwayne Jeng"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/cef7f4066cf3c5d898031802ec165e68a5aeaf90", "committedDate": "2020-01-27T23:08:53Z", "message": "Merge branch 'develop' of https://github.com/Sage-Bionetworks/Synapse-Repository-Services into plfm-6005\n\nConflicts:\n\tservices/repository-managers/src/test/java/org/sagebionetworks/repo/manager/EntityPermissionsManagerImplUnitTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d58e288e90a647023c112a4c36633e317f041003", "author": {"user": {"login": "DwayneJengSage", "name": "Dwayne Jeng"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/d58e288e90a647023c112a4c36633e317f041003", "committedDate": "2020-01-27T23:35:27Z", "message": "fix additional merge conflict"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MDcyOTI2", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916#pullrequestreview-349072926", "createdAt": "2020-01-28T00:46:47Z", "commit": {"oid": "d58e288e90a647023c112a4c36633e317f041003"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwMDo0Njo0N1rOFiWUkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwMDo0Njo0N1rOFiWUkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU2MTYxNw==", "bodyText": "Java Optional", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916#discussion_r371561617", "createdAt": "2020-01-28T00:46:47Z", "author": {"login": "john-hill"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/EntityManagerImpl.java", "diffHunk": "@@ -85,6 +98,22 @@ public void setAllowCreationOfOldEntities(boolean allowCreationOfOldEntities) {\n \t\t\tthrows DatastoreException, InvalidModelException,\n \t\t\tUnauthorizedException, NotFoundException {\n \t\tvalidateEntity(newEntity);\n+\t\tif (newEntity instanceof FileEntity) {\n+\t\t\tvalidateFileEntityStsRestrictions(userInfo, (FileEntity) newEntity);\n+\t\t}\n+\n+\t\t// If the parent lives inside an STS-enabled folder, only Files and Folders are allowed.\n+\t\tif (!(newEntity instanceof FileEntity) && !(newEntity instanceof Folder)) {\n+\t\t\tString parentId = newEntity.getParentId();\n+\t\t\tif (parentId != null) {\n+\t\t\t\tProjectSetting projectSetting = projectSettingsManager.getProjectSettingForNode(userInfo, parentId,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d58e288e90a647023c112a4c36633e317f041003"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MDc4OTUz", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916#pullrequestreview-349078953", "createdAt": "2020-01-28T01:07:17Z", "commit": {"oid": "d58e288e90a647023c112a4c36633e317f041003"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwMTowNzoxN1rOFiWoJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwMTowNzoxN1rOFiWoJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU2NjYzMA==", "bodyText": "test for null case?", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916#discussion_r371566630", "createdAt": "2020-01-28T01:07:17Z", "author": {"login": "john-hill"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/EntityManagerImpl.java", "diffHunk": "@@ -562,7 +595,50 @@ public DataTypeResponse changeEntityDataType(UserInfo userInfo, String entityId,\n \t\tValidateArgument.required(dataType, \"DataType\");\n \t\treturn objectTypeManager.changeObjectsDataType(userInfo, entityId, ObjectType.ENTITY, dataType);\n \t}\n-\t\n+\n+\t// Validates whether a FileEntity satisfies the STS restrictions of its parent.\n+\t// Package-scoped to facilitate unit tests.\n+\tvoid validateFileEntityStsRestrictions(UserInfo userInfo, FileEntity fileEntity) {\n+\t\t// Is the file STS-enabled?\n+\t\tFileHandle fileHandle = fileHandleManager.getRawFileHandle(userInfo, fileEntity.getDataFileHandleId());\n+\t\tLong fileStorageLocationId = fileHandle.getStorageLocationId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d58e288e90a647023c112a4c36633e317f041003"}, "originalPosition": 90}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NzY5NDU3", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916#pullrequestreview-349769457", "createdAt": "2020-01-28T23:09:46Z", "commit": {"oid": "d58e288e90a647023c112a4c36633e317f041003"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMzowOTo0NlrOFi3zDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMzowOTo0NlrOFi3zDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjExMDA5Mw==", "bodyText": "comment on projectId can be a folderId", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916#discussion_r372110093", "createdAt": "2020-01-28T23:09:46Z", "author": {"login": "john-hill"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/EntityPermissionsManagerImpl.java", "diffHunk": "@@ -154,6 +158,18 @@ public AccessControlList overrideInheritance(AccessControlList acl, UserInfo use\n \t\t\n \t\t// validate the Entity owners will still have access.\n \t\tPermissionsManagerUtils.validateACLContent(acl, userInfo, node.getCreatedByPrincipalId());\n+\n+\t\t// Can't override ACL inheritance if the entity lives inside an STS-enabled folder.\n+\t\tUploadDestinationListSetting projectSetting = projectSettingsManager.getProjectSettingForNode(userInfo,\n+\t\t\t\tentityId, ProjectSettingsType.upload, UploadDestinationListSetting.class);\n+\t\tif (projectSetting != null && !KeyFactory.equals(projectSetting.getProjectId(), entityId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d58e288e90a647023c112a4c36633e317f041003"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5Nzc1Njgw", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916#pullrequestreview-349775680", "createdAt": "2020-01-28T23:25:47Z", "commit": {"oid": "d58e288e90a647023c112a4c36633e317f041003"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMzoyNTo0N1rOFi4HzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMzoyNTo0N1rOFi4HzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjExNTQwNA==", "bodyText": "cast to the other way", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916#discussion_r372115404", "createdAt": "2020-01-28T23:25:47Z", "author": {"login": "john-hill"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/ProjectSettingsManagerImplUnitTest.java", "diffHunk": "@@ -1024,64 +1024,81 @@ public void testValidateProjectSetting_StsCannotBeEnabledWithOtherStorageLocatio\n \t}\n \n \t@Test\n-\tpublic void testIsStsStorageLocation_NullProjectSetting() {\n+\tpublic void testIsStsStorageLocation_NullStorageLocationSetting() {\n \t\t// Method under test.\n-\t\tboolean result = projectSettingsManagerImpl.isStsStorageLocationSetting(null);\n+\t\tboolean result = projectSettingsManagerImpl.isStsStorageLocationSetting((ProjectSetting) null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d58e288e90a647023c112a4c36633e317f041003"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5Nzc2MTY5", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916#pullrequestreview-349776169", "createdAt": "2020-01-28T23:27:05Z", "commit": {"oid": "d58e288e90a647023c112a4c36633e317f041003"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMzoyNzowNVrOFi4Jaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMzoyNzowNVrOFi4Jaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjExNTgxOQ==", "bodyText": "duplicate", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916#discussion_r372115819", "createdAt": "2020-01-28T23:27:05Z", "author": {"login": "john-hill"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/ProjectSettingsManagerImplUnitTest.java", "diffHunk": "@@ -1024,64 +1024,81 @@ public void testValidateProjectSetting_StsCannotBeEnabledWithOtherStorageLocatio\n \t}\n \n \t@Test\n-\tpublic void testIsStsStorageLocation_NullProjectSetting() {\n+\tpublic void testIsStsStorageLocation_NullStorageLocationSetting() {\n \t\t// Method under test.\n-\t\tboolean result = projectSettingsManagerImpl.isStsStorageLocationSetting(null);\n+\t\tboolean result = projectSettingsManagerImpl.isStsStorageLocationSetting((ProjectSetting) null);\n \t\tassertFalse(result);\n-\t\tverifyZeroInteractions(mockStorageLocationDAO);\n \t}\n \n \t@Test\n-\tpublic void testIsStsStorageLocation_ProjectSettingWrongSubclass() {\n-\t\t// Create a mock of ProjectSetting, so we can have a ProjectSetting instance that's not an\n-\t\t// UploadDestinationListSetting.\n-\t\tProjectSetting input = mock(ProjectSetting.class);\n+\tpublic void testIsStsStorageLocation_StorageLocationSettingWrongClass() {\n+\t\t// Method under test.\n+\t\tboolean result = projectSettingsManagerImpl.isStsStorageLocationSetting(\n+\t\t\t\tnew ExternalGoogleCloudStorageLocationSetting());\n+\t\tassertFalse(result);\n+\t}\n \n+\t@Test\n+\tpublic void testIsStsStorageLocation_NotStsStorageLocation() {\n \t\t// Method under test.\n-\t\tboolean result = projectSettingsManagerImpl.isStsStorageLocationSetting(input);\n+\t\tboolean result = projectSettingsManagerImpl.isStsStorageLocationSetting(\n+\t\t\t\texternalGoogleCloudStorageLocationSetting);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d58e288e90a647023c112a4c36633e317f041003"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5Nzg2MDQ4", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916#pullrequestreview-349786048", "createdAt": "2020-01-28T23:53:53Z", "commit": {"oid": "d58e288e90a647023c112a4c36633e317f041003"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4783, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}