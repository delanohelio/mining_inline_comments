{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4MjcwOTUz", "number": 4200, "title": "Plfm 6421", "bodyText": "", "createdAt": "2020-09-16T22:07:47Z", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200", "merged": true, "mergeCommit": {"oid": "14cc9d9e1b55ab9983d2dc8ef4c715e507c337ed"}, "closed": true, "closedAt": "2020-09-18T21:42:45Z", "author": {"login": "nlgilber"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdI76M6AH2gAyNDg4MjcwOTUzOjEzOTBjZDgyODcyNDE5OWVkODQwNGM3MzFmNWMzZWVkMzMyOGQ1Mjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdKMrOSgFqTQ5MTc5Nzg4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1390cd828724199ed8404c731f5c3eed3328d529", "author": {"user": {"login": "nlgilber", "name": "Nicoletta"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/1390cd828724199ed8404c731f5c3eed3328d529", "committedDate": "2020-09-14T23:36:36Z", "message": "implemented icon/preview functionality"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0419f3d6a5fad032ee6d50eef16fedb7dbb29ef", "author": {"user": {"login": "nlgilber", "name": "Nicoletta"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/d0419f3d6a5fad032ee6d50eef16fedb7dbb29ef", "committedDate": "2020-09-15T16:54:49Z", "message": "testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b0a754a0e7f77ac58a8156de8ed72bf344ad286", "author": {"user": {"login": "nlgilber", "name": "Nicoletta"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/1b0a754a0e7f77ac58a8156de8ed72bf344ad286", "committedDate": "2020-09-16T18:16:21Z", "message": "Merge branch 'PLFM-5960' into develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "316366a7efff2f941bf4edaa16c8e2676ff463a6", "author": {"user": {"login": "nlgilber", "name": "Nicoletta"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/316366a7efff2f941bf4edaa16c8e2676ff463a6", "committedDate": "2020-09-16T21:07:56Z", "message": "added mock for preview id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f352bae9496bfee8e7bd541e7e9de62ad63bf48d", "author": {"user": {"login": "nlgilber", "name": "Nicoletta"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/f352bae9496bfee8e7bd541e7e9de62ad63bf48d", "committedDate": "2020-09-16T21:15:40Z", "message": "Merge branch 'develop' of github.com:/nlgilber/Synapse-Repository-Services into PLFM-6421"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df3180b06c86f6b147b18dc159599673fbc23146", "author": {"user": {"login": "nlgilber", "name": "Nicoletta"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/df3180b06c86f6b147b18dc159599673fbc23146", "committedDate": "2020-09-16T22:02:06Z", "message": "Revert \" minor description change\"\n\nThis reverts commit 0b318707dcef42294bb9250558b3bd7bd772a61b."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30d48e0af1a936fdfe61163694b6e91681336cb2", "author": {"user": {"login": "nlgilber", "name": "Nicoletta"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/30d48e0af1a936fdfe61163694b6e91681336cb2", "committedDate": "2020-09-16T22:06:22Z", "message": "Revert \" order by most recent\"\n\nThis reverts commit 880e7f3ce593e9b8181492d670a52989187e3cc9."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6d585851a84bc731ee6b6df88d17ded00998fc0", "author": {"user": {"login": "nlgilber", "name": "Nicoletta"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/b6d585851a84bc731ee6b6df88d17ded00998fc0", "committedDate": "2020-09-16T22:06:42Z", "message": "Revert \" added test, added ORDER BY\"\n\nThis reverts commit d9ff8948123b209c57bdf1b09240a4d87432a551."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMDc5NDk1", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#pullrequestreview-490079495", "createdAt": "2020-09-16T23:14:11Z", "commit": {"oid": "b6d585851a84bc731ee6b6df88d17ded00998fc0"}, "state": "APPROVED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMzoxNDoxMVrOHTHQfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMzoyNDo0NlrOHTHdUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwMzkwMg==", "bodyText": "We can reuse the TEAM_ID_ICON constant: TEAM_ID_ICON_PREVIEW  = TEAM_ID_ICON  + \"/preview\";", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r489803902", "createdAt": "2020-09-16T23:14:11Z", "author": {"login": "marcomarasca"}, "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/UrlHelpers.java", "diffHunk": "@@ -921,6 +920,7 @@\n \tpublic static final String NAME_FRAGMENT_FILTER = \"fragment\";\n \tpublic static final String MEMBER_TYPE_FILTER = \"memberType\";\n \tpublic static final String TEAM_ID_ICON = TEAM_ID+\"/icon\";\n+\tpublic static final String TEAM_ID_ICON_PREVIEW = TEAM_ID+\"/icon/preview\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6d585851a84bc731ee6b6df88d17ded00998fc0"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwNDYyOA==", "bodyText": "We can extract a method to get the file handle id of a team since the same logic is used in more than one place.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r489804628", "createdAt": "2020-09-16T23:16:19Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -707,6 +707,28 @@ public String getIconURL(UserInfo userInfo, String teamId) throws NotFoundExcept\n \t\treturn fileHandleManager.getRedirectURLForFileHandle(urlRequest);\n \t}\n \n+\t@Override\n+\tpublic String getIconPreviewURL(UserInfo userInfo, String teamId) throws NotFoundException {\n+\t\tTeam team = teamDAO.get(teamId);\n+\n+\t\tString fileHandleId = team.getIcon();\n+\n+\t\tif (fileHandleId == null) {\n+\t\t\tthrow new NotFoundException(\"Team \" + teamId + \" has no icon file handle.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6d585851a84bc731ee6b6df88d17ded00998fc0"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwNTEyNg==", "bodyText": "Let us add some input validation, e.g. using the ValidateArgument.required... methods.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r489805126", "createdAt": "2020-09-16T23:18:01Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -707,6 +707,28 @@ public String getIconURL(UserInfo userInfo, String teamId) throws NotFoundExcept\n \t\treturn fileHandleManager.getRedirectURLForFileHandle(urlRequest);\n \t}\n \n+\t@Override\n+\tpublic String getIconPreviewURL(UserInfo userInfo, String teamId) throws NotFoundException {\n+\t\tTeam team = teamDAO.get(teamId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6d585851a84bc731ee6b6df88d17ded00998fc0"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwNTY2Nw==", "bodyText": "This might throw a NotFoundException for both a non existing file handle id, or for a missing preview. We can catch it here and rethrow a more useful message targeted to this request.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r489805667", "createdAt": "2020-09-16T23:19:46Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -707,6 +707,28 @@ public String getIconURL(UserInfo userInfo, String teamId) throws NotFoundExcept\n \t\treturn fileHandleManager.getRedirectURLForFileHandle(urlRequest);\n \t}\n \n+\t@Override\n+\tpublic String getIconPreviewURL(UserInfo userInfo, String teamId) throws NotFoundException {\n+\t\tTeam team = teamDAO.get(teamId);\n+\n+\t\tString fileHandleId = team.getIcon();\n+\n+\t\tif (fileHandleId == null) {\n+\t\t\tthrow new NotFoundException(\"Team \" + teamId + \" has no icon file handle.\");\n+\t\t}\n+\n+\t\tString fileHandlePreviewId = fileHandleManager.getPreviewFileHandleId(fileHandleId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6d585851a84bc731ee6b6df88d17ded00998fc0"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwNjA2Ng==", "bodyText": "Please let us add // Call under test", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r489806066", "createdAt": "2020-09-16T23:21:11Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "diffHunk": "@@ -771,6 +770,31 @@ public void testGetIconURL() {\n \t\t\n \t\tassertEquals(expectedUrl, url);\n \t}\n+\n+\t@Test\n+\tpublic void testGetIconPreviewURL() {\n+\t\tString iconFileHandleId = \"101\";\n+\n+\t\tTeam team = createTeam(null, \"name\", \"description\", null, iconFileHandleId, null, null, null, null);\n+\t\twhen(mockTeamDAO.get(TEAM_ID)).thenReturn(team);\n+\n+\t\tString iconPreviewFileHandleId = \"102\";\n+\n+\t\twhen(mockFileHandleManager.getPreviewFileHandleId(iconFileHandleId)).thenReturn(iconPreviewFileHandleId);\n+\n+\t\tFileHandleUrlRequest urlRequest = new FileHandleUrlRequest(userInfo, iconPreviewFileHandleId)\n+\t\t\t\t.withAssociation(FileHandleAssociateType.TeamAttachment, TEAM_ID);\n+\n+\t\tString expectedUrl = \"https://testurl.org\";\n+\n+\t\twhen(mockFileHandleManager.getRedirectURLForFileHandle(eq(urlRequest))).thenReturn(expectedUrl);\n+\n+\t\tString url = teamManagerImpl.getIconPreviewURL(userInfo, TEAM_ID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6d585851a84bc731ee6b6df88d17ded00998fc0"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwNjI3OQ==", "bodyText": "the eq(urlRequest) is not needed, should be enough to use the urlRequest directly.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r489806279", "createdAt": "2020-09-16T23:21:47Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "diffHunk": "@@ -771,6 +770,31 @@ public void testGetIconURL() {\n \t\t\n \t\tassertEquals(expectedUrl, url);\n \t}\n+\n+\t@Test\n+\tpublic void testGetIconPreviewURL() {\n+\t\tString iconFileHandleId = \"101\";\n+\n+\t\tTeam team = createTeam(null, \"name\", \"description\", null, iconFileHandleId, null, null, null, null);\n+\t\twhen(mockTeamDAO.get(TEAM_ID)).thenReturn(team);\n+\n+\t\tString iconPreviewFileHandleId = \"102\";\n+\n+\t\twhen(mockFileHandleManager.getPreviewFileHandleId(iconFileHandleId)).thenReturn(iconPreviewFileHandleId);\n+\n+\t\tFileHandleUrlRequest urlRequest = new FileHandleUrlRequest(userInfo, iconPreviewFileHandleId)\n+\t\t\t\t.withAssociation(FileHandleAssociateType.TeamAttachment, TEAM_ID);\n+\n+\t\tString expectedUrl = \"https://testurl.org\";\n+\n+\t\twhen(mockFileHandleManager.getRedirectURLForFileHandle(eq(urlRequest))).thenReturn(expectedUrl);\n+\n+\t\tString url = teamManagerImpl.getIconPreviewURL(userInfo, TEAM_ID);\n+\n+\t\tverify(mockFileHandleManager).getRedirectURLForFileHandle(eq(urlRequest));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6d585851a84bc731ee6b6df88d17ded00998fc0"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwNjYzOQ==", "bodyText": "Let us add the tests for the various cases (e.g. if the id of the icon is not set assert that an exception is thrown, input validation etc).", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r489806639", "createdAt": "2020-09-16T23:22:52Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "diffHunk": "@@ -771,6 +770,31 @@ public void testGetIconURL() {\n \t\t\n \t\tassertEquals(expectedUrl, url);\n \t}\n+\n+\t@Test\n+\tpublic void testGetIconPreviewURL() {\n+\t\tString iconFileHandleId = \"101\";\n+\n+\t\tTeam team = createTeam(null, \"name\", \"description\", null, iconFileHandleId, null, null, null, null);\n+\t\twhen(mockTeamDAO.get(TEAM_ID)).thenReturn(team);\n+\n+\t\tString iconPreviewFileHandleId = \"102\";\n+\n+\t\twhen(mockFileHandleManager.getPreviewFileHandleId(iconFileHandleId)).thenReturn(iconPreviewFileHandleId);\n+\n+\t\tFileHandleUrlRequest urlRequest = new FileHandleUrlRequest(userInfo, iconPreviewFileHandleId)\n+\t\t\t\t.withAssociation(FileHandleAssociateType.TeamAttachment, TEAM_ID);\n+\n+\t\tString expectedUrl = \"https://testurl.org\";\n+\n+\t\twhen(mockFileHandleManager.getRedirectURLForFileHandle(eq(urlRequest))).thenReturn(expectedUrl);\n+\n+\t\tString url = teamManagerImpl.getIconPreviewURL(userInfo, TEAM_ID);\n+\n+\t\tverify(mockFileHandleManager).getRedirectURLForFileHandle(eq(urlRequest));\n+\n+\t\tassertEquals(expectedUrl, url);\n+\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6d585851a84bc731ee6b6df88d17ded00998fc0"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwNzE4Ng==", "bodyText": "We can use any() instead of eq(urlRequest) as we are verifying below that the argument is correct.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r489807186", "createdAt": "2020-09-16T23:24:46Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "diffHunk": "@@ -771,6 +770,31 @@ public void testGetIconURL() {\n \t\t\n \t\tassertEquals(expectedUrl, url);\n \t}\n+\n+\t@Test\n+\tpublic void testGetIconPreviewURL() {\n+\t\tString iconFileHandleId = \"101\";\n+\n+\t\tTeam team = createTeam(null, \"name\", \"description\", null, iconFileHandleId, null, null, null, null);\n+\t\twhen(mockTeamDAO.get(TEAM_ID)).thenReturn(team);\n+\n+\t\tString iconPreviewFileHandleId = \"102\";\n+\n+\t\twhen(mockFileHandleManager.getPreviewFileHandleId(iconFileHandleId)).thenReturn(iconPreviewFileHandleId);\n+\n+\t\tFileHandleUrlRequest urlRequest = new FileHandleUrlRequest(userInfo, iconPreviewFileHandleId)\n+\t\t\t\t.withAssociation(FileHandleAssociateType.TeamAttachment, TEAM_ID);\n+\n+\t\tString expectedUrl = \"https://testurl.org\";\n+\n+\t\twhen(mockFileHandleManager.getRedirectURLForFileHandle(eq(urlRequest))).thenReturn(expectedUrl);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6d585851a84bc731ee6b6df88d17ded00998fc0"}, "originalPosition": 85}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a6b2be6d780bfbbdf90024f8b4b355c628ae7f7", "author": {"user": {"login": "nlgilber", "name": "Nicoletta"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/8a6b2be6d780bfbbdf90024f8b4b355c628ae7f7", "committedDate": "2020-09-17T19:50:28Z", "message": "added more tests, pull request changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMDM4OTQ4", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#pullrequestreview-491038948", "createdAt": "2020-09-17T22:45:16Z", "commit": {"oid": "8a6b2be6d780bfbbdf90024f8b4b355c628ae7f7"}, "state": "APPROVED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjo0NToxNlrOHT4B-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMzowMDoyMlrOHT4VDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwMzAwMg==", "bodyText": "If this is public for testing purposes, we can simply use the default visibility (e.g. without modifier).", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r490603002", "createdAt": "2020-09-17T22:45:16Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -729,6 +724,16 @@ public String getIconPreviewURL(UserInfo userInfo, String teamId) throws NotFoun\n \t\treturn fileHandleManager.getRedirectURLForFileHandle(urlRequest);\n \t}\n \n+\tpublic String getFileHandleId(String teamId) throws NotFoundException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6b2be6d780bfbbdf90024f8b4b355c628ae7f7"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNDkxNw==", "bodyText": "We can set this to null?", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r490604917", "createdAt": "2020-09-17T22:51:16Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -709,18 +706,16 @@ public String getIconURL(UserInfo userInfo, String teamId) throws NotFoundExcept\n \n \t@Override\n \tpublic String getIconPreviewURL(UserInfo userInfo, String teamId) throws NotFoundException {\n-\t\tTeam team = teamDAO.get(teamId);\n-\n-\t\tString fileHandleId = team.getIcon();\n-\n-\t\tif (fileHandleId == null) {\n-\t\t\tthrow new NotFoundException(\"Team \" + teamId + \" has no icon file handle.\");\n-\t\t}\n-\n-\t\tString fileHandlePreviewId = fileHandleManager.getPreviewFileHandleId(fileHandleId);\n+\t\tValidateArgument.required(userInfo, \"userInfo\");\n+\t\tValidateArgument.required(teamId, \"teamId\");\n \n-\t\tif (fileHandlePreviewId == null) {\n-\t\t\tthrow new NotFoundException(\"Team \" + teamId + \" has no icon preview file handle.\");\n+\t\tString fileHandleId = getFileHandleId(teamId);\n+\t\tString fileHandlePreviewId = \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6b2be6d780bfbbdf90024f8b4b355c628ae7f7"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNTU2Nw==", "bodyText": "We can simplify this message to be such as \"No preview was found for the icon of the team with id: 123\"", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r490605567", "createdAt": "2020-09-17T22:53:13Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -709,18 +706,16 @@ public String getIconURL(UserInfo userInfo, String teamId) throws NotFoundExcept\n \n \t@Override\n \tpublic String getIconPreviewURL(UserInfo userInfo, String teamId) throws NotFoundException {\n-\t\tTeam team = teamDAO.get(teamId);\n-\n-\t\tString fileHandleId = team.getIcon();\n-\n-\t\tif (fileHandleId == null) {\n-\t\t\tthrow new NotFoundException(\"Team \" + teamId + \" has no icon file handle.\");\n-\t\t}\n-\n-\t\tString fileHandlePreviewId = fileHandleManager.getPreviewFileHandleId(fileHandleId);\n+\t\tValidateArgument.required(userInfo, \"userInfo\");\n+\t\tValidateArgument.required(teamId, \"teamId\");\n \n-\t\tif (fileHandlePreviewId == null) {\n-\t\t\tthrow new NotFoundException(\"Team \" + teamId + \" has no icon preview file handle.\");\n+\t\tString fileHandleId = getFileHandleId(teamId);\n+\t\tString fileHandlePreviewId = \"\";\n+\t\ttry {\n+\t\t\tfileHandlePreviewId = fileHandleManager.getPreviewFileHandleId(fileHandleId);\n+\t\t} catch(NotFoundException e) {\n+\t\t\tthrow new NotFoundException(e.getMessage() + \" icon file handle or icon preview file handle not found\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6b2be6d780bfbbdf90024f8b4b355c628ae7f7"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNjQzOQ==", "bodyText": "testGetIconURLUserInfo -> testGetIconURLWithNullUserInfo", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r490606439", "createdAt": "2020-09-17T22:55:48Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "diffHunk": "@@ -771,6 +772,22 @@ public void testGetIconURL() {\n \t\tassertEquals(expectedUrl, url);\n \t}\n \n+\t@Test\n+\tpublic void testGetIconURLUserInfo() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6b2be6d780bfbbdf90024f8b4b355c628ae7f7"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNjYyNw==", "bodyText": "testGetIconURLTeamId -> testGetIconURLWithNullTeamId", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r490606627", "createdAt": "2020-09-17T22:56:29Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "diffHunk": "@@ -771,6 +772,22 @@ public void testGetIconURL() {\n \t\tassertEquals(expectedUrl, url);\n \t}\n \n+\t@Test\n+\tpublic void testGetIconURLUserInfo() {\n+\t\tException exception = assertThrows(IllegalArgumentException.class, () -> {\n+\t\t\tteamManagerImpl.getIconURL(null, TEAM_ID);\n+\t\t});\n+\t\tassertEquals(\"userInfo is required.\", exception.getMessage());\n+\t}\n+\n+\t@Test\n+\tpublic void testGetIconURLTeamId() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6b2be6d780bfbbdf90024f8b4b355c628ae7f7"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNzA3Mw==", "bodyText": "See previous comment.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r490607073", "createdAt": "2020-09-17T22:57:54Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "diffHunk": "@@ -787,14 +804,52 @@ public void testGetIconPreviewURL() {\n \n \t\tString expectedUrl = \"https://testurl.org\";\n \n-\t\twhen(mockFileHandleManager.getRedirectURLForFileHandle(eq(urlRequest))).thenReturn(expectedUrl);\n+\t\twhen(mockFileHandleManager.getRedirectURLForFileHandle(any())).thenReturn(expectedUrl);\n \n+\t\t// Call under test\n \t\tString url = teamManagerImpl.getIconPreviewURL(userInfo, TEAM_ID);\n \n-\t\tverify(mockFileHandleManager).getRedirectURLForFileHandle(eq(urlRequest));\n+\t\tverify(mockFileHandleManager).getRedirectURLForFileHandle(urlRequest);\n \n \t\tassertEquals(expectedUrl, url);\n \t}\n+\n+\t@Test\n+\tpublic void testGetIconPreviewURLUserInfo() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6b2be6d780bfbbdf90024f8b4b355c628ae7f7"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNzEwNA==", "bodyText": "See previous comment.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r490607104", "createdAt": "2020-09-17T22:58:02Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "diffHunk": "@@ -787,14 +804,52 @@ public void testGetIconPreviewURL() {\n \n \t\tString expectedUrl = \"https://testurl.org\";\n \n-\t\twhen(mockFileHandleManager.getRedirectURLForFileHandle(eq(urlRequest))).thenReturn(expectedUrl);\n+\t\twhen(mockFileHandleManager.getRedirectURLForFileHandle(any())).thenReturn(expectedUrl);\n \n+\t\t// Call under test\n \t\tString url = teamManagerImpl.getIconPreviewURL(userInfo, TEAM_ID);\n \n-\t\tverify(mockFileHandleManager).getRedirectURLForFileHandle(eq(urlRequest));\n+\t\tverify(mockFileHandleManager).getRedirectURLForFileHandle(urlRequest);\n \n \t\tassertEquals(expectedUrl, url);\n \t}\n+\n+\t@Test\n+\tpublic void testGetIconPreviewURLUserInfo() {\n+        Exception exception = assertThrows(IllegalArgumentException.class, () -> {\n+\t\t\tteamManagerImpl.getIconPreviewURL(null, TEAM_ID);\n+\t\t});\n+        assertEquals(\"userInfo is required.\", exception.getMessage());\n+\t}\n+\n+\t@Test\n+\tpublic void testGetIconPreviewURLTeamId() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6b2be6d780bfbbdf90024f8b4b355c628ae7f7"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNzg4NA==", "bodyText": "You can use the variable above :)", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r490607884", "createdAt": "2020-09-17T23:00:22Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "diffHunk": "@@ -771,6 +771,85 @@ public void testGetIconURL() {\n \t\t\n \t\tassertEquals(expectedUrl, url);\n \t}\n+\n+\t@Test\n+\tpublic void testGetIconURLUserInfo() {\n+\t\tException exception = assertThrows(IllegalArgumentException.class, () -> {\n+\t\t\tteamManagerImpl.getIconURL(null, TEAM_ID);\n+\t\t});\n+\t\tassertEquals(\"userInfo is required.\", exception.getMessage());\n+\t}\n+\n+\t@Test\n+\tpublic void testGetIconURLTeamId() {\n+\t\tException exception = assertThrows(IllegalArgumentException.class, () -> {\n+\t\t\tteamManagerImpl.getIconURL(userInfo, null);\n+\t\t});\n+\t\tassertEquals(\"teamId is required.\", exception.getMessage());\n+\t}\n+\n+\t@Test\n+\tpublic void testGetIconPreviewURL() {\n+\t\tString iconFileHandleId = \"101\";\n+\n+\t\tTeam team = createTeam(null, \"name\", \"description\", null, iconFileHandleId, null, null, null, null);\n+\t\twhen(mockTeamDAO.get(TEAM_ID)).thenReturn(team);\n+\n+\t\tString iconPreviewFileHandleId = \"102\";\n+\n+\t\twhen(mockFileHandleManager.getPreviewFileHandleId(iconFileHandleId)).thenReturn(iconPreviewFileHandleId);\n+\n+\t\tFileHandleUrlRequest urlRequest = new FileHandleUrlRequest(userInfo, iconPreviewFileHandleId)\n+\t\t\t\t.withAssociation(FileHandleAssociateType.TeamAttachment, TEAM_ID);\n+\n+\t\tString expectedUrl = \"https://testurl.org\";\n+\n+\t\twhen(mockFileHandleManager.getRedirectURLForFileHandle(any())).thenReturn(expectedUrl);\n+\n+\t\t// Call under test\n+\t\tString url = teamManagerImpl.getIconPreviewURL(userInfo, TEAM_ID);\n+\n+\t\tverify(mockFileHandleManager).getRedirectURLForFileHandle(urlRequest);\n+\n+\t\tassertEquals(expectedUrl, url);\n+\t}\n+\n+\t@Test\n+\tpublic void testGetIconPreviewURLUserInfo() {\n+        Exception exception = assertThrows(IllegalArgumentException.class, () -> {\n+\t\t\tteamManagerImpl.getIconPreviewURL(null, TEAM_ID);\n+\t\t});\n+        assertEquals(\"userInfo is required.\", exception.getMessage());\n+\t}\n+\n+\t@Test\n+\tpublic void testGetIconPreviewURLTeamId() {\n+\t\tException exception = assertThrows(IllegalArgumentException.class, () -> {\n+\t\t\tteamManagerImpl.getIconPreviewURL(userInfo, null);\n+\t\t});\n+\t\tassertEquals(\"teamId is required.\", exception.getMessage());\n+\t}\n+\n+\t@Test\n+\tpublic void testGetFileHandleIdNotFoundException() {\n+\t\tTeam team = createTeam(TEAM_ID, \"name\", \"description\", null, null, null, null, null, null);\n+\t\twhen(mockTeamDAO.get(TEAM_ID)).thenReturn(team);\n+\t\tException exception = assertThrows(NotFoundException.class, () -> {\n+\t\t\t// Call under test\n+\t\t\tteamManagerImpl.getFileHandleId(TEAM_ID);\n+\t\t});\n+\t\tassertEquals(\"Team \" + TEAM_ID + \" has no icon file handle.\", exception.getMessage());\n+\t}\n+\n+\t@Test\n+\tpublic void testGetFileHandleId() {\n+\t\tString iconFileHandleId = \"101\";\n+\t\tTeam team = createTeam(TEAM_ID, \"name\", \"description\", null, \"101\", null, null, null, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6b2be6d780bfbbdf90024f8b4b355c628ae7f7"}, "originalPosition": 142}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMDQ1Mjk4", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#pullrequestreview-491045298", "createdAt": "2020-09-17T23:02:05Z", "commit": {"oid": "8a6b2be6d780bfbbdf90024f8b4b355c628ae7f7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a4b34f99dd0a4bc0b4ecb088c795054138fe262", "author": {"user": {"login": "nlgilber", "name": "Nicoletta"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/4a4b34f99dd0a4bc0b4ecb088c795054138fe262", "committedDate": "2020-09-18T17:26:43Z", "message": " resolve conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "111ee859646a02288c2bb7b9a96ff7fa8d275c2d", "author": {"user": {"login": "nlgilber", "name": "Nicoletta"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/111ee859646a02288c2bb7b9a96ff7fa8d275c2d", "committedDate": "2020-09-18T17:33:24Z", "message": "pull request changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89287a348034c122a13dcd8f7145a96c83587e97", "author": {"user": {"login": "nlgilber", "name": "Nicoletta"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/89287a348034c122a13dcd8f7145a96c83587e97", "committedDate": "2020-09-18T20:46:40Z", "message": "added notFoundException test, changed exception message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNzk3NzE1", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#pullrequestreview-491797715", "createdAt": "2020-09-18T21:42:27Z", "commit": {"oid": "89287a348034c122a13dcd8f7145a96c83587e97"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMTo0MjoyN1rOHUcrIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMTo0MjoyN1rOHUcrIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIwMzM2MA==", "bodyText": "Note that this is not necessary as the previous assertEquals will implicitly perform this check.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r491203360", "createdAt": "2020-09-18T21:42:27Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "diffHunk": "@@ -773,21 +773,40 @@ public void testGetIconURL() {\n \t}\n \n \t@Test\n-\tpublic void testGetIconURLUserInfo() {\n+\tpublic void testGetIconURLWithNullUserInfo() {\n \t\tException exception = assertThrows(IllegalArgumentException.class, () -> {\n \t\t\tteamManagerImpl.getIconURL(null, TEAM_ID);\n \t\t});\n \t\tassertEquals(\"userInfo is required.\", exception.getMessage());\n \t}\n \n \t@Test\n-\tpublic void testGetIconURLTeamId() {\n+\tpublic void testGetIconURLWithNullTeamId() {\n \t\tException exception = assertThrows(IllegalArgumentException.class, () -> {\n \t\t\tteamManagerImpl.getIconURL(userInfo, null);\n \t\t});\n \t\tassertEquals(\"teamId is required.\", exception.getMessage());\n \t}\n \n+\t@Test\n+\tpublic void testGetIconPreviewURLPreviewFileHandleIdNotFoundException() {\n+\n+\t\tNotFoundException cause = new NotFoundException(\"inner exception\");\n+\t\tString iconFileHandleId = \"\";\n+\t\tTeam team = createTeam(TEAM_ID, \"name\", \"description\", null, iconFileHandleId, null, null, null, null);\n+        when(mockTeamDAO.get(TEAM_ID)).thenReturn(team);\n+\t\twhen(mockFileHandleManager.getPreviewFileHandleId(iconFileHandleId)).thenThrow(cause);\n+\n+\t\tNotFoundException exception = assertThrows(NotFoundException.class, () -> {\n+\t\t\t// Call under test\n+\t\t\tteamManagerImpl.getIconPreviewURL(userInfo, TEAM_ID);\n+\t\t});\n+\n+\t\tassertEquals(\"No preview was found for the icon of the team with id: \" + TEAM_ID, exception.getMessage());\n+\t\tassertEquals(cause, exception.getCause());\n+\t\tassertEquals(cause.getMessage(), exception.getCause().getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89287a348034c122a13dcd8f7145a96c83587e97"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNzk3ODg5", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#pullrequestreview-491797889", "createdAt": "2020-09-18T21:42:33Z", "commit": {"oid": "89287a348034c122a13dcd8f7145a96c83587e97"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4661, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}