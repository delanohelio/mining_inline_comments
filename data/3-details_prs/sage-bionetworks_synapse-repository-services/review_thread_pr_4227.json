{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5MjEyNzI0", "number": 4227, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQwMDozMjo1N1rOExaTDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQwMDo1MDowOFrOExaelA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMjQ2NTQyOnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/file/MultipartManagerV2ImplAutowireTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQwMDozMjo1N1rOHnh8xA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQwMDozMjo1N1rOHnh8xA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTIxMjc0MA==", "bodyText": "local vars with names for the vars", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4227#discussion_r511212740", "createdAt": "2020-10-24T00:32:57Z", "author": {"login": "john-hill"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/file/MultipartManagerV2ImplAutowireTest.java", "diffHunk": "@@ -178,197 +160,244 @@ public void before() throws Exception {\n \t\t\tgoogleCloudStorageLocationSetting.setBaseKey(baseKey);\r\n \t\t\tgoogleCloudStorageLocationSetting.setUploadType(UploadType.GOOGLECLOUDSTORAGE);\r\n \t\t\tgoogleCloudStorageLocationSetting = projectSettingsManager.createStorageLocationSetting(adminUserInfo, googleCloudStorageLocationSetting);\r\n+\t\t\r\n+\t\t\tstorageLocationsToDelete.add(googleCloudStorageLocationSetting.getStorageLocationId());\r\n \t\t}\r\n \t}\r\n \r\n \t@AfterEach\r\n \tpublic void after() {\r\n-\t\t\r\n-\t\tentityManager.deleteEntity(adminUserInfo, sourceEntity.getId());\r\n-\t\t\r\n-\t\t// delete the file from S3.\r\n-\t\tif (sourceFileHandle != null) {\r\n-\t\t\ts3Client.deleteObject(sourceFileHandle.getBucketName(), sourceFileHandle.getKey());\r\n+\r\n+\t\tfor (String entityId : entitiesToDelete) {\r\n+\t\t\tentityManager.deleteEntity(adminUserInfo, entityId);\r\n \t\t}\r\n \t\t\r\n-\t\tif (copyFileHandle != null) {\r\n-\t\t\ts3Client.deleteObject(copyFileHandle.getBucketName(), copyFileHandle.getKey());\r\n+\t\tfor (CloudProviderFileHandleInterface fileHandle : fileHandlesToDelete) {\r\n+\t\t\tif (fileHandle instanceof S3FileHandle) {\r\n+\t\t\t\ts3Client.deleteObject(fileHandle.getBucketName(), fileHandle.getKey());\r\n+\t\t\t} else if (fileHandle instanceof GoogleCloudFileHandle) {\r\n+\t\t\t\tgcClient.deleteObject(fileHandle.getBucketName(), fileHandle.getKey());\r\n+\t\t\t}\t\r\n \t\t}\r\n \t\t\r\n \t\tmultipartManagerV2.truncateAll();\r\n \t\tfileHandleDao.truncateTable();\r\n \t\t\r\n-\t\tif (stackConfiguration.getGoogleCloudEnabled()) {\r\n-\t\t\ttry {\r\n-\t\t\t\tprojectSettingsManager.deleteProjectSetting(adminUserInfo, googleCloudStorageLocationSetting.getStorageLocationId().toString());\r\n-\t\t\t} catch (Exception e) {\r\n-\t\t\t}\r\n+\t\tfor (Long storageLocationId :  storageLocationsToDelete) {\r\n+\t\t\tstorageLocationDao.delete(storageLocationId);\r\n \t\t}\r\n \t}\r\n \r\n \t@Test\r\n \tpublic void testMultipartUpload() throws Exception {\r\n-\t\t// step one start the upload.\r\n-\t\tMultipartUploadStatus status = startUpload();\r\n-\t\tString contentType = null;\r\n-\t\t// step two get pre-signed URLs for the parts\r\n-\t\tPartPresignedUrl preSignedUrl = getPresignedURLForPart(status.getUploadId(), contentType);\r\n-\t\t// step three put the part to the URL\r\n-\t\tputStringToURL(preSignedUrl.getUploadPresignedUrl(), fileDataString, preSignedUrl.getSignedHeaders());\r\n-\t\t// step four add the part to the upload\r\n-\t\taddPart(status.getUploadId(), fileMD5Hex);\r\n-\t\t// Step five complete the upload\r\n-\t\tMultipartUploadStatus finalStatus = completeUpload(status.getUploadId());\r\n-\t\t// validate the results\r\n-\t\tassertNotNull(finalStatus);\r\n-\t\tassertEquals(\"1\", finalStatus.getPartsState());\r\n-\t\tassertEquals(MultipartUploadState.COMPLETED, finalStatus.getState());\r\n-\t\tassertNotNull(finalStatus.getResultFileHandleId());\r\n-\t\tfileHandlesToDelete.add(finalStatus.getResultFileHandleId());\r\n+\t\tdoMultipartUpload(\"foo.txt\", \"plain/text\", \"This is the content of the file\", null, false);\r\n \t}\r\n-\t\r\n+\r\n \t@Test\r\n-\tpublic void testMultipartUploadWithPartMD5() throws Exception {\r\n-\t\t// step one start the upload.\r\n-\t\tMultipartUploadStatus status = startUpload();\r\n-\t\tString contentType = null;\r\n-\t\t// step two get pre-signed URLs for the parts\r\n-\t\tPartPresignedUrl preSignedUrl = getPresignedURLForPart(status.getUploadId(), contentType, fileMD5Hex);\r\n-\t\t// step three put the part to the URL\r\n-\t\tputStringToURL(preSignedUrl.getUploadPresignedUrl(), fileDataString, preSignedUrl.getSignedHeaders());\r\n-\t\t// step four add the part to the upload\r\n-\t\taddPart(status.getUploadId(), fileMD5Hex);\r\n-\t\t// Step five complete the upload\r\n-\t\tMultipartUploadStatus finalStatus = completeUpload(status.getUploadId());\r\n-\t\t// validate the results\r\n-\t\tassertNotNull(finalStatus);\r\n-\t\tassertEquals(\"1\", finalStatus.getPartsState());\r\n-\t\tassertEquals(MultipartUploadState.COMPLETED, finalStatus.getState());\r\n-\t\tassertNotNull(finalStatus.getResultFileHandleId());\r\n-\t\tfileHandlesToDelete.add(finalStatus.getResultFileHandleId());\r\n+\tpublic void testMultipartUploadWithContentType() throws Exception {\r\n+\t\tdoMultipartUpload(\"foo.txt\", \"plain/text\", \"This is the content of the file\", null, true);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b859126bc1e0044896432e5169a812b4de75b27c"}, "originalPosition": 227}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwMjQ5NDkyOnYy", "diffSide": "RIGHT", "path": "lib/lib-upload/src/main/java/org/sagebionetworks/upload/multipart/S3MultipartUploadDAOImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQwMDo1MDowOFrOHniPqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNFQwMDo1MDowOFrOHniPqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTIxNzU3Nw==", "bodyText": "let the exception go to the base handler.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4227#discussion_r511217577", "createdAt": "2020-10-24T00:50:08Z", "author": {"login": "john-hill"}, "path": "lib/lib-upload/src/main/java/org/sagebionetworks/upload/multipart/S3MultipartUploadDAOImpl.java", "diffHunk": "@@ -281,4 +274,14 @@ public long completeMultipartUpload(CompleteMultipartRequest request) {\n \t\treturn resultFileMetadata.getContentLength();\r\n \t}\r\n \r\n+\t@Override\r\n+\tpublic String getObjectEtag(String bucket, String key) {\r\n+\t\ttry {\r\n+\t\t\tObjectMetadata metaData = s3Client.getObjectMetadata(bucket, key);\r\n+\t\t\treturn metaData.getETag();\r\n+\t\t} catch (AmazonS3Exception e) {\r\n+\t\t\tthrow new IllegalArgumentException(e.getMessage(), e);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b859126bc1e0044896432e5169a812b4de75b27c"}, "originalPosition": 74}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2882, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}