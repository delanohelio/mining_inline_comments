{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyODczODcy", "number": 4117, "title": "PLFM-6241 - Log the OAuth client id from the basic auth creds", "bodyText": "", "createdAt": "2020-07-01T18:26:24Z", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4117", "merged": true, "mergeCommit": {"oid": "718ba000d3eb65e5d914da4e1df54ff55c582f26"}, "closed": true, "closedAt": "2020-07-08T17:26:20Z", "author": {"login": "nickgros"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwugkLgH2gAyNDQyODczODcyOjY2MTJmNWFlMzVmNTc5ZTFmODQ1ZDUwNGFjMjJhOTEwOTRkZWFlOWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy92rvAFqTQ0NDk4MDU5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6612f5ae35f579e1f845d504ac22a91094deae9a", "author": {"user": {"login": "nickgros", "name": "Nick Grosenbacher"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/6612f5ae35f579e1f845d504ac22a91094deae9a", "committedDate": "2020-07-01T18:25:39Z", "message": "Log the OAuth client id from the basic auth creds"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTcyMzMz", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4117#pullrequestreview-441172333", "createdAt": "2020-07-01T20:23:51Z", "commit": {"oid": "6612f5ae35f579e1f845d504ac22a91094deae9a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMDoyMzo1MVrOGr0L_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMDoyMzo1MVrOGr0L_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU5Njk4OA==", "bodyText": "A small warning about this approach: this might not be enough since we use basic authentication in other filters that are not related to oauth and the \"username\" extracted might not actually be an OAuth client id (e.g. might be the user for docker registry or cloud mail in, a service call etc.). You might want to check for the special OAUTH_VERIFIED_CLIENT_ID_HEADER injected in the request instead (see the implementation of OAuthClientAuthFilter)", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4117#discussion_r448596988", "createdAt": "2020-07-01T20:23:51Z", "author": {"login": "marcomarasca"}, "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/AccessInterceptor.java", "diffHunk": "@@ -51,9 +51,19 @@\n \tprivate OIDCTokenHelper oidcTokenHelper;\r\n \t\r\n \tString getOAuthClientId(HttpServletRequest request) {\r\n+\t\t/*\r\n+\t\t * There are two different places the client ID might be:\r\n+\t\t *  - in the access token, if the OAuth client is acting on behalf of a user\r\n+\t\t *  - in the basic auth credentials, if using an auth code/refresh token\r\n+\t\t */\r\n \t\tString accessToken = HttpAuthUtil.getBearerTokenFromStandardAuthorizationHeader(request);\r\n-\t\tif (accessToken==null) return null;\r\n-\t\treturn oidcTokenHelper.parseJWT(accessToken).getBody().getAudience();\r\n+\t\tif (accessToken != null) {\r\n+\t\t\treturn oidcTokenHelper.parseJWT(accessToken).getBody().getAudience();\r\n+\t\t} else if (HttpAuthUtil.usesBasicAuthentication(request)) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6612f5ae35f579e1f845d504ac22a91094deae9a"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc5ffbd58e999fb5d7549112a26556fd0405e217", "author": {"user": {"login": "nickgros", "name": "Nick Grosenbacher"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/fc5ffbd58e999fb5d7549112a26556fd0405e217", "committedDate": "2020-07-02T15:33:29Z", "message": "Get the OAuth client name from the header when using basic auth, log the basic auth username separately"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0OTc1MTc0", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4117#pullrequestreview-444975174", "createdAt": "2020-07-08T17:19:07Z", "commit": {"oid": "fc5ffbd58e999fb5d7549112a26556fd0405e217"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNzoxOTowN1rOGux3pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNzoxOTowN1rOGux3pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTcwNDc0Mw==", "bodyText": "why do we sleep?", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4117#discussion_r451704743", "createdAt": "2020-07-08T17:19:07Z", "author": {"login": "brucehoff"}, "path": "services/repository/src/test/java/org/sagebionetworks/repo/web/AccessInterceptorTest.java", "diffHunk": "@@ -196,7 +199,54 @@ public void testStatusCode400() throws Exception{\n \t\tassertNotNull(result);\r\n \t\tassertTrue(result.getTimestamp() >= start);\r\n \t\tassertEquals(234L, result.getElapseMS().longValue());\r\n-\t\tassertFalse(\"400 is not a success\",result.getSuccess());\r\n+\t\tassertFalse(result.getSuccess(), \"400 is not a success\");\r\n \t\tassertEquals(new Long(400), result.getResponseStatus());\r\n \t}\r\n+\r\n+\t@Test\r\n+\tpublic void testGetOAuthClientIdFromBearerJwt() throws Exception {\r\n+\t\t// Put the client ID in the JWT access token\r\n+\t\twhen(mockRequest.getHeader(\"Authorization\")).thenReturn(BEARER_TOKEN_HEADER);\r\n+\t\tClaims claims = new DefaultClaims();\r\n+\t\tclaims.setAudience(OAUTH_CLIENT_ID);\r\n+\t\tJwt<JwsHeader,Claims> jwt = new DefaultJwt(null, claims);\r\n+\t\twhen(oidcTokenHelper.parseJWT(any())).thenReturn(jwt);\r\n+\r\n+\t\t// Start\r\n+\t\tinterceptor.preHandle(mockRequest, mockResponse, mockHandler);\r\n+\t\tinterceptor.setReturnObjectId(\"returnId\");\r\n+\t\t// Wait to add some elapse time\r\n+\t\ttestClock.sleep(234);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc5ffbd58e999fb5d7549112a26556fd0405e217"}, "originalPosition": 114}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0OTc3MDE5", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4117#pullrequestreview-444977019", "createdAt": "2020-07-08T17:21:31Z", "commit": {"oid": "fc5ffbd58e999fb5d7549112a26556fd0405e217"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNzoyMTozMlrOGux9Rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNzoyMTozMlrOGux9Rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTcwNjE4Mg==", "bodyText": "// method under test", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4117#discussion_r451706182", "createdAt": "2020-07-08T17:21:32Z", "author": {"login": "brucehoff"}, "path": "services/repository/src/test/java/org/sagebionetworks/repo/web/AccessInterceptorTest.java", "diffHunk": "@@ -196,7 +199,54 @@ public void testStatusCode400() throws Exception{\n \t\tassertNotNull(result);\r\n \t\tassertTrue(result.getTimestamp() >= start);\r\n \t\tassertEquals(234L, result.getElapseMS().longValue());\r\n-\t\tassertFalse(\"400 is not a success\",result.getSuccess());\r\n+\t\tassertFalse(result.getSuccess(), \"400 is not a success\");\r\n \t\tassertEquals(new Long(400), result.getResponseStatus());\r\n \t}\r\n+\r\n+\t@Test\r\n+\tpublic void testGetOAuthClientIdFromBearerJwt() throws Exception {\r\n+\t\t// Put the client ID in the JWT access token\r\n+\t\twhen(mockRequest.getHeader(\"Authorization\")).thenReturn(BEARER_TOKEN_HEADER);\r\n+\t\tClaims claims = new DefaultClaims();\r\n+\t\tclaims.setAudience(OAUTH_CLIENT_ID);\r\n+\t\tJwt<JwsHeader,Claims> jwt = new DefaultJwt(null, claims);\r\n+\t\twhen(oidcTokenHelper.parseJWT(any())).thenReturn(jwt);\r\n+\r\n+\t\t// Start\r\n+\t\tinterceptor.preHandle(mockRequest, mockResponse, mockHandler);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc5ffbd58e999fb5d7549112a26556fd0405e217"}, "originalPosition": 111}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0OTgwNTk4", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4117#pullrequestreview-444980598", "createdAt": "2020-07-08T17:26:14Z", "commit": {"oid": "fc5ffbd58e999fb5d7549112a26556fd0405e217"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4566, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}