{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4MDMyNzk5", "number": 4046, "title": " PLFM-6211: allow Docker client to use an access token instead of a password", "bodyText": "", "createdAt": "2020-05-14T14:25:31Z", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4046", "merged": true, "mergeCommit": {"oid": "9655634aba175b12e6a4329cddebd648b2c636ac"}, "closed": true, "closedAt": "2020-05-20T23:43:13Z", "author": {"login": "brucehoff"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccfBwMAH2gAyNDE4MDMyNzk5OjBhODljYmFlMzAxOGI1NTk3MzBjYjdhODQwY2IwNDMwM2UzN2RhNTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjR37DAFqTQxNTc4NzYzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0a89cbae3018b559730cb7a840cb04303e37da50", "author": {"user": {"login": "brucehoff", "name": "Bruce Hoff"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/0a89cbae3018b559730cb7a840cb04303e37da50", "committedDate": "2020-04-29T21:04:56Z", "message": "PLFM-6211 Docker client can authenticate with access token"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0963c0e612d4a74888be84b110bc5ddb376bb21", "author": {"user": {"login": "brucehoff", "name": "Bruce Hoff"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/b0963c0e612d4a74888be84b110bc5ddb376bb21", "committedDate": "2020-05-04T22:58:33Z", "message": "Merge branch 'develop' of https://github.com/Sage-Bionetworks/Synapse-Repository-Services into PLFM-6211"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "622a20cf89dad0a1eadcc330d2380dcf73b0c709", "author": {"user": {"login": "brucehoff", "name": "Bruce Hoff"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/622a20cf89dad0a1eadcc330d2380dcf73b0c709", "committedDate": "2020-05-14T14:24:03Z", "message": "PLFM-6211: allow Docker client to use an access token instead of a password"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f36659a5a45fbfdff514f125ff39a0f330502d92", "author": {"user": {"login": "brucehoff", "name": "Bruce Hoff"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/f36659a5a45fbfdff514f125ff39a0f330502d92", "committedDate": "2020-05-14T14:50:48Z", "message": "PLFM-6211: allow Docker client to use an access token instead of a password"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4e4aa18b976f206a5cd467d530e2d3c6da7406e", "author": {"user": {"login": "brucehoff", "name": "Bruce Hoff"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/a4e4aa18b976f206a5cd467d530e2d3c6da7406e", "committedDate": "2020-05-14T14:56:36Z", "message": "PLFM-6211: allow Docker client to use an access token instead of a password"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMDA1ODYz", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4046#pullrequestreview-413005863", "createdAt": "2020-05-15T22:44:31Z", "commit": {"oid": "a4e4aa18b976f206a5cd467d530e2d3c6da7406e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMjo0NDozMlrOGWVszg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMjo0ODoyN1rOGWVwyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA3NzM5MA==", "bodyText": "We might want to modify the abstract method to return some sort of object that could be used as a signal in the subsequent step that there is a different type of \"credentials\".", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4046#discussion_r426077390", "createdAt": "2020-05-15T22:44:32Z", "author": {"login": "marcomarasca"}, "path": "services/repository/src/main/java/org/sagebionetworks/auth/filter/DockerClientAuthFilter.java", "diffHunk": "@@ -56,43 +62,58 @@ protected boolean reportBadCredentialsMetric() {\n \n \t@Override\n \tprotected boolean validCredentials(UserNameAndPassword credentials) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4e4aa18b976f206a5cd467d530e2d3c6da7406e"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA3ODQxMA==", "bodyText": "Consider introducing a dedicated filter for the term of use check that comes after all the authentication filters and could be applied to any endpoint regardless.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4046#discussion_r426078410", "createdAt": "2020-05-15T22:48:27Z", "author": {"login": "marcomarasca"}, "path": "services/repository/src/main/java/org/sagebionetworks/auth/filter/DockerClientAuthFilter.java", "diffHunk": "@@ -56,43 +62,58 @@ protected boolean reportBadCredentialsMetric() {\n \n \t@Override\n \tprotected boolean validCredentials(UserNameAndPassword credentials) {\n-\t\tLoginRequest credential = new LoginRequest();\n-\t\t\n-\t\tcredential.setUsername(credentials.getUserName());\n-\t\tcredential.setPassword(credentials.getPassword());\n-\t\t\n \t\ttry {\n-\t\t\tauthenticationService.login(credential);\n-\t\t} catch (UnauthenticatedException e) {\n-\t\t\treturn false;\n+\t\t\t// is the password actually an access token?\n+\t\t\toidcManager.getUserId(credentials.getPassword());\n+\t\t\treturn true;\n+\t\t} catch (IllegalArgumentException iae) {\n+\t\t\t// the password is NOT a (valid) access token,\n+\t\t\t// but maybe it's a password\n+\t\t\tLoginRequest credential = new LoginRequest();\n+\t\t\t\n+\t\t\tcredential.setUsername(credentials.getUserName());\n+\t\t\tcredential.setPassword(credentials.getPassword());\n+\t\t\t\n+\t\t\ttry {\n+\t\t\t\tauthenticationService.login(credential);\n+\t\t\t\treturn true;\n+\t\t\t} catch (UnauthenticatedException e) {\n+\t\t\t\treturn false;\n+\t\t\t}\n \t\t}\n-\t\t\n-\t\treturn true;\n-\n \t}\n \t\n \t@Override\n \tprotected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain, UserNameAndPassword credentials) throws ServletException, IOException {\n \t\t\n \t\tLong userId = BOOTSTRAP_PRINCIPAL.ANONYMOUS_USER.getPrincipalId();\n \t\t\n+\t\tMap<String, String[]> modHeaders = HttpAuthUtil.filterAuthorizationHeaders(request);\n+\t\t\n \t\tif (credentials != null) {\n+\t\t\tString accessToken = null;\n \t\t\ttry {\n-\t\t\t\tString username = credentials.getUserName();\n-\t\t\t\tPrincipalAlias alias = authenticationService.lookupUserForAuthentication(username);\n-\t\t\t\tuserId = alias.getPrincipalId();\n-\t\t\t} catch (NotFoundException e) {\n-\t\t\t\trejectRequest(response, getInvalidCredentialsMessage());\n+\t\t\t\t// is the password actually an access token?\n+\t\t\t\taccessToken = credentials.getPassword();\n+\t\t\t\tuserId = Long.parseLong(oidcManager.getUserId(accessToken));\n+\t\t\t} catch (IllegalArgumentException iae) {\n+\t\t\t\ttry {\n+\t\t\t\t\tString username = credentials.getUserName();\n+\t\t\t\t\tPrincipalAlias alias = authenticationService.lookupUserForAuthentication(username);\n+\t\t\t\t\tuserId = alias.getPrincipalId();\n+\t\t\t\t\taccessToken = oidcTokenHelper.createTotalAccessToken(userId);\n+\t\t\t\t} catch (NotFoundException e) {\n+\t\t\t\t\trejectRequest(response, getInvalidCredentialsMessage());\n+\t\t\t\t\treturn;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tHttpAuthUtil.setBearerTokenHeader(modHeaders, accessToken);\n+\t\t\tif (!authenticationService.hasUserAcceptedTermsOfUse(userId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4e4aa18b976f206a5cd467d530e2d3c6da7406e"}, "originalPosition": 114}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0OTIzMDg3", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4046#pullrequestreview-414923087", "createdAt": "2020-05-20T00:59:18Z", "commit": {"oid": "09326973ef08cfbb11208b31dfb20187e27b735f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwMDo1OToxOFrOGX3twQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwMDo1OToxOFrOGX3twQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY4MzI2NQ==", "bodyText": "A little trickery in the (CGLIB) proxies that we use for the spring beans, I'm afraid that the method cannot be final", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4046#discussion_r427683265", "createdAt": "2020-05-20T00:59:18Z", "author": {"login": "marcomarasca"}, "path": "services/repository/src/main/java/org/sagebionetworks/auth/filter/AcceptTermsOfUseFilter.java", "diffHunk": "@@ -0,0 +1,82 @@\n+package org.sagebionetworks.auth.filter;\r\n+\r\n+import java.io.IOException;\r\n+\r\n+import javax.servlet.Filter;\r\n+import javax.servlet.FilterChain;\r\n+import javax.servlet.FilterConfig;\r\n+import javax.servlet.ServletException;\r\n+import javax.servlet.ServletRequest;\r\n+import javax.servlet.ServletResponse;\r\n+import javax.servlet.http.HttpServletRequest;\r\n+import javax.servlet.http.HttpServletResponse;\r\n+\r\n+import org.sagebionetworks.auth.HttpAuthUtil;\r\n+import org.sagebionetworks.auth.services.AuthenticationService;\r\n+import org.sagebionetworks.repo.model.AuthorizationConstants;\r\n+import org.sagebionetworks.repo.model.AuthorizationConstants.BOOTSTRAP_PRINCIPAL;\r\n+import org.springframework.beans.factory.annotation.Autowired;\r\n+import org.springframework.http.HttpStatus;\r\n+import org.springframework.stereotype.Component;\r\n+\r\n+/**\r\n+\r\n+ * This filter checks that the authenticated Syanpse user has agreed to the Synapse Terms Of Use.\r\n+ * Anonymous users are simply let through.\r\n+ */\r\n+@Component(\"acceptTermsOfUseFilter\")\r\n+public class AcceptTermsOfUseFilter implements Filter {\r\n+\tprivate static final String TOU_UNSIGNED_REASON = \"Terms of use have not been signed.\";\r\n+\t\r\n+\tprivate AuthenticationService authenticationService;\r\n+\r\n+\t@Autowired\r\n+\tpublic AcceptTermsOfUseFilter(AuthenticationService authenticationService) {\r\n+\t\tthis.authenticationService = authenticationService;\r\n+\t}\r\n+\t\r\n+\t@Override\r\n+\tpublic final void doFilter(ServletRequest request, ServletResponse response, FilterChain filterChain)\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09326973ef08cfbb11208b31dfb20187e27b735f"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "baeff80e5e3953a39d4e2063220e863fb5604f87", "author": {"user": {"login": "brucehoff", "name": "Bruce Hoff"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/baeff80e5e3953a39d4e2063220e863fb5604f87", "committedDate": "2020-05-20T22:15:09Z", "message": "PLFM-6211 refactor BasicAuthenticationFilter to allow DockerClientAuthFilter to validate access token just once. Factored out ToU check into its own filter."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "69cc9d66a154327bae0a050d30f232a8e5fe87f1", "author": {"user": {"login": "brucehoff", "name": "Bruce Hoff"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/69cc9d66a154327bae0a050d30f232a8e5fe87f1", "committedDate": "2020-05-20T01:13:01Z", "message": "PLFM-6211 fix NPE"}, "afterCommit": {"oid": "baeff80e5e3953a39d4e2063220e863fb5604f87", "author": {"user": {"login": "brucehoff", "name": "Bruce Hoff"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/baeff80e5e3953a39d4e2063220e863fb5604f87", "committedDate": "2020-05-20T22:15:09Z", "message": "PLFM-6211 refactor BasicAuthenticationFilter to allow DockerClientAuthFilter to validate access token just once. Factored out ToU check into its own filter."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1Nzg3NjM0", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4046#pullrequestreview-415787634", "createdAt": "2020-05-20T23:42:54Z", "commit": {"oid": "baeff80e5e3953a39d4e2063220e863fb5604f87"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4716, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}