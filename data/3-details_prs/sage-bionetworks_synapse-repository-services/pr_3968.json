{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MDE3NTA0", "number": 3968, "title": "switch to stored procedures for transaction managment, consitency and\u2026", "bodyText": "\u2026 performance", "createdAt": "2020-03-06T20:56:00Z", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3968", "merged": true, "mergeCommit": {"oid": "76bb1ade476f436d06a4eac632fe9c91cba60319"}, "closed": true, "closedAt": "2020-03-07T02:25:19Z", "author": {"login": "john-hill"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcLGgTnAH2gAyMzg1MDE3NTA0OjlkZmY4ZGFkM2M5MDgxODhmNTVjZmM2ZWNkNWVkZTFlNzE5NzE0NWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcLLNCrgFqTM3MDcxNDk3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9dff8dad3c908188f55cfc6ecd5ede1e7197145a", "author": {"user": {"login": "john-hill", "name": "John Hill"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/9dff8dad3c908188f55cfc6ecd5ede1e7197145a", "committedDate": "2020-03-06T20:53:58Z", "message": "switch to stored procedures for transaction managment, consitency and performance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "526daaefa24cf91d7e8fcdeeda064c6d78c60bed", "author": {"user": {"login": "john-hill", "name": "John Hill"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/526daaefa24cf91d7e8fcdeeda064c6d78c60bed", "committedDate": "2020-03-06T21:11:38Z", "message": "updated tests to junit 5"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e32b5a920b3ab2e53875b4359be5ae4997ff6207", "author": {"user": {"login": "john-hill", "name": "John Hill"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/e32b5a920b3ab2e53875b4359be5ae4997ff6207", "committedDate": "2020-03-06T21:16:55Z", "message": "all tests are integeration tests in the package"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNjkxNDY1", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3968#pullrequestreview-370691465", "createdAt": "2020-03-06T23:50:33Z", "commit": {"oid": "e32b5a920b3ab2e53875b4359be5ae4997ff6207"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMzo1MDozM1rOFzKs3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMzo1MDozM1rOFzKs3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NzAyMw==", "bodyText": "we can remove the properties block", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3968#discussion_r389197023", "createdAt": "2020-03-06T23:50:33Z", "author": {"login": "marcomarasca"}, "path": "lib/id-generator/pom.xml", "diffHunk": "@@ -98,7 +98,7 @@\n \t</dependencies>\n \n \t<properties>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e32b5a920b3ab2e53875b4359be5ae4997ff6207"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNjkzMDM5", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3968#pullrequestreview-370693039", "createdAt": "2020-03-06T23:57:02Z", "commit": {"oid": "e32b5a920b3ab2e53875b4359be5ae4997ff6207"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMzo1NzowMlrOFzKyHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMzo1NzowMlrOFzKyHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5ODM2Ng==", "bodyText": "We could check for a specific error code", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3968#discussion_r389198366", "createdAt": "2020-03-06T23:57:02Z", "author": {"login": "marcomarasca"}, "path": "lib/id-generator/src/main/java/org/sagebionetworks/ids/IdGeneratorImpl.java", "diffHunk": "@@ -139,40 +119,34 @@ public void afterPropertiesSet() throws Exception {\n \t\t\t}\n \t\t}\n \t}\n-\n-\t@NewWriteTransaction\n-\t@Override\n-\tpublic BatchOfIds generateBatchNewIds(IdType type, int count) {\n-\t\tif(type == null){\n-\t\t\tthrow new IllegalArgumentException(\"Type cannot be null\");\n-\t\t}\n-\t\tif(count < 1){\n-\t\t\tthrow new IllegalArgumentException(\"Count must be greater than or equal to 1.\");\n-\t\t}\n-\t\t// Get the first ID and acquire the lock on this type.\n-\t\tLong firstId = generateNewId(type);\n-\t\tLong lastId = firstId+(count-1);\n-\t\tif(count > 1){\n-\t\t\tlong now = System.currentTimeMillis();\n-\t\t\tidGeneratorJdbcTemplate.update(String.format(INSERT_SQL_INCREMENT, type.name()), lastId, now);\n+\t\n+\tpublic void createStoredProcedure(String name) {\n+\t\tString ddl = loadDDLString(name);\n+\t\ttry {\n+\t\t\tidGeneratorJdbcTemplate.execute(ddl);\n+\t\t} catch (DataAccessException e) {\n+\t\t\tif(!e.getMessage().contains(\"already exists\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e32b5a920b3ab2e53875b4359be5ae4997ff6207"}, "originalPosition": 142}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNzAyNDY5", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3968#pullrequestreview-370702469", "createdAt": "2020-03-07T00:41:55Z", "commit": {"oid": "e32b5a920b3ab2e53875b4359be5ae4997ff6207"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDo0MTo1NVrOFzLTJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDo0MTo1NVrOFzLTJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwNjgyMA==", "bodyText": "We might not need a transaction nor the lock table", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3968#discussion_r389206820", "createdAt": "2020-03-07T00:41:55Z", "author": {"login": "marcomarasca"}, "path": "lib/id-generator/src/main/resources/generateNewId.ddl.sql", "diffHunk": "@@ -0,0 +1,23 @@\n+CREATE PROCEDURE generateNewId(IN typeName VARCHAR(256))\n+    MODIFIES SQL DATA\n+    SQL SECURITY INVOKER\n+BEGIN\n+\tDECLARE newId BIGINT;\n+    DECLARE typeLock VARCHAR(256);\n+\t\n+\tSET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e32b5a920b3ab2e53875b4359be5ae4997ff6207"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b57875122e79cb04dd1fdb505a19c17bdd743fc", "author": {"user": {"login": "john-hill", "name": "John Hill"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/4b57875122e79cb04dd1fdb505a19c17bdd743fc", "committedDate": "2020-03-07T01:25:40Z", "message": "JdbcTemplate only guarentees the same connection for the same transaction, but we do not need a transaction but we do need to reuse the same connection.  Adding both the INSERT and LAST_INSERT_ID() calls esures the same connection is used without using a transaction or a semaphore lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b7492fb708e8cac66e07ec62bcc66edb479c55a", "author": {"user": {"login": "john-hill", "name": "John Hill"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/6b7492fb708e8cac66e07ec62bcc66edb479c55a", "committedDate": "2020-03-07T01:28:59Z", "message": "code coverage reduced"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNzE0NDMy", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3968#pullrequestreview-370714432", "createdAt": "2020-03-07T02:15:30Z", "commit": {"oid": "6b7492fb708e8cac66e07ec62bcc66edb479c55a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMjoxNTozMFrOFzMAfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMjoxNTozMFrOFzMAfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxODQyOA==", "bodyText": "Can be removed", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3968#discussion_r389218428", "createdAt": "2020-03-07T02:15:30Z", "author": {"login": "marcomarasca"}, "path": "lib/id-generator/src/main/resources/generateNewId.ddl.sql", "diffHunk": "@@ -0,0 +1,25 @@\n+CREATE PROCEDURE generateNewId(IN typeName VARCHAR(256))\n+    MODIFIES SQL DATA\n+    SQL SECURITY INVOKER\n+BEGIN\n+\tDECLARE newId BIGINT;\n+    DECLARE typeLock VARCHAR(256);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b7492fb708e8cac66e07ec62bcc66edb479c55a"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNzE0NDk2", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3968#pullrequestreview-370714496", "createdAt": "2020-03-07T02:16:09Z", "commit": {"oid": "6b7492fb708e8cac66e07ec62bcc66edb479c55a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMjoxNjoxMFrOFzMAxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMjoxNjoxMFrOFzMAxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxODUwMg==", "bodyText": "Can be removed", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3968#discussion_r389218502", "createdAt": "2020-03-07T02:16:10Z", "author": {"login": "marcomarasca"}, "path": "lib/id-generator/src/main/resources/reserveId.ddl.sql", "diffHunk": "@@ -0,0 +1,16 @@\n+CREATE PROCEDURE reserveId(IN idToReserve BIGINT, IN typeName VARCHAR(256))\n+    MODIFIES SQL DATA\n+    SQL SECURITY INVOKER\n+BEGIN\n+    DECLARE typeLock VARCHAR(256);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b7492fb708e8cac66e07ec62bcc66edb479c55a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNzE0OTcx", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3968#pullrequestreview-370714971", "createdAt": "2020-03-07T02:22:27Z", "commit": {"oid": "6b7492fb708e8cac66e07ec62bcc66edb479c55a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4827, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}