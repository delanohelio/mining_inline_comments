{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4MjcwOTUz", "number": 4200, "reviewThreads": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMzoxNDoxMVrOEkRXHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMTo0MjoyN1rOElH-4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDY4NjM5OnYy", "diffSide": "RIGHT", "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/UrlHelpers.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMzoxNDoxMVrOHTHQfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMzoxNDoxMVrOHTHQfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwMzkwMg==", "bodyText": "We can reuse the TEAM_ID_ICON constant: TEAM_ID_ICON_PREVIEW  = TEAM_ID_ICON  + \"/preview\";", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r489803902", "createdAt": "2020-09-16T23:14:11Z", "author": {"login": "marcomarasca"}, "path": "services/repository/src/main/java/org/sagebionetworks/repo/web/UrlHelpers.java", "diffHunk": "@@ -921,6 +920,7 @@\n \tpublic static final String NAME_FRAGMENT_FILTER = \"fragment\";\n \tpublic static final String MEMBER_TYPE_FILTER = \"memberType\";\n \tpublic static final String TEAM_ID_ICON = TEAM_ID+\"/icon\";\n+\tpublic static final String TEAM_ID_ICON_PREVIEW = TEAM_ID+\"/icon/preview\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6d585851a84bc731ee6b6df88d17ded00998fc0"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDY5MTA5OnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMzoxNjoxOVrOHTHTVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMzoxNjoxOVrOHTHTVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwNDYyOA==", "bodyText": "We can extract a method to get the file handle id of a team since the same logic is used in more than one place.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r489804628", "createdAt": "2020-09-16T23:16:19Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -707,6 +707,28 @@ public String getIconURL(UserInfo userInfo, String teamId) throws NotFoundExcept\n \t\treturn fileHandleManager.getRedirectURLForFileHandle(urlRequest);\n \t}\n \n+\t@Override\n+\tpublic String getIconPreviewURL(UserInfo userInfo, String teamId) throws NotFoundException {\n+\t\tTeam team = teamDAO.get(teamId);\n+\n+\t\tString fileHandleId = team.getIcon();\n+\n+\t\tif (fileHandleId == null) {\n+\t\t\tthrow new NotFoundException(\"Team \" + teamId + \" has no icon file handle.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6d585851a84bc731ee6b6df88d17ded00998fc0"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDY5NDU5OnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMzoxODowMVrOHTHVRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMzoxODowMVrOHTHVRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwNTEyNg==", "bodyText": "Let us add some input validation, e.g. using the ValidateArgument.required... methods.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r489805126", "createdAt": "2020-09-16T23:18:01Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -707,6 +707,28 @@ public String getIconURL(UserInfo userInfo, String teamId) throws NotFoundExcept\n \t\treturn fileHandleManager.getRedirectURLForFileHandle(urlRequest);\n \t}\n \n+\t@Override\n+\tpublic String getIconPreviewURL(UserInfo userInfo, String teamId) throws NotFoundException {\n+\t\tTeam team = teamDAO.get(teamId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6d585851a84bc731ee6b6df88d17ded00998fc0"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDY5ODIzOnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMzoxOTo0NlrOHTHXYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMzoxOTo0NlrOHTHXYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwNTY2Nw==", "bodyText": "This might throw a NotFoundException for both a non existing file handle id, or for a missing preview. We can catch it here and rethrow a more useful message targeted to this request.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r489805667", "createdAt": "2020-09-16T23:19:46Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -707,6 +707,28 @@ public String getIconURL(UserInfo userInfo, String teamId) throws NotFoundExcept\n \t\treturn fileHandleManager.getRedirectURLForFileHandle(urlRequest);\n \t}\n \n+\t@Override\n+\tpublic String getIconPreviewURL(UserInfo userInfo, String teamId) throws NotFoundException {\n+\t\tTeam team = teamDAO.get(teamId);\n+\n+\t\tString fileHandleId = team.getIcon();\n+\n+\t\tif (fileHandleId == null) {\n+\t\t\tthrow new NotFoundException(\"Team \" + teamId + \" has no icon file handle.\");\n+\t\t}\n+\n+\t\tString fileHandlePreviewId = fileHandleManager.getPreviewFileHandleId(fileHandleId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6d585851a84bc731ee6b6df88d17ded00998fc0"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDcwMDkyOnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMzoyMToxMVrOHTHY8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMzoyMToxMVrOHTHY8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwNjA2Ng==", "bodyText": "Please let us add // Call under test", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r489806066", "createdAt": "2020-09-16T23:21:11Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "diffHunk": "@@ -771,6 +770,31 @@ public void testGetIconURL() {\n \t\t\n \t\tassertEquals(expectedUrl, url);\n \t}\n+\n+\t@Test\n+\tpublic void testGetIconPreviewURL() {\n+\t\tString iconFileHandleId = \"101\";\n+\n+\t\tTeam team = createTeam(null, \"name\", \"description\", null, iconFileHandleId, null, null, null, null);\n+\t\twhen(mockTeamDAO.get(TEAM_ID)).thenReturn(team);\n+\n+\t\tString iconPreviewFileHandleId = \"102\";\n+\n+\t\twhen(mockFileHandleManager.getPreviewFileHandleId(iconFileHandleId)).thenReturn(iconPreviewFileHandleId);\n+\n+\t\tFileHandleUrlRequest urlRequest = new FileHandleUrlRequest(userInfo, iconPreviewFileHandleId)\n+\t\t\t\t.withAssociation(FileHandleAssociateType.TeamAttachment, TEAM_ID);\n+\n+\t\tString expectedUrl = \"https://testurl.org\";\n+\n+\t\twhen(mockFileHandleManager.getRedirectURLForFileHandle(eq(urlRequest))).thenReturn(expectedUrl);\n+\n+\t\tString url = teamManagerImpl.getIconPreviewURL(userInfo, TEAM_ID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6d585851a84bc731ee6b6df88d17ded00998fc0"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDcwMjM5OnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMzoyMTo0N1rOHTHZxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMzoyMTo0N1rOHTHZxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwNjI3OQ==", "bodyText": "the eq(urlRequest) is not needed, should be enough to use the urlRequest directly.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r489806279", "createdAt": "2020-09-16T23:21:47Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "diffHunk": "@@ -771,6 +770,31 @@ public void testGetIconURL() {\n \t\t\n \t\tassertEquals(expectedUrl, url);\n \t}\n+\n+\t@Test\n+\tpublic void testGetIconPreviewURL() {\n+\t\tString iconFileHandleId = \"101\";\n+\n+\t\tTeam team = createTeam(null, \"name\", \"description\", null, iconFileHandleId, null, null, null, null);\n+\t\twhen(mockTeamDAO.get(TEAM_ID)).thenReturn(team);\n+\n+\t\tString iconPreviewFileHandleId = \"102\";\n+\n+\t\twhen(mockFileHandleManager.getPreviewFileHandleId(iconFileHandleId)).thenReturn(iconPreviewFileHandleId);\n+\n+\t\tFileHandleUrlRequest urlRequest = new FileHandleUrlRequest(userInfo, iconPreviewFileHandleId)\n+\t\t\t\t.withAssociation(FileHandleAssociateType.TeamAttachment, TEAM_ID);\n+\n+\t\tString expectedUrl = \"https://testurl.org\";\n+\n+\t\twhen(mockFileHandleManager.getRedirectURLForFileHandle(eq(urlRequest))).thenReturn(expectedUrl);\n+\n+\t\tString url = teamManagerImpl.getIconPreviewURL(userInfo, TEAM_ID);\n+\n+\t\tverify(mockFileHandleManager).getRedirectURLForFileHandle(eq(urlRequest));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6d585851a84bc731ee6b6df88d17ded00998fc0"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDcwNDg2OnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMzoyMjo1MlrOHTHbLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMzoyMjo1MlrOHTHbLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwNjYzOQ==", "bodyText": "Let us add the tests for the various cases (e.g. if the id of the icon is not set assert that an exception is thrown, input validation etc).", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r489806639", "createdAt": "2020-09-16T23:22:52Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "diffHunk": "@@ -771,6 +770,31 @@ public void testGetIconURL() {\n \t\t\n \t\tassertEquals(expectedUrl, url);\n \t}\n+\n+\t@Test\n+\tpublic void testGetIconPreviewURL() {\n+\t\tString iconFileHandleId = \"101\";\n+\n+\t\tTeam team = createTeam(null, \"name\", \"description\", null, iconFileHandleId, null, null, null, null);\n+\t\twhen(mockTeamDAO.get(TEAM_ID)).thenReturn(team);\n+\n+\t\tString iconPreviewFileHandleId = \"102\";\n+\n+\t\twhen(mockFileHandleManager.getPreviewFileHandleId(iconFileHandleId)).thenReturn(iconPreviewFileHandleId);\n+\n+\t\tFileHandleUrlRequest urlRequest = new FileHandleUrlRequest(userInfo, iconPreviewFileHandleId)\n+\t\t\t\t.withAssociation(FileHandleAssociateType.TeamAttachment, TEAM_ID);\n+\n+\t\tString expectedUrl = \"https://testurl.org\";\n+\n+\t\twhen(mockFileHandleManager.getRedirectURLForFileHandle(eq(urlRequest))).thenReturn(expectedUrl);\n+\n+\t\tString url = teamManagerImpl.getIconPreviewURL(userInfo, TEAM_ID);\n+\n+\t\tverify(mockFileHandleManager).getRedirectURLForFileHandle(eq(urlRequest));\n+\n+\t\tassertEquals(expectedUrl, url);\n+\t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6d585851a84bc731ee6b6df88d17ded00998fc0"}, "originalPosition": 92}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NDcwODU3OnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMzoyNDo0NlrOHTHdUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMzoyNDo0NlrOHTHdUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTgwNzE4Ng==", "bodyText": "We can use any() instead of eq(urlRequest) as we are verifying below that the argument is correct.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r489807186", "createdAt": "2020-09-16T23:24:46Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "diffHunk": "@@ -771,6 +770,31 @@ public void testGetIconURL() {\n \t\t\n \t\tassertEquals(expectedUrl, url);\n \t}\n+\n+\t@Test\n+\tpublic void testGetIconPreviewURL() {\n+\t\tString iconFileHandleId = \"101\";\n+\n+\t\tTeam team = createTeam(null, \"name\", \"description\", null, iconFileHandleId, null, null, null, null);\n+\t\twhen(mockTeamDAO.get(TEAM_ID)).thenReturn(team);\n+\n+\t\tString iconPreviewFileHandleId = \"102\";\n+\n+\t\twhen(mockFileHandleManager.getPreviewFileHandleId(iconFileHandleId)).thenReturn(iconPreviewFileHandleId);\n+\n+\t\tFileHandleUrlRequest urlRequest = new FileHandleUrlRequest(userInfo, iconPreviewFileHandleId)\n+\t\t\t\t.withAssociation(FileHandleAssociateType.TeamAttachment, TEAM_ID);\n+\n+\t\tString expectedUrl = \"https://testurl.org\";\n+\n+\t\twhen(mockFileHandleManager.getRedirectURLForFileHandle(eq(urlRequest))).thenReturn(expectedUrl);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6d585851a84bc731ee6b6df88d17ded00998fc0"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2OTcyMTg0OnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjo0NToxNlrOHT4B-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjo0NToxNlrOHT4B-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwMzAwMg==", "bodyText": "If this is public for testing purposes, we can simply use the default visibility (e.g. without modifier).", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r490603002", "createdAt": "2020-09-17T22:45:16Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -729,6 +724,16 @@ public String getIconPreviewURL(UserInfo userInfo, String teamId) throws NotFoun\n \t\treturn fileHandleManager.getRedirectURLForFileHandle(urlRequest);\n \t}\n \n+\tpublic String getFileHandleId(String teamId) throws NotFoundException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6b2be6d780bfbbdf90024f8b4b355c628ae7f7"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2OTczNDU3OnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjo1MToxNlrOHT4JdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjo1MToxNlrOHT4JdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNDkxNw==", "bodyText": "We can set this to null?", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r490604917", "createdAt": "2020-09-17T22:51:16Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -709,18 +706,16 @@ public String getIconURL(UserInfo userInfo, String teamId) throws NotFoundExcept\n \n \t@Override\n \tpublic String getIconPreviewURL(UserInfo userInfo, String teamId) throws NotFoundException {\n-\t\tTeam team = teamDAO.get(teamId);\n-\n-\t\tString fileHandleId = team.getIcon();\n-\n-\t\tif (fileHandleId == null) {\n-\t\t\tthrow new NotFoundException(\"Team \" + teamId + \" has no icon file handle.\");\n-\t\t}\n-\n-\t\tString fileHandlePreviewId = fileHandleManager.getPreviewFileHandleId(fileHandleId);\n+\t\tValidateArgument.required(userInfo, \"userInfo\");\n+\t\tValidateArgument.required(teamId, \"teamId\");\n \n-\t\tif (fileHandlePreviewId == null) {\n-\t\t\tthrow new NotFoundException(\"Team \" + teamId + \" has no icon preview file handle.\");\n+\t\tString fileHandleId = getFileHandleId(teamId);\n+\t\tString fileHandlePreviewId = \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6b2be6d780bfbbdf90024f8b4b355c628ae7f7"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2OTczODYxOnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjo1MzoxM1rOHT4L_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjo1MzoxM1rOHT4L_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNTU2Nw==", "bodyText": "We can simplify this message to be such as \"No preview was found for the icon of the team with id: 123\"", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r490605567", "createdAt": "2020-09-17T22:53:13Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/team/TeamManagerImpl.java", "diffHunk": "@@ -709,18 +706,16 @@ public String getIconURL(UserInfo userInfo, String teamId) throws NotFoundExcept\n \n \t@Override\n \tpublic String getIconPreviewURL(UserInfo userInfo, String teamId) throws NotFoundException {\n-\t\tTeam team = teamDAO.get(teamId);\n-\n-\t\tString fileHandleId = team.getIcon();\n-\n-\t\tif (fileHandleId == null) {\n-\t\t\tthrow new NotFoundException(\"Team \" + teamId + \" has no icon file handle.\");\n-\t\t}\n-\n-\t\tString fileHandlePreviewId = fileHandleManager.getPreviewFileHandleId(fileHandleId);\n+\t\tValidateArgument.required(userInfo, \"userInfo\");\n+\t\tValidateArgument.required(teamId, \"teamId\");\n \n-\t\tif (fileHandlePreviewId == null) {\n-\t\t\tthrow new NotFoundException(\"Team \" + teamId + \" has no icon preview file handle.\");\n+\t\tString fileHandleId = getFileHandleId(teamId);\n+\t\tString fileHandlePreviewId = \"\";\n+\t\ttry {\n+\t\t\tfileHandlePreviewId = fileHandleManager.getPreviewFileHandleId(fileHandleId);\n+\t\t} catch(NotFoundException e) {\n+\t\t\tthrow new NotFoundException(e.getMessage() + \" icon file handle or icon preview file handle not found\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6b2be6d780bfbbdf90024f8b4b355c628ae7f7"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2OTc0NDMzOnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjo1NTo0OFrOHT4PZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjo1NTo0OFrOHT4PZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNjQzOQ==", "bodyText": "testGetIconURLUserInfo -> testGetIconURLWithNullUserInfo", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r490606439", "createdAt": "2020-09-17T22:55:48Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "diffHunk": "@@ -771,6 +772,22 @@ public void testGetIconURL() {\n \t\tassertEquals(expectedUrl, url);\n \t}\n \n+\t@Test\n+\tpublic void testGetIconURLUserInfo() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6b2be6d780bfbbdf90024f8b4b355c628ae7f7"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2OTc0NTY1OnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjo1NjoyOVrOHT4QIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjo1NjoyOVrOHT4QIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNjYyNw==", "bodyText": "testGetIconURLTeamId -> testGetIconURLWithNullTeamId", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r490606627", "createdAt": "2020-09-17T22:56:29Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "diffHunk": "@@ -771,6 +772,22 @@ public void testGetIconURL() {\n \t\tassertEquals(expectedUrl, url);\n \t}\n \n+\t@Test\n+\tpublic void testGetIconURLUserInfo() {\n+\t\tException exception = assertThrows(IllegalArgumentException.class, () -> {\n+\t\t\tteamManagerImpl.getIconURL(null, TEAM_ID);\n+\t\t});\n+\t\tassertEquals(\"userInfo is required.\", exception.getMessage());\n+\t}\n+\n+\t@Test\n+\tpublic void testGetIconURLTeamId() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6b2be6d780bfbbdf90024f8b4b355c628ae7f7"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2OTc0ODUwOnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjo1Nzo1NFrOHT4R4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjo1Nzo1NFrOHT4R4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNzA3Mw==", "bodyText": "See previous comment.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r490607073", "createdAt": "2020-09-17T22:57:54Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "diffHunk": "@@ -787,14 +804,52 @@ public void testGetIconPreviewURL() {\n \n \t\tString expectedUrl = \"https://testurl.org\";\n \n-\t\twhen(mockFileHandleManager.getRedirectURLForFileHandle(eq(urlRequest))).thenReturn(expectedUrl);\n+\t\twhen(mockFileHandleManager.getRedirectURLForFileHandle(any())).thenReturn(expectedUrl);\n \n+\t\t// Call under test\n \t\tString url = teamManagerImpl.getIconPreviewURL(userInfo, TEAM_ID);\n \n-\t\tverify(mockFileHandleManager).getRedirectURLForFileHandle(eq(urlRequest));\n+\t\tverify(mockFileHandleManager).getRedirectURLForFileHandle(urlRequest);\n \n \t\tassertEquals(expectedUrl, url);\n \t}\n+\n+\t@Test\n+\tpublic void testGetIconPreviewURLUserInfo() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6b2be6d780bfbbdf90024f8b4b355c628ae7f7"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2OTc0ODY5OnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjo1ODowMlrOHT4SAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjo1ODowMlrOHT4SAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNzEwNA==", "bodyText": "See previous comment.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r490607104", "createdAt": "2020-09-17T22:58:02Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "diffHunk": "@@ -787,14 +804,52 @@ public void testGetIconPreviewURL() {\n \n \t\tString expectedUrl = \"https://testurl.org\";\n \n-\t\twhen(mockFileHandleManager.getRedirectURLForFileHandle(eq(urlRequest))).thenReturn(expectedUrl);\n+\t\twhen(mockFileHandleManager.getRedirectURLForFileHandle(any())).thenReturn(expectedUrl);\n \n+\t\t// Call under test\n \t\tString url = teamManagerImpl.getIconPreviewURL(userInfo, TEAM_ID);\n \n-\t\tverify(mockFileHandleManager).getRedirectURLForFileHandle(eq(urlRequest));\n+\t\tverify(mockFileHandleManager).getRedirectURLForFileHandle(urlRequest);\n \n \t\tassertEquals(expectedUrl, url);\n \t}\n+\n+\t@Test\n+\tpublic void testGetIconPreviewURLUserInfo() {\n+        Exception exception = assertThrows(IllegalArgumentException.class, () -> {\n+\t\t\tteamManagerImpl.getIconPreviewURL(null, TEAM_ID);\n+\t\t});\n+        assertEquals(\"userInfo is required.\", exception.getMessage());\n+\t}\n+\n+\t@Test\n+\tpublic void testGetIconPreviewURLTeamId() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6b2be6d780bfbbdf90024f8b4b355c628ae7f7"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2OTc1MzcyOnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMzowMDoyMlrOHT4VDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMzowMDoyMlrOHT4VDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNzg4NA==", "bodyText": "You can use the variable above :)", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r490607884", "createdAt": "2020-09-17T23:00:22Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "diffHunk": "@@ -771,6 +771,85 @@ public void testGetIconURL() {\n \t\t\n \t\tassertEquals(expectedUrl, url);\n \t}\n+\n+\t@Test\n+\tpublic void testGetIconURLUserInfo() {\n+\t\tException exception = assertThrows(IllegalArgumentException.class, () -> {\n+\t\t\tteamManagerImpl.getIconURL(null, TEAM_ID);\n+\t\t});\n+\t\tassertEquals(\"userInfo is required.\", exception.getMessage());\n+\t}\n+\n+\t@Test\n+\tpublic void testGetIconURLTeamId() {\n+\t\tException exception = assertThrows(IllegalArgumentException.class, () -> {\n+\t\t\tteamManagerImpl.getIconURL(userInfo, null);\n+\t\t});\n+\t\tassertEquals(\"teamId is required.\", exception.getMessage());\n+\t}\n+\n+\t@Test\n+\tpublic void testGetIconPreviewURL() {\n+\t\tString iconFileHandleId = \"101\";\n+\n+\t\tTeam team = createTeam(null, \"name\", \"description\", null, iconFileHandleId, null, null, null, null);\n+\t\twhen(mockTeamDAO.get(TEAM_ID)).thenReturn(team);\n+\n+\t\tString iconPreviewFileHandleId = \"102\";\n+\n+\t\twhen(mockFileHandleManager.getPreviewFileHandleId(iconFileHandleId)).thenReturn(iconPreviewFileHandleId);\n+\n+\t\tFileHandleUrlRequest urlRequest = new FileHandleUrlRequest(userInfo, iconPreviewFileHandleId)\n+\t\t\t\t.withAssociation(FileHandleAssociateType.TeamAttachment, TEAM_ID);\n+\n+\t\tString expectedUrl = \"https://testurl.org\";\n+\n+\t\twhen(mockFileHandleManager.getRedirectURLForFileHandle(any())).thenReturn(expectedUrl);\n+\n+\t\t// Call under test\n+\t\tString url = teamManagerImpl.getIconPreviewURL(userInfo, TEAM_ID);\n+\n+\t\tverify(mockFileHandleManager).getRedirectURLForFileHandle(urlRequest);\n+\n+\t\tassertEquals(expectedUrl, url);\n+\t}\n+\n+\t@Test\n+\tpublic void testGetIconPreviewURLUserInfo() {\n+        Exception exception = assertThrows(IllegalArgumentException.class, () -> {\n+\t\t\tteamManagerImpl.getIconPreviewURL(null, TEAM_ID);\n+\t\t});\n+        assertEquals(\"userInfo is required.\", exception.getMessage());\n+\t}\n+\n+\t@Test\n+\tpublic void testGetIconPreviewURLTeamId() {\n+\t\tException exception = assertThrows(IllegalArgumentException.class, () -> {\n+\t\t\tteamManagerImpl.getIconPreviewURL(userInfo, null);\n+\t\t});\n+\t\tassertEquals(\"teamId is required.\", exception.getMessage());\n+\t}\n+\n+\t@Test\n+\tpublic void testGetFileHandleIdNotFoundException() {\n+\t\tTeam team = createTeam(TEAM_ID, \"name\", \"description\", null, null, null, null, null, null);\n+\t\twhen(mockTeamDAO.get(TEAM_ID)).thenReturn(team);\n+\t\tException exception = assertThrows(NotFoundException.class, () -> {\n+\t\t\t// Call under test\n+\t\t\tteamManagerImpl.getFileHandleId(TEAM_ID);\n+\t\t});\n+\t\tassertEquals(\"Team \" + TEAM_ID + \" has no icon file handle.\", exception.getMessage());\n+\t}\n+\n+\t@Test\n+\tpublic void testGetFileHandleId() {\n+\t\tString iconFileHandleId = \"101\";\n+\t\tTeam team = createTeam(TEAM_ID, \"name\", \"description\", null, \"101\", null, null, null, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6b2be6d780bfbbdf90024f8b4b355c628ae7f7"}, "originalPosition": 142}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MzYzNTUzOnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMTo0MjoyN1rOHUcrIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMTo0MjoyN1rOHUcrIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIwMzM2MA==", "bodyText": "Note that this is not necessary as the previous assertEquals will implicitly perform this check.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4200#discussion_r491203360", "createdAt": "2020-09-18T21:42:27Z", "author": {"login": "marcomarasca"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/team/TeamManagerImplTest.java", "diffHunk": "@@ -773,21 +773,40 @@ public void testGetIconURL() {\n \t}\n \n \t@Test\n-\tpublic void testGetIconURLUserInfo() {\n+\tpublic void testGetIconURLWithNullUserInfo() {\n \t\tException exception = assertThrows(IllegalArgumentException.class, () -> {\n \t\t\tteamManagerImpl.getIconURL(null, TEAM_ID);\n \t\t});\n \t\tassertEquals(\"userInfo is required.\", exception.getMessage());\n \t}\n \n \t@Test\n-\tpublic void testGetIconURLTeamId() {\n+\tpublic void testGetIconURLWithNullTeamId() {\n \t\tException exception = assertThrows(IllegalArgumentException.class, () -> {\n \t\t\tteamManagerImpl.getIconURL(userInfo, null);\n \t\t});\n \t\tassertEquals(\"teamId is required.\", exception.getMessage());\n \t}\n \n+\t@Test\n+\tpublic void testGetIconPreviewURLPreviewFileHandleIdNotFoundException() {\n+\n+\t\tNotFoundException cause = new NotFoundException(\"inner exception\");\n+\t\tString iconFileHandleId = \"\";\n+\t\tTeam team = createTeam(TEAM_ID, \"name\", \"description\", null, iconFileHandleId, null, null, null, null);\n+        when(mockTeamDAO.get(TEAM_ID)).thenReturn(team);\n+\t\twhen(mockFileHandleManager.getPreviewFileHandleId(iconFileHandleId)).thenThrow(cause);\n+\n+\t\tNotFoundException exception = assertThrows(NotFoundException.class, () -> {\n+\t\t\t// Call under test\n+\t\t\tteamManagerImpl.getIconPreviewURL(userInfo, TEAM_ID);\n+\t\t});\n+\n+\t\tassertEquals(\"No preview was found for the icon of the team with id: \" + TEAM_ID, exception.getMessage());\n+\t\tassertEquals(cause, exception.getCause());\n+\t\tassertEquals(cause.getMessage(), exception.getCause().getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89287a348034c122a13dcd8f7145a96c83587e97"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2991, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}