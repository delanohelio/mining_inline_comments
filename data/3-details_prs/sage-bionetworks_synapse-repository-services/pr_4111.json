{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwMzEwMjU3", "number": 4111, "title": "PLFM-6306: Fix for race condition on replication", "bodyText": "", "createdAt": "2020-06-25T23:44:08Z", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4111", "merged": true, "mergeCommit": {"oid": "ae2f08ceb28c4c79dbaa956d03b93b387e0d3c04"}, "closed": true, "closedAt": "2020-06-26T23:22:49Z", "author": {"login": "marcomarasca"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcu3dBygH2gAyNDQwMzEwMjU3OmI1MGVjZjVlZjE1ZWVlZjY2OWJjNDM0YzE1ZjU2MmNjNTBmYTE2Njc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvLwomAFqTQzODY0Mjc5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b50ecf5ef15eeef669bc434c15f562cc50fa1667", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/b50ecf5ef15eeef669bc434c15f562cc50fa1667", "committedDate": "2020-06-25T23:43:05Z", "message": "PLFM-6306: Fix for race condition on replication"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a6899068cf8f541e72910750d4a0d2fdd683a67", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/8a6899068cf8f541e72910750d4a0d2fdd683a67", "committedDate": "2020-06-25T23:43:05Z", "message": "PLFM-6306: Dedup data before replication"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0361164fd9f4cbdaa1de3921fd38fcd4f03c18cc", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/0361164fd9f4cbdaa1de3921fd38fcd4f03c18cc", "committedDate": "2020-06-25T23:43:05Z", "message": "Note about alias reference with ON DUPLICATE KEY UPDATE"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NjQxODg1", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4111#pullrequestreview-438641885", "createdAt": "2020-06-26T23:18:33Z", "commit": {"oid": "0361164fd9f4cbdaa1de3921fd38fcd4f03c18cc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQyMzoxODozM1rOGpxElA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQyMzoxODozM1rOGpxElA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0ODc4OA==", "bodyText": "test with batch of objects with different ids.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4111#discussion_r446448788", "createdAt": "2020-06-26T23:18:33Z", "author": {"login": "john-hill"}, "path": "lib/lib-table-cluster/src/test/java/org/sagebionetworks/table/cluster/TableIndexDAOImplTest.java", "diffHunk": "@@ -1347,6 +1347,57 @@ public void testEntityReplication(){\n \t\tfetched = tableIndexDAO.getObjectData(objectType, 3L);\r\n \t\tassertEquals(file, fetched);\r\n \t}\r\n+\t\r\n+\t/**\r\n+\t * Test for PLFM-6306: The index failed to replicate because the insert was not handling duplicates. When replicating\r\n+\t * we first delete and then insert but with concurrent inserts and with no data it could lead to a race condition where\r\n+\t * a second thread that wasn't blocked by the first delete (since nothing needed to be deleted) tries to insert the same \r\n+\t * record. The solution is to allow updating on duplicate.\r\n+\t */\r\n+\t@Test\r\n+\tpublic void testEntityReplicationWithUpdate(){\r\n+\t\t\r\n+\t\tObjectDataDTO objectData = createObjectDataDTO(2L, EntityType.file, 2);\r\n+\t\t\r\n+\t\t// Add the data to the index once\r\n+\t\ttableIndexDAO.addObjectData(objectType, Collections.singletonList(objectData));\r\n+\t\t\r\n+\t\tObjectDataDTO result = tableIndexDAO.getObjectData(ViewObjectType.ENTITY, objectData.getId());\r\n+\t\r\n+\t\tassertEquals(objectData, result);\r\n+\t\t\r\n+\t\t// Update the data\r\n+\t\tobjectData.setEtag(objectData.getEtag() + \"_updated\");\r\n+\t\tobjectData.getAnnotations().get(0).setValue(\"updated_annotation\");\r\n+\t\t\r\n+\t\t// Re-adding to the index should simply update the object without throwing\r\n+\t\ttableIndexDAO.addObjectData(objectType, Collections.singletonList(objectData));\r\n+\t\t\r\n+\t\t// Makes sure the data was updated\r\n+\t\tresult = tableIndexDAO.getObjectData(ViewObjectType.ENTITY, objectData.getId());\r\n+\t\t\r\n+\t\tassertEquals(objectData, result);\r\n+\t}\r\n+\t\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0361164fd9f4cbdaa1de3921fd38fcd4f03c18cc"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NjQyNzk4", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4111#pullrequestreview-438642798", "createdAt": "2020-06-26T23:22:36Z", "commit": {"oid": "0361164fd9f4cbdaa1de3921fd38fcd4f03c18cc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4780, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}