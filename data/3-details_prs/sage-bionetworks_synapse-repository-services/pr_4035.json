{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0Nzc2NDMw", "number": 4035, "title": "Plfm 6158", "bodyText": "", "createdAt": "2020-05-07T15:57:12Z", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4035", "merged": true, "mergeCommit": {"oid": "5980807f239b83f0864a53ea0b7e06426ca406ec"}, "closed": true, "closedAt": "2020-05-07T18:31:11Z", "author": {"login": "marcomarasca"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABce1N_yAH2gAyNDE0Nzc2NDMwOjgyYWFiNWM5NWQ5OTUwOWJhYTRjMjI2YzY2NzdmZmU2ODkxZmZjOWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfBnzfgFqTQwNzczMTM4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "82aab5c95d99509baa4c226c6677ffe6891ffc9d", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/82aab5c95d99509baa4c226c6677ffe6891ffc9d", "committedDate": "2020-05-07T04:04:04Z", "message": "PLFM-6158: Move providers at the manager level"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b84b127afce50ba8646b4f234bd2273448df422", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/2b84b127afce50ba8646b4f234bd2273448df422", "committedDate": "2020-05-07T04:53:07Z", "message": "PLFM-6158: Store view subtype as varchar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25b4c8a3156f1050cfbcf2e3d3dbf614355568d8", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/25b4c8a3156f1050cfbcf2e3d3dbf614355568d8", "committedDate": "2020-05-07T05:38:02Z", "message": "PLFM-6158: Remove complexity in scope filter -> SQL"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bdb28d9909850f1b130d1d0d258f62f572ab520", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/9bdb28d9909850f1b130d1d0d258f62f572ab520", "committedDate": "2020-05-07T05:47:42Z", "message": "Move test to junit5"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3Njc3Nzg5", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4035#pullrequestreview-407677789", "createdAt": "2020-05-07T17:18:24Z", "commit": {"oid": "9bdb28d9909850f1b130d1d0d258f62f572ab520"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNzoxODoyNVrOGSIcvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNzoxODoyNVrOGSIcvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY2NTk4Mw==", "bodyText": "rename", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4035#discussion_r421665983", "createdAt": "2020-05-07T17:18:25Z", "author": {"login": "john-hill"}, "path": "lib/lib-table-cluster/src/test/java/org/sagebionetworks/table/cluster/SQLUtilsTest.java", "diffHunk": "@@ -3020,7 +3023,66 @@ public void testGetDeleteRowsFromViewSql() {\n \t\tassertEquals(\"DELETE FROM T999 WHERE ROW_ID = ?\", sql);\r\n \t}\r\n \t\r\n-\tprivate SQLScopeFilter getSQLScopeFilter(Long typeMask) {\r\n-\t\treturn new SQLScopeFilterBuilder(scopeFilterProvider, typeMask).build();\r\n+\t@Test\r\n+\tpublic void testGetViewScopeSubTypeFilterWithSingleType(){\r\n+\t\tList<Enum<?>> subTypes = ImmutableList.of(EntityType.file);\r\n+\t\tboolean filterByObjectId = false;\r\n+\t\t\r\n+\t\tViewScopeFilter scopeFilter = getSQLScopeFilter(subTypes, filterByObjectId);\r\n+\t\t\r\n+\t\tString result = SQLUtils.getViewScopeSubTypeFilter(scopeFilter);\r\n+\t\tassertEquals(\"R.SUBTYPE IN ('file')\", result);\r\n+\t}\r\n+\r\n+\t@Test\r\n+\tpublic void testGetViewScopeSubTypeFilterWithMultipleTypes(){\r\n+\t\tList<Enum<?>> subTypes = ImmutableList.of(EntityType.file, EntityType.table);\r\n+\t\tboolean filterByObjectId = false;\r\n+\t\t\r\n+\t\tViewScopeFilter scopeFilter = getSQLScopeFilter(subTypes, filterByObjectId);\r\n+\t\t\r\n+\t\tString result = SQLUtils.getViewScopeSubTypeFilter(scopeFilter);\r\n+\t\tassertEquals(\"R.SUBTYPE IN ('file','table')\", result);\r\n+\t}\r\n+\r\n+\t@Test\r\n+\tpublic void testGetViewScopeSubTypeFilterWithAllEntityTypes(){\r\n+\t\tList<Enum<?>> subTypes = Arrays.asList(EntityType.values());\r\n+\t\tboolean filterByObjectId = false;\r\n+\t\t\r\n+\t\tViewScopeFilter scopeFilter = getSQLScopeFilter(subTypes, filterByObjectId);\r\n+\t\t\r\n+\t\tString result = SQLUtils.getViewScopeSubTypeFilter(scopeFilter);\r\n+\t\tassertEquals(\"R.SUBTYPE IN ('project','folder','file','table','link','entityview','dockerrepo')\", result);\r\n+\t}\r\n+\t\r\n+\t@Test\r\n+\tpublic void testGetViewScopeFilterColumn() {\r\n+\t\tList<Enum<?>> subTypes = ImmutableList.of(EntityType.file);\r\n+\t\t\r\n+\t\tboolean filterByObjectId = false;\r\n+\t\t\r\n+\t\tViewScopeFilter scopeFilter = getSQLScopeFilter(subTypes, filterByObjectId);\r\n+\t\t\r\n+\t\tString result = SQLUtils.getViewScopeFilterColumn(scopeFilter);\r\n+\t\t\r\n+\t\tassertEquals(TableConstants.OBJECT_REPLICATION_COL_PARENT_ID, result);\r\n+\t}\r\n+\t\r\n+\t@Test\r\n+\tpublic void testGetViewScopeFilterColumnWithFilterByObjectId() {\r\n+\t\tList<Enum<?>> subTypes = ImmutableList.of(EntityType.file);\r\n+\t\t\r\n+\t\tboolean filterByObjectId = true;\r\n+\t\t\r\n+\t\tViewScopeFilter scopeFilter = getSQLScopeFilter(subTypes, filterByObjectId);\r\n+\t\t\r\n+\t\tString result = SQLUtils.getViewScopeFilterColumn(scopeFilter);\r\n+\t\t\r\n+\t\tassertEquals(TableConstants.OBJECT_REPLICATION_COL_OBJECT_ID, result);\r\n+\t}\r\n+\t\r\n+\tprivate ViewScopeFilter getSQLScopeFilter(List<Enum<?>> subTypes, boolean filterByObjectId) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bdb28d9909850f1b130d1d0d258f62f572ab520"}, "originalPosition": 351}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NzA3MTMz", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4035#pullrequestreview-407707133", "createdAt": "2020-05-07T17:57:45Z", "commit": {"oid": "9bdb28d9909850f1b130d1d0d258f62f572ab520"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNzo1Nzo0NVrOGSJ40g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNzo1Nzo0NVrOGSJ40g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY4OTU1NA==", "bodyText": "remove it not needed", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4035#discussion_r421689554", "createdAt": "2020-05-07T17:57:45Z", "author": {"login": "john-hill"}, "path": "lib/lib-table-cluster/src/main/java/org/sagebionetworks/table/cluster/metadata/ObjectFieldTypeMapper.java", "diffHunk": "@@ -10,6 +11,11 @@\n  * @author Marco Marasca\r\n  */\r\n public interface ObjectFieldTypeMapper {\r\n+\t\r\n+\t/**\r\n+\t * @return The object type this mapper applies to\r\n+\t */\r\n+\tObjectType getObjectType();\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bdb28d9909850f1b130d1d0d258f62f572ab520"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NzE1Mzk0", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4035#pullrequestreview-407715394", "createdAt": "2020-05-07T18:08:54Z", "commit": {"oid": "9bdb28d9909850f1b130d1d0d258f62f572ab520"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxODowODo1NVrOGSKTQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxODowODo1NVrOGSKTQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY5NjMyMg==", "bodyText": "Consider a List here since at this level it does not matter that they were enums.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4035#discussion_r421696322", "createdAt": "2020-05-07T18:08:55Z", "author": {"login": "john-hill"}, "path": "lib/models/src/main/java/org/sagebionetworks/repo/model/table/ViewScopeFilter.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package org.sagebionetworks.repo.model.table;\r\n+\r\n+import java.util.List;\r\n+import java.util.Objects;\r\n+import java.util.Set;\r\n+\r\n+import org.sagebionetworks.repo.model.ObjectType;\r\n+\r\n+/**\r\n+ * DTO that specifies the scope filter to apply when working with a view\r\n+ * \r\n+ * @author Marco Marasca\r\n+ */\r\n+public class ViewScopeFilter {\r\n+\r\n+\tprivate final ObjectType objectType;\r\n+\tprivate final List<Enum<?>> subTypes;\r\n+\tprivate final boolean filterByObjectId;\r\n+\tprivate final Set<Long> containerIds;\r\n+\r\n+\tpublic ViewScopeFilter(ObjectType objectType, List<Enum<?>> subTypes, boolean filterByObjectId, Set<Long> containerIds) {\r\n+\t\tthis.objectType = objectType;\r\n+\t\tthis.subTypes = subTypes;\r\n+\t\tthis.filterByObjectId = filterByObjectId;\r\n+\t\tthis.containerIds = containerIds;\r\n+\t}\r\n+\t\r\n+\tpublic ObjectType getObjectType() {\r\n+\t\treturn objectType;\r\n+\t}\r\n+\r\n+\tpublic List<Enum<?>> getSubTypes() {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bdb28d9909850f1b130d1d0d258f62f572ab520"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NzMxMzgy", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4035#pullrequestreview-407731382", "createdAt": "2020-05-07T18:31:07Z", "commit": {"oid": "9bdb28d9909850f1b130d1d0d258f62f572ab520"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4697, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}