{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MDE3NTA0", "number": 3968, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMzo1MDozM1rODl-X8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMjoxNjoxMFrODl_QAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTQ1ODQxOnYy", "diffSide": "RIGHT", "path": "lib/id-generator/pom.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMzo1MDozM1rOFzKs3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDowMTo0MFrOFzK16w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NzAyMw==", "bodyText": "we can remove the properties block", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3968#discussion_r389197023", "createdAt": "2020-03-06T23:50:33Z", "author": {"login": "marcomarasca"}, "path": "lib/id-generator/pom.xml", "diffHunk": "@@ -98,7 +98,7 @@\n \t</dependencies>\n \n \t<properties>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e32b5a920b3ab2e53875b4359be5ae4997ff6207"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5OTMzOQ==", "bodyText": "Double check for unused dependencies (since we removed the transactional context)", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3968#discussion_r389199339", "createdAt": "2020-03-07T00:01:40Z", "author": {"login": "marcomarasca"}, "path": "lib/id-generator/pom.xml", "diffHunk": "@@ -98,7 +98,7 @@\n \t</dependencies>\n \n \t<properties>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5NzAyMw=="}, "originalCommit": {"oid": "e32b5a920b3ab2e53875b4359be5ae4997ff6207"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTQ2NzA3OnYy", "diffSide": "RIGHT", "path": "lib/id-generator/src/main/java/org/sagebionetworks/ids/IdGeneratorImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMzo1NzowMlrOFzKyHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMzo1NzowMlrOFzKyHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE5ODM2Ng==", "bodyText": "We could check for a specific error code", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3968#discussion_r389198366", "createdAt": "2020-03-06T23:57:02Z", "author": {"login": "marcomarasca"}, "path": "lib/id-generator/src/main/java/org/sagebionetworks/ids/IdGeneratorImpl.java", "diffHunk": "@@ -139,40 +119,34 @@ public void afterPropertiesSet() throws Exception {\n \t\t\t}\n \t\t}\n \t}\n-\n-\t@NewWriteTransaction\n-\t@Override\n-\tpublic BatchOfIds generateBatchNewIds(IdType type, int count) {\n-\t\tif(type == null){\n-\t\t\tthrow new IllegalArgumentException(\"Type cannot be null\");\n-\t\t}\n-\t\tif(count < 1){\n-\t\t\tthrow new IllegalArgumentException(\"Count must be greater than or equal to 1.\");\n-\t\t}\n-\t\t// Get the first ID and acquire the lock on this type.\n-\t\tLong firstId = generateNewId(type);\n-\t\tLong lastId = firstId+(count-1);\n-\t\tif(count > 1){\n-\t\t\tlong now = System.currentTimeMillis();\n-\t\t\tidGeneratorJdbcTemplate.update(String.format(INSERT_SQL_INCREMENT, type.name()), lastId, now);\n+\t\n+\tpublic void createStoredProcedure(String name) {\n+\t\tString ddl = loadDDLString(name);\n+\t\ttry {\n+\t\t\tidGeneratorJdbcTemplate.execute(ddl);\n+\t\t} catch (DataAccessException e) {\n+\t\t\tif(!e.getMessage().contains(\"already exists\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e32b5a920b3ab2e53875b4359be5ae4997ff6207"}, "originalPosition": 142}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTUyMTg0OnYy", "diffSide": "RIGHT", "path": "lib/id-generator/src/main/resources/generateNewId.ddl.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDo0MTo1NVrOFzLTJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMDo0MTo1NVrOFzLTJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIwNjgyMA==", "bodyText": "We might not need a transaction nor the lock table", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3968#discussion_r389206820", "createdAt": "2020-03-07T00:41:55Z", "author": {"login": "marcomarasca"}, "path": "lib/id-generator/src/main/resources/generateNewId.ddl.sql", "diffHunk": "@@ -0,0 +1,23 @@\n+CREATE PROCEDURE generateNewId(IN typeName VARCHAR(256))\n+    MODIFIES SQL DATA\n+    SQL SECURITY INVOKER\n+BEGIN\n+\tDECLARE newId BIGINT;\n+    DECLARE typeLock VARCHAR(256);\n+\t\n+\tSET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e32b5a920b3ab2e53875b4359be5ae4997ff6207"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTYwMTMyOnYy", "diffSide": "RIGHT", "path": "lib/id-generator/src/main/resources/generateNewId.ddl.sql", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMjoxNTozMFrOFzMAfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMjoxNTozMFrOFzMAfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxODQyOA==", "bodyText": "Can be removed", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3968#discussion_r389218428", "createdAt": "2020-03-07T02:15:30Z", "author": {"login": "marcomarasca"}, "path": "lib/id-generator/src/main/resources/generateNewId.ddl.sql", "diffHunk": "@@ -0,0 +1,25 @@\n+CREATE PROCEDURE generateNewId(IN typeName VARCHAR(256))\n+    MODIFIES SQL DATA\n+    SQL SECURITY INVOKER\n+BEGIN\n+\tDECLARE newId BIGINT;\n+    DECLARE typeLock VARCHAR(256);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b7492fb708e8cac66e07ec62bcc66edb479c55a"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTYwMTk1OnYy", "diffSide": "RIGHT", "path": "lib/id-generator/src/main/resources/reserveId.ddl.sql", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMjoxNjoxMFrOFzMAxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMjoxNjoxMFrOFzMAxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxODUwMg==", "bodyText": "Can be removed", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3968#discussion_r389218502", "createdAt": "2020-03-07T02:16:10Z", "author": {"login": "marcomarasca"}, "path": "lib/id-generator/src/main/resources/reserveId.ddl.sql", "diffHunk": "@@ -0,0 +1,16 @@\n+CREATE PROCEDURE reserveId(IN idToReserve BIGINT, IN typeName VARCHAR(256))\n+    MODIFIES SQL DATA\n+    SQL SECURITY INVOKER\n+BEGIN\n+    DECLARE typeLock VARCHAR(256);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b7492fb708e8cac66e07ec62bcc66edb479c55a"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3144, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}