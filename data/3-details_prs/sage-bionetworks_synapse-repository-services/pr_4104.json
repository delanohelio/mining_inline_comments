{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4MDUxMzk4", "number": 4104, "title": "PLFM-6286", "bodyText": "https://sagebionetworks.jira.com/browse/PLFM-6286?filter=-1\nAdd OAuthErrorResponse and multiple exceptions that map to it in order to return error responses that match the OAuth 2/OIDC specs", "createdAt": "2020-06-22T16:25:54Z", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4104", "merged": true, "mergeCommit": {"oid": "e12cd792b2d79cfff61c1faa69d25e651b150d74"}, "closed": true, "closedAt": "2020-06-24T13:19:20Z", "author": {"login": "nickgros"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABct0AJhAH2gAyNDM4MDUxMzk4OmRmMDNkMzI5NzY3YjRmMTdjNzYzN2E5NzFmYzhhMTYyNDI1ODE2ZDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuZ7gGgFqTQzNjYzNzIwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "df03d329767b4f17c7637a971fc8a162425816d4", "author": {"user": {"login": "nickgros", "name": "Nick Grosenbacher"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/df03d329767b4f17c7637a971fc8a162425816d4", "committedDate": "2020-06-22T17:07:54Z", "message": "Add OAuthErrorResponse and multiple exceptions that map to it in order to return error responses that match the OAuth 2/OIDC specs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbd74d2a47cb9fc9783ab25eeadd92fe64fbd78d", "author": {"user": {"login": "nickgros", "name": "Nick Grosenbacher"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/cbd74d2a47cb9fc9783ab25eeadd92fe64fbd78d", "committedDate": "2020-06-22T17:07:54Z", "message": "Add tests for exception handlers, rename OAuthUnauthorizedException -> OAuthUnauthenticatedException"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f4f1d06758d2c0f8e1ee8cebebc9005703525a23", "author": {"user": {"login": "nickgros", "name": "Nick Grosenbacher"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/f4f1d06758d2c0f8e1ee8cebebc9005703525a23", "committedDate": "2020-06-22T17:07:27Z", "message": "Add tests for exception handlers, rename OAuthUnauthorizedException -> OAuthUnauthenticatedException"}, "afterCommit": {"oid": "cbd74d2a47cb9fc9783ab25eeadd92fe64fbd78d", "author": {"user": {"login": "nickgros", "name": "Nick Grosenbacher"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/cbd74d2a47cb9fc9783ab25eeadd92fe64fbd78d", "committedDate": "2020-06-22T17:07:54Z", "message": "Add tests for exception handlers, rename OAuthUnauthorizedException -> OAuthUnauthenticatedException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f809493e0687ac794db814da8ad643151c051528", "author": {"user": {"login": "nickgros", "name": "Nick Grosenbacher"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/f809493e0687ac794db814da8ad643151c051528", "committedDate": "2020-06-22T19:29:16Z", "message": "Fix test and rename-induced typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c1b4a5746046eea4457e786f14deb0dd525459f", "author": {"user": {"login": "nickgros", "name": "Nick Grosenbacher"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/8c1b4a5746046eea4457e786f14deb0dd525459f", "committedDate": "2020-06-22T19:52:25Z", "message": "Fix wrong package"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1Nzg3NTQ4", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4104#pullrequestreview-435787548", "createdAt": "2020-06-23T13:34:54Z", "commit": {"oid": "8c1b4a5746046eea4457e786f14deb0dd525459f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMzozNDo1NFrOGnphLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMzozNDo1NFrOGnphLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIyNzg4Nw==", "bodyText": "I didn't change this error message because I am not sure what the proper error code should be (of the error codes in the OIDC section in the commented URL).", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4104#discussion_r444227887", "createdAt": "2020-06-23T13:34:54Z", "author": {"login": "nickgros"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/oauth/OpenIDConnectManagerImpl.java", "diffHunk": "@@ -205,14 +208,15 @@ public boolean hasUserGrantedConsent(UserInfo userInfo, OIDCAuthorizationRequest\n \tpublic OAuthAuthorizationResponse authorizeClient(UserInfo userInfo,\n \t\t\tOIDCAuthorizationRequest authorizationRequest) {\n \t\tif (AuthorizationUtils.isUserAnonymous(userInfo)) {\n+\t\t\t// Perhaps this should be an OIDC Error Code: https://openid.net/specs/openid-connect-core-1_0.html#AuthError\n \t\t\tthrow new UnauthorizedException(\"Anonymous users may not provide access to OAuth clients.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c1b4a5746046eea4457e786f14deb0dd525459f"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NzkwOTY0", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4104#pullrequestreview-435790964", "createdAt": "2020-06-23T13:38:28Z", "commit": {"oid": "8c1b4a5746046eea4457e786f14deb0dd525459f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMzozODoyOFrOGnprOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMzozODoyOFrOGnprOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDIzMDQ1OQ==", "bodyText": "Per OAuth 2.1, using a revoked access token should result in a 403, not a 400.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4104#discussion_r444230459", "createdAt": "2020-06-23T13:38:28Z", "author": {"login": "nickgros"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/oauth/OpenIDConnectManagerImpl.java", "diffHunk": "@@ -270,7 +274,7 @@ public String validateAccessToken(String jwtToken) {\n \t\tString userId = getUserIdFromPPID(claims.getSubject(), claims.getAudience());\n \t\tString refreshTokenId = claims.get(OIDCClaimName.refresh_token_id.name(), String.class);\n \t\tif (refreshTokenId != null && !oauthRefreshTokenManager.isRefreshTokenActive(refreshTokenId)) {\n-\t\t\tthrow new IllegalArgumentException(\"The access token has been revoked\");\n+\t\t\tthrow new OAuthUnauthenticatedException(OAuthErrorCode.invalid_token, \"The access token has been revoked\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c1b4a5746046eea4457e786f14deb0dd525459f"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6adaf4aa8c94471106a78afebed0a9ca3c0025e7", "author": {"user": {"login": "nickgros", "name": "Nick Grosenbacher"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/6adaf4aa8c94471106a78afebed0a9ca3c0025e7", "committedDate": "2020-06-23T13:52:32Z", "message": "Error message changes in refresh token manager and service"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1ODA2NzI4", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4104#pullrequestreview-435806728", "createdAt": "2020-06-23T13:54:24Z", "commit": {"oid": "8c1b4a5746046eea4457e786f14deb0dd525459f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMzo1NDoyNFrOGnqZ7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMzo1NDoyNFrOGnqZ7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI0MjQxNA==", "bodyText": "Why was this ISE?", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4104#discussion_r444242414", "createdAt": "2020-06-23T13:54:24Z", "author": {"login": "nickgros"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/oauth/OpenIDConnectManagerImpl.java", "diffHunk": "@@ -314,25 +318,25 @@ public OIDCTokenResponse generateTokenResponseWithAuthorizationCode(String code,\n \t\ttry {\n \t\t\tserializedAuthorizationRequest = stackEncrypter.decryptStackEncryptedAndBase64EncodedString(code);\n \t\t} catch (Exception e) {\n-\t\t\tthrow new IllegalArgumentException(\"Invalid authorization code: \"+code, e);\n+\t\t\tthrow new OAuthBadRequestException(OAuthErrorCode.invalid_grant, \"Invalid authorization code: \"+code, e);\n \t\t}\n \t\tOIDCAuthorizationRequest authorizationRequest = new OIDCAuthorizationRequest();\n \t\ttry {\n \t\t\tJSONObjectAdapter adapter = new JSONObjectAdapterImpl(serializedAuthorizationRequest);\n \t\t\tauthorizationRequest.initializeFromJSONObject(adapter);\n \t\t} catch (JSONObjectAdapterException e) {\n-\t\t\tthrow new IllegalStateException(\"Incorrectly formatted authorization code: \"+code, e);\n+\t\t\tthrow new OAuthBadRequestException(OAuthErrorCode.invalid_grant, \"Incorrectly formatted authorization code: \"+code, e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c1b4a5746046eea4457e786f14deb0dd525459f"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MDAyOTI0", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4104#pullrequestreview-436002924", "createdAt": "2020-06-23T17:31:36Z", "commit": {"oid": "6adaf4aa8c94471106a78afebed0a9ca3c0025e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNzozMTozNlrOGnzgCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNzozMTozNlrOGnzgCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM5MTQzNA==", "bodyText": "this will go away", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4104#discussion_r444391434", "createdAt": "2020-06-23T17:31:36Z", "author": {"login": "brucehoff"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/web/controller/JSONEntityHttpMessageConverter.java", "diffHunk": "@@ -242,6 +243,8 @@ public void write(JSONEntity entity, final MediaType contentType,\n \tpublic static String convertEntityToPlainText(JSONEntity entity) throws JSONObjectAdapterException {\r\n \t\tif (entity instanceof ErrorResponse) {\r\n \t\t\treturn ((ErrorResponse)entity).getReason();\r\n+\t\t} else if (entity instanceof OAuthErrorResponse) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6adaf4aa8c94471106a78afebed0a9ca3c0025e7"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MDA0Mzc3", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4104#pullrequestreview-436004377", "createdAt": "2020-06-23T17:33:31Z", "commit": {"oid": "6adaf4aa8c94471106a78afebed0a9ca3c0025e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNzozMzozMVrOGnzkFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNzozMzozMVrOGnzkFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM5MjQ3MA==", "bodyText": "will go away", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4104#discussion_r444392470", "createdAt": "2020-06-23T17:33:31Z", "author": {"login": "brucehoff"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/web/controller/JSONEntityHttpMessageConverterTest.java", "diffHunk": "@@ -118,12 +119,20 @@ public void testErrorResponseRoundTripWithPlainTextMediaType() throws HttpMessag\n \t}\r\n \t\r\n \t@Test\r\n-\tpublic void testConvertEntityToPlainText() throws Exception {\r\n+\tpublic void testConvertErrorEntityToPlainText() throws Exception {\r\n \t\tErrorResponse error = new ErrorResponse();\r\n \t\terror.setReason(\"foo\");\r\n \t\tassertEquals(\"foo\", JSONEntityHttpMessageConverter.convertEntityToPlainText(error));\r\n \t}\r\n-\t\r\n+\r\n+\t@Test\r\n+\tpublic void testConvertOAuthErrorEntityToPlainText() throws Exception {\r\n+\t\tOAuthErrorResponse error = new OAuthErrorResponse();\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6adaf4aa8c94471106a78afebed0a9ca3c0025e7"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MDA1OTM4", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4104#pullrequestreview-436005938", "createdAt": "2020-06-23T17:35:39Z", "commit": {"oid": "6adaf4aa8c94471106a78afebed0a9ca3c0025e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNzozNTo0MFrOGnzolg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNzozNTo0MFrOGnzolg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM5MzYyMg==", "bodyText": "instead of adding a new method, just replace String reason with JSONEntity errorEntity.\nyou could then add two methods, one that turns a reason string into an ErrorResponse and another that turns OAuthErrorCode errorCode, String description into OAuthErrorResponse.  Each one then calls the common method that writes to the HttpResponse.\nBTW, only write WWW-Authenticate response header is status=401", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4104#discussion_r444393622", "createdAt": "2020-06-23T17:35:40Z", "author": {"login": "brucehoff"}, "path": "services/repository/src/main/java/org/sagebionetworks/auth/HttpAuthUtil.java", "diffHunk": "@@ -136,4 +145,32 @@ public static void reject(HttpServletResponse resp, String reason, HttpStatus st\n \t\t}\n \t\tresp.getWriter().flush();\n \t}\n+\n+\t/**\n+\t * OAuth errors don't have the same JSON format as our regular error, so this method may be used for\n+\t * sending error responses caused by OAuth services\n+\t */\n+\tpublic static void rejectWithOAuthError(HttpServletResponse resp, OAuthErrorCode errorCode, String description, HttpStatus status) throws IOException {\n+\t\tresp.setStatus(status.value());\n+\n+\t\t// This header is required according to RFC-2612\n+\t\t// See: http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2\n+\t\t//      http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.47\n+\t\t//      http://www.ietf.org/rfc/rfc2617.txt\n+\t\tresp.setContentType(\"application/json\");\n+\t\tresp.setHeader(\"WWW-Authenticate\", \"\\\"Digest\\\" your email\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6adaf4aa8c94471106a78afebed0a9ca3c0025e7"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MDE4MjQ0", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4104#pullrequestreview-436018244", "createdAt": "2020-06-23T17:49:00Z", "commit": {"oid": "6adaf4aa8c94471106a78afebed0a9ca3c0025e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNzo0OTowMFrOGn0JYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNzo0OTowMFrOGn0JYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQwMjAxOA==", "bodyText": "extend error response", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4104#discussion_r444402018", "createdAt": "2020-06-23T17:49:00Z", "author": {"login": "brucehoff"}, "path": "lib/lib-auto-generated/src/main/resources/schema/org/sagebionetworks/repo/model/OAuthErrorResponse.json", "diffHunk": "@@ -0,0 +1,17 @@\n+{\n+    \"description\":\"JSON schema for an error returned by Synapse OAuth 2.0 Services. Used to align error messages with <a href=\\\"https://tools.ietf.org/html/rfc6749#section-5.2\\\">RFC 6749 Section 5.2</a>\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6adaf4aa8c94471106a78afebed0a9ca3c0025e7"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4efce0949766d42d8098b223717ef1dfc993faf", "author": {"user": {"login": "nickgros", "name": "Nick Grosenbacher"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/b4efce0949766d42d8098b223717ef1dfc993faf", "committedDate": "2020-06-23T19:00:42Z", "message": "Code review changes #4104"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f860fef847355c0f228209cc0b0b1f694738f5f4", "author": {"user": {"login": "nickgros", "name": "Nick Grosenbacher"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/f860fef847355c0f228209cc0b0b1f694738f5f4", "committedDate": "2020-06-23T19:53:46Z", "message": "Fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2NjM3MjAw", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4104#pullrequestreview-436637200", "createdAt": "2020-06-24T13:19:13Z", "commit": {"oid": "f860fef847355c0f228209cc0b0b1f694738f5f4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4769, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}