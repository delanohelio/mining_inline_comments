{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2NzUwMDMx", "number": 4185, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODoyMjozN1rOEfBsCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODo0NTo0OFrOEfCKRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwOTY4OTY4OnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/oauth/OIDCTokenHelperImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODoyMjozN1rOHLC3JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODoyMjozN1rOHLC3JA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM0MzI2OA==", "bodyText": "use this in createPersonalAccessToken() too.  Make sure there are no other references to Jwts.claims()\ncreate a new factory, e.g., ????.createClaims() that returns a ClaimsWithAuthTime().", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4185#discussion_r481343268", "createdAt": "2020-09-01T18:22:37Z", "author": {"login": "brucehoff"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/oauth/OIDCTokenHelperImpl.java", "diffHunk": "@@ -111,28 +110,29 @@ public String createOIDCaccessToken(\n \t\t\tString issuer,\n \t\t\tString subject, \n \t\t\tString oauthClientId,\n-\t\t\tlong now, \n+\t\t\tlong now,\n+\t\t\tlong expirationTimeSeconds,\n \t\t\tDate authTime,\n \t\t\tString refreshTokenId,\n \t\t\tString accessTokenId,\n \t\t\tList<OAuthScope> scopes,\n \t\t\tMap<OIDCClaimName, OIDCClaimsRequestDetails> oidcClaims) {\n \t\t\n-\t\tClaims claims = Jwts.claims();\n+\t\tClaimsWithAuthTime claims = new ClaimsWithAuthTime();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40f347a913b9e510b8b54ec39e14cd76c291392e"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwOTY5ODI3OnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/oauth/OIDCTokenHelperImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODoyNToxM1rOHLC8ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODoyNToxM1rOHLC8ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM0NDY3NQ==", "bodyText": "put setAuthTime here", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4185#discussion_r481344675", "createdAt": "2020-09-01T18:25:13Z", "author": {"login": "brucehoff"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/oauth/OIDCTokenHelperImpl.java", "diffHunk": "@@ -111,28 +110,29 @@ public String createOIDCaccessToken(\n \t\t\tString issuer,\n \t\t\tString subject, \n \t\t\tString oauthClientId,\n-\t\t\tlong now, \n+\t\t\tlong now,\n+\t\t\tlong expirationTimeSeconds,\n \t\t\tDate authTime,\n \t\t\tString refreshTokenId,\n \t\t\tString accessTokenId,\n \t\t\tList<OAuthScope> scopes,\n \t\t\tMap<OIDCClaimName, OIDCClaimsRequestDetails> oidcClaims) {\n \t\t\n-\t\tClaims claims = Jwts.claims();\n+\t\tClaimsWithAuthTime claims = new ClaimsWithAuthTime();\n \t\t\n \t\tClaimsJsonUtil.addAccessClaims(scopes, oidcClaims, claims);\n \t\t\n \t\tclaims.setIssuer(issuer)\n \t\t\t.setAudience(oauthClientId)\n-\t\t\t.setExpiration(new Date(now+ACCESS_TOKEN_EXPIRATION_TIME_SECONDS*1000L))\n+\t\t\t.setExpiration(new Date(now+expirationTimeSeconds*1000L))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40f347a913b9e510b8b54ec39e14cd76c291392e"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwOTcxMDU0OnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/oauth/OpenIDConnectManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODoyODo1NVrOHLDEYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODoyODo1NVrOHLDEYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM0NjY1Nw==", "bodyText": "throw new OAuthBadRequestException(OAuthErrorCode.invalid_request, e.getMessage(), e), i.e., chain the exceptions", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4185#discussion_r481346657", "createdAt": "2020-09-01T18:28:55Z", "author": {"login": "brucehoff"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/oauth/OpenIDConnectManagerImpl.java", "diffHunk": "@@ -126,13 +128,21 @@ public void setClaimProviders(Map<OIDCClaimName, OIDCClaimProvider> claimProvide\n \t}\n \n \tpublic static void validateAuthenticationRequest(OIDCAuthorizationRequest authorizationRequest, OAuthClient client) {\n-\t\tValidateArgument.validUrl(authorizationRequest.getRedirectUri(), \"Redirect URI\");\n+\t\ttry {\n+\t\t\tValidateArgument.validUrl(authorizationRequest.getRedirectUri(), \"Redirect URI\");\n+\t\t} catch (IllegalArgumentException e) {\n+\t\t\tthrow new OAuthBadRequestException(OAuthErrorCode.invalid_request, e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40f347a913b9e510b8b54ec39e14cd76c291392e"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwOTcyODMwOnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/oauth/OpenIDConnectManagerImplUnitTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODozNDowMFrOHLDPdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODozNDowMFrOHLDPdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM0OTQ5Mw==", "bodyText": "convert to assertThrows", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4185#discussion_r481349493", "createdAt": "2020-09-01T18:34:00Z", "author": {"login": "brucehoff"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/oauth/OpenIDConnectManagerImplUnitTest.java", "diffHunk": "@@ -288,8 +290,8 @@ public void testValidateAuthenticationRequest_invalidUri() {\n \t\t\t// method under test\n \t\t\tOpenIDConnectManagerImpl.validateAuthenticationRequest(authorizationRequest, client);\n \t\t\tfail(\"Exception expected.\");\n-\t\t} catch (IllegalArgumentException e) {\n-\t\t\t// as expected\n+\t\t} catch (OAuthBadRequestException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40f347a913b9e510b8b54ec39e14cd76c291392e"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwOTcyODk4OnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/oauth/OpenIDConnectManagerImplUnitTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODozNDoxNFrOHLDP6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODozNDoxNFrOHLDP6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM0OTYxMQ==", "bodyText": "change to assertThrows; check message too", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4185#discussion_r481349611", "createdAt": "2020-09-01T18:34:14Z", "author": {"login": "brucehoff"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/oauth/OpenIDConnectManagerImplUnitTest.java", "diffHunk": "@@ -308,7 +310,7 @@ public void testValidateAuthenticationRequest_invalidResponseType() {\n \t\t\tOpenIDConnectManagerImpl.validateAuthenticationRequest(authorizationRequest, client);\n \t\t\tfail(\"Exception expected.\");\n \t\t} catch (OAuthBadRequestException e) {\n-\t\t\t// as expected\n+\t\t\tassertEquals(OAuthErrorCode.invalid_request, e.getError());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40f347a913b9e510b8b54ec39e14cd76c291392e"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwOTczMTUzOnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/oauth/OpenIDConnectManagerImplUnitTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODozNTowMVrOHLDRfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODozNTowMVrOHLDRfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM1MDAxNQ==", "bodyText": "assertThrows; check message", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4185#discussion_r481350015", "createdAt": "2020-09-01T18:35:01Z", "author": {"login": "brucehoff"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/oauth/OpenIDConnectManagerImplUnitTest.java", "diffHunk": "@@ -443,9 +445,10 @@ public void testGetAuthenticationRequestDescription_BadRedirectURI() {\n \t\ttry {\n \t\t\t// method under test\n \t\t\topenIDConnectManagerImpl.getAuthenticationRequestDescription(authorizationRequest);\n-\t\t\tfail(\"IllegalArgumentException expected\");\n-\t\t} catch (IllegalArgumentException e) {\n+\t\t\tfail(\"OAuthBadRequestException expected\");\n+\t\t} catch (OAuthBadRequestException e) {\n \t\t\t// as expected\n+\t\t\tassertEquals(OAuthErrorCode.invalid_request, e.getError());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40f347a913b9e510b8b54ec39e14cd76c291392e"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwOTc2NzEwOnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/oauth/OpenIDConnectManagerImplUnitTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODo0NTo0OFrOHLDnvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxODo0NTo0OFrOHLDnvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM1NTcxMQ==", "bodyText": "add verify() statements", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4185#discussion_r481355711", "createdAt": "2020-09-01T18:45:48Z", "author": {"login": "brucehoff"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/oauth/OpenIDConnectManagerImplUnitTest.java", "diffHunk": "@@ -1089,11 +1100,11 @@ public void testGetTokenResponseWithRefreshToken_nullOrEmptyScope() {\n \n \t\tString expectedIdToken = \"ID-TOKEN\";\n \t\twhen(oidcTokenHelper.createOIDCIdToken(eq(OAUTH_ENDPOINT), eq(ppid), eq(OAUTH_CLIENT_ID), anyLong(),\n-\t\t\t\tisNull(), eq(initalAuthzOn), anyString(), userInfoCaptor.capture())).thenReturn(expectedIdToken);\n+\t\t\t\tisNull(), eq(authenticationTime), anyString(), userInfoCaptor.capture())).thenReturn(expectedIdToken);\n \n \t\tString expectedAccessToken = \"ACCESS-TOKEN\";\n-\t\twhen(oidcTokenHelper.createOIDCaccessToken(eq(OAUTH_ENDPOINT), eq(ppid), eq(OAUTH_CLIENT_ID), anyLong(),\n-\t\t\t\teq(initalAuthzOn), eq(expectedRefreshTokenAndId.getMetadata().getTokenId()), anyString(), scopesCaptor.capture(), claimsCaptor.capture())).thenReturn(expectedAccessToken);\n+\t\twhen(oidcTokenHelper.createOIDCaccessToken(eq(OAUTH_ENDPOINT), eq(ppid), eq(OAUTH_CLIENT_ID), anyLong(), anyLong(),\n+\t\t\t\teq(authenticationTime), eq(expectedRefreshTokenAndId.getMetadata().getTokenId()), anyString(), scopesCaptor.capture(), claimsCaptor.capture())).thenReturn(expectedAccessToken);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40f347a913b9e510b8b54ec39e14cd76c291392e"}, "originalPosition": 156}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2970, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}