{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4NTMyNzY1", "number": 4132, "title": "PLFM-6367: Add service to detect if the stack is prod", "bodyText": "", "createdAt": "2020-07-13T22:30:42Z", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4132", "merged": true, "mergeCommit": {"oid": "3e5e5072473934f0f1067c8f7431c52a7cc71bc1"}, "closed": true, "closedAt": "2020-07-14T21:48:51Z", "author": {"login": "marcomarasca"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0l92HgH2gAyNDQ4NTMyNzY1Ojc2ZmNjYWZhYTk1NzQzMzNiZTMzY2YzODFlMTQzOGFjMjU0YTYzYzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc09NLkgFqTQ0ODQ5MDg5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "76fccafaa9574333be33cf381e1438ac254a63c5", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/76fccafaa9574333be33cf381e1438ac254a63c5", "committedDate": "2020-07-13T18:44:11Z", "message": "PLFM-6367: Added new config property that points to repo prod"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "118f771bc651f0d4e24067122e23ebf19607d384", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/118f771bc651f0d4e24067122e23ebf19607d384", "committedDate": "2020-07-13T22:25:22Z", "message": "PLFM-6367: Move the stack status manager to its own package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bacd4cea2e2a4d664549dca83d7473b38093298", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/2bacd4cea2e2a4d664549dca83d7473b38093298", "committedDate": "2020-07-13T22:26:59Z", "message": "PLFM-6367: Configure the injected http client timeouts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9075e967a53f8770542fcbe171eba2ccafda223b", "author": {"user": {"login": "marcomarasca", "name": "Marco Marasca"}}, "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/commit/9075e967a53f8770542fcbe171eba2ccafda223b", "committedDate": "2020-07-13T22:28:02Z", "message": "PLFM-6367: Add service for detecting if the stack is prod"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NDg0NzEw", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4132#pullrequestreview-448484710", "createdAt": "2020-07-14T21:37:25Z", "commit": {"oid": "9075e967a53f8770542fcbe171eba2ccafda223b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQyMTozNzoyNVrOGxmR5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQyMTozNzoyNVrOGxmR5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY2MDU4MA==", "bodyText": "add agent info for tracking.", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4132#discussion_r454660580", "createdAt": "2020-07-14T21:37:25Z", "author": {"login": "john-hill"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/stack/ProdDetectorImpl.java", "diffHunk": "@@ -0,0 +1,129 @@\n+package org.sagebionetworks.repo.manager.stack;\r\n+\r\n+import java.io.IOException;\r\n+import java.util.Map;\r\n+import java.util.Optional;\r\n+\r\n+import javax.annotation.PostConstruct;\r\n+\r\n+import org.apache.commons.lang3.StringUtils;\r\n+import org.apache.http.HttpHeaders;\r\n+import org.apache.http.HttpStatus;\r\n+import org.apache.http.entity.ContentType;\r\n+import org.apache.logging.log4j.Logger;\r\n+import org.sagebionetworks.LoggerProvider;\r\n+import org.sagebionetworks.StackConfiguration;\r\n+import org.sagebionetworks.repo.model.versionInfo.SynapseVersionInfo;\r\n+import org.sagebionetworks.schema.adapter.JSONObjectAdapter;\r\n+import org.sagebionetworks.schema.adapter.JSONObjectAdapterException;\r\n+import org.sagebionetworks.schema.adapter.org.json.JSONObjectAdapterImpl;\r\n+import org.sagebionetworks.simpleHttpClient.SimpleHttpClient;\r\n+import org.sagebionetworks.simpleHttpClient.SimpleHttpRequest;\r\n+import org.sagebionetworks.simpleHttpClient.SimpleHttpResponse;\r\n+import org.springframework.beans.factory.annotation.Autowired;\r\n+import org.springframework.http.CacheControl;\r\n+import org.springframework.stereotype.Service;\r\n+\r\n+import com.google.common.collect.ImmutableMap;\r\n+\r\n+@Service\r\n+public class ProdDetectorImpl implements ProdDetector {\r\n+\r\n+\tstatic final String VERSION_INFO_ENDPOINT = \"/version\";\r\n+\t\r\n+\tstatic final String FAILED_REQUEST_MSG = \"Could not fetch prod version info from {}: {}\";\r\n+\r\n+\tprivate final SimpleHttpClient httpClient;\r\n+\tprivate final StackConfiguration stackConfiguration;\r\n+\tprivate final LoggerProvider logProvider;\r\n+\t\r\n+\tprivate SimpleHttpRequest versionInfoRequest;\r\n+\tprivate String currentStackVersion;\r\n+\tprivate Logger log;\r\n+\r\n+\t@Autowired\r\n+\tpublic ProdDetectorImpl(final SimpleHttpClient httpClient, final StackConfiguration stackConfiguration, final LoggerProvider logProvider) {\r\n+\t\tthis.httpClient = httpClient;\r\n+\t\tthis.stackConfiguration = stackConfiguration;\r\n+\t\tthis.logProvider = logProvider;\r\n+\t}\r\n+\t\r\n+\t@PostConstruct\r\n+\tprotected void init() {\r\n+\t\tthis.log = logProvider.getLogger(ProdDetectorImpl.class.getName());\r\n+\t\tthis.currentStackVersion = stackConfiguration.getStackInstance();\r\n+\t\t\r\n+\t\tthis.versionInfoRequest = new SimpleHttpRequest();\r\n+\t\tthis.versionInfoRequest.setUri(stackConfiguration.getRepositoryServiceProdEndpoint() + VERSION_INFO_ENDPOINT);\r\n+\r\n+\t\tMap<String, String> headers = ImmutableMap.of(\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9075e967a53f8770542fcbe171eba2ccafda223b"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NDkwODk2", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/4132#pullrequestreview-448490896", "createdAt": "2020-07-14T21:48:46Z", "commit": {"oid": "9075e967a53f8770542fcbe171eba2ccafda223b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4585, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}