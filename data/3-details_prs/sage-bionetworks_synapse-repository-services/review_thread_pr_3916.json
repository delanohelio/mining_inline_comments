{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3NzU4MjE0", "number": 3916, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwMDo0Njo0N1rODbEmpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMzoyNzowNVrODbaEEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NzEzNTc1OnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/EntityManagerImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwMDo0Njo0N1rOFiWUkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwMDo0Njo0N1rOFiWUkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU2MTYxNw==", "bodyText": "Java Optional", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916#discussion_r371561617", "createdAt": "2020-01-28T00:46:47Z", "author": {"login": "john-hill"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/EntityManagerImpl.java", "diffHunk": "@@ -85,6 +98,22 @@ public void setAllowCreationOfOldEntities(boolean allowCreationOfOldEntities) {\n \t\t\tthrows DatastoreException, InvalidModelException,\n \t\t\tUnauthorizedException, NotFoundException {\n \t\tvalidateEntity(newEntity);\n+\t\tif (newEntity instanceof FileEntity) {\n+\t\t\tvalidateFileEntityStsRestrictions(userInfo, (FileEntity) newEntity);\n+\t\t}\n+\n+\t\t// If the parent lives inside an STS-enabled folder, only Files and Folders are allowed.\n+\t\tif (!(newEntity instanceof FileEntity) && !(newEntity instanceof Folder)) {\n+\t\t\tString parentId = newEntity.getParentId();\n+\t\t\tif (parentId != null) {\n+\t\t\t\tProjectSetting projectSetting = projectSettingsManager.getProjectSettingForNode(userInfo, parentId,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d58e288e90a647023c112a4c36633e317f041003"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NzE2Nzc4OnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/EntityManagerImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwMTowNzoxN1rOFiWoJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwMTowNzoxN1rOFiWoJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU2NjYzMA==", "bodyText": "test for null case?", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916#discussion_r371566630", "createdAt": "2020-01-28T01:07:17Z", "author": {"login": "john-hill"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/EntityManagerImpl.java", "diffHunk": "@@ -562,7 +595,50 @@ public DataTypeResponse changeEntityDataType(UserInfo userInfo, String entityId,\n \t\tValidateArgument.required(dataType, \"DataType\");\n \t\treturn objectTypeManager.changeObjectsDataType(userInfo, entityId, ObjectType.ENTITY, dataType);\n \t}\n-\t\n+\n+\t// Validates whether a FileEntity satisfies the STS restrictions of its parent.\n+\t// Package-scoped to facilitate unit tests.\n+\tvoid validateFileEntityStsRestrictions(UserInfo userInfo, FileEntity fileEntity) {\n+\t\t// Is the file STS-enabled?\n+\t\tFileHandle fileHandle = fileHandleManager.getRawFileHandle(userInfo, fileEntity.getDataFileHandleId());\n+\t\tLong fileStorageLocationId = fileHandle.getStorageLocationId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d58e288e90a647023c112a4c36633e317f041003"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMDYxNTIxOnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/EntityPermissionsManagerImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMzowOTo0NlrOFi3zDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMzowOTo0NlrOFi3zDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjExMDA5Mw==", "bodyText": "comment on projectId can be a folderId", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916#discussion_r372110093", "createdAt": "2020-01-28T23:09:46Z", "author": {"login": "john-hill"}, "path": "services/repository-managers/src/main/java/org/sagebionetworks/repo/manager/EntityPermissionsManagerImpl.java", "diffHunk": "@@ -154,6 +158,18 @@ public AccessControlList overrideInheritance(AccessControlList acl, UserInfo use\n \t\t\n \t\t// validate the Entity owners will still have access.\n \t\tPermissionsManagerUtils.validateACLContent(acl, userInfo, node.getCreatedByPrincipalId());\n+\n+\t\t// Can't override ACL inheritance if the entity lives inside an STS-enabled folder.\n+\t\tUploadDestinationListSetting projectSetting = projectSettingsManager.getProjectSettingForNode(userInfo,\n+\t\t\t\tentityId, ProjectSettingsType.upload, UploadDestinationListSetting.class);\n+\t\tif (projectSetting != null && !KeyFactory.equals(projectSetting.getProjectId(), entityId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d58e288e90a647023c112a4c36633e317f041003"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMDY0OTEwOnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/ProjectSettingsManagerImplUnitTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMzoyNTo0N1rOFi4HzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMzoyNTo0N1rOFi4HzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjExNTQwNA==", "bodyText": "cast to the other way", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916#discussion_r372115404", "createdAt": "2020-01-28T23:25:47Z", "author": {"login": "john-hill"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/ProjectSettingsManagerImplUnitTest.java", "diffHunk": "@@ -1024,64 +1024,81 @@ public void testValidateProjectSetting_StsCannotBeEnabledWithOtherStorageLocatio\n \t}\n \n \t@Test\n-\tpublic void testIsStsStorageLocation_NullProjectSetting() {\n+\tpublic void testIsStsStorageLocation_NullStorageLocationSetting() {\n \t\t// Method under test.\n-\t\tboolean result = projectSettingsManagerImpl.isStsStorageLocationSetting(null);\n+\t\tboolean result = projectSettingsManagerImpl.isStsStorageLocationSetting((ProjectSetting) null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d58e288e90a647023c112a4c36633e317f041003"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMDY1MTcxOnYy", "diffSide": "RIGHT", "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/ProjectSettingsManagerImplUnitTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMzoyNzowNVrOFi4Jaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMzoyNzowNVrOFi4Jaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjExNTgxOQ==", "bodyText": "duplicate", "url": "https://github.com/Sage-Bionetworks/Synapse-Repository-Services/pull/3916#discussion_r372115819", "createdAt": "2020-01-28T23:27:05Z", "author": {"login": "john-hill"}, "path": "services/repository-managers/src/test/java/org/sagebionetworks/repo/manager/ProjectSettingsManagerImplUnitTest.java", "diffHunk": "@@ -1024,64 +1024,81 @@ public void testValidateProjectSetting_StsCannotBeEnabledWithOtherStorageLocatio\n \t}\n \n \t@Test\n-\tpublic void testIsStsStorageLocation_NullProjectSetting() {\n+\tpublic void testIsStsStorageLocation_NullStorageLocationSetting() {\n \t\t// Method under test.\n-\t\tboolean result = projectSettingsManagerImpl.isStsStorageLocationSetting(null);\n+\t\tboolean result = projectSettingsManagerImpl.isStsStorageLocationSetting((ProjectSetting) null);\n \t\tassertFalse(result);\n-\t\tverifyZeroInteractions(mockStorageLocationDAO);\n \t}\n \n \t@Test\n-\tpublic void testIsStsStorageLocation_ProjectSettingWrongSubclass() {\n-\t\t// Create a mock of ProjectSetting, so we can have a ProjectSetting instance that's not an\n-\t\t// UploadDestinationListSetting.\n-\t\tProjectSetting input = mock(ProjectSetting.class);\n+\tpublic void testIsStsStorageLocation_StorageLocationSettingWrongClass() {\n+\t\t// Method under test.\n+\t\tboolean result = projectSettingsManagerImpl.isStsStorageLocationSetting(\n+\t\t\t\tnew ExternalGoogleCloudStorageLocationSetting());\n+\t\tassertFalse(result);\n+\t}\n \n+\t@Test\n+\tpublic void testIsStsStorageLocation_NotStsStorageLocation() {\n \t\t// Method under test.\n-\t\tboolean result = projectSettingsManagerImpl.isStsStorageLocationSetting(input);\n+\t\tboolean result = projectSettingsManagerImpl.isStsStorageLocationSetting(\n+\t\t\t\texternalGoogleCloudStorageLocationSetting);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d58e288e90a647023c112a4c36633e317f041003"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3103, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}