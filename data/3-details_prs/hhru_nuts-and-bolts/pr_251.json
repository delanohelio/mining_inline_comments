{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0OTU3NDIz", "number": 251, "title": "HH-113352 request cluster metadata before producer start", "bodyText": "https://jira.hh.ru/browse/HH-113352", "createdAt": "2020-07-22T08:16:48Z", "url": "https://github.com/hhru/nuts-and-bolts/pull/251", "merged": true, "mergeCommit": {"oid": "aa36c6f470e0f63b4d5070f78952f4e6d9625a47"}, "closed": true, "closedAt": "2020-07-22T09:29:40Z", "author": {"login": "bokshitsky"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3WXiKAH2gAyNDU0OTU3NDIzOmQyMDUyY2Q3ODFlMjA5NGRjYjg1NTRiMzAxZDBlZDJkY2E2OTY5ZWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3XLcbAFqTQ1MzEzNjgzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d2052cd781e2094dcb8554b301d0ed2dca6969eb", "author": {"user": {"login": "bokshitsky", "name": "Evgeny Bokshitsky"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/d2052cd781e2094dcb8554b301d0ed2dca6969eb", "committedDate": "2020-07-22T08:15:32Z", "message": "HH-113352 add metadata request on producer start"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45a5d9626da9db6daaa1c15cd3290d5bf8c20f98", "author": {"user": {"login": "bokshitsky", "name": "Evgeny Bokshitsky"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/45a5d9626da9db6daaa1c15cd3290d5bf8c20f98", "committedDate": "2020-07-22T08:16:06Z", "message": "HH-113352 remove non used variable from kafka unit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMDk3NjE4", "url": "https://github.com/hhru/nuts-and-bolts/pull/251#pullrequestreview-453097618", "createdAt": "2020-07-22T08:20:22Z", "commit": {"oid": "45a5d9626da9db6daaa1c15cd3290d5bf8c20f98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwODoyMDoyMlrOG1X6lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwODoyMDoyMlrOG1X6lQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYxOTU0MQ==", "bodyText": "\u041c\u0435\u0442\u043e\u0434 createRawProducer \u0441\u043f\u0435\u0446\u0438\u0430\u043b\u044c\u043d\u043e \u0441\u0434\u0435\u043b\u0430\u043d \u0432 KafkaProducerFactory \u0434\u043b\u044f \u043e\u0432\u0435\u0440\u0430\u0439\u0434\u0430.\n\u043f\u0435\u0440\u0435\u043e\u043f\u0440\u0435\u0434\u0438\u0442\u044c \u0441\u0430\u043c \u043f\u0440\u043e\u0434\u044c\u044e\u0441\u0435\u0440 \u043d\u0435 \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u0442\u0441\u044f - \u043c\u0435\u0442\u043e\u0434\nwaitOnMetadata \u0438 \u0432\u043e\u043e\u0431\u0449\u0435 \u0434\u043e\u0441\u0442\u0443\u043f \u043a \u043c\u0435\u0442\u0430\u0434\u0430\u0442\u0435 \u0442\u0430\u043c \u043f\u0440\u0438\u0432\u0430\u0442\u043d\u044b\u0435\nwaitOnMetadata \u0432\u044b\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u0432 2-\u0445 \u0441\u043b\u0443\u0447\u0430\u044f\u0445 - \u043b\u0438\u0431\u043e \u043f\u0440\u0438 .send() \u043b\u0438\u0431\u043e \u043f\u0440\u0438 . partitionsFor()\n\u0422.\u043a. \u043e\u0442\u043f\u0440\u0430\u0432\u043a\u0430 - \u043e\u043f\u0435\u0440\u0430\u0446\u0438\u044f \u043e\u043f\u0430\u0441\u043d\u0430\u044f, \u0440\u0435\u0448\u0438\u043b \u0432\u044b\u0437\u0432\u0430\u0442\u044c \u0431\u0435\u0437\u043e\u043f\u0430\u0441\u043d\u044b\u0439 \u0438 \u043d\u0435 \u0438\u043c\u0435\u044e\u0449\u0438\u0439 \u043f\u043e\u0431\u043e\u0447\u043d\u044b\u0445 \u0434\u0435\u0439\u0441\u0442\u0432\u0438\u0439 (\u043d\u0430\u0434\u0435\u044e\u0441\u044c) \u0437\u0430\u043f\u0440\u043e\u0441 \u0441\u043f\u0438\u0441\u043a\u0430 \u043f\u0430\u0440\u0442\u0438\u0446\u0438\u0439 \u0434\u043b\u044f \u043d\u0435\u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044e\u0449\u0435\u0433\u043e \u0442\u043e\u043f\u0438\u043a\u0430 (\u043e\u043d \u0432\u0435\u0440\u043d\u0435\u0442 emptyList, \u043d\u043e \u043f\u043e\u0441\u043b\u0435 \u043f\u043e\u0445\u043e\u0434\u0430 \u0432 \u043a\u043b\u0430\u0441\u0442\u0435\u0440 \u0438 \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u044f \u0438\u043d\u0444\u044b, \u0447\u0442\u043e \u0442\u043e\u043f\u0438\u043a\u0430 \u043d\u0435\u0442)", "url": "https://github.com/hhru/nuts-and-bolts/pull/251#discussion_r458619541", "createdAt": "2020-07-22T08:20:22Z", "author": {"login": "bokshitsky"}, "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/producer/KafkaProducerFactory.java", "diffHunk": "@@ -29,10 +31,15 @@ public KafkaProducer createProducer(String producerSettingsName) {\n     producerConfig.put(CommonClientConfigs.METRIC_REPORTER_CLASSES_CONFIG, KafkaStatsDReporter.class.getName());\n \n     ProducerFactory<String, Object> producerFactory = new DefaultKafkaProducerFactory<>(\n-        producerConfig,\n-        new StringSerializer(),\n-        serializerSupplier.supply()\n-    );\n+        producerConfig, new StringSerializer(), serializerSupplier.supply()\n+    ) {\n+      @Override\n+      protected Producer<String, Object> createRawProducer(Map<String, Object> configs) {\n+        Producer<String, Object> rawProducer = super.createRawProducer(configs);\n+        rawProducer.partitionsFor(\"request_partitions_for_topic_to_force_metadata_request\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45a5d9626da9db6daaa1c15cd3290d5bf8c20f98"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMDk4MTg1", "url": "https://github.com/hhru/nuts-and-bolts/pull/251#pullrequestreview-453098185", "createdAt": "2020-07-22T08:21:07Z", "commit": {"oid": "45a5d9626da9db6daaa1c15cd3290d5bf8c20f98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwODoyMTowN1rOG1X8Pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwODoyMTowN1rOG1X8Pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODYxOTk2Nw==", "bodyText": "\u0447\u0442\u043e\u0431\u044b \u0431\u044b\u043b\u043e \u0447\u0443\u0442\u043a\u0430 \u043f\u043e\u043d\u044f\u0442\u043d\u0435\u0435, \u0447\u0442\u043e \u0437\u0430 \u0447\u0438\u0441\u043b\u043e 5 \u0432\u0437\u044f\u043b\u043e\u0441\u044c", "url": "https://github.com/hhru/nuts-and-bolts/pull/251#discussion_r458619967", "createdAt": "2020-07-22T08:21:07Z", "author": {"login": "bokshitsky"}, "path": "nab-tests/src/test/java/ru/hh/nab/kafka/consumer/ConsumerRecoveryAfterFailTest.java", "diffHunk": "@@ -52,20 +51,19 @@ public void testNoGlobalAckPerformed() throws InterruptedException {\n   @Test\n   public void testSeek() throws InterruptedException {\n     putMessagesIntoKafka(117);\n-    AtomicBoolean failed = new AtomicBoolean(false);\n     startConsumer((messages, ack) -> messages.forEach(m -> {\n       processedMessages.add(m.value());\n       if (processedMessages.size() == 40) {\n         ack.seek(m);\n       }\n-      if (!failed.get() && processedMessages.size() == 45) {\n+      if (processedMessages.size() == 45) {\n         throw new IllegalStateException(\"Processing failed\");\n       }\n     }));\n-    assertProcessedMessagesCount(117 + 5);\n+    assertProcessedMessagesCount(117 + (45 - 40));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45a5d9626da9db6daaa1c15cd3290d5bf8c20f98"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMTM2ODMz", "url": "https://github.com/hhru/nuts-and-bolts/pull/251#pullrequestreview-453136833", "createdAt": "2020-07-22T09:12:14Z", "commit": {"oid": "45a5d9626da9db6daaa1c15cd3290d5bf8c20f98"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3317, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}