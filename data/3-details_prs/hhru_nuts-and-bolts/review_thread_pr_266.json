{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyNDQyNzE1", "number": 266, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNToxOTozNVrOEtF56A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNTozMjowOFrOEtGWWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1NzE4MTIwOnYy", "diffSide": "RIGHT", "path": "nab-common/src/main/java/ru/hh/nab/common/properties/FileSettings.java", "isResolved": true, "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNToxOTozNVrOHgsIFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMDoyNjoxNVrOHhMdCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzOTQ0NA==", "bodyText": "\u043d\u0435 \u043d\u0430\u0434\u043e \u0442\u0430\u043a\u043e\u0439 \u043c\u0435\u0442\u043e\u0434. \u0435\u0441\u043b\u0438 \u0447\u0435\u0433\u043e-\u0442\u043e \u0432 \u0444\u0430\u0439\u043b\u0438\u043a\u0435 \u043d\u0435\u0442 - \u043d\u0430\u0434\u043e \u0432\u0430\u043b\u0438\u0442\u044c\u0441\u044f", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504039444", "createdAt": "2020-10-13T15:19:35Z", "author": {"login": "dzharikhin"}, "path": "nab-common/src/main/java/ru/hh/nab/common/properties/FileSettings.java", "diffHunk": "@@ -18,6 +19,10 @@ public String getString(String key) {\n     return properties.getProperty(key);\n   }\n \n+  public String getString(String key, String defaultValue) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA0MTE1Ng==", "bodyText": "\u0430 \u043f\u043e\u0442\u043e\u043c \u0432\u0435\u0437\u0434\u0435 requireNonNullElse", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504041156", "createdAt": "2020-10-13T15:21:45Z", "author": {"login": "heruv1m"}, "path": "nab-common/src/main/java/ru/hh/nab/common/properties/FileSettings.java", "diffHunk": "@@ -18,6 +19,10 @@ public String getString(String key) {\n     return properties.getProperty(key);\n   }\n \n+  public String getString(String key, String defaultValue) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzOTQ0NA=="}, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA0MjQ0NQ==", "bodyText": "\u041d\u0435 \u0432\u0438\u0436\u0443 \u0447\u0435\u043c \u043f\u043b\u043e\u0445\u043e. \u0412 \u043c\u043e\u0435\u043c \u043a\u0435\u0439\u0441\u0435 \u0442\u043e\u0447\u043d\u043e \u0443\u0441\u0442\u0430\u0440\u0438\u0432\u0430\u044e\u0442 \u0434\u0435\u0444\u043e\u043b\u0442\u043d\u044b\u0435 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b, \u0434\u0443\u043c\u0430\u044e \u0434\u0440\u0443\u0433\u0438\u043c \u0442\u043e\u0436\u0435 \u043f\u0440\u0438\u0433\u043e\u0434\u0438\u0442\u0441\u044f", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504042445", "createdAt": "2020-10-13T15:23:18Z", "author": {"login": "heruv1m"}, "path": "nab-common/src/main/java/ru/hh/nab/common/properties/FileSettings.java", "diffHunk": "@@ -18,6 +19,10 @@ public String getString(String key) {\n     return properties.getProperty(key);\n   }\n \n+  public String getString(String key, String defaultValue) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzOTQ0NA=="}, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA3Mzg2NA==", "bodyText": "\u0441\u0443\u0442\u044c - \u0441\u0434\u0435\u043b\u0430\u0442\u044c \u0442\u0430\u043a, \u0447\u0442\u043e\u0431\u044b \u0443 \u043a\u0440\u0438\u0442\u0438\u0447\u043d\u044b\u0445 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u043e\u0432 \u0434\u0435\u0444\u043e\u043b\u0442\u043e\u0432 \u043d\u0435 \u0431\u044b\u043b\u043e\n\u043f\u043e\u0441\u043a\u043e\u043b\u044c\u043a\u0443 \u043c\u044b \u043d\u0435 \u043c\u043e\u0436\u0435\u043c \u0437\u043d\u0430\u0442\u044c \u0437\u0430\u0440\u0430\u043d\u0435\u0435 \u0433\u0434\u0435 \u043a\u0440\u0438\u0442\u0438\u0447\u043d\u043e - \u043b\u0443\u0447\u0448\u0435 \u043e\u0442 \u044d\u0442\u043e\u0433\u043e \u0437\u0430\u0449\u0438\u0449\u0430\u0442\u044c\u0441\u044f", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504073864", "createdAt": "2020-10-13T16:02:56Z", "author": {"login": "dzharikhin"}, "path": "nab-common/src/main/java/ru/hh/nab/common/properties/FileSettings.java", "diffHunk": "@@ -18,6 +19,10 @@ public String getString(String key) {\n     return properties.getProperty(key);\n   }\n \n+  public String getString(String key, String defaultValue) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzOTQ0NA=="}, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA3NTA4Mw==", "bodyText": "\u043c\u043e\u0436\u043d\u043e \u0441\u043a\u043b\u0435\u043f\u0430\u0442\u044c \u0441\u0435\u0431\u0435 \u043a\u0430\u043a\u0443\u044e-\u0442\u043e \u043d\u0435\u043f\u0443\u0431\u043b\u0438\u0447\u043d\u0443\u044e \u043e\u0431\u0435\u0440\u0442\u043a\u0443 \u0438 \u0441\u0434\u0435\u043b\u0430\u0442\u044c \u0432 \u043d\u0435\u0439", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504075083", "createdAt": "2020-10-13T16:04:50Z", "author": {"login": "dzharikhin"}, "path": "nab-common/src/main/java/ru/hh/nab/common/properties/FileSettings.java", "diffHunk": "@@ -18,6 +19,10 @@ public String getString(String key) {\n     return properties.getProperty(key);\n   }\n \n+  public String getString(String key, String defaultValue) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzOTQ0NA=="}, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzNjg4Mw==", "bodyText": "\u042f \u043d\u0435 \u0441\u043e\u0433\u043b\u0430\u0441\u0435\u043d \u0432\u0441\u0435 \u0440\u0430\u0432\u043d\u043e. \u0421\u043b\u043e\u043c\u0430\u0442\u044c \u043c\u043e\u0436\u043d\u043e \u0447\u0442\u043e \u0443\u0433\u043e\u0434\u043d\u043e. \u0415\u0441\u0442\u044c \u043c\u0435\u0442\u043e\u0434 \u0431\u0435\u0437 \u0434\u0435\u0444\u043e\u043b\u0442\u0430. \u0415\u0441\u0442\u044c \u0441 \u0434\u0435\u0444\u043e\u043b\u0442\u043e\u043c. \u0427\u0435\u043c \u0445\u0443\u0436\u0435 \u043c\u0435\u0442\u043e\u0434 \u0434\u043b\u044f \u0438\u043d\u0442\u0430 \u0441 \u0434\u0435\u0444\u043e\u043b\u0442\u043e\u043c?", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504536883", "createdAt": "2020-10-14T09:32:06Z", "author": {"login": "heruv1m"}, "path": "nab-common/src/main/java/ru/hh/nab/common/properties/FileSettings.java", "diffHunk": "@@ -18,6 +19,10 @@ public String getString(String key) {\n     return properties.getProperty(key);\n   }\n \n+  public String getString(String key, String defaultValue) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzOTQ0NA=="}, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0MDQ4Nw==", "bodyText": "@pvorlov \u0430 \u0442\u044b \u043a\u0430\u043a \u0434\u0443\u043c\u0430\u0435\u0448\u044c?", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504540487", "createdAt": "2020-10-14T09:37:57Z", "author": {"login": "heruv1m"}, "path": "nab-common/src/main/java/ru/hh/nab/common/properties/FileSettings.java", "diffHunk": "@@ -18,6 +19,10 @@ public String getString(String key) {\n     return properties.getProperty(key);\n   }\n \n+  public String getString(String key, String defaultValue) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzOTQ0NA=="}, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2NDM4OQ==", "bodyText": "\u042f \u0441\u043a\u043e\u0440\u0435\u0435 \u0437\u0430 \u0442\u043e \u0447\u0442\u043e \u0431 \u0434\u043e\u0431\u0430\u0432\u0438\u0442\u044c. \u041a\u0440\u0438\u0442\u0438\u0447\u043d\u044b\u0435 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b \u043c\u043e\u0433\u0443\u0442 \u0431\u044b\u0442\u044c \u0438 long \u0438 int. \u041d\u043e \u0434\u043b\u044f \u043d\u0438\u0445 \u043c\u044b \u0434\u0435\u0444\u043e\u043b\u0442\u044b \u043d\u0430\u043f\u0438\u0441\u0430\u043b\u0438. \u041a\u043e\u043c\u0443 \u043d\u0430\u0434\u043e \u0434\u0435\u0444\u043e\u043b\u0442 \u0442\u0430\u043c \u0433\u0434\u0435 \u043a\u0440\u0438\u0442\u0438\u0447\u043d\u043e \u043e\u043d \u0441\u043c\u043e\u0436\u0435\u0442 \u0438 \u0431\u0435\u0437 \u044d\u0442\u043e\u0433\u043e \u043c\u0435\u0442\u043e\u0434\u0430 \u0441\u0434\u0435\u043b\u0430\u0442\u044c \u0447\u0435\u0440\u0435\u0437 Optional.\n\u041a\u043b\u0430\u0441\u0441 \u043f\u0440\u043e\u0441\u0442\u043e \u043b\u0430\u043a\u043e\u043d\u0438\u0447\u043d\u0435\u0435 \u0441\u043c\u043e\u0442\u0440\u0435\u0442\u044c\u0441\u044f \u0431\u0443\u0434\u0435\u0442, \u0432 \u043e\u0434\u043d\u043e\u043c \u0441\u0442\u0438\u043b\u0435.", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504564389", "createdAt": "2020-10-14T10:17:40Z", "author": {"login": "pvorlov"}, "path": "nab-common/src/main/java/ru/hh/nab/common/properties/FileSettings.java", "diffHunk": "@@ -18,6 +19,10 @@ public String getString(String key) {\n     return properties.getProperty(key);\n   }\n \n+  public String getString(String key, String defaultValue) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzOTQ0NA=="}, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2NzY3NQ==", "bodyText": "\u043a\u0440\u0438\u0442\u0438\u0447\u043d\u044b\u0435 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b - \u043d\u0435 \u043f\u043e \u0442\u0438\u043f\u0443\n\u044d\u0442\u043e \u043a\u043e\u0433\u0434\u0430 \u0442\u044b \u0432 \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0430\u0445 \u043d\u0435 \u0443\u043a\u0430\u0437\u044b\u0432\u0430\u0435\u0448\u044c \u043d\u0430\u043f\u0440\u0438\u043c\u0435\u0440 \u0438\u043c\u044f \u0441\u0435\u0440\u0432\u0438\u0441\u0430. \u043e\u043d\u043e \u0434\u043e\u043b\u0436\u043d\u043e \u0431\u044b\u0442\u044c, \u0431\u0435\u0437 \u043d\u0435\u0433\u043e \u0434\u043e\u043b\u0436\u043d\u043e \u043f\u0430\u0434\u0430\u0442\u044c", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504567675", "createdAt": "2020-10-14T10:23:40Z", "author": {"login": "dzharikhin"}, "path": "nab-common/src/main/java/ru/hh/nab/common/properties/FileSettings.java", "diffHunk": "@@ -18,6 +19,10 @@ public String getString(String key) {\n     return properties.getProperty(key);\n   }\n \n+  public String getString(String key, String defaultValue) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzOTQ0NA=="}, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2OTA5Ng==", "bodyText": "\u041d\u0443 \u0438 \u043f\u0443\u0441\u0442\u044c \u043f\u0430\u0434\u0430\u0435\u0442! \u0422\u0435\u0431\u044f \u0436 \u043d\u0438\u043a\u0442\u043e \u043d\u0435 \u0437\u0430\u0432\u0441\u0442\u0430\u0432\u043b\u044f\u0435\u0442 \u044d\u0442\u043e\u0442 \u043c\u0435\u0442\u043e\u0434 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c. \u0421\u0442\u0430\u0440\u044b\u0439 getString \u043e\u0441\u0442\u0430\u0451\u0442\u0441\u044f. \u0413\u0434\u0435 \u0434\u043e\u043b\u0436\u043d\u043e \u043f\u0430\u0434\u0430\u0442\u044c - \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u043c \u0435\u0433\u043e.", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504569096", "createdAt": "2020-10-14T10:26:15Z", "author": {"login": "pvorlov"}, "path": "nab-common/src/main/java/ru/hh/nab/common/properties/FileSettings.java", "diffHunk": "@@ -18,6 +19,10 @@ public String getString(String key) {\n     return properties.getProperty(key);\n   }\n \n+  public String getString(String key, String defaultValue) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzOTQ0NA=="}, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1NzE5OTk4OnYy", "diffSide": "RIGHT", "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNToyMzoxNVrOHgsTmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNTozMjozMFrOHgs1jQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA0MjM5Mw==", "bodyText": "3 \u043c\u043e\u0436\u0435\u0442 \u0442\u043e\u0436\u0435 \u0432 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b? \u0432\u044b\u0433\u043b\u044f\u0434\u0438\u0442, \u0447\u0442\u043e \u044d\u0442\u043e \u0442\u0430\u043a\u0430\u044f \u0448\u0442\u0443\u043a\u0430 - \u043d\u0430\u0441\u043a\u043e\u043b\u044c\u043a\u043e \u0443\u043c\u0435\u043d\u044c\u0448\u0430\u0442\u044c \u0432\u0435\u0441 \u0441\u0435\u0440\u0432\u0438\u0441\u0430 \u043c\u043e\u0436\u0435\u0442 \u0431\u044b\u0442\u044c \u0447\u0443\u0432\u0441\u0442\u0432\u0438\u0442\u0435\u043b\u044c\u043d\u043e", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504042393", "createdAt": "2020-10-13T15:23:15Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -23,38 +25,57 @@\n   private static final Logger LOGGER = LoggerFactory.getLogger(ConsulService.class);\n \n   private static final String LOG_LEVEL_OVERRIDE_EXTENSION_TAG = \"log_level_override_extension_enabled\";\n+  private static final int DEFAULT_WEIGHT = 100;\n \n   private final AgentClient agentClient;\n+  private final KeyValueClient kvClient;\n   private final Registration service;\n   private final String id;\n   private final boolean enabled;\n \n-  public ConsulService(AgentClient agentClient, FileSettings fileSettings, String datacenter, String host, AppMetadata appMetadata,\n-                       @Nullable LogLevelOverrideExtension logLevelOverrideExtension) {\n+  public ConsulService(AgentClient agentClient, KeyValueClient kvClient,\n+                              FileSettings fileSettings, String datacenter, String hostName, AppMetadata appMetadata,\n+                              @Nullable LogLevelOverrideExtension logLevelOverrideExtension) {\n     this.agentClient = agentClient;\n+    this.kvClient = kvClient;\n+\n     var applicationPort = fileSettings.getInteger(\"jetty.port\");\n     var applicationHost = Optional.ofNullable(fileSettings.getString(\"consul.check.host\"))\n-      .orElse(\"127.0.0.1\");\n-    var id = fileSettings.getString(\"serviceName\") + \"-\" + datacenter + \"-\" + host + \"-\" + applicationPort;\n+        .orElse(\"127.0.0.1\");\n+    var id = fileSettings.getString(\"serviceName\") + \"-\" + datacenter + \"-\" + hostName + \"-\" + applicationPort;\n     var tags = new ArrayList<>(fileSettings.getStringList(\"consul.tags\"));\n     if (logLevelOverrideExtension != null) {\n       tags.add(LOG_LEVEL_OVERRIDE_EXTENSION_TAG);\n     }\n \n-    ImmutableRegCheck regCheck = ImmutableRegCheck.builder()\n-            .http(\"http://\" + applicationHost + \":\" + applicationPort + \"/status\")\n-            .interval(requireNonNullElse(fileSettings.getString(\"consul.check.interval\"), \"5s\"))\n-            .timeout(requireNonNullElse(fileSettings.getString(\"consul.check.timeout\"), \"5s\"))\n-            .build();\n+    Registration.RegCheck regCheck = ImmutableRegCheck.builder()\n+        .http(\"http://\" + applicationHost + \":\" + applicationPort + \"/status\")\n+        .interval(fileSettings.getString(\"consul.check.interval\", \"5s\"))\n+        .timeout(fileSettings.getString(\"consul.check.timeout\", \"5s\"))\n+        .deregisterCriticalServiceAfter(fileSettings.getString(\"consul.deregisterCritical.timeout\", \"10m\"))\n+        .successBeforePassing(fileSettings.getInteger(\"consul.check.successCount\", 2))\n+        .failuresBeforeCritical(fileSettings.getInteger(\"consul.check.failCount\", 2))\n+        .build();\n+    Optional<String> weight = getWeight(hostName);\n+    int weightForService;\n+    if (weight.isPresent()) {\n+      weightForService = weight.map(Integer::parseInt).get();\n+    } else {\n+      LOGGER.warn(\"No weight present for node:{}\", hostName);\n+      weightForService = DEFAULT_WEIGHT;\n+    }\n+\n+    ServiceWeights serviceWeights = ImmutableServiceWeights.builder().passing(weightForService).warning(weightForService / 3).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA1MTA4NQ==", "bodyText": "\u0432\u043e\u043e\u0431\u0449\u0435 \u0441\u043e\u043c\u043d\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0435. \u0423 \u043d\u0430\u0441 \u0441\u0435\u0439\u0447\u0430\u0441 \u0432\u043e\u043e\u0431\u0449\u0435 \u043d\u0435 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u044e\u0442\u0441\u044f \u0441\u0435\u0440\u0432\u0438\u0441\u044b, \u0435\u0441\u043b\u0438 \u0443 \u043d\u0438\u0445 \u0441\u0442\u0430\u0442\u0443\u0441 \u043e\u0442\u043b\u0438\u0447\u043d\u044b\u0439 \u043e\u0442 passing.\n\u041d\u0443 \u0434\u0430\u0432\u0430\u0439 \u043f\u0435\u0440\u0435\u0437\u0430\u043b\u043e\u0436\u0443\u0441\u044c. \u0425\u0443\u0436\u0435 \u043d\u0435 \u0431\u0443\u0434\u0435\u0442", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504051085", "createdAt": "2020-10-13T15:32:30Z", "author": {"login": "heruv1m"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -23,38 +25,57 @@\n   private static final Logger LOGGER = LoggerFactory.getLogger(ConsulService.class);\n \n   private static final String LOG_LEVEL_OVERRIDE_EXTENSION_TAG = \"log_level_override_extension_enabled\";\n+  private static final int DEFAULT_WEIGHT = 100;\n \n   private final AgentClient agentClient;\n+  private final KeyValueClient kvClient;\n   private final Registration service;\n   private final String id;\n   private final boolean enabled;\n \n-  public ConsulService(AgentClient agentClient, FileSettings fileSettings, String datacenter, String host, AppMetadata appMetadata,\n-                       @Nullable LogLevelOverrideExtension logLevelOverrideExtension) {\n+  public ConsulService(AgentClient agentClient, KeyValueClient kvClient,\n+                              FileSettings fileSettings, String datacenter, String hostName, AppMetadata appMetadata,\n+                              @Nullable LogLevelOverrideExtension logLevelOverrideExtension) {\n     this.agentClient = agentClient;\n+    this.kvClient = kvClient;\n+\n     var applicationPort = fileSettings.getInteger(\"jetty.port\");\n     var applicationHost = Optional.ofNullable(fileSettings.getString(\"consul.check.host\"))\n-      .orElse(\"127.0.0.1\");\n-    var id = fileSettings.getString(\"serviceName\") + \"-\" + datacenter + \"-\" + host + \"-\" + applicationPort;\n+        .orElse(\"127.0.0.1\");\n+    var id = fileSettings.getString(\"serviceName\") + \"-\" + datacenter + \"-\" + hostName + \"-\" + applicationPort;\n     var tags = new ArrayList<>(fileSettings.getStringList(\"consul.tags\"));\n     if (logLevelOverrideExtension != null) {\n       tags.add(LOG_LEVEL_OVERRIDE_EXTENSION_TAG);\n     }\n \n-    ImmutableRegCheck regCheck = ImmutableRegCheck.builder()\n-            .http(\"http://\" + applicationHost + \":\" + applicationPort + \"/status\")\n-            .interval(requireNonNullElse(fileSettings.getString(\"consul.check.interval\"), \"5s\"))\n-            .timeout(requireNonNullElse(fileSettings.getString(\"consul.check.timeout\"), \"5s\"))\n-            .build();\n+    Registration.RegCheck regCheck = ImmutableRegCheck.builder()\n+        .http(\"http://\" + applicationHost + \":\" + applicationPort + \"/status\")\n+        .interval(fileSettings.getString(\"consul.check.interval\", \"5s\"))\n+        .timeout(fileSettings.getString(\"consul.check.timeout\", \"5s\"))\n+        .deregisterCriticalServiceAfter(fileSettings.getString(\"consul.deregisterCritical.timeout\", \"10m\"))\n+        .successBeforePassing(fileSettings.getInteger(\"consul.check.successCount\", 2))\n+        .failuresBeforeCritical(fileSettings.getInteger(\"consul.check.failCount\", 2))\n+        .build();\n+    Optional<String> weight = getWeight(hostName);\n+    int weightForService;\n+    if (weight.isPresent()) {\n+      weightForService = weight.map(Integer::parseInt).get();\n+    } else {\n+      LOGGER.warn(\"No weight present for node:{}\", hostName);\n+      weightForService = DEFAULT_WEIGHT;\n+    }\n+\n+    ServiceWeights serviceWeights = ImmutableServiceWeights.builder().passing(weightForService).warning(weightForService / 3).build();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA0MjM5Mw=="}, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1NzIwMjk5OnYy", "diffSide": "RIGHT", "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNToyMzo1M1rOHgsVlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwOTozMDo1NlrOHhKcjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA0MjkwMg==", "bodyText": "\u0442\u0430\u043c \u0449\u0430\u0441 \u043f\u043e \u0434\u0435\u0444\u043e\u043b\u0442\u0443 1 \u0436\u0435?\n\u043c\u043e\u0436\u0435\u0442 \u0441\u0434\u0435\u043b\u0430\u0442\u044c \u0431\u0435\u0437 \u0434\u0435\u0444\u043e\u043b\u0442\u043d\u043e\u0433\u043e \u0432\u0435\u0441\u0430? \u043d\u0443 \u0442\u0438\u043f\u0430 \u043f\u0440\u043e\u0441\u0442\u043e \u043d\u0435 \u0440\u0435\u0433\u0430\u0435\u043c \u0432\u0435\u0441, \u0435\u0441\u043b\u0438 \u0435\u0433\u043e \u043d\u0435\u0442?", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504042902", "createdAt": "2020-10-13T15:23:53Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -23,38 +25,57 @@\n   private static final Logger LOGGER = LoggerFactory.getLogger(ConsulService.class);\n \n   private static final String LOG_LEVEL_OVERRIDE_EXTENSION_TAG = \"log_level_override_extension_enabled\";\n+  private static final int DEFAULT_WEIGHT = 100;\n \n   private final AgentClient agentClient;\n+  private final KeyValueClient kvClient;\n   private final Registration service;\n   private final String id;\n   private final boolean enabled;\n \n-  public ConsulService(AgentClient agentClient, FileSettings fileSettings, String datacenter, String host, AppMetadata appMetadata,\n-                       @Nullable LogLevelOverrideExtension logLevelOverrideExtension) {\n+  public ConsulService(AgentClient agentClient, KeyValueClient kvClient,\n+                              FileSettings fileSettings, String datacenter, String hostName, AppMetadata appMetadata,\n+                              @Nullable LogLevelOverrideExtension logLevelOverrideExtension) {\n     this.agentClient = agentClient;\n+    this.kvClient = kvClient;\n+\n     var applicationPort = fileSettings.getInteger(\"jetty.port\");\n     var applicationHost = Optional.ofNullable(fileSettings.getString(\"consul.check.host\"))\n-      .orElse(\"127.0.0.1\");\n-    var id = fileSettings.getString(\"serviceName\") + \"-\" + datacenter + \"-\" + host + \"-\" + applicationPort;\n+        .orElse(\"127.0.0.1\");\n+    var id = fileSettings.getString(\"serviceName\") + \"-\" + datacenter + \"-\" + hostName + \"-\" + applicationPort;\n     var tags = new ArrayList<>(fileSettings.getStringList(\"consul.tags\"));\n     if (logLevelOverrideExtension != null) {\n       tags.add(LOG_LEVEL_OVERRIDE_EXTENSION_TAG);\n     }\n \n-    ImmutableRegCheck regCheck = ImmutableRegCheck.builder()\n-            .http(\"http://\" + applicationHost + \":\" + applicationPort + \"/status\")\n-            .interval(requireNonNullElse(fileSettings.getString(\"consul.check.interval\"), \"5s\"))\n-            .timeout(requireNonNullElse(fileSettings.getString(\"consul.check.timeout\"), \"5s\"))\n-            .build();\n+    Registration.RegCheck regCheck = ImmutableRegCheck.builder()\n+        .http(\"http://\" + applicationHost + \":\" + applicationPort + \"/status\")\n+        .interval(fileSettings.getString(\"consul.check.interval\", \"5s\"))\n+        .timeout(fileSettings.getString(\"consul.check.timeout\", \"5s\"))\n+        .deregisterCriticalServiceAfter(fileSettings.getString(\"consul.deregisterCritical.timeout\", \"10m\"))\n+        .successBeforePassing(fileSettings.getInteger(\"consul.check.successCount\", 2))\n+        .failuresBeforeCritical(fileSettings.getInteger(\"consul.check.failCount\", 2))\n+        .build();\n+    Optional<String> weight = getWeight(hostName);\n+    int weightForService;\n+    if (weight.isPresent()) {\n+      weightForService = weight.map(Integer::parseInt).get();\n+    } else {\n+      LOGGER.warn(\"No weight present for node:{}\", hostName);\n+      weightForService = DEFAULT_WEIGHT;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzNjIwNw==", "bodyText": "\u043f\u043e \u0434\u0435\u0444\u043e\u043b\u0442\u0443 \u0443 \u043a\u043e\u043d\u0441\u0443\u043b\u0430 \u0441\u043e\u0442\u043a\u0430, \u0434\u0430.\n\u0421\u0430\u0448\u0430 \u0441\u043a\u0430\u0437\u0430\u043b \u043d\u0430\u0448\u0438\u043c \u043f\u043e \u0434\u0435\u0444\u043e\u0442\u043b\u0443 \u043f\u043e\u0441\u0442\u0430\u0432\u0438\u0442\u044c \u0441\u043e\u0442\u043a\u0443.", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504536207", "createdAt": "2020-10-14T09:30:56Z", "author": {"login": "heruv1m"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -23,38 +25,57 @@\n   private static final Logger LOGGER = LoggerFactory.getLogger(ConsulService.class);\n \n   private static final String LOG_LEVEL_OVERRIDE_EXTENSION_TAG = \"log_level_override_extension_enabled\";\n+  private static final int DEFAULT_WEIGHT = 100;\n \n   private final AgentClient agentClient;\n+  private final KeyValueClient kvClient;\n   private final Registration service;\n   private final String id;\n   private final boolean enabled;\n \n-  public ConsulService(AgentClient agentClient, FileSettings fileSettings, String datacenter, String host, AppMetadata appMetadata,\n-                       @Nullable LogLevelOverrideExtension logLevelOverrideExtension) {\n+  public ConsulService(AgentClient agentClient, KeyValueClient kvClient,\n+                              FileSettings fileSettings, String datacenter, String hostName, AppMetadata appMetadata,\n+                              @Nullable LogLevelOverrideExtension logLevelOverrideExtension) {\n     this.agentClient = agentClient;\n+    this.kvClient = kvClient;\n+\n     var applicationPort = fileSettings.getInteger(\"jetty.port\");\n     var applicationHost = Optional.ofNullable(fileSettings.getString(\"consul.check.host\"))\n-      .orElse(\"127.0.0.1\");\n-    var id = fileSettings.getString(\"serviceName\") + \"-\" + datacenter + \"-\" + host + \"-\" + applicationPort;\n+        .orElse(\"127.0.0.1\");\n+    var id = fileSettings.getString(\"serviceName\") + \"-\" + datacenter + \"-\" + hostName + \"-\" + applicationPort;\n     var tags = new ArrayList<>(fileSettings.getStringList(\"consul.tags\"));\n     if (logLevelOverrideExtension != null) {\n       tags.add(LOG_LEVEL_OVERRIDE_EXTENSION_TAG);\n     }\n \n-    ImmutableRegCheck regCheck = ImmutableRegCheck.builder()\n-            .http(\"http://\" + applicationHost + \":\" + applicationPort + \"/status\")\n-            .interval(requireNonNullElse(fileSettings.getString(\"consul.check.interval\"), \"5s\"))\n-            .timeout(requireNonNullElse(fileSettings.getString(\"consul.check.timeout\"), \"5s\"))\n-            .build();\n+    Registration.RegCheck regCheck = ImmutableRegCheck.builder()\n+        .http(\"http://\" + applicationHost + \":\" + applicationPort + \"/status\")\n+        .interval(fileSettings.getString(\"consul.check.interval\", \"5s\"))\n+        .timeout(fileSettings.getString(\"consul.check.timeout\", \"5s\"))\n+        .deregisterCriticalServiceAfter(fileSettings.getString(\"consul.deregisterCritical.timeout\", \"10m\"))\n+        .successBeforePassing(fileSettings.getInteger(\"consul.check.successCount\", 2))\n+        .failuresBeforeCritical(fileSettings.getInteger(\"consul.check.failCount\", 2))\n+        .build();\n+    Optional<String> weight = getWeight(hostName);\n+    int weightForService;\n+    if (weight.isPresent()) {\n+      weightForService = weight.map(Integer::parseInt).get();\n+    } else {\n+      LOGGER.warn(\"No weight present for node:{}\", hostName);\n+      weightForService = DEFAULT_WEIGHT;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA0MjkwMg=="}, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1NzIyMTEzOnYy", "diffSide": "RIGHT", "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNToyNzoxNlrOHgsglQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwOTozMjoxOVrOHhKfww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA0NTcxNw==", "bodyText": "\u041a\u0430\u043a-\u0442\u043e \u0441\u0442\u0440\u0430\u043d\u043d\u043e \u043e\u0442\u0441\u0442\u0443\u043f\u044b \u0440\u0430\u0437\u044a\u0435\u0445\u0430\u043b\u0438\u0441\u044c", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504045717", "createdAt": "2020-10-13T15:27:16Z", "author": {"login": "pvorlov"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -23,38 +25,57 @@\n   private static final Logger LOGGER = LoggerFactory.getLogger(ConsulService.class);\n \n   private static final String LOG_LEVEL_OVERRIDE_EXTENSION_TAG = \"log_level_override_extension_enabled\";\n+  private static final int DEFAULT_WEIGHT = 100;\n \n   private final AgentClient agentClient;\n+  private final KeyValueClient kvClient;\n   private final Registration service;\n   private final String id;\n   private final boolean enabled;\n \n-  public ConsulService(AgentClient agentClient, FileSettings fileSettings, String datacenter, String host, AppMetadata appMetadata,\n-                       @Nullable LogLevelOverrideExtension logLevelOverrideExtension) {\n+  public ConsulService(AgentClient agentClient, KeyValueClient kvClient,\n+                              FileSettings fileSettings, String datacenter, String hostName, AppMetadata appMetadata,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzNzAyNw==", "bodyText": "\u043f\u043e\u043f\u0440\u0430\u0432\u043b\u044e", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504537027", "createdAt": "2020-10-14T09:32:19Z", "author": {"login": "heruv1m"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -23,38 +25,57 @@\n   private static final Logger LOGGER = LoggerFactory.getLogger(ConsulService.class);\n \n   private static final String LOG_LEVEL_OVERRIDE_EXTENSION_TAG = \"log_level_override_extension_enabled\";\n+  private static final int DEFAULT_WEIGHT = 100;\n \n   private final AgentClient agentClient;\n+  private final KeyValueClient kvClient;\n   private final Registration service;\n   private final String id;\n   private final boolean enabled;\n \n-  public ConsulService(AgentClient agentClient, FileSettings fileSettings, String datacenter, String host, AppMetadata appMetadata,\n-                       @Nullable LogLevelOverrideExtension logLevelOverrideExtension) {\n+  public ConsulService(AgentClient agentClient, KeyValueClient kvClient,\n+                              FileSettings fileSettings, String datacenter, String hostName, AppMetadata appMetadata,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA0NTcxNw=="}, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1NzI1NDAxOnYy", "diffSide": "RIGHT", "path": "pom.xml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNTozMjowOFrOHgs0XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwOTozMDoxOFrOHhKbAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA1MDc4MQ==", "bodyText": "\u042f \u0434\u0443\u043c\u0430\u044e \u043f\u0440\u0438 \u043e\u0434\u043d\u043e\u0439 \u0432\u0435\u0440\u0441\u0438\u0438 \u043e\u0442 orbitz \u043c\u043e\u0436\u0435\u0442 \u0431\u044b\u0442\u044c \u043d\u0435\u0441\u043a\u043e\u043b\u044c\u043a\u043e \u0432\u0435\u0440\u0441\u0438\u0439 hh, \u043c\u043e\u0436\u0435\u0442 \u0447\u0442\u043e-\u0442\u043e \u0432\u0440\u043e\u0434\u0435 1.4.0.hh.1.0?", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504050781", "createdAt": "2020-10-13T15:32:08Z", "author": {"login": "pvorlov"}, "path": "pom.xml", "diffHunk": "@@ -44,7 +44,7 @@\n         <jclient.version>1.7.5</jclient.version>\n         <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>\n         <java.version>11</java.version>\n-        <orbitz.consul.version>1.4.0</orbitz.consul.version>\n+        <orbitz.consul.version>1.4.0-hh</orbitz.consul.version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUzNTgwOQ==", "bodyText": "\u0434\u0430\u0432\u0430\u0439 \u0442\u0430\u043a", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504535809", "createdAt": "2020-10-14T09:30:18Z", "author": {"login": "heruv1m"}, "path": "pom.xml", "diffHunk": "@@ -44,7 +44,7 @@\n         <jclient.version>1.7.5</jclient.version>\n         <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>\n         <java.version>11</java.version>\n-        <orbitz.consul.version>1.4.0</orbitz.consul.version>\n+        <orbitz.consul.version>1.4.0-hh</orbitz.consul.version>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA1MDc4MQ=="}, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4275, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}