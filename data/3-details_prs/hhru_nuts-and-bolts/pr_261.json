{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5NTAxODc2", "number": 261, "title": "HH-115630 migrate consul to orbitz", "bodyText": "", "createdAt": "2020-09-04T09:30:14Z", "url": "https://github.com/hhru/nuts-and-bolts/pull/261", "merged": true, "mergeCommit": {"oid": "b747817b07359c6622030cd88639483a56aac5cf"}, "closed": true, "closedAt": "2020-09-08T09:15:25Z", "author": {"login": "heruv1m"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFhzSygH2gAyNDc5NTAxODc2OmE0NzZmMjhlNTFhMjg5NGYxNDM5NjhlOWQzNzcwZGI5ZmEzZGZiZDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGz3sHAH2gAyNDc5NTAxODc2OmZkMGFmOTk2NmEwNjJmMGMwOGIzZWQ4ZDBiY2EzZTUwMmUzNGRmZDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a476f28e51a2894f143968e9d3770db9fa3dfbd3", "author": {"user": {"login": "heruv1m", "name": "Alexander Kazantsev"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/a476f28e51a2894f143968e9d3770db9fa3dfbd3", "committedDate": "2020-09-04T09:29:45Z", "message": "HH-115630 migrate consul to orbitz"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNTA5MDE5", "url": "https://github.com/hhru/nuts-and-bolts/pull/261#pullrequestreview-482509019", "createdAt": "2020-09-04T09:37:50Z", "commit": {"oid": "a476f28e51a2894f143968e9d3770db9fa3dfbd3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNjQ5NDQy", "url": "https://github.com/hhru/nuts-and-bolts/pull/261#pullrequestreview-483649442", "createdAt": "2020-09-07T16:04:34Z", "commit": {"oid": "a476f28e51a2894f143968e9d3770db9fa3dfbd3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNjowNDozNFrOHOD90A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNjowNDozNFrOHOD90A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUwNzA4OA==", "bodyText": "\u0420\u0430\u0437 \u0442\u0435\u043f\u0435\u0440\u044c \u044d\u0442\u043e \u0431\u0438\u043d, \u0442\u043e \u0434\u0443\u043c\u0430\u044e \u044d\u0442\u043e\u0442 \u0433\u0435\u0442\u0442\u0435\u0440 \u0431\u0435\u0441\u0441\u043c\u044b\u0441\u043b\u0435\u043d\u0435\u043d. \u0410 \u0447\u0442\u043e \u0434\u0435\u043b\u0430\u0442\u044c \u0435\u0441\u043b\u0438 \u0441\u0435\u0440\u0432\u0438\u0441\u0430\u043c \u043f\u043e\u043d\u0430\u0434\u043e\u0431\u044f\u0442\u0441\u044f \u0434\u0440\u0443\u0433\u0438\u0435 \u043a\u043b\u0438\u0435\u043d\u0442\u044b? ConsulClient \u043e\u0442 ecwid \u043e\u0431\u044a\u0435\u0434\u0438\u043d\u044f\u043b \u0438\u0445 \u0444\u0430\u043a\u0442\u0438\u0447\u0435\u0441\u043a\u0438. logginig-configurator \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442 catalog client. \u041e\u0431\u043d\u043e\u0432\u0438\u0442\u044c\u0441\u044f \u043d\u0430 \u044d\u0442\u0443 \u0432\u0435\u0440\u0441\u0438\u044e \u043d\u0435 \u043f\u043e\u043b\u0443\u0447\u0438\u0442\u0441\u044f, \u043f\u0440\u0438\u0434\u0451\u0442\u0441\u044f \u0441\u043d\u0430\u0447\u0430\u043b\u0430 \u043f\u0438\u0441\u0430\u0442\u044c \u043a\u043e\u0434 \u0432 nab \u043f\u043e\u0442\u043e\u043c \u043e\u0431\u043d\u043e\u0432\u043b\u044f\u0442\u044c \u0441\u0435\u0440\u0432\u0438\u0441. \u041a\u0430\u043a-\u0442\u043e \u0448\u0430\u0442\u043a\u043e \u043f\u043e\u043b\u0443\u0447\u0438\u043b\u043e\u0441\u044c.", "url": "https://github.com/hhru/nuts-and-bolts/pull/261#discussion_r484507088", "createdAt": "2020-09-07T16:04:34Z", "author": {"login": "pvorlov"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -37,39 +40,39 @@ public ConsulService(FileSettings fileSettings, String datacenter, String addres\n       tags.add(LOG_LEVEL_OVERRIDE_EXTENSION_TAG);\n     }\n \n-    NewService.Check check = new NewService.Check();\n-    check.setHttp(\"http://\" + applicationHost + \":\" + applicationPort + \"/status\");\n-    check.setTimeout(fileSettings.getString(\"consul.check.timeout\"));\n-    check.setInterval(fileSettings.getString(\"consul.check.interval\"));\n-    check.setMethod(\"GET\");\n-    check.setStatus(\"passing\");\n-\n-    NewService service = new NewService();\n-    service.setId(id);\n-    service.setName(fileSettings.getString(\"serviceName\"));\n-    service.setPort(applicationPort);\n-    service.setAddress(address);\n-    service.setCheck(check);\n-    service.setTags(tags);\n-    service.setMeta(Collections.singletonMap(\"serviceVersion\", appMetadata.getVersion()));\n-\n-    this.client = new ConsulClient(\n-      Optional.ofNullable(fileSettings.getString(\"consul.http.host\")).orElse(\"127.0.0.1\"),\n-      fileSettings.getInteger(\"consul.http.port\")\n-    );\n+    ImmutableRegCheck regCheck = ImmutableRegCheck.builder()\n+            .http(\"http://\" + applicationHost + \":\" + applicationPort + \"/status\")\n+            .interval(fileSettings.getString(\"consul.check.interval\"))\n+            .timeout(fileSettings.getString(\"consul.check.timeout\"))\n+            .build();\n+\n+    Registration service = ImmutableRegistration.builder()\n+            .id(id)\n+            .name(fileSettings.getString(\"serviceName\"))\n+            .port(applicationPort)\n+            .address(address)\n+\n+            .check(regCheck)\n+\n+            .tags(tags)\n+            .meta(Collections.singletonMap(\"serviceVersion\", appMetadata.getVersion()))\n+\n+            .build();\n+    agentClient.register(service);\n+\n     this.service = service;\n     this.id = id;\n     this.enabled = Optional.ofNullable(fileSettings.getBoolean(\"consul.enabled\")).orElse(true);\n   }\n \n-  public ConsulClient getClient() {\n-    return client;\n+  public AgentClient getClient() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a476f28e51a2894f143968e9d3770db9fa3dfbd3"}, "originalPosition": 96}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa988d3e7fab5acc48c5a28c42fc40dda59f5d6f", "author": {"user": {"login": "heruv1m", "name": "Alexander Kazantsev"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/aa988d3e7fab5acc48c5a28c42fc40dda59f5d6f", "committedDate": "2020-09-08T07:44:51Z", "message": "HH-115630 remove getClient"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzOTE3MDM4", "url": "https://github.com/hhru/nuts-and-bolts/pull/261#pullrequestreview-483917038", "createdAt": "2020-09-08T08:38:26Z", "commit": {"oid": "aa988d3e7fab5acc48c5a28c42fc40dda59f5d6f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd0af9966a062f0c08b3ed8d0bca3e502e34dfd5", "author": {"user": {"login": "heruv1m", "name": "Alexander Kazantsev"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/fd0af9966a062f0c08b3ed8d0bca3e502e34dfd5", "committedDate": "2020-09-08T09:06:46Z", "message": "HH-115630 fix tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3337, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}