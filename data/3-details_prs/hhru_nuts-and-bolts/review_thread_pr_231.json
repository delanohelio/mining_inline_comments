{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MTEyNTYz", "number": 231, "reviewThreads": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjoxNzoyMFrODrnkAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNDoxMzo1NlrODssWAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MDYzNTU0OnYy", "diffSide": "RIGHT", "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjoxNzoyMFrOF8EHwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMzowMzo1OFrOF8F1oA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUyNjQwMg==", "bodyText": "\u043e\u043d \u0447\u0442\u043e-\u0442\u043e \u043a\u0438\u0434\u0430\u0435\u0442, \u0435\u0441\u043b\u0438 \u043d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c?", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r398526402", "createdAt": "2020-03-26T12:17:20Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -57,11 +57,14 @@ public ConsulClient getClient() {\n     return client;\n   }\n \n-  @PostConstruct\n   void register() {\n     if (enabled) {\n-      client.agentServiceRegister(service);\n-      logger.info(\"Registered service: {} to consul\", service);\n+      try {\n+        client.agentServiceRegister(service);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a1a0600cfa9327d3a0491178f2d25d19d04fab"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU0NDI2Nw==", "bodyText": "TransportException, OperationException \u043c\u043e\u0436\u0435\u0442 \u0435\u0449\u0435 \u0447\u0442\u043e \u0442\u043e", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r398544267", "createdAt": "2020-03-26T12:47:40Z", "author": {"login": "heruv1m"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -57,11 +57,14 @@ public ConsulClient getClient() {\n     return client;\n   }\n \n-  @PostConstruct\n   void register() {\n     if (enabled) {\n-      client.agentServiceRegister(service);\n-      logger.info(\"Registered service: {} to consul\", service);\n+      try {\n+        client.agentServiceRegister(service);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUyNjQwMg=="}, "originalCommit": {"oid": "89a1a0600cfa9327d3a0491178f2d25d19d04fab"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU1NDUyOA==", "bodyText": "\u043d\u0443 \u0432 \u043e\u0431\u0449\u0435\u043c \u0442\u0435\u0441\u0442 \u043d\u0430\u0434\u043e)", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r398554528", "createdAt": "2020-03-26T13:03:58Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -57,11 +57,14 @@ public ConsulClient getClient() {\n     return client;\n   }\n \n-  @PostConstruct\n   void register() {\n     if (enabled) {\n-      client.agentServiceRegister(service);\n-      logger.info(\"Registered service: {} to consul\", service);\n+      try {\n+        client.agentServiceRegister(service);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUyNjQwMg=="}, "originalCommit": {"oid": "89a1a0600cfa9327d3a0491178f2d25d19d04fab"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MDY0Mjc3OnYy", "diffSide": "RIGHT", "path": "nab-starter/src/main/java/ru/hh/nab/starter/NabProdConfig.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjoxOToxNFrOF8EMGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjo0OTowMlrOF8FQ8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUyNzUxNQ==", "bodyText": "\u0430 \u0447\u0435 \u043d\u0435 jettyEventListener?", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r398527515", "createdAt": "2020-03-26T12:19:14Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/NabProdConfig.java", "diffHunk": "@@ -60,4 +60,9 @@ ConsulService consulService(FileSettings fileSettings, String datacenter, AppMet\n     var address = InetAddress.getLocalHost().getHostAddress();\n     return new ConsulService(fileSettings, datacenter, address, appMetadata);\n   }\n+\n+  @Bean\n+  JettyEventListener customSpringEventListener(ConsulService consulService){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a1a0600cfa9327d3a0491178f2d25d19d04fab"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU0NTEzOA==", "bodyText": "\u0438\u0441\u043f\u0440\u0430\u0432\u043b\u044e", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r398545138", "createdAt": "2020-03-26T12:49:02Z", "author": {"login": "heruv1m"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/NabProdConfig.java", "diffHunk": "@@ -60,4 +60,9 @@ ConsulService consulService(FileSettings fileSettings, String datacenter, AppMet\n     var address = InetAddress.getLocalHost().getHostAddress();\n     return new ConsulService(fileSettings, datacenter, address, appMetadata);\n   }\n+\n+  @Bean\n+  JettyEventListener customSpringEventListener(ConsulService consulService){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUyNzUxNQ=="}, "originalCommit": {"oid": "89a1a0600cfa9327d3a0491178f2d25d19d04fab"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MDY0NDk4OnYy", "diffSide": "RIGHT", "path": "nab-starter/src/main/java/ru/hh/nab/starter/JettyEventListener.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjoxOTo0OFrOF8ENcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMzowMzo0NFrOF8F0_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUyNzg1OQ==", "bodyText": "\u043c\u0431 \u0443\u0431\u0440\u0430\u0442\u044c \u0432\u0441\u0435 \u043f\u0440\u043e \u044d\u0432\u0435\u043d\u0442\u044b \u0432 events?", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r398527859", "createdAt": "2020-03-26T12:19:48Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/JettyEventListener.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package ru.hh.nab.starter;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a1a0600cfa9327d3a0491178f2d25d19d04fab"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU0Njc1OQ==", "bodyText": "\u043b\u0438\u0441\u043d\u0435\u0440 \u0441\u043f\u0440\u0438\u043d\u0433\u043e\u0432\u044b\u0439 \u043f\u043e\u0436\u0430\u043b\u0443\u0439 \u0434\u0430, \u0430 \u0434\u0436\u0435\u0442\u0435\u0432\u0441\u043a\u0438\u0439 \u044f \u0431\u044b \u0432 \u043f\u0430\u043a\u0435\u0442\u0435 \u0434\u0436\u0435\u0442\u0442\u0438 \u043e\u0441\u0442\u0430\u0432\u0438\u043b. \u041a\u0430\u0436\u0435\u0442\u0441\u044f \u0431\u043b\u0438\u0436\u0435", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r398546759", "createdAt": "2020-03-26T12:51:32Z", "author": {"login": "heruv1m"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/JettyEventListener.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package ru.hh.nab.starter;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUyNzg1OQ=="}, "originalCommit": {"oid": "89a1a0600cfa9327d3a0491178f2d25d19d04fab"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU1NDM2Nw==", "bodyText": "\u043e\u043a", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r398554367", "createdAt": "2020-03-26T13:03:44Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/JettyEventListener.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package ru.hh.nab.starter;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUyNzg1OQ=="}, "originalCommit": {"oid": "89a1a0600cfa9327d3a0491178f2d25d19d04fab"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MDY1ODk2OnYy", "diffSide": "RIGHT", "path": "nab-starter/src/main/java/ru/hh/nab/starter/server/jetty/JettyServerFactory.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjoyNDowMFrOF8EWag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNDoxNToxOVrOF8I-AQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUzMDE1NA==", "bodyText": "\u043c\u043d\u0435 \u043d\u0435 \u043e\u0447\u0435\u043d\u044c \u043d\u0440\u0430\u0432\u0438\u0442\u0441\u044f, \u0447\u0442\u043e \u0441\u043e\u0431\u044b\u0442\u0438\u044f \u043e\u0442\u0434\u0435\u043b\u044c\u043d\u043e \u043e\u0442 webappinitializer \u0438\u0434\u0443\u0442. \u044d\u0442\u043e \u043f\u043e \u0438\u0434\u0435\u0435 \u0442\u043e\u0442 \u0441\u0430\u043c\u044b\u0439 \u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442, \u043a\u043e\u0442\u043e\u0440\u044b\u0439 \u0440\u0443\u043b\u0438\u0442 \u0438\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u0435\u0439. \u043e\u043d \u0432\u0440\u043e\u0434\u0435 \u0431\u044b \u0437\u043d\u0430\u0435\u0442 \u0443\u0436\u0435 \u043f\u0440\u043e \u043a\u043e\u043d\u0442\u0435\u043a\u0441\u0442 \u0438 \u0432\u0441\u044e \u043a\u0443\u0445\u043d\u044e. \u0432\u043e\u0442 \u0435\u043c\u0443 \u0431\u044b \u0432\u0441\u0435\u043c\u0438 \u044d\u0442\u0438\u043c\u0438 \u043b\u0438\u0441\u0442\u0435\u043d\u0435\u0440\u0430\u043c\u0438 \u0438 \u0437\u0430\u043d\u044f\u0442\u044c\u0441\u044f", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r398530154", "createdAt": "2020-03-26T12:24:00Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/server/jetty/JettyServerFactory.java", "diffHunk": "@@ -15,10 +16,11 @@\n \n   private static final int DEFAULT_IDLE_TIMEOUT_MS = (int) Duration.ofMinutes(1).toMillis();\n \n-  public static JettyServer create(FileSettings fileSettings, ThreadPool threadPool, WebAppInitializer webAppInitializer) {\n+  public static JettyServer create(FileSettings fileSettings, ThreadPool threadPool, WebAppInitializer webAppInitializer,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a1a0600cfa9327d3a0491178f2d25d19d04fab"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU4MjQwNg==", "bodyText": "\u0442\u0443\u0442 \u043f\u0440\u043e\u0431\u043b\u0435\u043c\u0430. WebAppContext \u0441\u0442\u0430\u0440\u0442\u0443\u0435\u0442 \u0440\u0430\u043d\u044c\u0448\u0435 \u0441\u0435\u0440\u0432\u0435\u0440\u0430, \u0437\u0430\u043f\u0440\u043e\u0441 \u043d\u0435 \u043f\u0440\u043e\u0445\u043e\u0434\u0438\u0442 \u0432 \u044d\u0442\u043e\u0442 \u043c\u043e\u043c\u0435\u043d\u0442. \u0421\u0435\u0440\u0432\u0435\u0440\u0430 \u0443 \u043d\u0435\u0433\u043e \u043d\u0435\u0442. \u041f\u043e\u043a\u0430\u043f\u0430\u044e\u0441\u044c \u0435\u0449\u0435 \u0432 \u0436\u0438\u0437\u043d\u0435\u043d\u043d\u043e\u043c \u0446\u0438\u043a\u043b\u0435", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r398582406", "createdAt": "2020-03-26T13:44:44Z", "author": {"login": "heruv1m"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/server/jetty/JettyServerFactory.java", "diffHunk": "@@ -15,10 +16,11 @@\n \n   private static final int DEFAULT_IDLE_TIMEOUT_MS = (int) Duration.ofMinutes(1).toMillis();\n \n-  public static JettyServer create(FileSettings fileSettings, ThreadPool threadPool, WebAppInitializer webAppInitializer) {\n+  public static JettyServer create(FileSettings fileSettings, ThreadPool threadPool, WebAppInitializer webAppInitializer,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUzMDE1NA=="}, "originalCommit": {"oid": "89a1a0600cfa9327d3a0491178f2d25d19d04fab"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODYwNTgyNQ==", "bodyText": "\u043d\u0443 \u0442\u0435\u0431\u0435 \u043f\u043e \u0438\u0434\u0435\u0435 \u0434\u043b\u044f \u043f\u0440\u043e\u043a\u0438\u0434\u044b\u0432\u0430\u043d\u0438\u044f \u043b\u0438\u0441\u0442\u0435\u043d\u0435\u0440\u0430 \u0432 \u0434\u0436\u0435\u0442\u0442\u0438 \u043d\u0443\u0436\u0435\u043d \u043d\u0435 \u0441\u0435\u0440\u0432\u0435\u0440, \u0430 \u0432\u0435\u0431\u0430\u043f\u043f \u0432 \u0441\u0435\u0440\u0432\u0435\u0440\u0435,\n\u043a\u043e\u0442\u043e\u0440\u044b\u0439 https://github.com/hhru/nuts-and-bolts/pull/231/files#diff-c5eb530aea50eff731d8d64f2fb9ee4cR130\n\u0442\u0430\u043c \u043a\u0430\u043a \u0440\u0430\u0437 \u0443\u0436\u0435 \u043f\u043e\u0445\u043e\u0436\u0438\u0439 \u043a\u043e\u0434 \u043d\u0430\u043f\u0438\u0441\u0430\u043d \u043f\u0440\u043e \u0441\u043e\u0431\u044b\u0442\u0438\u044f) \u043a\u0430\u0436\u0435\u0442\u0441\u044f, \u0447\u0442\u043e \u043c\u043e\u0436\u043d\u043e \u0431\u044b\u043b\u043e \u0431\u044b \u0442\u0443\u0434\u0430 \u0438 \u043d\u043e\u0432\u044b\u0439 \u043b\u0438\u0441\u0442\u0435\u043d\u0435\u0440 \u0441\u043b\u043e\u0436\u0438\u0442\u044c, \u0430 \u0432 \u0441\u0430\u043c \u0441\u0435\u0440\u0432\u0435\u0440 \u043a\u0430\u043a \u0438 \u0440\u0430\u043d\u044c\u0448\u0435 \u043f\u0435\u0440\u0435\u0434\u0430\u0432\u0430\u0442\u044c \u0442\u043e\u043b\u044c\u043a\u043e \u0445\u043e\u043b\u0434\u0435\u0440", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r398605825", "createdAt": "2020-03-26T14:15:19Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/server/jetty/JettyServerFactory.java", "diffHunk": "@@ -15,10 +16,11 @@\n \n   private static final int DEFAULT_IDLE_TIMEOUT_MS = (int) Duration.ofMinutes(1).toMillis();\n \n-  public static JettyServer create(FileSettings fileSettings, ThreadPool threadPool, WebAppInitializer webAppInitializer) {\n+  public static JettyServer create(FileSettings fileSettings, ThreadPool threadPool, WebAppInitializer webAppInitializer,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUzMDE1NA=="}, "originalCommit": {"oid": "89a1a0600cfa9327d3a0491178f2d25d19d04fab"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MDY2MDM3OnYy", "diffSide": "RIGHT", "path": "nab-starter/src/main/java/ru/hh/nab/starter/server/jetty/JettyLifeCycleListener.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjoyNDoyNFrOF8EXUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjo1Mzo1NlrOF8FdMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUzMDM4NA==", "bodyText": "\u0442\u0430\u043c \u0432\u0440\u043e\u0434\u0435 \u0431\u044b\u043b \u0430\u0431\u0441\u0442\u0440\u0430\u043a\u0442\u043d\u044b\u0439 \u043a\u043b\u0430\u0441\u0441", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r398530384", "createdAt": "2020-03-26T12:24:24Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/server/jetty/JettyLifeCycleListener.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package ru.hh.nab.starter.server.jetty;\n+\n+import org.eclipse.jetty.util.component.LifeCycle;\n+import org.springframework.context.ApplicationEventPublisher;\n+import ru.hh.nab.starter.JettyStartedEvent;\n+\n+public class JettyLifeCycleListener implements LifeCycle.Listener {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a1a0600cfa9327d3a0491178f2d25d19d04fab"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODU0ODI3Mw==", "bodyText": "\u0443\u0433\u0443, \u043f\u043e\u0442\u0435\u0440 \u043b\u0438\u0448\u043d\u0435\u0435", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r398548273", "createdAt": "2020-03-26T12:53:56Z", "author": {"login": "heruv1m"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/server/jetty/JettyLifeCycleListener.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package ru.hh.nab.starter.server.jetty;\n+\n+import org.eclipse.jetty.util.component.LifeCycle;\n+import org.springframework.context.ApplicationEventPublisher;\n+import ru.hh.nab.starter.JettyStartedEvent;\n+\n+public class JettyLifeCycleListener implements LifeCycle.Listener {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUzMDM4NA=="}, "originalCommit": {"oid": "89a1a0600cfa9327d3a0491178f2d25d19d04fab"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3NTc4NDcxOnYy", "diffSide": "RIGHT", "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNToxNDo0MVrOF81rLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNDo0MToyNFrOF9tGgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzODI4Ng==", "bodyText": "\u0437\u0430\u0447\u0435\u043c?", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399338286", "createdAt": "2020-03-27T15:14:41Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -45,8 +45,8 @@ public ConsulService(FileSettings fileSettings, String datacenter, String addres\n     service.setMeta(Collections.singletonMap(\"serviceVersion\", appMetadata.getVersion()));\n \n     this.client = new ConsulClient(\n-      Optional.ofNullable(fileSettings.getString(\"consul.http.host\")).orElse(\"127.0.0.1\"),\n-      fileSettings.getInteger(\"consul.http.port\")\n+            Optional.ofNullable(fileSettings.getString(\"consul.http.host\")).orElse(\"127.0.0.1\"),\n+            Optional.ofNullable(fileSettings.getInteger(\"consul.http.port\")).orElse(8300)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2OTc0Nw==", "bodyText": "\u0435\u0441\u043b\u0438 \u0443 \u0442\u0435\u0431\u044f \u043d\u0435 \u0443\u043a\u0430\u0437\u0430\u043d \u043f\u043e\u0440\u0442 \u0432 \u0431\u043e\u044e, \u043d\u0430\u0434\u043e \u0431\u044b \u043f\u0430\u0434\u0430\u0442\u044c. \u0435\u0441\u043b\u0438 \u043d\u0430\u0434\u043e \u0432 \u0442\u0435\u0441\u0442\u0430\u0445, \u0442\u043e \u043b\u0443\u0447\u0448\u0435 \u0440\u0435\u0448\u0438\u0442\u044c \u0437\u0430 \u0441\u0447\u0435\u0442 \u043e\u0432\u0435\u0440\u0440\u0430\u0439\u0434\u0430 \u043f\u0440\u043e\u043f\u0435\u0440\u0442\u0435\u0439", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399369747", "createdAt": "2020-03-27T15:59:17Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -45,8 +45,8 @@ public ConsulService(FileSettings fileSettings, String datacenter, String addres\n     service.setMeta(Collections.singletonMap(\"serviceVersion\", appMetadata.getVersion()));\n \n     this.client = new ConsulClient(\n-      Optional.ofNullable(fileSettings.getString(\"consul.http.host\")).orElse(\"127.0.0.1\"),\n-      fileSettings.getInteger(\"consul.http.port\")\n+            Optional.ofNullable(fileSettings.getString(\"consul.http.host\")).orElse(\"127.0.0.1\"),\n+            Optional.ofNullable(fileSettings.getInteger(\"consul.http.port\")).orElse(8300)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzODI4Ng=="}, "originalCommit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk5NTkyMA==", "bodyText": "\u0434\u0430 \u044f \u043f\u043e\u0434\u0443\u043c\u0430\u043b, \u0447\u0435\u043c \u043f\u043e\u0440\u0442 \u0445\u0443\u0436\u0435 \u0445\u043e\u0441\u0442\u0430.", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399995920", "createdAt": "2020-03-30T08:00:10Z", "author": {"login": "heruv1m"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -45,8 +45,8 @@ public ConsulService(FileSettings fileSettings, String datacenter, String addres\n     service.setMeta(Collections.singletonMap(\"serviceVersion\", appMetadata.getVersion()));\n \n     this.client = new ConsulClient(\n-      Optional.ofNullable(fileSettings.getString(\"consul.http.host\")).orElse(\"127.0.0.1\"),\n-      fileSettings.getInteger(\"consul.http.port\")\n+            Optional.ofNullable(fileSettings.getString(\"consul.http.host\")).orElse(\"127.0.0.1\"),\n+            Optional.ofNullable(fileSettings.getInteger(\"consul.http.port\")).orElse(8300)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzODI4Ng=="}, "originalCommit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIxODYzMw==", "bodyText": "\u043d\u0443 \u0438\u0437 \u0438\u043d\u0444\u0440\u0430\u0441\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u044b \u0441\u043b\u0435\u0434\u0443\u0435\u0442. \u0442\u0438\u043f\u0430 \u0434\u0435\u043c\u043e\u043d \u043a\u043e\u043d\u0441\u0443\u043b\u0430 \u0432\u0441\u0435\u0433\u0434\u0430 \u0441\u0442\u043e\u0438\u0442 \u043d\u0430 \u0445\u043e\u0441\u0442\u0435. \u0442.\u0435. \u044d\u0442\u043e bestpractice \u043a\u043e\u043d\u0441\u0443\u043b\u0430, \u0447\u0442\u043e\u0431\u044b \u0434\u0435\u043c\u043e\u043d \u0431\u044b\u043b \u043d\u0430 127.0.0.1. \u0430 \u0432\u043e\u0442 \u043f\u043e \u043f\u043e\u0440\u0442\u0443 - \u043d\u0438\u043a\u0430\u043a\u0438\u0445 bestpractice \u043d\u0435\u0442. \u043f\u043e\u044d\u0442\u043e\u043c\u0443", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r400218633", "createdAt": "2020-03-30T14:05:56Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -45,8 +45,8 @@ public ConsulService(FileSettings fileSettings, String datacenter, String addres\n     service.setMeta(Collections.singletonMap(\"serviceVersion\", appMetadata.getVersion()));\n \n     this.client = new ConsulClient(\n-      Optional.ofNullable(fileSettings.getString(\"consul.http.host\")).orElse(\"127.0.0.1\"),\n-      fileSettings.getInteger(\"consul.http.port\")\n+            Optional.ofNullable(fileSettings.getString(\"consul.http.host\")).orElse(\"127.0.0.1\"),\n+            Optional.ofNullable(fileSettings.getInteger(\"consul.http.port\")).orElse(8300)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzODI4Ng=="}, "originalCommit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI0NjQwMA==", "bodyText": "\u0443\u0431\u0435\u0440\u0443", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r400246400", "createdAt": "2020-03-30T14:41:24Z", "author": {"login": "heruv1m"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -45,8 +45,8 @@ public ConsulService(FileSettings fileSettings, String datacenter, String addres\n     service.setMeta(Collections.singletonMap(\"serviceVersion\", appMetadata.getVersion()));\n \n     this.client = new ConsulClient(\n-      Optional.ofNullable(fileSettings.getString(\"consul.http.host\")).orElse(\"127.0.0.1\"),\n-      fileSettings.getInteger(\"consul.http.port\")\n+            Optional.ofNullable(fileSettings.getString(\"consul.http.host\")).orElse(\"127.0.0.1\"),\n+            Optional.ofNullable(fileSettings.getInteger(\"consul.http.port\")).orElse(8300)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzODI4Ng=="}, "originalCommit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3NTc5NDI3OnYy", "diffSide": "RIGHT", "path": "nab-starter/src/main/java/ru/hh/nab/starter/common/Visitor.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNToxNjo1MlrOF81xXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwOTo1ODozN1rOF9iQTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzOTg3MA==", "bodyText": "\u0447\u0435\u043c \u0442\u0435\u0431\u0435 Consumer \u043d\u0435 \u043d\u0440\u0430\u0432\u0438\u0442\u0441\u044f", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399339870", "createdAt": "2020-03-27T15:16:52Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/common/Visitor.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package ru.hh.nab.starter.common;\n+\n+public interface Visitor<T> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2MzA5MA==", "bodyText": "\u0438\u043b\u0438 \u0442\u043e\u0442 \u0436\u0435 WebAppInitializer - \u044d\u0442\u043e \u0436 \u043f\u0440\u044f\u043c \u043e\u043d)", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399363090", "createdAt": "2020-03-27T15:49:42Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/common/Visitor.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package ru.hh.nab.starter.common;\n+\n+public interface Visitor<T> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzOTg3MA=="}, "originalCommit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAxNDc4OA==", "bodyText": "\u043f\u0440\u043e \u043a\u043e\u043d\u0441\u044c\u044e\u043c\u0435\u0440 \u0437\u0430\u0431\u044b\u043b, \u0430 \u0441 \u0432\u0435\u0431 \u0438\u043d\u0438\u0446\u0438\u0430\u043b\u0430\u0439\u0437\u0435\u0440\u043e\u043c.. \u0421\u043f\u0438\u0441\u043e\u043a \u0442\u043e\u0433\u0434\u0430 \u0441\u0434\u0435\u043b\u0430\u044e, \u043e\u043a?\n\u041d\u0443 \u0432 \u0441\u043c\u044b\u0441\u043b\u0435 \u043b\u0438\u0441\u0442 WebAppInitializer", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r400014788", "createdAt": "2020-03-30T08:32:32Z", "author": {"login": "heruv1m"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/common/Visitor.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package ru.hh.nab.starter.common;\n+\n+public interface Visitor<T> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzOTg3MA=="}, "originalCommit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA1OTcwMQ==", "bodyText": "\u043d\u0443.. \u043c\u043e\u0436\u043d\u043e", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r400059701", "createdAt": "2020-03-30T09:44:15Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/common/Visitor.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package ru.hh.nab.starter.common;\n+\n+public interface Visitor<T> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzOTg3MA=="}, "originalCommit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA2ODY4Nw==", "bodyText": "\u0430 \u043a\u0430\u043a? \u041f\u043e\u0434\u043c\u0435\u043d\u0438\u0442\u044c \u0436\u0435 \u044f \u0435\u0433\u043e \u043d\u0435 \u043c\u043e\u0433\u0443, \u0441\u043a\u043b\u0435\u0438\u0442\u044c \u0442\u043e\u0436\u0435", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r400068687", "createdAt": "2020-03-30T09:58:37Z", "author": {"login": "heruv1m"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/common/Visitor.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package ru.hh.nab.starter.common;\n+\n+public interface Visitor<T> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzOTg3MA=="}, "originalCommit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3NTk0MDA4OnYy", "diffSide": "RIGHT", "path": "nab-starter/src/main/java/ru/hh/nab/starter/NabApplication.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNTo1MDowNlrOF83NHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwODozMzoxNlrOF9e_dQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2MzM1Ng==", "bodyText": "\u0447\u0442\u043e \u0442\u0430\u043a\u043e\u0435 v?", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399363356", "createdAt": "2020-03-27T15:50:06Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/NabApplication.java", "diffHunk": "@@ -68,27 +71,40 @@ public JettyServer run(WebApplicationContext baseContext,\n     try {\n       configureLogger();\n       configureSentry(baseContext);\n-      FileSettings fileSettings = baseContext.getBean(FileSettings.class);\n-      ThreadPool threadPool = baseContext.getBean(ThreadPool.class);\n-      WebAppInitializer webAppInitializer = createWebAppInitializer(servletContextConfig, baseContext, directlyUseAsWebAppRoot);\n-      JettyServer jettyServer = serverStarter.apply(port -> {\n-        FileSettings effectiveSettings = fileSettings;\n-        if (port != null) {\n-          Properties properties = fileSettings.getProperties();\n-          properties.setProperty(JETTY_PORT, String.valueOf(port));\n-          effectiveSettings = new FileSettings(properties);\n-        }\n-        JettyServer server = JettyServerFactory.create(effectiveSettings, threadPool, webAppInitializer);\n-        server.start();\n-        return server;\n-      });\n+      JettyServer jettyServer = createJettyServer(baseContext, directlyUseAsWebAppRoot, serverStarter,\n+              v->v.addLifeCycleListener(new JettyLifeCycleListener(baseContext)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2MzkxMg==", "bodyText": "\u0430 \u043c\u044b \u0440\u0430\u0437\u0432\u0435 \u043c\u043e\u0436\u0435\u043c \u0445\u043e\u0442\u044c \u043a\u043e\u0433\u0434\u0430-\u0442\u043e \u043d\u0435 \u0437\u0430\u0445\u043e\u0442\u0435\u0442\u044c \u0434\u043e\u0431\u0430\u0432\u043b\u044f\u0442\u044c listener - \u044f \u0431\u044b \u044d\u0442\u043e \u0443\u043d\u0435\u0441 \u043f\u0440\u044f\u043c \u0432 \u043e\u0441\u043d\u043e\u0432\u043d\u043e\u0439 webAppInitializer", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399363912", "createdAt": "2020-03-27T15:50:54Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/NabApplication.java", "diffHunk": "@@ -68,27 +71,40 @@ public JettyServer run(WebApplicationContext baseContext,\n     try {\n       configureLogger();\n       configureSentry(baseContext);\n-      FileSettings fileSettings = baseContext.getBean(FileSettings.class);\n-      ThreadPool threadPool = baseContext.getBean(ThreadPool.class);\n-      WebAppInitializer webAppInitializer = createWebAppInitializer(servletContextConfig, baseContext, directlyUseAsWebAppRoot);\n-      JettyServer jettyServer = serverStarter.apply(port -> {\n-        FileSettings effectiveSettings = fileSettings;\n-        if (port != null) {\n-          Properties properties = fileSettings.getProperties();\n-          properties.setProperty(JETTY_PORT, String.valueOf(port));\n-          effectiveSettings = new FileSettings(properties);\n-        }\n-        JettyServer server = JettyServerFactory.create(effectiveSettings, threadPool, webAppInitializer);\n-        server.start();\n-        return server;\n-      });\n+      JettyServer jettyServer = createJettyServer(baseContext, directlyUseAsWebAppRoot, serverStarter,\n+              v->v.addLifeCycleListener(new JettyLifeCycleListener(baseContext)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2MzM1Ng=="}, "originalCommit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAxNTIyMQ==", "bodyText": "\u0431\u0443\u0434\u0443 \u0431\u043e\u043b\u0435\u0435 \u0433\u043e\u0432\u043e\u0440\u044f\u0449\u0435 \u043e\u0431\u0437\u044b\u0432\u0430\u0442\u044c.\n\u0414\u043b\u044f \u0442\u0435\u0441\u0442\u043e\u0432 \u0432\u044b\u043d\u0435\u0441 \u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e\u0441\u0442\u044c \u0434\u043e\u0431\u0430\u0432\u0438\u0442\u044c \u0441\u043d\u0430\u0440\u0443\u0436\u0438", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r400015221", "createdAt": "2020-03-30T08:33:16Z", "author": {"login": "heruv1m"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/NabApplication.java", "diffHunk": "@@ -68,27 +71,40 @@ public JettyServer run(WebApplicationContext baseContext,\n     try {\n       configureLogger();\n       configureSentry(baseContext);\n-      FileSettings fileSettings = baseContext.getBean(FileSettings.class);\n-      ThreadPool threadPool = baseContext.getBean(ThreadPool.class);\n-      WebAppInitializer webAppInitializer = createWebAppInitializer(servletContextConfig, baseContext, directlyUseAsWebAppRoot);\n-      JettyServer jettyServer = serverStarter.apply(port -> {\n-        FileSettings effectiveSettings = fileSettings;\n-        if (port != null) {\n-          Properties properties = fileSettings.getProperties();\n-          properties.setProperty(JETTY_PORT, String.valueOf(port));\n-          effectiveSettings = new FileSettings(properties);\n-        }\n-        JettyServer server = JettyServerFactory.create(effectiveSettings, threadPool, webAppInitializer);\n-        server.start();\n-        return server;\n-      });\n+      JettyServer jettyServer = createJettyServer(baseContext, directlyUseAsWebAppRoot, serverStarter,\n+              v->v.addLifeCycleListener(new JettyLifeCycleListener(baseContext)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2MzM1Ng=="}, "originalCommit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3NTk0NTE5OnYy", "diffSide": "RIGHT", "path": "nab-starter/src/main/java/ru/hh/nab/starter/NabApplication.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNTo1MToxNVrOF83QLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwODozMzo1OVrOF9fBLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NDE0Mg==", "bodyText": "\u0437\u0430\u0447\u0435\u043c \u0435\u043c\u0443 \u0442\u043e\u0440\u0447\u0430\u0442\u044c \u043d\u0430\u0440\u0443\u0436\u0443?", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399364142", "createdAt": "2020-03-27T15:51:15Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/NabApplication.java", "diffHunk": "@@ -68,27 +71,40 @@ public JettyServer run(WebApplicationContext baseContext,\n     try {\n       configureLogger();\n       configureSentry(baseContext);\n-      FileSettings fileSettings = baseContext.getBean(FileSettings.class);\n-      ThreadPool threadPool = baseContext.getBean(ThreadPool.class);\n-      WebAppInitializer webAppInitializer = createWebAppInitializer(servletContextConfig, baseContext, directlyUseAsWebAppRoot);\n-      JettyServer jettyServer = serverStarter.apply(port -> {\n-        FileSettings effectiveSettings = fileSettings;\n-        if (port != null) {\n-          Properties properties = fileSettings.getProperties();\n-          properties.setProperty(JETTY_PORT, String.valueOf(port));\n-          effectiveSettings = new FileSettings(properties);\n-        }\n-        JettyServer server = JettyServerFactory.create(effectiveSettings, threadPool, webAppInitializer);\n-        server.start();\n-        return server;\n-      });\n+      JettyServer jettyServer = createJettyServer(baseContext, directlyUseAsWebAppRoot, serverStarter,\n+              v->v.addLifeCycleListener(new JettyLifeCycleListener(baseContext)));\n+      jettyServer.start();\n       logStartupInfo(baseContext);\n       return jettyServer;\n     } catch (Exception e) {\n       return logErrorAndExit(e, exitOnError);\n     }\n   }\n \n+  public JettyServer createJettyServer(WebApplicationContext baseContext,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0cbb59f4e0e8edd073713d12227544043cbeee9"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NDcwMg==", "bodyText": "\u043c\u0431 \u044d\u0442\u043e\u0442 \u043c\u0435\u0442\u043e\u0434 \u043f\u0435\u0440\u0435\u0433\u0440\u0443\u0437\u0438\u0442\u044c \u0431\u0435\u0437 webAppContextVisitor? \u0432 run \u043d\u0430\u043c \u0432\u0440\u043e\u0434\u0435 \u043d\u0438\u0447\u0435\u0433\u043e \u0442\u0430\u043a\u043e\u0433\u043e \u043d\u0435 \u043d\u0443\u0436\u043d\u043e. \u0430 \u043f\u043e\u043b\u043d\u0443\u044e \u0432\u0435\u0440\u0441\u0438\u044e \u0431\u0443\u0434\u0435\u043c \u0434\u0435\u0440\u0433\u0430\u0442\u044c \u0432 \u0442\u0435\u0441\u0442\u0430\u0445", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399364702", "createdAt": "2020-03-27T15:52:03Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/NabApplication.java", "diffHunk": "@@ -68,27 +71,40 @@ public JettyServer run(WebApplicationContext baseContext,\n     try {\n       configureLogger();\n       configureSentry(baseContext);\n-      FileSettings fileSettings = baseContext.getBean(FileSettings.class);\n-      ThreadPool threadPool = baseContext.getBean(ThreadPool.class);\n-      WebAppInitializer webAppInitializer = createWebAppInitializer(servletContextConfig, baseContext, directlyUseAsWebAppRoot);\n-      JettyServer jettyServer = serverStarter.apply(port -> {\n-        FileSettings effectiveSettings = fileSettings;\n-        if (port != null) {\n-          Properties properties = fileSettings.getProperties();\n-          properties.setProperty(JETTY_PORT, String.valueOf(port));\n-          effectiveSettings = new FileSettings(properties);\n-        }\n-        JettyServer server = JettyServerFactory.create(effectiveSettings, threadPool, webAppInitializer);\n-        server.start();\n-        return server;\n-      });\n+      JettyServer jettyServer = createJettyServer(baseContext, directlyUseAsWebAppRoot, serverStarter,\n+              v->v.addLifeCycleListener(new JettyLifeCycleListener(baseContext)));\n+      jettyServer.start();\n       logStartupInfo(baseContext);\n       return jettyServer;\n     } catch (Exception e) {\n       return logErrorAndExit(e, exitOnError);\n     }\n   }\n \n+  public JettyServer createJettyServer(WebApplicationContext baseContext,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NDE0Mg=="}, "originalCommit": {"oid": "b0cbb59f4e0e8edd073713d12227544043cbeee9"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAxNTY2Mw==", "bodyText": "\u0441\u0434\u0435\u043b\u0430\u044e \u0432\u043d\u0443\u0442\u0440\u0435\u043d\u043d\u0438\u0439 \u043c\u0435\u0442\u043e\u0434 \u0441 \u0441\u043e\u0437\u0434\u0430\u043d\u0438\u0435\u043c \u0438\u043d\u0438\u0446\u0438\u0430\u043b\u0430\u0439\u0437\u0435\u0440\u0430 \u043f\u043e \u0434\u0435\u0444\u043e\u043b\u0442\u0443", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r400015663", "createdAt": "2020-03-30T08:33:59Z", "author": {"login": "heruv1m"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/NabApplication.java", "diffHunk": "@@ -68,27 +71,40 @@ public JettyServer run(WebApplicationContext baseContext,\n     try {\n       configureLogger();\n       configureSentry(baseContext);\n-      FileSettings fileSettings = baseContext.getBean(FileSettings.class);\n-      ThreadPool threadPool = baseContext.getBean(ThreadPool.class);\n-      WebAppInitializer webAppInitializer = createWebAppInitializer(servletContextConfig, baseContext, directlyUseAsWebAppRoot);\n-      JettyServer jettyServer = serverStarter.apply(port -> {\n-        FileSettings effectiveSettings = fileSettings;\n-        if (port != null) {\n-          Properties properties = fileSettings.getProperties();\n-          properties.setProperty(JETTY_PORT, String.valueOf(port));\n-          effectiveSettings = new FileSettings(properties);\n-        }\n-        JettyServer server = JettyServerFactory.create(effectiveSettings, threadPool, webAppInitializer);\n-        server.start();\n-        return server;\n-      });\n+      JettyServer jettyServer = createJettyServer(baseContext, directlyUseAsWebAppRoot, serverStarter,\n+              v->v.addLifeCycleListener(new JettyLifeCycleListener(baseContext)));\n+      jettyServer.start();\n       logStartupInfo(baseContext);\n       return jettyServer;\n     } catch (Exception e) {\n       return logErrorAndExit(e, exitOnError);\n     }\n   }\n \n+  public JettyServer createJettyServer(WebApplicationContext baseContext,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NDE0Mg=="}, "originalCommit": {"oid": "b0cbb59f4e0e8edd073713d12227544043cbeee9"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3NTk2MTA0OnYy", "diffSide": "RIGHT", "path": "nab-tests/src/test/java/ru/hh/nab/starter/NabAppTestConfig.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNTo1NDo1NVrOF83aQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNDo0Mjo0MFrOF9tKhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NjcyMw==", "bodyText": "\u044d\u0442\u0430 \u0448\u0442\u0443\u043a\u0430 \u043f\u043e\u0436\u0430\u043b\u0443\u0439 \u0434\u043e\u043b\u0436\u043d\u0430 \u0431\u044b \u0438\u0437 CommonContext'\u0430 \u043f\u0440\u0438\u0435\u0437\u0436\u0430\u0442\u044c", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399366723", "createdAt": "2020-03-27T15:54:55Z", "author": {"login": "dzharikhin"}, "path": "nab-tests/src/test/java/ru/hh/nab/starter/NabAppTestConfig.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package ru.hh.nab.starter;\n+\n+import static org.mockito.Mockito.spy;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Import;\n+import ru.hh.nab.common.properties.FileSettings;\n+import ru.hh.nab.starter.events.JettyEventListener;\n+import ru.hh.nab.testbase.NabTestConfig;\n+\n+@Configuration\n+@Import({NabTestConfig.class})\n+public class NabAppTestConfig {\n+  @Bean\n+  ConsulService consulService(FileSettings fileSettings, AppMetadata appMetadata) {\n+    return spy(new ConsulService(fileSettings, null, null, appMetadata));\n+  }\n+\n+  @Bean\n+  JettyEventListener jettyEventListener(ConsulService consulService) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0cbb59f4e0e8edd073713d12227544043cbeee9"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAyMjY0OA==", "bodyText": "\u043a\u043e\u043c\u043c\u043e\u043d \u043a\u043e\u043d\u0444\u0438\u0433\u0430?\n\u043a\u043e\u043d\u0441\u0443\u043b \u0441\u0435\u0440\u0432\u0438\u0441 \u0441\u0435\u0439\u0447\u0430\u0441 \u0441\u043e\u0437\u0434\u0430\u0435\u0442\u0441\u044f \u0442\u0443\u0442 ru.hh.nab.starter.NabProdConfig\n\u0414\u0430 \u044d\u0442\u043e \u043f\u043e\u0436\u0430\u043b\u0443\u0439 \u0438 \u043f\u0440\u0430\u0432\u0438\u043b\u044c\u043d\u043e. \u041d\u0435\u0437\u0430\u0447\u0435\u043c \u0435\u0433\u043e \u0442\u0430\u0449\u0438\u0442\u044c \u0432\u043e \u0432\u0441\u0435 \u0442\u0435\u0441\u0442\u044b", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r400022648", "createdAt": "2020-03-30T08:45:33Z", "author": {"login": "heruv1m"}, "path": "nab-tests/src/test/java/ru/hh/nab/starter/NabAppTestConfig.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package ru.hh.nab.starter;\n+\n+import static org.mockito.Mockito.spy;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Import;\n+import ru.hh.nab.common.properties.FileSettings;\n+import ru.hh.nab.starter.events.JettyEventListener;\n+import ru.hh.nab.testbase.NabTestConfig;\n+\n+@Configuration\n+@Import({NabTestConfig.class})\n+public class NabAppTestConfig {\n+  @Bean\n+  ConsulService consulService(FileSettings fileSettings, AppMetadata appMetadata) {\n+    return spy(new ConsulService(fileSettings, null, null, appMetadata));\n+  }\n+\n+  @Bean\n+  JettyEventListener jettyEventListener(ConsulService consulService) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NjcyMw=="}, "originalCommit": {"oid": "b0cbb59f4e0e8edd073713d12227544043cbeee9"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE2MDc2MQ==", "bodyText": "\u043d\u0443 \u0432\u043e\u0442 \u0430 \u0437\u0430\u0447\u0435\u043c jettyEventListener \u0437\u0430\u0432\u0438\u0441\u0438\u0442 \u043e\u0442 ConsulService?)", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r400160761", "createdAt": "2020-03-30T12:43:48Z", "author": {"login": "dzharikhin"}, "path": "nab-tests/src/test/java/ru/hh/nab/starter/NabAppTestConfig.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package ru.hh.nab.starter;\n+\n+import static org.mockito.Mockito.spy;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Import;\n+import ru.hh.nab.common.properties.FileSettings;\n+import ru.hh.nab.starter.events.JettyEventListener;\n+import ru.hh.nab.testbase.NabTestConfig;\n+\n+@Configuration\n+@Import({NabTestConfig.class})\n+public class NabAppTestConfig {\n+  @Bean\n+  ConsulService consulService(FileSettings fileSettings, AppMetadata appMetadata) {\n+    return spy(new ConsulService(fileSettings, null, null, appMetadata));\n+  }\n+\n+  @Bean\n+  JettyEventListener jettyEventListener(ConsulService consulService) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NjcyMw=="}, "originalCommit": {"oid": "b0cbb59f4e0e8edd073713d12227544043cbeee9"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI0NzQyOQ==", "bodyText": "\u0434\u043e\u0433\u043e\u0432\u043e\u0440\u0438\u043b\u0438\u0441\u044c \u043f\u0435\u0440\u0435\u0438\u043c\u0435\u043d\u043e\u0432\u0430\u0442\u044c", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r400247429", "createdAt": "2020-03-30T14:42:40Z", "author": {"login": "heruv1m"}, "path": "nab-tests/src/test/java/ru/hh/nab/starter/NabAppTestConfig.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package ru.hh.nab.starter;\n+\n+import static org.mockito.Mockito.spy;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Import;\n+import ru.hh.nab.common.properties.FileSettings;\n+import ru.hh.nab.starter.events.JettyEventListener;\n+import ru.hh.nab.testbase.NabTestConfig;\n+\n+@Configuration\n+@Import({NabTestConfig.class})\n+public class NabAppTestConfig {\n+  @Bean\n+  ConsulService consulService(FileSettings fileSettings, AppMetadata appMetadata) {\n+    return spy(new ConsulService(fileSettings, null, null, appMetadata));\n+  }\n+\n+  @Bean\n+  JettyEventListener jettyEventListener(ConsulService consulService) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NjcyMw=="}, "originalCommit": {"oid": "b0cbb59f4e0e8edd073713d12227544043cbeee9"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3NTk2NTc2OnYy", "diffSide": "RIGHT", "path": "nab-tests/src/test/java/ru/hh/nab/starter/NabApplicationTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNTo1NjowMFrOF83dJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxMjoyMjo1NVrOF9nHKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NzQ2MQ==", "bodyText": "\u0412\u0440\u043e\u0434\u0435 \u0431\u044b \u0434\u043e\u0441\u0442\u0430\u0442\u043e\u0447\u043d\u043e Properties \u0431\u0438\u043d \u043e\u0431\u044a\u044f\u0432\u0438\u0442\u044c", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399367461", "createdAt": "2020-03-27T15:56:00Z", "author": {"login": "dzharikhin"}, "path": "nab-tests/src/test/java/ru/hh/nab/starter/NabApplicationTest.java", "diffHunk": "@@ -82,4 +133,18 @@ String failedBean() {\n       throw new RuntimeException(\"failed to load bean\");\n     }\n   }\n+\n+  @Configuration\n+  @Import(NabAppTestConfig.class)\n+  public static class BrokenConsul {\n+\n+    @Bean\n+    @Primary\n+    FileSettings fileSettings() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0cbb59f4e0e8edd073713d12227544043cbeee9"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE0ODI2NA==", "bodyText": "++", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r400148264", "createdAt": "2020-03-30T12:22:55Z", "author": {"login": "heruv1m"}, "path": "nab-tests/src/test/java/ru/hh/nab/starter/NabApplicationTest.java", "diffHunk": "@@ -82,4 +133,18 @@ String failedBean() {\n       throw new RuntimeException(\"failed to load bean\");\n     }\n   }\n+\n+  @Configuration\n+  @Import(NabAppTestConfig.class)\n+  public static class BrokenConsul {\n+\n+    @Bean\n+    @Primary\n+    FileSettings fileSettings() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NzQ2MQ=="}, "originalCommit": {"oid": "b0cbb59f4e0e8edd073713d12227544043cbeee9"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3NTk2OTQyOnYy", "diffSide": "RIGHT", "path": "nab-tests/src/test/java/ru/hh/nab/starter/NabApplicationTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNTo1Njo1NVrOF83fig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxMjozMzoyN1rOF9nfuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2ODA3NA==", "bodyText": "\u0447\u0442\u043e \u0442\u0430\u043a\u043e\u0435 mock \u0438 v?", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399368074", "createdAt": "2020-03-27T15:56:55Z", "author": {"login": "dzharikhin"}, "path": "nab-tests/src/test/java/ru/hh/nab/starter/NabApplicationTest.java", "diffHunk": "@@ -46,6 +58,45 @@ public void runShouldStartJetty() {\n     }\n   }\n \n+  @Test\n+  public void testRightStartupOrderForConsul() {\n+    AnnotationConfigWebApplicationContext aggregateCtx = new AnnotationConfigWebApplicationContext();\n+    aggregateCtx.register(NabAppTestConfig.class);\n+    aggregateCtx.refresh();\n+\n+    JettyLifeCycleListener lifeCycleListener = spy(new JettyLifeCycleListener(aggregateCtx));\n+\n+    NabApplication nabApplication = new NabApplication(new NabServletContextConfig());\n+    JettyServer jettyServer = nabApplication.createJettyServer(aggregateCtx,\n+            false,\n+            mock -> mock.apply(null),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0cbb59f4e0e8edd073713d12227544043cbeee9"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDE1NDU1NQ==", "bodyText": "\u043f\u0435\u0440\u0435\u0438\u043c\u0435\u043d\u043e\u0432\u0430\u043b", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r400154555", "createdAt": "2020-03-30T12:33:27Z", "author": {"login": "heruv1m"}, "path": "nab-tests/src/test/java/ru/hh/nab/starter/NabApplicationTest.java", "diffHunk": "@@ -46,6 +58,45 @@ public void runShouldStartJetty() {\n     }\n   }\n \n+  @Test\n+  public void testRightStartupOrderForConsul() {\n+    AnnotationConfigWebApplicationContext aggregateCtx = new AnnotationConfigWebApplicationContext();\n+    aggregateCtx.register(NabAppTestConfig.class);\n+    aggregateCtx.refresh();\n+\n+    JettyLifeCycleListener lifeCycleListener = spy(new JettyLifeCycleListener(aggregateCtx));\n+\n+    NabApplication nabApplication = new NabApplication(new NabServletContextConfig());\n+    JettyServer jettyServer = nabApplication.createJettyServer(aggregateCtx,\n+            false,\n+            mock -> mock.apply(null),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2ODA3NA=="}, "originalCommit": {"oid": "b0cbb59f4e0e8edd073713d12227544043cbeee9"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MTg5NDI0OnYy", "diffSide": "RIGHT", "path": "nab-starter/src/main/java/ru/hh/nab/starter/NabApplication.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNDoxMTo0OFrOF9rrrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNTowMzo0NFrOF9uLpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIyMzE0OA==", "bodyText": "\u043f\u043e\u0447\u0435\u043c\u0443 \u043e\u043f\u044f\u0442\u044c public?", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r400223148", "createdAt": "2020-03-30T14:11:48Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/NabApplication.java", "diffHunk": "@@ -68,27 +71,45 @@ public JettyServer run(WebApplicationContext baseContext,\n     try {\n       configureLogger();\n       configureSentry(baseContext);\n-      FileSettings fileSettings = baseContext.getBean(FileSettings.class);\n-      ThreadPool threadPool = baseContext.getBean(ThreadPool.class);\n-      WebAppInitializer webAppInitializer = createWebAppInitializer(servletContextConfig, baseContext, directlyUseAsWebAppRoot);\n-      JettyServer jettyServer = serverStarter.apply(port -> {\n-        FileSettings effectiveSettings = fileSettings;\n-        if (port != null) {\n-          Properties properties = fileSettings.getProperties();\n-          properties.setProperty(JETTY_PORT, String.valueOf(port));\n-          effectiveSettings = new FileSettings(properties);\n-        }\n-        JettyServer server = JettyServerFactory.create(effectiveSettings, threadPool, webAppInitializer);\n-        server.start();\n-        return server;\n-      });\n+      JettyServer jettyServer = createJettyServer(baseContext, directlyUseAsWebAppRoot, serverStarter);\n+      jettyServer.start();\n       logStartupInfo(baseContext);\n       return jettyServer;\n     } catch (Exception e) {\n       return logErrorAndExit(e, exitOnError);\n     }\n   }\n \n+  private JettyServer createJettyServer(WebApplicationContext baseContext,\n+                                       boolean directlyUseAsWebAppRoot,\n+                                       Function<Function<Integer, JettyServer>, JettyServer> serverStarter\n+  ) {\n+    return createJettyServer(baseContext, directlyUseAsWebAppRoot, serverStarter,\n+            webAppContext -> webAppContext.addLifeCycleListener(new JettyLifeCycleListener(baseContext)));\n+  }\n+\n+  public JettyServer createJettyServer(WebApplicationContext baseContext,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86d0846fb564fc499729d3afafd915ac36d694a2"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2NDEwMw==", "bodyText": "\u043f\u043e\u0441\u0442\u0430\u0432\u0438\u043b \u043f\u0435\u043a\u0435\u0434\u0436", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r400264103", "createdAt": "2020-03-30T15:03:44Z", "author": {"login": "heruv1m"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/NabApplication.java", "diffHunk": "@@ -68,27 +71,45 @@ public JettyServer run(WebApplicationContext baseContext,\n     try {\n       configureLogger();\n       configureSentry(baseContext);\n-      FileSettings fileSettings = baseContext.getBean(FileSettings.class);\n-      ThreadPool threadPool = baseContext.getBean(ThreadPool.class);\n-      WebAppInitializer webAppInitializer = createWebAppInitializer(servletContextConfig, baseContext, directlyUseAsWebAppRoot);\n-      JettyServer jettyServer = serverStarter.apply(port -> {\n-        FileSettings effectiveSettings = fileSettings;\n-        if (port != null) {\n-          Properties properties = fileSettings.getProperties();\n-          properties.setProperty(JETTY_PORT, String.valueOf(port));\n-          effectiveSettings = new FileSettings(properties);\n-        }\n-        JettyServer server = JettyServerFactory.create(effectiveSettings, threadPool, webAppInitializer);\n-        server.start();\n-        return server;\n-      });\n+      JettyServer jettyServer = createJettyServer(baseContext, directlyUseAsWebAppRoot, serverStarter);\n+      jettyServer.start();\n       logStartupInfo(baseContext);\n       return jettyServer;\n     } catch (Exception e) {\n       return logErrorAndExit(e, exitOnError);\n     }\n   }\n \n+  private JettyServer createJettyServer(WebApplicationContext baseContext,\n+                                       boolean directlyUseAsWebAppRoot,\n+                                       Function<Function<Integer, JettyServer>, JettyServer> serverStarter\n+  ) {\n+    return createJettyServer(baseContext, directlyUseAsWebAppRoot, serverStarter,\n+            webAppContext -> webAppContext.addLifeCycleListener(new JettyLifeCycleListener(baseContext)));\n+  }\n+\n+  public JettyServer createJettyServer(WebApplicationContext baseContext,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIyMzE0OA=="}, "originalCommit": {"oid": "86d0846fb564fc499729d3afafd915ac36d694a2"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MTkwMTUzOnYy", "diffSide": "RIGHT", "path": "nab-tests/src/test/java/ru/hh/nab/starter/NabApplicationTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNDoxMzoyMlrOF9rwOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNDo0MzoyOVrOF9tNEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIyNDMxNA==", "bodyText": "\u0447\u0438\u0441\u0442\u043e \u043d\u0430 \u0432\u043a\u0443\u0441 - \u043d\u0443 \u043b\u0438\u0431\u043e \u0443\u0436\u0435 \u043d\u0430 \u0443\u0440\u043e\u0432\u0435\u043d\u044c \u0441 JettyServer \u0441\u043a\u043e\u0431\u043a\u0443, \u043b\u0438\u0431\u043e \u043f\u043e-\u043f\u0438\u0442\u043e\u043d\u044f\u0447\u044c\u0438 \u0432 \u043a\u043e\u043d\u0435\u0446 \u043f\u0440\u0435\u0434\u044b\u0434\u0443\u0449\u0435\u0439 \u0441\u0442\u0440\u043e\u043a\u0438", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r400224314", "createdAt": "2020-03-30T14:13:22Z", "author": {"login": "dzharikhin"}, "path": "nab-tests/src/test/java/ru/hh/nab/starter/NabApplicationTest.java", "diffHunk": "@@ -46,6 +57,45 @@ public void runShouldStartJetty() {\n     }\n   }\n \n+  @Test\n+  public void testRightStartupOrderForConsul() {\n+    AnnotationConfigWebApplicationContext aggregateCtx = new AnnotationConfigWebApplicationContext();\n+    aggregateCtx.register(NabAppTestConfig.class);\n+    aggregateCtx.refresh();\n+\n+    JettyLifeCycleListener lifeCycleListener = spy(new JettyLifeCycleListener(aggregateCtx));\n+\n+    NabApplication nabApplication = new NabApplication(new NabServletContextConfig());\n+    JettyServer jettyServer = nabApplication.createJettyServer(aggregateCtx,\n+            false,\n+            portSupplier -> portSupplier.apply(null),\n+            webAppContext -> webAppContext.addLifeCycleListener(lifeCycleListener)\n+            );\n+\n+    ConsulService consulService = aggregateCtx.getBean(ConsulService.class);\n+\n+    jettyServer.start();\n+\n+    InOrder inOrder = inOrder(lifeCycleListener, consulService);\n+    inOrder.verify(lifeCycleListener).lifeCycleStarted(any());\n+    inOrder.verify(consulService).register();\n+  }\n+\n+  @Test(expected = ConsulServiceException.class)\n+  public void testFailWithoutConsul() {\n+    AnnotationConfigWebApplicationContext aggregateCtx = new AnnotationConfigWebApplicationContext();\n+    aggregateCtx.register(BrokenConsul.class);\n+    aggregateCtx.refresh();\n+\n+    JettyServer jettyServer = new NabApplication(new NabServletContextConfig()).createJettyServer(aggregateCtx,\n+            false,\n+            portSupplier -> portSupplier.apply(0),\n+            webAppContext -> webAppContext.addLifeCycleListener(new JettyLifeCycleListener(aggregateCtx))\n+            );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86d0846fb564fc499729d3afafd915ac36d694a2"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI0ODA4MA==", "bodyText": "\u043f\u0435\u0440\u0435\u043d\u0435\u0441", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r400248080", "createdAt": "2020-03-30T14:43:29Z", "author": {"login": "heruv1m"}, "path": "nab-tests/src/test/java/ru/hh/nab/starter/NabApplicationTest.java", "diffHunk": "@@ -46,6 +57,45 @@ public void runShouldStartJetty() {\n     }\n   }\n \n+  @Test\n+  public void testRightStartupOrderForConsul() {\n+    AnnotationConfigWebApplicationContext aggregateCtx = new AnnotationConfigWebApplicationContext();\n+    aggregateCtx.register(NabAppTestConfig.class);\n+    aggregateCtx.refresh();\n+\n+    JettyLifeCycleListener lifeCycleListener = spy(new JettyLifeCycleListener(aggregateCtx));\n+\n+    NabApplication nabApplication = new NabApplication(new NabServletContextConfig());\n+    JettyServer jettyServer = nabApplication.createJettyServer(aggregateCtx,\n+            false,\n+            portSupplier -> portSupplier.apply(null),\n+            webAppContext -> webAppContext.addLifeCycleListener(lifeCycleListener)\n+            );\n+\n+    ConsulService consulService = aggregateCtx.getBean(ConsulService.class);\n+\n+    jettyServer.start();\n+\n+    InOrder inOrder = inOrder(lifeCycleListener, consulService);\n+    inOrder.verify(lifeCycleListener).lifeCycleStarted(any());\n+    inOrder.verify(consulService).register();\n+  }\n+\n+  @Test(expected = ConsulServiceException.class)\n+  public void testFailWithoutConsul() {\n+    AnnotationConfigWebApplicationContext aggregateCtx = new AnnotationConfigWebApplicationContext();\n+    aggregateCtx.register(BrokenConsul.class);\n+    aggregateCtx.refresh();\n+\n+    JettyServer jettyServer = new NabApplication(new NabServletContextConfig()).createJettyServer(aggregateCtx,\n+            false,\n+            portSupplier -> portSupplier.apply(0),\n+            webAppContext -> webAppContext.addLifeCycleListener(new JettyLifeCycleListener(aggregateCtx))\n+            );", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIyNDMxNA=="}, "originalCommit": {"oid": "86d0846fb564fc499729d3afafd915ac36d694a2"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MTkwNDY1OnYy", "diffSide": "RIGHT", "path": "nab-tests/src/test/java/ru/hh/nab/starter/NabApplicationTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNDoxMzo1NlrOF9ryDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNDoxMzo1NlrOF9ryDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIyNDc4Mw==", "bodyText": "\u043f\u043e \u0438\u0434\u0435\u0435 \u043c\u043e\u0436\u043d\u043e \u0431\u0435\u0437 Primary - \u0442\u0432\u043e\u0439 \u043a\u043e\u043d\u0444\u0438\u0433 \u043f\u0435\u0440\u0435\u043a\u0440\u043e\u0435\u0442, \u0435\u0441\u043b\u0438 \u0431\u0438\u043d \u0442\u0430\u043a \u0436\u0435 \u043d\u0430\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f. \u043d\u043e \u0432\u043e\u0442 \u043e\u043d \u0447\u0435-\u0442\u043e \u043d\u0435 \u0442\u0430\u043a \u0436\u0435 \u043d\u0430\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u043f\u043e-\u043c\u043e\u0435\u043c\u0443", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r400224783", "createdAt": "2020-03-30T14:13:56Z", "author": {"login": "dzharikhin"}, "path": "nab-tests/src/test/java/ru/hh/nab/starter/NabApplicationTest.java", "diffHunk": "@@ -82,4 +132,17 @@ String failedBean() {\n       throw new RuntimeException(\"failed to load bean\");\n     }\n   }\n+\n+  @Configuration\n+  @Import(NabAppTestConfig.class)\n+  public static class BrokenConsul {\n+    @Bean\n+    @Primary", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86d0846fb564fc499729d3afafd915ac36d694a2"}, "originalPosition": 84}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4333, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}