{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5MDYyNzI5", "number": 253, "title": "HH-113801 improve support for multiple DBs", "bodyText": "", "createdAt": "2020-07-30T10:40:52Z", "url": "https://github.com/hhru/nuts-and-bolts/pull/253", "merged": true, "mergeCommit": {"oid": "7d2c7cc2d4b7b45eead4f6d04c1a50917acc09b9"}, "closed": true, "closedAt": "2020-08-03T11:17:18Z", "author": {"login": "dzharikhin"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc59MaeAH2gAyNDU5MDYyNzI5OjkxZWUwZTkxMjRmYmY3NWJmYTZjYWIyN2VkYjc0ZmMwOTIwNDhkNTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6CXMZAFqTQ1ODU3MzM0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "91ee0e9124fbf75bfa6cab27edb74fc092048d55", "author": {"user": {"login": "dzharikhin", "name": "Dmitriy Zharikhin"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/91ee0e9124fbf75bfa6cab27edb74fc092048d55", "committedDate": "2020-07-30T10:37:32Z", "message": "HH-113801 improve support for multiple DBs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b7be685bbf772abcc2df8e3962dde777c4b9772", "author": {"user": {"login": "pvorlov", "name": "Pavel Orlov"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/7b7be685bbf772abcc2df8e3962dde777c4b9772", "committedDate": "2020-07-30T10:47:18Z", "message": "HH-113801 add jackson to root dependencyManagement"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MzMzODQz", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#pullrequestreview-458333843", "createdAt": "2020-07-30T12:02:27Z", "commit": {"oid": "7b7be685bbf772abcc2df8e3962dde777c4b9772"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjowMjoyN1rOG5gCsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjowMjoyN1rOG5gCsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk0Njk5Mw==", "bodyText": "\u0412\u0441\u0435\u0433\u0434\u0430 \u0431\u044b\u043b \u043f\u0440\u043e\u0442\u0438\u0432 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u044f \u044d\u0442\u043e\u0439 \u0444\u0438\u0447\u0438 \u0441\u043f\u0440\u0438\u043d\u0433\u0430, \u044d\u0442\u043e \u0441\u043a\u043e\u0432\u044b\u0432\u0430\u0435\u0442 \u0440\u0430\u0437\u0440\u0430\u0431\u043e\u0442\u043a\u0443.\n\u0417\u0430\u0445\u043e\u0447\u0435\u0442 \u043d\u0430\u043f\u0440\u0438\u043c\u0435\u0440 \u043a\u0442\u043e-\u0442\u043e \u0441\u0434\u0435\u043b\u0430\u0442\u044c 2 \u0431\u0438\u043d\u0430 DataSourceContextTransactionManagerImpl \u0438 DataSourceContextTransactionManagerProxy \u0438 \u043d\u0430\u0431 \u0432\u0437\u043e\u0440\u0432\u0451\u0442\u0441\u044f.\n\u0414\u043b\u044f \u0442\u0430\u043a\u0438\u0445 \u0441\u043b\u0443\u0447\u0430\u0435\u0432 \u044f \u0431\u044b \u043b\u0438\u0431\u043e \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043b \u043a\u043b\u0430\u0441\u0441 \u043e\u0431\u0451\u0440\u0442\u043a\u0443, \u0432\u043e\u0437\u0432\u0440\u0430\u0449\u0430\u044e\u0449\u0438\u0439 Map'\u0443 \u043b\u0438\u0431\u043e \u0443\u0436 \u0435\u0441\u043b\u0438 \u0441\u043e\u0432\u0441\u0435\u043c \u0445\u043e\u0447\u0435\u0442\u0441\u044f \u0432 \u0442\u0430\u043a\u043e\u043c \u0441\u0438\u043d\u0442\u0430\u043a\u0441\u0438\u0441\u0435 \u043a\u0432\u0430\u043b\u0438\u0444\u0438\u043a\u0430\u0442\u043e\u0440.", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r462946993", "createdAt": "2020-07-30T12:02:27Z", "author": {"login": "pvorlov"}, "path": "nab-hibernate/src/main/java/ru/hh/nab/hibernate/NabHibernateCommonConfig.java", "diffHunk": "@@ -6,43 +6,55 @@\n import org.hibernate.SessionFactory;\n import org.hibernate.boot.registry.BootstrapServiceRegistryBuilder;\n import org.hibernate.integrator.spi.Integrator;\n+import org.springframework.context.ApplicationContext;\n import org.springframework.context.annotation.Bean;\n import org.springframework.context.annotation.Configuration;\n import org.springframework.context.annotation.EnableAspectJAutoProxy;\n import org.springframework.orm.hibernate5.HibernateTransactionManager;\n \n import javax.sql.DataSource;\n import java.util.Properties;\n+import java.util.function.Function;\n+import java.util.stream.Stream;\n+\n import org.springframework.transaction.annotation.EnableTransactionManagement;\n import ru.hh.nab.hibernate.transaction.DataSourceContextTransactionManager;\n import ru.hh.nab.hibernate.transaction.ExecuteOnDataSourceAspect;\n import ru.hh.nab.hibernate.transaction.TransactionalScope;\n \n+import static java.util.stream.Collectors.toMap;\n+\n @Configuration\n @EnableTransactionManagement(order = 0)\n @EnableAspectJAutoProxy\n public class NabHibernateCommonConfig {\n \n   @Bean\n-  DataSourceContextTransactionManager transactionManager(SessionFactory sessionFactory, DataSource routingDataSource) {\n+  DataSourceContextTransactionManager transactionManager(SessionFactory sessionFactory, DataSource dataSource) {\n     HibernateTransactionManager simpleTransactionManager = new HibernateTransactionManager(sessionFactory);\n-    simpleTransactionManager.setDataSource(routingDataSource);\n+    simpleTransactionManager.setDataSource(dataSource);\n     return new DataSourceContextTransactionManager(simpleTransactionManager);\n   }\n \n   @Bean\n-  ExecuteOnDataSourceAspect executeOnDataSourceAspect(DataSourceContextTransactionManager transactionManager, SessionFactory sessionFactory) {\n-    return new ExecuteOnDataSourceAspect(transactionManager, sessionFactory);\n+  ExecuteOnDataSourceAspect executeOnDataSourceAspect(ApplicationContext applicationContext) {\n+    var txManagers\n+      = Stream.of(applicationContext.getBeanNamesForType(DataSourceContextTransactionManager.class))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b7be685bbf772abcc2df8e3962dde777c4b9772"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MzYxMDM3", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#pullrequestreview-458361037", "createdAt": "2020-07-30T12:41:26Z", "commit": {"oid": "6ce06f3a920178b26a15eaecf5d7cb39af003379"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjo0MToyNlrOG5hQ-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjo0MToyNlrOG5hQ-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2NzAzNQ==", "bodyText": "\u0412 \u0434\u043e\u043a\u0435 \u043d\u0430\u043f\u0438\u0441\u0430\u043d\u043e, \u0447\u0442\u043e \u043e\u043d \u0430\u043a\u0442\u0438\u0432\u0438\u0440\u043e\u0432\u0430\u043d \u043f\u043e \u0434\u0435\u0444\u043e\u043b\u0442\u0443. \u0414\u0443\u043c\u0430\u044e \u043c\u043e\u0436\u043d\u043e \u0443\u0431\u0440\u0430\u0442\u044c", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r462967035", "createdAt": "2020-07-30T12:41:26Z", "author": {"login": "pvorlov"}, "path": "nab-hibernate/src/main/java/ru/hh/nab/hibernate/NabHibernateCommonConfig.java", "diffHunk": "@@ -30,9 +30,9 @@\n public class NabHibernateCommonConfig {\n \n   @Bean\n-  DataSourceContextTransactionManager transactionManager(SessionFactory sessionFactory, DataSource dataSource) {\n+  DataSourceContextTransactionManager transactionManager(SessionFactory sessionFactory) {\n     HibernateTransactionManager simpleTransactionManager = new HibernateTransactionManager(sessionFactory);\n-    simpleTransactionManager.setDataSource(dataSource);\n+    simpleTransactionManager.setAutodetectDataSource(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ce06f3a920178b26a15eaecf5d7cb39af003379"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MzY3MjQ4", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#pullrequestreview-458367248", "createdAt": "2020-07-30T12:49:13Z", "commit": {"oid": "6ce06f3a920178b26a15eaecf5d7cb39af003379"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjo0OToxM1rOG5hiSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjo0OToxM1rOG5hiSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk3MTQ2Nw==", "bodyText": "\u0410 \u0434\u0430\u0432\u0430\u0439 \u043b\u0443\u0447\u0448\u0435 \u0432 \u043a\u043e\u043d\u0441\u0442\u0440\u0443\u043a\u0442\u043e\u0440\u0435 \u043f\u0440\u0438\u043d\u0438\u043c\u0430\u0442\u044c HibernateTransactionManager", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r462971467", "createdAt": "2020-07-30T12:49:13Z", "author": {"login": "pvorlov"}, "path": "nab-hibernate/src/main/java/ru/hh/nab/hibernate/transaction/DataSourceContextTransactionManager.java", "diffHunk": "@@ -19,6 +21,11 @@ public DataSourceContextTransactionManager(PlatformTransactionManager delegate)\n     this.delegate = delegate;\n   }\n \n+  //fuuuuuuck\n+  SessionFactory getSessionFactory() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ce06f3a920178b26a15eaecf5d7cb39af003379"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4Mzc1ODQz", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#pullrequestreview-458375843", "createdAt": "2020-07-30T13:00:15Z", "commit": {"oid": "6ce06f3a920178b26a15eaecf5d7cb39af003379"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMzowMDoxNVrOG5h7KA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMzowMDoxNVrOG5h7KA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk3NzgzMg==", "bodyText": "\u0427\u0442\u043e \u0432\u0441\u0451-\u0442\u0430\u043a\u0438 \u043f\u043e\u0434\u0440\u0430\u0437\u0443\u043c\u0435\u0432\u0430\u0435\u0442\u0441\u044f \u043f\u043e\u0434 \u043f\u0435\u0440\u0435\u0438\u043c\u0435\u043d\u043e\u0432\u0430\u043d\u0438\u0435\u043c? \u0427\u0442\u043e \u043c\u044b \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u043c \u043c\u0430\u0441\u0442\u0435\u0440 \u0438\u043b\u0438 \u0447\u0442\u043e \u0432 \u0441\u0435\u0440\u0441\u0438\u0441\u0430\u0445 \u043d\u0430\u0434\u043e \u0431\u0443\u0434\u0435\u0442 \u043f\u0435\u0440\u0435\u0438\u043c\u0435\u043d\u043e\u0432\u044b\u0432\u0430\u0442\u044c routingDataSource? \u0415\u0441\u043b\u0438 \u0432\u0442\u043e\u0440\u043e\u0435 \u0442\u043e \u0437\u0430\u0447\u0435\u043c?", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r462977832", "createdAt": "2020-07-30T13:00:15Z", "author": {"login": "pvorlov"}, "path": "nab-hibernate/src/main/java/ru/hh/nab/hibernate/NabHibernateCommonConfig.java", "diffHunk": "@@ -6,43 +6,52 @@\n import org.hibernate.SessionFactory;\n import org.hibernate.boot.registry.BootstrapServiceRegistryBuilder;\n import org.hibernate.integrator.spi.Integrator;\n+import org.springframework.context.ApplicationContext;\n import org.springframework.context.annotation.Bean;\n import org.springframework.context.annotation.Configuration;\n import org.springframework.context.annotation.EnableAspectJAutoProxy;\n import org.springframework.orm.hibernate5.HibernateTransactionManager;\n \n import javax.sql.DataSource;\n import java.util.Properties;\n+import java.util.function.Function;\n+import java.util.stream.Stream;\n+\n import org.springframework.transaction.annotation.EnableTransactionManagement;\n import ru.hh.nab.hibernate.transaction.DataSourceContextTransactionManager;\n import ru.hh.nab.hibernate.transaction.ExecuteOnDataSourceAspect;\n import ru.hh.nab.hibernate.transaction.TransactionalScope;\n \n+import static java.util.stream.Collectors.toMap;\n+\n @Configuration\n @EnableTransactionManagement(order = 0)\n @EnableAspectJAutoProxy\n public class NabHibernateCommonConfig {\n \n   @Bean\n-  DataSourceContextTransactionManager transactionManager(SessionFactory sessionFactory, DataSource routingDataSource) {\n+  DataSourceContextTransactionManager transactionManager(SessionFactory sessionFactory) {\n     HibernateTransactionManager simpleTransactionManager = new HibernateTransactionManager(sessionFactory);\n-    simpleTransactionManager.setDataSource(routingDataSource);\n+    simpleTransactionManager.setAutodetectDataSource(true);\n     return new DataSourceContextTransactionManager(simpleTransactionManager);\n   }\n \n   @Bean\n-  ExecuteOnDataSourceAspect executeOnDataSourceAspect(DataSourceContextTransactionManager transactionManager, SessionFactory sessionFactory) {\n-    return new ExecuteOnDataSourceAspect(transactionManager, sessionFactory);\n+  ExecuteOnDataSourceAspect executeOnDataSourceAspect(ApplicationContext applicationContext) {\n+    var txManagers\n+      = Stream.of(applicationContext.getBeanNamesForType(DataSourceContextTransactionManager.class))\n+        .collect(toMap(Function.identity(), beanName -> applicationContext.getBean(beanName, DataSourceContextTransactionManager.class)));\n+    return new ExecuteOnDataSourceAspect(txManagers);\n   }\n \n   @Bean\n-  NabSessionFactoryBean sessionFactoryBean(DataSource routingDataSource, Properties hibernateProperties,\n+  NabSessionFactoryBean sessionFactory(DataSource dataSource, Properties hibernateProperties,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ce06f3a920178b26a15eaecf5d7cb39af003379"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4Mzg0MTQw", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#pullrequestreview-458384140", "createdAt": "2020-07-30T13:10:26Z", "commit": {"oid": "6ce06f3a920178b26a15eaecf5d7cb39af003379"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMzoxMDoyNlrOG5iSXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMzoxMDoyNlrOG5iSXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk4Mzc3NQ==", "bodyText": "\u041d\u0435 \u043d\u0440\u0430\u0432\u0438\u0442\u0441\u044f \u043c\u043d\u0435 \u044d\u0442\u043e\u0442 default. \u0423\u0436 \u043b\u0443\u0447\u0448\u0435 \u0432\u043e\u043e\u0431\u0449\u0435 \u0431\u0435\u0437 \u043d\u0435\u0433\u043e \u0447\u0435\u043c \u043f\u043e\u043b\u0430\u0433\u0430\u0442\u044c\u0441\u044f \u043d\u0430 \u0441\u0442\u0440\u043e\u043a\u0438.\n\u0410 \u0447\u0442\u043e \u0435\u0441\u043b\u0438 \u043f\u043e\u043f\u0440\u043e\u0431\u043e\u0432\u0430\u0442\u044c \u0447\u0435\u0440\u0435\u0437 \u043a\u0432\u0430\u043b\u0438\u0444\u0438\u043a\u0430\u0442\u043e\u0440\u044b? \u0414\u043e\u043a\u0430 \u0434\u043b\u044f @ Transactional \u043f\u0438\u0448\u0435\u0442 \"matching the qualifier value (or the bean name)\"\n\u0415\u0441\u043b\u0438 \u0431\u0440\u0430\u0442\u044c \u0432 \u043f\u0440\u0438\u043c\u0435\u0440 negotiation \u0442\u043e \u043c\u043e\u0436\u043d\u043e \u0431\u044b\u043b\u043e \u0431\u044b \u043f\u043e\u043f\u0440\u043e\u0431\u043e\u0432\u0430\u0442\u044c \u0434\u043b\u044f \u0430\u043a\u0442\u0438\u0432\u043d\u044b\u0445 \u043f\u0435\u0440\u0435\u043f\u0438\u0441\u043e\u043a \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c \u0432\u0441\u0442\u0440\u043e\u0435\u043d\u043d\u044b\u0439 \u043a\u0432\u0430\u043b\u0438\u0444\u043a\u0430\u0442\u043e\u0440 @ Default \u0430 \u0434\u043b\u044f \u0430\u0440\u0445\u0438\u0432\u043d\u043e\u0433\u043e \u0437\u0430\u0432\u0435\u0441\u0442\u0438 \u0441\u0432\u043e\u0439.", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r462983775", "createdAt": "2020-07-30T13:10:26Z", "author": {"login": "pvorlov"}, "path": "nab-hibernate/src/main/java/ru/hh/nab/hibernate/transaction/ExecuteOnDataSource.java", "diffHunk": "@@ -25,4 +25,6 @@\n   boolean overrideByRequestScope() default false;\n \n   DataSourceCacheMode cacheMode() default DataSourceCacheMode.NORMAL;\n+\n+  String txManager() default \"transactionManager\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ce06f3a920178b26a15eaecf5d7cb39af003379"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "810aec83f2b322c9ee5f98b5405dec1b78ae8489", "author": {"user": {"login": "dzharikhin", "name": "Dmitriy Zharikhin"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/810aec83f2b322c9ee5f98b5405dec1b78ae8489", "committedDate": "2020-07-30T13:14:41Z", "message": "HH-113801 no need to set ds in txManager"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6ce06f3a920178b26a15eaecf5d7cb39af003379", "author": {"user": {"login": "dzharikhin", "name": "Dmitriy Zharikhin"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/6ce06f3a920178b26a15eaecf5d7cb39af003379", "committedDate": "2020-07-30T12:38:07Z", "message": "HH-113801 no need to set ds in txManager"}, "afterCommit": {"oid": "810aec83f2b322c9ee5f98b5405dec1b78ae8489", "author": {"user": {"login": "dzharikhin", "name": "Dmitriy Zharikhin"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/810aec83f2b322c9ee5f98b5405dec1b78ae8489", "committedDate": "2020-07-30T13:14:41Z", "message": "HH-113801 no need to set ds in txManager"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NDA1NDk4", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#pullrequestreview-458405498", "createdAt": "2020-07-30T13:35:20Z", "commit": {"oid": "810aec83f2b322c9ee5f98b5405dec1b78ae8489"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMzozNToyMFrOG5jSUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMzozNToyMFrOG5jSUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAwMDE0Ng==", "bodyText": "\u0414\u0430\u0432\u0430\u0439 \u0443\u0431\u0435\u0440\u0451\u043c \u0438 \u043e\u0441\u0442\u0430\u0432\u0438\u043c \u0434\u0435\u0444\u043e\u043b\u0442\u044b.\n\u0422\u0435 \u0443 \u043a\u043e\u0433\u043e 2 \u0434\u0430\u0442\u0430\u0441\u043e\u0440\u0441\u0430 \u043f\u0443\u0441\u0442\u044c \u0441\u0432\u043e\u0438 \u043a\u043b\u0430\u0441\u0441\u044b \u043f\u0438\u0448\u0443\u0442.", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463000146", "createdAt": "2020-07-30T13:35:20Z", "author": {"login": "pvorlov"}, "path": "nab-hibernate/src/main/java/ru/hh/nab/hibernate/transaction/TransactionalScope.java", "diffHunk": "@@ -5,22 +5,22 @@\n \n public class TransactionalScope {\n \n-  @Transactional(readOnly = true)\n+  @Transactional(value = \"transactionManager\", readOnly = true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "810aec83f2b322c9ee5f98b5405dec1b78ae8489"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NDA5Nzcx", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#pullrequestreview-458409771", "createdAt": "2020-07-30T13:40:10Z", "commit": {"oid": "810aec83f2b322c9ee5f98b5405dec1b78ae8489"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMzo0MDoxMFrOG5je_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMzo0MDoxMFrOG5je_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAwMzM5MA==", "bodyText": "\u0414\u0443\u043c\u0430\u044e \u043d\u0430\u0434\u043e \u043f\u0440\u0438\u0434\u0443\u0441\u043c\u043e\u0442\u0440\u0435\u0442\u044c \u0441\u043b\u0443\u0447\u0430\u0439 \u043a\u043e\u0433\u0434\u0430 txManager \u0432 \u0430\u043d\u043d\u043e\u0442\u0430\u0446\u0438\u0438 null \u0438\u043b\u0438 \u043f\u0443\u0441\u0442\u0430\u044f \u0441\u0442\u0440\u043e\u043a\u0430. \u042d\u0442\u043e \u043d\u0435 \u0431\u0443\u0434\u0435\u0442 \u0441\u043a\u043e\u0432\u044b\u0432\u0430\u0442\u044c \u043d\u0430\u0441 \u0432 \u043d\u0430\u0437\u0432\u0430\u043d\u0438\u0438 \u0431\u0438\u043d\u0430 \u0435\u0441\u043b\u0438 \u0432\u0441\u0435\u0433\u043e \u043e\u0434\u0438\u043d transactionManager, \u0447\u0442\u043e\u0431\u044b \u0440\u0430\u0431\u043e\u0442\u0430\u043b\u043e \u0430\u043d\u0430\u043b\u043e\u0433\u0438\u0447\u043d\u043e @ Transactional\n\u0415\u0441\u043b\u0438 \u043f\u0443\u0441\u0442\u0430\u044f \u0441\u0442\u0440\u043e\u043a\u0430 \u0438\u043b\u0438 null \u0438 \u0432 \u043c\u0430\u043f\u043a \u043e\u0434\u0438\u043d \u043c\u0435\u043d\u0435\u0434\u0436\u0435\u0440 - \u0431\u0435\u0440\u0451\u043c \u0435\u0433\u043e\n\u0418\u043d\u0430\u0447\u0435 exception", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463003390", "createdAt": "2020-07-30T13:40:10Z", "author": {"login": "pvorlov"}, "path": "nab-hibernate/src/main/java/ru/hh/nab/hibernate/transaction/ExecuteOnDataSourceAspect.java", "diffHunk": "@@ -27,13 +28,15 @@ public Object executeOnSpecialDataSource(final ProceedingJoinPoint pjp, final Ex\n         && TransactionSynchronizationManager.isSynchronizationActive()) {\n       return pjp.proceed();\n     }\n+    DataSourceContextTransactionManager transactionManager = txManagers.get(executeOnDataSource.txManager());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "810aec83f2b322c9ee5f98b5405dec1b78ae8489"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NDE2Nzgy", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#pullrequestreview-458416782", "createdAt": "2020-07-30T13:48:06Z", "commit": {"oid": "810aec83f2b322c9ee5f98b5405dec1b78ae8489"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMzo0ODowNlrOG5jz8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMzo0ODowNlrOG5jz8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAwODc1Mg==", "bodyText": "\u0420\u0430\u043d\u044c\u0448\u0435 \u043d\u0430\u0431 \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u043e\u043c \u0441\u043e\u0437\u0434\u0430\u0432\u0430\u043b transactionManager. \u0422\u0443\u043f\u0435\u0440\u044c \u0443 \u043d\u0430\u0441 \u0447\u0430\u0441\u0442\u044c \u0441\u043e\u0437\u0434\u0430\u0451\u0442 nab \u0430 \u0447\u0430\u0441\u0442\u044c \u0441\u043e\u0437\u0434\u0430\u0451\u0442 \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0435. \u042d\u0442\u043e \u0432\u0435\u0440\u0431\u043e\u0437\u043d\u043e \u0438 \u043d\u0435\u0443\u0434\u043e\u0431\u043d\u043e. \u0427\u0442\u043e \u0435\u0441\u043b\u0438 \u0441\u043e\u0437\u0434\u0430\u0432\u0430\u0442\u044c \u0434\u0438\u043d\u0430\u043c\u0438\u0447\u0435\u0441\u043a\u043e\u0435 \u043a\u043e\u043b\u0438\u0447\u0435\u0441\u0442\u0432\u043e \u0431\u0438\u043d\u043e\u0432 \u0447\u0435\u0440\u0435\u0437 BeanFactoryPostProcessor?", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463008752", "createdAt": "2020-07-30T13:48:06Z", "author": {"login": "pvorlov"}, "path": "nab-hibernate/src/main/java/ru/hh/nab/hibernate/NabHibernateCommonConfig.java", "diffHunk": "@@ -6,43 +6,52 @@\n import org.hibernate.SessionFactory;\n import org.hibernate.boot.registry.BootstrapServiceRegistryBuilder;\n import org.hibernate.integrator.spi.Integrator;\n+import org.springframework.context.ApplicationContext;\n import org.springframework.context.annotation.Bean;\n import org.springframework.context.annotation.Configuration;\n import org.springframework.context.annotation.EnableAspectJAutoProxy;\n import org.springframework.orm.hibernate5.HibernateTransactionManager;\n \n import javax.sql.DataSource;\n import java.util.Properties;\n+import java.util.function.Function;\n+import java.util.stream.Stream;\n+\n import org.springframework.transaction.annotation.EnableTransactionManagement;\n import ru.hh.nab.hibernate.transaction.DataSourceContextTransactionManager;\n import ru.hh.nab.hibernate.transaction.ExecuteOnDataSourceAspect;\n import ru.hh.nab.hibernate.transaction.TransactionalScope;\n \n+import static java.util.stream.Collectors.toMap;\n+\n @Configuration\n @EnableTransactionManagement(order = 0)\n @EnableAspectJAutoProxy\n public class NabHibernateCommonConfig {\n \n   @Bean\n-  DataSourceContextTransactionManager transactionManager(SessionFactory sessionFactory, DataSource routingDataSource) {\n+  DataSourceContextTransactionManager transactionManager(SessionFactory sessionFactory) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "810aec83f2b322c9ee5f98b5405dec1b78ae8489"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NDE4NjEw", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#pullrequestreview-458418610", "createdAt": "2020-07-30T13:50:11Z", "commit": {"oid": "810aec83f2b322c9ee5f98b5405dec1b78ae8489"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMzo1MDoxMlrOG5j5mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMzo1MDoxMlrOG5j5mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzAxMDIwMw==", "bodyText": "\u0414\u0443\u043c\u0430\u044e \u0432\u0441\u0435 sessionFactory \u0442\u043e\u0436\u0435 \u043d\u0430\u0434\u043e \u0441\u043e\u0437\u0434\u0430\u0432\u0430\u0442\u044c \u0434\u0438\u043d\u0430\u043c\u0438\u0447\u0435\u0441\u043a\u0438 \u0447\u0435\u0440\u0435\u0437 BeanFactoryPostProcessor \u0447\u0442\u043e\u0431\u044b \u0431\u044b\u043b\u043e \u043c\u0435\u043d\u044c\u0448\u0435 \u043a\u043e\u0434\u0430 \u0432 \u0441\u0435\u0440\u0432\u0438\u0441\u0430\u0445", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463010203", "createdAt": "2020-07-30T13:50:12Z", "author": {"login": "pvorlov"}, "path": "nab-hibernate/src/main/java/ru/hh/nab/hibernate/NabHibernateCommonConfig.java", "diffHunk": "@@ -6,43 +6,52 @@\n import org.hibernate.SessionFactory;\n import org.hibernate.boot.registry.BootstrapServiceRegistryBuilder;\n import org.hibernate.integrator.spi.Integrator;\n+import org.springframework.context.ApplicationContext;\n import org.springframework.context.annotation.Bean;\n import org.springframework.context.annotation.Configuration;\n import org.springframework.context.annotation.EnableAspectJAutoProxy;\n import org.springframework.orm.hibernate5.HibernateTransactionManager;\n \n import javax.sql.DataSource;\n import java.util.Properties;\n+import java.util.function.Function;\n+import java.util.stream.Stream;\n+\n import org.springframework.transaction.annotation.EnableTransactionManagement;\n import ru.hh.nab.hibernate.transaction.DataSourceContextTransactionManager;\n import ru.hh.nab.hibernate.transaction.ExecuteOnDataSourceAspect;\n import ru.hh.nab.hibernate.transaction.TransactionalScope;\n \n+import static java.util.stream.Collectors.toMap;\n+\n @Configuration\n @EnableTransactionManagement(order = 0)\n @EnableAspectJAutoProxy\n public class NabHibernateCommonConfig {\n \n   @Bean\n-  DataSourceContextTransactionManager transactionManager(SessionFactory sessionFactory, DataSource routingDataSource) {\n+  DataSourceContextTransactionManager transactionManager(SessionFactory sessionFactory) {\n     HibernateTransactionManager simpleTransactionManager = new HibernateTransactionManager(sessionFactory);\n-    simpleTransactionManager.setDataSource(routingDataSource);\n+    simpleTransactionManager.setAutodetectDataSource(true);\n     return new DataSourceContextTransactionManager(simpleTransactionManager);\n   }\n \n   @Bean\n-  ExecuteOnDataSourceAspect executeOnDataSourceAspect(DataSourceContextTransactionManager transactionManager, SessionFactory sessionFactory) {\n-    return new ExecuteOnDataSourceAspect(transactionManager, sessionFactory);\n+  ExecuteOnDataSourceAspect executeOnDataSourceAspect(ApplicationContext applicationContext) {\n+    var txManagers\n+      = Stream.of(applicationContext.getBeanNamesForType(DataSourceContextTransactionManager.class))\n+        .collect(toMap(Function.identity(), beanName -> applicationContext.getBean(beanName, DataSourceContextTransactionManager.class)));\n+    return new ExecuteOnDataSourceAspect(txManagers);\n   }\n \n   @Bean\n-  NabSessionFactoryBean sessionFactoryBean(DataSource routingDataSource, Properties hibernateProperties,\n+  NabSessionFactoryBean sessionFactory(DataSource dataSource, Properties hibernateProperties,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "810aec83f2b322c9ee5f98b5405dec1b78ae8489"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a17651f93eaf9529b6249384db68067460e61f1", "author": {"user": {"login": "dzharikhin", "name": "Dmitriy Zharikhin"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/9a17651f93eaf9529b6249384db68067460e61f1", "committedDate": "2020-07-30T14:31:12Z", "message": "HH-113801 aspect works with one txManager by default"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9581d54decfe6535ad4cdd5c60e4d778578d06a", "author": {"user": {"login": "dzharikhin", "name": "Dmitriy Zharikhin"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/f9581d54decfe6535ad4cdd5c60e4d778578d06a", "committedDate": "2020-07-30T14:57:21Z", "message": "HH-113801 if u wanna txBean in multi db - DIY"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a17e13e054d0d9047b24295129d7517bed42744a", "author": {"user": {"login": "dzharikhin", "name": "Dmitriy Zharikhin"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/a17e13e054d0d9047b24295129d7517bed42744a", "committedDate": "2020-07-30T14:57:01Z", "message": "HH-113801 if u wanna txBean in multi db - DIY"}, "afterCommit": {"oid": "f9581d54decfe6535ad4cdd5c60e4d778578d06a", "author": {"user": {"login": "dzharikhin", "name": "Dmitriy Zharikhin"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/f9581d54decfe6535ad4cdd5c60e4d778578d06a", "committedDate": "2020-07-30T14:57:21Z", "message": "HH-113801 if u wanna txBean in multi db - DIY"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NDg3Mzk1", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#pullrequestreview-458487395", "createdAt": "2020-07-30T15:01:06Z", "commit": {"oid": "9a17651f93eaf9529b6249384db68067460e61f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNTowMTowNlrOG5nEAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNTowMTowNlrOG5nEAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA2MjAxNg==", "bodyText": "\u0412\u043e\u0437\u043c\u043e\u0436\u043d\u043e \u043c\u044b\u0441\u043b\u044c \u043f\u043e\u0442\u0435\u0440\u044f\u043b\u0430\u0441\u044c \u0432 \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0445: \u0432\u043e\u0442 \u0442\u0443\u0442 \u044f @ Primary \u043f\u0440\u0435\u0434\u043b\u0430\u0433\u0430\u044e \u043d\u0430\u0432\u0435\u0441\u0438\u0442\u044c.\n\u0422\u043e\u0433\u0434\u0430 \u043c\u043e\u0436\u043d\u043e \u0443\u0431\u0440\u0430\u0442\u044c transactionManager \u0438\u0437 TransactionalScope\n\u041f\u043b\u044e\u0441 \u043d\u0435 \u043d\u0430\u0434\u043e \u0431\u0443\u0434\u0435\u0442 \u0435\u0441\u043b\u0438 \u043d\u0435\u0441\u043a\u043e\u043b\u044c\u043a\u043e \u0434\u0430\u0442\u0430\u0441\u043e\u0440\u0441\u043e\u0432 \u0443\u043a\u0430\u0437\u044b\u0432\u0430\u0442\u044c \u0434\u043b\u044f \u0434\u0435\u0444\u043e\u043b\u0442\u043e\u0432\u043e\u0433\u043e \u0432 \u043a\u0430\u0436\u0434\u043e\u043c @ transactional \u0434\u0435\u0444\u043e\u043b\u0442\u043e\u0432\u044b\u0439 TransactionManager", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#discussion_r463062016", "createdAt": "2020-07-30T15:01:06Z", "author": {"login": "pvorlov"}, "path": "nab-hibernate/src/main/java/ru/hh/nab/hibernate/NabHibernateCommonConfig.java", "diffHunk": "@@ -6,43 +6,52 @@\n import org.hibernate.SessionFactory;\n import org.hibernate.boot.registry.BootstrapServiceRegistryBuilder;\n import org.hibernate.integrator.spi.Integrator;\n+import org.springframework.context.ApplicationContext;\n import org.springframework.context.annotation.Bean;\n import org.springframework.context.annotation.Configuration;\n import org.springframework.context.annotation.EnableAspectJAutoProxy;\n import org.springframework.orm.hibernate5.HibernateTransactionManager;\n \n import javax.sql.DataSource;\n import java.util.Properties;\n+import java.util.function.Function;\n+import java.util.stream.Stream;\n+\n import org.springframework.transaction.annotation.EnableTransactionManagement;\n import ru.hh.nab.hibernate.transaction.DataSourceContextTransactionManager;\n import ru.hh.nab.hibernate.transaction.ExecuteOnDataSourceAspect;\n import ru.hh.nab.hibernate.transaction.TransactionalScope;\n \n+import static java.util.stream.Collectors.toMap;\n+\n @Configuration\n @EnableTransactionManagement(order = 0)\n @EnableAspectJAutoProxy\n public class NabHibernateCommonConfig {\n \n   @Bean", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a17651f93eaf9529b6249384db68067460e61f1"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f14ca190d1f67249a61713c6801abecf09b8e4f0", "author": {"user": {"login": "dzharikhin", "name": "Dmitriy Zharikhin"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/f14ca190d1f67249a61713c6801abecf09b8e4f0", "committedDate": "2020-07-30T15:10:45Z", "message": "HH-113801 bind to hibernate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "350d1517635c645c1c8d0dae9996e41ed47bffac", "author": {"user": {"login": "dzharikhin", "name": "Dmitriy Zharikhin"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/350d1517635c645c1c8d0dae9996e41ed47bffac", "committedDate": "2020-07-30T16:31:47Z", "message": "HH-113801 use primary as fallback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NTczMzQ1", "url": "https://github.com/hhru/nuts-and-bolts/pull/253#pullrequestreview-458573345", "createdAt": "2020-07-30T16:38:50Z", "commit": {"oid": "350d1517635c645c1c8d0dae9996e41ed47bffac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3324, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}