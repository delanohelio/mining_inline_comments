{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5OTQ1MDIw", "number": 276, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwNzoyMzowMVrOE5S6qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwNzozMjo1N1rOE5TEhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NTE0MjE4OnYy", "diffSide": "RIGHT", "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaConsumer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwNzoyMzowMlrOHzqnRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwNzozOToxMFrOHzq_QQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzkzNzYwNA==", "bodyText": "getCurrentBatch() \u0432\u044b\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u0432\u0442\u043e\u0440\u043e\u0439 \u0440\u0430\u0437, \u0442\u0443\u0442 \u0432\u044b\u0448\u0435 currentBatch", "url": "https://github.com/hhru/nuts-and-bolts/pull/276#discussion_r523937604", "createdAt": "2020-11-16T07:23:02Z", "author": {"login": "bokshitsky"}, "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaConsumer.java", "diffHunk": "@@ -63,5 +67,31 @@ public void onMessagesBatch(List<ConsumerRecord<String, T>> messages, Consumer<?\n     currentBatch.set(sortedBatch);\n     Ack<T> ack = new KafkaInternalTopicAck<>(this, consumer);\n     consumeStrategy.onMessagesBatch(sortedBatch, ack);\n+    if (!ack.isAcknowledge()) {\n+      rewindToLastAckedOffset(consumer);\n+    }\n+  }\n+\n+  public void rewindToLastAckedOffset(Consumer<?, ?> consumer) {\n+    List<ConsumerRecord<String, T>> currentBatch = getCurrentBatch();\n+    if (!currentBatch.isEmpty()) {\n+      LinkedHashMap<TopicPartition, OffsetAndMetadata> offsetsToSeek = currentBatch.stream().collect(toMap(\n+          record -> new TopicPartition(record.topic(), record.partition()),\n+          record -> new OffsetAndMetadata(record.offset()),\n+          (offset1, offset2) -> offset1,\n+          LinkedHashMap::new\n+      ));\n+\n+      Optional.ofNullable(getLastAckedBatchRecord()).ifPresent(lastAckedBatchRecord -> {\n+        for (ConsumerRecord<String, T> record : getCurrentBatch()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cf3ffeea8a2374ad4b1969729ec8e825f644c0b"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk0Mzc0NQ==", "bodyText": "\u0418\u0441\u043f\u0440\u0430\u0432\u0438\u043b", "url": "https://github.com/hhru/nuts-and-bolts/pull/276#discussion_r523943745", "createdAt": "2020-11-16T07:39:10Z", "author": {"login": "nicholasgribanov"}, "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaConsumer.java", "diffHunk": "@@ -63,5 +67,31 @@ public void onMessagesBatch(List<ConsumerRecord<String, T>> messages, Consumer<?\n     currentBatch.set(sortedBatch);\n     Ack<T> ack = new KafkaInternalTopicAck<>(this, consumer);\n     consumeStrategy.onMessagesBatch(sortedBatch, ack);\n+    if (!ack.isAcknowledge()) {\n+      rewindToLastAckedOffset(consumer);\n+    }\n+  }\n+\n+  public void rewindToLastAckedOffset(Consumer<?, ?> consumer) {\n+    List<ConsumerRecord<String, T>> currentBatch = getCurrentBatch();\n+    if (!currentBatch.isEmpty()) {\n+      LinkedHashMap<TopicPartition, OffsetAndMetadata> offsetsToSeek = currentBatch.stream().collect(toMap(\n+          record -> new TopicPartition(record.topic(), record.partition()),\n+          record -> new OffsetAndMetadata(record.offset()),\n+          (offset1, offset2) -> offset1,\n+          LinkedHashMap::new\n+      ));\n+\n+      Optional.ofNullable(getLastAckedBatchRecord()).ifPresent(lastAckedBatchRecord -> {\n+        for (ConsumerRecord<String, T> record : getCurrentBatch()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzkzNzYwNA=="}, "originalCommit": {"oid": "6cf3ffeea8a2374ad4b1969729ec8e825f644c0b"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NTE1MjY5OnYy", "diffSide": "RIGHT", "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaInternalTopicAck.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwNzoyNzowM1rOHzqtQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwNzozOToxOVrOHzq_gQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzkzOTEzOA==", "bodyText": "\u0418\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0431\u044b \u0432 false \u044f\u0432\u043d\u043e \u0442\u0443\u0442 / \u0432 \u043a\u043e\u043d\u0441\u0442\u0440\u0443\u043a\u0442\u043e\u0440\u0435", "url": "https://github.com/hhru/nuts-and-bolts/pull/276#discussion_r523939138", "createdAt": "2020-11-16T07:27:03Z", "author": {"login": "bokshitsky"}, "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaInternalTopicAck.java", "diffHunk": "@@ -15,6 +15,7 @@\n   private final KafkaConsumer<T> kafkaConsumer;\n   private final Consumer<?, ?> consumer;\n   private Integer lastCommittedIndex = null;\n+  private boolean isAcknowledge;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cf3ffeea8a2374ad4b1969729ec8e825f644c0b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk0MzgwOQ==", "bodyText": "\u0434\u043e\u0431\u0430\u0432\u0438\u043b", "url": "https://github.com/hhru/nuts-and-bolts/pull/276#discussion_r523943809", "createdAt": "2020-11-16T07:39:19Z", "author": {"login": "nicholasgribanov"}, "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaInternalTopicAck.java", "diffHunk": "@@ -15,6 +15,7 @@\n   private final KafkaConsumer<T> kafkaConsumer;\n   private final Consumer<?, ?> consumer;\n   private Integer lastCommittedIndex = null;\n+  private boolean isAcknowledge;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzkzOTEzOA=="}, "originalCommit": {"oid": "6cf3ffeea8a2374ad4b1969729ec8e825f644c0b"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NTE2NzQxOnYy", "diffSide": "RIGHT", "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaInternalTopicAck.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwNzozMjo1N1rOHzq1yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwNzozMjo1N1rOHzq1yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk0MTMyMQ==", "bodyText": "\u0434\u0443\u043c\u0430\u044e, \u0447\u0442\u043e \u043a\u043e\u0433\u0434\u0430 \u043c\u044b \u044f\u0432\u043d\u043e \u0434\u0435\u043b\u0430\u0435\u043c seek (\u0441\u0434\u0432\u0438\u0433\u0430\u0435\u043c \u043b\u043e\u043a\u0430\u043b\u044c\u043d\u044b\u0439 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u044c \u0432 \u043f\u0430\u043c\u044f\u0442\u0438 \u043a\u043e\u043d\u0441\u0443\u043c\u0435\u0440\u0430 \u043d\u0430 \u043a\u043e\u043d\u043a\u0440\u0435\u0442\u043d\u0443\u044e \u0437\u0430\u043f\u0438\u0441\u044c) \u043d\u0430\u0434\u043e \u0442\u043e\u0436\u0435 \u043d\u0435 \u0432\u043e\u0437\u0432\u0440\u0430\u0449\u0430\u0442\u044c \u043e\u0431\u0440\u0430\u0442\u043d\u043e.\n\u0423 \u043d\u0435\u0433\u043e \u0435\u0441\u0442\u044c \u043d\u0435\u0441\u043a\u043e\u043b\u044c\u043a\u043e \u043f\u0440\u0438\u043c\u0435\u043d\u0435\u043d\u0438\u0439:\n\n\u043a\u043e\u0433\u0434\u0430 \u043c\u044b \u0445\u043e\u0442\u0438\u043c \u043a\u043e\u043c\u043c\u0438\u0442\u0438\u0442\u044c \u043e\u0444\u0444\u0441\u0435\u0442 \u043d\u0435 \u043d\u0430 \u043a\u0430\u0436\u0434\u044b\u0439 \u0431\u0430\u0442\u0447, \u0430, \u043d\u0430\u043f\u0440\u0438\u043c\u0435\u0440, \u043f\u043e \u0432\u0440\u0435\u043c\u0435\u043d\u0438\n\u043a\u043e\u0433\u0434\u0430 \u043c\u044b \u0445\u043e\u0442\u0438\u043c \u043e\u043f\u0442\u0438\u043c\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043e\u043f\u0442\u0438\u043c\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0434\u0443\u0431\u043b\u0438 \u0438 at_least_once \u0441\u0435\u043c\u0430\u043d\u0442\u0438\u043a\u0443 -  \u0434\u0435\u043b\u0430\u0435\u043c seek \u043f\u043e\u0441\u043b\u0435 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0438 \u043a\u0430\u0436\u0434\u043e\u0433\u043e \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f \u0432 \u0431\u0430\u0442\u0447\u0435 (\u0434\u0435\u0448\u0435\u0432\u043e) \u0432 \u043a\u043e\u043d\u0446\u0435 \u0431\u0430\u0442\u0447\u0430 \u0434\u0435\u043b\u0430\u0435\u043c \u0433\u043b\u043e\u0431\u0430\u043b\u044c\u043d\u044b\u0439 ack.\n\n\u041f\u043b\u044e\u0441, \u043d\u0430\u043c \u0441\u043a\u043e\u0440\u043e \u043e\u043d \u043f\u043e\u043d\u0430\u0434\u043e\u0431\u0438\u0442\u0441\u044f, \u043a\u043e\u0433\u0434\u0430 \u0431\u0443\u0434\u0435\u043c \u0443\u0447\u0438\u0442\u044c nab-kafka \u0432\u044b\u0447\u0438\u0442\u044b\u0432\u0430\u0442\u044c \u0432\u0441\u0435 \u043f\u0430\u0440\u0442\u0438\u0446\u0438\u0438 \u0442\u043e\u043f\u0438\u043a\u0430, \u0431\u0435\u0437 \u0431\u0430\u043b\u0430\u043d\u0441\u0438\u0440\u043e\u0432\u043a\u0438", "url": "https://github.com/hhru/nuts-and-bolts/pull/276#discussion_r523941321", "createdAt": "2020-11-16T07:32:57Z", "author": {"login": "bokshitsky"}, "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaInternalTopicAck.java", "diffHunk": "@@ -50,10 +51,16 @@ public void acknowledge(ConsumerRecord<String, T> processedMessage) {\n     ));\n     consumer.commitSync(offsetsToCommit);\n     seek(processedMessage);\n+    isAcknowledge = true;\n   }\n \n   @Override\n   public void seek(ConsumerRecord<String, T> processedMessage) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cf3ffeea8a2374ad4b1969729ec8e825f644c0b"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4290, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}