{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MTEyNTYz", "number": 231, "title": "HH-106303 registration in consul properly", "bodyText": "", "createdAt": "2020-03-26T11:29:36Z", "url": "https://github.com/hhru/nuts-and-bolts/pull/231", "merged": true, "mergeCommit": {"oid": "e8675f080679c19875286a467e3e2e836a8db5bb"}, "closed": true, "closedAt": "2020-03-30T15:22:32Z", "author": {"login": "heruv1m"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRaY8HAH2gAyMzk0MTEyNTYzOjg5YTFhMDYwMGNmYTkzMjdkM2EwNDkxMTc4ZjJkMjVkMTlkMDRmYWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcSwBWNAFqTM4Mzk1NzYwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "89a1a0600cfa9327d3a0491178f2d25d19d04fab", "author": {"user": {"login": "heruv1m", "name": "Alexander Kazantsev"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/89a1a0600cfa9327d3a0491178f2d25d19d04fab", "committedDate": "2020-03-26T11:27:34Z", "message": "HH-106303 registration in consul properly"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxOTUxMjE3", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#pullrequestreview-381951217", "createdAt": "2020-03-26T12:17:20Z", "commit": {"oid": "89a1a0600cfa9327d3a0491178f2d25d19d04fab"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjoxNzoyMFrOF8EHwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjoyNDoyNFrOF8EXUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUyNjQwMg==", "bodyText": "\u043e\u043d \u0447\u0442\u043e-\u0442\u043e \u043a\u0438\u0434\u0430\u0435\u0442, \u0435\u0441\u043b\u0438 \u043d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c?", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r398526402", "createdAt": "2020-03-26T12:17:20Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -57,11 +57,14 @@ public ConsulClient getClient() {\n     return client;\n   }\n \n-  @PostConstruct\n   void register() {\n     if (enabled) {\n-      client.agentServiceRegister(service);\n-      logger.info(\"Registered service: {} to consul\", service);\n+      try {\n+        client.agentServiceRegister(service);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a1a0600cfa9327d3a0491178f2d25d19d04fab"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUyNzUxNQ==", "bodyText": "\u0430 \u0447\u0435 \u043d\u0435 jettyEventListener?", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r398527515", "createdAt": "2020-03-26T12:19:14Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/NabProdConfig.java", "diffHunk": "@@ -60,4 +60,9 @@ ConsulService consulService(FileSettings fileSettings, String datacenter, AppMet\n     var address = InetAddress.getLocalHost().getHostAddress();\n     return new ConsulService(fileSettings, datacenter, address, appMetadata);\n   }\n+\n+  @Bean\n+  JettyEventListener customSpringEventListener(ConsulService consulService){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a1a0600cfa9327d3a0491178f2d25d19d04fab"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUyNzg1OQ==", "bodyText": "\u043c\u0431 \u0443\u0431\u0440\u0430\u0442\u044c \u0432\u0441\u0435 \u043f\u0440\u043e \u044d\u0432\u0435\u043d\u0442\u044b \u0432 events?", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r398527859", "createdAt": "2020-03-26T12:19:48Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/JettyEventListener.java", "diffHunk": "@@ -0,0 +1,21 @@\n+package ru.hh.nab.starter;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a1a0600cfa9327d3a0491178f2d25d19d04fab"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUzMDE1NA==", "bodyText": "\u043c\u043d\u0435 \u043d\u0435 \u043e\u0447\u0435\u043d\u044c \u043d\u0440\u0430\u0432\u0438\u0442\u0441\u044f, \u0447\u0442\u043e \u0441\u043e\u0431\u044b\u0442\u0438\u044f \u043e\u0442\u0434\u0435\u043b\u044c\u043d\u043e \u043e\u0442 webappinitializer \u0438\u0434\u0443\u0442. \u044d\u0442\u043e \u043f\u043e \u0438\u0434\u0435\u0435 \u0442\u043e\u0442 \u0441\u0430\u043c\u044b\u0439 \u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442, \u043a\u043e\u0442\u043e\u0440\u044b\u0439 \u0440\u0443\u043b\u0438\u0442 \u0438\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u0435\u0439. \u043e\u043d \u0432\u0440\u043e\u0434\u0435 \u0431\u044b \u0437\u043d\u0430\u0435\u0442 \u0443\u0436\u0435 \u043f\u0440\u043e \u043a\u043e\u043d\u0442\u0435\u043a\u0441\u0442 \u0438 \u0432\u0441\u044e \u043a\u0443\u0445\u043d\u044e. \u0432\u043e\u0442 \u0435\u043c\u0443 \u0431\u044b \u0432\u0441\u0435\u043c\u0438 \u044d\u0442\u0438\u043c\u0438 \u043b\u0438\u0441\u0442\u0435\u043d\u0435\u0440\u0430\u043c\u0438 \u0438 \u0437\u0430\u043d\u044f\u0442\u044c\u0441\u044f", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r398530154", "createdAt": "2020-03-26T12:24:00Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/server/jetty/JettyServerFactory.java", "diffHunk": "@@ -15,10 +16,11 @@\n \n   private static final int DEFAULT_IDLE_TIMEOUT_MS = (int) Duration.ofMinutes(1).toMillis();\n \n-  public static JettyServer create(FileSettings fileSettings, ThreadPool threadPool, WebAppInitializer webAppInitializer) {\n+  public static JettyServer create(FileSettings fileSettings, ThreadPool threadPool, WebAppInitializer webAppInitializer,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a1a0600cfa9327d3a0491178f2d25d19d04fab"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUzMDM4NA==", "bodyText": "\u0442\u0430\u043c \u0432\u0440\u043e\u0434\u0435 \u0431\u044b\u043b \u0430\u0431\u0441\u0442\u0440\u0430\u043a\u0442\u043d\u044b\u0439 \u043a\u043b\u0430\u0441\u0441", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r398530384", "createdAt": "2020-03-26T12:24:24Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/server/jetty/JettyLifeCycleListener.java", "diffHunk": "@@ -0,0 +1,34 @@\n+package ru.hh.nab.starter.server.jetty;\n+\n+import org.eclipse.jetty.util.component.LifeCycle;\n+import org.springframework.context.ApplicationEventPublisher;\n+import ru.hh.nab.starter.JettyStartedEvent;\n+\n+public class JettyLifeCycleListener implements LifeCycle.Listener {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89a1a0600cfa9327d3a0491178f2d25d19d04fab"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18", "author": {"user": {"login": "heruv1m", "name": "Alexander Kazantsev"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/1913f1f03d7fe27d74bd10e88b459f99b6672d18", "committedDate": "2020-03-27T15:03:40Z", "message": "HH-106303 add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0cbb59f4e0e8edd073713d12227544043cbeee9", "author": {"user": {"login": "heruv1m", "name": "Alexander Kazantsev"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/b0cbb59f4e0e8edd073713d12227544043cbeee9", "committedDate": "2020-03-27T15:31:53Z", "message": "HH-106303 add fileSettings for fixing test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyOTUwMTMx", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#pullrequestreview-382950131", "createdAt": "2020-03-27T15:14:40Z", "commit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNToxNDo0MVrOF81rLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNTo1OToxN1rOF83mEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzODI4Ng==", "bodyText": "\u0437\u0430\u0447\u0435\u043c?", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399338286", "createdAt": "2020-03-27T15:14:41Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -45,8 +45,8 @@ public ConsulService(FileSettings fileSettings, String datacenter, String addres\n     service.setMeta(Collections.singletonMap(\"serviceVersion\", appMetadata.getVersion()));\n \n     this.client = new ConsulClient(\n-      Optional.ofNullable(fileSettings.getString(\"consul.http.host\")).orElse(\"127.0.0.1\"),\n-      fileSettings.getInteger(\"consul.http.port\")\n+            Optional.ofNullable(fileSettings.getString(\"consul.http.host\")).orElse(\"127.0.0.1\"),\n+            Optional.ofNullable(fileSettings.getInteger(\"consul.http.port\")).orElse(8300)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzOTg3MA==", "bodyText": "\u0447\u0435\u043c \u0442\u0435\u0431\u0435 Consumer \u043d\u0435 \u043d\u0440\u0430\u0432\u0438\u0442\u0441\u044f", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399339870", "createdAt": "2020-03-27T15:16:52Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/common/Visitor.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package ru.hh.nab.starter.common;\n+\n+public interface Visitor<T> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2MzA5MA==", "bodyText": "\u0438\u043b\u0438 \u0442\u043e\u0442 \u0436\u0435 WebAppInitializer - \u044d\u0442\u043e \u0436 \u043f\u0440\u044f\u043c \u043e\u043d)", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399363090", "createdAt": "2020-03-27T15:49:42Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/common/Visitor.java", "diffHunk": "@@ -0,0 +1,5 @@\n+package ru.hh.nab.starter.common;\n+\n+public interface Visitor<T> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzOTg3MA=="}, "originalCommit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2MzM1Ng==", "bodyText": "\u0447\u0442\u043e \u0442\u0430\u043a\u043e\u0435 v?", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399363356", "createdAt": "2020-03-27T15:50:06Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/NabApplication.java", "diffHunk": "@@ -68,27 +71,40 @@ public JettyServer run(WebApplicationContext baseContext,\n     try {\n       configureLogger();\n       configureSentry(baseContext);\n-      FileSettings fileSettings = baseContext.getBean(FileSettings.class);\n-      ThreadPool threadPool = baseContext.getBean(ThreadPool.class);\n-      WebAppInitializer webAppInitializer = createWebAppInitializer(servletContextConfig, baseContext, directlyUseAsWebAppRoot);\n-      JettyServer jettyServer = serverStarter.apply(port -> {\n-        FileSettings effectiveSettings = fileSettings;\n-        if (port != null) {\n-          Properties properties = fileSettings.getProperties();\n-          properties.setProperty(JETTY_PORT, String.valueOf(port));\n-          effectiveSettings = new FileSettings(properties);\n-        }\n-        JettyServer server = JettyServerFactory.create(effectiveSettings, threadPool, webAppInitializer);\n-        server.start();\n-        return server;\n-      });\n+      JettyServer jettyServer = createJettyServer(baseContext, directlyUseAsWebAppRoot, serverStarter,\n+              v->v.addLifeCycleListener(new JettyLifeCycleListener(baseContext)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2MzkxMg==", "bodyText": "\u0430 \u043c\u044b \u0440\u0430\u0437\u0432\u0435 \u043c\u043e\u0436\u0435\u043c \u0445\u043e\u0442\u044c \u043a\u043e\u0433\u0434\u0430-\u0442\u043e \u043d\u0435 \u0437\u0430\u0445\u043e\u0442\u0435\u0442\u044c \u0434\u043e\u0431\u0430\u0432\u043b\u044f\u0442\u044c listener - \u044f \u0431\u044b \u044d\u0442\u043e \u0443\u043d\u0435\u0441 \u043f\u0440\u044f\u043c \u0432 \u043e\u0441\u043d\u043e\u0432\u043d\u043e\u0439 webAppInitializer", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399363912", "createdAt": "2020-03-27T15:50:54Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/NabApplication.java", "diffHunk": "@@ -68,27 +71,40 @@ public JettyServer run(WebApplicationContext baseContext,\n     try {\n       configureLogger();\n       configureSentry(baseContext);\n-      FileSettings fileSettings = baseContext.getBean(FileSettings.class);\n-      ThreadPool threadPool = baseContext.getBean(ThreadPool.class);\n-      WebAppInitializer webAppInitializer = createWebAppInitializer(servletContextConfig, baseContext, directlyUseAsWebAppRoot);\n-      JettyServer jettyServer = serverStarter.apply(port -> {\n-        FileSettings effectiveSettings = fileSettings;\n-        if (port != null) {\n-          Properties properties = fileSettings.getProperties();\n-          properties.setProperty(JETTY_PORT, String.valueOf(port));\n-          effectiveSettings = new FileSettings(properties);\n-        }\n-        JettyServer server = JettyServerFactory.create(effectiveSettings, threadPool, webAppInitializer);\n-        server.start();\n-        return server;\n-      });\n+      JettyServer jettyServer = createJettyServer(baseContext, directlyUseAsWebAppRoot, serverStarter,\n+              v->v.addLifeCycleListener(new JettyLifeCycleListener(baseContext)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2MzM1Ng=="}, "originalCommit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NDE0Mg==", "bodyText": "\u0437\u0430\u0447\u0435\u043c \u0435\u043c\u0443 \u0442\u043e\u0440\u0447\u0430\u0442\u044c \u043d\u0430\u0440\u0443\u0436\u0443?", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399364142", "createdAt": "2020-03-27T15:51:15Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/NabApplication.java", "diffHunk": "@@ -68,27 +71,40 @@ public JettyServer run(WebApplicationContext baseContext,\n     try {\n       configureLogger();\n       configureSentry(baseContext);\n-      FileSettings fileSettings = baseContext.getBean(FileSettings.class);\n-      ThreadPool threadPool = baseContext.getBean(ThreadPool.class);\n-      WebAppInitializer webAppInitializer = createWebAppInitializer(servletContextConfig, baseContext, directlyUseAsWebAppRoot);\n-      JettyServer jettyServer = serverStarter.apply(port -> {\n-        FileSettings effectiveSettings = fileSettings;\n-        if (port != null) {\n-          Properties properties = fileSettings.getProperties();\n-          properties.setProperty(JETTY_PORT, String.valueOf(port));\n-          effectiveSettings = new FileSettings(properties);\n-        }\n-        JettyServer server = JettyServerFactory.create(effectiveSettings, threadPool, webAppInitializer);\n-        server.start();\n-        return server;\n-      });\n+      JettyServer jettyServer = createJettyServer(baseContext, directlyUseAsWebAppRoot, serverStarter,\n+              v->v.addLifeCycleListener(new JettyLifeCycleListener(baseContext)));\n+      jettyServer.start();\n       logStartupInfo(baseContext);\n       return jettyServer;\n     } catch (Exception e) {\n       return logErrorAndExit(e, exitOnError);\n     }\n   }\n \n+  public JettyServer createJettyServer(WebApplicationContext baseContext,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0cbb59f4e0e8edd073713d12227544043cbeee9"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NDcwMg==", "bodyText": "\u043c\u0431 \u044d\u0442\u043e\u0442 \u043c\u0435\u0442\u043e\u0434 \u043f\u0435\u0440\u0435\u0433\u0440\u0443\u0437\u0438\u0442\u044c \u0431\u0435\u0437 webAppContextVisitor? \u0432 run \u043d\u0430\u043c \u0432\u0440\u043e\u0434\u0435 \u043d\u0438\u0447\u0435\u0433\u043e \u0442\u0430\u043a\u043e\u0433\u043e \u043d\u0435 \u043d\u0443\u0436\u043d\u043e. \u0430 \u043f\u043e\u043b\u043d\u0443\u044e \u0432\u0435\u0440\u0441\u0438\u044e \u0431\u0443\u0434\u0435\u043c \u0434\u0435\u0440\u0433\u0430\u0442\u044c \u0432 \u0442\u0435\u0441\u0442\u0430\u0445", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399364702", "createdAt": "2020-03-27T15:52:03Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/NabApplication.java", "diffHunk": "@@ -68,27 +71,40 @@ public JettyServer run(WebApplicationContext baseContext,\n     try {\n       configureLogger();\n       configureSentry(baseContext);\n-      FileSettings fileSettings = baseContext.getBean(FileSettings.class);\n-      ThreadPool threadPool = baseContext.getBean(ThreadPool.class);\n-      WebAppInitializer webAppInitializer = createWebAppInitializer(servletContextConfig, baseContext, directlyUseAsWebAppRoot);\n-      JettyServer jettyServer = serverStarter.apply(port -> {\n-        FileSettings effectiveSettings = fileSettings;\n-        if (port != null) {\n-          Properties properties = fileSettings.getProperties();\n-          properties.setProperty(JETTY_PORT, String.valueOf(port));\n-          effectiveSettings = new FileSettings(properties);\n-        }\n-        JettyServer server = JettyServerFactory.create(effectiveSettings, threadPool, webAppInitializer);\n-        server.start();\n-        return server;\n-      });\n+      JettyServer jettyServer = createJettyServer(baseContext, directlyUseAsWebAppRoot, serverStarter,\n+              v->v.addLifeCycleListener(new JettyLifeCycleListener(baseContext)));\n+      jettyServer.start();\n       logStartupInfo(baseContext);\n       return jettyServer;\n     } catch (Exception e) {\n       return logErrorAndExit(e, exitOnError);\n     }\n   }\n \n+  public JettyServer createJettyServer(WebApplicationContext baseContext,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NDE0Mg=="}, "originalCommit": {"oid": "b0cbb59f4e0e8edd073713d12227544043cbeee9"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NjcyMw==", "bodyText": "\u044d\u0442\u0430 \u0448\u0442\u0443\u043a\u0430 \u043f\u043e\u0436\u0430\u043b\u0443\u0439 \u0434\u043e\u043b\u0436\u043d\u0430 \u0431\u044b \u0438\u0437 CommonContext'\u0430 \u043f\u0440\u0438\u0435\u0437\u0436\u0430\u0442\u044c", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399366723", "createdAt": "2020-03-27T15:54:55Z", "author": {"login": "dzharikhin"}, "path": "nab-tests/src/test/java/ru/hh/nab/starter/NabAppTestConfig.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package ru.hh.nab.starter;\n+\n+import static org.mockito.Mockito.spy;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Import;\n+import ru.hh.nab.common.properties.FileSettings;\n+import ru.hh.nab.starter.events.JettyEventListener;\n+import ru.hh.nab.testbase.NabTestConfig;\n+\n+@Configuration\n+@Import({NabTestConfig.class})\n+public class NabAppTestConfig {\n+  @Bean\n+  ConsulService consulService(FileSettings fileSettings, AppMetadata appMetadata) {\n+    return spy(new ConsulService(fileSettings, null, null, appMetadata));\n+  }\n+\n+  @Bean\n+  JettyEventListener jettyEventListener(ConsulService consulService) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0cbb59f4e0e8edd073713d12227544043cbeee9"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2NzQ2MQ==", "bodyText": "\u0412\u0440\u043e\u0434\u0435 \u0431\u044b \u0434\u043e\u0441\u0442\u0430\u0442\u043e\u0447\u043d\u043e Properties \u0431\u0438\u043d \u043e\u0431\u044a\u044f\u0432\u0438\u0442\u044c", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399367461", "createdAt": "2020-03-27T15:56:00Z", "author": {"login": "dzharikhin"}, "path": "nab-tests/src/test/java/ru/hh/nab/starter/NabApplicationTest.java", "diffHunk": "@@ -82,4 +133,18 @@ String failedBean() {\n       throw new RuntimeException(\"failed to load bean\");\n     }\n   }\n+\n+  @Configuration\n+  @Import(NabAppTestConfig.class)\n+  public static class BrokenConsul {\n+\n+    @Bean\n+    @Primary\n+    FileSettings fileSettings() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0cbb59f4e0e8edd073713d12227544043cbeee9"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2ODA3NA==", "bodyText": "\u0447\u0442\u043e \u0442\u0430\u043a\u043e\u0435 mock \u0438 v?", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399368074", "createdAt": "2020-03-27T15:56:55Z", "author": {"login": "dzharikhin"}, "path": "nab-tests/src/test/java/ru/hh/nab/starter/NabApplicationTest.java", "diffHunk": "@@ -46,6 +58,45 @@ public void runShouldStartJetty() {\n     }\n   }\n \n+  @Test\n+  public void testRightStartupOrderForConsul() {\n+    AnnotationConfigWebApplicationContext aggregateCtx = new AnnotationConfigWebApplicationContext();\n+    aggregateCtx.register(NabAppTestConfig.class);\n+    aggregateCtx.refresh();\n+\n+    JettyLifeCycleListener lifeCycleListener = spy(new JettyLifeCycleListener(aggregateCtx));\n+\n+    NabApplication nabApplication = new NabApplication(new NabServletContextConfig());\n+    JettyServer jettyServer = nabApplication.createJettyServer(aggregateCtx,\n+            false,\n+            mock -> mock.apply(null),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0cbb59f4e0e8edd073713d12227544043cbeee9"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM2OTc0Nw==", "bodyText": "\u0435\u0441\u043b\u0438 \u0443 \u0442\u0435\u0431\u044f \u043d\u0435 \u0443\u043a\u0430\u0437\u0430\u043d \u043f\u043e\u0440\u0442 \u0432 \u0431\u043e\u044e, \u043d\u0430\u0434\u043e \u0431\u044b \u043f\u0430\u0434\u0430\u0442\u044c. \u0435\u0441\u043b\u0438 \u043d\u0430\u0434\u043e \u0432 \u0442\u0435\u0441\u0442\u0430\u0445, \u0442\u043e \u043b\u0443\u0447\u0448\u0435 \u0440\u0435\u0448\u0438\u0442\u044c \u0437\u0430 \u0441\u0447\u0435\u0442 \u043e\u0432\u0435\u0440\u0440\u0430\u0439\u0434\u0430 \u043f\u0440\u043e\u043f\u0435\u0440\u0442\u0435\u0439", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r399369747", "createdAt": "2020-03-27T15:59:17Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -45,8 +45,8 @@ public ConsulService(FileSettings fileSettings, String datacenter, String addres\n     service.setMeta(Collections.singletonMap(\"serviceVersion\", appMetadata.getVersion()));\n \n     this.client = new ConsulClient(\n-      Optional.ofNullable(fileSettings.getString(\"consul.http.host\")).orElse(\"127.0.0.1\"),\n-      fileSettings.getInteger(\"consul.http.port\")\n+            Optional.ofNullable(fileSettings.getString(\"consul.http.host\")).orElse(\"127.0.0.1\"),\n+            Optional.ofNullable(fileSettings.getInteger(\"consul.http.port\")).orElse(8300)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzODI4Ng=="}, "originalCommit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73d77e0c98369570a23e38612ddda6f407b731ae", "author": {"user": {"login": "heruv1m", "name": "Alexander Kazantsev"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/73d77e0c98369570a23e38612ddda6f407b731ae", "committedDate": "2020-03-30T12:29:02Z", "message": "HH-106303 review. move logic to webInitializer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86d0846fb564fc499729d3afafd915ac36d694a2", "author": {"user": {"login": "heruv1m", "name": "Alexander Kazantsev"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/86d0846fb564fc499729d3afafd915ac36d694a2", "committedDate": "2020-03-30T12:32:42Z", "message": "HH-106303 registration in consul properly"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzODg5MDA1", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#pullrequestreview-383889005", "createdAt": "2020-03-30T14:05:56Z", "commit": {"oid": "86d0846fb564fc499729d3afafd915ac36d694a2"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNDowNTo1NlrOF9raCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNDoxMzo1NlrOF9ryDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIxODYzMw==", "bodyText": "\u043d\u0443 \u0438\u0437 \u0438\u043d\u0444\u0440\u0430\u0441\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u044b \u0441\u043b\u0435\u0434\u0443\u0435\u0442. \u0442\u0438\u043f\u0430 \u0434\u0435\u043c\u043e\u043d \u043a\u043e\u043d\u0441\u0443\u043b\u0430 \u0432\u0441\u0435\u0433\u0434\u0430 \u0441\u0442\u043e\u0438\u0442 \u043d\u0430 \u0445\u043e\u0441\u0442\u0435. \u0442.\u0435. \u044d\u0442\u043e bestpractice \u043a\u043e\u043d\u0441\u0443\u043b\u0430, \u0447\u0442\u043e\u0431\u044b \u0434\u0435\u043c\u043e\u043d \u0431\u044b\u043b \u043d\u0430 127.0.0.1. \u0430 \u0432\u043e\u0442 \u043f\u043e \u043f\u043e\u0440\u0442\u0443 - \u043d\u0438\u043a\u0430\u043a\u0438\u0445 bestpractice \u043d\u0435\u0442. \u043f\u043e\u044d\u0442\u043e\u043c\u0443", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r400218633", "createdAt": "2020-03-30T14:05:56Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -45,8 +45,8 @@ public ConsulService(FileSettings fileSettings, String datacenter, String addres\n     service.setMeta(Collections.singletonMap(\"serviceVersion\", appMetadata.getVersion()));\n \n     this.client = new ConsulClient(\n-      Optional.ofNullable(fileSettings.getString(\"consul.http.host\")).orElse(\"127.0.0.1\"),\n-      fileSettings.getInteger(\"consul.http.port\")\n+            Optional.ofNullable(fileSettings.getString(\"consul.http.host\")).orElse(\"127.0.0.1\"),\n+            Optional.ofNullable(fileSettings.getInteger(\"consul.http.port\")).orElse(8300)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzODI4Ng=="}, "originalCommit": {"oid": "1913f1f03d7fe27d74bd10e88b459f99b6672d18"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIyMzE0OA==", "bodyText": "\u043f\u043e\u0447\u0435\u043c\u0443 \u043e\u043f\u044f\u0442\u044c public?", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r400223148", "createdAt": "2020-03-30T14:11:48Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/NabApplication.java", "diffHunk": "@@ -68,27 +71,45 @@ public JettyServer run(WebApplicationContext baseContext,\n     try {\n       configureLogger();\n       configureSentry(baseContext);\n-      FileSettings fileSettings = baseContext.getBean(FileSettings.class);\n-      ThreadPool threadPool = baseContext.getBean(ThreadPool.class);\n-      WebAppInitializer webAppInitializer = createWebAppInitializer(servletContextConfig, baseContext, directlyUseAsWebAppRoot);\n-      JettyServer jettyServer = serverStarter.apply(port -> {\n-        FileSettings effectiveSettings = fileSettings;\n-        if (port != null) {\n-          Properties properties = fileSettings.getProperties();\n-          properties.setProperty(JETTY_PORT, String.valueOf(port));\n-          effectiveSettings = new FileSettings(properties);\n-        }\n-        JettyServer server = JettyServerFactory.create(effectiveSettings, threadPool, webAppInitializer);\n-        server.start();\n-        return server;\n-      });\n+      JettyServer jettyServer = createJettyServer(baseContext, directlyUseAsWebAppRoot, serverStarter);\n+      jettyServer.start();\n       logStartupInfo(baseContext);\n       return jettyServer;\n     } catch (Exception e) {\n       return logErrorAndExit(e, exitOnError);\n     }\n   }\n \n+  private JettyServer createJettyServer(WebApplicationContext baseContext,\n+                                       boolean directlyUseAsWebAppRoot,\n+                                       Function<Function<Integer, JettyServer>, JettyServer> serverStarter\n+  ) {\n+    return createJettyServer(baseContext, directlyUseAsWebAppRoot, serverStarter,\n+            webAppContext -> webAppContext.addLifeCycleListener(new JettyLifeCycleListener(baseContext)));\n+  }\n+\n+  public JettyServer createJettyServer(WebApplicationContext baseContext,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86d0846fb564fc499729d3afafd915ac36d694a2"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIyNDMxNA==", "bodyText": "\u0447\u0438\u0441\u0442\u043e \u043d\u0430 \u0432\u043a\u0443\u0441 - \u043d\u0443 \u043b\u0438\u0431\u043e \u0443\u0436\u0435 \u043d\u0430 \u0443\u0440\u043e\u0432\u0435\u043d\u044c \u0441 JettyServer \u0441\u043a\u043e\u0431\u043a\u0443, \u043b\u0438\u0431\u043e \u043f\u043e-\u043f\u0438\u0442\u043e\u043d\u044f\u0447\u044c\u0438 \u0432 \u043a\u043e\u043d\u0435\u0446 \u043f\u0440\u0435\u0434\u044b\u0434\u0443\u0449\u0435\u0439 \u0441\u0442\u0440\u043e\u043a\u0438", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r400224314", "createdAt": "2020-03-30T14:13:22Z", "author": {"login": "dzharikhin"}, "path": "nab-tests/src/test/java/ru/hh/nab/starter/NabApplicationTest.java", "diffHunk": "@@ -46,6 +57,45 @@ public void runShouldStartJetty() {\n     }\n   }\n \n+  @Test\n+  public void testRightStartupOrderForConsul() {\n+    AnnotationConfigWebApplicationContext aggregateCtx = new AnnotationConfigWebApplicationContext();\n+    aggregateCtx.register(NabAppTestConfig.class);\n+    aggregateCtx.refresh();\n+\n+    JettyLifeCycleListener lifeCycleListener = spy(new JettyLifeCycleListener(aggregateCtx));\n+\n+    NabApplication nabApplication = new NabApplication(new NabServletContextConfig());\n+    JettyServer jettyServer = nabApplication.createJettyServer(aggregateCtx,\n+            false,\n+            portSupplier -> portSupplier.apply(null),\n+            webAppContext -> webAppContext.addLifeCycleListener(lifeCycleListener)\n+            );\n+\n+    ConsulService consulService = aggregateCtx.getBean(ConsulService.class);\n+\n+    jettyServer.start();\n+\n+    InOrder inOrder = inOrder(lifeCycleListener, consulService);\n+    inOrder.verify(lifeCycleListener).lifeCycleStarted(any());\n+    inOrder.verify(consulService).register();\n+  }\n+\n+  @Test(expected = ConsulServiceException.class)\n+  public void testFailWithoutConsul() {\n+    AnnotationConfigWebApplicationContext aggregateCtx = new AnnotationConfigWebApplicationContext();\n+    aggregateCtx.register(BrokenConsul.class);\n+    aggregateCtx.refresh();\n+\n+    JettyServer jettyServer = new NabApplication(new NabServletContextConfig()).createJettyServer(aggregateCtx,\n+            false,\n+            portSupplier -> portSupplier.apply(0),\n+            webAppContext -> webAppContext.addLifeCycleListener(new JettyLifeCycleListener(aggregateCtx))\n+            );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86d0846fb564fc499729d3afafd915ac36d694a2"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIyNDc4Mw==", "bodyText": "\u043f\u043e \u0438\u0434\u0435\u0435 \u043c\u043e\u0436\u043d\u043e \u0431\u0435\u0437 Primary - \u0442\u0432\u043e\u0439 \u043a\u043e\u043d\u0444\u0438\u0433 \u043f\u0435\u0440\u0435\u043a\u0440\u043e\u0435\u0442, \u0435\u0441\u043b\u0438 \u0431\u0438\u043d \u0442\u0430\u043a \u0436\u0435 \u043d\u0430\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f. \u043d\u043e \u0432\u043e\u0442 \u043e\u043d \u0447\u0435-\u0442\u043e \u043d\u0435 \u0442\u0430\u043a \u0436\u0435 \u043d\u0430\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u043f\u043e-\u043c\u043e\u0435\u043c\u0443", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#discussion_r400224783", "createdAt": "2020-03-30T14:13:56Z", "author": {"login": "dzharikhin"}, "path": "nab-tests/src/test/java/ru/hh/nab/starter/NabApplicationTest.java", "diffHunk": "@@ -82,4 +132,17 @@ String failedBean() {\n       throw new RuntimeException(\"failed to load bean\");\n     }\n   }\n+\n+  @Configuration\n+  @Import(NabAppTestConfig.class)\n+  public static class BrokenConsul {\n+    @Bean\n+    @Primary", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86d0846fb564fc499729d3afafd915ac36d694a2"}, "originalPosition": 84}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea2ad5b79d79d8e880ee56dff6615d97c92f1b44", "author": {"user": {"login": "heruv1m", "name": "Alexander Kazantsev"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/ea2ad5b79d79d8e880ee56dff6615d97c92f1b44", "committedDate": "2020-03-30T15:02:10Z", "message": "HH-106303 fix config in tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8812e4da6e1bcb7f4d03c290481dbb17af53b5d4", "author": {"user": {"login": "heruv1m", "name": "Alexander Kazantsev"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/8812e4da6e1bcb7f4d03c290481dbb17af53b5d4", "committedDate": "2020-03-30T15:08:38Z", "message": "HH-106303 clear code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzOTU3NjA2", "url": "https://github.com/hhru/nuts-and-bolts/pull/231#pullrequestreview-383957606", "createdAt": "2020-03-30T15:13:38Z", "commit": {"oid": "8812e4da6e1bcb7f4d03c290481dbb17af53b5d4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3402, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}