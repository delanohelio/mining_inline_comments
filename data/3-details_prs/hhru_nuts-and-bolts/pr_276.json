{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5OTQ1MDIw", "number": 276, "title": "HH-110735. Rewind to last acked offset if current was not acked", "bodyText": "\u0414\u043b\u044f \u043a\u043e\u043d\u0442\u0435\u043a\u0441\u0442\u0430:\nhttps://hhru.slack.com/archives/C06P8LGAZ/p1591347468002000\n\u0426\u0435\u043b\u044c - \u043f\u0440\u0438\u043d\u0443\u0434\u0438\u0442\u0435\u043b\u044c\u043d\u043e \u043e\u0442\u043a\u0430\u0442\u044b\u0432\u0430\u0442\u044c\u0441\u044f \u043a \u0441\u0442\u0430\u0440\u043e\u043c\u0443 \u0430\u043a\u043d\u0443\u0442\u043e\u043c\u0443 \u043e\u0444\u0441\u0435\u0442\u0443, \u0435\u0441\u043b\u0438 \u0432 \u0442\u0435\u043a\u0443\u0449\u0435\u0439 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0438 \u0431\u0430\u0442\u0447\u0430 \u0435\u0433\u043e \u043d\u0435 \u0431\u044b\u043b\u043e, \u0434\u0430\u0431\u044b \u043d\u0435 \u043f\u0440\u043e\u043f\u0443\u0441\u043a\u0430\u0442\u044c \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0439. \u041f\u043e\u043b\u0443\u0447\u0430\u0435\u0442\u0441\u044f, \u0447\u0442\u043e \u0430\u0432\u0442\u043e\u0440 \u043a\u043e\u0434\u0430 \u0434\u043e\u043b\u0436\u0435\u043d \u0432 \u043b\u044e\u0431\u043e\u043c \u0441\u043b\u0443\u0447\u0430\u0435 \u0441\u0434\u0435\u043b\u0430\u0442\u044c \u0430\u043a, \u0447\u0442\u043e\u0431\u044b \"\u0441\u0434\u0432\u0438\u043d\u0443\u0442\u044c\" \u043b\u043e\u043a\u0430\u043b\u044c\u043d\u044b\u0439 \u043e\u0444\u0444\u0441\u0435\u0442.\n\u041f\u043e \u0440\u0435\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u0438 \u0441\u043b\u0435\u0434\u0443\u044e\u0449\u0430\u044f \u0438\u0441\u0442\u043e\u0440\u0438\u044f: \u0444\u0443\u043d\u043a\u0446\u0438\u043e\u043d\u0430\u043b \u0441\u0431\u0440\u043e\u0441\u0430 \u043e\u0444\u0444\u0441\u0435\u0442\u0430 \u0443\u0436\u0435 \u0431\u044b\u043b \u0441\u0434\u0435\u043b\u0430\u043d \u0432 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u0447\u0438\u043a\u0435 \u043e\u0448\u0438\u0431\u043e\u043a. \u041a\u043e\u0434 \u043e\u0442\u0442\u0443\u0434\u0430 \u043f\u043e\u0437\u0430\u0438\u043c\u0441\u0442\u0432\u043e\u0432\u0430\u043d \u0438 \u0443\u043d\u0435\u0441\u0435\u043d \u0432 KafkaConsumer, \u0438 \u0432\u044b\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u043d\u0435 \u0442\u043e\u043b\u044c\u043a\u043e \u043f\u0440\u0438 \u043e\u0448\u0438\u0431\u043a\u0435, \u043d\u043e \u0438 \u0443 \u0441\u043b\u0443\u0447\u0430\u0435 \u0435\u0441\u043b\u0438 \u0430\u043a\u0430 \u043d\u0435 \u0431\u044b\u043b\u043e.", "createdAt": "2020-11-12T15:01:35Z", "url": "https://github.com/hhru/nuts-and-bolts/pull/276", "merged": true, "mergeCommit": {"oid": "601846c6d66e5ff8966fcdb796ff56da4de1fa60"}, "closed": true, "closedAt": "2020-11-16T09:21:36Z", "author": {"login": "nicholasgribanov"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcDUjogFqTUyOTg4NDk2Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABddBEjXgFqTUzMTEyMDkxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5ODg0OTYz", "url": "https://github.com/hhru/nuts-and-bolts/pull/276#pullrequestreview-529884963", "createdAt": "2020-11-13T08:59:17Z", "commit": {"oid": "6d7de058340ea57ba179225c141b9906e6e3d8a3"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cf3ffeea8a2374ad4b1969729ec8e825f644c0b", "author": {"user": null}, "url": "https://github.com/hhru/nuts-and-bolts/commit/6cf3ffeea8a2374ad4b1969729ec8e825f644c0b", "committedDate": "2020-11-16T06:54:13Z", "message": "HH-110735. Rewind to last acked offset if current was not acked"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e4de57305784986f969aa7db834bd774e6e25640", "author": {"user": null}, "url": "https://github.com/hhru/nuts-and-bolts/commit/e4de57305784986f969aa7db834bd774e6e25640", "committedDate": "2020-11-13T14:58:37Z", "message": "add rewind test"}, "afterCommit": {"oid": "6cf3ffeea8a2374ad4b1969729ec8e825f644c0b", "author": {"user": null}, "url": "https://github.com/hhru/nuts-and-bolts/commit/6cf3ffeea8a2374ad4b1969729ec8e825f644c0b", "committedDate": "2020-11-16T06:54:13Z", "message": "HH-110735. Rewind to last acked offset if current was not acked"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwOTYyOTQw", "url": "https://github.com/hhru/nuts-and-bolts/pull/276#pullrequestreview-530962940", "createdAt": "2020-11-16T07:23:01Z", "commit": {"oid": "6cf3ffeea8a2374ad4b1969729ec8e825f644c0b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwNzoyMzowMlrOHzqnRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwNzoyMzowMlrOHzqnRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzkzNzYwNA==", "bodyText": "getCurrentBatch() \u0432\u044b\u0437\u044b\u0432\u0430\u0435\u0442\u0441\u044f \u0432\u0442\u043e\u0440\u043e\u0439 \u0440\u0430\u0437, \u0442\u0443\u0442 \u0432\u044b\u0448\u0435 currentBatch", "url": "https://github.com/hhru/nuts-and-bolts/pull/276#discussion_r523937604", "createdAt": "2020-11-16T07:23:02Z", "author": {"login": "bokshitsky"}, "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaConsumer.java", "diffHunk": "@@ -63,5 +67,31 @@ public void onMessagesBatch(List<ConsumerRecord<String, T>> messages, Consumer<?\n     currentBatch.set(sortedBatch);\n     Ack<T> ack = new KafkaInternalTopicAck<>(this, consumer);\n     consumeStrategy.onMessagesBatch(sortedBatch, ack);\n+    if (!ack.isAcknowledge()) {\n+      rewindToLastAckedOffset(consumer);\n+    }\n+  }\n+\n+  public void rewindToLastAckedOffset(Consumer<?, ?> consumer) {\n+    List<ConsumerRecord<String, T>> currentBatch = getCurrentBatch();\n+    if (!currentBatch.isEmpty()) {\n+      LinkedHashMap<TopicPartition, OffsetAndMetadata> offsetsToSeek = currentBatch.stream().collect(toMap(\n+          record -> new TopicPartition(record.topic(), record.partition()),\n+          record -> new OffsetAndMetadata(record.offset()),\n+          (offset1, offset2) -> offset1,\n+          LinkedHashMap::new\n+      ));\n+\n+      Optional.ofNullable(getLastAckedBatchRecord()).ifPresent(lastAckedBatchRecord -> {\n+        for (ConsumerRecord<String, T> record : getCurrentBatch()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cf3ffeea8a2374ad4b1969729ec8e825f644c0b"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwOTY0NjQ5", "url": "https://github.com/hhru/nuts-and-bolts/pull/276#pullrequestreview-530964649", "createdAt": "2020-11-16T07:27:03Z", "commit": {"oid": "6cf3ffeea8a2374ad4b1969729ec8e825f644c0b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwNzoyNzowM1rOHzqtQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwNzoyNzowM1rOHzqtQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzkzOTEzOA==", "bodyText": "\u0418\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0431\u044b \u0432 false \u044f\u0432\u043d\u043e \u0442\u0443\u0442 / \u0432 \u043a\u043e\u043d\u0441\u0442\u0440\u0443\u043a\u0442\u043e\u0440\u0435", "url": "https://github.com/hhru/nuts-and-bolts/pull/276#discussion_r523939138", "createdAt": "2020-11-16T07:27:03Z", "author": {"login": "bokshitsky"}, "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaInternalTopicAck.java", "diffHunk": "@@ -15,6 +15,7 @@\n   private final KafkaConsumer<T> kafkaConsumer;\n   private final Consumer<?, ?> consumer;\n   private Integer lastCommittedIndex = null;\n+  private boolean isAcknowledge;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cf3ffeea8a2374ad4b1969729ec8e825f644c0b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwOTcyNDg4", "url": "https://github.com/hhru/nuts-and-bolts/pull/276#pullrequestreview-530972488", "createdAt": "2020-11-16T07:32:56Z", "commit": {"oid": "6cf3ffeea8a2374ad4b1969729ec8e825f644c0b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwNzozMjo1N1rOHzq1yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwNzozMjo1N1rOHzq1yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk0MTMyMQ==", "bodyText": "\u0434\u0443\u043c\u0430\u044e, \u0447\u0442\u043e \u043a\u043e\u0433\u0434\u0430 \u043c\u044b \u044f\u0432\u043d\u043e \u0434\u0435\u043b\u0430\u0435\u043c seek (\u0441\u0434\u0432\u0438\u0433\u0430\u0435\u043c \u043b\u043e\u043a\u0430\u043b\u044c\u043d\u044b\u0439 \u0443\u043a\u0430\u0437\u0430\u0442\u0435\u043b\u044c \u0432 \u043f\u0430\u043c\u044f\u0442\u0438 \u043a\u043e\u043d\u0441\u0443\u043c\u0435\u0440\u0430 \u043d\u0430 \u043a\u043e\u043d\u043a\u0440\u0435\u0442\u043d\u0443\u044e \u0437\u0430\u043f\u0438\u0441\u044c) \u043d\u0430\u0434\u043e \u0442\u043e\u0436\u0435 \u043d\u0435 \u0432\u043e\u0437\u0432\u0440\u0430\u0449\u0430\u0442\u044c \u043e\u0431\u0440\u0430\u0442\u043d\u043e.\n\u0423 \u043d\u0435\u0433\u043e \u0435\u0441\u0442\u044c \u043d\u0435\u0441\u043a\u043e\u043b\u044c\u043a\u043e \u043f\u0440\u0438\u043c\u0435\u043d\u0435\u043d\u0438\u0439:\n\n\u043a\u043e\u0433\u0434\u0430 \u043c\u044b \u0445\u043e\u0442\u0438\u043c \u043a\u043e\u043c\u043c\u0438\u0442\u0438\u0442\u044c \u043e\u0444\u0444\u0441\u0435\u0442 \u043d\u0435 \u043d\u0430 \u043a\u0430\u0436\u0434\u044b\u0439 \u0431\u0430\u0442\u0447, \u0430, \u043d\u0430\u043f\u0440\u0438\u043c\u0435\u0440, \u043f\u043e \u0432\u0440\u0435\u043c\u0435\u043d\u0438\n\u043a\u043e\u0433\u0434\u0430 \u043c\u044b \u0445\u043e\u0442\u0438\u043c \u043e\u043f\u0442\u0438\u043c\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043e\u043f\u0442\u0438\u043c\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0434\u0443\u0431\u043b\u0438 \u0438 at_least_once \u0441\u0435\u043c\u0430\u043d\u0442\u0438\u043a\u0443 -  \u0434\u0435\u043b\u0430\u0435\u043c seek \u043f\u043e\u0441\u043b\u0435 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0438 \u043a\u0430\u0436\u0434\u043e\u0433\u043e \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f \u0432 \u0431\u0430\u0442\u0447\u0435 (\u0434\u0435\u0448\u0435\u0432\u043e) \u0432 \u043a\u043e\u043d\u0446\u0435 \u0431\u0430\u0442\u0447\u0430 \u0434\u0435\u043b\u0430\u0435\u043c \u0433\u043b\u043e\u0431\u0430\u043b\u044c\u043d\u044b\u0439 ack.\n\n\u041f\u043b\u044e\u0441, \u043d\u0430\u043c \u0441\u043a\u043e\u0440\u043e \u043e\u043d \u043f\u043e\u043d\u0430\u0434\u043e\u0431\u0438\u0442\u0441\u044f, \u043a\u043e\u0433\u0434\u0430 \u0431\u0443\u0434\u0435\u043c \u0443\u0447\u0438\u0442\u044c nab-kafka \u0432\u044b\u0447\u0438\u0442\u044b\u0432\u0430\u0442\u044c \u0432\u0441\u0435 \u043f\u0430\u0440\u0442\u0438\u0446\u0438\u0438 \u0442\u043e\u043f\u0438\u043a\u0430, \u0431\u0435\u0437 \u0431\u0430\u043b\u0430\u043d\u0441\u0438\u0440\u043e\u0432\u043a\u0438", "url": "https://github.com/hhru/nuts-and-bolts/pull/276#discussion_r523941321", "createdAt": "2020-11-16T07:32:57Z", "author": {"login": "bokshitsky"}, "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/consumer/KafkaInternalTopicAck.java", "diffHunk": "@@ -50,10 +51,16 @@ public void acknowledge(ConsumerRecord<String, T> processedMessage) {\n     ));\n     consumer.commitSync(offsetsToCommit);\n     seek(processedMessage);\n+    isAcknowledge = true;\n   }\n \n   @Override\n   public void seek(ConsumerRecord<String, T> processedMessage) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cf3ffeea8a2374ad4b1969729ec8e825f644c0b"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c0b93e3ca9d84c4c2e7485b7caadcab69bf18ef", "author": {"user": null}, "url": "https://github.com/hhru/nuts-and-bolts/commit/3c0b93e3ca9d84c4c2e7485b7caadcab69bf18ef", "committedDate": "2020-11-16T07:38:50Z", "message": "delete duplicate calling method and add initialize default value"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfa5c612eef8f4ede0df0f955708c71da96613ad", "author": {"user": null}, "url": "https://github.com/hhru/nuts-and-bolts/commit/dfa5c612eef8f4ede0df0f955708c71da96613ad", "committedDate": "2020-11-16T08:41:18Z", "message": "remove isAcknowledge flag"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMTIwOTE5", "url": "https://github.com/hhru/nuts-and-bolts/pull/276#pullrequestreview-531120919", "createdAt": "2020-11-16T08:55:55Z", "commit": {"oid": "dfa5c612eef8f4ede0df0f955708c71da96613ad"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3364, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}