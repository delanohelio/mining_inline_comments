{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1NzA1NzI0", "number": 280, "title": "HH-120026 consul de\\registration fix", "bodyText": "", "createdAt": "2020-11-23T12:43:56Z", "url": "https://github.com/hhru/nuts-and-bolts/pull/280", "merged": true, "mergeCommit": {"oid": "28d5051ec41fe8573bdd9ff9e5b0fc700e0b633f"}, "closed": true, "closedAt": "2020-11-24T13:07:04Z", "author": {"login": "dzharikhin"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeYAm-gH2gAyNTI1NzA1NzI0OjlhOWU3NjVkNGJmMzhhM2U4ODI4ZTgwYTM1YWE1YjdhMjAwMDg3NTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfXOEKAH2gAyNTI1NzA1NzI0Ojg2ZjA3ZDI4MmVlMDgyZjc0ZDIyNTM0MjE1NjQ4NzAwMjlhYTk0NTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9a9e765d4bf38a3e8828e80a35aa5b7a20008753", "author": {"user": {"login": "dzharikhin", "name": "Dmitriy Zharikhin"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/9a9e765d4bf38a3e8828e80a35aa5b7a20008753", "committedDate": "2020-11-20T14:13:21Z", "message": "HH-120026 fix serviceId"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cede7688f70325b9fc4a14269e8e823c450b529", "author": {"user": {"login": "dzharikhin", "name": "Dmitriy Zharikhin"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/8cede7688f70325b9fc4a14269e8e823c450b529", "committedDate": "2020-11-23T09:34:30Z", "message": "HH-120026 make registration setting more clear"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "caa28fe63969632cbe77af3c8e056e6b342f4b76", "author": {"user": {"login": "dzharikhin", "name": "Dmitriy Zharikhin"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/caa28fe63969632cbe77af3c8e056e6b342f4b76", "committedDate": "2020-11-23T12:42:28Z", "message": "HH-120026 fix de\\registration lifecycle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0aff8da5d3241e51fc515a2eac4cc3333c555e96", "author": {"user": {"login": "dzharikhin", "name": "Dmitriy Zharikhin"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/0aff8da5d3241e51fc515a2eac4cc3333c555e96", "committedDate": "2020-11-23T12:42:28Z", "message": "HH-120026 fix example"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NDQyNzg4", "url": "https://github.com/hhru/nuts-and-bolts/pull/280#pullrequestreview-536442788", "createdAt": "2020-11-23T12:51:10Z", "commit": {"oid": "0aff8da5d3241e51fc515a2eac4cc3333c555e96"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NDUyMzg5", "url": "https://github.com/hhru/nuts-and-bolts/pull/280#pullrequestreview-536452389", "createdAt": "2020-11-23T13:04:08Z", "commit": {"oid": "0aff8da5d3241e51fc515a2eac4cc3333c555e96"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NDU0NDky", "url": "https://github.com/hhru/nuts-and-bolts/pull/280#pullrequestreview-536454492", "createdAt": "2020-11-23T13:06:52Z", "commit": {"oid": "0aff8da5d3241e51fc515a2eac4cc3333c555e96"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMzowNjo1MlrOH4Mpmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMzowNjo1MlrOH4Mpmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4OTU2Mw==", "bodyText": "interruptedFlag?", "url": "https://github.com/hhru/nuts-and-bolts/pull/280#discussion_r528689563", "createdAt": "2020-11-23T13:06:52Z", "author": {"login": "pvorlov"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -98,14 +98,22 @@ public void register() {\n     return kvClient.getValueAsString(String.format(\"host/%s/weight\", hostName));\n   }\n \n-  @PreDestroy\n-  void deregister() {\n+  public void deregister() {\n     if (enabled) {\n       agentClient.deregister(service.getId());\n+      LOGGER.debug(\"De-registered id: {} from consul, going to sleep {}ms to wait possible requests\", id, sleepAfterDeregisterMillis);\n+      trySleep();\n       LOGGER.info(\"De-registered id: {} from consul\", id);\n     }\n   }\n \n+  private void trySleep() {\n+    try {\n+      Thread.sleep(sleepAfterDeregisterMillis);\n+    } catch (InterruptedException ignored) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0aff8da5d3241e51fc515a2eac4cc3333c555e96"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86f07d282ee082f74d2253421564870029aa9454", "author": {"user": {"login": "dzharikhin", "name": "Dmitriy Zharikhin"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/86f07d282ee082f74d2253421564870029aa9454", "committedDate": "2020-11-23T15:52:04Z", "message": "HH-120026 throw interruptedexception if any"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3370, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}