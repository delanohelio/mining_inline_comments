{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzNzEzOTYz", "number": 229, "title": "HH-104397 remove generification from KafkaProducer interface", "bodyText": "https://jira.hh.ru/browse/HH-104397", "createdAt": "2020-03-04T17:12:51Z", "url": "https://github.com/hhru/nuts-and-bolts/pull/229", "merged": true, "mergeCommit": {"oid": "2becf033bc29f7b3a91ddfaca19bf372b53ea742"}, "closed": true, "closedAt": "2020-03-05T07:57:38Z", "author": {"login": "vorobey92"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKma7mAFqTM2OTM0NDMyNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKmwJ_gBqjMxMDAwMzU2Mjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MzQ0MzI1", "url": "https://github.com/hhru/nuts-and-bolts/pull/229#pullrequestreview-369344325", "createdAt": "2020-03-05T07:31:08Z", "commit": {"oid": "36aa3aa9e6481099874199e4770342d8c86ca672"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwNzozMTowOFrOFyI2xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwNzozMTowOFrOFyI2xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODExODIxNA==", "bodyText": "\u041a\u043e\u0433\u0434\u0430 \u0445\u043e\u0447\u0435\u0442\u0441\u044f \u0445\u043e\u0442\u044c \u0447\u0442\u043e-\u0442\u043e \u043d\u0430\u043f\u0438\u0441\u0430\u0442\u044c:  \u0442\u0443\u0442 \u043c\u043e\u0436\u043d\u043e \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c var :)\nvar producerRecord = new ProducerRecord<String, Object>(topicName, key, kafkaMessage);", "url": "https://github.com/hhru/nuts-and-bolts/pull/229#discussion_r388118214", "createdAt": "2020-03-05T07:31:08Z", "author": {"login": "mvxio"}, "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/producer/DefaultKafkaProducer.java", "diffHunk": "@@ -1,22 +1,31 @@\n package ru.hh.nab.kafka.producer;\n \n import java.util.concurrent.CompletableFuture;\n+import org.apache.kafka.clients.producer.ProducerRecord;\n import org.springframework.kafka.core.KafkaTemplate;\n-import org.springframework.kafka.support.SendResult;\n \n-public class DefaultKafkaProducer<T> implements KafkaProducer<T> {\n+public class DefaultKafkaProducer implements KafkaProducer {\n \n-  private final KafkaTemplate<String, T> kafkaTemplate;\n+  private final KafkaTemplate<String, Object> kafkaTemplate;\n \n-  public DefaultKafkaProducer(KafkaTemplate<String, T> kafkaTemplate) {\n+  public DefaultKafkaProducer(KafkaTemplate<String, Object> kafkaTemplate) {\n     this.kafkaTemplate = kafkaTemplate;\n   }\n \n-  public CompletableFuture<SendResult<String, T>> sendMessage(String topicName, T kafkaMessage) {\n+  public <T> CompletableFuture<SendResult<T>> sendMessage(String topicName, T kafkaMessage) {\n     return sendMessage(topicName, null, kafkaMessage);\n   }\n \n-  public CompletableFuture<SendResult<String, T>> sendMessage(String topicName, String key, T kafkaMessage) {\n-    return kafkaTemplate.send(topicName, key, kafkaMessage).completable();\n+  public <T> CompletableFuture<SendResult<T>> sendMessage(String topicName, String key, T kafkaMessage) {\n+    ProducerRecord<String, Object> producerRecord = new ProducerRecord<>(topicName, key, kafkaMessage);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36aa3aa9e6481099874199e4770342d8c86ca672"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MzQ0NDU2", "url": "https://github.com/hhru/nuts-and-bolts/pull/229#pullrequestreview-369344456", "createdAt": "2020-03-05T07:31:29Z", "commit": {"oid": "36aa3aa9e6481099874199e4770342d8c86ca672"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MzQ4OTIx", "url": "https://github.com/hhru/nuts-and-bolts/pull/229#pullrequestreview-369348921", "createdAt": "2020-03-05T07:42:24Z", "commit": {"oid": "b54ffe029dcbd3cc8462a9e59375ae15470d35df"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwNzo0MjoyNFrOFyJFew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQwNzo0MjoyNFrOFyJFew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODEyMTk3OQ==", "bodyText": "\u0442\u0435\u043f\u0435\u0440\u044c \u0432\u0441\u0435 \u043f\u043e-\u0447\u0435\u0441\u0442\u043d\u043e\u043c\u0443, \u0431\u0435\u0437 \u0441\u0442\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u043e\u0433\u043e \u043a\u0430\u0441\u0442\u0430. \u041d\u043e \u0441\u0438\u0433\u043d\u0430\u0442\u0443\u0440\u0430 \u0440\u0430\u0441\u043f\u0443\u0445\u043b\u0430 \u043d\u0430 +1 \u0430\u0440\u0433\u0443\u043c\u0435\u043d\u0442", "url": "https://github.com/hhru/nuts-and-bolts/pull/229#discussion_r388121979", "createdAt": "2020-03-05T07:42:24Z", "author": {"login": "vorobey92"}, "path": "nab-kafka/src/main/java/ru/hh/nab/kafka/producer/DefaultKafkaProducer.java", "diffHunk": "@@ -1,22 +1,43 @@\n package ru.hh.nab.kafka.producer;\n \n import java.util.concurrent.CompletableFuture;\n+import org.apache.kafka.clients.producer.ProducerRecord;\n import org.springframework.kafka.core.KafkaTemplate;\n import org.springframework.kafka.support.SendResult;\n \n-public class DefaultKafkaProducer<T> implements KafkaProducer<T> {\n+public class DefaultKafkaProducer implements KafkaProducer {\n \n-  private final KafkaTemplate<String, T> kafkaTemplate;\n+  private final KafkaTemplate<String, Object> kafkaTemplate;\n \n-  public DefaultKafkaProducer(KafkaTemplate<String, T> kafkaTemplate) {\n+  public DefaultKafkaProducer(KafkaTemplate<String, Object> kafkaTemplate) {\n     this.kafkaTemplate = kafkaTemplate;\n   }\n \n-  public CompletableFuture<SendResult<String, T>> sendMessage(String topicName, T kafkaMessage) {\n-    return sendMessage(topicName, null, kafkaMessage);\n+  public <T> CompletableFuture<KafkaSendResult<T>> sendMessage(String topicName, Class<T> messageType, T kafkaMessage) {\n+    return sendMessage(topicName, null, messageType, kafkaMessage);\n   }\n \n-  public CompletableFuture<SendResult<String, T>> sendMessage(String topicName, String key, T kafkaMessage) {\n-    return kafkaTemplate.send(topicName, key, kafkaMessage).completable();\n+  public <T> CompletableFuture<KafkaSendResult<T>> sendMessage(String topicName, String key, Class<T> messageType, T kafkaMessage) {\n+    return kafkaTemplate.send(topicName, key, kafkaMessage)\n+        .completable()\n+        .thenApply(springResult -> convertSpringSendResult(springResult, messageType));\n+  }\n+\n+  private <T> KafkaSendResult<T> convertSpringSendResult(SendResult<String, Object> springResult, Class<T> messageType) {\n+    return new KafkaSendResult<>(\n+        convertProducerRecord(springResult.getProducerRecord(), messageType),\n+        springResult.getRecordMetadata()\n+    );\n+  }\n+\n+  private <T> ProducerRecord<String, T> convertProducerRecord(ProducerRecord<String, Object> initial, Class<T> messageType) {\n+    return new ProducerRecord<>(\n+        initial.topic(),\n+        initial.partition(),\n+        initial.timestamp(),\n+        initial.key(),\n+        messageType.cast(initial.value()),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b54ffe029dcbd3cc8462a9e59375ae15470d35df"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MzUzMjk1", "url": "https://github.com/hhru/nuts-and-bolts/pull/229#pullrequestreview-369353295", "createdAt": "2020-03-05T07:52:06Z", "commit": {"oid": "b54ffe029dcbd3cc8462a9e59375ae15470d35df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fd8291a75855f666733d6d8d9662f8aa26cdaea", "author": {"user": {"login": "vorobey92", "name": "\u0418\u0432\u0430\u043d \u0412\u043e\u0440\u043e\u0431\u044c\u0435\u0432"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/2fd8291a75855f666733d6d8d9662f8aa26cdaea", "committedDate": "2020-03-05T07:54:03Z", "message": "HH-104397 remove generification from KafkaProducer interface"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b54ffe029dcbd3cc8462a9e59375ae15470d35df", "author": {"user": {"login": "vorobey92", "name": "\u0418\u0432\u0430\u043d \u0412\u043e\u0440\u043e\u0431\u044c\u0435\u0432"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/b54ffe029dcbd3cc8462a9e59375ae15470d35df", "committedDate": "2020-03-05T07:40:21Z", "message": "HH-104397 rework to dynamic cast"}, "afterCommit": {"oid": "2fd8291a75855f666733d6d8d9662f8aa26cdaea", "author": {"user": {"login": "vorobey92", "name": "\u0418\u0432\u0430\u043d \u0412\u043e\u0440\u043e\u0431\u044c\u0435\u0432"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/2fd8291a75855f666733d6d8d9662f8aa26cdaea", "committedDate": "2020-03-05T07:54:03Z", "message": "HH-104397 remove generification from KafkaProducer interface"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3394, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}