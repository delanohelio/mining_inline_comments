{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyNDQyNzE1", "number": 266, "title": "HH-117799 add new parameters in consul registration", "bodyText": "", "createdAt": "2020-10-13T15:09:39Z", "url": "https://github.com/hhru/nuts-and-bolts/pull/266", "merged": true, "mergeCommit": {"oid": "adae57f8d31ea6076d87dbb394b086695459796c"}, "closed": true, "closedAt": "2020-10-15T13:58:28Z", "author": {"login": "heruv1m"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSKLl1gFqTUwNzU1MjQ1NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSyH2bAH2gAyNTAyNDQyNzE1Ojc4YjMxZjk3MzI4NzQ1YWE4ODU0Njk2ZDhiZDNmMTNhMGQ0ZTYzYzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NTUyNDU0", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#pullrequestreview-507552454", "createdAt": "2020-10-13T15:19:35Z", "commit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNToxOTozNVrOHgsIFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNToxOTozNVrOHgsIFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAzOTQ0NA==", "bodyText": "\u043d\u0435 \u043d\u0430\u0434\u043e \u0442\u0430\u043a\u043e\u0439 \u043c\u0435\u0442\u043e\u0434. \u0435\u0441\u043b\u0438 \u0447\u0435\u0433\u043e-\u0442\u043e \u0432 \u0444\u0430\u0439\u043b\u0438\u043a\u0435 \u043d\u0435\u0442 - \u043d\u0430\u0434\u043e \u0432\u0430\u043b\u0438\u0442\u044c\u0441\u044f", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504039444", "createdAt": "2020-10-13T15:19:35Z", "author": {"login": "dzharikhin"}, "path": "nab-common/src/main/java/ru/hh/nab/common/properties/FileSettings.java", "diffHunk": "@@ -18,6 +19,10 @@ public String getString(String key) {\n     return properties.getProperty(key);\n   }\n \n+  public String getString(String key, String defaultValue) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NTU2MjM3", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#pullrequestreview-507556237", "createdAt": "2020-10-13T15:23:15Z", "commit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNToyMzoxNVrOHgsTmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNToyMzo1M1rOHgsVlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA0MjM5Mw==", "bodyText": "3 \u043c\u043e\u0436\u0435\u0442 \u0442\u043e\u0436\u0435 \u0432 \u043f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u044b? \u0432\u044b\u0433\u043b\u044f\u0434\u0438\u0442, \u0447\u0442\u043e \u044d\u0442\u043e \u0442\u0430\u043a\u0430\u044f \u0448\u0442\u0443\u043a\u0430 - \u043d\u0430\u0441\u043a\u043e\u043b\u044c\u043a\u043e \u0443\u043c\u0435\u043d\u044c\u0448\u0430\u0442\u044c \u0432\u0435\u0441 \u0441\u0435\u0440\u0432\u0438\u0441\u0430 \u043c\u043e\u0436\u0435\u0442 \u0431\u044b\u0442\u044c \u0447\u0443\u0432\u0441\u0442\u0432\u0438\u0442\u0435\u043b\u044c\u043d\u043e", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504042393", "createdAt": "2020-10-13T15:23:15Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -23,38 +25,57 @@\n   private static final Logger LOGGER = LoggerFactory.getLogger(ConsulService.class);\n \n   private static final String LOG_LEVEL_OVERRIDE_EXTENSION_TAG = \"log_level_override_extension_enabled\";\n+  private static final int DEFAULT_WEIGHT = 100;\n \n   private final AgentClient agentClient;\n+  private final KeyValueClient kvClient;\n   private final Registration service;\n   private final String id;\n   private final boolean enabled;\n \n-  public ConsulService(AgentClient agentClient, FileSettings fileSettings, String datacenter, String host, AppMetadata appMetadata,\n-                       @Nullable LogLevelOverrideExtension logLevelOverrideExtension) {\n+  public ConsulService(AgentClient agentClient, KeyValueClient kvClient,\n+                              FileSettings fileSettings, String datacenter, String hostName, AppMetadata appMetadata,\n+                              @Nullable LogLevelOverrideExtension logLevelOverrideExtension) {\n     this.agentClient = agentClient;\n+    this.kvClient = kvClient;\n+\n     var applicationPort = fileSettings.getInteger(\"jetty.port\");\n     var applicationHost = Optional.ofNullable(fileSettings.getString(\"consul.check.host\"))\n-      .orElse(\"127.0.0.1\");\n-    var id = fileSettings.getString(\"serviceName\") + \"-\" + datacenter + \"-\" + host + \"-\" + applicationPort;\n+        .orElse(\"127.0.0.1\");\n+    var id = fileSettings.getString(\"serviceName\") + \"-\" + datacenter + \"-\" + hostName + \"-\" + applicationPort;\n     var tags = new ArrayList<>(fileSettings.getStringList(\"consul.tags\"));\n     if (logLevelOverrideExtension != null) {\n       tags.add(LOG_LEVEL_OVERRIDE_EXTENSION_TAG);\n     }\n \n-    ImmutableRegCheck regCheck = ImmutableRegCheck.builder()\n-            .http(\"http://\" + applicationHost + \":\" + applicationPort + \"/status\")\n-            .interval(requireNonNullElse(fileSettings.getString(\"consul.check.interval\"), \"5s\"))\n-            .timeout(requireNonNullElse(fileSettings.getString(\"consul.check.timeout\"), \"5s\"))\n-            .build();\n+    Registration.RegCheck regCheck = ImmutableRegCheck.builder()\n+        .http(\"http://\" + applicationHost + \":\" + applicationPort + \"/status\")\n+        .interval(fileSettings.getString(\"consul.check.interval\", \"5s\"))\n+        .timeout(fileSettings.getString(\"consul.check.timeout\", \"5s\"))\n+        .deregisterCriticalServiceAfter(fileSettings.getString(\"consul.deregisterCritical.timeout\", \"10m\"))\n+        .successBeforePassing(fileSettings.getInteger(\"consul.check.successCount\", 2))\n+        .failuresBeforeCritical(fileSettings.getInteger(\"consul.check.failCount\", 2))\n+        .build();\n+    Optional<String> weight = getWeight(hostName);\n+    int weightForService;\n+    if (weight.isPresent()) {\n+      weightForService = weight.map(Integer::parseInt).get();\n+    } else {\n+      LOGGER.warn(\"No weight present for node:{}\", hostName);\n+      weightForService = DEFAULT_WEIGHT;\n+    }\n+\n+    ServiceWeights serviceWeights = ImmutableServiceWeights.builder().passing(weightForService).warning(weightForService / 3).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA0MjkwMg==", "bodyText": "\u0442\u0430\u043c \u0449\u0430\u0441 \u043f\u043e \u0434\u0435\u0444\u043e\u043b\u0442\u0443 1 \u0436\u0435?\n\u043c\u043e\u0436\u0435\u0442 \u0441\u0434\u0435\u043b\u0430\u0442\u044c \u0431\u0435\u0437 \u0434\u0435\u0444\u043e\u043b\u0442\u043d\u043e\u0433\u043e \u0432\u0435\u0441\u0430? \u043d\u0443 \u0442\u0438\u043f\u0430 \u043f\u0440\u043e\u0441\u0442\u043e \u043d\u0435 \u0440\u0435\u0433\u0430\u0435\u043c \u0432\u0435\u0441, \u0435\u0441\u043b\u0438 \u0435\u0433\u043e \u043d\u0435\u0442?", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504042902", "createdAt": "2020-10-13T15:23:53Z", "author": {"login": "dzharikhin"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -23,38 +25,57 @@\n   private static final Logger LOGGER = LoggerFactory.getLogger(ConsulService.class);\n \n   private static final String LOG_LEVEL_OVERRIDE_EXTENSION_TAG = \"log_level_override_extension_enabled\";\n+  private static final int DEFAULT_WEIGHT = 100;\n \n   private final AgentClient agentClient;\n+  private final KeyValueClient kvClient;\n   private final Registration service;\n   private final String id;\n   private final boolean enabled;\n \n-  public ConsulService(AgentClient agentClient, FileSettings fileSettings, String datacenter, String host, AppMetadata appMetadata,\n-                       @Nullable LogLevelOverrideExtension logLevelOverrideExtension) {\n+  public ConsulService(AgentClient agentClient, KeyValueClient kvClient,\n+                              FileSettings fileSettings, String datacenter, String hostName, AppMetadata appMetadata,\n+                              @Nullable LogLevelOverrideExtension logLevelOverrideExtension) {\n     this.agentClient = agentClient;\n+    this.kvClient = kvClient;\n+\n     var applicationPort = fileSettings.getInteger(\"jetty.port\");\n     var applicationHost = Optional.ofNullable(fileSettings.getString(\"consul.check.host\"))\n-      .orElse(\"127.0.0.1\");\n-    var id = fileSettings.getString(\"serviceName\") + \"-\" + datacenter + \"-\" + host + \"-\" + applicationPort;\n+        .orElse(\"127.0.0.1\");\n+    var id = fileSettings.getString(\"serviceName\") + \"-\" + datacenter + \"-\" + hostName + \"-\" + applicationPort;\n     var tags = new ArrayList<>(fileSettings.getStringList(\"consul.tags\"));\n     if (logLevelOverrideExtension != null) {\n       tags.add(LOG_LEVEL_OVERRIDE_EXTENSION_TAG);\n     }\n \n-    ImmutableRegCheck regCheck = ImmutableRegCheck.builder()\n-            .http(\"http://\" + applicationHost + \":\" + applicationPort + \"/status\")\n-            .interval(requireNonNullElse(fileSettings.getString(\"consul.check.interval\"), \"5s\"))\n-            .timeout(requireNonNullElse(fileSettings.getString(\"consul.check.timeout\"), \"5s\"))\n-            .build();\n+    Registration.RegCheck regCheck = ImmutableRegCheck.builder()\n+        .http(\"http://\" + applicationHost + \":\" + applicationPort + \"/status\")\n+        .interval(fileSettings.getString(\"consul.check.interval\", \"5s\"))\n+        .timeout(fileSettings.getString(\"consul.check.timeout\", \"5s\"))\n+        .deregisterCriticalServiceAfter(fileSettings.getString(\"consul.deregisterCritical.timeout\", \"10m\"))\n+        .successBeforePassing(fileSettings.getInteger(\"consul.check.successCount\", 2))\n+        .failuresBeforeCritical(fileSettings.getInteger(\"consul.check.failCount\", 2))\n+        .build();\n+    Optional<String> weight = getWeight(hostName);\n+    int weightForService;\n+    if (weight.isPresent()) {\n+      weightForService = weight.map(Integer::parseInt).get();\n+    } else {\n+      LOGGER.warn(\"No weight present for node:{}\", hostName);\n+      weightForService = DEFAULT_WEIGHT;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NTYzMTQz", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#pullrequestreview-507563143", "createdAt": "2020-10-13T15:27:16Z", "commit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNToyNzoxNlrOHgsglQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNTozMjowOFrOHgs0XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA0NTcxNw==", "bodyText": "\u041a\u0430\u043a-\u0442\u043e \u0441\u0442\u0440\u0430\u043d\u043d\u043e \u043e\u0442\u0441\u0442\u0443\u043f\u044b \u0440\u0430\u0437\u044a\u0435\u0445\u0430\u043b\u0438\u0441\u044c", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504045717", "createdAt": "2020-10-13T15:27:16Z", "author": {"login": "pvorlov"}, "path": "nab-starter/src/main/java/ru/hh/nab/starter/ConsulService.java", "diffHunk": "@@ -23,38 +25,57 @@\n   private static final Logger LOGGER = LoggerFactory.getLogger(ConsulService.class);\n \n   private static final String LOG_LEVEL_OVERRIDE_EXTENSION_TAG = \"log_level_override_extension_enabled\";\n+  private static final int DEFAULT_WEIGHT = 100;\n \n   private final AgentClient agentClient;\n+  private final KeyValueClient kvClient;\n   private final Registration service;\n   private final String id;\n   private final boolean enabled;\n \n-  public ConsulService(AgentClient agentClient, FileSettings fileSettings, String datacenter, String host, AppMetadata appMetadata,\n-                       @Nullable LogLevelOverrideExtension logLevelOverrideExtension) {\n+  public ConsulService(AgentClient agentClient, KeyValueClient kvClient,\n+                              FileSettings fileSettings, String datacenter, String hostName, AppMetadata appMetadata,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDA1MDc4MQ==", "bodyText": "\u042f \u0434\u0443\u043c\u0430\u044e \u043f\u0440\u0438 \u043e\u0434\u043d\u043e\u0439 \u0432\u0435\u0440\u0441\u0438\u0438 \u043e\u0442 orbitz \u043c\u043e\u0436\u0435\u0442 \u0431\u044b\u0442\u044c \u043d\u0435\u0441\u043a\u043e\u043b\u044c\u043a\u043e \u0432\u0435\u0440\u0441\u0438\u0439 hh, \u043c\u043e\u0436\u0435\u0442 \u0447\u0442\u043e-\u0442\u043e \u0432\u0440\u043e\u0434\u0435 1.4.0.hh.1.0?", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#discussion_r504050781", "createdAt": "2020-10-13T15:32:08Z", "author": {"login": "pvorlov"}, "path": "pom.xml", "diffHunk": "@@ -44,7 +44,7 @@\n         <jclient.version>1.7.5</jclient.version>\n         <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>\n         <java.version>11</java.version>\n-        <orbitz.consul.version>1.4.0</orbitz.consul.version>\n+        <orbitz.consul.version>1.4.0-hh</orbitz.consul.version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6055085695e305ab528e9c22a36ede8567170694"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5MjU2OTI2", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#pullrequestreview-509256926", "createdAt": "2020-10-15T10:57:53Z", "commit": {"oid": "3830134fa1885ad17289d9eb1157c66ae2bb0dda"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5MjczNjg1", "url": "https://github.com/hhru/nuts-and-bolts/pull/266#pullrequestreview-509273685", "createdAt": "2020-10-15T11:21:51Z", "commit": {"oid": "3830134fa1885ad17289d9eb1157c66ae2bb0dda"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64f5e30440fb013219216a2843ad98e100aa3a60", "author": {"user": {"login": "heruv1m", "name": "Alexander Kazantsev"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/64f5e30440fb013219216a2843ad98e100aa3a60", "committedDate": "2020-10-15T12:44:34Z", "message": "HH-117799 add new parameters in consul registration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95894878f3e63c9f2fe7a003beebf9bb4a1451a9", "author": {"user": {"login": "heruv1m", "name": "Alexander Kazantsev"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/95894878f3e63c9f2fe7a003beebf9bb4a1451a9", "committedDate": "2020-10-15T12:44:34Z", "message": "HH-117799 add new parameters in consul registration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1bd9a9ab2b58f1387d7677c1511623ac5ba4ce2", "author": {"user": {"login": "heruv1m", "name": "Alexander Kazantsev"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/b1bd9a9ab2b58f1387d7677c1511623ac5ba4ce2", "committedDate": "2020-10-15T12:44:34Z", "message": "HH-117799 add new parameters in consul registration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94c7953dd0c919323e1d82035f2f28e25a3e1249", "author": {"user": {"login": "heruv1m", "name": "Alexander Kazantsev"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/94c7953dd0c919323e1d82035f2f28e25a3e1249", "committedDate": "2020-10-15T12:44:34Z", "message": "HH-117799 add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80db3234239e572600b9e051ab0e2c3a92183543", "author": {"user": {"login": "heruv1m", "name": "Alexander Kazantsev"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/80db3234239e572600b9e051ab0e2c3a92183543", "committedDate": "2020-10-15T12:44:34Z", "message": "HH-117799 add new parameters in consul registration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "304fbf05125b89433037c111bc929bb10c3a8ea4", "author": {"user": {"login": "heruv1m", "name": "Alexander Kazantsev"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/304fbf05125b89433037c111bc929bb10c3a8ea4", "committedDate": "2020-10-15T12:44:34Z", "message": "HH-117799 up consul version"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3d29c910e1ea035afc368e39de6c9429f677dac7", "author": {"user": {"login": "heruv1m", "name": "Alexander Kazantsev"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/3d29c910e1ea035afc368e39de6c9429f677dac7", "committedDate": "2020-10-15T12:35:46Z", "message": "HH-117799 up consul version"}, "afterCommit": {"oid": "304fbf05125b89433037c111bc929bb10c3a8ea4", "author": {"user": {"login": "heruv1m", "name": "Alexander Kazantsev"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/304fbf05125b89433037c111bc929bb10c3a8ea4", "committedDate": "2020-10-15T12:44:34Z", "message": "HH-117799 up consul version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78b31f97328745aa8854696d8bd3f13a0d4e63c5", "author": {"user": {"login": "heruv1m", "name": "Alexander Kazantsev"}}, "url": "https://github.com/hhru/nuts-and-bolts/commit/78b31f97328745aa8854696d8bd3f13a0d4e63c5", "committedDate": "2020-10-15T13:51:42Z", "message": "HH-117799 up consul version"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3346, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}