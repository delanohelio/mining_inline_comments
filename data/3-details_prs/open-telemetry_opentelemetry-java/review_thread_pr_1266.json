{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxOTQ4NTY0", "number": 1266, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxNToxMDowN1rOD_acVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxNToyMjoyOFrOD_apiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3ODIwMTE2OnYy", "diffSide": "RIGHT", "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxNToxMDowN1rOGaEFCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwMTo1OTo1OFrOGaMeUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk4Mjk4Nw==", "bodyText": "Could be simplified to if null { remove } return;", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1266#discussion_r429982987", "createdAt": "2020-05-25T15:10:07Z", "author": {"login": "arminru"}, "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java", "diffHunk": "@@ -176,10 +173,16 @@\n     Objects.requireNonNull(key, \"key\");\n     if (value == null\n         || (value.getType() == AttributeValue.Type.STRING && value.getStringValue() == null)) {\n+      if (attributes == null) {\n+        return this;\n+      }\n       attributes.remove(key);\n-    } else {\n-      attributes.put(key, value);\n+      return this;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee8a6f3d324975e338345a2fa1c36add0c186dd3"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEyMDUyOA==", "bodyText": "Done.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1266#discussion_r430120528", "createdAt": "2020-05-26T01:59:58Z", "author": {"login": "bogdandrutu"}, "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/SpanBuilderSdk.java", "diffHunk": "@@ -176,10 +173,16 @@\n     Objects.requireNonNull(key, \"key\");\n     if (value == null\n         || (value.getType() == AttributeValue.Type.STRING && value.getStringValue() == null)) {\n+      if (attributes == null) {\n+        return this;\n+      }\n       attributes.remove(key);\n-    } else {\n-      attributes.put(key, value);\n+      return this;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk4Mjk4Nw=="}, "originalCommit": {"oid": "ee8a6f3d324975e338345a2fa1c36add0c186dd3"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3ODIyMDY0OnYy", "diffSide": "RIGHT", "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/RecordEventsReadableSpan.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxNToxNjo1OVrOGaEQwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwODoyNjozNFrOGaT1Bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk4NTk4Ng==", "bodyText": "Why are attributes nullable but links aren't?", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1266#discussion_r429985986", "createdAt": "2020-05-25T15:16:59Z", "author": {"login": "arminru"}, "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/RecordEventsReadableSpan.java", "diffHunk": "@@ -84,7 +84,8 @@\n   private final long startEpochNanos;\n   // Set of recorded attributes. DO NOT CALL any other method that changes the ordering of events.\n   @GuardedBy(\"lock\")\n-  private final AttributesMap attributes;\n+  @Nullable\n+  private AttributesMap attributes;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee8a6f3d324975e338345a2fa1c36add0c186dd3"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEyMDA0MA==", "bodyText": "Links is a final argument because the Span does not have an API to add links (only the builder) so it is fine to just use emptyList (which is immutable) if no links were added to avoid all null checks. In the case of attributes if I use emptyMap does not give me any benefit because that is immutable so I still need to have all checks before adding elements to the map.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1266#discussion_r430120040", "createdAt": "2020-05-26T01:57:29Z", "author": {"login": "bogdandrutu"}, "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/RecordEventsReadableSpan.java", "diffHunk": "@@ -84,7 +84,8 @@\n   private final long startEpochNanos;\n   // Set of recorded attributes. DO NOT CALL any other method that changes the ordering of events.\n   @GuardedBy(\"lock\")\n-  private final AttributesMap attributes;\n+  @Nullable\n+  private AttributesMap attributes;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk4NTk4Ng=="}, "originalCommit": {"oid": "ee8a6f3d324975e338345a2fa1c36add0c186dd3"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDI0MTAzMA==", "bodyText": "Thanks for clarifying!", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1266#discussion_r430241030", "createdAt": "2020-05-26T08:26:34Z", "author": {"login": "arminru"}, "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/RecordEventsReadableSpan.java", "diffHunk": "@@ -84,7 +84,8 @@\n   private final long startEpochNanos;\n   // Set of recorded attributes. DO NOT CALL any other method that changes the ordering of events.\n   @GuardedBy(\"lock\")\n-  private final AttributesMap attributes;\n+  @Nullable\n+  private AttributesMap attributes;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk4NTk4Ng=="}, "originalCommit": {"oid": "ee8a6f3d324975e338345a2fa1c36add0c186dd3"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3ODIzMjAzOnYy", "diffSide": "RIGHT", "path": "sdk/src/test/java/io/opentelemetry/sdk/trace/SpanBuilderSdkTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxNToyMToyMVrOGaEXug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwMjowMjo0MlrOGaMgfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk4Nzc3MA==", "bodyText": "You might want to use a different SpanContext here, otherwise the missing effect could also come from a check that links are not duplicated (or a set being used internally).", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1266#discussion_r429987770", "createdAt": "2020-05-25T15:21:21Z", "author": {"login": "arminru"}, "path": "sdk/src/test/java/io/opentelemetry/sdk/trace/SpanBuilderSdkTest.java", "diffHunk": "@@ -177,6 +177,24 @@ public void changingAttributes_NoEffectAfterAddLink() {\n     }\n   }\n \n+  @Test\n+  public void addLink_NoEffectAfterStartSpan() {\n+    Span.Builder spanBuilder = tracerSdk.spanBuilder(SPAN_NAME);\n+    spanBuilder.addLink(sampledSpanContext);\n+    RecordEventsReadableSpan span = (RecordEventsReadableSpan) spanBuilder.startSpan();\n+    try {\n+      assertThat(span.toSpanData().getLinks())\n+          .containsExactly(\n+              Link.create(sampledSpanContext, Collections.<String, AttributeValue>emptyMap()));\n+      spanBuilder.addLink(sampledSpanContext);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee8a6f3d324975e338345a2fa1c36add0c186dd3"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEyMTA4Nw==", "bodyText": "Done, also added a comment to explain.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1266#discussion_r430121087", "createdAt": "2020-05-26T02:02:42Z", "author": {"login": "bogdandrutu"}, "path": "sdk/src/test/java/io/opentelemetry/sdk/trace/SpanBuilderSdkTest.java", "diffHunk": "@@ -177,6 +177,24 @@ public void changingAttributes_NoEffectAfterAddLink() {\n     }\n   }\n \n+  @Test\n+  public void addLink_NoEffectAfterStartSpan() {\n+    Span.Builder spanBuilder = tracerSdk.spanBuilder(SPAN_NAME);\n+    spanBuilder.addLink(sampledSpanContext);\n+    RecordEventsReadableSpan span = (RecordEventsReadableSpan) spanBuilder.startSpan();\n+    try {\n+      assertThat(span.toSpanData().getLinks())\n+          .containsExactly(\n+              Link.create(sampledSpanContext, Collections.<String, AttributeValue>emptyMap()));\n+      spanBuilder.addLink(sampledSpanContext);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk4Nzc3MA=="}, "originalCommit": {"oid": "ee8a6f3d324975e338345a2fa1c36add0c186dd3"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3ODIzNDk2OnYy", "diffSide": "RIGHT", "path": "sdk/src/test/java/io/opentelemetry/sdk/trace/SpanBuilderSdkTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxNToyMjoyOFrOGaEZow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwMjowMDoyNlrOGaMeuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk4ODI1OQ==", "bodyText": "\ud83d\udc4d for covering this!", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1266#discussion_r429988259", "createdAt": "2020-05-25T15:22:28Z", "author": {"login": "arminru"}, "path": "sdk/src/test/java/io/opentelemetry/sdk/trace/SpanBuilderSdkTest.java", "diffHunk": "@@ -384,6 +431,27 @@ public void droppingAttributes() {\n     }\n   }\n \n+  @Test\n+  public void addAttributes_OnlyViaSampler() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee8a6f3d324975e338345a2fa1c36add0c186dd3"}, "originalPosition": 136}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEyMDYzMw==", "bodyText": "You are welcome :)", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1266#discussion_r430120633", "createdAt": "2020-05-26T02:00:26Z", "author": {"login": "bogdandrutu"}, "path": "sdk/src/test/java/io/opentelemetry/sdk/trace/SpanBuilderSdkTest.java", "diffHunk": "@@ -384,6 +431,27 @@ public void droppingAttributes() {\n     }\n   }\n \n+  @Test\n+  public void addAttributes_OnlyViaSampler() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTk4ODI1OQ=="}, "originalCommit": {"oid": "ee8a6f3d324975e338345a2fa1c36add0c186dd3"}, "originalPosition": 136}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 720, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}