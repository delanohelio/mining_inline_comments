{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNDYwMjY0", "number": 1800, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNzoyMDo0NlrOEtlcsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMDowMzoxN1rOEvjB4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MjM0OTI4OnYy", "diffSide": "RIGHT", "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/Adapter.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNzoyMDo0NlrOHhdVZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNTo1NTo0NVrOHjGe4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg0NTY3MA==", "bodyText": "Why is this needed?", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r504845670", "createdAt": "2020-10-14T17:20:46Z", "author": {"login": "bogdandrutu"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/Adapter.java", "diffHunk": "@@ -192,7 +196,10 @@ private Adapter() {}\n   @VisibleForTesting\n   static <T> Model.KeyValue toKeyValue(AttributeKey<T> key, T value) {\n     Model.KeyValue.Builder builder = Model.KeyValue.newBuilder();\n-    builder.setKey(key.getKey());\n+    builder.setKey(\n+        key.getKey()\n+            .replace(\"InstrumentationLibrary.name\", \"otel.library.name\")\n+            .replace(\"InstrumentationLibrary.version\", \"otel.library.version\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cdbcfe0eb8ea9397fdf186c7130b088e1527a22"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA4ODk3NA==", "bodyText": "Thanks @malafeev - looks like there was some confusion on the issue, yeah you shouldn't need to do any sort of name translation logic.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r505088974", "createdAt": "2020-10-15T00:04:42Z", "author": {"login": "anuraaga"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/Adapter.java", "diffHunk": "@@ -192,7 +196,10 @@ private Adapter() {}\n   @VisibleForTesting\n   static <T> Model.KeyValue toKeyValue(AttributeKey<T> key, T value) {\n     Model.KeyValue.Builder builder = Model.KeyValue.newBuilder();\n-    builder.setKey(key.getKey());\n+    builder.setKey(\n+        key.getKey()\n+            .replace(\"InstrumentationLibrary.name\", \"otel.library.name\")\n+            .replace(\"InstrumentationLibrary.version\", \"otel.library.version\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg0NTY3MA=="}, "originalCommit": {"oid": "8cdbcfe0eb8ea9397fdf186c7130b088e1527a22"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU2NzI4Ng==", "bodyText": "removed", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r506567286", "createdAt": "2020-10-16T15:53:53Z", "author": {"login": "malafeev"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/Adapter.java", "diffHunk": "@@ -192,7 +196,10 @@ private Adapter() {}\n   @VisibleForTesting\n   static <T> Model.KeyValue toKeyValue(AttributeKey<T> key, T value) {\n     Model.KeyValue.Builder builder = Model.KeyValue.newBuilder();\n-    builder.setKey(key.getKey());\n+    builder.setKey(\n+        key.getKey()\n+            .replace(\"InstrumentationLibrary.name\", \"otel.library.name\")\n+            .replace(\"InstrumentationLibrary.version\", \"otel.library.version\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg0NTY3MA=="}, "originalCommit": {"oid": "8cdbcfe0eb8ea9397fdf186c7130b088e1527a22"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU2ODQxOA==", "bodyText": "I was confused by https://github.com/open-telemetry/opentelemetry-specification/blob/master/specification/trace/sdk_exporters/jaeger.md#resource\nI decided that InstrumentationLibrary.name should be translated into otel.library.name etc", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r506568418", "createdAt": "2020-10-16T15:55:45Z", "author": {"login": "malafeev"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/Adapter.java", "diffHunk": "@@ -192,7 +196,10 @@ private Adapter() {}\n   @VisibleForTesting\n   static <T> Model.KeyValue toKeyValue(AttributeKey<T> key, T value) {\n     Model.KeyValue.Builder builder = Model.KeyValue.newBuilder();\n-    builder.setKey(key.getKey());\n+    builder.setKey(\n+        key.getKey()\n+            .replace(\"InstrumentationLibrary.name\", \"otel.library.name\")\n+            .replace(\"InstrumentationLibrary.version\", \"otel.library.version\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDg0NTY3MA=="}, "originalCommit": {"oid": "8cdbcfe0eb8ea9397fdf186c7130b088e1527a22"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2Mzg0NjU1OnYy", "diffSide": "RIGHT", "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/Adapter.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwMDowNToyMFrOHhsMkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNTo1MzoxOVrOHjGZPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA4OTE3MA==", "bodyText": "Resource corresponds to process, so we want to add these to the process's tags. Can you move this logic to the process here?\nhttps://github.com/open-telemetry/opentelemetry-java/blob/master/exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/JaegerGrpcSpanExporter.java#L89", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r505089170", "createdAt": "2020-10-15T00:05:20Z", "author": {"login": "anuraaga"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/Adapter.java", "diffHunk": "@@ -75,6 +75,10 @@ private Adapter() {}\n     target.addAllLogs(toJaegerLogs(span.getEvents()));\n     target.addAllReferences(toSpanRefs(span.getLinks()));\n \n+    if (span.getResource() != null && span.getResource().getAttributes() != null) {\n+      target.addAllTags(toKeyValues(span.getResource().getAttributes()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8cdbcfe0eb8ea9397fdf186c7130b088e1527a22"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE0ODU3NA==", "bodyText": "@anuraaga there I don't have SpanData to get span.getResource().getAttributes().\nshould I get resource attributes using Resource.getDefault().getAttributes() ?", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r505148574", "createdAt": "2020-10-15T03:52:11Z", "author": {"login": "malafeev"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/Adapter.java", "diffHunk": "@@ -75,6 +75,10 @@ private Adapter() {}\n     target.addAllLogs(toJaegerLogs(span.getEvents()));\n     target.addAllReferences(toSpanRefs(span.getLinks()));\n \n+    if (span.getResource() != null && span.getResource().getAttributes() != null) {\n+      target.addAllTags(toKeyValues(span.getResource().getAttributes()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA4OTE3MA=="}, "originalCommit": {"oid": "8cdbcfe0eb8ea9397fdf186c7130b088e1527a22"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE2MjI5MQ==", "bodyText": "Oh interesting - in that case I think this does need to be a bigger refactoring to move the process struct construction into the export flow. We should be able to follow a logic flow very similar to OTLP which starts by grouping by resource\nhttps://www.github.com/open-telemetry/opentelemetry-java/tree/master/exporters%2Fotlp%2Fsrc%2Fmain%2Fjava%2Fio%2Fopentelemetry%2Fexporters%2Fotlp%2FSpanAdapter.java", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r505162291", "createdAt": "2020-10-15T04:51:06Z", "author": {"login": "anuraaga"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/Adapter.java", "diffHunk": "@@ -75,6 +75,10 @@ private Adapter() {}\n     target.addAllLogs(toJaegerLogs(span.getEvents()));\n     target.addAllReferences(toSpanRefs(span.getLinks()));\n \n+    if (span.getResource() != null && span.getResource().getAttributes() != null) {\n+      target.addAllTags(toKeyValues(span.getResource().getAttributes()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA4OTE3MA=="}, "originalCommit": {"oid": "8cdbcfe0eb8ea9397fdf186c7130b088e1527a22"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTI1Nzc5NQ==", "bodyText": "Collector.PostSpansRequest accepts only one Model.Batch. But Model.Batch is per Model.Process.\nhttps://github.com/open-telemetry/opentelemetry-java/blob/master/exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/JaegerGrpcSpanExporter.java#L107\nIf there are several different Resources then I need to create several batches and send several requests.\nShould I change collector.proto to accept multiple batches?\nMy concern is that jaeger backend will not accept such payload.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r505257795", "createdAt": "2020-10-15T07:23:17Z", "author": {"login": "malafeev"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/Adapter.java", "diffHunk": "@@ -75,6 +75,10 @@ private Adapter() {}\n     target.addAllLogs(toJaegerLogs(span.getEvents()));\n     target.addAllReferences(toSpanRefs(span.getLinks()));\n \n+    if (span.getResource() != null && span.getResource().getAttributes() != null) {\n+      target.addAllTags(toKeyValues(span.getResource().getAttributes()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA4OTE3MA=="}, "originalCommit": {"oid": "8cdbcfe0eb8ea9397fdf186c7130b088e1527a22"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTg5MDYzMw==", "bodyText": "Not an expert in this, but my guess is that we'll need to change the exporter to potentially send more than one batch, one per Resource on the span data. The case where you get multiple Resources per batch of spans should be very rare, so I wouldn't worry about the fact that we're sending multiple requests per export too much.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r505890633", "createdAt": "2020-10-15T22:04:28Z", "author": {"login": "jkwatson"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/Adapter.java", "diffHunk": "@@ -75,6 +75,10 @@ private Adapter() {}\n     target.addAllLogs(toJaegerLogs(span.getEvents()));\n     target.addAllReferences(toSpanRefs(span.getLinks()));\n \n+    if (span.getResource() != null && span.getResource().getAttributes() != null) {\n+      target.addAllTags(toKeyValues(span.getResource().getAttributes()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA4OTE3MA=="}, "originalCommit": {"oid": "8cdbcfe0eb8ea9397fdf186c7130b088e1527a22"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU2Njk3NQ==", "bodyText": "refactored to group spans by resource and then set process tags per resource", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r506566975", "createdAt": "2020-10-16T15:53:19Z", "author": {"login": "malafeev"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/Adapter.java", "diffHunk": "@@ -75,6 +75,10 @@ private Adapter() {}\n     target.addAllLogs(toJaegerLogs(span.getEvents()));\n     target.addAllReferences(toSpanRefs(span.getLinks()));\n \n+    if (span.getResource() != null && span.getResource().getAttributes() != null) {\n+      target.addAllTags(toKeyValues(span.getResource().getAttributes()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTA4OTE3MA=="}, "originalCommit": {"oid": "8cdbcfe0eb8ea9397fdf186c7130b088e1527a22"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3MzEwODk5OnYy", "diffSide": "RIGHT", "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/Adapter.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNjo1NjoxOVrOHjIjiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNDozMTo0M1rOHkRoxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYwMjM3Nw==", "bodyText": "Did you consider using a java 8 Stream with a groupingBy collector to do this work? It might read a little more clearly. It's a one-liner in this case:\n    return spans.stream().collect(Collectors.groupingBy(SpanData::getResource));", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r506602377", "createdAt": "2020-10-16T16:56:19Z", "author": {"login": "jkwatson"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/Adapter.java", "diffHunk": "@@ -39,6 +42,22 @@\n \n   private Adapter() {}\n \n+  /**\n+   * Groups {@link SpanData}'s by {@link Resource}.\n+   *\n+   * @param spans the list of spans to be grouped\n+   * @return the map of grouped spans\n+   */\n+  static Map<Resource, List<SpanData>> groupByResource(Collection<SpanData> spans) {\n+    Map<Resource, List<SpanData>> result = new HashMap<>();\n+    for (SpanData spanData : spans) {\n+      Resource resource = spanData.getResource();\n+      List<SpanData> spanDataList = result.computeIfAbsent(resource, k -> new ArrayList<>());\n+      spanDataList.add(spanData);\n+    }\n+    return result;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b13536fee97013122f5d06de6565c68530846031"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYwMzM5NA==", "bodyText": "(and, given that it's a one-liner...you can probably just one-liner it in the calling code, rather than adding a function here.)", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r506603394", "createdAt": "2020-10-16T16:58:09Z", "author": {"login": "jkwatson"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/Adapter.java", "diffHunk": "@@ -39,6 +42,22 @@\n \n   private Adapter() {}\n \n+  /**\n+   * Groups {@link SpanData}'s by {@link Resource}.\n+   *\n+   * @param spans the list of spans to be grouped\n+   * @return the map of grouped spans\n+   */\n+  static Map<Resource, List<SpanData>> groupByResource(Collection<SpanData> spans) {\n+    Map<Resource, List<SpanData>> result = new HashMap<>();\n+    for (SpanData spanData : spans) {\n+      Resource resource = spanData.getResource();\n+      List<SpanData> spanDataList = result.computeIfAbsent(resource, k -> new ArrayList<>());\n+      spanDataList.add(spanData);\n+    }\n+    return result;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYwMjM3Nw=="}, "originalCommit": {"oid": "b13536fee97013122f5d06de6565c68530846031"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc5OTc1MA==", "bodyText": "done", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r507799750", "createdAt": "2020-10-19T14:31:43Z", "author": {"login": "malafeev"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/Adapter.java", "diffHunk": "@@ -39,6 +42,22 @@\n \n   private Adapter() {}\n \n+  /**\n+   * Groups {@link SpanData}'s by {@link Resource}.\n+   *\n+   * @param spans the list of spans to be grouped\n+   * @return the map of grouped spans\n+   */\n+  static Map<Resource, List<SpanData>> groupByResource(Collection<SpanData> spans) {\n+    Map<Resource, List<SpanData>> result = new HashMap<>();\n+    for (SpanData spanData : spans) {\n+      Resource resource = spanData.getResource();\n+      List<SpanData> spanDataList = result.computeIfAbsent(resource, k -> new ArrayList<>());\n+      spanDataList.add(spanData);\n+    }\n+    return result;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYwMjM3Nw=="}, "originalCommit": {"oid": "b13536fee97013122f5d06de6565c68530846031"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3MzEyNDk3OnYy", "diffSide": "RIGHT", "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/JaegerGrpcSpanExporter.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNzowMTowNlrOHjItnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMzo0NDo0NVrOHkpiog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYwNDk1Ng==", "bodyText": "I'd extract lines 120-132 into a separate method, and then you could use a java 8 Stream/map to collapse this logic significantly.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r506604956", "createdAt": "2020-10-16T17:01:06Z", "author": {"login": "jkwatson"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/JaegerGrpcSpanExporter.java", "diffHunk": "@@ -104,26 +109,42 @@ private JaegerGrpcSpanExporter(String serviceName, ManagedChannel channel, long\n    */\n   @Override\n   public CompletableResultCode export(Collection<SpanData> spans) {\n-    Collector.PostSpansRequest request =\n-        Collector.PostSpansRequest.newBuilder()\n-            .setBatch(\n-                Model.Batch.newBuilder()\n-                    .addAllSpans(Adapter.toJaeger(spans))\n-                    .setProcess(this.process)\n-                    .build())\n-            .build();\n-\n     CollectorServiceGrpc.CollectorServiceFutureStub stub = this.stub;\n     if (deadlineMs > 0) {\n       stub = stub.withDeadlineAfter(deadlineMs, TimeUnit.MILLISECONDS);\n     }\n \n+    Map<Resource, List<SpanData>> resourceAndSpanData = Adapter.groupByResource(spans);\n+    List<Collector.PostSpansRequest> requests = new ArrayList<>();\n+    for (Map.Entry<Resource, List<SpanData>> entry : resourceAndSpanData.entrySet()) {\n+      Process.Builder builder = this.processBuilder.clone();\n+      if (entry.getKey().getAttributes() != null) {\n+        builder.addAllTags(Adapter.toKeyValues(entry.getKey().getAttributes()));\n+      }\n+\n+      Collector.PostSpansRequest request =\n+          Collector.PostSpansRequest.newBuilder()\n+              .setBatch(\n+                  Model.Batch.newBuilder()\n+                      .addAllSpans(Adapter.toJaeger(entry.getValue()))\n+                      .setProcess(builder.build())\n+                      .build())\n+              .build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b13536fee97013122f5d06de6565c68530846031"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYwNTk4Nw==", "bodyText": "Also, please add a unit test to the JaegerGrpcSpanExporterTest to cover this change.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r506605987", "createdAt": "2020-10-16T17:03:24Z", "author": {"login": "jkwatson"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/JaegerGrpcSpanExporter.java", "diffHunk": "@@ -104,26 +109,42 @@ private JaegerGrpcSpanExporter(String serviceName, ManagedChannel channel, long\n    */\n   @Override\n   public CompletableResultCode export(Collection<SpanData> spans) {\n-    Collector.PostSpansRequest request =\n-        Collector.PostSpansRequest.newBuilder()\n-            .setBatch(\n-                Model.Batch.newBuilder()\n-                    .addAllSpans(Adapter.toJaeger(spans))\n-                    .setProcess(this.process)\n-                    .build())\n-            .build();\n-\n     CollectorServiceGrpc.CollectorServiceFutureStub stub = this.stub;\n     if (deadlineMs > 0) {\n       stub = stub.withDeadlineAfter(deadlineMs, TimeUnit.MILLISECONDS);\n     }\n \n+    Map<Resource, List<SpanData>> resourceAndSpanData = Adapter.groupByResource(spans);\n+    List<Collector.PostSpansRequest> requests = new ArrayList<>();\n+    for (Map.Entry<Resource, List<SpanData>> entry : resourceAndSpanData.entrySet()) {\n+      Process.Builder builder = this.processBuilder.clone();\n+      if (entry.getKey().getAttributes() != null) {\n+        builder.addAllTags(Adapter.toKeyValues(entry.getKey().getAttributes()));\n+      }\n+\n+      Collector.PostSpansRequest request =\n+          Collector.PostSpansRequest.newBuilder()\n+              .setBatch(\n+                  Model.Batch.newBuilder()\n+                      .addAllSpans(Adapter.toJaeger(entry.getValue()))\n+                      .setProcess(builder.build())\n+                      .build())\n+              .build();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYwNDk1Ng=="}, "originalCommit": {"oid": "b13536fee97013122f5d06de6565c68530846031"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzc5OTY0NA==", "bodyText": "done", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r507799644", "createdAt": "2020-10-19T14:31:38Z", "author": {"login": "malafeev"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/JaegerGrpcSpanExporter.java", "diffHunk": "@@ -104,26 +109,42 @@ private JaegerGrpcSpanExporter(String serviceName, ManagedChannel channel, long\n    */\n   @Override\n   public CompletableResultCode export(Collection<SpanData> spans) {\n-    Collector.PostSpansRequest request =\n-        Collector.PostSpansRequest.newBuilder()\n-            .setBatch(\n-                Model.Batch.newBuilder()\n-                    .addAllSpans(Adapter.toJaeger(spans))\n-                    .setProcess(this.process)\n-                    .build())\n-            .build();\n-\n     CollectorServiceGrpc.CollectorServiceFutureStub stub = this.stub;\n     if (deadlineMs > 0) {\n       stub = stub.withDeadlineAfter(deadlineMs, TimeUnit.MILLISECONDS);\n     }\n \n+    Map<Resource, List<SpanData>> resourceAndSpanData = Adapter.groupByResource(spans);\n+    List<Collector.PostSpansRequest> requests = new ArrayList<>();\n+    for (Map.Entry<Resource, List<SpanData>> entry : resourceAndSpanData.entrySet()) {\n+      Process.Builder builder = this.processBuilder.clone();\n+      if (entry.getKey().getAttributes() != null) {\n+        builder.addAllTags(Adapter.toKeyValues(entry.getKey().getAttributes()));\n+      }\n+\n+      Collector.PostSpansRequest request =\n+          Collector.PostSpansRequest.newBuilder()\n+              .setBatch(\n+                  Model.Batch.newBuilder()\n+                      .addAllSpans(Adapter.toJaeger(entry.getValue()))\n+                      .setProcess(builder.build())\n+                      .build())\n+              .build();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYwNDk1Ng=="}, "originalCommit": {"oid": "b13536fee97013122f5d06de6565c68530846031"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODAyNDEyNg==", "bodyText": "I think it would be good to have a test that uses multiple resources, so we can verify that multiple batches are sent, and we don't just use the first Resource we find. I didn't see this case in the test code. did I miss it?", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r508024126", "createdAt": "2020-10-19T19:55:31Z", "author": {"login": "jkwatson"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/JaegerGrpcSpanExporter.java", "diffHunk": "@@ -104,26 +109,42 @@ private JaegerGrpcSpanExporter(String serviceName, ManagedChannel channel, long\n    */\n   @Override\n   public CompletableResultCode export(Collection<SpanData> spans) {\n-    Collector.PostSpansRequest request =\n-        Collector.PostSpansRequest.newBuilder()\n-            .setBatch(\n-                Model.Batch.newBuilder()\n-                    .addAllSpans(Adapter.toJaeger(spans))\n-                    .setProcess(this.process)\n-                    .build())\n-            .build();\n-\n     CollectorServiceGrpc.CollectorServiceFutureStub stub = this.stub;\n     if (deadlineMs > 0) {\n       stub = stub.withDeadlineAfter(deadlineMs, TimeUnit.MILLISECONDS);\n     }\n \n+    Map<Resource, List<SpanData>> resourceAndSpanData = Adapter.groupByResource(spans);\n+    List<Collector.PostSpansRequest> requests = new ArrayList<>();\n+    for (Map.Entry<Resource, List<SpanData>> entry : resourceAndSpanData.entrySet()) {\n+      Process.Builder builder = this.processBuilder.clone();\n+      if (entry.getKey().getAttributes() != null) {\n+        builder.addAllTags(Adapter.toKeyValues(entry.getKey().getAttributes()));\n+      }\n+\n+      Collector.PostSpansRequest request =\n+          Collector.PostSpansRequest.newBuilder()\n+              .setBatch(\n+                  Model.Batch.newBuilder()\n+                      .addAllSpans(Adapter.toJaeger(entry.getValue()))\n+                      .setProcess(builder.build())\n+                      .build())\n+              .build();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYwNDk1Ng=="}, "originalCommit": {"oid": "b13536fee97013122f5d06de6565c68530846031"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE5MTM5NA==", "bodyText": "added test", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r508191394", "createdAt": "2020-10-20T03:44:45Z", "author": {"login": "malafeev"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/JaegerGrpcSpanExporter.java", "diffHunk": "@@ -104,26 +109,42 @@ private JaegerGrpcSpanExporter(String serviceName, ManagedChannel channel, long\n    */\n   @Override\n   public CompletableResultCode export(Collection<SpanData> spans) {\n-    Collector.PostSpansRequest request =\n-        Collector.PostSpansRequest.newBuilder()\n-            .setBatch(\n-                Model.Batch.newBuilder()\n-                    .addAllSpans(Adapter.toJaeger(spans))\n-                    .setProcess(this.process)\n-                    .build())\n-            .build();\n-\n     CollectorServiceGrpc.CollectorServiceFutureStub stub = this.stub;\n     if (deadlineMs > 0) {\n       stub = stub.withDeadlineAfter(deadlineMs, TimeUnit.MILLISECONDS);\n     }\n \n+    Map<Resource, List<SpanData>> resourceAndSpanData = Adapter.groupByResource(spans);\n+    List<Collector.PostSpansRequest> requests = new ArrayList<>();\n+    for (Map.Entry<Resource, List<SpanData>> entry : resourceAndSpanData.entrySet()) {\n+      Process.Builder builder = this.processBuilder.clone();\n+      if (entry.getKey().getAttributes() != null) {\n+        builder.addAllTags(Adapter.toKeyValues(entry.getKey().getAttributes()));\n+      }\n+\n+      Collector.PostSpansRequest request =\n+          Collector.PostSpansRequest.newBuilder()\n+              .setBatch(\n+                  Model.Batch.newBuilder()\n+                      .addAllSpans(Adapter.toJaeger(entry.getValue()))\n+                      .setProcess(builder.build())\n+                      .build())\n+              .build();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYwNDk1Ng=="}, "originalCommit": {"oid": "b13536fee97013122f5d06de6565c68530846031"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4MjkxMzc3OnYy", "diffSide": "RIGHT", "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/Adapter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQyMzo1Nzo1M1rOHklvRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMzo0NDoxOVrOHkpiPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODEyOTA5NQ==", "bodyText": "We can remove this code now right?", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r508129095", "createdAt": "2020-10-19T23:57:53Z", "author": {"login": "anuraaga"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/Adapter.java", "diffHunk": "@@ -75,6 +75,10 @@ private Adapter() {}\n     target.addAllLogs(toJaegerLogs(span.getEvents()));\n     target.addAllReferences(toSpanRefs(span.getLinks()));\n \n+    if (span.getResource() != null && span.getResource().getAttributes() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76aaf3a956526f1326b718eeaf735b7877d667b4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE5MTI5Mg==", "bodyText": "removed", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r508191292", "createdAt": "2020-10-20T03:44:19Z", "author": {"login": "malafeev"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/Adapter.java", "diffHunk": "@@ -75,6 +75,10 @@ private Adapter() {}\n     target.addAllLogs(toJaegerLogs(span.getEvents()));\n     target.addAllReferences(toSpanRefs(span.getLinks()));\n \n+    if (span.getResource() != null && span.getResource().getAttributes() != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODEyOTA5NQ=="}, "originalCommit": {"oid": "76aaf3a956526f1326b718eeaf735b7877d667b4"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4MjkyNDUxOnYy", "diffSide": "RIGHT", "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/JaegerGrpcSpanExporter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMDowMzoxN1rOHkl1hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwMzo0NDoyOFrOHkpiZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODEzMDY5NA==", "bodyText": "Don't need null check for attributes", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r508130694", "createdAt": "2020-10-20T00:03:17Z", "author": {"login": "anuraaga"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/JaegerGrpcSpanExporter.java", "diffHunk": "@@ -137,6 +144,21 @@ public void onFailure(Throwable t) {\n     return result;\n   }\n \n+  private Collector.PostSpansRequest buildRequest(Resource resource, List<SpanData> spans) {\n+    Process.Builder builder = this.processBuilder.clone();\n+    if (resource.getAttributes() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76aaf3a956526f1326b718eeaf735b7877d667b4"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODE5MTMzNA==", "bodyText": "removed", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1800#discussion_r508191334", "createdAt": "2020-10-20T03:44:28Z", "author": {"login": "malafeev"}, "path": "exporters/jaeger/src/main/java/io/opentelemetry/exporters/jaeger/JaegerGrpcSpanExporter.java", "diffHunk": "@@ -137,6 +144,21 @@ public void onFailure(Throwable t) {\n     return result;\n   }\n \n+  private Collector.PostSpansRequest buildRequest(Resource resource, List<SpanData> spans) {\n+    Process.Builder builder = this.processBuilder.clone();\n+    if (resource.getAttributes() != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODEzMDY5NA=="}, "originalCommit": {"oid": "76aaf3a956526f1326b718eeaf735b7877d667b4"}, "originalPosition": 104}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2085, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}