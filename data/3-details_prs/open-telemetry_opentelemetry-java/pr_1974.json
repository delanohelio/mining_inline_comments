{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0MTYwMTg3", "number": 1974, "title": "Documents that ContextStorage.current can return null", "bodyText": "Currently the ThreadLocalContextStorage sets the ThreadLocal to Context.root() within the static constructor.  However, this only sets the value of the ThreadLocal for the thread that happens to execute that constructor.  For all other threads the ThreadLocal remains unset and THREAD_LOCAL_STORAGE.get() will return null which is likely unexpected by the consumer.\nThere are two options here:\n\nHave THREAD_LOCAL_STORAGE be a class derived from ThreadLocal<Context> and override the initialValue method to return an initial value for when the thread local has not been set for the current thread.\nHave current() check if THREAD_LOCAL_STORAGE.get() returns null and return Context.root() instead.\n\nSince all reads to the ThreadLocal go through the current() method I went with the second option as I find it the easiest to understand.\nUpdates the docs and annotations on ContextStorage#current to make it clear that the method may return null if no context has been attached to the current thread.  Also removes the static constructor in ThreadLocalContextStorage that sets the ThreadLocal<Context> to Context.root() for the thread that invokes the constructor.", "createdAt": "2020-11-02T16:04:47Z", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1974", "merged": true, "mergeCommit": {"oid": "b083bc7e764b493d11fb544431f65601d273e7d6"}, "closed": true, "closedAt": "2020-11-02T20:56:02Z", "author": {"login": "HaloFour"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYmwDlAH2gAyNTE0MTYwMTg3OmNiZjRiNmNlYTk5ZGYwYTdlODViY2ExMWY3Yzk1NDM5MTk3YTI1Y2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY0Go8AFqTUyMjIzMzgxNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cbf4b6cea99df0a7e85bca11f7c95439197a25cd", "author": {"user": {"login": "HaloFour", "name": null}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/cbf4b6cea99df0a7e85bca11f7c95439197a25cd", "committedDate": "2020-11-02T16:00:18Z", "message": "Fixes ThreadLocalContextStorage to return root Context if not set on current thread"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1512fa1d754644b0c2de3f30a6039c848bfc1c03", "author": {"user": {"login": "HaloFour", "name": null}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/1512fa1d754644b0c2de3f30a6039c848bfc1c03", "committedDate": "2020-11-02T16:07:50Z", "message": "Kick CI"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNzc4MTkx", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1974#pullrequestreview-521778191", "createdAt": "2020-11-02T16:15:02Z", "commit": {"oid": "1512fa1d754644b0c2de3f30a6039c848bfc1c03"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNjoxNTowMlrOHsLUjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNjoxNTowMlrOHsLUjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA4NDg3Ng==", "bodyText": "I think we can simply remove this line, we check for null in the Context and this is not necessarily.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1974#discussion_r516084876", "createdAt": "2020-11-02T16:15:02Z", "author": {"login": "bogdandrutu"}, "path": "context/src/main/java/io/opentelemetry/context/ThreadLocalContextStorage.java", "diffHunk": "@@ -45,7 +41,8 @@ public Scope attach(Context toAttach) {\n \n   @Override\n   public Context current() {\n-    return THREAD_LOCAL_STORAGE.get();\n+    Context threadContext = THREAD_LOCAL_STORAGE.get();\n+    return threadContext != null ? threadContext : Context.root();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1512fa1d754644b0c2de3f30a6039c848bfc1c03"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "077b1ce27f182adc2deac6d479e587a69eb30d6b", "author": {"user": {"login": "HaloFour", "name": null}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/077b1ce27f182adc2deac6d479e587a69eb30d6b", "committedDate": "2020-11-02T18:55:27Z", "message": "Change docs on ContextStorage.current to indicate that it can return null"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31f1dddab70a6a3d8f99ba32114edaf7e62df463", "author": {"user": {"login": "HaloFour", "name": null}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/31f1dddab70a6a3d8f99ba32114edaf7e62df463", "committedDate": "2020-11-02T19:05:00Z", "message": "Kick CI"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxOTE2NDA5", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1974#pullrequestreview-521916409", "createdAt": "2020-11-02T19:05:04Z", "commit": {"oid": "077b1ce27f182adc2deac6d479e587a69eb30d6b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMjMzODE0", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1974#pullrequestreview-522233814", "createdAt": "2020-11-03T07:24:24Z", "commit": {"oid": "31f1dddab70a6a3d8f99ba32114edaf7e62df463"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QwNzoyNDoyNFrOHsifPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QwNzoyNDoyNFrOHsifPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ2NDQ0NQ==", "bodyText": "Thanks for fixing my silliness :)", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1974#discussion_r516464445", "createdAt": "2020-11-03T07:24:24Z", "author": {"login": "anuraaga"}, "path": "context/src/main/java/io/opentelemetry/context/ThreadLocalContextStorage.java", "diffHunk": "@@ -15,10 +16,6 @@\n \n   private static final ThreadLocal<Context> THREAD_LOCAL_STORAGE = new ThreadLocal<>();\n \n-  static {\n-    THREAD_LOCAL_STORAGE.set(Context.root());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31f1dddab70a6a3d8f99ba32114edaf7e62df463"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3923, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}