{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3Njg4MjA1", "number": 1366, "title": "Add SDK Telemetry resources", "bodyText": "Resolves #1311", "createdAt": "2020-06-22T05:20:15Z", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366", "merged": true, "mergeCommit": {"oid": "0da293d9290cd06b99e4c3d38bef951d88164bfd"}, "closed": true, "closedAt": "2020-06-29T18:25:48Z", "author": {"login": "thisthat"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABctqGFcAFqTQzNDYxMDc0Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwEg1iAFqTQzOTM1NjI4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NjEwNzQ3", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#pullrequestreview-434610747", "createdAt": "2020-06-22T05:24:35Z", "commit": {"oid": "f032e616294936c8f08d9f21df1508a0d66edc08"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNToyNDozNVrOGmySxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwNTozNTowNFrOGmycLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMyMzA3Nw==", "bodyText": "I don't think this is doing what you expect, this code is run during the Gradle configuration, not during any task which is not good for several reasons.\nInstead, add a new task and set it as a builtBy source\nhttps://github.com/aws/aws-xray-sdk-java/blob/master/build.gradle.kts#L63\nhttps://github.com/aws/aws-xray-sdk-java/blob/master/build.gradle.kts#L131", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r443323077", "createdAt": "2020-06-22T05:24:35Z", "author": {"login": "anuraaga"}, "path": "sdk/build.gradle", "diffHunk": "@@ -30,3 +30,10 @@ animalsniffer {\n             sourceSets.main\n     ]\n }\n+\n+processResources {\n+    new File(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f032e616294936c8f08d9f21df1508a0d66edc08"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMyMzYwOQ==", "bodyText": "I think we should put this into a package, e.g. io/opentelemetry/sdk/version.properties", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r443323609", "createdAt": "2020-06-22T05:26:38Z", "author": {"login": "anuraaga"}, "path": "sdk/build.gradle", "diffHunk": "@@ -30,3 +30,10 @@ animalsniffer {\n             sourceSets.main\n     ]\n }\n+\n+processResources {\n+    new File(\n+            projectDir.getAbsolutePath() + File.separator + [\"src\", \"main\", \"resources\"].join(File.separator),\n+            \"version.properties\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f032e616294936c8f08d9f21df1508a0d66edc08"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMyNDExNA==", "bodyText": "I think FileInputStream only works when loading from the file system, e.g., IntelliJ and unit tests but not from a JAR. Instead\nResource.class.getResourceAsAstream(\"version.properties\") can handle both", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r443324114", "createdAt": "2020-06-22T05:28:48Z", "author": {"login": "anuraaga"}, "path": "sdk/src/main/java/io/opentelemetry/sdk/resources/Resource.java", "diffHunk": "@@ -45,6 +47,26 @@\n   private static final String ERROR_MESSAGE_INVALID_VALUE =\n       \" should be a ASCII string with a length not exceed \" + MAX_LENGTH + \" characters.\";\n   private static final Resource EMPTY = create(Attributes.empty());\n+  private static final Resource TELEMETRY_SDK =\n+      create(\n+          Attributes.newBuilder()\n+              .setAttribute(\"telemetry.sdk.name\", \"opentelemetry\")\n+              .setAttribute(\"telemetry.sdk.language\", \"java\")\n+              .setAttribute(\"telemetry.sdk.version\", readVersion())\n+              .build());\n+\n+  @Nullable\n+  private static String readVersion() {\n+    Properties properties = new Properties();\n+    try {\n+      properties.load(\n+          new FileInputStream(Resource.class.getResource(\"version.properties\").getFile()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f032e616294936c8f08d9f21df1508a0d66edc08"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMyNDU0MQ==", "bodyText": "So when a user wants to define their own Resource, they always have to merge the default one to get these values. I think this is OK, but it could also be good independently of this PR to think if Resource would make sense to have its own SPI, so that any ResourceProvider in the app are automatically registered without having to manually merge them all. Of course, there could be ordering problems with this, but it's probably still simpler than manual merging in many cases.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r443324541", "createdAt": "2020-06-22T05:30:44Z", "author": {"login": "anuraaga"}, "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/TracerSdkProvider.java", "diffHunk": "@@ -138,7 +138,7 @@ public void forceFlush() {\n \n     private Clock clock = MillisClock.getInstance();\n     private IdsGenerator idsGenerator = new RandomIdsGenerator();\n-    private Resource resource = EnvVarResource.getResource();\n+    private Resource resource = Resource.getTelemetrySdk().merge(EnvVarResource.getResource());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f032e616294936c8f08d9f21df1508a0d66edc08"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMyNTQ4NQ==", "bodyText": "Think it's better to avoid the forEach\nassertThat(attributes.get(\"telemetry.sdk.name\")).isEqualTo(stringAttributeValue(\"opentelemetry\"));\nassertThat(attributes.get(\"telemetry.sdk.language\")).isEqualTo(stringAttributeValue(\"java\"));\nassertThat(attributes.get(\"telemetry.sdk.version\")).isNotNull();\n/cc PS @jkwatson Would love to have getString :D", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r443325485", "createdAt": "2020-06-22T05:35:04Z", "author": {"login": "anuraaga"}, "path": "sdk/src/test/java/io/opentelemetry/sdk/resource/ResourceTest.java", "diffHunk": "@@ -148,4 +150,15 @@ public void testMergeResources_Resource2_Null() {\n     Resource resource = DEFAULT_RESOURCE.merge(resource1).merge(null);\n     assertThat(resource.getAttributes()).isEqualTo(expectedAttributes);\n   }\n+\n+  @Test\n+  public void testSdkTelemetryResources() {\n+    Resource resource = Resource.getTelemetrySdk();\n+    ReadableAttributes attributes = resource.getAttributes();\n+    String[] keys = {\"telemetry.sdk.name\", \"telemetry.sdk.language\", \"telemetry.sdk.version\"};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f032e616294936c8f08d9f21df1508a0d66edc08"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bc6a89b9f479d407170b0f8ae689a554723bb04", "author": {"user": {"login": "thisthat", "name": "Giovanni Liva"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/4bc6a89b9f479d407170b0f8ae689a554723bb04", "committedDate": "2020-06-23T06:40:43Z", "message": "Add SDK Telemetry resources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d63d6314df3c3f3bf614aa2c20c6c94eba0daaad", "author": {"user": {"login": "thisthat", "name": "Giovanni Liva"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/d63d6314df3c3f3bf614aa2c20c6c94eba0daaad", "committedDate": "2020-06-23T06:41:09Z", "message": "Address feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NDgyMTc3", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#pullrequestreview-435482177", "createdAt": "2020-06-23T06:40:41Z", "commit": {"oid": "976244341cff4f7913ddcf8575b472be4bead6cc"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwNjo0MDo0MVrOGnbQ-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwNjo0MTozNFrOGnbScA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk5NDM2Mg==", "bodyText": "Can you delete this file? We want to generate into build at build time, not into the codebase. If you remove this and apply the suggestions and tests still pass, then you should be good", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r443994362", "createdAt": "2020-06-23T06:40:41Z", "author": {"login": "anuraaga"}, "path": "sdk/src/main/resources/io/opentelemetry/sdk/version.properties", "diffHunk": "@@ -0,0 +1 @@\n+sdk.version=0.6.0-SNAPSHOT", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "976244341cff4f7913ddcf8575b472be4bead6cc"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk5NDU0Ng==", "bodyText": "Don't generate to source, generate to build, e.g. build/generated/properties/io/opentelemetry/sdk", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r443994546", "createdAt": "2020-06-23T06:41:07Z", "author": {"login": "anuraaga"}, "path": "sdk/build.gradle", "diffHunk": "@@ -8,6 +8,7 @@ plugins {\n \n description = 'OpenTelemetry SDK'\n ext.moduleName = \"io.opentelemetry.sdk\"\n+ext.propertiesDir = \"src/main/resources/io/opentelemetry/sdk\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "976244341cff4f7913ddcf8575b472be4bead6cc"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk5NDczNg==", "bodyText": "Here you would register build/generated/properties I believe", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r443994736", "createdAt": "2020-06-23T06:41:34Z", "author": {"login": "anuraaga"}, "path": "sdk/build.gradle", "diffHunk": "@@ -24,16 +25,24 @@ dependencies {\n     signature \"net.sf.androidscents.signature:android-api-level-24:7.0_r2@signature\"\n }\n \n+sourceSets {\n+    main {\n+        output.dir(propertiesDir, builtBy: 'generateVersionResource')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "976244341cff4f7913ddcf8575b472be4bead6cc"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e3fb8700884fa63c3e99b33d3772a2ffcae6218", "author": {"user": {"login": "thisthat", "name": "Giovanni Liva"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/8e3fb8700884fa63c3e99b33d3772a2ffcae6218", "committedDate": "2020-06-23T06:46:58Z", "message": "Generate version.properties"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "976244341cff4f7913ddcf8575b472be4bead6cc", "author": {"user": {"login": "thisthat", "name": "Giovanni Liva"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/976244341cff4f7913ddcf8575b472be4bead6cc", "committedDate": "2020-06-23T06:38:46Z", "message": "Address feedback"}, "afterCommit": {"oid": "8e3fb8700884fa63c3e99b33d3772a2ffcae6218", "author": {"user": {"login": "thisthat", "name": "Giovanni Liva"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/8e3fb8700884fa63c3e99b33d3772a2ffcae6218", "committedDate": "2020-06-23T06:46:58Z", "message": "Generate version.properties"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NDg5MTU3", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#pullrequestreview-435489157", "createdAt": "2020-06-23T06:53:10Z", "commit": {"oid": "8e3fb8700884fa63c3e99b33d3772a2ffcae6218"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwNjo1MzoxMFrOGnbmYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwNjo1MzoxMFrOGnbmYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk5OTg0MQ==", "bodyText": "Just noticed null value is allowed - @jkwatson does that seem OK? Wouldn't be surprised if it causes a NPE during export.\nEither way, what about setting to unknown?", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r443999841", "createdAt": "2020-06-23T06:53:10Z", "author": {"login": "anuraaga"}, "path": "sdk/src/main/java/io/opentelemetry/sdk/resources/Resource.java", "diffHunk": "@@ -45,6 +46,27 @@\n   private static final String ERROR_MESSAGE_INVALID_VALUE =\n       \" should be a ASCII string with a length not exceed \" + MAX_LENGTH + \" characters.\";\n   private static final Resource EMPTY = create(Attributes.empty());\n+  private static final Resource TELEMETRY_SDK =\n+      create(\n+          Attributes.newBuilder()\n+              .setAttribute(\"telemetry.sdk.name\", \"opentelemetry\")\n+              .setAttribute(\"telemetry.sdk.language\", \"java\")\n+              .setAttribute(\"telemetry.sdk.version\", readVersion())\n+              .build());\n+\n+  @Nullable\n+  private static String readVersion() {\n+\n+    Properties properties = new Properties();\n+    try {\n+      properties.load(\n+          Resource.class.getResourceAsStream(\"/io/opentelemetry/sdk/version.properties\"));\n+    } catch (Exception e) {\n+      // we left the attribute empty\n+      return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e3fb8700884fa63c3e99b33d3772a2ffcae6218"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f113c0d5f7a174eedf2107a1a9df2e0ec2430a8", "author": {"user": {"login": "thisthat", "name": "Giovanni Liva"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/6f113c0d5f7a174eedf2107a1a9df2e0ec2430a8", "committedDate": "2020-06-29T05:35:03Z", "message": "Use unknown when version not available"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MjIwNjcz", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#pullrequestreview-439220673", "createdAt": "2020-06-29T14:48:15Z", "commit": {"oid": "6f113c0d5f7a174eedf2107a1a9df2e0ec2430a8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MzU1NTU2", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#pullrequestreview-439355556", "createdAt": "2020-06-29T17:28:56Z", "commit": {"oid": "6f113c0d5f7a174eedf2107a1a9df2e0ec2430a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNzoyODo1NlrOGqa-Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNzoyODo1NlrOGqa-Xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEzNTMyNg==", "bodyText": "With such a generic filename, it seems like there's a possibility this could collide with other projects version file. What do you think about making this be something super clear like \"opentelemetry-sdk-version.properties\" ?", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#discussion_r447135326", "createdAt": "2020-06-29T17:28:56Z", "author": {"login": "jkwatson"}, "path": "sdk/build.gradle", "diffHunk": "@@ -24,9 +25,24 @@ dependencies {\n     signature \"net.sf.androidscents.signature:android-api-level-24:7.0_r2@signature\"\n }\n \n+sourceSets {\n+    main {\n+        output.dir(\"build/generated/properties\", builtBy: 'generateVersionResource')\n+    }\n+}\n+\n animalsniffer {\n     // Don't check sourceSets.jmh and sourceSets.test\n     sourceSets = [\n             sourceSets.main\n     ]\n }\n+\n+task generateVersionResource {\n+    doLast {\n+        def folder = file(propertiesDir)\n+        folder.mkdirs()\n+        def propertiesFile = new File(folder.getAbsolutePath(), \"version.properties\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f113c0d5f7a174eedf2107a1a9df2e0ec2430a8"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MzU2Mjgz", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1366#pullrequestreview-439356283", "createdAt": "2020-06-29T17:29:56Z", "commit": {"oid": "6f113c0d5f7a174eedf2107a1a9df2e0ec2430a8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2487, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}