{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5OTc0ODY1", "number": 2304, "title": "Add custom proto marshaler to avoid unnecessary allocation", "bodyText": "Some of the differences with the generated code:\n\nAvoid builders to construct the marshalers;\nUse less objects for Attributes because of the way oneof generated code is implemented; Also proto files supports arrays of any combination which is not the case for us.\nTake advantage on the fact that data we know are immutable, no need to wrap to unmodifiable list/maps etc;\n\nUnfortunately we cannot get the whole performance back because we need to write a custom Marshaler for grpc (which is possible but try to limit the PR size).\nAs the numbers show we have ~25% improvement in CPU and ~15% in memory with this PR. With a custom marshaler we can get anoter 7% CPU and 7% memory.\nCPU benchmarks:\n\nMemory rate/op:\n\nUPDATE\nAfter one more round of improvements (based on @anuraaga hint that I can use byte[], I changed all the places where we wrapped the byte[] in BytesString and won a lot more performance, now we are 55% CPU usage win and 57% Memory.\nCPU benchmarks:\n\nMemory rate/op:\n\nSigned-off-by: Bogdan Drutu bogdandrutu@gmail.com", "createdAt": "2020-12-15T04:54:38Z", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2304", "merged": true, "mergeCommit": {"oid": "6946732e06e385425af7e7da85fe0ecdca898cf2"}, "closed": true, "closedAt": "2020-12-16T06:32:55Z", "author": {"login": "bogdandrutu"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmTUeVgFqTU1MjExMjUwOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmo2DYABqjQxMTgwMjk4MzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMTEyNTA4", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2304#pullrequestreview-552112508", "createdAt": "2020-12-15T05:16:55Z", "commit": {"oid": "9ff19c1cf6d210f6e2a7f3f6c024a21c9a822c58"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ff19c1cf6d210f6e2a7f3f6c024a21c9a822c58", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/9ff19c1cf6d210f6e2a7f3f6c024a21c9a822c58", "committedDate": "2020-12-15T04:50:19Z", "message": "Add custom proto marshaler to avoid unnecessary allocation\n\nUnfortunately we cannot get the whole performance back because we need to write a custom Marshaler for grpc (which is possible but try to limit the PR size).\n\nAs the numbers show we have ~25% improvement in CPU and ~15% in memory with this PR. With a custom marshaler we can get anoter 7% CPU and 7% memory.\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}, "afterCommit": {"oid": "d68df96b64d93c6e91417fe963af99edd188a38b", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/d68df96b64d93c6e91417fe963af99edd188a38b", "committedDate": "2020-12-15T17:46:24Z", "message": "Add custom proto marshaler to avoid unnecessary allocation\n\nUnfortunately we cannot get the whole performance back because we need to write a custom Marshaler for grpc (which is possible but try to limit the PR size).\n\nAs the numbers show we have ~25% improvement in CPU and ~15% in memory with this PR. With a custom marshaler we can get anoter 7% CPU and 7% memory.\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d68df96b64d93c6e91417fe963af99edd188a38b", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/d68df96b64d93c6e91417fe963af99edd188a38b", "committedDate": "2020-12-15T17:46:24Z", "message": "Add custom proto marshaler to avoid unnecessary allocation\n\nUnfortunately we cannot get the whole performance back because we need to write a custom Marshaler for grpc (which is possible but try to limit the PR size).\n\nAs the numbers show we have ~25% improvement in CPU and ~15% in memory with this PR. With a custom marshaler we can get anoter 7% CPU and 7% memory.\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}, "afterCommit": {"oid": "061c20e736ffe0b4a1c3e7e834d6f4e51d082203", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/061c20e736ffe0b4a1c3e7e834d6f4e51d082203", "committedDate": "2020-12-15T18:18:36Z", "message": "Add custom proto marshaler to avoid unnecessary allocation\n\nSome of the differences with the generated code:\n1. Avoid builders to construct the marshalers;\n2. Use less objects for Attributes because of the way `oneof` generated code is implemented; Also proto files supports arrays of any combination which is not the case for us.\n3. Take advantage on the fact that data we know are immutable, no need to wrap to unmodifiable list/maps etc;\n\nUnfortunately we cannot get the whole performance back because we need to write a custom Marshaler for grpc (which is possible but try to limit the PR size).\n\nAs the numbers show we have ~25% improvement in CPU and ~15% in memory with this PR. With a custom marshaler we can get anoter 7% CPU and 7% memory.\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "061c20e736ffe0b4a1c3e7e834d6f4e51d082203", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/061c20e736ffe0b4a1c3e7e834d6f4e51d082203", "committedDate": "2020-12-15T18:18:36Z", "message": "Add custom proto marshaler to avoid unnecessary allocation\n\nSome of the differences with the generated code:\n1. Avoid builders to construct the marshalers;\n2. Use less objects for Attributes because of the way `oneof` generated code is implemented; Also proto files supports arrays of any combination which is not the case for us.\n3. Take advantage on the fact that data we know are immutable, no need to wrap to unmodifiable list/maps etc;\n\nUnfortunately we cannot get the whole performance back because we need to write a custom Marshaler for grpc (which is possible but try to limit the PR size).\n\nAs the numbers show we have ~25% improvement in CPU and ~15% in memory with this PR. With a custom marshaler we can get anoter 7% CPU and 7% memory.\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}, "afterCommit": {"oid": "b288e09faa7d609dcd8739467ac3f1e9576b8169", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/b288e09faa7d609dcd8739467ac3f1e9576b8169", "committedDate": "2020-12-15T18:27:47Z", "message": "Add custom proto marshaler to avoid unnecessary allocation\n\nSome of the differences with the generated code:\n1. Avoid builders to construct the marshalers;\n2. Use less objects for Attributes because of the way `oneof` generated code is implemented; Also proto files supports arrays of any combination which is not the case for us.\n3. Take advantage on the fact that data we know are immutable, no need to wrap to unmodifiable list/maps etc;\n\nUnfortunately we cannot get the whole performance back because we need to write a custom Marshaler for grpc (which is possible but try to limit the PR size).\n\nAs the numbers show we have ~25% improvement in CPU and ~15% in memory with this PR. With a custom marshaler we can get anoter 7% CPU and 7% memory.\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyODEwMTMw", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2304#pullrequestreview-552810130", "createdAt": "2020-12-15T19:44:54Z", "commit": {"oid": "b288e09faa7d609dcd8739467ac3f1e9576b8169"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxOTo0NDo1NFrOIGc-aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxOTo0NDo1NFrOIGc-aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzYzNzA5OQ==", "bodyText": "we should have a better description here, even if it won't happen under any normal circumstance", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2304#discussion_r543637099", "createdAt": "2020-12-15T19:44:54Z", "author": {"login": "jkwatson"}, "path": "exporters/otlp/src/main/java/io/opentelemetry/exporter/otlp/AttributeMarshaler.java", "diffHunk": "@@ -0,0 +1,293 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.exporter.otlp;\n+\n+import com.google.protobuf.ByteString;\n+import com.google.protobuf.CodedOutputStream;\n+import com.google.protobuf.WireFormat;\n+import io.opentelemetry.api.common.AttributeKey;\n+import io.opentelemetry.api.common.Attributes;\n+import io.opentelemetry.proto.common.v1.AnyValue;\n+import io.opentelemetry.proto.common.v1.ArrayValue;\n+import io.opentelemetry.proto.common.v1.KeyValue;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+abstract class AttributeMarshaler extends MarshalerWithSize {\n+  private static final AttributeMarshaler[] EMPTY_REPEATED = new AttributeMarshaler[0];\n+  private final ByteString key;\n+  private final int valueSize;\n+\n+  static AttributeMarshaler[] createRepeated(Attributes attributes) {\n+    if (attributes.isEmpty()) {\n+      return EMPTY_REPEATED;\n+    }\n+\n+    AttributeMarshaler[] attributeMarshalers = new AttributeMarshaler[attributes.size()];\n+    // TODO: Revisit how to avoid the atomic integer creation.\n+    AtomicInteger pos = new AtomicInteger();\n+    attributes.forEach(\n+        (attributeKey, o) ->\n+            attributeMarshalers[pos.getAndIncrement()] =\n+                AttributeMarshaler.create(attributeKey, o));\n+    return attributeMarshalers;\n+  }\n+\n+  @SuppressWarnings(\"unchecked\")\n+  static AttributeMarshaler create(AttributeKey<?> attributeKey, Object value) {\n+    ByteString key = MarshalerUtil.toByteString(attributeKey.getKey());\n+    if (value == null) {\n+      return new KeyValueNullMarshaler(key);\n+    }\n+    switch (attributeKey.getType()) {\n+      case STRING:\n+        return new KeyValueStringMarshaler(key, MarshalerUtil.toByteString((String) value));\n+      case LONG:\n+        return new KeyValueLongMarshaler(key, (Long) value);\n+      case BOOLEAN:\n+        return new KeyValueBooleanMarshaler(key, (Boolean) value);\n+      case DOUBLE:\n+        return new KeyValueDoubleMarshaler(key, (Double) value);\n+      case STRING_ARRAY:\n+        return new KeyValueArrayStringMarshaler(key, (List<String>) value);\n+      case LONG_ARRAY:\n+        return new KeyValueArrayLongMarshaler(key, (List<Long>) value);\n+      case BOOLEAN_ARRAY:\n+        return new KeyValueArrayBooleanMarshaler(key, (List<Boolean>) value);\n+      case DOUBLE_ARRAY:\n+        return new KeyValueArrayDoubleMarshaler(key, (List<Double>) value);\n+    }\n+    throw new IllegalArgumentException(\"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b288e09faa7d609dcd8739467ac3f1e9576b8169"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyODQzMDYy", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2304#pullrequestreview-552843062", "createdAt": "2020-12-15T20:30:06Z", "commit": {"oid": "b288e09faa7d609dcd8739467ac3f1e9576b8169"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b288e09faa7d609dcd8739467ac3f1e9576b8169", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/b288e09faa7d609dcd8739467ac3f1e9576b8169", "committedDate": "2020-12-15T18:27:47Z", "message": "Add custom proto marshaler to avoid unnecessary allocation\n\nSome of the differences with the generated code:\n1. Avoid builders to construct the marshalers;\n2. Use less objects for Attributes because of the way `oneof` generated code is implemented; Also proto files supports arrays of any combination which is not the case for us.\n3. Take advantage on the fact that data we know are immutable, no need to wrap to unmodifiable list/maps etc;\n\nUnfortunately we cannot get the whole performance back because we need to write a custom Marshaler for grpc (which is possible but try to limit the PR size).\n\nAs the numbers show we have ~25% improvement in CPU and ~15% in memory with this PR. With a custom marshaler we can get anoter 7% CPU and 7% memory.\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}, "afterCommit": {"oid": "703e60ebf16cd5f243d466a0715ca55a3501317e", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/703e60ebf16cd5f243d466a0715ca55a3501317e", "committedDate": "2020-12-15T22:28:58Z", "message": "Add custom proto marshaler to avoid unnecessary allocation\n\nSome of the differences with the generated code:\n1. Avoid builders to construct the marshalers;\n2. Use less objects for Attributes because of the way `oneof` generated code is implemented; Also proto files supports arrays of any combination which is not the case for us.\n3. Take advantage on the fact that data we know are immutable, no need to wrap to unmodifiable list/maps etc;\n\nUnfortunately we cannot get the whole performance back because we need to write a custom Marshaler for grpc (which is possible but try to limit the PR size).\n\nAs the numbers show we have ~25% improvement in CPU and ~15% in memory with this PR. With a custom marshaler we can get anoter 7% CPU and 7% memory.\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzMzAyMDk4", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2304#pullrequestreview-553302098", "createdAt": "2020-12-16T02:04:31Z", "commit": {"oid": "31e7b639766295d476d83419f18f23557b85fe57"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwMjowNDozMVrOIGoUmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwMjoxMTozOFrOIGoqBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzgyMzAwMA==", "bodyText": "If I recall correctly, when size is known gRPC allocates byte[] how about using byte[] instead of ByteBuffer?", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2304#discussion_r543823000", "createdAt": "2020-12-16T02:04:31Z", "author": {"login": "anuraaga"}, "path": "exporters/otlp/src/jmh/java/io/opentelemetry/exporter/otlp/RequestMarshalBenchmarks.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.exporter.otlp;\n+\n+import com.google.protobuf.CodedOutputStream;\n+import io.opentelemetry.proto.collector.trace.v1.ExportTraceServiceRequest;\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.util.concurrent.TimeUnit;\n+import org.openjdk.jmh.annotations.Benchmark;\n+import org.openjdk.jmh.annotations.BenchmarkMode;\n+import org.openjdk.jmh.annotations.Fork;\n+import org.openjdk.jmh.annotations.Measurement;\n+import org.openjdk.jmh.annotations.Mode;\n+import org.openjdk.jmh.annotations.OutputTimeUnit;\n+import org.openjdk.jmh.annotations.Threads;\n+import org.openjdk.jmh.annotations.Warmup;\n+\n+@BenchmarkMode({Mode.AverageTime})\n+@OutputTimeUnit(TimeUnit.NANOSECONDS)\n+@Warmup(iterations = 5, time = 1)\n+@Measurement(iterations = 10, time = 1)\n+@Fork(1)\n+public class RequestMarshalBenchmarks {\n+\n+  @Benchmark\n+  @Threads(1)\n+  public ByteBuffer createProtoMarshal(RequestMarshalState state) {\n+    ExportTraceServiceRequest protoRequest =\n+        ExportTraceServiceRequest.newBuilder()\n+            .addAllResourceSpans(SpanAdapter.toProtoResourceSpans(state.spanDataList))\n+            .build();\n+    return ByteBuffer.allocate(protoRequest.getSerializedSize());\n+  }\n+\n+  @Benchmark\n+  @Threads(1)\n+  public ByteBuffer marshalProto(RequestMarshalState state) throws IOException {\n+    ExportTraceServiceRequest protoRequest =\n+        ExportTraceServiceRequest.newBuilder()\n+            .addAllResourceSpans(SpanAdapter.toProtoResourceSpans(state.spanDataList))\n+            .build();\n+    ByteBuffer protoOutput = ByteBuffer.allocate(protoRequest.getSerializedSize());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31e7b639766295d476d83419f18f23557b85fe57"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzgyNDAzNg==", "bodyText": "Such 0's are relatively rare, how about using more representative IDs? Don't think it affects performance but just in case.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2304#discussion_r543824036", "createdAt": "2020-12-16T02:05:51Z", "author": {"login": "anuraaga"}, "path": "exporters/otlp/src/jmh/java/io/opentelemetry/exporter/otlp/RequestMarshalState.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.exporter.otlp;\n+\n+import io.opentelemetry.api.common.AttributeKey;\n+import io.opentelemetry.api.common.Attributes;\n+import io.opentelemetry.api.trace.Span;\n+import io.opentelemetry.api.trace.SpanContext;\n+import io.opentelemetry.api.trace.SpanId;\n+import io.opentelemetry.api.trace.TraceFlags;\n+import io.opentelemetry.api.trace.TraceId;\n+import io.opentelemetry.api.trace.TraceState;\n+import io.opentelemetry.sdk.common.InstrumentationLibraryInfo;\n+import io.opentelemetry.sdk.resources.Resource;\n+import io.opentelemetry.sdk.testing.trace.TestSpanData;\n+import io.opentelemetry.sdk.trace.data.SpanData;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import org.openjdk.jmh.annotations.Param;\n+import org.openjdk.jmh.annotations.Scope;\n+import org.openjdk.jmh.annotations.Setup;\n+import org.openjdk.jmh.annotations.State;\n+\n+@State(Scope.Benchmark)\n+public class RequestMarshalState {\n+  private static final Resource RESOURCE =\n+      Resource.create(\n+          Attributes.builder()\n+              .put(AttributeKey.booleanKey(\"key_bool\"), true)\n+              .put(AttributeKey.stringKey(\"key_string\"), \"string\")\n+              .put(AttributeKey.longKey(\"key_int\"), 100L)\n+              .put(AttributeKey.doubleKey(\"key_double\"), 100.3)\n+              .put(\n+                  AttributeKey.stringArrayKey(\"key_string_array\"),\n+                  Arrays.asList(\"string\", \"string\"))\n+              .put(AttributeKey.longArrayKey(\"key_long_array\"), Arrays.asList(12L, 23L))\n+              .put(AttributeKey.doubleArrayKey(\"key_double_array\"), Arrays.asList(12.3, 23.1))\n+              .put(AttributeKey.booleanArrayKey(\"key_boolean_array\"), Arrays.asList(true, false))\n+              .build());\n+\n+  private static final InstrumentationLibraryInfo INSTRUMENTATION_LIBRARY_INFO =\n+      InstrumentationLibraryInfo.create(\"name\", null);\n+  private static final byte[] TRACE_ID_BYTES =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31e7b639766295d476d83419f18f23557b85fe57"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzgyODQ4NA==", "bodyText": "It seems unfortunate to instantiate marshallers for each object. Isn't it better to define Marshaler something like\ninterface MarshalerWithSize<T> {\n\n  int serializedSize(T value);\n\n  void writeValue(T value, CodedOutputStream stream);\n}\nand have singleton marshalers?", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2304#discussion_r543828484", "createdAt": "2020-12-16T02:11:38Z", "author": {"login": "anuraaga"}, "path": "exporters/otlp/src/main/java/io/opentelemetry/exporter/otlp/AttributeMarshaler.java", "diffHunk": "@@ -0,0 +1,293 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.exporter.otlp;\n+\n+import com.google.protobuf.ByteString;\n+import com.google.protobuf.CodedOutputStream;\n+import com.google.protobuf.WireFormat;\n+import io.opentelemetry.api.common.AttributeKey;\n+import io.opentelemetry.api.common.Attributes;\n+import io.opentelemetry.proto.common.v1.AnyValue;\n+import io.opentelemetry.proto.common.v1.ArrayValue;\n+import io.opentelemetry.proto.common.v1.KeyValue;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+abstract class AttributeMarshaler extends MarshalerWithSize {\n+  private static final AttributeMarshaler[] EMPTY_REPEATED = new AttributeMarshaler[0];\n+  private final ByteString key;\n+  private final int valueSize;\n+\n+  static AttributeMarshaler[] createRepeated(Attributes attributes) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31e7b639766295d476d83419f18f23557b85fe57"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzMzM4Nzk2", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2304#pullrequestreview-553338796", "createdAt": "2020-12-16T03:55:35Z", "commit": {"oid": "31e7b639766295d476d83419f18f23557b85fe57"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwMzo1NTozNVrOIGtZwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwNDowOTo0MVrOIGuD0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzkwNjI0MA==", "bodyText": "I think asMap.entrySet should work fine too here escape analysis generally performs well for iteration. Otherwise, just\nnew BiConsumer<AttributeKey, Object> {\n  int index = 0;\n\n  void accept(AttributeKey, Object) {\n    attributeMarshalers[index++] = create()\n  }\n}", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2304#discussion_r543906240", "createdAt": "2020-12-16T03:55:35Z", "author": {"login": "anuraaga"}, "path": "exporters/otlp/src/main/java/io/opentelemetry/exporter/otlp/AttributeMarshaler.java", "diffHunk": "@@ -0,0 +1,293 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.exporter.otlp;\n+\n+import com.google.protobuf.ByteString;\n+import com.google.protobuf.CodedOutputStream;\n+import com.google.protobuf.WireFormat;\n+import io.opentelemetry.api.common.AttributeKey;\n+import io.opentelemetry.api.common.Attributes;\n+import io.opentelemetry.proto.common.v1.AnyValue;\n+import io.opentelemetry.proto.common.v1.ArrayValue;\n+import io.opentelemetry.proto.common.v1.KeyValue;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+abstract class AttributeMarshaler extends MarshalerWithSize {\n+  private static final AttributeMarshaler[] EMPTY_REPEATED = new AttributeMarshaler[0];\n+  private final ByteString key;\n+  private final int valueSize;\n+\n+  static AttributeMarshaler[] createRepeated(Attributes attributes) {\n+    if (attributes.isEmpty()) {\n+      return EMPTY_REPEATED;\n+    }\n+\n+    AttributeMarshaler[] attributeMarshalers = new AttributeMarshaler[attributes.size()];\n+    // TODO: Revisit how to avoid the atomic integer creation.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31e7b639766295d476d83419f18f23557b85fe57"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzkxNzAxMA==", "bodyText": "Ok - also don't forget we have a fast concurrent weak map now, so it can often be used as an efficient cache when needed. If the attribute key is the main reason for the instantiation, then that'd be easy to cache and maybe a simple win.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2304#discussion_r543917010", "createdAt": "2020-12-16T04:09:41Z", "author": {"login": "anuraaga"}, "path": "exporters/otlp/src/main/java/io/opentelemetry/exporter/otlp/AttributeMarshaler.java", "diffHunk": "@@ -0,0 +1,293 @@\n+/*\n+ * Copyright The OpenTelemetry Authors\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package io.opentelemetry.exporter.otlp;\n+\n+import com.google.protobuf.ByteString;\n+import com.google.protobuf.CodedOutputStream;\n+import com.google.protobuf.WireFormat;\n+import io.opentelemetry.api.common.AttributeKey;\n+import io.opentelemetry.api.common.Attributes;\n+import io.opentelemetry.proto.common.v1.AnyValue;\n+import io.opentelemetry.proto.common.v1.ArrayValue;\n+import io.opentelemetry.proto.common.v1.KeyValue;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicInteger;\n+\n+abstract class AttributeMarshaler extends MarshalerWithSize {\n+  private static final AttributeMarshaler[] EMPTY_REPEATED = new AttributeMarshaler[0];\n+  private final ByteString key;\n+  private final int valueSize;\n+\n+  static AttributeMarshaler[] createRepeated(Attributes attributes) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzgyODQ4NA=="}, "originalCommit": {"oid": "31e7b639766295d476d83419f18f23557b85fe57"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c618b050a695c1230519e690a6cbd57e1869dd68", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/c618b050a695c1230519e690a6cbd57e1869dd68", "committedDate": "2020-12-16T04:40:43Z", "message": "Add custom proto marshaler to avoid unnecessary allocation\n\nSome of the differences with the generated code:\n1. Avoid builders to construct the marshalers;\n2. Use less objects for Attributes because of the way `oneof` generated code is implemented; Also proto files supports arrays of any combination which is not the case for us.\n3. Take advantage on the fact that data we know are immutable, no need to wrap to unmodifiable list/maps etc;\n\nUnfortunately we cannot get the whole performance back because we need to write a custom Marshaler for grpc (which is possible but try to limit the PR size).\n\nAs the numbers show we have ~25% improvement in CPU and ~15% in memory with this PR. With a custom marshaler we can get anoter 7% CPU and 7% memory.\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f02ed1c734c4c76cc0e6bbfbb4105a0ba736fc2", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/6f02ed1c734c4c76cc0e6bbfbb4105a0ba736fc2", "committedDate": "2020-12-16T04:40:44Z", "message": "Always send the message information even if empty values\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64663dbe9e58d494899d6f23c6b852e107b79142", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/64663dbe9e58d494899d6f23c6b852e107b79142", "committedDate": "2020-12-16T04:40:45Z", "message": "Test for error status\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98582f81a75a664667c2549ad03c5731b304ffc6", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/98582f81a75a664667c2549ad03c5731b304ffc6", "committedDate": "2020-12-16T04:40:45Z", "message": "Test for valid ParentSpanId\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60ec03b110aa6c87012dfbdc4ba83be226e6b8e5", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/60ec03b110aa6c87012dfbdc4ba83be226e6b8e5", "committedDate": "2020-12-16T04:40:45Z", "message": "Fix order in status fields\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67723d9cf134bb1f9ddd8713a8f97f7ad1fe10fd", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/67723d9cf134bb1f9ddd8713a8f97f7ad1fe10fd", "committedDate": "2020-12-16T04:40:45Z", "message": "Address feedback from code review\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "775872f8bd06808dc5990564c7b7526c98056661", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/775872f8bd06808dc5990564c7b7526c98056661", "committedDate": "2020-12-16T04:40:45Z", "message": "Avoid one extra object BytesString, use byte array always\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "55e91443726d1250a281d26d58cee094abd32d7f", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/55e91443726d1250a281d26d58cee094abd32d7f", "committedDate": "2020-12-16T04:35:02Z", "message": "Avoid one extra object BytesString, use byte array always\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}, "afterCommit": {"oid": "8db5cb3aecc35cafb4108a542a9fa7f559815b46", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/8db5cb3aecc35cafb4108a542a9fa7f559815b46", "committedDate": "2020-12-16T04:50:33Z", "message": "Fix things after PR that moved proto conversions\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8db5cb3aecc35cafb4108a542a9fa7f559815b46", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/8db5cb3aecc35cafb4108a542a9fa7f559815b46", "committedDate": "2020-12-16T04:50:33Z", "message": "Fix things after PR that moved proto conversions\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}, "afterCommit": {"oid": "6b1a897f01b13f82aeb695969623b1fa7f5020b4", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/6b1a897f01b13f82aeb695969623b1fa7f5020b4", "committedDate": "2020-12-16T04:55:59Z", "message": "Fix things after PR that moved proto conversions\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6b1a897f01b13f82aeb695969623b1fa7f5020b4", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/6b1a897f01b13f82aeb695969623b1fa7f5020b4", "committedDate": "2020-12-16T04:55:59Z", "message": "Fix things after PR that moved proto conversions\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}, "afterCommit": {"oid": "b244bf83a4f793c91762d6c4b3057d0a379f08ee", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/b244bf83a4f793c91762d6c4b3057d0a379f08ee", "committedDate": "2020-12-16T05:59:57Z", "message": "Fix things after PR that moved proto conversions\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b244bf83a4f793c91762d6c4b3057d0a379f08ee", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/b244bf83a4f793c91762d6c4b3057d0a379f08ee", "committedDate": "2020-12-16T05:59:57Z", "message": "Fix things after PR that moved proto conversions\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}, "afterCommit": {"oid": "686e2d77995f7c58b5c6238d733b355640988eef", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/686e2d77995f7c58b5c6238d733b355640988eef", "committedDate": "2020-12-16T06:05:43Z", "message": "Fix things after PR that moved proto conversions\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "686e2d77995f7c58b5c6238d733b355640988eef", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/686e2d77995f7c58b5c6238d733b355640988eef", "committedDate": "2020-12-16T06:05:43Z", "message": "Fix things after PR that moved proto conversions\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}, "afterCommit": {"oid": "12d12f3ce78d9a8db89335a29b323b03420edfaf", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/12d12f3ce78d9a8db89335a29b323b03420edfaf", "committedDate": "2020-12-16T06:13:30Z", "message": "Fix things after PR that moved proto conversions\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "12d12f3ce78d9a8db89335a29b323b03420edfaf", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/12d12f3ce78d9a8db89335a29b323b03420edfaf", "committedDate": "2020-12-16T06:13:30Z", "message": "Fix things after PR that moved proto conversions\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}, "afterCommit": {"oid": "3bc1c6d2459a94e1c28376c92b0865a3effcc252", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/3bc1c6d2459a94e1c28376c92b0865a3effcc252", "committedDate": "2020-12-16T06:19:37Z", "message": "Fix things after PR that moved proto conversions\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6622c56717831fa1991592ec9f8b2b969ba51bde", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/6622c56717831fa1991592ec9f8b2b969ba51bde", "committedDate": "2020-12-16T06:21:28Z", "message": "Fix things after PR that moved proto conversions\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3bc1c6d2459a94e1c28376c92b0865a3effcc252", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/3bc1c6d2459a94e1c28376c92b0865a3effcc252", "committedDate": "2020-12-16T06:19:37Z", "message": "Fix things after PR that moved proto conversions\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}, "afterCommit": {"oid": "6622c56717831fa1991592ec9f8b2b969ba51bde", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/6622c56717831fa1991592ec9f8b2b969ba51bde", "committedDate": "2020-12-16T06:21:28Z", "message": "Fix things after PR that moved proto conversions\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3674, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}