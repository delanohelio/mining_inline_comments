{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2OTgwNjc2", "number": 2038, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQwODoyMDoyM1rOE2b_RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMTo0MDowMVrOE3bFuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NTE3MTI0OnYy", "diffSide": "RIGHT", "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3Propagator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQwODoyMDoyM1rOHvO2rQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQwODoyMDoyM1rOHvO2rQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTI4ODQ5Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              static final String DEBUG_CONTEXT_KEY = \"b3-debug\";\n          \n          \n            \n              static final ContextKey<String> DEBUG_CONTEXT = ContextKey.named(B3Propagator.DEBUG_CONTEXT_KEY);\n          \n          \n            \n              static final ContextKey<String> DEBUG_CONTEXT_KEY = ContextKey.named(\"b3-debug);\n          \n      \n    \n    \n  \n\nThe string form isn't really used, and it's the ContextKey that is actually the context key :)", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2038#discussion_r519288493", "createdAt": "2020-11-08T08:20:23Z", "author": {"login": "anuraaga"}, "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3Propagator.java", "diffHunk": "@@ -49,12 +50,16 @@\n   static final String TRACE_ID_HEADER = \"X-B3-TraceId\";\n   static final String SPAN_ID_HEADER = \"X-B3-SpanId\";\n   static final String SAMPLED_HEADER = \"X-B3-Sampled\";\n+  static final String DEBUG_HEADER = \"X-B3-Flags\";\n   static final String COMBINED_HEADER = \"b3\";\n   static final String COMBINED_HEADER_DELIMITER = \"-\";\n+  static final String DEBUG_CONTEXT_KEY = \"b3-debug\";\n+  static final ContextKey<String> DEBUG_CONTEXT = ContextKey.named(B3Propagator.DEBUG_CONTEXT_KEY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52ba177d2fa869baa501ec2025d842512cf27e2a"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NTE3MzM1OnYy", "diffSide": "RIGHT", "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorExtractorMultipleHeaders.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQwODoyMToxOVrOHvO34Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQyMTowNzo1MVrOHvaYMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTI4ODgwMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (!StringUtils.isNullOrEmpty(debug) && debug.contentEquals(Common.TRUE_INT)) {\n          \n          \n            \n                if (Common.TRUE_INT.equals(debug)) {\n          \n      \n    \n    \n  \n\nthroughout PR. Empty check is redundant, and it's always String, not CharSequence so can use equals.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2038#discussion_r519288801", "createdAt": "2020-11-08T08:21:19Z", "author": {"login": "anuraaga"}, "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorExtractorMultipleHeaders.java", "diffHunk": "@@ -28,33 +28,38 @@\n       Context context, C carrier, TextMapPropagator.Getter<C> getter) {\n     Objects.requireNonNull(carrier, \"carrier\");\n     Objects.requireNonNull(getter, \"getter\");\n-    SpanContext spanContext = getSpanContextFromMultipleHeaders(carrier, getter);\n-    if (!spanContext.isValid()) {\n-      return Optional.empty();\n-    }\n-\n-    return Optional.of(context.with(Span.wrap(spanContext)));\n+    return extractSpanContextFromMultipleHeaders(context, carrier, getter);\n   }\n \n-  private static <C> SpanContext getSpanContextFromMultipleHeaders(\n-      C carrier, TextMapPropagator.Getter<C> getter) {\n+  private static <C> Optional<Context> extractSpanContextFromMultipleHeaders(\n+      Context context, C carrier, TextMapPropagator.Getter<C> getter) {\n     String traceId = getter.get(carrier, TRACE_ID_HEADER);\n     if (StringUtils.isNullOrEmpty(traceId)) {\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n     if (!Common.isTraceIdValid(traceId)) {\n       logger.fine(\n           \"Invalid TraceId in B3 header: \" + traceId + \"'. Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n \n     String spanId = getter.get(carrier, SPAN_ID_HEADER);\n     if (!Common.isSpanIdValid(spanId)) {\n       logger.fine(\"Invalid SpanId in B3 header: \" + spanId + \"'. Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n+    }\n+\n+    // if debug flag is set, then set sampled flag, and also store the B3 debug flag in the context\n+    // for onward use by B3 injector\n+    String debug = getter.get(carrier, DEBUG_HEADER);\n+    if (!StringUtils.isNullOrEmpty(debug) && debug.contentEquals(Common.TRUE_INT)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52ba177d2fa869baa501ec2025d842512cf27e2a"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ3NzI5OA==", "bodyText": "tidied this up", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2038#discussion_r519477298", "createdAt": "2020-11-08T21:07:51Z", "author": {"login": "jarebudev"}, "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorExtractorMultipleHeaders.java", "diffHunk": "@@ -28,33 +28,38 @@\n       Context context, C carrier, TextMapPropagator.Getter<C> getter) {\n     Objects.requireNonNull(carrier, \"carrier\");\n     Objects.requireNonNull(getter, \"getter\");\n-    SpanContext spanContext = getSpanContextFromMultipleHeaders(carrier, getter);\n-    if (!spanContext.isValid()) {\n-      return Optional.empty();\n-    }\n-\n-    return Optional.of(context.with(Span.wrap(spanContext)));\n+    return extractSpanContextFromMultipleHeaders(context, carrier, getter);\n   }\n \n-  private static <C> SpanContext getSpanContextFromMultipleHeaders(\n-      C carrier, TextMapPropagator.Getter<C> getter) {\n+  private static <C> Optional<Context> extractSpanContextFromMultipleHeaders(\n+      Context context, C carrier, TextMapPropagator.Getter<C> getter) {\n     String traceId = getter.get(carrier, TRACE_ID_HEADER);\n     if (StringUtils.isNullOrEmpty(traceId)) {\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n     if (!Common.isTraceIdValid(traceId)) {\n       logger.fine(\n           \"Invalid TraceId in B3 header: \" + traceId + \"'. Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n \n     String spanId = getter.get(carrier, SPAN_ID_HEADER);\n     if (!Common.isSpanIdValid(spanId)) {\n       logger.fine(\"Invalid SpanId in B3 header: \" + spanId + \"'. Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n+    }\n+\n+    // if debug flag is set, then set sampled flag, and also store the B3 debug flag in the context\n+    // for onward use by B3 injector\n+    String debug = getter.get(carrier, DEBUG_HEADER);\n+    if (!StringUtils.isNullOrEmpty(debug) && debug.contentEquals(Common.TRUE_INT)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTI4ODgwMQ=="}, "originalCommit": {"oid": "52ba177d2fa869baa501ec2025d842512cf27e2a"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NTE4MDQ0OnYy", "diffSide": "RIGHT", "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorExtractorMultipleHeaders.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQwODoyNDoxNVrOHvO8gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQyMTowODowOFrOHvaYRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTI4OTk4Nw==", "bodyText": "In some cases we pass debug, others Common.TRUE_INT - I'd pass Common.TRUE_INT everywhere", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2038#discussion_r519289987", "createdAt": "2020-11-08T08:24:15Z", "author": {"login": "anuraaga"}, "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorExtractorMultipleHeaders.java", "diffHunk": "@@ -28,33 +28,38 @@\n       Context context, C carrier, TextMapPropagator.Getter<C> getter) {\n     Objects.requireNonNull(carrier, \"carrier\");\n     Objects.requireNonNull(getter, \"getter\");\n-    SpanContext spanContext = getSpanContextFromMultipleHeaders(carrier, getter);\n-    if (!spanContext.isValid()) {\n-      return Optional.empty();\n-    }\n-\n-    return Optional.of(context.with(Span.wrap(spanContext)));\n+    return extractSpanContextFromMultipleHeaders(context, carrier, getter);\n   }\n \n-  private static <C> SpanContext getSpanContextFromMultipleHeaders(\n-      C carrier, TextMapPropagator.Getter<C> getter) {\n+  private static <C> Optional<Context> extractSpanContextFromMultipleHeaders(\n+      Context context, C carrier, TextMapPropagator.Getter<C> getter) {\n     String traceId = getter.get(carrier, TRACE_ID_HEADER);\n     if (StringUtils.isNullOrEmpty(traceId)) {\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n     if (!Common.isTraceIdValid(traceId)) {\n       logger.fine(\n           \"Invalid TraceId in B3 header: \" + traceId + \"'. Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n \n     String spanId = getter.get(carrier, SPAN_ID_HEADER);\n     if (!Common.isSpanIdValid(spanId)) {\n       logger.fine(\"Invalid SpanId in B3 header: \" + spanId + \"'. Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n+    }\n+\n+    // if debug flag is set, then set sampled flag, and also store the B3 debug flag in the context\n+    // for onward use by B3 injector\n+    String debug = getter.get(carrier, DEBUG_HEADER);\n+    if (!StringUtils.isNullOrEmpty(debug) && debug.contentEquals(Common.TRUE_INT)) {\n+      return Optional.of(\n+          context\n+              .with(B3Propagator.DEBUG_CONTEXT, debug)\n+              .with(Span.wrap(Common.buildSpanContext(traceId, spanId, debug))));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52ba177d2fa869baa501ec2025d842512cf27e2a"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ3NzMxNg==", "bodyText": "done", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2038#discussion_r519477316", "createdAt": "2020-11-08T21:08:08Z", "author": {"login": "jarebudev"}, "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorExtractorMultipleHeaders.java", "diffHunk": "@@ -28,33 +28,38 @@\n       Context context, C carrier, TextMapPropagator.Getter<C> getter) {\n     Objects.requireNonNull(carrier, \"carrier\");\n     Objects.requireNonNull(getter, \"getter\");\n-    SpanContext spanContext = getSpanContextFromMultipleHeaders(carrier, getter);\n-    if (!spanContext.isValid()) {\n-      return Optional.empty();\n-    }\n-\n-    return Optional.of(context.with(Span.wrap(spanContext)));\n+    return extractSpanContextFromMultipleHeaders(context, carrier, getter);\n   }\n \n-  private static <C> SpanContext getSpanContextFromMultipleHeaders(\n-      C carrier, TextMapPropagator.Getter<C> getter) {\n+  private static <C> Optional<Context> extractSpanContextFromMultipleHeaders(\n+      Context context, C carrier, TextMapPropagator.Getter<C> getter) {\n     String traceId = getter.get(carrier, TRACE_ID_HEADER);\n     if (StringUtils.isNullOrEmpty(traceId)) {\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n     if (!Common.isTraceIdValid(traceId)) {\n       logger.fine(\n           \"Invalid TraceId in B3 header: \" + traceId + \"'. Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n \n     String spanId = getter.get(carrier, SPAN_ID_HEADER);\n     if (!Common.isSpanIdValid(spanId)) {\n       logger.fine(\"Invalid SpanId in B3 header: \" + spanId + \"'. Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n+    }\n+\n+    // if debug flag is set, then set sampled flag, and also store the B3 debug flag in the context\n+    // for onward use by B3 injector\n+    String debug = getter.get(carrier, DEBUG_HEADER);\n+    if (!StringUtils.isNullOrEmpty(debug) && debug.contentEquals(Common.TRUE_INT)) {\n+      return Optional.of(\n+          context\n+              .with(B3Propagator.DEBUG_CONTEXT, debug)\n+              .with(Span.wrap(Common.buildSpanContext(traceId, spanId, debug))));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTI4OTk4Nw=="}, "originalCommit": {"oid": "52ba177d2fa869baa501ec2025d842512cf27e2a"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1NTE4NjY1OnYy", "diffSide": "RIGHT", "path": "extensions/trace-propagators/src/test/java/io/opentelemetry/extension/trace/propagation/B3PropagatorTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQwODoyNjo0NVrOHvPAcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQyMTowNzoyOVrOHvaYCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTI5MDk5Mg==", "bodyText": "I believe we're missing two test cases for when both sampled and debug are set. Especially sampled = false and debug = true is important.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2038#discussion_r519290992", "createdAt": "2020-11-08T08:26:45Z", "author": {"login": "anuraaga"}, "path": "extensions/trace-propagators/src/test/java/io/opentelemetry/extension/trace/propagation/B3PropagatorTest.java", "diffHunk": "@@ -599,4 +600,62 @@ void extract_emptyCarrier() {\n     assertThat(getSpanContext(b3Propagator.extract(Context.current(), emptyHeaders, getter)))\n         .isEqualTo(SpanContext.getInvalid());\n   }\n+\n+  @Test\n+  void extract_DebugContext_SingleHeader() {\n+    Map<String, String> carrier = new LinkedHashMap<>();\n+    carrier.put(B3Propagator.COMBINED_HEADER, TRACE_ID + \"-\" + SPAN_ID + \"-\" + \"d\");\n+\n+    Context context = b3Propagator.extract(Context.current(), carrier, getter);\n+    assertThat(getSpanContext(context))\n+        .isEqualTo(\n+            SpanContext.createFromRemoteParent(\n+                TRACE_ID, SPAN_ID, SAMPLED_TRACE_OPTIONS, TRACE_STATE_DEFAULT));\n+    assertThat(context.get(DEBUG_CONTEXT)).isEqualTo(Common.TRUE_INT);\n+  }\n+\n+  @Test\n+  void extract_DebugContext_MultipleHeaders() {\n+    Map<String, String> carrier = new LinkedHashMap<>();\n+    carrier.put(B3Propagator.TRACE_ID_HEADER, TRACE_ID);\n+    carrier.put(B3Propagator.SPAN_ID_HEADER, SPAN_ID);\n+    carrier.put(B3Propagator.DEBUG_HEADER, Common.TRUE_INT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52ba177d2fa869baa501ec2025d842512cf27e2a"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTQ3NzI1Ng==", "bodyText": "added", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2038#discussion_r519477256", "createdAt": "2020-11-08T21:07:29Z", "author": {"login": "jarebudev"}, "path": "extensions/trace-propagators/src/test/java/io/opentelemetry/extension/trace/propagation/B3PropagatorTest.java", "diffHunk": "@@ -599,4 +600,62 @@ void extract_emptyCarrier() {\n     assertThat(getSpanContext(b3Propagator.extract(Context.current(), emptyHeaders, getter)))\n         .isEqualTo(SpanContext.getInvalid());\n   }\n+\n+  @Test\n+  void extract_DebugContext_SingleHeader() {\n+    Map<String, String> carrier = new LinkedHashMap<>();\n+    carrier.put(B3Propagator.COMBINED_HEADER, TRACE_ID + \"-\" + SPAN_ID + \"-\" + \"d\");\n+\n+    Context context = b3Propagator.extract(Context.current(), carrier, getter);\n+    assertThat(getSpanContext(context))\n+        .isEqualTo(\n+            SpanContext.createFromRemoteParent(\n+                TRACE_ID, SPAN_ID, SAMPLED_TRACE_OPTIONS, TRACE_STATE_DEFAULT));\n+    assertThat(context.get(DEBUG_CONTEXT)).isEqualTo(Common.TRUE_INT);\n+  }\n+\n+  @Test\n+  void extract_DebugContext_MultipleHeaders() {\n+    Map<String, String> carrier = new LinkedHashMap<>();\n+    carrier.put(B3Propagator.TRACE_ID_HEADER, TRACE_ID);\n+    carrier.put(B3Propagator.SPAN_ID_HEADER, SPAN_ID);\n+    carrier.put(B3Propagator.DEBUG_HEADER, Common.TRUE_INT);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTI5MDk5Mg=="}, "originalCommit": {"oid": "52ba177d2fa869baa501ec2025d842512cf27e2a"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2MDIyMTQ1OnYy", "diffSide": "RIGHT", "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorExtractorSingleHeader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxOToyNToyMlrOHv-N1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxOTozNzowMlrOHv-n_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA2NDQ2OA==", "bodyText": "We should use the constant defined in the B3Propagator class here", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2038#discussion_r520064468", "createdAt": "2020-11-09T19:25:22Z", "author": {"login": "jkwatson"}, "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorExtractorSingleHeader.java", "diffHunk": "@@ -50,25 +44,34 @@\n     if (parts.length < 2 || parts.length > 4) {\n       logger.fine(\n           \"Invalid combined header '\" + COMBINED_HEADER + \". Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n \n     String traceId = parts[0];\n     if (!Common.isTraceIdValid(traceId)) {\n       logger.fine(\n           \"Invalid TraceId in B3 header: \" + COMBINED_HEADER + \". Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n \n     String spanId = parts[1];\n     if (!Common.isSpanIdValid(spanId)) {\n       logger.fine(\n           \"Invalid SpanId in B3 header: \" + COMBINED_HEADER + \". Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n \n     String sampled = parts.length >= 3 ? parts[2] : null;\n \n-    return Common.buildSpanContext(traceId, spanId, sampled);\n+    // if sampled is marked as 'd'ebug, then set sampled flag, and also store the B3 debug flag in\n+    // the context for onward use by the B3 injector\n+    if (sampled != null && sampled.equals(\"d\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a730fdb34829175f2248078ffbefb49e74ddb352"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA3MTE2Nw==", "bodyText": "And, if you flip the .equals, you can skip the null check as well.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2038#discussion_r520071167", "createdAt": "2020-11-09T19:37:02Z", "author": {"login": "jkwatson"}, "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorExtractorSingleHeader.java", "diffHunk": "@@ -50,25 +44,34 @@\n     if (parts.length < 2 || parts.length > 4) {\n       logger.fine(\n           \"Invalid combined header '\" + COMBINED_HEADER + \". Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n \n     String traceId = parts[0];\n     if (!Common.isTraceIdValid(traceId)) {\n       logger.fine(\n           \"Invalid TraceId in B3 header: \" + COMBINED_HEADER + \". Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n \n     String spanId = parts[1];\n     if (!Common.isSpanIdValid(spanId)) {\n       logger.fine(\n           \"Invalid SpanId in B3 header: \" + COMBINED_HEADER + \". Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n \n     String sampled = parts.length >= 3 ? parts[2] : null;\n \n-    return Common.buildSpanContext(traceId, spanId, sampled);\n+    // if sampled is marked as 'd'ebug, then set sampled flag, and also store the B3 debug flag in\n+    // the context for onward use by the B3 injector\n+    if (sampled != null && sampled.equals(\"d\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA2NDQ2OA=="}, "originalCommit": {"oid": "a730fdb34829175f2248078ffbefb49e74ddb352"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2MDIzNDI0OnYy", "diffSide": "RIGHT", "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorExtractorMultipleHeaders.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxOToyODo0OFrOHv-Vlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMjo0OToxNlrOHwEtxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA2NjQ1NA==", "bodyText": "Shouldn't this be comparing to B3Propagator.DEBUG_SAMPLED, since we're extracting it from the incoming request?", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2038#discussion_r520066454", "createdAt": "2020-11-09T19:28:48Z", "author": {"login": "jkwatson"}, "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorExtractorMultipleHeaders.java", "diffHunk": "@@ -28,33 +28,37 @@\n       Context context, C carrier, TextMapPropagator.Getter<C> getter) {\n     Objects.requireNonNull(carrier, \"carrier\");\n     Objects.requireNonNull(getter, \"getter\");\n-    SpanContext spanContext = getSpanContextFromMultipleHeaders(carrier, getter);\n-    if (!spanContext.isValid()) {\n-      return Optional.empty();\n-    }\n-\n-    return Optional.of(context.with(Span.wrap(spanContext)));\n+    return extractSpanContextFromMultipleHeaders(context, carrier, getter);\n   }\n \n-  private static <C> SpanContext getSpanContextFromMultipleHeaders(\n-      C carrier, TextMapPropagator.Getter<C> getter) {\n+  private static <C> Optional<Context> extractSpanContextFromMultipleHeaders(\n+      Context context, C carrier, TextMapPropagator.Getter<C> getter) {\n     String traceId = getter.get(carrier, TRACE_ID_HEADER);\n     if (StringUtils.isNullOrEmpty(traceId)) {\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n     if (!Common.isTraceIdValid(traceId)) {\n       logger.fine(\n           \"Invalid TraceId in B3 header: \" + traceId + \"'. Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n \n     String spanId = getter.get(carrier, SPAN_ID_HEADER);\n     if (!Common.isSpanIdValid(spanId)) {\n       logger.fine(\"Invalid SpanId in B3 header: \" + spanId + \"'. Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n+    }\n+\n+    // if debug flag is set, then set sampled flag, and also store the B3 debug flag in the context\n+    // for onward use by B3 injector\n+    if (Common.TRUE_INT.equals(getter.get(carrier, DEBUG_HEADER))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a730fdb34829175f2248078ffbefb49e74ddb352"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA2ODQ5Nw==", "bodyText": "er wait. that's \"d\" where as the format specifies a \"1\" for the debug flag. What is the \"d\" for?", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2038#discussion_r520068497", "createdAt": "2020-11-09T19:32:20Z", "author": {"login": "jkwatson"}, "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorExtractorMultipleHeaders.java", "diffHunk": "@@ -28,33 +28,37 @@\n       Context context, C carrier, TextMapPropagator.Getter<C> getter) {\n     Objects.requireNonNull(carrier, \"carrier\");\n     Objects.requireNonNull(getter, \"getter\");\n-    SpanContext spanContext = getSpanContextFromMultipleHeaders(carrier, getter);\n-    if (!spanContext.isValid()) {\n-      return Optional.empty();\n-    }\n-\n-    return Optional.of(context.with(Span.wrap(spanContext)));\n+    return extractSpanContextFromMultipleHeaders(context, carrier, getter);\n   }\n \n-  private static <C> SpanContext getSpanContextFromMultipleHeaders(\n-      C carrier, TextMapPropagator.Getter<C> getter) {\n+  private static <C> Optional<Context> extractSpanContextFromMultipleHeaders(\n+      Context context, C carrier, TextMapPropagator.Getter<C> getter) {\n     String traceId = getter.get(carrier, TRACE_ID_HEADER);\n     if (StringUtils.isNullOrEmpty(traceId)) {\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n     if (!Common.isTraceIdValid(traceId)) {\n       logger.fine(\n           \"Invalid TraceId in B3 header: \" + traceId + \"'. Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n \n     String spanId = getter.get(carrier, SPAN_ID_HEADER);\n     if (!Common.isSpanIdValid(spanId)) {\n       logger.fine(\"Invalid SpanId in B3 header: \" + spanId + \"'. Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n+    }\n+\n+    // if debug flag is set, then set sampled flag, and also store the B3 debug flag in the context\n+    // for onward use by B3 injector\n+    if (Common.TRUE_INT.equals(getter.get(carrier, DEBUG_HEADER))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA2NjQ1NA=="}, "originalCommit": {"oid": "a730fdb34829175f2248078ffbefb49e74ddb352"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA3MDUzNw==", "bodyText": "I got it. \"d\" is used for single-header and \"1\" is used for multi-header. I recommend not using the Common constant here, but putting a separate constant in the B3Propagator class for B3 multi-header in particular.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2038#discussion_r520070537", "createdAt": "2020-11-09T19:36:00Z", "author": {"login": "jkwatson"}, "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorExtractorMultipleHeaders.java", "diffHunk": "@@ -28,33 +28,37 @@\n       Context context, C carrier, TextMapPropagator.Getter<C> getter) {\n     Objects.requireNonNull(carrier, \"carrier\");\n     Objects.requireNonNull(getter, \"getter\");\n-    SpanContext spanContext = getSpanContextFromMultipleHeaders(carrier, getter);\n-    if (!spanContext.isValid()) {\n-      return Optional.empty();\n-    }\n-\n-    return Optional.of(context.with(Span.wrap(spanContext)));\n+    return extractSpanContextFromMultipleHeaders(context, carrier, getter);\n   }\n \n-  private static <C> SpanContext getSpanContextFromMultipleHeaders(\n-      C carrier, TextMapPropagator.Getter<C> getter) {\n+  private static <C> Optional<Context> extractSpanContextFromMultipleHeaders(\n+      Context context, C carrier, TextMapPropagator.Getter<C> getter) {\n     String traceId = getter.get(carrier, TRACE_ID_HEADER);\n     if (StringUtils.isNullOrEmpty(traceId)) {\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n     if (!Common.isTraceIdValid(traceId)) {\n       logger.fine(\n           \"Invalid TraceId in B3 header: \" + traceId + \"'. Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n \n     String spanId = getter.get(carrier, SPAN_ID_HEADER);\n     if (!Common.isSpanIdValid(spanId)) {\n       logger.fine(\"Invalid SpanId in B3 header: \" + spanId + \"'. Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n+    }\n+\n+    // if debug flag is set, then set sampled flag, and also store the B3 debug flag in the context\n+    // for onward use by B3 injector\n+    if (Common.TRUE_INT.equals(getter.get(carrier, DEBUG_HEADER))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA2NjQ1NA=="}, "originalCommit": {"oid": "a730fdb34829175f2248078ffbefb49e74ddb352"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE3MDk0OA==", "bodyText": "Sure, what I've done is add a couple of constants in B3Propagator which should hopefully make this clearer\n  static final String MULTI_HEADER_DEBUG = \"1\";\n  static final String SINGLE_HEADER_DEBUG = \"d\";", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2038#discussion_r520170948", "createdAt": "2020-11-09T22:49:16Z", "author": {"login": "jarebudev"}, "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorExtractorMultipleHeaders.java", "diffHunk": "@@ -28,33 +28,37 @@\n       Context context, C carrier, TextMapPropagator.Getter<C> getter) {\n     Objects.requireNonNull(carrier, \"carrier\");\n     Objects.requireNonNull(getter, \"getter\");\n-    SpanContext spanContext = getSpanContextFromMultipleHeaders(carrier, getter);\n-    if (!spanContext.isValid()) {\n-      return Optional.empty();\n-    }\n-\n-    return Optional.of(context.with(Span.wrap(spanContext)));\n+    return extractSpanContextFromMultipleHeaders(context, carrier, getter);\n   }\n \n-  private static <C> SpanContext getSpanContextFromMultipleHeaders(\n-      C carrier, TextMapPropagator.Getter<C> getter) {\n+  private static <C> Optional<Context> extractSpanContextFromMultipleHeaders(\n+      Context context, C carrier, TextMapPropagator.Getter<C> getter) {\n     String traceId = getter.get(carrier, TRACE_ID_HEADER);\n     if (StringUtils.isNullOrEmpty(traceId)) {\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n     if (!Common.isTraceIdValid(traceId)) {\n       logger.fine(\n           \"Invalid TraceId in B3 header: \" + traceId + \"'. Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n     }\n \n     String spanId = getter.get(carrier, SPAN_ID_HEADER);\n     if (!Common.isSpanIdValid(spanId)) {\n       logger.fine(\"Invalid SpanId in B3 header: \" + spanId + \"'. Returning INVALID span context.\");\n-      return SpanContext.getInvalid();\n+      return Optional.empty();\n+    }\n+\n+    // if debug flag is set, then set sampled flag, and also store the B3 debug flag in the context\n+    // for onward use by B3 injector\n+    if (Common.TRUE_INT.equals(getter.get(carrier, DEBUG_HEADER))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA2NjQ1NA=="}, "originalCommit": {"oid": "a730fdb34829175f2248078ffbefb49e74ddb352"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2MTE4NTYxOnYy", "diffSide": "RIGHT", "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorInjectorMultipleHeaders.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwMDo0MzozOFrOHwHQaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMDo1MTozNVrOHwvJMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIxMjU4NQ==", "bodyText": "Should we use the new constant here, MULTI_HEADER_DEBUG?", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2038#discussion_r520212585", "createdAt": "2020-11-10T00:43:38Z", "author": {"login": "anuraaga"}, "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorInjectorMultipleHeaders.java", "diffHunk": "@@ -26,6 +26,12 @@\n \n     String sampled = spanContext.isSampled() ? Common.TRUE_INT : Common.FALSE_INT;\n \n+    String debug = context.get(B3Propagator.DEBUG_CONTEXT_KEY);\n+    if (!StringUtils.isNullOrEmpty(debug) && debug.contentEquals(Common.TRUE_INT)) {\n+      setter.set(carrier, B3Propagator.DEBUG_HEADER, Common.TRUE_INT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7ce0aec45d16016329b392b724263aa709db2ed"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg2NjA5OA==", "bodyText": "yeh, have changed it/tidied it up.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2038#discussion_r520866098", "createdAt": "2020-11-10T20:51:35Z", "author": {"login": "jarebudev"}, "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorInjectorMultipleHeaders.java", "diffHunk": "@@ -26,6 +26,12 @@\n \n     String sampled = spanContext.isSampled() ? Common.TRUE_INT : Common.FALSE_INT;\n \n+    String debug = context.get(B3Propagator.DEBUG_CONTEXT_KEY);\n+    if (!StringUtils.isNullOrEmpty(debug) && debug.contentEquals(Common.TRUE_INT)) {\n+      setter.set(carrier, B3Propagator.DEBUG_HEADER, Common.TRUE_INT);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIxMjU4NQ=="}, "originalCommit": {"oid": "e7ce0aec45d16016329b392b724263aa709db2ed"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2MTE4NjM5OnYy", "diffSide": "RIGHT", "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorInjectorMultipleHeaders.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwMDo0NDowNlrOHwHQ5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwMDo0NDowNlrOHwHQ5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDIxMjcxMQ==", "bodyText": "Common.TRUE_INT.equals(debug) for this and next file I think", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2038#discussion_r520212711", "createdAt": "2020-11-10T00:44:06Z", "author": {"login": "anuraaga"}, "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorInjectorMultipleHeaders.java", "diffHunk": "@@ -26,6 +26,12 @@\n \n     String sampled = spanContext.isSampled() ? Common.TRUE_INT : Common.FALSE_INT;\n \n+    String debug = context.get(B3Propagator.DEBUG_CONTEXT_KEY);\n+    if (!StringUtils.isNullOrEmpty(debug) && debug.contentEquals(Common.TRUE_INT)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7ce0aec45d16016329b392b724263aa709db2ed"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2NTUwOTY4OnYy", "diffSide": "RIGHT", "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorInjectorMultipleHeaders.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMTo0MDowMVrOHwwqTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMjowNDowN1rOHxf9Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg5MDk1OQ==", "bodyText": "Hm. In this case, aren't we putting Common.TRUE_INT into the context, not B3Propagator.MULTI_HEADER_DEBUG? They might happen to have the same value at the moment, but I don't think we should confuse the constant from the wire protocol with the constant that we're using internally for propagation.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2038#discussion_r520890959", "createdAt": "2020-11-10T21:40:01Z", "author": {"login": "jkwatson"}, "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorInjectorMultipleHeaders.java", "diffHunk": "@@ -26,6 +26,11 @@\n \n     String sampled = spanContext.isSampled() ? Common.TRUE_INT : Common.FALSE_INT;\n \n+    if (B3Propagator.MULTI_HEADER_DEBUG.equals(context.get(B3Propagator.DEBUG_CONTEXT_KEY))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "205102c41d7eac38794c0d72e2852f21c7950ad4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTA5ODQxNw==", "bodyText": "Ah good point - whether the b3 debug was enabled or not is sort of independent of how it was actually modeled in the header, and it might be converted from single to multiple, or vice versa. @jarebudev How about just using a Boolean context value for this?", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2038#discussion_r521098417", "createdAt": "2020-11-11T04:02:16Z", "author": {"login": "anuraaga"}, "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorInjectorMultipleHeaders.java", "diffHunk": "@@ -26,6 +26,11 @@\n \n     String sampled = spanContext.isSampled() ? Common.TRUE_INT : Common.FALSE_INT;\n \n+    if (B3Propagator.MULTI_HEADER_DEBUG.equals(context.get(B3Propagator.DEBUG_CONTEXT_KEY))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg5MDk1OQ=="}, "originalCommit": {"oid": "205102c41d7eac38794c0d72e2852f21c7950ad4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY2NTgzMA==", "bodyText": "Yeh makes sense. I've changed it to set a boolean, hopefully this sorts it!", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2038#discussion_r521665830", "createdAt": "2020-11-11T22:04:07Z", "author": {"login": "jarebudev"}, "path": "extensions/trace-propagators/src/main/java/io/opentelemetry/extension/trace/propagation/B3PropagatorInjectorMultipleHeaders.java", "diffHunk": "@@ -26,6 +26,11 @@\n \n     String sampled = spanContext.isSampled() ? Common.TRUE_INT : Common.FALSE_INT;\n \n+    if (B3Propagator.MULTI_HEADER_DEBUG.equals(context.get(B3Propagator.DEBUG_CONTEXT_KEY))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg5MDk1OQ=="}, "originalCommit": {"oid": "205102c41d7eac38794c0d72e2852f21c7950ad4"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1915, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}