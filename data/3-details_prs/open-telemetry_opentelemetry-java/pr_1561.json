{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMzM4NzQ1", "number": 1561, "title": "Update the TraceState key validations to more closely match the w3c spec", "bodyText": "Resolves #1027", "createdAt": "2020-08-19T18:30:42Z", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561", "merged": true, "mergeCommit": {"oid": "79b6f0e14cd6b4db5d2ccc174709a010e5b10bc2"}, "closed": true, "closedAt": "2020-08-23T16:52:46Z", "author": {"login": "jkwatson"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAf1WhAH2gAyNDcwMzM4NzQ1OmQ0YWMyZWFmOTM5NTk3M2Y3MGVjYjc5M2VlMGZiOGVhNTMzMmM4Nzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdBnZaigFqTQ3Mjk4MTExMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d4ac2eaf9395973f70ecb793ee0fb8ea5332c879", "author": {"user": null}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/d4ac2eaf9395973f70ecb793ee0fb8ea5332c879", "committedDate": "2020-08-19T18:22:34Z", "message": "Update the TraceState key validations to more closely match the w3c spec."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwOTk0Nzcw", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#pullrequestreview-470994770", "createdAt": "2020-08-19T21:59:12Z", "commit": {"oid": "d4ac2eaf9395973f70ecb793ee0fb8ea5332c879"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMjcwNTMw", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#pullrequestreview-471270530", "createdAt": "2020-08-20T06:06:46Z", "commit": {"oid": "d4ac2eaf9395973f70ecb793ee0fb8ea5332c879"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMjczMDkw", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#pullrequestreview-471273090", "createdAt": "2020-08-20T06:12:53Z", "commit": {"oid": "d4ac2eaf9395973f70ecb793ee0fb8ea5332c879"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwNjoxMjo1M1rOHDsYYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwNjoxMjo1M1rOHDsYYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzNDkxMw==", "bodyText": "I'm having trouble grokking this code.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#discussion_r473634913", "createdAt": "2020-08-20T06:12:53Z", "author": {"login": "anuraaga"}, "path": "api/src/main/java/io/opentelemetry/trace/TraceState.java", "diffHunk": "@@ -235,26 +235,53 @@ public static Entry create(String key, String value) {\n   // Key is opaque string up to 256 characters printable. It MUST begin with a lowercase letter, and\n   // can only contain lowercase letters a-z, digits 0-9, underscores _, dashes -, asterisks *, and\n   // forward slashes /.  For multi-tenant vendor scenarios, an at sign (@) can be used to prefix the\n-  // vendor name.\n+  // vendor name. The tenant id (before the '@') is limited to 240 characters and the vendor id is\n+  // limited to 13 characters. If in the multi-tenant vendor format, then the first character\n+  // may additionally be digit.\n+  //\n   // todo: benchmark this implementation\n   private static boolean validateKey(String key) {\n-    if (key.length() > KEY_MAX_SIZE || key.isEmpty() || !isNumberOrDigit(key.charAt(0))) {\n+    if (key.length() > KEY_MAX_SIZE || key.isEmpty() || !isLowercaseLetterOrDigit(key.charAt(0))) {\n       return false;\n     }\n     int atSeenCount = 0;\n     for (int i = 1; i < key.length(); i++) {\n       char c = key.charAt(i);\n-      if (!isNumberOrDigit(c) && c != '_' && c != '-' && c != '@' && c != '*' && c != '/') {\n+      if (!isLowercaseLetterOrDigit(c)\n+          && c != '_'\n+          && c != '-'\n+          && c != '@'\n+          && c != '*'\n+          && c != '/') {\n         return false;\n       }\n-      if ((c == '@') && (++atSeenCount > 1)) {\n-        return false;\n+      int atPosition = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4ac2eaf9395973f70ecb793ee0fb8ea5332c879"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMjczNzc1", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#pullrequestreview-471273775", "createdAt": "2020-08-20T06:14:31Z", "commit": {"oid": "d4ac2eaf9395973f70ecb793ee0fb8ea5332c879"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwNjoxNDozMVrOHDscWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwNjoxNToxNVrOHDsekg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzNTkzMA==", "bodyText": "Instead of having atPosition is it ok to do something like this in this branch?\n// remaining is vendor id, must be 13 characters or less\nif (key.length() - i > 13) {\n  return false;\n}", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#discussion_r473635930", "createdAt": "2020-08-20T06:14:31Z", "author": {"login": "anuraaga"}, "path": "api/src/main/java/io/opentelemetry/trace/TraceState.java", "diffHunk": "@@ -235,26 +235,53 @@ public static Entry create(String key, String value) {\n   // Key is opaque string up to 256 characters printable. It MUST begin with a lowercase letter, and\n   // can only contain lowercase letters a-z, digits 0-9, underscores _, dashes -, asterisks *, and\n   // forward slashes /.  For multi-tenant vendor scenarios, an at sign (@) can be used to prefix the\n-  // vendor name.\n+  // vendor name. The tenant id (before the '@') is limited to 240 characters and the vendor id is\n+  // limited to 13 characters. If in the multi-tenant vendor format, then the first character\n+  // may additionally be digit.\n+  //\n   // todo: benchmark this implementation\n   private static boolean validateKey(String key) {\n-    if (key.length() > KEY_MAX_SIZE || key.isEmpty() || !isNumberOrDigit(key.charAt(0))) {\n+    if (key.length() > KEY_MAX_SIZE || key.isEmpty() || !isLowercaseLetterOrDigit(key.charAt(0))) {\n       return false;\n     }\n     int atSeenCount = 0;\n     for (int i = 1; i < key.length(); i++) {\n       char c = key.charAt(i);\n-      if (!isNumberOrDigit(c) && c != '_' && c != '-' && c != '@' && c != '*' && c != '/') {\n+      if (!isLowercaseLetterOrDigit(c)\n+          && c != '_'\n+          && c != '-'\n+          && c != '@'\n+          && c != '*'\n+          && c != '/') {\n         return false;\n       }\n-      if ((c == '@') && (++atSeenCount > 1)) {\n-        return false;\n+      int atPosition = 0;\n+      if (c == '@') {\n+        atPosition = i;\n+        // tenant id must be 240 characters or less\n+        if (i > 240) {\n+          return false;\n+        }\n+        atSeenCount++;\n+        if (atSeenCount > 1) {\n+          return false;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4ac2eaf9395973f70ecb793ee0fb8ea5332c879"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzNjQ5OA==", "bodyText": "I may just be misgrokking, but isn't atPosition 0 for most of the loop rather than the actual atPosition? If my reading is right, my above suggestion would probably solve it but it also means there's a unit test missing for the current buggy state.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#discussion_r473636498", "createdAt": "2020-08-20T06:15:15Z", "author": {"login": "anuraaga"}, "path": "api/src/main/java/io/opentelemetry/trace/TraceState.java", "diffHunk": "@@ -235,26 +235,53 @@ public static Entry create(String key, String value) {\n   // Key is opaque string up to 256 characters printable. It MUST begin with a lowercase letter, and\n   // can only contain lowercase letters a-z, digits 0-9, underscores _, dashes -, asterisks *, and\n   // forward slashes /.  For multi-tenant vendor scenarios, an at sign (@) can be used to prefix the\n-  // vendor name.\n+  // vendor name. The tenant id (before the '@') is limited to 240 characters and the vendor id is\n+  // limited to 13 characters. If in the multi-tenant vendor format, then the first character\n+  // may additionally be digit.\n+  //\n   // todo: benchmark this implementation\n   private static boolean validateKey(String key) {\n-    if (key.length() > KEY_MAX_SIZE || key.isEmpty() || !isNumberOrDigit(key.charAt(0))) {\n+    if (key.length() > KEY_MAX_SIZE || key.isEmpty() || !isLowercaseLetterOrDigit(key.charAt(0))) {\n       return false;\n     }\n     int atSeenCount = 0;\n     for (int i = 1; i < key.length(); i++) {\n       char c = key.charAt(i);\n-      if (!isNumberOrDigit(c) && c != '_' && c != '-' && c != '@' && c != '*' && c != '/') {\n+      if (!isLowercaseLetterOrDigit(c)\n+          && c != '_'\n+          && c != '-'\n+          && c != '@'\n+          && c != '*'\n+          && c != '/') {\n         return false;\n       }\n-      if ((c == '@') && (++atSeenCount > 1)) {\n-        return false;\n+      int atPosition = 0;\n+      if (c == '@') {\n+        atPosition = i;\n+        // tenant id must be 240 characters or less\n+        if (i > 240) {\n+          return false;\n+        }\n+        atSeenCount++;\n+        if (atSeenCount > 1) {\n+          return false;\n+        }\n       }\n+      if (atSeenCount == 1) {\n+        // vendor id must be 13 characters or less\n+        if ((i - atPosition) > 13) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4ac2eaf9395973f70ecb793ee0fb8ea5332c879"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMjc1MTEz", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#pullrequestreview-471275113", "createdAt": "2020-08-20T06:17:32Z", "commit": {"oid": "d4ac2eaf9395973f70ecb793ee0fb8ea5332c879"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwNjoxNzozM1rOHDskaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwNjoxNzozM1rOHDskaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzNzk5NQ==", "bodyText": "Also, guess we should avoid unicode comparisons like this and stick with simple ones we implement", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#discussion_r473637995", "createdAt": "2020-08-20T06:17:33Z", "author": {"login": "anuraaga"}, "path": "api/src/main/java/io/opentelemetry/trace/TraceState.java", "diffHunk": "@@ -235,26 +235,53 @@ public static Entry create(String key, String value) {\n   // Key is opaque string up to 256 characters printable. It MUST begin with a lowercase letter, and\n   // can only contain lowercase letters a-z, digits 0-9, underscores _, dashes -, asterisks *, and\n   // forward slashes /.  For multi-tenant vendor scenarios, an at sign (@) can be used to prefix the\n-  // vendor name.\n+  // vendor name. The tenant id (before the '@') is limited to 240 characters and the vendor id is\n+  // limited to 13 characters. If in the multi-tenant vendor format, then the first character\n+  // may additionally be digit.\n+  //\n   // todo: benchmark this implementation\n   private static boolean validateKey(String key) {\n-    if (key.length() > KEY_MAX_SIZE || key.isEmpty() || !isNumberOrDigit(key.charAt(0))) {\n+    if (key.length() > KEY_MAX_SIZE || key.isEmpty() || !isLowercaseLetterOrDigit(key.charAt(0))) {\n       return false;\n     }\n     int atSeenCount = 0;\n     for (int i = 1; i < key.length(); i++) {\n       char c = key.charAt(i);\n-      if (!isNumberOrDigit(c) && c != '_' && c != '-' && c != '@' && c != '*' && c != '/') {\n+      if (!isLowercaseLetterOrDigit(c)\n+          && c != '_'\n+          && c != '-'\n+          && c != '@'\n+          && c != '*'\n+          && c != '/') {\n         return false;\n       }\n-      if ((c == '@') && (++atSeenCount > 1)) {\n-        return false;\n+      int atPosition = 0;\n+      if (c == '@') {\n+        atPosition = i;\n+        // tenant id must be 240 characters or less\n+        if (i > 240) {\n+          return false;\n+        }\n+        atSeenCount++;\n+        if (atSeenCount > 1) {\n+          return false;\n+        }\n       }\n+      if (atSeenCount == 1) {\n+        // vendor id must be 13 characters or less\n+        if ((i - atPosition) > 13) {\n+          return false;\n+        }\n+      }\n+    }\n+    if (atSeenCount == 0) {\n+      // if it's not the vendor format (with an '@' sign), the key must start with a letter.\n+      return !Character.isDigit(key.charAt(0));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4ac2eaf9395973f70ecb793ee0fb8ea5332c879"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18f20313e4bf259c4da5dca857bbf5055901fd20", "author": {"user": null}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/18f20313e4bf259c4da5dca857bbf5055901fd20", "committedDate": "2020-08-20T18:32:45Z", "message": "rework method and variable names for more clarity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "585922d441ee0556ffb28dd78e37562bb362473b", "author": {"user": null}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/585922d441ee0556ffb28dd78e37562bb362473b", "committedDate": "2020-08-21T18:06:04Z", "message": "Add some tests and fix a bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyOTgxMTEw", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1561#pullrequestreview-472981110", "createdAt": "2020-08-23T05:45:13Z", "commit": {"oid": "585922d441ee0556ffb28dd78e37562bb362473b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2368, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}