{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5MjkzNDIz", "number": 1021, "title": "Limit RecordEventsReadableSpan attributes to configured max", "bodyText": "Another step towards #993 and extends #1004. Closes #1022.\nThis PR adds support for dropping span attributes once the max configured in the TraceConfig has been reached and also maintain a count for the number of dropped attributes.\nThis also fixes up some existing tests that were broken by this change.", "createdAt": "2020-03-16T14:56:36Z", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1021", "merged": true, "mergeCommit": {"oid": "826ec7e27bc9da45f1ba760166ab6c7ed14473c1"}, "closed": true, "closedAt": "2020-03-18T18:48:19Z", "author": {"login": "MikeGoldsmith"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOOBcOAH2gAyMzg5MjkzNDIzOmM5NjE3YmZiNTE2YTNhNTRkNTA2MDQ1OTk3NGY5N2NhMzc0OGI1MWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOo3OsgFqTM3NjM4NjUzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c9617bfb516a3a54d5060459974f97ca3748b51b", "author": {"user": {"login": "MikeGoldsmith", "name": "Mike Goldsmith"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/c9617bfb516a3a54d5060459974f97ca3748b51b", "committedDate": "2020-03-16T13:21:16Z", "message": "limit max attributes in RecordEventsReadableSpan and update tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37059ee4a278944ebaea469a124c397669f40ca9", "author": {"user": {"login": "MikeGoldsmith", "name": "Mike Goldsmith"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/37059ee4a278944ebaea469a124c397669f40ca9", "committedDate": "2020-03-16T15:47:19Z", "message": "refactor dropped attribute count to total attibute count"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MzYyMDIw", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1021#pullrequestreview-375362020", "createdAt": "2020-03-16T16:06:51Z", "commit": {"oid": "37059ee4a278944ebaea469a124c397669f40ca9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNjowNjo1MlrOF27Log==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNjowNjo1MlrOF27Log==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzEzNzA1OA==", "bodyText": "Same needs to be implemented for dropped attributes in events and in links.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1021#discussion_r393137058", "createdAt": "2020-03-16T16:06:52Z", "author": {"login": "bogdandrutu"}, "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/data/SpanData.java", "diffHunk": "@@ -570,11 +572,11 @@ public abstract Builder setInstrumentationLibraryInfo(\n     public abstract Builder setTotalRecordedLinks(int totalRecordedLinks);\n \n     /**\n-     * Set the number of dropped attributes on this span.\n+     * Set the total number of attributes recorded on this span.\n      *\n-     * @param droppedAttributeCount The number of dropped attributes.\n+     * @param totalAttributeCount The total number of attributes recorded.\n      * @return this\n      */\n-    public abstract Builder setDroppedAttributeCount(int droppedAttributeCount);\n+    public abstract Builder setTotalAttributeCount(int totalAttributeCount);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37059ee4a278944ebaea469a124c397669f40ca9"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5939b4814ae48e70550a5d3be6e656ade381d4ce", "author": {"user": {"login": "MikeGoldsmith", "name": "Mike Goldsmith"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/5939b4814ae48e70550a5d3be6e656ade381d4ce", "committedDate": "2020-03-16T16:29:03Z", "message": "refactor link and event dropped counts to totals"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1Mzg3NDU1", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1021#pullrequestreview-375387455", "createdAt": "2020-03-16T16:36:36Z", "commit": {"oid": "5939b4814ae48e70550a5d3be6e656ade381d4ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNjozNjozNlrOF28ZdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNjozNjozNlrOF28ZdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE1Njk4MQ==", "bodyText": "This should be attributes.size() correct? Same everywhere, otherwise we have negative dropped :)", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1021#discussion_r393156981", "createdAt": "2020-03-16T16:36:36Z", "author": {"login": "bogdandrutu"}, "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/data/SpanData.java", "diffHunk": "@@ -245,34 +245,35 @@ public static Link create(SpanContext spanContext, Map<String, AttributeValue> a\n       return new AutoValue_SpanData_Link(\n           spanContext,\n           Collections.unmodifiableMap(new LinkedHashMap<>(attributes)),\n-          ZERO_DROPPED_ATTRIBUTE_COUNT);\n+          DEFAULT_ATTRIBUTE_COUNT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5939b4814ae48e70550a5d3be6e656ade381d4ce"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1a45c9d626c776dd67ef0f25ecdfb623edd3f9a", "author": {"user": {"login": "MikeGoldsmith", "name": "Mike Goldsmith"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/d1a45c9d626c776dd67ef0f25ecdfb623edd3f9a", "committedDate": "2020-03-16T19:29:21Z", "message": "set total attributes count to size of attribute map"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9777d13c163ea33205b33c56ecc9e1e83549b737", "author": {"user": {"login": "MikeGoldsmith", "name": "Mike Goldsmith"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/9777d13c163ea33205b33c56ecc9e1e83549b737", "committedDate": "2020-03-16T19:45:36Z", "message": "fix some test names"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NTYwOTY5", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1021#pullrequestreview-375560969", "createdAt": "2020-03-16T20:31:51Z", "commit": {"oid": "9777d13c163ea33205b33c56ecc9e1e83549b737"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NjM1NjI1", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1021#pullrequestreview-375635625", "createdAt": "2020-03-16T22:54:53Z", "commit": {"oid": "9777d13c163ea33205b33c56ecc9e1e83549b737"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMjo1NDo1M1rOF3Ia7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMjo1NToyN1rOF3IbuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM1Mzk2NA==", "bodyText": "You could also add the span's name and the key of the dropped attribute to ease debugging here.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1021#discussion_r393353964", "createdAt": "2020-03-16T22:54:53Z", "author": {"login": "arminru"}, "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/RecordEventsReadableSpan.java", "diffHunk": "@@ -325,6 +330,15 @@ public void setAttribute(String key, AttributeValue value) {\n         logger.log(Level.FINE, \"Calling setAttribute() on an ended Span.\");\n         return;\n       }\n+      totalAttributeCount++;\n+      if (attributes.get(key) == null && attributes.size() >= maxNumberOfAttributes) {\n+        logger.log(\n+            Level.FINE,\n+            \"Span has maximum number of attributes (\"\n+                + maxNumberOfAttributes\n+                + \"). Dropping new entries.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9777d13c163ea33205b33c56ecc9e1e83549b737"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzM1NDE2OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private int maxNumberOfAttributes = 0;\n          \n          \n            \n              private final int maxNumberOfAttributes = 0;", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1021#discussion_r393354169", "createdAt": "2020-03-16T22:55:27Z", "author": {"login": "arminru"}, "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/RecordEventsReadableSpan.java", "diffHunk": "@@ -63,6 +63,10 @@\n   private final List<Link> links;\n   // Number of links recorded.\n   private final int totalRecordedLinks;\n+  // Max number of attibutes per span.\n+  private int maxNumberOfAttributes = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9777d13c163ea33205b33c56ecc9e1e83549b737"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NzU3MDMx", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1021#pullrequestreview-375757031", "createdAt": "2020-03-17T05:56:04Z", "commit": {"oid": "9777d13c163ea33205b33c56ecc9e1e83549b737"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7dcffd6554cb66d5ccaa4a63aad1803e3a145686", "author": {"user": {"login": "MikeGoldsmith", "name": "Mike Goldsmith"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/7dcffd6554cb66d5ccaa4a63aad1803e3a145686", "committedDate": "2020-03-17T10:11:02Z", "message": "make maxNumberOfAttributes final\n\nCo-Authored-By: Armin Ruech <armin.ruech@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e65d79fc73c8f65667fdf7d3871ee64b4e15e96e", "author": {"user": {"login": "MikeGoldsmith", "name": "Mike Goldsmith"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/e65d79fc73c8f65667fdf7d3871ee64b4e15e96e", "committedDate": "2020-03-17T10:15:47Z", "message": "add total attribute count to SpanData.Event (TimedEvent)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04da38d6b7fe8314b0d1cf2e8de0b2b4c75b22bb", "author": {"user": {"login": "MikeGoldsmith", "name": "Mike Goldsmith"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/04da38d6b7fe8314b0d1cf2e8de0b2b4c75b22bb", "committedDate": "2020-03-17T14:26:28Z", "message": "add extra detail when dropping span attribute"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38d4db5eb9437f244fc444f80067531318d3b7d3", "author": {"user": {"login": "MikeGoldsmith", "name": "Mike Goldsmith"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/38d4db5eb9437f244fc444f80067531318d3b7d3", "committedDate": "2020-03-17T14:31:45Z", "message": "add extra detail when dropping link attributes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MTk2MDkz", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1021#pullrequestreview-376196093", "createdAt": "2020-03-17T16:23:01Z", "commit": {"oid": "38d4db5eb9437f244fc444f80067531318d3b7d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNjoyMzowMVrOF3j9OQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNjoyMzowMVrOF3j9OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgwNTExMw==", "bodyText": "this should be moved down into the mutable section below and marked as @GuardedBy(\"lock\")", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1021#discussion_r393805113", "createdAt": "2020-03-17T16:23:01Z", "author": {"login": "jkwatson"}, "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/RecordEventsReadableSpan.java", "diffHunk": "@@ -63,6 +64,12 @@\n   private final List<Link> links;\n   // Number of links recorded.\n   private final int totalRecordedLinks;\n+  // Max number of attibutes per span.\n+  private final int maxNumberOfAttributes;\n+  // Number of attributes recorded.\n+  private int totalAttributeCount = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38d4db5eb9437f244fc444f80067531318d3b7d3"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MTk2ODU0", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1021#pullrequestreview-376196854", "createdAt": "2020-03-17T16:23:50Z", "commit": {"oid": "38d4db5eb9437f244fc444f80067531318d3b7d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNjoyMzo1MFrOF3j_hA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNjoyMzo1MFrOF3j_hA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgwNTcwMA==", "bodyText": "I'd prefer to see the logging done with string interpolation, rather than a giant concatenated string like this.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1021#discussion_r393805700", "createdAt": "2020-03-17T16:23:50Z", "author": {"login": "jkwatson"}, "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/RecordEventsReadableSpan.java", "diffHunk": "@@ -325,6 +333,19 @@ public void setAttribute(String key, AttributeValue value) {\n         logger.log(Level.FINE, \"Calling setAttribute() on an ended Span.\");\n         return;\n       }\n+      totalAttributeCount++;\n+      if (attributes.get(key) == null && attributes.size() >= maxNumberOfAttributes) {\n+        logger.log(\n+            Level.FINE,\n+            \"Span with name '\"\n+                + this.name\n+                + \"' has reached the maximum number of attributes (\"\n+                + maxNumberOfAttributes\n+                + \"). Dropping attribute with key '\"\n+                + key\n+                + \"'\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38d4db5eb9437f244fc444f80067531318d3b7d3"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2a8309741ed5b42551b944c0bac4ae405eff1a3", "author": {"user": {"login": "MikeGoldsmith", "name": "Mike Goldsmith"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/b2a8309741ed5b42551b944c0bac4ae405eff1a3", "committedDate": "2020-03-17T19:57:56Z", "message": "move numberOfAttributeCount and add Guardedby(\u201clock\u201d)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f0435eccef5e5fa1b709bc54c14a36f97e3d422", "author": {"user": {"login": "MikeGoldsmith", "name": "Mike Goldsmith"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/9f0435eccef5e5fa1b709bc54c14a36f97e3d422", "committedDate": "2020-03-17T19:58:22Z", "message": "use string.format instead of concatenating strings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d3cacbdae78745d14221a53f891245842b9ebae", "author": {"user": {"login": "MikeGoldsmith", "name": "Mike Goldsmith"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/7d3cacbdae78745d14221a53f891245842b9ebae", "committedDate": "2020-03-17T20:05:21Z", "message": "add suppression to max span log message for line length"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2Mzg2MDQ1", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1021#pullrequestreview-376386045", "createdAt": "2020-03-17T20:36:48Z", "commit": {"oid": "7d3cacbdae78745d14221a53f891245842b9ebae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QyMDozNjo0OFrOF3tC_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QyMDozNjo0OFrOF3tC_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzk1NDA0NA==", "bodyText": "splitting the string across 2 lines is also totally fine.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1021#discussion_r393954044", "createdAt": "2020-03-17T20:36:48Z", "author": {"login": "jkwatson"}, "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/RecordEventsReadableSpan.java", "diffHunk": "@@ -50,6 +51,13 @@\n \n   private static final Logger logger = Logger.getLogger(Tracer.class.getName());\n \n+  @SuppressWarnings(\"checkstyle:LineLength\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d3cacbdae78745d14221a53f891245842b9ebae"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2Mzg2NTMw", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1021#pullrequestreview-376386530", "createdAt": "2020-03-17T20:37:33Z", "commit": {"oid": "7d3cacbdae78745d14221a53f891245842b9ebae"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3220, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}