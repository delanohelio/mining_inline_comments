{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3MDcwMDE2", "number": 2039, "title": "Add a way to enforce default context storage implementation", "bodyText": "closes #1818", "createdAt": "2020-11-07T03:31:53Z", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2039", "merged": true, "mergeCommit": {"oid": "33db03bc05199f55561b3367c3b5ab77efd94c71"}, "closed": true, "closedAt": "2020-11-10T19:09:30Z", "author": {"login": "dengliming"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdaDBPOAH2gAyNTE3MDcwMDE2OmU1ZTEyMjI4YTFmZTM5Zjk0MTJhZTVmYmJiZTlmYmU2YWU3NjVmODc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbNaElAH2gAyNTE3MDcwMDE2OjI4MzgxMTI4MzI2NDQ5YzE3YThlMzFiNDVhOGYxNmY2NDNkMGY5MzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e5e12228a1fe39f9412ae5fbbbe9fbe6ae765f87", "author": {"user": {"login": "dengliming", "name": null}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/e5e12228a1fe39f9412ae5fbbbe9fbe6ae765f87", "committedDate": "2020-11-07T03:30:20Z", "message": "Add a way to enforce default context storage implementation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NjM1OTA5", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2039#pullrequestreview-525635909", "createdAt": "2020-11-07T07:53:04Z", "commit": {"oid": "e5e12228a1fe39f9412ae5fbbbe9fbe6ae765f87"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwNzo1MzowNFrOHvGYVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QwNzo1MzowNFrOHvGYVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTE0OTY1Mg==", "bodyText": "Why a second system property? As discussed on the issue, a single one would be simpler.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2039#discussion_r519149652", "createdAt": "2020-11-07T07:53:04Z", "author": {"login": "Oberon00"}, "path": "context/src/main/java/io/opentelemetry/context/LazyStorage.java", "diffHunk": "@@ -83,6 +85,10 @@ static ContextStorage get() {\n \n   static ContextStorage createStorage(AtomicReference<Throwable> deferredStorageFailure) {\n     String providerClassName = System.getProperty(CONTEXT_STORAGE_PROVIDER_PROPERTY, \"\");\n+    boolean enforceDefault = Boolean.getBoolean(CONTEXT_STORAGE_PROVIDER_ENFORCE_DEFAULT_PROPERTY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5e12228a1fe39f9412ae5fbbbe9fbe6ae765f87"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b655b89821c9d85a2ea52232fcb40b9cc5ee4e5e", "author": {"user": {"login": "dengliming", "name": null}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/b655b89821c9d85a2ea52232fcb40b9cc5ee4e5e", "committedDate": "2020-11-07T08:13:33Z", "message": "Fix review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NzAyNDA2", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2039#pullrequestreview-525702406", "createdAt": "2020-11-08T03:57:07Z", "commit": {"oid": "b655b89821c9d85a2ea52232fcb40b9cc5ee4e5e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQwMzo1NzowN1rOHvMrNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQwMzo1NzowN1rOHvMrNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTI1Mjc5MQ==", "bodyText": "I don't think we can test this sort of behavior with other ones since the system property is only loaded once. Can you extract another testset for this case? I think context will be full of many test sets because of his global initialization logic :)", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2039#discussion_r519252791", "createdAt": "2020-11-08T03:57:07Z", "author": {"login": "anuraaga"}, "path": "context/src/test/java/io/opentelemetry/context/LazyStorageTest.java", "diffHunk": "@@ -76,6 +76,13 @@ public void set_storage_provider_property_matches_one_provides() throws Exceptio\n     }\n   }\n \n+  @Test\n+  public void enforce_default_thread_local_storage() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b655b89821c9d85a2ea52232fcb40b9cc5ee4e5e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19c7f4d7e245e47a97ccf7309eec70f12a573936", "author": {"user": {"login": "dengliming", "name": null}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/19c7f4d7e245e47a97ccf7309eec70f12a573936", "committedDate": "2020-11-08T04:16:04Z", "message": "Add testcase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3724e44c4f33d0070881e9b6a7e4bc8aabcd0f31", "author": {"user": {"login": "dengliming", "name": null}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/3724e44c4f33d0070881e9b6a7e4bc8aabcd0f31", "committedDate": "2020-11-08T07:15:08Z", "message": "Use junit_pioneer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1Nzg0NTI1", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2039#pullrequestreview-525784525", "createdAt": "2020-11-08T08:13:26Z", "commit": {"oid": "3724e44c4f33d0070881e9b6a7e4bc8aabcd0f31"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQwODoxMzoyNlrOHvOsbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQwODoxMzoyNlrOHvOsbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTI4NTg3MA==", "bodyText": "Just one last nit, if you can change the methods to be package-private, since junit5, that would be swell, not a required change though.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2039#discussion_r519285870", "createdAt": "2020-11-08T08:13:26Z", "author": {"login": "anuraaga"}, "path": "context/src/test/java/io/opentelemetry/context/LazyStorageTest.java", "diffHunk": "@@ -13,37 +13,36 @@\n import java.io.Writer;\n import java.net.URL;\n import java.util.concurrent.atomic.AtomicReference;\n-import org.junit.jupiter.api.AfterEach;\n import org.junit.jupiter.api.Test;\n+import org.junitpioneer.jupiter.ClearSystemProperty;\n+import org.junitpioneer.jupiter.SetSystemProperty;\n \n class LazyStorageTest {\n \n   private static final String CONTEXT_STORAGE_PROVIDER_PROPERTY =\n       \"io.opentelemetry.context.contextStorageProvider\";\n+  private static final String MOCK_CONTEXT_STORAGE_PROVIDER =\n+      \"io.opentelemetry.context.LazyStorageTest$MockContextStorageProvider\";\n   private static final AtomicReference<Throwable> DEFERRED_STORAGE_FAILURE =\n       new AtomicReference<>();\n \n-  @AfterEach\n-  public void after() {\n-    System.clearProperty(CONTEXT_STORAGE_PROVIDER_PROPERTY);\n-  }\n-\n   @Test\n-  public void empty_provides() {\n+  @ClearSystemProperty(key = CONTEXT_STORAGE_PROVIDER_PROPERTY)\n+  public void empty_providers() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3724e44c4f33d0070881e9b6a7e4bc8aabcd0f31"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ba446e4b33a709323abf05d13f92d96ad9bf811", "author": {"user": {"login": "dengliming", "name": null}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/1ba446e4b33a709323abf05d13f92d96ad9bf811", "committedDate": "2020-11-08T08:27:52Z", "message": "Change the methods to be package-private"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NDQxMzE5", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2039#pullrequestreview-526441319", "createdAt": "2020-11-09T16:40:00Z", "commit": {"oid": "1ba446e4b33a709323abf05d13f92d96ad9bf811"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNjo0MDowMFrOHv3YFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNjo0MDowMFrOHv3YFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk1MjQwNA==", "bodyText": "shouldn't we change the default value here to ENFORCE_DEFAULT_VALUE, rather than an empty String?", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2039#discussion_r519952404", "createdAt": "2020-11-09T16:40:00Z", "author": {"login": "jkwatson"}, "path": "context/src/main/java/io/opentelemetry/context/LazyStorage.java", "diffHunk": "@@ -83,6 +84,10 @@ static ContextStorage get() {\n \n   static ContextStorage createStorage(AtomicReference<Throwable> deferredStorageFailure) {\n     String providerClassName = System.getProperty(CONTEXT_STORAGE_PROVIDER_PROPERTY, \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ba446e4b33a709323abf05d13f92d96ad9bf811"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NDUyNDM0", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2039#pullrequestreview-526452434", "createdAt": "2020-11-09T16:48:57Z", "commit": {"oid": "1ba446e4b33a709323abf05d13f92d96ad9bf811"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNjo0ODo1N1rOHv34XA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNjo0ODo1N1rOHv34XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk2MDY2OA==", "bodyText": "How are we choosing between calling this method, vs. ContextStorage.defaultStorage() which return the same thing?", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2039#discussion_r519960668", "createdAt": "2020-11-09T16:48:57Z", "author": {"login": "jkwatson"}, "path": "context/src/main/java/io/opentelemetry/context/LazyStorage.java", "diffHunk": "@@ -83,6 +84,10 @@ static ContextStorage get() {\n \n   static ContextStorage createStorage(AtomicReference<Throwable> deferredStorageFailure) {\n     String providerClassName = System.getProperty(CONTEXT_STORAGE_PROVIDER_PROPERTY, \"\");\n+    // enforceDefault\n+    if (ENFORCE_DEFAULT_VALUE.equals(providerClassName)) {\n+      return DefaultContext.threadLocalStorage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ba446e4b33a709323abf05d13f92d96ad9bf811"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d65656dc22db62211e9dfb8a7d6e1df3e2b9cf03", "author": {"user": {"login": "dengliming", "name": null}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/d65656dc22db62211e9dfb8a7d6e1df3e2b9cf03", "committedDate": "2020-11-10T02:05:03Z", "message": "Add some comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e3cde5f9f2d473b8a1facb1dc63387eab6ff79e", "author": {"user": {"login": "dengliming", "name": null}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/0e3cde5f9f2d473b8a1facb1dc63387eab6ff79e", "committedDate": "2020-11-10T16:45:16Z", "message": "Remove DefaultContext.threadLocalStorage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NDYxMzI4", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2039#pullrequestreview-527461328", "createdAt": "2020-11-10T17:54:25Z", "commit": {"oid": "0e3cde5f9f2d473b8a1facb1dc63387eab6ff79e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NDY4MTA0", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2039#pullrequestreview-527468104", "createdAt": "2020-11-10T18:02:27Z", "commit": {"oid": "0e3cde5f9f2d473b8a1facb1dc63387eab6ff79e"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxODowMjoyN1rOHwo37g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxODowMjo1N1rOHwo48Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2MzM3NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private static final String ENFORCE_DEFAULT_VALUE = \"default\";\n          \n          \n            \n              private static final String ENFORCE_DEFAULT_STORAGE_VALUE = \"default\";", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2039#discussion_r520763374", "createdAt": "2020-11-10T18:02:27Z", "author": {"login": "Oberon00"}, "path": "context/src/main/java/io/opentelemetry/context/LazyStorage.java", "diffHunk": "@@ -65,6 +65,7 @@ static ContextStorage get() {\n \n   private static final String CONTEXT_STORAGE_PROVIDER_PROPERTY =\n       \"io.opentelemetry.context.contextStorageProvider\";\n+  private static final String ENFORCE_DEFAULT_VALUE = \"default\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e3cde5f9f2d473b8a1facb1dc63387eab6ff79e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc2MzYzMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                String providerClassName = System.getProperty(CONTEXT_STORAGE_PROVIDER_PROPERTY, \"\");\n          \n          \n            \n                final String providerClassName = System.getProperty(CONTEXT_STORAGE_PROVIDER_PROPERTY, \"\");", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2039#discussion_r520763633", "createdAt": "2020-11-10T18:02:57Z", "author": {"login": "Oberon00"}, "path": "context/src/main/java/io/opentelemetry/context/LazyStorage.java", "diffHunk": "@@ -82,7 +83,12 @@ static ContextStorage get() {\n   }\n \n   static ContextStorage createStorage(AtomicReference<Throwable> deferredStorageFailure) {\n+    // Get the specified SPI implementation first here\n     String providerClassName = System.getProperty(CONTEXT_STORAGE_PROVIDER_PROPERTY, \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e3cde5f9f2d473b8a1facb1dc63387eab6ff79e"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28381128326449c17a8e31b45a8f16f643d0f935", "author": {"user": {"login": "dengliming", "name": null}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/28381128326449c17a8e31b45a8f16f643d0f935", "committedDate": "2020-11-10T18:10:26Z", "message": "Fix review"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3992, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}