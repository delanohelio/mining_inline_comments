{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzMzkxMTg3", "number": 1707, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwNzoyMjo0N1rOEnuKhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwMzo1MTozNlrOEs2uGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMDg2Mjc2OnYy", "diffSide": "RIGHT", "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwNzoyMjo0N1rOHYecxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNTowOTo1M1rOHZCu9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyNjc1Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * <p>Note: if a null is returned, the TraceState will be reset to {@link\n          \n          \n            \n                 * <p>Note: if {@code null} is returned, the TraceState will be reset to {@link\n          \n      \n    \n    \n  \n\nOr I might remove this, this is not a nullable method so we don't want to indicate null is allowed. We just happen to have a default to prevent crashing in case that happens.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r495426757", "createdAt": "2020-09-26T07:22:47Z", "author": {"login": "anuraaga"}, "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java", "diffHunk": "@@ -88,5 +89,14 @@ SamplingResult shouldSample(\n      *     {@link Decision#RECORD_AND_SAMPLE}.\n      */\n     Attributes getAttributes();\n+\n+    /**\n+     * Return the {@link TraceState} that should be associated with the resulting Span. This may be\n+     * the same {@link TraceState} that was provided originally, or an updated one.\n+     *\n+     * <p>Note: if a null is returned, the TraceState will be reset to {@link", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f23245425e088292de52b8e05773359bcf9080bb"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NTA1OA==", "bodyText": "Indeed, should we require non-null return value?", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r495575058", "createdAt": "2020-09-27T13:49:23Z", "author": {"login": "iNikem"}, "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java", "diffHunk": "@@ -88,5 +89,14 @@ SamplingResult shouldSample(\n      *     {@link Decision#RECORD_AND_SAMPLE}.\n      */\n     Attributes getAttributes();\n+\n+    /**\n+     * Return the {@link TraceState} that should be associated with the resulting Span. This may be\n+     * the same {@link TraceState} that was provided originally, or an updated one.\n+     *\n+     * <p>Note: if a null is returned, the TraceState will be reset to {@link", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyNjc1Nw=="}, "originalCommit": {"oid": "f23245425e088292de52b8e05773359bcf9080bb"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYwNjM3MQ==", "bodyText": "The spec explicitly specifies the behavior for the null return, but I wouldn't have a problem making this non-nullable. It's easy enough for samplers to explicitly return TraceState.getInvalid() if that's what they want.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r495606371", "createdAt": "2020-09-27T19:26:39Z", "author": {"login": "jkwatson"}, "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java", "diffHunk": "@@ -88,5 +89,14 @@ SamplingResult shouldSample(\n      *     {@link Decision#RECORD_AND_SAMPLE}.\n      */\n     Attributes getAttributes();\n+\n+    /**\n+     * Return the {@link TraceState} that should be associated with the resulting Span. This may be\n+     * the same {@link TraceState} that was provided originally, or an updated one.\n+     *\n+     * <p>Note: if a null is returned, the TraceState will be reset to {@link", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyNjc1Nw=="}, "originalCommit": {"oid": "f23245425e088292de52b8e05773359bcf9080bb"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAyMTIzNg==", "bodyText": "Sorry..my comment above is wrong. I mis-read \"empty\" as \"null\" in the spec.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r496021236", "createdAt": "2020-09-28T15:09:53Z", "author": {"login": "jkwatson"}, "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java", "diffHunk": "@@ -88,5 +89,14 @@ SamplingResult shouldSample(\n      *     {@link Decision#RECORD_AND_SAMPLE}.\n      */\n     Attributes getAttributes();\n+\n+    /**\n+     * Return the {@link TraceState} that should be associated with the resulting Span. This may be\n+     * the same {@link TraceState} that was provided originally, or an updated one.\n+     *\n+     * <p>Note: if a null is returned, the TraceState will be reset to {@link", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQyNjc1Nw=="}, "originalCommit": {"oid": "f23245425e088292de52b8e05773359bcf9080bb"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMTAyMDcyOnYy", "diffSide": "RIGHT", "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Samplers.java", "isResolved": false, "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQxMTowNDo0MFrOHYfmPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxOTozOTozNlrOHZM6_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTU2Nw==", "bodyText": "If we use null (or some static final instance of TraceState) to indicate \"use parent tracestate\", we could keep the constant objects, conserving allocations.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r495445567", "createdAt": "2020-09-26T11:04:40Z", "author": {"login": "Oberon00"}, "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Samplers.java", "diffHunk": "@@ -96,19 +92,20 @@ public static SamplingResult samplingResult(Decision decision, Attributes attrib\n    *\n    * <p>This is meant for use by custom {@link Sampler} implementations.\n    *\n-   * <p>Use {@link #samplingResult(Decision, Attributes)} if you need attributes.\n+   * <p>Use {@link #samplingResult(Decision, Attributes, TraceState)} if you need attributes.\n    *\n    * @param decision The decision made on the span.\n+   * @param traceState The {@link TraceState} to use.\n    * @return A {@link SamplingResult} with empty attributes and the provided {@code decision}.\n    */\n-  public static SamplingResult emptySamplingResult(Decision decision) {\n+  public static SamplingResult emptySamplingResult(Decision decision, TraceState traceState) {\n     switch (decision) {\n       case RECORD_AND_SAMPLE:\n-        return EMPTY_RECORDED_AND_SAMPLED_SAMPLING_RESULT;\n+        return SamplingResultImpl.createWithoutAttributes(Decision.RECORD_AND_SAMPLE, traceState);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f23245425e088292de52b8e05773359bcf9080bb"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYwNjQzMw==", "bodyText": "yeah, but the spec describes the behavior for null, which is to invalidate the tracestate. :(", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r495606433", "createdAt": "2020-09-27T19:27:12Z", "author": {"login": "jkwatson"}, "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Samplers.java", "diffHunk": "@@ -96,19 +92,20 @@ public static SamplingResult samplingResult(Decision decision, Attributes attrib\n    *\n    * <p>This is meant for use by custom {@link Sampler} implementations.\n    *\n-   * <p>Use {@link #samplingResult(Decision, Attributes)} if you need attributes.\n+   * <p>Use {@link #samplingResult(Decision, Attributes, TraceState)} if you need attributes.\n    *\n    * @param decision The decision made on the span.\n+   * @param traceState The {@link TraceState} to use.\n    * @return A {@link SamplingResult} with empty attributes and the provided {@code decision}.\n    */\n-  public static SamplingResult emptySamplingResult(Decision decision) {\n+  public static SamplingResult emptySamplingResult(Decision decision, TraceState traceState) {\n     switch (decision) {\n       case RECORD_AND_SAMPLE:\n-        return EMPTY_RECORDED_AND_SAMPLED_SAMPLING_RESULT;\n+        return SamplingResultImpl.createWithoutAttributes(Decision.RECORD_AND_SAMPLE, traceState);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTU2Nw=="}, "originalCommit": {"oid": "f23245425e088292de52b8e05773359bcf9080bb"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYwNzU2Ng==", "bodyText": "OK, that was unintentional. But still, we could do private static final TraceState USE_PARENT = TraceState.builder.build()  and then check if the object identity of the contained tracestate == USE_PARENT.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r495607566", "createdAt": "2020-09-27T19:38:39Z", "author": {"login": "Oberon00"}, "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Samplers.java", "diffHunk": "@@ -96,19 +92,20 @@ public static SamplingResult samplingResult(Decision decision, Attributes attrib\n    *\n    * <p>This is meant for use by custom {@link Sampler} implementations.\n    *\n-   * <p>Use {@link #samplingResult(Decision, Attributes)} if you need attributes.\n+   * <p>Use {@link #samplingResult(Decision, Attributes, TraceState)} if you need attributes.\n    *\n    * @param decision The decision made on the span.\n+   * @param traceState The {@link TraceState} to use.\n    * @return A {@link SamplingResult} with empty attributes and the provided {@code decision}.\n    */\n-  public static SamplingResult emptySamplingResult(Decision decision) {\n+  public static SamplingResult emptySamplingResult(Decision decision, TraceState traceState) {\n     switch (decision) {\n       case RECORD_AND_SAMPLE:\n-        return EMPTY_RECORDED_AND_SAMPLED_SAMPLING_RESULT;\n+        return SamplingResultImpl.createWithoutAttributes(Decision.RECORD_AND_SAMPLE, traceState);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTU2Nw=="}, "originalCommit": {"oid": "f23245425e088292de52b8e05773359bcf9080bb"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcyOTU2MA==", "bodyText": "I think the spec doesn't say anything about a null tracestate here, only an empty one: https://github.com/open-telemetry/opentelemetry-specification/blob/master/specification/trace/sdk.md#shouldsample\n\n\nA Tracestate that will be associated with the Span through the new\nSpanContext.\nNote: If the sampler returns an empty Tracestate here, the Tracestate will be cleared,\nso samplers should normally return the passed-in Tracestate if they do not intend\nto change it.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r495729560", "createdAt": "2020-09-28T07:07:37Z", "author": {"login": "Oberon00"}, "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Samplers.java", "diffHunk": "@@ -96,19 +92,20 @@ public static SamplingResult samplingResult(Decision decision, Attributes attrib\n    *\n    * <p>This is meant for use by custom {@link Sampler} implementations.\n    *\n-   * <p>Use {@link #samplingResult(Decision, Attributes)} if you need attributes.\n+   * <p>Use {@link #samplingResult(Decision, Attributes, TraceState)} if you need attributes.\n    *\n    * @param decision The decision made on the span.\n+   * @param traceState The {@link TraceState} to use.\n    * @return A {@link SamplingResult} with empty attributes and the provided {@code decision}.\n    */\n-  public static SamplingResult emptySamplingResult(Decision decision) {\n+  public static SamplingResult emptySamplingResult(Decision decision, TraceState traceState) {\n     switch (decision) {\n       case RECORD_AND_SAMPLE:\n-        return EMPTY_RECORDED_AND_SAMPLED_SAMPLING_RESULT;\n+        return SamplingResultImpl.createWithoutAttributes(Decision.RECORD_AND_SAMPLE, traceState);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTU2Nw=="}, "originalCommit": {"oid": "f23245425e088292de52b8e05773359bcf9080bb"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjAxOTUyMQ==", "bodyText": "You're right. I read that wrong. But, I don't think using null as a signal to use the parent is a great API. I'd rather have an explicit way for Samplers to signal that, rather than an implicit null.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r496019521", "createdAt": "2020-09-28T15:08:21Z", "author": {"login": "jkwatson"}, "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Samplers.java", "diffHunk": "@@ -96,19 +92,20 @@ public static SamplingResult samplingResult(Decision decision, Attributes attrib\n    *\n    * <p>This is meant for use by custom {@link Sampler} implementations.\n    *\n-   * <p>Use {@link #samplingResult(Decision, Attributes)} if you need attributes.\n+   * <p>Use {@link #samplingResult(Decision, Attributes, TraceState)} if you need attributes.\n    *\n    * @param decision The decision made on the span.\n+   * @param traceState The {@link TraceState} to use.\n    * @return A {@link SamplingResult} with empty attributes and the provided {@code decision}.\n    */\n-  public static SamplingResult emptySamplingResult(Decision decision) {\n+  public static SamplingResult emptySamplingResult(Decision decision, TraceState traceState) {\n     switch (decision) {\n       case RECORD_AND_SAMPLE:\n-        return EMPTY_RECORDED_AND_SAMPLED_SAMPLING_RESULT;\n+        return SamplingResultImpl.createWithoutAttributes(Decision.RECORD_AND_SAMPLE, traceState);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTU2Nw=="}, "originalCommit": {"oid": "f23245425e088292de52b8e05773359bcf9080bb"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA1MTAyMg==", "bodyText": "Agreed, null isn't a great API here. So maybe the sentinel object instance I mentioned above?", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r496051022", "createdAt": "2020-09-28T15:43:19Z", "author": {"login": "Oberon00"}, "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Samplers.java", "diffHunk": "@@ -96,19 +92,20 @@ public static SamplingResult samplingResult(Decision decision, Attributes attrib\n    *\n    * <p>This is meant for use by custom {@link Sampler} implementations.\n    *\n-   * <p>Use {@link #samplingResult(Decision, Attributes)} if you need attributes.\n+   * <p>Use {@link #samplingResult(Decision, Attributes, TraceState)} if you need attributes.\n    *\n    * @param decision The decision made on the span.\n+   * @param traceState The {@link TraceState} to use.\n    * @return A {@link SamplingResult} with empty attributes and the provided {@code decision}.\n    */\n-  public static SamplingResult emptySamplingResult(Decision decision) {\n+  public static SamplingResult emptySamplingResult(Decision decision, TraceState traceState) {\n     switch (decision) {\n       case RECORD_AND_SAMPLE:\n-        return EMPTY_RECORDED_AND_SAMPLED_SAMPLING_RESULT;\n+        return SamplingResultImpl.createWithoutAttributes(Decision.RECORD_AND_SAMPLE, traceState);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTU2Nw=="}, "originalCommit": {"oid": "f23245425e088292de52b8e05773359bcf9080bb"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExMTgxNg==", "bodyText": "I'm not sure yet. My main concern is making sure that Sampler authors have a clear obvious way to do it. At the moment, the Sampler interface forces everyone to think about whether to modify the TraceState or not, and I think the most common use-case will be to not modify the TraceState, but just use the existing parent's.\n@Oberon00 do you think it's worth opening up a spec issue to make it easier to do the \"right thing\" in our SDK, or do you think the current spec is flexible enough to allow default-behavior to be implemented (using a sentinel value, or explicit boolean attribute)?", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r496111816", "createdAt": "2020-09-28T17:18:59Z", "author": {"login": "jkwatson"}, "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Samplers.java", "diffHunk": "@@ -96,19 +92,20 @@ public static SamplingResult samplingResult(Decision decision, Attributes attrib\n    *\n    * <p>This is meant for use by custom {@link Sampler} implementations.\n    *\n-   * <p>Use {@link #samplingResult(Decision, Attributes)} if you need attributes.\n+   * <p>Use {@link #samplingResult(Decision, Attributes, TraceState)} if you need attributes.\n    *\n    * @param decision The decision made on the span.\n+   * @param traceState The {@link TraceState} to use.\n    * @return A {@link SamplingResult} with empty attributes and the provided {@code decision}.\n    */\n-  public static SamplingResult emptySamplingResult(Decision decision) {\n+  public static SamplingResult emptySamplingResult(Decision decision, TraceState traceState) {\n     switch (decision) {\n       case RECORD_AND_SAMPLE:\n-        return EMPTY_RECORDED_AND_SAMPLED_SAMPLING_RESULT;\n+        return SamplingResultImpl.createWithoutAttributes(Decision.RECORD_AND_SAMPLE, traceState);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTU2Nw=="}, "originalCommit": {"oid": "f23245425e088292de52b8e05773359bcf9080bb"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE2MTY5OQ==", "bodyText": "I no one will complain that you violate the current spec if you make \"use parent\" the default somehow, but an editorial spec change / recommendation would make sense I think.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r496161699", "createdAt": "2020-09-28T18:48:44Z", "author": {"login": "Oberon00"}, "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Samplers.java", "diffHunk": "@@ -96,19 +92,20 @@ public static SamplingResult samplingResult(Decision decision, Attributes attrib\n    *\n    * <p>This is meant for use by custom {@link Sampler} implementations.\n    *\n-   * <p>Use {@link #samplingResult(Decision, Attributes)} if you need attributes.\n+   * <p>Use {@link #samplingResult(Decision, Attributes, TraceState)} if you need attributes.\n    *\n    * @param decision The decision made on the span.\n+   * @param traceState The {@link TraceState} to use.\n    * @return A {@link SamplingResult} with empty attributes and the provided {@code decision}.\n    */\n-  public static SamplingResult emptySamplingResult(Decision decision) {\n+  public static SamplingResult emptySamplingResult(Decision decision, TraceState traceState) {\n     switch (decision) {\n       case RECORD_AND_SAMPLE:\n-        return EMPTY_RECORDED_AND_SAMPLED_SAMPLING_RESULT;\n+        return SamplingResultImpl.createWithoutAttributes(Decision.RECORD_AND_SAMPLE, traceState);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTU2Nw=="}, "originalCommit": {"oid": "f23245425e088292de52b8e05773359bcf9080bb"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE4ODE1Ng==", "bodyText": "I decided to start with an issue:  open-telemetry/opentelemetry-specification#1031", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r496188156", "createdAt": "2020-09-28T19:39:36Z", "author": {"login": "jkwatson"}, "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Samplers.java", "diffHunk": "@@ -96,19 +92,20 @@ public static SamplingResult samplingResult(Decision decision, Attributes attrib\n    *\n    * <p>This is meant for use by custom {@link Sampler} implementations.\n    *\n-   * <p>Use {@link #samplingResult(Decision, Attributes)} if you need attributes.\n+   * <p>Use {@link #samplingResult(Decision, Attributes, TraceState)} if you need attributes.\n    *\n    * @param decision The decision made on the span.\n+   * @param traceState The {@link TraceState} to use.\n    * @return A {@link SamplingResult} with empty attributes and the provided {@code decision}.\n    */\n-  public static SamplingResult emptySamplingResult(Decision decision) {\n+  public static SamplingResult emptySamplingResult(Decision decision, TraceState traceState) {\n     switch (decision) {\n       case RECORD_AND_SAMPLE:\n-        return EMPTY_RECORDED_AND_SAMPLED_SAMPLING_RESULT;\n+        return SamplingResultImpl.createWithoutAttributes(Decision.RECORD_AND_SAMPLE, traceState);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQ0NTU2Nw=="}, "originalCommit": {"oid": "f23245425e088292de52b8e05773359bcf9080bb"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1MzIxNjQwOnYy", "diffSide": "RIGHT", "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNzoxMjowMlrOHgG2Xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMjo0NTo1NVrOHgPhMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyODcwMw==", "bodyText": "We could document here that this will always be the same instance as the one passed to ShouldSample before.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r503428703", "createdAt": "2020-10-12T17:12:02Z", "author": {"login": "Oberon00"}, "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java", "diffHunk": "@@ -77,5 +79,16 @@ SamplingResult shouldSample(\n      *     {@link Decision#RECORD_AND_SAMPLE}.\n      */\n     Attributes getAttributes();\n+\n+    /**\n+     * Return an optionally-updated {@link TraceState}, based on the parent TraceState. This may\n+     * return the same {@link TraceState} that was provided originally, or an updated one.\n+     *\n+     * @param parentTraceState The TraceState from any parent span. Might be an empty TraceState, if", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55224f011bae0f37cdd106f3864ad2a525239fb5"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU3MDczOA==", "bodyText": "good idea. done!", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r503570738", "createdAt": "2020-10-12T22:45:55Z", "author": {"login": "jkwatson"}, "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java", "diffHunk": "@@ -77,5 +79,16 @@ SamplingResult shouldSample(\n      *     {@link Decision#RECORD_AND_SAMPLE}.\n      */\n     Attributes getAttributes();\n+\n+    /**\n+     * Return an optionally-updated {@link TraceState}, based on the parent TraceState. This may\n+     * return the same {@link TraceState} that was provided originally, or an updated one.\n+     *\n+     * @param parentTraceState The TraceState from any parent span. Might be an empty TraceState, if", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyODcwMw=="}, "originalCommit": {"oid": "55224f011bae0f37cdd106f3864ad2a525239fb5"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1NDY5MzM2OnYy", "diffSide": "RIGHT", "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwMzo1MTozNlrOHgUcvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwNTo0NTo1MVrOHgWN_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY1MTUxOQ==", "bodyText": "Thanks sorry for missing the allocation issue, got it. TBH this API still feels weird to me - having to call the sampler, and then the caller has to correctly call this method to get the trace state.\nI'm reading the discussion here\n#1707 (comment)\nand I'm personally not sure this functional style is that much better than null indicating a non-update, in a caller\nspan.traceState = result.getUpdatedTraceState() != null ? result.getUpdatedTraceState() : parentTraceState;\n\nseems more direct? It's true that there's no updated trace state, so use the non-updated one.\nOtherwise, another approach that is similar to this one but seems a bit nicer is having this sort of method on the Sampler, accepting the decision with the parent trace state. \"update trace state\" is a business logic operation, it's nice if that lives in the Sampler which has the logic, a result feels like it should be mostly constant.\nFinally, maybe we can just live with an extra allocation if it seems like a normal getTraceState() seems like a more intuitive API. Sampling result is very short lived, it may even be optimized away who knows.\nFood for thought, I don't really have a strong preference for any, but a small preference for eating the allocation.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r503651519", "createdAt": "2020-10-13T03:51:36Z", "author": {"login": "anuraaga"}, "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java", "diffHunk": "@@ -77,5 +79,18 @@ SamplingResult shouldSample(\n      *     {@link Decision#RECORD_AND_SAMPLE}.\n      */\n     Attributes getAttributes();\n+\n+    /**\n+     * Return an optionally-updated {@link TraceState}, based on the parent TraceState. This may\n+     * return the same {@link TraceState} that was provided originally, or an updated one.\n+     *\n+     * @param parentTraceState The TraceState from the parent span. Might be an empty TraceState, if\n+     *     there is no parent. This will be the same TraceState that was passed in via the {@link\n+     *     SpanContext} parameter on the {@link #shouldSample(SpanContext, String, String, Kind,\n+     *     ReadableAttributes, List)} call.\n+     */\n+    default TraceState getUpdatedTraceState(TraceState parentTraceState) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28a37ea61b00be48a2baa7cb2978ab93deb57c61"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY2NzUxMQ==", "bodyText": "The other reason to avoid \"eating the allocation\" is that we really want to make it super easy for \"normal\" samplers to do the right thing (that is, not modify the TraceState). I really dislike using \"null\" as a meaningful business result, but if y'all prefer that as the API, then I can get on board. What if we had it return Optional<TraceState> so the \"normal\" samplers can just have a constant Optional.empty()?", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r503667511", "createdAt": "2020-10-13T04:59:27Z", "author": {"login": "jkwatson"}, "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java", "diffHunk": "@@ -77,5 +79,18 @@ SamplingResult shouldSample(\n      *     {@link Decision#RECORD_AND_SAMPLE}.\n      */\n     Attributes getAttributes();\n+\n+    /**\n+     * Return an optionally-updated {@link TraceState}, based on the parent TraceState. This may\n+     * return the same {@link TraceState} that was provided originally, or an updated one.\n+     *\n+     * @param parentTraceState The TraceState from the parent span. Might be an empty TraceState, if\n+     *     there is no parent. This will be the same TraceState that was passed in via the {@link\n+     *     SpanContext} parameter on the {@link #shouldSample(SpanContext, String, String, Kind,\n+     *     ReadableAttributes, List)} call.\n+     */\n+    default TraceState getUpdatedTraceState(TraceState parentTraceState) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY1MTUxOQ=="}, "originalCommit": {"oid": "28a37ea61b00be48a2baa7cb2978ab93deb57c61"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY4MDUwOQ==", "bodyText": "@anuraaga and I discussed offline and decided to stick with what we have right now; if someone actually uses this API and doesn't like how it works, we can definitely change it, since it's SDK-only functionality, and we can be a little more loose with making changes.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1707#discussion_r503680509", "createdAt": "2020-10-13T05:45:51Z", "author": {"login": "jkwatson"}, "path": "sdk/tracing/src/main/java/io/opentelemetry/sdk/trace/Sampler.java", "diffHunk": "@@ -77,5 +79,18 @@ SamplingResult shouldSample(\n      *     {@link Decision#RECORD_AND_SAMPLE}.\n      */\n     Attributes getAttributes();\n+\n+    /**\n+     * Return an optionally-updated {@link TraceState}, based on the parent TraceState. This may\n+     * return the same {@link TraceState} that was provided originally, or an updated one.\n+     *\n+     * @param parentTraceState The TraceState from the parent span. Might be an empty TraceState, if\n+     *     there is no parent. This will be the same TraceState that was passed in via the {@link\n+     *     SpanContext} parameter on the {@link #shouldSample(SpanContext, String, String, Kind,\n+     *     ReadableAttributes, List)} call.\n+     */\n+    default TraceState getUpdatedTraceState(TraceState parentTraceState) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY1MTUxOQ=="}, "originalCommit": {"oid": "28a37ea61b00be48a2baa7cb2978ab93deb57c61"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1231, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}