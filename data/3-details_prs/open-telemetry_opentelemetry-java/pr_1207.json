{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3MDA1Njkx", "number": 1207, "title": "Ensure the total number of attributes is counted correctly", "bodyText": "Fixes #1198", "createdAt": "2020-05-12T22:27:25Z", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1207", "merged": true, "mergeCommit": {"oid": "ba772a7a7fbbaea676fc1c89e7e16227417f6d2d"}, "closed": true, "closedAt": "2020-05-12T23:31:31Z", "author": {"login": "bogdandrutu"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgsBJWAFqTQxMDQ2NzQwMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgsw69gFqTQxMDQ4ODg3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNDY3NDAz", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1207#pullrequestreview-410467403", "createdAt": "2020-05-12T22:28:33Z", "commit": {"oid": "49b005d0db4a85619631772a158bb25eeb6c6188"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMjoyODozNFrOGUbLvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMjoyODozNFrOGUbLvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA3MDA3Ng==", "bodyText": "Added as public to override the newly added methods in java8, so when we do the switch and start using them we remember to fix them and count the number of attributes added.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1207#discussion_r424070076", "createdAt": "2020-05-12T22:28:34Z", "author": {"login": "bogdandrutu"}, "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/AttributesMap.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright 2019, OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.sdk.trace;\n+\n+import io.opentelemetry.common.AttributeValue;\n+import java.util.HashMap;\n+import java.util.Map;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * A map implementation with a fixed capacity that drops attributes when the map gets full.\n+ *\n+ * <p>Some APIs may have slightly different behaviors, like `put` which returns null if out of\n+ * capacity.\n+ */\n+final class AttributesMap extends HashMap<String, AttributeValue> {\n+\n+  private final long capacity;\n+  private int totalAddedValues = 0;\n+  // Here because -Werror complains about this: [serial] serializable class AttributesWithCapacity\n+  // has no definition of serialVersionUID. This class shouldn't be serialized.\n+  private static final long serialVersionUID = 42L;\n+\n+  AttributesMap(long capacity) {\n+    this.capacity = capacity;\n+  }\n+\n+  @Nullable\n+  @Override\n+  public AttributeValue put(String key, AttributeValue value) {\n+    totalAddedValues++;\n+    if (size() >= capacity && !containsKey(key)) {\n+      return null;\n+    }\n+    return super.put(key, value);\n+  }\n+\n+  @Override\n+  public void putAll(Map<? extends String, ? extends AttributeValue> values) {\n+    for (Map.Entry<? extends String, ? extends AttributeValue> entry : values.entrySet()) {\n+      put(entry.getKey(), entry.getValue());\n+    }\n+  }\n+\n+  @Nullable\n+  @Override\n+  public AttributeValue remove(Object key) {\n+    return super.remove(key);\n+  }\n+\n+  public AttributeValue putIfAbsent(String key, AttributeValue value) {\n+    throw new RuntimeException(\"Do not call methods on the map\");\n+  }\n+\n+  public AttributeValue replace(String key, AttributeValue value) {\n+    throw new RuntimeException(\"Do not call methods on the map\");\n+  }\n+\n+  public boolean replace(String key, AttributeValue oldValue, AttributeValue newValue) {\n+    throw new RuntimeException(\"Do not call methods on the map\");\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49b005d0db4a85619631772a158bb25eeb6c6188"}, "originalPosition": 75}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1632f379e79a7eaf67cccfa4143a94a2d3a5e771", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/1632f379e79a7eaf67cccfa4143a94a2d3a5e771", "committedDate": "2020-05-12T22:34:06Z", "message": "Ensure the total number of attributes is counted correctly\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "49b005d0db4a85619631772a158bb25eeb6c6188", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/49b005d0db4a85619631772a158bb25eeb6c6188", "committedDate": "2020-05-12T22:26:51Z", "message": "Ensure the total number of attributes is counted correctly\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}, "afterCommit": {"oid": "1632f379e79a7eaf67cccfa4143a94a2d3a5e771", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/1632f379e79a7eaf67cccfa4143a94a2d3a5e771", "committedDate": "2020-05-12T22:34:06Z", "message": "Ensure the total number of attributes is counted correctly\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNDg1NTA4", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1207#pullrequestreview-410485508", "createdAt": "2020-05-12T23:11:45Z", "commit": {"oid": "1632f379e79a7eaf67cccfa4143a94a2d3a5e771"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMzoxMTo0NVrOGUcHZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMzoxMTo0NVrOGUcHZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA4NTM0OQ==", "bodyText": "We should revisit this. Extending HashMap is a pretty bad antipattern in the Java world. I'd rather eat an allocation to wrap a Map and only provide the functionality that we want to expose, rather than having to deal with any arbitrary calls to our Map extension. But, that's beyond the scope of this PR.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1207#discussion_r424085349", "createdAt": "2020-05-12T23:11:45Z", "author": {"login": "jkwatson"}, "path": "sdk/src/main/java/io/opentelemetry/sdk/trace/AttributesMap.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Copyright 2019, OpenTelemetry Authors\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.opentelemetry.sdk.trace;\n+\n+import io.opentelemetry.common.AttributeValue;\n+import java.util.HashMap;\n+import java.util.Map;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * A map implementation with a fixed capacity that drops attributes when the map gets full.\n+ *\n+ * <p>Some APIs may have slightly different behaviors, like `put` which returns null if out of\n+ * capacity.\n+ */\n+final class AttributesMap extends HashMap<String, AttributeValue> {\n+\n+  private final long capacity;\n+  private int totalAddedValues = 0;\n+  // Here because -Werror complains about this: [serial] serializable class AttributesWithCapacity\n+  // has no definition of serialVersionUID. This class shouldn't be serialized.\n+  private static final long serialVersionUID = 42L;\n+\n+  AttributesMap(long capacity) {\n+    this.capacity = capacity;\n+  }\n+\n+  @Nullable\n+  @Override\n+  public AttributeValue put(String key, AttributeValue value) {\n+    totalAddedValues++;\n+    if (size() >= capacity && !containsKey(key)) {\n+      return null;\n+    }\n+    return super.put(key, value);\n+  }\n+\n+  @Override\n+  public void putAll(Map<? extends String, ? extends AttributeValue> values) {\n+    for (Map.Entry<? extends String, ? extends AttributeValue> entry : values.entrySet()) {\n+      put(entry.getKey(), entry.getValue());\n+    }\n+  }\n+\n+  @Nullable\n+  @Override\n+  public AttributeValue remove(Object key) {\n+    return super.remove(key);\n+  }\n+\n+  // Added as public to override the newly added methods in java8, so when we do the switch and\n+  // start using them we remember to fix them and count the number of attributes added.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1632f379e79a7eaf67cccfa4143a94a2d3a5e771"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNDg4ODc4", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/1207#pullrequestreview-410488878", "createdAt": "2020-05-12T23:20:55Z", "commit": {"oid": "1632f379e79a7eaf67cccfa4143a94a2d3a5e771"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2688, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}