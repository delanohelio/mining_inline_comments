{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0NDg0NTYy", "number": 2395, "title": "Rename Aggregator -> AggregatorHandle; AggregatorFactory -> Aggregator", "bodyText": "Left a TODO to move getInstance to the new Aggregator interface.\nSigned-off-by: Bogdan Drutu bogdandrutu@gmail.com", "createdAt": "2020-12-23T02:18:55Z", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2395", "merged": true, "mergeCommit": {"oid": "b1a22e03a6bd913d8091f1dd47dcef8780bf78a6"}, "closed": true, "closedAt": "2020-12-24T16:11:19Z", "author": {"login": "bogdandrutu"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdo1mddgBqjQxNDI0MTIxOTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdpV33AgBqjQxNDc3MTM1Njg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bb4d4c5251b934a8c1ae3f28b16ab86d5d971c0f", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/bb4d4c5251b934a8c1ae3f28b16ab86d5d971c0f", "committedDate": "2020-12-23T02:18:03Z", "message": "Rename Aggregator -> AggregatorHandle; AggregatorFactory -> Aggregator\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}, "afterCommit": {"oid": "e01e48dc67f6e700db41005e612afd85a6ed7c01", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/e01e48dc67f6e700db41005e612afd85a6ed7c01", "committedDate": "2020-12-23T02:21:01Z", "message": "Rename Aggregator -> AggregatorHandle; AggregatorFactory -> Aggregator\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e01e48dc67f6e700db41005e612afd85a6ed7c01", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/e01e48dc67f6e700db41005e612afd85a6ed7c01", "committedDate": "2020-12-23T02:21:01Z", "message": "Rename Aggregator -> AggregatorHandle; AggregatorFactory -> Aggregator\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}, "afterCommit": {"oid": "551b47f25fc01caf4dd7588b74da0c47310f63af", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/551b47f25fc01caf4dd7588b74da0c47310f63af", "committedDate": "2020-12-23T03:22:23Z", "message": "Rename Aggregator -> AggregatorHandle; AggregatorFactory -> Aggregator\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4MjIwMTcy", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2395#pullrequestreview-558220172", "createdAt": "2020-12-23T20:43:42Z", "commit": {"oid": "551b47f25fc01caf4dd7588b74da0c47310f63af"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QyMDo0Mzo0MlrOIK0xPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QyMDo0Mzo0MlrOIK0xPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODIyMTI0NA==", "bodyText": "This comment is no longer correct.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2395#discussion_r548221244", "createdAt": "2020-12-23T20:43:42Z", "author": {"login": "jkwatson"}, "path": "sdk/metrics/src/main/java/io/opentelemetry/sdk/metrics/aggregation/AggregationFactory.java", "diffHunk": "@@ -5,11 +5,11 @@\n \n package io.opentelemetry.sdk.metrics.aggregation;\n \n-import io.opentelemetry.sdk.metrics.aggregator.Aggregator;\n+import io.opentelemetry.sdk.metrics.aggregator.AggregatorHandle;\n import io.opentelemetry.sdk.metrics.common.InstrumentValueType;\n import javax.annotation.concurrent.Immutable;\n \n-/** Factory class for {@link Aggregator}. */\n+/** Factory class for {@link AggregatorHandle}. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "551b47f25fc01caf4dd7588b74da0c47310f63af"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4MjI1MTIy", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2395#pullrequestreview-558225122", "createdAt": "2020-12-23T20:56:22Z", "commit": {"oid": "551b47f25fc01caf4dd7588b74da0c47310f63af"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QyMDo1NjoyMlrOIK1VYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QyMDo1NjoyMlrOIK1VYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODIzMDQ5Nw==", "bodyText": "If we're ok with not testing the exact type returned by the createHandle method, we could make these handle implementations private.", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2395#discussion_r548230497", "createdAt": "2020-12-23T20:56:22Z", "author": {"login": "jkwatson"}, "path": "sdk/metrics/src/main/java/io/opentelemetry/sdk/metrics/aggregator/DoubleMinMaxSumCountAggregator.java", "diffHunk": "@@ -11,77 +11,85 @@\n import javax.annotation.concurrent.ThreadSafe;\n \n @ThreadSafe\n-public final class DoubleMinMaxSumCountAggregator extends Aggregator<MinMaxSumCountAccumulation> {\n-  private static final AggregatorFactory<MinMaxSumCountAccumulation> AGGREGATOR_FACTORY =\n-      new AggregatorFactory<MinMaxSumCountAccumulation>() {\n-        @Override\n-        public Aggregator<MinMaxSumCountAccumulation> getAggregator() {\n-          return new DoubleMinMaxSumCountAggregator();\n-        }\n+public final class DoubleMinMaxSumCountAggregator\n+    implements Aggregator<MinMaxSumCountAccumulation> {\n+  private static final DoubleMinMaxSumCountAggregator INSTANCE =\n+      new DoubleMinMaxSumCountAggregator();\n \n-        @Override\n-        public MinMaxSumCountAccumulation accumulateDouble(double value) {\n-          return MinMaxSumCountAccumulation.create(1, value, value, value);\n-        }\n-      };\n-\n-  private final ReentrantReadWriteLock lock = new ReentrantReadWriteLock();\n-  // The current value. This controls its own internal thread-safety via method access. Don't\n-  // try to use its fields directly.\n-  @GuardedBy(\"lock\")\n-  private final DoubleState current = new DoubleState();\n-\n-  public static AggregatorFactory<MinMaxSumCountAccumulation> getFactory() {\n-    return AGGREGATOR_FACTORY;\n+  /**\n+   * Returns the instance of this {@link Aggregator}.\n+   *\n+   * @return the instance of this {@link Aggregator}.\n+   */\n+  public static Aggregator<MinMaxSumCountAccumulation> getInstance() {\n+    return INSTANCE;\n   }\n \n   private DoubleMinMaxSumCountAggregator() {}\n \n   @Override\n-  protected MinMaxSumCountAccumulation doAccumulateThenReset() {\n-    lock.writeLock().lock();\n-    try {\n-      MinMaxSumCountAccumulation toReturn =\n-          MinMaxSumCountAccumulation.create(current.count, current.sum, current.min, current.max);\n-      current.reset();\n-      return toReturn;\n-    } finally {\n-      lock.writeLock().unlock();\n-    }\n+  public AggregatorHandle<MinMaxSumCountAccumulation> createHandle() {\n+    return new Handle();\n   }\n \n   @Override\n-  protected void doRecordDouble(double value) {\n-    lock.writeLock().lock();\n-    try {\n-      current.record(value);\n-    } finally {\n-      lock.writeLock().unlock();\n-    }\n+  public MinMaxSumCountAccumulation accumulateDouble(double value) {\n+    return MinMaxSumCountAccumulation.create(1, value, value, value);\n   }\n \n-  private static final class DoubleState {\n-    private long count;\n-    private double sum;\n-    private double min;\n-    private double max;\n+  static final class Handle extends AggregatorHandle<MinMaxSumCountAccumulation> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "551b47f25fc01caf4dd7588b74da0c47310f63af"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4MjI4MTg2", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2395#pullrequestreview-558228186", "createdAt": "2020-12-23T21:04:43Z", "commit": {"oid": "551b47f25fc01caf4dd7588b74da0c47310f63af"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4Mjc1Njg0", "url": "https://github.com/open-telemetry/opentelemetry-java/pull/2395#pullrequestreview-558275684", "createdAt": "2020-12-23T23:47:28Z", "commit": {"oid": "551b47f25fc01caf4dd7588b74da0c47310f63af"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "483723c7974fc7187c731849abaeb162d00425e8", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/483723c7974fc7187c731849abaeb162d00425e8", "committedDate": "2020-12-24T15:48:39Z", "message": "Rename Aggregator -> AggregatorHandle; AggregatorFactory -> Aggregator\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "551b47f25fc01caf4dd7588b74da0c47310f63af", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/551b47f25fc01caf4dd7588b74da0c47310f63af", "committedDate": "2020-12-23T03:22:23Z", "message": "Rename Aggregator -> AggregatorHandle; AggregatorFactory -> Aggregator\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}, "afterCommit": {"oid": "d01b845c2b682d1404719ecda6919d1e6ed26c93", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/d01b845c2b682d1404719ecda6919d1e6ed26c93", "committedDate": "2020-12-24T15:56:03Z", "message": "Update comments for Aggregator and AggregatorHandle\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7004e805b70f16094d53e70c0b2f312808fb755e", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/7004e805b70f16094d53e70c0b2f312808fb755e", "committedDate": "2020-12-24T15:57:00Z", "message": "Update comments for Aggregator and AggregatorHandle\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d01b845c2b682d1404719ecda6919d1e6ed26c93", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/d01b845c2b682d1404719ecda6919d1e6ed26c93", "committedDate": "2020-12-24T15:56:03Z", "message": "Update comments for Aggregator and AggregatorHandle\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}, "afterCommit": {"oid": "7004e805b70f16094d53e70c0b2f312808fb755e", "author": {"user": {"login": "bogdandrutu", "name": "Bogdan Drutu"}}, "url": "https://github.com/open-telemetry/opentelemetry-java/commit/7004e805b70f16094d53e70c0b2f312808fb755e", "committedDate": "2020-12-24T15:57:00Z", "message": "Update comments for Aggregator and AggregatorHandle\n\nSigned-off-by: Bogdan Drutu <bogdandrutu@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3543, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}