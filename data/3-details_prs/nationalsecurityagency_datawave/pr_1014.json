{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5Njg1MTIy", "number": 1014, "title": "fixes #1010 fix SpringCDIExtension applicationContext and serialization/deserialization of DatawavePrincipals", "bodyText": "SpringCDIExtension not properly initializing the ClassPathXmlApplicationContext -- must split the resource string on commas\nThis was noticed when a running QueryLogic reached a point in the DocumentTransformer where it was adding cardinality information and called Document.getTimestamp() whiched caused a metadata update and a reference to MarkingFunctions which had to be resolved through Weld/CDI/Spring and failed.\nCallerPrincipal and ServerPrincipal encode/decode isn't working\nAlso -- use an Apache Base64 class for encoding/decoding instead of infinispan", "createdAt": "2020-12-14T17:32:52Z", "url": "https://github.com/NationalSecurityAgency/datawave/pull/1014", "merged": true, "mergeCommit": {"oid": "b3332df2c0d4fd1049a43aa347630a527471bc76"}, "closed": true, "closedAt": "2020-12-17T20:25:29Z", "author": {"login": "billoley"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmJNj_gH2gAyNTM5Njg1MTIyOmYwZmQyODA4ZTI1ZDM1ZDRjNzE5N2JmZWY5MjY0ODJlMDNlYTRhZGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnIIESAFqTU1NDg5MDA2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f0fd2808e25d35d4c7197bfef926482e03ea4add", "author": {"user": {"login": "billoley", "name": "Bill Oley"}}, "url": "https://github.com/NationalSecurityAgency/datawave/commit/f0fd2808e25d35d4c7197bfef926482e03ea4add", "committedDate": "2020-12-14T17:30:19Z", "message": "fixes #1010 fix SpringCDIExtension applicationContext and serialization/deserialization of DatawavePrincipals\n\nAdditional changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxODI3MTM2", "url": "https://github.com/NationalSecurityAgency/datawave/pull/1014#pullrequestreview-551827136", "createdAt": "2020-12-14T19:33:20Z", "commit": {"oid": "f0fd2808e25d35d4c7197bfef926482e03ea4add"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOTozMzoyMVrOIFjCHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOTozMzoyMVrOIFjCHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY4Nzc3NQ==", "bodyText": "Does this allow us to remove the infinispan dependency from the POM?", "url": "https://github.com/NationalSecurityAgency/datawave/pull/1014#discussion_r542687775", "createdAt": "2020-12-14T19:33:21Z", "author": {"login": "keith-ratcliffe"}, "path": "web-services/map-reduce-embedded/src/main/java/datawave/security/system/EmbeddedCallerPrincipalProducer.java", "diffHunk": "@@ -7,7 +7,11 @@\n import javax.interceptor.Interceptor;\n \n import datawave.security.authorization.DatawavePrincipal;\n-import org.infinispan.commons.util.Base64;\n+import org.apache.commons.codec.binary.Base64;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0fd2808e25d35d4c7197bfef926482e03ea4add"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxODMwNDA3", "url": "https://github.com/NationalSecurityAgency/datawave/pull/1014#pullrequestreview-551830407", "createdAt": "2020-12-14T19:37:48Z", "commit": {"oid": "f0fd2808e25d35d4c7197bfef926482e03ea4add"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOTozNzo0OFrOIFjVKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxOTozNzo0OFrOIFjVKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjY5MjY0OA==", "bodyText": "Try-with-resources instead?", "url": "https://github.com/NationalSecurityAgency/datawave/pull/1014#discussion_r542692648", "createdAt": "2020-12-14T19:37:48Z", "author": {"login": "keith-ratcliffe"}, "path": "web-services/map-reduce-embedded/src/main/java/datawave/security/system/EmbeddedCallerPrincipalProducer.java", "diffHunk": "@@ -31,8 +35,21 @@ public DatawavePrincipal produceCallerPrincipal() {\n     \n     private void initializeCallerPrincipal() {\n         String encodedCallerPrincipal = System.getProperty(\"caller.principal\");\n-        if (encodedCallerPrincipal == null)\n-            throw new IllegalStateException(\"System property caller.principal must be set to a serialized, gzip'd, base64 encoded principal.\");\n-        callerPrincipal = (DatawavePrincipal) Base64.decodeToObject(encodedCallerPrincipal);\n+        if (encodedCallerPrincipal == null) {\n+            throw new IllegalStateException(\"System property caller.principal must be set to a serialized, base64 encoded principal.\");\n+        }\n+        ByteArrayInputStream bais = new ByteArrayInputStream(Base64.decodeBase64(encodedCallerPrincipal));\n+        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0fd2808e25d35d4c7197bfef926482e03ea4add"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37903032202801b312aecc161c171dc71090989a", "author": {"user": {"login": "billoley", "name": "Bill Oley"}}, "url": "https://github.com/NationalSecurityAgency/datawave/commit/37903032202801b312aecc161c171dc71090989a", "committedDate": "2020-12-15T14:15:45Z", "message": "Use try with resources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76e89802d352e83b244c00d279c36af55e5a0c11", "author": {"user": {"login": "billoley", "name": "Bill Oley"}}, "url": "https://github.com/NationalSecurityAgency/datawave/commit/76e89802d352e83b244c00d279c36af55e5a0c11", "committedDate": "2020-12-15T14:27:13Z", "message": "remove infinispan dependency from map-reduce-embedded pom"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNjExMzAy", "url": "https://github.com/NationalSecurityAgency/datawave/pull/1014#pullrequestreview-552611302", "createdAt": "2020-12-15T15:59:58Z", "commit": {"oid": "76e89802d352e83b244c00d279c36af55e5a0c11"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNTo1OTo1OFrOIGS2Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNTo1OTo1OFrOIGS2Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ3MTEzNA==", "bodyText": "try-with-resources, same as above? Sorry, thought I'd flagged this one already...guess not", "url": "https://github.com/NationalSecurityAgency/datawave/pull/1014#discussion_r543471134", "createdAt": "2020-12-15T15:59:58Z", "author": {"login": "keith-ratcliffe"}, "path": "web-services/map-reduce/src/main/java/datawave/webservice/mr/configuration/BulkResultsJobConfiguration.java", "diffHunk": "@@ -304,7 +306,21 @@ private void setupJob(Job job, Path jobDir, GenericQueryConfiguration queryConfi\n     }\n     \n     private String encodePrincipal(DatawavePrincipal principal) throws IOException {\n-        return Base64.encodeObject(principal, Base64.GZIP | Base64.DONT_BREAK_LINES);\n+        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        ObjectOutputStream oos = null;\n+        try {\n+            oos = new ObjectOutputStream(baos);\n+            // create a copy because this DatawavePrincipal might be CDI injected and have a reference to Weld\n+            oos.writeObject(new DatawavePrincipal(principal.getProxiedUsers(), principal.getCreationTime()));\n+            return Base64.encodeBase64String(baos.toByteArray());\n+        } finally {\n+            if (oos != null) {\n+                oos.close();\n+            }\n+            if (baos != null) {\n+                baos.close();\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76e89802d352e83b244c00d279c36af55e5a0c11"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNjEzODc3", "url": "https://github.com/NationalSecurityAgency/datawave/pull/1014#pullrequestreview-552613877", "createdAt": "2020-12-15T16:02:24Z", "commit": {"oid": "76e89802d352e83b244c00d279c36af55e5a0c11"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b60894a39d42b4e48d53e356cf6a1177521a259d", "author": {"user": {"login": "billoley", "name": "Bill Oley"}}, "url": "https://github.com/NationalSecurityAgency/datawave/commit/b60894a39d42b4e48d53e356cf6a1177521a259d", "committedDate": "2020-12-15T18:13:20Z", "message": "Use try with resources in another place"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0ODkwMDYy", "url": "https://github.com/NationalSecurityAgency/datawave/pull/1014#pullrequestreview-554890062", "createdAt": "2020-12-17T18:48:20Z", "commit": {"oid": "b60894a39d42b4e48d53e356cf6a1177521a259d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 960, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}