{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3MDI3NTI0", "number": 727, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNzoxMzozNVrODa9M5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNzoyNjoxNFrODa9dQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NTkyMjk1OnYy", "diffSide": "RIGHT", "path": "warehouse/query-core/src/main/java/datawave/core/iterators/DatawaveFieldIndexCachingIteratorJexl.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNzoxMzozNVrOFiKpSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNzo0NToxNVrOFiLo4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM3MDMxMw==", "bodyText": "fix comment", "url": "https://github.com/NationalSecurityAgency/datawave/pull/727#discussion_r371370313", "createdAt": "2020-01-27T17:13:35Z", "author": {"login": "ivakegg"}, "path": "warehouse/query-core/src/main/java/datawave/core/iterators/DatawaveFieldIndexCachingIteratorJexl.java", "diffHunk": "@@ -888,20 +902,38 @@ protected boolean isTimedOut() {\n     /**\n      * Get a source copy. If the source is setup as a ThreadLocalPooledSource, then no copy is needed.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60bcac19059905be53c0e28191773931a088ba7d"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM3MDUxNQ==", "bodyText": "perhaps add comment that this should only be used for the unsorted case", "url": "https://github.com/NationalSecurityAgency/datawave/pull/727#discussion_r371370515", "createdAt": "2020-01-27T17:13:56Z", "author": {"login": "ivakegg"}, "path": "warehouse/query-core/src/main/java/datawave/core/iterators/DatawaveFieldIndexCachingIteratorJexl.java", "diffHunk": "@@ -888,20 +902,38 @@ protected boolean isTimedOut() {\n     /**\n      * Get a source copy. If the source is setup as a ThreadLocalPooledSource, then no copy is needed.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM3MDMxMw=="}, "originalCommit": {"oid": "60bcac19059905be53c0e28191773931a088ba7d"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM4NjU5NQ==", "bodyText": "done.", "url": "https://github.com/NationalSecurityAgency/datawave/pull/727#discussion_r371386595", "createdAt": "2020-01-27T17:45:15Z", "author": {"login": "jwomeara"}, "path": "warehouse/query-core/src/main/java/datawave/core/iterators/DatawaveFieldIndexCachingIteratorJexl.java", "diffHunk": "@@ -888,20 +902,38 @@ protected boolean isTimedOut() {\n     /**\n      * Get a source copy. If the source is setup as a ThreadLocalPooledSource, then no copy is needed.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM3MDMxMw=="}, "originalCommit": {"oid": "60bcac19059905be53c0e28191773931a088ba7d"}, "originalPosition": 102}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NTkzNzg5OnYy", "diffSide": "LEFT", "path": "warehouse/query-core/src/main/java/datawave/query/iterator/QueryIterator.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNzoxODowN1rOFiKyXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNzo0NDoyNlrOFiLnVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM3MjYzNg==", "bodyText": "Does the QueryIterator still need to implement SourceFactory after these changes?", "url": "https://github.com/NationalSecurityAgency/datawave/pull/727#discussion_r371372636", "createdAt": "2020-01-27T17:18:07Z", "author": {"login": "ivakegg"}, "path": "warehouse/query-core/src/main/java/datawave/query/iterator/QueryIterator.java", "diffHunk": "@@ -1328,7 +1329,8 @@ protected IteratorBuildingVisitor createIteratorBuildingVisitor(Class<? extends\n                         .setIvaratorCacheBufferSize(this.getIvaratorCacheBufferSize())\n                         .setIvaratorCacheScanPersistThreshold(this.getIvaratorCacheScanPersistThreshold())\n                         .setIvaratorCacheScanTimeout(this.getIvaratorCacheScanTimeout()).setMaxRangeSplit(this.getMaxIndexRangeSplit())\n-                        .setIvaratorMaxOpenFiles(this.getIvaratorMaxOpenFiles()).setIvaratorSources(this, this.getMaxIvaratorSources())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60bcac19059905be53c0e28191773931a088ba7d"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM4NjE5OQ==", "bodyText": "Yes, because it is used by the SourceManager which determines how many non-ivarator iterators can be made.", "url": "https://github.com/NationalSecurityAgency/datawave/pull/727#discussion_r371386199", "createdAt": "2020-01-27T17:44:26Z", "author": {"login": "jwomeara"}, "path": "warehouse/query-core/src/main/java/datawave/query/iterator/QueryIterator.java", "diffHunk": "@@ -1328,7 +1329,8 @@ protected IteratorBuildingVisitor createIteratorBuildingVisitor(Class<? extends\n                         .setIvaratorCacheBufferSize(this.getIvaratorCacheBufferSize())\n                         .setIvaratorCacheScanPersistThreshold(this.getIvaratorCacheScanPersistThreshold())\n                         .setIvaratorCacheScanTimeout(this.getIvaratorCacheScanTimeout()).setMaxRangeSplit(this.getMaxIndexRangeSplit())\n-                        .setIvaratorMaxOpenFiles(this.getIvaratorMaxOpenFiles()).setIvaratorSources(this, this.getMaxIvaratorSources())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM3MjYzNg=="}, "originalCommit": {"oid": "60bcac19059905be53c0e28191773931a088ba7d"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NTk0MTgyOnYy", "diffSide": "RIGHT", "path": "warehouse/query-core/src/main/java/datawave/query/iterator/QueryIterator.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNzoxOToyMFrOFiK00Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNzo0Njo1MFrOFiLsLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM3MzI2NQ==", "bodyText": "maybe setIvaratorSource should be setUnsortedIvaratorSource", "url": "https://github.com/NationalSecurityAgency/datawave/pull/727#discussion_r371373265", "createdAt": "2020-01-27T17:19:20Z", "author": {"login": "ivakegg"}, "path": "warehouse/query-core/src/main/java/datawave/query/iterator/QueryIterator.java", "diffHunk": "@@ -1328,7 +1329,8 @@ protected IteratorBuildingVisitor createIteratorBuildingVisitor(Class<? extends\n                         .setIvaratorCacheBufferSize(this.getIvaratorCacheBufferSize())\n                         .setIvaratorCacheScanPersistThreshold(this.getIvaratorCacheScanPersistThreshold())\n                         .setIvaratorCacheScanTimeout(this.getIvaratorCacheScanTimeout()).setMaxRangeSplit(this.getMaxIndexRangeSplit())\n-                        .setIvaratorMaxOpenFiles(this.getIvaratorMaxOpenFiles()).setIvaratorSources(this, this.getMaxIvaratorSources())\n+                        .setIvaratorMaxOpenFiles(this.getIvaratorMaxOpenFiles()).setIvaratorSource(this.sourceForDeepCopies)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60bcac19059905be53c0e28191773931a088ba7d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM4NzQzNg==", "bodyText": "sure.  done.", "url": "https://github.com/NationalSecurityAgency/datawave/pull/727#discussion_r371387436", "createdAt": "2020-01-27T17:46:50Z", "author": {"login": "jwomeara"}, "path": "warehouse/query-core/src/main/java/datawave/query/iterator/QueryIterator.java", "diffHunk": "@@ -1328,7 +1329,8 @@ protected IteratorBuildingVisitor createIteratorBuildingVisitor(Class<? extends\n                         .setIvaratorCacheBufferSize(this.getIvaratorCacheBufferSize())\n                         .setIvaratorCacheScanPersistThreshold(this.getIvaratorCacheScanPersistThreshold())\n                         .setIvaratorCacheScanTimeout(this.getIvaratorCacheScanTimeout()).setMaxRangeSplit(this.getMaxIndexRangeSplit())\n-                        .setIvaratorMaxOpenFiles(this.getIvaratorMaxOpenFiles()).setIvaratorSources(this, this.getMaxIvaratorSources())\n+                        .setIvaratorMaxOpenFiles(this.getIvaratorMaxOpenFiles()).setIvaratorSource(this.sourceForDeepCopies)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM3MzI2NQ=="}, "originalCommit": {"oid": "60bcac19059905be53c0e28191773931a088ba7d"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NTk0NjQxOnYy", "diffSide": "RIGHT", "path": "warehouse/query-core/src/main/java/datawave/query/iterator/QueryIterator.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNzoyMDo0MVrOFiK3og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxOTozNDo1MFrOFiO5Pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM3Mzk4Ng==", "bodyText": "does this deepCopy do the opening of the RFiles, or is that lazy and not done until the first seek?  Just curious if we need to create these lazily.", "url": "https://github.com/NationalSecurityAgency/datawave/pull/727#discussion_r371373986", "createdAt": "2020-01-27T17:20:41Z", "author": {"login": "ivakegg"}, "path": "warehouse/query-core/src/main/java/datawave/query/iterator/QueryIterator.java", "diffHunk": "@@ -1337,6 +1339,14 @@ protected IteratorBuildingVisitor createIteratorBuildingVisitor(Class<? extends\n         // TODO: .setStatsPort(this.statsdHostAndPort);\n     }\n     \n+    protected ArrayBlockingQueue<SortedKeyValueIterator<Key,Value>> createIvaratorSourcePool(SortedKeyValueIterator<Key,Value> sourceForDeepCopies,\n+                    int maxIvaratorSources, IteratorEnvironment env) {\n+        ArrayBlockingQueue<SortedKeyValueIterator<Key,Value>> ivaratorSourcePool = new ArrayBlockingQueue<>(maxIvaratorSources, true);\n+        for (int i = 0; i < maxIvaratorSources; i++)\n+            ivaratorSourcePool.add(sourceForDeepCopies.deepCopy(env));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60bcac19059905be53c0e28191773931a088ba7d"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQzOTkzNA==", "bodyText": "Now you've done it...  Fix coming soon...", "url": "https://github.com/NationalSecurityAgency/datawave/pull/727#discussion_r371439934", "createdAt": "2020-01-27T19:34:50Z", "author": {"login": "jwomeara"}, "path": "warehouse/query-core/src/main/java/datawave/query/iterator/QueryIterator.java", "diffHunk": "@@ -1337,6 +1339,14 @@ protected IteratorBuildingVisitor createIteratorBuildingVisitor(Class<? extends\n         // TODO: .setStatsPort(this.statsdHostAndPort);\n     }\n     \n+    protected ArrayBlockingQueue<SortedKeyValueIterator<Key,Value>> createIvaratorSourcePool(SortedKeyValueIterator<Key,Value> sourceForDeepCopies,\n+                    int maxIvaratorSources, IteratorEnvironment env) {\n+        ArrayBlockingQueue<SortedKeyValueIterator<Key,Value>> ivaratorSourcePool = new ArrayBlockingQueue<>(maxIvaratorSources, true);\n+        for (int i = 0; i < maxIvaratorSources; i++)\n+            ivaratorSourcePool.add(sourceForDeepCopies.deepCopy(env));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM3Mzk4Ng=="}, "originalCommit": {"oid": "60bcac19059905be53c0e28191773931a088ba7d"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NTk2NDgxOnYy", "diffSide": "RIGHT", "path": "warehouse/query-core/src/main/java/datawave/query/jexl/visitors/PushdownLargeFieldedListsVisitor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNzoyNjoxNFrOFiLDKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxOTozNToxNVrOFiO5_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM3NjkzNg==", "bodyText": "I think the fst check needs to be first the way we were doing before.  If we are favoring the fst too much then the fst threshold needs to be set larger.", "url": "https://github.com/NationalSecurityAgency/datawave/pull/727#discussion_r371376936", "createdAt": "2020-01-27T17:26:14Z", "author": {"login": "ivakegg"}, "path": "warehouse/query-core/src/main/java/datawave/query/jexl/visitors/PushdownLargeFieldedListsVisitor.java", "diffHunk": "@@ -127,14 +127,14 @@ public Object visit(ASTOrNode node, Object data) {\n                 List<JexlNode> markers = new ArrayList<>();\n                 \n                 try {\n-                    // if we have an hdfs cache directory and if past the fst threshold, then create the fst and replace the list with an assignment\n-                    if (fstHdfsUri != null && (eqNodes.size() >= config.getMaxOrExpansionFstThreshold())) {\n+                    // if we have an hdfs cache directory and if past the fst/list threshold, then create the fst/list and replace the list with an assignment\n+                    if (eqNodes.size() >= config.getMaxOrExpansionThreshold()) {\n+                        markers.add(ExceededOrThresholdMarkerJexlNode.createFromValues(field, values));\n+                        eqNodes = null;\n+                    } else if (fstHdfsUri != null && (eqNodes.size() >= config.getMaxOrExpansionFstThreshold())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60bcac19059905be53c0e28191773931a088ba7d"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ0MDEyNw==", "bodyText": "i suppose you're right.  fixed.", "url": "https://github.com/NationalSecurityAgency/datawave/pull/727#discussion_r371440127", "createdAt": "2020-01-27T19:35:15Z", "author": {"login": "jwomeara"}, "path": "warehouse/query-core/src/main/java/datawave/query/jexl/visitors/PushdownLargeFieldedListsVisitor.java", "diffHunk": "@@ -127,14 +127,14 @@ public Object visit(ASTOrNode node, Object data) {\n                 List<JexlNode> markers = new ArrayList<>();\n                 \n                 try {\n-                    // if we have an hdfs cache directory and if past the fst threshold, then create the fst and replace the list with an assignment\n-                    if (fstHdfsUri != null && (eqNodes.size() >= config.getMaxOrExpansionFstThreshold())) {\n+                    // if we have an hdfs cache directory and if past the fst/list threshold, then create the fst/list and replace the list with an assignment\n+                    if (eqNodes.size() >= config.getMaxOrExpansionThreshold()) {\n+                        markers.add(ExceededOrThresholdMarkerJexlNode.createFromValues(field, values));\n+                        eqNodes = null;\n+                    } else if (fstHdfsUri != null && (eqNodes.size() >= config.getMaxOrExpansionFstThreshold())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM3NjkzNg=="}, "originalCommit": {"oid": "60bcac19059905be53c0e28191773931a088ba7d"}, "originalPosition": 10}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4481, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}