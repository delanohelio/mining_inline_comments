{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExODM2NDQx", "number": 814, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwOTo0Mzo1OFrOD4VCLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwOTo1ODozM1rOD4VMUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMzkxNDcxOnYy", "diffSide": "RIGHT", "path": "warehouse/query-core/src/main/java/datawave/query/util/sortedset/FileSortedSet.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwOTo0Mzo1OFrOGPGDTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNTowMzo1M1rOGPMKdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ4MDk3NA==", "bodyText": "Should the number of objects to verify be configurable? Not in this pr, but as a general comment.", "url": "https://github.com/NationalSecurityAgency/datawave/pull/814#discussion_r418480974", "createdAt": "2020-05-01T09:43:58Z", "author": {"login": "apmoriarty"}, "path": "warehouse/query-core/src/main/java/datawave/query/util/sortedset/FileSortedSet.java", "diffHunk": "@@ -201,12 +215,12 @@ private void persist(SortedSet<E> set, SortedSetFileHandler handler) throws IOEx\n                 throw new IOException(\"Failed to verify file existence\");\n             }\n             // now verify the first 100 objects were written correctly", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e5aff73683668122a216d322f6e3142af8c6552"}, "originalPosition": 201}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU4MTEwOQ==", "bodyText": "I could add that in here.... not too hard to parameterize.", "url": "https://github.com/NationalSecurityAgency/datawave/pull/814#discussion_r418581109", "createdAt": "2020-05-01T15:03:53Z", "author": {"login": "ivakegg"}, "path": "warehouse/query-core/src/main/java/datawave/query/util/sortedset/FileSortedSet.java", "diffHunk": "@@ -201,12 +215,12 @@ private void persist(SortedSet<E> set, SortedSetFileHandler handler) throws IOEx\n                 throw new IOException(\"Failed to verify file existence\");\n             }\n             // now verify the first 100 objects were written correctly", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ4MDk3NA=="}, "originalCommit": {"oid": "3e5aff73683668122a216d322f6e3142af8c6552"}, "originalPosition": 201}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMzkyMzExOnYy", "diffSide": "RIGHT", "path": "warehouse/query-core/src/main/java/datawave/query/util/sortedset/FileSortedSet.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwOTo0ODo0MlrOGPGIRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNTowNDowOFrOGPMLBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ4MjI0NA==", "bodyText": "Are we sure we want to double the length of the array? ArrayList resizes with (size + size/2).", "url": "https://github.com/NationalSecurityAgency/datawave/pull/814#discussion_r418482244", "createdAt": "2020-05-01T09:48:42Z", "author": {"login": "apmoriarty"}, "path": "warehouse/query-core/src/main/java/datawave/query/util/sortedset/FileSortedSet.java", "diffHunk": "@@ -414,28 +404,32 @@ public boolean contains(Object o) {\n     public <T> T[] toArray(T[] a) {\n         if (persisted) {\n             try {\n-                int size = readSize();\n-                InputStream stream = getInputStream();\n+                SortedSetInputStream<E> stream = getBoundedFileHandler().getInputStream(getStart(), getEnd());\n                 try {\n-                    T[] dest = a;\n-                    int i = 0;\n-                    for (; i < size; i++) {\n-                        T obj = (T) readObject(stream);\n-                        if (dest.length <= i) {\n-                            T[] newDest = (T[]) (Array.newInstance(a.getClass().getComponentType(), size));\n-                            System.arraycopy(dest, 0, newDest, 0, i);\n-                            dest = newDest;\n+                    T[] data = a;\n+                    int index = 0;\n+                    T obj = (T) stream.readObject();\n+                    while (obj != null) {\n+                        if (index > data.length) {\n+                            T[] dataCpy = (T[]) (Array.newInstance(a.getClass().getComponentType(), data.length * 2));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e5aff73683668122a216d322f6e3142af8c6552"}, "originalPosition": 371}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU4MTI1NA==", "bodyText": "I agree.  Will do.", "url": "https://github.com/NationalSecurityAgency/datawave/pull/814#discussion_r418581254", "createdAt": "2020-05-01T15:04:08Z", "author": {"login": "ivakegg"}, "path": "warehouse/query-core/src/main/java/datawave/query/util/sortedset/FileSortedSet.java", "diffHunk": "@@ -414,28 +404,32 @@ public boolean contains(Object o) {\n     public <T> T[] toArray(T[] a) {\n         if (persisted) {\n             try {\n-                int size = readSize();\n-                InputStream stream = getInputStream();\n+                SortedSetInputStream<E> stream = getBoundedFileHandler().getInputStream(getStart(), getEnd());\n                 try {\n-                    T[] dest = a;\n-                    int i = 0;\n-                    for (; i < size; i++) {\n-                        T obj = (T) readObject(stream);\n-                        if (dest.length <= i) {\n-                            T[] newDest = (T[]) (Array.newInstance(a.getClass().getComponentType(), size));\n-                            System.arraycopy(dest, 0, newDest, 0, i);\n-                            dest = newDest;\n+                    T[] data = a;\n+                    int index = 0;\n+                    T obj = (T) stream.readObject();\n+                    while (obj != null) {\n+                        if (index > data.length) {\n+                            T[] dataCpy = (T[]) (Array.newInstance(a.getClass().getComponentType(), data.length * 2));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ4MjI0NA=="}, "originalCommit": {"oid": "3e5aff73683668122a216d322f6e3142af8c6552"}, "originalPosition": 371}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMzkzNjY1OnYy", "diffSide": "RIGHT", "path": "warehouse/query-core/src/main/java/datawave/query/util/sortedset/FileSortedSet.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwOTo1NTo1NlrOGPGQbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNTowNDoxOVrOGPMLTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ4NDMzMg==", "bodyText": "There's an opportunity for a try-with-resources block here", "url": "https://github.com/NationalSecurityAgency/datawave/pull/814#discussion_r418484332", "createdAt": "2020-05-01T09:55:56Z", "author": {"login": "apmoriarty"}, "path": "warehouse/query-core/src/main/java/datawave/query/util/sortedset/FileSortedSet.java", "diffHunk": "@@ -610,13 +586,15 @@ public E last() {\n         E last = null;\n         if (persisted) {\n             try {\n-                int size = readSize();\n-                InputStream stream = getInputStream();\n+                SortedSetInputStream<E> stream = getBoundedFileHandler().getInputStream(getStart(), getEnd());\n                 try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e5aff73683668122a216d322f6e3142af8c6552"}, "originalPosition": 479}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU4MTMyNQ==", "bodyText": "ok", "url": "https://github.com/NationalSecurityAgency/datawave/pull/814#discussion_r418581325", "createdAt": "2020-05-01T15:04:19Z", "author": {"login": "ivakegg"}, "path": "warehouse/query-core/src/main/java/datawave/query/util/sortedset/FileSortedSet.java", "diffHunk": "@@ -610,13 +586,15 @@ public E last() {\n         E last = null;\n         if (persisted) {\n             try {\n-                int size = readSize();\n-                InputStream stream = getInputStream();\n+                SortedSetInputStream<E> stream = getBoundedFileHandler().getInputStream(getStart(), getEnd());\n                 try {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ4NDMzMg=="}, "originalCommit": {"oid": "3e5aff73683668122a216d322f6e3142af8c6552"}, "originalPosition": 479}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwMzk0MDY2OnYy", "diffSide": "RIGHT", "path": "warehouse/query-core/src/main/java/datawave/query/util/sortedset/MultiSetBackedSortedSet.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwOTo1ODozM1rOGPGS2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNTowNDozM1rOGPMLrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ4NDk1NA==", "bodyText": "Remove commented code", "url": "https://github.com/NationalSecurityAgency/datawave/pull/814#discussion_r418484954", "createdAt": "2020-05-01T09:58:33Z", "author": {"login": "apmoriarty"}, "path": "warehouse/query-core/src/main/java/datawave/query/util/sortedset/MultiSetBackedSortedSet.java", "diffHunk": "@@ -152,13 +155,16 @@ public E first() {\n     public E last() {\n         SortedSet<E> lastSet = new TreeSet<>(comparator());\n         for (SortedSet<E> set : sets) {\n-            lastSet.add(set.last());\n+            E s = set.last();\n+            if (s != null) {\n+                lastSet.add(s);\n+            }\n         }\n         return lastSet.last();\n     }\n     \n-    @Override\n-    public String toString() {\n-        return sets.toString();\n-    }\n+    // @Override", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e5aff73683668122a216d322f6e3142af8c6552"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU4MTQyMg==", "bodyText": "oops, forgot about that one.  Thanks.", "url": "https://github.com/NationalSecurityAgency/datawave/pull/814#discussion_r418581422", "createdAt": "2020-05-01T15:04:33Z", "author": {"login": "ivakegg"}, "path": "warehouse/query-core/src/main/java/datawave/query/util/sortedset/MultiSetBackedSortedSet.java", "diffHunk": "@@ -152,13 +155,16 @@ public E first() {\n     public E last() {\n         SortedSet<E> lastSet = new TreeSet<>(comparator());\n         for (SortedSet<E> set : sets) {\n-            lastSet.add(set.last());\n+            E s = set.last();\n+            if (s != null) {\n+                lastSet.add(s);\n+            }\n         }\n         return lastSet.last();\n     }\n     \n-    @Override\n-    public String toString() {\n-        return sets.toString();\n-    }\n+    // @Override", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ4NDk1NA=="}, "originalCommit": {"oid": "3e5aff73683668122a216d322f6e3142af8c6552"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4380, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}