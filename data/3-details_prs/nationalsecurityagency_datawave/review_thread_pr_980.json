{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMTEyMjk1", "number": 980, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxODoyNDoxMVrOEz6XMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMzo0MToyM1rOE3OxrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyODY5MDQzOnYy", "diffSide": "RIGHT", "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxODoyNDoxMVrOHrbS0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxOToyMjo0NFrOHrc-Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5ODAwMw==", "bodyText": "Why not put this before the while loop and avoid the firstRun flag altogether?", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r515298003", "createdAt": "2020-10-30T18:24:11Z", "author": {"login": "ivakegg"}, "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "diffHunk": "@@ -433,9 +434,16 @@ public void run() {\n         int fsAccessFailures = 0;\n         Path[] jobDirectories = new Path[0];\n         int nextJobIndex = 0;\n+        boolean firstRun = true;\n+        \n         try {\n             while (true) {\n                 try {\n+                    if (firstRun) {\n+                        \n+                        cleanJobDirectoriesOnStartup();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ea057db3db7f65f67a9a62225cb01269ffa5dea"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMyNTQ5NA==", "bodyText": "Why not, indeed.", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r515325494", "createdAt": "2020-10-30T19:22:44Z", "author": {"login": "hlgp"}, "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "diffHunk": "@@ -433,9 +434,16 @@ public void run() {\n         int fsAccessFailures = 0;\n         Path[] jobDirectories = new Path[0];\n         int nextJobIndex = 0;\n+        boolean firstRun = true;\n+        \n         try {\n             while (true) {\n                 try {\n+                    if (firstRun) {\n+                        \n+                        cleanJobDirectoriesOnStartup();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5ODAwMw=="}, "originalCommit": {"oid": "6ea057db3db7f65f67a9a62225cb01269ffa5dea"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyODY5ODEyOnYy", "diffSide": "RIGHT", "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxODoyNjo0NFrOHrbXwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMDoyMToxNFrOHre3-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5OTI2Ng==", "bodyText": "I realize that the markSourceFilesLoaded can supposedly be run by multiple instances concurrently, but how about the runCleanUpScript?  Since that is being passed in, I am thinking this could be a problem.", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r515299266", "createdAt": "2020-10-30T18:26:44Z", "author": {"login": "ivakegg"}, "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "diffHunk": "@@ -534,6 +542,18 @@ public void run() {\n         log.info(\"Bulk map file loader shutting down.\");\n     }\n     \n+    protected void cleanJobDirectoriesOnStartup() throws IOException {\n+        Path[] cleanupDirectories = getJobDirectories(new Path(workDir, jobDirPattern + '/' + CLEANUP_FILE_MARKER));\n+        for (int i = 0; i < cleanupDirectories.length; i++) {\n+            \n+            markSourceFilesLoaded(cleanupDirectories[i]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ea057db3db7f65f67a9a62225cb01269ffa5dea"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM1NjY2Ng==", "bodyText": "We don't actually use this script option anywhere.  Might be an artifact from a bygone era.  Thinking to remove the logic and option for it since it seems hokey to call a bash script like this anyway. Thoughts?", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r515356666", "createdAt": "2020-10-30T20:21:14Z", "author": {"login": "hlgp"}, "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "diffHunk": "@@ -534,6 +542,18 @@ public void run() {\n         log.info(\"Bulk map file loader shutting down.\");\n     }\n     \n+    protected void cleanJobDirectoriesOnStartup() throws IOException {\n+        Path[] cleanupDirectories = getJobDirectories(new Path(workDir, jobDirPattern + '/' + CLEANUP_FILE_MARKER));\n+        for (int i = 0; i < cleanupDirectories.length; i++) {\n+            \n+            markSourceFilesLoaded(cleanupDirectories[i]);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5OTI2Ng=="}, "originalCommit": {"oid": "6ea057db3db7f65f67a9a62225cb01269ffa5dea"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyODcyNjM0OnYy", "diffSide": "RIGHT", "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxODozNTo0NVrOHrbpNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMDowNToxNlrOHred6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMwMzczNQ==", "bodyText": "I don't think this will work if the srcHdfs is different than the destHdfs, in which case the directory will have been discp'ed to the destHdfs prior to having been processed.  See the routine below that marks the directory for cleanup which works with the destHdfs.", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r515303735", "createdAt": "2020-10-30T18:35:45Z", "author": {"login": "ivakegg"}, "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "diffHunk": "@@ -534,6 +542,18 @@ public void run() {\n         log.info(\"Bulk map file loader shutting down.\");\n     }\n     \n+    protected void cleanJobDirectoriesOnStartup() throws IOException {\n+        Path[] cleanupDirectories = getJobDirectories(new Path(workDir, jobDirPattern + '/' + CLEANUP_FILE_MARKER));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ea057db3db7f65f67a9a62225cb01269ffa5dea"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM0OTk5Mw==", "bodyText": "true!", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r515349993", "createdAt": "2020-10-30T20:05:16Z", "author": {"login": "hlgp"}, "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "diffHunk": "@@ -534,6 +542,18 @@ public void run() {\n         log.info(\"Bulk map file loader shutting down.\");\n     }\n     \n+    protected void cleanJobDirectoriesOnStartup() throws IOException {\n+        Path[] cleanupDirectories = getJobDirectories(new Path(workDir, jobDirPattern + '/' + CLEANUP_FILE_MARKER));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMwMzczNQ=="}, "originalCommit": {"oid": "6ea057db3db7f65f67a9a62225cb01269ffa5dea"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIzMzcxNDE1OnYy", "diffSide": "RIGHT", "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNDowNTowOFrOHsFslw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNTo1NzozNFrOHsKj2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk5MjcyNw==", "bodyText": "Will this throw an exception if some other process already deleted the directory?", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r515992727", "createdAt": "2020-11-02T14:05:08Z", "author": {"login": "ivakegg"}, "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "diffHunk": "@@ -527,13 +524,26 @@ public void run() {\n                     log.error(\"Error: \" + e.getMessage(), e);\n                 }\n             }\n+        } catch (IOException e) {\n+            log.error(\"Error: \" + e.getMessage(), e);\n         } finally {\n             log.info(\"Shutting down executor service\");\n             executor.shutdown();\n         }\n         log.info(\"Bulk map file loader shutting down.\");\n     }\n     \n+    protected void cleanJobDirectoriesOnStartup() throws IOException {\n+        Path[] cleanupDirectories = getJobDirectories(destHdfs, new Path(workDir, jobDirPattern + '/' + CLEANUP_FILE_MARKER));\n+        for (int i = 0; i < cleanupDirectories.length; i++) {\n+            \n+            markSourceFilesLoaded(cleanupDirectories[i]);\n+            getFileSystem(destHdfs).delete(cleanupDirectories[i], true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac7be3d5758029580ab66da649488efbc12e3134"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA3MjQxMA==", "bodyText": "Ah, you're right.  I'll adjust that try/catch", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r516072410", "createdAt": "2020-11-02T15:57:34Z", "author": {"login": "hlgp"}, "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "diffHunk": "@@ -527,13 +524,26 @@ public void run() {\n                     log.error(\"Error: \" + e.getMessage(), e);\n                 }\n             }\n+        } catch (IOException e) {\n+            log.error(\"Error: \" + e.getMessage(), e);\n         } finally {\n             log.info(\"Shutting down executor service\");\n             executor.shutdown();\n         }\n         log.info(\"Bulk map file loader shutting down.\");\n     }\n     \n+    protected void cleanJobDirectoriesOnStartup() throws IOException {\n+        Path[] cleanupDirectories = getJobDirectories(destHdfs, new Path(workDir, jobDirPattern + '/' + CLEANUP_FILE_MARKER));\n+        for (int i = 0; i < cleanupDirectories.length; i++) {\n+            \n+            markSourceFilesLoaded(cleanupDirectories[i]);\n+            getFileSystem(destHdfs).delete(cleanupDirectories[i], true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk5MjcyNw=="}, "originalCommit": {"oid": "ac7be3d5758029580ab66da649488efbc12e3134"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2MzQ5MjI4OnYy", "diffSide": "RIGHT", "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMzo0MToyM1rOHwdB2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMToyOTozMFrOHwwU2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU2OTMwNw==", "bodyText": "How do you know that is the reason for the IOException?  Perhaps the client could not reach the NN at the time or something else.  Include the message from the IOException as the reason.", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r520569307", "createdAt": "2020-11-10T13:41:23Z", "author": {"login": "ivakegg"}, "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "diffHunk": "@@ -527,13 +528,29 @@ public void run() {\n                     log.error(\"Error: \" + e.getMessage(), e);\n                 }\n             }\n+            \n         } finally {\n             log.info(\"Shutting down executor service\");\n             executor.shutdown();\n         }\n         log.info(\"Bulk map file loader shutting down.\");\n     }\n     \n+    protected void cleanJobDirectoriesOnStartup() throws IOException {\n+        Path[] cleanupDirectories = getJobDirectories(destHdfs, new Path(workDir, jobDirPattern + '/' + CLEANUP_FILE_MARKER));\n+        for (int i = 0; i < cleanupDirectories.length; i++) {\n+            \n+            markSourceFilesLoaded(cleanupDirectories[i]);\n+            try {\n+                getFileSystem(destHdfs).delete(cleanupDirectories[i], true);\n+            } catch (IOException e) {\n+                log.warn(\"Unable to delete directory \" + cleanupDirectories[i] + \".  Another process already cleaned it up.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "229a8eab5c6bf8717c5051d5066007abc29208cb"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4NTQ2NA==", "bodyText": "updated.", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r520885464", "createdAt": "2020-11-10T21:29:30Z", "author": {"login": "hlgp"}, "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "diffHunk": "@@ -527,13 +528,29 @@ public void run() {\n                     log.error(\"Error: \" + e.getMessage(), e);\n                 }\n             }\n+            \n         } finally {\n             log.info(\"Shutting down executor service\");\n             executor.shutdown();\n         }\n         log.info(\"Bulk map file loader shutting down.\");\n     }\n     \n+    protected void cleanJobDirectoriesOnStartup() throws IOException {\n+        Path[] cleanupDirectories = getJobDirectories(destHdfs, new Path(workDir, jobDirPattern + '/' + CLEANUP_FILE_MARKER));\n+        for (int i = 0; i < cleanupDirectories.length; i++) {\n+            \n+            markSourceFilesLoaded(cleanupDirectories[i]);\n+            try {\n+                getFileSystem(destHdfs).delete(cleanupDirectories[i], true);\n+            } catch (IOException e) {\n+                log.warn(\"Unable to delete directory \" + cleanupDirectories[i] + \".  Another process already cleaned it up.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU2OTMwNw=="}, "originalCommit": {"oid": "229a8eab5c6bf8717c5051d5066007abc29208cb"}, "originalPosition": 82}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4471, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}