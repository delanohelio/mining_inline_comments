{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMTEyMjk1", "number": 980, "title": "Handle orphaned files from killed MapFileLoader (#740)", "bodyText": "", "createdAt": "2020-10-30T16:10:11Z", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980", "merged": true, "mergeCommit": {"oid": "ac896d7d9c4c4c9b7d478be40c47b80794013eec"}, "closed": true, "closedAt": "2020-11-12T02:12:01Z", "author": {"login": "hlgp"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXrMs0gFqTUyMDkzMDM0MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbo4vRAFqTUyODY4NDQ5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTMwMzQx", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#pullrequestreview-520930341", "createdAt": "2020-10-30T18:24:11Z", "commit": {"oid": "6ea057db3db7f65f67a9a62225cb01269ffa5dea"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxODoyNDoxMVrOHrbS0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxODozNTo0NVrOHrbpNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5ODAwMw==", "bodyText": "Why not put this before the while loop and avoid the firstRun flag altogether?", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r515298003", "createdAt": "2020-10-30T18:24:11Z", "author": {"login": "ivakegg"}, "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "diffHunk": "@@ -433,9 +434,16 @@ public void run() {\n         int fsAccessFailures = 0;\n         Path[] jobDirectories = new Path[0];\n         int nextJobIndex = 0;\n+        boolean firstRun = true;\n+        \n         try {\n             while (true) {\n                 try {\n+                    if (firstRun) {\n+                        \n+                        cleanJobDirectoriesOnStartup();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ea057db3db7f65f67a9a62225cb01269ffa5dea"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5OTI2Ng==", "bodyText": "I realize that the markSourceFilesLoaded can supposedly be run by multiple instances concurrently, but how about the runCleanUpScript?  Since that is being passed in, I am thinking this could be a problem.", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r515299266", "createdAt": "2020-10-30T18:26:44Z", "author": {"login": "ivakegg"}, "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "diffHunk": "@@ -534,6 +542,18 @@ public void run() {\n         log.info(\"Bulk map file loader shutting down.\");\n     }\n     \n+    protected void cleanJobDirectoriesOnStartup() throws IOException {\n+        Path[] cleanupDirectories = getJobDirectories(new Path(workDir, jobDirPattern + '/' + CLEANUP_FILE_MARKER));\n+        for (int i = 0; i < cleanupDirectories.length; i++) {\n+            \n+            markSourceFilesLoaded(cleanupDirectories[i]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ea057db3db7f65f67a9a62225cb01269ffa5dea"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMwMzczNQ==", "bodyText": "I don't think this will work if the srcHdfs is different than the destHdfs, in which case the directory will have been discp'ed to the destHdfs prior to having been processed.  See the routine below that marks the directory for cleanup which works with the destHdfs.", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r515303735", "createdAt": "2020-10-30T18:35:45Z", "author": {"login": "ivakegg"}, "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "diffHunk": "@@ -534,6 +542,18 @@ public void run() {\n         log.info(\"Bulk map file loader shutting down.\");\n     }\n     \n+    protected void cleanJobDirectoriesOnStartup() throws IOException {\n+        Path[] cleanupDirectories = getJobDirectories(new Path(workDir, jobDirPattern + '/' + CLEANUP_FILE_MARKER));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ea057db3db7f65f67a9a62225cb01269ffa5dea"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNjU1NjI2", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#pullrequestreview-521655626", "createdAt": "2020-11-02T14:05:08Z", "commit": {"oid": "ac7be3d5758029580ab66da649488efbc12e3134"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNDowNTowOFrOHsFslw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNDowNTowOFrOHsFslw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk5MjcyNw==", "bodyText": "Will this throw an exception if some other process already deleted the directory?", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r515992727", "createdAt": "2020-11-02T14:05:08Z", "author": {"login": "ivakegg"}, "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "diffHunk": "@@ -527,13 +524,26 @@ public void run() {\n                     log.error(\"Error: \" + e.getMessage(), e);\n                 }\n             }\n+        } catch (IOException e) {\n+            log.error(\"Error: \" + e.getMessage(), e);\n         } finally {\n             log.info(\"Shutting down executor service\");\n             executor.shutdown();\n         }\n         log.info(\"Bulk map file loader shutting down.\");\n     }\n     \n+    protected void cleanJobDirectoriesOnStartup() throws IOException {\n+        Path[] cleanupDirectories = getJobDirectories(destHdfs, new Path(workDir, jobDirPattern + '/' + CLEANUP_FILE_MARKER));\n+        for (int i = 0; i < cleanupDirectories.length; i++) {\n+            \n+            markSourceFilesLoaded(cleanupDirectories[i]);\n+            getFileSystem(destHdfs).delete(cleanupDirectories[i], true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac7be3d5758029580ab66da649488efbc12e3134"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MjEwNTc3", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#pullrequestreview-527210577", "createdAt": "2020-11-10T13:41:23Z", "commit": {"oid": "229a8eab5c6bf8717c5051d5066007abc29208cb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMzo0MToyM1rOHwdB2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMzo0MToyM1rOHwdB2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU2OTMwNw==", "bodyText": "How do you know that is the reason for the IOException?  Perhaps the client could not reach the NN at the time or something else.  Include the message from the IOException as the reason.", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#discussion_r520569307", "createdAt": "2020-11-10T13:41:23Z", "author": {"login": "ivakegg"}, "path": "warehouse/ingest-core/src/main/java/datawave/ingest/mapreduce/job/BulkIngestMapFileLoader.java", "diffHunk": "@@ -527,13 +528,29 @@ public void run() {\n                     log.error(\"Error: \" + e.getMessage(), e);\n                 }\n             }\n+            \n         } finally {\n             log.info(\"Shutting down executor service\");\n             executor.shutdown();\n         }\n         log.info(\"Bulk map file loader shutting down.\");\n     }\n     \n+    protected void cleanJobDirectoriesOnStartup() throws IOException {\n+        Path[] cleanupDirectories = getJobDirectories(destHdfs, new Path(workDir, jobDirPattern + '/' + CLEANUP_FILE_MARKER));\n+        for (int i = 0; i < cleanupDirectories.length; i++) {\n+            \n+            markSourceFilesLoaded(cleanupDirectories[i]);\n+            try {\n+                getFileSystem(destHdfs).delete(cleanupDirectories[i], true);\n+            } catch (IOException e) {\n+                log.warn(\"Unable to delete directory \" + cleanupDirectories[i] + \".  Another process already cleaned it up.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "229a8eab5c6bf8717c5051d5066007abc29208cb"}, "originalPosition": 82}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75dfb7205a6338cf54125df550db7deb33809a64", "author": {"user": {"login": "hlgp", "name": "palindrome"}}, "url": "https://github.com/NationalSecurityAgency/datawave/commit/75dfb7205a6338cf54125df550db7deb33809a64", "committedDate": "2020-11-10T21:58:06Z", "message": "Address #740 Handle orphaned files from killed MapFileLoader"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb28d9cc74994f7ef8740c62ce4d708789357ad9", "author": {"user": {"login": "hlgp", "name": "palindrome"}}, "url": "https://github.com/NationalSecurityAgency/datawave/commit/eb28d9cc74994f7ef8740c62ce4d708789357ad9", "committedDate": "2020-11-10T16:38:31Z", "message": "Merge branch 'issue-740' of https://github.com/hlgp/datawave into issue-740"}, "afterCommit": {"oid": "75dfb7205a6338cf54125df550db7deb33809a64", "author": {"user": {"login": "hlgp", "name": "palindrome"}}, "url": "https://github.com/NationalSecurityAgency/datawave/commit/75dfb7205a6338cf54125df550db7deb33809a64", "committedDate": "2020-11-10T21:58:06Z", "message": "Address #740 Handle orphaned files from killed MapFileLoader"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4Njg0NDk5", "url": "https://github.com/NationalSecurityAgency/datawave/pull/980#pullrequestreview-528684499", "createdAt": "2020-11-12T02:11:22Z", "commit": {"oid": "75dfb7205a6338cf54125df550db7deb33809a64"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1105, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}