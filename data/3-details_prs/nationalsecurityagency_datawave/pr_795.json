{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3MTE4NzU5", "number": 795, "title": "Fix potential NPE in TermFrequencyIndexIterator.", "bodyText": "", "createdAt": "2020-04-01T17:01:43Z", "url": "https://github.com/NationalSecurityAgency/datawave/pull/795", "merged": true, "mergeCommit": {"oid": "fc6914c5e1fe811c5f9bf848efb331e03813f848"}, "closed": true, "closedAt": "2020-04-01T18:38:38Z", "author": {"login": "apmoriarty"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTawQYgH2gAyMzk3MTE4NzU5OmZhNWRhMjM0YjY1MTUwZDNlZjU4ZmYxZjFjYmE2YjdmYmJmYTE5ZGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTy46yAFqTM4Njc3NzA3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fa5da234b65150d3ef58ff1f1cba6b7fbbfa19df", "author": {"user": {"login": "apmoriarty", "name": "Moriarty"}}, "url": "https://github.com/NationalSecurityAgency/datawave/commit/fa5da234b65150d3ef58ff1f1cba6b7fbbfa19df", "committedDate": "2020-04-01T17:00:53Z", "message": "Fix potential NPE in TermFrequencyIndexIterator."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NzgzNzgx", "url": "https://github.com/NationalSecurityAgency/datawave/pull/795#pullrequestreview-385783781", "createdAt": "2020-04-01T17:08:30Z", "commit": {"oid": "fa5da234b65150d3ef58ff1f1cba6b7fbbfa19df"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1ODE2Nzk0", "url": "https://github.com/NationalSecurityAgency/datawave/pull/795#pullrequestreview-385816794", "createdAt": "2020-04-01T17:52:29Z", "commit": {"oid": "fa5da234b65150d3ef58ff1f1cba6b7fbbfa19df"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNzo1MjoyOVrOF_L_Sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNzo1MjoyOVrOF_L_Sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgwMTAzNQ==", "bodyText": "Reusing tk here is not good here.  Say we get through this loop without tk being null, and then the check at line 204 is true.  This would result in a seek and we would immediately pop out of the outer while loop because tk is not null and would not be holding the correct field name!  Use a separate Key variable instead.", "url": "https://github.com/NationalSecurityAgency/datawave/pull/795#discussion_r401801035", "createdAt": "2020-04-01T17:52:29Z", "author": {"login": "ivakegg"}, "path": "warehouse/query-core/src/main/java/datawave/query/iterator/logic/TermFrequencyIndexIterator.java", "diffHunk": "@@ -187,12 +187,20 @@ public void next() throws IOException {\n             \n             for (int i = 0; i < 256 && source.hasTop() && key.getFieldName().compareTo(field) < 0; ++i) {\n                 source.next();\n-                key = new DatawaveKey(source.getTopKey());\n+                \n+                tk = source.getTopKey();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa5da234b65150d3ef58ff1f1cba6b7fbbfa19df"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4d45f0c536dc55248564177dea9333c62160f7a", "author": {"user": {"login": "apmoriarty", "name": "Moriarty"}}, "url": "https://github.com/NationalSecurityAgency/datawave/commit/c4d45f0c536dc55248564177dea9333c62160f7a", "committedDate": "2020-04-01T18:16:00Z", "message": "Address PR comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1ODM4MzE3", "url": "https://github.com/NationalSecurityAgency/datawave/pull/795#pullrequestreview-385838317", "createdAt": "2020-04-01T18:22:25Z", "commit": {"oid": "c4d45f0c536dc55248564177dea9333c62160f7a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1ODQwNDkw", "url": "https://github.com/NationalSecurityAgency/datawave/pull/795#pullrequestreview-385840490", "createdAt": "2020-04-01T18:25:27Z", "commit": {"oid": "c4d45f0c536dc55248564177dea9333c62160f7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxODoyNToyN1rOF_NK3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxODoyNToyN1rOF_NK3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgyMDM4Mg==", "bodyText": "I wouldn't hold it up over this, and some could argue it's too esoteric, but it seems like this could actually be a good use of a labelled continue statement. Label the outer while loop, change this to continue <label> and remove the addition at line 202. At that point, nextTop could also be local to this loop.", "url": "https://github.com/NationalSecurityAgency/datawave/pull/795#discussion_r401820382", "createdAt": "2020-04-01T18:25:27Z", "author": {"login": "brianloss"}, "path": "warehouse/query-core/src/main/java/datawave/query/iterator/logic/TermFrequencyIndexIterator.java", "diffHunk": "@@ -184,15 +184,24 @@ public void next() throws IOException {\n             }\n             \n             DatawaveKey key = new DatawaveKey(top);\n+            Key nextTop = null;\n             \n             for (int i = 0; i < 256 && source.hasTop() && key.getFieldName().compareTo(field) < 0; ++i) {\n                 source.next();\n-                key = new DatawaveKey(source.getTopKey());\n+                \n+                nextTop = source.getTopKey();\n+                if (nextTop == null)\n+                    break;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4d45f0c536dc55248564177dea9333c62160f7a"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1ODQxNjAz", "url": "https://github.com/NationalSecurityAgency/datawave/pull/795#pullrequestreview-385841603", "createdAt": "2020-04-01T18:26:56Z", "commit": {"oid": "c4d45f0c536dc55248564177dea9333c62160f7a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2Nzc3MDcy", "url": "https://github.com/NationalSecurityAgency/datawave/pull/795#pullrequestreview-386777072", "createdAt": "2020-04-02T21:08:04Z", "commit": {"oid": "c4d45f0c536dc55248564177dea9333c62160f7a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMTowODowNFrOF_8lJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMTowODowNFrOF_8lJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU5NzE1Ng==", "bodyText": "This leads to an infinite loop if we never go in to the for loop on line 188/189 (which would happen if we already have the right key). All of the github actions have been stuck due to this. Initializing nextTop as Key nextTop = top; on line 187 will solve.", "url": "https://github.com/NationalSecurityAgency/datawave/pull/795#discussion_r402597156", "createdAt": "2020-04-02T21:08:04Z", "author": {"login": "brianloss"}, "path": "warehouse/query-core/src/main/java/datawave/query/iterator/logic/TermFrequencyIndexIterator.java", "diffHunk": "@@ -184,15 +184,24 @@ public void next() throws IOException {\n             }\n             \n             DatawaveKey key = new DatawaveKey(top);\n+            Key nextTop = null;\n             \n             for (int i = 0; i < 256 && source.hasTop() && key.getFieldName().compareTo(field) < 0; ++i) {\n                 source.next();\n-                key = new DatawaveKey(source.getTopKey());\n+                \n+                nextTop = source.getTopKey();\n+                if (nextTop == null)\n+                    break;\n+                \n+                key = new DatawaveKey(nextTop);\n                 if (log.isTraceEnabled()) {\n                     log.trace(\"Have key \" + key + \" < \" + field);\n                 }\n             }\n             \n+            if (nextTop == null)\n+                continue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4d45f0c536dc55248564177dea9333c62160f7a"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1185, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}