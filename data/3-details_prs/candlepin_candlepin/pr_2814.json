{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzMDYwNDc3", "number": 2814, "title": "1841591: Manifest delete takes 24 hours or more in large environment", "bodyText": "", "createdAt": "2020-09-25T13:09:17Z", "url": "https://github.com/candlepin/candlepin/pull/2814", "merged": true, "mergeCommit": {"oid": "d8eb57d79b1053356b5565aa10cb2f70b364b9fc"}, "closed": true, "closedAt": "2020-10-01T11:17:32Z", "author": {"login": "Januson"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMW5H_AFqTQ5NjQ4OTM1MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdN-P2wgBqjM4MjUwMzI3Nzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NDg5MzUx", "url": "https://github.com/candlepin/candlepin/pull/2814#pullrequestreview-496489351", "createdAt": "2020-09-25T14:44:38Z", "commit": {"oid": "57dabf3e128f0ccbfe30499428b9b666ba618417"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNDo0NDozOFrOHYGs7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNDo0NDozOFrOHYGs7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAzNzY3OA==", "bodyText": "As per our conversation, there's more things to discuss here. The ideal solution is to not fetch the entitlement objects into memory at all (they're 60k+ after all), but instead do a batch delete by entitlement IDs like is done elsewhere.\nTo do that though, we first have to make sure we do anything else that needs to be done (revokeEntitlements does a lot of stuff, and we need to find out if we even need to do most of those in this specific use case (UndoImportsJob)).", "url": "https://github.com/candlepin/candlepin/pull/2814#discussion_r495037678", "createdAt": "2020-09-25T14:44:38Z", "author": {"login": "nikosmoum"}, "path": "server/src/main/java/org/candlepin/controller/CandlepinPoolManager.java", "diffHunk": "@@ -2114,9 +2114,13 @@ public void deletePool(Pool pool) {\n         Event event = eventFactory.poolDeleted(pool);\n \n         // Must do a full revoke for all entitlements:\n-        for (Entitlement e : poolCurator.entitlementsIn(pool)) {\n+        List<Entitlement> entitlements = poolCurator.entitlementsIn(pool);\n+        for (Entitlement e : entitlements) {\n             e.setDeletedFromPool(true);\n-            revokeEntitlement(e);\n+        }\n+\n+        for (List<Entitlement> partition : Iterables.partition(entitlements, 1000)) {\n+            revokeEntitlements(partition);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57dabf3e128f0ccbfe30499428b9b666ba618417"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57dabf3e128f0ccbfe30499428b9b666ba618417", "author": {"user": {"login": "Januson", "name": null}}, "url": "https://github.com/candlepin/candlepin/commit/57dabf3e128f0ccbfe30499428b9b666ba618417", "committedDate": "2020-09-25T13:06:32Z", "message": "1841591: Manifest delete takes 24 hours or more in large environment (60k consumers in owner)\n - Delete entitlements in batches."}, "afterCommit": {"oid": "f39e956aee83669ec3240d7c4defd71f63b4abca", "author": {"user": {"login": "Januson", "name": null}}, "url": "https://github.com/candlepin/candlepin/commit/f39e956aee83669ec3240d7c4defd71f63b4abca", "committedDate": "2020-09-30T13:30:29Z", "message": "1841591: Manifest delete takes 24 hours or more in large environment (60k consumers in owner)\n - Switch to a faster implementation of pool deletion."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NDQzODA4", "url": "https://github.com/candlepin/candlepin/pull/2814#pullrequestreview-499443808", "createdAt": "2020-09-30T13:42:53Z", "commit": {"oid": "f39e956aee83669ec3240d7c4defd71f63b4abca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMzo0Mjo1M1rOHaeLmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMzo0Mjo1M1rOHaeLmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzUxOTUxMg==", "bodyText": "No need to pass another argument here, the deletePools method has an overloaded version which only accepts a single list of pools. Other than that, this looks good", "url": "https://github.com/candlepin/candlepin/pull/2814#discussion_r497519512", "createdAt": "2020-09-30T13:42:53Z", "author": {"login": "nikosmoum"}, "path": "server/src/main/java/org/candlepin/async/tasks/UndoImportsJob.java", "diffHunk": "@@ -164,11 +167,12 @@ public void execute(JobExecutionContext context) throws JobExecutionException {\n         log.info(\"Deleting all pools originating from manifests for owner/org: {}\", displayName);\n \n         List<Pool> pools = this.poolManager.listPoolsByOwner(owner).list();\n-        for (Pool pool : pools) {\n-            if (this.poolManager.isManaged(pool)) {\n-                this.poolManager.deletePool(pool);\n-            }\n-        }\n+        this.poolManager.deletePools(\n+            pools.stream()\n+                .filter(this.poolManager::isManaged)\n+                .collect(Collectors.toList()),\n+            new ArrayList<>()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f39e956aee83669ec3240d7c4defd71f63b4abca"}, "originalPosition": 25}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f39e956aee83669ec3240d7c4defd71f63b4abca", "author": {"user": {"login": "Januson", "name": null}}, "url": "https://github.com/candlepin/candlepin/commit/f39e956aee83669ec3240d7c4defd71f63b4abca", "committedDate": "2020-09-30T13:30:29Z", "message": "1841591: Manifest delete takes 24 hours or more in large environment (60k consumers in owner)\n - Switch to a faster implementation of pool deletion."}, "afterCommit": {"oid": "e1f6338390ed59cc10a5de8b5ffbabd9cecb8074", "author": {"user": {"login": "Januson", "name": null}}, "url": "https://github.com/candlepin/candlepin/commit/e1f6338390ed59cc10a5de8b5ffbabd9cecb8074", "committedDate": "2020-09-30T14:30:02Z", "message": "1841591: Manifest delete takes 24 hours or more in large environment (60k consumers in owner)\n - Switch to a faster implementation of pool deletion."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba594a278789591f18621ce54ab31538d51b905a", "author": {"user": {"login": "Januson", "name": null}}, "url": "https://github.com/candlepin/candlepin/commit/ba594a278789591f18621ce54ab31538d51b905a", "committedDate": "2020-09-30T15:09:26Z", "message": "1841591: Manifest delete takes 24 hours or more in large environment (60k consumers in owner)\n - Switch to a faster implementation of pool deletion."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e1f6338390ed59cc10a5de8b5ffbabd9cecb8074", "author": {"user": {"login": "Januson", "name": null}}, "url": "https://github.com/candlepin/candlepin/commit/e1f6338390ed59cc10a5de8b5ffbabd9cecb8074", "committedDate": "2020-09-30T14:30:02Z", "message": "1841591: Manifest delete takes 24 hours or more in large environment (60k consumers in owner)\n - Switch to a faster implementation of pool deletion."}, "afterCommit": {"oid": "ba594a278789591f18621ce54ab31538d51b905a", "author": {"user": {"login": "Januson", "name": null}}, "url": "https://github.com/candlepin/candlepin/commit/ba594a278789591f18621ce54ab31538d51b905a", "committedDate": "2020-09-30T15:09:26Z", "message": "1841591: Manifest delete takes 24 hours or more in large environment (60k consumers in owner)\n - Switch to a faster implementation of pool deletion."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2321, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}