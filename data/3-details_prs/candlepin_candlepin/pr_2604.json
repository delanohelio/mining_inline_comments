{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczMDc4ODE4", "number": 2604, "title": "[F] ENT-1686: Change the way Dev Pools are created", "bodyText": "Removed adding installed products of the consumer.\nAdded provided products of dev_sku.", "createdAt": "2020-02-10T11:19:28Z", "url": "https://github.com/candlepin/candlepin/pull/2604", "merged": true, "mergeCommit": {"oid": "7bc6c968cfa3757ff7898a5e6d6c6c55d48b5ae8"}, "closed": true, "closedAt": "2020-02-14T20:14:35Z", "author": {"login": "sonalidhome"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDRbt9gBqjMwMjY0NjE3MjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcETMD8gFqTM1OTExMDE4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1172585c78bc61cb0495b887d4f57d90970994ce", "author": {"user": {"login": "sonalidhome", "name": "Sonali Dhome"}}, "url": "https://github.com/candlepin/candlepin/commit/1172585c78bc61cb0495b887d4f57d90970994ce", "committedDate": "2020-02-10T11:12:04Z", "message": "[F] ENT-1686: Change the way Dev Pools are created\n- Removed adding installed products of consumer.\n- Added provided products for dev_sku."}, "afterCommit": {"oid": "746250b8acbb7a6182990c81c4a27727e0e01b27", "author": {"user": {"login": "sonalidhome", "name": "Sonali Dhome"}}, "url": "https://github.com/candlepin/candlepin/commit/746250b8acbb7a6182990c81c4a27727e0e01b27", "committedDate": "2020-02-11T13:05:32Z", "message": "[F] ENT-1686: Change the way Dev Pools are created\n- Removed adding installed products of consumer.\n- Added provided products for dev_sku."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MzIwOTky", "url": "https://github.com/candlepin/candlepin/pull/2604#pullrequestreview-358320992", "createdAt": "2020-02-13T15:40:56Z", "commit": {"oid": "746250b8acbb7a6182990c81c4a27727e0e01b27"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNTo0MDo1NlrOFpYvOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNTo0MDo1NlrOFpYvOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk0MTI0MA==", "bodyText": "This block is a bit dangerous, since we have no innate control over whether or not devProduct actually returns a non-null value or not. Plus, we can do some optimization here to avoid instantiating a new collection, since we already have one to populate:\n            Collection<? extends ProductInfo> provided = devProduct.getProvidedProducts();\n\n            if (provided != null) {\n                provided.forEach(product -> {\n                    if (product != null) {\n                        devProductIds.add(product.getId());\n                    }\n                });\n            }", "url": "https://github.com/candlepin/candlepin/pull/2604#discussion_r378941240", "createdAt": "2020-02-13T15:40:56Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/controller/Entitler.java", "diffHunk": "@@ -362,26 +362,38 @@ protected Pool assembleDevPool(Consumer consumer, Owner owner, String sku) {\n         return pool;\n     }\n \n-    private DeveloperProducts getDeveloperPoolProducts(Consumer consumer, Owner owner, String sku) {\n-        DeveloperProducts devProducts = getDevProductMap(consumer, owner, sku);\n-        verifyDevProducts(consumer, sku, devProducts);\n+    private DeveloperProducts getDeveloperPoolProducts(Owner owner, String sku) {\n+        DeveloperProducts devProducts = getDevProductMap(owner, sku);\n+        verifyDevProducts(sku, devProducts);\n         return devProducts;\n     }\n \n     /**\n-     * Looks up all Products matching the specified SKU and the consumer's\n-     * installed products.\n+     * Looks up all Products and their provided products\n+     * matching the specified SKU.\n      *\n-     * @param consumer the consumer to pull the installed product id list from.\n      * @param sku the product id of the SKU.\n      * @return a {@link DeveloperProducts} object that contains the Product objects\n      *         from the adapter.\n      */\n-    private DeveloperProducts getDevProductMap(Consumer consumer, Owner owner, String sku) {\n-        List<String> devProductIds = new ArrayList<>();\n-        devProductIds.add(sku);\n-        for (ConsumerInstalledProduct ip : consumer.getInstalledProducts()) {\n-            devProductIds.add(ip.getProductId());\n+    private DeveloperProducts getDevProductMap(Owner owner, String sku) {\n+\n+        Collection<? extends ProductInfo> productsByIds = this.productAdapter\n+            .getProductsByIds(owner.getKey(), Arrays.asList(sku));\n+\n+        Collection<String> devProductIds = new ArrayList<>();\n+        if (productsByIds.iterator().hasNext()) {\n+            ProductInfo devProduct = productsByIds.iterator().next();\n+            devProductIds.add(devProduct.getId());\n+\n+            if (!devProduct.getProvidedProducts().isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "746250b8acbb7a6182990c81c4a27727e0e01b27"}, "originalPosition": 64}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "746250b8acbb7a6182990c81c4a27727e0e01b27", "author": {"user": {"login": "sonalidhome", "name": "Sonali Dhome"}}, "url": "https://github.com/candlepin/candlepin/commit/746250b8acbb7a6182990c81c4a27727e0e01b27", "committedDate": "2020-02-11T13:05:32Z", "message": "[F] ENT-1686: Change the way Dev Pools are created\n- Removed adding installed products of consumer.\n- Added provided products for dev_sku."}, "afterCommit": {"oid": "0b4976bc2e5d33d0ff5e47ebd19070fda8a91f8a", "author": {"user": {"login": "sonalidhome", "name": "Sonali Dhome"}}, "url": "https://github.com/candlepin/candlepin/commit/0b4976bc2e5d33d0ff5e47ebd19070fda8a91f8a", "committedDate": "2020-02-14T07:49:46Z", "message": "[F] ENT-1686: Change the way Dev Pools are created\n- Removed adding installed products of consumer.\n- Added provided products for dev_sku."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2020d4523ffc7af080ebfe414144603574c2af2b", "author": {"user": {"login": "sonalidhome", "name": "Sonali Dhome"}}, "url": "https://github.com/candlepin/candlepin/commit/2020d4523ffc7af080ebfe414144603574c2af2b", "committedDate": "2020-02-14T07:59:18Z", "message": "[F] ENT-1686: Change the way Dev Pools are created\n- Removed adding installed products of consumer.\n- Added provided products for dev_sku."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0b4976bc2e5d33d0ff5e47ebd19070fda8a91f8a", "author": {"user": {"login": "sonalidhome", "name": "Sonali Dhome"}}, "url": "https://github.com/candlepin/candlepin/commit/0b4976bc2e5d33d0ff5e47ebd19070fda8a91f8a", "committedDate": "2020-02-14T07:49:46Z", "message": "[F] ENT-1686: Change the way Dev Pools are created\n- Removed adding installed products of consumer.\n- Added provided products for dev_sku."}, "afterCommit": {"oid": "2020d4523ffc7af080ebfe414144603574c2af2b", "author": {"user": {"login": "sonalidhome", "name": "Sonali Dhome"}}, "url": "https://github.com/candlepin/candlepin/commit/2020d4523ffc7af080ebfe414144603574c2af2b", "committedDate": "2020-02-14T07:59:18Z", "message": "[F] ENT-1686: Change the way Dev Pools are created\n- Removed adding installed products of consumer.\n- Added provided products for dev_sku."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MTEwMTg3", "url": "https://github.com/candlepin/candlepin/pull/2604#pullrequestreview-359110187", "createdAt": "2020-02-14T17:43:09Z", "commit": {"oid": "2020d4523ffc7af080ebfe414144603574c2af2b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2500, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}