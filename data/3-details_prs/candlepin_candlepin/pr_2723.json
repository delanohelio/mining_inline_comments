{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMwOTEyMTQx", "number": 2723, "title": "ENT-2440: Map internal async job states to a subset of client-supported states", "bodyText": "", "createdAt": "2020-06-08T08:19:06Z", "url": "https://github.com/candlepin/candlepin/pull/2723", "merged": true, "mergeCommit": {"oid": "b5e7ad226edf53bbde520c909c113afc2113311f"}, "closed": true, "closedAt": "2020-06-09T05:41:10Z", "author": {"login": "Januson"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpN0a6ABqjM0MTkzNTUzODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpSqkhABqjM0MjA4NDc4MjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f982c655b8209b0b097d1e77adf73730609f648e", "author": {"user": {"login": "Januson", "name": null}}, "url": "https://github.com/candlepin/candlepin/commit/f982c655b8209b0b097d1e77adf73730609f648e", "committedDate": "2020-06-08T08:17:12Z", "message": "ENT-2440: Map internal async job states to a subset of client-supported states\n- Introduce an enum with client facing Job States\n- Map internal JobState to PublicJobState"}, "afterCommit": {"oid": "111be186786a300e52f9a4155854697f4475ea60", "author": {"user": {"login": "Januson", "name": null}}, "url": "https://github.com/candlepin/candlepin/commit/111be186786a300e52f9a4155854697f4475ea60", "committedDate": "2020-06-08T10:22:46Z", "message": "ENT-2440: Map internal async job states to a subset of client-supported states\n- Introduce an enum with client facing Job States\n- Map internal JobState to PublicJobState"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "111be186786a300e52f9a4155854697f4475ea60", "author": {"user": {"login": "Januson", "name": null}}, "url": "https://github.com/candlepin/candlepin/commit/111be186786a300e52f9a4155854697f4475ea60", "committedDate": "2020-06-08T10:22:46Z", "message": "ENT-2440: Map internal async job states to a subset of client-supported states\n- Introduce an enum with client facing Job States\n- Map internal JobState to PublicJobState"}, "afterCommit": {"oid": "10663fde0a6da529aba62d6d194faa72b64bc1e1", "author": {"user": {"login": "Januson", "name": null}}, "url": "https://github.com/candlepin/candlepin/commit/10663fde0a6da529aba62d6d194faa72b64bc1e1", "committedDate": "2020-06-08T10:56:29Z", "message": "ENT-2440: Map internal async job states to a subset of client-supported states\n- Introduce an enum with client facing Job States\n- Map internal JobState to PublicJobState"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MjczNDM1", "url": "https://github.com/candlepin/candlepin/pull/2723#pullrequestreview-426273435", "createdAt": "2020-06-08T14:01:33Z", "commit": {"oid": "10663fde0a6da529aba62d6d194faa72b64bc1e1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNDowMTozNFrOGgf5ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNDoxNjoyM1rOGggufA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjczMDI1MA==", "bodyText": "I'm torn on this one. I can see a temporary \"FAILED\" output being useful, but it's still kind of \"RUNNING\" since it'll get picked up again unless something breaks internally.", "url": "https://github.com/candlepin/candlepin/pull/2723#discussion_r436730250", "createdAt": "2020-06-08T14:01:34Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/dto/api/v1/AsyncJobStatusTranslator.java", "diffHunk": "@@ -72,14 +71,54 @@ public AsyncJobStatusDTO populate(ModelTranslator translator, AsyncJobStatus sou\n         destination.setAttempts(source.getAttempts());\n         destination.setMaxAttempts(source.getMaxAttempts());\n         destination.setResult(source.getJobResult());\n+        destination.setState(stateToString(mapState(source.getState())));\n+        destination.setPreviousState(stateToString(mapState(source.getPreviousState())));\n \n-        JobState state = source.getState();\n-        destination.setState(state != null ? state.name() : null);\n+        return destination;\n+    }\n \n-        JobState pstate = source.getPreviousState();\n-        destination.setPreviousState(pstate != null ? pstate.name() : null);\n+    private String stateToString(PublicJobState state) {\n+        if (state == null) {\n+            return null;\n+        }\n+        return state.name();\n+    }\n \n-        return destination;\n+    public static PublicJobState mapState(JobState state) {\n+        if (state == null) {\n+            return null;\n+        }\n+        PublicJobState publicJobState;\n+        switch (state) {\n+            case FINISHED:\n+                publicJobState = PublicJobState.FINISHED;\n+                break;\n+            case CREATED:\n+                publicJobState = PublicJobState.CREATED;\n+                break;\n+            case QUEUED:\n+            case RUNNING:\n+            case SCHEDULED:\n+            case WAITING:\n+                publicJobState = PublicJobState.RUNNING;\n+                break;\n+            case ABORTED:\n+            case CANCELED:\n+            case FAILED:\n+            case FAILED_WITH_RETRY:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10663fde0a6da529aba62d6d194faa72b64bc1e1"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc0MzI5Nw==", "bodyText": "Should QUEUED be part of RUNNING or CREATED? This is another one where I can see arguments for either case.", "url": "https://github.com/candlepin/candlepin/pull/2723#discussion_r436743297", "createdAt": "2020-06-08T14:15:42Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/dto/api/v1/AsyncJobStatusTranslator.java", "diffHunk": "@@ -72,14 +71,54 @@ public AsyncJobStatusDTO populate(ModelTranslator translator, AsyncJobStatus sou\n         destination.setAttempts(source.getAttempts());\n         destination.setMaxAttempts(source.getMaxAttempts());\n         destination.setResult(source.getJobResult());\n+        destination.setState(stateToString(mapState(source.getState())));\n+        destination.setPreviousState(stateToString(mapState(source.getPreviousState())));\n \n-        JobState state = source.getState();\n-        destination.setState(state != null ? state.name() : null);\n+        return destination;\n+    }\n \n-        JobState pstate = source.getPreviousState();\n-        destination.setPreviousState(pstate != null ? pstate.name() : null);\n+    private String stateToString(PublicJobState state) {\n+        if (state == null) {\n+            return null;\n+        }\n+        return state.name();\n+    }\n \n-        return destination;\n+    public static PublicJobState mapState(JobState state) {\n+        if (state == null) {\n+            return null;\n+        }\n+        PublicJobState publicJobState;\n+        switch (state) {\n+            case FINISHED:\n+                publicJobState = PublicJobState.FINISHED;\n+                break;\n+            case CREATED:\n+                publicJobState = PublicJobState.CREATED;\n+                break;\n+            case QUEUED:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10663fde0a6da529aba62d6d194faa72b64bc1e1"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc0MzgwNA==", "bodyText": "As mentioned in IRC, let's hang on to the CANCELED state, since it doesn't fit into either of the two completion states from the request, and it was preexisting so we won't break clients.", "url": "https://github.com/candlepin/candlepin/pull/2723#discussion_r436743804", "createdAt": "2020-06-08T14:16:23Z", "author": {"login": "Ceiu"}, "path": "server/spec/job_status_spec.rb", "diffHunk": "@@ -123,18 +123,18 @@\n       job = @user.autoheal_org(@owner['key'])\n       #make sure we see a job waiting to go\n       joblist = @cp.list_jobs(@owner['key'])\n-      expect(joblist.find { |j| j['id'] == job['id'] }['state']).to eq('QUEUED')\n+      expect(joblist.find { |j| j['id'] == job['id'] }['state']).to eq('RUNNING')\n \n       @user.cancel_job(job['id'])\n       #make sure we see a job canceled\n       joblist = @cp.list_jobs(@owner['key'])\n-      expect(joblist.find { |j| j['id'] == job['id'] }['state']).to eq('CANCELED')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10663fde0a6da529aba62d6d194faa72b64bc1e1"}, "originalPosition": 32}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "10663fde0a6da529aba62d6d194faa72b64bc1e1", "author": {"user": {"login": "Januson", "name": null}}, "url": "https://github.com/candlepin/candlepin/commit/10663fde0a6da529aba62d6d194faa72b64bc1e1", "committedDate": "2020-06-08T10:56:29Z", "message": "ENT-2440: Map internal async job states to a subset of client-supported states\n- Introduce an enum with client facing Job States\n- Map internal JobState to PublicJobState"}, "afterCommit": {"oid": "016d9438e9499275bbc63dd7b8f4b8ca8c64af98", "author": {"user": {"login": "Januson", "name": null}}, "url": "https://github.com/candlepin/candlepin/commit/016d9438e9499275bbc63dd7b8f4b8ca8c64af98", "committedDate": "2020-06-08T14:55:28Z", "message": "ENT-2440: Map internal async job states to a subset of client-supported states\n- Introduce an enum with client facing Job States\n- Map internal JobState to PublicJobState"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MzM5ODkz", "url": "https://github.com/candlepin/candlepin/pull/2723#pullrequestreview-426339893", "createdAt": "2020-06-08T15:09:26Z", "commit": {"oid": "016d9438e9499275bbc63dd7b8f4b8ca8c64af98"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96f659a195924f8a35ec2811ceb721dfde3a9997", "author": {"user": {"login": "Januson", "name": null}}, "url": "https://github.com/candlepin/candlepin/commit/96f659a195924f8a35ec2811ceb721dfde3a9997", "committedDate": "2020-06-08T15:24:10Z", "message": "ENT-2440: Map internal async job states to a subset of client-supported states\n- Introduce an enum with client facing Job States\n- Map internal JobState to PublicJobState"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "016d9438e9499275bbc63dd7b8f4b8ca8c64af98", "author": {"user": {"login": "Januson", "name": null}}, "url": "https://github.com/candlepin/candlepin/commit/016d9438e9499275bbc63dd7b8f4b8ca8c64af98", "committedDate": "2020-06-08T14:55:28Z", "message": "ENT-2440: Map internal async job states to a subset of client-supported states\n- Introduce an enum with client facing Job States\n- Map internal JobState to PublicJobState"}, "afterCommit": {"oid": "96f659a195924f8a35ec2811ceb721dfde3a9997", "author": {"user": {"login": "Januson", "name": null}}, "url": "https://github.com/candlepin/candlepin/commit/96f659a195924f8a35ec2811ceb721dfde3a9997", "committedDate": "2020-06-08T15:24:10Z", "message": "ENT-2440: Map internal async job states to a subset of client-supported states\n- Introduce an enum with client facing Job States\n- Map internal JobState to PublicJobState"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2421, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}