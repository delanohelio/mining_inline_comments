{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczNjMyODU5", "number": 2609, "title": "[M] ENT-2049: Use new hibernate session per job", "bodyText": "Use UnitOfWork to open/close a sessions when starting/stopping a\njob. Currently hibernate sessions are staying open when artemis\njobs are running, which causes a lot of issues, one of them being\nmanifested as stale data when the same artemis thread happens to\nexecute the same job sequentially, resulting in intermittent\nspec test failures in import_spec.rb", "createdAt": "2020-02-11T12:31:17Z", "url": "https://github.com/candlepin/candlepin/pull/2609", "merged": true, "mergeCommit": {"oid": "06b500c52b83e91ed3a0b7ae48e4e3ccfa75d999"}, "closed": true, "closedAt": "2020-02-17T20:23:40Z", "author": {"login": "nikosmoum"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDTD57gFqTM1NjcxOTkxNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFTR3kgFqTM1OTk1MTM1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NzE5OTE2", "url": "https://github.com/candlepin/candlepin/pull/2609#pullrequestreview-356719916", "createdAt": "2020-02-11T14:52:24Z", "commit": {"oid": "31fa51218d5f233e084ae3316ecd5a5078af4cc5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNDo1MjoyNVrOFoL8nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNDo1MjoyNVrOFoL8nA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY4MzEwMA==", "bodyText": "We should set the owner to the merged owner here since we use it again later.", "url": "https://github.com/candlepin/candlepin/pull/2609#discussion_r377683100", "createdAt": "2020-02-11T14:52:25Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/async/tasks/UndoImportsJob.java", "diffHunk": "@@ -173,10 +173,12 @@ public Object execute(JobExecutionContext context) throws JobExecutionException\n         // Clear out upstream ID so owner can import from other distributors:\n         UpstreamConsumer uc = owner.getUpstreamConsumer();\n         owner.setUpstreamConsumer(null);\n+        this.ownerCurator.merge(owner);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31fa51218d5f233e084ae3316ecd5a5078af4cc5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e368bb8ef122e7bbbfd6cbdb3bfad0b25bd8bbed", "author": {"user": {"login": "nikosmoum", "name": "Nikos Moumoulidis"}}, "url": "https://github.com/candlepin/candlepin/commit/e368bb8ef122e7bbbfd6cbdb3bfad0b25bd8bbed", "committedDate": "2020-02-13T13:14:18Z", "message": "ENT-2049: Use new hibernate session per job\n\n- Use UnitOfWork to open/close a sessions when starting/stopping a\n  job. Currently hibernate sessions are staying open when artemis\n  jobs are running, which causes a lot of issues, one of them being\n  manifested as stale data when the same artemis thread happens to\n  execute the same job sequentially, resulting in intermittent\n  spec test failures in import_spec.rb"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "31fa51218d5f233e084ae3316ecd5a5078af4cc5", "author": {"user": {"login": "nikosmoum", "name": "Nikos Moumoulidis"}}, "url": "https://github.com/candlepin/candlepin/commit/31fa51218d5f233e084ae3316ecd5a5078af4cc5", "committedDate": "2020-02-11T12:30:38Z", "message": "ENT-2049: Fix import spec test failures\n\n- Explicitly flush and then evict the owner at the end of the\n  UndoImports job, and also refresh the owner at the start of\n  importing.\n- This is to fix intermittent failures in import_spec.rb tests where\n  a hibernate session with stale data (an owner's UpstreamConsumer)\n  could sometimes be reused between import/undo import operations,\n  and cause import to fail."}, "afterCommit": {"oid": "e368bb8ef122e7bbbfd6cbdb3bfad0b25bd8bbed", "author": {"user": {"login": "nikosmoum", "name": "Nikos Moumoulidis"}}, "url": "https://github.com/candlepin/candlepin/commit/e368bb8ef122e7bbbfd6cbdb3bfad0b25bd8bbed", "committedDate": "2020-02-13T13:14:18Z", "message": "ENT-2049: Use new hibernate session per job\n\n- Use UnitOfWork to open/close a sessions when starting/stopping a\n  job. Currently hibernate sessions are staying open when artemis\n  jobs are running, which causes a lot of issues, one of them being\n  manifested as stale data when the same artemis thread happens to\n  execute the same job sequentially, resulting in intermittent\n  spec test failures in import_spec.rb"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5OTUxMzUy", "url": "https://github.com/candlepin/candlepin/pull/2609#pullrequestreview-359951352", "createdAt": "2020-02-17T20:23:25Z", "commit": {"oid": "e368bb8ef122e7bbbfd6cbdb3bfad0b25bd8bbed"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2504, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}