{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3MTU5NjQ1", "number": 2766, "title": "[M] 1854221: Graceful shutdown of Artemis job threads; ENT-2586", "bodyText": "Now, when tomcat is shut down gracefully:\n\nFirst wait for Artemis client threads to finish before\nclosing the sessions, to make sure that commits happen\ninstead of potentially finishing a job and the broker\nnot getting a commit back.\nDon't use ActiveMQClient.clearThreadPools() to quiesce\nthe threads, because it:\n\nWaits only 10 seconds for jobs to finish before force\nshutting them down.\nUses ExecutorService.shutdownNow() which will interrupt\nthreads, causing an InterruptedException and not wait for\nthe jobs to finish.\n\n\nUse ExecutorService.shutdown() which will gracefully wait\nfor the threads to finish their work.\nIntroduce new config \"candlepin.async.thread.shutdown.timeout\"\nto specify how long (in seconds) to wait for job threads to\nfinish before forcefully shutting them down.", "createdAt": "2020-07-27T13:20:17Z", "url": "https://github.com/candlepin/candlepin/pull/2766", "merged": true, "mergeCommit": {"oid": "57b4cbf57c6af3c087af2f9660dc9a2c285a34a4"}, "closed": true, "closedAt": "2020-07-28T21:31:07Z", "author": {"login": "nikosmoum"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5CXUpgFqTQ1NTgwNjYzOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5XlEKABqjM1OTQ3NDYwNTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1ODA2NjM4", "url": "https://github.com/candlepin/candlepin/pull/2766#pullrequestreview-455806638", "createdAt": "2020-07-27T13:58:03Z", "commit": {"oid": "5af4464f01b4398c4dea62a036e9008ec8bd91d7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxMzo1ODowM1rOG3jreA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNDowMjozNVrOG3j39Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDkwOTQzMg==", "bodyText": "We should do this after the call to jobManager.shutdown", "url": "https://github.com/candlepin/candlepin/pull/2766#discussion_r460909432", "createdAt": "2020-07-27T13:58:03Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/guice/CandlepinContextListener.java", "diffHunk": "@@ -259,6 +260,8 @@ public void contextDestroyed(ServletContextEvent event) {\n     }\n \n     private void destroySubsystems() throws Exception {\n+        this.waitForArtemisJobThreadsToFinish();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5af4464f01b4398c4dea62a036e9008ec8bd91d7"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDkxMjYyOQ==", "bodyText": "If this is specifically for the job system, we should move this to somewhere that makes a bit more sense. Either in jobManager.shutdown or, and probably best in my opinion, ArtemisContextListener.shutdown (which gets hit automatically via cpmContextListener.shutdown above)", "url": "https://github.com/candlepin/candlepin/pull/2766#discussion_r460912629", "createdAt": "2020-07-27T14:02:35Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/guice/CandlepinContextListener.java", "diffHunk": "@@ -291,6 +294,35 @@ private void destroySubsystems() throws Exception {\n         this.loggerListener.contextDestroyed();\n     }\n \n+    private void waitForArtemisJobThreadsToFinish() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5af4464f01b4398c4dea62a036e9008ec8bd91d7"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NTc1Njc1", "url": "https://github.com/candlepin/candlepin/pull/2766#pullrequestreview-456575675", "createdAt": "2020-07-28T12:21:51Z", "commit": {"oid": "5af4464f01b4398c4dea62a036e9008ec8bd91d7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de901c3e447bcb7a7186387334542430cfde0889", "author": {"user": {"login": "nikosmoum", "name": "Nikos Moumoulidis"}}, "url": "https://github.com/candlepin/candlepin/commit/de901c3e447bcb7a7186387334542430cfde0889", "committedDate": "2020-07-28T14:47:46Z", "message": "1854221: Graceful shutdown of Artemis job threads\n\nNow, when tomcat is shut down gracefully:\n- First wait for Artemis client threads to finish before\n  closing the sessions, to make sure that commits happen\n  instead of potentially finishing a job and the broker\n  not getting a commit back.\n- Don't use ActiveMQClient.clearThreadPools() to quiesce\n  the threads, because it:\n   * Waits only 10 seconds for jobs to finish before force\n   shutting them down.\n   * Uses ExecutorService.shutdownNow() which will interrupt\n   threads, causing an InterruptedException and not wait for\n   the jobs to finish.\n- Use ExecutorService.shutdown() which will gracefully wait\n  for the threads to finish their work.\n- Introduce new config \"candlepin.async.thread.shutdown.timeout\"\n  to specify how long (in seconds) to wait for job threads to\n  finish before forcefully shutting them down."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5af4464f01b4398c4dea62a036e9008ec8bd91d7", "author": {"user": {"login": "nikosmoum", "name": "Nikos Moumoulidis"}}, "url": "https://github.com/candlepin/candlepin/commit/5af4464f01b4398c4dea62a036e9008ec8bd91d7", "committedDate": "2020-07-27T13:19:20Z", "message": "1854221: Graceful shutdown of Artemis job threads\n\nNow, when tomcat is shut down gracefully:\n- First wait for Artemis client threads to finish before\n  closing the sessions, to make sure that commits happen\n  instead of potentially finishing a job and the broker\n  not getting a commit back.\n- Don't use ActiveMQClient.clearThreadPools() to quiesce\n  the threads, because it:\n   * Waits only 10 seconds for jobs to finish before force\n   shutting them down.\n   * Uses ExecutorService.shutdownNow() which will interrupt\n   threads, causing an InterruptedException and not wait for\n   the jobs to finish.\n- Use ExecutorService.shutdown() which will gracefully wait\n  for the threads to finish their work.\n- Introduce new config \"candlepin.async.thread.shutdown.timeout\"\n  to specify how long (in seconds) to wait for job threads to\n  finish before forcefully shutting them down."}, "afterCommit": {"oid": "de901c3e447bcb7a7186387334542430cfde0889", "author": {"user": {"login": "nikosmoum", "name": "Nikos Moumoulidis"}}, "url": "https://github.com/candlepin/candlepin/commit/de901c3e447bcb7a7186387334542430cfde0889", "committedDate": "2020-07-28T14:47:46Z", "message": "1854221: Graceful shutdown of Artemis job threads\n\nNow, when tomcat is shut down gracefully:\n- First wait for Artemis client threads to finish before\n  closing the sessions, to make sure that commits happen\n  instead of potentially finishing a job and the broker\n  not getting a commit back.\n- Don't use ActiveMQClient.clearThreadPools() to quiesce\n  the threads, because it:\n   * Waits only 10 seconds for jobs to finish before force\n   shutting them down.\n   * Uses ExecutorService.shutdownNow() which will interrupt\n   threads, causing an InterruptedException and not wait for\n   the jobs to finish.\n- Use ExecutorService.shutdown() which will gracefully wait\n  for the threads to finish their work.\n- Introduce new config \"candlepin.async.thread.shutdown.timeout\"\n  to specify how long (in seconds) to wait for job threads to\n  finish before forcefully shutting them down."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2286, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}