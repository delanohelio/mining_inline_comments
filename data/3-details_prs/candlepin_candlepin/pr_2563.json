{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyNDgzOTMw", "number": 2563, "title": "[F] [ENT-1831][ENT-1830] update pool response and manifest export flow", "bodyText": "Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\nUpdated org/candlepin/sync/Exporter.java to copy provided products from product and derived product\nUpdated product creation logic in rspec\nUpdated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts\nUpdated rspec and junit as per code changes\nRemoved spec tests related to accumulating provided products in case of stacked entitlements as marketing product and stack id has one to one relationship i.e. different marketing product will not have the same stacking id and all the required provided products will be available in marketing product itself from the adapter.", "createdAt": "2020-01-14T07:21:08Z", "url": "https://github.com/candlepin/candlepin/pull/2563", "merged": true, "mergeCommit": {"oid": "fb0b336413b74b01f913aae6b8a42bd95ac59cc2"}, "closed": true, "closedAt": "2020-01-23T18:19:18Z", "author": {"login": "abhiskum"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6MAPyABqjI5NDU5ODM3ODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9OhITAFqTM0NzUwODc5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "895e4f2016c9b439df2fdacf47f93a7c52d4815f", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/895e4f2016c9b439df2fdacf47f93a7c52d4815f", "committedDate": "2020-01-14T07:19:07Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Add logic in PoolTranslator to accumulate provided products for stacked entitlements at runtime\n  - Updated product creation logic in rspec\n  - Update translator junits to pass entitlement EntitlementCurator in this constructor\n  - updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts"}, "afterCommit": {"oid": "d276a39e176e535c3fa6f39b93b05f16e718b1bc", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/d276a39e176e535c3fa6f39b93b05f16e718b1bc", "committedDate": "2020-01-14T07:41:03Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Add logic in PoolTranslator to accumulate provided products for stacked entitlements at runtime\n  - Updated product creation logic in rspec\n  - Update translator junits to pass entitlement EntitlementCurator in this constructor\n  - updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d276a39e176e535c3fa6f39b93b05f16e718b1bc", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/d276a39e176e535c3fa6f39b93b05f16e718b1bc", "committedDate": "2020-01-14T07:41:03Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Add logic in PoolTranslator to accumulate provided products for stacked entitlements at runtime\n  - Updated product creation logic in rspec\n  - Update translator junits to pass entitlement EntitlementCurator in this constructor\n  - updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts"}, "afterCommit": {"oid": "1070f83a4e0c5ba5c5cd10e7467c85ec54790877", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/1070f83a4e0c5ba5c5cd10e7467c85ec54790877", "committedDate": "2020-01-14T09:42:09Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Add logic in PoolTranslator to accumulate provided products for stacked entitlements at runtime\n  - Updated product creation logic in rspec\n  - Update translator junits to pass entitlement EntitlementCurator in this constructor\n  - updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNTcwMzc2", "url": "https://github.com/candlepin/candlepin/pull/2563#pullrequestreview-342570376", "createdAt": "2020-01-14T14:26:48Z", "commit": {"oid": "1070f83a4e0c5ba5c5cd10e7467c85ec54790877"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNDoyNjo0OFrOFdZS0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNToxODozMFrOFdbJYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM2NzQ0MQ==", "bodyText": "For blocks like this, either follow the existing formatting (each new param on a new line), or update the formatting for the whole statement. This occurs a number of times throughout this PR.", "url": "https://github.com/candlepin/candlepin/pull/2563#discussion_r366367441", "createdAt": "2020-01-14T14:26:48Z", "author": {"login": "Ceiu"}, "path": "server/src/test/java/org/candlepin/resource/util/InstalledProductStatusCalculatorTest.java", "diffHunk": "@@ -117,7 +118,7 @@ public void setUp() {\n \n         translator = new StandardTranslator(this.consumerTypeCurator,\n             this.environmentCurator,\n-            this.ownerCurator);\n+            this.ownerCurator, this.entitlementCurator);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1070f83a4e0c5ba5c5cd10e7467c85ec54790877"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM2ODIxMg==", "bodyText": "Trailing punctuation goes on the previous line. If it cannot fit, bring the last chunk of code down. In this case, I'm guessing this.oc, should be on 171.", "url": "https://github.com/candlepin/candlepin/pull/2563#discussion_r366368212", "createdAt": "2020-01-14T14:28:13Z", "author": {"login": "Ceiu"}, "path": "server/src/test/java/org/candlepin/sync/ImporterTest.java", "diffHunk": "@@ -163,8 +164,11 @@ public void init() throws URISyntaxException, IOException {\n         this.mockSubReconciler = Mockito.mock(SubscriptionReconciler.class);\n         this.consumerTypeCurator = Mockito.mock(ConsumerTypeCurator.class);\n         oc = mock(OwnerCurator.class);\n+        entitlementCurator = mock(EntitlementCurator.class);\n \n-        this.translator = new StandardTranslator(this.consumerTypeCurator, this.environmentCurator, this.oc);\n+\n+        this.translator = new StandardTranslator(this.consumerTypeCurator, this.environmentCurator, this.oc\n+            , this.entitlementCurator);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1070f83a4e0c5ba5c5cd10e7467c85ec54790877"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM4MTI2NA==", "bodyText": "There are a number of ways to format these blocks, and for the most part that's fine; but try to be consistent in which you choose. Elsewhere in the PR there is a nearly identical block which is formatted with different breakage.", "url": "https://github.com/candlepin/candlepin/pull/2563#discussion_r366381264", "createdAt": "2020-01-14T14:50:56Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/dto/api/v1/PoolTranslator.java", "diffHunk": "@@ -122,20 +132,22 @@ public PoolDTO populate(ModelTranslator modelTranslator, Pool source, PoolDTO de\n                 dest.setBranding(Collections.emptySet());\n             }\n \n-            Set<Product> products = source.getProvidedProducts();\n+            Collection<Product> products =\n+                source.getProduct() != null ? source.getProduct().getProvidedProducts() : null;\n             if (products != null && !products.isEmpty()) {\n                 for (Product prod : products) {\n                     if (prod != null) {\n-                        dest.addProvidedProduct(\n-                            new PoolDTO.ProvidedProductDTO(prod.getId(), prod.getName()));\n+                        dest.addProvidedProduct(new PoolDTO.ProvidedProductDTO(prod.getId(), prod.getName()));\n                     }\n                 }\n+\n             }\n             else {\n                 dest.setProvidedProducts(Collections.<PoolDTO.ProvidedProductDTO>emptySet());\n             }\n \n-            Set<Product> derivedProducts = source.getDerivedProvidedProducts();\n+            Collection<Product> derivedProducts =\n+                source.getDerivedProduct() != null ? source.getDerivedProduct().getProvidedProducts() : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1070f83a4e0c5ba5c5cd10e7467c85ec54790877"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM4MTU2OQ==", "bodyText": "Whitespace missing between the // and TODO", "url": "https://github.com/candlepin/candlepin/pull/2563#discussion_r366381569", "createdAt": "2020-01-14T14:51:20Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/controller/CandlepinPoolManager.java", "diffHunk": "@@ -974,6 +974,11 @@ private Pool convertToMasterPoolImpl(SubscriptionInfo sub, Owner owner, Map<Stri\n             }\n \n             pool.setProvidedProducts(products);\n+            //TODO: workaround to pass import spec tests. we will revisit and update this in import and", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1070f83a4e0c5ba5c5cd10e7467c85ec54790877"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5NjQ5Nw==", "bodyText": "Product model translation needs to be n-tier aware during the conversion to a flat list here and below.", "url": "https://github.com/candlepin/candlepin/pull/2563#discussion_r366396497", "createdAt": "2020-01-14T15:16:17Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/sync/Exporter.java", "diffHunk": "@@ -492,12 +492,18 @@ private void exportProducts(File baseDir, Consumer consumer) throws IOException\n             Product product = pool.getProduct();\n             products.put(product.getId(), product);\n \n+            for (Product providedProduct : product.getProvidedProducts()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1070f83a4e0c5ba5c5cd10e7467c85ec54790877"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5NzU2NA==", "bodyText": "These need to be n-tier aware translations", "url": "https://github.com/candlepin/candlepin/pull/2563#discussion_r366397564", "createdAt": "2020-01-14T15:18:04Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/dto/manifest/v1/PoolTranslator.java", "diffHunk": "@@ -150,8 +162,47 @@ public PoolDTO populate(ModelTranslator modelTranslator, Pool source, PoolDTO de\n             else {\n                 dest.setDerivedProvidedProducts(Collections.emptySet());\n             }\n+\n+            // accumulate provided products for stacked entitlements\n+            if (PoolType.STACK_DERIVED.equals(source.getType())) {\n+                Collection<Product> providedProducts = accumulateStackDerivedPoolProvidedProducts(source);\n+                if (source.getDerivedProduct() != null) {\n+                    for (Product providedProduct : providedProducts) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1070f83a4e0c5ba5c5cd10e7467c85ec54790877"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5Nzc5NA==", "bodyText": "These need to be n-tier aware translations", "url": "https://github.com/candlepin/candlepin/pull/2563#discussion_r366397794", "createdAt": "2020-01-14T15:18:30Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/dto/api/v1/PoolTranslator.java", "diffHunk": "@@ -147,8 +159,48 @@ public PoolDTO populate(ModelTranslator modelTranslator, Pool source, PoolDTO de\n             else {\n                 dest.setDerivedProvidedProducts(Collections.<PoolDTO.ProvidedProductDTO>emptySet());\n             }\n+\n+            // accumulate provided products for stacked entitlements\n+            if (PoolType.STACK_DERIVED.equals(source.getType())) {\n+                Collection<Product> providedProducts = accumulateStackDerivedPoolProvidedProducts(source);\n+                if (source.getDerivedProduct() != null) {\n+                    for (Product providedProduct : providedProducts) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1070f83a4e0c5ba5c5cd10e7467c85ec54790877"}, "originalPosition": 78}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1070f83a4e0c5ba5c5cd10e7467c85ec54790877", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/1070f83a4e0c5ba5c5cd10e7467c85ec54790877", "committedDate": "2020-01-14T09:42:09Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Add logic in PoolTranslator to accumulate provided products for stacked entitlements at runtime\n  - Updated product creation logic in rspec\n  - Update translator junits to pass entitlement EntitlementCurator in this constructor\n  - updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts"}, "afterCommit": {"oid": "e2576563692b24fc182ef1ac28aa1f065ef297fa", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/e2576563692b24fc182ef1ac28aa1f065ef297fa", "committedDate": "2020-01-16T07:51:54Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Add logic in PoolTranslator to accumulate provided products for stacked entitlements at runtime\n  - Updated product creation logic in rspec\n  - Update translator junits to pass entitlement EntitlementCurator in this constructor\n  - updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2576563692b24fc182ef1ac28aa1f065ef297fa", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/e2576563692b24fc182ef1ac28aa1f065ef297fa", "committedDate": "2020-01-16T07:51:54Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Add logic in PoolTranslator to accumulate provided products for stacked entitlements at runtime\n  - Updated product creation logic in rspec\n  - Update translator junits to pass entitlement EntitlementCurator in this constructor\n  - updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts"}, "afterCommit": {"oid": "2f6a855952c85fa4f40c6909e2bb7f461a7df346", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/2f6a855952c85fa4f40c6909e2bb7f461a7df346", "committedDate": "2020-01-16T09:18:33Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Add logic in PoolTranslator to accumulate provided products for stacked entitlements at runtime\n  - Updated product creation logic in rspec\n  - Update translator junits to pass entitlement EntitlementCurator in this constructor\n  - updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzODYwNDYy", "url": "https://github.com/candlepin/candlepin/pull/2563#pullrequestreview-343860462", "createdAt": "2020-01-16T11:56:48Z", "commit": {"oid": "2f6a855952c85fa4f40c6909e2bb7f461a7df346"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMTo1Njo0OFrOFeW_5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxMjozNzoyMVrOFe3woA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM3ODQwNQ==", "bodyText": "\ud83d\udc4d Yep, it would be easier to get the refresh changes done first", "url": "https://github.com/candlepin/candlepin/pull/2563#discussion_r367378405", "createdAt": "2020-01-16T11:56:48Z", "author": {"login": "nikosmoum"}, "path": "server/src/main/java/org/candlepin/controller/CandlepinPoolManager.java", "diffHunk": "@@ -974,6 +974,11 @@ private Pool convertToMasterPoolImpl(SubscriptionInfo sub, Owner owner, Map<Stri\n             }\n \n             pool.setProvidedProducts(products);\n+            // TODO: workaround to pass import spec tests. we will revisit and update this in import and\n+            // refresh code changes", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f6a855952c85fa4f40c6909e2bb7f461a7df346"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM4MzY2Ng==", "bodyText": "This is something also found in Sonali's PR, which we discussed, and decided it is part if a separate task (ENT-1834), since the import_test_data.rb file has nothing to do with spec tests, and is only invoked by the deploy script to load test_data.json, so it should probably be reverted from this PR.", "url": "https://github.com/candlepin/candlepin/pull/2563#discussion_r367383666", "createdAt": "2020-01-16T12:10:01Z", "author": {"login": "nikosmoum"}, "path": "server/bin/import_test_data.rb", "diffHunk": "@@ -202,12 +202,14 @@ def create_product(cp, owner, product)\n   attrs['variant'] = variant\n   attrs['arch'] = arch\n   attrs['type'] = type\n+\n   product_ret = cp.create_product(owner['name'], id, name, {\n     :multiplier => multiplier,\n     :attributes => attrs,\n     :dependentProductIds => dependent_products,\n     :relies_on => relies_on,\n-    :branding => branding\n+    :branding => branding,\n+    :providedProducts => provided_products", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f6a855952c85fa4f40c6909e2bb7f461a7df346"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkxMzI0Mw==", "bodyText": "This is something we discussed for a bit before, and it didn't seem right to me. I wasn't familiar with the code in StackedSubPoolValueAccumulator and how it's used, and it's hard to go through, but I tried to look into it a bit, and from what I understand this is what happens:\nWhen we want to update sub-pools (stack derived pools) of a master pool, we find the entitlements from the same stack of that sub-pool, then find the pools off of those entitlements, and see if any of their provided products changed, and if they did change, we set those provided products on that sub-pool here, and eventually persist it.\nI assume the problem that arose that prompted you to add this change in the Translator is that those updated provided products are not reflected in the pool's marketing product, so we add them in the DTO here due to possible spec test failures? Would it not be preferable to change the code in PoolRules instead, to add those updated provided products on the marketing product directly and make sure our model data is consistent? Then we wouldn't need to do this on the DTO?\n@abhiskum Maybe I'm misunderstanding something since I'm not familiar with this part of the application? @Ceiu do you happen to know more about this?", "url": "https://github.com/candlepin/candlepin/pull/2563#discussion_r367913243", "createdAt": "2020-01-17T12:31:39Z", "author": {"login": "nikosmoum"}, "path": "server/src/main/java/org/candlepin/dto/api/v1/PoolTranslator.java", "diffHunk": "@@ -122,33 +132,74 @@ public PoolDTO populate(ModelTranslator modelTranslator, Pool source, PoolDTO de\n                 dest.setBranding(Collections.emptySet());\n             }\n \n-            Set<Product> products = source.getProvidedProducts();\n-            if (products != null && !products.isEmpty()) {\n-                for (Product prod : products) {\n-                    if (prod != null) {\n-                        dest.addProvidedProduct(\n-                            new PoolDTO.ProvidedProductDTO(prod.getId(), prod.getName()));\n+            Collection<Product> products =\n+                source.getProduct() != null ? source.getProduct().getProvidedProducts() : null;\n+            Set<PoolDTO.ProvidedProductDTO> providedProductDTOs = new HashSet<>();\n+            addProvidedProducts(products, providedProductDTOs);\n+            dest.setProvidedProducts(providedProductDTOs);\n+\n+            Collection<Product> derivedProducts =\n+                source.getDerivedProduct() != null ? source.getDerivedProduct().getProvidedProducts() : null;\n+            Set<PoolDTO.ProvidedProductDTO> derivedProvidedProductDTOs = new HashSet<>();\n+            addProvidedProducts(derivedProducts, derivedProvidedProductDTOs);\n+            dest.setDerivedProvidedProducts(derivedProvidedProductDTOs);\n+\n+            // accumulate provided products for stacked entitlements\n+            if (PoolType.STACK_DERIVED.equals(source.getType())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f6a855952c85fa4f40c6909e2bb7f461a7df346"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkxNTE2OA==", "bodyText": "Are these recursive calls what is meant by \"n-tier aware\"? Are we sure that this is how we're going to be handling this in the future; as a marketing product that has provided products and each provided product has its own provided products etc.? Last I checked we were not going to be doing the N-tier stuff, because we don't yet know how the product management people are going to design that stuff.\n@abhiskum @Ceiu", "url": "https://github.com/candlepin/candlepin/pull/2563#discussion_r367915168", "createdAt": "2020-01-17T12:37:21Z", "author": {"login": "nikosmoum"}, "path": "server/src/main/java/org/candlepin/dto/manifest/v1/PoolTranslator.java", "diffHunk": "@@ -125,33 +135,73 @@ public PoolDTO populate(ModelTranslator modelTranslator, Pool source, PoolDTO de\n                 dest.setBranding(Collections.emptySet());\n             }\n \n-            Set<Product> products = source.getProvidedProducts();\n-            if (products != null && !products.isEmpty()) {\n-                for (Product prod : products) {\n-                    if (prod != null) {\n-                        dest.addProvidedProduct(\n-                            new PoolDTO.ProvidedProductDTO(prod.getId(), prod.getName()));\n+            Collection<Product> products =\n+                source.getProduct() != null ? source.getProduct().getProvidedProducts() : null;\n+            Set<PoolDTO.ProvidedProductDTO> providedProductDTOs = new HashSet<>();\n+            addProvidedProducts(products, providedProductDTOs);\n+            dest.setProvidedProducts(providedProductDTOs);\n+\n+            Collection<Product> derivedProducts =\n+                source.getDerivedProduct() != null ? source.getDerivedProduct().getProvidedProducts() : null;\n+            Set<PoolDTO.ProvidedProductDTO> derivedProvidedProductDTOs = new HashSet<>();\n+            addProvidedProducts(derivedProducts, derivedProvidedProductDTOs);\n+            dest.setDerivedProvidedProducts(derivedProvidedProductDTOs);\n+\n+            // accumulate provided products for stacked entitlements\n+            if (PoolType.STACK_DERIVED.equals(source.getType())) {\n+                Set<PoolDTO.ProvidedProductDTO> expectedProvidedProds = new HashSet<>();\n+\n+                accumulateStackDerivedPoolProvidedProducts(source, expectedProvidedProds);\n+\n+                if (source.getDerivedProduct() != null) {\n+                    for (PoolDTO.ProvidedProductDTO providedProductDTO : expectedProvidedProds) {\n+                        dest.addDerivedProvidedProduct(providedProductDTO);\n                     }\n                 }\n-            }\n-            else {\n-                dest.setProvidedProducts(Collections.emptySet());\n-            }\n-\n-            Set<Product> derivedProducts = source.getDerivedProvidedProducts();\n-            if (derivedProducts != null && !derivedProducts.isEmpty()) {\n-                for (Product derivedProd : derivedProducts) {\n-                    if (derivedProd != null) {\n-                        dest.addDerivedProvidedProduct(\n-                            new PoolDTO.ProvidedProductDTO(derivedProd.getId(), derivedProd.getName()));\n+                else {\n+                    for (PoolDTO.ProvidedProductDTO providedProductDTO : expectedProvidedProds) {\n+                        dest.addProvidedProduct(providedProductDTO);\n                     }\n                 }\n             }\n+        }\n+\n+        return dest;\n+    }\n+\n+    /**\n+     *\n+     * @param pool\n+     * @return\n+     *   accumulated provided products collection from the same stack entitlements\n+     */\n+    private void accumulateStackDerivedPoolProvidedProducts(Pool pool,\n+        Set<PoolDTO.ProvidedProductDTO> expectedProvidedProds) {\n+        List<Entitlement> stackedEntitlements = this.entitlementCurator\n+            .findByStackId(pool.getSourceStack().getSourceConsumer(), pool.getSourceStackId()).list();\n+        for (Entitlement nextStacked : stackedEntitlements) {\n+            Pool nextStackedPool = nextStacked.getPool();\n+            if (nextStackedPool.getDerivedProduct() == null) {\n+                addProvidedProducts(nextStackedPool.getProduct().getProvidedProducts(),\n+                    expectedProvidedProds);\n+            }\n             else {\n-                dest.setDerivedProvidedProducts(Collections.emptySet());\n+                addProvidedProducts(nextStackedPool.getDerivedProduct().getProvidedProducts(),\n+                    expectedProvidedProds);\n             }\n         }\n+    }\n \n-        return dest;\n+    private void addProvidedProducts(Collection<Product> providedProducts,\n+        Set<PoolDTO.ProvidedProductDTO> providedProductDTOs) {\n+        if (providedProducts == null || providedProducts.isEmpty()) {\n+            return;\n+        }\n+        for (Product product : providedProducts) {\n+            if (product != null) {\n+                providedProductDTOs.add(new PoolDTO.ProvidedProductDTO(product.getId(), product.getName()));\n+                addProvidedProducts(product.getProvidedProducts(), providedProductDTOs);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f6a855952c85fa4f40c6909e2bb7f461a7df346"}, "originalPosition": 119}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NzQxOTQ0", "url": "https://github.com/candlepin/candlepin/pull/2563#pullrequestreview-344741944", "createdAt": "2020-01-17T17:50:34Z", "commit": {"oid": "2f6a855952c85fa4f40c6909e2bb7f461a7df346"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNzo1MDozNFrOFfAljQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNzo1MTo0OFrOFfAnbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA1OTc4OQ==", "bodyText": "Missed formatting correction", "url": "https://github.com/candlepin/candlepin/pull/2563#discussion_r368059789", "createdAt": "2020-01-17T17:50:34Z", "author": {"login": "Ceiu"}, "path": "server/src/test/java/org/candlepin/sync/EntitlementImporterTest.java", "diffHunk": "@@ -101,7 +102,7 @@ public void init() {\n \n         this.translator = new StandardTranslator(mockConsumerTypeCurator,\n             mockEnvironmentCurator,\n-            ownerCurator);\n+            ownerCurator, entitlementCurator);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f6a855952c85fa4f40c6909e2bb7f461a7df346"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2MDI3MQ==", "bodyText": "Missed whitespace correction", "url": "https://github.com/candlepin/candlepin/pull/2563#discussion_r368060271", "createdAt": "2020-01-17T17:51:48Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/controller/CandlepinPoolManager.java", "diffHunk": "@@ -993,6 +998,11 @@ private Pool convertToMasterPoolImpl(SubscriptionInfo sub, Owner owner, Map<Stri\n             }\n \n             pool.setDerivedProvidedProducts(products);\n+            //TODO: workaround to pass import spec tests. we will revisit and update this in import and", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f6a855952c85fa4f40c6909e2bb7f461a7df346"}, "originalPosition": 16}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2f6a855952c85fa4f40c6909e2bb7f461a7df346", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/2f6a855952c85fa4f40c6909e2bb7f461a7df346", "committedDate": "2020-01-16T09:18:33Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Add logic in PoolTranslator to accumulate provided products for stacked entitlements at runtime\n  - Updated product creation logic in rspec\n  - Update translator junits to pass entitlement EntitlementCurator in this constructor\n  - updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts"}, "afterCommit": {"oid": "917e9082b6e145ba84adb04a8c3e73d81a84f040", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/917e9082b6e145ba84adb04a8c3e73d81a84f040", "committedDate": "2020-01-20T11:44:57Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Add logic in PoolTranslator to accumulate provided products for stacked entitlements at runtime\n  - Updated product creation logic in rspec\n  - Update translator junits to pass entitlement EntitlementCurator in this constructor\n  - updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "917e9082b6e145ba84adb04a8c3e73d81a84f040", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/917e9082b6e145ba84adb04a8c3e73d81a84f040", "committedDate": "2020-01-20T11:44:57Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Add logic in PoolTranslator to accumulate provided products for stacked entitlements at runtime\n  - Updated product creation logic in rspec\n  - Update translator junits to pass entitlement EntitlementCurator in this constructor\n  - updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts"}, "afterCommit": {"oid": "f7d1e71b597628a07ee9508b9ad5418989401a08", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/f7d1e71b597628a07ee9508b9ad5418989401a08", "committedDate": "2020-01-21T07:19:28Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Add logic in PoolTranslator to accumulate provided products for stacked entitlements at runtime\n  - Updated product creation logic in rspec\n  - Update translator junits to pass entitlement EntitlementCurator in this constructor\n  - updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f7d1e71b597628a07ee9508b9ad5418989401a08", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/f7d1e71b597628a07ee9508b9ad5418989401a08", "committedDate": "2020-01-21T07:19:28Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Add logic in PoolTranslator to accumulate provided products for stacked entitlements at runtime\n  - Updated product creation logic in rspec\n  - Update translator junits to pass entitlement EntitlementCurator in this constructor\n  - updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts"}, "afterCommit": {"oid": "c0f842cfd31dc511135c1ab2640d5638806bd18e", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/c0f842cfd31dc511135c1ab2640d5638806bd18e", "committedDate": "2020-01-21T15:48:13Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Add logic in PoolTranslator to accumulate provided products for stacked entitlements at runtime\n  - Updated product creation logic in rspec\n  - Update translator junits to pass entitlement EntitlementCurator in this constructor\n  - updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1OTk5NDU0", "url": "https://github.com/candlepin/candlepin/pull/2563#pullrequestreview-345999454", "createdAt": "2020-01-21T16:09:34Z", "commit": {"oid": "c0f842cfd31dc511135c1ab2640d5638806bd18e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c0f842cfd31dc511135c1ab2640d5638806bd18e", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/c0f842cfd31dc511135c1ab2640d5638806bd18e", "committedDate": "2020-01-21T15:48:13Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Add logic in PoolTranslator to accumulate provided products for stacked entitlements at runtime\n  - Updated product creation logic in rspec\n  - Update translator junits to pass entitlement EntitlementCurator in this constructor\n  - updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts"}, "afterCommit": {"oid": "3a26112cb32d2f5574299edf810cdc4118b7d1b3", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/3a26112cb32d2f5574299edf810cdc4118b7d1b3", "committedDate": "2020-01-22T00:29:16Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Updated product creation logic in rspec\n  - Update translator junits to pass entitlement EntitlementCurator in this constructor\n  - updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a26112cb32d2f5574299edf810cdc4118b7d1b3", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/3a26112cb32d2f5574299edf810cdc4118b7d1b3", "committedDate": "2020-01-22T00:29:16Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Updated product creation logic in rspec\n  - Update translator junits to pass entitlement EntitlementCurator in this constructor\n  - updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts"}, "afterCommit": {"oid": "0ecf68ab62f4d14348ead78c47e3690a7c366cdc", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/0ecf68ab62f4d14348ead78c47e3690a7c366cdc", "committedDate": "2020-01-22T00:30:50Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Updated org/candlepin/sync/Exporter.java to copy provided products from product and derived product\n  - Updated product creation logic in rspec\n  - Updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts\n  - Updated rspec and junit as per code changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ecf68ab62f4d14348ead78c47e3690a7c366cdc", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/0ecf68ab62f4d14348ead78c47e3690a7c366cdc", "committedDate": "2020-01-22T00:30:50Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Updated org/candlepin/sync/Exporter.java to copy provided products from product and derived product\n  - Updated product creation logic in rspec\n  - Updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts\n  - Updated rspec and junit as per code changes"}, "afterCommit": {"oid": "9eae5bae99f7137ad862e10683b86496963518e1", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/9eae5bae99f7137ad862e10683b86496963518e1", "committedDate": "2020-01-22T00:42:00Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Updated org/candlepin/sync/Exporter.java to copy provided products from product and derived product\n  - Updated product creation logic in rspec\n  - Updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts\n  - Updated rspec and junit as per code changes\n  - Removed spec tests related to accumulate provided products in case of stacked entitlements as\nmarketing product and stack id has one to one relationship i.e. different marketing product will not have the same stacking id and all the required provided products will be available in marketing product itself from adapter."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd62cc1137a71b221a00b32686fd1cd19efb0bb3", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/cd62cc1137a71b221a00b32686fd1cd19efb0bb3", "committedDate": "2020-01-22T00:43:17Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Updated org/candlepin/sync/Exporter.java to copy provided products from product and derived product\n  - Updated product creation logic in rspec\n  - Updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts\n  - Updated rspec and junit as per code changes\n  - Removed spec tests related to accumulate provided products in case of stacked entitlements as marketing product and stack id has one to one relationship i.e. different marketing product will not have the same stacking id and all the required provided products will be available in marketing product itself from adapter."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9eae5bae99f7137ad862e10683b86496963518e1", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/9eae5bae99f7137ad862e10683b86496963518e1", "committedDate": "2020-01-22T00:42:00Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Updated org/candlepin/sync/Exporter.java to copy provided products from product and derived product\n  - Updated product creation logic in rspec\n  - Updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts\n  - Updated rspec and junit as per code changes\n  - Removed spec tests related to accumulate provided products in case of stacked entitlements as\nmarketing product and stack id has one to one relationship i.e. different marketing product will not have the same stacking id and all the required provided products will be available in marketing product itself from adapter."}, "afterCommit": {"oid": "cd62cc1137a71b221a00b32686fd1cd19efb0bb3", "author": {"user": {"login": "abhiskum", "name": "Abhishek Kumar"}}, "url": "https://github.com/candlepin/candlepin/commit/cd62cc1137a71b221a00b32686fd1cd19efb0bb3", "committedDate": "2020-01-22T00:43:17Z", "message": "[ENT-1831][ENT-1830] update pool response and manifest export flow\n  - Update org/candlepin/dto/api/v1/PoolTranslator.java to populate provided products into PoolDTO from Pool.Product.ProvidedProducts\n  - Updated org/candlepin/sync/Exporter.java to copy provided products from product and derived product\n  - Updated product creation logic in rspec\n  - Updated org/candlepin/dto/manifest/v1/PoolTranslator.java to populate provided products into PoolDTO from pool.product.providedProducts\n  - Updated rspec and junit as per code changes\n  - Removed spec tests related to accumulate provided products in case of stacked entitlements as marketing product and stack id has one to one relationship i.e. different marketing product will not have the same stacking id and all the required provided products will be available in marketing product itself from adapter."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NDEyMzM2", "url": "https://github.com/candlepin/candlepin/pull/2563#pullrequestreview-346412336", "createdAt": "2020-01-22T08:31:23Z", "commit": {"oid": "cd62cc1137a71b221a00b32686fd1cd19efb0bb3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3NTA4Nzk0", "url": "https://github.com/candlepin/candlepin/pull/2563#pullrequestreview-347508794", "createdAt": "2020-01-23T18:19:10Z", "commit": {"oid": "cd62cc1137a71b221a00b32686fd1cd19efb0bb3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2444, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}