{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwMzExNTU0", "number": 2852, "title": "1884047: Unable to unschedule trigger while deleting job crash during startup (ENT-3129)", "bodyText": "Since original bug was harder to reproduce locally, judging form the exception trace the crash happens around deleteJob() area.\nThis PR has minor update to efficiently unschedule (& delete) quartz jobs using Trigger-keys. Internally unscheduleJobs() is a bulk operation which faster & efficient. We can leverage this as all of our Quartz job are non-durable which means job gets automatically deleted from the scheduler once there are no longer any active triggers associated with it.", "createdAt": "2020-12-01T13:43:59Z", "url": "https://github.com/candlepin/candlepin/pull/2852", "merged": true, "mergeCommit": {"oid": "fd0018573b8ec263be190dd59db615d05ae8afc3"}, "closed": true, "closedAt": "2020-12-02T14:57:53Z", "author": {"login": "wolfdale"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdh7OgngFqTU0MTk4MTU1Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiP1ilgFqTU0MjkxOTk2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxOTgxNTU2", "url": "https://github.com/candlepin/candlepin/pull/2852#pullrequestreview-541981556", "createdAt": "2020-12-01T14:55:49Z", "commit": {"oid": "084046bd64d3ecb9e47a8654e4e8857d6dabc2f1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNDo1NTo0OVrOH8wvcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNDo1NjoyOFrOH8wxnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ3NTE4Ng==", "bodyText": "jobTrigger should be plural, since it's a collection.", "url": "https://github.com/candlepin/candlepin/pull/2852#discussion_r533475186", "createdAt": "2020-12-01T14:55:49Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/async/JobManager.java", "diffHunk": "@@ -912,8 +912,16 @@ private void synchronizeJobSchedule() throws SchedulerException {\n \n         // Unschedule dead/invalid jobs\n         for (JobKey key : unschedule) {\n-            this.scheduler.deleteJob(key);\n-            log.info(\"Removed existing schedule for job: {}\", key.getName());\n+            List<Trigger> jobTrigger = (List<Trigger>) this.scheduler.getTriggersOfJob(key);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "084046bd64d3ecb9e47a8654e4e8857d6dabc2f1"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ3NTc0Mw==", "bodyText": "We should have a contingency here in the event jobTriggers is empty. In such a case, we'll have a job key associated with nothing, and that should get cleaned up appropriately.", "url": "https://github.com/candlepin/candlepin/pull/2852#discussion_r533475743", "createdAt": "2020-12-01T14:56:28Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/async/JobManager.java", "diffHunk": "@@ -912,8 +912,16 @@ private void synchronizeJobSchedule() throws SchedulerException {\n \n         // Unschedule dead/invalid jobs\n         for (JobKey key : unschedule) {\n-            this.scheduler.deleteJob(key);\n-            log.info(\"Removed existing schedule for job: {}\", key.getName());\n+            List<Trigger> jobTrigger = (List<Trigger>) this.scheduler.getTriggersOfJob(key);\n+\n+            if (!jobTrigger.isEmpty()) {\n+                this.scheduler.unscheduleJobs(jobTrigger\n+                    .stream()\n+                    .map(Trigger::getKey)\n+                    .collect(Collectors.toList()));\n+                log.info(\"Removed existing schedule for job: {}\", key.getName());\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "084046bd64d3ecb9e47a8654e4e8857d6dabc2f1"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d4b9601ebf2b489ec2c94d6d77d601116e91986", "author": {"user": {"login": "wolfdale", "name": "Prakhar Gupta"}}, "url": "https://github.com/candlepin/candlepin/commit/2d4b9601ebf2b489ec2c94d6d77d601116e91986", "committedDate": "2020-12-02T06:39:54Z", "message": "1884047: Unable to unschedule trigger while deleting job during startup (ENT-3129)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "084046bd64d3ecb9e47a8654e4e8857d6dabc2f1", "author": {"user": {"login": "wolfdale", "name": "Prakhar Gupta"}}, "url": "https://github.com/candlepin/candlepin/commit/084046bd64d3ecb9e47a8654e4e8857d6dabc2f1", "committedDate": "2020-12-01T13:29:14Z", "message": "1884047: Unable to unschedule trigger while deleting job during startup (ENT-3129)"}, "afterCommit": {"oid": "2d4b9601ebf2b489ec2c94d6d77d601116e91986", "author": {"user": {"login": "wolfdale", "name": "Prakhar Gupta"}}, "url": "https://github.com/candlepin/candlepin/commit/2d4b9601ebf2b489ec2c94d6d77d601116e91986", "committedDate": "2020-12-02T06:39:54Z", "message": "1884047: Unable to unschedule trigger while deleting job during startup (ENT-3129)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyOTE5OTYz", "url": "https://github.com/candlepin/candlepin/pull/2852#pullrequestreview-542919963", "createdAt": "2020-12-02T14:57:43Z", "commit": {"oid": "2d4b9601ebf2b489ec2c94d6d77d601116e91986"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2257, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}