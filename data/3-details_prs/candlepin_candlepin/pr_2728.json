{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2Mzg1MzY5", "number": 2728, "title": "[Bug 1844258]: Job Manager Logging Format Changes for Splunk (ENT-2480)", "bodyText": "Added the job key to the log context (MDC)\nChanges related to log format.", "createdAt": "2020-06-18T10:41:25Z", "url": "https://github.com/candlepin/candlepin/pull/2728", "merged": true, "mergeCommit": {"oid": "6c04426b5504037ae23c4989cbd415d769aa3a48"}, "closed": true, "closedAt": "2020-06-19T13:19:09Z", "author": {"login": "wolfdale"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsd9b1AFqTQzMzI0NjA4Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsy69QAFqTQzNDA2OTkyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMjQ2MDg3", "url": "https://github.com/candlepin/candlepin/pull/2728#pullrequestreview-433246087", "createdAt": "2020-06-18T12:47:05Z", "commit": {"oid": "8ca73f3ee33fcf39c2f73d566184e2cd9dba0902"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxMjo0NzowNlrOGltrVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxMjo1Mjo0OFrOGlt5Yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE5ODg2OA==", "bodyText": "For the displayed value, we want to use snake case, so \"job_key\" here is more appropriate.", "url": "https://github.com/candlepin/candlepin/pull/2728#discussion_r442198868", "createdAt": "2020-06-18T12:47:06Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/async/JobManager.java", "diffHunk": "@@ -1293,6 +1295,9 @@ private void setupJobRuntimeEnvironment(AsyncJobStatus status) {\n         MDC.put(MDC_REQUEST_TYPE_KEY, \"job\");\n         MDC.put(MDC_REQUEST_UUID_KEY, status.getId());\n \n+        MDC.put(MDC_REQUEST_SUB_TYPE_KEY, \"jobKey\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ca73f3ee33fcf39c2f73d566184e2cd9dba0902"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIwMjQ2Ng==", "bodyText": "This is going to result in a floating \"=, \" for the majority of log entries. If we're going to use this method for omitting the entry when it's not present, we also need to do that for the separators as well, which is a bit hack.\nWe should look for a better option here, such that we can avoid printing the whole thing if the target variable is empty. All else failing, we can update the logging format here to specify the value separator and the keypair separator, and then inject them ourselves as suggested above.", "url": "https://github.com/candlepin/candlepin/pull/2728#discussion_r442202466", "createdAt": "2020-06-18T12:52:48Z", "author": {"login": "Ceiu"}, "path": "server/src/main/resources/logback.xml", "diffHunk": "@@ -20,7 +20,7 @@\n     <appender name=\"CandlepinAppender\" class=\"ch.qos.logback.core.rolling.RollingFileAppender\">\n         <file>${LOG_DIR}/candlepin.log</file>\n         <encoder>\n-            <pattern>%d{ISO8601} [thread=%thread] [%X{requestType}=%X{requestUuid}, org=%X{org}, csid=%X{csid}] %-5p %c - %m%n</pattern>\n+            <pattern>%d{ISO8601} [thread=%thread] [%X{requestType}=%X{requestUuid}, %X{requestSubType}=%X{requestName}, org=%X{org}, csid=%X{csid}] %-5p %c - %m%n</pattern>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ca73f3ee33fcf39c2f73d566184e2cd9dba0902"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ca73f3ee33fcf39c2f73d566184e2cd9dba0902", "author": {"user": {"login": "wolfdale", "name": "Prakhar Gupta"}}, "url": "https://github.com/candlepin/candlepin/commit/8ca73f3ee33fcf39c2f73d566184e2cd9dba0902", "committedDate": "2020-06-18T10:36:18Z", "message": "1844258: Job Manager Logging Format Changes for Splunk"}, "afterCommit": {"oid": "88e56a51bc860a9df97f1f868e4e2f0587ec2610", "author": {"user": {"login": "wolfdale", "name": "Prakhar Gupta"}}, "url": "https://github.com/candlepin/candlepin/commit/88e56a51bc860a9df97f1f868e4e2f0587ec2610", "committedDate": "2020-06-18T15:18:08Z", "message": "1844258: Job Manager Logging Format Changes for Splunk"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNDA0MDk0", "url": "https://github.com/candlepin/candlepin/pull/2728#pullrequestreview-433404094", "createdAt": "2020-06-18T15:32:52Z", "commit": {"oid": "88e56a51bc860a9df97f1f868e4e2f0587ec2610"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNTozMjo1MlrOGl02Bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNTozNToxNFrOGl08tQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMxNjI5NQ==", "bodyText": "Looks like a refactor artifact here.", "url": "https://github.com/candlepin/candlepin/pull/2728#discussion_r442316295", "createdAt": "2020-06-18T15:32:52Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/async/JobManager.java", "diffHunk": "@@ -1197,7 +1198,7 @@ public AsyncJobStatus executeJob(JobMessage message) throws JobException {\n         // rather than failing directly. This would allow use of aliases and explicit job\n         // classes.\n         if (jobClass == null) {\n-            String errmsg = String.format(\"No registered job class for job: %s\", status.getJobKey());\n+            String errmsg = String.format(\"No registered job class for jobKey=%s\", status.getJobKey());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e56a51bc860a9df97f1f868e4e2f0587ec2610"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMxNjk1Mw==", "bodyText": "No space between the final } and the org=. If we have it in there, you get a double space between org and the preceding value.", "url": "https://github.com/candlepin/candlepin/pull/2728#discussion_r442316953", "createdAt": "2020-06-18T15:33:41Z", "author": {"login": "Ceiu"}, "path": "server/src/main/resources/logback.xml", "diffHunk": "@@ -20,7 +20,7 @@\n     <appender name=\"CandlepinAppender\" class=\"ch.qos.logback.core.rolling.RollingFileAppender\">\n         <file>${LOG_DIR}/candlepin.log</file>\n         <encoder>\n-            <pattern>%d{ISO8601} [thread=%thread] [%X{requestType}=%X{requestUuid}, org=%X{org}, csid=%X{csid}] %-5p %c - %m%n</pattern>\n+            <pattern>%d{ISO8601} [thread=%thread] [%X{requestType}=%X{requestUuid}, %replace(job_key=%X{jobKey}, ){'job_key=, ', ''} org=%X{org}, csid=%X{csid}] %-5p %c - %m%n</pattern>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e56a51bc860a9df97f1f868e4e2f0587ec2610"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMxODAwNQ==", "bodyText": "MDC_JOB_KEY_KEY\nThe name sounds a bit silly and redundant, but it is the key for the job key.", "url": "https://github.com/candlepin/candlepin/pull/2728#discussion_r442318005", "createdAt": "2020-06-18T15:35:14Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/async/JobManager.java", "diffHunk": "@@ -93,6 +93,7 @@\n \n     private static final String MDC_REQUEST_TYPE_KEY = \"requestType\";\n     private static final String MDC_REQUEST_UUID_KEY = \"requestUuid\";\n+    private static final String MDC_REQUEST_JOB_KEY = \"jobKey\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88e56a51bc860a9df97f1f868e4e2f0587ec2610"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "88e56a51bc860a9df97f1f868e4e2f0587ec2610", "author": {"user": {"login": "wolfdale", "name": "Prakhar Gupta"}}, "url": "https://github.com/candlepin/candlepin/commit/88e56a51bc860a9df97f1f868e4e2f0587ec2610", "committedDate": "2020-06-18T15:18:08Z", "message": "1844258: Job Manager Logging Format Changes for Splunk"}, "afterCommit": {"oid": "cb27a0f8a23f5a85c286f1237546ae89b14b6565", "author": {"user": {"login": "wolfdale", "name": "Prakhar Gupta"}}, "url": "https://github.com/candlepin/candlepin/commit/cb27a0f8a23f5a85c286f1237546ae89b14b6565", "committedDate": "2020-06-18T15:44:50Z", "message": "1844258: Job Manager Logging Format Changes for Splunk"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNDI5Mzgw", "url": "https://github.com/candlepin/candlepin/pull/2728#pullrequestreview-433429380", "createdAt": "2020-06-18T16:00:29Z", "commit": {"oid": "cb27a0f8a23f5a85c286f1237546ae89b14b6565"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNjowMDoyOVrOGl2Arw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxNjowMDoyOVrOGl2Arw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzNTQwNw==", "bodyText": "I'm guessing the intent here is to make this particular line searchable as part of the same log query? If so, changing the message isn't the way to go here. This block can safely live in the try block below immediately following the setupJobRuntimeEnvironment call (with proper whitespace).\nI also noticed a bug unrelated to your code in the log message below regarding job instantiation. We can fix that here as well:\n        try {\n            this.setupJobRuntimeEnvironment(status);\n\n            // Maybe in this case it'd be better to attempt to use the job key as the job class\n            // rather than failing directly. This would allow use of aliases and explicit job\n            // classes.\n            Class<? extends AsyncJob> jobClass = getJobClass(status.getJobKey());\n            if (jobClass == null) {\n                String errmsg = String.format(\"No registered job class for job: %s\", status.getJobKey());\n\n                this.updateJobStatus(status, JobState.FAILED, errmsg);\n\n                log.error(errmsg);\n                throw new JobInitializationException(errmsg, true);\n            }\n\n            EventSink eventSink = injector.getInstance(EventSink.class);\n            AsyncJob job = injector.getInstance(jobClass);\n\n            if (job == null) {\n                String errmsg = String.format(\"Unable to instantiate job class \\\"%s\\\" for job: %s\",\n                    jobClass.getName(), status.getJobKey());\n\n                log.error(errmsg);\n                throw new JobInitializationException(errmsg);\n            }", "url": "https://github.com/candlepin/candlepin/pull/2728#discussion_r442335407", "createdAt": "2020-06-18T16:00:29Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/async/JobManager.java", "diffHunk": "@@ -1197,7 +1198,7 @@ public AsyncJobStatus executeJob(JobMessage message) throws JobException {\n         // rather than failing directly. This would allow use of aliases and explicit job\n         // classes.\n         if (jobClass == null) {\n-            String errmsg = String.format(\"No registered job class for job: %s\", status.getJobKey());\n+            String errmsg = String.format(\"No registered job class for job_key=%s\", status.getJobKey());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb27a0f8a23f5a85c286f1237546ae89b14b6565"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "942c5c3d495e00b1e1e73a47dad39f1e40687cb3", "author": {"user": {"login": "wolfdale", "name": "Prakhar Gupta"}}, "url": "https://github.com/candlepin/candlepin/commit/942c5c3d495e00b1e1e73a47dad39f1e40687cb3", "committedDate": "2020-06-19T05:41:44Z", "message": "1844258: Job Manager Logging Format Changes for Splunk"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cb27a0f8a23f5a85c286f1237546ae89b14b6565", "author": {"user": {"login": "wolfdale", "name": "Prakhar Gupta"}}, "url": "https://github.com/candlepin/candlepin/commit/cb27a0f8a23f5a85c286f1237546ae89b14b6565", "committedDate": "2020-06-18T15:44:50Z", "message": "1844258: Job Manager Logging Format Changes for Splunk"}, "afterCommit": {"oid": "942c5c3d495e00b1e1e73a47dad39f1e40687cb3", "author": {"user": {"login": "wolfdale", "name": "Prakhar Gupta"}}, "url": "https://github.com/candlepin/candlepin/commit/942c5c3d495e00b1e1e73a47dad39f1e40687cb3", "committedDate": "2020-06-19T05:41:44Z", "message": "1844258: Job Manager Logging Format Changes for Splunk"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MDY5OTIy", "url": "https://github.com/candlepin/candlepin/pull/2728#pullrequestreview-434069922", "createdAt": "2020-06-19T13:18:24Z", "commit": {"oid": "942c5c3d495e00b1e1e73a47dad39f1e40687cb3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2428, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}