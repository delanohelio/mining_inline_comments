{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwNTI0NTgz", "number": 2600, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwOToyMzoyM1rODc6DmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMDowNjo1NFrODgVTxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNjM3OTEyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/candlepin/resteasy/filter/VerifyAuthorizationFilter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwOToyMzoyM1rOFlNCqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNToyMTozMVrOFlYE8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1NTMwNA==", "bodyText": "locatorMap is no longer used.", "url": "https://github.com/candlepin/candlepin/pull/2600#discussion_r374555304", "createdAt": "2020-02-04T09:23:23Z", "author": {"login": "Januson"}, "path": "server/src/main/java/org/candlepin/resteasy/filter/VerifyAuthorizationFilter.java", "diffHunk": "@@ -65,6 +65,7 @@\n @Priority(Priorities.AUTHORIZATION)\n public class VerifyAuthorizationFilter extends AbstractAuthorizationFilter {\n     private static final Logger log = LoggerFactory.getLogger(VerifyAuthorizationFilter.class);\n+\n     private StoreFactory storeFactory;\n     private ResourceLocatorMap locatorMap;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17ecbe3781241d28f693a8c404a5eb061730225a"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDczNjExMw==", "bodyText": "Fixed. Removed this line and the entire ResourceLocatorMap file.", "url": "https://github.com/candlepin/candlepin/pull/2600#discussion_r374736113", "createdAt": "2020-02-04T15:21:31Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/resteasy/filter/VerifyAuthorizationFilter.java", "diffHunk": "@@ -65,6 +65,7 @@\n @Priority(Priorities.AUTHORIZATION)\n public class VerifyAuthorizationFilter extends AbstractAuthorizationFilter {\n     private static final Logger log = LoggerFactory.getLogger(VerifyAuthorizationFilter.class);\n+\n     private StoreFactory storeFactory;\n     private ResourceLocatorMap locatorMap;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1NTMwNA=="}, "originalCommit": {"oid": "17ecbe3781241d28f693a8c404a5eb061730225a"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNjM4MTA2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/candlepin/resteasy/filter/CandlepinQueryInterceptor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwOToyMzo1OVrOFlNDyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNToyMTozNVrOFlYFHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1NTU5Mw==", "bodyText": "Forgotten commented code.", "url": "https://github.com/candlepin/candlepin/pull/2600#discussion_r374555593", "createdAt": "2020-02-04T09:23:59Z", "author": {"login": "Januson"}, "path": "server/src/main/java/org/candlepin/resteasy/filter/CandlepinQueryInterceptor.java", "diffHunk": "@@ -64,45 +65,78 @@ public CandlepinQueryInterceptor(\n      * @return a newly opened session\n      */\n     protected Session openSession() {\n-        final Session currentSession = (Session) this.emProvider.get().getDelegate();\n-        final SessionFactory factory = currentSession.getSessionFactory();\n+        Session currentSession = (Session) this.emProvider.get().getDelegate();\n+        SessionFactory factory = currentSession.getSessionFactory();\n \n         return factory.openSession();\n     }\n \n     @Override\n-    public void postProcess(ServerResponse response) {\n-        final Object entity = response.getEntity();\n+    public void filter(ContainerRequestContext requestContext, ContainerResponseContext responseContext) {\n+        Object entity = responseContext.getEntity();\n \n         if (entity instanceof CandlepinQuery) {\n-            final PageRequest pageRequest = ResteasyProviderFactory.getContextData(PageRequest.class);\n-            final Session session = this.openSession();\n+            PageRequest pageRequest = ResteasyContext.getContextData(PageRequest.class);\n+            Session session = this.openSession();\n+\n             try {\n-                final CandlepinQuery query = (CandlepinQuery) entity;\n+                CandlepinQuery query = (CandlepinQuery) entity;\n \n                 // Use a separate session so we aren't at risk of lazy loading or interceptors closing\n                 // our cursor mid-stream.\n                 query.useSession(session);\n \n                 // Apply any paging config we may have\n-                applyPaging(pageRequest, query);\n+                this.applyPaging(pageRequest, query);\n \n                 // Set the output streamer that will stream our query result\n-                response.setEntity(buildOutputStreamer(session, query));\n+                responseContext.setEntity(this.buildOutputStreamer(session, query));\n             }\n-            catch (final RuntimeException e) {\n+            catch (RuntimeException e) {\n                 if (session != null) {\n                     session.close();\n                 }\n+\n                 throw e;\n             }\n+\n         }\n     }\n \n+    // @Override", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17ecbe3781241d28f693a8c404a5eb061730225a"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDczNjE1Nw==", "bodyText": "Removed", "url": "https://github.com/candlepin/candlepin/pull/2600#discussion_r374736157", "createdAt": "2020-02-04T15:21:35Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/resteasy/filter/CandlepinQueryInterceptor.java", "diffHunk": "@@ -64,45 +65,78 @@ public CandlepinQueryInterceptor(\n      * @return a newly opened session\n      */\n     protected Session openSession() {\n-        final Session currentSession = (Session) this.emProvider.get().getDelegate();\n-        final SessionFactory factory = currentSession.getSessionFactory();\n+        Session currentSession = (Session) this.emProvider.get().getDelegate();\n+        SessionFactory factory = currentSession.getSessionFactory();\n \n         return factory.openSession();\n     }\n \n     @Override\n-    public void postProcess(ServerResponse response) {\n-        final Object entity = response.getEntity();\n+    public void filter(ContainerRequestContext requestContext, ContainerResponseContext responseContext) {\n+        Object entity = responseContext.getEntity();\n \n         if (entity instanceof CandlepinQuery) {\n-            final PageRequest pageRequest = ResteasyProviderFactory.getContextData(PageRequest.class);\n-            final Session session = this.openSession();\n+            PageRequest pageRequest = ResteasyContext.getContextData(PageRequest.class);\n+            Session session = this.openSession();\n+\n             try {\n-                final CandlepinQuery query = (CandlepinQuery) entity;\n+                CandlepinQuery query = (CandlepinQuery) entity;\n \n                 // Use a separate session so we aren't at risk of lazy loading or interceptors closing\n                 // our cursor mid-stream.\n                 query.useSession(session);\n \n                 // Apply any paging config we may have\n-                applyPaging(pageRequest, query);\n+                this.applyPaging(pageRequest, query);\n \n                 // Set the output streamer that will stream our query result\n-                response.setEntity(buildOutputStreamer(session, query));\n+                responseContext.setEntity(this.buildOutputStreamer(session, query));\n             }\n-            catch (final RuntimeException e) {\n+            catch (RuntimeException e) {\n                 if (session != null) {\n                     session.close();\n                 }\n+\n                 throw e;\n             }\n+\n         }\n     }\n \n+    // @Override", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1NTU5Mw=="}, "originalCommit": {"oid": "17ecbe3781241d28f693a8c404a5eb061730225a"}, "originalPosition": 84}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxNjM5MzY2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/candlepin/resteasy/filter/VerifyAuthorizationFilter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwOToyNzozMVrOFlNLUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNTozODoyNFrOFlYwTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1NzUyMQ==", "bodyText": "This could be enhanced for", "url": "https://github.com/candlepin/candlepin/pull/2600#discussion_r374557521", "createdAt": "2020-02-04T09:27:31Z", "author": {"login": "Januson"}, "path": "server/src/main/java/org/candlepin/resteasy/filter/VerifyAuthorizationFilter.java", "diffHunk": "@@ -111,39 +110,79 @@ public void runFilter(ContainerRequestContext requestContext) {\n         }\n     }\n \n-    protected Map<Verify, Object> getArguments(HttpRequest request, Method method) {\n-        ResteasyProviderFactory resourceFactory = ResteasyProviderFactory.getInstance();\n-        InjectorFactory injectorFactory = resourceFactory.getInjectorFactory();\n+    /**\n+     * Fetches the arguments for parameters flagged with the Verify annotation from the request\n+     * context. If the method does not have any Verify-annotated parameters, this method returns\n+     * an empty map.\n+     *\n+     * @param requestContext\n+     *  the context data for the request\n+     *\n+     * @param method\n+     *  the method handling the request\n+     *\n+     * @return\n+     *  a mapping of verify annotations to their respective arguments\n+     */\n+    protected Map<Verify, Object> getArguments(ContainerRequestContext requestContext, Method method) {\n+\n+        // LinkedHashMap preserves insertion order\n+        Map<Verify, Object> argMap = new LinkedHashMap<>();\n \n-        ResourceLocator locator = locatorMap.get(method);\n+        Annotation[][] annotations = annotationLocator.getParameterAnnotations(method);\n \n-        if (null == locator) {\n-            throw new IseException(\"Method \" + method.getName() + \" not registered as RESTful.\");\n-        }\n+        Map<String, List<String>> pathParams = null;\n+        Map<String, List<String>> queryParams = null;\n+        Map<String, List<String>> headers = null;\n \n-        MethodInjector methodInjector = injectorFactory.createMethodInjector(locator, resourceFactory);\n-        HttpResponse response = ResteasyProviderFactory.popContextData(HttpResponse.class);\n-        Object[] args = methodInjector.injectArguments(request, response);\n+        for (int i = 0; i < annotations.length; ++i) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17ecbe3781241d28f693a8c404a5eb061730225a"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc0NzIxNQ==", "bodyText": "I suppose, but this was something that was pre-existing that would get (immeasurably) slower by a change, so I opted to just leave it as-is.", "url": "https://github.com/candlepin/candlepin/pull/2600#discussion_r374747215", "createdAt": "2020-02-04T15:38:24Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/resteasy/filter/VerifyAuthorizationFilter.java", "diffHunk": "@@ -111,39 +110,79 @@ public void runFilter(ContainerRequestContext requestContext) {\n         }\n     }\n \n-    protected Map<Verify, Object> getArguments(HttpRequest request, Method method) {\n-        ResteasyProviderFactory resourceFactory = ResteasyProviderFactory.getInstance();\n-        InjectorFactory injectorFactory = resourceFactory.getInjectorFactory();\n+    /**\n+     * Fetches the arguments for parameters flagged with the Verify annotation from the request\n+     * context. If the method does not have any Verify-annotated parameters, this method returns\n+     * an empty map.\n+     *\n+     * @param requestContext\n+     *  the context data for the request\n+     *\n+     * @param method\n+     *  the method handling the request\n+     *\n+     * @return\n+     *  a mapping of verify annotations to their respective arguments\n+     */\n+    protected Map<Verify, Object> getArguments(ContainerRequestContext requestContext, Method method) {\n+\n+        // LinkedHashMap preserves insertion order\n+        Map<Verify, Object> argMap = new LinkedHashMap<>();\n \n-        ResourceLocator locator = locatorMap.get(method);\n+        Annotation[][] annotations = annotationLocator.getParameterAnnotations(method);\n \n-        if (null == locator) {\n-            throw new IseException(\"Method \" + method.getName() + \" not registered as RESTful.\");\n-        }\n+        Map<String, List<String>> pathParams = null;\n+        Map<String, List<String>> queryParams = null;\n+        Map<String, List<String>> headers = null;\n \n-        MethodInjector methodInjector = injectorFactory.createMethodInjector(locator, resourceFactory);\n-        HttpResponse response = ResteasyProviderFactory.popContextData(HttpResponse.class);\n-        Object[] args = methodInjector.injectArguments(request, response);\n+        for (int i = 0; i < annotations.length; ++i) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1NzUyMQ=="}, "originalCommit": {"oid": "17ecbe3781241d28f693a8c404a5eb061730225a"}, "originalPosition": 100}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1MjMwMTQ5OnYy", "diffSide": "RIGHT", "path": "server/pom.xml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMDowNjo1NFrOFqeyJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMDowNjo1NFrOFqeyJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDA4ODg2OQ==", "bodyText": "This is more relevant to the spec-first branch/feature than to this, but shouldn't this have a version here? Do/Should we declare the api as a maven module?", "url": "https://github.com/candlepin/candlepin/pull/2600#discussion_r380088869", "createdAt": "2020-02-17T10:06:54Z", "author": {"login": "nikosmoum"}, "path": "server/pom.xml", "diffHunk": "@@ -197,6 +197,18 @@\n         </exclusion>\n       </exclusions>\n     </dependency>\n+    <dependency>\n+      <groupId>org.candlepin</groupId>\n+      <artifactId>api</artifactId>\n+      <version>unspecified</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17d65ec61d8f1760fbdedbfeb5f85b4fc2eb3afa"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4287, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}