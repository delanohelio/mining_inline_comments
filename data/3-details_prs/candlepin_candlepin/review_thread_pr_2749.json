{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2ODAxODcz", "number": 2749, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QyMDozNjozMVrOEN-y1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNDo1Mzo1NFrOEcG77w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMDk1NzY3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/candlepin/model/EntitlementCurator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QyMDozNjozMVrOGw45fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwOTozMTozOVrOG0v7Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkxNzA1NQ==", "bodyText": "If we're going to be using this lookup for paging, we need the query itself to be ordered, and we cannot use a set (as its ordering is not guaranteed either).\nThe entire criteria usage itself likely needs to be axed here.", "url": "https://github.com/candlepin/candlepin/pull/2749#discussion_r453917055", "createdAt": "2020-07-13T20:36:31Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/model/EntitlementCurator.java", "diffHunk": "@@ -437,27 +440,69 @@ private String sanitizeMatchesFilter(String matches) {\n             List<String> entitlementIds = criteria.list();\n \n             if (entitlementIds != null && !entitlementIds.isEmpty()) {\n-                criteria = this.currentSession()\n-                    .createCriteria(Entitlement.class)\n-                    .add(CPRestrictions.in(\"id\", entitlementIds));\n-\n-                entitlementsPage = listByCriteria(criteria, pageRequest);\n+                entitlementsPage = createPage(findEntitlements(entitlementIds), pageRequest);\n             }\n             else {\n                 entitlementsPage = new Page<>();\n-                entitlementsPage.setPageData(Collections.<Entitlement>emptyList());\n+                entitlementsPage.setPageData(Collections.emptyList());\n                 entitlementsPage.setMaxRecords(0);\n             }\n         }\n-\n         return entitlementsPage;\n     }\n \n+    private Set<Entitlement> findEntitlements(List<String> entitlementIds) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5112312c57dac9b5e7ae517fb70ee2aea59aca99"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzk2NDMyNg==", "bodyText": "Done.", "url": "https://github.com/candlepin/candlepin/pull/2749#discussion_r457964326", "createdAt": "2020-07-21T09:31:39Z", "author": {"login": "Januson"}, "path": "server/src/main/java/org/candlepin/model/EntitlementCurator.java", "diffHunk": "@@ -437,27 +440,69 @@ private String sanitizeMatchesFilter(String matches) {\n             List<String> entitlementIds = criteria.list();\n \n             if (entitlementIds != null && !entitlementIds.isEmpty()) {\n-                criteria = this.currentSession()\n-                    .createCriteria(Entitlement.class)\n-                    .add(CPRestrictions.in(\"id\", entitlementIds));\n-\n-                entitlementsPage = listByCriteria(criteria, pageRequest);\n+                entitlementsPage = createPage(findEntitlements(entitlementIds), pageRequest);\n             }\n             else {\n                 entitlementsPage = new Page<>();\n-                entitlementsPage.setPageData(Collections.<Entitlement>emptyList());\n+                entitlementsPage.setPageData(Collections.emptyList());\n                 entitlementsPage.setMaxRecords(0);\n             }\n         }\n-\n         return entitlementsPage;\n     }\n \n+    private Set<Entitlement> findEntitlements(List<String> entitlementIds) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzkxNzA1NQ=="}, "originalCommit": {"oid": "5112312c57dac9b5e7ae517fb70ee2aea59aca99"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1ODkyODIyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/candlepin/model/EntitlementCurator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNDoyNTo1MVrOG06khg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNDoyNTo1MVrOG06khg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEzODc1OA==", "bodyText": "If we're requiring a list as input, we could use .sublist instead of streaming and collecting.", "url": "https://github.com/candlepin/candlepin/pull/2749#discussion_r458138758", "createdAt": "2020-07-21T14:25:51Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/model/EntitlementCurator.java", "diffHunk": "@@ -437,27 +437,61 @@ private String sanitizeMatchesFilter(String matches) {\n             List<String> entitlementIds = criteria.list();\n \n             if (entitlementIds != null && !entitlementIds.isEmpty()) {\n-                criteria = this.currentSession()\n-                    .createCriteria(Entitlement.class)\n-                    .add(CPRestrictions.in(\"id\", entitlementIds));\n+                entitlementsPage = createPage(this.findEntitlements(entitlementIds), pageRequest);\n \n-                entitlementsPage = listByCriteria(criteria, pageRequest);\n             }\n             else {\n                 entitlementsPage = new Page<>();\n-                entitlementsPage.setPageData(Collections.<Entitlement>emptyList());\n+                entitlementsPage.setPageData(Collections.emptyList());\n                 entitlementsPage.setMaxRecords(0);\n             }\n         }\n-\n         return entitlementsPage;\n     }\n \n+    private List<Entitlement> findEntitlements(Iterable<String> entitlementIds) {\n+        String queryStr = \"SELECT e \" +\n+            \"FROM Entitlement e \" +\n+            \"WHERE e.id IN (:entitlement_ids) \" +\n+            \"ORDER BY e.id\";\n+\n+        Query query = getEntityManager().createQuery(queryStr, Entitlement.class);\n+        List<Entitlement> result = new LinkedList<>();\n+        if (entitlementIds == null || !entitlementIds.iterator().hasNext()) {\n+            return result;\n+        }\n+\n+        int blockSize = Math.min(this.getInBlockSize(), this.getQueryParameterLimit() / 2);\n+        for (List<String> block : Iterables.partition(entitlementIds, blockSize)) {\n+            result.addAll(query.setParameter(\"entitlement_ids\", block).getResultList());\n+        }\n+        return result;\n+    }\n+\n+    private Page<List<Entitlement>> createPage(List<Entitlement> entitlements, PageRequest pageRequest) {\n+        Page<List<Entitlement>> page = new Page<>();\n+        if (pageRequest != null) {\n+            int start = (pageRequest.getPage() - 1) * pageRequest.getPerPage();\n+            List<Entitlement> currentPage = entitlements.stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "825d0f256a6c2042077e48c874c108c695ae6763"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1ODk2NDc2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/candlepin/model/EntitlementCurator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNDozMzoxOFrOG067pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNDozMzoxOFrOG067pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE0NDY3OQ==", "bodyText": "We're still broken here (and, for the record, we were broken before): as soon as we re-query here, we lose any sorting from the pageRequest unless we pass the same sorting params through.\nAdditionally, if we're going to keep the multi-query behavior, we should use this as an opportunity to not query the entire set of entitlements, and only grab the entitlements from the block of IDs we're going to fetch.", "url": "https://github.com/candlepin/candlepin/pull/2749#discussion_r458144679", "createdAt": "2020-07-21T14:33:18Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/model/EntitlementCurator.java", "diffHunk": "@@ -437,27 +437,61 @@ private String sanitizeMatchesFilter(String matches) {\n             List<String> entitlementIds = criteria.list();\n \n             if (entitlementIds != null && !entitlementIds.isEmpty()) {\n-                criteria = this.currentSession()\n-                    .createCriteria(Entitlement.class)\n-                    .add(CPRestrictions.in(\"id\", entitlementIds));\n+                entitlementsPage = createPage(this.findEntitlements(entitlementIds), pageRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "825d0f256a6c2042077e48c874c108c695ae6763"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3OTA5MjMxOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/candlepin/model/AbstractHibernateCurator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNDo1Mzo1NFrOHGcCQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNDo1Mzo1NFrOHGcCQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjUxMjgzMw==", "bodyText": "This isn't quite right. If the query coming in is filtered at all, the max records value won't line up with the maximum number of rows for the query being executed.", "url": "https://github.com/candlepin/candlepin/pull/2749#discussion_r476512833", "createdAt": "2020-08-25T14:53:54Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/model/AbstractHibernateCurator.java", "diffHunk": "@@ -563,6 +601,25 @@ protected Criterion getSecureCriteriaRestrictions(Class entityClass) {\n         return page;\n     }\n \n+    @Transactional\n+    public Page<List<E>> listByCriteria(Root<E> root, CriteriaQuery<E> criteria, PageRequest pageRequest) {\n+        Page<List<E>> page = new Page<>();\n+        if (pageRequest != null) {\n+            criteria.orderBy(createPagingOrder(root, pageRequest));\n+            // TODO page should store long\n+            page.setMaxRecords(this.findRowCount().intValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "217a07c0571b0dd4f8658595ba3dd9fb37b047f7"}, "originalPosition": 74}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4043, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}