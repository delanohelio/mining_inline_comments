{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5OTk5NDMw", "number": 2736, "title": "1847879: Artemis errors while trying to send events during hypervisor update job (ENT-2529)", "bodyText": "Changes -\n\nAdded a check to open the session on-demand if it is closed for while queuing messages.\nHardened sendMessages & cancelMessages methods to allow execution only if AMQ session is open.", "createdAt": "2020-06-25T12:51:08Z", "url": "https://github.com/candlepin/candlepin/pull/2736", "merged": true, "mergeCommit": {"oid": "63d1bc1948a133d49b07494ab8b5e61275f8ffa3"}, "closed": true, "closedAt": "2020-06-30T13:47:13Z", "author": {"login": "wolfdale"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcu9IEKgBqjM0ODUyNTE0ODE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwV4uqgFqTQ0MDAyODgyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da630e615b1599a1aabc6bda78de679cb28560ef", "author": {"user": {"login": "wolfdale", "name": "Prakhar Gupta"}}, "url": "https://github.com/candlepin/candlepin/commit/da630e615b1599a1aabc6bda78de679cb28560ef", "committedDate": "2020-06-25T12:47:24Z", "message": "1847879: Artemis errors while trying to send events during hypervisor update job"}, "afterCommit": {"oid": "a28b932db68186cca97be099893bedbf2af8bcec", "author": {"user": {"login": "wolfdale", "name": "Prakhar Gupta"}}, "url": "https://github.com/candlepin/candlepin/commit/a28b932db68186cca97be099893bedbf2af8bcec", "committedDate": "2020-06-26T06:03:07Z", "message": "1847879: Artemis errors while trying to send events during hypervisor update job"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a28b932db68186cca97be099893bedbf2af8bcec", "author": {"user": {"login": "wolfdale", "name": "Prakhar Gupta"}}, "url": "https://github.com/candlepin/candlepin/commit/a28b932db68186cca97be099893bedbf2af8bcec", "committedDate": "2020-06-26T06:03:07Z", "message": "1847879: Artemis errors while trying to send events during hypervisor update job"}, "afterCommit": {"oid": "c1fc008101e8095d7bdef8595028db1ebba4df06", "author": {"user": {"login": "wolfdale", "name": "Prakhar Gupta"}}, "url": "https://github.com/candlepin/candlepin/commit/c1fc008101e8095d7bdef8595028db1ebba4df06", "committedDate": "2020-06-26T06:19:27Z", "message": "1847879: Artemis errors while trying to send events during hypervisor update job"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4MzAwNjQx", "url": "https://github.com/candlepin/candlepin/pull/2736#pullrequestreview-438300641", "createdAt": "2020-06-26T13:35:49Z", "commit": {"oid": "c1fc008101e8095d7bdef8595028db1ebba4df06"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMzozNTo0OVrOGphJdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMzozNTo0OVrOGphJdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE4Nzg5Mw==", "bodyText": "This works, but is still breaking the encapsulation open to accomplish the goal. The purpose of the EventMessageSender is to be our abstraction layer for managing the session, so we should avoid spinning up a new one to do the work it should be doing. From the other change in this code, it appears you've already spotted the downside in doing it this way: you need to do the close check in every operation; making the session management exist in three places, rather than one.\nHowever, this does highlight another minor problem with the existing code: EventMessageSender isn't static. The wrapper does not care about the state of its outer class, nor should it ever use it. We don't need the baggage an inner class inherits in such a case, and we should be declaring it statically.", "url": "https://github.com/candlepin/candlepin/pull/2736#discussion_r446187893", "createdAt": "2020-06-26T13:35:49Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/audit/EventSinkImpl.java", "diffHunk": "@@ -127,8 +127,8 @@ public void queueEvent(Event event) {\n \n         try {\n             // Lazily initialize the message sender when the first\n-            // message gets queued.\n-            if (messageSender == null) {\n+            // message gets queued or initialize session if it's closed.\n+            if (messageSender == null || messageSender.session.isClosed()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1fc008101e8095d7bdef8595028db1ebba4df06"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbea6c174ce0fb2c39d1b2311f6b14d93f7c5a48", "author": {"user": {"login": "wolfdale", "name": "Prakhar Gupta"}}, "url": "https://github.com/candlepin/candlepin/commit/fbea6c174ce0fb2c39d1b2311f6b14d93f7c5a48", "committedDate": "2020-06-29T07:04:30Z", "message": "1847879: Artemis errors while trying to send events during hypervisor update job"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c1fc008101e8095d7bdef8595028db1ebba4df06", "author": {"user": {"login": "wolfdale", "name": "Prakhar Gupta"}}, "url": "https://github.com/candlepin/candlepin/commit/c1fc008101e8095d7bdef8595028db1ebba4df06", "committedDate": "2020-06-26T06:19:27Z", "message": "1847879: Artemis errors while trying to send events during hypervisor update job"}, "afterCommit": {"oid": "fbea6c174ce0fb2c39d1b2311f6b14d93f7c5a48", "author": {"user": {"login": "wolfdale", "name": "Prakhar Gupta"}}, "url": "https://github.com/candlepin/candlepin/commit/fbea6c174ce0fb2c39d1b2311f6b14d93f7c5a48", "committedDate": "2020-06-29T07:04:30Z", "message": "1847879: Artemis errors while trying to send events during hypervisor update job"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMDI4ODI1", "url": "https://github.com/candlepin/candlepin/pull/2736#pullrequestreview-440028825", "createdAt": "2020-06-30T13:44:25Z", "commit": {"oid": "fbea6c174ce0fb2c39d1b2311f6b14d93f7c5a48"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2266, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}