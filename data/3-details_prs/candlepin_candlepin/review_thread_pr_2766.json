{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3MTU5NjQ1", "number": 2766, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxMzo1ODowM1rOESZi7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNDowMjozNVrOESZq5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NzI4MzY1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/candlepin/guice/CandlepinContextListener.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxMzo1ODowM1rOG3jreA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNDoxMTowOVrOG3kPjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDkwOTQzMg==", "bodyText": "We should do this after the call to jobManager.shutdown", "url": "https://github.com/candlepin/candlepin/pull/2766#discussion_r460909432", "createdAt": "2020-07-27T13:58:03Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/guice/CandlepinContextListener.java", "diffHunk": "@@ -259,6 +260,8 @@ public void contextDestroyed(ServletContextEvent event) {\n     }\n \n     private void destroySubsystems() throws Exception {\n+        this.waitForArtemisJobThreadsToFinish();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5af4464f01b4398c4dea62a036e9008ec8bd91d7"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDkxODY2OA==", "bodyText": "It was deliberately added before the JobManager.shutdown, because that method calls into these:\n                this.dispatcher.shutdown();\n                this.receiver.shutdown();\n\nand the receiver.shutdown() is actually closing the sessions that these threads use.\nWe don't want to close sessions of threads that are still running, but first wait for the threads to finish", "url": "https://github.com/candlepin/candlepin/pull/2766#discussion_r460918668", "createdAt": "2020-07-27T14:11:09Z", "author": {"login": "nikosmoum"}, "path": "server/src/main/java/org/candlepin/guice/CandlepinContextListener.java", "diffHunk": "@@ -259,6 +260,8 @@ public void contextDestroyed(ServletContextEvent event) {\n     }\n \n     private void destroySubsystems() throws Exception {\n+        this.waitForArtemisJobThreadsToFinish();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDkwOTQzMg=="}, "originalCommit": {"oid": "5af4464f01b4398c4dea62a036e9008ec8bd91d7"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NzMwNDA1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/candlepin/guice/CandlepinContextListener.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNDowMjozNVrOG3j39Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNDoxMjozNFrOG3kTPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDkxMjYyOQ==", "bodyText": "If this is specifically for the job system, we should move this to somewhere that makes a bit more sense. Either in jobManager.shutdown or, and probably best in my opinion, ArtemisContextListener.shutdown (which gets hit automatically via cpmContextListener.shutdown above)", "url": "https://github.com/candlepin/candlepin/pull/2766#discussion_r460912629", "createdAt": "2020-07-27T14:02:35Z", "author": {"login": "Ceiu"}, "path": "server/src/main/java/org/candlepin/guice/CandlepinContextListener.java", "diffHunk": "@@ -291,6 +294,35 @@ private void destroySubsystems() throws Exception {\n         this.loggerListener.contextDestroyed();\n     }\n \n+    private void waitForArtemisJobThreadsToFinish() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5af4464f01b4398c4dea62a036e9008ec8bd91d7"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDkxOTYxNQ==", "bodyText": "Same as above answer, by the time we get to ArtemisContextListener.shutdown, the sessions are already closed. We want the sessions to keep open for the message commits to happen first", "url": "https://github.com/candlepin/candlepin/pull/2766#discussion_r460919615", "createdAt": "2020-07-27T14:12:34Z", "author": {"login": "nikosmoum"}, "path": "server/src/main/java/org/candlepin/guice/CandlepinContextListener.java", "diffHunk": "@@ -291,6 +294,35 @@ private void destroySubsystems() throws Exception {\n         this.loggerListener.contextDestroyed();\n     }\n \n+    private void waitForArtemisJobThreadsToFinish() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDkxMjYyOQ=="}, "originalCommit": {"oid": "5af4464f01b4398c4dea62a036e9008ec8bd91d7"}, "originalPosition": 41}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4052, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}