{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5OTkyMjkw", "number": 703, "title": "Add AMQP nack strategies for the modified delivery state", "bodyText": "Add two new nack strategies to the AMQP connector:\n\nmodified-failed - marking the message modified and incrementing the delivery count (the message may be redelivered to the application)\nmodified-failed-undeliverable-here - marking the message modified, incrementing the delivery count, and indicating the application cannot process the message. The broker cannot redeliver the message to the application.", "createdAt": "2020-08-19T08:02:51Z", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/703", "merged": true, "mergeCommit": {"oid": "593a62272d43ebdcfaea2d04b7733735d9303b45"}, "closed": true, "closedAt": "2020-08-20T05:29:44Z", "author": {"login": "cescoffier"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAXgKfgFqTQ3MDIzNDI3Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAbx0KgBqjM2NzA4MjY2MzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMjM0Mjc3", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/703#pullrequestreview-470234277", "createdAt": "2020-08-19T08:26:11Z", "commit": {"oid": "822dc97f87ad7c75320548a2738502f53dda788e"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwODoyNjoxMlrOHC8tBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwODozNjoxMVrOHC9Epw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg1Mzc2Nw==", "bodyText": "This is using the same log message as the other failure handler. Seems like it should have its own variant, or the message should always indicate both the deliveryFailed and undeliverableHere value, with the latter passed in, otherwise it would be difficult to tell which handler variant actually occurred.", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/703#discussion_r472853767", "createdAt": "2020-08-19T08:26:12Z", "author": {"login": "gemmellr"}, "path": "smallrye-reactive-messaging-amqp/src/main/java/io/smallrye/reactive/messaging/amqp/fault/AmqpModifiedFailedAndUndeliverableHere.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package io.smallrye.reactive.messaging.amqp.fault;\n+\n+import static io.smallrye.reactive.messaging.amqp.i18n.AMQPLogging.log;\n+\n+import java.util.concurrent.CompletionStage;\n+\n+import io.smallrye.reactive.messaging.amqp.AmqpMessage;\n+import io.smallrye.reactive.messaging.amqp.ConnectionHolder;\n+import io.vertx.mutiny.core.Context;\n+\n+/**\n+ * This nack strategy marking the message as {@code modified} and set the {@code delivery-failed} attribute to {@code true},\n+ * as well as the {@code undeliverable-here} flag to {@code true}.\n+ * <p>\n+ * The message will not be redelivered on the same node, but may be redelivered on another node.\n+ * <p>\n+ * See http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-modified.\n+ */\n+public class AmqpModifiedFailedAndUndeliverableHere implements AmqpFailureHandler {\n+\n+    private final String channel;\n+\n+    public AmqpModifiedFailedAndUndeliverableHere(String channel) {\n+        this.channel = channel;\n+    }\n+\n+    @Override\n+    public <V> CompletionStage<Void> handle(AmqpMessage<V> msg, Context context, Throwable reason) {\n+        log.nackedModifiedFailedMessage(channel);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "822dc97f87ad7c75320548a2738502f53dda788e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg1NTM1Nw==", "bodyText": "Seems odd to wait for >=10 but then assert exactly 13 values, this will surely be racey? Particularly as the 10th message will satistfy the await, but is also one of the ones to be redelivered.", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/703#discussion_r472855357", "createdAt": "2020-08-19T08:28:58Z", "author": {"login": "gemmellr"}, "path": "smallrye-reactive-messaging-amqp/src/test/java/io/smallrye/reactive/messaging/amqp/AmqpFailureHandlerTest.java", "diffHunk": "@@ -131,6 +140,46 @@ public void testRejectStrategy() {\n         assertThat(isAmqpConnectorReady(connector)).isTrue();\n     }\n \n+    @Test\n+    public void testModifiedFailedStrategy() {\n+        getModifiedFailedConfig();\n+        MyReceiverBeanRecovering bean = deployRecovering();\n+        AtomicInteger counter = new AtomicInteger();\n+        AmqpConnector connector = container.getBeanManager().createInstance().select(AmqpConnector.class,\n+                ConnectorLiteral.of(AmqpConnector.CONNECTOR_NAME)).get();\n+        await().until(() -> isAmqpConnectorReady(connector));\n+        await().until(() -> isAmqpConnectorAlive(connector));\n+\n+        usage.produceTenIntegers(\"modified-failed\", counter::getAndIncrement);\n+\n+        await().atMost(2, TimeUnit.MINUTES).until(() -> bean.list().size() >= 10);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "822dc97f87ad7c75320548a2738502f53dda788e"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg1OTMyNA==", "bodyText": "Should have been received?", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/703#discussion_r472859324", "createdAt": "2020-08-19T08:35:21Z", "author": {"login": "gemmellr"}, "path": "smallrye-reactive-messaging-amqp/src/test/java/io/smallrye/reactive/messaging/amqp/AmqpFailureHandlerTest.java", "diffHunk": "@@ -131,6 +140,46 @@ public void testRejectStrategy() {\n         assertThat(isAmqpConnectorReady(connector)).isTrue();\n     }\n \n+    @Test\n+    public void testModifiedFailedStrategy() {\n+        getModifiedFailedConfig();\n+        MyReceiverBeanRecovering bean = deployRecovering();\n+        AtomicInteger counter = new AtomicInteger();\n+        AmqpConnector connector = container.getBeanManager().createInstance().select(AmqpConnector.class,\n+                ConnectorLiteral.of(AmqpConnector.CONNECTOR_NAME)).get();\n+        await().until(() -> isAmqpConnectorReady(connector));\n+        await().until(() -> isAmqpConnectorAlive(connector));\n+\n+        usage.produceTenIntegers(\"modified-failed\", counter::getAndIncrement);\n+\n+        await().atMost(2, TimeUnit.MINUTES).until(() -> bean.list().size() >= 10);\n+        // All messages should not have been received + 3, 6 and 9 are redelivered\n+        assertThat(bean.list()).containsExactly(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 3, 6, 9);\n+\n+        assertThat(isAmqpConnectorAlive(connector)).isTrue();\n+        assertThat(isAmqpConnectorReady(connector)).isTrue();\n+    }\n+\n+    @Test\n+    public void testModifiedFailedUndeliverableHereStrategy() {\n+        getModifiedFailedUndeliverableConfig();\n+        MyReceiverBeanRecovering bean = deployRecovering();\n+        AtomicInteger counter = new AtomicInteger();\n+        AmqpConnector connector = container.getBeanManager().createInstance().select(AmqpConnector.class,\n+                ConnectorLiteral.of(AmqpConnector.CONNECTOR_NAME)).get();\n+        await().until(() -> isAmqpConnectorReady(connector));\n+        await().until(() -> isAmqpConnectorAlive(connector));\n+\n+        usage.produceTenIntegers(\"modified-failed-undeliverable-here\", counter::getAndIncrement);\n+\n+        await().atMost(2, TimeUnit.MINUTES).until(() -> bean.list().size() >= 10);\n+        // All messages should not have been received, 3 6 and 9 are NOT redelivered", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "822dc97f87ad7c75320548a2738502f53dda788e"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg1OTgxNQ==", "bodyText": "Should have been received?", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/703#discussion_r472859815", "createdAt": "2020-08-19T08:36:11Z", "author": {"login": "gemmellr"}, "path": "smallrye-reactive-messaging-amqp/src/test/java/io/smallrye/reactive/messaging/amqp/AmqpFailureHandlerTest.java", "diffHunk": "@@ -131,6 +140,46 @@ public void testRejectStrategy() {\n         assertThat(isAmqpConnectorReady(connector)).isTrue();\n     }\n \n+    @Test\n+    public void testModifiedFailedStrategy() {\n+        getModifiedFailedConfig();\n+        MyReceiverBeanRecovering bean = deployRecovering();\n+        AtomicInteger counter = new AtomicInteger();\n+        AmqpConnector connector = container.getBeanManager().createInstance().select(AmqpConnector.class,\n+                ConnectorLiteral.of(AmqpConnector.CONNECTOR_NAME)).get();\n+        await().until(() -> isAmqpConnectorReady(connector));\n+        await().until(() -> isAmqpConnectorAlive(connector));\n+\n+        usage.produceTenIntegers(\"modified-failed\", counter::getAndIncrement);\n+\n+        await().atMost(2, TimeUnit.MINUTES).until(() -> bean.list().size() >= 10);\n+        // All messages should not have been received + 3, 6 and 9 are redelivered", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "822dc97f87ad7c75320548a2738502f53dda788e"}, "originalPosition": 36}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "822dc97f87ad7c75320548a2738502f53dda788e", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/822dc97f87ad7c75320548a2738502f53dda788e", "committedDate": "2020-08-19T08:02:14Z", "message": "Fix #673\n\nAdd two new nack strategies to the AMQP connector:\n\n* modified-failed - marking the message modified and incrementing the delivery count (the message may be redelivered to the application)\n* modified-failed-undeliverable-here - marking the message modified, incrementing the delivery count, and indicating the application cannot process the message. The broker cannot redeliver the message to the application."}, "afterCommit": {"oid": "bfbdbf22aacd8bbec4905fa2d8c60c681f138c52", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/bfbdbf22aacd8bbec4905fa2d8c60c681f138c52", "committedDate": "2020-08-19T08:54:45Z", "message": "Fix #673\n\nAdd two new nack strategies to the AMQP connector:\n\n* modified-failed - marking the message modified and incrementing the delivery count (the message may be redelivered to the application)\n* modified-failed-undeliverable-here - marking the message modified, incrementing the delivery count, and indicating the application cannot process the message. The broker cannot redeliver the message to the application."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bfbdbf22aacd8bbec4905fa2d8c60c681f138c52", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/bfbdbf22aacd8bbec4905fa2d8c60c681f138c52", "committedDate": "2020-08-19T08:54:45Z", "message": "Fix #673\n\nAdd two new nack strategies to the AMQP connector:\n\n* modified-failed - marking the message modified and incrementing the delivery count (the message may be redelivered to the application)\n* modified-failed-undeliverable-here - marking the message modified, incrementing the delivery count, and indicating the application cannot process the message. The broker cannot redeliver the message to the application."}, "afterCommit": {"oid": "d631fe7a430fdfb18e6e1a3cdec577094e625e7c", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/d631fe7a430fdfb18e6e1a3cdec577094e625e7c", "committedDate": "2020-08-19T10:44:20Z", "message": "Fix #673\n\nAdd two new nack strategies to the AMQP connector:\n\n* modified-failed - marking the message modified and incrementing the delivery count (the message may be redelivered to the application)\n* modified-failed-undeliverable-here - marking the message modified, incrementing the delivery count, and indicating the application cannot process the message. The broker cannot redeliver the message to the application."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d631fe7a430fdfb18e6e1a3cdec577094e625e7c", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/d631fe7a430fdfb18e6e1a3cdec577094e625e7c", "committedDate": "2020-08-19T10:44:20Z", "message": "Fix #673\n\nAdd two new nack strategies to the AMQP connector:\n\n* modified-failed - marking the message modified and incrementing the delivery count (the message may be redelivered to the application)\n* modified-failed-undeliverable-here - marking the message modified, incrementing the delivery count, and indicating the application cannot process the message. The broker cannot redeliver the message to the application."}, "afterCommit": {"oid": "93ce152c8f7c432c88df3143db5f918944b3aec9", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/93ce152c8f7c432c88df3143db5f918944b3aec9", "committedDate": "2020-08-19T10:49:34Z", "message": "Fix #673\n\nAdd two new nack strategies to the AMQP connector:\n\n* modified-failed - marking the message modified and incrementing the delivery count (the message may be redelivered to the application)\n* modified-failed-undeliverable-here - marking the message modified, incrementing the delivery count, and indicating the application cannot process the message. The broker cannot redeliver the message to the application."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMzU1Njkx", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/703#pullrequestreview-470355691", "createdAt": "2020-08-19T11:13:02Z", "commit": {"oid": "93ce152c8f7c432c88df3143db5f918944b3aec9"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41b4b05ddeaf09b75fbc915c4b9d0a207bcff01a", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/41b4b05ddeaf09b75fbc915c4b9d0a207bcff01a", "committedDate": "2020-08-19T13:38:49Z", "message": "Fix #673\n\nAdd two new nack strategies to the AMQP connector:\n\n* modified-failed - marking the message modified and incrementing the delivery count (the message may be redelivered to the application)\n* modified-failed-undeliverable-here - marking the message modified, incrementing the delivery count, and indicating the application cannot process the message. The broker cannot redeliver the message to the application."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93ce152c8f7c432c88df3143db5f918944b3aec9", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/93ce152c8f7c432c88df3143db5f918944b3aec9", "committedDate": "2020-08-19T10:49:34Z", "message": "Fix #673\n\nAdd two new nack strategies to the AMQP connector:\n\n* modified-failed - marking the message modified and incrementing the delivery count (the message may be redelivered to the application)\n* modified-failed-undeliverable-here - marking the message modified, incrementing the delivery count, and indicating the application cannot process the message. The broker cannot redeliver the message to the application."}, "afterCommit": {"oid": "41b4b05ddeaf09b75fbc915c4b9d0a207bcff01a", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/41b4b05ddeaf09b75fbc915c4b9d0a207bcff01a", "committedDate": "2020-08-19T13:38:49Z", "message": "Fix #673\n\nAdd two new nack strategies to the AMQP connector:\n\n* modified-failed - marking the message modified and incrementing the delivery count (the message may be redelivered to the application)\n* modified-failed-undeliverable-here - marking the message modified, incrementing the delivery count, and indicating the application cannot process the message. The broker cannot redeliver the message to the application."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2250, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}