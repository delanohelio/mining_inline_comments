{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5ODY1NDg5", "number": 797, "title": "Make the rebalance listeners blocking ", "bodyText": "change the method signatures to make rebalance listener blocking (breaking change)\nsubstitute the internal rebalance listener used by the Vert.x client by our own\ninvoke the rebalance listener from the Kafka polling threading thread.\n\nThe synchronization protocol in the throttled commit strategy is not completed yet.", "createdAt": "2020-10-08T11:52:25Z", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/797", "merged": true, "mergeCommit": {"oid": "2fc3495b759e54b40f455a407fe35c42059345cf"}, "closed": true, "closedAt": "2020-10-12T05:44:49Z", "author": {"login": "cescoffier"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQh6Y4ABqjM4NTU1NTk2NDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdRlzXAAFqTUwNjIxNTY3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8731c57096bde1e0b03e832455f71072f2ff3647", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/8731c57096bde1e0b03e832455f71072f2ff3647", "committedDate": "2020-10-08T11:49:30Z", "message": "Make the rebalance listeners blocking and invoked from the Kafka polling thread."}, "afterCommit": {"oid": "2103f9421752d23db3f9302e7ea058d4007dbeb1", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/2103f9421752d23db3f9302e7ea058d4007dbeb1", "committedDate": "2020-10-08T13:50:27Z", "message": "Make the rebalance listeners blocking and invoked from the Kafka polling thread."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1Njk0MTcy", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/797#pullrequestreview-505694172", "createdAt": "2020-10-09T13:54:16Z", "commit": {"oid": "2103f9421752d23db3f9302e7ea058d4007dbeb1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzo1NDoxNlrOHfKtUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzo1NDoxNlrOHfKtUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ0MzM0NQ==", "bodyText": "This could be a problem as OffsetStore is not thread safe and was designed to be called within the context thread.\nIn partitionsRevoked we call clearLesserSequentiallyProcessedOffsetsAndReturnLargestOffset which mutates the OffsetStore. Is it not possible to make a blocking call in the context thread from the poll thread?", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/797#discussion_r502443345", "createdAt": "2020-10-09T13:54:16Z", "author": {"login": "pcasaes"}, "path": "smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/commit/KafkaThrottledLatestProcessedCommit.java", "diffHunk": "@@ -38,7 +38,7 @@\n \n     private static final Map<String, Map<Integer, TopicPartition>> TOPIC_PARTITIONS_CACHE = new ConcurrentHashMap<>();\n \n-    private final Map<TopicPartition, OffsetStore> offsetStores = new HashMap<>();\n+    private final Map<TopicPartition, OffsetStore> offsetStores = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2103f9421752d23db3f9302e7ea058d4007dbeb1"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b50352d30d0b824013ffa75b08ba858d216b0ab", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/9b50352d30d0b824013ffa75b08ba858d216b0ab", "committedDate": "2020-10-10T11:57:17Z", "message": "Make the rebalance listeners blocking and invoked from the Kafka polling thread."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2103f9421752d23db3f9302e7ea058d4007dbeb1", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/2103f9421752d23db3f9302e7ea058d4007dbeb1", "committedDate": "2020-10-08T13:50:27Z", "message": "Make the rebalance listeners blocking and invoked from the Kafka polling thread."}, "afterCommit": {"oid": "1d20fd1b45bf30228e91136f3185b4518bc2e1de", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/1d20fd1b45bf30228e91136f3185b4518bc2e1de", "committedDate": "2020-10-10T14:44:42Z", "message": "Fix synchronization protocol in the throttled commit strategy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a07a24729265e2a9ce30c097d8a95ecebbf19de5", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/a07a24729265e2a9ce30c097d8a95ecebbf19de5", "committedDate": "2020-10-10T14:50:31Z", "message": "Fix synchronization protocol in the throttled commit strategy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2c8e3dcae6c957ccc63fcb4fecc85dd9487e683", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/d2c8e3dcae6c957ccc63fcb4fecc85dd9487e683", "committedDate": "2020-10-10T19:04:08Z", "message": "Add default timeout support and fix type mismatch on sync commit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1d20fd1b45bf30228e91136f3185b4518bc2e1de", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/1d20fd1b45bf30228e91136f3185b4518bc2e1de", "committedDate": "2020-10-10T14:44:42Z", "message": "Fix synchronization protocol in the throttled commit strategy"}, "afterCommit": {"oid": "d2c8e3dcae6c957ccc63fcb4fecc85dd9487e683", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/d2c8e3dcae6c957ccc63fcb4fecc85dd9487e683", "committedDate": "2020-10-10T19:04:08Z", "message": "Add default timeout support and fix type mismatch on sync commit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MTM1MDky", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/797#pullrequestreview-506135092", "createdAt": "2020-10-11T00:47:26Z", "commit": {"oid": "d2c8e3dcae6c957ccc63fcb4fecc85dd9487e683"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQwMDo0NzoyNlrOHfjeaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQwMDo0NzoyNlrOHfjeaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg0OTEyOA==", "bodyText": "Are we sure about throwing a WakeupException? It will stop the poll thread dead cold. I used it without giving it much thought on my tests. The other option is to wrap it in a CompletionException along with the others (besides marking the current thread as interrupted).\nDealing with InterruptedException is always tricky because you never know where they can come from.", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/797#discussion_r502849128", "createdAt": "2020-10-11T00:47:26Z", "author": {"login": "pcasaes"}, "path": "smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/commit/ContextHolder.java", "diffHunk": "@@ -45,4 +50,18 @@ public void runOnContext(Runnable runnable) {\n         }\n     }\n \n+    public <T> T runOnContextAndAwait(Callable<T> action) {\n+        FutureTask<T> task = new FutureTask<>(action);\n+        runOnContext(task);\n+\n+        try {\n+            return task.get(timeout, TimeUnit.MILLISECONDS);\n+        } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();\n+            throw new WakeupException();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2c8e3dcae6c957ccc63fcb4fecc85dd9487e683"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9140dbcdcf9fc474da8339687d62004e417e0ac9", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/9140dbcdcf9fc474da8339687d62004e417e0ac9", "committedDate": "2020-10-11T07:58:31Z", "message": "Improve the handling interruptions while executing blocking task in the rebalance listeners."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cd23a44b2080d6f02b320e11c0b9e6e5346d3b3", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/1cd23a44b2080d6f02b320e11c0b9e6e5346d3b3", "committedDate": "2020-10-11T08:27:24Z", "message": "Update consumer rebalance listener documentation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MjE1Njcy", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/797#pullrequestreview-506215672", "createdAt": "2020-10-11T20:56:32Z", "commit": {"oid": "1cd23a44b2080d6f02b320e11c0b9e6e5346d3b3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2280, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}