{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3MzkwNDUz", "number": 790, "title": "Improvement of the throttled commit strategy (and make it the default)", "bodyText": "This PR fixes a few issues with the throttled commit strategy:\n\ncommit on partition revocation\nhandle partition assignation when called after the reception of messages\nimprove context handling (for performance purpose)", "createdAt": "2020-10-04T07:29:49Z", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/790", "merged": true, "mergeCommit": {"oid": "574baa8d370238298063acc9a308f364b41c1fff"}, "closed": true, "closedAt": "2020-10-05T05:55:54Z", "author": {"login": "cescoffier"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPJjsfAH2gAyNDk3MzkwNDUzOjdhMWQ4OWIzZWViMjY3NDdiNGZjMmM4OGEyYTA5MTY5N2EwNzE1ZGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPRjfXgFqTUwMTYzNzQ0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7a1d89b3eeb26747b4fc2c88a2a091697a0715df", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/7a1d89b3eeb26747b4fc2c88a2a091697a0715df", "committedDate": "2020-10-04T06:54:14Z", "message": "Capture the Vert.x context used by the Vert.x Kafka Client earlier to avoid performance penalties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf2bdc5d22b2bf469ad2cc08fdfb3c4b8e3ae335", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/bf2bdc5d22b2bf469ad2cc08fdfb3c4b8e3ae335", "committedDate": "2020-10-04T06:55:11Z", "message": "Commit handlers may need to execute some actions when partitions are revoked\n\nTypically, commit the processed offsets."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b942b62676817fe6c60dcda90bdff1fe1cd9724b", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/b942b62676817fe6c60dcda90bdff1fe1cd9724b", "committedDate": "2020-10-04T06:58:31Z", "message": "Fix rebalancing in the throttled commit strategy\n\nBecause of the execution model used by the Vert.x Kafka client, we may have started consuming records before the partitions assigned callback is invoked.\nAlso, when partitions are revoked, it must commit the processed offsets.  Unfortunately, with the current execution model, we cannot block the revocation, and the commit is a best-effort."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db6983a533f68c1d8974a2e7623d78474e4b4d37", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/db6983a533f68c1d8974a2e7623d78474e4b4d37", "committedDate": "2020-10-04T06:59:19Z", "message": "Switch to the throttled commit strategy as default"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNjIyMjIz", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/790#pullrequestreview-501622223", "createdAt": "2020-10-04T13:09:57Z", "commit": {"oid": "db6983a533f68c1d8974a2e7623d78474e4b4d37"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQxMzowOTo1N1rOHcHgOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQxMzowOTo1N1rOHcHgOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI0NTExMw==", "bodyText": "Why is turning the keySet into a HashSet necessary?", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/790#discussion_r499245113", "createdAt": "2020-10-04T13:09:57Z", "author": {"login": "pcasaes"}, "path": "smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/commit/KafkaThrottledLatestProcessedCommit.java", "diffHunk": "@@ -105,11 +104,50 @@ private OffsetStore getOffsetStore(TopicPartition topicPartition) {\n      */\n     @Override\n     public void partitionsAssigned(Set<TopicPartition> partitions) {\n-        offsetStores.clear();\n+        stopFlushAndCheckHealthTimer();\n+\n+        // Remove all handled partitions that are not in the given list of partitions\n+        for (TopicPartition partition : new HashSet<>(offsetStores.keySet())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db6983a533f68c1d8974a2e7623d78474e4b4d37"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNjIzNTY3", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/790#pullrequestreview-501623567", "createdAt": "2020-10-04T13:27:26Z", "commit": {"oid": "db6983a533f68c1d8974a2e7623d78474e4b4d37"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQxMzoyNzoyNlrOHcHmiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNFQxMzo0MDoxMlrOHcHrwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI0NjczMQ==", "bodyText": "This is something I got wrong. From the documentation:\n\nThe list of partitions that are now assigned to the consumer (previously owned partitions will NOT be included, i.e. this list will only include newly added partitions)\n\nhttps://kafka.apache.org/24/javadoc/org/apache/kafka/clients/consumer/ConsumerRebalanceListener.html#onPartitionsAssigned-java.util.Collection-\nThis needs to be used in conjunction with revoked to get the full picture\n\npartitions - The list of partitions that were assigned to the consumer and now have been reassigned to other consumers (may not include all currently assigned partitions, i.e. there may still be some partitions left)\n\nhttps://kafka.apache.org/24/javadoc/org/apache/kafka/clients/consumer/ConsumerRebalanceListener.html#onPartitionsRevoked-java.util.Collection-\nIf the idea is to remove partitions from the store then that should be done in partitionsRevoked.", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/790#discussion_r499246731", "createdAt": "2020-10-04T13:27:26Z", "author": {"login": "pcasaes"}, "path": "smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/commit/KafkaThrottledLatestProcessedCommit.java", "diffHunk": "@@ -105,11 +104,50 @@ private OffsetStore getOffsetStore(TopicPartition topicPartition) {\n      */\n     @Override\n     public void partitionsAssigned(Set<TopicPartition> partitions) {\n-        offsetStores.clear();\n+        stopFlushAndCheckHealthTimer();\n+\n+        // Remove all handled partitions that are not in the given list of partitions", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db6983a533f68c1d8974a2e7623d78474e4b4d37"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI0Njc1OQ==", "bodyText": "Concerning the comment left on the partitionsAssigned method. After committing we should remove partitions from the store.", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/790#discussion_r499246759", "createdAt": "2020-10-04T13:27:48Z", "author": {"login": "pcasaes"}, "path": "smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/commit/KafkaThrottledLatestProcessedCommit.java", "diffHunk": "@@ -105,11 +104,50 @@ private OffsetStore getOffsetStore(TopicPartition topicPartition) {\n      */\n     @Override\n     public void partitionsAssigned(Set<TopicPartition> partitions) {\n-        offsetStores.clear();\n+        stopFlushAndCheckHealthTimer();\n+\n+        // Remove all handled partitions that are not in the given list of partitions\n+        for (TopicPartition partition : new HashSet<>(offsetStores.keySet())) {\n+            if (!partitions.contains(partition)) {\n+                offsetStores.remove(partition);\n+            }\n+        }\n+\n+        // We cannot commit the removed offsets as we are not assigned to this partition anymore.\n+\n+        if (!offsetStores.isEmpty()) {\n+            startFlushAndCheckHealthTimer();\n+        }\n+    }\n \n+    /**\n+     * Revoked partitions.\n+     * This method is called from a Vert.x event loop (the one used by the Kafka client)\n+     *\n+     * @param partitions the partitions that we will no longer receive\n+     */\n+    @Override\n+    public void partitionsRevoked(Set<TopicPartition> partitions) {\n         stopFlushAndCheckHealthTimer();\n \n-        if (!partitions.isEmpty()) {\n+        // Remove all handled partitions that are not in the given list of partitions\n+        Map<TopicPartition, OffsetAndMetadata> toCommit = new HashMap<>();\n+        for (TopicPartition partition : new HashSet<>(offsetStores.keySet())) {\n+            if (!partitions.contains(partition)) {\n+                OffsetStore store = offsetStores.remove(partition);\n+                long largestOffset = store.clearLesserSequentiallyProcessedOffsetsAndReturnLargestOffset();\n+                if (largestOffset > -1) {\n+                    toCommit.put(partition, new OffsetAndMetadata(largestOffset + 1L, null));\n+                }\n+            }\n+        }\n+\n+        if (!toCommit.isEmpty()) {\n+            // Commit the offsets\n+            consumer.getDelegate().commit(toCommit);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db6983a533f68c1d8974a2e7623d78474e4b4d37"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI0Njk2NQ==", "bodyText": "If we are not adding partitions to the store in this method then we need to start the time if either that store or partitions aren't empty.", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/790#discussion_r499246965", "createdAt": "2020-10-04T13:29:27Z", "author": {"login": "pcasaes"}, "path": "smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/commit/KafkaThrottledLatestProcessedCommit.java", "diffHunk": "@@ -105,11 +104,50 @@ private OffsetStore getOffsetStore(TopicPartition topicPartition) {\n      */\n     @Override\n     public void partitionsAssigned(Set<TopicPartition> partitions) {\n-        offsetStores.clear();\n+        stopFlushAndCheckHealthTimer();\n+\n+        // Remove all handled partitions that are not in the given list of partitions\n+        for (TopicPartition partition : new HashSet<>(offsetStores.keySet())) {\n+            if (!partitions.contains(partition)) {\n+                offsetStores.remove(partition);\n+            }\n+        }\n+\n+        // We cannot commit the removed offsets as we are not assigned to this partition anymore.\n+\n+        if (!offsetStores.isEmpty()) {\n+            startFlushAndCheckHealthTimer();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db6983a533f68c1d8974a2e7623d78474e4b4d37"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI0NzMwOQ==", "bodyText": "Nice!", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/790#discussion_r499247309", "createdAt": "2020-10-04T13:32:58Z", "author": {"login": "pcasaes"}, "path": "smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/commit/KafkaThrottledLatestProcessedCommit.java", "diffHunk": "@@ -282,13 +320,54 @@ boolean hasTooManyMessagesWithoutAck() {\n \n     public static class TooManyMessagesWithoutAckException extends Exception {\n         public TooManyMessagesWithoutAckException() {\n-            super(\"Too Many Messages without Ack\");\n+            super(\"Too Many Messages without acknowledgement\");\n         }\n     }\n \n     @Override\n     public void terminate() {\n-        // TODO Force commit sync.\n+        commitAllAndAwait();\n+        offsetStores.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db6983a533f68c1d8974a2e7623d78474e4b4d37"}, "originalPosition": 147}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI0ODA2Ng==", "bodyText": "Will we be living with this as a final solution or are we going to work with Vert.X to get access to the context properly?", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/790#discussion_r499248066", "createdAt": "2020-10-04T13:40:12Z", "author": {"login": "pcasaes"}, "path": "smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/commit/ContextHolder.java", "diffHunk": "@@ -15,24 +19,29 @@ public ContextHolder(Vertx vertx) {\n         this.vertx = vertx;\n     }\n \n-    public Context getContext() {\n-        Context ctx = this.context;\n-        if (ctx == null) {\n-            synchronized (this) {\n-                ctx = this.context;\n-                if (ctx == null) {\n-                    this.context = ctx = vertx.getOrCreateContext();\n-                }\n+    public void capture(KafkaReadStream<?, ?> stream) {\n+        if (!(stream instanceof KafkaReadStreamImpl)) {\n+            throw new IllegalArgumentException(\"Cannot capture the context - not a KafkaReadStreamImpl\");\n+        } else {\n+            try {\n+                Field field = KafkaReadStreamImpl.class.getDeclaredField(\"context\");\n+                field.setAccessible(true);\n+                context = new Context((io.vertx.core.Context) field.get(stream));\n+            } catch (Exception e) {\n+                throw new IllegalArgumentException(\"Cannot capture the context\", e);\n             }\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db6983a533f68c1d8974a2e7623d78474e4b4d37"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "710f52ad525b15d0676be22dcd129c075334d3c3", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/710f52ad525b15d0676be22dcd129c075334d3c3", "committedDate": "2020-10-04T16:09:49Z", "message": "Explicitely mention that the user must manage the offset commit in the rebalance listener"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f6b0274c3ae4799f64acdfea9e12793d9cdb930", "author": {"user": {"login": "cescoffier", "name": "Clement Escoffier"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/8f6b0274c3ae4799f64acdfea9e12793d9cdb930", "committedDate": "2020-10-04T16:10:32Z", "message": "Do not clear partitions in the partitionAssigned handling in the throttled commit strategy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNjM3NDQ5", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/790#pullrequestreview-501637449", "createdAt": "2020-10-04T16:13:15Z", "commit": {"oid": "8f6b0274c3ae4799f64acdfea9e12793d9cdb930"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2279, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}