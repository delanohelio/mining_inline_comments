{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwMDY4NTQ0", "number": 762, "title": "Use timer on throttled strategy and improve throttled health check", "bodyText": "@cescoffier\nAs we discussed on #672 here I added the use of a vert.x periodic timer to perform the commit and run the health check by testing how long the oldest received message has gone unprocessed. In the case of replaying a topic from the beginning it can still trigger so it can be disabled.", "createdAt": "2020-09-21T06:22:40Z", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/762", "merged": true, "mergeCommit": {"oid": "bb26ef47658f5f602cfcc0e5db6e0fadca40d4df"}, "closed": true, "closedAt": "2020-09-22T06:56:52Z", "author": {"login": "pcasaes"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdK-izCAFqTQ5MjM0NDk0MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLSZr8gFqTQ5MzE2OTk4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyMzQ0OTQw", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/762#pullrequestreview-492344940", "createdAt": "2020-09-21T07:44:28Z", "commit": {"oid": "cad5346a11e89e7333fed0f071eb79d31387c393"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwNzo0NDoyOFrOHVD5rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwNzo0ODoyNFrOHVEB_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg0NjA2Mw==", "bodyText": "while an object, a long with an initial value of -1 works well.", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/762#discussion_r491846063", "createdAt": "2020-09-21T07:44:28Z", "author": {"login": "cescoffier"}, "path": "smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/commit/KafkaThrottledLatestProcessedCommit.java", "diffHunk": "@@ -41,37 +42,27 @@\n  */\n public class KafkaThrottledLatestProcessedCommit implements KafkaCommitHandler {\n \n-    private static final long THROTTLE_TIME_IN_MILLIS = 5_000L;\n     private static final Map<String, Map<Integer, TopicPartition>> TOPIC_PARTITIONS_CACHE = new ConcurrentHashMap<>();\n \n     private final Map<TopicPartition, OffsetStore> offsetStores = new HashMap<>();\n \n     private final KafkaConsumer<?, ?> consumer;\n     private final KafkaSource<?, ?> source;\n-    private final int maxReceivedWithoutAckAllowed;\n+    private final int unprocessedRecordMaxAge;\n+    private final int autoCommitInterval;\n \n     private volatile Context context;\n-    private long nextCommitTime;\n+\n+    private Long timerId = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cad5346a11e89e7333fed0f071eb79d31387c393"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg0NjU3Mw==", "bodyText": "you should store the IncomingKAfkaConfiguration and use this object instead of accessing the config. Typically, alias and default values are managed for you.", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/762#discussion_r491846573", "createdAt": "2020-09-21T07:45:22Z", "author": {"login": "cescoffier"}, "path": "smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/commit/KafkaThrottledLatestProcessedCommit.java", "diffHunk": "@@ -82,10 +73,16 @@ public static KafkaThrottledLatestProcessedCommit create(KafkaConsumer<?, ?> con\n             Map<String, String> config,\n             KafkaSource<?, ?> source) {\n \n-        int maxPollRecords = Integer.parseInt(config.getOrDefault(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, \"500\"));\n-        int maxReceivedWithoutAckAllowed = getNextPowerOfTwoEqualOrGreater(maxPollRecords * 2);\n-        log.settingMaxReceivedWithoutAckAllowed(config.get(ConsumerConfig.GROUP_ID_CONFIG), maxReceivedWithoutAckAllowed);\n-        return new KafkaThrottledLatestProcessedCommit(consumer, source, maxReceivedWithoutAckAllowed);\n+        int unprocessedRecordMaxAge = Integer.parseInt(config.getOrDefault(\"throttled.unprocessed-record-max-age\", \"60000\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cad5346a11e89e7333fed0f071eb79d31387c393"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg0NzQ3OQ==", "bodyText": "instead of using a periodic task, we may want to do a timed task starting a new timed task. So the gap between the end of the task and the beginning of the next one will be the configured time. Without it's the time between 2 beginning which might be too close.", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/762#discussion_r491847479", "createdAt": "2020-09-21T07:47:05Z", "author": {"login": "cescoffier"}, "path": "smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/commit/KafkaThrottledLatestProcessedCommit.java", "diffHunk": "@@ -106,25 +103,26 @@ public void partitionsAssigned(Context context, Set<TopicPartition> partitions)\n \n         offsetStores.clear();\n \n-        resetNextCommitTime();\n+        if (timerId != null) {\n+            context.owner().cancelTimer(timerId);\n+            timerId = null;\n+        }\n+\n+        if (!partitions.isEmpty()) {\n+            timerId = context\n+                    .owner()\n+                    .setPeriodic(autoCommitInterval, this::flushAndCheckHealth);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cad5346a11e89e7333fed0f071eb79d31387c393"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg0ODE4OA==", "bodyText": "shouldn't we pause first?", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/762#discussion_r491848188", "createdAt": "2020-09-21T07:48:24Z", "author": {"login": "cescoffier"}, "path": "smallrye-reactive-messaging-kafka/src/main/java/io/smallrye/reactive/messaging/kafka/impl/KafkaSource.java", "diffHunk": "@@ -150,6 +150,7 @@ public KafkaSource(Vertx vertx,\n                     + 11_000L; // it's possible that it might expire 10 seconds before when we need it to\n \n             kafkaConsumer.partitionsAssignedHandler(set -> {\n+                commitHandler.partitionsAssigned(vertx.getOrCreateContext(), set);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cad5346a11e89e7333fed0f071eb79d31387c393"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cad5346a11e89e7333fed0f071eb79d31387c393", "author": {"user": {"login": "pcasaes", "name": "Paulo Casaes"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/cad5346a11e89e7333fed0f071eb79d31387c393", "committedDate": "2020-09-21T06:18:50Z", "message": "Use timer on throttled strategy and improve throttled health check"}, "afterCommit": {"oid": "1b7c8d9ff0c341240de3ce37f8665aefa304d974", "author": {"user": {"login": "pcasaes", "name": "Paulo Casaes"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/1b7c8d9ff0c341240de3ce37f8665aefa304d974", "committedDate": "2020-09-21T14:55:39Z", "message": "Use timer on throttled strategy and improve throttled health check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0dbdd7833c2c20322f69e947427e376c8dcf2b9c", "author": {"user": {"login": "pcasaes", "name": "Paulo Casaes"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/0dbdd7833c2c20322f69e947427e376c8dcf2b9c", "committedDate": "2020-09-21T16:58:38Z", "message": "Use timer on throttled strategy and improve throttled health check"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1b7c8d9ff0c341240de3ce37f8665aefa304d974", "author": {"user": {"login": "pcasaes", "name": "Paulo Casaes"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/1b7c8d9ff0c341240de3ce37f8665aefa304d974", "committedDate": "2020-09-21T14:55:39Z", "message": "Use timer on throttled strategy and improve throttled health check"}, "afterCommit": {"oid": "0dbdd7833c2c20322f69e947427e376c8dcf2b9c", "author": {"user": {"login": "pcasaes", "name": "Paulo Casaes"}}, "url": "https://github.com/smallrye/smallrye-reactive-messaging/commit/0dbdd7833c2c20322f69e947427e376c8dcf2b9c", "committedDate": "2020-09-21T16:58:38Z", "message": "Use timer on throttled strategy and improve throttled health check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMTY5OTg5", "url": "https://github.com/smallrye/smallrye-reactive-messaging/pull/762#pullrequestreview-493169989", "createdAt": "2020-09-22T06:56:45Z", "commit": {"oid": "0dbdd7833c2c20322f69e947427e376c8dcf2b9c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2266, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}