{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2ODQ4MTgx", "number": 2737, "title": "[Gradle plugin] Add schema upload", "bodyText": "add ./gradlew uploadApolloSchema --key $key --schema schema.sdl to upload to the apollo graph manager", "createdAt": "2020-11-06T16:20:26Z", "url": "https://github.com/apollographql/apollo-android/pull/2737", "merged": true, "mergeCommit": {"oid": "ce14245a9e58001d93d55278df9bc6558980495a"}, "closed": true, "closedAt": "2020-11-16T15:45:07Z", "author": {"login": "martinbonnin"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZ1-uCgH2gAyNTE2ODQ4MTgxOjFhM2QyNDAyNzYyZjZjYzc4MjQ5OTVjYTc0N2Y4ZjdhNTkyYmM5ZmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdadr-qgH2gAyNTE2ODQ4MTgxOmIwN2FhZjg1MTgyNTBhNTlhOTgyMDhmMzQ0OGQ4Yjc3NDczZGVhOGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1a3d2402762f6cc7824995ca747f8f7a592bc9fd", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/1a3d2402762f6cc7824995ca747f8f7a592bc9fd", "committedDate": "2020-11-06T12:18:49Z", "message": "add uploadApolloSchema"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a7234f3b7cd9648ae12e247ce1fb809219320ba", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/5a7234f3b7cd9648ae12e247ce1fb809219320ba", "committedDate": "2020-11-06T15:48:15Z", "message": "add ./gradlew uploadApolloSchema"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NDUwNTkx", "url": "https://github.com/apollographql/apollo-android/pull/2737#pullrequestreview-525450591", "createdAt": "2020-11-06T19:56:46Z", "commit": {"oid": "5a7234f3b7cd9648ae12e247ce1fb809219320ba"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxOTo1Njo0NlrOHu7jhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxOTo1ODo1M1rOHu7nXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk3MjI5Mw==", "bodyText": "I think key, graph, variant, and sdl should all be required String types here", "url": "https://github.com/apollographql/apollo-android/pull/2737#discussion_r518972293", "createdAt": "2020-11-06T19:56:46Z", "author": {"login": "zionts"}, "path": "apollo-gradle-plugin/src/main/kotlin/com/apollographql/apollo/gradle/internal/SchemaUploader.kt", "diffHunk": "@@ -0,0 +1,43 @@\n+package com.apollographql.apollo.gradle.internal\n+\n+import com.apollographql.apollo.compiler.fromJson\n+import com.apollographql.apollo.gradle.internal.SchemaDownloader.cast\n+import java.net.InetAddress\n+import java.nio.charset.StandardCharsets\n+import java.security.MessageDigest\n+import java.util.UUID\n+\n+object SchemaUploader {\n+  fun uploadSchema(key: String, graph: String, variant: String, sdl: String) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a7234f3b7cd9648ae12e247ce1fb809219320ba"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk3MjY2MA==", "bodyText": "it may be worth having some kind of automatic retry on disconnect, but \ud83e\udd37", "url": "https://github.com/apollographql/apollo-android/pull/2737#discussion_r518972660", "createdAt": "2020-11-06T19:57:30Z", "author": {"login": "zionts"}, "path": "apollo-gradle-plugin/src/main/kotlin/com/apollographql/apollo/gradle/internal/SchemaHelper.kt", "diffHunk": "@@ -0,0 +1,60 @@\n+package com.apollographql.apollo.gradle.internal\n+\n+import com.apollographql.apollo.compiler.toJson\n+import com.squareup.moshi.JsonWriter\n+import okhttp3.MediaType.Companion.toMediaTypeOrNull\n+import okhttp3.OkHttpClient\n+import okhttp3.Request\n+import okhttp3.RequestBody.Companion.toRequestBody\n+import okhttp3.Response\n+import okio.buffer\n+import okio.sink\n+import java.io.ByteArrayOutputStream\n+import java.util.concurrent.TimeUnit\n+\n+internal object SchemaHelper {\n+  private fun newOkHttpClient(): OkHttpClient {\n+    val connectTimeoutSeconds = System.getProperty(\"okHttp.connectTimeout\", \"600\").toLong()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a7234f3b7cd9648ae12e247ce1fb809219320ba"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODk3MzI3OQ==", "bodyText": "Could we call the action pushSchema instead of uploadSchema? Though we call it uploadSchema in our API, in our public documentation and existing CLI, this is called \"publishing to the registry,\" \"pushing to the registry\" and service:push, and I want to make sure we're telling a consistent message to users since the upload will actually correspond the uploaded schema as active on the graph@variant in question.", "url": "https://github.com/apollographql/apollo-android/pull/2737#discussion_r518973279", "createdAt": "2020-11-06T19:58:53Z", "author": {"login": "zionts"}, "path": "apollo-gradle-plugin/src/main/kotlin/com/apollographql/apollo/gradle/internal/ApolloUploadSchemaTask.kt", "diffHunk": "@@ -0,0 +1,64 @@\n+package com.apollographql.apollo.gradle.internal\n+\n+import org.gradle.api.DefaultTask\n+import org.gradle.api.provider.Property\n+import org.gradle.api.tasks.Input\n+import org.gradle.api.tasks.Optional\n+import org.gradle.api.tasks.TaskAction\n+import org.gradle.api.tasks.options.Option\n+import java.io.File\n+\n+abstract class ApolloUploadSchemaTask : DefaultTask() {\n+  @get:Input\n+  @get:Optional\n+  @get:Option(option = \"schema\", description = \"schema to upload as SDL\")\n+  abstract val schema: Property<String>\n+\n+  @get:Optional\n+  @get:Input\n+  @get:Option(option = \"key\", description = \"The Apollo API key. See https://www.apollographql.com/docs/studio/api-keys/ for more information on how to get your API key.\")\n+  abstract val key: Property<String>\n+\n+  @get:Optional\n+  @get:Input\n+  @get:Option(option = \"graph\", description = \"The identifier of the Apollo graph used to download the schema.\")\n+  abstract val graph: Property<String>\n+\n+  @get:Optional\n+  @get:Input\n+  @get:Option(option = \"graphVariant\", description = \"The variant of the Apollo graph used to download the schema.\")\n+  abstract val graphVariant: Property<String>\n+\n+\n+  private fun Property<String>.orProperty(name: String) = orElse(project.provider {\n+    (project.findProperty(\"com.apollographql.apollo.$name\") as? String)?.also {\n+      logger.lifecycle(\"Using the com.apollographql.apollo.$name property is deprecated. Use --$name instead.\")\n+    }\n+  }).orNull\n+\n+  @TaskAction\n+  fun taskAction() {\n+    val key = key.orProperty(\"key\")\n+    var graph = graph.orProperty(\"graph\")\n+    val graphVariant = graphVariant.orProperty(\"graph-variant\")\n+    val schema = schema.orNull\n+\n+    check (key != null) {\n+      \"please define key\"\n+    }\n+\n+    if (graph == null && key.startsWith(\"service:\")) {\n+      graph = key.split(\":\")[1]\n+    }\n+\n+    check (graph != null) {\n+      \"please define graph\"\n+    }\n+\n+    check (schema != null) {\n+      \"please define schema\"\n+    }\n+\n+    SchemaUploader.uploadSchema(key = key, graph = graph, variant = graphVariant ?: \"current\", File(schema).readText())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a7234f3b7cd9648ae12e247ce1fb809219320ba"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24e7329d01e02021021765059ef5c8f5ef5c12ee", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/24e7329d01e02021021765059ef5c8f5ef5c12ee", "committedDate": "2020-11-08T10:33:35Z", "message": "upload -> push"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b07aaf8518250a59a98208f3448d8b77473dea8f", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/b07aaf8518250a59a98208f3448d8b77473dea8f", "committedDate": "2020-11-08T10:34:33Z", "message": "exemple -> example"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4193, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}