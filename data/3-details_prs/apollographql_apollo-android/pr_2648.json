{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxMDA0NzY2", "number": 2648, "title": "Introduce new response reader API to support reading from stream - part1", "bodyText": "Introduce new API selectField to be used in feature implementation of stream reader\nProvide implementation to existing Map based readers\nUpdate code generation to parse response based on selectField\n\nPart of #2523\nThe actual implementation of stream readers will be introduced in next PR.", "createdAt": "2020-10-10T16:47:44Z", "url": "https://github.com/apollographql/apollo-android/pull/2648", "merged": true, "mergeCommit": {"oid": "8b8c4ae846d3d9823cb1d30eba543d860d0eded5"}, "closed": true, "closedAt": "2020-10-12T18:29:49Z", "author": {"login": "sav007"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdRghVNgFqTUwNjE4NjQ5NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdR318jgFqTUwNjgxNDkyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MTg2NDk1", "url": "https://github.com/apollographql/apollo-android/pull/2648#pullrequestreview-506186495", "createdAt": "2020-10-11T14:47:18Z", "commit": {"oid": "868a8a72563223029b36ed8fbb70708abf108924"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQxNDo0NzoxOFrOHfoG9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQxNDo0NzoxOFrOHfoG9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjkyNTA0Ng==", "bodyText": "Why do we even need shouldSkip ? Isn't this supposed to be handled server side? If a server returns a value for a skipped field, this is most likely against the spec. Maybe we can avoid this logic client side and save a few more CPU cycles?", "url": "https://github.com/apollographql/apollo-android/pull/2648#discussion_r502925046", "createdAt": "2020-10-11T14:47:18Z", "author": {"login": "martinbonnin"}, "path": "apollo-api/src/commonMain/kotlin/com/apollographql/apollo/api/internal/ResponseReader.kt", "diffHunk": "@@ -78,4 +80,24 @@ interface ResponseReader {\n       })\n     }\n   }\n+\n+  fun ResponseField.shouldSkip(variableValues: Map<String, Any?>): Boolean {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "868a8a72563223029b36ed8fbb70708abf108924"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MTg4MjY3", "url": "https://github.com/apollographql/apollo-android/pull/2648#pullrequestreview-506188267", "createdAt": "2020-10-11T15:05:30Z", "commit": {"oid": "868a8a72563223029b36ed8fbb70708abf108924"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQxNTowNTozMFrOHfoQMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQxNTowNTozMFrOHfoQMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjkyNzQxMA==", "bodyText": "We could leverage the fact that field order should be preserved to remove the iteration here and have faster parsing performance than json. Maybe with a \"slow\" path for non-compliant server implementations.", "url": "https://github.com/apollographql/apollo-android/pull/2648#discussion_r502927410", "createdAt": "2020-10-11T15:05:30Z", "author": {"login": "martinbonnin"}, "path": "apollo-api/src/commonMain/kotlin/com/apollographql/apollo/api/internal/SimpleResponseReader.kt", "diffHunk": "@@ -13,121 +13,64 @@ class SimpleResponseReader private constructor(\n     private val variableValues: Map<String, Any?>,\n     private val scalarTypeAdapters: ScalarTypeAdapters\n ) : ResponseReader {\n+  private val responseRecordSetIterator = recordSet.iterator()\n \n   constructor(\n       recordSet: Map<String, Any?>,\n       variables: Operation.Variables,\n       scalarTypeAdapters: ScalarTypeAdapters\n   ) : this(recordSet, variables.valueMap(), scalarTypeAdapters)\n \n-  override fun readString(field: ResponseField): String? {\n-    if (shouldSkip(field)) {\n-      return null\n-    }\n+  override fun selectField(fields: Array<ResponseField>): Int {\n+    while (true)\n+      if (responseRecordSetIterator.hasNext()) {\n+        val (nextFieldName, _) = responseRecordSetIterator.next()\n+        val fieldIndex = fields.indexOfFirst { field -> field.responseName == nextFieldName }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "868a8a72563223029b36ed8fbb70708abf108924"}, "originalPosition": 20}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1c3ca799e6215589ffd35d2d226102d2f0cb19c1", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/1c3ca799e6215589ffd35d2d226102d2f0cb19c1", "committedDate": "2020-10-12T03:01:52Z", "message": "Remove `shouldSkip` from simple response reader.\nRevert back `Mapper` code generation."}, "afterCommit": {"oid": "484f5dbbd5576a97a1facc03491749362c1092a5", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/484f5dbbd5576a97a1facc03491749362c1092a5", "committedDate": "2020-10-12T03:24:13Z", "message": "Remove `shouldSkip` from simple response reader.\nRevert back `Mapper` code generation.\nRebase."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acda55c7137d31b9e9cb472f5b736a16d3f33c16", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/acda55c7137d31b9e9cb472f5b736a16d3f33c16", "committedDate": "2020-10-12T15:54:57Z", "message": "Introduce new response reader API to support reading from stream\n\n- Introduce new API `selectField` to be used in feature implementation of stream reader\n- Provide implementation to existing Map based readers\n- Update code generation to parse response based on `selectField`\n\nPart of #2523"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76afa546a2ec3438df73c2267e6b4b0441356dac", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/76afa546a2ec3438df73c2267e6b4b0441356dac", "committedDate": "2020-10-12T15:54:57Z", "message": "Codegen + test fixtures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0af7c8ca734994b0c9c1cf70dea4e701761e2c7b", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/0af7c8ca734994b0c9c1cf70dea4e701761e2c7b", "committedDate": "2020-10-12T15:54:57Z", "message": "Fix reading number issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02131f4be67d004749fe82f67c76097b07ee2cc1", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/02131f4be67d004749fe82f67c76097b07ee2cc1", "committedDate": "2020-10-12T15:54:57Z", "message": "Remove `shouldSkip` from simple response reader.\nRevert back `Mapper` code generation.\nRebase."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6f20b468248c1711a2d35656c576948c8411f26", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/e6f20b468248c1711a2d35656c576948c8411f26", "committedDate": "2020-10-12T15:54:57Z", "message": "Rework `RealResponseReader` to fix issue with parsing response from cache."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "35daba94797d5b789f6bad73ae2c1f4c60ab0958", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/35daba94797d5b789f6bad73ae2c1f4c60ab0958", "committedDate": "2020-10-12T15:17:45Z", "message": "Rework `RealResponseReader` to fix issue with parsing response from cache."}, "afterCommit": {"oid": "e6f20b468248c1711a2d35656c576948c8411f26", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/e6f20b468248c1711a2d35656c576948c8411f26", "committedDate": "2020-10-12T15:54:57Z", "message": "Rework `RealResponseReader` to fix issue with parsing response from cache."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71a3a44587a65fc80342f0d27d478666cdaaf57e", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/71a3a44587a65fc80342f0d27d478666cdaaf57e", "committedDate": "2020-10-12T17:34:18Z", "message": "Update test fixture"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2ODE0OTI5", "url": "https://github.com/apollographql/apollo-android/pull/2648#pullrequestreview-506814929", "createdAt": "2020-10-12T17:57:39Z", "commit": {"oid": "71a3a44587a65fc80342f0d27d478666cdaaf57e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4146, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}