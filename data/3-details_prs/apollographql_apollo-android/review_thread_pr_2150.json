{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMDI5NTE5", "number": 2150, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMDoyMTozMFrODw2ZZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxNzowMTo1M1rODw9xKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNTQ5NDc4OnYy", "diffSide": "RIGHT", "path": "apollo-api/src/commonMain/kotlin/com/apollographql/apollo/api/internal/OperationRequestBodyComposer.kt", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMDoyMTozMFrOGEEyMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMDoyMTozMFrOGEEyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkyNTg3Mw==", "bodyText": "If we use use function, then this close will be called automatically and safer.", "url": "https://github.com/apollographql/apollo-android/pull/2150#discussion_r406925873", "createdAt": "2020-04-10T20:21:30Z", "author": {"login": "tasomaniac"}, "path": "apollo-api/src/commonMain/kotlin/com/apollographql/apollo/api/internal/OperationRequestBodyComposer.kt", "diffHunk": "@@ -0,0 +1,46 @@\n+package com.apollographql.apollo.api.internal\n+\n+import com.apollographql.apollo.api.Operation\n+import com.apollographql.apollo.api.ScalarTypeAdapters\n+import com.apollographql.apollo.api.internal.json.JsonWriter\n+import okio.Buffer\n+import okio.ByteString\n+import kotlin.jvm.JvmStatic\n+\n+object OperationRequestBodyComposer {\n+\n+  @JvmStatic\n+  fun compose(\n+      operation: Operation<*, *, *>,\n+      autoPersistQueries: Boolean,\n+      withQueryDocument: Boolean,\n+      scalarTypeAdapters: ScalarTypeAdapters\n+  ): ByteString {\n+    return Buffer().apply {\n+      JsonWriter.of(this)\n+          .apply { serializeNulls = true }\n+          .beginObject()\n+          .name(\"operationName\").value(operation.name().name())\n+          .name(\"variables\").jsonValue(operation.variables().marshal(scalarTypeAdapters))\n+          .apply {\n+            if (autoPersistQueries) {\n+              name(\"extensions\")\n+                  .beginObject()\n+                  .name(\"persistedQuery\")\n+                  .beginObject()\n+                  .name(\"version\").value(1)\n+                  .name(\"sha256Hash\").value(operation.operationId())\n+                  .endObject()\n+                  .endObject()\n+            }\n+          }\n+          .apply {\n+            if (withQueryDocument) {\n+              name(\"query\").value(operation.queryDocument())\n+            }\n+          }\n+          .endObject()\n+          .close()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f903d87815565e84d703eb0965e40585ec6be3f"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNjY5OTgzOnYy", "diffSide": "RIGHT", "path": "apollo-api/src/commonMain/kotlin/com/apollographql/apollo/api/Operation.kt", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxNjo1ODozNFrOGEOjnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMzowMDoyNVrOGERvRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA4NTk4Mw==", "bodyText": "Just curious: what's the advantage of  exposing a ByteString instead of a String ? Do we support something else than utf8 ?", "url": "https://github.com/apollographql/apollo-android/pull/2150#discussion_r407085983", "createdAt": "2020-04-11T16:58:34Z", "author": {"login": "martinbonnin"}, "path": "apollo-api/src/commonMain/kotlin/com/apollographql/apollo/api/Operation.kt", "diffHunk": "@@ -60,6 +61,34 @@ interface Operation<D : Operation.Data, T, V : Operation.Variables> {\n   @Throws(IOException::class)\n   fun parse(source: BufferedSource): Response<T>\n \n+  /**\n+   * Composes POST JSON-encoded request body with provided [scalarTypeAdapters] to be sent to the GraphQL server.\n+   *\n+   * *Example*:\n+   * ```\n+   * {\n+   *    \"query\": \"query TestQuery($episode: Episode) { hero(episode: $episode) { name } }\",\n+   *    \"operationName\": \"TestQuery\",\n+   *    \"variables\": { \"episode\": \"JEDI\" }\n+   * }\n+   * ```\n+   */\n+  fun composeRequestBody(scalarTypeAdapters: ScalarTypeAdapters): ByteString", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49b27fb85a0d43520eb1c254dac1a5b5206fff6d"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzODExNw==", "bodyText": "Sure we can make it as a String, I was optimizing for okhttp3.RequestBody\nhttps://github.com/square/okhttp/blob/master/okhttp/src/main/kotlin/okhttp3/RequestBody.kt#L105\nin case of string it will convert it to back to byte array, so we are saving here extra conversions bytestring -> string -> bytestring.", "url": "https://github.com/apollographql/apollo-android/pull/2150#discussion_r407138117", "createdAt": "2020-04-12T03:00:25Z", "author": {"login": "sav007"}, "path": "apollo-api/src/commonMain/kotlin/com/apollographql/apollo/api/Operation.kt", "diffHunk": "@@ -60,6 +61,34 @@ interface Operation<D : Operation.Data, T, V : Operation.Variables> {\n   @Throws(IOException::class)\n   fun parse(source: BufferedSource): Response<T>\n \n+  /**\n+   * Composes POST JSON-encoded request body with provided [scalarTypeAdapters] to be sent to the GraphQL server.\n+   *\n+   * *Example*:\n+   * ```\n+   * {\n+   *    \"query\": \"query TestQuery($episode: Episode) { hero(episode: $episode) { name } }\",\n+   *    \"operationName\": \"TestQuery\",\n+   *    \"variables\": { \"episode\": \"JEDI\" }\n+   * }\n+   * ```\n+   */\n+  fun composeRequestBody(scalarTypeAdapters: ScalarTypeAdapters): ByteString", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA4NTk4Mw=="}, "originalCommit": {"oid": "49b27fb85a0d43520eb1c254dac1a5b5206fff6d"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNjcwMjUxOnYy", "diffSide": "RIGHT", "path": "apollo-compiler/src/test/graphql/com/example/arguments_complex/TestQuery.kt", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxNzowMTo1M1rOGEOk8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QwMDoxMDoxNlrOGEZyaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA4NjMyMQ==", "bodyText": "Does this need to be in the generated models ?  What about just having that as an extension function in kotlin ? That's less codegen code to maintain and it'll make it easier to navigate the generated models ?", "url": "https://github.com/apollographql/apollo-android/pull/2150#discussion_r407086321", "createdAt": "2020-04-11T17:01:53Z", "author": {"login": "martinbonnin"}, "path": "apollo-compiler/src/test/graphql/com/example/arguments_complex/TestQuery.kt", "diffHunk": "@@ -72,6 +75,32 @@ data class TestQuery(\n   @Throws(IOException::class)\n   override fun parse(source: BufferedSource): Response<Data> = parse(source, DEFAULT)\n \n+  override fun composeRequestBody(scalarTypeAdapters: ScalarTypeAdapters): ByteString =\n+      OperationRequestBodyComposer.compose(\n+    operation = this,\n+    autoPersistQueries = false,\n+    withQueryDocument = true,\n+    scalarTypeAdapters = scalarTypeAdapters\n+  )\n+\n+  override fun composeRequestBody(): ByteString = OperationRequestBodyComposer.compose(\n+    operation = this,\n+    autoPersistQueries = false,\n+    withQueryDocument = true,\n+    scalarTypeAdapters = DEFAULT\n+  )\n+\n+  override fun composeRequestBody(\n+    autoPersistQueries: Boolean,\n+    withQueryDocument: Boolean,\n+    scalarTypeAdapters: ScalarTypeAdapters\n+  ): ByteString = OperationRequestBodyComposer.compose(\n+    operation = this,\n+    autoPersistQueries = autoPersistQueries,\n+    withQueryDocument = withQueryDocument,\n+    scalarTypeAdapters = scalarTypeAdapters\n+  )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49b27fb85a0d43520eb1c254dac1a5b5206fff6d"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzODc2OA==", "bodyText": "I see you concern but I think it should be part of generated models for 2 reasons:\n\nas it's a symmetric to the generated method implementation of Operation.parse\nand it's more nicer API from the iOS user perspective", "url": "https://github.com/apollographql/apollo-android/pull/2150#discussion_r407138768", "createdAt": "2020-04-12T03:09:32Z", "author": {"login": "sav007"}, "path": "apollo-compiler/src/test/graphql/com/example/arguments_complex/TestQuery.kt", "diffHunk": "@@ -72,6 +75,32 @@ data class TestQuery(\n   @Throws(IOException::class)\n   override fun parse(source: BufferedSource): Response<Data> = parse(source, DEFAULT)\n \n+  override fun composeRequestBody(scalarTypeAdapters: ScalarTypeAdapters): ByteString =\n+      OperationRequestBodyComposer.compose(\n+    operation = this,\n+    autoPersistQueries = false,\n+    withQueryDocument = true,\n+    scalarTypeAdapters = scalarTypeAdapters\n+  )\n+\n+  override fun composeRequestBody(): ByteString = OperationRequestBodyComposer.compose(\n+    operation = this,\n+    autoPersistQueries = false,\n+    withQueryDocument = true,\n+    scalarTypeAdapters = DEFAULT\n+  )\n+\n+  override fun composeRequestBody(\n+    autoPersistQueries: Boolean,\n+    withQueryDocument: Boolean,\n+    scalarTypeAdapters: ScalarTypeAdapters\n+  ): ByteString = OperationRequestBodyComposer.compose(\n+    operation = this,\n+    autoPersistQueries = autoPersistQueries,\n+    withQueryDocument = withQueryDocument,\n+    scalarTypeAdapters = scalarTypeAdapters\n+  )", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA4NjMyMQ=="}, "originalCommit": {"oid": "49b27fb85a0d43520eb1c254dac1a5b5206fff6d"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE4ODUwNQ==", "bodyText": "as it's a symmetric to the generated method implementation of Operation.parse\n\nCould Operation.parse be made an extension method ?\n\nand it's more nicer API from the iOS user perspective\n\nIndeed. Although I guess a lot of users might still consume this API from Kotlin but for those consuming it in Swift, that'll be way better \ud83d\udc4d", "url": "https://github.com/apollographql/apollo-android/pull/2150#discussion_r407188505", "createdAt": "2020-04-12T12:02:45Z", "author": {"login": "martinbonnin"}, "path": "apollo-compiler/src/test/graphql/com/example/arguments_complex/TestQuery.kt", "diffHunk": "@@ -72,6 +75,32 @@ data class TestQuery(\n   @Throws(IOException::class)\n   override fun parse(source: BufferedSource): Response<Data> = parse(source, DEFAULT)\n \n+  override fun composeRequestBody(scalarTypeAdapters: ScalarTypeAdapters): ByteString =\n+      OperationRequestBodyComposer.compose(\n+    operation = this,\n+    autoPersistQueries = false,\n+    withQueryDocument = true,\n+    scalarTypeAdapters = scalarTypeAdapters\n+  )\n+\n+  override fun composeRequestBody(): ByteString = OperationRequestBodyComposer.compose(\n+    operation = this,\n+    autoPersistQueries = false,\n+    withQueryDocument = true,\n+    scalarTypeAdapters = DEFAULT\n+  )\n+\n+  override fun composeRequestBody(\n+    autoPersistQueries: Boolean,\n+    withQueryDocument: Boolean,\n+    scalarTypeAdapters: ScalarTypeAdapters\n+  ): ByteString = OperationRequestBodyComposer.compose(\n+    operation = this,\n+    autoPersistQueries = autoPersistQueries,\n+    withQueryDocument = withQueryDocument,\n+    scalarTypeAdapters = scalarTypeAdapters\n+  )", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA4NjMyMQ=="}, "originalCommit": {"oid": "49b27fb85a0d43520eb1c254dac1a5b5206fff6d"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2OTk5NQ==", "bodyText": "Yeah we could make parse as extension function but again for Swift consumers it won't be very nice experience.", "url": "https://github.com/apollographql/apollo-android/pull/2150#discussion_r407269995", "createdAt": "2020-04-13T00:10:16Z", "author": {"login": "sav007"}, "path": "apollo-compiler/src/test/graphql/com/example/arguments_complex/TestQuery.kt", "diffHunk": "@@ -72,6 +75,32 @@ data class TestQuery(\n   @Throws(IOException::class)\n   override fun parse(source: BufferedSource): Response<Data> = parse(source, DEFAULT)\n \n+  override fun composeRequestBody(scalarTypeAdapters: ScalarTypeAdapters): ByteString =\n+      OperationRequestBodyComposer.compose(\n+    operation = this,\n+    autoPersistQueries = false,\n+    withQueryDocument = true,\n+    scalarTypeAdapters = scalarTypeAdapters\n+  )\n+\n+  override fun composeRequestBody(): ByteString = OperationRequestBodyComposer.compose(\n+    operation = this,\n+    autoPersistQueries = false,\n+    withQueryDocument = true,\n+    scalarTypeAdapters = DEFAULT\n+  )\n+\n+  override fun composeRequestBody(\n+    autoPersistQueries: Boolean,\n+    withQueryDocument: Boolean,\n+    scalarTypeAdapters: ScalarTypeAdapters\n+  ): ByteString = OperationRequestBodyComposer.compose(\n+    operation = this,\n+    autoPersistQueries = autoPersistQueries,\n+    withQueryDocument = withQueryDocument,\n+    scalarTypeAdapters = scalarTypeAdapters\n+  )", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA4NjMyMQ=="}, "originalCommit": {"oid": "49b27fb85a0d43520eb1c254dac1a5b5206fff6d"}, "originalPosition": 52}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3181, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}