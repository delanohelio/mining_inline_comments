{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3NTg4MzMw", "number": 2063, "title": "Refactor `ScalarType`", "bodyText": "Replace javaType(): Class<*> with className(): String for better support of KN", "createdAt": "2020-03-13T04:41:39Z", "url": "https://github.com/apollographql/apollo-android/pull/2063", "merged": true, "mergeCommit": {"oid": "9e06dfc74eb6ee9a97f74e04b859a8579dd5f35b"}, "closed": true, "closedAt": "2020-03-14T23:16:18Z", "author": {"login": "sav007"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNYQYrgH2gAyMzg3NTg4MzMwOjc3YjExOTE3YTRjYWFhYzEzZmQ4MmNkOTA5ODI5MmIzN2E1YWExMGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNtL6LAFqTM3NDc1OTY1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "77b11917a4caaac13fd82cd9098292b37a5aa10f", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/77b11917a4caaac13fd82cd9098292b37a5aa10f", "committedDate": "2020-03-13T22:42:43Z", "message": "Refactor `ScalarType`\n\nReplace `javaType(): Class<*>` with `className(): String` for better support of KN"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "266075b5d0e8cec4f68a593f4769be6cd50bd371", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/266075b5d0e8cec4f68a593f4769be6cd50bd371", "committedDate": "2020-03-13T22:42:43Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3adc7d8a424e63ac6d46cfb6a6d0b315416c835f", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/3adc7d8a424e63ac6d46cfb6a6d0b315416c835f", "committedDate": "2020-03-13T22:55:07Z", "message": "Rebase + fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dec2486eef5ca7282307043f06a23526b44e01ba", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/dec2486eef5ca7282307043f06a23526b44e01ba", "committedDate": "2020-03-13T05:31:14Z", "message": "Fix tests"}, "afterCommit": {"oid": "3adc7d8a424e63ac6d46cfb6a6d0b315416c835f", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/3adc7d8a424e63ac6d46cfb6a6d0b315416c835f", "committedDate": "2020-03-13T22:55:07Z", "message": "Rebase + fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NzA1OTUz", "url": "https://github.com/apollographql/apollo-android/pull/2063#pullrequestreview-374705953", "createdAt": "2020-03-14T07:56:20Z", "commit": {"oid": "3adc7d8a424e63ac6d46cfb6a6d0b315416c835f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NzA2MTM3", "url": "https://github.com/apollographql/apollo-android/pull/2063#pullrequestreview-374706137", "createdAt": "2020-03-14T08:00:06Z", "commit": {"oid": "3adc7d8a424e63ac6d46cfb6a6d0b315416c835f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQwODowMDowN1rOF2YW5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQwODowMToyOFrOF2YXQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU2NjUwMA==", "bodyText": "Is java.lang.String enough or should we also check other Strings? Like I wonder what would happen on iOS. Of course can be tackled later.", "url": "https://github.com/apollographql/apollo-android/pull/2063#discussion_r392566500", "createdAt": "2020-03-14T08:00:07Z", "author": {"login": "tasomaniac"}, "path": "apollo-api/src/commonMain/kotlin/com/apollographql/apollo/api/ScalarTypeAdapters.kt", "diffHunk": "@@ -1,10 +1,117 @@\n package com.apollographql.apollo.api\n \n-expect class ScalarTypeAdapters(customAdapters: Map<ScalarType, CustomTypeAdapter<*>>) {\n+import com.apollographql.apollo.api.CustomTypeValue.*\n+import com.apollographql.apollo.api.CustomTypeValue.Companion.fromRawValue\n+import com.apollographql.apollo.api.internal.json.JsonWriter\n+import com.apollographql.apollo.api.internal.json.Utils\n+import com.apollographql.apollo.api.internal.json.use\n+import okio.Buffer\n+import kotlin.jvm.JvmField\n \n-  fun <T : Any> adapterFor(scalarType: ScalarType): CustomTypeAdapter<T>\n+class ScalarTypeAdapters(customAdapters: Map<ScalarType, CustomTypeAdapter<*>>) {\n+  private val customAdapters = customAdapters.mapKeys { it.key.typeName() }\n+\n+  @Suppress(\"UNCHECKED_CAST\")\n+  fun <T : Any> adapterFor(scalarType: ScalarType): CustomTypeAdapter<T> {\n+    var customTypeAdapter: CustomTypeAdapter<*>? = customAdapters[scalarType.typeName()]\n+    if (customTypeAdapter == null) {\n+      customTypeAdapter = DEFAULT_ADAPTERS[scalarType.className()]\n+    }\n+    return requireNotNull(customTypeAdapter) {\n+      \"Can't map GraphQL type: `${scalarType.typeName()}` to: `${scalarType.className()}`. Did you forget to add a custom type adapter?\"\n+    } as CustomTypeAdapter<T>\n+  }\n \n   companion object {\n-    val DEFAULT: ScalarTypeAdapters\n+    @JvmField\n+    val DEFAULT = ScalarTypeAdapters(emptyMap())\n+\n+    private val DEFAULT_ADAPTERS = emptyMap<String, CustomTypeAdapter<*>>() +\n+        createDefaultScalarTypeAdapter(\"java.lang.String\", \"kotlin.String\") { value ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3adc7d8a424e63ac6d46cfb6a6d0b315416c835f"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU2NjU5NQ==", "bodyText": "Why does this say Double for FileUpload?", "url": "https://github.com/apollographql/apollo-android/pull/2063#discussion_r392566595", "createdAt": "2020-03-14T08:01:28Z", "author": {"login": "tasomaniac"}, "path": "apollo-api/src/commonMain/kotlin/com/apollographql/apollo/api/ScalarTypeAdapters.kt", "diffHunk": "@@ -1,10 +1,117 @@\n package com.apollographql.apollo.api\n \n-expect class ScalarTypeAdapters(customAdapters: Map<ScalarType, CustomTypeAdapter<*>>) {\n+import com.apollographql.apollo.api.CustomTypeValue.*\n+import com.apollographql.apollo.api.CustomTypeValue.Companion.fromRawValue\n+import com.apollographql.apollo.api.internal.json.JsonWriter\n+import com.apollographql.apollo.api.internal.json.Utils\n+import com.apollographql.apollo.api.internal.json.use\n+import okio.Buffer\n+import kotlin.jvm.JvmField\n \n-  fun <T : Any> adapterFor(scalarType: ScalarType): CustomTypeAdapter<T>\n+class ScalarTypeAdapters(customAdapters: Map<ScalarType, CustomTypeAdapter<*>>) {\n+  private val customAdapters = customAdapters.mapKeys { it.key.typeName() }\n+\n+  @Suppress(\"UNCHECKED_CAST\")\n+  fun <T : Any> adapterFor(scalarType: ScalarType): CustomTypeAdapter<T> {\n+    var customTypeAdapter: CustomTypeAdapter<*>? = customAdapters[scalarType.typeName()]\n+    if (customTypeAdapter == null) {\n+      customTypeAdapter = DEFAULT_ADAPTERS[scalarType.className()]\n+    }\n+    return requireNotNull(customTypeAdapter) {\n+      \"Can't map GraphQL type: `${scalarType.typeName()}` to: `${scalarType.className()}`. Did you forget to add a custom type adapter?\"\n+    } as CustomTypeAdapter<T>\n+  }\n \n   companion object {\n-    val DEFAULT: ScalarTypeAdapters\n+    @JvmField\n+    val DEFAULT = ScalarTypeAdapters(emptyMap())\n+\n+    private val DEFAULT_ADAPTERS = emptyMap<String, CustomTypeAdapter<*>>() +\n+        createDefaultScalarTypeAdapter(\"java.lang.String\", \"kotlin.String\") { value ->\n+          if (value is GraphQLJsonList || value is GraphQLJsonObject) {\n+            val buffer = Buffer()\n+            JsonWriter.of(buffer).use { writer ->\n+              Utils.writeToJson(value.value, writer)\n+            }\n+            buffer.readUtf8()\n+          } else {\n+            value.value.toString()\n+          }\n+        } +\n+        createDefaultScalarTypeAdapter(\"java.lang.Boolean\", \"kotlin.Boolean\") { value ->\n+          when (value) {\n+            is GraphQLBoolean -> value.value\n+            is GraphQLString -> value.value.toBoolean()\n+            else -> throw IllegalArgumentException(\"Can't decode: $value into Boolean\")\n+          }\n+        } +\n+        createDefaultScalarTypeAdapter(\"java.lang.Integer\", \"kotlin.Int\") { value ->\n+          when (value) {\n+            is GraphQLNumber -> value.value.toInt()\n+            is GraphQLString -> value.value.toInt()\n+            else -> throw IllegalArgumentException(\"Can't decode: $value into Integer\")\n+          }\n+        } +\n+        createDefaultScalarTypeAdapter(\"java.lang.Long\", \"kotlin.Long\") { value ->\n+          when (value) {\n+            is GraphQLNumber -> value.value.toLong()\n+            is GraphQLString -> value.value.toLong()\n+            else -> throw IllegalArgumentException(\"Can't decode: $value into Long\")\n+          }\n+        } +\n+        createDefaultScalarTypeAdapter(\"java.lang.Float\", \"kotlin.Float\") { value ->\n+          when (value) {\n+            is GraphQLNumber -> value.value.toFloat()\n+            is GraphQLString -> value.value.toFloat()\n+            else -> throw IllegalArgumentException(\"Can't decode: $value into Float\")\n+          }\n+        } +\n+        createDefaultScalarTypeAdapter(\"java.lang.Double\", \"kotlin.Double\") { value ->\n+          when (value) {\n+            is GraphQLNumber -> value.value.toDouble()\n+            is GraphQLString -> value.value.toDouble()\n+            else -> throw IllegalArgumentException(\"Can't decode: $value into Double\")\n+          }\n+        } +\n+        createDefaultScalarTypeAdapter(FileUpload::class.qualifiedName!!) { value ->\n+          when (value) {\n+            is GraphQLNumber -> value.value.toDouble()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3adc7d8a424e63ac6d46cfb6a6d0b315416c835f"}, "originalPosition": 81}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f62e932c1b857411f29a3ef5fd91adf7ac743dd8", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/f62e932c1b857411f29a3ef5fd91adf7ac743dd8", "committedDate": "2020-03-14T22:37:40Z", "message": "Fix file upload scalar type adapter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NzU5NDQ3", "url": "https://github.com/apollographql/apollo-android/pull/2063#pullrequestreview-374759447", "createdAt": "2020-03-14T22:59:38Z", "commit": {"oid": "f62e932c1b857411f29a3ef5fd91adf7ac743dd8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NzU5NjU4", "url": "https://github.com/apollographql/apollo-android/pull/2063#pullrequestreview-374759658", "createdAt": "2020-03-14T23:05:50Z", "commit": {"oid": "f62e932c1b857411f29a3ef5fd91adf7ac743dd8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4090, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}