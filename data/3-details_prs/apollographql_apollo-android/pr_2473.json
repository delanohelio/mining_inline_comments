{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2NjM4MTQx", "number": 2473, "title": "[apollo-api] Parse Longs only once", "bodyText": "First (baby) step toward removing BigDecimal as a mandatory intermediate when converting from json to GraphQL Int and Double: Remove the default adapters for Float and Long.\nEdit: After some investigation, this pull request keeps the DEFAULT_ADAPTERS for now as that would be a breaking change. It still optimizes the parsing of Longs. There is no need to parse from String again since BufferedSourceJsonReader already parses internally.\nFollow up issue about removing DEFAULT_ADAPTERS there: #2486", "createdAt": "2020-07-25T16:48:53Z", "url": "https://github.com/apollographql/apollo-android/pull/2473", "merged": true, "mergeCommit": {"oid": "d8d701fc14464ba3ee3e7d92fe7e76a4af0070a3"}, "closed": true, "closedAt": "2020-07-29T22:12:22Z", "author": {"login": "martinbonnin"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc4Eop4AH2gAyNDU2NjM4MTQxOmI1MjljNDZiZTc4MTA0NzZhOTNjMWNmZDRkZmM1NDhiNDc5MTdiMmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5yMingFqTQ1NzkyMjQ3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b529c46be7810476a93c1cfd4dfc548b47917b2d", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/b529c46be7810476a93c1cfd4dfc548b47917b2d", "committedDate": "2020-07-24T14:09:52Z", "message": "set version to 3.0.0-alpha01"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "97bb821d29b72b4ec667dd837cf6db8a95ec10ff", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/97bb821d29b72b4ec667dd837cf6db8a95ec10ff", "committedDate": "2020-07-25T16:05:03Z", "message": "remove Long and Float default adapters"}, "afterCommit": {"oid": "ca51f3370f21c0d4fab7e809eeca42b7767f27b3", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/ca51f3370f21c0d4fab7e809eeca42b7767f27b3", "committedDate": "2020-07-25T16:49:26Z", "message": "remove Long and Float default adapters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8971baf234dc75ea8feb20acc77e42f0358a0a7c", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/8971baf234dc75ea8feb20acc77e42f0358a0a7c", "committedDate": "2020-07-25T16:50:40Z", "message": "remove Long and Float default adapters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ca51f3370f21c0d4fab7e809eeca42b7767f27b3", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/ca51f3370f21c0d4fab7e809eeca42b7767f27b3", "committedDate": "2020-07-25T16:49:26Z", "message": "remove Long and Float default adapters"}, "afterCommit": {"oid": "8971baf234dc75ea8feb20acc77e42f0358a0a7c", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/8971baf234dc75ea8feb20acc77e42f0358a0a7c", "committedDate": "2020-07-25T16:50:40Z", "message": "remove Long and Float default adapters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71046fdcc84d68f0b8ba3173d504fdbdf4893fff", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/71046fdcc84d68f0b8ba3173d504fdbdf4893fff", "committedDate": "2020-07-27T09:43:38Z", "message": "remove unused methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd72eccc7dc3746ddd933eccca6c58f29b0201b6", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/fd72eccc7dc3746ddd933eccca6c58f29b0201b6", "committedDate": "2020-07-27T12:43:45Z", "message": "add a performance test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7153df195003ab3dd8c1974caadc990732eedcb", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/b7153df195003ab3dd8c1974caadc990732eedcb", "committedDate": "2020-07-27T14:50:17Z", "message": "add some float tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "581b159f5d789504f6cadfb09f373f48605e3a8a", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/581b159f5d789504f6cadfb09f373f48605e3a8a", "committedDate": "2020-07-27T15:39:36Z", "message": "parse Longs only once"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42bae64e70bc9d8dfa4ef9157544b63ca64ed6e2", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/42bae64e70bc9d8dfa4ef9157544b63ca64ed6e2", "committedDate": "2020-07-27T15:42:40Z", "message": "update comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MjAwMzk2", "url": "https://github.com/apollographql/apollo-android/pull/2473#pullrequestreview-456200396", "createdAt": "2020-07-27T23:23:10Z", "commit": {"oid": "42bae64e70bc9d8dfa4ef9157544b63ca64ed6e2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMzoyMzoxMFrOG32_1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QyMzoyMzoxMFrOG32_1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTIyNTk0MA==", "bodyText": "Is there any reason to not use our JsonWriter to compose test json? I mean at least we can avoid extra dependency to kotlinx-serialization that is used as far as I understood only for this test?", "url": "https://github.com/apollographql/apollo-android/pull/2473#discussion_r461225940", "createdAt": "2020-07-27T23:23:10Z", "author": {"login": "sav007"}, "path": "apollo-integration/src/test/java/com/apollographql/apollo/performance/NumberParsingTest.kt", "diffHunk": "@@ -0,0 +1,103 @@\n+package com.apollographql.apollo.performance\n+\n+import com.apollographql.apollo.ApolloClient\n+import com.apollographql.apollo.Utils.immediateExecutor\n+import com.apollographql.apollo.Utils.immediateExecutorService\n+import com.apollographql.apollo.api.internal.SimpleOperationResponseParser\n+import com.apollographql.apollo.fetcher.ApolloResponseFetchers\n+import com.apollographql.apollo.integration.performance.GetFloatsQuery\n+import com.apollographql.apollo.integration.performance.GetIntsQuery\n+import kotlinx.coroutines.runBlocking\n+import kotlinx.serialization.json.JsonArray\n+import kotlinx.serialization.json.JsonObject\n+import kotlinx.serialization.json.JsonPrimitive\n+import okhttp3.Dispatcher\n+import okhttp3.OkHttpClient\n+import okio.ByteString\n+import okio.ByteString.Companion.encodeUtf8\n+import kotlin.random.Random\n+import kotlin.test.Test\n+import kotlin.time.ExperimentalTime\n+import kotlin.time.measureTime\n+\n+data class Data(\n+    val randomInts: List<Int>\n+)\n+\n+/**\n+ * These tests are disabled by default. Set the `runPerformanceTests` property to run them:\n+ * ./gradlew :apollo-integration:testDebug --tests '*parseFloats*' -DrunPerformanceTests=true\n+ */\n+@OptIn(ExperimentalTime::class)\n+class NumberParsingTest {\n+  /**\n+   * A test to benchmark the parsing of integers in Json.\n+   */\n+  @Test\n+  fun parseInts() {\n+\n+    val random = Random.Default\n+\n+    val data = JsonObject(\n+        mapOf(\n+            \"data\" to JsonObject(\n+                mapOf(\n+                    \"randomInts\" to JsonArray(\n+                        0.until(10000).map {\n+                          JsonPrimitive(random.nextInt())\n+                        }\n+                    )\n+                )\n+            )\n+        )\n+    )\n+\n+    val json = data.toString().encodeUtf8()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42bae64e70bc9d8dfa4ef9157544b63ca64ed6e2"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec6e255d9850a969f21f2a39bae24caaa2639002", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/ec6e255d9850a969f21f2a39bae24caaa2639002", "committedDate": "2020-07-28T09:57:34Z", "message": "remove kotlinx-serialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b880267bb3a34922413bc3d23afd5370bbca211", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/4b880267bb3a34922413bc3d23afd5370bbca211", "committedDate": "2020-07-29T08:09:57Z", "message": "restore the default scalar adapters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd721e022e5ecc2e6b9045fbe9f0f109093204cf", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/bd721e022e5ecc2e6b9045fbe9f0f109093204cf", "committedDate": "2020-07-29T08:13:18Z", "message": "add comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3OTIyNDcy", "url": "https://github.com/apollographql/apollo-android/pull/2473#pullrequestreview-457922472", "createdAt": "2020-07-29T21:48:43Z", "commit": {"oid": "bd721e022e5ecc2e6b9045fbe9f0f109093204cf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4219, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}