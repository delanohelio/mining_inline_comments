{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3MTgzMTg0", "number": 1943, "title": "Add support for auto persisted subscriptions", "bodyText": "Introduce new configuration flag to enable subscription auto persistence feature (it was intentionally introduced as a separate flag to avoid messing with regular subscriptions, though I'm not really confident if need it, we might use the same flag as for regular queries enableAutoPersistedQueries)\nUpdate Start protocol message to support auto persistence\nHandle subscription protocol negotiation errors and resend Start message with subscription document\nTests.\n\nCloses #1850", "createdAt": "2020-01-26T05:15:15Z", "url": "https://github.com/apollographql/apollo-android/pull/1943", "merged": true, "mergeCommit": {"oid": "0b480c725ae352815ec05451fc2667319c15f8d0"}, "closed": true, "closedAt": "2020-01-29T23:02:13Z", "author": {"login": "sav007"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-BGCaAH2gAyMzY3MTgzMTg0OjU4MDlmY2UzNzRjYzdmODM2Mzg5Y2I2MjBjYmM1ZDRkNzQ4NTIyOWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_NOt-AFqTM1MDQ1MzE5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5809fce374cc7f836389cb620cbc5d4d7485229c", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/5809fce374cc7f836389cb620cbc5d4d7485229c", "committedDate": "2020-01-26T05:14:44Z", "message": "Add support for auto persisted subscriptions\n\n- Introduce new configuration flag to enable subscription auto persistence feature (it was intentionally introduced as a separate flag to avoid messing with regular subscriptions, though I'm not really confident if need it, we might use the same flag as for regular queries `enableAutoPersistedQueries`)\n- Update `Start` protocol message to support auto persistence\n- Handle subscription `protocol negotiation errors` and resend `Start` message with subscription document\n- Tests.\n\nCloses https://github.com/apollographql/apollo-android/issues/1850"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4Mzg4NzM5", "url": "https://github.com/apollographql/apollo-android/pull/1943#pullrequestreview-348388739", "createdAt": "2020-01-26T16:02:19Z", "commit": {"oid": "5809fce374cc7f836389cb620cbc5d4d7485229c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNlQxNjowMjoxOVrOFh0q0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNlQxNjowMzozM1rOFh0rLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAxMDI1OA==", "bodyText": "Should this just be queryHashMethod? It's not necessarily sha256", "url": "https://github.com/apollographql/apollo-android/pull/1943#discussion_r371010258", "createdAt": "2020-01-26T16:02:19Z", "author": {"login": "kenyee"}, "path": "apollo-runtime/src/main/java/com/apollographql/apollo/subscription/OperationClientMessage.java", "diffHunk": "@@ -62,26 +62,48 @@ public Init(@NotNull Map<String, Object> connectionParams) {\n     private static final String JSON_KEY_QUERY = \"query\";\n     private static final String JSON_KEY_VARIABLES = \"variables\";\n     private static final String JSON_KEY_OPERATION_NAME = \"operationName\";\n+    private static final String JSON_KEY_EXTENSIONS = \"extensions\";\n+    private static final String JSON_KEY_EXTENSIONS_PERSISTED_QUERY = \"persistedQuery\";\n+    private static final String JSON_KEY_EXTENSIONS_PERSISTED_QUERY_VERSION = \"version\";\n+    private static final String JSON_KEY_EXTENSIONS_PERSISTED_QUERY_HASH = \"sha256Hash\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5809fce374cc7f836389cb620cbc5d4d7485229c"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAxMDM1MA==", "bodyText": "Nice renaming of this method \ud83d\ude42", "url": "https://github.com/apollographql/apollo-android/pull/1943#discussion_r371010350", "createdAt": "2020-01-26T16:03:33Z", "author": {"login": "kenyee"}, "path": "apollo-runtime/src/main/java/com/apollographql/apollo/response/OperationResponseParser.java", "diffHunk": "@@ -130,15 +130,15 @@ public OperationResponseParser(Operation<D, W, ?> operation, ResponseFieldMapper\n       @Override public Error read(ResponseJsonStreamReader reader) throws IOException {\n         return reader.nextObject(true, new ResponseJsonStreamReader.ObjectReader<Error>() {\n           @Override public Error read(ResponseJsonStreamReader reader) throws IOException {\n-            return readError(reader.toMap());\n+            return parseError(reader.toMap());\n           }\n         });\n       }\n     });\n   }\n \n   @SuppressWarnings(\"unchecked\")\n-  private Error readError(Map<String, Object> payload) {\n+  public static Error parseError(Map<String, Object> payload) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5809fce374cc7f836389cb620cbc5d4d7485229c"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NzMyNzg1", "url": "https://github.com/apollographql/apollo-android/pull/1943#pullrequestreview-349732785", "createdAt": "2020-01-28T21:56:17Z", "commit": {"oid": "5809fce374cc7f836389cb620cbc5d4d7485229c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMTo1NjoxOFrOFi2BRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMTo1NjoxOFrOFi2BRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA4MDk2Ng==", "bodyText": "This looks little weird in terms of code style. Would be nice to leave this false alone", "url": "https://github.com/apollographql/apollo-android/pull/1943#discussion_r372080966", "createdAt": "2020-01-28T21:56:18Z", "author": {"login": "tasomaniac"}, "path": "apollo-runtime/src/main/java/com/apollographql/apollo/internal/subscription/RealSubscriptionManager.java", "diffHunk": "@@ -165,13 +170,16 @@ void doSubscribe(Subscription subscription, SubscriptionManager.Callback callbac\n         timer.cancelTask(INACTIVITY_TIMEOUT_TIMER_TASK_ID);\n \n         final UUID subscriptionId = UUID.randomUUID();\n-\n         subscriptions.put(subscriptionId, new SubscriptionRecord(subscriptionId, subscription, callback));\n+\n         if (state == SubscriptionManagerState.DISCONNECTED) {\n           state = SubscriptionManagerState.CONNECTING;\n           transport.connect();\n         } else if (state == SubscriptionManagerState.ACTIVE) {\n-          transport.send(new OperationClientMessage.Start(subscriptionId.toString(), subscription, scalarTypeAdapters));\n+          transport.send(\n+              new OperationClientMessage.Start(subscriptionId.toString(), subscription, scalarTypeAdapters, autoPersistSubscription,\n+                  false)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5809fce374cc7f836389cb620cbc5d4d7485229c"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33d743d5e65a33c2c4fb033ee5ec14b7324f418c", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/33d743d5e65a33c2c4fb033ee5ec14b7324f418c", "committedDate": "2020-01-29T21:36:41Z", "message": "Feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e9b4d50739d856a1e5230d85954c824fb244ecf", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/7e9b4d50739d856a1e5230d85954c824fb244ecf", "committedDate": "2020-01-29T21:37:57Z", "message": "Lint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNDUzMTk1", "url": "https://github.com/apollographql/apollo-android/pull/1943#pullrequestreview-350453195", "createdAt": "2020-01-29T21:57:00Z", "commit": {"oid": "7e9b4d50739d856a1e5230d85954c824fb244ecf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4014, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}