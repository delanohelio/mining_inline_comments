{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4MjE5MzEz", "number": 2776, "title": "Add interface for classes generated for enum types and fix sealed classes json representation", "bodyText": "Objects representing enums in sealed classes don't have stable toString() implementation: instead, they'll return the class name along with memory address for that object. This breaks SQLite-based caching for queries that accept enum parameters, as toString() is used to generate the query key, so it would change between app restarts. This commit fixes this behavior by adding an EnumValue interface to types representing enums, and using its rawValue property to build proper cache key.\nFixes #2775", "createdAt": "2020-11-26T18:11:55Z", "url": "https://github.com/apollographql/apollo-android/pull/2776", "merged": true, "mergeCommit": {"oid": "3dc1db1d8a28bc58a12005f8a9f8d45d01f6ba15"}, "closed": true, "closedAt": "2020-11-30T09:08:23Z", "author": {"login": "lwasyl"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgXGI4AFqTUzOTQ5OTk3Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgbzOaABqjQwNDQwNzk4MDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NDk5OTc3", "url": "https://github.com/apollographql/apollo-android/pull/2776#pullrequestreview-539499977", "createdAt": "2020-11-26T18:15:29Z", "commit": {"oid": "1d67c78800f32224143f43c65971318371c96da5"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxODoxNTozMFrOH6kjtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxODoxNjozMFrOH6kk6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE3ODQyMQ==", "bodyText": "I kind of wanted to follow ScalarType naming, but of course can change it to whatever is more appropriate.\nAlso, @martinbonnin suggested using an interface (#2775 (comment)), but I wasn't sure it's okay to have a default method with toString implementation. And if the idea was to add a case here then of course I can also do that, it's just overriding toString feels like a good solution", "url": "https://github.com/apollographql/apollo-android/pull/2776#discussion_r531178421", "createdAt": "2020-11-26T18:15:30Z", "author": {"login": "lwasyl"}, "path": "apollo-api/src/commonMain/kotlin/com/apollographql/apollo/api/SealedEnumType.kt", "diffHunk": "@@ -0,0 +1,11 @@\n+package com.apollographql.apollo.api\n+\n+/**\n+ * Base class for an enum type when generating sealed Kotlin class\n+ */\n+abstract class SealedEnumType {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d67c78800f32224143f43c65971318371c96da5"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE3ODcyOQ==", "bodyText": "The primaryConstructorSpec is used also when generating enum class and for Unknown case, so we need a new one that overrides the raw value", "url": "https://github.com/apollographql/apollo-android/pull/2776#discussion_r531178729", "createdAt": "2020-11-26T18:16:30Z", "author": {"login": "lwasyl"}, "path": "apollo-compiler/src/main/kotlin/com/apollographql/apollo/compiler/codegen/kotlin/EnumType.kt", "diffHunk": "@@ -37,6 +38,12 @@ private val primaryConstructorSpec =\n         .addParameter(\"rawValue\", String::class)\n         .build()\n \n+private val sealedSubclassPrimaryConstructorSpec =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d67c78800f32224143f43c65971318371c96da5"}, "originalPosition": 11}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1d67c78800f32224143f43c65971318371c96da5", "author": {"user": {"login": "lwasyl", "name": "\u0141ukasz Wasylkowski"}}, "url": "https://github.com/apollographql/apollo-android/commit/1d67c78800f32224143f43c65971318371c96da5", "committedDate": "2020-11-26T18:06:16Z", "message": "Add toString implementation to sealed classes generated for enum types.\n\nObjects representing enums in sealed classes don't have stable toString() implementation: instead, they'll return the class name along with memory address for that object. This breaks SQLite-based caching for queries that accept enum parameters, as toString() is used to generate the query key, so it would change between app restarts. This commit fixes this behavior by implementing a stable toString() implementation for sealed classes representing enum types.\n\nFixes https://github.com/apollographql/apollo-android/issues/2775"}, "afterCommit": {"oid": "711c2d8206fea239a0f6689549138c6df75e30ac", "author": {"user": {"login": "lwasyl", "name": "\u0141ukasz Wasylkowski"}}, "url": "https://github.com/apollographql/apollo-android/commit/711c2d8206fea239a0f6689549138c6df75e30ac", "committedDate": "2020-11-26T18:48:59Z", "message": "Add toString implementation to sealed classes generated for enum types.\n\nObjects representing enums in sealed classes don't have stable toString() implementation: instead, they'll return the class name along with memory address for that object. This breaks SQLite-based caching for queries that accept enum parameters, as toString() is used to generate the query key, so it would change between app restarts. This commit fixes this behavior by implementing a stable toString() implementation for sealed classes representing enum types.\n\nFixes https://github.com/apollographql/apollo-android/issues/2775"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "569f93375c18440656bcd5bb2a246cb7404371bb", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/569f93375c18440656bcd5bb2a246cb7404371bb", "committedDate": "2020-11-26T20:24:13Z", "message": "added a test for sealed classes cache keys"}, "afterCommit": {"oid": "2a163b0542b9aecec55f0d52701e3654feacac8b", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/2a163b0542b9aecec55f0d52701e3654feacac8b", "committedDate": "2020-11-26T21:44:29Z", "message": "added a test for sealed classes cache keys"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2a163b0542b9aecec55f0d52701e3654feacac8b", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/2a163b0542b9aecec55f0d52701e3654feacac8b", "committedDate": "2020-11-26T21:44:29Z", "message": "added a test for sealed classes cache keys"}, "afterCommit": {"oid": "8153582764492c37e9d16ca396beff18d6033c92", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/8153582764492c37e9d16ca396beff18d6033c92", "committedDate": "2020-11-26T21:51:51Z", "message": "added a test for sealed classes cache keys"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NTc0MjIz", "url": "https://github.com/apollographql/apollo-android/pull/2776#pullrequestreview-539574223", "createdAt": "2020-11-26T23:06:59Z", "commit": {"oid": "8153582764492c37e9d16ca396beff18d6033c92"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQyMzowNzowMFrOH6o24Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQyMzowNzowMFrOH6o24Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI0ODg2NQ==", "bodyText": "Paranoid checks: I think this is a backward compatible change but since it touches regular enums and not only sealed classes this has the potential to impact a lot more users. Are we possibly missing a weird edge case?", "url": "https://github.com/apollographql/apollo-android/pull/2776#discussion_r531248865", "createdAt": "2020-11-26T23:07:00Z", "author": {"login": "martinbonnin"}, "path": "apollo-compiler/src/test/graphql/com/example/java_beans_semantic_naming/type/Episode.kt", "diffHunk": "@@ -5,15 +5,16 @@\n //\n package com.example.java_beans_semantic_naming.type\n \n+import com.apollographql.apollo.api.EnumValue\n import kotlin.Deprecated\n import kotlin.String\n \n /**\n  * The episodes in the Star Wars trilogy\n  */\n enum class Episode(\n-  val rawValue: String\n-) {\n+  override val rawValue: String\n+) : EnumValue {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8153582764492c37e9d16ca396beff18d6033c92"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NTc3NTM5", "url": "https://github.com/apollographql/apollo-android/pull/2776#pullrequestreview-539577539", "createdAt": "2020-11-26T23:27:40Z", "commit": {"oid": "8153582764492c37e9d16ca396beff18d6033c92"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cedb6c1cb0d07d14062e0cbc91ab28a2cbcb4d0", "author": {"user": {"login": "lwasyl", "name": "\u0141ukasz Wasylkowski"}}, "url": "https://github.com/apollographql/apollo-android/commit/2cedb6c1cb0d07d14062e0cbc91ab28a2cbcb4d0", "committedDate": "2020-11-26T23:43:26Z", "message": "Make generated classes for enum types implement a common interface\n\nObjects representing enums in sealed classes don't have stable toString() implementation: instead, they'll return the class name along with memory address for that object. This breaks SQLite-based caching for queries that accept enum parameters, as toString() is used to generate the query key, so it would change between app restarts. This commit fixes this behavior by adding an EnumValue interface to types representing enums, and using its `rawValue` property to build proper cache key.\n\nFixes https://github.com/apollographql/apollo-android/issues/2775"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf77715678d63cf96117e1f618bdc4f917d1a363", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/bf77715678d63cf96117e1f618bdc4f917d1a363", "committedDate": "2020-11-26T23:45:52Z", "message": "added a test for sealed classes cache keys"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8153582764492c37e9d16ca396beff18d6033c92", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/8153582764492c37e9d16ca396beff18d6033c92", "committedDate": "2020-11-26T21:51:51Z", "message": "added a test for sealed classes cache keys"}, "afterCommit": {"oid": "bf77715678d63cf96117e1f618bdc4f917d1a363", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/bf77715678d63cf96117e1f618bdc4f917d1a363", "committedDate": "2020-11-26T23:45:52Z", "message": "added a test for sealed classes cache keys"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4203, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}