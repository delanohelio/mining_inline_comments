{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxMjYzMDcy", "number": 2295, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxMDoyNzozN1rOD-jKKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxMjo0NDo0M1rOD-lWag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2OTE0MzQ2OnYy", "diffSide": "RIGHT", "path": "apollo-runtime/src/main/java/com/apollographql/apollo/internal/response/RealResponseWriter.kt", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxMDoyNzozN1rOGYt69w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxMjowODoxNVrOGYwbIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODU3MTM4Mw==", "bodyText": "If this is the case, buffer above shouldn't be nullable", "url": "https://github.com/apollographql/apollo-android/pull/2295#discussion_r428571383", "createdAt": "2020-05-21T10:27:37Z", "author": {"login": "tasomaniac"}, "path": "apollo-runtime/src/main/java/com/apollographql/apollo/internal/response/RealResponseWriter.kt", "diffHunk": "@@ -0,0 +1,224 @@\n+package com.apollographql.apollo.internal.response\n+\n+import com.apollographql.apollo.api.CustomTypeAdapter\n+import com.apollographql.apollo.api.Operation\n+import com.apollographql.apollo.api.ResponseField\n+import com.apollographql.apollo.api.ScalarType\n+import com.apollographql.apollo.api.ScalarTypeAdapters\n+import com.apollographql.apollo.api.internal.ResolveDelegate\n+import com.apollographql.apollo.api.internal.ResponseFieldMarshaller\n+import com.apollographql.apollo.api.internal.ResponseWriter\n+import java.math.BigDecimal\n+import java.util.ArrayList\n+import java.util.LinkedHashMap\n+\n+class RealResponseWriter(private val operationVariables: Operation.Variables, private val scalarTypeAdapters: ScalarTypeAdapters) : ResponseWriter {\n+  val buffer: MutableMap<String, FieldDescriptor> = LinkedHashMap()\n+  override fun writeString(field: ResponseField, value: String?) {\n+    writeScalarFieldValue(field, value)\n+  }\n+\n+  override fun writeInt(field: ResponseField, value: Int?) {\n+    writeScalarFieldValue(field, if (value != null) BigDecimal.valueOf(value.toLong()) else null)\n+  }\n+\n+  override fun writeLong(field: ResponseField, value: Long?) {\n+    writeScalarFieldValue(field, if (value != null) BigDecimal.valueOf(value) else null)\n+  }\n+\n+  override fun writeDouble(field: ResponseField, value: Double?) {\n+    writeScalarFieldValue(field, if (value != null) BigDecimal.valueOf(value) else null)\n+  }\n+\n+  override fun writeBoolean(field: ResponseField, value: Boolean?) {\n+    writeScalarFieldValue(field, value)\n+  }\n+\n+  override fun writeCustom(field: ResponseField.CustomTypeField, value: Any?) {\n+    val typeAdapter = scalarTypeAdapters.adapterFor<Any>(field.scalarType)\n+    writeScalarFieldValue(field, if (value != null) typeAdapter.encode(value).value else null)\n+  }\n+\n+  override fun writeObject(field: ResponseField, marshaller: ResponseFieldMarshaller?) {\n+    checkFieldValue(field, marshaller)\n+    if (marshaller == null) {\n+      buffer[field.responseName] = FieldDescriptor(field, null)\n+      return\n+    }\n+    val nestedResponseWriter = RealResponseWriter(operationVariables, scalarTypeAdapters)\n+    marshaller.marshal(nestedResponseWriter)\n+    buffer[field.responseName] = FieldDescriptor(field, nestedResponseWriter.buffer)\n+  }\n+\n+  override fun writeFragment(marshaller: ResponseFieldMarshaller?) {\n+    marshaller?.marshal(this)\n+  }\n+\n+  override fun <T> writeList(field: ResponseField, values: List<T>?, listWriter: ResponseWriter.ListWriter<T>) {\n+    checkFieldValue(field, values)\n+    if (values == null) {\n+      buffer[field.responseName] = FieldDescriptor(field, null)\n+      return\n+    }\n+    val accumulated = ArrayList<Any?>()\n+    listWriter.write(values, ListItemWriter(operationVariables, scalarTypeAdapters, accumulated))\n+    buffer[field.responseName] = FieldDescriptor(field, accumulated)\n+  }\n+\n+  fun resolveFields(delegate: ResolveDelegate<Map<String, Any>?>) {\n+    resolveFields(operationVariables, delegate, buffer)\n+  }\n+\n+  private fun writeScalarFieldValue(field: ResponseField, value: Any?) {\n+    checkFieldValue(field, value)\n+    buffer[field.responseName] = FieldDescriptor(field, value)\n+  }\n+\n+  private fun rawFieldValues(buffer: Map<String, FieldDescriptor>?): Map<String, Any?> {\n+    val fieldValues: MutableMap<String, Any?> = LinkedHashMap()\n+    for ((fieldResponseName, value) in buffer!!) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d60f8d9b9b8a93538bb5d2696b5224c00ae67c14"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYxMjM4Ng==", "bodyText": "I could remove this !! and a few other ones. There are still a few in the file that I'm not sure we can remove easily/safely.", "url": "https://github.com/apollographql/apollo-android/pull/2295#discussion_r428612386", "createdAt": "2020-05-21T12:08:15Z", "author": {"login": "martinbonnin"}, "path": "apollo-runtime/src/main/java/com/apollographql/apollo/internal/response/RealResponseWriter.kt", "diffHunk": "@@ -0,0 +1,224 @@\n+package com.apollographql.apollo.internal.response\n+\n+import com.apollographql.apollo.api.CustomTypeAdapter\n+import com.apollographql.apollo.api.Operation\n+import com.apollographql.apollo.api.ResponseField\n+import com.apollographql.apollo.api.ScalarType\n+import com.apollographql.apollo.api.ScalarTypeAdapters\n+import com.apollographql.apollo.api.internal.ResolveDelegate\n+import com.apollographql.apollo.api.internal.ResponseFieldMarshaller\n+import com.apollographql.apollo.api.internal.ResponseWriter\n+import java.math.BigDecimal\n+import java.util.ArrayList\n+import java.util.LinkedHashMap\n+\n+class RealResponseWriter(private val operationVariables: Operation.Variables, private val scalarTypeAdapters: ScalarTypeAdapters) : ResponseWriter {\n+  val buffer: MutableMap<String, FieldDescriptor> = LinkedHashMap()\n+  override fun writeString(field: ResponseField, value: String?) {\n+    writeScalarFieldValue(field, value)\n+  }\n+\n+  override fun writeInt(field: ResponseField, value: Int?) {\n+    writeScalarFieldValue(field, if (value != null) BigDecimal.valueOf(value.toLong()) else null)\n+  }\n+\n+  override fun writeLong(field: ResponseField, value: Long?) {\n+    writeScalarFieldValue(field, if (value != null) BigDecimal.valueOf(value) else null)\n+  }\n+\n+  override fun writeDouble(field: ResponseField, value: Double?) {\n+    writeScalarFieldValue(field, if (value != null) BigDecimal.valueOf(value) else null)\n+  }\n+\n+  override fun writeBoolean(field: ResponseField, value: Boolean?) {\n+    writeScalarFieldValue(field, value)\n+  }\n+\n+  override fun writeCustom(field: ResponseField.CustomTypeField, value: Any?) {\n+    val typeAdapter = scalarTypeAdapters.adapterFor<Any>(field.scalarType)\n+    writeScalarFieldValue(field, if (value != null) typeAdapter.encode(value).value else null)\n+  }\n+\n+  override fun writeObject(field: ResponseField, marshaller: ResponseFieldMarshaller?) {\n+    checkFieldValue(field, marshaller)\n+    if (marshaller == null) {\n+      buffer[field.responseName] = FieldDescriptor(field, null)\n+      return\n+    }\n+    val nestedResponseWriter = RealResponseWriter(operationVariables, scalarTypeAdapters)\n+    marshaller.marshal(nestedResponseWriter)\n+    buffer[field.responseName] = FieldDescriptor(field, nestedResponseWriter.buffer)\n+  }\n+\n+  override fun writeFragment(marshaller: ResponseFieldMarshaller?) {\n+    marshaller?.marshal(this)\n+  }\n+\n+  override fun <T> writeList(field: ResponseField, values: List<T>?, listWriter: ResponseWriter.ListWriter<T>) {\n+    checkFieldValue(field, values)\n+    if (values == null) {\n+      buffer[field.responseName] = FieldDescriptor(field, null)\n+      return\n+    }\n+    val accumulated = ArrayList<Any?>()\n+    listWriter.write(values, ListItemWriter(operationVariables, scalarTypeAdapters, accumulated))\n+    buffer[field.responseName] = FieldDescriptor(field, accumulated)\n+  }\n+\n+  fun resolveFields(delegate: ResolveDelegate<Map<String, Any>?>) {\n+    resolveFields(operationVariables, delegate, buffer)\n+  }\n+\n+  private fun writeScalarFieldValue(field: ResponseField, value: Any?) {\n+    checkFieldValue(field, value)\n+    buffer[field.responseName] = FieldDescriptor(field, value)\n+  }\n+\n+  private fun rawFieldValues(buffer: Map<String, FieldDescriptor>?): Map<String, Any?> {\n+    val fieldValues: MutableMap<String, Any?> = LinkedHashMap()\n+    for ((fieldResponseName, value) in buffer!!) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODU3MTM4Mw=="}, "originalCommit": {"oid": "d60f8d9b9b8a93538bb5d2696b5224c00ae67c14"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2OTE0NDkzOnYy", "diffSide": "RIGHT", "path": "apollo-runtime/src/main/java/com/apollographql/apollo/internal/response/RealResponseWriter.kt", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxMDoyODowNVrOGYt73Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxMDoyODowNVrOGYt73Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODU3MTYxMw==", "bodyText": "Same here", "url": "https://github.com/apollographql/apollo-android/pull/2295#discussion_r428571613", "createdAt": "2020-05-21T10:28:05Z", "author": {"login": "tasomaniac"}, "path": "apollo-runtime/src/main/java/com/apollographql/apollo/internal/response/RealResponseWriter.kt", "diffHunk": "@@ -0,0 +1,224 @@\n+package com.apollographql.apollo.internal.response\n+\n+import com.apollographql.apollo.api.CustomTypeAdapter\n+import com.apollographql.apollo.api.Operation\n+import com.apollographql.apollo.api.ResponseField\n+import com.apollographql.apollo.api.ScalarType\n+import com.apollographql.apollo.api.ScalarTypeAdapters\n+import com.apollographql.apollo.api.internal.ResolveDelegate\n+import com.apollographql.apollo.api.internal.ResponseFieldMarshaller\n+import com.apollographql.apollo.api.internal.ResponseWriter\n+import java.math.BigDecimal\n+import java.util.ArrayList\n+import java.util.LinkedHashMap\n+\n+class RealResponseWriter(private val operationVariables: Operation.Variables, private val scalarTypeAdapters: ScalarTypeAdapters) : ResponseWriter {\n+  val buffer: MutableMap<String, FieldDescriptor> = LinkedHashMap()\n+  override fun writeString(field: ResponseField, value: String?) {\n+    writeScalarFieldValue(field, value)\n+  }\n+\n+  override fun writeInt(field: ResponseField, value: Int?) {\n+    writeScalarFieldValue(field, if (value != null) BigDecimal.valueOf(value.toLong()) else null)\n+  }\n+\n+  override fun writeLong(field: ResponseField, value: Long?) {\n+    writeScalarFieldValue(field, if (value != null) BigDecimal.valueOf(value) else null)\n+  }\n+\n+  override fun writeDouble(field: ResponseField, value: Double?) {\n+    writeScalarFieldValue(field, if (value != null) BigDecimal.valueOf(value) else null)\n+  }\n+\n+  override fun writeBoolean(field: ResponseField, value: Boolean?) {\n+    writeScalarFieldValue(field, value)\n+  }\n+\n+  override fun writeCustom(field: ResponseField.CustomTypeField, value: Any?) {\n+    val typeAdapter = scalarTypeAdapters.adapterFor<Any>(field.scalarType)\n+    writeScalarFieldValue(field, if (value != null) typeAdapter.encode(value).value else null)\n+  }\n+\n+  override fun writeObject(field: ResponseField, marshaller: ResponseFieldMarshaller?) {\n+    checkFieldValue(field, marshaller)\n+    if (marshaller == null) {\n+      buffer[field.responseName] = FieldDescriptor(field, null)\n+      return\n+    }\n+    val nestedResponseWriter = RealResponseWriter(operationVariables, scalarTypeAdapters)\n+    marshaller.marshal(nestedResponseWriter)\n+    buffer[field.responseName] = FieldDescriptor(field, nestedResponseWriter.buffer)\n+  }\n+\n+  override fun writeFragment(marshaller: ResponseFieldMarshaller?) {\n+    marshaller?.marshal(this)\n+  }\n+\n+  override fun <T> writeList(field: ResponseField, values: List<T>?, listWriter: ResponseWriter.ListWriter<T>) {\n+    checkFieldValue(field, values)\n+    if (values == null) {\n+      buffer[field.responseName] = FieldDescriptor(field, null)\n+      return\n+    }\n+    val accumulated = ArrayList<Any?>()\n+    listWriter.write(values, ListItemWriter(operationVariables, scalarTypeAdapters, accumulated))\n+    buffer[field.responseName] = FieldDescriptor(field, accumulated)\n+  }\n+\n+  fun resolveFields(delegate: ResolveDelegate<Map<String, Any>?>) {\n+    resolveFields(operationVariables, delegate, buffer)\n+  }\n+\n+  private fun writeScalarFieldValue(field: ResponseField, value: Any?) {\n+    checkFieldValue(field, value)\n+    buffer[field.responseName] = FieldDescriptor(field, value)\n+  }\n+\n+  private fun rawFieldValues(buffer: Map<String, FieldDescriptor>?): Map<String, Any?> {\n+    val fieldValues: MutableMap<String, Any?> = LinkedHashMap()\n+    for ((fieldResponseName, value) in buffer!!) {\n+      val fieldValue = value.value\n+      if (fieldValue == null) {\n+        fieldValues[fieldResponseName] = null\n+      } else if (fieldValue is Map<*, *>) {\n+        val nestedMap = rawFieldValues(fieldValue as Map<String, FieldDescriptor>?)\n+        fieldValues[fieldResponseName] = nestedMap\n+      } else if (fieldValue is List<*>) {\n+        fieldValues[fieldResponseName] = rawListFieldValues(fieldValue)\n+      } else {\n+        fieldValues[fieldResponseName] = fieldValue\n+      }\n+    }\n+    return fieldValues\n+  }\n+\n+  private fun rawListFieldValues(values: List<*>): List<*> {\n+    val listValues = ArrayList<Any?>()\n+    for (value in values) {\n+      if (value is Map<*, *>) {\n+        listValues.add(rawFieldValues(value as Map<String, FieldDescriptor>))\n+      } else if (value is List<*>) {\n+        listValues.add(rawListFieldValues(value))\n+      } else {\n+        listValues.add(value)\n+      }\n+    }\n+    return listValues\n+  }\n+\n+  private fun resolveFields(operationVariables: Operation.Variables,\n+                            delegate: ResolveDelegate<Map<String, Any>?>, buffer: Map<String, FieldDescriptor>?) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d60f8d9b9b8a93538bb5d2696b5224c00ae67c14"}, "originalPosition": 110}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2OTE0NTIyOnYy", "diffSide": "RIGHT", "path": "apollo-runtime/src/main/java/com/apollographql/apollo/internal/response/RealResponseWriter.kt", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxMDoyODoxMlrOGYt8DQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxMDoyODoxMlrOGYt8DQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODU3MTY2MQ==", "bodyText": "Same here", "url": "https://github.com/apollographql/apollo-android/pull/2295#discussion_r428571661", "createdAt": "2020-05-21T10:28:12Z", "author": {"login": "tasomaniac"}, "path": "apollo-runtime/src/main/java/com/apollographql/apollo/internal/response/RealResponseWriter.kt", "diffHunk": "@@ -0,0 +1,224 @@\n+package com.apollographql.apollo.internal.response\n+\n+import com.apollographql.apollo.api.CustomTypeAdapter\n+import com.apollographql.apollo.api.Operation\n+import com.apollographql.apollo.api.ResponseField\n+import com.apollographql.apollo.api.ScalarType\n+import com.apollographql.apollo.api.ScalarTypeAdapters\n+import com.apollographql.apollo.api.internal.ResolveDelegate\n+import com.apollographql.apollo.api.internal.ResponseFieldMarshaller\n+import com.apollographql.apollo.api.internal.ResponseWriter\n+import java.math.BigDecimal\n+import java.util.ArrayList\n+import java.util.LinkedHashMap\n+\n+class RealResponseWriter(private val operationVariables: Operation.Variables, private val scalarTypeAdapters: ScalarTypeAdapters) : ResponseWriter {\n+  val buffer: MutableMap<String, FieldDescriptor> = LinkedHashMap()\n+  override fun writeString(field: ResponseField, value: String?) {\n+    writeScalarFieldValue(field, value)\n+  }\n+\n+  override fun writeInt(field: ResponseField, value: Int?) {\n+    writeScalarFieldValue(field, if (value != null) BigDecimal.valueOf(value.toLong()) else null)\n+  }\n+\n+  override fun writeLong(field: ResponseField, value: Long?) {\n+    writeScalarFieldValue(field, if (value != null) BigDecimal.valueOf(value) else null)\n+  }\n+\n+  override fun writeDouble(field: ResponseField, value: Double?) {\n+    writeScalarFieldValue(field, if (value != null) BigDecimal.valueOf(value) else null)\n+  }\n+\n+  override fun writeBoolean(field: ResponseField, value: Boolean?) {\n+    writeScalarFieldValue(field, value)\n+  }\n+\n+  override fun writeCustom(field: ResponseField.CustomTypeField, value: Any?) {\n+    val typeAdapter = scalarTypeAdapters.adapterFor<Any>(field.scalarType)\n+    writeScalarFieldValue(field, if (value != null) typeAdapter.encode(value).value else null)\n+  }\n+\n+  override fun writeObject(field: ResponseField, marshaller: ResponseFieldMarshaller?) {\n+    checkFieldValue(field, marshaller)\n+    if (marshaller == null) {\n+      buffer[field.responseName] = FieldDescriptor(field, null)\n+      return\n+    }\n+    val nestedResponseWriter = RealResponseWriter(operationVariables, scalarTypeAdapters)\n+    marshaller.marshal(nestedResponseWriter)\n+    buffer[field.responseName] = FieldDescriptor(field, nestedResponseWriter.buffer)\n+  }\n+\n+  override fun writeFragment(marshaller: ResponseFieldMarshaller?) {\n+    marshaller?.marshal(this)\n+  }\n+\n+  override fun <T> writeList(field: ResponseField, values: List<T>?, listWriter: ResponseWriter.ListWriter<T>) {\n+    checkFieldValue(field, values)\n+    if (values == null) {\n+      buffer[field.responseName] = FieldDescriptor(field, null)\n+      return\n+    }\n+    val accumulated = ArrayList<Any?>()\n+    listWriter.write(values, ListItemWriter(operationVariables, scalarTypeAdapters, accumulated))\n+    buffer[field.responseName] = FieldDescriptor(field, accumulated)\n+  }\n+\n+  fun resolveFields(delegate: ResolveDelegate<Map<String, Any>?>) {\n+    resolveFields(operationVariables, delegate, buffer)\n+  }\n+\n+  private fun writeScalarFieldValue(field: ResponseField, value: Any?) {\n+    checkFieldValue(field, value)\n+    buffer[field.responseName] = FieldDescriptor(field, value)\n+  }\n+\n+  private fun rawFieldValues(buffer: Map<String, FieldDescriptor>?): Map<String, Any?> {\n+    val fieldValues: MutableMap<String, Any?> = LinkedHashMap()\n+    for ((fieldResponseName, value) in buffer!!) {\n+      val fieldValue = value.value\n+      if (fieldValue == null) {\n+        fieldValues[fieldResponseName] = null\n+      } else if (fieldValue is Map<*, *>) {\n+        val nestedMap = rawFieldValues(fieldValue as Map<String, FieldDescriptor>?)\n+        fieldValues[fieldResponseName] = nestedMap\n+      } else if (fieldValue is List<*>) {\n+        fieldValues[fieldResponseName] = rawListFieldValues(fieldValue)\n+      } else {\n+        fieldValues[fieldResponseName] = fieldValue\n+      }\n+    }\n+    return fieldValues\n+  }\n+\n+  private fun rawListFieldValues(values: List<*>): List<*> {\n+    val listValues = ArrayList<Any?>()\n+    for (value in values) {\n+      if (value is Map<*, *>) {\n+        listValues.add(rawFieldValues(value as Map<String, FieldDescriptor>))\n+      } else if (value is List<*>) {\n+        listValues.add(rawListFieldValues(value))\n+      } else {\n+        listValues.add(value)\n+      }\n+    }\n+    return listValues\n+  }\n+\n+  private fun resolveFields(operationVariables: Operation.Variables,\n+                            delegate: ResolveDelegate<Map<String, Any>?>, buffer: Map<String, FieldDescriptor>?) {\n+    val rawFieldValues = rawFieldValues(buffer)\n+    for (fieldResponseName in buffer!!.keys) {\n+      val fieldDescriptor = buffer[fieldResponseName]\n+      val rawFieldValue = rawFieldValues[fieldResponseName]\n+      delegate.willResolve(fieldDescriptor!!.field, operationVariables, fieldDescriptor.value)\n+      when (fieldDescriptor.field.type) {\n+        ResponseField.Type.OBJECT -> {\n+          resolveObjectFields(fieldDescriptor, rawFieldValue as Map<String, Any>?, delegate)\n+        }\n+        ResponseField.Type.LIST -> {\n+          resolveListField(fieldDescriptor.field, fieldDescriptor.value as List<*>?, rawFieldValue as List<*>?, delegate)\n+        }\n+        else -> {\n+          if (rawFieldValue == null) {\n+            delegate.didResolveNull()\n+          } else {\n+            delegate.didResolveScalar(rawFieldValue)\n+          }\n+        }\n+      }\n+      delegate.didResolve(fieldDescriptor.field, operationVariables)\n+    }\n+  }\n+\n+  private fun resolveObjectFields(fieldDescriptor: FieldDescriptor?,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d60f8d9b9b8a93538bb5d2696b5224c00ae67c14"}, "originalPosition": 135}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2OTUwMjUwOnYy", "diffSide": "RIGHT", "path": "apollo-runtime/src/main/java/com/apollographql/apollo/internal/response/RealResponseWriter.kt", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxMjo0NDo0M1rOGYxaMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxMjo0NDo0M1rOGYxaMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYyODUzMA==", "bodyText": "This can be replaced with forEachWithIndex. Could be little bit better but this is also good.", "url": "https://github.com/apollographql/apollo-android/pull/2295#discussion_r428628530", "createdAt": "2020-05-21T12:44:43Z", "author": {"login": "tasomaniac"}, "path": "apollo-runtime/src/main/java/com/apollographql/apollo/internal/response/RealResponseWriter.kt", "diffHunk": "@@ -0,0 +1,225 @@\n+package com.apollographql.apollo.internal.response\n+\n+import com.apollographql.apollo.api.CustomTypeAdapter\n+import com.apollographql.apollo.api.Operation\n+import com.apollographql.apollo.api.ResponseField\n+import com.apollographql.apollo.api.ScalarType\n+import com.apollographql.apollo.api.ScalarTypeAdapters\n+import com.apollographql.apollo.api.internal.ResolveDelegate\n+import com.apollographql.apollo.api.internal.ResponseFieldMarshaller\n+import com.apollographql.apollo.api.internal.ResponseWriter\n+import java.math.BigDecimal\n+import java.util.ArrayList\n+import java.util.LinkedHashMap\n+\n+class RealResponseWriter(private val operationVariables: Operation.Variables, private val scalarTypeAdapters: ScalarTypeAdapters) : ResponseWriter {\n+  val buffer: MutableMap<String, FieldDescriptor> = LinkedHashMap()\n+  override fun writeString(field: ResponseField, value: String?) {\n+    writeScalarFieldValue(field, value)\n+  }\n+\n+  override fun writeInt(field: ResponseField, value: Int?) {\n+    writeScalarFieldValue(field, if (value != null) BigDecimal.valueOf(value.toLong()) else null)\n+  }\n+\n+  override fun writeLong(field: ResponseField, value: Long?) {\n+    writeScalarFieldValue(field, if (value != null) BigDecimal.valueOf(value) else null)\n+  }\n+\n+  override fun writeDouble(field: ResponseField, value: Double?) {\n+    writeScalarFieldValue(field, if (value != null) BigDecimal.valueOf(value) else null)\n+  }\n+\n+  override fun writeBoolean(field: ResponseField, value: Boolean?) {\n+    writeScalarFieldValue(field, value)\n+  }\n+\n+  override fun writeCustom(field: ResponseField.CustomTypeField, value: Any?) {\n+    val typeAdapter = scalarTypeAdapters.adapterFor<Any>(field.scalarType)\n+    writeScalarFieldValue(field, if (value != null) typeAdapter.encode(value).value else null)\n+  }\n+\n+  override fun writeObject(field: ResponseField, marshaller: ResponseFieldMarshaller?) {\n+    checkFieldValue(field, marshaller)\n+    if (marshaller == null) {\n+      buffer[field.responseName] = FieldDescriptor(field, null)\n+      return\n+    }\n+    val nestedResponseWriter = RealResponseWriter(operationVariables, scalarTypeAdapters)\n+    marshaller.marshal(nestedResponseWriter)\n+    buffer[field.responseName] = FieldDescriptor(field, nestedResponseWriter.buffer)\n+  }\n+\n+  override fun writeFragment(marshaller: ResponseFieldMarshaller?) {\n+    marshaller?.marshal(this)\n+  }\n+\n+  override fun <T> writeList(field: ResponseField, values: List<T>?, listWriter: ResponseWriter.ListWriter<T>) {\n+    checkFieldValue(field, values)\n+    if (values == null) {\n+      buffer[field.responseName] = FieldDescriptor(field, null)\n+      return\n+    }\n+    val accumulated = ArrayList<Any?>()\n+    listWriter.write(values, ListItemWriter(operationVariables, scalarTypeAdapters, accumulated))\n+    buffer[field.responseName] = FieldDescriptor(field, accumulated)\n+  }\n+\n+  fun resolveFields(delegate: ResolveDelegate<Map<String, Any>?>) {\n+    resolveFields(operationVariables, delegate, buffer)\n+  }\n+\n+  private fun writeScalarFieldValue(field: ResponseField, value: Any?) {\n+    checkFieldValue(field, value)\n+    buffer[field.responseName] = FieldDescriptor(field, value)\n+  }\n+\n+  private fun rawFieldValues(buffer: Map<String, FieldDescriptor>): Map<String, Any?> {\n+    val fieldValues: MutableMap<String, Any?> = LinkedHashMap()\n+    for ((fieldResponseName, value) in buffer) {\n+      val fieldValue = value.value\n+      if (fieldValue == null) {\n+        fieldValues[fieldResponseName] = null\n+      } else if (fieldValue is Map<*, *>) {\n+        val nestedMap = rawFieldValues(fieldValue as Map<String, FieldDescriptor>)\n+        fieldValues[fieldResponseName] = nestedMap\n+      } else if (fieldValue is List<*>) {\n+        fieldValues[fieldResponseName] = rawListFieldValues(fieldValue)\n+      } else {\n+        fieldValues[fieldResponseName] = fieldValue\n+      }\n+    }\n+    return fieldValues\n+  }\n+\n+  private fun rawListFieldValues(values: List<*>): List<*> {\n+    val listValues = ArrayList<Any?>()\n+    for (value in values) {\n+      if (value is Map<*, *>) {\n+        listValues.add(rawFieldValues(value as Map<String, FieldDescriptor>))\n+      } else if (value is List<*>) {\n+        listValues.add(rawListFieldValues(value))\n+      } else {\n+        listValues.add(value)\n+      }\n+    }\n+    return listValues\n+  }\n+\n+  private fun resolveFields(operationVariables: Operation.Variables,\n+                            delegate: ResolveDelegate<Map<String, Any>?>, buffer: Map<String, FieldDescriptor>) {\n+    val rawFieldValues = rawFieldValues(buffer)\n+    for (fieldResponseName in buffer.keys) {\n+      val fieldDescriptor = buffer[fieldResponseName]\n+      val rawFieldValue = rawFieldValues[fieldResponseName]\n+      delegate.willResolve(fieldDescriptor!!.field, operationVariables, fieldDescriptor.value)\n+      when (fieldDescriptor.field.type) {\n+        ResponseField.Type.OBJECT -> {\n+          resolveObjectFields(fieldDescriptor, rawFieldValue as Map<String, Any>?, delegate)\n+        }\n+        ResponseField.Type.LIST -> {\n+          resolveListField(fieldDescriptor.field, fieldDescriptor.value as List<*>?, rawFieldValue as List<*>?, delegate)\n+        }\n+        else -> {\n+          if (rawFieldValue == null) {\n+            delegate.didResolveNull()\n+          } else {\n+            delegate.didResolveScalar(rawFieldValue)\n+          }\n+        }\n+      }\n+      delegate.didResolve(fieldDescriptor.field, operationVariables)\n+    }\n+  }\n+\n+  private fun resolveObjectFields(fieldDescriptor: FieldDescriptor,\n+                                  rawFieldValues: Map<String, Any>?, delegate: ResolveDelegate<Map<String, Any>?>) {\n+    delegate.willResolveObject(fieldDescriptor.field, rawFieldValues)\n+    val value = fieldDescriptor.value\n+    if (value == null) {\n+      delegate.didResolveNull()\n+    } else {\n+      resolveFields(operationVariables, delegate, value as Map<String, FieldDescriptor>)\n+    }\n+    delegate.didResolveObject(fieldDescriptor.field, rawFieldValues)\n+  }\n+\n+  private fun resolveListField(listResponseField: ResponseField, fieldValues: List<*>?,\n+                               rawFieldValues: List<*>?, delegate: ResolveDelegate<Map<String, Any>?>) {\n+    if (fieldValues == null) {\n+      delegate.didResolveNull()\n+      return\n+    }\n+    for (i in fieldValues.indices) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a290708c0cd37f77e5f38b9a2cbc68a7178763a"}, "originalPosition": 153}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3087, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}