{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMDI5NTE5", "number": 2150, "title": "Generate 'composeRequestBody' to encode GraphQL POST request payload", "bodyText": "See https://github.com/apollographql/apollo-android/pull/2150/files#diff-f17956f5f068990894e5e12df8833d96\nCloses #2137", "createdAt": "2020-04-10T19:02:17Z", "url": "https://github.com/apollographql/apollo-android/pull/2150", "merged": true, "mergeCommit": {"oid": "ea5afe58f7a4e15333e60210ecdae934b567c586"}, "closed": true, "closedAt": "2020-04-13T04:18:47Z", "author": {"login": "sav007"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWXBKRAFqTM5MTY0MTUyOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXFpH5gH2gAyNDAyMDI5NTE5OmMxYmZjZGZkMTg4MjUyOWU1ODgxZWRlMmE4NmFjNjQzNGY1ZTUwNzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNjQxNTI5", "url": "https://github.com/apollographql/apollo-android/pull/2150#pullrequestreview-391641529", "createdAt": "2020-04-10T20:21:30Z", "commit": {"oid": "8f903d87815565e84d703eb0965e40585ec6be3f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMDoyMTozMFrOGEEyMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMDoyMTozMFrOGEEyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkyNTg3Mw==", "bodyText": "If we use use function, then this close will be called automatically and safer.", "url": "https://github.com/apollographql/apollo-android/pull/2150#discussion_r406925873", "createdAt": "2020-04-10T20:21:30Z", "author": {"login": "tasomaniac"}, "path": "apollo-api/src/commonMain/kotlin/com/apollographql/apollo/api/internal/OperationRequestBodyComposer.kt", "diffHunk": "@@ -0,0 +1,46 @@\n+package com.apollographql.apollo.api.internal\n+\n+import com.apollographql.apollo.api.Operation\n+import com.apollographql.apollo.api.ScalarTypeAdapters\n+import com.apollographql.apollo.api.internal.json.JsonWriter\n+import okio.Buffer\n+import okio.ByteString\n+import kotlin.jvm.JvmStatic\n+\n+object OperationRequestBodyComposer {\n+\n+  @JvmStatic\n+  fun compose(\n+      operation: Operation<*, *, *>,\n+      autoPersistQueries: Boolean,\n+      withQueryDocument: Boolean,\n+      scalarTypeAdapters: ScalarTypeAdapters\n+  ): ByteString {\n+    return Buffer().apply {\n+      JsonWriter.of(this)\n+          .apply { serializeNulls = true }\n+          .beginObject()\n+          .name(\"operationName\").value(operation.name().name())\n+          .name(\"variables\").jsonValue(operation.variables().marshal(scalarTypeAdapters))\n+          .apply {\n+            if (autoPersistQueries) {\n+              name(\"extensions\")\n+                  .beginObject()\n+                  .name(\"persistedQuery\")\n+                  .beginObject()\n+                  .name(\"version\").value(1)\n+                  .name(\"sha256Hash\").value(operation.operationId())\n+                  .endObject()\n+                  .endObject()\n+            }\n+          }\n+          .apply {\n+            if (withQueryDocument) {\n+              name(\"query\").value(operation.queryDocument())\n+            }\n+          }\n+          .endObject()\n+          .close()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f903d87815565e84d703eb0965e40585ec6be3f"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNjQyNDcz", "url": "https://github.com/apollographql/apollo-android/pull/2150#pullrequestreview-391642473", "createdAt": "2020-04-10T20:23:52Z", "commit": {"oid": "8f903d87815565e84d703eb0965e40585ec6be3f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ceea4691aa85a4a34edcdad91e9356203e5a8c56", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/ceea4691aa85a4a34edcdad91e9356203e5a8c56", "committedDate": "2020-04-11T04:12:14Z", "message": "Fix test"}, "afterCommit": {"oid": "6fd5743cd2d20d7e219032cd3c8e40214fc14255", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/6fd5743cd2d20d7e219032cd3c8e40214fc14255", "committedDate": "2020-04-11T04:36:02Z", "message": "Fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNzQ0NTAz", "url": "https://github.com/apollographql/apollo-android/pull/2150#pullrequestreview-391744503", "createdAt": "2020-04-11T07:32:35Z", "commit": {"oid": "6fd5743cd2d20d7e219032cd3c8e40214fc14255"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6fd5743cd2d20d7e219032cd3c8e40214fc14255", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/6fd5743cd2d20d7e219032cd3c8e40214fc14255", "committedDate": "2020-04-11T04:36:02Z", "message": "Fix test"}, "afterCommit": {"oid": "49b27fb85a0d43520eb1c254dac1a5b5206fff6d", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/49b27fb85a0d43520eb1c254dac1a5b5206fff6d", "committedDate": "2020-04-11T16:03:03Z", "message": "Fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNzgyODI1", "url": "https://github.com/apollographql/apollo-android/pull/2150#pullrequestreview-391782825", "createdAt": "2020-04-11T16:58:34Z", "commit": {"oid": "49b27fb85a0d43520eb1c254dac1a5b5206fff6d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxNjo1ODozNFrOGEOjnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxNjo1ODozNFrOGEOjnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA4NTk4Mw==", "bodyText": "Just curious: what's the advantage of  exposing a ByteString instead of a String ? Do we support something else than utf8 ?", "url": "https://github.com/apollographql/apollo-android/pull/2150#discussion_r407085983", "createdAt": "2020-04-11T16:58:34Z", "author": {"login": "martinbonnin"}, "path": "apollo-api/src/commonMain/kotlin/com/apollographql/apollo/api/Operation.kt", "diffHunk": "@@ -60,6 +61,34 @@ interface Operation<D : Operation.Data, T, V : Operation.Variables> {\n   @Throws(IOException::class)\n   fun parse(source: BufferedSource): Response<T>\n \n+  /**\n+   * Composes POST JSON-encoded request body with provided [scalarTypeAdapters] to be sent to the GraphQL server.\n+   *\n+   * *Example*:\n+   * ```\n+   * {\n+   *    \"query\": \"query TestQuery($episode: Episode) { hero(episode: $episode) { name } }\",\n+   *    \"operationName\": \"TestQuery\",\n+   *    \"variables\": { \"episode\": \"JEDI\" }\n+   * }\n+   * ```\n+   */\n+  fun composeRequestBody(scalarTypeAdapters: ScalarTypeAdapters): ByteString", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49b27fb85a0d43520eb1c254dac1a5b5206fff6d"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNzgzMDgz", "url": "https://github.com/apollographql/apollo-android/pull/2150#pullrequestreview-391783083", "createdAt": "2020-04-11T17:01:52Z", "commit": {"oid": "49b27fb85a0d43520eb1c254dac1a5b5206fff6d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxNzowMTo1M1rOGEOk8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQxNzowMTo1M1rOGEOk8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzA4NjMyMQ==", "bodyText": "Does this need to be in the generated models ?  What about just having that as an extension function in kotlin ? That's less codegen code to maintain and it'll make it easier to navigate the generated models ?", "url": "https://github.com/apollographql/apollo-android/pull/2150#discussion_r407086321", "createdAt": "2020-04-11T17:01:53Z", "author": {"login": "martinbonnin"}, "path": "apollo-compiler/src/test/graphql/com/example/arguments_complex/TestQuery.kt", "diffHunk": "@@ -72,6 +75,32 @@ data class TestQuery(\n   @Throws(IOException::class)\n   override fun parse(source: BufferedSource): Response<Data> = parse(source, DEFAULT)\n \n+  override fun composeRequestBody(scalarTypeAdapters: ScalarTypeAdapters): ByteString =\n+      OperationRequestBodyComposer.compose(\n+    operation = this,\n+    autoPersistQueries = false,\n+    withQueryDocument = true,\n+    scalarTypeAdapters = scalarTypeAdapters\n+  )\n+\n+  override fun composeRequestBody(): ByteString = OperationRequestBodyComposer.compose(\n+    operation = this,\n+    autoPersistQueries = false,\n+    withQueryDocument = true,\n+    scalarTypeAdapters = DEFAULT\n+  )\n+\n+  override fun composeRequestBody(\n+    autoPersistQueries: Boolean,\n+    withQueryDocument: Boolean,\n+    scalarTypeAdapters: ScalarTypeAdapters\n+  ): ByteString = OperationRequestBodyComposer.compose(\n+    operation = this,\n+    autoPersistQueries = autoPersistQueries,\n+    withQueryDocument = withQueryDocument,\n+    scalarTypeAdapters = scalarTypeAdapters\n+  )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49b27fb85a0d43520eb1c254dac1a5b5206fff6d"}, "originalPosition": 52}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "49b27fb85a0d43520eb1c254dac1a5b5206fff6d", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/49b27fb85a0d43520eb1c254dac1a5b5206fff6d", "committedDate": "2020-04-11T16:03:03Z", "message": "Fix test"}, "afterCommit": {"oid": "a2d73e894a669012a286bb5b7a636fe09cdacf40", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/a2d73e894a669012a286bb5b7a636fe09cdacf40", "committedDate": "2020-04-12T03:13:11Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d6716033f03c994f46abc8b9cd6972f18b31a2c", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/4d6716033f03c994f46abc8b9cd6972f18b31a2c", "committedDate": "2020-04-12T03:32:01Z", "message": "Generate 'composeRequestBody' to encode GraphQL POST request payload\n\nCloses https://github.com/apollographql/apollo-android/issues/2137"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2353c151b740587c3417b2f04efa5227dc701d50", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/2353c151b740587c3417b2f04efa5227dc701d50", "committedDate": "2020-04-12T03:32:01Z", "message": "Remove default values from interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72a5ce680ae008100685ccfbc3f2496170749e32", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/72a5ce680ae008100685ccfbc3f2496170749e32", "committedDate": "2020-04-12T03:32:01Z", "message": "Feedback + iOS sample"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40345c931ae98d53d667d2780dd192123d19c0b5", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/40345c931ae98d53d667d2780dd192123d19c0b5", "committedDate": "2020-04-12T03:32:01Z", "message": "Update docs + fix issue with conditions to encode query document or not"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcfd5ec600173dfa7fbf01543aa338f930a8fb80", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/dcfd5ec600173dfa7fbf01543aa338f930a8fb80", "committedDate": "2020-04-12T03:32:02Z", "message": "Fix test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a2d73e894a669012a286bb5b7a636fe09cdacf40", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/a2d73e894a669012a286bb5b7a636fe09cdacf40", "committedDate": "2020-04-12T03:13:11Z", "message": "Fix test"}, "afterCommit": {"oid": "dcfd5ec600173dfa7fbf01543aa338f930a8fb80", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/dcfd5ec600173dfa7fbf01543aa338f930a8fb80", "committedDate": "2020-04-12T03:32:02Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d0ea1178965fee984753e5b7a9ab5e6c9820c9e", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/5d0ea1178965fee984753e5b7a9ab5e6c9820c9e", "committedDate": "2020-04-13T00:08:09Z", "message": "Fix test fixtures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1bfcdfd1882529e5881ede2a86ac6434f5e5070", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/c1bfcdfd1882529e5881ede2a86ac6434f5e5070", "committedDate": "2020-04-13T02:40:47Z", "message": "Fix tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3925, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}