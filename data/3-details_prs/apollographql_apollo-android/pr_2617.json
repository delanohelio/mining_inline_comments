{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0NjY2NDU2", "number": 2617, "title": "[Gradle Plugin] add registry download", "bodyText": "Allow to download a schema from the Apollo registry with:\n./gradlew downloadApolloSchema --graph $APOLLO_GRAPH --key $APOLLO_KEY --schema schema.[json | sdl]", "createdAt": "2020-09-29T08:46:15Z", "url": "https://github.com/apollographql/apollo-android/pull/2617", "merged": true, "mergeCommit": {"oid": "b4de86259f940ffe6a1cc04db02b9bd4cbf2ec9b"}, "closed": true, "closedAt": "2020-10-01T23:12:05Z", "author": {"login": "martinbonnin"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNkFOAAH2gAyNDk0NjY2NDU2OjFkYTEyNmU4NGI3YTI4OTM1MWM3YzE5ZDQ3MmEyZjkzZDkxNjRmNmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdN89u5gH2gAyNDk0NjY2NDU2OjVhNDA5ZWFjYTE3NGNiYTZjMzIxYjZlYjdkMzYzNDNjOTIzNDg2YTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1da126e84b7a289351c7c19d472a2f93d9164f6e", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/1da126e84b7a289351c7c19d472a2f93d9164f6e", "committedDate": "2020-09-29T08:40:32Z", "message": "add registry download"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NjcyMTEx", "url": "https://github.com/apollographql/apollo-android/pull/2617#pullrequestreview-498672111", "createdAt": "2020-09-29T16:29:11Z", "commit": {"oid": "1da126e84b7a289351c7c19d472a2f93d9164f6e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNjoyOToxMVrOHZ2_Vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNjoyOToxMVrOHZ2_Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3NzM5OQ==", "bodyText": "Could we make sure to name the operation here? Additionally, using variables is a best practice, along with identifying your client traffic using the apollographql-client-name header.\nMaybe something like this?\nquery DownloadSchema($graphID: ID!, $variant: String! = \"current\") {\n  service(id: $graphID) {\n    variant(name: $variant) {\n      activeSchemaPublish {\n        schema {\n          document\n        }\n      }\n    }\n  }\n}", "url": "https://github.com/apollographql/apollo-android/pull/2617#discussion_r496877399", "createdAt": "2020-09-29T16:29:11Z", "author": {"login": "zionts"}, "path": "apollo-gradle-plugin/src/main/kotlin/com/apollographql/apollo/gradle/internal/SchemaDownloader.kt", "diffHunk": "@@ -39,30 +44,56 @@ object SchemaDownloader {\n             addHeader(it.key, it.value)\n           }\n         }\n-        .url(endpoint)\n+        .url(url)\n         .build()\n \n-    val response = OkHttpClient.Builder()\n-        .connectTimeout(connectTimeoutSeconds, TimeUnit.SECONDS)\n-        .readTimeout(readTimeoutSeconds, TimeUnit.SECONDS)\n-        .build()\n-        .newCall(request).execute()\n+    val response = newOkHttpClient()\n+        .newCall(request)\n+        .execute()\n \n     if (!response.isSuccessful) {\n       throw Exception(\"cannot get schema: ${response.code}:\\n${response.body?.string()}\")\n     }\n \n-    schema.parentFile?.mkdirs()\n+    return response\n+  }\n+\n+  fun downloadIntrospection(\n+      endpoint: String,\n+      headers: Map<String, String>\n+  ): String {\n+\n+    val response = executeQuery(introspectionQuery, endpoint, headers)\n+\n+    return response.body.use { responseBody ->\n+      responseBody!!.string()\n+    }\n+  }\n \n-    response.body.use { responseBody ->\n-      if (schema.extension.toLowerCase() == \"json\") {\n-        schema.writeText(responseBody!!.string())\n-      } else {\n-        IntrospectionSchema(responseBody!!.byteStream()).toSDL(schema)\n+  fun downloadRegistry(graph: String, key: String, variant: String): String? {\n+    val registryQuery = \"\"\"\n+    query {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1da126e84b7a289351c7c19d472a2f93d9164f6e"}, "originalPosition": 90}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NjcyODQ5", "url": "https://github.com/apollographql/apollo-android/pull/2617#pullrequestreview-498672849", "createdAt": "2020-09-29T16:30:05Z", "commit": {"oid": "1da126e84b7a289351c7c19d472a2f93d9164f6e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNjozMDowNVrOHZ3Bvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNjozMDowNVrOHZ3Bvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg3ODAxNA==", "bodyText": "can we add in an apollographql-client-name header? This will help us make sure that we're tracking this operation back to this particular client so if there are any changes that might affect it down the road, we can reach out :) https://www.apollographql.com/docs/studio/client-awareness/", "url": "https://github.com/apollographql/apollo-android/pull/2617#discussion_r496878014", "createdAt": "2020-09-29T16:30:05Z", "author": {"login": "zionts"}, "path": "apollo-gradle-plugin/src/main/kotlin/com/apollographql/apollo/gradle/internal/SchemaDownloader.kt", "diffHunk": "@@ -39,30 +44,56 @@ object SchemaDownloader {\n             addHeader(it.key, it.value)\n           }\n         }\n-        .url(endpoint)\n+        .url(url)\n         .build()\n \n-    val response = OkHttpClient.Builder()\n-        .connectTimeout(connectTimeoutSeconds, TimeUnit.SECONDS)\n-        .readTimeout(readTimeoutSeconds, TimeUnit.SECONDS)\n-        .build()\n-        .newCall(request).execute()\n+    val response = newOkHttpClient()\n+        .newCall(request)\n+        .execute()\n \n     if (!response.isSuccessful) {\n       throw Exception(\"cannot get schema: ${response.code}:\\n${response.body?.string()}\")\n     }\n \n-    schema.parentFile?.mkdirs()\n+    return response\n+  }\n+\n+  fun downloadIntrospection(\n+      endpoint: String,\n+      headers: Map<String, String>\n+  ): String {\n+\n+    val response = executeQuery(introspectionQuery, endpoint, headers)\n+\n+    return response.body.use { responseBody ->\n+      responseBody!!.string()\n+    }\n+  }\n \n-    response.body.use { responseBody ->\n-      if (schema.extension.toLowerCase() == \"json\") {\n-        schema.writeText(responseBody!!.string())\n-      } else {\n-        IntrospectionSchema(responseBody!!.byteStream()).toSDL(schema)\n+  fun downloadRegistry(graph: String, key: String, variant: String): String? {\n+    val registryQuery = \"\"\"\n+    query {\n+      service(id: \"$graph\") {\n+        schema(tag: \"$variant\") {\n+          document\n+        }\n       }\n     }\n+  \"\"\".trimIndent()\n+\n+    val response = executeQuery(registryQuery, \"https://engine-graphql.apollographql.com/api/graphql\", mapOf(\"x-api-key\" to key))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1da126e84b7a289351c7c19d472a2f93d9164f6e"}, "originalPosition": 99}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25b02fee86742a50698394ec21aaec08cdcd8dfa", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/25b02fee86742a50698394ec21aaec08cdcd8dfa", "committedDate": "2020-09-30T10:31:40Z", "message": "pass the apollographql-client-name and apollographql-client-version\nheaders"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b1a3210148723affcfff852816afa368a77360e", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/6b1a3210148723affcfff852816afa368a77360e", "committedDate": "2020-09-30T11:59:54Z", "message": "gix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a409eaca174cba6c321b6eb7d36343c923486a5", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/5a409eaca174cba6c321b6eb7d36343c923486a5", "committedDate": "2020-09-30T13:39:59Z", "message": "use the new url"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4282, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}