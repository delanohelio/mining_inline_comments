{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyMDQ1OTE1", "number": 2298, "title": "[New Runtime] Add BearerTokenInterceptor", "bodyText": "Continuation of sav007#7\nA BearerTokenInterceptor can be added to the list of interceptors to provide/refresh an accessToken.\nPart of #2222", "createdAt": "2020-05-22T17:00:19Z", "url": "https://github.com/apollographql/apollo-android/pull/2298", "merged": true, "mergeCommit": {"oid": "553b3c5c331ca80db2c9f075b2ecd7be791bf863"}, "closed": true, "closedAt": "2020-05-28T07:49:54Z", "author": {"login": "martinbonnin"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjzqToAH2gAyNDIyMDQ1OTE1OjY4MWI5NWQ3M2JkYjYwMWUyM2UyNzU2ODliMWNhZDk5ZjI5N2EzMjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcld3C1gFqTQxOTUxMzM0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "681b95d73bdb601e23e275689b1cad99f297a321", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/681b95d73bdb601e23e275689b1cad99f297a321", "committedDate": "2020-05-22T15:04:48Z", "message": "add OauthInterceptor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "515db2430f22f4838c7451cd608da5634ba903d9", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/515db2430f22f4838c7451cd608da5634ba903d9", "committedDate": "2020-05-22T15:04:50Z", "message": "use retry and lock from the interceptor itself"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1de2690f48c63f4d87b8bf085192642d04716587", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/1de2690f48c63f4d87b8bf085192642d04716587", "committedDate": "2020-05-22T15:04:50Z", "message": "rename to BearerTokenInterceptor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8ca6adf7c7905625fdbe65350612b1aa0bc4ab4", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/c8ca6adf7c7905625fdbe65350612b1aa0bc4ab4", "committedDate": "2020-05-22T16:58:33Z", "message": "integrate feedbacks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NjY2NDkw", "url": "https://github.com/apollographql/apollo-android/pull/2298#pullrequestreview-418666490", "createdAt": "2020-05-26T20:46:27Z", "commit": {"oid": "c8ca6adf7c7905625fdbe65350612b1aa0bc4ab4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMDo0NjoyN1rOGavuQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMDo0NjoyN1rOGavuQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY5ODA0OQ==", "bodyText": "I feel like this let only add to the default branch with emptyMap. It should add to the existing context, shouldn't it?", "url": "https://github.com/apollographql/apollo-android/pull/2298#discussion_r430698049", "createdAt": "2020-05-26T20:46:27Z", "author": {"login": "tasomaniac"}, "path": "apollo-runtime-kotlin/src/commonMain/kotlin/com/apollographql/apollo/interceptor/BearerTokenInterceptor.kt", "diffHunk": "@@ -0,0 +1,61 @@\n+package com.apollographql.apollo.interceptor\n+\n+import com.apollographql.apollo.ApolloException\n+import com.apollographql.apollo.ApolloHttpException\n+import com.apollographql.apollo.BearerTokenException\n+import com.apollographql.apollo.api.ApolloExperimental\n+import com.apollographql.apollo.api.Response\n+import com.apollographql.apollo.network.HttpExecutionContext\n+import kotlinx.coroutines.flow.Flow\n+import kotlinx.coroutines.flow.catch\n+import kotlinx.coroutines.flow.flatMapConcat\n+import kotlinx.coroutines.flow.flow\n+import kotlinx.coroutines.flow.retry\n+import kotlinx.coroutines.sync.Mutex\n+import kotlinx.coroutines.sync.withLock\n+\n+@ApolloExperimental\n+class BearerTokenInterceptor(private val tokenProvider: TokenProvider) : ApolloRequestInterceptor {\n+  val mutex = Mutex()\n+\n+  private fun <T> ApolloRequest<T>.withHeader(name: String, value: String): ApolloRequest<T> {\n+    val httpRequestContext = executionContext[HttpExecutionContext.Request]\n+        ?: HttpExecutionContext.Request(emptyMap())\n+            .let {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8ca6adf7c7905625fdbe65350612b1aa0bc4ab4"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NjY3NTc2", "url": "https://github.com/apollographql/apollo-android/pull/2298#pullrequestreview-418667576", "createdAt": "2020-05-26T20:48:01Z", "commit": {"oid": "c8ca6adf7c7905625fdbe65350612b1aa0bc4ab4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMDo0ODowMVrOGavxbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMDo0ODowMVrOGavxbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY5ODg2Mg==", "bodyText": "Would it make sense to somehow extend ApolloHttpException here since this is essentially also an HttpException", "url": "https://github.com/apollographql/apollo-android/pull/2298#discussion_r430698862", "createdAt": "2020-05-26T20:48:01Z", "author": {"login": "tasomaniac"}, "path": "apollo-runtime-kotlin/src/commonMain/kotlin/com/apollographql/apollo/ApolloException.kt", "diffHunk": "@@ -14,3 +14,5 @@ class ApolloHttpException(\n     message: String,\n     cause: Throwable? = null\n ) : ApolloException(message = message, cause = cause)\n+\n+class BearerTokenException(message: String, cause: Throwable? = null, val token: String): ApolloException(message = message, cause = cause)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8ca6adf7c7905625fdbe65350612b1aa0bc4ab4"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NjY5NTA1", "url": "https://github.com/apollographql/apollo-android/pull/2298#pullrequestreview-418669505", "createdAt": "2020-05-26T20:51:07Z", "commit": {"oid": "c8ca6adf7c7905625fdbe65350612b1aa0bc4ab4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMDo1MTowOFrOGav3OQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQyMDo1MTowOFrOGav3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcwMDM0NQ==", "bodyText": "I wonder how much we should follow OAuth standards here? I was thinking about refreshToken for example. That is usually used for getting a new token in such scenario.", "url": "https://github.com/apollographql/apollo-android/pull/2298#discussion_r430700345", "createdAt": "2020-05-26T20:51:08Z", "author": {"login": "tasomaniac"}, "path": "apollo-runtime-kotlin/src/commonMain/kotlin/com/apollographql/apollo/interceptor/TokenProvider.kt", "diffHunk": "@@ -0,0 +1,6 @@\n+package com.apollographql.apollo.interceptor\n+\n+interface TokenProvider {\n+  suspend fun currentToken(): String\n+  suspend fun renewToken(previousToken: String): String", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8ca6adf7c7905625fdbe65350612b1aa0bc4ab4"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bdb51e205db90dd4018b020aea5619dbfde209c", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/1bdb51e205db90dd4018b020aea5619dbfde209c", "committedDate": "2020-05-26T21:25:24Z", "message": "fix let applied to the wrong expression"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43b10e8d0a1dadd3a4b0d968c27c2984fb3e576e", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/43b10e8d0a1dadd3a4b0d968c27c2984fb3e576e", "committedDate": "2020-05-26T21:30:26Z", "message": "prefix with `Apollo`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3623a3fac3da1075177517ec2f7d9ee75eab8ae6", "author": {"user": {"login": "martinbonnin", "name": "Martin Bonnin"}}, "url": "https://github.com/apollographql/apollo-android/commit/3623a3fac3da1075177517ec2f7d9ee75eab8ae6", "committedDate": "2020-05-26T21:31:04Z", "message": "renewToken -> refreshToken"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NTEzMzQx", "url": "https://github.com/apollographql/apollo-android/pull/2298#pullrequestreview-419513341", "createdAt": "2020-05-27T18:48:39Z", "commit": {"oid": "3623a3fac3da1075177517ec2f7d9ee75eab8ae6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3808, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}