{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4MjU3NTg0", "number": 2388, "title": "Subscription connection keep alive", "bodyText": "Add support for heart beat feature, see https://github.com/apollographql/subscriptions-transport-ws/blob/master/PROTOCOL.md#gql_connection_keep_alive\nAuto close web socket connection if GQL_CONNECTION_KEEP_ALIVE has not been received in configured timeout.\nPart of #2222", "createdAt": "2020-06-23T01:20:34Z", "url": "https://github.com/apollographql/apollo-android/pull/2388", "merged": true, "mergeCommit": {"oid": "818ff720fe982132e9e0d5bccd20e3aa112774a4"}, "closed": true, "closedAt": "2020-06-25T22:07:17Z", "author": {"login": "sav007"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABct7CrgAH2gAyNDM4MjU3NTg0OmRlMGRlZGY2MTM0NzYzNmQxYTVlOWZlOTJlNjY5NjllOTcxYjIxYjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcus1-zgFqTQzNzM5ODY4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "de0dedf61347636d1a5e9fe92e66969e971b21b0", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/de0dedf61347636d1a5e9fe92e66969e971b21b0", "committedDate": "2020-06-23T01:20:00Z", "message": "Subscription connection keep alive\n\nAdd support for heart beat feature, see https://github.com/apollographql/subscriptions-transport-ws/blob/master/PROTOCOL.md#gql_connection_keep_alive\n\nAuto close web socket connection if `GQL_CONNECTION_KEEP_ALIVE` has not been received in configured timeout.\n\nPart of https://github.com/apollographql/apollo-android/issues/2222"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NjA2NzM4", "url": "https://github.com/apollographql/apollo-android/pull/2388#pullrequestreview-435606738", "createdAt": "2020-06-23T09:30:05Z", "commit": {"oid": "de0dedf61347636d1a5e9fe92e66969e971b21b0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwOTozMDowNVrOGnhHfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwOTozMDowNVrOGnhHfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA5MDIzOQ==", "bodyText": "Why is this yield required?", "url": "https://github.com/apollographql/apollo-android/pull/2388#discussion_r444090239", "createdAt": "2020-06-23T09:30:05Z", "author": {"login": "martinbonnin"}, "path": "apollo-runtime-kotlin/src/commonMain/kotlin/com/apollographql/apollo/network/ws/ApolloWebSocketNetworkTransport.kt", "diffHunk": "@@ -205,22 +214,34 @@ class ApolloWebSocketNetworkTransport(\n \n     private suspend fun onUnsubscribed() {\n       mutex.withLock {\n-        if (--activeSubscriptionCount == 0) scheduleAutoClose()\n+        if (--activeSubscriptionCount == 0 && idleTimeoutMs > 0) {\n+          idleTimeoutJob?.cancel()\n+          connectionKeepAliveTimeoutJob?.cancel()\n+\n+          idleTimeoutJob = coroutineScope.launch {\n+            delay(idleTimeoutMs)\n+            close()\n+          }\n+        }\n       }\n     }\n \n-    private fun scheduleAutoClose() {\n-      idleTimeoutJob?.cancel()\n-      if (idleTimeoutMs > 0) {\n-        idleTimeoutJob = coroutineScope.launch {\n-          delay(idleTimeoutMs)\n-          close()\n+    private suspend fun onConnectionKeepAlive() {\n+      mutex.withLock {\n+        if (activeSubscriptionCount > 0 && connectionKeepAliveTimeoutMs > 0) {\n+          connectionKeepAliveTimeoutJob?.cancel()\n+\n+          connectionKeepAliveTimeoutJob = coroutineScope.launch {\n+            delay(idleTimeoutMs)\n+            close()\n+          }\n         }\n       }\n     }\n \n     private suspend fun close() {\n       mutex.withLock {\n+        yield()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de0dedf61347636d1a5e9fe92e66969e971b21b0"}, "originalPosition": 112}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86f8ad3d789a81d9c4397fb5e2faae48fc653ec0", "author": {"user": {"login": "sav007", "name": "Ivan Savytskyi"}}, "url": "https://github.com/apollographql/apollo-android/commit/86f8ad3d789a81d9c4397fb5e2faae48fc653ec0", "committedDate": "2020-06-24T18:08:15Z", "message": "Remove redundant `yield`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3Mzk4Njg0", "url": "https://github.com/apollographql/apollo-android/pull/2388#pullrequestreview-437398684", "createdAt": "2020-06-25T11:21:23Z", "commit": {"oid": "86f8ad3d789a81d9c4397fb5e2faae48fc653ec0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3854, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}