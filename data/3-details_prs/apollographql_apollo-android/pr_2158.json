{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyNDE3Njg4", "number": 2158, "title": "Replace legacy Android SQL with SqlDelight", "bodyText": "After discussing with @martinbonnin we've decided to create a new module apollo-sqlite-cache for the new persisted cache implementation.\nConsiderations\n\napollo-android-support now depends on the new module for backward compatibility purposes.\nApolloSqlHelper is kept 100% backward compatible and deprecated.\napollo-normalized-cache-api module is added for shared API between components.\n\nFixes #2116", "createdAt": "2020-04-12T23:55:09Z", "url": "https://github.com/apollographql/apollo-android/pull/2158", "merged": true, "mergeCommit": {"oid": "ff04e5d65262ba8e31c7729c18beef6825a0ab22"}, "closed": true, "closedAt": "2020-04-13T13:16:40Z", "author": {"login": "tasomaniac"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXDTU_AH2gAyNDAyNDE3Njg4OmRhZWQ5MGNlNjU2OGVjY2RkMGJiZjM1NDFjZGJiMTM0ZjYzNTdmNjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXONP-gFqTM5MjExOTQ5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "daed90ce6568eccdd0bbf3541cdbb134f6357f67", "author": {"user": {"login": "tasomaniac", "name": "Said Tahsin Dane"}}, "url": "https://github.com/apollographql/apollo-android/commit/daed90ce6568eccdd0bbf3541cdbb134f6357f67", "committedDate": "2020-04-12T23:57:10Z", "message": "Initial SqlDelight integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84bfffaa98a3c56cb1c895c52ab69969c2365740", "author": {"user": {"login": "tasomaniac", "name": "Said Tahsin Dane"}}, "url": "https://github.com/apollographql/apollo-android/commit/84bfffaa98a3c56cb1c895c52ab69969c2365740", "committedDate": "2020-04-12T23:57:10Z", "message": "Use it in the sample"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38a1c9c3fb75d9f53d11c4e24f41948a8b7283ff", "author": {"user": {"login": "tasomaniac", "name": "Said Tahsin Dane"}}, "url": "https://github.com/apollographql/apollo-android/commit/38a1c9c3fb75d9f53d11c4e24f41948a8b7283ff", "committedDate": "2020-04-12T23:57:10Z", "message": "Keep API similar by keeping ApolloSqlHelper class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1ebd845a6a4a8dfefeff992da26c06f23c81733", "author": {"user": {"login": "tasomaniac", "name": "Said Tahsin Dane"}}, "url": "https://github.com/apollographql/apollo-android/commit/a1ebd845a6a4a8dfefeff992da26c06f23c81733", "committedDate": "2020-04-12T23:57:10Z", "message": "Move and run SqlNormalizedCacheTest's in JVM"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5eee7b447e14c9b76fc65ede708c06bce0a25cf0", "author": {"user": {"login": "tasomaniac", "name": "Said Tahsin Dane"}}, "url": "https://github.com/apollographql/apollo-android/commit/5eee7b447e14c9b76fc65ede708c06bce0a25cf0", "committedDate": "2020-04-12T23:57:10Z", "message": "Split cache stuff into 3 modules:\n- sqlite-cache\n- normalized-cache-api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c4e24ef5f9f5b48b3a4199e7eadbf5e634ef465", "author": {"user": {"login": "tasomaniac", "name": "Said Tahsin Dane"}}, "url": "https://github.com/apollographql/apollo-android/commit/9c4e24ef5f9f5b48b3a4199e7eadbf5e634ef465", "committedDate": "2020-04-12T23:57:10Z", "message": "Make sure we have 100% backward compat by reverting the sample"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c27ce4c8d10d87def6d9cbdc0471259e49bb68fc", "author": {"user": {"login": "tasomaniac", "name": "Said Tahsin Dane"}}, "url": "https://github.com/apollographql/apollo-android/commit/c27ce4c8d10d87def6d9cbdc0471259e49bb68fc", "committedDate": "2020-04-12T23:57:10Z", "message": "Add TODO message to cache dependency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "973b065a9dc625e606c7db494ab02413727e0db9", "author": {"user": {"login": "tasomaniac", "name": "Said Tahsin Dane"}}, "url": "https://github.com/apollographql/apollo-android/commit/973b065a9dc625e606c7db494ab02413727e0db9", "committedDate": "2020-04-12T23:57:10Z", "message": "Revert unnecessary change"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "16269bc4ba99ecb3fbb64f258a875abff7115006", "author": {"user": {"login": "tasomaniac", "name": "Said Tahsin Dane"}}, "url": "https://github.com/apollographql/apollo-android/commit/16269bc4ba99ecb3fbb64f258a875abff7115006", "committedDate": "2020-04-12T23:55:44Z", "message": "Revert unnecessary change"}, "afterCommit": {"oid": "973b065a9dc625e606c7db494ab02413727e0db9", "author": {"user": {"login": "tasomaniac", "name": "Said Tahsin Dane"}}, "url": "https://github.com/apollographql/apollo-android/commit/973b065a9dc625e606c7db494ab02413727e0db9", "committedDate": "2020-04-12T23:57:10Z", "message": "Revert unnecessary change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMDI2OTE0", "url": "https://github.com/apollographql/apollo-android/pull/2158#pullrequestreview-392026914", "createdAt": "2020-04-13T08:38:59Z", "commit": {"oid": "973b065a9dc625e606c7db494ab02413727e0db9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QwODozODo1OVrOGEgfbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QwODozODo1OVrOGEgfbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM3OTgyMQ==", "bodyText": "Nitpicking, maybe not update key ?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            UPDATE records SET key=:key, record=:record WHERE key=:key;\n          \n          \n            \n            UPDATE records SET record=:record WHERE key=:key;", "url": "https://github.com/apollographql/apollo-android/pull/2158#discussion_r407379821", "createdAt": "2020-04-13T08:38:59Z", "author": {"login": "martinbonnin"}, "path": "apollo-sqlite-cache/src/main/sqldelight/com/apollographql/apollo/cache/normalized/sql/cache.sq", "diffHunk": "@@ -0,0 +1,25 @@\n+CREATE TABLE records (\n+  _id INTEGER PRIMARY KEY AUTOINCREMENT,\n+  key TEXT NOT NULL,\n+  record TEXT NOT NULL\n+);\n+\n+CREATE INDEX idx_records_key ON records(key);\n+\n+recordForKey:\n+SELECT key, record FROM records WHERE key=?;\n+\n+insert:\n+INSERT INTO records (key, record) VALUES (?,?);\n+\n+update:\n+UPDATE records SET key=:key, record=:record WHERE key=:key;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "973b065a9dc625e606c7db494ab02413727e0db9"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMDI4Njcw", "url": "https://github.com/apollographql/apollo-android/pull/2158#pullrequestreview-392028670", "createdAt": "2020-04-13T08:43:00Z", "commit": {"oid": "973b065a9dc625e606c7db494ab02413727e0db9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QwODo0MzowMVrOGEglHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QwODo0MzowMVrOGEglHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM4MTI3Nw==", "bodyText": "Nitpicking about the naming: what about apollo-normalized-cache-sqldelight ?  This would:\n\nput the module next to apollo-normalized-cache and apollo-normalized-cache-api when sorted alphabetically\nmake a clear distinction between 'normalized' caches and 'http' ones.\nallow for sqlite implementation without sqldelight", "url": "https://github.com/apollographql/apollo-android/pull/2158#discussion_r407381277", "createdAt": "2020-04-13T08:43:01Z", "author": {"login": "martinbonnin"}, "path": "apollo-sqlite-cache/gradle.properties", "diffHunk": "@@ -0,0 +1,4 @@\n+POM_ARTIFACT_ID=apollo-sqlite-cache", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "973b065a9dc625e606c7db494ab02413727e0db9"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMDMxMTY4", "url": "https://github.com/apollographql/apollo-android/pull/2158#pullrequestreview-392031168", "createdAt": "2020-04-13T08:49:00Z", "commit": {"oid": "973b065a9dc625e606c7db494ab02413727e0db9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QwODo0OTowMFrOGEgtsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QwODo0OTowMFrOGEgtsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM4MzQ3NA==", "bodyText": "What about SQLDelightNormalizedCache ?", "url": "https://github.com/apollographql/apollo-android/pull/2158#discussion_r407383474", "createdAt": "2020-04-13T08:49:00Z", "author": {"login": "martinbonnin"}, "path": "apollo-sqlite-cache/src/main/java/com/apollographql/apollo/cache/normalized/sql/SqlNormalizedCache.kt", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.apollographql.apollo.cache.normalized.sql\n+\n+import com.apollographql.apollo.cache.ApolloCacheHeaders.EVICT_AFTER_READ\n+import com.apollographql.apollo.cache.CacheHeaders\n+import com.apollographql.apollo.cache.normalized.CacheKey\n+import com.apollographql.apollo.cache.normalized.NormalizedCache\n+import com.apollographql.apollo.cache.normalized.Record\n+import com.apollographql.apollo.cache.normalized.RecordFieldJsonAdapter\n+import okio.IOException\n+\n+class SqlNormalizedCache(\n+    private val recordFieldAdapter: RecordFieldJsonAdapter,\n+    private val cacheQueries: CacheQueries\n+) : NormalizedCache() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "973b065a9dc625e606c7db494ab02413727e0db9"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMDMzMDE0", "url": "https://github.com/apollographql/apollo-android/pull/2158#pullrequestreview-392033014", "createdAt": "2020-04-13T08:53:34Z", "commit": {"oid": "973b065a9dc625e606c7db494ab02413727e0db9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QwODo1MzozNFrOGEg0NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QwODo1MzozNFrOGEg0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzM4NTE0MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      .executeAsList()\n          \n          \n            \n                      .firstOrNull()\n          \n          \n            \n                      .executeAsOneOrNull()", "url": "https://github.com/apollographql/apollo-android/pull/2158#discussion_r407385140", "createdAt": "2020-04-13T08:53:34Z", "author": {"login": "martinbonnin"}, "path": "apollo-sqlite-cache/src/main/java/com/apollographql/apollo/cache/normalized/sql/SqlNormalizedCache.kt", "diffHunk": "@@ -0,0 +1,97 @@\n+package com.apollographql.apollo.cache.normalized.sql\n+\n+import com.apollographql.apollo.cache.ApolloCacheHeaders.EVICT_AFTER_READ\n+import com.apollographql.apollo.cache.CacheHeaders\n+import com.apollographql.apollo.cache.normalized.CacheKey\n+import com.apollographql.apollo.cache.normalized.NormalizedCache\n+import com.apollographql.apollo.cache.normalized.Record\n+import com.apollographql.apollo.cache.normalized.RecordFieldJsonAdapter\n+import okio.IOException\n+\n+class SqlNormalizedCache(\n+    private val recordFieldAdapter: RecordFieldJsonAdapter,\n+    private val cacheQueries: CacheQueries\n+) : NormalizedCache() {\n+\n+  override fun loadRecord(key: String, cacheHeaders: CacheHeaders): Record? {\n+    val record = selectRecordForKey(key)\n+\n+    if (record != null) {\n+      if (cacheHeaders.hasHeader(EVICT_AFTER_READ)) {\n+        deleteRecord(key)\n+      }\n+      return record\n+    }\n+    return nextCache?.loadRecord(key, cacheHeaders)\n+  }\n+\n+  override fun clearAll() {\n+    nextCache?.clearAll()\n+    cacheQueries.deleteAll()\n+  }\n+\n+  override fun remove(cacheKey: CacheKey, cascade: Boolean): Boolean {\n+    val result: Boolean = nextCache?.remove(cacheKey, cascade) ?: false\n+    if (result) {\n+      return true\n+    }\n+    return if (cascade) {\n+      selectRecordForKey(cacheKey.key)\n+          ?.referencedFields()\n+          ?.all { remove(CacheKey(it.key()), cascade = true) }\n+          ?: false\n+    } else {\n+      deleteRecord(cacheKey.key)\n+    }\n+  }\n+\n+  override fun performMerge(apolloRecord: Record, cacheHeaders: CacheHeaders): Set<String> {\n+    val oldRecord = selectRecordForKey(apolloRecord.key())\n+    return if (oldRecord == null) {\n+      cacheQueries.insert(apolloRecord.key(), recordFieldAdapter.toJson(apolloRecord.fields()))\n+      emptySet()\n+    } else {\n+      oldRecord.mergeWith(apolloRecord).also {\n+        if (it.isNotEmpty()) {\n+          cacheQueries.update(oldRecord.key(), recordFieldAdapter.toJson(oldRecord.fields()))\n+        }\n+      }\n+    }\n+  }\n+\n+  fun selectRecordForKey(key: String): Record? {\n+    return try {\n+      cacheQueries.recordForKey(key)\n+          .executeAsList()\n+          .firstOrNull()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "973b065a9dc625e606c7db494ab02413727e0db9"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d937ca3da450333abc4bda66dc9018df24324598", "author": {"user": {"login": "tasomaniac", "name": "Said Tahsin Dane"}}, "url": "https://github.com/apollographql/apollo-android/commit/d937ca3da450333abc4bda66dc9018df24324598", "committedDate": "2020-04-13T10:48:42Z", "message": "Remove unneeded key update.\n\nCo-Authored-By: Martin Bonnin <martin@mbonnin.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "114c8dcf825ff726964679843f4bf2af6e92136f", "author": {"user": {"login": "tasomaniac", "name": "Said Tahsin Dane"}}, "url": "https://github.com/apollographql/apollo-android/commit/114c8dcf825ff726964679843f4bf2af6e92136f", "committedDate": "2020-04-13T11:01:30Z", "message": "Rename module"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "517572b5f23da6a93024454a413dbf6120fef0a1", "author": {"user": {"login": "tasomaniac", "name": "Said Tahsin Dane"}}, "url": "https://github.com/apollographql/apollo-android/commit/517572b5f23da6a93024454a413dbf6120fef0a1", "committedDate": "2020-04-13T11:06:45Z", "message": "Move CacheKeyResolver.kt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4bbd7b7c22786fd1a962b382969837c68e88cc2", "author": {"user": {"login": "tasomaniac", "name": "Said Tahsin Dane"}}, "url": "https://github.com/apollographql/apollo-android/commit/b4bbd7b7c22786fd1a962b382969837c68e88cc2", "committedDate": "2020-04-13T11:14:19Z", "message": "Make constructor internal"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8dc9232012c706abdbec3ab096d78e239d2967d9", "author": {"user": {"login": "tasomaniac", "name": "Said Tahsin Dane"}}, "url": "https://github.com/apollographql/apollo-android/commit/8dc9232012c706abdbec3ab096d78e239d2967d9", "committedDate": "2020-04-13T11:17:39Z", "message": "Keep constructor internal for tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c0ba701b7933103d7864a0c75baad00f199f798", "author": {"user": {"login": "tasomaniac", "name": "Said Tahsin Dane"}}, "url": "https://github.com/apollographql/apollo-android/commit/1c0ba701b7933103d7864a0c75baad00f199f798", "committedDate": "2020-04-13T11:26:42Z", "message": "Move api related tests to api module\nConvert WriteableStore to Kotlin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6178af7083dc1bc7d6f1139316345f6ba3c83c5a", "author": {"user": {"login": "tasomaniac", "name": "Said Tahsin Dane"}}, "url": "https://github.com/apollographql/apollo-android/commit/6178af7083dc1bc7d6f1139316345f6ba3c83c5a", "committedDate": "2020-04-13T11:30:30Z", "message": "Add the db schema into source control"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "023c4bad7a2aa715075f13a26501add1230eb1d6", "author": {"user": {"login": "tasomaniac", "name": "Said Tahsin Dane"}}, "url": "https://github.com/apollographql/apollo-android/commit/023c4bad7a2aa715075f13a26501add1230eb1d6", "committedDate": "2020-04-13T12:36:17Z", "message": "Remove deprecated usage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMTE5NDk2", "url": "https://github.com/apollographql/apollo-android/pull/2158#pullrequestreview-392119496", "createdAt": "2020-04-13T12:39:29Z", "commit": {"oid": "023c4bad7a2aa715075f13a26501add1230eb1d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3933, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}