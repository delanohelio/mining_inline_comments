{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4ODk1Nzgw", "number": 2220, "title": "Migrate Transaction and EvictionPolicy to Kotlin (#2144)", "bodyText": "", "createdAt": "2020-04-25T11:46:06Z", "url": "https://github.com/apollographql/apollo-android/pull/2220", "merged": true, "mergeCommit": {"oid": "8e96b1f5f43c917faa6a557aa397182c620754aa"}, "closed": true, "closedAt": "2020-04-26T19:22:49Z", "author": {"login": "SubhrajyotiSen"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcbEiLDgH2gAyNDA4ODk1NzgwOjliY2UyMTJiNDM1YjViZDkzMzVlODNkZDU3OThjNzE2OTdkNWQ4M2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbdoc0AFqTQwMDUyNTEzOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9bce212b435b5bd9335e83dd5798c71697d5d83b", "author": {"user": {"login": "SubhrajyotiSen", "name": "Subhrajyoti Sen"}}, "url": "https://github.com/apollographql/apollo-android/commit/9bce212b435b5bd9335e83dd5798c71697d5d83b", "committedDate": "2020-04-25T11:38:59Z", "message": "Migrate Transaction and EvictionPolicy to Kotlin (#2144)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDI1NzEy", "url": "https://github.com/apollographql/apollo-android/pull/2220#pullrequestreview-400425712", "createdAt": "2020-04-25T19:46:58Z", "commit": {"oid": "9bce212b435b5bd9335e83dd5798c71697d5d83b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQxOTo0Njo1OVrOGL5k4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQxOTo0Nzo0N1rOGL5lVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzMDg0OA==", "bodyText": "Can you remove usages of Optional and replace them with Kotlin Nullable type? Of course we need to be careful in places where these are exposed as public API. But I think it is still possible to remove as much as possible.", "url": "https://github.com/apollographql/apollo-android/pull/2220#discussion_r415130848", "createdAt": "2020-04-25T19:46:59Z", "author": {"login": "tasomaniac"}, "path": "apollo-normalized-cache/src/main/java/com/apollographql/apollo/cache/normalized/lru/EvictionPolicy.kt", "diffHunk": "@@ -0,0 +1,92 @@\n+package com.apollographql.apollo.cache.normalized.lru\n+\n+import com.apollographql.apollo.api.internal.Optional\n+import java.util.concurrent.TimeUnit\n+\n+/**\n+ * Controls how long a [com.apollographql.apollo.cache.normalized.Record] will\n+ * stay in a [LruNormalizedCache].\n+ */\n+class EvictionPolicy internal constructor(\n+    private val maxSizeBytes: Optional<Long>,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bce212b435b5bd9335e83dd5798c71697d5d83b"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzMDk2NQ==", "bodyText": "JvmStatic?", "url": "https://github.com/apollographql/apollo-android/pull/2220#discussion_r415130965", "createdAt": "2020-04-25T19:47:47Z", "author": {"login": "tasomaniac"}, "path": "apollo-normalized-cache/src/main/java/com/apollographql/apollo/cache/normalized/lru/EvictionPolicy.kt", "diffHunk": "@@ -0,0 +1,92 @@\n+package com.apollographql.apollo.cache.normalized.lru\n+\n+import com.apollographql.apollo.api.internal.Optional\n+import java.util.concurrent.TimeUnit\n+\n+/**\n+ * Controls how long a [com.apollographql.apollo.cache.normalized.Record] will\n+ * stay in a [LruNormalizedCache].\n+ */\n+class EvictionPolicy internal constructor(\n+    private val maxSizeBytes: Optional<Long>,\n+    private val maxEntries: Optional<Long>,\n+    private val expireAfterAccess: Optional<Long>,\n+    private val expireAfterAccessTimeUnit: Optional<TimeUnit>,\n+    private val expireAfterWrite: Optional<Long>,\n+    private val expireAfterWriteTimeUnit: Optional<TimeUnit>\n+) {\n+\n+  fun maxSizeBytes(): Optional<Long> {\n+    return maxSizeBytes\n+  }\n+\n+  fun maxEntries(): Optional<Long> {\n+    return maxEntries\n+  }\n+\n+  fun expireAfterAccess(): Optional<Long> {\n+    return expireAfterAccess\n+  }\n+\n+  fun expireAfterAccessTimeUnit(): Optional<TimeUnit> {\n+    return expireAfterAccessTimeUnit\n+  }\n+\n+  fun expireAfterWrite(): Optional<Long> {\n+    return expireAfterWrite\n+  }\n+\n+  fun expireAfterWriteTimeUnit(): Optional<TimeUnit> {\n+    return expireAfterWriteTimeUnit\n+  }\n+\n+  class Builder internal constructor() {\n+    private var maxSizeBytes = Optional.absent<Long>()\n+    private var maxEntries = Optional.absent<Long>()\n+    private var expireAfterAccess = Optional.absent<Long>()\n+    private var expireAfterAccessTimeUnit = Optional.absent<TimeUnit>()\n+    private var expireAfterWrite = Optional.absent<Long>()\n+    private var expireAfterWriteTimeUnit = Optional.absent<TimeUnit>()\n+\n+    fun maxSizeBytes(maxSizeBytes: Long): Builder {\n+      this.maxSizeBytes = Optional.of(maxSizeBytes)\n+      return this\n+    }\n+\n+    fun maxEntries(maxEntries: Long): Builder {\n+      this.maxEntries = Optional.of(maxEntries)\n+      return this\n+    }\n+\n+    fun expireAfterAccess(time: Long, timeUnit: TimeUnit): Builder {\n+      expireAfterAccess = Optional.of(time)\n+      expireAfterAccessTimeUnit = Optional.of(timeUnit)\n+      return this\n+    }\n+\n+    fun expireAfterWrite(time: Long, timeUnit: TimeUnit): Builder {\n+      expireAfterWrite = Optional.of(time)\n+      expireAfterWriteTimeUnit = Optional.of(timeUnit)\n+      return this\n+    }\n+\n+    fun build(): EvictionPolicy {\n+      return EvictionPolicy(\n+          maxSizeBytes,\n+          maxEntries,\n+          expireAfterAccess,\n+          expireAfterAccessTimeUnit,\n+          expireAfterWrite,\n+          expireAfterWriteTimeUnit\n+      )\n+    }\n+  }\n+\n+  companion object {\n+    val NO_EVICTION = builder().build()\n+    fun builder(): Builder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bce212b435b5bd9335e83dd5798c71697d5d83b"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e08de22a26c93627eac60fdd9a5b701cfc23fb49", "author": {"user": {"login": "SubhrajyotiSen", "name": "Subhrajyoti Sen"}}, "url": "https://github.com/apollographql/apollo-android/commit/e08de22a26c93627eac60fdd9a5b701cfc23fb49", "committedDate": "2020-04-25T20:05:56Z", "message": "EvictionPolicy: replace Optional with Nullable type for internal usage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDI3NDQz", "url": "https://github.com/apollographql/apollo-android/pull/2220#pullrequestreview-400427443", "createdAt": "2020-04-25T20:11:18Z", "commit": {"oid": "e08de22a26c93627eac60fdd9a5b701cfc23fb49"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQyMDoxMToxOFrOGL50tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQyMDoxMToxOFrOGL50tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEzNDkwMw==", "bodyText": "@tasomaniac Should I add imports for @JvmStatic and @JvmField since they are needed for Multiplatform like you mentioned on #2211", "url": "https://github.com/apollographql/apollo-android/pull/2220#discussion_r415134903", "createdAt": "2020-04-25T20:11:18Z", "author": {"login": "SubhrajyotiSen"}, "path": "apollo-normalized-cache/src/main/java/com/apollographql/apollo/cache/normalized/lru/EvictionPolicy.kt", "diffHunk": "@@ -0,0 +1,96 @@\n+package com.apollographql.apollo.cache.normalized.lru\n+\n+import com.apollographql.apollo.api.internal.Optional\n+import java.util.concurrent.TimeUnit\n+\n+/**\n+ * Controls how long a [com.apollographql.apollo.cache.normalized.Record] will\n+ * stay in a [LruNormalizedCache].\n+ */\n+class EvictionPolicy internal constructor(\n+    private val maxSizeBytes: Optional<Long>,\n+    private val maxEntries: Optional<Long>,\n+    private val expireAfterAccess: Optional<Long>,\n+    private val expireAfterAccessTimeUnit: Optional<TimeUnit>,\n+    private val expireAfterWrite: Optional<Long>,\n+    private val expireAfterWriteTimeUnit: Optional<TimeUnit>\n+) {\n+\n+  fun maxSizeBytes(): Optional<Long> {\n+    return maxSizeBytes\n+  }\n+\n+  fun maxEntries(): Optional<Long> {\n+    return maxEntries\n+  }\n+\n+  fun expireAfterAccess(): Optional<Long> {\n+    return expireAfterAccess\n+  }\n+\n+  fun expireAfterAccessTimeUnit(): Optional<TimeUnit> {\n+    return expireAfterAccessTimeUnit\n+  }\n+\n+  fun expireAfterWrite(): Optional<Long> {\n+    return expireAfterWrite\n+  }\n+\n+  fun expireAfterWriteTimeUnit(): Optional<TimeUnit> {\n+    return expireAfterWriteTimeUnit\n+  }\n+\n+  class Builder internal constructor() {\n+    private var maxSizeBytes: Long? = null\n+    private var maxEntries: Long? = null\n+    private var expireAfterAccess: Long? = null\n+    private var expireAfterAccessTimeUnit: TimeUnit? = null\n+    private var expireAfterWrite: Long? = null\n+    private var expireAfterWriteTimeUnit: TimeUnit? = null\n+\n+    fun maxSizeBytes(maxSizeBytes: Long): Builder {\n+      this.maxSizeBytes = maxSizeBytes\n+      return this\n+    }\n+\n+    fun maxEntries(maxEntries: Long): Builder {\n+      this.maxEntries = maxEntries\n+      return this\n+    }\n+\n+    fun expireAfterAccess(time: Long, timeUnit: TimeUnit): Builder {\n+      expireAfterAccess = time\n+      expireAfterAccessTimeUnit = timeUnit\n+      return this\n+    }\n+\n+    fun expireAfterWrite(time: Long, timeUnit: TimeUnit): Builder {\n+      expireAfterWrite = time\n+      expireAfterWriteTimeUnit = timeUnit\n+      return this\n+    }\n+\n+    fun build(): EvictionPolicy {\n+      return EvictionPolicy(\n+          Optional.fromNullable(maxSizeBytes),\n+          Optional.fromNullable(maxEntries),\n+          Optional.fromNullable(expireAfterAccess),\n+          Optional.fromNullable(expireAfterAccessTimeUnit),\n+          Optional.fromNullable(expireAfterWrite),\n+          Optional.fromNullable(expireAfterWriteTimeUnit)\n+      )\n+    }\n+  }\n+\n+  companion object {\n+\n+    @JvmField\n+    val NO_EVICTION = builder().build()\n+\n+    @JvmStatic\n+    fun builder(): Builder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e08de22a26c93627eac60fdd9a5b701cfc23fb49"}, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDk3Mzc2", "url": "https://github.com/apollographql/apollo-android/pull/2220#pullrequestreview-400497376", "createdAt": "2020-04-26T12:15:05Z", "commit": {"oid": "e08de22a26c93627eac60fdd9a5b701cfc23fb49"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQxMjoxNTowNlrOGMDrRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQxMjoxNTowNlrOGMDrRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI5NjMyNA==", "bodyText": "These are also private. Let's remove Optionals here too. You can take a look at this class for reference. Let's make these public and expose as val maxSizeBytes: Long?\nThen we can keep the below functions with Optional for backward compatibility reasons and deprecate them.\nhttps://github.com/apollographql/apollo-android/blob/master/apollo-normalized-cache-api/src/main/java/com/apollographql/apollo/cache/normalized/NormalizedCache.kt#L129-L130", "url": "https://github.com/apollographql/apollo-android/pull/2220#discussion_r415296324", "createdAt": "2020-04-26T12:15:06Z", "author": {"login": "tasomaniac"}, "path": "apollo-normalized-cache/src/main/java/com/apollographql/apollo/cache/normalized/lru/EvictionPolicy.kt", "diffHunk": "@@ -0,0 +1,96 @@\n+package com.apollographql.apollo.cache.normalized.lru\n+\n+import com.apollographql.apollo.api.internal.Optional\n+import java.util.concurrent.TimeUnit\n+\n+/**\n+ * Controls how long a [com.apollographql.apollo.cache.normalized.Record] will\n+ * stay in a [LruNormalizedCache].\n+ */\n+class EvictionPolicy internal constructor(\n+    private val maxSizeBytes: Optional<Long>,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e08de22a26c93627eac60fdd9a5b701cfc23fb49"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f8fe9dc1fb7fed50879f60b90f5fb6d9ed5f4c5", "author": {"user": {"login": "SubhrajyotiSen", "name": "Subhrajyoti Sen"}}, "url": "https://github.com/apollographql/apollo-android/commit/6f8fe9dc1fb7fed50879f60b90f5fb6d9ed5f4c5", "committedDate": "2020-04-26T16:39:52Z", "message": "Use Nullable isstead of Optional in EvictionPolicy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNTI0MTU4", "url": "https://github.com/apollographql/apollo-android/pull/2220#pullrequestreview-400524158", "createdAt": "2020-04-26T16:43:11Z", "commit": {"oid": "6f8fe9dc1fb7fed50879f60b90f5fb6d9ed5f4c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQxNjo0MzoxMlrOGMG97Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNlQxNjo0MzoxMlrOGMG97Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTM1MDI1Mw==", "bodyText": "@tasomaniac I had to use force unwrap here since expireAfterAccess() expects a Nonnull.\nGiven that the existing implementation does not check with isPresent() for expireAfterAccessTimeUnit, it the force unwrap here okay?", "url": "https://github.com/apollographql/apollo-android/pull/2220#discussion_r415350253", "createdAt": "2020-04-26T16:43:12Z", "author": {"login": "SubhrajyotiSen"}, "path": "apollo-normalized-cache/src/main/java/com/apollographql/apollo/cache/normalized/lru/LruNormalizedCache.kt", "diffHunk": "@@ -21,21 +21,21 @@ class LruNormalizedCache internal constructor(evictionPolicy: EvictionPolicy) :\n \n   private val lruCache: Cache<String, Record> =\n       CacheBuilder.newBuilder().apply {\n-        if (evictionPolicy.maxSizeBytes().isPresent) {\n-          maximumWeight(evictionPolicy.maxSizeBytes().get()).weigher(\n+        if (evictionPolicy.maxSizeBytes != null) {\n+          maximumWeight(evictionPolicy.maxSizeBytes).weigher(\n               Weigher { key: String, value: Record ->\n                 key.toByteArray(Charset.defaultCharset()).size + value.sizeEstimateBytes()\n               }\n           )\n         }\n-        if (evictionPolicy.maxEntries().isPresent) {\n-          maximumSize(evictionPolicy.maxEntries().get())\n+        if (evictionPolicy.maxEntries != null) {\n+          maximumSize(evictionPolicy.maxEntries)\n         }\n-        if (evictionPolicy.expireAfterAccess().isPresent) {\n-          expireAfterAccess(evictionPolicy.expireAfterAccess().get(), evictionPolicy.expireAfterAccessTimeUnit().get())\n+        if (evictionPolicy.expireAfterAccess != null) {\n+          expireAfterAccess(evictionPolicy.expireAfterAccess, evictionPolicy.expireAfterAccessTimeUnit!!)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f8fe9dc1fb7fed50879f60b90f5fb6d9ed5f4c5"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNTI1MTM5", "url": "https://github.com/apollographql/apollo-android/pull/2220#pullrequestreview-400525139", "createdAt": "2020-04-26T16:53:28Z", "commit": {"oid": "6f8fe9dc1fb7fed50879f60b90f5fb6d9ed5f4c5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3986, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}