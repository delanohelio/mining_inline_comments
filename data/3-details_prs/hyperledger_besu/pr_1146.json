{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwMDA1Mzkz", "number": 1146, "title": "Besu vulnerable to being used for DDoS amplification", "bodyText": "PR description\nThis PR modifies the peer discovery process to no longer add peers to the peer table during the PING processing. It now adds the peer to a bonding DS and goes through the bond process to ensure the request is valid. Peers are now added to the peer table only upon the receipt of a successful PONG.\nTesting\n\nRan Hive tests\nSynced goerli\nSynced ropsten\nStarted a mainnet sync\n\nFixed Issue(s)\n#792", "createdAt": "2020-06-25T13:01:49Z", "url": "https://github.com/hyperledger/besu/pull/1146", "merged": true, "mergeCommit": {"oid": "5b39e7e7e76db25911e47e16a04d9d4e0479488e"}, "closed": true, "closedAt": "2020-06-26T11:52:08Z", "author": {"login": "davemec"}, "timelineItems": {"totalCount": 31, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfRP7TgH2gAyNDQwMDA1MzkzOmM2NzY5MzdjMWYxNTk3YzhiNTMzMjAwMTU2NzY1MDA1YWNkNzE5ODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwDc62gFqTQzOTIyMTIwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c676937c1f1597c8b533200156765005acd71986", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/c676937c1f1597c8b533200156765005acd71986", "committedDate": "2020-05-08T12:43:31Z", "message": "Add check for spoofed IP in ping message\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7bef19e8267146126ee798e63aeb5a3878b40f1", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/f7bef19e8267146126ee798e63aeb5a3878b40f1", "committedDate": "2020-05-08T13:09:35Z", "message": "Merge branch 'master' into TKT-792"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26dc9388b381caed88b0c5467dd067ac916e12bd", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/26dc9388b381caed88b0c5467dd067ac916e12bd", "committedDate": "2020-05-08T13:14:01Z", "message": "Fix formatting issues\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be01d47caa641bb37a7ff3a8981432618f8e80a3", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/be01d47caa641bb37a7ff3a8981432618f8e80a3", "committedDate": "2020-05-08T13:14:15Z", "message": "Merge branch 'TKT-792' of github.com:davemec/besu into TKT-792"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de9b2dbad6ce3f79e257f9fec758ac8b6dc34472", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/de9b2dbad6ce3f79e257f9fec758ac8b6dc34472", "committedDate": "2020-05-08T14:14:32Z", "message": "Add logging message when ping request is rejected.\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fb90ebab04899f8cd2cc9f20d25bc98a1400983", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/5fb90ebab04899f8cd2cc9f20d25bc98a1400983", "committedDate": "2020-05-18T13:55:49Z", "message": "Merge branch 'master' of github.com:hyperledger/besu into TKT-792"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c61f74bf2f924199dd4f96acaaf3833c071752f", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/3c61f74bf2f924199dd4f96acaaf3833c071752f", "committedDate": "2020-05-20T13:46:21Z", "message": "Merge branch 'master' of github.com:hyperledger/besu into TKT-792"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45374db4ab63ce2172a559c59d17c0aab915c94c", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/45374db4ab63ce2172a559c59d17c0aab915c94c", "committedDate": "2020-06-02T14:32:28Z", "message": "Merge branch 'master' of github.com:hyperledger/besu into TKT-792"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b99b7c94fb0852f0ca796d1df2002fbc37f552df", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/b99b7c94fb0852f0ca796d1df2002fbc37f552df", "committedDate": "2020-06-04T20:38:41Z", "message": "Revert last changes\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b7b94c7513f62c7aaa47af8552a4ac55650f50d", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/6b7b94c7513f62c7aaa47af8552a4ac55650f50d", "committedDate": "2020-06-08T00:03:13Z", "message": "Merge branch 'master' of github.com:hyperledger/besu into TKT-792"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2eddab4e11b151bcab242bf8a69d903e716f0ea", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/f2eddab4e11b151bcab242bf8a69d903e716f0ea", "committedDate": "2020-06-08T14:43:00Z", "message": "Fix for hive SpoofAmplification test\n\nSigned-off-by: David Mechler <davemec@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8e50cf2005895c233357bcf93d46e87d08e6784", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/a8e50cf2005895c233357bcf93d46e87d08e6784", "committedDate": "2020-06-11T13:31:03Z", "message": "Merge branch 'master' of github.com:hyperledger/besu into TKT-792"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f1af986b12b2ec167efcd850de18a454dcbeab2", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/4f1af986b12b2ec167efcd850de18a454dcbeab2", "committedDate": "2020-06-11T13:33:24Z", "message": "Add check for spoofed IP in ping message\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00c69d9ef86f17e0805877fae12601c71a989b64", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/00c69d9ef86f17e0805877fae12601c71a989b64", "committedDate": "2020-06-11T13:33:24Z", "message": "Fix formatting issues\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05afcf1a103fb77fb2c45c833d3ceb0ff41d461c", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/05afcf1a103fb77fb2c45c833d3ceb0ff41d461c", "committedDate": "2020-06-11T13:33:24Z", "message": "Add logging message when ping request is rejected.\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cce51a048c2c00bcc66ca5bd242c2d21efd4230b", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/cce51a048c2c00bcc66ca5bd242c2d21efd4230b", "committedDate": "2020-06-11T13:33:24Z", "message": "Revert last changes\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96fc849497a7a445e66fef8e1a632729b305555b", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/96fc849497a7a445e66fef8e1a632729b305555b", "committedDate": "2020-06-11T13:33:24Z", "message": "Fix for hive SpoofAmplification test\n\nSigned-off-by: David Mechler <davemec@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f8b8ad47c7226452f1e4bb0052052b801df83dc", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/5f8b8ad47c7226452f1e4bb0052052b801df83dc", "committedDate": "2020-06-11T13:33:35Z", "message": "Merge branch 'TKT-792' of github.com:davemec/besu into TKT-792"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f706cdecd733f3e341947b7bc10736def8c1d6dc", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/f706cdecd733f3e341947b7bc10736def8c1d6dc", "committedDate": "2020-06-11T13:34:47Z", "message": "Fix for hive SpoofAmplification test\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8727564073ab340da723859dee347495b7844e94", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/8727564073ab340da723859dee347495b7844e94", "committedDate": "2020-06-23T21:16:06Z", "message": "Update to bond on PING and only add to PeerTable on PONG.\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a2b83632c543458268bd64afecef0aa2e915b36", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/4a2b83632c543458268bd64afecef0aa2e915b36", "committedDate": "2020-06-23T21:27:04Z", "message": "Merge branch 'master' of github.com:hyperledger/besu into TKT-792\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94e6cc13461c494b92ff66b57050028a26f9683e", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/94e6cc13461c494b92ff66b57050028a26f9683e", "committedDate": "2020-06-23T23:04:14Z", "message": "clean up\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c069c47c08f797212dce534e3047cad62faaecc", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/4c069c47c08f797212dce534e3047cad62faaecc", "committedDate": "2020-06-24T16:38:38Z", "message": "Merge branch 'master' of github.com:hyperledger/besu into TKT-792"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48752ed113ea5604d7c1d57f0f844c988527e0b1", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/48752ed113ea5604d7c1d57f0f844c988527e0b1", "committedDate": "2020-06-25T12:44:18Z", "message": "clean up\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d4f4ba1c98e5cc40f1c926939e063aba4e7c91f", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/0d4f4ba1c98e5cc40f1c926939e063aba4e7c91f", "committedDate": "2020-06-25T13:02:32Z", "message": "Merge branch 'master' into TKT-792"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NDgyNjYz", "url": "https://github.com/hyperledger/besu/pull/1146#pullrequestreview-437482663", "createdAt": "2020-06-25T13:16:55Z", "commit": {"oid": "0d4f4ba1c98e5cc40f1c926939e063aba4e7c91f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMzoxNjo1NVrOGo6NHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMzoxODowNlrOGo6QJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU0OTg1Mg==", "bodyText": "Nice catch", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r445549852", "createdAt": "2020-06-25T13:16:55Z", "author": {"login": "abdelhamidbakhta"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java", "diffHunk": "@@ -205,7 +207,7 @@ public void start() {\n         bootstrapNodes.stream()\n             .filter(peerPermissions::isAllowedInPeerTable)\n             .collect(Collectors.toList());\n-    initialDiscoveryPeers.stream().forEach(peerTable::tryAdd);\n+    initialDiscoveryPeers.forEach(peerTable::tryAdd);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d4f4ba1c98e5cc40f1c926939e063aba4e7c91f"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU1MDYzMQ==", "bodyText": "What about inlining instead of storing local variable", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r445550631", "createdAt": "2020-06-25T13:18:06Z", "author": {"login": "abdelhamidbakhta"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java", "diffHunk": "@@ -296,31 +298,41 @@ public void onMessage(final Packet packet, final DiscoveryPeer sender) {\n     // Load the peer from the table, or use the instance that comes in.\n     final Optional<DiscoveryPeer> maybeKnownPeer =\n         peerTable.get(sender).filter(known -> known.discoveryEndpointMatches(sender));\n-    final DiscoveryPeer peer = maybeKnownPeer.orElse(sender);\n+    DiscoveryPeer peer = maybeKnownPeer.orElse(sender);\n     final boolean peerKnown = maybeKnownPeer.isPresent();\n+    if (!peerKnown && bondingPeers.containsKey(sender.getId())) {\n+      peer = bondingPeers.get(sender.getId());\n+    }\n \n+    final DiscoveryPeer finalPeer = peer;\n     switch (packet.getType()) {\n       case PING:\n         if (peerPermissions.allowInboundBonding(peer)) {\n-          addToPeerTable(peer);\n+          long now = System.currentTimeMillis();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d4f4ba1c98e5cc40f1c926939e063aba4e7c91f"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NDg2MzM5", "url": "https://github.com/hyperledger/besu/pull/1146#pullrequestreview-437486339", "createdAt": "2020-06-25T13:21:14Z", "commit": {"oid": "0d4f4ba1c98e5cc40f1c926939e063aba4e7c91f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMzoyMToxNVrOGo6YBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMzoyMToxNVrOGo6YBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU1MjY0NQ==", "bodyText": "is it not necessary to use a ConcurrentHashMap here?", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r445552645", "createdAt": "2020-06-25T13:21:15Z", "author": {"login": "matkt"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java", "diffHunk": "@@ -168,6 +169,7 @@ private PeerDiscoveryController(\n     this.outboundMessageHandler = outboundMessageHandler;\n     this.peerBondedObservers = peerBondedObservers;\n     this.discoveryProtocolLogger = new DiscoveryProtocolLogger(metricsSystem);\n+    this.bondingPeers = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d4f4ba1c98e5cc40f1c926939e063aba4e7c91f"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0007795004533d1c9e755b30687ba5e363671fca", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/0007795004533d1c9e755b30687ba5e363671fca", "committedDate": "2020-06-25T13:33:23Z", "message": "Code clean up from PR\n\nSigned-off-by: David Mechler <david.mechler@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "772fe072f4b00043b15d2151cfb24f10edd66268", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/772fe072f4b00043b15d2151cfb24f10edd66268", "committedDate": "2020-06-25T20:39:27Z", "message": "Merge branch 'master' into TKT-792"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d0f1afabbd7bce3989c5c3596900e6a964e8e07", "author": {"user": {"login": "davemec", "name": "David Mechler"}}, "url": "https://github.com/hyperledger/besu/commit/5d0f1afabbd7bce3989c5c3596900e6a964e8e07", "committedDate": "2020-06-26T11:19:40Z", "message": "Merge branch 'master' into TKT-792"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MjIxMjAw", "url": "https://github.com/hyperledger/besu/pull/1146#pullrequestreview-439221200", "createdAt": "2020-06-29T14:48:47Z", "commit": {"oid": "5d0f1afabbd7bce3989c5c3596900e6a964e8e07"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNDo0ODo0N1rOGqUhIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNjowNTowNVrOGqX2YQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAyOTUzNw==", "bodyText": "Do we need this? Looks like sourceEndpoint.getTcpPort() will always be empty: \n  \n    \n      besu/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/VertxPeerDiscoveryAgent.java\n    \n    \n        Lines 219 to 220\n      in\n      b0115a2\n    \n    \n    \n    \n\n        \n          \n           final Endpoint endpoint = new Endpoint(host, port, OptionalInt.empty()); \n        \n\n        \n          \n           handleIncomingPacket(endpoint, event.result());", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r447029537", "createdAt": "2020-06-29T14:48:47Z", "author": {"login": "mbaxter"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryAgent.java", "diffHunk": "@@ -190,6 +191,10 @@ protected void handleIncomingPacket(final Endpoint sourceEndpoint, final Packet\n       }\n     }\n \n+    if (PacketType.PONG.equals(packet.getType())) {\n+      tcpPort = sourceEndpoint.getTcpPort();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0f1afabbd7bce3989c5c3596900e6a964e8e07"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAzNDAwOA==", "bodyText": "We should only remove the peer from this collection if the interaction matches, right?\n        matchInteraction(packet)\n            .ifPresent(\n                interaction -> {\n                  bondingPeers.remove(peer.getId());\n                  addToPeerTable(peer);\n                  recursivePeerRefreshState.onBondingComplete(peer);\n                  addToPeerTable(finalPeer);\n                  recursivePeerRefreshState.onBondingComplete(finalPeer);\n                });", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r447034008", "createdAt": "2020-06-29T14:54:34Z", "author": {"login": "mbaxter"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java", "diffHunk": "@@ -296,31 +298,40 @@ public void onMessage(final Packet packet, final DiscoveryPeer sender) {\n     // Load the peer from the table, or use the instance that comes in.\n     final Optional<DiscoveryPeer> maybeKnownPeer =\n         peerTable.get(sender).filter(known -> known.discoveryEndpointMatches(sender));\n-    final DiscoveryPeer peer = maybeKnownPeer.orElse(sender);\n+    DiscoveryPeer peer = maybeKnownPeer.orElse(sender);\n     final boolean peerKnown = maybeKnownPeer.isPresent();\n+    if (!peerKnown && bondingPeers.containsKey(sender.getId())) {\n+      peer = bondingPeers.get(sender.getId());\n+    }\n \n+    final DiscoveryPeer finalPeer = peer;\n     switch (packet.getType()) {\n       case PING:\n         if (peerPermissions.allowInboundBonding(peer)) {\n-          addToPeerTable(peer);\n+          peer.setLastSeen(System.currentTimeMillis());\n           final PingPacketData ping = packet.getPacketData(PingPacketData.class).get();\n+          if (!PeerDiscoveryStatus.BONDED.equals(peer.getStatus())\n+              && !bondingPeers.containsKey(peer.getId())) {\n+            bond(peer);\n+          }\n           respondToPing(ping, packet.getHash(), peer);\n         }\n         break;\n       case PONG:\n+        bondingPeers.remove(peer.getId());\n         matchInteraction(packet)\n             .ifPresent(\n                 interaction -> {\n-                  addToPeerTable(peer);\n-                  recursivePeerRefreshState.onBondingComplete(peer);\n+                  addToPeerTable(finalPeer);\n+                  recursivePeerRefreshState.onBondingComplete(finalPeer);\n                 });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0f1afabbd7bce3989c5c3596900e6a964e8e07"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAzNjkxMw==", "bodyText": "We already have a PeerStatus.BONDING state - why not just add bonding peers to our table with this status instead of creating a new collection?", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r447036913", "createdAt": "2020-06-29T14:58:34Z", "author": {"login": "mbaxter"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java", "diffHunk": "@@ -168,6 +169,7 @@ private PeerDiscoveryController(\n     this.outboundMessageHandler = outboundMessageHandler;\n     this.peerBondedObservers = peerBondedObservers;\n     this.discoveryProtocolLogger = new DiscoveryProtocolLogger(metricsSystem);\n+    this.bondingPeers = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0f1afabbd7bce3989c5c3596900e6a964e8e07"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA2MjI3NQ==", "bodyText": "Why are there 3 packets here and not 2?  Seems like we should only have 1 incoming PING, and 1 incoming PONG.", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r447062275", "createdAt": "2020-06-29T15:33:35Z", "author": {"login": "mbaxter"}, "path": "ethereum/p2p/src/test/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryAgentTest.java", "diffHunk": "@@ -209,25 +217,33 @@ public void bonding_allowIncomingBonding() {\n     final PeerPermissions peerPermissions = mock(PeerPermissions.class);\n     final MockPeerDiscoveryAgent agent =\n         helper.startDiscoveryAgent(Collections.emptyList(), peerPermissions);\n+    assertThat(agent.getAdvertisedPeer().isPresent()).isTrue();\n     final Peer localNode = agent.getAdvertisedPeer().get();\n \n     // Setup peer and permissions\n     final MockPeerDiscoveryAgent otherNode = helper.startDiscoveryAgent();\n+    assertThat(otherNode.getAdvertisedPeer().isPresent()).isTrue();\n     final Peer remotePeer = otherNode.getAdvertisedPeer().get();\n     when(peerPermissions.isPermitted(eq(localNode), any(), any())).thenReturn(false);\n     when(peerPermissions.isPermitted(\n             eq(localNode), eq(remotePeer), eq(Action.DISCOVERY_ACCEPT_INBOUND_BONDING)))\n         .thenReturn(true);\n+    when(peerPermissions.isPermitted(\n+            any(), eq(remotePeer), eq(Action.DISCOVERY_ALLOW_IN_PEER_TABLE)))\n+        .thenReturn(true);\n \n     // Bond\n     bondViaIncomingPing(agent, otherNode);\n \n-    // Check that peer received a return pong\n     List<IncomingPacket> remoteIncomingPackets = otherNode.getIncomingPackets();\n-    assertThat(remoteIncomingPackets).hasSize(1);\n+    assertThat(remoteIncomingPackets).hasSize(3);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0f1afabbd7bce3989c5c3596900e6a964e8e07"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA3MTE3NA==", "bodyText": "We shouldn't need to manually send a PONG here -remoteAgent is using agent as a bootnode, so they should automatically bond.", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r447071174", "createdAt": "2020-06-29T15:45:59Z", "author": {"login": "mbaxter"}, "path": "ethereum/p2p/src/test/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryAgentTest.java", "diffHunk": "@@ -349,11 +370,16 @@ public void simulatePeerRestartingOnDifferentEndpoint(\n \n     agent.start(999);\n     remoteAgent.start(888);\n+    assertThat(remoteAgent.getAdvertisedPeer().isPresent()).isTrue();\n     final DiscoveryPeer remotePeer = remoteAgent.getAdvertisedPeer().get();\n \n+    // Send PONG so that peers will be bonded\n+    final Packet pongPacket = helper.createPongPacket(agent, Hash.EMPTY);\n+    helper.sendMessageBetweenAgents(remoteAgent, agent, pongPacket);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0f1afabbd7bce3989c5c3596900e6a964e8e07"}, "originalPosition": 153}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA3Njc4OQ==", "bodyText": "There should only be 1 PONG here", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r447076789", "createdAt": "2020-06-29T15:54:22Z", "author": {"login": "mbaxter"}, "path": "ethereum/p2p/src/test/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryBondingTest.java", "diffHunk": "@@ -48,10 +48,14 @@ public void pongSentUponPing() {\n         otherAgent.getIncomingPackets().stream()\n             .filter(p -> p.packet.getType().equals(PacketType.PONG))\n             .collect(Collectors.toList());\n-    assertThat(otherAgentIncomingPongs.size()).isEqualTo(1);\n+    assertThat(otherAgentIncomingPongs.size()).isEqualTo(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0f1afabbd7bce3989c5c3596900e6a964e8e07"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA3NzUxMQ==", "bodyText": "Again not sure why we have 2 PONG's here", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r447077511", "createdAt": "2020-06-29T15:55:21Z", "author": {"login": "mbaxter"}, "path": "ethereum/p2p/src/test/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryBondingTest.java", "diffHunk": "@@ -86,10 +90,11 @@ public void neighborsPacketNotSentUnlessBonded() throws InterruptedException {\n         otherNode.getIncomingPackets().stream()\n             .filter(p -> p.packet.getType().equals(PacketType.PONG))\n             .collect(Collectors.toList());\n-    assertThat(incomingPongs.size()).isEqualTo(1);\n+    assertThat(incomingPongs.size()).isEqualTo(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0f1afabbd7bce3989c5c3596900e6a964e8e07"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA4NDEyOQ==", "bodyText": "(nit) We should make these method names match:\n  private void mockPingPacketCreation(final DiscoveryPeer peer, final Packet mockPacket) {", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r447084129", "createdAt": "2020-06-29T16:05:05Z", "author": {"login": "mbaxter"}, "path": "ethereum/p2p/src/test/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryControllerTest.java", "diffHunk": "@@ -153,24 +153,25 @@ public void bootstrapPeersRetriesSent() {\n   }\n \n   private void mockPingPacketCreation(final Packet mockPacket) {\n-    mockPacketCreation(PacketType.PING, Optional.empty(), mockPacket);\n+    mockPacketCreation(Optional.empty(), mockPacket);\n   }\n \n-  private void mockPacketCreation(\n-      final PacketType type, final DiscoveryPeer peer, final Packet mockPacket) {\n-    mockPacketCreation(type, Optional.of(peer), mockPacket);\n+  private void mockPacketCreation(final DiscoveryPeer peer, final Packet mockPacket) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0f1afabbd7bce3989c5c3596900e6a964e8e07"}, "originalPosition": 11}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1502, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}