{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwMDcyNjMz", "number": 666, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMDoxMzoxOVrODvfitA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMDo1ODozM1rODvy3SQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTI2NDUyOnYy", "diffSide": "RIGHT", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/connections/netty/HandshakeHandlerOutbound.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMDoxMzoxOVrOGB8oyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMTozNToxOFrOGCb9Tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5NTI0Mg==", "bodyText": "Does it make sense to move the second parameter SECP256K1.PublicKey.create(peer.getId()) as potentially a static method in NodeKey as well?", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r404695242", "createdAt": "2020-04-07T10:13:19Z", "author": {"login": "usmansaleem"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/connections/netty/HandshakeHandlerOutbound.java", "diffHunk": "@@ -53,7 +54,8 @@ public HandshakeHandlerOutbound(\n         connectionFuture,\n         connectionEventDispatcher,\n         metricsSystem);\n-    handshaker.prepareInitiator(kp, SECP256K1.PublicKey.create(peer.getId()));\n+    handshaker.prepareInitiator(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwODM5OA==", "bodyText": "Thinking not - NodeKey is all about protecting this node's identity/private key - the Peer in this question is someone remote.\nI.e. only operations for our node key need to go via the NodeKey interface", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r405208398", "createdAt": "2020-04-08T01:35:18Z", "author": {"login": "rain-on"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/connections/netty/HandshakeHandlerOutbound.java", "diffHunk": "@@ -53,7 +54,8 @@ public HandshakeHandlerOutbound(\n         connectionFuture,\n         connectionEventDispatcher,\n         metricsSystem);\n-    handshaker.prepareInitiator(kp, SECP256K1.PublicKey.create(peer.getId()));\n+    handshaker.prepareInitiator(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5NTI0Mg=="}, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTI3MzE4OnYy", "diffSide": "RIGHT", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/handshake/ecies/ECIESHandshaker.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMDoxNTo0MVrOGB8uNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMTo0MDo0OFrOGCcCuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5NjYyOQ==", "bodyText": "what about ephKeyPair?", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r404696629", "createdAt": "2020-04-07T10:15:41Z", "author": {"login": "usmansaleem"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/handshake/ecies/ECIESHandshaker.java", "diffHunk": "@@ -101,14 +103,14 @@ public void prepareInitiator(final SECP256K1.KeyPair ourKeypair, final PublicKey\n   }\n \n   @Override\n-  public void prepareResponder(final SECP256K1.KeyPair ourKeypair) {\n+  public void prepareResponder(final NodeKey nodeKey) {\n     checkState(\n         status.compareAndSet(\n             Handshaker.HandshakeStatus.UNINITIALIZED, Handshaker.HandshakeStatus.IN_PROGRESS),\n         \"handshake was already prepared\");\n \n     this.initiator = false;\n-    this.identityKeyPair = ourKeypair;\n+    this.nodeKey = nodeKey;\n     this.ephKeyPair = SECP256K1.KeyPair.generate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwOTc4Nw==", "bodyText": "This is the ephemeral key used for inter-node communications and is rolling - so no need to protect it alongside our nodekey", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r405209787", "createdAt": "2020-04-08T01:40:48Z", "author": {"login": "rain-on"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/handshake/ecies/ECIESHandshaker.java", "diffHunk": "@@ -101,14 +103,14 @@ public void prepareInitiator(final SECP256K1.KeyPair ourKeypair, final PublicKey\n   }\n \n   @Override\n-  public void prepareResponder(final SECP256K1.KeyPair ourKeypair) {\n+  public void prepareResponder(final NodeKey nodeKey) {\n     checkState(\n         status.compareAndSet(\n             Handshaker.HandshakeStatus.UNINITIALIZED, Handshaker.HandshakeStatus.IN_PROGRESS),\n         \"handshake was already prepared\");\n \n     this.initiator = false;\n-    this.identityKeyPair = ourKeypair;\n+    this.nodeKey = nodeKey;\n     this.ephKeyPair = SECP256K1.KeyPair.generate();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5NjYyOQ=="}, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTI3OTAxOnYy", "diffSide": "RIGHT", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/handshake/ecies/EncryptedMessage.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMDoxNzoxNFrOGB8xwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMTo0MzoyMlrOGCcFEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5NzUzOA==", "bodyText": "just wondering, should we name argument as 'ourNodeKey' ?", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r404697538", "createdAt": "2020-04-07T10:17:14Z", "author": {"login": "usmansaleem"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/handshake/ecies/EncryptedMessage.java", "diffHunk": "@@ -57,19 +58,19 @@ public static Bytes decryptMsg(final Bytes msgBytes, final SECP256K1.PrivateKey\n \n     // Perform the decryption.\n     final ECIESEncryptionEngine decryptor =\n-        ECIESEncryptionEngine.forDecryption(ourKey, ephPubKey, iv);\n+        ECIESEncryptionEngine.forDecryption(nodeKey, ephPubKey, iv);\n     return decryptor.decrypt(encrypted);\n   }\n \n   /**\n    * Decrypts the ciphertext using our private key.\n    *\n    * @param msgBytes The ciphertext.\n-   * @param ourKey Our private key.\n+   * @param nodeKey Abstraction of this nodes private key & associated crypto operations\n    * @return The plaintext.\n    * @throws InvalidCipherTextException Thrown if decryption failed.\n    */\n-  public static Bytes decryptMsgEIP8(final Bytes msgBytes, final SECP256K1.PrivateKey ourKey)\n+  public static Bytes decryptMsgEIP8(final Bytes msgBytes, final NodeKey nodeKey)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIxMDM4NQ==", "bodyText": "I'd prefer not to. For 2 reasons:\nThinking \"nodeKey\" is explicit enough to indicate ownership (on some levels).\nSecondly, I'd hate for this class to imply the owner of the key which is doing the decryption - i.e. it simply needs a key to do the decryption - ownership of the key makes no difference as to the operation being conducted.", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r405210385", "createdAt": "2020-04-08T01:43:22Z", "author": {"login": "rain-on"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/handshake/ecies/EncryptedMessage.java", "diffHunk": "@@ -57,19 +58,19 @@ public static Bytes decryptMsg(final Bytes msgBytes, final SECP256K1.PrivateKey\n \n     // Perform the decryption.\n     final ECIESEncryptionEngine decryptor =\n-        ECIESEncryptionEngine.forDecryption(ourKey, ephPubKey, iv);\n+        ECIESEncryptionEngine.forDecryption(nodeKey, ephPubKey, iv);\n     return decryptor.decrypt(encrypted);\n   }\n \n   /**\n    * Decrypts the ciphertext using our private key.\n    *\n    * @param msgBytes The ciphertext.\n-   * @param ourKey Our private key.\n+   * @param nodeKey Abstraction of this nodes private key & associated crypto operations\n    * @return The plaintext.\n    * @throws InvalidCipherTextException Thrown if decryption failed.\n    */\n-  public static Bytes decryptMsgEIP8(final Bytes msgBytes, final SECP256K1.PrivateKey ourKey)\n+  public static Bytes decryptMsgEIP8(final Bytes msgBytes, final NodeKey nodeKey)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY5NzUzOA=="}, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDI4NTA3OnYy", "diffSide": "RIGHT", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/handshake/Handshaker.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMzo0MjozM1rOGCaBaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMTozNzoxM1rOGCb_Tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3NjY4MA==", "bodyText": "final isn't needed on the interface fields", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r405176680", "createdAt": "2020-04-07T23:42:33Z", "author": {"login": "jframe"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/handshake/Handshaker.java", "diffHunk": "@@ -76,11 +77,11 @@\n    * <p>This method must throw an {@link IllegalStateException} exception if the handshake had\n    * already been prepared before, no matter if under the initiator or the responder role.\n    *\n-   * @param ourKeypair The keypair for our node identity.\n+   * @param nodeKey An object which represents our identity\n    * @param theirPubKey The public key of the node we're handshaking with.\n    * @throws IllegalStateException Indicates that preparation had already occured.\n    */\n-  void prepareInitiator(SECP256K1.KeyPair ourKeypair, SECP256K1.PublicKey theirPubKey);\n+  void prepareInitiator(final NodeKey nodeKey, SECP256K1.PublicKey theirPubKey);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwODkxMA==", "bodyText": "done", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r405208910", "createdAt": "2020-04-08T01:37:13Z", "author": {"login": "rain-on"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/handshake/Handshaker.java", "diffHunk": "@@ -76,11 +77,11 @@\n    * <p>This method must throw an {@link IllegalStateException} exception if the handshake had\n    * already been prepared before, no matter if under the initiator or the responder role.\n    *\n-   * @param ourKeypair The keypair for our node identity.\n+   * @param nodeKey An object which represents our identity\n    * @param theirPubKey The public key of the node we're handshaking with.\n    * @throws IllegalStateException Indicates that preparation had already occured.\n    */\n-  void prepareInitiator(SECP256K1.KeyPair ourKeypair, SECP256K1.PublicKey theirPubKey);\n+  void prepareInitiator(final NodeKey nodeKey, SECP256K1.PublicKey theirPubKey);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3NjY4MA=="}, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDI4NzI0OnYy", "diffSide": "RIGHT", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/handshake/Handshaker.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMzo0MzoyN1rOGCaCpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMTo0NToyNFrOGCcHUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3Njk5Ng==", "bodyText": "final isn't needed on the interface fields", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r405176996", "createdAt": "2020-04-07T23:43:27Z", "author": {"login": "jframe"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/handshake/Handshaker.java", "diffHunk": "@@ -89,10 +90,10 @@\n    * <p>This method must throw an {@link IllegalStateException} exception if the handshake had\n    * already been prepared before, whether with the initiator or the responder role.\n    *\n-   * @param ourKeypair The keypair for our node identity.\n+   * @param nodeKey An object which represents our identity\n    * @throws IllegalStateException Indicates that preparation had already occured.\n    */\n-  void prepareResponder(SECP256K1.KeyPair ourKeypair);\n+  void prepareResponder(final NodeKey nodeKey);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIxMDk2MQ==", "bodyText": "done", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r405210961", "createdAt": "2020-04-08T01:45:24Z", "author": {"login": "rain-on"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/handshake/Handshaker.java", "diffHunk": "@@ -89,10 +90,10 @@\n    * <p>This method must throw an {@link IllegalStateException} exception if the handshake had\n    * already been prepared before, whether with the initiator or the responder role.\n    *\n-   * @param ourKeypair The keypair for our node identity.\n+   * @param nodeKey An object which represents our identity\n    * @throws IllegalStateException Indicates that preparation had already occured.\n    */\n-  void prepareResponder(SECP256K1.KeyPair ourKeypair);\n+  void prepareResponder(final NodeKey nodeKey);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3Njk5Ng=="}, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDI5MDU0OnYy", "diffSide": "RIGHT", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/handshake/ecies/InitiatorHandshakeMessageV1.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMzo0NTowMlrOGCaElQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMTo0NDowOFrOGCcGBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3NzQ5Mw==", "bodyText": "Can you also update the javadoc since this is no longer a keypair", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r405177493", "createdAt": "2020-04-07T23:45:02Z", "author": {"login": "jframe"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/handshake/ecies/InitiatorHandshakeMessageV1.java", "diffHunk": "@@ -95,11 +95,10 @@ public static InitiatorHandshakeMessageV1 create(\n    * Decodes this message.\n    *\n    * @param bytes The raw bytes.\n-   * @param keyPair Our keypair to calculat ECDH key agreements.\n+   * @param nodeKey Our keypair to calculat ECDH key agreements.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIxMDYzMA==", "bodyText": "done", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r405210630", "createdAt": "2020-04-08T01:44:08Z", "author": {"login": "rain-on"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/handshake/ecies/InitiatorHandshakeMessageV1.java", "diffHunk": "@@ -95,11 +95,10 @@ public static InitiatorHandshakeMessageV1 create(\n    * Decodes this message.\n    *\n    * @param bytes The raw bytes.\n-   * @param keyPair Our keypair to calculat ECDH key agreements.\n+   * @param nodeKey Our keypair to calculat ECDH key agreements.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3NzQ5Mw=="}, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDI5NTg4OnYy", "diffSide": "RIGHT", "path": "crypto/src/main/java/org/hyperledger/besu/crypto/NodeKey.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMzo0Nzo0MlrOGCaH0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMTo0NDozOVrOGCcGfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3ODMyMw==", "bodyText": "Do we want to be more explicit here and call out that is the ECDH key agreement? I thinking we should.", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r405178323", "createdAt": "2020-04-07T23:47:42Z", "author": {"login": "jframe"}, "path": "crypto/src/main/java/org/hyperledger/besu/crypto/NodeKey.java", "diffHunk": "@@ -17,11 +17,16 @@\n import org.hyperledger.besu.crypto.SECP256K1.PublicKey;\n import org.hyperledger.besu.crypto.SECP256K1.Signature;\n \n+import org.apache.tuweni.bytes.Bytes;\n import org.apache.tuweni.bytes.Bytes32;\n \n public interface NodeKey {\n \n   Signature sign(Bytes32 dataHash);\n \n   PublicKey getPublicKey();\n+\n+  Bytes32 calculateKeyAgreement(final PublicKey partyKey);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIxMDc0OQ==", "bodyText": "done", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r405210749", "createdAt": "2020-04-08T01:44:39Z", "author": {"login": "rain-on"}, "path": "crypto/src/main/java/org/hyperledger/besu/crypto/NodeKey.java", "diffHunk": "@@ -17,11 +17,16 @@\n import org.hyperledger.besu.crypto.SECP256K1.PublicKey;\n import org.hyperledger.besu.crypto.SECP256K1.Signature;\n \n+import org.apache.tuweni.bytes.Bytes;\n import org.apache.tuweni.bytes.Bytes32;\n \n public interface NodeKey {\n \n   Signature sign(Bytes32 dataHash);\n \n   PublicKey getPublicKey();\n+\n+  Bytes32 calculateKeyAgreement(final PublicKey partyKey);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3ODMyMw=="}, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDMwMDkyOnYy", "diffSide": "RIGHT", "path": "crypto/src/main/java/org/hyperledger/besu/crypto/NodeKey.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMzo0OTo1MVrOGCaKlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMTo0NDo1MFrOGCcGug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3OTAyOA==", "bodyText": "Should this just be publicKey instead of partyKey? I don't know enough ECDH key agreements to say it should be, but elsewhere it seems to be just referred to as publicKey", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r405179028", "createdAt": "2020-04-07T23:49:51Z", "author": {"login": "jframe"}, "path": "crypto/src/main/java/org/hyperledger/besu/crypto/NodeKey.java", "diffHunk": "@@ -17,11 +17,16 @@\n import org.hyperledger.besu.crypto.SECP256K1.PublicKey;\n import org.hyperledger.besu.crypto.SECP256K1.Signature;\n \n+import org.apache.tuweni.bytes.Bytes;\n import org.apache.tuweni.bytes.Bytes32;\n \n public interface NodeKey {\n \n   Signature sign(Bytes32 dataHash);\n \n   PublicKey getPublicKey();\n+\n+  Bytes32 calculateKeyAgreement(final PublicKey partyKey);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIxMDgxMA==", "bodyText": "done", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r405210810", "createdAt": "2020-04-08T01:44:50Z", "author": {"login": "rain-on"}, "path": "crypto/src/main/java/org/hyperledger/besu/crypto/NodeKey.java", "diffHunk": "@@ -17,11 +17,16 @@\n import org.hyperledger.besu.crypto.SECP256K1.PublicKey;\n import org.hyperledger.besu.crypto.SECP256K1.Signature;\n \n+import org.apache.tuweni.bytes.Bytes;\n import org.apache.tuweni.bytes.Bytes32;\n \n public interface NodeKey {\n \n   Signature sign(Bytes32 dataHash);\n \n   PublicKey getPublicKey();\n+\n+  Bytes32 calculateKeyAgreement(final PublicKey partyKey);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3OTAyOA=="}, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDMwMjgwOnYy", "diffSide": "RIGHT", "path": "crypto/src/main/java/org/hyperledger/besu/crypto/BouncyCastleNodeKey.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMzo1MDo1MlrOGCaLxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMTo0NDoxOVrOGCcGJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3OTMzMg==", "bodyText": "Thinking this should be calculateECIESKeyAgreement", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r405179332", "createdAt": "2020-04-07T23:50:52Z", "author": {"login": "jframe"}, "path": "crypto/src/main/java/org/hyperledger/besu/crypto/BouncyCastleNodeKey.java", "diffHunk": "@@ -41,4 +51,23 @@ public Signature sign(final Bytes32 dataHash) {\n   public PublicKey getPublicKey() {\n     return nodeKeys.getPublicKey();\n   }\n+\n+  @Override\n+  public Bytes32 calculateKeyAgreement(final PublicKey partyKey) {\n+    return SECP256K1.calculateKeyAgreement(nodeKeys.getPrivateKey(), partyKey);\n+  }\n+\n+  @Override\n+  public Bytes calculateECIESAgreement(final SECP256K1.PublicKey ephPubKey) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIxMDY2Mg==", "bodyText": "done", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r405210662", "createdAt": "2020-04-08T01:44:19Z", "author": {"login": "rain-on"}, "path": "crypto/src/main/java/org/hyperledger/besu/crypto/BouncyCastleNodeKey.java", "diffHunk": "@@ -41,4 +51,23 @@ public Signature sign(final Bytes32 dataHash) {\n   public PublicKey getPublicKey() {\n     return nodeKeys.getPublicKey();\n   }\n+\n+  @Override\n+  public Bytes32 calculateKeyAgreement(final PublicKey partyKey) {\n+    return SECP256K1.calculateKeyAgreement(nodeKeys.getPrivateKey(), partyKey);\n+  }\n+\n+  @Override\n+  public Bytes calculateECIESAgreement(final SECP256K1.PublicKey ephPubKey) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE3OTMzMg=="}, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDMwODA3OnYy", "diffSide": "RIGHT", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/handshake/ecies/ECIESEncryptionEngine.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMzo1Mzo1MlrOGCaPJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMTozOTozMlrOGCcBkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MDE5OQ==", "bodyText": "This can be lower z", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r405180199", "createdAt": "2020-04-07T23:53:52Z", "author": {"login": "jframe"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/handshake/ecies/ECIESEncryptionEngine.java", "diffHunk": "@@ -82,41 +75,30 @@\n   private final byte[] iv;\n \n   private ECIESEncryptionEngine(\n-      final CipherParameters pubParam,\n-      final CipherParameters privParam,\n-      final SECP256K1.PublicKey ephPubKey,\n-      final byte[] iv) {\n+      final Bytes Z, final SECP256K1.PublicKey ephPubKey, final byte[] iv) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwOTQ4OQ==", "bodyText": "changed - but I wonder what it REALLY is .... changed to agreedSecret", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r405209489", "createdAt": "2020-04-08T01:39:32Z", "author": {"login": "rain-on"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/handshake/ecies/ECIESEncryptionEngine.java", "diffHunk": "@@ -82,41 +75,30 @@\n   private final byte[] iv;\n \n   private ECIESEncryptionEngine(\n-      final CipherParameters pubParam,\n-      final CipherParameters privParam,\n-      final SECP256K1.PublicKey ephPubKey,\n-      final byte[] iv) {\n+      final Bytes Z, final SECP256K1.PublicKey ephPubKey, final byte[] iv) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4MDE5OQ=="}, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDQzMDE3OnYy", "diffSide": "RIGHT", "path": "crypto/src/main/java/org/hyperledger/besu/crypto/BouncyCastleNodeKey.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMDo1ODozM1rOGCbXXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMTozNjoyMFrOGCb-XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5ODY4Ng==", "bodyText": "Would be nicer if both of the key agreement functions were in SECP256k1 class", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r405198686", "createdAt": "2020-04-08T00:58:33Z", "author": {"login": "jframe"}, "path": "crypto/src/main/java/org/hyperledger/besu/crypto/BouncyCastleNodeKey.java", "diffHunk": "@@ -41,4 +51,23 @@ public Signature sign(final Bytes32 dataHash) {\n   public PublicKey getPublicKey() {\n     return nodeKeys.getPublicKey();\n   }\n+\n+  @Override\n+  public Bytes32 calculateKeyAgreement(final PublicKey partyKey) {\n+    return SECP256K1.calculateKeyAgreement(nodeKeys.getPrivateKey(), partyKey);\n+  }\n+\n+  @Override\n+  public Bytes calculateECIESAgreement(final SECP256K1.PublicKey ephPubKey) {\n+    final ECDomainParameters dp = SECP256K1.CURVE;\n+\n+    final CipherParameters pubParam = new ECPublicKeyParameters(ephPubKey.asEcPoint(), dp);\n+    final CipherParameters privParam =\n+        new ECPrivateKeyParameters(nodeKeys.getPrivateKey().getD(), dp);\n+\n+    final BasicAgreement agree = new ECDHBasicAgreement();\n+    agree.init(privParam);\n+    final BigInteger z = agree.calculateAgreement(pubParam);\n+    return Bytes.wrap(BigIntegers.asUnsignedByteArray(agree.getFieldSize(), z));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTIwODY2OQ==", "bodyText": "done", "url": "https://github.com/hyperledger/besu/pull/666#discussion_r405208669", "createdAt": "2020-04-08T01:36:20Z", "author": {"login": "rain-on"}, "path": "crypto/src/main/java/org/hyperledger/besu/crypto/BouncyCastleNodeKey.java", "diffHunk": "@@ -41,4 +51,23 @@ public Signature sign(final Bytes32 dataHash) {\n   public PublicKey getPublicKey() {\n     return nodeKeys.getPublicKey();\n   }\n+\n+  @Override\n+  public Bytes32 calculateKeyAgreement(final PublicKey partyKey) {\n+    return SECP256K1.calculateKeyAgreement(nodeKeys.getPrivateKey(), partyKey);\n+  }\n+\n+  @Override\n+  public Bytes calculateECIESAgreement(final SECP256K1.PublicKey ephPubKey) {\n+    final ECDomainParameters dp = SECP256K1.CURVE;\n+\n+    final CipherParameters pubParam = new ECPublicKeyParameters(ephPubKey.asEcPoint(), dp);\n+    final CipherParameters privParam =\n+        new ECPrivateKeyParameters(nodeKeys.getPrivateKey().getD(), dp);\n+\n+    final BasicAgreement agree = new ECDHBasicAgreement();\n+    agree.init(privParam);\n+    final BigInteger z = agree.calculateAgreement(pubParam);\n+    return Bytes.wrap(BigIntegers.asUnsignedByteArray(agree.getFieldSize(), z));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE5ODY4Ng=="}, "originalCommit": {"oid": "d3a8736cc85aec01165b6a6cac54caec7abb8d29"}, "originalPosition": 39}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1032, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}