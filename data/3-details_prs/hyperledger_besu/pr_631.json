{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3MDA5OTI0", "number": 631, "title": "eth/sync: augment log with peer count information", "bodyText": "PR description\nI'm running a lot of Besu nodes and it bothered me that there is only a little information about networking available in the default INFO log level. This pull request tries to improve the logging a bit.\n\naugment LOG.info() with peerCount wherever sensible in eth/sync/*\nshortened block hashes to decrease the required terminal width, e.g., 0x3b64..5bcb\nfixed some minor wording issues\n\n\n\n\nSubmitting this as draft PR. I'm not trying to blow up complexity but passing ethContext to the import steps is breaking some tests. I tried to investigate but I couldn't find an easy way to provide an ethContext in the block import test cases. I'm not very familiar with the code-base yet. Any pointers appreciated. \ud83d\ude4f\nFixed Issue(s)\nN/A", "createdAt": "2020-04-01T13:51:42Z", "url": "https://github.com/hyperledger/besu/pull/631", "merged": true, "mergeCommit": {"oid": "480f0a54be1ec44ac7316e59f4e743d7d88860ec"}, "closed": true, "closedAt": "2020-04-08T13:47:29Z", "author": {"login": "q9f"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTX37ggH2gAyMzk3MDA5OTI0OmVhNWE0YmRmZGUyZThlZGYxNjU0NGU4YjQ2NmUzYmUwMWJjN2FlMjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVmAbSgH2gAyMzk3MDA5OTI0OmZmZDgwOTY1MDc4Zjk1MmY2NzI1OWJlMDExZmY4ZTNkZDljZmQ0OTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ea5a4bdfde2e8edf16544e8b466e3be01bc7ae21", "author": {"user": {"login": "q9f", "name": "Afr Schoe"}}, "url": "https://github.com/hyperledger/besu/commit/ea5a4bdfde2e8edf16544e8b466e3be01bc7ae21", "committedDate": "2020-04-01T13:39:33Z", "message": "ethereum/fullsync: augment log with peer count information\n\nSigned-off-by: q9f <58883403+q9f@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee5b28779cffb7acaaa79bcaa6e54ab131145675", "author": {"user": {"login": "q9f", "name": "Afr Schoe"}}, "url": "https://github.com/hyperledger/besu/commit/ee5b28779cffb7acaaa79bcaa6e54ab131145675", "committedDate": "2020-04-01T13:50:21Z", "message": "ethereum/fastsync: augment log with peer count information\n\nSigned-off-by: q9f <58883403+q9f@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bd50239f0f6e4a479c2d7be3804122f736bf9ce", "author": {"user": {"login": "q9f", "name": "Afr Schoe"}}, "url": "https://github.com/hyperledger/besu/commit/0bd50239f0f6e4a479c2d7be3804122f736bf9ce", "committedDate": "2020-04-01T13:51:34Z", "message": "ethereum/manager: augment log with peer count information\n\nSigned-off-by: q9f <58883403+q9f@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1ODgyMTM3", "url": "https://github.com/hyperledger/besu/pull/631#pullrequestreview-385882137", "createdAt": "2020-04-01T19:24:36Z", "commit": {"oid": "0bd50239f0f6e4a479c2d7be3804122f736bf9ce"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxOToyNDozN1rOF_PQWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxOToyNjo1NFrOF_PVVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg1NDU1Mg==", "bodyText": "My concern with short hashes is then we cannot go to etherscan from the log.  I do this fairly frequently when analyzing short lived forks.\nPerhaps put the peers not at the end and making the other numbers fixed width?", "url": "https://github.com/hyperledger/besu/pull/631#discussion_r401854552", "createdAt": "2020-04-01T19:24:37Z", "author": {"login": "shemnon"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/BlockPropagationManager.java", "diffHunk": "@@ -341,16 +341,23 @@ private void broadcastBlock(final Block block, final BlockHeader parent) {\n                     block.getHash());\n               } else {\n                 final double timeInS = importTask.getTaskTimeInSec();\n+                final String blockHash = block.getHash().toHexString();\n+                final String shortHash =\n+                    String.format(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bd50239f0f6e4a479c2d7be3804122f736bf9ce"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg1NTgzMA==", "bodyText": "short hash here is fine.", "url": "https://github.com/hyperledger/besu/pull/631#discussion_r401855830", "createdAt": "2020-04-01T19:26:54Z", "author": {"login": "shemnon"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fullsync/FullImportBlockStep.java", "diffHunk": "@@ -30,23 +31,37 @@\n   private static final Logger LOG = LogManager.getLogger();\n   private final ProtocolSchedule<C> protocolSchedule;\n   private final ProtocolContext<C> protocolContext;\n+  private final EthContext ethContext;\n \n   public FullImportBlockStep(\n-      final ProtocolSchedule<C> protocolSchedule, final ProtocolContext<C> protocolContext) {\n+      final ProtocolSchedule<C> protocolSchedule,\n+      final ProtocolContext<C> protocolContext,\n+      final EthContext ethContext) {\n     this.protocolSchedule = protocolSchedule;\n     this.protocolContext = protocolContext;\n+    this.ethContext = ethContext;\n   }\n \n   @Override\n   public void accept(final Block block) {\n     final long blockNumber = block.getHeader().getNumber();\n+    final String blockHash = block.getHash().toHexString();\n+    final String shortHash =\n+        String.format(\n+            \"%s..%s\",\n+            blockHash.substring(0, 6),\n+            blockHash.substring(blockHash.length() - 4, blockHash.length()));\n     final BlockImporter<C> importer =\n         protocolSchedule.getByBlockNumber(blockNumber).getBlockImporter();\n     if (!importer.importBlock(protocolContext, block, HeaderValidationMode.SKIP_DETACHED)) {\n       throw new InvalidBlockException(\"Failed to import block\", blockNumber, block.getHash());\n     }\n     if (blockNumber % 200 == 0) {\n-      LOG.info(\"Import reached block {}\", blockNumber);\n+      LOG.info(\n+          \"Import reached block {} ({}), Peers: {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bd50239f0f6e4a479c2d7be3804122f736bf9ce"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd51c40c538b3bea06f48ccca1395ca259f71635", "author": {"user": {"login": "q9f", "name": "Afr Schoe"}}, "url": "https://github.com/hyperledger/besu/commit/dd51c40c538b3bea06f48ccca1395ca259f71635", "committedDate": "2020-04-02T13:45:23Z", "message": "ethereum/manager: print full block hash in debug log information\n\nSigned-off-by: q9f <58883403+q9f@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3315af76a124bde6044cb875644906b859e88e0b", "author": {"user": {"login": "q9f", "name": "Afr Schoe"}}, "url": "https://github.com/hyperledger/besu/commit/3315af76a124bde6044cb875644906b859e88e0b", "committedDate": "2020-04-02T13:46:32Z", "message": "ethereum/*sync: fix tests without passing ethContext\n\nSigned-off-by: q9f <58883403+q9f@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4aab45b13391bba5464587518b38db77e1f72af", "author": {"user": {"login": "q9f", "name": "Afr Schoe"}}, "url": "https://github.com/hyperledger/besu/commit/f4aab45b13391bba5464587518b38db77e1f72af", "committedDate": "2020-04-02T13:47:34Z", "message": "Merge branch 'master' into q9-logger-peers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea2da1ed999e3aedc92a07897e8ce372ae4a0f1f", "author": {"user": {"login": "q9f", "name": "Afr Schoe"}}, "url": "https://github.com/hyperledger/besu/commit/ea2da1ed999e3aedc92a07897e8ce372ae4a0f1f", "committedDate": "2020-04-02T15:35:26Z", "message": "Merge branch 'master' into q9-logger-peers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e29cb7b26e8db3f8be1132d0c74c4ca5b6a7ac5", "author": {"user": {"login": "q9f", "name": "Afr Schoe"}}, "url": "https://github.com/hyperledger/besu/commit/2e29cb7b26e8db3f8be1132d0c74c4ca5b6a7ac5", "committedDate": "2020-04-04T06:35:29Z", "message": "Merge branch 'master' into q9-logger-peers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adc3700937e2e5029162e5587f44aecc7c538de4", "author": {"user": {"login": "q9f", "name": "Afr Schoe"}}, "url": "https://github.com/hyperledger/besu/commit/adc3700937e2e5029162e5587f44aecc7c538de4", "committedDate": "2020-04-04T09:36:19Z", "message": "ethereum/sync: restore full block hash in info log\n\nSigned-off-by: /raw PONG _GHMoaCXLT <58883403+q9f@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d9bdae59e0fae673ec229146e5eb2e2a9299940", "author": {"user": {"login": "q9f", "name": "Afr Schoe"}}, "url": "https://github.com/hyperledger/besu/commit/4d9bdae59e0fae673ec229146e5eb2e2a9299940", "committedDate": "2020-04-06T08:19:00Z", "message": "Merge branch 'master' into q9-logger-peers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzAwMTk2", "url": "https://github.com/hyperledger/besu/pull/631#pullrequestreview-389300196", "createdAt": "2020-04-07T16:42:41Z", "commit": {"oid": "4d9bdae59e0fae673ec229146e5eb2e2a9299940"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffd80965078f952f67259be011ff8e3dd9cfd497", "author": {"user": {"login": "q9f", "name": "Afr Schoe"}}, "url": "https://github.com/hyperledger/besu/commit/ffd80965078f952f67259be011ff8e3dd9cfd497", "committedDate": "2020-04-08T11:15:21Z", "message": "Merge branch 'master' into q9-logger-peers"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1654, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}