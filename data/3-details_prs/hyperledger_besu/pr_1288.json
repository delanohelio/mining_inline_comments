{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1MzExMjc1", "number": 1288, "title": "On chain group management api changes", "bodyText": "PR description\n\nAdding an API to the on-chain group management contract that checks whether someone is allowed to update the current group management contract\nRemoving the enclave key as a parameter from several on-chain management APIs\nDefault implementation now only allows the account of the creator to add/remove members and to update the management contract\n\nFixed Issue(s)\n#807", "createdAt": "2020-08-10T06:40:19Z", "url": "https://github.com/hyperledger/besu/pull/1288", "merged": true, "mergeCommit": {"oid": "78c458b321903815d2cbc085890bb2fe97da629f"}, "closed": true, "closedAt": "2020-08-19T03:11:03Z", "author": {"login": "pinges"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczcqDtAH2gAyNDY1MzExMjc1OjBhNjYxNzAxOTg1ZmZjM2ZiNzEyYjAxNjFlMmEzZWYwOWEyZGNmNDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdASjslgFqTQ3MDA4OTY5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0a661701985ffc3fb712b0161e2a3ef09a2dcf40", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/0a661701985ffc3fb712b0161e2a3ef09a2dcf40", "committedDate": "2020-07-10T05:19:30Z", "message": "before removing enclave keys from APIs\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c30832c3f14d055c59f1612d7ade58b81fa5733c", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/c30832c3f14d055c59f1612d7ade58b81fa5733c", "committedDate": "2020-07-10T05:19:59Z", "message": "before removing enclave keys from APIs\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed74e18cb05eb4e9feaff1ee160fddcf02f61e57", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/ed74e18cb05eb4e9feaff1ee160fddcf02f61e57", "committedDate": "2020-07-16T10:27:35Z", "message": "Merge branch 'master' of github.com:hyperledger/besu into HEAD"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63e8b323235b4e578e08464b11b415389f2907c4", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/63e8b323235b4e578e08464b11b415389f2907c4", "committedDate": "2020-08-10T01:21:47Z", "message": "Merge branch 'master' of github.com:hyperledger/besu into HEAD"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4afaa60d59939a7280594526386a65d30a2487c5", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/4afaa60d59939a7280594526386a65d30a2487c5", "committedDate": "2020-08-10T06:04:51Z", "message": "On-chain group management changes: additional API to check whether someone is allowed to update the contract, and remove enclave key as a parameter to contract APIs\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed8b4e84d13835371fbbaae28ca16ed4a12b6063", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/ed8b4e84d13835371fbbaae28ca16ed4a12b6063", "committedDate": "2020-08-10T07:08:30Z", "message": "On-chain group management changes: additional API to check whether someone is allowed to update the contract, and remove enclave key as a parameter to contract APIs\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a8e87481b6da3b61573ddb86d1c5d440ac040a2", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/1a8e87481b6da3b61573ddb86d1c5d440ac040a2", "committedDate": "2020-08-10T22:20:49Z", "message": "fix AT\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6ba836384050b2e0bede64f7f61e0a916686aff", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/b6ba836384050b2e0bede64f7f61e0a916686aff", "committedDate": "2020-08-10T22:53:08Z", "message": "Merge branch 'master' into on-chain_group_management_api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9581efefb54b47a9c7ee62899545cbdeab19f25a", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/9581efefb54b47a9c7ee62899545cbdeab19f25a", "committedDate": "2020-08-11T01:10:53Z", "message": "Merge branch 'master' into on-chain_group_management_api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "479149f83058168f67c265124fbcef87462908bd", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/479149f83058168f67c265124fbcef87462908bd", "committedDate": "2020-08-11T07:12:42Z", "message": "Merge branch 'master' into on-chain_group_management_api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbd8aee2ff65c42127954a1df3886cc918003ec3", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/cbd8aee2ff65c42127954a1df3886cc918003ec3", "committedDate": "2020-08-12T07:50:01Z", "message": "add some tests\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c3cd4fccafed1a4d34f8136bf04dea972730567", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/4c3cd4fccafed1a4d34f8136bf04dea972730567", "committedDate": "2020-08-12T22:51:41Z", "message": "Merge branch 'master' into on-chain_group_management_api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MzQ2NjU0", "url": "https://github.com/hyperledger/besu/pull/1288#pullrequestreview-466346654", "createdAt": "2020-08-12T23:38:49Z", "commit": {"oid": "4c3cd4fccafed1a4d34f8136bf04dea972730567"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQyMzozODo0OVrOG_2drA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwMDoxNjozOVrOG_3KQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYwNTgwNA==", "bodyText": "Maye we could have a overloaded version of this method instead of changing every call. For most tests, having the node key signing the transaction is enough, isn't it?", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r469605804", "createdAt": "2020-08-12T23:38:49Z", "author": {"login": "lucassaldanha"}, "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/transaction/privacy/PrivacyRequestFactory.java", "diffHunk": "@@ -127,18 +128,20 @@ public String getTransactionKey() {\n   }\n \n   public String privxAddToPrivacyGroup(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c3cd4fccafed1a4d34f8136bf04dea972730567"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYwNjM3Mw==", "bodyText": "The same applies to the other methods in this class.", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r469606373", "createdAt": "2020-08-12T23:40:48Z", "author": {"login": "lucassaldanha"}, "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/transaction/privacy/PrivacyRequestFactory.java", "diffHunk": "@@ -127,18 +128,20 @@ public String getTransactionKey() {\n   }\n \n   public String privxAddToPrivacyGroup(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYwNTgwNA=="}, "originalCommit": {"oid": "4c3cd4fccafed1a4d34f8136bf04dea972730567"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYwODEzNQ==", "bodyText": "Did you forget to delete this?", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r469608135", "createdAt": "2020-08-12T23:46:40Z", "author": {"login": "lucassaldanha"}, "path": "acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/web3j/privacy/OnChainPrivacyAcceptanceTest.java", "diffHunk": "@@ -252,14 +259,33 @@ public void bobCanAddCharlieAfterBeingAddedByAlice() {\n             eventEmitter.getContractAddress(), alice.getAddress().toString())\n         .verify(eventEmitter);\n \n+    final Credentials aliceCredentials = Credentials.create(alice.getTransactionSigningKey());\n     final String aliceLockHash =\n-        alice.execute(privacyTransactions.privxLockPrivacyGroupAndCheck(privacyGroupId, alice));\n+        alice.execute(\n+            privacyTransactions.privxLockPrivacyGroupAndCheck(\n+                privacyGroupId, alice, aliceCredentials));\n+\n+    final String hash =\n+        alice.execute(\n+            privacyTransactions.addToPrivacyGroup(privacyGroupId, alice, aliceCredentials, bob));\n \n-    alice.execute(privacyTransactions.addToPrivacyGroup(privacyGroupId, alice, bob));\n+    System.out.println(hash);\n+\n+    final Object[] aliceKeys = alice.getOrion().getPublicKeys().toArray();\n+    final Object[] bobKeys = bob.getOrion().getPublicKeys().toArray();\n+    final Address aliceAddress = alice.getAddress();\n+\n+    System.out.println(aliceKeys.length + bobKeys.length + aliceAddress.toString());\n \n     checkOnChainPrivacyGroupExists(privacyGroupId, alice, bob);\n \n-    bob.execute(privacyTransactions.privxLockPrivacyGroupAndCheck(privacyGroupId, bob));\n+    //    boolean b = true;\n+    //    while (b) {\n+    //      int i = 0;\n+    //      if (i == 1) b = false;\n+    //    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c3cd4fccafed1a4d34f8136bf04dea972730567"}, "originalPosition": 148}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYwOTA0NA==", "bodyText": "Either we remove this Sys.out or we replace it with a log msg.", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r469609044", "createdAt": "2020-08-12T23:49:42Z", "author": {"login": "lucassaldanha"}, "path": "acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/web3j/privacy/OnChainPrivacyAcceptanceTest.java", "diffHunk": "@@ -457,6 +488,15 @@ public void addMembersToTwoGroupsInTheSameBlock() throws InterruptedException {\n    * @return the id of the privacy group\n    */\n   private String createOnChainPrivacyGroup(final PrivacyNode... members) {\n+\n+    System.out.println(\"Public keys start:\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c3cd4fccafed1a4d34f8136bf04dea972730567"}, "originalPosition": 209}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYwOTkwNQ==", "bodyText": "I'd rather have two separate test cases:\n\nOwner successfully upgrades contract\nNon-owner can't upgrade contract", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r469609905", "createdAt": "2020-08-12T23:52:07Z", "author": {"login": "lucassaldanha"}, "path": "acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/web3j/privacy/contracts/PrivacyProxyTest.java", "diffHunk": "@@ -67,47 +76,39 @@ public void rlp() throws Exception {\n     contractVerifier\n         .validTransactionReceipt(onChainPrivacyGroupManagementProxy.getContractAddress())\n         .verify(onChainPrivacyGroupManagementProxy);\n-    // 0x0b0235be\n-    assertThat(RAW_FIRST_PARTICIPANT)\n-        .isEqualTo(\n-            onChainPrivacyGroupManagementProxy\n-                .getParticipants(firstParticipant.raw())\n-                .encodeFunctionCall());\n-    // 0xf744b089\n+    assertThat(RAW_GET_PARTICIPANTS)\n+        .isEqualTo(onChainPrivacyGroupManagementProxy.getParticipants().encodeFunctionCall());\n     assertThat(RAW_ADD_PARTICIPANT)\n         .isEqualTo(\n             onChainPrivacyGroupManagementProxy\n-                .addParticipants(firstParticipant.raw(), Collections.emptyList())\n+                .addParticipants(Collections.emptyList())\n                 .encodeFunctionCall());\n   }\n \n   @Ignore(\"return 0x which causes web3j to throw exception instead of return empty list\")\n   @Test\n   public void deploysWithNoParticipant() throws Exception {\n-    final List<byte[]> participants =\n-        onChainPrivacyGroupManagementProxy.getParticipants(firstParticipant.raw()).send();\n+    final List<byte[]> participants = onChainPrivacyGroupManagementProxy.getParticipants().send();\n     assertThat(participants.size()).isEqualTo(0);\n   }\n \n   @Test\n   public void canAddParticipants() throws Exception {\n     onChainPrivacyGroupManagementProxy\n-        .addParticipants(firstParticipant.raw(), Collections.singletonList(secondParticipant.raw()))\n+        .addParticipants(Arrays.asList(firstParticipant.raw(), secondParticipant.raw()))\n         .send();\n-    final List<byte[]> participants =\n-        onChainPrivacyGroupManagementProxy.getParticipants(firstParticipant.raw()).send();\n+    final List<byte[]> participants = onChainPrivacyGroupManagementProxy.getParticipants().send();\n     assertThat(participants.size()).isEqualTo(2);\n     assertThat(firstParticipant.raw()).isEqualTo(participants.get(0));\n     assertThat(secondParticipant.raw()).isEqualTo(participants.get(1));\n   }\n \n   @Test\n-  public void canUpgrade() throws Exception {\n+  public void onlyOwnerCanUpgrade() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c3cd4fccafed1a4d34f8136bf04dea972730567"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxMDY3OA==", "bodyText": "I feel like this would be easier to read if we join the two if's together:\nif (maybePrivacyGroup.isEmpty() && !privacyController.isGroupAdditionTransaction(privateTransaction))", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r469610678", "createdAt": "2020-08-12T23:54:55Z", "author": {"login": "lucassaldanha"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/privacy/methods/eea/EeaSendRawTransaction.java", "diffHunk": "@@ -95,8 +95,11 @@ public JsonRpcResponse response(final JsonRpcRequestContext requestContext) {\n         maybePrivacyGroup =\n             privacyController.retrieveOnChainPrivacyGroup(\n                 maybePrivacyGroupId.get(), enclavePublicKey);\n-        if (maybePrivacyGroup.isEmpty()\n-            && !privacyController.isGroupAdditionTransaction(privateTransaction)) {\n+        if (maybePrivacyGroup.isEmpty()) {\n+          if (!privacyController.isGroupAdditionTransaction(privateTransaction)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c3cd4fccafed1a4d34f8136bf04dea972730567"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxMTQ1Mg==", "bodyText": "This shouldn't be logged as an error. The system is behaving exactly as expected.\nIt should be a DEBUG or TRACE to help investigations or bug fixing.", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r469611452", "createdAt": "2020-08-12T23:57:25Z", "author": {"login": "lucassaldanha"}, "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/OnChainPrivacyPrecompiledContract.java", "diffHunk": "@@ -226,11 +242,97 @@ boolean canExecute(\n         blockchain,\n         disposablePrivateState,\n         privateWorldStateUpdater)) {\n+      LOG.debug(\n+          \"Privacy group version mismatch while trying to execute transaction with commitment {}\",\n+          messageFrame.getTransactionHash());\n+      return false;\n+    }\n+\n+    if (!isMemberOfPrivacyGroup(\n+        isAddingParticipant,\n+        privateTransaction,\n+        privateFrom,\n+        privacyGroupId,\n+        messageFrame,\n+        currentBlockHeader,\n+        publicWorldState,\n+        blockchain,\n+        disposablePrivateState,\n+        privateWorldStateUpdater)) {\n+      LOG.error(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c3cd4fccafed1a4d34f8136bf04dea972730567"}, "originalPosition": 151}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxMTkwNA==", "bodyText": "Can't we add this to the class that encapsulates the interaction with the contract? OnchainPrivacyGroupContract", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r469611904", "createdAt": "2020-08-12T23:59:02Z", "author": {"login": "lucassaldanha"}, "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/OnChainPrivacyPrecompiledContract.java", "diffHunk": "@@ -226,11 +242,97 @@ boolean canExecute(\n         blockchain,\n         disposablePrivateState,\n         privateWorldStateUpdater)) {\n+      LOG.debug(\n+          \"Privacy group version mismatch while trying to execute transaction with commitment {}\",\n+          messageFrame.getTransactionHash());\n+      return false;\n+    }\n+\n+    if (!isMemberOfPrivacyGroup(\n+        isAddingParticipant,\n+        privateTransaction,\n+        privateFrom,\n+        privacyGroupId,\n+        messageFrame,\n+        currentBlockHeader,\n+        publicWorldState,\n+        blockchain,\n+        disposablePrivateState,\n+        privateWorldStateUpdater)) {\n+      LOG.error(\n+          \"PrivateTransaction with hash {} cannot execute in privacy group {} because private from {} is not a member.\",\n+          messageFrame.getTransactionHash(),\n+          privacyGroupId.toBase64String(),\n+          privateFrom.toBase64String());\n       return false;\n     }\n+\n     return true;\n   }\n \n+  private boolean isMemberOfPrivacyGroup(\n+      final boolean isAddingParticipant,\n+      final PrivateTransaction privateTransaction,\n+      final Bytes privateFrom,\n+      final Bytes32 privacyGroupId,\n+      final MessageFrame messageFrame,\n+      final ProcessableBlockHeader currentBlockHeader,\n+      final WorldUpdater publicWorldState,\n+      final Blockchain blockchain,\n+      final MutableWorldState disposablePrivateState,\n+      final WorldUpdater privateWorldStateUpdater) {\n+    final PrivateTransactionProcessor.Result result =\n+        simulateTransaction(\n+            messageFrame,\n+            currentBlockHeader,\n+            publicWorldState,\n+            privacyGroupId,\n+            blockchain,\n+            disposablePrivateState,\n+            privateWorldStateUpdater,\n+            OnChainGroupManagement.GET_PARTICIPANTS_METHOD_SIGNATURE);\n+    final List<Bytes> list = getMembersFromResult(result);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c3cd4fccafed1a4d34f8136bf04dea972730567"}, "originalPosition": 183}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxMjEzOQ==", "bodyText": "Are these TODOs things that we need to discuss before merging this PR?", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r469612139", "createdAt": "2020-08-12T23:59:40Z", "author": {"login": "lucassaldanha"}, "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/PrivacyPrecompiledContract.java", "diffHunk": "@@ -134,14 +136,29 @@ public Bytes compute(final Bytes input, final MessageFrame messageFrame) {\n     final PrivateTransaction privateTransaction =\n         PrivateTransaction.readFrom(bytesValueRLPInput.readAsRlp());\n \n-    if (!privateFromMatchesSenderKey(\n-        privateTransaction.getPrivateFrom(), receiveResponse.getSenderKey())) {\n+    final Bytes privateFrom = privateTransaction.getPrivateFrom();\n+    if (!privateFromMatchesSenderKey(privateFrom, receiveResponse.getSenderKey())) {\n       return Bytes.EMPTY;\n     }\n \n     final Bytes32 privacyGroupId =\n         Bytes32.wrap(Bytes.fromBase64String(receiveResponse.getPrivacyGroupId()));\n \n+    try {\n+      // TODO: Do we need to check anything for legacy private transactions\n+      if (privateTransaction.getPrivateFor().isEmpty()\n+          && !enclave\n+              .retrievePrivacyGroup(privacyGroupId.toBase64String())\n+              .getMembers()\n+              .contains(privateFrom.toBase64String())) {\n+        return Bytes.EMPTY;\n+      }\n+    } catch (final EnclaveClientException e) {\n+      // TODO: do I have to catch anything else here? This exception is thrown when the privacy\n+      // group can not be found\n+      return Bytes.EMPTY;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c3cd4fccafed1a4d34f8136bf04dea972730567"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxMjY5NA==", "bodyText": "NIT: we can return the value directly instead of assigning it to maybePrivacyGroup.", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r469612694", "createdAt": "2020-08-13T00:01:27Z", "author": {"login": "lucassaldanha"}, "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/MultiTenancyPrivacyController.java", "diffHunk": "@@ -234,11 +234,7 @@ public boolean isGroupAdditionTransaction(final PrivateTransaction privateTransa\n       final Bytes privacyGroupId, final String enclavePublicKey) {\n     final Optional<PrivacyGroup> maybePrivacyGroup =\n         privacyController.retrieveOnChainPrivacyGroup(privacyGroupId, enclavePublicKey);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c3cd4fccafed1a4d34f8136bf04dea972730567"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxMzYwMw==", "bodyText": "Just to confirm. We are setting the owner when we inject the contract into the newly created private state, correct?", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r469613603", "createdAt": "2020-08-13T00:04:01Z", "author": {"login": "lucassaldanha"}, "path": "privacy-contracts/src/main/solidity/DefaultOnChainPrivacyGroupManagementContract.sol", "diffHunk": "@@ -3,6 +3,7 @@ import \"./OnChainPrivacyGroupManagementInterface.sol\";\n \n contract DefaultOnChainPrivacyGroupManagementContract is OnChainPrivacyGroupManagementInterface {\n \n+    address private _owner;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c3cd4fccafed1a4d34f8136bf04dea972730567"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxNDYwOA==", "bodyText": "The owner check can be simplified using a function modifier. Check this example:\nhttps://solidity.readthedocs.io/en/v0.6.2/contracts.html#function-modifiers", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r469614608", "createdAt": "2020-08-13T00:07:29Z", "author": {"login": "lucassaldanha"}, "path": "privacy-contracts/src/main/solidity/DefaultOnChainPrivacyGroupManagementContract.sol", "diffHunk": "@@ -12,54 +13,58 @@ contract DefaultOnChainPrivacyGroupManagementContract is OnChainPrivacyGroupMana\n         return _version;\n     }\n \n-    // overrides\n     function canExecute() external view returns (bool) {\n         return _canExecute;\n     }\n \n     function lock() public {\n         require(_canExecute);\n+        require(tx.origin == _owner, \"Origin not the owner.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c3cd4fccafed1a4d34f8136bf04dea972730567"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxNDc0Mg==", "bodyText": "I don't understand why we are doing this.", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r469614742", "createdAt": "2020-08-13T00:07:54Z", "author": {"login": "lucassaldanha"}, "path": "privacy-contracts/src/main/solidity/DefaultOnChainPrivacyGroupManagementContract.sol", "diffHunk": "@@ -12,54 +13,58 @@ contract DefaultOnChainPrivacyGroupManagementContract is OnChainPrivacyGroupMana\n         return _version;\n     }\n \n-    // overrides\n     function canExecute() external view returns (bool) {\n         return _canExecute;\n     }\n \n     function lock() public {\n         require(_canExecute);\n+        require(tx.origin == _owner, \"Origin not the owner.\");\n         _canExecute = false;\n     }\n \n     function unlock() public {\n         require(!_canExecute);\n+        require(tx.origin == _owner, \"Origin not the owner.\");\n         _canExecute = true;\n     }\n \n-    function addParticipants(bytes32 _enclaveKey, bytes32[] memory _accounts) public returns (bool) {\n+    function addParticipants(bytes32[] memory _accounts) public returns (bool) {\n         require(!_canExecute);\n-        if(distributionList.length == 0) {\n-            addParticipant(_enclaveKey);\n+        if (_owner == address(0x0)) {\n+            _owner = tx.origin;\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c3cd4fccafed1a4d34f8136bf04dea972730567"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxNTIxNQ==", "bodyText": "I know that this was already here, but I don't like the fact we are calling the enclaveKey accounts.\nGiven we are changing the contract, can we fix this (for all methods)?", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r469615215", "createdAt": "2020-08-13T00:09:31Z", "author": {"login": "lucassaldanha"}, "path": "privacy-contracts/src/main/solidity/DefaultOnChainPrivacyGroupManagementContract.sol", "diffHunk": "@@ -12,54 +13,58 @@ contract DefaultOnChainPrivacyGroupManagementContract is OnChainPrivacyGroupMana\n         return _version;\n     }\n \n-    // overrides\n     function canExecute() external view returns (bool) {\n         return _canExecute;\n     }\n \n     function lock() public {\n         require(_canExecute);\n+        require(tx.origin == _owner, \"Origin not the owner.\");\n         _canExecute = false;\n     }\n \n     function unlock() public {\n         require(!_canExecute);\n+        require(tx.origin == _owner, \"Origin not the owner.\");\n         _canExecute = true;\n     }\n \n-    function addParticipants(bytes32 _enclaveKey, bytes32[] memory _accounts) public returns (bool) {\n+    function addParticipants(bytes32[] memory _accounts) public returns (bool) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c3cd4fccafed1a4d34f8136bf04dea972730567"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxNTg5Mw==", "bodyText": "This seems a bit weird. Aren't we supposed to return true or false?\nI feel like we could have: return tx.origin == _owner.\nAm I missing something?", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r469615893", "createdAt": "2020-08-13T00:11:50Z", "author": {"login": "lucassaldanha"}, "path": "privacy-contracts/src/main/solidity/DefaultOnChainPrivacyGroupManagementContract.sol", "diffHunk": "@@ -12,54 +13,58 @@ contract DefaultOnChainPrivacyGroupManagementContract is OnChainPrivacyGroupMana\n         return _version;\n     }\n \n-    // overrides\n     function canExecute() external view returns (bool) {\n         return _canExecute;\n     }\n \n     function lock() public {\n         require(_canExecute);\n+        require(tx.origin == _owner, \"Origin not the owner.\");\n         _canExecute = false;\n     }\n \n     function unlock() public {\n         require(!_canExecute);\n+        require(tx.origin == _owner, \"Origin not the owner.\");\n         _canExecute = true;\n     }\n \n-    function addParticipants(bytes32 _enclaveKey, bytes32[] memory _accounts) public returns (bool) {\n+    function addParticipants(bytes32[] memory _accounts) public returns (bool) {\n         require(!_canExecute);\n-        if(distributionList.length == 0) {\n-            addParticipant(_enclaveKey);\n+        if (_owner == address(0x0)) {\n+            _owner = tx.origin;\n         }\n-        require(isMember(_enclaveKey));\n-        bool result = addAll(_enclaveKey, _accounts);\n+        require(tx.origin == _owner, \"Origin not the owner.\");\n+        bool result = addAll(_accounts);\n         _canExecute = true;\n         updateVersion();\n         return result;\n     }\n \n-    function removeParticipant(bytes32 _enclaveKey, bytes32 _account) public returns (bool) {\n-        require(isMember(_enclaveKey));\n+    function removeParticipant(bytes32 _account) public returns (bool) {\n+        require(_canExecute);\n+        require(tx.origin == _owner, \"Origin not the owner.\");\n         bool result = removeInternal(_account);\n         updateVersion();\n+        emit ParticipantRemoved(result, _account);\n         return result;\n     }\n \n-    function getParticipants(bytes32 _enclaveKey) public view returns (bytes32[] memory) {\n-        require(isMember(_enclaveKey));\n+    function getParticipants() public view returns (bytes32[] memory) {\n         return distributionList;\n     }\n \n+    function canUpgrade() external returns (bool) {\n+        require(tx.origin == _owner, \"Origin not the owner.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c3cd4fccafed1a4d34f8136bf04dea972730567"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYxNzIxOA==", "bodyText": "Which version is the required one? We shouldn't have two :P", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r469617218", "createdAt": "2020-08-13T00:16:39Z", "author": {"login": "lucassaldanha"}, "path": "privacy-contracts/src/main/solidity/OnChainPrivacyGroupManagementProxy.sol", "diffHunk": "@@ -1,5 +1,6 @@\n pragma solidity ^0.5.12;\n \n+pragma solidity ^0.5.9;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c3cd4fccafed1a4d34f8136bf04dea972730567"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MzY2NjE2", "url": "https://github.com/hyperledger/besu/pull/1288#pullrequestreview-466366616", "createdAt": "2020-08-13T00:30:38Z", "commit": {"oid": "4c3cd4fccafed1a4d34f8136bf04dea972730567"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwMDozMDozOFrOG_3oPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwMDozMTowOFrOG_3ovQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYyNDg5Mw==", "bodyText": "commented out code", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r469624893", "createdAt": "2020-08-13T00:30:38Z", "author": {"login": "macfarla"}, "path": "acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/web3j/privacy/OnChainPrivacyAcceptanceTest.java", "diffHunk": "@@ -252,14 +259,33 @@ public void bobCanAddCharlieAfterBeingAddedByAlice() {\n             eventEmitter.getContractAddress(), alice.getAddress().toString())\n         .verify(eventEmitter);\n \n+    final Credentials aliceCredentials = Credentials.create(alice.getTransactionSigningKey());\n     final String aliceLockHash =\n-        alice.execute(privacyTransactions.privxLockPrivacyGroupAndCheck(privacyGroupId, alice));\n+        alice.execute(\n+            privacyTransactions.privxLockPrivacyGroupAndCheck(\n+                privacyGroupId, alice, aliceCredentials));\n+\n+    final String hash =\n+        alice.execute(\n+            privacyTransactions.addToPrivacyGroup(privacyGroupId, alice, aliceCredentials, bob));\n \n-    alice.execute(privacyTransactions.addToPrivacyGroup(privacyGroupId, alice, bob));\n+    System.out.println(hash);\n+\n+    final Object[] aliceKeys = alice.getOrion().getPublicKeys().toArray();\n+    final Object[] bobKeys = bob.getOrion().getPublicKeys().toArray();\n+    final Address aliceAddress = alice.getAddress();\n+\n+    System.out.println(aliceKeys.length + bobKeys.length + aliceAddress.toString());\n \n     checkOnChainPrivacyGroupExists(privacyGroupId, alice, bob);\n \n-    bob.execute(privacyTransactions.privxLockPrivacyGroupAndCheck(privacyGroupId, bob));\n+    //    boolean b = true;\n+    //    while (b) {\n+    //      int i = 0;\n+    //      if (i == 1) b = false;\n+    //    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c3cd4fccafed1a4d34f8136bf04dea972730567"}, "originalPosition": 148}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTYyNTAyMQ==", "bodyText": "debug code", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r469625021", "createdAt": "2020-08-13T00:31:08Z", "author": {"login": "macfarla"}, "path": "acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/web3j/privacy/OnChainPrivacyAcceptanceTest.java", "diffHunk": "@@ -457,6 +488,15 @@ public void addMembersToTwoGroupsInTheSameBlock() throws InterruptedException {\n    * @return the id of the privacy group\n    */\n   private String createOnChainPrivacyGroup(final PrivacyNode... members) {\n+\n+    System.out.println(\"Public keys start:\");\n+    Arrays.stream(members)\n+        .map(m -> m.getOrion().getPublicKeys())\n+        .forEach(\n+            k -> {\n+              System.out.println(k);\n+            });\n+    System.out.println(\"Public keys end!\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c3cd4fccafed1a4d34f8136bf04dea972730567"}, "originalPosition": 216}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a90e0a8b4a638747446a20c104e28fcfc4f5c54", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/0a90e0a8b4a638747446a20c104e28fcfc4f5c54", "committedDate": "2020-08-17T23:09:23Z", "message": "changes after review\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08a3f3039536259bc77c483183b45ab176688ec0", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/08a3f3039536259bc77c483183b45ab176688ec0", "committedDate": "2020-08-17T23:09:57Z", "message": "Merge branch 'on-chain_group_management_api' of github.com:pinges/besu into on-chain_group_management_api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4OTEwMjY2", "url": "https://github.com/hyperledger/besu/pull/1288#pullrequestreview-468910266", "createdAt": "2020-08-18T00:12:31Z", "commit": {"oid": "08a3f3039536259bc77c483183b45ab176688ec0"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMDoxMjozMVrOHB-6tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMDoxOTo0NFrOHB_CYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg0MTQ2Mg==", "bodyText": "s/On-Chain/Onchain", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r471841462", "createdAt": "2020-08-18T00:12:31Z", "author": {"login": "macfarla"}, "path": "CHANGELOG.md", "diffHunk": "@@ -1,5 +1,15 @@\n # Changelog\n \n+## 1.5.3\n+\n+### Breaking Changes\n+\n+When upgrading to 1.5.3, ensure you've taken into account the following breaking changes.\n+\n+#### On-Chain Privacy Group Management", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08a3f3039536259bc77c483183b45ab176688ec0"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg0MTU2NA==", "bodyText": "s/on-chain/onchain", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r471841564", "createdAt": "2020-08-18T00:12:53Z", "author": {"login": "macfarla"}, "path": "CHANGELOG.md", "diffHunk": "@@ -1,5 +1,15 @@\n # Changelog\n \n+## 1.5.3\n+\n+### Breaking Changes\n+\n+When upgrading to 1.5.3, ensure you've taken into account the following breaking changes.\n+\n+#### On-Chain Privacy Group Management\n+\n+This early access feature was changed in a way that makes on-chain privacy groups created with previous versions no longer usable. ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08a3f3039536259bc77c483183b45ab176688ec0"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg0MjQzMQ==", "bodyText": "should this say \"privateFrom\" rather than \"private from\"?", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r471842431", "createdAt": "2020-08-18T00:15:59Z", "author": {"login": "macfarla"}, "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/OnChainPrivacyPrecompiledContract.java", "diffHunk": "@@ -226,11 +242,97 @@ boolean canExecute(\n         blockchain,\n         disposablePrivateState,\n         privateWorldStateUpdater)) {\n+      LOG.debug(\n+          \"Privacy group version mismatch while trying to execute transaction with commitment {}\",\n+          messageFrame.getTransactionHash());\n+      return false;\n+    }\n+\n+    if (!isMemberOfPrivacyGroup(\n+        isAddingParticipant,\n+        privateTransaction,\n+        privateFrom,\n+        privacyGroupId,\n+        messageFrame,\n+        currentBlockHeader,\n+        publicWorldState,\n+        blockchain,\n+        disposablePrivateState,\n+        privateWorldStateUpdater)) {\n+      LOG.debug(\n+          \"PrivateTransaction with hash {} cannot execute in privacy group {} because private from {} is not a member.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08a3f3039536259bc77c483183b45ab176688ec0"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg0Mjc5NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  LOG.error(\"Can not communicate with enclave is it up?\", e);\n          \n          \n            \n                  LOG.error(\"Can not communicate with enclave, is it up?\", e);", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r471842794", "createdAt": "2020-08-18T00:17:21Z", "author": {"login": "macfarla"}, "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/PrivacyPrecompiledContract.java", "diffHunk": "@@ -134,14 +136,32 @@ public Bytes compute(final Bytes input, final MessageFrame messageFrame) {\n     final PrivateTransaction privateTransaction =\n         PrivateTransaction.readFrom(bytesValueRLPInput.readAsRlp());\n \n-    if (!privateFromMatchesSenderKey(\n-        privateTransaction.getPrivateFrom(), receiveResponse.getSenderKey())) {\n+    final Bytes privateFrom = privateTransaction.getPrivateFrom();\n+    if (!privateFromMatchesSenderKey(privateFrom, receiveResponse.getSenderKey())) {\n       return Bytes.EMPTY;\n     }\n \n     final Bytes32 privacyGroupId =\n         Bytes32.wrap(Bytes.fromBase64String(receiveResponse.getPrivacyGroupId()));\n \n+    try {\n+      if (!enclave\n+          .retrievePrivacyGroup(privacyGroupId.toBase64String())\n+          .getMembers()\n+          .contains(privateFrom.toBase64String())) {\n+        return Bytes.EMPTY;\n+      }\n+    } catch (final EnclaveClientException e) {\n+      // This exception is thrown when the privacy group can not be found\n+      return Bytes.EMPTY;\n+    } catch (final EnclaveServerException e) {\n+      LOG.error(\"Enclave is responding with an error, perhaps it has a misconfiguration?\", e);\n+      throw e;\n+    } catch (final EnclaveIOException e) {\n+      LOG.error(\"Can not communicate with enclave is it up?\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08a3f3039536259bc77c483183b45ab176688ec0"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg0MzQyNw==", "bodyText": "do we need the SPDX header even for generated files?", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r471843427", "createdAt": "2020-08-18T00:19:44Z", "author": {"login": "macfarla"}, "path": "privacy-contracts/src/main/java/org/hyperledger/besu/privacy/contracts/generated/OnChainPrivacyGroupManagementInterface.java", "diffHunk": "@@ -1,17 +1,3 @@\n-/*\n- * Copyright ConsenSys AG.\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n- * the License. You may obtain a copy of the License at\n- *\n- * http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n- * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n- * specific language governing permissions and limitations under the License.\n- *\n- * SPDX-License-Identifier: Apache-2.0\n- */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08a3f3039536259bc77c483183b45ab176688ec0"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fecc8447069843c18c8a28aa93aa5a434e71016c", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/fecc8447069843c18c8a28aa93aa5a434e71016c", "committedDate": "2020-08-18T00:52:11Z", "message": "fix spdx\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93b491f6cf18d8e90340a45ffb276dd19670719d", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/93b491f6cf18d8e90340a45ffb276dd19670719d", "committedDate": "2020-08-18T01:17:34Z", "message": "fixed spelling\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "81d4ca51cb34006d3aab9a478d9e5fb33b1f2a1d", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/81d4ca51cb34006d3aab9a478d9e5fb33b1f2a1d", "committedDate": "2020-08-18T01:02:19Z", "message": "Merge branch 'on-chain_group_management_api' of github.com:pinges/besu into on-chain_group_management_api\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}, "afterCommit": {"oid": "93b491f6cf18d8e90340a45ffb276dd19670719d", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/93b491f6cf18d8e90340a45ffb276dd19670719d", "committedDate": "2020-08-18T01:17:34Z", "message": "fixed spelling\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cdf3115addaa895aeb44ada1b65fe359ddc227d", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/3cdf3115addaa895aeb44ada1b65fe359ddc227d", "committedDate": "2020-08-18T01:20:06Z", "message": "merge master and fix conflict\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8466512b174e64df5152d9c3ef82373b4b4c241", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/f8466512b174e64df5152d9c3ef82373b4b4c241", "committedDate": "2020-08-18T11:58:56Z", "message": "fix web3 legacy tests\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b61a8b235ff5ede541b31df474bdeca9887f25ee", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/b61a8b235ff5ede541b31df474bdeca9887f25ee", "committedDate": "2020-08-18T22:16:04Z", "message": "Merge branch 'master' into on-chain_group_management_api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3760fd1a864bc14a9b53e239f9b4a0b83ba1c5b2", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/3760fd1a864bc14a9b53e239f9b4a0b83ba1c5b2", "committedDate": "2020-08-19T00:33:14Z", "message": "Merge branch 'master' into on-chain_group_management_api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMDUyNDk1", "url": "https://github.com/hyperledger/besu/pull/1288#pullrequestreview-470052495", "createdAt": "2020-08-19T02:00:10Z", "commit": {"oid": "3760fd1a864bc14a9b53e239f9b4a0b83ba1c5b2"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMjowMDoxMVrOHCsq-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMjoxMDozM1rOHCs1_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU5MTA5Ng==", "bodyText": "You left a sys.out here", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r472591096", "createdAt": "2020-08-19T02:00:11Z", "author": {"login": "lucassaldanha"}, "path": "acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/web3j/privacy/Ibft2PrivacyClusterAcceptanceTest.java", "diffHunk": "@@ -144,16 +144,25 @@ public void canInteractWithMultiplePrivacyGroups() {\n                 bob.getEnclaveKey()));\n \n     // alice gets receipt from charlie's interaction\n-    final PrivateTransactionReceipt firstExpectedReceipt =\n+    final PrivateTransactionReceipt aliceReceipt =\n         alice.execute(privacyTransactions.getPrivateTransactionReceipt(firstTransactionHash));\n \n+    final PrivateTransactionReceipt bobReceipt =\n+        bob.execute(privacyTransactions.getPrivateTransactionReceipt(firstTransactionHash));\n+    final PrivateTransactionReceipt charlieReceipt =\n+        bob.execute(privacyTransactions.getPrivateTransactionReceipt(firstTransactionHash));\n+\n+    System.out.println(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3760fd1a864bc14a9b53e239f9b4a0b83ba1c5b2"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU5MTI2MA==", "bodyText": "Also, are we using bobReceipt and charlieReceipt for anything?", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r472591260", "createdAt": "2020-08-19T02:00:42Z", "author": {"login": "lucassaldanha"}, "path": "acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/web3j/privacy/Ibft2PrivacyClusterAcceptanceTest.java", "diffHunk": "@@ -144,16 +144,25 @@ public void canInteractWithMultiplePrivacyGroups() {\n                 bob.getEnclaveKey()));\n \n     // alice gets receipt from charlie's interaction\n-    final PrivateTransactionReceipt firstExpectedReceipt =\n+    final PrivateTransactionReceipt aliceReceipt =\n         alice.execute(privacyTransactions.getPrivateTransactionReceipt(firstTransactionHash));\n \n+    final PrivateTransactionReceipt bobReceipt =\n+        bob.execute(privacyTransactions.getPrivateTransactionReceipt(firstTransactionHash));\n+    final PrivateTransactionReceipt charlieReceipt =\n+        bob.execute(privacyTransactions.getPrivateTransactionReceipt(firstTransactionHash));\n+\n+    System.out.println(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU5MTA5Ng=="}, "originalCommit": {"oid": "3760fd1a864bc14a9b53e239f9b4a0b83ba1c5b2"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU5MTYxNw==", "bodyText": "NIT: we could assign Credentials.create(alice.getTransactionSigningKey()) to a variable aliceCredentials to make the code easier to read.", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r472591617", "createdAt": "2020-08-19T02:02:01Z", "author": {"login": "lucassaldanha"}, "path": "acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/web3j/privacy/OnChainPrivacyAcceptanceTest.java", "diffHunk": "@@ -100,8 +101,9 @@ public void canAddParticipantToGroup() {\n \n     charlie.verify(privateTransactionVerifier.noPrivateTransactionReceipt(commitmentHash));\n \n-    lockPrivacyGroup(privacyGroupId, alice);\n-    addMembersToPrivacyGroup(privacyGroupId, alice, charlie);\n+    lockPrivacyGroup(privacyGroupId, alice, Credentials.create(alice.getTransactionSigningKey()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3760fd1a864bc14a9b53e239f9b4a0b83ba1c5b2"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU5MTgxNw==", "bodyText": "Left another sys.out :)", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r472591817", "createdAt": "2020-08-19T02:02:50Z", "author": {"login": "lucassaldanha"}, "path": "acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/web3j/privacy/OnChainPrivacyAcceptanceTest.java", "diffHunk": "@@ -252,14 +259,28 @@ public void bobCanAddCharlieAfterBeingAddedByAlice() {\n             eventEmitter.getContractAddress(), alice.getAddress().toString())\n         .verify(eventEmitter);\n \n+    final Credentials aliceCredentials = Credentials.create(alice.getTransactionSigningKey());\n     final String aliceLockHash =\n-        alice.execute(privacyTransactions.privxLockPrivacyGroupAndCheck(privacyGroupId, alice));\n+        alice.execute(\n+            privacyTransactions.privxLockPrivacyGroupAndCheck(\n+                privacyGroupId, alice, aliceCredentials));\n+\n+    final String hash =\n+        alice.execute(\n+            privacyTransactions.addToPrivacyGroup(privacyGroupId, alice, aliceCredentials, bob));\n \n-    alice.execute(privacyTransactions.addToPrivacyGroup(privacyGroupId, alice, bob));\n+    System.out.println(hash);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3760fd1a864bc14a9b53e239f9b4a0b83ba1c5b2"}, "originalPosition": 133}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU5MTg4Mg==", "bodyText": "Yet another sys.out...", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r472591882", "createdAt": "2020-08-19T02:03:05Z", "author": {"login": "lucassaldanha"}, "path": "acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/web3j/privacy/OnChainPrivacyAcceptanceTest.java", "diffHunk": "@@ -252,14 +259,28 @@ public void bobCanAddCharlieAfterBeingAddedByAlice() {\n             eventEmitter.getContractAddress(), alice.getAddress().toString())\n         .verify(eventEmitter);\n \n+    final Credentials aliceCredentials = Credentials.create(alice.getTransactionSigningKey());\n     final String aliceLockHash =\n-        alice.execute(privacyTransactions.privxLockPrivacyGroupAndCheck(privacyGroupId, alice));\n+        alice.execute(\n+            privacyTransactions.privxLockPrivacyGroupAndCheck(\n+                privacyGroupId, alice, aliceCredentials));\n+\n+    final String hash =\n+        alice.execute(\n+            privacyTransactions.addToPrivacyGroup(privacyGroupId, alice, aliceCredentials, bob));\n \n-    alice.execute(privacyTransactions.addToPrivacyGroup(privacyGroupId, alice, bob));\n+    System.out.println(hash);\n+\n+    final Object[] aliceKeys = alice.getOrion().getPublicKeys().toArray();\n+    final Object[] bobKeys = bob.getOrion().getPublicKeys().toArray();\n+    final Address aliceAddress = alice.getAddress();\n+\n+    System.out.println(aliceKeys.length + bobKeys.length + aliceAddress.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3760fd1a864bc14a9b53e239f9b4a0b83ba1c5b2"}, "originalPosition": 139}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU5MzkxNw==", "bodyText": "Instead of always emitting the event with a status, why don't we only emit the event when the participant is removed successfully?", "url": "https://github.com/hyperledger/besu/pull/1288#discussion_r472593917", "createdAt": "2020-08-19T02:10:33Z", "author": {"login": "lucassaldanha"}, "path": "privacy-contracts/src/main/solidity/OnChainPrivacyGroupManagementProxy.sol", "diffHunk": "@@ -10,28 +11,25 @@ contract OnChainPrivacyGroupManagementProxy is OnChainPrivacyGroupManagementInte\n         implementation = _implementation;\n     }\n \n-    function upgradeTo(address _newImplementation) external {\n-        require(implementation != _newImplementation);\n-        _setImplementation(_newImplementation);\n-    }\n-\n     function _setImplementation(address _newImp) internal {\n         implementation = _newImp;\n     }\n \n-    function addParticipants(bytes32 enclaveKey, bytes32[] memory participants) public returns (bool) {\n+    function addParticipants(bytes32[] memory _publicEnclaveKeys) public returns (bool) {\n         OnChainPrivacyGroupManagementInterface privacyInterface = OnChainPrivacyGroupManagementInterface(implementation);\n-        return privacyInterface.addParticipants(enclaveKey, participants);\n+        return privacyInterface.addParticipants(_publicEnclaveKeys);\n     }\n \n-    function getParticipants(bytes32 enclaveKey) view public returns (bytes32[] memory) {\n+    function getParticipants() view public returns (bytes32[] memory) {\n         OnChainPrivacyGroupManagementInterface privacyInterface = OnChainPrivacyGroupManagementInterface(implementation);\n-        return privacyInterface.getParticipants(enclaveKey);\n+        return privacyInterface.getParticipants();\n     }\n \n-    function removeParticipant(bytes32 enclaveKey, bytes32 account) public returns (bool) {\n+    function removeParticipant(bytes32 _member) public returns (bool) {\n         OnChainPrivacyGroupManagementInterface privacyInterface = OnChainPrivacyGroupManagementInterface(implementation);\n-        return privacyInterface.removeParticipant(enclaveKey, account);\n+        bool result = privacyInterface.removeParticipant(_member);\n+        emit ParticipantRemoved(result, _member);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3760fd1a864bc14a9b53e239f9b4a0b83ba1c5b2"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c014f2729fe7718b3634e0352f63f75e53962a7", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/3c014f2729fe7718b3634e0352f63f75e53962a7", "committedDate": "2020-08-19T02:31:39Z", "message": "Remove sys outs and make minor change in proxy conract\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5baf1eb98f2d49ac960e0bf44f28d75128a007d", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/c5baf1eb98f2d49ac960e0bf44f28d75128a007d", "committedDate": "2020-08-19T02:31:49Z", "message": "Merge branch 'on-chain_group_management_api' of github.com:pinges/besu into on-chain_group_management_api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02f002e89f93857c8b1c988dff1cb0ea3a9f0e6e", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/02f002e89f93857c8b1c988dff1cb0ea3a9f0e6e", "committedDate": "2020-08-19T02:47:30Z", "message": "add headers AGAIN\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMDg5Njk5", "url": "https://github.com/hyperledger/besu/pull/1288#pullrequestreview-470089699", "createdAt": "2020-08-19T02:54:31Z", "commit": {"oid": "02f002e89f93857c8b1c988dff1cb0ea3a9f0e6e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1464, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}