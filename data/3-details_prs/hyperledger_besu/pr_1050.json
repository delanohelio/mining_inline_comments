{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4MzUxNzk5", "number": 1050, "title": "Fix EIP-2124 Fork identifier for chain compatibility checks.", "bodyText": "PR description\nBefore this pull request Besu was using the latest known fork id to create status message for Ethereum P2P protocol handshake.\nThis latest known fork id was created based on a list of forks retrieved from the Genesis.\nFor private networks it is possible that all fork blocks number are set to 0.\nThe algorithm to compute the valid fork hashes excludes 0 values.\nAs a result, the list was empty and the getLatestForkId was returning null. This is an issue when you support capabilities >= to Eth/64 sub protocol because other peers expect the fork id value in the RLP encoded message.\nMoreover, the algorithm to compute the fork id should be aware of the chain head number and update CRC value only for fork blocks below the current head.\nThis pull request fixes this issue by fetching the chain head number and update accordingly the CRC value.\nUnit tests have been extended to cover an exhaustive list of possible combinations on named networks (goerli, rinkeby, ropsten and mainnet).\nFixed Issue(s)\nfixes #1044\nTesting\nAutomated\nAdded unit tests.\nTest Results - EIP2124Test.pdf\nManual\n\n\n\nNetwork\nStatus\n\n\n\n\nmainnet\nOK\n\n\nropsten\nOK\n\n\ngoerli\nOK\n\n\nmordor\nOK\n\n\nclassic\nNOT STARTED\n\n\nprivate\nOK\n\n\n\nSigned-off-by: Abdelhamid Bakhta abdelhamid.bakhta@consensys.net", "createdAt": "2020-06-05T10:02:42Z", "url": "https://github.com/hyperledger/besu/pull/1050", "merged": true, "mergeCommit": {"oid": "8589177e49740e5ad533f99819de88fa35c82933"}, "closed": true, "closedAt": "2020-06-09T15:59:36Z", "author": {"login": "abdelhamidbakhta"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoPs9OAH2gAyNDI4MzUxNzk5Ojk2MjhkMWQwN2MyNjc0MDM2MmM4NGY2MGE4YjA5NDFhZjA0MjhkODM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpm4VTAFqTQyNzI4NTQ1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9628d1d07c26740362c84f60a8b0941af0428d83", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/9628d1d07c26740362c84f60a8b0941af0428d83", "committedDate": "2020-06-05T10:00:44Z", "message": "Fix EIP-2124 Fork identifier for chain compatibility checks.\n\nBefore this pull request Besu was using the latest known fork id to create status message for Ethereum P2P protocol handshake.\nThis latest known fork id was created based on a list of forks retrieved from the Genesis.\nFor private networks it is possible that all fork blocks number are set to 0.\nThe algorithm to compute the valid fork hashes excludes 0 values.\nAs a result, the list was empty and the `getLatestForkId` was returning `null`. This is an issue when you support capabilities >= to Eth/64 sub protocol because other peers expect the fork id value in the `RLP` encoded message.\nMoreover, the algorithm to compute the fork id should be aware of the chain head number and update `CRC` value only for fork blocks below the current head.\nThis pull request fixes this issue by fetching the chain head number and update accordingly the `CRC` value.\nUnit tests have been extended to cover an exhaustive list of possible combinations on named networks (`goerli`, `rinkeby`, `ropsten` and `mainnet`).\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a224b78ab36e27f98dbac4070d6d79940261ceb", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/5a224b78ab36e27f98dbac4070d6d79940261ceb", "committedDate": "2020-06-05T16:29:42Z", "message": "Merge remote-tracking branch 'upstream/master' into 1044\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ebc051e88ce61ac293dd996ce7dc9fefb0dc8ac", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/6ebc051e88ce61ac293dd996ce7dc9fefb0dc8ac", "committedDate": "2020-06-05T16:39:46Z", "message": "Add condition in if statement\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4b0cecf1b18052c7b351d589084551f68ec1062", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/e4b0cecf1b18052c7b351d589084551f68ec1062", "committedDate": "2020-06-05T16:41:28Z", "message": "Merge remote-tracking branch 'upstream/master' into 1044\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NTg4OTQx", "url": "https://github.com/hyperledger/besu/pull/1050#pullrequestreview-425588941", "createdAt": "2020-06-05T19:57:30Z", "commit": {"oid": "e4b0cecf1b18052c7b351d589084551f68ec1062"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxOTo1NzozMFrOGf7pqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxOTo1NzozMFrOGf7pqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEzNjM2Mg==", "bodyText": "This feels like a lot of duplication with  org.hyperledger.besu.ethereum.eth.manager.ForkIdManagerTest - What is being tested here that is not being tested there and can these two files be merged into one?", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436136362", "createdAt": "2020-06-05T19:57:30Z", "author": {"login": "shemnon"}, "path": "ethereum/eth/src/test/java/org/hyperledger/besu/ethereum/eth/manager/EIP2124Test.java", "diffHunk": "@@ -0,0 +1,235 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth.manager;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+import org.hyperledger.besu.ethereum.chain.Blockchain;\n+import org.hyperledger.besu.ethereum.core.Block;\n+import org.hyperledger.besu.ethereum.core.BlockHeader;\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.ethereum.eth.manager.ForkIdManager.ForkId;\n+\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.List;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.tuweni.bytes.Bytes;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n+import org.junit.runners.Parameterized.Parameters;\n+\n+@RunWith(Parameterized.class)\n+public class EIP2124Test {\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  @Parameters(name = \"{index}: {0}\")\n+  public static Collection<Object[]> data() {\n+    return Arrays.asList(\n+        new Object[][] {\n+          // Mainnet test cases\n+          {\"Mainnet // First Homestead block\", Network.MAINNET, 1150000L, \"0x97c2c34c\", 1920000L},", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4b0cecf1b18052c7b351d589084551f68ec1062"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e92a86e1c2bb87a2f2c8b4b58ce3e19840286b8", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/7e92a86e1c2bb87a2f2c8b4b58ce3e19840286b8", "committedDate": "2020-06-08T07:05:04Z", "message": "Merge remote-tracking branch 'upstream/master' into 1044\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "991c1d6c96bf23074b7c5e21534e2a5f2b424127", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/991c1d6c96bf23074b7c5e21534e2a5f2b424127", "committedDate": "2020-06-08T08:57:59Z", "message": "Fix Ethereum classic mordor fork id\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2Mzk5ODg3", "url": "https://github.com/hyperledger/besu/pull/1050#pullrequestreview-426399887", "createdAt": "2020-06-08T16:14:44Z", "commit": {"oid": "991c1d6c96bf23074b7c5e21534e2a5f2b424127"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjoxNDo0NFrOGgl38w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxNjo0MToxNFrOGgm44w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgyODE0Nw==", "bodyText": "Is this just for testing?", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436828147", "createdAt": "2020-06-08T16:14:44Z", "author": {"login": "RatanRSur"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkIdManager.java", "diffHunk": "@@ -66,12 +69,41 @@ public ForkIdManager(final Blockchain blockchain, final List<Long> forks) {\n               blockchain,\n               genesisHash,\n               forks,\n-              fs -> fs.stream().distinct().collect(Collectors.toUnmodifiableList()),\n+              fs -> fs.stream().distinct().sorted().collect(Collectors.toUnmodifiableList()),\n               new ArrayList<>());\n       this.forkIDCheckers = Arrays.asList(newForkIdChecker, legacyForkIdChecker);\n     }\n   }\n \n+  public ForkId computeForkId() {\n+    final long head = chainHeadSupplier.getAsLong();\n+    if (lastHead != 0 && head == lastHead && lastComputedForkId != null) {\n+      return lastComputedForkId;\n+    }\n+    lastHead = head;\n+\n+    final CRC32 crc = new CRC32();\n+    long next = 0;\n+    crc.update(genesisHash.toArray());\n+    for (final Long fork : forks) {\n+      if (fork <= head) {\n+        updateCrc(crc, fork);\n+        continue;\n+      }\n+      next = fork;\n+      break;\n+    }\n+    lastComputedForkId = new ForkId(getCurrentCrcHash(crc), next);\n+    return lastComputedForkId;\n+  }\n+\n+  ForkId getLatestForkId() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "991c1d6c96bf23074b7c5e21534e2a5f2b424127"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgzMzQxMA==", "bodyText": "Since forks doesn't include 0, onlyZerosForkBlocks is not doing what it looks like it's doing. As it happens, it will be true because allMatch is true for empty but it's pretty misleading right now.", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436833410", "createdAt": "2020-06-08T16:22:45Z", "author": {"login": "RatanRSur"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkIdManager.java", "diffHunk": "@@ -40,23 +41,25 @@\n   private final List<ForkId> forkAndHashList;\n \n   private final List<Predicate<ForkId>> forkIDCheckers;\n+  private final List<Long> forks;\n+  private final LongSupplier chainHeadSupplier;\n+  private long lastHead;\n+  private ForkId lastComputedForkId;\n \n   public ForkIdManager(final Blockchain blockchain, final List<Long> forks) {\n     checkNotNull(blockchain);\n     checkNotNull(forks);\n+    this.chainHeadSupplier = blockchain::getChainHeadBlockNumber;\n     this.genesisHash = blockchain.getGenesisBlock().getHash();\n     this.forkAndHashList = new ArrayList<>();\n+    this.forks =\n+        forks.stream()\n+            .filter(fork -> fork > 0)\n+            .distinct()\n+            .sorted()\n+            .collect(Collectors.toUnmodifiableList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "991c1d6c96bf23074b7c5e21534e2a5f2b424127"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgzMzk5NA==", "bodyText": "If this isn't used anywhere else, we should probably move it into the else clause.", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436833994", "createdAt": "2020-06-08T16:23:44Z", "author": {"login": "RatanRSur"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkIdManager.java", "diffHunk": "@@ -40,23 +41,25 @@\n   private final List<ForkId> forkAndHashList;\n \n   private final List<Predicate<ForkId>> forkIDCheckers;\n+  private final List<Long> forks;\n+  private final LongSupplier chainHeadSupplier;\n+  private long lastHead;\n+  private ForkId lastComputedForkId;\n \n   public ForkIdManager(final Blockchain blockchain, final List<Long> forks) {\n     checkNotNull(blockchain);\n     checkNotNull(forks);\n+    this.chainHeadSupplier = blockchain::getChainHeadBlockNumber;\n     this.genesisHash = blockchain.getGenesisBlock().getHash();\n     this.forkAndHashList = new ArrayList<>();\n+    this.forks =\n+        forks.stream()\n+            .filter(fork -> fork > 0)\n+            .distinct()\n+            .sorted()\n+            .collect(Collectors.toUnmodifiableList());\n     final Predicate<ForkId> legacyForkIdChecker =\n-        createForkIDChecker(\n-            blockchain,\n-            genesisHash,\n-            forks,\n-            fs ->\n-                fs.stream()\n-                    .filter(fork -> fork > 0)\n-                    .distinct()\n-                    .collect(Collectors.toUnmodifiableList()),\n-            forkAndHashList);\n+        createForkIDChecker(blockchain, genesisHash, forks, fs -> forks, forkAndHashList);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "991c1d6c96bf23074b7c5e21534e2a5f2b424127"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0MzE0Mw==", "bodyText": "Do we need this filter as well? I thought we already got rid of the 0's above. If it does break when this is removed, I wonder if there's a way we can do this filter in only one place.", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436843143", "createdAt": "2020-06-08T16:38:28Z", "author": {"login": "RatanRSur"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkIdManager.java", "diffHunk": "@@ -205,16 +230,20 @@ private static long createForkIds(\n     final CRC32 crc = new CRC32();\n     crc.update(genesisHash.toArray());\n     final List<Bytes> forkHashes = new ArrayList<>(List.of(getCurrentCrcHash(crc)));\n-    for (final Long fork : forks) {\n-      updateCrc(crc, fork);\n-      forkHashes.add(getCurrentCrcHash(crc));\n-    }\n+    final List<Long> filteredForks =\n+        forks.stream().filter(v -> v > 0).distinct().collect(Collectors.toUnmodifiableList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "991c1d6c96bf23074b7c5e21534e2a5f2b424127"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjg0NDc3MQ==", "bodyText": "Can we reuse the getLatestForkId here?", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r436844771", "createdAt": "2020-06-08T16:41:14Z", "author": {"login": "RatanRSur"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkIdManager.java", "diffHunk": "@@ -205,16 +230,20 @@ private static long createForkIds(\n     final CRC32 crc = new CRC32();\n     crc.update(genesisHash.toArray());\n     final List<Bytes> forkHashes = new ArrayList<>(List.of(getCurrentCrcHash(crc)));\n-    for (final Long fork : forks) {\n-      updateCrc(crc, fork);\n-      forkHashes.add(getCurrentCrcHash(crc));\n-    }\n+    final List<Long> filteredForks =\n+        forks.stream().filter(v -> v > 0).distinct().collect(Collectors.toUnmodifiableList());\n+    filteredForks.forEach(\n+        fork -> {\n+          updateCrc(crc, fork);\n+          forkHashes.add(getCurrentCrcHash(crc));\n+        });\n+\n     // This loop is for all the fork hashes that have an associated \"next fork\"\n-    for (int i = 0; i < forks.size(); i++) {\n-      forkIds.add(new ForkId(forkHashes.get(i), forks.get(i)));\n+    for (int i = 0; i < filteredForks.size(); i++) {\n+      forkIds.add(new ForkId(forkHashes.get(i), filteredForks.get(i)));\n     }\n     long forkNext = 0;\n-    if (!forks.isEmpty()) {\n+    if (!filteredForks.isEmpty()) {\n       forkNext = forkIds.get(forkIds.size() - 1).getNext();\n       forkIds.add(new ForkId(forkHashes.get(forkHashes.size() - 1), 0));\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "991c1d6c96bf23074b7c5e21534e2a5f2b424127"}, "originalPosition": 128}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e859dd2fa6d4f7149b66666750cb230f5351a8d2", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/e859dd2fa6d4f7149b66666750cb230f5351a8d2", "committedDate": "2020-06-08T16:47:52Z", "message": "Merge remote-tracking branch 'upstream/master' into 1044\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NDQzMDQ2", "url": "https://github.com/hyperledger/besu/pull/1050#pullrequestreview-426443046", "createdAt": "2020-06-08T17:06:58Z", "commit": {"oid": "e859dd2fa6d4f7149b66666750cb230f5351a8d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NDQ5NDc5", "url": "https://github.com/hyperledger/besu/pull/1050#pullrequestreview-426449479", "createdAt": "2020-06-08T17:14:49Z", "commit": {"oid": "e859dd2fa6d4f7149b66666750cb230f5351a8d2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a91f7837870b07f1d3db04bfa4ff701f7e2a1aa", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/1a91f7837870b07f1d3db04bfa4ff701f7e2a1aa", "committedDate": "2020-06-08T17:18:23Z", "message": "Address PR comments\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19081d5602722308acd5f39e0672a9990397ffe2", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/19081d5602722308acd5f39e0672a9990397ffe2", "committedDate": "2020-06-09T09:14:09Z", "message": "Refactor tests\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29f7e60a78d285f63bb564f33115eba8c1c8bbb7", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/29f7e60a78d285f63bb564f33115eba8c1c8bbb7", "committedDate": "2020-06-09T09:14:34Z", "message": "Merge remote-tracking branch 'upstream/master' into 1044\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c5cf8151b6e27bfbde25c4e41f50e831241a8ae", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/0c5cf8151b6e27bfbde25c4e41f50e831241a8ae", "committedDate": "2020-06-09T12:51:18Z", "message": "Refactor ForkIdManager\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MjMzODEz", "url": "https://github.com/hyperledger/besu/pull/1050#pullrequestreview-427233813", "createdAt": "2020-06-09T14:51:20Z", "commit": {"oid": "0c5cf8151b6e27bfbde25c4e41f50e831241a8ae"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNDo1MToyMFrOGhN-JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNDo1MToyMFrOGhN-JA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ4NTA5Mg==", "bodyText": "Is there a way to get this from the forkAndHashList? If I understand correctly we just need to filter out the hashes that are for forks past the chain head, right?", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r437485092", "createdAt": "2020-06-09T14:51:20Z", "author": {"login": "RatanRSur"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkIdManager.java", "diffHunk": "@@ -39,69 +36,58 @@\n   private final Hash genesisHash;\n   private final List<ForkId> forkAndHashList;\n \n-  private final List<Predicate<ForkId>> forkIDCheckers;\n+  private final List<Long> forks;\n+  private final LongSupplier chainHeadSupplier;\n+  private long lastHead;\n+  private ForkId lastComputedForkId;\n+  private final long forkNext;\n+  private final boolean onlyZerosForkBlocks;\n+  private final long highestKnownFork;\n \n-  public ForkIdManager(final Blockchain blockchain, final List<Long> forks) {\n+  public ForkIdManager(final Blockchain blockchain, final List<Long> nonFilteredForks) {\n     checkNotNull(blockchain);\n-    checkNotNull(forks);\n+    checkNotNull(nonFilteredForks);\n+    this.chainHeadSupplier = blockchain::getChainHeadBlockNumber;\n     this.genesisHash = blockchain.getGenesisBlock().getHash();\n     this.forkAndHashList = new ArrayList<>();\n-    final Predicate<ForkId> legacyForkIdChecker =\n-        createForkIDChecker(\n-            blockchain,\n-            genesisHash,\n-            forks,\n-            fs ->\n-                fs.stream()\n-                    .filter(fork -> fork > 0)\n-                    .distinct()\n-                    .collect(Collectors.toUnmodifiableList()),\n-            forkAndHashList);\n-    // if the fork list contains only zeros then we may be in a consortium/dev network\n-    if (onlyZerosForkBlocks(forks)) {\n-      this.forkIDCheckers = singletonList(forkId -> true);\n-    } else {\n-      final Predicate<ForkId> newForkIdChecker =\n-          createForkIDChecker(\n-              blockchain,\n-              genesisHash,\n-              forks,\n-              fs -> fs.stream().distinct().collect(Collectors.toUnmodifiableList()),\n-              new ArrayList<>());\n-      this.forkIDCheckers = Arrays.asList(newForkIdChecker, legacyForkIdChecker);\n-    }\n-  }\n-\n-  private static Predicate<ForkId> createForkIDChecker(\n-      final Blockchain blockchain,\n-      final Hash genesisHash,\n-      final List<Long> forks,\n-      final Function<List<Long>, List<Long>> sanitizer,\n-      final List<ForkId> forkIds) {\n-    final List<Long> sanitizedForks = sanitizer.apply(forks);\n-    final long forkNext = createForkIds(genesisHash, sanitizedForks, forkIds);\n-    return eip2124(blockchain, forkNext, forkIds, highestKnownFork(sanitizedForks));\n+    this.forks =\n+        nonFilteredForks.stream()\n+            .filter(fork -> fork > 0)\n+            .distinct()\n+            .sorted()\n+            .collect(Collectors.toUnmodifiableList());\n+    this.onlyZerosForkBlocks = nonFilteredForks.stream().allMatch(value -> 0L == value);\n+    this.forkNext = createForkIds();\n+    this.highestKnownFork = !forks.isEmpty() ? forks.get(forks.size() - 1) : 0L;\n   }\n \n-  private static boolean onlyZerosForkBlocks(final List<Long> forks) {\n-    return forks.stream().allMatch(value -> 0L == value);\n-  }\n+  public ForkId computeForkId() {\n+    final long head = chainHeadSupplier.getAsLong();\n+    if (lastHead != 0 && head == lastHead && lastComputedForkId != null) {\n+      return lastComputedForkId;\n+    }\n+    lastHead = head;\n \n-  private static long highestKnownFork(final List<Long> forks) {\n-    return !forks.isEmpty() ? forks.get(forks.size() - 1) : 0L;\n+    final CRC32 crc = new CRC32();\n+    long next = 0;\n+    crc.update(genesisHash.toArray());\n+    for (final Long fork : forks) {\n+      if (fork <= head) {\n+        updateCrc(crc, fork);\n+        continue;\n+      }\n+      next = fork;\n+      break;\n+    }\n+    lastComputedForkId = new ForkId(getCurrentCrcHash(crc), next);\n+    return lastComputedForkId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c5cf8151b6e27bfbde25c4e41f50e831241a8ae"}, "originalPosition": 117}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db09f7677652d3ad561b2f78746b98e796f277ad", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/db09f7677652d3ad561b2f78746b98e796f277ad", "committedDate": "2020-06-09T15:11:15Z", "message": "Simplify fork id computation\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3Mjg3MjUw", "url": "https://github.com/hyperledger/besu/pull/1050#pullrequestreview-427287250", "createdAt": "2020-06-09T15:34:11Z", "commit": {"oid": "0c5cf8151b6e27bfbde25c4e41f50e831241a8ae"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3Mjg1NDU2", "url": "https://github.com/hyperledger/besu/pull/1050#pullrequestreview-427285456", "createdAt": "2020-06-09T15:32:17Z", "commit": {"oid": "db09f7677652d3ad561b2f78746b98e796f277ad"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNTozMjoxN1rOGhQXBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNTozNDoyNVrOGhQdCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUyNDIyOQ==", "bodyText": "nit: java.lang.Long#reverseBytes is quicker and hotspot compiles faster.", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r437524229", "createdAt": "2020-06-09T15:32:17Z", "author": {"login": "shemnon"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkId.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth.manager;\n+\n+import org.hyperledger.besu.ethereum.rlp.BytesValueRLPOutput;\n+import org.hyperledger.besu.ethereum.rlp.RLPInput;\n+import org.hyperledger.besu.ethereum.rlp.RLPOutput;\n+import org.hyperledger.besu.util.EndianUtils;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.apache.tuweni.bytes.Bytes;\n+\n+public class ForkId {\n+  final Bytes hash;\n+  final Bytes next;\n+  Bytes forkIdRLP;\n+\n+  protected ForkId(final Bytes hash, final Bytes next) {\n+    this.hash = hash;\n+    this.next = next;\n+    createForkIdRLP();\n+  }\n+\n+  public ForkId(final Bytes hash, final long next) {\n+    this(hash, Bytes.wrap(EndianUtils.longToBigEndian(next)).trimLeadingZeros());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db09f7677652d3ad561b2f78746b98e796f277ad"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUyNTc2OQ==", "bodyText": "nit: we don't need this.  Integer and Long both have reerseBytes that can do this as HotSpot 'Intrinsic' methods, which means it goes straight to ASM when JITed.", "url": "https://github.com/hyperledger/besu/pull/1050#discussion_r437525769", "createdAt": "2020-06-09T15:34:25Z", "author": {"login": "shemnon"}, "path": "util/src/main/java/org/hyperledger/besu/util/EndianUtils.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.util;\n+\n+public class EndianUtils {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db09f7677652d3ad561b2f78746b98e796f277ad"}, "originalPosition": 17}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1574, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}