{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2NDgxOTM3", "number": 1018, "title": "Reintroduce consortium network friendly EIP-2124 fork id management.", "bodyText": "PR description\n#979 and #981 pull requests broke fork id management on some networks.\nHence, the consortium network friendly has been disabled. This PR reintroduces it by fixing the edge cases.\nTesting\n\n\n\nNetwork\nStatus\n\n\n\n\nmainnet\nOK\n\n\nropsten\nOK\n\n\ngoerli\nOK\n\n\nmordor\nOK\n\n\n\nFixed Issue(s)\nfixes #1002\nSigned-off-by: Abdelhamid Bakhta abdelhamid.bakhta@consensys.net", "createdAt": "2020-06-02T10:02:51Z", "url": "https://github.com/hyperledger/besu/pull/1018", "merged": true, "mergeCommit": {"oid": "9c37887df42f70e695cacb71c3ea2195c05c4c62"}, "closed": true, "closedAt": "2020-06-02T17:43:33Z", "author": {"login": "abdelhamidbakhta"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnQ0_CgH2gAyNDI2NDgxOTM3OjA4ZjM0YTgxZWZmMjAzODY4NzU3ZTVjNWVlYmVhZGE4ZGE0NjZlNDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnXu8MgH2gAyNDI2NDgxOTM3Ojk1YWU0NGQ1MjBmYWM2ZDkzNjkzYTZmNmE5OWMzMjY4YThmOWRjOGI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "08f34a81eff203868757e5c5eebeada8da466e40", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/08f34a81eff203868757e5c5eebeada8da466e40", "committedDate": "2020-06-02T08:45:29Z", "message": "Handle backward compatible fork id.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff72b54e5f3755391489988da48478569617c196", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/ff72b54e5f3755391489988da48478569617c196", "committedDate": "2020-06-02T09:56:13Z", "message": "Build fork id list no matter the network.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a83f2c43c3245290fbc0365560e06f74b50f16e6", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/a83f2c43c3245290fbc0365560e06f74b50f16e6", "committedDate": "2020-06-02T11:12:04Z", "message": "Merge remote-tracking branch 'upstream/master' into 1002\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNzUzOTYw", "url": "https://github.com/hyperledger/besu/pull/1018#pullrequestreview-422753960", "createdAt": "2020-06-02T14:46:24Z", "commit": {"oid": "a83f2c43c3245290fbc0365560e06f74b50f16e6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNDo0NjoyNFrOGd1NyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNDo0NjoyNFrOGd1NyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkzMzc2OQ==", "bodyText": "asserts do nothing unless explicitly enabled at runtime, and we never do that.  Perhaps you meant Preconditions.checkNotNull? (com.google.common.base.Preconditions)", "url": "https://github.com/hyperledger/besu/pull/1018#discussion_r433933769", "createdAt": "2020-06-02T14:46:24Z", "author": {"login": "shemnon"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkIdManager.java", "diffHunk": "@@ -30,22 +34,59 @@\n \n public class ForkIdManager {\n \n-  private final Blockchain blockchain;\n   private final Hash genesisHash;\n-  private final List<Long> forks;\n-  private long forkNext;\n-  private final long highestKnownFork;\n-  private List<ForkId> forkAndHashList;\n+  private final List<ForkId> forkAndHashList;\n+\n+  private final List<ForkIDChecker> forkIDCheckers;\n \n   public ForkIdManager(final Blockchain blockchain, final List<Long> forks) {\n-    this.blockchain = blockchain;\n+    assert blockchain != null && forks != null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a83f2c43c3245290fbc0365560e06f74b50f16e6"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyODA1NTg1", "url": "https://github.com/hyperledger/besu/pull/1018#pullrequestreview-422805585", "createdAt": "2020-06-02T15:37:12Z", "commit": {"oid": "a83f2c43c3245290fbc0365560e06f74b50f16e6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNTozNzoxMlrOGd3eOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNTozNzoxMlrOGd3eOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk3MDc0Ng==", "bodyText": "What happens if we have a few 0 forks but others greater than 0? Would we do the right thing?", "url": "https://github.com/hyperledger/besu/pull/1018#discussion_r433970746", "createdAt": "2020-06-02T15:37:12Z", "author": {"login": "RatanRSur"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkIdManager.java", "diffHunk": "@@ -30,22 +34,59 @@\n \n public class ForkIdManager {\n \n-  private final Blockchain blockchain;\n   private final Hash genesisHash;\n-  private final List<Long> forks;\n-  private long forkNext;\n-  private final long highestKnownFork;\n-  private List<ForkId> forkAndHashList;\n+  private final List<ForkId> forkAndHashList;\n+\n+  private final List<ForkIDChecker> forkIDCheckers;\n \n   public ForkIdManager(final Blockchain blockchain, final List<Long> forks) {\n-    this.blockchain = blockchain;\n+    assert blockchain != null && forks != null;\n     this.genesisHash = blockchain.getGenesisBlock().getHash();\n-    // de-dupe and sanitize forks\n-    this.forks =\n-        forks.stream().filter(fork -> fork > 0).distinct().collect(Collectors.toUnmodifiableList());\n-    highestKnownFork = forks.size() > 0 ? forks.get(forks.size() - 1) : 0L;\n-    createForkIds();\n-  };\n+    this.forkAndHashList = new ArrayList<>();\n+    final ForkIDChecker legacyForkIdChecker =\n+        createForkIDChecker(\n+            blockchain,\n+            genesisHash,\n+            forks,\n+            fs ->\n+                fs.stream()\n+                    .filter(fork -> fork > 0)\n+                    .distinct()\n+                    .collect(Collectors.toUnmodifiableList()),\n+            forkAndHashList);\n+    // if the fork list contains only zeros then we may be in a consortium/dev network\n+    if (onlyZerosForkBlocks(forks)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a83f2c43c3245290fbc0365560e06f74b50f16e6"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb667c6a6217c2a78a2dc7a538e3abd7c5460071", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/fb667c6a6217c2a78a2dc7a538e3abd7c5460071", "committedDate": "2020-06-02T15:42:43Z", "message": "Merge remote-tracking branch 'upstream/master' into 1002\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e1bb7c6dc1a2efc8913077a28d04f494cb114b1", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/4e1bb7c6dc1a2efc8913077a28d04f494cb114b1", "committedDate": "2020-06-02T15:47:24Z", "message": "Do not use assert\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyODE4MTMz", "url": "https://github.com/hyperledger/besu/pull/1018#pullrequestreview-422818133", "createdAt": "2020-06-02T15:47:46Z", "commit": {"oid": "a83f2c43c3245290fbc0365560e06f74b50f16e6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNTo0Nzo1OVrOGd4EBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNTo0Nzo1OVrOGd4EBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzk4MDQyMw==", "bodyText": "I suggest we put implements Predicate<ForkId> here so that we can get all the other Predicate methods for free", "url": "https://github.com/hyperledger/besu/pull/1018#discussion_r433980423", "createdAt": "2020-06-02T15:47:59Z", "author": {"login": "RatanRSur"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkIdManager.java", "diffHunk": "@@ -257,4 +316,9 @@ private static void intToBigEndian(final int n, final byte[] bs, int off) {\n     bs[++off] = (byte) (n >>> 8);\n     bs[++off] = (byte) (n);\n   }\n+\n+  @FunctionalInterface\n+  private interface ForkIDChecker {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e1bb7c6dc1a2efc8913077a28d04f494cb114b1"}, "originalPosition": 244}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32db91fdf060689bb42783f0fc289f74c0cdf057", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/32db91fdf060689bb42783f0fc289f74c0cdf057", "committedDate": "2020-06-02T15:53:45Z", "message": "Move to Predicate\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyODQyMjc4", "url": "https://github.com/hyperledger/besu/pull/1018#pullrequestreview-422842278", "createdAt": "2020-06-02T16:15:14Z", "commit": {"oid": "32db91fdf060689bb42783f0fc289f74c0cdf057"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95ae44d520fac6d93693a6f6a99c3268a8f9dc8b", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/95ae44d520fac6d93693a6f6a99c3268a8f9dc8b", "committedDate": "2020-06-02T16:48:13Z", "message": "Merge branch 'master' into 1002"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1552, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}