{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyOTM1MjQ4", "number": 1502, "title": "Update eth_estimateGas and eth_call RPC APIs for EIP1559 transaction", "bodyText": "Signed-off-by: Karim TAAM karim.t2am@gmail.com\nPR description\nMake eth_estimateGas compatible with EIP-1559 transactions. This change also impacts eth_call so I made it work for eth_call too\nCallParams has been modified (https://besu.hyperledger.org/en/stable/Reference/API-Objects/#transaction-call-object) :\nThere are two new optional fields for EIP1559 transactions. If one of the two is added the second must be too.\n\nfeeCap (optional & Wei)\ngasPremium (optional & Wei)\n\nNB : For non-EIP1559 transactions the calls  (eth_call, eth_estimateGas) work as before\n\n\nRequest eth_call (eip1559 transaction)\n\n{\"jsonrpc\":\"2.0\",\"method\":\"eth_call\",\"params\":[{\"feeCap\":\"0x10\", \"gasPremium\":\"0x10\", \"from\":\"0xFE3B557E8Fb62b89F4916B721be55cEb828dBd73\" , \"to\":\"0x89905dCF6c805Bfb69e91bAbc4596127c4F76Db3\", \"data\":\"0xcecdc6aa\"}, \"latest\"],\"id\":1} \n\nResponse\n\n{\n    \"jsonrpc\": \"2.0\",\n    \"id\": 1,\n    \"result\": \"0x9b82d2f38fbdf13006bfa741767f793d917e063392737837b580c1c2b1e0bab3\"\n}\n\n\nRequest eth_estimateGas (eip1559 transaction)\n\n{\"jsonrpc\":\"2.0\",\"method\":\"eth_estimateGas\",\"params\":[{\"feeCap\":\"0x100000\", \"gasPremium\":\"0x10000\", \"from\":\"fe3b557e8fb62b89f4916b721be55ceb828dbd73\",\"to\":\"0xdd37f65db31c107f773e82a4f85c693058fef7a9\",\"value\":\"0x1\"}, \"latest\"],\"id\":1}\n\nResponse\n\n{\n    \"jsonrpc\": \"2.0\",\n    \"id\": 1,\n    \"result\": \"0x5208\"\n}\nTest performed\n\n\nGoerli - Eth_EstimateGas (eip1559 and  legacy transaction)\n\n\nEIP1559 Testnet after the fork - Eth_EstimateGas (eip1559 and  legacy transaction)\n\n\nEIP1559 Testnet before the fork - Eth_EstimateGas (eip1559 and  legacy transaction)\n\n\nGoerli - Eth_Call (eip1559 and  legacy transaction)\n\n\nEIP1559 Testnet after the fork - Eth_Call (eip1559 and  legacy transaction)\n\n\nEIP1559 Testnet before the fork - Eth_Call (eip1559 and  legacy transaction)\n\n\nChangelog\n\n I thought about the changelog and included a changelog update if required.\n\nNot updated because EIP1559 is an experimental feature", "createdAt": "2020-10-30T11:33:28Z", "url": "https://github.com/hyperledger/besu/pull/1502", "merged": true, "mergeCommit": {"oid": "e6b6b1338b346bd63fc2eae4e71a34f41dbf0ddb"}, "closed": true, "closedAt": "2020-11-12T11:13:25Z", "author": {"login": "matkt"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXkne0AH2gAyNTEyOTM1MjQ4OjQ4OWYyNzRlOGYwZTUyN2I4ZGYwNjAzMTk3MDJmNzRjMTAyODZjOTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbvnxNAH2gAyNTEyOTM1MjQ4OjAyNjAxYWJkZTVkNzM0YjYzNDg2MjhhNWU3NGZjNTFiYTI0YjkxZTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "489f274e8f0e527b8df060319702f74c10286c95", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/489f274e8f0e527b8df060319702f74c10286c95", "committedDate": "2020-10-30T10:57:12Z", "message": "init eth_estimateGas for EIP1559 transaction\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f46fde48dec58827ca72774de69b9bc0108616c", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/9f46fde48dec58827ca72774de69b9bc0108616c", "committedDate": "2020-10-30T14:06:17Z", "message": "add validation for eip 1559 transaction\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26fdf379cb1a61c2a813b70e70dd6a453bbd591c", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/26fdf379cb1a61c2a813b70e70dd6a453bbd591c", "committedDate": "2020-10-30T14:16:37Z", "message": "Merge branch 'upstream/master' into feature/eth-estimate-gas-eip1559\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec2305201ac139e17bd838b73e359aab6695c5bc", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/ec2305201ac139e17bd838b73e359aab6695c5bc", "committedDate": "2020-10-30T15:41:20Z", "message": "Merge branch 'master' into feature/eth-estimate-gas-eip1559"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4edaef34527b40f1f443916f680948e088852bf2", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/4edaef34527b40f1f443916f680948e088852bf2", "committedDate": "2020-11-02T08:54:12Z", "message": "Merge branch 'master' into feature/eth-estimate-gas-eip1559"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNzk1MzIy", "url": "https://github.com/hyperledger/besu/pull/1502#pullrequestreview-521795322", "createdAt": "2020-11-02T16:33:01Z", "commit": {"oid": "4edaef34527b40f1f443916f680948e088852bf2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNjozMzowMVrOHsMG-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNjo0NjoyMVrOHsMsbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA5Nzc4NA==", "bodyText": "I think while we're here we might as well fix this issue of CallParams and JsonCallParams. Take a look at FilterParameter, that has non-string types but also has the properties to make it json serializable. If you want to make it a separate PR that works!", "url": "https://github.com/hyperledger/besu/pull/1502#discussion_r516097784", "createdAt": "2020-11-02T16:33:01Z", "author": {"login": "RatanRSur"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/methods/EthEstimateGas.java", "diffHunk": "@@ -91,6 +91,8 @@ private JsonCallParameter overrideGasLimitAndPrice(\n         callParams.getTo() != null ? callParams.getTo().toString() : null,\n         Quantity.create(gasLimit),\n         Quantity.create(0L),\n+        callParams.getGasPremium().map(Quantity::create).orElse(null),\n+        callParams.getFeeCap().map(Quantity::create).orElse(null),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4edaef34527b40f1f443916f680948e088852bf2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEwNjE3MQ==", "bodyText": "If process returns empty(), it could be that the world state is unavailable. As I read it, that means that we're sometimes giving the user INTERNAL_ERROR for world state unavailability and sometimes WORLD_STATE_UNAVAILABLE. Is that right?", "url": "https://github.com/hyperledger/besu/pull/1502#discussion_r516106171", "createdAt": "2020-11-02T16:44:41Z", "author": {"login": "RatanRSur"}, "path": "ethereum/api/src/test/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/methods/EthEstimateGasTest.java", "diffHunk": "@@ -94,8 +94,22 @@ public void shouldReturnErrorWhenTransientTransactionProcessorReturnsEmpty() {\n   }\n \n   @Test\n-  public void shouldReturnGasEstimateWhenTransientTransactionProcessorReturnsResultSuccess() {\n-    final JsonRpcRequestContext request = ethEstimateGasRequest(callParameter());\n+  public void shouldReturnErrorWhenTransientEip1559TransactionProcessorReturnsEmpty() {\n+    final JsonRpcRequestContext request = ethEstimateGasRequest(eip1559TransactionCallParameter());\n+    when(transactionSimulator.process(\n+            eq(modifiedEip1559TransactionCallParameter()), any(OperationTracer.class), eq(1L)))\n+        .thenReturn(Optional.empty());\n+\n+    final JsonRpcResponse expectedResponse =\n+        new JsonRpcErrorResponse(null, JsonRpcError.INTERNAL_ERROR);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4edaef34527b40f1f443916f680948e088852bf2"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjEwNzM3NQ==", "bodyText": "Is this tested anywhere?", "url": "https://github.com/hyperledger/besu/pull/1502#discussion_r516107375", "createdAt": "2020-11-02T16:46:21Z", "author": {"login": "RatanRSur"}, "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/MainnetTransactionValidator.java", "diffHunk": "@@ -102,6 +102,12 @@ public MainnetTransactionValidator(\n               String.format(\"gasPrice is less than the current BaseFee\"));\n         }\n       }\n+    } else if (transaction.isEIP1559Transaction()) {\n+      return ValidationResult.invalid(\n+          TransactionInvalidReason.INVALID_TRANSACTION_FORMAT,\n+          String.format(\n+              \"transaction format is invalid, accepted transaction types are %s\",\n+              acceptedTransactionTypes.toString()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4edaef34527b40f1f443916f680948e088852bf2"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a74552d4cb520aec3a97d4d32cba88ac472d37e", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/5a74552d4cb520aec3a97d4d32cba88ac472d37e", "committedDate": "2020-11-03T13:51:13Z", "message": "add missing test\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11a928016f4fdff438a33858ef1d1c209d8f59e7", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/11a928016f4fdff438a33858ef1d1c209d8f59e7", "committedDate": "2020-11-03T13:52:14Z", "message": "Merge\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fd13ee32592efc79738e420385a002462fa376b", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/9fd13ee32592efc79738e420385a002462fa376b", "committedDate": "2020-11-03T14:08:17Z", "message": "fix pipeline\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8eb1708de62eb564e35e58cdcec699e9ac9196b", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/f8eb1708de62eb564e35e58cdcec699e9ac9196b", "committedDate": "2020-11-05T10:34:03Z", "message": "Merge branch 'master' into feature/eth-estimate-gas-eip1559"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0Mzk1MDgx", "url": "https://github.com/hyperledger/besu/pull/1502#pullrequestreview-524395081", "createdAt": "2020-11-05T15:43:22Z", "commit": {"oid": "f8eb1708de62eb564e35e58cdcec699e9ac9196b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80fb218ffd7c07c9c8350539fe0bfa0e51088ba0", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/80fb218ffd7c07c9c8350539fe0bfa0e51088ba0", "committedDate": "2020-11-06T12:49:20Z", "message": "Merge branch 'master' into feature/eth-estimate-gas-eip1559"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdec89214c6f1efe2ad4be5c39fffa84128a453c", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/fdec89214c6f1efe2ad4be5c39fffa84128a453c", "committedDate": "2020-11-10T13:01:16Z", "message": "Merge branch 'master' into feature/eth-estimate-gas-eip1559"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9509228a6d92e8c2d15a737c0d5fcc7e7cbe435d", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/9509228a6d92e8c2d15a737c0d5fcc7e7cbe435d", "committedDate": "2020-11-12T09:10:12Z", "message": "Merge branch 'master' into feature/eth-estimate-gas-eip1559"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02601abde5d734b6348628a5e74fc51ba24b91e2", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/02601abde5d734b6348628a5e74fc51ba24b91e2", "committedDate": "2020-11-12T10:02:10Z", "message": "fix merge issue\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2044, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}