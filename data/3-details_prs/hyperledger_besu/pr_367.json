{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxMjc3MzY5", "number": 367, "title": "[BESU-169] cache logs bloom filters automatically.", "bodyText": "PR description\nLog index is generated either by starting Besu using the generate-log-bloom-cache CLI subcommand or by calling the admin_generatelogbloomcache RPC method.\nHowever, it seems necessary to make this call or run this subcommand every once a while to regenerate log index cache.\nA workaround is to have a cron task sending an RPC request to admin_generatelogbloomcache, but then the return result have to be stored to be used as parameters for the next call.\nIt then would be great to have Besu able to update the index cache by itself on a configurable schedule (every once x seconds, or every once x blocks, or automatically by letting Besu decide the best moment to update) and with an automatic management of the range to index (without the need of the two params the admin_generatelogbloomcache requires).\nFixed Issue(s)\n\n\nhttps://jira.hyperledger.org/browse/BESU-169\nDocumentation changes required\n\nAdded --auto-logs-bloom-indexing-enabled CLI option: Enable Automatic logs bloom indexing\n\nTODO\n\nImplement a hook to cache missing logs bloom at startup DONE\nImplement a hook to cache missing logs bloom on new block propagated. iterate over all previous segments to see if they are missing, trigger indexing if some are missing.  DONE\n\nSigned-off-by: Abdelhamid Bakhta abdelhamid.bakhta@consensys.net", "createdAt": "2020-02-05T09:51:49Z", "url": "https://github.com/hyperledger/besu/pull/367", "merged": true, "mergeCommit": {"oid": "6677362598716d4a4519b9095bacb41a5e3c955b"}, "closed": true, "closedAt": "2020-02-13T15:33:11Z", "author": {"login": "abdelhamidbakhta"}, "timelineItems": {"totalCount": 38, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBTB73gH2gAyMzcxMjc3MzY5OjY5NjMwNzFiYTdlZWEzYTBjNjM2NzUyZDY0MTc1OWYxOWE5ZjZiNTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcD7ge4AFqTM1ODI0MjI4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6963071ba7eea3a0c636752d641759f19a9f6b55", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/6963071ba7eea3a0c636752d641759f19a9f6b55", "committedDate": "2020-02-05T09:50:19Z", "message": "First iteration. Draft PR.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca62e34ad9f2421a1ba7f454e987cab804a136c1", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/ca62e34ad9f2421a1ba7f454e987cab804a136c1", "committedDate": "2020-02-05T13:24:02Z", "message": "fix SPDX header\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "388d0dcffa49a43ed47faedefd3b47410cd40c80", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/388d0dcffa49a43ed47faedefd3b47410cd40c80", "committedDate": "2020-02-05T17:32:55Z", "message": "Use block broadcaster to index log bloom.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94fccd4f122d7ab9418757dd41ce04fc6099ad6b", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/94fccd4f122d7ab9418757dd41ce04fc6099ad6b", "committedDate": "2020-02-05T17:34:15Z", "message": "Remove useless toString method\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "997c333d0714201fd753a5affefc2828624b5d61", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/997c333d0714201fd753a5affefc2828624b5d61", "committedDate": "2020-02-05T17:37:17Z", "message": "spotless apply\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3092ddca914aa6759d0228529d896ad08cd8ae87", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/3092ddca914aa6759d0228529d896ad08cd8ae87", "committedDate": "2020-02-05T19:35:02Z", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a29dcee1abee07fdbb5558b089b6138e2979bd27", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/a29dcee1abee07fdbb5558b089b6138e2979bd27", "committedDate": "2020-02-06T08:54:14Z", "message": "cacheLogsBloomForBlockHeader\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34fe368127f2f8375d7bd83473c72f4957801b96", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/34fe368127f2f8375d7bd83473c72f4957801b96", "committedDate": "2020-02-06T08:56:51Z", "message": "spotless apply\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3daa9a43d6e81d9234849228f77632bf07af75d7", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/3daa9a43d6e81d9234849228f77632bf07af75d7", "committedDate": "2020-02-07T13:17:41Z", "message": "ensurePreviousSegmentsArePresent\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "743448aea13040a0762310fad4f3599b6e5c2f52", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/743448aea13040a0762310fad4f3599b6e5c2f52", "committedDate": "2020-02-07T13:35:27Z", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7fbfdf5a71f71871533ab91afe5ce0d96d0647d", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/d7fbfdf5a71f71871533ab91afe5ce0d96d0647d", "committedDate": "2020-02-07T14:36:59Z", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34b1e50a19c446155ff2c4d6c89c64c60a8534ef", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/34b1e50a19c446155ff2c4d6c89c64c60a8534ef", "committedDate": "2020-02-07T16:55:26Z", "message": "Added CLI flag to enable / disable automatic logs bloom indexing.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "026d53f45e0cd53529dffee747d0b7a8daa4b3c2", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/026d53f45e0cd53529dffee747d0b7a8daa4b3c2", "committedDate": "2020-02-10T07:51:05Z", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f545f708fc3cf30dd39b178427875ee11153e7a7", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/f545f708fc3cf30dd39b178427875ee11153e7a7", "committedDate": "2020-02-10T09:11:46Z", "message": "Create cache directory and cache file if not exist.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb48fec2d60d52ae3f8244288450a73b5a5390bb", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/eb48fec2d60d52ae3f8244288450a73b5a5390bb", "committedDate": "2020-02-10T09:42:03Z", "message": "Fix acceptance test\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c7a20c91ac8b8d43a831a7ff60e123ada871171", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/4c7a20c91ac8b8d43a831a7ff60e123ada871171", "committedDate": "2020-02-11T08:11:55Z", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec42713e0ca788308ce3a2be7def86dea786f06e", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/ec42713e0ca788308ce3a2be7def86dea786f06e", "committedDate": "2020-02-11T08:23:40Z", "message": "Write cache for block only if block is new canonical head.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18f1a22fe033a608f3ad99fa365752b42c7bd296", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/18f1a22fe033a608f3ad99fa365752b42c7bd296", "committedDate": "2020-02-12T08:42:17Z", "message": "Handling of chain reorg.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84614213fdc59bca9fb0e2cc1a825de745f27a8d", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/84614213fdc59bca9fb0e2cc1a825de745f27a8d", "committedDate": "2020-02-12T08:47:25Z", "message": "fix\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc65af99c4eddf0478a27ed23d5d1e306253c40b", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/bc65af99c4eddf0478a27ed23d5d1e306253c40b", "committedDate": "2020-02-12T08:53:11Z", "message": "sportless apply\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a3c988224dd40fdf63c2e07987cede3702e466f", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/8a3c988224dd40fdf63c2e07987cede3702e466f", "committedDate": "2020-02-12T16:53:15Z", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a6861a64065f58de8a96ef2574820517743d838", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/3a6861a64065f58de8a96ef2574820517743d838", "committedDate": "2020-02-12T16:22:58Z", "message": "Merge branch 'master' into besu-169/auto-log-indexing"}, "afterCommit": {"oid": "8a3c988224dd40fdf63c2e07987cede3702e466f", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/8a3c988224dd40fdf63c2e07987cede3702e466f", "committedDate": "2020-02-12T16:53:15Z", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd468ecb4b773bd7dcff9617183eb9d428f3e02a", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/cd468ecb4b773bd7dcff9617183eb9d428f3e02a", "committedDate": "2020-02-12T17:32:23Z", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cd0985b0c9f1565f054d7d1a6c7f7f0fa1fa026", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/2cd0985b0c9f1565f054d7d1a6c7f7f0fa1fa026", "committedDate": "2020-02-12T17:53:57Z", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d6efc35046e024222e9abce128f0942a49aba2b", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/3d6efc35046e024222e9abce128f0942a49aba2b", "committedDate": "2020-02-12T18:06:18Z", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3ODA5NjU1", "url": "https://github.com/hyperledger/besu/pull/367#pullrequestreview-357809655", "createdAt": "2020-02-12T21:44:00Z", "commit": {"oid": "3d6efc35046e024222e9abce128f0942a49aba2b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3ODI4ODEx", "url": "https://github.com/hyperledger/besu/pull/367#pullrequestreview-357828811", "createdAt": "2020-02-12T22:16:05Z", "commit": {"oid": "3d6efc35046e024222e9abce128f0942a49aba2b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQyMjoxNjowNVrOFpAiag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQyMjoxODoyNFrOFpAmFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0NDc0Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                params.add(\"--auto-logs-bloom-indexing-enabled\");\n          \n          \n            \n                params.add(\"--auto-log-bloom-caching-enabled\");", "url": "https://github.com/hyperledger/besu/pull/367#discussion_r378544746", "createdAt": "2020-02-12T22:16:05Z", "author": {"login": "shemnon"}, "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java", "diffHunk": "@@ -257,6 +257,9 @@ public void startNode(final BesuNode node) {\n     params.add(\"--key-value-storage\");\n     params.add(\"rocksdb\");\n \n+    params.add(\"--auto-logs-bloom-indexing-enabled\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d6efc35046e024222e9abce128f0942a49aba2b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0NTY4Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .autoLogsBloomIndexing(false)\n          \n          \n            \n                        .autoLogBloomCaching(false)", "url": "https://github.com/hyperledger/besu/pull/367#discussion_r378545686", "createdAt": "2020-02-12T22:18:24Z", "author": {"login": "shemnon"}, "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ThreadBesuNodeRunner.java", "diffHunk": "@@ -195,6 +195,7 @@ public void startNode(final BesuNode node) {\n                     .map(EnodeURL::fromString)\n                     .collect(Collectors.toList()))\n             .besuPluginContext(new BesuPluginContextImpl())\n+            .autoLogsBloomIndexing(false)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d6efc35046e024222e9abce128f0942a49aba2b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3ODg4NDIy", "url": "https://github.com/hyperledger/besu/pull/367#pullrequestreview-357888422", "createdAt": "2020-02-13T00:43:53Z", "commit": {"oid": "3d6efc35046e024222e9abce128f0942a49aba2b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwMDo0Mzo1NFrOFpDjhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwMDo0Mzo1NFrOFpDjhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU5NDE4Mg==", "bodyText": "This should be debug - it happens way too often.", "url": "https://github.com/hyperledger/besu/pull/367#discussion_r378594182", "createdAt": "2020-02-13T00:43:54Z", "author": {"login": "shemnon"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/query/TransactionLogsIndexer.java", "diffHunk": "@@ -117,16 +128,68 @@ private long fillCacheFile(\n       if (maybeHeader.isEmpty()) {\n         break;\n       }\n-      final byte[] logs = maybeHeader.get().getLogsBloom().toArray();\n-      checkNotNull(logs);\n-      checkState(logs.length == 256, \"BloomBits are not the correct length\");\n-      fos.write(logs);\n+      fillCacheFileWithBlock(maybeHeader.get(), fos);\n       indexingStatus.currentBlock = blockNum;\n       blockNum++;\n     }\n     return blockNum - startBlock;\n   }\n \n+  public void cacheLogsBloomForBlockHeader(final BlockHeader blockHeader) {\n+    try {\n+      final long blockNumber = blockHeader.getNumber();\n+      LOG.info(\"Caching logs bloom for block {}.\", \"0x\" + Long.toHexString(blockNumber));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d6efc35046e024222e9abce128f0942a49aba2b"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3ODkyNzYx", "url": "https://github.com/hyperledger/besu/pull/367#pullrequestreview-357892761", "createdAt": "2020-02-13T00:57:04Z", "commit": {"oid": "3d6efc35046e024222e9abce128f0942a49aba2b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwMDo1NzowNFrOFpD0MQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwMDo1NzowNFrOFpD0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU5ODQ0OQ==", "bodyText": "This can result in indexing running twice... perhaps ensurePreviousSegmentsArePresent(blockchain.getChainHeadBlockNumber());?", "url": "https://github.com/hyperledger/besu/pull/367#discussion_r378598449", "createdAt": "2020-02-13T00:57:04Z", "author": {"login": "shemnon"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/query/TransactionLogsIndexer.java", "diffHunk": "@@ -60,6 +67,10 @@ public TransactionLogsIndexer(\n     this.scheduler = scheduler;\n   }\n \n+  public IndexingStatus indexAll() {\n+    return generateLogBloomCache(0, Long.MAX_VALUE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d6efc35046e024222e9abce128f0942a49aba2b"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3ODk0NjEw", "url": "https://github.com/hyperledger/besu/pull/367#pullrequestreview-357894610", "createdAt": "2020-02-13T01:03:02Z", "commit": {"oid": "3d6efc35046e024222e9abce128f0942a49aba2b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwMTowMzowMlrOFpD59A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwMTowMzowMlrOFpD59A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU5OTkyNA==", "bodyText": "I think we should track what segments we have made in a list or tree map.  Check the map before going to disk.", "url": "https://github.com/hyperledger/besu/pull/367#discussion_r378599924", "createdAt": "2020-02-13T01:03:02Z", "author": {"login": "shemnon"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/query/TransactionLogsIndexer.java", "diffHunk": "@@ -117,16 +128,68 @@ private long fillCacheFile(\n       if (maybeHeader.isEmpty()) {\n         break;\n       }\n-      final byte[] logs = maybeHeader.get().getLogsBloom().toArray();\n-      checkNotNull(logs);\n-      checkState(logs.length == 256, \"BloomBits are not the correct length\");\n-      fos.write(logs);\n+      fillCacheFileWithBlock(maybeHeader.get(), fos);\n       indexingStatus.currentBlock = blockNum;\n       blockNum++;\n     }\n     return blockNum - startBlock;\n   }\n \n+  public void cacheLogsBloomForBlockHeader(final BlockHeader blockHeader) {\n+    try {\n+      final long blockNumber = blockHeader.getNumber();\n+      LOG.info(\"Caching logs bloom for block {}.\", \"0x\" + Long.toHexString(blockNumber));\n+      ensurePreviousSegmentsArePresent(blockNumber);\n+      final File cacheFile = calculateCacheFileName(blockNumber, cacheDir);\n+      if (!cacheFile.exists()) {\n+        Files.createFile(cacheFile.toPath());\n+      }\n+      try (RandomAccessFile writer = new RandomAccessFile(cacheFile, \"rw\")) {\n+        final long offset = (blockNumber / BLOCKS_PER_BLOOM_CACHE) * BLOOM_BITS_LENGTH;\n+        writer.seek(offset);\n+        writer.write(ensureBloomBitsAreCorrectLength(blockHeader.getLogsBloom().toArray()));\n+      }\n+    } catch (IOException e) {\n+      LOG.error(\"Unhandled indexing exception.\", e);\n+    }\n+  }\n+\n+  private void ensurePreviousSegmentsArePresent(final long blockNumber) {\n+    scheduler.scheduleFutureTask(\n+        () -> {\n+          long currentSegment = (blockNumber / BLOCKS_PER_BLOOM_CACHE) - 1;\n+          while (currentSegment > 0) {\n+            try {\n+              if (!isCachePresentForSegment(currentSegment)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d6efc35046e024222e9abce128f0942a49aba2b"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3ODk0OTI0", "url": "https://github.com/hyperledger/besu/pull/367#pullrequestreview-357894924", "createdAt": "2020-02-13T01:03:59Z", "commit": {"oid": "3d6efc35046e024222e9abce128f0942a49aba2b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwMTowNDowMFrOFpD65g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwMTowNDowMFrOFpD65g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODYwMDE2Ng==", "bodyText": "We should check indexing status before submitting the work.", "url": "https://github.com/hyperledger/besu/pull/367#discussion_r378600166", "createdAt": "2020-02-13T01:04:00Z", "author": {"login": "shemnon"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/query/TransactionLogsIndexer.java", "diffHunk": "@@ -117,16 +128,68 @@ private long fillCacheFile(\n       if (maybeHeader.isEmpty()) {\n         break;\n       }\n-      final byte[] logs = maybeHeader.get().getLogsBloom().toArray();\n-      checkNotNull(logs);\n-      checkState(logs.length == 256, \"BloomBits are not the correct length\");\n-      fos.write(logs);\n+      fillCacheFileWithBlock(maybeHeader.get(), fos);\n       indexingStatus.currentBlock = blockNum;\n       blockNum++;\n     }\n     return blockNum - startBlock;\n   }\n \n+  public void cacheLogsBloomForBlockHeader(final BlockHeader blockHeader) {\n+    try {\n+      final long blockNumber = blockHeader.getNumber();\n+      LOG.info(\"Caching logs bloom for block {}.\", \"0x\" + Long.toHexString(blockNumber));\n+      ensurePreviousSegmentsArePresent(blockNumber);\n+      final File cacheFile = calculateCacheFileName(blockNumber, cacheDir);\n+      if (!cacheFile.exists()) {\n+        Files.createFile(cacheFile.toPath());\n+      }\n+      try (RandomAccessFile writer = new RandomAccessFile(cacheFile, \"rw\")) {\n+        final long offset = (blockNumber / BLOCKS_PER_BLOOM_CACHE) * BLOOM_BITS_LENGTH;\n+        writer.seek(offset);\n+        writer.write(ensureBloomBitsAreCorrectLength(blockHeader.getLogsBloom().toArray()));\n+      }\n+    } catch (IOException e) {\n+      LOG.error(\"Unhandled indexing exception.\", e);\n+    }\n+  }\n+\n+  private void ensurePreviousSegmentsArePresent(final long blockNumber) {\n+    scheduler.scheduleFutureTask(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d6efc35046e024222e9abce128f0942a49aba2b"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3ODk1MzY3", "url": "https://github.com/hyperledger/besu/pull/367#pullrequestreview-357895367", "createdAt": "2020-02-13T01:05:16Z", "commit": {"oid": "3d6efc35046e024222e9abce128f0942a49aba2b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3ODk1ODk0", "url": "https://github.com/hyperledger/besu/pull/367#pullrequestreview-357895894", "createdAt": "2020-02-13T01:06:57Z", "commit": {"oid": "3d6efc35046e024222e9abce128f0942a49aba2b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "393dddbc99b8635948f2ce13ebeb095d9119e877", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/393dddbc99b8635948f2ce13ebeb095d9119e877", "committedDate": "2020-02-13T08:01:33Z", "message": "Merge remote-tracking branch 'upstream/master' into besu-169/auto-log-indexing\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8d2a711c90d3fb24e3ec40f0cedc00a528c4fac", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/d8d2a711c90d3fb24e3ec40f0cedc00a528c4fac", "committedDate": "2020-02-13T08:17:08Z", "message": "Address PR comments.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb1facf87fd34badf59e09792716ac255a099f5e", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/eb1facf87fd34badf59e09792716ac255a099f5e", "committedDate": "2020-02-13T08:20:12Z", "message": "Remove unused constant.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "275ab563f17d4c331db26c96eab589b16dffd120", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/275ab563f17d4c331db26c96eab589b16dffd120", "committedDate": "2020-02-13T08:24:44Z", "message": "spotless apply\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MjQyMjg3", "url": "https://github.com/hyperledger/besu/pull/367#pullrequestreview-358242287", "createdAt": "2020-02-13T14:07:45Z", "commit": {"oid": "275ab563f17d4c331db26c96eab589b16dffd120"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1932, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}