{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0OTQ2MDk4", "number": 1345, "title": "Ignore accept header in requests to metrics service", "bodyText": "PR description\nThe metrics HTTP service only has one supported representation for content but is applying overly strict content type negotiation and refusing to return any content if the Accept header is present and set to anything other than text/plain; version=0.0.4; charset=utf-8.  This makes it incompatible with tools like DataDog which specify Accept: text/plain.\nFixed Issue(s)\nConsenSys/teku#2678\nChangelog\n\n I thought about the changelog and included a changelog update if required.", "createdAt": "2020-08-27T20:59:41Z", "url": "https://github.com/hyperledger/besu/pull/1345", "merged": true, "mergeCommit": {"oid": "80173d6fe62156013bf7b884c7b2882a059c67da"}, "closed": true, "closedAt": "2020-08-27T22:12:39Z", "author": {"login": "ajsutton"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDGzXygH2gAyNDc0OTQ2MDk4OjVkOGY5NTk2NjU0MDRhYmE5YTZhMzg0NzgwYWY3NDVjOGNjZTVlMGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDHrkeAH2gAyNDc0OTQ2MDk4OmZlMTM0MDhkZjNjOWIwMDkwOWQ1ZGNiY2I0YTllZjg2YWFmNjQzZmY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5d8f959665404aba9a6a384780af745c8cce5e0e", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/hyperledger/besu/commit/5d8f959665404aba9a6a384780af745c8cce5e0e", "committedDate": "2020-08-27T20:54:33Z", "message": "Ignore accept header in requests to metrics service.\n\nSigned-off-by: Adrian Sutton <adrian.sutton@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d69d709cc6e78f1b06c8e4d13bf63a43c84880f0", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/hyperledger/besu/commit/d69d709cc6e78f1b06c8e4d13bf63a43c84880f0", "committedDate": "2020-08-27T20:59:59Z", "message": "Add changelog.\n\nSigned-off-by: Adrian Sutton <adrian.sutton@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d2dc7e91fb81353f7d693e2758f2f979749026f", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/hyperledger/besu/commit/1d2dc7e91fb81353f7d693e2758f2f979749026f", "committedDate": "2020-08-27T21:06:27Z", "message": "Spotless.\n\nSigned-off-by: Adrian Sutton <adrian.sutton@consensys.net>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "027cc2afef0538b14cbac468a2cfe66b18588f20", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/hyperledger/besu/commit/027cc2afef0538b14cbac468a2cfe66b18588f20", "committedDate": "2020-08-27T21:06:08Z", "message": "Spotless."}, "afterCommit": {"oid": "1d2dc7e91fb81353f7d693e2758f2f979749026f", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/hyperledger/besu/commit/1d2dc7e91fb81353f7d693e2758f2f979749026f", "committedDate": "2020-08-27T21:06:27Z", "message": "Spotless.\n\nSigned-off-by: Adrian Sutton <adrian.sutton@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MDk3MDMx", "url": "https://github.com/hyperledger/besu/pull/1345#pullrequestreview-477097031", "createdAt": "2020-08-27T21:28:43Z", "commit": {"oid": "1d2dc7e91fb81353f7d693e2758f2f979749026f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MTAxODU4", "url": "https://github.com/hyperledger/besu/pull/1345#pullrequestreview-477101858", "createdAt": "2020-08-27T21:37:21Z", "commit": {"oid": "1d2dc7e91fb81353f7d693e2758f2f979749026f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMTozNzoyMVrOHIiIeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMTozOTo0N1rOHIiMyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcwOTg4MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                  // Assert we still get the Content-Type Prometheus likes\n          \n          \n            \n                  assertThat(resp.header(\"Content-Type\")).isEqualTo(TextFormat.CONTENT_TYPE_004);\n          \n          \n            \n                }\n          \n      \n    \n    \n  \n\nYou will also need import io.prometheus.client.exporter.common.TextFormat; but GitHub won't let me suggest that far our of the code diff.", "url": "https://github.com/hyperledger/besu/pull/1345#discussion_r478709881", "createdAt": "2020-08-27T21:37:21Z", "author": {"login": "shemnon"}, "path": "metrics/core/src/test/java/org/hyperledger/besu/metrics/prometheus/MetricsHttpServiceTest.java", "diffHunk": "@@ -174,6 +174,22 @@ public void metricsAreAbsentWhenFiltered() throws Exception {\n     }\n   }\n \n+  @Test\n+  // There is only one available representation so content negotiation should not be used\n+  public void acceptHeaderIgnored() throws Exception {\n+    final Request metricsRequest =\n+        new Request.Builder().addHeader(\"Accept\", \"text/xml\").url(baseUrl + \"/metrics\").build();\n+    try (final Response resp = client.newCall(metricsRequest).execute()) {\n+      assertThat(resp.code()).isEqualTo(200);\n+      // Check general format of result, it maps to java.util.Properties\n+      final Properties props = new Properties();\n+      props.load(resp.body().byteStream());\n+\n+      // We should have JVM metrics already loaded, verify a simple key.\n+      assertThat(props).containsKey(\"jvm_threads_deadlocked\");\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d2dc7e91fb81353f7d693e2758f2f979749026f"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcxMDk4Nw==", "bodyText": "Maybe just check for \"text/plain\" instead of completely dropping Prometheus' very specific version?", "url": "https://github.com/hyperledger/besu/pull/1345#discussion_r478710987", "createdAt": "2020-08-27T21:39:47Z", "author": {"login": "shemnon"}, "path": "metrics/core/src/main/java/org/hyperledger/besu/metrics/prometheus/MetricsHttpService.java", "diffHunk": "@@ -91,11 +91,7 @@ private void validateConfig(final MetricsConfiguration config) {\n     router.route(\"/\").method(HttpMethod.GET).handler(this::handleEmptyRequest);\n \n     // Endpoint for Prometheus metrics monitoring.\n-    router\n-        .route(\"/metrics\")\n-        .method(HttpMethod.GET)\n-        .produces(TextFormat.CONTENT_TYPE_004)\n-        .handler(this::metricsRequest);\n+    router.route(\"/metrics\").method(HttpMethod.GET).handler(this::metricsRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d2dc7e91fb81353f7d693e2758f2f979749026f"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe13408df3c9b00909d5dcbcb4a9ef86aaf643ff", "author": {"user": {"login": "ajsutton", "name": "Adrian Sutton"}}, "url": "https://github.com/hyperledger/besu/commit/fe13408df3c9b00909d5dcbcb4a9ef86aaf643ff", "committedDate": "2020-08-27T21:55:56Z", "message": "Add assertion that Content-Type is still set.\n\nSigned-off-by: Adrian Sutton <adrian.sutton@consensys.net>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1473, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}