{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2Njk5NzQw", "number": 904, "title": "Update transaction pool error handling.", "bodyText": "Description\nTransactions added locally into the pool via eth_sendRawTransaction can now generate 2 new JSON RPC errors:\n\nETH_SEND_TX_ALREADY_KNOWN: occurs when adding a transaction already present in the pool.\n\ncode: -32000\nmessage: Known Transaction\n\n\nETH_SEND_TX_REPLACEMENT_UNDERPRICED: occurs when the gas price of the new transaction is too low to replace the old transaction.\n\ncode: -32000\nmessage: Replacement transaction underpriced\n\n\n\nChanges summary\n\nCreated TransactionAddedStatus enum.\n\nALREADY_KNOWN\nREJECTED_UNDERPRICED_REPLACEMENT\nADDED\n\n\nCreated 2 new errors in JsonRpcError.\nUpdated JsonRpcErrorConverter to handle newly created errors.\nUpdated addLocalTransaction method of PendingTransactions to return TransactionAddedStatus instead of boolean.\nUpdated unit tests accordingly.\n\nSample\nAlready known transaction\nScenario\n\nCall eth_sendRawTransaction with transaction nonce=1 and gas price=1000\nCall eth_sendRawTransaction with transaction nonce=1 and gas price=1000\n\nExpected output:\n{\n  \"jsonrpc\": \"2.0\",\n  \"id\": 1,\n  \"error\": {\n    \"code\": -32000,\n    \"message\": \"Known transaction\"\n  }\n}\nReplacement underpriced\nScenario\n\nCall eth_sendRawTransaction with transaction nonce=1 and gas price=1100\nCall eth_sendRawTransaction with transaction nonce=1 and gas price=1050\n\nExpected output:\n{\n  \"jsonrpc\": \"2.0\",\n  \"id\": 1,\n  \"error\": {\n    \"code\": -32000,\n    \"message\": \"Replacement transaction underpriced\"\n  }\n}\nIssues\nfixes #559\nSigned-off-by: Abdelhamid Bakhta abdelhamid.bakhta@consensys.net", "createdAt": "2020-05-12T12:41:41Z", "url": "https://github.com/hyperledger/besu/pull/904", "merged": true, "mergeCommit": {"oid": "167679e9fa05537bff4f2ff82b47108398048c16"}, "closed": true, "closedAt": "2020-05-12T14:26:01Z", "author": {"login": "abdelhamidbakhta"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgjk2PgH2gAyNDE2Njk5NzQwOjAzMTMyNTllOGJkZGI2NGRkNDZhYmRlOWM0MDI4ZmE4ZmY1ZWYxZDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgkoqFgFqTQxMDA2Mzk4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0313259e8bddb64dd46abde9c4028fa8ff5ef1d9", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/0313259e8bddb64dd46abde9c4028fa8ff5ef1d9", "committedDate": "2020-05-12T12:38:35Z", "message": "Update transaction pool error handling.\nTransactions added locally into the pool via `eth_sendRawTransaction` can now generate 2 new JSON RPC errors:\n- `ETH_SEND_TX_ALREADY_KNOWN`: occurs when adding a transaction already present in the pool.\n    - code: -32000\n    - message: `Known Transaction`\n- `ETH_SEND_TX_REPLACEMENT_UNDERPRICED`: occurs when adding a transaction already present in the pool.\n    - code: -32000\n    - message: `Replacement transaction underpriced`\n\n### Changes summary\n- Created `TransactionAddedStatus` enum.\n    - `ALREADY_KNOWN`\n    - `REJECTED_UNDERPRICED_REPLACEMENT`\n    - `ADDED`\n- Created 2 new errors in `JsonRpcError`.\n- Updated JsonRpcErrorConverter to handle newly created errors.\n- Updated `addLocalTransaction` method of `PendingTransactions` to return `TransactionAddedStatus` instead of boolean.\n- Updated unit tests accordingly.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8c4a3682d698537a60b058ecb7448f5e6ba7fb1", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/a8c4a3682d698537a60b058ecb7448f5e6ba7fb1", "committedDate": "2020-05-12T13:37:39Z", "message": "Address PR comment.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMDUyNjE1", "url": "https://github.com/hyperledger/besu/pull/904#pullrequestreview-410052615", "createdAt": "2020-05-12T13:41:14Z", "commit": {"oid": "0313259e8bddb64dd46abde9c4028fa8ff5ef1d9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMzo0MToxNFrOGUHKMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMzo0MjoxOFrOGUHNQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc0MjAwMA==", "bodyText": "I think it would be better to use optional rather than putting a null. What do you think ?", "url": "https://github.com/hyperledger/besu/pull/904#discussion_r423742000", "createdAt": "2020-05-12T13:41:14Z", "author": {"login": "matkt"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactions.java", "diffHunk": "@@ -435,4 +442,20 @@ public Instant getAddedToPoolAt() {\n \n     TransactionSelectionResult evaluateTransaction(final Transaction transaction);\n   }\n+\n+  public enum TransactionAddedStatus {\n+    ALREADY_KNOWN(TransactionInvalidReason.TRANSACTION_ALREADY_KNOWN),\n+    REJECTED_UNDERPRICED_REPLACEMENT(TransactionInvalidReason.TRANSACTION_REPLACEMENT_UNDERPRICED),\n+    ADDED(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0313259e8bddb64dd46abde9c4028fa8ff5ef1d9"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc0Mjc4Ng==", "bodyText": "We can use a variable to avoid doing the equals twice", "url": "https://github.com/hyperledger/besu/pull/904#discussion_r423742786", "createdAt": "2020-05-12T13:42:18Z", "author": {"login": "matkt"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactions.java", "diffHunk": "@@ -130,11 +134,11 @@ public void evictOldTransactions() {\n   public boolean addRemoteTransaction(final Transaction transaction) {\n     final TransactionInfo transactionInfo =\n         new TransactionInfo(transaction, false, clock.instant());\n-    final boolean transactionAdded = addTransaction(transactionInfo);\n-    if (transactionAdded) {\n+    final TransactionAddedStatus transactionAddedStatus = addTransaction(transactionInfo);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0313259e8bddb64dd46abde9c4028fa8ff5ef1d9"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db0449fb43d37d36ac85695321ac526013f8ad9f", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/db0449fb43d37d36ac85695321ac526013f8ad9f", "committedDate": "2020-05-12T13:50:42Z", "message": "Changed nullable value to optional.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMDYzOTgy", "url": "https://github.com/hyperledger/besu/pull/904#pullrequestreview-410063982", "createdAt": "2020-05-12T13:52:39Z", "commit": {"oid": "db0449fb43d37d36ac85695321ac526013f8ad9f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1631, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}