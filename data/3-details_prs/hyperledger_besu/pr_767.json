{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3NDExMDYy", "number": 767, "title": "Add regular logs to filters straight from BlockAddedEvent. Still use `privacyQueries` for private logs", "bodyText": "PR description\n@pinges correctly pointed out that, even though we have access to all the logs in the BlockAddedEvent, we still use BlockchainQueries to add the new logs from the event. Now we do the sane thing.\nUnfortunately, it doesn't seem as easy with private logs so we still have to use privacyQueries as far as I can tell.", "createdAt": "2020-04-22T16:46:10Z", "url": "https://github.com/hyperledger/besu/pull/767", "merged": true, "mergeCommit": {"oid": "fa430452f15c798d7770c8e7bb7f9570b66fbbfe"}, "closed": true, "closedAt": "2020-04-23T22:32:27Z", "author": {"login": "RatanRSur"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaK7fygH2gAyNDA3NDExMDYyOmQ4N2JlZDNjNGY1YTYwZDkxODAzYWY3MTFhMjU5OGQzZmQ0ZTA0ZTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcakmJrAFqTM5OTUyMDE3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d87bed3c4f5a60d91803af711a2598d3fd4e04e2", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/d87bed3c4f5a60d91803af711a2598d3fd4e04e2", "committedDate": "2020-04-22T16:32:09Z", "message": "use logs from event directly instead of going to disk\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4MzkxMTA1", "url": "https://github.com/hyperledger/besu/pull/767#pullrequestreview-398391105", "createdAt": "2020-04-22T16:57:59Z", "commit": {"oid": "d87bed3c4f5a60d91803af711a2598d3fd4e04e2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNjo1ODowMFrOGKA6Sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNjo1ODowMFrOGKA6Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE1Mzg2Ng==", "bodyText": "I see that it is not being used by the method, but why the underscore variable name? Is it just how you are denoting that it is not used?", "url": "https://github.com/hyperledger/besu/pull/767#discussion_r413153866", "createdAt": "2020-04-22T16:58:00Z", "author": {"login": "davemec"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/filter/FilterManager.java", "diffHunk": "@@ -151,28 +152,28 @@ public boolean uninstallFilter(final String filterId) {\n     }\n   }\n \n-  public void recordBlockEvent(final BlockAddedEvent event, final Blockchain blockchain) {\n+  public void recordBlockEvent(final BlockAddedEvent event, final Blockchain __) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d87bed3c4f5a60d91803af711a2598d3fd4e04e2"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4e28ec7572c0b4e35e193b6ffb49e3bec194e5c", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/f4e28ec7572c0b4e35e193b6ffb49e3bec194e5c", "committedDate": "2020-04-22T21:38:44Z", "message": "test changes\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3150a77f87b9eed331b95f52bc40101f8909268e", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/3150a77f87b9eed331b95f52bc40101f8909268e", "committedDate": "2020-04-22T21:38:44Z", "message": "rename\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdfb6b19e592f1e4d88c8515c507271bdc7c455a", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/fdfb6b19e592f1e4d88c8515c507271bdc7c455a", "committedDate": "2020-04-22T21:38:44Z", "message": "reinstate querying for private txs\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "451b733cebcde544a197ba5d9d97a95fb2367910", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/451b733cebcde544a197ba5d9d97a95fb2367910", "committedDate": "2020-04-22T21:39:47Z", "message": "spotless\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3f97653f6f18d1d42e780420c77b06b9c81970d", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/c3f97653f6f18d1d42e780420c77b06b9c81970d", "committedDate": "2020-04-22T21:42:34Z", "message": "comment\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3745c6acb93073e86e0f31ed26c4716f42df2651", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/3745c6acb93073e86e0f31ed26c4716f42df2651", "committedDate": "2020-04-22T21:43:55Z", "message": "unused method\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6da3ffedbc50a4537a80fe88a3c0981ef700afcb", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/6da3ffedbc50a4537a80fe88a3c0981ef700afcb", "committedDate": "2020-04-23T14:09:50Z", "message": "revert some changes\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fc6587c1fd5b0fd679760c5ac16d7cfcd0f6ed1", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/5fc6587c1fd5b0fd679760c5ac16d7cfcd0f6ed1", "committedDate": "2020-04-23T14:19:53Z", "message": "reintroduce privacy test invariants\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95e3b77d546d9a1199f1563bf6d8c68ae1907afc", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/95e3b77d546d9a1199f1563bf6d8c68ae1907afc", "committedDate": "2020-04-23T15:34:33Z", "message": "bugfixes and test changes\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "917c94473c8718cdb5ae45f6266d331abacc4879", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/917c94473c8718cdb5ae45f6266d331abacc4879", "committedDate": "2020-04-23T15:34:40Z", "message": "Merge remote-tracking branch 'upstream' into log-with-metadata-updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44fe98d25b1fe6bbfdbaf53fa8824c16eefd2524", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/44fe98d25b1fe6bbfdbaf53fa8824c16eefd2524", "committedDate": "2020-04-23T15:42:52Z", "message": "Merge remote-tracking branch 'upstream' into log-with-metadata-updates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NDcwMDg1", "url": "https://github.com/hyperledger/besu/pull/767#pullrequestreview-399470085", "createdAt": "2020-04-23T20:56:44Z", "commit": {"oid": "44fe98d25b1fe6bbfdbaf53fa8824c16eefd2524"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDo1Njo0NFrOGK7xlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDo1Njo0NFrOGK7xlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDExODI5NA==", "bodyText": "Maybe this is a problem that was already in the code. But I have just thought about it.\nIf the filter is using a blockhash, we shouldn't be adding logs from any other block into it. However, it looks like our log filtering logic would add the logs regardless. Because in this case, the blockhash in the filter won't be empty but the from/to block parameter will be empty.", "url": "https://github.com/hyperledger/besu/pull/767#discussion_r414118294", "createdAt": "2020-04-23T20:56:44Z", "author": {"login": "lucassaldanha"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/filter/FilterManager.java", "diffHunk": "@@ -151,28 +153,45 @@ public boolean uninstallFilter(final String filterId) {\n     }\n   }\n \n-  public void recordBlockEvent(final BlockAddedEvent event, final Blockchain blockchain) {\n+  public void recordBlockEvent(final BlockAddedEvent event, final Blockchain __) {\n     final Hash blockHash = event.getBlock().getHash();\n     final Collection<BlockFilter> blockFilters =\n         filterRepository.getFiltersOfType(BlockFilter.class);\n     blockFilters.forEach(\n-        (filter) -> {\n+        filter -> {\n           synchronized (filter) {\n             filter.addBlockHash(blockHash);\n           }\n         });\n \n-    filterRepository.getFiltersOfType(LogFilter.class).forEach(this::addNewMatchingLogs);\n-  }\n-\n-  private void addNewMatchingLogs(final LogFilter filter) {\n-    final long fromBlockNumber = blockchainQueries.headBlockNumber();\n-    final long toBlockNumber =\n-        filter.getToBlock().getNumber().orElse(blockchainQueries.headBlockNumber());\n-\n-    final List<LogWithMetadata> logs = findLogsWithinRange(filter, fromBlockNumber, toBlockNumber);\n-\n-    filter.addLogs(logs);\n+    final List<LogWithMetadata> logsWithMetadata = event.getLogsWithMetadata();\n+    filterRepository.getFiltersOfType(LogFilter.class).stream()\n+        .filter(\n+            // Only keep filters where the \"to\" block could include the block in the event\n+            filter -> {\n+              final OptionalLong maybeToBlockNumber = filter.getToBlock().getNumber();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44fe98d25b1fe6bbfdbaf53fa8824c16eefd2524"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abb64e9e836f0cb3736f81c3261afad8ec6ba251", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/abb64e9e836f0cb3736f81c3261afad8ec6ba251", "committedDate": "2020-04-23T21:55:35Z", "message": "Merge remote-tracking branch 'upstream' into log-with-metadata-updates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NTIwMTcz", "url": "https://github.com/hyperledger/besu/pull/767#pullrequestreview-399520173", "createdAt": "2020-04-23T22:26:22Z", "commit": {"oid": "abb64e9e836f0cb3736f81c3261afad8ec6ba251"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1590, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}