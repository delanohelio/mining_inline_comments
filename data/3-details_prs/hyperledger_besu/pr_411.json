{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2OTE2Mzkz", "number": 411, "title": "LogBloomCache - make sure the current segment is filled", "bodyText": "Make sure we cache the current cache segment with all of the data from\nthe beginning of the segment.  Use a flip file approach since it will be\na partial file until done.\nSigned-off-by: Danno Ferrin danno.ferrin@gmail.com", "createdAt": "2020-02-19T01:21:27Z", "url": "https://github.com/hyperledger/besu/pull/411", "merged": true, "mergeCommit": {"oid": "90d46b74458b87e9af09738821b7a9863e546a0c"}, "closed": true, "closedAt": "2020-02-19T17:46:04Z", "author": {"login": "shemnon"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFsIQugH2gAyMzc2OTE2MzkzOmZjZDZmY2ZlNzE0Yjk2YzFlNjc0MzE2MjUwYTVhYzI1ZjdmNmFlNGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcF464VAH2gAyMzc2OTE2MzkzOjVkOTFkMjMwNzFlNzY0OWViMjJmNmI1NDE2MDc0YWE0YWI4NjkxMDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fcd6fcfe714b96c1e674316250a5ac25f7f6ae4b", "author": {"user": {"login": "shemnon", "name": "Danno Ferrin"}}, "url": "https://github.com/hyperledger/besu/commit/fcd6fcfe714b96c1e674316250a5ac25f7f6ae4b", "committedDate": "2020-02-19T01:20:33Z", "message": "LogBloomCache - make sure the current segment is filled\n\nMake sure we cache the current cache segment with all of the data from\nthe beginning of the segment.  Use a flip file approach since it will be\n a partial file until done.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNzk0Njc4", "url": "https://github.com/hyperledger/besu/pull/411#pullrequestreview-360794678", "createdAt": "2020-02-19T01:49:22Z", "commit": {"oid": "fcd6fcfe714b96c1e674316250a5ac25f7f6ae4b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMTo0OToyMlrOFrYnZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMTo0OToyMlrOFrYnZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAzNjM5MQ==", "bodyText": "This while loop near the chain head on EthScheduler seems to be approximating a listener. The whole logs caching endeavor reminds me of pruning in that way. Where there's something that needs to be done in bulk (marking the whole state trie of one special block <-> doing all the caching for previous segments) and one that is done with a listener (marking new nodes from new blocks with a listener on the state storage <-> random access writing the log blooms for recent blocks). Could a similar approach be useful here?", "url": "https://github.com/hyperledger/besu/pull/411#discussion_r381036391", "createdAt": "2020-02-19T01:49:22Z", "author": {"login": "RatanRSur"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/query/TransactionLogBloomCacher.java", "diffHunk": "@@ -128,27 +132,63 @@ private void fillCacheFile(\n     }\n   }\n \n-  public void cacheLogsBloomForBlockHeader(\n+  void cacheLogsBloomForBlockHeader(\n       final BlockHeader blockHeader,\n       final Optional<File> reusedCacheFile,\n       final boolean ensureChecks) {\n     try {\n+      if (cachingStatus.cachingCount.incrementAndGet() != 1) {\n+        return;\n+      }\n       final long blockNumber = blockHeader.getNumber();\n       LOG.debug(\"Caching logs bloom for block {}.\", \"0x\" + Long.toHexString(blockNumber));\n       if (ensureChecks) {\n         ensurePreviousSegmentsArePresent(blockNumber);\n       }\n       final File cacheFile = reusedCacheFile.orElse(calculateCacheFileName(blockNumber, cacheDir));\n-      if (!cacheFile.exists()) {\n-        Files.createFile(cacheFile.toPath());\n+      if (cacheFile.exists()) {\n+        cacheSingleBlock(blockHeader, cacheFile);\n+      } else {\n+        scheduler.scheduleComputationTask(this::populateLatestSegment);\n+      }\n+    } catch (final IOException e) {\n+      LOG.error(\"Unhandled caching exception.\", e);\n+    } finally {\n+      cachingStatus.cachingCount.decrementAndGet();\n+    }\n+  }\n+\n+  private void cacheSingleBlock(final BlockHeader blockHeader, final File cacheFile)\n+      throws IOException {\n+    try (final RandomAccessFile writer = new RandomAccessFile(cacheFile, \"rw\")) {\n+      final long offset = (blockHeader.getNumber() % BLOCKS_PER_BLOOM_CACHE) * BLOOM_BITS_LENGTH;\n+      writer.seek(offset);\n+      writer.write(ensureBloomBitsAreCorrectLength(blockHeader.getLogsBloom().toArray()));\n+    }\n+  }\n+\n+  private boolean populateLatestSegment() {\n+    try {\n+      long blockNumber = blockchain.getChainHeadBlockNumber();\n+      final File currentFile = calculateCacheFileName(CURRENT, cacheDir);\n+      final long segmentNumber = blockNumber / BLOCKS_PER_BLOOM_CACHE;\n+      try (final OutputStream out = new FileOutputStream(currentFile)) {\n+        fillCacheFile(segmentNumber * BLOCKS_PER_BLOOM_CACHE, blockNumber, out);\n       }\n-      try (RandomAccessFile writer = new RandomAccessFile(cacheFile, \"rw\")) {\n-        final long offset = (blockNumber / BLOCKS_PER_BLOOM_CACHE) * BLOOM_BITS_LENGTH;\n-        writer.seek(offset);\n-        writer.write(ensureBloomBitsAreCorrectLength(blockHeader.getLogsBloom().toArray()));\n+      while (blockNumber <= blockchain.getChainHeadBlockNumber()\n+          && (blockNumber % BLOCKS_PER_BLOOM_CACHE != 0)) {\n+        cacheSingleBlock(blockchain.getBlockHeader(blockNumber).orElseThrow(), currentFile);\n+        blockNumber++;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcd6fcfe714b96c1e674316250a5ac25f7f6ae4b"}, "originalPosition": 128}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwOTAyODM1", "url": "https://github.com/hyperledger/besu/pull/411#pullrequestreview-360902835", "createdAt": "2020-02-19T08:00:07Z", "commit": {"oid": "fcd6fcfe714b96c1e674316250a5ac25f7f6ae4b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "882789ee45de2ac7b37c3708f7b4aac9e9e0cc04", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/882789ee45de2ac7b37c3708f7b4aac9e9e0cc04", "committedDate": "2020-02-19T08:00:45Z", "message": "Merge branch 'master' into cachecurrent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d91d23071e7649eb22f6b5416074aa4ab869102", "author": {"user": {"login": "shemnon", "name": "Danno Ferrin"}}, "url": "https://github.com/hyperledger/besu/commit/5d91d23071e7649eb22f6b5416074aa4ab869102", "committedDate": "2020-02-19T16:14:42Z", "message": "Merge branch 'master' into cachecurrent"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1785, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}