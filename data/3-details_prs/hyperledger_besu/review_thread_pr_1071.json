{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzNTczODYx", "number": 1071, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwNToyMTozM1rOEFZIAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMjo0MToxN1rOEFuHww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MDg5OTg2OnYy", "diffSide": "RIGHT", "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/blockcreation/CliqueMiningCoordinator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwNToyMTozM1rOGjjibQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMDowMzo0M1rOGjrkzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTkzNTU5Nw==", "bodyText": "Nit: could we not use \"mining\"?  I always associate that with PoW mining and nonce solving.  Is there a more different term like \"sealing\" \"block production\" or \"validating\" we could use?", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r439935597", "createdAt": "2020-06-15T05:21:33Z", "author": {"login": "shemnon"}, "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/blockcreation/CliqueMiningCoordinator.java", "diffHunk": "@@ -33,6 +41,30 @@ public CliqueMiningCoordinator(\n     this.miningTracker = miningTracker;\n   }\n \n+  @Override\n+  protected void inSyncChanged(final boolean inSync) {\n+    synchronized (this) {\n+      final VoteTally validatorProvider =\n+          miningTracker\n+              .getProtocolContext()\n+              .getConsensusState(CliqueContext.class)\n+              .getVoteTallyCache()\n+              .getVoteTallyAfterBlock(blockchain.getChainHeadHeader());\n+      final boolean isValidator =\n+          getCoinbase()\n+              .filter(coinbase -> validatorProvider.getValidators().contains(coinbase))\n+              .isPresent();\n+\n+      if (inSync && startMiningIfPossible() && isValidator) {\n+        LOG.info(\"Resuming mining operations\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a1d1b2710a139abfc1220c5e9430705f597ee0a"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA2NzI3Nw==", "bodyText": "Done. I used block production for the log. For now, I keep the class called CliqueMiningCoordinator because it inherits from AbstractMiningCoordinator and implements MiningCoordinator. If we want to change that. this should be done in another PR. Because the impacts can be significant IMO", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r440067277", "createdAt": "2020-06-15T10:03:43Z", "author": {"login": "matkt"}, "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/blockcreation/CliqueMiningCoordinator.java", "diffHunk": "@@ -33,6 +41,30 @@ public CliqueMiningCoordinator(\n     this.miningTracker = miningTracker;\n   }\n \n+  @Override\n+  protected void inSyncChanged(final boolean inSync) {\n+    synchronized (this) {\n+      final VoteTally validatorProvider =\n+          miningTracker\n+              .getProtocolContext()\n+              .getConsensusState(CliqueContext.class)\n+              .getVoteTallyCache()\n+              .getVoteTallyAfterBlock(blockchain.getChainHeadHeader());\n+      final boolean isValidator =\n+          getCoinbase()\n+              .filter(coinbase -> validatorProvider.getValidators().contains(coinbase))\n+              .isPresent();\n+\n+      if (inSync && startMiningIfPossible() && isValidator) {\n+        LOG.info(\"Resuming mining operations\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTkzNTU5Nw=="}, "originalCommit": {"oid": "2a1d1b2710a139abfc1220c5e9430705f597ee0a"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MDkwMTU0OnYy", "diffSide": "RIGHT", "path": "ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/EthHashMiningCoordinator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwNToyMjo1M1rOGjjjjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwNToyMjo1M1rOGjjjjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTkzNTg4NQ==", "bodyText": "Mining is the correct term here for sure.", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r439935885", "createdAt": "2020-06-15T05:22:53Z", "author": {"login": "shemnon"}, "path": "ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/EthHashMiningCoordinator.java", "diffHunk": "@@ -49,6 +55,18 @@ public void setStratumMiningEnabled(final boolean stratumMiningEnabled) {\n     executor.setStratumMiningEnabled(stratumMiningEnabled);\n   }\n \n+  @Override\n+  protected void inSyncChanged(final boolean inSync) {\n+    synchronized (this) {\n+      if (inSync && startMiningIfPossible()) {\n+        LOG.info(\"Resuming mining operations\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a1d1b2710a139abfc1220c5e9430705f597ee0a"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MDk3ODY0OnYy", "diffSide": "RIGHT", "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/blockcreation/CliqueMiningCoordinator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwNjowODowNFrOGjkR8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMDowNTo0MFrOGjrpIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk0Nzc2Mg==", "bodyText": "do we want to be careful here? The coinbase is not necessarily this node's ID (maybe in our code base, but the concepts are different) - it'd be nice to see this comparing nodeKey against validator list", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r439947762", "createdAt": "2020-06-15T06:08:04Z", "author": {"login": "rain-on"}, "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/blockcreation/CliqueMiningCoordinator.java", "diffHunk": "@@ -33,6 +41,30 @@ public CliqueMiningCoordinator(\n     this.miningTracker = miningTracker;\n   }\n \n+  @Override\n+  protected void inSyncChanged(final boolean inSync) {\n+    synchronized (this) {\n+      final VoteTally validatorProvider =\n+          miningTracker\n+              .getProtocolContext()\n+              .getConsensusState(CliqueContext.class)\n+              .getVoteTallyCache()\n+              .getVoteTallyAfterBlock(blockchain.getChainHeadHeader());\n+      final boolean isValidator =\n+          getCoinbase()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a1d1b2710a139abfc1220c5e9430705f597ee0a"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA2ODM4NA==", "bodyText": "Done. I created an isSigner method in CliqueHelpers because there was already a very close implementation and it used the node's ID", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r440068384", "createdAt": "2020-06-15T10:05:40Z", "author": {"login": "matkt"}, "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/blockcreation/CliqueMiningCoordinator.java", "diffHunk": "@@ -33,6 +41,30 @@ public CliqueMiningCoordinator(\n     this.miningTracker = miningTracker;\n   }\n \n+  @Override\n+  protected void inSyncChanged(final boolean inSync) {\n+    synchronized (this) {\n+      final VoteTally validatorProvider =\n+          miningTracker\n+              .getProtocolContext()\n+              .getConsensusState(CliqueContext.class)\n+              .getVoteTallyCache()\n+              .getVoteTallyAfterBlock(blockchain.getChainHeadHeader());\n+      final boolean isValidator =\n+          getCoinbase()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk0Nzc2Mg=="}, "originalCommit": {"oid": "2a1d1b2710a139abfc1220c5e9430705f597ee0a"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTEwMDIzOnYy", "diffSide": "RIGHT", "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/blockcreation/CliqueMiningCoordinator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwNjo1OToyMFrOGjlaUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMDowNjowNFrOGjrqBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk2NjI5MA==", "bodyText": "nit: maybe isSigner? IBFT2 has validators, Clique has signers.", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r439966290", "createdAt": "2020-06-15T06:59:20Z", "author": {"login": "rain-on"}, "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/blockcreation/CliqueMiningCoordinator.java", "diffHunk": "@@ -33,6 +41,30 @@ public CliqueMiningCoordinator(\n     this.miningTracker = miningTracker;\n   }\n \n+  @Override\n+  protected void inSyncChanged(final boolean inSync) {\n+    synchronized (this) {\n+      final VoteTally validatorProvider =\n+          miningTracker\n+              .getProtocolContext()\n+              .getConsensusState(CliqueContext.class)\n+              .getVoteTallyCache()\n+              .getVoteTallyAfterBlock(blockchain.getChainHeadHeader());\n+      final boolean isValidator =\n+          getCoinbase()\n+              .filter(coinbase -> validatorProvider.getValidators().contains(coinbase))\n+              .isPresent();\n+\n+      if (inSync && startMiningIfPossible() && isValidator) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a1d1b2710a139abfc1220c5e9430705f597ee0a"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA2ODYxNA==", "bodyText": "I created an isSigner method in CliqueHelpers", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r440068614", "createdAt": "2020-06-15T10:06:04Z", "author": {"login": "matkt"}, "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/blockcreation/CliqueMiningCoordinator.java", "diffHunk": "@@ -33,6 +41,30 @@ public CliqueMiningCoordinator(\n     this.miningTracker = miningTracker;\n   }\n \n+  @Override\n+  protected void inSyncChanged(final boolean inSync) {\n+    synchronized (this) {\n+      final VoteTally validatorProvider =\n+          miningTracker\n+              .getProtocolContext()\n+              .getConsensusState(CliqueContext.class)\n+              .getVoteTallyCache()\n+              .getVoteTallyAfterBlock(blockchain.getChainHeadHeader());\n+      final boolean isValidator =\n+          getCoinbase()\n+              .filter(coinbase -> validatorProvider.getValidators().contains(coinbase))\n+              .isPresent();\n+\n+      if (inSync && startMiningIfPossible() && isValidator) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk2NjI5MA=="}, "originalCommit": {"oid": "2a1d1b2710a139abfc1220c5e9430705f597ee0a"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTEwNjYzOnYy", "diffSide": "RIGHT", "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/CliqueMiningTracker.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwNzowMTo0NFrOGjleBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMDowNzozOVrOGjrtWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk2NzIzNg==", "bodyText": "this shouldn't be exposed here - this class isn't a carriage for this - its used internally to determine if/how we can mine.", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r439967236", "createdAt": "2020-06-15T07:01:44Z", "author": {"login": "rain-on"}, "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/CliqueMiningTracker.java", "diffHunk": "@@ -42,4 +42,8 @@ public boolean canMakeBlockNextRound(final BlockHeader header) {\n   public boolean blockCreatedLocally(final BlockHeader header) {\n     return CliqueHelpers.getProposerOfBlock(header).equals(localAddress);\n   }\n+\n+  public ProtocolContext getProtocolContext() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a1d1b2710a139abfc1220c5e9430705f597ee0a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA2OTQ2NQ==", "bodyText": "This part has been moved to the mining tracker class. This is no longer exposed", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r440069465", "createdAt": "2020-06-15T10:07:39Z", "author": {"login": "matkt"}, "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/CliqueMiningTracker.java", "diffHunk": "@@ -42,4 +42,8 @@ public boolean canMakeBlockNextRound(final BlockHeader header) {\n   public boolean blockCreatedLocally(final BlockHeader header) {\n     return CliqueHelpers.getProposerOfBlock(header).equals(localAddress);\n   }\n+\n+  public ProtocolContext getProtocolContext() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk2NzIzNg=="}, "originalCommit": {"oid": "2a1d1b2710a139abfc1220c5e9430705f597ee0a"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTExMjk3OnYy", "diffSide": "RIGHT", "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/blockcreation/CliqueMiningCoordinator.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwNzowNDoxM1rOGjlh6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMDowODo0NFrOGjrvkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk2ODIzNQ==", "bodyText": "rather than exposing the ProtocolContext, we can add a function \"isValidator\" to the CliqueMiningTracker?", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r439968235", "createdAt": "2020-06-15T07:04:13Z", "author": {"login": "rain-on"}, "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/blockcreation/CliqueMiningCoordinator.java", "diffHunk": "@@ -33,6 +41,30 @@ public CliqueMiningCoordinator(\n     this.miningTracker = miningTracker;\n   }\n \n+  @Override\n+  protected void inSyncChanged(final boolean inSync) {\n+    synchronized (this) {\n+      final VoteTally validatorProvider =\n+          miningTracker\n+              .getProtocolContext()\n+              .getConsensusState(CliqueContext.class)\n+              .getVoteTallyCache()\n+              .getVoteTallyAfterBlock(blockchain.getChainHeadHeader());\n+      final boolean isValidator =\n+          getCoinbase()\n+              .filter(coinbase -> validatorProvider.getValidators().contains(coinbase))\n+              .isPresent();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a1d1b2710a139abfc1220c5e9430705f597ee0a"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk2ODQ0NQ==", "bodyText": "using getCoinbase() is kinda dangerous as it does not necessarily relate to the local node's ID.", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r439968445", "createdAt": "2020-06-15T07:04:47Z", "author": {"login": "rain-on"}, "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/blockcreation/CliqueMiningCoordinator.java", "diffHunk": "@@ -33,6 +41,30 @@ public CliqueMiningCoordinator(\n     this.miningTracker = miningTracker;\n   }\n \n+  @Override\n+  protected void inSyncChanged(final boolean inSync) {\n+    synchronized (this) {\n+      final VoteTally validatorProvider =\n+          miningTracker\n+              .getProtocolContext()\n+              .getConsensusState(CliqueContext.class)\n+              .getVoteTallyCache()\n+              .getVoteTallyAfterBlock(blockchain.getChainHeadHeader());\n+      final boolean isValidator =\n+          getCoinbase()\n+              .filter(coinbase -> validatorProvider.getValidators().contains(coinbase))\n+              .isPresent();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk2ODIzNQ=="}, "originalCommit": {"oid": "2a1d1b2710a139abfc1220c5e9430705f597ee0a"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3MDAzMw==", "bodyText": "Changed. I am now using the node's ID; Good catch", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r440070033", "createdAt": "2020-06-15T10:08:44Z", "author": {"login": "matkt"}, "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/blockcreation/CliqueMiningCoordinator.java", "diffHunk": "@@ -33,6 +41,30 @@ public CliqueMiningCoordinator(\n     this.miningTracker = miningTracker;\n   }\n \n+  @Override\n+  protected void inSyncChanged(final boolean inSync) {\n+    synchronized (this) {\n+      final VoteTally validatorProvider =\n+          miningTracker\n+              .getProtocolContext()\n+              .getConsensusState(CliqueContext.class)\n+              .getVoteTallyCache()\n+              .getVoteTallyAfterBlock(blockchain.getChainHeadHeader());\n+      final boolean isValidator =\n+          getCoinbase()\n+              .filter(coinbase -> validatorProvider.getValidators().contains(coinbase))\n+              .isPresent();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk2ODIzNQ=="}, "originalCommit": {"oid": "2a1d1b2710a139abfc1220c5e9430705f597ee0a"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTExNzY2OnYy", "diffSide": "RIGHT", "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/blockcreation/CliqueMiningCoordinator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwNzowNTo1OVrOGjlkzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMDoxMDoxM1rOGjryqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk2ODk3Mw==", "bodyText": "nit: the haltMiningOperation will stop the current mining operation, which is sort of a side-effect - in the past I've avoided side-effects in conditions - not sure we care.", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r439968973", "createdAt": "2020-06-15T07:05:59Z", "author": {"login": "rain-on"}, "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/blockcreation/CliqueMiningCoordinator.java", "diffHunk": "@@ -33,6 +41,30 @@ public CliqueMiningCoordinator(\n     this.miningTracker = miningTracker;\n   }\n \n+  @Override\n+  protected void inSyncChanged(final boolean inSync) {\n+    synchronized (this) {\n+      final VoteTally validatorProvider =\n+          miningTracker\n+              .getProtocolContext()\n+              .getConsensusState(CliqueContext.class)\n+              .getVoteTallyCache()\n+              .getVoteTallyAfterBlock(blockchain.getChainHeadHeader());\n+      final boolean isValidator =\n+          getCoinbase()\n+              .filter(coinbase -> validatorProvider.getValidators().contains(coinbase))\n+              .isPresent();\n+\n+      if (inSync && startMiningIfPossible() && isValidator) {\n+        LOG.info(\"Resuming mining operations\");\n+      }\n+\n+      if (!inSync && haltCurrentMiningOperation() && isValidator) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a1d1b2710a139abfc1220c5e9430705f597ee0a"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3MDgyNg==", "bodyText": "This is no longer present in the CliqueMiningCoordinator class. The original implementation has been moved back to the abstract class. But indeed this behavior was already there", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r440070826", "createdAt": "2020-06-15T10:10:13Z", "author": {"login": "matkt"}, "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/blockcreation/CliqueMiningCoordinator.java", "diffHunk": "@@ -33,6 +41,30 @@ public CliqueMiningCoordinator(\n     this.miningTracker = miningTracker;\n   }\n \n+  @Override\n+  protected void inSyncChanged(final boolean inSync) {\n+    synchronized (this) {\n+      final VoteTally validatorProvider =\n+          miningTracker\n+              .getProtocolContext()\n+              .getConsensusState(CliqueContext.class)\n+              .getVoteTallyCache()\n+              .getVoteTallyAfterBlock(blockchain.getChainHeadHeader());\n+      final boolean isValidator =\n+          getCoinbase()\n+              .filter(coinbase -> validatorProvider.getValidators().contains(coinbase))\n+              .isPresent();\n+\n+      if (inSync && startMiningIfPossible() && isValidator) {\n+        LOG.info(\"Resuming mining operations\");\n+      }\n+\n+      if (!inSync && haltCurrentMiningOperation() && isValidator) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk2ODk3Mw=="}, "originalCommit": {"oid": "2a1d1b2710a139abfc1220c5e9430705f597ee0a"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTEyMTM4OnYy", "diffSide": "RIGHT", "path": "ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/AbstractMiningCoordinator.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwNzowNzoyMlrOGjlnCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMDoxMjoyNFrOGjr3Yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk2OTU0NA==", "bodyText": "nit: changing this from private to protected opens the API significantly (and just for logging purposes) - is there a way we can move the conditional into the child-class, but keep the heavy-lifting here?", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r439969544", "createdAt": "2020-06-15T07:07:22Z", "author": {"login": "rain-on"}, "path": "ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/AbstractMiningCoordinator.java", "diffHunk": "@@ -152,7 +147,7 @@ private void startAsyncMiningOperation() {\n         executor.startAsyncMining(minedBlockObservers, ethHashObservers, parentHeader);\n   }\n \n-  private synchronized boolean haltCurrentMiningOperation() {\n+  protected synchronized boolean haltCurrentMiningOperation() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a1d1b2710a139abfc1220c5e9430705f597ee0a"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3MTEzNg==", "bodyText": "The new implementation no longer needs this", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r440071136", "createdAt": "2020-06-15T10:10:46Z", "author": {"login": "matkt"}, "path": "ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/AbstractMiningCoordinator.java", "diffHunk": "@@ -152,7 +147,7 @@ private void startAsyncMiningOperation() {\n         executor.startAsyncMining(minedBlockObservers, ethHashObservers, parentHeader);\n   }\n \n-  private synchronized boolean haltCurrentMiningOperation() {\n+  protected synchronized boolean haltCurrentMiningOperation() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk2OTU0NA=="}, "originalCommit": {"oid": "2a1d1b2710a139abfc1220c5e9430705f597ee0a"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3MjAzNA==", "bodyText": "I created two methods onPauseMining and onResumeMining which allow to keep the main implementation in the abstract class", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r440072034", "createdAt": "2020-06-15T10:12:24Z", "author": {"login": "matkt"}, "path": "ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/AbstractMiningCoordinator.java", "diffHunk": "@@ -152,7 +147,7 @@ private void startAsyncMiningOperation() {\n         executor.startAsyncMining(minedBlockObservers, ethHashObservers, parentHeader);\n   }\n \n-  private synchronized boolean haltCurrentMiningOperation() {\n+  protected synchronized boolean haltCurrentMiningOperation() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk2OTU0NA=="}, "originalCommit": {"oid": "2a1d1b2710a139abfc1220c5e9430705f597ee0a"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTEzMDE0OnYy", "diffSide": "RIGHT", "path": "ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/EthHashMiningCoordinator.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwNzoxMDoyOVrOGjlsVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMjo0MTo0NlrOGkFKhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk3MDkwMA==", "bodyText": "nit: could/should this stay in the base class? and just overriden in clique?", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r439970900", "createdAt": "2020-06-15T07:10:29Z", "author": {"login": "rain-on"}, "path": "ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/EthHashMiningCoordinator.java", "diffHunk": "@@ -49,6 +55,18 @@ public void setStratumMiningEnabled(final boolean stratumMiningEnabled) {\n     executor.setStratumMiningEnabled(stratumMiningEnabled);\n   }\n \n+  @Override", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a1d1b2710a139abfc1220c5e9430705f597ee0a"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3MzQ5Nw==", "bodyText": "I have just changed; I reduced to minimum what must be overriden", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r440073497", "createdAt": "2020-06-15T10:15:13Z", "author": {"login": "matkt"}, "path": "ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/EthHashMiningCoordinator.java", "diffHunk": "@@ -49,6 +55,18 @@ public void setStratumMiningEnabled(final boolean stratumMiningEnabled) {\n     executor.setStratumMiningEnabled(stratumMiningEnabled);\n   }\n \n+  @Override", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk3MDkwMA=="}, "originalCommit": {"oid": "2a1d1b2710a139abfc1220c5e9430705f597ee0a"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ4NjUzNQ==", "bodyText": "looks way better (IMHO)", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r440486535", "createdAt": "2020-06-15T22:41:46Z", "author": {"login": "rain-on"}, "path": "ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/EthHashMiningCoordinator.java", "diffHunk": "@@ -49,6 +55,18 @@ public void setStratumMiningEnabled(final boolean stratumMiningEnabled) {\n     executor.setStratumMiningEnabled(stratumMiningEnabled);\n   }\n \n+  @Override", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTk3MDkwMA=="}, "originalCommit": {"oid": "2a1d1b2710a139abfc1220c5e9430705f597ee0a"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NDMzOTg3OnYy", "diffSide": "RIGHT", "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/blockcreation/CliqueMiningCoordinator.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMjo0MToxN1rOGkFJ2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwOToyNzo0M1rOGk9i7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ4NjM2MA==", "bodyText": "nit: Other thing I was thinking - is this really an \"info\" level log - or can it be reduced to debug? Seems like something we wouldn't need to see all the time.", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r440486360", "createdAt": "2020-06-15T22:41:17Z", "author": {"login": "rain-on"}, "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/blockcreation/CliqueMiningCoordinator.java", "diffHunk": "@@ -33,6 +39,20 @@ public CliqueMiningCoordinator(\n     this.miningTracker = miningTracker;\n   }\n \n+  @Override\n+  public void onResumeMining() {\n+    if (miningTracker.isSigner(blockchain.getChainHeadHeader())) {\n+      LOG.info(\"Resuming block production operations\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca3475ce0b5404a40d6fcc03cc07961fb2f35543"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDczNjM5Mg==", "bodyText": "IMO it can be interesting to see that the block production start and stop without changing the log level to debug. Do you really think that we need to change it ?", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r440736392", "createdAt": "2020-06-16T10:05:37Z", "author": {"login": "matkt"}, "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/blockcreation/CliqueMiningCoordinator.java", "diffHunk": "@@ -33,6 +39,20 @@ public CliqueMiningCoordinator(\n     this.miningTracker = miningTracker;\n   }\n \n+  @Override\n+  public void onResumeMining() {\n+    if (miningTracker.isSigner(blockchain.getChainHeadHeader())) {\n+      LOG.info(\"Resuming block production operations\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ4NjM2MA=="}, "originalCommit": {"oid": "ca3475ce0b5404a40d6fcc03cc07961fb2f35543"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQxMDI4Nw==", "bodyText": "No - just wanted to ask.\nI feel the logging Besu is a generally bit verbose/noisy - so I tend to be pretty hard with what should be at info/debug/trace.\nReally dropping out of sync is the problem - the fact that mining is paused is kinda an obvious side effect - so maybe \"Lost Sync\" is in info, and stopping mining is debug.\nBut seriously, happy to let it lie and push this in.", "url": "https://github.com/hyperledger/besu/pull/1071#discussion_r441410287", "createdAt": "2020-06-17T09:27:43Z", "author": {"login": "rain-on"}, "path": "consensus/clique/src/main/java/org/hyperledger/besu/consensus/clique/blockcreation/CliqueMiningCoordinator.java", "diffHunk": "@@ -33,6 +39,20 @@ public CliqueMiningCoordinator(\n     this.miningTracker = miningTracker;\n   }\n \n+  @Override\n+  public void onResumeMining() {\n+    if (miningTracker.isSigner(blockchain.getChainHeadHeader())) {\n+      LOG.info(\"Resuming block production operations\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ4NjM2MA=="}, "originalCommit": {"oid": "ca3475ce0b5404a40d6fcc03cc07961fb2f35543"}, "originalPosition": 28}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 793, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}