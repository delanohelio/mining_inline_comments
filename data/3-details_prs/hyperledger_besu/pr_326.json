{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3MDk1MzYx", "number": 326, "title": "Add Parity style Statediff", "bodyText": "Adds parity style state diffs.  The BlockTracer uses a rolling\n\"base\" world updater that is the block base or the last transaction.\nDiffs are then based on those two states. i.e. diffs are computed\nbetween chained results of transaction outputs.", "createdAt": "2020-01-25T07:15:53Z", "url": "https://github.com/hyperledger/besu/pull/326", "merged": true, "mergeCommit": {"oid": "f9b0439fdc8475dfd63047cecd1ea0ae43ef48a6"}, "closed": true, "closedAt": "2020-01-27T08:15:18Z", "author": {"login": "shemnon"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9kwWPAH2gAyMzY3MDk1MzYxOjY3OWIxMGE0MGNkYWNjY2I4MDM0MzZjOWMzOTI0OTYzMGUwMTBlZDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-YQ10gFqTM0ODQ4NjkwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "679b10a40cdacccb803436c9c39249630e010ed1", "author": {"user": {"login": "shemnon", "name": "Danno Ferrin"}}, "url": "https://github.com/hyperledger/besu/commit/679b10a40cdacccb803436c9c39249630e010ed1", "committedDate": "2020-01-24T20:13:42Z", "message": "State diff\n\nAll but balances work at this point.\u00a0 And it has something to do with\nupfront gas costs.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90d3ff669f6e8f576b8fe1ef292494eb71090ee1", "author": {"user": {"login": "shemnon", "name": "Danno Ferrin"}}, "url": "https://github.com/hyperledger/besu/commit/90d3ff669f6e8f576b8fe1ef292494eb71090ee1", "committedDate": "2020-01-25T07:09:53Z", "message": "fix the balances bug\n\nThere was also a chained transactions bug. To address this I create a\nnew WorldUpdater for each iteration of a transaction through the block.\n The current world updater has the new state, the prior the old one.\n Diffs just fall out after that.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83b5c34f5238a52f3f495897f476518515adb882", "author": {"user": {"login": "shemnon", "name": "Danno Ferrin"}}, "url": "https://github.com/hyperledger/besu/commit/83b5c34f5238a52f3f495897f476518515adb882", "committedDate": "2020-01-25T07:28:13Z", "message": "get rid of midBlock state, it's unneeded with the chained updaters.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8d53872a84fb4ee209fc6b3809494bf5d471ca2", "author": {"user": {"login": "shemnon", "name": "Danno Ferrin"}}, "url": "https://github.com/hyperledger/besu/commit/d8d53872a84fb4ee209fc6b3809494bf5d471ca2", "committedDate": "2020-01-25T07:33:37Z", "message": "remove rootWorld method, old code from a prior attempt.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84dc04004a65571b3996d3d94ff7191a5532ae89", "author": {"user": {"login": "shemnon", "name": "Danno Ferrin"}}, "url": "https://github.com/hyperledger/besu/commit/84dc04004a65571b3996d3d94ff7191a5532ae89", "committedDate": "2020-01-25T07:34:49Z", "message": "remove println\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fa861c33052339552176e3f30cc6e8bf2c7ab73", "author": {"user": {"login": "shemnon", "name": "Danno Ferrin"}}, "url": "https://github.com/hyperledger/besu/commit/8fa861c33052339552176e3f30cc6e8bf2c7ab73", "committedDate": "2020-01-25T17:15:43Z", "message": "spotless\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "602c17202612d64ff2c165e422343b57244bfbd6", "author": {"user": {"login": "shemnon", "name": "Danno Ferrin"}}, "url": "https://github.com/hyperledger/besu/commit/602c17202612d64ff2c165e422343b57244bfbd6", "committedDate": "2020-01-25T17:33:57Z", "message": "spotless, comments, and cleanup\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79f8a45288f64c4d9abfc0b7571a58f4e44a0e94", "author": {"user": {"login": "shemnon", "name": "Danno Ferrin"}}, "url": "https://github.com/hyperledger/besu/commit/79f8a45288f64c4d9abfc0b7571a58f4e44a0e94", "committedDate": "2020-01-25T17:36:05Z", "message": "spotless keeps missing this.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "716af088f117d3cf9cf213408d90c46cb2dc0978", "author": {"user": {"login": "shemnon", "name": "Danno Ferrin"}}, "url": "https://github.com/hyperledger/besu/commit/716af088f117d3cf9cf213408d90c46cb2dc0978", "committedDate": "2020-01-25T17:49:20Z", "message": "javadoc\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da06ac543234198644a0dd9fd9dea00660e07e5c", "author": {"user": {"login": "shemnon", "name": "Danno Ferrin"}}, "url": "https://github.com/hyperledger/besu/commit/da06ac543234198644a0dd9fd9dea00660e07e5c", "committedDate": "2020-01-25T20:17:04Z", "message": "fix broken reference tests\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a47ab7d8cc5b7301affb73d7ea0a865d31223888", "author": {"user": {"login": "shemnon", "name": "Danno Ferrin"}}, "url": "https://github.com/hyperledger/besu/commit/a47ab7d8cc5b7301affb73d7ea0a865d31223888", "committedDate": "2020-01-25T20:21:19Z", "message": "spotless\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49c9b3473de834f6ec35c3a5c46c0fd012d59411", "author": {"user": {"login": "shemnon", "name": "Danno Ferrin"}}, "url": "https://github.com/hyperledger/besu/commit/49c9b3473de834f6ec35c3a5c46c0fd012d59411", "committedDate": "2020-01-26T20:07:18Z", "message": "tighten access\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4NDg2OTA2", "url": "https://github.com/hyperledger/besu/pull/326#pullrequestreview-348486906", "createdAt": "2020-01-27T08:08:21Z", "commit": {"oid": "49c9b3473de834f6ec35c3a5c46c0fd012d59411"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QwODowODoyMVrOFh6SZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QwODoxMDoyMFrOFh6U8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTEwMjMxMQ==", "bodyText": "(Suggestion) Maybe add final modifier. Same comment for multiple local variables in this method.", "url": "https://github.com/hyperledger/besu/pull/326#discussion_r371102311", "createdAt": "2020-01-27T08:08:21Z", "author": {"login": "abdelhamidbakhta"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/diff/StateDiffGenerator.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ *\n+ */\n+\n+package org.hyperledger.besu.ethereum.api.jsonrpc.internal.results.tracing.diff;\n+\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.processor.TransactionTrace;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.results.tracing.Trace;\n+import org.hyperledger.besu.ethereum.core.AbstractWorldUpdater;\n+import org.hyperledger.besu.ethereum.core.AbstractWorldUpdater.UpdateTrackingAccount;\n+import org.hyperledger.besu.ethereum.core.Account;\n+import org.hyperledger.besu.ethereum.core.Address;\n+import org.hyperledger.besu.ethereum.core.Wei;\n+import org.hyperledger.besu.ethereum.core.WorldUpdater;\n+import org.hyperledger.besu.ethereum.debug.TraceFrame;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.TreeMap;\n+import java.util.function.Function;\n+import java.util.stream.Stream;\n+\n+import org.apache.tuweni.units.bigints.UInt256;\n+\n+public class StateDiffGenerator {\n+\n+  public Stream<Trace> generateStateDiff(final TransactionTrace transactionTrace) {\n+    List<TraceFrame> traceFrames = transactionTrace.getTraceFrames();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49c9b3473de834f6ec35c3a5c46c0fd012d59411"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTEwMjk2Mg==", "bodyText": "Why not  filtering the transactionUpdater.getTouchedAccounts Collection to have only UpdateTrackingAccount types ?", "url": "https://github.com/hyperledger/besu/pull/326#discussion_r371102962", "createdAt": "2020-01-27T08:10:20Z", "author": {"login": "abdelhamidbakhta"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/diff/StateDiffGenerator.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ *\n+ */\n+\n+package org.hyperledger.besu.ethereum.api.jsonrpc.internal.results.tracing.diff;\n+\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.processor.TransactionTrace;\n+import org.hyperledger.besu.ethereum.api.jsonrpc.internal.results.tracing.Trace;\n+import org.hyperledger.besu.ethereum.core.AbstractWorldUpdater;\n+import org.hyperledger.besu.ethereum.core.AbstractWorldUpdater.UpdateTrackingAccount;\n+import org.hyperledger.besu.ethereum.core.Account;\n+import org.hyperledger.besu.ethereum.core.Address;\n+import org.hyperledger.besu.ethereum.core.Wei;\n+import org.hyperledger.besu.ethereum.core.WorldUpdater;\n+import org.hyperledger.besu.ethereum.debug.TraceFrame;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.TreeMap;\n+import java.util.function.Function;\n+import java.util.stream.Stream;\n+\n+import org.apache.tuweni.units.bigints.UInt256;\n+\n+public class StateDiffGenerator {\n+\n+  public Stream<Trace> generateStateDiff(final TransactionTrace transactionTrace) {\n+    List<TraceFrame> traceFrames = transactionTrace.getTraceFrames();\n+    if (traceFrames.size() < 1) {\n+      return Stream.empty();\n+    }\n+\n+    // This corresponds to the world state after the TX executed\n+    // It is two deep because of the way we addressed Spurious Dragon.\n+    WorldUpdater transactionUpdater =\n+        traceFrames\n+            .get(0)\n+            .getMessageFrame()\n+            .getWorldState()\n+            .parentUpdater()\n+            .get()\n+            .parentUpdater()\n+            .get();\n+    // This corresponds to the world state prior to the TX execution,\n+    // Either the initial block state or the state of the prior TX\n+    WorldUpdater previousUpdater = transactionUpdater.parentUpdater().get();\n+\n+    StateDiffTrace stateDiffResult = new StateDiffTrace();\n+\n+    for (Account touchedAccount : transactionUpdater.getTouchedAccounts()) {\n+      if (!(touchedAccount instanceof AbstractWorldUpdater.UpdateTrackingAccount)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49c9b3473de834f6ec35c3a5c46c0fd012d59411"}, "originalPosition": 65}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1897, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}