{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNzI2OTAw", "number": 1390, "title": "handle case where onchain groups do not exist", "bodyText": "Signed-off-by: Sally MacFarlane sally.macfarlane@consensys.net\nOnchain groups do not get created before they are queried. This means we cannot assume the privacyGroup will exist. Also added unit tests for this case.\nManual testing:\nPostman query priv_getTransactionCount() for a group that does not exist returns zero (previously \"Unable to determine nonce for account in group.\")\nWIP web3js-eea onChainPrivacy/multiTenancyExample can now create privacy group  (previously \"Unable to determine nonce for account in group.\")\nSee #1389 for further testing that was carried out\nChangelog\n\n I thought about the changelog and included a changelog update if required.", "createdAt": "2020-09-22T06:41:55Z", "url": "https://github.com/hyperledger/besu/pull/1390", "merged": true, "mergeCommit": {"oid": "ba495f783ed9ba909238e9e3f604af848de817af"}, "closed": true, "closedAt": "2020-09-24T21:48:35Z", "author": {"login": "macfarla"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLSIF-AH2gAyNDkwNzI2OTAwOmNmMmZhZTY1YmVjNDFkNmY5ZmY0NDkzZGIyYjFjOTYyYzZiYTgwYWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMICItAH2gAyNDkwNzI2OTAwOmM4ZWExNzNlZGI3OGZkNmU1OTJlMzFiNTdlZDFjMGQyNTFkM2M0NTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cf2fae65bec41d6f9ff4493db2b1c962c6ba80af", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/cf2fae65bec41d6f9ff4493db2b1c962c6ba80af", "committedDate": "2020-09-22T06:37:32Z", "message": "handle case where onchain groups do not exist\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1654e26f4af65eda4407869f1b575860a0ccfa3", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/f1654e26f4af65eda4407869f1b575860a0ccfa3", "committedDate": "2020-09-24T03:07:51Z", "message": "added constructor so the tests can mock the onchain management contract\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b239bdf83d25c701cac54e08256c0200621d40b9", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/b239bdf83d25c701cac54e08256c0200621d40b9", "committedDate": "2020-09-24T03:09:17Z", "message": "removed TODO comment\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21befdae84ef8a7a211f38351253241d0c095e40", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/21befdae84ef8a7a211f38351253241d0c095e40", "committedDate": "2020-09-24T03:10:02Z", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into onchain-mt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33ab2e72bed8529030fb22e7bdbe1e07aa31fe9a", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/33ab2e72bed8529030fb22e7bdbe1e07aa31fe9a", "committedDate": "2020-09-24T03:15:36Z", "message": "unused variable\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MjQwNDg1", "url": "https://github.com/hyperledger/besu/pull/1390#pullrequestreview-495240485", "createdAt": "2020-09-24T05:58:45Z", "commit": {"oid": "33ab2e72bed8529030fb22e7bdbe1e07aa31fe9a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwNTo1ODo0NlrOHXKzlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwNTo1ODo0NlrOHXKzlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA1NjM0Mg==", "bodyText": "It feels like this logic could be polished a bit. Maybe separating the logic for finding a ground onchain vs offchain in separate methods would make it a bit easier to read?", "url": "https://github.com/hyperledger/besu/pull/1390#discussion_r494056342", "createdAt": "2020-09-24T05:58:46Z", "author": {"login": "lucassaldanha"}, "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/MultiTenancyPrivacyController.java", "diffHunk": "@@ -260,17 +273,28 @@ public void verifyPrivacyGroupContainsEnclavePublicKey(\n   public void verifyPrivacyGroupContainsEnclavePublicKey(\n       final String privacyGroupId, final String enclavePublicKey, final Optional<Long> blockNumber)\n       throws MultiTenancyValidationException {\n-    // TODO: There's potentially a bug here where an onchain privacyGroup\n-    // that isn't found will default to the offchain privacy group.\n-    final PrivacyGroup privacyGroup =\n-        onchainPrivacyGroupContract\n-            .flatMap(\n-                contract -> contract.getPrivacyGroupByIdAndBlockNumber(privacyGroupId, blockNumber))\n-            .orElse(enclave.retrievePrivacyGroup(privacyGroupId));\n-\n-    if (!privacyGroup.getMembers().contains(enclavePublicKey)) {\n-      throw new MultiTenancyValidationException(\n-          \"Privacy group must contain the enclave public key\");\n+    Optional<PrivacyGroup> maybePrivacyGroup;\n+    PrivacyGroup offchainPrivacyGroup;\n+    if (onchainPrivacyGroupContract.isPresent()) {\n+      maybePrivacyGroup =\n+          onchainPrivacyGroupContract\n+              .get()\n+              .getPrivacyGroupByIdAndBlockNumber(privacyGroupId, blockNumber);\n+      if (maybePrivacyGroup.isEmpty()) {\n+        // group doesn't exist yet - this is normal for onchain privacy groups\n+      } else {\n+        // group DOES exist - does it contain the user?\n+        if (!maybePrivacyGroup.get().getMembers().contains(enclavePublicKey)) {\n+          throw new MultiTenancyValidationException(\n+              \"Privacy group must contain the enclave public key\");\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33ab2e72bed8529030fb22e7bdbe1e07aa31fe9a"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MjQwNzQ5", "url": "https://github.com/hyperledger/besu/pull/1390#pullrequestreview-495240749", "createdAt": "2020-09-24T05:59:23Z", "commit": {"oid": "33ab2e72bed8529030fb22e7bdbe1e07aa31fe9a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8ea173edb78fd6e592e31b57ed1c0d251d3c459", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/c8ea173edb78fd6e592e31b57ed1c0d251d3c459", "committedDate": "2020-09-24T21:25:54Z", "message": "refactoring\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2160, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}