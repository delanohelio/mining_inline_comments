{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3NjI3NTU2", "number": 1542, "title": "Handle legacy fork id Eth/64", "bodyText": "PR description\nThe fork id computation has been updated to not include 0 fork blocks in the list of forks used to compute the fork id.\nAs a result, previous Besu versions are not capable anymore to talk to newest versions of Besu because their fork id are rejected with the new computation method.\nWe should allow previous Besu nodes to talk with new Besu nodes by adding a command line flag that enable the legacy fork id computation.\nThis PR adds a CLI flag to enable the legacy fork id computation method: --compatibility-eth64-forkid-enabled defaulted to false.\nFixed Issue(s)\nAdresses #1541\nTesting\nManual Test\nSetup\nLocal testnet with 2 Besu nodes:\n\nbesu/v20.10.1-dev-9589ae08/osx-x86_64/adoptopenjdk-java-11\n\n--compatibility-eth64-forkid-enabled=true\n\n\nbesu/v1.4.6/osx-x86_64/adoptopenjdk-java-11\n\nGenesis\n{\n  \"config\": {\n    \"chainId\": 1542,\n    \"homesteadBlock\": 0,\n    \"eip150Block\": 0,\n    \"eip155Block\": 0,\n    \"eip158Block\": 4,\n    \"byzantiumBlock\": 5,\n    \"constantinopleBlock\": 6,\n    \"petersburgBlock\": 7,\n    \"istanbulBlock\": 8,\n    \"muirGlacierBlock\": 9,\n    \"ethash\": {\n    }\n  },\n  \"difficulty\": \"0x20\",\n  \"gasLimit\": \"0x200B20\",\n  \"alloc\": {\n    \"fe3b557e8fb62b89f4916b721be55ceb828dbd73\": {\n      \"privateKey\": \"8f2a55949038a9610f50fb23b5883af3b4ecb3c3bb792cbcefbd1542c692be63\",\n      \"balance\": \"90000000000000000000000\"\n    },\n    \"627306090abaB3A6e1400e9345bC60c78a8BEf57\": {\n      \"privateKey\": \"c87509a1c067bbde78beb793e6fa76530b6382a4c0241e5e4a9ec0a0f44dc0d3\",\n      \"balance\": \"90000000000000000000000\"\n    },\n    \"f17f52151EbEF6C7334FAD080c5704D77216b732\": {\n      \"privateKey\": \"ae6ae8e5ccbfb04590405997ee2d52d2b330726137b875053c36d94e974d162f\",\n      \"balance\": \"90000000000000000000000\"\n    }\n  }\n}\nResult\nNodes are able to communicate correctly using Eth/64 subprotocol.\nAdmin peers of besu/v20.10.1\n{\n    \"jsonrpc\": \"2.0\",\n    \"id\": 1,\n    \"result\": [\n        {\n            \"version\": \"0x5\",\n            \"name\": \"besu/v1.4.6/osx-x86_64/adoptopenjdk-java-11\",\n            \"caps\": [\n                \"eth/62\",\n                \"eth/63\",\n                \"eth/64\"\n            ],\n            \"network\": {\n                \"localAddress\": \"127.0.0.1:50958\",\n                \"remoteAddress\": \"127.0.0.1:40303\"\n            },\n            \"port\": \"0x9d6f\",\n            \"id\": \"0x3eca270e124b5e24e846bb39d0a911d152cfd2671be079478e72e768363c959852301b40b2afffddbe45a285fd752fa4541e8376f73dad688757e0a07a35e164\"\n        }\n    ]\n}\nAdmin peers of besu/v1.4.6\n{\n    \"jsonrpc\": \"2.0\",\n    \"id\": 1,\n    \"result\": [\n        {\n            \"version\": \"0x5\",\n            \"name\": \"besu/v20.10.1-dev-9589ae08/osx-x86_64/adoptopenjdk-java-11\",\n            \"caps\": [\n                \"eth/62\",\n                \"eth/63\",\n                \"eth/64\"\n            ],\n            \"network\": {\n                \"localAddress\": \"127.0.0.1:40303\",\n                \"remoteAddress\": \"127.0.0.1:50958\"\n            },\n            \"port\": \"0x765f\",\n            \"id\": \"0x1c6d296749018e4e4a78baf9a8a3048aae2557c3f2f11a340570d57e71071e2e9816a5f5d9215a333d12b432a81ff5017520b09461c4a102e72c7a1a2d9d7d0f\"\n        }\n    ]\n}\nUnit tests\nAdded ForkIdBackwardCompatibilityTest class to cover backward compatibility testing.\nCopied legacy ForkIdManager from Besu 1.4.6 and added as a test resource to compute expected results for tests.\nChangelog\n\n I thought about the changelog and included a changelog update if required.\n\nSigned-off-by: Abdelhamid Bakhta abdelhamid.bakhta@consensys.net", "createdAt": "2020-11-09T09:42:45Z", "url": "https://github.com/hyperledger/besu/pull/1542", "merged": true, "mergeCommit": {"oid": "0bedfffe027536ca95a74cc069097ea1aa166a38"}, "closed": true, "closedAt": "2020-11-13T09:37:20Z", "author": {"login": "abdelhamidbakhta"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdaxcTqAH2gAyNTE3NjI3NTU2OmIyZGY1OGY3ODI0YzlmMWQ1MDMwNTQ0ZWJkNGMzMTZjYWQ5NjE5MGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdcDJoagH2gAyNTE3NjI3NTU2OjI3NzllOWI4Y2FlZDZkZWM5ODIxYWVkMTBmMTAwZGQ1MGZmNTc0YjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b2df58f7824c9f1d5030544ebd4c316cad96190e", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/b2df58f7824c9f1d5030544ebd4c316cad96190e", "committedDate": "2020-11-09T09:35:32Z", "message": "Handle legacy fork id Eth/64\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7aa5173739acb834c7c680653e73e52900de621f", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/7aa5173739acb834c7c680653e73e52900de621f", "committedDate": "2020-11-09T09:43:44Z", "message": "update changelog\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a4b6bc3a1d078aca3161c37c2059ad288346360", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/0a4b6bc3a1d078aca3161c37c2059ad288346360", "committedDate": "2020-11-09T09:53:45Z", "message": "spotless apply\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MzI0ODc0", "url": "https://github.com/hyperledger/besu/pull/1542#pullrequestreview-526324874", "createdAt": "2020-11-09T14:43:53Z", "commit": {"oid": "0a4b6bc3a1d078aca3161c37c2059ad288346360"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NDQ4MDkx", "url": "https://github.com/hyperledger/besu/pull/1542#pullrequestreview-526448091", "createdAt": "2020-11-09T16:44:24Z", "commit": {"oid": "0a4b6bc3a1d078aca3161c37c2059ad288346360"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9589ae0894087ed453e3e54defe852e5a28c28ea", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/9589ae0894087ed453e3e54defe852e5a28c28ea", "committedDate": "2020-11-12T08:11:49Z", "message": "Merge remote-tracking branch 'upstream/master' into forkid-backward-compatibility\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd255562e5657b7d4faa1d5e2c6d7d63fb266f85", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/bd255562e5657b7d4faa1d5e2c6d7d63fb266f85", "committedDate": "2020-11-12T09:04:19Z", "message": "handle legacy fork id computation\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MDcxNDAw", "url": "https://github.com/hyperledger/besu/pull/1542#pullrequestreview-529071400", "createdAt": "2020-11-12T13:12:11Z", "commit": {"oid": "bd255562e5657b7d4faa1d5e2c6d7d63fb266f85"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMzoxMjoxMVrOHx6IeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMzoxNjo1N1rOHx6Tgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA5NDcxMw==", "bodyText": "If you use isEmpty here it's easier to parse at a glance how it differs from the version below", "url": "https://github.com/hyperledger/besu/pull/1542#discussion_r522094713", "createdAt": "2020-11-12T13:12:11Z", "author": {"login": "RatanRSur"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkIdManager.java", "diffHunk": "@@ -61,6 +64,9 @@ public ForkIdManager(final Blockchain blockchain, final List<Long> nonFilteredFo\n   }\n \n   public ForkId computeForkId() {\n+    if (legacyEth64) {\n+      return forkAndHashList.size() > 0 ? forkAndHashList.get(forkAndHashList.size() - 1) : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd255562e5657b7d4faa1d5e2c6d7d63fb266f85"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA5NzUzOA==", "bodyText": "Do we need to keep these unused methods around?", "url": "https://github.com/hyperledger/besu/pull/1542#discussion_r522097538", "createdAt": "2020-11-12T13:16:57Z", "author": {"login": "RatanRSur"}, "path": "ethereum/eth/src/test/java/org/hyperledger/besu/ethereum/eth/LegacyForkIdManager.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth;\n+\n+import org.hyperledger.besu.ethereum.chain.Blockchain;\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.ethereum.eth.manager.ForkId;\n+import org.hyperledger.besu.ethereum.rlp.RLPInput;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.zip.CRC32;\n+\n+import org.apache.tuweni.bytes.Bytes;\n+import org.apache.tuweni.bytes.Bytes32;\n+\n+public class LegacyForkIdManager {\n+\n+  private final Blockchain blockchain;\n+  private final Hash genesisHash;\n+  private final List<Long> forks;\n+  private long forkNext;\n+  private final long highestKnownFork;\n+  private List<ForkId> forkAndHashList;\n+\n+  public LegacyForkIdManager(final Blockchain blockchain, final List<Long> forks) {\n+    this.blockchain = blockchain;\n+    this.genesisHash = blockchain.getGenesisBlock().getHash();\n+    // de-dupe and sanitize forks\n+    this.forks =\n+        forks.stream().filter(fork -> fork > 0).distinct().collect(Collectors.toUnmodifiableList());\n+    highestKnownFork = forks.size() > 0 ? forks.get(forks.size() - 1) : 0L;\n+    createForkIds();\n+  };\n+\n+  public List<ForkId> getForkAndHashList() {\n+    return this.forkAndHashList;\n+  }\n+\n+  public ForkId getLatestForkId() {\n+    if (forkAndHashList.size() > 0) {\n+      return forkAndHashList.get(forkAndHashList.size() - 1);\n+    }\n+    return null;\n+  }\n+\n+  public static ForkId readFrom(final RLPInput in) {\n+    in.enterList();\n+    final Bytes hash = in.readBytes();\n+    final Bytes next = in.readBytes();\n+    in.leaveList();\n+    return new ForkId(hash, next);\n+  }\n+\n+  /**\n+   * EIP-2124 behaviour\n+   *\n+   * @param forkId to be validated.\n+   * @return boolean (peer valid (true) or invalid (false))\n+   */\n+  boolean peerCheck(final ForkId forkId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd255562e5657b7d4faa1d5e2c6d7d63fb266f85"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9140de0441ef879fffd43dd1abc1b63ce7565888", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/9140de0441ef879fffd43dd1abc1b63ce7565888", "committedDate": "2020-11-12T13:24:15Z", "message": "address PR comments\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25aee359c1c561fd3eb49a1fb190e6adaeb266e2", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/25aee359c1c561fd3eb49a1fb190e6adaeb266e2", "committedDate": "2020-11-12T13:35:26Z", "message": "fix error prone\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "315ca8829c29cc0e26ca0d07e07ea9fbf671bd7e", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/315ca8829c29cc0e26ca0d07e07ea9fbf671bd7e", "committedDate": "2020-11-12T13:39:28Z", "message": "Merge remote-tracking branch 'upstream/master' into forkid-backward-compatibility\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MjIwNDgy", "url": "https://github.com/hyperledger/besu/pull/1542#pullrequestreview-529220482", "createdAt": "2020-11-12T15:45:18Z", "commit": {"oid": "315ca8829c29cc0e26ca0d07e07ea9fbf671bd7e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a0c60b6ea4222c5402cfdc5a088cfbb416e0957", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/2a0c60b6ea4222c5402cfdc5a088cfbb416e0957", "committedDate": "2020-11-12T17:32:30Z", "message": "Merge remote-tracking branch 'upstream/master' into forkid-backward-compatibility\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a33778062d72c894cc5e77ef43020fcd67fea22", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/8a33778062d72c894cc5e77ef43020fcd67fea22", "committedDate": "2020-11-13T08:25:40Z", "message": "Merge remote-tracking branch 'upstream/master' into forkid-backward-compatibility\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>\n\n# Conflicts:\n#\tCHANGELOG.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2779e9b8caed6dec9821aed10f100dd50ff574b3", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/2779e9b8caed6dec9821aed10f100dd50ff574b3", "committedDate": "2020-11-13T08:47:21Z", "message": "- update changelog\n- change cli option name\n- add unit tests\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2067, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}