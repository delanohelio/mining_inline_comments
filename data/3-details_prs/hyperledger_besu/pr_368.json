{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxNTk3OTg1", "number": 368, "title": "[BOUNTY-2] Add NAT Docker Support ", "bodyText": "Signed-off-by: Karim TAAM karim.t2am@gmail.com\nPR description\nThe goal of this work is to offer developers a consistent API for performing NAT tasks, and add support for Docker\u2019s NAT implementation when Pantheon is being run from a Docker container.\nHere is a proposal for the bounty allowing to detect the Docker environment automatically.\n\nProperly detects when Pantheon is being run inside a docker container.\n\nBesu will automatically detect that the client is in a docker.\n\nInteracts with Docker APIs, as needed, to determine external IP address and exposed ports.\n\nThere is no method to detect the port mapping and the host IP.\nThere is host.docker.internal which is created by docker and which allows to recover the internal IP used by the host(https://docs.docker.com/docker-for-windows/networking/) but this is not the external IP. In addition we can have several layers between the real external IP address and the besu client (docker, box, etc.)\nThe port mapping is also not accessible from the container. There are methods but it looks more like a hack than a real solution (https://stackoverflow.com/questions/32444612/how-to-get-the-mapped-port-on-host-from-a-docker-container)\nI suggest that if the client detects that it is launched in a docker it will look for :\n\nthe IP address of a host, given a specific hostname (HOST_IP).\nthe port mapping, given a specific environment variable\n\nSo you can run a docker like that :\ndocker run --add-host=HOST_IP:77.202.XXX.YYY --env HOST_PORT_8545=8046 -it besu-dev:latest --p2p-enabled=true --rpc-http-enabled --rpc-http-apis=\"eth,net,web3,debug,admin\"", "createdAt": "2020-02-05T21:37:28Z", "url": "https://github.com/hyperledger/besu/pull/368", "merged": true, "mergeCommit": {"oid": "39826b14231ef8cff7ca88589ed21972120b3e40"}, "closed": true, "closedAt": "2020-02-10T20:13:21Z", "author": {"login": "matkt"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8m8z8AH2gAyMzcxNTk3OTg1OjQ1ZTJjNGFjMTVlYzhlNTdkNmI5ZjYyZjk5MmI3NmFmOTM1NDEwOTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDCpJ4gFqTM1NjIxNzUwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "45e2c4ac15ec8e57d6b9f62f992b76af93541094", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/45e2c4ac15ec8e57d6b9f62f992b76af93541094", "committedDate": "2020-01-21T20:13:12Z", "message": "add docker detection\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d002b1213c27ccb3169e9d621cc9eccb3693ec44", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/d002b1213c27ccb3169e9d621cc9eccb3693ec44", "committedDate": "2020-02-02T15:37:29Z", "message": "add port mapping detection\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e10e9ca1c3c553ea941c89aac0a8d5ee500f5ca6", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/e10e9ca1c3c553ea941c89aac0a8d5ee500f5ca6", "committedDate": "2020-02-05T21:21:30Z", "message": "add tests and refactor ip detection\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3df06c0b2d8de29b4610a3863d70d95fa0f3d9a8", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/3df06c0b2d8de29b4610a3863d70d95fa0f3d9a8", "committedDate": "2020-02-05T21:27:00Z", "message": "clean RunnerBuilder\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef679aa86ebdbb07714076c2f2838035cd79b3d6", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/ef679aa86ebdbb07714076c2f2838035cd79b3d6", "committedDate": "2020-02-05T21:31:10Z", "message": "clean useless modification\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa85458f187e55c34da9c3a587f7bb9edaac97c5", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/aa85458f187e55c34da9c3a587f7bb9edaac97c5", "committedDate": "2020-02-05T22:58:06Z", "message": "spotless\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "599de6788f9a0be7fcd0d915d14a0a22aabf5c93", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/599de6788f9a0be7fcd0d915d14a0a22aabf5c93", "committedDate": "2020-02-06T18:09:25Z", "message": "resolve tests issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdcf72c0e8895f9f76e28e5aba39110262878f7e", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/fdcf72c0e8895f9f76e28e5aba39110262878f7e", "committedDate": "2020-02-07T14:09:35Z", "message": "Merge branch 'master' into feature/bounty-add-nat-docker-support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "803d345deaf09f02db0aa2bf948db6fc3a30ca32", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/803d345deaf09f02db0aa2bf948db6fc3a30ca32", "committedDate": "2020-02-07T14:37:48Z", "message": "Merge branch 'master' into feature/bounty-add-nat-docker-support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "066361ca048e8d7feb19d431e5dee768b970b185", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/066361ca048e8d7feb19d431e5dee768b970b185", "committedDate": "2020-02-07T18:16:30Z", "message": "streamline auto detection\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f89baf487d751588b3720ccd67b2f954573e879b", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/f89baf487d751588b3720ccd67b2f954573e879b", "committedDate": "2020-02-07T19:21:31Z", "message": "Merge pull request #15 from RatanRSur/feature/bounty-add-nat-docker-support\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>\r\n\r\nstreamline auto detection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc958ecb18d41ad61ebd75e4b9f9df70d84fa81c", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/fc958ecb18d41ad61ebd75e4b9f9df70d84fa81c", "committedDate": "2020-02-10T07:50:54Z", "message": "Merge branch 'master' into feature/bounty-add-nat-docker-support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MDgxNTc2", "url": "https://github.com/hyperledger/besu/pull/368#pullrequestreview-356081576", "createdAt": "2020-02-10T16:31:26Z", "commit": {"oid": "fc958ecb18d41ad61ebd75e4b9f9df70d84fa81c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNjozMToyNlrOFns3kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNjozMToyNlrOFns3kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE3MzkwNA==", "bodyText": "How does this behave if you don't supply the HOST_IP env var to the docker command?", "url": "https://github.com/hyperledger/besu/pull/368#discussion_r377173904", "createdAt": "2020-02-10T16:31:26Z", "author": {"login": "RatanRSur"}, "path": "nat/src/main/java/org/hyperledger/besu/nat/docker/HostBasedIpDetector.java", "diffHunk": "@@ -13,25 +13,22 @@\n  * SPDX-License-Identifier: Apache-2.0\n  */\n \n-package org.hyperledger.besu.nat.core;\n+package org.hyperledger.besu.nat.docker;\n \n-import org.hyperledger.besu.nat.NatMethod;\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.util.Optional;\n \n-public class AutoDetectionResult {\n+public class HostBasedIpDetector implements IpDetector {\n \n-  private final NatMethod natMethod;\n-  private final boolean isDetectedNatMethod;\n+  private static final String HOSTNAME = \"HOST_IP\";\n \n-  public AutoDetectionResult(final NatMethod natMethod, final boolean isDetectedNatMethod) {\n-    this.natMethod = natMethod;\n-    this.isDetectedNatMethod = isDetectedNatMethod;\n-  }\n-\n-  public NatMethod getNatMethod() {\n-    return natMethod;\n-  }\n-\n-  public boolean isDetectedNatMethod() {\n-    return isDetectedNatMethod;\n+  @Override\n+  public Optional<String> detectExternalIp() {\n+    try {\n+      return Optional.of(InetAddress.getByName(HOSTNAME).getHostAddress());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc958ecb18d41ad61ebd75e4b9f9df70d84fa81c"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MTE1MjY5", "url": "https://github.com/hyperledger/besu/pull/368#pullrequestreview-356115269", "createdAt": "2020-02-10T17:14:44Z", "commit": {"oid": "fc958ecb18d41ad61ebd75e4b9f9df70d84fa81c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "399ea929d5859c00f58beea73af34f272a7b3380", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/399ea929d5859c00f58beea73af34f272a7b3380", "committedDate": "2020-02-10T19:51:21Z", "message": "Merge branch 'master' into feature/bounty-add-nat-docker-support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MjE3NTA1", "url": "https://github.com/hyperledger/besu/pull/368#pullrequestreview-356217505", "createdAt": "2020-02-10T19:52:37Z", "commit": {"oid": "399ea929d5859c00f58beea73af34f272a7b3380"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1935, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}