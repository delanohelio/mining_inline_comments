{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0MDcwNzM5", "number": 1375, "title": "Refactor transaction rlp encoding / decoding ", "bodyText": "PR description\nCurrently RLP encoding and decoding operations are performed inside Transaction class. And with new EIP-1559 transactions type and potentially with new types introduced by EIP-2718 typed transaction envelope (https://eips.ethereum.org/EIPS/eip-2718), the complexity of this class increases a lot and the readability decreases. We need to refactor this class and introduce helper classes to perform encoding / decoding operations so that we don't have to update Transaction class each time we introduce a new type.\nChanges summary\n\nAdded TransactionRLPDecoder with Transaction decode(RLPInput input); method.\nAdded TransactionRLPEncoder with void encode(Transaction transaction, RLPOutput output); method.\nAdded TransactionRLPEncoderDecoder with 2 static methods:\n\nstatic void encode(final Transaction transaction, final RLPOutput output)\nstatic Transaction decode(final RLPInput input)\n\n\nUpdated Transaction class to use TransactionRLPEncoderDecoder.\n\nFixed Issue(s)\nfixes #1364\nSigned-off-by: Abdelhamid Bakhta abdelhamid.bakhta@consensys.net", "createdAt": "2020-09-10T16:24:40Z", "url": "https://github.com/hyperledger/besu/pull/1375", "merged": true, "mergeCommit": {"oid": "31df8660d43afb06e431acbcc4d45f6376ce065c"}, "closed": true, "closedAt": "2020-09-14T16:34:21Z", "author": {"login": "abdelhamidbakhta"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHjRlDgH2gAyNDg0MDcwNzM5OjgwN2FmZWM5ODgwNWI2M2E1OTM1M2Y3ZTJlZjdiZTU0YWE0MGJlZjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdI1fBegH2gAyNDg0MDcwNzM5OjVkZWU5NmZiM2U1MWU3M2JjYjYxOThlY2I4NWYwMWRjYTY4OTViZDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "807afec98805b63a59353f7e2ef7be54aa40bef1", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/807afec98805b63a59353f7e2ef7be54aa40bef1", "committedDate": "2020-09-10T16:20:35Z", "message": "Add utility classes to deal with RLP encoding / decoding of transactions.\n- Added `TransactionRLPDecoder` with `Transaction decode(RLPInput input);` method.\n- Added `TransactionRLPEncoder` with `void encode(Transaction transaction, RLPOutput output);` method.\n- Added `TransactionRLPEncoderDecoder` with 2 static methods:\n    - `static void encode(final Transaction transaction, final RLPOutput output)`\n    - `static Transaction decode(final RLPInput input)`\n- Updated `Transaction` class to use `TransactionRLPEncoderDecoder`.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e8c1071ff084ff21e10c183fcaf4eb2a624fa72", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/2e8c1071ff084ff21e10c183fcaf4eb2a624fa72", "committedDate": "2020-09-10T16:20:46Z", "message": "Merge remote-tracking branch 'upstream/master' into 1364\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1bac29a8ab2a28f96252f2eb75c8562e2cea711", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/c1bac29a8ab2a28f96252f2eb75c8562e2cea711", "committedDate": "2020-09-10T16:31:10Z", "message": "Update plugin api hash\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MTE5OTQ1", "url": "https://github.com/hyperledger/besu/pull/1375#pullrequestreview-486119945", "createdAt": "2020-09-10T16:39:50Z", "commit": {"oid": "c1bac29a8ab2a28f96252f2eb75c8562e2cea711"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjozOTo1MFrOHP8pXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjozOTo1MFrOHP8pXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ4NDMxOQ==", "bodyText": "Why can't this switching logic go inside the encoder and decoder classes?", "url": "https://github.com/hyperledger/besu/pull/1375#discussion_r486484319", "createdAt": "2020-09-10T16:39:50Z", "author": {"login": "RatanRSur"}, "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/encoding/TransactionRLPEncoderDecoder.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.core.encoding;\n+\n+import org.hyperledger.besu.config.experimental.ExperimentalEIPs;\n+import org.hyperledger.besu.ethereum.core.Transaction;\n+import org.hyperledger.besu.ethereum.rlp.RLPInput;\n+import org.hyperledger.besu.ethereum.rlp.RLPOutput;\n+import org.hyperledger.besu.plugin.data.TransactionType;\n+\n+import com.google.common.collect.ImmutableMap;\n+\n+public class TransactionRLPEncoderDecoder {\n+\n+  private static final TransactionRLPEncoder DEFAULT_ENCODER = TransactionRLPEncoder.FRONTIER;\n+  private static final ImmutableMap<TransactionType, TransactionRLPEncoder> ENCODERS =\n+      ImmutableMap.of(\n+          TransactionType.FRONTIER,\n+          TransactionRLPEncoder.FRONTIER,\n+          TransactionType.EIP1559,\n+          TransactionRLPEncoder.EIP1559);\n+\n+  public static void encode(final Transaction transaction, final RLPOutput output) {\n+    ENCODERS.getOrDefault(transaction.getType(), DEFAULT_ENCODER).encode(transaction, output);\n+  }\n+\n+  public static Transaction decode(final RLPInput input) {\n+    final TransactionRLPDecoder decoder =\n+        ExperimentalEIPs.eip1559Enabled\n+            ? TransactionRLPDecoder.EIP1559\n+            : TransactionRLPDecoder.FRONTIER;\n+    return decoder.decode(input);\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1bac29a8ab2a28f96252f2eb75c8562e2cea711"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MTIxMjk5", "url": "https://github.com/hyperledger/besu/pull/1375#pullrequestreview-486121299", "createdAt": "2020-09-10T16:41:42Z", "commit": {"oid": "c1bac29a8ab2a28f96252f2eb75c8562e2cea711"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjo0MTo0MlrOHP8t4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjo0MTo0MlrOHP8t4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ4NTQ3NA==", "bodyText": "Trying to understand this. No matter what the RLP is we decode it as an eip1559 transaction if that's enabled? We don't need to do any checks on the decoded rlp to see if it's a legacy tx?", "url": "https://github.com/hyperledger/besu/pull/1375#discussion_r486485474", "createdAt": "2020-09-10T16:41:42Z", "author": {"login": "RatanRSur"}, "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/encoding/TransactionRLPEncoderDecoder.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.core.encoding;\n+\n+import org.hyperledger.besu.config.experimental.ExperimentalEIPs;\n+import org.hyperledger.besu.ethereum.core.Transaction;\n+import org.hyperledger.besu.ethereum.rlp.RLPInput;\n+import org.hyperledger.besu.ethereum.rlp.RLPOutput;\n+import org.hyperledger.besu.plugin.data.TransactionType;\n+\n+import com.google.common.collect.ImmutableMap;\n+\n+public class TransactionRLPEncoderDecoder {\n+\n+  private static final TransactionRLPEncoder DEFAULT_ENCODER = TransactionRLPEncoder.FRONTIER;\n+  private static final ImmutableMap<TransactionType, TransactionRLPEncoder> ENCODERS =\n+      ImmutableMap.of(\n+          TransactionType.FRONTIER,\n+          TransactionRLPEncoder.FRONTIER,\n+          TransactionType.EIP1559,\n+          TransactionRLPEncoder.EIP1559);\n+\n+  public static void encode(final Transaction transaction, final RLPOutput output) {\n+    ENCODERS.getOrDefault(transaction.getType(), DEFAULT_ENCODER).encode(transaction, output);\n+  }\n+\n+  public static Transaction decode(final RLPInput input) {\n+    final TransactionRLPDecoder decoder =\n+        ExperimentalEIPs.eip1559Enabled\n+            ? TransactionRLPDecoder.EIP1559\n+            : TransactionRLPDecoder.FRONTIER;\n+    return decoder.decode(input);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1bac29a8ab2a28f96252f2eb75c8562e2cea711"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7bda52eb3552b4be1141fdd64bce6c3b59d4863", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/a7bda52eb3552b4be1141fdd64bce6c3b59d4863", "committedDate": "2020-09-10T16:43:39Z", "message": "Add utility classes to deal with RLP encoding / decoding of transactions.\n- Added `TransactionRLPDecoder` with `Transaction decode(RLPInput input);` method.\n- Added `TransactionRLPEncoder` with `void encode(Transaction transaction, RLPOutput output);` method.\n- Added `TransactionRLPEncoderDecoder` with 2 static methods:\n    - `static void encode(final Transaction transaction, final RLPOutput output)`\n    - `static Transaction decode(final RLPInput input)`\n- Updated `Transaction` class to use `TransactionRLPEncoderDecoder`.\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "360df0dfa24e78c3ff9bdab12b156d382b61427f", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/360df0dfa24e78c3ff9bdab12b156d382b61427f", "committedDate": "2020-09-10T16:43:39Z", "message": "Update plugin api hash\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "020dca2454c3c35a6f33e08efbb338807d7b6d80", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/020dca2454c3c35a6f33e08efbb338807d7b6d80", "committedDate": "2020-09-10T16:44:37Z", "message": "Merge branch '1364' of https://github.com/abdelhamidbakhta/besu into 1364"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MTMxMjM2", "url": "https://github.com/hyperledger/besu/pull/1375#pullrequestreview-486131236", "createdAt": "2020-09-10T16:54:42Z", "commit": {"oid": "020dca2454c3c35a6f33e08efbb338807d7b6d80"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjo1NDo0MlrOHP9MUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjo1NDo0MlrOHP9MUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5MzI2NQ==", "bodyText": "I'm wondering if there is a better name for this", "url": "https://github.com/hyperledger/besu/pull/1375#discussion_r486493265", "createdAt": "2020-09-10T16:54:42Z", "author": {"login": "matkt"}, "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/core/Transaction.java", "diffHunk": "@@ -38,16 +39,16 @@\n \n   // Used for transactions that are not tied to a specific chain\n   // (e.g. does not have a chain id associated with it).\n-  private static final BigInteger REPLAY_UNPROTECTED_V_BASE = BigInteger.valueOf(27);\n-  private static final BigInteger REPLAY_UNPROTECTED_V_BASE_PLUS_1 = BigInteger.valueOf(28);\n+  public static final BigInteger REPLAY_UNPROTECTED_V_BASE = BigInteger.valueOf(27);\n+  public static final BigInteger REPLAY_UNPROTECTED_V_BASE_PLUS_1 = BigInteger.valueOf(28);\n \n-  private static final BigInteger REPLAY_PROTECTED_V_BASE = BigInteger.valueOf(35);\n+  public static final BigInteger REPLAY_PROTECTED_V_BASE = BigInteger.valueOf(35);\n \n   // The v signature parameter starts at 36 because 1 is the first valid chainId so:\n   // chainId > 1 implies that 2 * chainId + V_BASE > 36.\n-  private static final BigInteger REPLAY_PROTECTED_V_MIN = BigInteger.valueOf(36);\n+  public static final BigInteger REPLAY_PROTECTED_V_MIN = BigInteger.valueOf(36);\n \n-  private static final BigInteger TWO = BigInteger.valueOf(2);\n+  public static final BigInteger TWO = BigInteger.valueOf(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "020dca2454c3c35a6f33e08efbb338807d7b6d80"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e39e71cd068d4ab04d804048b940451f64777ee7", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/e39e71cd068d4ab04d804048b940451f64777ee7", "committedDate": "2020-09-10T16:58:09Z", "message": "Address PR comments\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ed88508b69f27dd20df10887504654833be9ee8", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/5ed88508b69f27dd20df10887504654833be9ee8", "committedDate": "2020-09-10T17:39:05Z", "message": "Address PR comments\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f273d76dba5344ebc389dcffa51ab5c59c34c8df", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/f273d76dba5344ebc389dcffa51ab5c59c34c8df", "committedDate": "2020-09-11T08:38:18Z", "message": "Merge remote-tracking branch 'upstream/master' into 1364\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "581a88109d9faade7724607aff964ec4590d2bf8", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/581a88109d9faade7724607aff964ec4590d2bf8", "committedDate": "2020-09-14T07:05:26Z", "message": "Merge remote-tracking branch 'upstream/master' into 1364\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96bbe0095644be9cce95922a31d53bb24d964d55", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/96bbe0095644be9cce95922a31d53bb24d964d55", "committedDate": "2020-09-14T15:19:55Z", "message": "Merge remote-tracking branch 'upstream/master' into 1364\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01084064a68c55eb9f2f70596079904985583a1e", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/01084064a68c55eb9f2f70596079904985583a1e", "committedDate": "2020-09-14T16:03:40Z", "message": "Added unit tests\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3d91ddb2489832cf99eb583ae5b629a3f42ba73", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/a3d91ddb2489832cf99eb583ae5b629a3f42ba73", "committedDate": "2020-09-14T16:04:57Z", "message": "Added SPDX header\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3OTI2ODY5", "url": "https://github.com/hyperledger/besu/pull/1375#pullrequestreview-487926869", "createdAt": "2020-09-14T16:05:32Z", "commit": {"oid": "a3d91ddb2489832cf99eb583ae5b629a3f42ba73"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5dee96fb3e51e73bcb6198ecb85f01dca6895bd7", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/5dee96fb3e51e73bcb6198ecb85f01dca6895bd7", "committedDate": "2020-09-14T16:07:29Z", "message": "spotless apply\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1481, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}