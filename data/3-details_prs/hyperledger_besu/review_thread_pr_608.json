{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0OTE4Njc1", "number": 608, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNDo1MjozNVrODstfqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNzoxNjowNFrODtoO6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MjA5MzIzOnYy", "diffSide": "RIGHT", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/EthProtocol.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNDo1MjozNVrOF9tpYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMzozNzoxNFrOF-EIjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI1NTMyOA==", "bodyText": "This deserves a comment.  Since Eth/65 messages operate in a \"hole\" in the Eth/64 message space (0x08->0x0a even though we add 3 messages the highest message number is still 0x10. Without this tidbit one might expect the message space to be 20.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400255328", "createdAt": "2020-03-30T14:52:35Z", "author": {"login": "shemnon"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/EthProtocol.java", "diffHunk": "@@ -65,6 +78,7 @@ public int messageSpace(final int protocolVersion) {\n         return 8;\n       case EthVersion.V63:\n       case EthVersion.V64:\n+      case EthVersion.V65:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYyMzc1Ng==", "bodyText": "Sure thing.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400623756", "createdAt": "2020-03-31T03:37:14Z", "author": {"login": "atoulme"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/EthProtocol.java", "diffHunk": "@@ -65,6 +78,7 @@ public int messageSpace(final int protocolVersion) {\n         return 8;\n       case EthVersion.V63:\n       case EthVersion.V64:\n+      case EthVersion.V65:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI1NTMyOA=="}, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MjE0NzA3OnYy", "diffSide": "RIGHT", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/EthProtocol.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNTowMzo0MFrOF9uLaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMzozODo1M1rOF-EKHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2NDA0MQ==", "bodyText": "Since the codes for pooled transactions are between new block (0x07) and get node data (0x0d) perhaps these should be put at line 106, so we sort by actual code value not by protocol introduced.  This would help remind maintainers of this peculiarity.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400264041", "createdAt": "2020-03-30T15:03:40Z", "author": {"login": "shemnon"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/EthProtocol.java", "diffHunk": "@@ -111,6 +127,12 @@ public String messageName(final int protocolVersion, final int code) {\n         return \"GetReceipts\";\n       case EthPV63.RECEIPTS:\n         return \"Receipts\";\n+      case EthPV65.GET_POOLED_TRANSACTIONS:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYyNDE1Nw==", "bodyText": "ok changed.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400624157", "createdAt": "2020-03-31T03:38:53Z", "author": {"login": "atoulme"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/EthProtocol.java", "diffHunk": "@@ -111,6 +127,12 @@ public String messageName(final int protocolVersion, final int code) {\n         return \"GetReceipts\";\n       case EthPV63.RECEIPTS:\n         return \"Receipts\";\n+      case EthPV65.GET_POOLED_TRANSACTIONS:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2NDA0MQ=="}, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MjE1OTExOnYy", "diffSide": "RIGHT", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/EthProtocolManager.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNTowNjoxMVrOF9uS4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwNjozNToyMFrOF-ynWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2NTk1Mg==", "bodyText": "Why does this need to be moved from constructor args into a bind method?", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400265952", "createdAt": "2020-03-30T15:06:11Z", "author": {"login": "shemnon"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/EthProtocolManager.java", "diffHunk": "@@ -184,6 +176,19 @@ public String getSupportedProtocol() {\n     return supportedCapabilities;\n   }\n \n+  public void bind(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYzNjA2Nw==", "bodyText": "Alright, that's a bit meaty.\nSo EthProtocolManager does define a EthContext instance that is required by TransactionPool and SyncState, which now require it to configure themselves.\nThe EthContext object is built in the constructor of EthProtocolManager with objects built by EthProtocolManager, EthPeers and EthMessages.  While EthPeers is used elsewhere, EthMessages is only used in bind and to handle messages.\nIf you want to move EthContext out of EthProtocolManager, you'll need to also move EthPeers and EthMessages out.\nIs that what you want?", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400636067", "createdAt": "2020-03-31T04:28:14Z", "author": {"login": "atoulme"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/EthProtocolManager.java", "diffHunk": "@@ -184,6 +176,19 @@ public String getSupportedProtocol() {\n     return supportedCapabilities;\n   }\n \n+  public void bind(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2NTk1Mg=="}, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY1Njg2Mg==", "bodyText": "That would more accurately reflect the real complexity.  Also, without the two step binding it makes it easier to move to something like Dagger or Guice to manage all of this.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400656862", "createdAt": "2020-03-31T05:45:34Z", "author": {"login": "shemnon"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/EthProtocolManager.java", "diffHunk": "@@ -184,6 +176,19 @@ public String getSupportedProtocol() {\n     return supportedCapabilities;\n   }\n \n+  public void bind(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2NTk1Mg=="}, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY2NjY3Nw==", "bodyText": "That's interesting, what's the plan around DI?", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400666677", "createdAt": "2020-03-31T06:16:28Z", "author": {"login": "atoulme"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/EthProtocolManager.java", "diffHunk": "@@ -184,6 +176,19 @@ public String getSupportedProtocol() {\n     return supportedCapabilities;\n   }\n \n+  public void bind(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2NTk1Mg=="}, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM4NTMwNQ==", "bodyText": "OK I have flattened the dependencies, let's see once I make all the tests pass again.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r401385305", "createdAt": "2020-04-01T06:35:20Z", "author": {"login": "atoulme"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/EthProtocolManager.java", "diffHunk": "@@ -184,6 +176,19 @@ public String getSupportedProtocol() {\n     return supportedCapabilities;\n   }\n \n+  public void bind(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2NTk1Mg=="}, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 103}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MjE4MDAzOnYy", "diffSide": "RIGHT", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactionSender.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNToxMDoxNVrOF9ufiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwNjozNTo0NVrOF-yn9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2OTE5Mg==", "bodyText": "Why does this need it's own executor?  Why can't it re-use the sync worker?  That's the same queue we are currently sending transactions to peers on already.  I think the OS overhead of yet another executor is unwarranted in this case.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400269192", "createdAt": "2020-03-30T15:10:15Z", "author": {"login": "shemnon"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactionSender.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth.transactions;\n+\n+import org.hyperledger.besu.ethereum.core.Transaction;\n+import org.hyperledger.besu.ethereum.eth.manager.EthContext;\n+import org.hyperledger.besu.ethereum.eth.transactions.TransactionPool.TransactionBatchAddedListener;\n+\n+class PendingTransactionSender implements TransactionBatchAddedListener {\n+\n+  private final PeerPendingTransactionTracker transactionTracker;\n+  private final PendingTransactionsMessageSender transactionsMessageSender;\n+  private final EthContext ethContext;\n+\n+  public PendingTransactionSender(\n+      final PeerPendingTransactionTracker transactionTracker,\n+      final PendingTransactionsMessageSender transactionsMessageSender,\n+      final EthContext ethContext) {\n+    this.transactionTracker = transactionTracker;\n+    this.transactionsMessageSender = transactionsMessageSender;\n+    this.ethContext = ethContext;\n+  }\n+\n+  @Override\n+  public void onTransactionsAdded(final Iterable<Transaction> transactions) {\n+    ethContext\n+        .getEthPeers()\n+        .streamAvailablePeers()\n+        .forEach(\n+            peer ->\n+                transactions.forEach(\n+                    transaction ->\n+                        transactionTracker.addToPeerSendQueue(peer, transaction.getHash())));\n+    ethContext\n+        .getScheduler()\n+        .schedulePendingTransactionsTask(transactionsMessageSender::sendTransactionsToPeers);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYyMzUzOA==", "bodyText": "It allows fine tuning of the executor, as in you can shut off this gossip mechanism. Note that otherwise this is not something you can easily control through settings.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400623538", "createdAt": "2020-03-31T03:36:24Z", "author": {"login": "atoulme"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactionSender.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth.transactions;\n+\n+import org.hyperledger.besu.ethereum.core.Transaction;\n+import org.hyperledger.besu.ethereum.eth.manager.EthContext;\n+import org.hyperledger.besu.ethereum.eth.transactions.TransactionPool.TransactionBatchAddedListener;\n+\n+class PendingTransactionSender implements TransactionBatchAddedListener {\n+\n+  private final PeerPendingTransactionTracker transactionTracker;\n+  private final PendingTransactionsMessageSender transactionsMessageSender;\n+  private final EthContext ethContext;\n+\n+  public PendingTransactionSender(\n+      final PeerPendingTransactionTracker transactionTracker,\n+      final PendingTransactionsMessageSender transactionsMessageSender,\n+      final EthContext ethContext) {\n+    this.transactionTracker = transactionTracker;\n+    this.transactionsMessageSender = transactionsMessageSender;\n+    this.ethContext = ethContext;\n+  }\n+\n+  @Override\n+  public void onTransactionsAdded(final Iterable<Transaction> transactions) {\n+    ethContext\n+        .getEthPeers()\n+        .streamAvailablePeers()\n+        .forEach(\n+            peer ->\n+                transactions.forEach(\n+                    transaction ->\n+                        transactionTracker.addToPeerSendQueue(peer, transaction.getHash())));\n+    ethContext\n+        .getScheduler()\n+        .schedulePendingTransactionsTask(transactionsMessageSender::sendTransactionsToPeers);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2OTE5Mg=="}, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY1NjUxNA==", "bodyText": "There are at least three other similar paired messages that the argument could be made for, but they all still use the sync worker.  I don't think we need a new executor for this group of messages and strongly feel we should use the existing sync worker for these.  It is, after all, the same executor the transactions are polled from in eth/64 and prior.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400656514", "createdAt": "2020-03-31T05:44:17Z", "author": {"login": "shemnon"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactionSender.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth.transactions;\n+\n+import org.hyperledger.besu.ethereum.core.Transaction;\n+import org.hyperledger.besu.ethereum.eth.manager.EthContext;\n+import org.hyperledger.besu.ethereum.eth.transactions.TransactionPool.TransactionBatchAddedListener;\n+\n+class PendingTransactionSender implements TransactionBatchAddedListener {\n+\n+  private final PeerPendingTransactionTracker transactionTracker;\n+  private final PendingTransactionsMessageSender transactionsMessageSender;\n+  private final EthContext ethContext;\n+\n+  public PendingTransactionSender(\n+      final PeerPendingTransactionTracker transactionTracker,\n+      final PendingTransactionsMessageSender transactionsMessageSender,\n+      final EthContext ethContext) {\n+    this.transactionTracker = transactionTracker;\n+    this.transactionsMessageSender = transactionsMessageSender;\n+    this.ethContext = ethContext;\n+  }\n+\n+  @Override\n+  public void onTransactionsAdded(final Iterable<Transaction> transactions) {\n+    ethContext\n+        .getEthPeers()\n+        .streamAvailablePeers()\n+        .forEach(\n+            peer ->\n+                transactions.forEach(\n+                    transaction ->\n+                        transactionTracker.addToPeerSendQueue(peer, transaction.getHash())));\n+    ethContext\n+        .getScheduler()\n+        .schedulePendingTransactionsTask(transactionsMessageSender::sendTransactionsToPeers);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2OTE5Mg=="}, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY1NzA4NA==", "bodyText": "OK.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400657084", "createdAt": "2020-03-31T05:46:19Z", "author": {"login": "atoulme"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactionSender.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth.transactions;\n+\n+import org.hyperledger.besu.ethereum.core.Transaction;\n+import org.hyperledger.besu.ethereum.eth.manager.EthContext;\n+import org.hyperledger.besu.ethereum.eth.transactions.TransactionPool.TransactionBatchAddedListener;\n+\n+class PendingTransactionSender implements TransactionBatchAddedListener {\n+\n+  private final PeerPendingTransactionTracker transactionTracker;\n+  private final PendingTransactionsMessageSender transactionsMessageSender;\n+  private final EthContext ethContext;\n+\n+  public PendingTransactionSender(\n+      final PeerPendingTransactionTracker transactionTracker,\n+      final PendingTransactionsMessageSender transactionsMessageSender,\n+      final EthContext ethContext) {\n+    this.transactionTracker = transactionTracker;\n+    this.transactionsMessageSender = transactionsMessageSender;\n+    this.ethContext = ethContext;\n+  }\n+\n+  @Override\n+  public void onTransactionsAdded(final Iterable<Transaction> transactions) {\n+    ethContext\n+        .getEthPeers()\n+        .streamAvailablePeers()\n+        .forEach(\n+            peer ->\n+                transactions.forEach(\n+                    transaction ->\n+                        transactionTracker.addToPeerSendQueue(peer, transaction.getHash())));\n+    ethContext\n+        .getScheduler()\n+        .schedulePendingTransactionsTask(transactionsMessageSender::sendTransactionsToPeers);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2OTE5Mg=="}, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM4NTQ2Mw==", "bodyText": "I have removed the separate executor.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r401385463", "createdAt": "2020-04-01T06:35:45Z", "author": {"login": "atoulme"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactionSender.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth.transactions;\n+\n+import org.hyperledger.besu.ethereum.core.Transaction;\n+import org.hyperledger.besu.ethereum.eth.manager.EthContext;\n+import org.hyperledger.besu.ethereum.eth.transactions.TransactionPool.TransactionBatchAddedListener;\n+\n+class PendingTransactionSender implements TransactionBatchAddedListener {\n+\n+  private final PeerPendingTransactionTracker transactionTracker;\n+  private final PendingTransactionsMessageSender transactionsMessageSender;\n+  private final EthContext ethContext;\n+\n+  public PendingTransactionSender(\n+      final PeerPendingTransactionTracker transactionTracker,\n+      final PendingTransactionsMessageSender transactionsMessageSender,\n+      final EthContext ethContext) {\n+    this.transactionTracker = transactionTracker;\n+    this.transactionsMessageSender = transactionsMessageSender;\n+    this.ethContext = ethContext;\n+  }\n+\n+  @Override\n+  public void onTransactionsAdded(final Iterable<Transaction> transactions) {\n+    ethContext\n+        .getEthPeers()\n+        .streamAvailablePeers()\n+        .forEach(\n+            peer ->\n+                transactions.forEach(\n+                    transaction ->\n+                        transactionTracker.addToPeerSendQueue(peer, transaction.getHash())));\n+    ethContext\n+        .getScheduler()\n+        .schedulePendingTransactionsTask(transactionsMessageSender::sendTransactionsToPeers);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2OTE5Mg=="}, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MjMyMjMzOnYy", "diffSide": "RIGHT", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/task/GetPooledTransactionsFromPeerTask.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNTozODo1NVrOF9v4SA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMzozNjoyOFrOF-EHvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI5MTkxMg==", "bodyText": "Per the spec a closed stream is a valid response indicating all requests were not found.\n\nA peer may respond with an empty reply iff none of the hashes match transactions in its pool. It is allowed to announce a transaction that will not be served later if it gets included in a block in between.\n\nSo it usually would be a valid response.  I think we should revise the comment so we don't accidentally come back in and try and \"optimize\" it.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400291912", "createdAt": "2020-03-30T15:38:55Z", "author": {"login": "shemnon"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/task/GetPooledTransactionsFromPeerTask.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth.manager.task;\n+\n+import static java.util.Collections.emptyMap;\n+\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.ethereum.core.Transaction;\n+import org.hyperledger.besu.ethereum.eth.manager.EthContext;\n+import org.hyperledger.besu.ethereum.eth.manager.EthPeer;\n+import org.hyperledger.besu.ethereum.eth.manager.PendingPeerRequest;\n+import org.hyperledger.besu.ethereum.eth.messages.EthPV65;\n+import org.hyperledger.besu.ethereum.eth.messages.PooledTransactionsMessage;\n+import org.hyperledger.besu.ethereum.p2p.rlpx.wire.MessageData;\n+import org.hyperledger.besu.plugin.services.MetricsSystem;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class GetPooledTransactionsFromPeerTask\n+    extends AbstractPeerRequestTask<Map<Hash, Transaction>> {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  private final List<Hash> hashes;\n+\n+  private GetPooledTransactionsFromPeerTask(\n+      final EthContext ethContext, final List<Hash> hashes, final MetricsSystem metricsSystem) {\n+    super(ethContext, EthPV65.GET_POOLED_TRANSACTIONS, metricsSystem);\n+    this.hashes = new ArrayList<>(hashes);\n+  }\n+\n+  public static GetPooledTransactionsFromPeerTask forHashes(\n+      final EthContext ethContext, final List<Hash> hashes, final MetricsSystem metricsSystem) {\n+    return new GetPooledTransactionsFromPeerTask(ethContext, hashes, metricsSystem);\n+  }\n+\n+  @Override\n+  protected PendingPeerRequest sendRequest() {\n+    return sendRequestToPeer(\n+        peer -> {\n+          LOG.debug(\"Requesting {} transaction pool entries from peer {}.\", hashes.size(), peer);\n+          return peer.getPooledTransactions(hashes);\n+        },\n+        0);\n+  }\n+\n+  @Override\n+  protected Optional<Map<Hash, Transaction>> processResponse(\n+      final boolean streamClosed, final MessageData message, final EthPeer peer) {\n+    if (streamClosed) {\n+      // We don't record this as a useless response because it's impossible to know if a peer has", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYyMzU0OA==", "bodyText": "This is a copy/paste of another part of the code. streamClosed here means that the other peer closed the TCP connection. Empty response means that the payload of the message is empty.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400623548", "createdAt": "2020-03-31T03:36:28Z", "author": {"login": "atoulme"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/task/GetPooledTransactionsFromPeerTask.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth.manager.task;\n+\n+import static java.util.Collections.emptyMap;\n+\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.ethereum.core.Transaction;\n+import org.hyperledger.besu.ethereum.eth.manager.EthContext;\n+import org.hyperledger.besu.ethereum.eth.manager.EthPeer;\n+import org.hyperledger.besu.ethereum.eth.manager.PendingPeerRequest;\n+import org.hyperledger.besu.ethereum.eth.messages.EthPV65;\n+import org.hyperledger.besu.ethereum.eth.messages.PooledTransactionsMessage;\n+import org.hyperledger.besu.ethereum.p2p.rlpx.wire.MessageData;\n+import org.hyperledger.besu.plugin.services.MetricsSystem;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class GetPooledTransactionsFromPeerTask\n+    extends AbstractPeerRequestTask<Map<Hash, Transaction>> {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  private final List<Hash> hashes;\n+\n+  private GetPooledTransactionsFromPeerTask(\n+      final EthContext ethContext, final List<Hash> hashes, final MetricsSystem metricsSystem) {\n+    super(ethContext, EthPV65.GET_POOLED_TRANSACTIONS, metricsSystem);\n+    this.hashes = new ArrayList<>(hashes);\n+  }\n+\n+  public static GetPooledTransactionsFromPeerTask forHashes(\n+      final EthContext ethContext, final List<Hash> hashes, final MetricsSystem metricsSystem) {\n+    return new GetPooledTransactionsFromPeerTask(ethContext, hashes, metricsSystem);\n+  }\n+\n+  @Override\n+  protected PendingPeerRequest sendRequest() {\n+    return sendRequestToPeer(\n+        peer -> {\n+          LOG.debug(\"Requesting {} transaction pool entries from peer {}.\", hashes.size(), peer);\n+          return peer.getPooledTransactions(hashes);\n+        },\n+        0);\n+  }\n+\n+  @Override\n+  protected Optional<Map<Hash, Transaction>> processResponse(\n+      final boolean streamClosed, final MessageData message, final EthPeer peer) {\n+    if (streamClosed) {\n+      // We don't record this as a useless response because it's impossible to know if a peer has", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI5MTkxMg=="}, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MjMzNjgwOnYy", "diffSide": "RIGHT", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/task/GetPooledTransactionsFromPeerTask.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNTo0MTo0OVrOF9wBJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMzo1Nzo0OVrOF-Ec-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI5NDE4Mg==", "bodyText": "Curious why we need to return a Map<Hash, Transaction>, why not just a List<Transaction>?", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400294182", "createdAt": "2020-03-30T15:41:49Z", "author": {"login": "shemnon"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/task/GetPooledTransactionsFromPeerTask.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth.manager.task;\n+\n+import static java.util.Collections.emptyMap;\n+\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.ethereum.core.Transaction;\n+import org.hyperledger.besu.ethereum.eth.manager.EthContext;\n+import org.hyperledger.besu.ethereum.eth.manager.EthPeer;\n+import org.hyperledger.besu.ethereum.eth.manager.PendingPeerRequest;\n+import org.hyperledger.besu.ethereum.eth.messages.EthPV65;\n+import org.hyperledger.besu.ethereum.eth.messages.PooledTransactionsMessage;\n+import org.hyperledger.besu.ethereum.p2p.rlpx.wire.MessageData;\n+import org.hyperledger.besu.plugin.services.MetricsSystem;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class GetPooledTransactionsFromPeerTask\n+    extends AbstractPeerRequestTask<Map<Hash, Transaction>> {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  private final List<Hash> hashes;\n+\n+  private GetPooledTransactionsFromPeerTask(\n+      final EthContext ethContext, final List<Hash> hashes, final MetricsSystem metricsSystem) {\n+    super(ethContext, EthPV65.GET_POOLED_TRANSACTIONS, metricsSystem);\n+    this.hashes = new ArrayList<>(hashes);\n+  }\n+\n+  public static GetPooledTransactionsFromPeerTask forHashes(\n+      final EthContext ethContext, final List<Hash> hashes, final MetricsSystem metricsSystem) {\n+    return new GetPooledTransactionsFromPeerTask(ethContext, hashes, metricsSystem);\n+  }\n+\n+  @Override\n+  protected PendingPeerRequest sendRequest() {\n+    return sendRequestToPeer(\n+        peer -> {\n+          LOG.debug(\"Requesting {} transaction pool entries from peer {}.\", hashes.size(), peer);\n+          return peer.getPooledTransactions(hashes);\n+        },\n+        0);\n+  }\n+\n+  @Override\n+  protected Optional<Map<Hash, Transaction>> processResponse(\n+      final boolean streamClosed, final MessageData message, final EthPeer peer) {\n+    if (streamClosed) {\n+      // We don't record this as a useless response because it's impossible to know if a peer has\n+      // the data we're requesting.\n+      return Optional.of(emptyMap());\n+    }\n+    final PooledTransactionsMessage pooledTransactionsMessage =\n+        PooledTransactionsMessage.readFrom(message);\n+    final List<Transaction> tx = pooledTransactionsMessage.transactions();\n+    if (tx.size() > hashes.size()) {\n+      // Can't be the response to our request\n+      return Optional.empty();\n+    }\n+    return mapNodeDataByHash(tx);\n+  }\n+\n+  private Optional<Map<Hash, Transaction>> mapNodeDataByHash(final List<Transaction> transactions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYyODk4NA==", "bodyText": "I can simplify to that, sure.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400628984", "createdAt": "2020-03-31T03:57:49Z", "author": {"login": "atoulme"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/task/GetPooledTransactionsFromPeerTask.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth.manager.task;\n+\n+import static java.util.Collections.emptyMap;\n+\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.ethereum.core.Transaction;\n+import org.hyperledger.besu.ethereum.eth.manager.EthContext;\n+import org.hyperledger.besu.ethereum.eth.manager.EthPeer;\n+import org.hyperledger.besu.ethereum.eth.manager.PendingPeerRequest;\n+import org.hyperledger.besu.ethereum.eth.messages.EthPV65;\n+import org.hyperledger.besu.ethereum.eth.messages.PooledTransactionsMessage;\n+import org.hyperledger.besu.ethereum.p2p.rlpx.wire.MessageData;\n+import org.hyperledger.besu.plugin.services.MetricsSystem;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+\n+public class GetPooledTransactionsFromPeerTask\n+    extends AbstractPeerRequestTask<Map<Hash, Transaction>> {\n+\n+  private static final Logger LOG = LogManager.getLogger();\n+\n+  private final List<Hash> hashes;\n+\n+  private GetPooledTransactionsFromPeerTask(\n+      final EthContext ethContext, final List<Hash> hashes, final MetricsSystem metricsSystem) {\n+    super(ethContext, EthPV65.GET_POOLED_TRANSACTIONS, metricsSystem);\n+    this.hashes = new ArrayList<>(hashes);\n+  }\n+\n+  public static GetPooledTransactionsFromPeerTask forHashes(\n+      final EthContext ethContext, final List<Hash> hashes, final MetricsSystem metricsSystem) {\n+    return new GetPooledTransactionsFromPeerTask(ethContext, hashes, metricsSystem);\n+  }\n+\n+  @Override\n+  protected PendingPeerRequest sendRequest() {\n+    return sendRequestToPeer(\n+        peer -> {\n+          LOG.debug(\"Requesting {} transaction pool entries from peer {}.\", hashes.size(), peer);\n+          return peer.getPooledTransactions(hashes);\n+        },\n+        0);\n+  }\n+\n+  @Override\n+  protected Optional<Map<Hash, Transaction>> processResponse(\n+      final boolean streamClosed, final MessageData message, final EthPeer peer) {\n+    if (streamClosed) {\n+      // We don't record this as a useless response because it's impossible to know if a peer has\n+      // the data we're requesting.\n+      return Optional.of(emptyMap());\n+    }\n+    final PooledTransactionsMessage pooledTransactionsMessage =\n+        PooledTransactionsMessage.readFrom(message);\n+    final List<Transaction> tx = pooledTransactionsMessage.transactions();\n+    if (tx.size() > hashes.size()) {\n+      // Can't be the response to our request\n+      return Optional.empty();\n+    }\n+    return mapNodeDataByHash(tx);\n+  }\n+\n+  private Optional<Map<Hash, Transaction>> mapNodeDataByHash(final List<Transaction> transactions) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI5NDE4Mg=="}, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 84}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MjM1NTAzOnYy", "diffSide": "RIGHT", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/messages/LimitedNewPooledTransactionHashesMessages.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNTo0NTo0NFrOF9wMeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNTo0NTo0NFrOF9wMeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI5NzA4MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              static final int LIMIT = 1048576;\n          \n          \n            \n              static final int LIMIT = 1024 * 1024;\n          \n      \n    \n    \n  \n\nMakes it clearer it is 1MiB.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400297081", "createdAt": "2020-03-30T15:45:44Z", "author": {"login": "shemnon"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/messages/LimitedNewPooledTransactionHashesMessages.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth.messages;\n+\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.ethereum.rlp.BytesValueRLPOutput;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.apache.tuweni.bytes.Bytes;\n+\n+public final class LimitedNewPooledTransactionHashesMessages {\n+\n+  static final int LIMIT = 1048576;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MjM4NDM1OnYy", "diffSide": "RIGHT", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/messages/LimitedNewPooledTransactionHashesMessages.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNTo1MjowMFrOF9wekA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwMzo0MDowNVrOF-ELVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwMTcxMg==", "bodyText": "readability: this should be transactionHash, txHash, or hash.  It's not the whole transaction.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400301712", "createdAt": "2020-03-30T15:52:00Z", "author": {"login": "shemnon"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/messages/LimitedNewPooledTransactionHashesMessages.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth.messages;\n+\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.ethereum.rlp.BytesValueRLPOutput;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.apache.tuweni.bytes.Bytes;\n+\n+public final class LimitedNewPooledTransactionHashesMessages {\n+\n+  static final int LIMIT = 1048576;\n+  static final int MAX_COUNT = 4096;\n+\n+  private final NewPooledTransactionHashesMessage transactionsMessage;\n+  private final List<Hash> includedTransactions;\n+\n+  public LimitedNewPooledTransactionHashesMessages(\n+      final NewPooledTransactionHashesMessage transactionsMessage,\n+      final List<Hash> includedTransactions) {\n+    this.transactionsMessage = transactionsMessage;\n+    this.includedTransactions = includedTransactions;\n+  }\n+\n+  public static LimitedNewPooledTransactionHashesMessages createLimited(\n+      final Iterable<Hash> hashes) {\n+    final List<Hash> includedTransactions = new ArrayList<>();\n+    final BytesValueRLPOutput message = new BytesValueRLPOutput();\n+    int messageSize = 0;\n+    int count = 0;\n+    message.startList();\n+    for (final Hash transaction : hashes) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYyNDQ3MQ==", "bodyText": "ok changed.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400624471", "createdAt": "2020-03-31T03:40:05Z", "author": {"login": "atoulme"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/messages/LimitedNewPooledTransactionHashesMessages.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth.messages;\n+\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.ethereum.rlp.BytesValueRLPOutput;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.apache.tuweni.bytes.Bytes;\n+\n+public final class LimitedNewPooledTransactionHashesMessages {\n+\n+  static final int LIMIT = 1048576;\n+  static final int MAX_COUNT = 4096;\n+\n+  private final NewPooledTransactionHashesMessage transactionsMessage;\n+  private final List<Hash> includedTransactions;\n+\n+  public LimitedNewPooledTransactionHashesMessages(\n+      final NewPooledTransactionHashesMessage transactionsMessage,\n+      final List<Hash> includedTransactions) {\n+    this.transactionsMessage = transactionsMessage;\n+    this.includedTransactions = includedTransactions;\n+  }\n+\n+  public static LimitedNewPooledTransactionHashesMessages createLimited(\n+      final Iterable<Hash> hashes) {\n+    final List<Hash> includedTransactions = new ArrayList<>();\n+    final BytesValueRLPOutput message = new BytesValueRLPOutput();\n+    int messageSize = 0;\n+    int count = 0;\n+    message.startList();\n+    for (final Hash transaction : hashes) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwMTcxMg=="}, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MjM4ODk5OnYy", "diffSide": "RIGHT", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/messages/LimitedNewPooledTransactionHashesMessages.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNTo1Mjo1NlrOF9whVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNDoyMzowOVrOF-Ez9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwMjQyMg==", "bodyText": "Instead of breaking when done and returning just one message I think things would be cleaner if this method returned a List and we created a new message each time we went over the limit and then returned all the messages.  Then in PendingTransacitonMessageSender we won't need to iteratively clear out the list, and we won't need to track includedTransactions", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400302422", "createdAt": "2020-03-30T15:52:56Z", "author": {"login": "shemnon"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/messages/LimitedNewPooledTransactionHashesMessages.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth.messages;\n+\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.ethereum.rlp.BytesValueRLPOutput;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.apache.tuweni.bytes.Bytes;\n+\n+public final class LimitedNewPooledTransactionHashesMessages {\n+\n+  static final int LIMIT = 1048576;\n+  static final int MAX_COUNT = 4096;\n+\n+  private final NewPooledTransactionHashesMessage transactionsMessage;\n+  private final List<Hash> includedTransactions;\n+\n+  public LimitedNewPooledTransactionHashesMessages(\n+      final NewPooledTransactionHashesMessage transactionsMessage,\n+      final List<Hash> includedTransactions) {\n+    this.transactionsMessage = transactionsMessage;\n+    this.includedTransactions = includedTransactions;\n+  }\n+\n+  public static LimitedNewPooledTransactionHashesMessages createLimited(\n+      final Iterable<Hash> hashes) {\n+    final List<Hash> includedTransactions = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYyMzYyNg==", "bodyText": "This is a straight copy of LimitedTransactions.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400623626", "createdAt": "2020-03-31T03:36:42Z", "author": {"login": "atoulme"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/messages/LimitedNewPooledTransactionHashesMessages.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth.messages;\n+\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.ethereum.rlp.BytesValueRLPOutput;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.apache.tuweni.bytes.Bytes;\n+\n+public final class LimitedNewPooledTransactionHashesMessages {\n+\n+  static final int LIMIT = 1048576;\n+  static final int MAX_COUNT = 4096;\n+\n+  private final NewPooledTransactionHashesMessage transactionsMessage;\n+  private final List<Hash> includedTransactions;\n+\n+  public LimitedNewPooledTransactionHashesMessages(\n+      final NewPooledTransactionHashesMessage transactionsMessage,\n+      final List<Hash> includedTransactions) {\n+    this.transactionsMessage = transactionsMessage;\n+    this.includedTransactions = includedTransactions;\n+  }\n+\n+  public static LimitedNewPooledTransactionHashesMessages createLimited(\n+      final Iterable<Hash> hashes) {\n+    final List<Hash> includedTransactions = new ArrayList<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwMjQyMg=="}, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYzNDg3MA==", "bodyText": "I mean, it's also not too expensive to keep track of includedTransactions. Agree it's clumsy, but I'd do this in a separate ticket and fix it for both classes.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400634870", "createdAt": "2020-03-31T04:23:09Z", "author": {"login": "atoulme"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/messages/LimitedNewPooledTransactionHashesMessages.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth.messages;\n+\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.ethereum.rlp.BytesValueRLPOutput;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.apache.tuweni.bytes.Bytes;\n+\n+public final class LimitedNewPooledTransactionHashesMessages {\n+\n+  static final int LIMIT = 1048576;\n+  static final int MAX_COUNT = 4096;\n+\n+  private final NewPooledTransactionHashesMessage transactionsMessage;\n+  private final List<Hash> includedTransactions;\n+\n+  public LimitedNewPooledTransactionHashesMessages(\n+      final NewPooledTransactionHashesMessage transactionsMessage,\n+      final List<Hash> includedTransactions) {\n+    this.transactionsMessage = transactionsMessage;\n+    this.includedTransactions = includedTransactions;\n+  }\n+\n+  public static LimitedNewPooledTransactionHashesMessages createLimited(\n+      final Iterable<Hash> hashes) {\n+    final List<Hash> includedTransactions = new ArrayList<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwMjQyMg=="}, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MjQwMTgyOnYy", "diffSide": "RIGHT", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/messages/LimitedNewPooledTransactionHashesMessages.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNTo1NTo0MlrOF9wpUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNDoxODowNFrOF-Evfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwNDQ2Nw==", "bodyText": "With this logic we will always produce messages just larger than the limit.  Perhaps we check the limits earlier in the loop, and if we would exceed the limit with the new data we then produce a new message and put it in there.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400304467", "createdAt": "2020-03-30T15:55:42Z", "author": {"login": "shemnon"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/messages/LimitedNewPooledTransactionHashesMessages.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth.messages;\n+\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.ethereum.rlp.BytesValueRLPOutput;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.apache.tuweni.bytes.Bytes;\n+\n+public final class LimitedNewPooledTransactionHashesMessages {\n+\n+  static final int LIMIT = 1048576;\n+  static final int MAX_COUNT = 4096;\n+\n+  private final NewPooledTransactionHashesMessage transactionsMessage;\n+  private final List<Hash> includedTransactions;\n+\n+  public LimitedNewPooledTransactionHashesMessages(\n+      final NewPooledTransactionHashesMessage transactionsMessage,\n+      final List<Hash> includedTransactions) {\n+    this.transactionsMessage = transactionsMessage;\n+    this.includedTransactions = includedTransactions;\n+  }\n+\n+  public static LimitedNewPooledTransactionHashesMessages createLimited(\n+      final Iterable<Hash> hashes) {\n+    final List<Hash> includedTransactions = new ArrayList<>();\n+    final BytesValueRLPOutput message = new BytesValueRLPOutput();\n+    int messageSize = 0;\n+    int count = 0;\n+    message.startList();\n+    for (final Hash transaction : hashes) {\n+      final BytesValueRLPOutput encodedTransaction = new BytesValueRLPOutput();\n+      encodedTransaction.writeBytes(transaction);\n+      Bytes encodedBytes = encodedTransaction.encoded();\n+      // Break if individual transaction size exceeds limit\n+      if (encodedBytes.size() > LIMIT && (messageSize != 0)) {\n+        break;\n+      }\n+      message.writeRLPUnsafe(encodedBytes);\n+      includedTransactions.add(transaction);\n+      // Check if last transaction to add to the message\n+      messageSize += encodedBytes.size();\n+      count++;\n+      if (messageSize > LIMIT || count >= MAX_COUNT) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYzMzcyNg==", "bodyText": "it's actually a little dumb of me. Each hash is 32 bytes, and the max is a MB. But 4096 hashes is less than a megabyte, even with RLP separators. So I could just go by count of hashes.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r400633726", "createdAt": "2020-03-31T04:18:04Z", "author": {"login": "atoulme"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/messages/LimitedNewPooledTransactionHashesMessages.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.eth.messages;\n+\n+import org.hyperledger.besu.ethereum.core.Hash;\n+import org.hyperledger.besu.ethereum.rlp.BytesValueRLPOutput;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.apache.tuweni.bytes.Bytes;\n+\n+public final class LimitedNewPooledTransactionHashesMessages {\n+\n+  static final int LIMIT = 1048576;\n+  static final int MAX_COUNT = 4096;\n+\n+  private final NewPooledTransactionHashesMessage transactionsMessage;\n+  private final List<Hash> includedTransactions;\n+\n+  public LimitedNewPooledTransactionHashesMessages(\n+      final NewPooledTransactionHashesMessage transactionsMessage,\n+      final List<Hash> includedTransactions) {\n+    this.transactionsMessage = transactionsMessage;\n+    this.includedTransactions = includedTransactions;\n+  }\n+\n+  public static LimitedNewPooledTransactionHashesMessages createLimited(\n+      final Iterable<Hash> hashes) {\n+    final List<Hash> includedTransactions = new ArrayList<>();\n+    final BytesValueRLPOutput message = new BytesValueRLPOutput();\n+    int messageSize = 0;\n+    int count = 0;\n+    message.startList();\n+    for (final Hash transaction : hashes) {\n+      final BytesValueRLPOutput encodedTransaction = new BytesValueRLPOutput();\n+      encodedTransaction.writeBytes(transaction);\n+      Bytes encodedBytes = encodedTransaction.encoded();\n+      // Break if individual transaction size exceeds limit\n+      if (encodedBytes.size() > LIMIT && (messageSize != 0)) {\n+        break;\n+      }\n+      message.writeRLPUnsafe(encodedBytes);\n+      includedTransactions.add(transaction);\n+      // Check if last transaction to add to the message\n+      messageSize += encodedBytes.size();\n+      count++;\n+      if (messageSize > LIMIT || count >= MAX_COUNT) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDMwNDQ2Nw=="}, "originalCommit": {"oid": "defbed1d0abf2bf326b68178cac3aba53a2832a9"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MTcxNjkwOnYy", "diffSide": "RIGHT", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactions.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNzoxNjowNFrOF_Ko8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNzozOTozMFrOF_LhMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc3ODkzMA==", "bodyText": "This also makes localTransactionHashesAdded synced when all we care about is newPooledHashes. Perhaps just synchronized (newPooledHashes) { ...  around the add and remove?", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r401778930", "createdAt": "2020-04-01T17:16:04Z", "author": {"login": "shemnon"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactions.java", "diffHunk": "@@ -137,7 +137,7 @@ public boolean addRemoteTransaction(final Transaction transaction) {\n     return transactionAdded;\n   }\n \n-  boolean addTransactionHash(final Hash transactionHash) {\n+  synchronized boolean addTransactionHash(final Hash transactionHash) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fc6c6d47fab1933efc43dfe8578e597d6bcfca3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc4Mjk1MA==", "bodyText": "sure thing.", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r401782950", "createdAt": "2020-04-01T17:22:42Z", "author": {"login": "atoulme"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactions.java", "diffHunk": "@@ -137,7 +137,7 @@ public boolean addRemoteTransaction(final Transaction transaction) {\n     return transactionAdded;\n   }\n \n-  boolean addTransactionHash(final Hash transactionHash) {\n+  synchronized boolean addTransactionHash(final Hash transactionHash) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc3ODkzMA=="}, "originalCommit": {"oid": "3fc6c6d47fab1933efc43dfe8578e597d6bcfca3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc5MzMyOA==", "bodyText": "done", "url": "https://github.com/hyperledger/besu/pull/608#discussion_r401793328", "createdAt": "2020-04-01T17:39:30Z", "author": {"login": "atoulme"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactions.java", "diffHunk": "@@ -137,7 +137,7 @@ public boolean addRemoteTransaction(final Transaction transaction) {\n     return transactionAdded;\n   }\n \n-  boolean addTransactionHash(final Hash transactionHash) {\n+  synchronized boolean addTransactionHash(final Hash transactionHash) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc3ODkzMA=="}, "originalCommit": {"oid": "3fc6c6d47fab1933efc43dfe8578e597d6bcfca3"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 999, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}