{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzNjU0ODUz", "number": 1508, "title": "Fix `TargetingGasLimitCalculator`", "bodyText": "PR description\nThis PR is aimed to fix the disobedience for GasLimitRangeAndDeltaValidationRule in TargetingGasLimitCalculator.\nThere is a bound of  block gas limit delta in Ethereum specification which is enforced by GasLimitRangeAndDeltaValidationRule in Besu to limit the delta to 1024th of parent block gas limit.\nThe scenario can be reproduced in the added test case (which gas limit is less or equal than 1024 * 1024).", "createdAt": "2020-11-01T16:50:04Z", "url": "https://github.com/hyperledger/besu/pull/1508", "merged": true, "mergeCommit": {"oid": "954906720a45b97337f2f95e3c494b2c3e36dfd5"}, "closed": true, "closedAt": "2020-11-05T17:05:26Z", "author": {"login": "AtkinsChang"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYS4ragBqjM5NDUzNzA1MTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZlJmfgH2gAyNTEzNjU0ODUzOmFjOTg3YzdlNDBlYzQzMDFiZGI4MmNjNzQ4ODQ1NGI2ZDcxMjA2ZWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "082372e32594c8b274eb911fc7fec82503f0bc9d", "author": {"user": {"login": "AtkinsChang", "name": "Atkins"}}, "url": "https://github.com/hyperledger/besu/commit/082372e32594c8b274eb911fc7fec82503f0bc9d", "committedDate": "2020-11-01T16:26:48Z", "message": "Fix `TargetingGasLimitCalculator` to meet `GasLimitRangeAndDeltaValidationRule`"}, "afterCommit": {"oid": "7544e097cfbc59945ded2fbf3c064b347e287ec5", "author": {"user": {"login": "AtkinsChang", "name": "Atkins"}}, "url": "https://github.com/hyperledger/besu/commit/7544e097cfbc59945ded2fbf3c064b347e287ec5", "committedDate": "2020-11-01T16:51:09Z", "message": "Fix `TargetingGasLimitCalculator` to meet `GasLimitRangeAndDeltaValidationRule`\n\nSigned-off-by: Atkins <atkinschang@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7544e097cfbc59945ded2fbf3c064b347e287ec5", "author": {"user": {"login": "AtkinsChang", "name": "Atkins"}}, "url": "https://github.com/hyperledger/besu/commit/7544e097cfbc59945ded2fbf3c064b347e287ec5", "committedDate": "2020-11-01T16:51:09Z", "message": "Fix `TargetingGasLimitCalculator` to meet `GasLimitRangeAndDeltaValidationRule`\n\nSigned-off-by: Atkins <atkinschang@gmail.com>"}, "afterCommit": {"oid": "d24ca08a0b2d846b2fcee8f98cc490d466a3dbce", "author": {"user": {"login": "AtkinsChang", "name": "Atkins"}}, "url": "https://github.com/hyperledger/besu/commit/d24ca08a0b2d846b2fcee8f98cc490d466a3dbce", "committedDate": "2020-11-01T16:57:48Z", "message": "Fix `TargetingGasLimitCalculator` to meet `GasLimitRangeAndDeltaValidationRule`\n\nSigned-off-by: Atkins <atkinschang@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNzQ5MDcw", "url": "https://github.com/hyperledger/besu/pull/1508#pullrequestreview-521749070", "createdAt": "2020-11-02T15:44:52Z", "commit": {"oid": "d24ca08a0b2d846b2fcee8f98cc490d466a3dbce"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNTo0NDo1MlrOHsJ_cA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNTo1MjozMlrOHsKVfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA2MzA4OA==", "bodyText": "Since we already have logic like this in the Rule class, I think we should find a common place for this validation that they both use.", "url": "https://github.com/hyperledger/besu/pull/1508#discussion_r516063088", "createdAt": "2020-11-02T15:44:52Z", "author": {"login": "RatanRSur"}, "path": "besu/src/main/java/org/hyperledger/besu/controller/TargetingGasLimitCalculator.java", "diffHunk": "@@ -56,17 +57,23 @@ public void changeTargetGasLimit(final Long targetGasLimit) {\n     this.targetGasLimit = targetGasLimit;\n   }\n \n+  private long adjustAmount(final long gasLimit) {\n+    final long maxAdjustAmount =\n+        Math.max(Long.divideUnsigned(gasLimit, GASLIMIT_BOUND_DIVISOR) - 1, 0);\n+    return Math.min(ADJUSTMENT_FACTOR, maxAdjustAmount);\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d24ca08a0b2d846b2fcee8f98cc490d466a3dbce"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA2ODczNQ==", "bodyText": "GasLimitRangeAndDeltaValidationRule checks that the min gas limit is above the divisor and doesn't accept it. Your ammendent of this test seems to suggest that it should be allowed, but it causes the adjustment to be 0 in perpetuity. Do you have a source for this behavior? I see that when I search gas limit here, it seems to say that 5000 is the minimum: https://ethereum.github.io/yellowpaper/paper.pdf", "url": "https://github.com/hyperledger/besu/pull/1508#discussion_r516068735", "createdAt": "2020-11-02T15:52:32Z", "author": {"login": "RatanRSur"}, "path": "besu/src/test/java/org/hyperledger/besu/controller/TargetingGasLimitCalculatorTest.java", "diffHunk": "@@ -48,11 +52,13 @@ public void verifyGasLimitReachesTarget() {\n \n   @Test\n   public void verifyNoNegative() {\n+    // gas limit less or equal than GASLIMIT_BOUND_DIVISOR (1024) can't not be change because of\n+    // delta rule\n     final long target = 0L;\n-    final long offset = TargetingGasLimitCalculator.ADJUSTMENT_FACTOR / 2;\n+    final long current = TargetingGasLimitCalculator.GASLIMIT_BOUND_DIVISOR;\n     TargetingGasLimitCalculator targetingGasLimitCalculator =\n         new TargetingGasLimitCalculator(target);\n-    assertThat(targetingGasLimitCalculator.nextGasLimit(target + offset)).isEqualTo(target);\n+    assertThat(targetingGasLimitCalculator.nextGasLimit(current)).isEqualTo(current);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d24ca08a0b2d846b2fcee8f98cc490d466a3dbce"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7acd31dff05f41531f4e4c0caf8952e539a537b", "author": {"user": {"login": "AtkinsChang", "name": "Atkins"}}, "url": "https://github.com/hyperledger/besu/commit/d7acd31dff05f41531f4e4c0caf8952e539a537b", "committedDate": "2020-11-02T17:00:25Z", "message": "Add test case for delta bound of gas limit\n\nSigned-off-by: Atkins <atkinschang@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a9fa0c5b60118b58ad628a65cc93fca1fb07b29", "author": {"user": {"login": "AtkinsChang", "name": "Atkins"}}, "url": "https://github.com/hyperledger/besu/commit/2a9fa0c5b60118b58ad628a65cc93fca1fb07b29", "committedDate": "2020-11-02T17:00:25Z", "message": "Fix `TargetingGasLimitCalculator` to meet `GasLimitRangeAndDeltaValidationRule`\n\nSigned-off-by: Atkins <atkinschang@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d24ca08a0b2d846b2fcee8f98cc490d466a3dbce", "author": {"user": {"login": "AtkinsChang", "name": "Atkins"}}, "url": "https://github.com/hyperledger/besu/commit/d24ca08a0b2d846b2fcee8f98cc490d466a3dbce", "committedDate": "2020-11-01T16:57:48Z", "message": "Fix `TargetingGasLimitCalculator` to meet `GasLimitRangeAndDeltaValidationRule`\n\nSigned-off-by: Atkins <atkinschang@gmail.com>"}, "afterCommit": {"oid": "2a9fa0c5b60118b58ad628a65cc93fca1fb07b29", "author": {"user": {"login": "AtkinsChang", "name": "Atkins"}}, "url": "https://github.com/hyperledger/besu/commit/2a9fa0c5b60118b58ad628a65cc93fca1fb07b29", "committedDate": "2020-11-02T17:00:25Z", "message": "Fix `TargetingGasLimitCalculator` to meet `GasLimitRangeAndDeltaValidationRule`\n\nSigned-off-by: Atkins <atkinschang@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee13abbab5effbb61f1d0989b64c7578ce537f8d", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/ee13abbab5effbb61f1d0989b64c7578ce537f8d", "committedDate": "2020-11-02T22:50:34Z", "message": "rename\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffea0c83c8a4a9b7a84daa533aceb88ea6f43ac9", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/ffea0c83c8a4a9b7a84daa533aceb88ea6f43ac9", "committedDate": "2020-11-02T22:52:10Z", "message": "String.format\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyMTIzMjk2", "url": "https://github.com/hyperledger/besu/pull/1508#pullrequestreview-522123296", "createdAt": "2020-11-03T00:22:44Z", "commit": {"oid": "2a9fa0c5b60118b58ad628a65cc93fca1fb07b29"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QwMDoyMjo0NFrOHsb8Cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QwMDoyMjo0NFrOHsb8Cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM1NzEzMA==", "bodyText": "I think there's a bug here we didn't catch. We don't use the lower and upper bound parameters in these operations. If that's the case, we should add tests to that effect. One thing which might make the code look closer to what we're going after conceptually is the use of google guava's Range class.", "url": "https://github.com/hyperledger/besu/pull/1508#discussion_r516357130", "createdAt": "2020-11-03T00:22:44Z", "author": {"login": "RatanRSur"}, "path": "besu/src/main/java/org/hyperledger/besu/controller/TargetingGasLimitCalculator.java", "diffHunk": "@@ -52,21 +64,32 @@ public long nextGasLimit(final long currentGasLimit) {\n \n   @Override\n   public void changeTargetGasLimit(final Long targetGasLimit) {\n-    checkArgument(targetGasLimit >= 0, \"Target gas limit must be non-negative\");\n+    checkArgument(\n+        targetGasLimit >= minGasLimit,\n+        \"targetGasLimit of \" + targetGasLimit + \" is below the minGasLimit of \" + minGasLimit);\n+\n+    checkArgument(\n+        targetGasLimit <= maxGasLimit,\n+        \"targetGasLimit of \" + targetGasLimit + \" is above the maxGasLimit of \" + maxGasLimit);\n     this.targetGasLimit = targetGasLimit;\n   }\n \n+  private long adjustAmount(final long currentGasLimit) {\n+    final long maxAdjustAmount = Math.max(deltaBound(currentGasLimit) - 1, 0);\n+    return Math.min(adjustFactor, maxAdjustAmount);\n+  }\n+\n   private long safeAdd(final long gasLimit) {\n     try {\n-      return Math.addExact(gasLimit, ADJUSTMENT_FACTOR);\n+      return Math.addExact(gasLimit, adjustAmount(gasLimit));\n     } catch (final ArithmeticException ex) {\n       return Long.MAX_VALUE;\n     }\n   }\n \n   private long safeSub(final long gasLimit) {\n     try {\n-      return Math.max(Math.subtractExact(gasLimit, ADJUSTMENT_FACTOR), 0);\n+      return Math.max(Math.subtractExact(gasLimit, adjustAmount(gasLimit)), 0);\n     } catch (final ArithmeticException ex) {\n       return 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a9fa0c5b60118b58ad628a65cc93fca1fb07b29"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0aef2ed335429284ae037b166481c40884c6fd6d", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/0aef2ed335429284ae037b166481c40884c6fd6d", "committedDate": "2020-11-03T13:01:16Z", "message": "rename\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNDc3NDkx", "url": "https://github.com/hyperledger/besu/pull/1508#pullrequestreview-522477491", "createdAt": "2020-11-03T13:09:34Z", "commit": {"oid": "0aef2ed335429284ae037b166481c40884c6fd6d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac987c7e40ec4301bdb82cc7488454b6d71206eb", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/ac987c7e40ec4301bdb82cc7488454b6d71206eb", "committedDate": "2020-11-05T16:42:19Z", "message": "Merge branch 'master' into fix-targeting-gas-limit-calculator"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2047, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}