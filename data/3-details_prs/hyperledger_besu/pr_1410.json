{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1ODYwODIy", "number": 1410, "title": "Tracing", "bodyText": "Add tracing agent to the build and default parameters in Dockerfiles.\nAdd sample showing how to use tracing.\nSigned-off-by: Antoine Toulme antoine@lunar-ocean.com\nPR description\nThis adds the Open Telemetry Java agent to the distribution artifacts of Besu.\nIt also adds the agent to the arguments of the run task.\nThe PR includes also some simple configuration changes to the Dockerfiles to showcase the environment variables that can be easily manipulated to configure the Open Telemetry agent.\nThe PR also comes with an example of use of the agent with a local Zipkin container showing traces captured during calls to the JSON-RPC API.\nChangelog\n\n I thought about the changelog and included a changelog update if required.", "createdAt": "2020-09-30T23:45:34Z", "url": "https://github.com/hyperledger/besu/pull/1410", "merged": true, "mergeCommit": {"oid": "dbc3fee7bb1d3a5908ffc73a0fd85a17ec847b6b"}, "closed": true, "closedAt": "2020-10-13T23:07:23Z", "author": {"login": "atoulme"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOVaL5gFqTUwMDU5ODE1OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSQevmABqjM4NzM4ODExMTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNTk4MTU5", "url": "https://github.com/hyperledger/besu/pull/1410#pullrequestreview-500598159", "createdAt": "2020-10-01T18:08:46Z", "commit": {"oid": "61093c9e73498b403a0745daed2fb6e946ce359c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODowODo0N1rOHbVnig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODowODo0N1rOHbVnig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQyNzc4Ng==", "bodyText": "This is a giant red flag for me.  Downloading from a random github url rather than a central repository like maven or jcenter, or at least an open-telemetry bintray is not long-term maintainable and circumvents some of our licensing and security checks.", "url": "https://github.com/hyperledger/besu/pull/1410#discussion_r498427786", "createdAt": "2020-10-01T18:08:47Z", "author": {"login": "shemnon"}, "path": "build.gradle", "diffHunk": "@@ -509,9 +520,26 @@ startScripts {\n   }\n }\n \n+task downloadOLTPJavaAgent(){\n+  def f = new File('build/opentelemetry-javaagent-all.jar')\n+  if (!f.exists()) {\n+    if (!f.getParentFile().exists()) {\n+      f.getParentFile().mkdirs()\n+    }\n+    new URL('https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/download/v0.8.0/opentelemetry-javaagent-all.jar').withInputStream{ i -> f.withOutputStream{ it << i }}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61093c9e73498b403a0745daed2fb6e946ce359c"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjE1NTE3", "url": "https://github.com/hyperledger/besu/pull/1410#pullrequestreview-503215517", "createdAt": "2020-10-06T17:49:29Z", "commit": {"oid": "ff90b0f416b67d3a1a188f91528ecc5f1d9f296b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo0OTozMFrOHdTNoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo0OTozMFrOHdTNoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4NTUzNw==", "bodyText": "What is the overhead cost of adding this agent and not using opentelemetry?  My concern is I don't want to impose a universal performance penalty.", "url": "https://github.com/hyperledger/besu/pull/1410#discussion_r500485537", "createdAt": "2020-10-06T17:49:30Z", "author": {"login": "shemnon"}, "path": "build.gradle", "diffHunk": "@@ -481,9 +483,12 @@ applicationDefaultJvmArgs = [\n   \"java.base/java.nio=ALL-UNNAMED\"\n ]\n \n+\n run {\n   args project.hasProperty(\"besu.run.args\") ? project.property(\"besu.run.args\").toString().split(\"\\\\s+\") : []\n   doFirst {\n+    applicationDefaultJvmArgs.add(0, \"-Dotel.resource.attributes=service.name=besu-dev\")\n+    applicationDefaultJvmArgs.add(0, \"-javaagent:\"+ configurations.javaAgent.singleFile.toPath() + \"\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff90b0f416b67d3a1a188f91528ecc5f1d9f296b"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MDc2MzUw", "url": "https://github.com/hyperledger/besu/pull/1410#pullrequestreview-507076350", "createdAt": "2020-10-13T05:21:30Z", "commit": {"oid": "953f7aceb24e4d651ac81f3b2965f549bfab9127"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwNToyMTozMVrOHgVx9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwNToyNjoxMlrOHgV3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY3MzMzMg==", "bodyText": "Mostly style and doc nits.  We use def more than actual types in the build scripts, especially for basic types.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                String agentFileName = configurations.javaAgent.singleFile.toPath().getFileName()\n          \n          \n            \n                String unixRegex = $/exec \"$$JAVACMD\" /$\n          \n          \n            \n                String forwardSlash = \"/\"\n          \n          \n            \n                String unixReplacement = $/if [ -n \"$$TRACING\" ];then\n          \n          \n            \n             TRACING_AGENT=\"-javaagent:$$APP_HOME/agent${forwardSlash}${agentFileName}\"\n          \n          \n            \n            fi\n          \n          \n            \n            exec \"$$JAVACMD\" $$TRACING_AGENT /$\n          \n          \n            \n                unixScript.text = unixScript.text.replace(unixRegex, unixReplacement)\n          \n          \n            \n                String windowsRegex = $/\"%JAVA_EXE%\" %DEFAULT_JVM_OPTS%/$\n          \n          \n            \n                String windowsReplacement = $/if Defined TRACING (TRACING_AGENT=\"-javaagent:\"%APP_HOME%\\agent\\/$ + agentFileName + '\")\\r\\n\"%JAVA_EXE%\" %DEFAULT_JVM_OPTS% %TRACING_AGENT%'\n          \n          \n            \n                windowsScript.text = windowsScript.text.replace(windowsRegex, windowsReplacement)\n          \n          \n            \n                // OpenTelemetry Wiring for unix scripts\n          \n          \n            \n                def agentFileName = configurations.javaAgent.singleFile.toPath().getFileName()\n          \n          \n            \n                def unixRegex = $/exec \"$$JAVACMD\" /$\n          \n          \n            \n                def forwardSlash = \"/\"\n          \n          \n            \n                def unixReplacement = $/if [ -n \"$$TRACING\" ];then\n          \n          \n            \n             TRACING_AGENT=\"-javaagent:$$APP_HOME/agent${forwardSlash}${agentFileName}\"\n          \n          \n            \n            fi\n          \n          \n            \n            exec \"$$JAVACMD\" $$TRACING_AGENT /$\n          \n          \n            \n                unixScript.text = unixScript.text.replace(unixRegex, unixReplacement)\n          \n          \n            \n                \n          \n          \n            \n                // OpenTelemetry Wiring for windows scripts\n          \n          \n            \n                def windowsRegex = $/\"%JAVA_EXE%\" %DEFAULT_JVM_OPTS%/$\n          \n          \n            \n                def windowsReplacement = $/if Defined TRACING (TRACING_AGENT=\"-javaagent:\"%APP_HOME%\\agent\\/$ + agentFileName + '\")\\r\\n\"%JAVA_EXE%\" %DEFAULT_JVM_OPTS% %TRACING_AGENT%'\n          \n          \n            \n                windowsScript.text = windowsScript.text.replace(windowsRegex, windowsReplacement)", "url": "https://github.com/hyperledger/besu/pull/1410#discussion_r503673332", "createdAt": "2020-10-13T05:21:31Z", "author": {"login": "shemnon"}, "path": "build.gradle", "diffHunk": "@@ -499,6 +504,17 @@ startScripts {\n   doLast {\n     unixScript.text = unixScript.text.replace('BESU_HOME', '\\$APP_HOME')\n     windowsScript.text = windowsScript.text.replace('BESU_HOME', '%~dp0..')\n+    String agentFileName = configurations.javaAgent.singleFile.toPath().getFileName()\n+    String unixRegex = $/exec \"$$JAVACMD\" /$\n+    String forwardSlash = \"/\"\n+    String unixReplacement = $/if [ -n \"$$TRACING\" ];then\n+ TRACING_AGENT=\"-javaagent:$$APP_HOME/agent${forwardSlash}${agentFileName}\"\n+fi\n+exec \"$$JAVACMD\" $$TRACING_AGENT /$\n+    unixScript.text = unixScript.text.replace(unixRegex, unixReplacement)\n+    String windowsRegex = $/\"%JAVA_EXE%\" %DEFAULT_JVM_OPTS%/$\n+    String windowsReplacement = $/if Defined TRACING (TRACING_AGENT=\"-javaagent:\"%APP_HOME%\\agent\\/$ + agentFileName + '\")\\r\\n\"%JAVA_EXE%\" %DEFAULT_JVM_OPTS% %TRACING_AGENT%'\n+    windowsScript.text = windowsScript.text.replace(windowsRegex, windowsReplacement)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "953f7aceb24e4d651ac81f3b2965f549bfab9127"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY3MzcxNg==", "bodyText": "Set it to what?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # To enable tracing, set the environment variable TRACING.\n          \n          \n            \n            # To enable tracing, uncomment next line\n          \n          \n            \n            #ENV TRACING=ENABLED", "url": "https://github.com/hyperledger/besu/pull/1410#discussion_r503673716", "createdAt": "2020-10-13T05:23:00Z", "author": {"login": "shemnon"}, "path": "docker/graalvm/Dockerfile", "diffHunk": "@@ -21,6 +21,11 @@ ENV BESU_RPC_HTTP_HOST 0.0.0.0\n ENV BESU_RPC_WS_HOST 0.0.0.0\n ENV BESU_GRAPHQL_HTTP_HOST 0.0.0.0\n ENV BESU_PID_PATH \"/tmp/pid\"\n+# Tracing defaults\n+# To enable tracing, set the environment variable TRACING.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "953f7aceb24e4d651ac81f3b2965f549bfab9127"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY3Mzc5Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # To enable tracing, set the environment variable TRACING.\n          \n          \n            \n            # To enable tracing, uncomment next line\n          \n          \n            \n            #ENV TRACING=ENABLED", "url": "https://github.com/hyperledger/besu/pull/1410#discussion_r503673792", "createdAt": "2020-10-13T05:23:13Z", "author": {"login": "shemnon"}, "path": "docker/openjdk-11/Dockerfile", "diffHunk": "@@ -21,6 +21,11 @@ ENV BESU_RPC_HTTP_HOST 0.0.0.0\n ENV BESU_RPC_WS_HOST 0.0.0.0\n ENV BESU_GRAPHQL_HTTP_HOST 0.0.0.0\n ENV BESU_PID_PATH \"/tmp/pid\"\n+# Tracing defaults\n+# To enable tracing, set the environment variable TRACING.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "953f7aceb24e4d651ac81f3b2965f549bfab9127"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY3Mzg2MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            # To enable tracing, set the environment variable TRACING.\n          \n          \n            \n            # To enable tracing, uncomment next line\n          \n          \n            \n            #ENV TRACING=ENABLED", "url": "https://github.com/hyperledger/besu/pull/1410#discussion_r503673861", "createdAt": "2020-10-13T05:23:28Z", "author": {"login": "shemnon"}, "path": "docker/openjdk-latest/Dockerfile", "diffHunk": "@@ -21,6 +21,11 @@ ENV BESU_RPC_HTTP_HOST 0.0.0.0\n ENV BESU_RPC_WS_HOST 0.0.0.0\n ENV BESU_GRAPHQL_HTTP_HOST 0.0.0.0\n ENV BESU_PID_PATH \"/tmp/pid\"\n+# Tracing defaults\n+# To enable tracing, set the environment variable TRACING.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "953f7aceb24e4d651ac81f3b2965f549bfab9127"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY3NDY3Ng==", "bodyText": "Would docs/tracing be a better home for these?  Or at least the README as docs/open-telemetry.md?  I'm concerned that this may get overlooked as just another module.  Weakly held opinion.", "url": "https://github.com/hyperledger/besu/pull/1410#discussion_r503674676", "createdAt": "2020-10-13T05:26:12Z", "author": {"login": "shemnon"}, "path": "tracing/README.md", "diffHunk": "@@ -0,0 +1,21 @@\n+# Tracing", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "953f7aceb24e4d651ac81f3b2965f549bfab9127"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MDc4NTQx", "url": "https://github.com/hyperledger/besu/pull/1410#pullrequestreview-507078541", "createdAt": "2020-10-13T05:27:45Z", "commit": {"oid": "953f7aceb24e4d651ac81f3b2965f549bfab9127"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwNToyNzo0NVrOHgV5CA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwNToyNzo0NVrOHgV5CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY3NTE0NA==", "bodyText": "This should go to the RC-2 section on line 29.", "url": "https://github.com/hyperledger/besu/pull/1410#discussion_r503675144", "createdAt": "2020-10-13T05:27:45Z", "author": {"login": "shemnon"}, "path": "CHANGELOG.md", "diffHunk": "@@ -42,6 +42,7 @@ Hyperledger Besu is moving its versioning scheme to [CalVer](https://calver.org/\n * Added support for multi-tenancy when using the early access feature of [onchain privacy group management](https://besu.hyperledger.org/en/stable/Concepts/Privacy/Onchain-PrivacyGroups/) \n * Fixed memory leak in eth/65 subprotocol behavior. It is now enabled by default. [\\#1420](https://github.com/hyperledger/besu/pull/1420), [#1348](https://github.com/hyperledger/besu/pull/1348), [#1321](https://github.com/hyperledger/besu/pull/1321)\n * Added `--privacy-flexible-groups-enabled` as an alternative for `--privacy-onchain-groups-enabled` CLI option\n+* Added the Open Telemetry Java agent to report traces to a remote backend. Added an example to showcase the trace reporting capabilities.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "953f7aceb24e4d651ac81f3b2965f549bfab9127"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3981be9e457bdf4bb49807633441868255e3cca", "author": {"user": {"login": "atoulme", "name": "Antoine Toulme"}}, "url": "https://github.com/hyperledger/besu/commit/b3981be9e457bdf4bb49807633441868255e3cca", "committedDate": "2020-10-13T18:43:12Z", "message": "Update build.gradle\n\nCo-authored-by: Danno Ferrin <danno.ferrin@shemnon.com>"}, "afterCommit": {"oid": "88508fb92b7178eb068c2b6d46d450b69450d379", "author": {"user": {"login": "atoulme", "name": "Antoine Toulme"}}, "url": "https://github.com/hyperledger/besu/commit/88508fb92b7178eb068c2b6d46d450b69450d379", "committedDate": "2020-10-13T22:37:07Z", "message": "Add tracing agent to the build and default parameters in Dockerfiles\n\nSigned-off-by: Antoine Toulme <antoine@lunar-ocean.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b98d5fb82c0c8701a3252f445f0b360df772312", "author": {"user": {"login": "atoulme", "name": "Antoine Toulme"}}, "url": "https://github.com/hyperledger/besu/commit/4b98d5fb82c0c8701a3252f445f0b360df772312", "committedDate": "2020-10-13T22:39:46Z", "message": "Add tracing agent to the build and default parameters in Dockerfiles\n\nSigned-off-by: Antoine Toulme <antoine@lunar-ocean.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "88508fb92b7178eb068c2b6d46d450b69450d379", "author": {"user": {"login": "atoulme", "name": "Antoine Toulme"}}, "url": "https://github.com/hyperledger/besu/commit/88508fb92b7178eb068c2b6d46d450b69450d379", "committedDate": "2020-10-13T22:37:07Z", "message": "Add tracing agent to the build and default parameters in Dockerfiles\n\nSigned-off-by: Antoine Toulme <antoine@lunar-ocean.com>"}, "afterCommit": {"oid": "4b98d5fb82c0c8701a3252f445f0b360df772312", "author": {"user": {"login": "atoulme", "name": "Antoine Toulme"}}, "url": "https://github.com/hyperledger/besu/commit/4b98d5fb82c0c8701a3252f445f0b360df772312", "committedDate": "2020-10-13T22:39:46Z", "message": "Add tracing agent to the build and default parameters in Dockerfiles\n\nSigned-off-by: Antoine Toulme <antoine@lunar-ocean.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2177, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}