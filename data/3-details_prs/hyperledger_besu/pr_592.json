{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MjI4ODUx", "number": 592, "title": "Fix tracing api ", "bodyText": "Signed-off-by: Karim TAAM karim.t2am@gmail.com\nFixed Issue(s)\nInvalid GasUsed\nThe gasused was not valid during a RETURN\nTo define the gasUsed during a RETURN it was used cumulativeGasCost but its value was not always valid. To fix that we no longer use this value and the computeGasUsed method has been updated. Note : the gasused is returned before applying the effects of gas refunds\n\n  \n    \n      besu/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/flat/FlatTraceGenerator.java\n    \n    \n         Line 490\n      in\n      ed7ca97\n    \n    \n    \n    \n\n        \n          \n           private static long computeGasUsed( \n        \n    \n  \n\n\n\n  \n    \n      besu/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/flat/FlatTraceGenerator.java\n    \n    \n         Line 287\n      in\n      ed7ca97\n    \n    \n    \n    \n\n        \n          \n           currentContext.setGasUsed( \n        \n    \n  \n\n\nGasStipend is not removed from intermediate traces\nOn certain traces the callStipend of 2300 was not removed in the Gasused field. To fix this I made the method getAdditionalCallStipend public and put it in the GasCalculator interface.\nGasCalculator\nFrontierGasCalculator\nTangerineWhistleGasCalculator\nIt was also necessary to pass the ProtocolScheduler to the FlatTraceGenerator.java  (so that it can recover the GasCalculator corresponding to the block) and to modify the TraceReplayBlock, TraceTransaction to pass the ProtocolScheduler and the current Block\n.../hyperledger/besu/ethereum/api/jsonrpc/internal/methods/TraceReplayBlockTransactions.java\n...ain/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/methods/TraceTransaction.java\nOnce the gasCalculator is obtained if We handle a STOP frame with an empty gasUsed. We remove the stipend to all traces contained in traceContexts (except the first and the current one)\n\n  \n    \n      besu/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/flat/FlatTraceGenerator.java\n    \n    \n         Line 290\n      in\n      ed7ca97\n    \n    \n    \n    \n\n        \n          \n           if (\"STOP\".equals(traceFrame.getOpcode()) && resultBuilder.isGasUsedEmpty()) { \n        \n    \n  \n\n\nThe gasused was not valid during a SELFDESTRUCT\nTo define the gasUsed during a SELFDESTRUCT it was used cumulativeGasCost but its value was not always valid. To fix that we no longer use this value and the gasUsed part has been updated\n\n  \n    \n      besu/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/flat/FlatTraceGenerator.java\n    \n    \n         Line 335\n      in\n      ed7ca97\n    \n    \n    \n    \n\n        \n          \n           Gas gasUsed = \n        \n    \n  \n\n\nInvalid Gas for Create operation\nThe gas calculation was based only on the gasReamining of the frame. This method did not always give the right result. The method has been updated in order to obtain the correct result in all cases\n\n  \n    \n      besu/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/flat/FlatTraceGenerator.java\n    \n    \n         Line 514\n      in\n      ed7ca97\n    \n    \n    \n    \n\n        \n          \n           private static Gas computeGas( \n        \n    \n  \n\n\nFix error messages\nIf a frame has an ExceptionalHaltReasons but it has already been handle before (example a Create operation) the error message was not updated\n\n  \n    \n      besu/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/flat/FlatTraceGenerator.java\n    \n    \n         Line 168\n      in\n      ed7ca97\n    \n    \n    \n    \n\n        \n          \n           if (currentContext != null && !traceFrame.getExceptionalHaltReasons().isEmpty()) { \n        \n    \n  \n\n\nNo display of Revert errors in the subtraces\nIt is necessary to search if a revert exists at the level of the subtraces to be able to display all the error messages. Creation of a hasRevertInSubCall method which will check that a subtrace is not in a revert state. For non-subtraces the usual mechanism works\n\n  \n    \n      besu/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/flat/FlatTraceGenerator.java\n    \n    \n         Line 258\n      in\n      ed7ca97\n    \n    \n    \n    \n\n        \n          \n           nextTraceFrame.ifPresent( \n        \n    \n  \n\n\n\n  \n    \n      besu/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/flat/FlatTraceGenerator.java\n    \n    \n         Line 448\n      in\n      ed7ca97\n    \n    \n    \n    \n\n        \n          \n           private static boolean hasRevertInSubCall( \n        \n    \n  \n\n\nThe value of the frame was changed when it was not necessary in the handleRevert method.\nOnly traceFrame of type CALL must have their value which changes to 0x0.\n\n  \n    \n      besu/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/flat/FlatTraceGenerator.java\n    \n    \n         Line 252\n      in\n      ed7ca97\n    \n    \n    \n    \n\n        \n          \n           if (tracesContexts.size() > 1 && traceFrame.getOpcode().equals(\"CALL\")) { \n        \n    \n  \n\n\nThe value of the frame was invalid with handleHalt\n\n  \n    \n      besu/ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/flat/FlatTraceGenerator.java\n    \n    \n         Line 418\n      in\n      ed7ca97\n    \n    \n    \n    \n\n        \n          \n           private static FlatTrace.Context handleHalt( \n        \n    \n  \n\n\nMissing OOO issues during contract creation issue\nAddition of a method in the operationTracer which allows to transmit the result of the creation of a contract in case of failure traceAccountCreationResult\n\n  \n    \n      besu/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/DebugOperationTracer.java\n    \n    \n         Line 115\n      in\n      ed7ca97\n    \n    \n    \n    \n\n        \n          \n           public void traceAccountCreationResult( \n        \n    \n  \n\n\nTransmit the  error to the operationTracer in the following cases :\n\ninsufficient funds for code deposit\n\n\n  \n    \n      besu/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/MainnetContractCreationProcessor.java\n    \n    \n         Line 154\n      in\n      ed7ca97\n    \n    \n    \n    \n\n        \n          \n           operationTracer.traceAccountCreationResult( \n        \n    \n  \n\n\n\naccount as already been created for address\n\n\n  \n    \n      besu/ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/MainnetContractCreationProcessor.java\n    \n    \n         Line 124\n      in\n      ed7ca97\n    \n    \n    \n    \n\n        \n          \n           operationTracer.traceAccountCreationResult(", "createdAt": "2020-03-26T15:07:03Z", "url": "https://github.com/hyperledger/besu/pull/592", "merged": true, "mergeCommit": {"oid": "fbd4e36bbeee58edd9f1d017e81edae58c4ba81a"}, "closed": true, "closedAt": "2020-04-07T08:59:37Z", "author": {"login": "matkt"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcM4aWHAH2gAyMzk0MjI4ODUxOjllMWE0OTFmYmUyZjQ3YWE0YjliYjgxMzM3YWRmMTc1MDgwZTAwOGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVO05AAH2gAyMzk0MjI4ODUxOjhjM2QwOWNhZWEyZDM4OTMzYmFlYTNkYzNiYjFiZjc1ZDlkZTMwNjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9e1a491fbe2f47aa4b9bb81337adf175080e008b", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/9e1a491fbe2f47aa4b9bb81337adf175080e008b", "committedDate": "2020-03-12T09:36:38Z", "message": "update changelog\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f91d6f0cb2305e3decd444d3796edf72da5e0b9", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/4f91d6f0cb2305e3decd444d3796edf72da5e0b9", "committedDate": "2020-03-12T15:28:02Z", "message": "Merge branch 'master' of https://github.com/hyperledger/besu\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>\n\n# Conflicts:\n#\tCHANGELOG.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b72e4aebeed925ea6eff57c6e831786fd2dd920", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/9b72e4aebeed925ea6eff57c6e831786fd2dd920", "committedDate": "2020-03-16T10:27:25Z", "message": "Merge branch 'master' of https://github.com/matkt/besu\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>\n\n# Conflicts:\n#\tCHANGELOG.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4e962cacec7c203fa0994454b66b830bdfadd67", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/f4e962cacec7c203fa0994454b66b830bdfadd67", "committedDate": "2020-03-19T14:32:57Z", "message": "Merge commit 'fff1f5e13ff91f7f99efe9b27dc0a0d5da474bad'\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1ed080b08a6a44a1d14c7554fd23517f02df2e1", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/d1ed080b08a6a44a1d14c7554fd23517f02df2e1", "committedDate": "2020-03-25T09:23:57Z", "message": "Merge commit '5e368dd7e6ec74827b481a9fbfccc24dc1aa9e2d'\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5494f19f4a42a4ada74967280a3ad0fb3a4a994", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/a5494f19f4a42a4ada74967280a3ad0fb3a4a994", "committedDate": "2020-03-25T18:07:33Z", "message": "update change log\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a97432f4a2eb05826e15786911d4cce3b934d040", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/a97432f4a2eb05826e15786911d4cce3b934d040", "committedDate": "2020-03-25T18:08:41Z", "message": "update change log\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5ac1ac2fca931cef013b178e2caf3b64a1a5782", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/a5ac1ac2fca931cef013b178e2caf3b64a1a5782", "committedDate": "2020-03-26T12:50:02Z", "message": "Merge commit '4fa78d61a3571a098ecbaa0c9980f7475ae7ca7a'\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>\n\n# Conflicts:\n#\tCHANGELOG.md"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4596e50cc01da9aed870c3e45e3df8cb900912d1", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/4596e50cc01da9aed870c3e45e3df8cb900912d1", "committedDate": "2020-03-26T15:02:48Z", "message": "add refund gas to the gasused\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f59bfa58ffc328fe1dc001a15503f2f6958a963f", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/f59bfa58ffc328fe1dc001a15503f2f6958a963f", "committedDate": "2020-03-30T13:41:35Z", "message": "resolve out of gas issue\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa7503c2ac268db3a3157f3b2caa2322b9711125", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/fa7503c2ac268db3a3157f3b2caa2322b9711125", "committedDate": "2020-04-06T08:53:34Z", "message": "resolve tracing api issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "128405436027c11da16f3949a8f7ed94ad5290bd", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/128405436027c11da16f3949a8f7ed94ad5290bd", "committedDate": "2020-04-06T09:12:55Z", "message": "clean code\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed7ca9739a29bde354afaf7ce4984dfdecd78529", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/ed7ca9739a29bde354afaf7ce4984dfdecd78529", "committedDate": "2020-04-06T11:56:26Z", "message": "fix value issues for call traceframe\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffb32ccbb5bbda34f686f1f09a5c545d3c4c44f3", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/ffb32ccbb5bbda34f686f1f09a5c545d3c4c44f3", "committedDate": "2020-04-06T12:53:22Z", "message": "Merge commit 'c58cb7c67e3378d2519f749260bbf9b2980db482' into feature/fix_tracing_api_gas_refund_missing\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91e4c1c5f9ae48481827d1ebfdcf7b4126f7a11c", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/91e4c1c5f9ae48481827d1ebfdcf7b4126f7a11c", "committedDate": "2020-04-06T13:28:03Z", "message": "clean code\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NTk3MTc4", "url": "https://github.com/hyperledger/besu/pull/592#pullrequestreview-388597178", "createdAt": "2020-04-06T20:36:12Z", "commit": {"oid": "91e4c1c5f9ae48481827d1ebfdcf7b4126f7a11c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMDozNjoxMlrOGBo51w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMDozNjoxMlrOGBo51w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM3MTkyNw==", "bodyText": "Where did this name come from?  If I read the code right it has to do with EIP 150 (https://eips.ethereum.org/EIPS/eip-150) so a name like EIP_150_DIVISOR or ALL_BUT_1_64TH would make it's purpose more clear.", "url": "https://github.com/hyperledger/besu/pull/592#discussion_r404371927", "createdAt": "2020-04-06T20:36:12Z", "author": {"login": "shemnon"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/flat/FlatTraceGenerator.java", "diffHunk": "@@ -49,16 +51,22 @@\n \n   private static final String ZERO_ADDRESS_STRING = Address.ZERO.toHexString();\n \n+  private static final int SUB_GAS_CAP_DIVISOR = 64;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91e4c1c5f9ae48481827d1ebfdcf7b4126f7a11c"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cd2b9be32f1201711533b85306f57b37f825e2b", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/9cd2b9be32f1201711533b85306f57b37f825e2b", "committedDate": "2020-04-07T07:38:41Z", "message": "resolve review issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c3d09caea2d38933baea3dc3bb1bf75d9de3067", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/8c3d09caea2d38933baea3dc3bb1bf75d9de3067", "committedDate": "2020-04-07T08:14:56Z", "message": "merge with master\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1637, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}