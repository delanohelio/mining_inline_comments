{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzMjUzNDAy", "number": 981, "title": "Handle backward compatibility for EIP-2124 fork id management", "bodyText": "Signed-off-by: Abdelhamid Bakhta abdelhamid.bakhta@consensys.net\n\n\nPR description\nFork Id computation has been updated to work with Geth nodes in consortium networks.\nBesu should allow fork id generated with old versions of Besu.\nFixed Issue(s)\n\n\nfixes #980\nSigned-off-by: Abdelhamid Bakhta abdelhamid.bakhta@consensys.net", "createdAt": "2020-05-26T14:47:47Z", "url": "https://github.com/hyperledger/besu/pull/981", "merged": true, "mergeCommit": {"oid": "1d8218aef76caca0c29972c5ae363980aa54af43"}, "closed": true, "closedAt": "2020-05-26T18:03:58Z", "author": {"login": "abdelhamidbakhta"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclFzO_AH2gAyNDIzMjUzNDAyOmIyMDY5YWIyMTk1MzNhMzE0Njc1N2EwYzVjMWMzZGIwN2RkNjg3OWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclInp3AFqTQxODU0ODgxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b2069ab219533a3146757a0c5c1c3db07dd6879b", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/b2069ab219533a3146757a0c5c1c3db07dd6879b", "committedDate": "2020-05-26T14:46:46Z", "message": "Handle backward compatibility for EIP-2124 fork id management\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4Mzg0MTc5", "url": "https://github.com/hyperledger/besu/pull/981#pullrequestreview-418384179", "createdAt": "2020-05-26T14:57:22Z", "commit": {"oid": "b2069ab219533a3146757a0c5c1c3db07dd6879b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNDo1NzoyM1rOGaiSHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNDo1NzoyM1rOGaiSHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ3Nzg1Mg==", "bodyText": "Maybe we can use !forks.isEmpty() instead of  size() > 0", "url": "https://github.com/hyperledger/besu/pull/981#discussion_r430477852", "createdAt": "2020-05-26T14:57:23Z", "author": {"login": "matkt"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/ForkIdManager.java", "diffHunk": "@@ -32,38 +34,71 @@\n \n public class ForkIdManager {\n \n-  private final Blockchain blockchain;\n   private final Hash genesisHash;\n-  private final List<Long> forks;\n-  private long forkNext;\n-  private final long highestKnownFork;\n-  private List<ForkId> forkAndHashList;\n+\n+  private final List<ForkId> legacyForkAndHashList;\n+  private final List<ForkId> forkAndHashList;\n+\n   private final List<ForkIDChecker> forkIDCheckers;\n \n   public ForkIdManager(final Blockchain blockchain, final List<Long> forks) {\n     assert blockchain != null && forks != null;\n-    this.blockchain = blockchain;\n     this.genesisHash = blockchain.getGenesisBlock().getHash();\n+    this.legacyForkAndHashList = new ArrayList<>();\n+    this.forkAndHashList = new ArrayList<>();\n     // if the fork list contains only zeros then we may be in a consortium/dev network\n     if (onlyZerosForkBlocks(forks)) {\n       this.forkIDCheckers = singletonList(forkId -> true);\n     } else {\n-      this.forkIDCheckers = singletonList(this::eip2124Checker);\n+      final ForkIDChecker legacyForkIdChecker =\n+          createForkIDChecker(\n+              blockchain,\n+              genesisHash,\n+              forks,\n+              fs ->\n+                  fs.stream()\n+                      .filter(fork -> fork > 0)\n+                      .distinct()\n+                      .collect(Collectors.toUnmodifiableList()),\n+              legacyForkAndHashList);\n+      final ForkIDChecker newForkIdChecker =\n+          createForkIDChecker(\n+              blockchain,\n+              genesisHash,\n+              forks,\n+              fs -> fs.stream().distinct().collect(Collectors.toUnmodifiableList()),\n+              forkAndHashList);\n+      this.forkIDCheckers = Arrays.asList(newForkIdChecker, legacyForkIdChecker);\n     }\n-    // de-dupe and sanitize forks\n-    this.forks = forks.stream().distinct().collect(Collectors.toUnmodifiableList());\n-    highestKnownFork = forks.size() > 0 ? forks.get(forks.size() - 1) : 0L;\n-    createForkIds();\n   }\n \n-  private boolean onlyZerosForkBlocks(final List<Long> forks) {\n+  private static ForkIDChecker createForkIDChecker(\n+      final Blockchain blockchain,\n+      final Hash genesisHash,\n+      final List<Long> forks,\n+      final Function<List<Long>, List<Long>> sanitizer,\n+      final List<ForkId> forkIds) {\n+    final List<Long> sanitizedForks = sanitizer.apply(forks);\n+    final long forkNext = createForkIds(genesisHash, sanitizedForks, forkIds);\n+    return eip2124(blockchain, forkNext, forkIds, highestKnownFork(sanitizedForks));\n+  }\n+\n+  private static boolean onlyZerosForkBlocks(final List<Long> forks) {\n     return forks.stream().allMatch(value -> 0L == value);\n   }\n \n+  private static long highestKnownFork(final List<Long> forks) {\n+    return forks.size() > 0 ? forks.get(forks.size() - 1) : 0L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2069ab219533a3146757a0c5c1c3db07dd6879b"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa530bd2a76e08167158172baddc69487f2a1988", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/aa530bd2a76e08167158172baddc69487f2a1988", "committedDate": "2020-05-26T15:24:10Z", "message": "Address PR comment\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "270a411f3c7f85e1ff7d16c1e0273cbea1be37e9", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/270a411f3c7f85e1ff7d16c1e0273cbea1be37e9", "committedDate": "2020-05-26T15:24:26Z", "message": "Merge remote-tracking branch 'upstream/master' into 980\n\nSigned-off-by: Abdelhamid Bakhta <abdelhamid.bakhta@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NTQ4ODE4", "url": "https://github.com/hyperledger/besu/pull/981#pullrequestreview-418548818", "createdAt": "2020-05-26T18:03:50Z", "commit": {"oid": "270a411f3c7f85e1ff7d16c1e0273cbea1be37e9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1541, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}