{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0NzA2NTMx", "number": 399, "title": "Improving Acceptance Test logging", "bodyText": "Add origin information (test and process) to log lines\nRoute logs to separate files according to origin\nDelete logs of successful tests (configurable, delete by default)\nImprove logging of some corner cases", "createdAt": "2020-02-13T07:12:06Z", "url": "https://github.com/hyperledger/besu/pull/399", "merged": true, "mergeCommit": {"oid": "93f54d0e37b1a3b37aedc35ccf570219b728a4f5"}, "closed": true, "closedAt": "2020-03-24T07:19:18Z", "author": {"login": "hmijail"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcD1bFAAH2gAyMzc0NzA2NTMxOjM4N2ZmYmYxYjdmNmUzNDM4MTczOTFlMmE0OTUyMjU2OWMzNjhiNGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQsv50gH2gAyMzc0NzA2NTMxOmUzNWMwYzEyZmFmZTc2ZTAyNzNmNmFlNzRhMDBiMmMwMTRlNzhiM2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "387ffbf1b7f6e343817391e2a49522569c368b4b", "author": {"user": {"login": "hmijail", "name": "Horacio Mijail Ant\u00f3n Quiles"}}, "url": "https://github.com/hyperledger/besu/commit/387ffbf1b7f6e343817391e2a49522569c368b4b", "committedDate": "2020-02-13T07:02:24Z", "message": "Improve logging for Acceptance Tests\n\nAdd test and process origin information to each log line\nRoute the logs to per-test files\nAdd detail to the logs\nLog on error corner cases\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ae3b4272f53e502813527daab3587ba5b2369f1", "author": {"user": {"login": "hmijail", "name": "Horacio Mijail Ant\u00f3n Quiles"}}, "url": "https://github.com/hyperledger/besu/commit/7ae3b4272f53e502813527daab3587ba5b2369f1", "committedDate": "2020-02-13T07:02:24Z", "message": "Spotless, minor merge conflicts\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bccb75c7ed0130e25c4311e4224099d37dbb8529", "author": {"user": {"login": "hmijail", "name": "Horacio Mijail Ant\u00f3n Quiles"}}, "url": "https://github.com/hyperledger/besu/commit/bccb75c7ed0130e25c4311e4224099d37dbb8529", "committedDate": "2020-02-13T07:02:24Z", "message": "Delete logs of successful tests\n\nConfigurable, delete by default\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NjI2MDA1", "url": "https://github.com/hyperledger/besu/pull/399#pullrequestreview-358626005", "createdAt": "2020-02-13T23:32:01Z", "commit": {"oid": "bccb75c7ed0130e25c4311e4224099d37dbb8529"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMzozMjowMVrOFpnKVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QyMzozOTo0N1rOFpnUxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3NzU1Ng==", "bodyText": "Is there any reason not to have the static modifier for the logger?\n(that would be in keeping with the reference being uppercase)", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r379177556", "createdAt": "2020-02-13T23:32:01Z", "author": {"login": "CjHare"}, "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java", "diffHunk": "@@ -41,9 +41,19 @@\n import org.hyperledger.besu.tests.acceptance.dsl.transaction.privacy.PrivacyTransactions;\n import org.hyperledger.besu.tests.acceptance.dsl.transaction.web3.Web3Transactions;\n \n+import java.io.File;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.ThreadContext;\n import org.junit.After;\n+import org.junit.Rule;\n+import org.junit.rules.TestName;\n+import org.junit.rules.TestWatcher;\n+import org.junit.runner.Description;\n \n public class AcceptanceTestBase {\n+  protected final Logger LOG = LogManager.getLogger();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bccb75c7ed0130e25c4311e4224099d37dbb8529"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3ODQ0Mw==", "bodyText": "You could put the error string into a local String variable and use Log4j lazy variable substitution.\ne.g.\nfinal String errorMessage = \" \"Uncaught exception in thread \\\"{}\\\"\";", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r379178443", "createdAt": "2020-02-13T23:34:27Z", "author": {"login": "CjHare"}, "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java", "diffHunk": "@@ -98,6 +108,55 @@ protected AcceptanceTestBase() {\n     permissionedNodeBuilder = new PermissionedNodeBuilder();\n   }\n \n+  static {\n+    System.setProperty(\"log4j2.isThreadContextMapInheritable\", \"true\");\n+  }\n+\n+  @Rule public final TestName name = new TestName();\n+\n+  @Rule\n+  public TestWatcher log_eraser =\n+      new TestWatcher() {\n+\n+        @Override\n+        protected void starting(final Description description) {\n+          ThreadContext.put(\"test\", description.getMethodName());\n+          ThreadContext.put(\"class\", description.getClassName());\n+          Thread.currentThread()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bccb75c7ed0130e25c4311e4224099d37dbb8529"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3ODk4MQ==", "bodyText": "acctests.keepLogs seems misleading as a variable, as it only applies to successful test executions, not the failed ones?", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r379178981", "createdAt": "2020-02-13T23:35:59Z", "author": {"login": "CjHare"}, "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/AcceptanceTestBase.java", "diffHunk": "@@ -98,6 +108,55 @@ protected AcceptanceTestBase() {\n     permissionedNodeBuilder = new PermissionedNodeBuilder();\n   }\n \n+  static {\n+    System.setProperty(\"log4j2.isThreadContextMapInheritable\", \"true\");\n+  }\n+\n+  @Rule public final TestName name = new TestName();\n+\n+  @Rule\n+  public TestWatcher log_eraser =\n+      new TestWatcher() {\n+\n+        @Override\n+        protected void starting(final Description description) {\n+          ThreadContext.put(\"test\", description.getMethodName());\n+          ThreadContext.put(\"class\", description.getClassName());\n+          Thread.currentThread()\n+              .setUncaughtExceptionHandler(\n+                  (thread, error) ->\n+                      LOG.error(\n+                          \"Uncaught exception in thread \\\"\" + thread.getName() + \"\\\"\", error));\n+          Thread.setDefaultUncaughtExceptionHandler(\n+              (thread, error) ->\n+                  LOG.error(\"Uncaught exception in thread \\\"\" + thread.getName() + \"\\\"\", error));\n+        }\n+\n+        @Override\n+        protected void failed(final Throwable e, final Description description) {\n+          // add the result at the end of the log so it is self-sufficient\n+          LOG.error(\n+              \"==========================================================================================\");\n+          LOG.error(\"Test failed. Reported Throwable at the point of failure:\", e);\n+        }\n+\n+        @Override\n+        protected void succeeded(final Description description) {\n+          // if so configured, delete logs of successful tests\n+          if (!Boolean.getBoolean(\"acctests.keepLogs\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bccb75c7ed0130e25c4311e4224099d37dbb8529"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE3OTg3Mw==", "bodyText": "Aren't you loosing the name of the node here (that name being assigned by the test being executed)?", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r379179873", "createdAt": "2020-02-13T23:38:52Z", "author": {"login": "CjHare"}, "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ProcessBesuNodeRunner.java", "diffHunk": "@@ -298,11 +310,16 @@ private void printOutput(final BesuNode node, final Process process) {\n         new BufferedReader(new InputStreamReader(process.getInputStream(), UTF_8))) {\n       String line = in.readLine();\n       while (line != null) {\n-        PROCESS_LOG.info(\"{}: {}\", node.getName(), line);\n+        // would be nice to pass up the log level of the incoming log line\n+        PROCESS_LOG.info(line);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bccb75c7ed0130e25c4311e4224099d37dbb8529"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTE4MDIzMQ==", "bodyText": "Does this also change the logging levels of the third party dependencies e.g Vertx?", "url": "https://github.com/hyperledger/besu/pull/399#discussion_r379180231", "createdAt": "2020-02-13T23:39:47Z", "author": {"login": "CjHare"}, "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ThreadBesuNodeRunner.java", "diffHunk": "@@ -197,9 +205,15 @@ public void startNode(final BesuNode node) {\n             .besuPluginContext(new BesuPluginContextImpl())\n             .build();\n \n+    // in testing, we don't mind logging on success, but we want max info on failures\n+    // log level is normally set in BesuCommand, which is bypassed here. So let's just set it.\n+    // This still leaves out the vertx system properties set in Besu.main().\n+    Configurator.setAllLevels(\"\", Level.DEBUG);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bccb75c7ed0130e25c4311e4224099d37dbb8529"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c834a762c129b463fee14174a5047d13e428d29", "author": {"user": {"login": "hmijail", "name": "Horacio Mijail Ant\u00f3n Quiles"}}, "url": "https://github.com/hyperledger/besu/commit/0c834a762c129b463fee14174a5047d13e428d29", "committedDate": "2020-02-19T07:44:47Z", "message": "Address comments\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f78b325c887156778967b913cd2b8c45954e156", "author": {"user": {"login": "hmijail", "name": "Horacio Mijail Ant\u00f3n Quiles"}}, "url": "https://github.com/hyperledger/besu/commit/3f78b325c887156778967b913cd2b8c45954e156", "committedDate": "2020-02-20T11:31:39Z", "message": "Fix naming convention of other loggers\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4e933a9d2d0775317ed1e2cd4e6e0c8540348ac", "author": {"user": {"login": "hmijail", "name": "Horacio Mijail Ant\u00f3n Quiles"}}, "url": "https://github.com/hyperledger/besu/commit/e4e933a9d2d0775317ed1e2cd4e6e0c8540348ac", "committedDate": "2020-02-22T18:50:56Z", "message": "Address comment on system property name\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba54b173598b1127063606495f74d332e46bbcf8", "author": {"user": {"login": "hmijail", "name": "Horacio Mijail Ant\u00f3n Quiles"}}, "url": "https://github.com/hyperledger/besu/commit/ba54b173598b1127063606495f74d332e46bbcf8", "committedDate": "2020-02-22T18:54:24Z", "message": "Make Besu process' logging be the same level as the test's\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMTc3OTE1", "url": "https://github.com/hyperledger/besu/pull/399#pullrequestreview-363177915", "createdAt": "2020-02-24T05:50:00Z", "commit": {"oid": "ba54b173598b1127063606495f74d332e46bbcf8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e35c0c12fafe76e0273f6ae74a00b2c014e78b3e", "author": {"user": {"login": "hmijail", "name": "Horacio Mijail Ant\u00f3n Quiles"}}, "url": "https://github.com/hyperledger/besu/commit/e35c0c12fafe76e0273f6ae74a00b2c014e78b3e", "committedDate": "2020-03-24T06:17:01Z", "message": "Merge branch 'master' into Improve-logging-2\n\nSigned-off-by: Horacio Mijail Anton Quiles <hmijail@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1767, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}