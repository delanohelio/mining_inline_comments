{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzNTg5NTQz", "number": 1189, "title": "Fix tracing with reference tests", "bodyText": "Signed-off-by: Karim TAAM karim.t2am@gmail.com\n\n\nPR description\nThis PR fixes several bugs discovered thanks to the reference tests and goerli (300,000 blocks checked)\nFixes traces in the following cases :\n\nContract creation colission\nStack underflow during contract creation\nrefund_CallToSuicideTwice\nMissing op in VmTrace\nMissing reverted error message in the first frame (If there is no other CALL)\nGasRefund missing on some transaction. This resulted in an invalid gasUsed\n\nThis PR also allows you to trace only what you need (no need to capture memory or storage during tracing). The capture will depend on the options chosen by the user (vmTrace, trace, etc.) And this can improve performance\nTested\n\nCheck with 300,000 blocks on goerli\nCheck with tests already present on besu\nCheck with blocks sent by Alethio", "createdAt": "2020-07-02T15:22:22Z", "url": "https://github.com/hyperledger/besu/pull/1189", "merged": true, "mergeCommit": {"oid": "9c409258b1b327064a91382da92d7232f18adae2"}, "closed": true, "closedAt": "2020-07-03T09:26:37Z", "author": {"login": "matkt"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxAQpKgH2gAyNDQzNTg5NTQzOjE5MzJlMTNhNzI4N2QyZGY4OTRkOGNmYWEyM2YwNGU0Y2QwZTAwYTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcxPlP9AH2gAyNDQzNTg5NTQzOjRmMzE0ZDUyZGU1NDczM2U5MjBjYzA2ZjU0OGJiYWNhOWQwNjU4NjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1932e13a7287d2df894d8cfaa23f04e4cd0e00a7", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/1932e13a7287d2df894d8cfaa23f04e4cd0e00a7", "committedDate": "2020-07-02T15:06:33Z", "message": "fix tracing with reference tests\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxODE1Nzk4", "url": "https://github.com/hyperledger/besu/pull/1189#pullrequestreview-441815798", "createdAt": "2020-07-02T15:45:36Z", "commit": {"oid": "1932e13a7287d2df894d8cfaa23f04e4cd0e00a7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNTo0NTozNlrOGsTPYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNTo0NTozNlrOGsTPYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTEwNTc2Mg==", "bodyText": "If we are adding blocks for 1D and 1E we should have test traces for those blocks as well.", "url": "https://github.com/hyperledger/besu/pull/1189#discussion_r449105762", "createdAt": "2020-07-02T15:45:36Z", "author": {"login": "shemnon"}, "path": "ethereum/api/src/test/resources/org/hyperledger/besu/ethereum/api/jsonrpc/trace/chain-data/blocks.json", "diffHunk": "@@ -499,6 +499,32 @@\n           \"data\": \"0x60806040523373ffffffffffffffffffffffffffffffffffffffff16fffe\"\n         }\n       ]\n+    },\n+    {\n+      \"number\": \"0x1D\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1932e13a7287d2df894d8cfaa23f04e4cd0e00a7"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86a0d6acc590f86385c0afa05501c49eff40773f", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/86a0d6acc590f86385c0afa05501c49eff40773f", "committedDate": "2020-07-02T15:47:09Z", "message": "fix tracing with reference tests\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxODI0MjA2", "url": "https://github.com/hyperledger/besu/pull/1189#pullrequestreview-441824206", "createdAt": "2020-07-02T15:55:04Z", "commit": {"oid": "86a0d6acc590f86385c0afa05501c49eff40773f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNTo1NTowNFrOGsTyQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNTo1NTowNFrOGsTyQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTExNDY5MQ==", "bodyText": "since this wraps all of the remaining conditions should it be changed to a mini guard-block?\nif (currentContext == null) {\n  continue;\n}\n\nor even a break since there is no way the currentContext will ever get changed?", "url": "https://github.com/hyperledger/besu/pull/1189#discussion_r449114691", "createdAt": "2020-07-02T15:55:04Z", "author": {"login": "shemnon"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/results/tracing/flat/FlatTraceGenerator.java", "diffHunk": "@@ -124,25 +129,25 @@\n               + traceFrame.getPrecompiledGasCost().orElse(Gas.ZERO).toLong();\n \n       final String opcodeString = traceFrame.getOpcode();\n-      if (\"CALL\".equals(opcodeString)\n-          || \"CALLCODE\".equals(opcodeString)\n-          || \"DELEGATECALL\".equals(opcodeString)\n-          || \"STATICCALL\".equals(opcodeString)) {\n-\n-        currentContext =\n-            handleCall(\n-                transactionTrace,\n-                traceFrame,\n-                nextTraceFrame,\n-                flatTraces,\n-                cumulativeGasCost,\n-                tracesContexts,\n-                opcodeString.toLowerCase(Locale.US));\n-\n-      } else if (\"CALLDATALOAD\".equals(opcodeString)) {\n-        if (currentContext != null) currentContext = handleCallDataLoad(currentContext, traceFrame);\n-      } else if (\"RETURN\".equals(opcodeString) || \"STOP\".equals(opcodeString)) {\n-        if (currentContext != null) {\n+      if (currentContext != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86a0d6acc590f86385c0afa05501c49eff40773f"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6ff56c4b90f648e563ee5444a212902ff405cf4", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/b6ff56c4b90f648e563ee5444a212902ff405cf4", "committedDate": "2020-07-03T08:56:14Z", "message": "fix review issue\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f314d52de54733e920cc06f548bbaca9d065865", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/4f314d52de54733e920cc06f548bbaca9d065865", "committedDate": "2020-07-03T08:57:38Z", "message": "Merge branch 'upstream/master' into feature/reference-test-for-tracing\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1512, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}