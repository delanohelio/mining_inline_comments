{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNjM4NzA4", "number": 1440, "title": "Allow Random Peer Prioritization", "bodyText": "PR description\nThanks to @shemnon for the suggestion of using a randomly generated mask so we get a \"deterministic\" randomness without allowing nodes to nodeId farm. Review suggestion: hide widespace.\nFixed Issue(s)\nfixes #983\nTesting\nManually tested that 2 peers connected with max-peers of 1 and unlimited inbound peers reject a 3rd peer unless the flag is enabled.\nChangelog\n\n I thought about the changelog and included a changelog update if required.", "createdAt": "2020-10-09T14:42:10Z", "url": "https://github.com/hyperledger/besu/pull/1440", "merged": true, "mergeCommit": {"oid": "b2e3c42eceac4f6bb4fd3689ca5378cb531f950e"}, "closed": true, "closedAt": "2020-10-12T18:53:25Z", "author": {"login": "RatanRSur"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQ3F-sAH2gAyNTAwNjM4NzA4OmJmZWU0Y2I3YWI1MWZlN2ZhODFlZDBkMzY2OTZiOWIzNmE5MTg5NjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdR4JqRgH2gAyNTAwNjM4NzA4OjNmMWUzODIzZDBhZWM1ZmY2MWYyMmY5YTZmOWM0YzRlOGI0MjkzOWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bfee4cb7ab51fe7fa81ed0d36696b9b36a918961", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/bfee4cb7ab51fe7fa81ed0d36696b9b36a918961", "committedDate": "2020-10-09T14:31:20Z", "message": "wip\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddd099dac3e442549478d68ac048c28f387d5e5a", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/ddd099dac3e442549478d68ac048c28f387d5e5a", "committedDate": "2020-10-09T14:31:20Z", "message": "add new prioritization to RlpxAgent\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1d900a37801224bed0b738b316311f28dff3051", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/b1d900a37801224bed0b738b316311f28dff3051", "committedDate": "2020-10-09T14:31:20Z", "message": "threading command line flags\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd0a8d892249b62d262ebba29c50734bff96bc71", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/fd0a8d892249b62d262ebba29c50734bff96bc71", "committedDate": "2020-10-09T14:31:20Z", "message": "test\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8babcf2c5581e148565ff6871ae20e85c97bf99", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/f8babcf2c5581e148565ff6871ae20e85c97bf99", "committedDate": "2020-10-09T14:31:20Z", "message": "don't prematurely reject the possibility of connection if we randomly prioritize peers\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0128d91dc8d158e5fb05abb788449ef8ed674302", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/0128d91dc8d158e5fb05abb788449ef8ed674302", "committedDate": "2020-10-09T14:31:20Z", "message": "more concise assertion\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "940aad77336dbcee043b8a30c22a9671ebca2f83", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/940aad77336dbcee043b8a30c22a9671ebca2f83", "committedDate": "2020-10-09T14:31:20Z", "message": "make sure we see failures as well\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8b5e2ca9ed99d10c8c9eea94f4fad55518c7313", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/b8b5e2ca9ed99d10c8c9eea94f4fad55518c7313", "committedDate": "2020-10-09T14:31:20Z", "message": "make mask number not magic\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "286657d6cee8fe597f801bd8b2ef0023c529cd1c", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/286657d6cee8fe597f801bd8b2ef0023c529cd1c", "committedDate": "2020-10-09T14:31:20Z", "message": "new test\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f6bc080f1e47294336e655703e1951485a71384", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/6f6bc080f1e47294336e655703e1951485a71384", "committedDate": "2020-10-09T14:31:20Z", "message": "typo\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f85371fbe122b74410bb7c99011b4bc1434ddc33", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/f85371fbe122b74410bb7c99011b4bc1434ddc33", "committedDate": "2020-10-09T14:31:20Z", "message": "flag info\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2319f4bfa81cb4eb25b44588b4f0cf08ba19cae5", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/2319f4bfa81cb4eb25b44588b4f0cf08ba19cae5", "committedDate": "2020-10-09T14:31:20Z", "message": "command line and rename\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "161bc6c3977b48ed7f212ad8d4a58f840cd8f517", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/161bc6c3977b48ed7f212ad8d4a58f840cd8f517", "committedDate": "2020-10-09T14:31:20Z", "message": "support peer limit exemptions\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ed18c6fc44c0aa840ad57cbbc1e606968a1edd0", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/5ed18c6fc44c0aa840ad57cbbc1e606968a1edd0", "committedDate": "2020-10-09T14:31:20Z", "message": "fix command line\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25fa752a52dabd3049eb78641b7adf6836cb1801", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/25fa752a52dabd3049eb78641b7adf6836cb1801", "committedDate": "2020-10-09T14:31:20Z", "message": "error prone\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75b1b7e3f09adc103c84878b8d34e2bab10c6a7a", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/75b1b7e3f09adc103c84878b8d34e2bab10c6a7a", "committedDate": "2020-10-09T14:31:20Z", "message": "fix NullPointerException\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09cbfbfc84a27c8c357eade9c94d50862d122702", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/09cbfbfc84a27c8c357eade9c94d50862d122702", "committedDate": "2020-10-09T14:44:51Z", "message": "changelog\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1OTkwNTI0", "url": "https://github.com/hyperledger/besu/pull/1440#pullrequestreview-505990524", "createdAt": "2020-10-09T21:09:22Z", "commit": {"oid": "09cbfbfc84a27c8c357eade9c94d50862d122702"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMTowOToyMlrOHfYrpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMToxNTowN1rOHfYzog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3MjI5NQ==", "bodyText": "I'd add some commentary about the purpose.  Something about the scope (per agent) and purpose (to thwart external gaming of the random comparison).", "url": "https://github.com/hyperledger/besu/pull/1440#discussion_r502672295", "createdAt": "2020-10-09T21:09:22Z", "author": {"login": "shemnon"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/RlpxAgent.java", "diffHunk": "@@ -67,7 +68,9 @@\n   private final PeerRlpxPermissions peerPermissions;\n   private final PeerPrivileges peerPrivileges;\n   private final int maxConnections;\n+  private final boolean randomPeerPriority;\n   private final int maxRemotelyInitiatedConnections;\n+  private final Bytes nodeIdMask = Bytes.random(SECP256K1.PublicKey.BYTE_LENGTH);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09cbfbfc84a27c8c357eade9c94d50862d122702"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3Mjc5MA==", "bodyText": "Randomly feels like the wrong name.  While the mask is random once it's set it doesn't change. compareByMaskedNodeId?", "url": "https://github.com/hyperledger/besu/pull/1440#discussion_r502672790", "createdAt": "2020-10-09T21:10:39Z", "author": {"login": "shemnon"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/RlpxAgent.java", "diffHunk": "@@ -463,21 +471,29 @@ private void enforceConnectionLimits() {\n   private Stream<RlpxConnection> getActivePrioritizedConnections() {\n     return connectionsById.values().stream()\n         .filter(RlpxConnection::isActive)\n-        .sorted(this::prioritizeConnections);\n+        .sorted(this::comparePeerPriorities);\n   }\n \n-  private int prioritizeConnections(final RlpxConnection a, final RlpxConnection b) {\n+  private int comparePeerPriorities(final RlpxConnection a, final RlpxConnection b) {\n     final boolean aIgnoresPeerLimits = peerPrivileges.canExceedConnectionLimits(a.getPeer());\n     final boolean bIgnoresPeerLimits = peerPrivileges.canExceedConnectionLimits(b.getPeer());\n     if (aIgnoresPeerLimits && !bIgnoresPeerLimits) {\n       return -1;\n     } else if (bIgnoresPeerLimits && !aIgnoresPeerLimits) {\n       return 1;\n     } else {\n-      return Math.toIntExact(a.getInitiatedAt() - b.getInitiatedAt());\n+      return randomPeerPriority ? compareRandomly(a, b) : compareConnectionInitiationTimes(a, b);\n     }\n   }\n \n+  private int compareConnectionInitiationTimes(final RlpxConnection a, final RlpxConnection b) {\n+    return Math.toIntExact(a.getInitiatedAt() - b.getInitiatedAt());\n+  }\n+\n+  private int compareRandomly(final RlpxConnection a, final RlpxConnection b) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09cbfbfc84a27c8c357eade9c94d50862d122702"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3NDMzOA==", "bodyText": "Perhaps we should white box this test.\nGo ahead and set up the pool and the peer randomly, but then get the peer that would be evicted (sorted last), then generate peers until we get one that we see is higher priority than the one to be evicted, and then only once do the add check loop.  We would need to get at the peers list and the nodeIdMask to do this, hence the white boxing.", "url": "https://github.com/hyperledger/besu/pull/1440#discussion_r502674338", "createdAt": "2020-10-09T21:15:07Z", "author": {"login": "shemnon"}, "path": "ethereum/p2p/src/test/java/org/hyperledger/besu/ethereum/p2p/rlpx/RlpxAgentTest.java", "diffHunk": "@@ -321,6 +323,41 @@ public void incomingConnection_maxPeersExceeded()\n     }\n   }\n \n+  @Test\n+  public void incomingConnection_succeedsEventuallyWithRandomPeerPrioritization() {\n+    // Saturate connections with one local and one remote\n+    startAgentWithMaxPeers(2, builder -> builder.randomPeerPriority(true));\n+    agent.connect(createPeer());\n+    connectionInitializer.simulateIncomingConnection(connection(createPeer()));\n+    // Sanity check\n+    assertThat(agent.getConnectionCount()).isEqualTo(2);\n+\n+    boolean newConnectionDisconnected = false;\n+    boolean oldConnectionDisconnected = false;\n+    // With very high probability we should see the connections churn\n+    for (int i = 0; i < 1000; ++i) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09cbfbfc84a27c8c357eade9c94d50862d122702"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ea9e7f9e1dd68dc429bb43e76a76fc23898e124", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/3ea9e7f9e1dd68dc429bb43e76a76fc23898e124", "committedDate": "2020-10-12T15:02:45Z", "message": "comment\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11b1221309104f4136d5f664e919f4876a4ad878", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/11b1221309104f4136d5f664e919f4876a4ad878", "committedDate": "2020-10-12T15:03:59Z", "message": "rename\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c75717c1f67b921d39419179ac05daf3dfa3be2", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/8c75717c1f67b921d39419179ac05daf3dfa3be2", "committedDate": "2020-10-12T15:09:25Z", "message": "Merge remote-tracking branch 'upstream/master' into accomodating-peering"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7eb1f228852c52044f22d6dee34e2521934c614", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/d7eb1f228852c52044f22d6dee34e2521934c614", "committedDate": "2020-10-12T17:27:56Z", "message": "early exit\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd73c977cd462a6b529c75783ad9f7aae6e8b902", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/dd73c977cd462a6b529c75783ad9f7aae6e8b902", "committedDate": "2020-10-12T17:28:05Z", "message": "test every loop\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f1e3823d0aec5ff61f22f9a6f9c4c4e8b42939e", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/3f1e3823d0aec5ff61f22f9a6f9c4c4e8b42939e", "committedDate": "2020-10-12T18:19:11Z", "message": "use 25 peers instead of 2\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2202, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}