{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyNjg2NzU2", "number": 831, "title": "Ibft now handles failing sign operations", "bodyText": "IbftRound has been updated to handle Signing errors (eg no signature supplier available) and\ncontinue operating if possible.\nSigned-off-by: Trent Mohay trent.mohay@consensys.net", "createdAt": "2020-05-03T23:48:04Z", "url": "https://github.com/hyperledger/besu/pull/831", "merged": true, "mergeCommit": {"oid": "0917f8905af8ee3c2b8df929c709bde8259ca368"}, "closed": true, "closedAt": "2020-05-06T06:44:49Z", "author": {"login": "rain-on"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcd0Pv2gBqjMyOTc5OTI2ODA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceiW-wgBqjMzMDcwMTAzNjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "969e670ce16d7cca69f93571f8c6a77a0d5bfd1b", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/969e670ce16d7cca69f93571f8c6a77a0d5bfd1b", "committedDate": "2020-05-03T23:23:14Z", "message": "Ibft now handles failing sign operations\n\nTests are not yet written, however IbftRound has been updated to\naccept Signing errors (eg no signature supplier available) and\ncontinue operating if possible.\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}, "afterCommit": {"oid": "baecdd932f5dcf6ce3a551437b0fa5317c2422db", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/baecdd932f5dcf6ce3a551437b0fa5317c2422db", "committedDate": "2020-05-04T00:21:56Z", "message": "Ibft now handles failing sign operations\n\nTests are not yet written, however IbftRound has been updated to\naccept Signing errors (eg no signature supplier available) and\ncontinue operating if possible.\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f81ca8d1ee70ee8f81da547d0b6f120d2c9fc2f7", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/f81ca8d1ee70ee8f81da547d0b6f120d2c9fc2f7", "committedDate": "2020-05-04T01:57:03Z", "message": "fix spotless\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}, "afterCommit": {"oid": "75fcd7272d29335a13789ad7765ce85863b7da9a", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/75fcd7272d29335a13789ad7765ce85863b7da9a", "committedDate": "2020-05-04T02:13:54Z", "message": "fix spotless\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f3606ff689265858276a790234a8b6e37f629eb9", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/f3606ff689265858276a790234a8b6e37f629eb9", "committedDate": "2020-05-04T03:54:38Z", "message": "more spotless fixes\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}, "afterCommit": {"oid": "b8e917bfe926485be70342b4c2e7679723d7fcda", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/b8e917bfe926485be70342b4c2e7679723d7fcda", "committedDate": "2020-05-04T05:08:06Z", "message": "Handle Crytpo failures in Ibft, Clique, discovery and Handshaking\n\nTests are not yet written, however IbftRound has been updated to\naccept Signing errors (eg no signature supplier available) and\ncontinue operating if possible.\n\nThis also catches failures in signing and ECDH Key agreement\ncreation during discovery and handshaking.\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b8e917bfe926485be70342b4c2e7679723d7fcda", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/b8e917bfe926485be70342b4c2e7679723d7fcda", "committedDate": "2020-05-04T05:08:06Z", "message": "Handle Crytpo failures in Ibft, Clique, discovery and Handshaking\n\nTests are not yet written, however IbftRound has been updated to\naccept Signing errors (eg no signature supplier available) and\ncontinue operating if possible.\n\nThis also catches failures in signing and ECDH Key agreement\ncreation during discovery and handshaking.\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}, "afterCommit": {"oid": "00b7f809004a5e512eab35297a6d839c2d79feac", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/00b7f809004a5e512eab35297a6d839c2d79feac", "committedDate": "2020-05-04T05:22:03Z", "message": "Handle Crytpo failures in Ibft, Clique, discovery and Handshaking\n\nTests are not yet written, however IbftRound has been updated to\naccept Signing errors (eg no signature supplier available) and\ncontinue operating if possible.\n\nThis also catches failures in signing and ECDH Key agreement\ncreation during discovery and handshaking.\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NDI0Njc0", "url": "https://github.com/hyperledger/besu/pull/831#pullrequestreview-405424674", "createdAt": "2020-05-04T23:59:04Z", "commit": {"oid": "00b7f809004a5e512eab35297a6d839c2d79feac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMzo1OTowNFrOGQWUDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMzo1OTowNFrOGQWUDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc5NTk4MQ==", "bodyText": "you have changed the operations order from previous logic? i.e. Previously it was multiCastPrepare then peerIsPrepared. Now it is peerIsPrepared then multicastPrepare? Is that by mistake or it doesn't matter?", "url": "https://github.com/hyperledger/besu/pull/831#discussion_r419795981", "createdAt": "2020-05-04T23:59:04Z", "author": {"login": "usmansaleem"}, "path": "consensus/ibft/src/main/java/org/hyperledger/besu/consensus/ibft/statemachine/IbftRound.java", "diffHunk": "@@ -132,11 +138,15 @@ public void handleProposalMessage(final Proposal msg) {\n \n     if (updateStateWithProposedBlock(msg)) {\n       LOG.debug(\"Sending prepare message. round={}\", roundState.getRoundIdentifier());\n-      final Prepare localPrepareMessage =\n-          messageFactory.createPrepare(getRoundIdentifier(), block.getHash());\n-      transmitter.multicastPrepare(\n-          localPrepareMessage.getRoundIdentifier(), localPrepareMessage.getDigest());\n-      peerIsPrepared(localPrepareMessage);\n+      try {\n+        final Prepare localPrepareMessage =\n+            messageFactory.createPrepare(getRoundIdentifier(), block.getHash());\n+        peerIsPrepared(localPrepareMessage);\n+        transmitter.multicastPrepare(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00b7f809004a5e512eab35297a6d839c2d79feac"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NDI2MTk0", "url": "https://github.com/hyperledger/besu/pull/831#pullrequestreview-405426194", "createdAt": "2020-05-05T00:03:46Z", "commit": {"oid": "00b7f809004a5e512eab35297a6d839c2d79feac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NDg2NTc4", "url": "https://github.com/hyperledger/besu/pull/831#pullrequestreview-405486578", "createdAt": "2020-05-05T04:32:07Z", "commit": {"oid": "00b7f809004a5e512eab35297a6d839c2d79feac"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwNDozMjowN1rOGQaF-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwNDo1OToyMFrOGQadIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg1NzkxMg==", "bodyText": "The try/catch only needs to be around the messageFactory.create method", "url": "https://github.com/hyperledger/besu/pull/831#discussion_r419857912", "createdAt": "2020-05-05T04:32:07Z", "author": {"login": "jframe"}, "path": "consensus/ibft/src/main/java/org/hyperledger/besu/consensus/ibft/network/IbftMessageTransmitter.java", "diffHunk": "@@ -47,42 +53,57 @@ public void multicastProposal(\n       final ConsensusRoundIdentifier roundIdentifier,\n       final Block block,\n       final Optional<RoundChangeCertificate> roundChangeCertificate) {\n-    final Proposal data =\n-        messageFactory.createProposal(roundIdentifier, block, roundChangeCertificate);\n+    try {\n+      final Proposal data =\n+          messageFactory.createProposal(roundIdentifier, block, roundChangeCertificate);\n \n-    final ProposalMessageData message = ProposalMessageData.create(data);\n+      final ProposalMessageData message = ProposalMessageData.create(data);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00b7f809004a5e512eab35297a6d839c2d79feac"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg1ODA0Ng==", "bodyText": "Same as above for the all the other messages in the message transmitter", "url": "https://github.com/hyperledger/besu/pull/831#discussion_r419858046", "createdAt": "2020-05-05T04:32:52Z", "author": {"login": "jframe"}, "path": "consensus/ibft/src/main/java/org/hyperledger/besu/consensus/ibft/network/IbftMessageTransmitter.java", "diffHunk": "@@ -47,42 +53,57 @@ public void multicastProposal(\n       final ConsensusRoundIdentifier roundIdentifier,\n       final Block block,\n       final Optional<RoundChangeCertificate> roundChangeCertificate) {\n-    final Proposal data =\n-        messageFactory.createProposal(roundIdentifier, block, roundChangeCertificate);\n+    try {\n+      final Proposal data =\n+          messageFactory.createProposal(roundIdentifier, block, roundChangeCertificate);\n \n-    final ProposalMessageData message = ProposalMessageData.create(data);\n+      final ProposalMessageData message = ProposalMessageData.create(data);\n \n-    multicaster.send(message);\n+      multicaster.send(message);\n+    } catch (final SecurityModuleException e) {\n+      LOG.warn(\"Failed to generate signature for Proposal (not sent): {} \", e.getMessage());\n+    }\n   }\n \n   public void multicastPrepare(final ConsensusRoundIdentifier roundIdentifier, final Hash digest) {\n-    final Prepare data = messageFactory.createPrepare(roundIdentifier, digest);\n+    try {\n+      final Prepare data = messageFactory.createPrepare(roundIdentifier, digest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00b7f809004a5e512eab35297a6d839c2d79feac"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg1ODk5Nw==", "bodyText": "Is it only the createPrepare that can fail with a SecurityModuleException? Don't think this try/catch needs to be around the peerIsPrepared or multicastPrepare", "url": "https://github.com/hyperledger/besu/pull/831#discussion_r419858997", "createdAt": "2020-05-05T04:37:24Z", "author": {"login": "jframe"}, "path": "consensus/ibft/src/main/java/org/hyperledger/besu/consensus/ibft/statemachine/IbftRound.java", "diffHunk": "@@ -132,11 +138,15 @@ public void handleProposalMessage(final Proposal msg) {\n \n     if (updateStateWithProposedBlock(msg)) {\n       LOG.debug(\"Sending prepare message. round={}\", roundState.getRoundIdentifier());\n-      final Prepare localPrepareMessage =\n-          messageFactory.createPrepare(getRoundIdentifier(), block.getHash());\n-      transmitter.multicastPrepare(\n-          localPrepareMessage.getRoundIdentifier(), localPrepareMessage.getDigest());\n-      peerIsPrepared(localPrepareMessage);\n+      try {\n+        final Prepare localPrepareMessage =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00b7f809004a5e512eab35297a6d839c2d79feac"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTg2Mzg0MA==", "bodyText": "Should we be returning true in this case, as this will result in a prepare message being created?", "url": "https://github.com/hyperledger/besu/pull/831#discussion_r419863840", "createdAt": "2020-05-05T04:59:20Z", "author": {"login": "jframe"}, "path": "consensus/ibft/src/main/java/org/hyperledger/besu/consensus/ibft/statemachine/IbftRound.java", "diffHunk": "@@ -158,23 +168,41 @@ private boolean updateStateWithProposedBlock(final Proposal msg) {\n     final boolean wasPrepared = roundState.isPrepared();\n     final boolean wasCommitted = roundState.isCommitted();\n     final boolean blockAccepted = roundState.setProposedBlock(msg);\n+\n     if (blockAccepted) {\n+      final Block block = roundState.getProposedBlock().get();\n+\n+      final Signature commitSeal;\n+      try {\n+        commitSeal = createCommitSeal(block);\n+      } catch (final SecurityModuleException e) {\n+        LOG.warn(\"Failed to construct commit seal; {}\", e.getMessage());\n+        return blockAccepted;\n+      }\n+\n       // There are times handling a proposed block is enough to enter prepared.\n       if (wasPrepared != roundState.isPrepared()) {\n         LOG.debug(\"Sending commit message. round={}\", roundState.getRoundIdentifier());\n-        final Block block = roundState.getProposedBlock().get();\n-        transmitter.multicastCommit(getRoundIdentifier(), block.getHash(), createCommitSeal(block));\n+        transmitter.multicastCommit(getRoundIdentifier(), block.getHash(), commitSeal);\n+      }\n+\n+      // can automatically add _our_ commit message to the roundState\n+      // cannot create a prepare message here, as it may be _our_ proposal, and thus we cannot also\n+      // prepare\n+      try {\n+        final Commit localCommitMessage =\n+            messageFactory.createCommit(\n+                roundState.getRoundIdentifier(), msg.getBlock().getHash(), commitSeal);\n+        roundState.addCommitMessage(localCommitMessage);\n+      } catch (final SecurityModuleException e) {\n+        LOG.warn(\"Failed to create signed Commit message; {}\", e.getMessage());\n+        return blockAccepted;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00b7f809004a5e512eab35297a6d839c2d79feac"}, "originalPosition": 79}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3b7a5069ad22aeb248134bf44c65387a8e1bcdb", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/e3b7a5069ad22aeb248134bf44c65387a8e1bcdb", "committedDate": "2020-05-06T06:05:18Z", "message": "Handle Crytpo failures in Ibft, Clique, discovery and Handshaking\n\nTests are not yet written, however IbftRound has been updated to\naccept Signing errors (eg no signature supplier available) and\ncontinue operating if possible.\n\nThis also catches failures in signing and ECDH Key agreement\ncreation during discovery and handshaking.\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "414a1b8241605e482b793a68102f8b955fb9da80", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/414a1b8241605e482b793a68102f8b955fb9da80", "committedDate": "2020-05-06T05:49:46Z", "message": "fix log line in controller"}, "afterCommit": {"oid": "e3b7a5069ad22aeb248134bf44c65387a8e1bcdb", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/e3b7a5069ad22aeb248134bf44c65387a8e1bcdb", "committedDate": "2020-05-06T06:05:18Z", "message": "Handle Crytpo failures in Ibft, Clique, discovery and Handshaking\n\nTests are not yet written, however IbftRound has been updated to\naccept Signing errors (eg no signature supplier available) and\ncontinue operating if possible.\n\nThis also catches failures in signing and ECDH Key agreement\ncreation during discovery and handshaking.\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1613, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}