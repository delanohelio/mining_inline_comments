{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxNjUwNjIx", "number": 1169, "title": "Copy Subscribers to Prevent Unwanted Recursion", "bodyText": "Occasionally, a callback given to a subscriber will complete a future which then runs another task which adds another callback to the subsriber list of the same type. By the time the first callback is finished, the new callback (which presumably wants another \"real\" instance of the event to happen) could be next up in the list of the first's subscribers callback iteration. This takes a snapshot of the subsribers when the desired event happens so there's no risk of following down the rabbit hole.\nI collected some rough data about the size of the subscriber lists to see the penalty for copying them and I found that by the time a full sync began or a fast sync had started downloading headers, the maximum subscribers any one Subscribers class had was 7.", "createdAt": "2020-06-29T21:07:54Z", "url": "https://github.com/hyperledger/besu/pull/1169", "merged": true, "mergeCommit": {"oid": "78f203d8a3d215e49a7dfa6ed4b05ab2beacc583"}, "closed": true, "closedAt": "2020-07-08T15:42:56Z", "author": {"login": "RatanRSur"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwHejIgH2gAyNDQxNjUwNjIxOmZjYjU4Y2RkZWNhNTU2YTRiYTMxNWEyMGM5NjcwNTM4NjYxYjY5MjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy8Cu1gH2gAyNDQxNjUwNjIxOjZlZDlmN2ZhMzY3YmE0YTg1YjZjNmZmOGU1ZTI2MmM4MjI2NWJkNWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fcb58cddeca556a4ba315a20c9670538661b6920", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/fcb58cddeca556a4ba315a20c9670538661b6920", "committedDate": "2020-06-29T20:57:09Z", "message": "copy subscribers to prevent recursion\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NTMxOTcw", "url": "https://github.com/hyperledger/besu/pull/1169#pullrequestreview-439531970", "createdAt": "2020-06-29T22:03:36Z", "commit": {"oid": "fcb58cddeca556a4ba315a20c9670538661b6920"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMjowMzozNlrOGqjz9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMjowMzozNlrOGqjz9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI4MDExNw==", "bodyText": "So this is the main change?  the rest are all style adjustments?", "url": "https://github.com/hyperledger/besu/pull/1169#discussion_r447280117", "createdAt": "2020-06-29T22:03:36Z", "author": {"login": "shemnon"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/SyncTargetManager.java", "diffHunk": "@@ -113,7 +113,7 @@ protected SyncTargetManager(\n   protected abstract CompletableFuture<Optional<EthPeer>> selectBestAvailableSyncTarget();\n \n   private CompletableFuture<SyncTarget> waitForPeerAndThenSetSyncTarget() {\n-    return waitForNewPeer().handle((r, t) -> r).thenCompose((r) -> selectNewSyncTarget());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcb58cddeca556a4ba315a20c9670538661b6920"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NTMyOTg4", "url": "https://github.com/hyperledger/besu/pull/1169#pullrequestreview-439532988", "createdAt": "2020-06-29T22:05:21Z", "commit": {"oid": "fcb58cddeca556a4ba315a20c9670538661b6920"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMjowNToyMVrOGqj3Rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMjowNToyMVrOGqj3Rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI4MDk2Ng==", "bodyText": "Actually, this is the main change.  Can we move all style changes to a separate PR since they masked where the real change was?", "url": "https://github.com/hyperledger/besu/pull/1169#discussion_r447280966", "createdAt": "2020-06-29T22:05:21Z", "author": {"login": "shemnon"}, "path": "util/src/main/java/org/hyperledger/besu/util/Subscribers.java", "diffHunk": "@@ -101,17 +102,19 @@ public boolean unsubscribe(final long subscriberId) {\n    * @param action the action to perform for each subscriber\n    */\n   public void forEach(final Consumer<T> action) {\n-    subscribers\n-        .values()\n+    ImmutableSet.copyOf(\n+            // we copy here to ensure that our callback, which may add another subscriber on this", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcb58cddeca556a4ba315a20c9670538661b6920"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NTQzMTE4", "url": "https://github.com/hyperledger/besu/pull/1169#pullrequestreview-439543118", "createdAt": "2020-06-29T22:23:36Z", "commit": {"oid": "fcb58cddeca556a4ba315a20c9670538661b6920"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMjoyMzozN1rOGqkkTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMjoyMzozN1rOGqkkTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI5MjQ5Mw==", "bodyText": "changing this from throwable to exception seems important - i.e. prior to this change, throwables would be eaten by the \"suppress\" - now they will always be raised (which maybe the intent, but wanted to confirm).", "url": "https://github.com/hyperledger/besu/pull/1169#discussion_r447292493", "createdAt": "2020-06-29T22:23:37Z", "author": {"login": "rain-on"}, "path": "util/src/main/java/org/hyperledger/besu/util/Subscribers.java", "diffHunk": "@@ -101,17 +102,19 @@ public boolean unsubscribe(final long subscriberId) {\n    * @param action the action to perform for each subscriber\n    */\n   public void forEach(final Consumer<T> action) {\n-    subscribers\n-        .values()\n+    ImmutableSet.copyOf(\n+            // we copy here to ensure that our callback, which may add another subscriber on this\n+            // event, won't trigger that new additional subscriber\n+            subscribers.values())\n         .forEach(\n             subscriber -> {\n               try {\n                 action.accept(subscriber);\n-              } catch (Throwable throwable) {\n+              } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcb58cddeca556a4ba315a20c9670538661b6920"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a1408cf4dcb7df6536cf55d0b92b28a6615c56c", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/9a1408cf4dcb7df6536cf55d0b92b28a6615c56c", "committedDate": "2020-07-06T16:57:00Z", "message": "remove style changes\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67f7a3fad2f75927e1575d7a3187a20ac6a280d6", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/67f7a3fad2f75927e1575d7a3187a20ac6a280d6", "committedDate": "2020-07-06T16:57:25Z", "message": "Merge remote-tracking branch 'upstream' into wait-for-peer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MzMxMzE2", "url": "https://github.com/hyperledger/besu/pull/1169#pullrequestreview-444331316", "createdAt": "2020-07-08T00:13:23Z", "commit": {"oid": "67f7a3fad2f75927e1575d7a3187a20ac6a280d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ed9f7fa367ba4a85b6c6ff8e5e262c82265bd5f", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/6ed9f7fa367ba4a85b6c6ff8e5e262c82265bd5f", "committedDate": "2020-07-08T15:19:35Z", "message": "Merge branch 'master' into wait-for-peer"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1506, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}