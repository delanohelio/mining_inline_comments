{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwODMwMzM2", "number": 1649, "title": "Add extra info in log messages to help with flaky test ", "bodyText": "Added some extra logging that should help if the awaitPeerCount assertion fails again. See #1646\nChangelog\n\n I thought about the changelog and included a changelog update if required.", "createdAt": "2020-12-02T08:03:00Z", "url": "https://github.com/hyperledger/besu/pull/1649", "merged": true, "mergeCommit": {"oid": "a430ea1bba6e807de9e10074ef34e3a47b951455"}, "closed": true, "closedAt": "2020-12-03T05:16:53Z", "author": {"login": "macfarla"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiGox7AH2gAyNTMwODMwMzM2OjE2MTllODZlYzlkNjBiNjdkMzVkMjE1ZjZjMmVmNTdhZWRkYzk3NjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdicEXLAFqTU0MzQ4OTg5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1619e86ec9d60b67d35d215f6c2ef57aeddc9764", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/1619e86ec9d60b67d35d215f6c2ef57aeddc9764", "committedDate": "2020-12-02T04:14:38Z", "message": "extra logging including pid\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b91384231a137d3491075b9b70aaaae6628d47f", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/8b91384231a137d3491075b9b70aaaae6628d47f", "committedDate": "2020-12-02T08:00:23Z", "message": "extra logging\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99c3c1e5943e8690a5bc953b65c5dedb96b55a4a", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/99c3c1e5943e8690a5bc953b65c5dedb96b55a4a", "committedDate": "2020-12-02T08:00:27Z", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into flaky-test-await-peer-count"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMzM3NjYy", "url": "https://github.com/hyperledger/besu/pull/1649#pullrequestreview-543337662", "createdAt": "2020-12-03T00:01:43Z", "commit": {"oid": "99c3c1e5943e8690a5bc953b65c5dedb96b55a4a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwMDowMTo0M1rOH9zRWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwMDowNDoxNVrOH9zU-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU2NTIxMQ==", "bodyText": "can we put a try-catch block around the awaitPeerDiscovery and if fail - dump the actual peers\n(this would require creating a transaction in the dsl which wraps Ethereum.adminPeers - similar to NetPeerCountTransaction)", "url": "https://github.com/hyperledger/besu/pull/1649#discussion_r534565211", "createdAt": "2020-12-03T00:01:43Z", "author": {"login": "rain-on"}, "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/cluster/Cluster.java", "diffHunk": "@@ -87,12 +87,19 @@ public void start(final List<? extends RunnableNode> nodes) {\n \n     nodes\n         .parallelStream()\n-        .filter(node -> bootnode.map(boot -> boot != node).orElse(true))\n+        .filter(\n+            node -> {\n+              LOG.info(\"starting non-bootnode {}\", node.getName());\n+              return bootnode.map(boot -> boot != node).orElse(true);\n+            })\n         .forEach(this::startNode);\n \n     if (clusterConfiguration.isAwaitPeerDiscovery()) {\n       for (final RunnableNode node : nodes) {\n-        LOG.info(\"Awaiting peer discovery for node {}\", node.getName());\n+        LOG.info(\n+            \"Awaiting peer discovery for node {}, expecting {} peers\",\n+            node.getName(),\n+            nodes.size() - 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99c3c1e5943e8690a5bc953b65c5dedb96b55a4a"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU2NjEzNg==", "bodyText": "doing this in a custom fork-join pool can be done like:\nForkJoinPool forkJoinPool = new ForkJoinPool(nodes.size() - 1); forkJoiNPool.submit(nodes.parallelStream() ....\nThat removes a dependency on the \"system wide\" thread pool, which removes a dependency which might be causing problems,", "url": "https://github.com/hyperledger/besu/pull/1649#discussion_r534566136", "createdAt": "2020-12-03T00:04:15Z", "author": {"login": "rain-on"}, "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/cluster/Cluster.java", "diffHunk": "@@ -87,12 +87,19 @@ public void start(final List<? extends RunnableNode> nodes) {\n \n     nodes\n         .parallelStream()\n-        .filter(node -> bootnode.map(boot -> boot != node).orElse(true))\n+        .filter(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99c3c1e5943e8690a5bc953b65c5dedb96b55a4a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fa032d2fa5b6575ea9b68c2911587348c18e216", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/1fa032d2fa5b6575ea9b68c2911587348c18e216", "committedDate": "2020-12-03T04:29:52Z", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into flaky-test-await-peer-count"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzNDg5ODk2", "url": "https://github.com/hyperledger/besu/pull/1649#pullrequestreview-543489896", "createdAt": "2020-12-03T05:12:46Z", "commit": {"oid": "1fa032d2fa5b6575ea9b68c2911587348c18e216"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2149, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}