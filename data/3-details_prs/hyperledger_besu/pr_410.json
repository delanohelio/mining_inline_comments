{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2ODA2MTQy", "number": 410, "title": "[BOUNTY-4] Add NAT Kubernetes Support", "bodyText": "Signed-off-by: Karim TAAM karim.t2am@gmail.com\nPR description\nThe goal of this work is to offer developers a consistent API for performing NAT tasks, and add support for Kubernetes NAT implementation when Besu is being run from a Kubernetes cluster.\n\nProperly detects when Besu is being run inside a Kubernetes cluster.\n\nBesu will automatically detect that the client is in a kubernetes.\n\nInteracts with Kubernetes APIs, as needed, to determine external IP address and exposed ports.\n\nBesu will automatically try to detect the external IP address and the exposed ports thanks to the sdk https://github.com/kubernetes-client/java under Apache 2.0\nThe configuration will be in the '/opt/besu/shared/kube-config' location\nSample of script in order to define the port mapping\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app.kubernetes.io/name: besu\n    app.kubernetes.io/release: \"1.0.0\"\n  name: besu\nspec:\n  ports:\n  - name: \"json-rpc\"\n    port: 9000\n    targetPort: 8545\n  - name: \"rlpx\"\n    port: 7777\n    targetPort: 8888\n  selector:\n    app.kubernetes.io/name: besu\n    app.kubernetes.io/release: \"1.0.0\"\n  type: LoadBalancer\n\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: besu-config\n  labels:\n    app.kubernetes.io/name: besu\n    app.kubernetes.io/release: 1.0.0\ndata:\n  BESU_LOGGING: \"INFO\"\n  BESU_NETWORK: \"dev\"\n  BESU_P2P_ENABLED: \"true\"\n  BESU_RPC_HTTP_ENABLED: \"true\"\n  BESU_RPC_HTTP_APIS: \"eth,net,web3,debug,admin\"\n  KUBE_CONFIG_PATH: \"/opt/besu/shared/kube-config\"\n\n---\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: besu\n  labels:\n    app.kubernetes.io/name: besu\n    app.kubernetes.io/release: \"1.0.0\"\nspec:\n  replicas: 1\n  strategy: {}\n  template:\n    metadata:\n      creationTimestamp: null\n      labels:\n        app.kubernetes.io/name: besu\n        app.kubernetes.io/release: \"1.0.0\"\n    spec:\n      volumes:\n        - name: task-pv-storage\n          persistentVolumeClaim:\n            claimName: task-pv-claim\n      containers:\n      - name: besu\n        image: \"hyperledger/besu:1.4.1-SNAPSHOT\"\n        imagePullPolicy: Never\n        ports:\n          - containerPort: 8545\n        volumeMounts:\n          - mountPath: \"/opt/besu/shared\"\n            name: task-pv-storage\n        envFrom:\n        - configMapRef:\n            name: besu-config\n      restartPolicy: Always\nstatus: {}\n\n\n\nCreate persistent volume\nkubectl apply -f pv-volume.yml\n\n\nClaim volume\nkubectl apply -f pv-claim.yml\n\n\nCopy the kube config file in the mounted directory.\n\n\nDeploy Besu service.\nkubectl apply -f besu-service.yml -f besu-deployment.yml", "createdAt": "2020-02-18T19:56:04Z", "url": "https://github.com/hyperledger/besu/pull/410", "merged": true, "mergeCommit": {"oid": "8a6840273252af81e44b6b245d9a81d8f11389af"}, "closed": true, "closedAt": "2020-02-19T09:34:37Z", "author": {"login": "matkt"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFnIbAAH2gAyMzc2ODA2MTQyOmE3YjRiNjNmYzIxMzA3ZDk5ZGRkMTE2NDI0OTBlNzVkOGVlY2VkYjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFy0JfgFqTM2MDk0MDk3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a7b4b63fc21307d99ddd11642490e75d8eecedb1", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/a7b4b63fc21307d99ddd11642490e75d8eecedb1", "committedDate": "2020-02-18T19:31:12Z", "message": "add kubernetes support\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25aeeee054edc3ffbc2c58a218cd7b12d3a4bf50", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/25aeeee054edc3ffbc2c58a218cd7b12d3a4bf50", "committedDate": "2020-02-18T19:34:18Z", "message": "merge from master\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNjkzNDI0", "url": "https://github.com/hyperledger/besu/pull/410#pullrequestreview-360693424", "createdAt": "2020-02-18T21:41:18Z", "commit": {"oid": "25aeeee054edc3ffbc2c58a218cd7b12d3a4bf50"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMTo0MToxOFrOFrTclg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMTo0MToxOFrOFrTclg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1MTcwMg==", "bodyText": "What happens if it would return the NatMethod for both of these? Do we want Docker to be returned even if Kubernetes would be detected?", "url": "https://github.com/hyperledger/besu/pull/410#discussion_r380951702", "createdAt": "2020-02-18T21:41:18Z", "author": {"login": "RatanRSur"}, "path": "besu/src/main/java/org/hyperledger/besu/RunnerBuilder.java", "diffHunk": "@@ -590,7 +597,7 @@ public Runner build() {\n     final NatMethod detectedNatMethod =\n         Optional.of(natMethod)\n             .filter(not(isEqual(NatMethod.AUTO)))\n-            .orElse(NatService.autoDetectNatMethod(new DockerDetector()));\n+            .orElse(NatService.autoDetectNatMethod(new DockerDetector(), new KubernetesDetector()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25aeeee054edc3ffbc2c58a218cd7b12d3a4bf50"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNjk2MzE5", "url": "https://github.com/hyperledger/besu/pull/410#pullrequestreview-360696319", "createdAt": "2020-02-18T21:46:05Z", "commit": {"oid": "25aeeee054edc3ffbc2c58a218cd7b12d3a4bf50"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMTo0NjowNlrOFrTlXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMTo0NjowNlrOFrTlXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1Mzk1MQ==", "bodyText": "Since the strings are only used once, I would inline usages here to make it easier to glance over at the file and see more richly typed fields. So the types would become Optional<String> and Path.", "url": "https://github.com/hyperledger/besu/pull/410#discussion_r380953951", "createdAt": "2020-02-18T21:46:06Z", "author": {"login": "RatanRSur"}, "path": "nat/src/main/java/org/hyperledger/besu/nat/kubernetes/KubernetesDetector.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+\n+package org.hyperledger.besu.nat.kubernetes;\n+\n+import org.hyperledger.besu.nat.NatMethod;\n+import org.hyperledger.besu.nat.core.NatMethodDetector;\n+\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.Optional;\n+\n+public class KubernetesDetector implements NatMethodDetector {\n+\n+  // When a Pod runs on a Node, the kubelet adds a set of environment variables for each active\n+  // Service.\n+  // https://kubernetes.io/docs/concepts/services-networking/connect-applications-service/#environment-variables\n+  private static final String KUBERNETES_SERVICE_HOST = \"KUBERNETES_SERVICE_HOST\";\n+  private static final String KUBERNETES_WATERMARK_FILE = \"/var/run/secrets/kubernetes.io\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25aeeee054edc3ffbc2c58a218cd7b12d3a4bf50"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b727b7b5132f7212895670617a09d3bb25f0171f", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/b727b7b5132f7212895670617a09d3bb25f0171f", "committedDate": "2020-02-19T09:02:44Z", "message": "fix review issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41c7394b0edb6413abe00a17e1c3269e7c4d3066", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/41c7394b0edb6413abe00a17e1c3269e7c4d3066", "committedDate": "2020-02-19T09:03:12Z", "message": "merge from master\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwOTQwOTcw", "url": "https://github.com/hyperledger/besu/pull/410#pullrequestreview-360940970", "createdAt": "2020-02-19T09:07:55Z", "commit": {"oid": "41c7394b0edb6413abe00a17e1c3269e7c4d3066"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1781, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}