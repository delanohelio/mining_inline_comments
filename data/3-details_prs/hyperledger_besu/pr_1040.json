{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3NjI5NDIw", "number": 1040, "title": "Fix flaky test: Permissioning + IBFT stall", "bodyText": "PR description\nTest was failing with timeout when trying to verify that node was added to whitelist successfully. This was because blocks were not yet being produced, caused by IBFT rounds not completing successfully - ie nodes were still starting up and getting rounds in sync (takes ~1.5 min). Block 1 is usually produced in IBFT round 2 or 3.\nTo fix:\n\nverify that blocks are being produced BEFORE trying to send transactions adding nodes to whitelist\nreduced number of validators from 4 to 2\nreduced height of blocks being waited for in between test logic, since this was just wasting time - test doesn't require 15 blocks, we just need to know blocks are being produced\nremoved checks for number of peers since this is already done in cluster.start()\n\nFixed Issue(s)\nFixes #1011", "createdAt": "2020-06-04T06:58:21Z", "url": "https://github.com/hyperledger/besu/pull/1040", "merged": true, "mergeCommit": {"oid": "4d18598d21a743b8ad86bc9e69fc26b44eef5daa"}, "closed": true, "closedAt": "2020-06-05T03:02:19Z", "author": {"login": "macfarla"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjBOvLAH2gAyNDI3NjI5NDIwOjBhZTc0MjA1OTA4Y2RjNGUzYzI1ODY3NGIxYjljYzgzN2M0YjQyMzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoIwBogH2gAyNDI3NjI5NDIwOmNiMGYxN2MwYjhkYzM4Y2VhYzY4ZWNiZDFkNDdjYTMzNTFhY2RlZGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0ae74205908cdc4e3c258674b1b9cc837c4b4233", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/0ae74205908cdc4e3c258674b1b9cc837c4b4233", "committedDate": "2020-05-20T04:19:26Z", "message": "added test that fails\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af2150e4c020e9d4f09a78a016efc2bfc4fdfe54", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/af2150e4c020e9d4f09a78a016efc2bfc4fdfe54", "committedDate": "2020-05-20T04:21:56Z", "message": "Revert \"added test that fails\"\n\nThis reverts commit 4d6de6df528882db4374b4a87c4a2485ab148e6a.\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce6daf14bd07402ae9d70d91718d50c3c2e03d78", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/ce6daf14bd07402ae9d70d91718d50c3c2e03d78", "committedDate": "2020-05-21T20:37:58Z", "message": "Merge branch 'master' of https://github.com/hyperledger/besu"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2ed6426fc9abe6e66660a4394c62291856e357f", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/f2ed6426fc9abe6e66660a4394c62291856e357f", "committedDate": "2020-05-24T23:15:07Z", "message": "Merge branch 'master' of https://github.com/hyperledger/besu"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6135b8c2afadcd86a348ea1f95ade3800bcf1f21", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/6135b8c2afadcd86a348ea1f95ade3800bcf1f21", "committedDate": "2020-05-27T05:50:41Z", "message": "Merge branch 'master' of https://github.com/hyperledger/besu"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "659831b6b163c4892066c208749801e1066d3d04", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/659831b6b163c4892066c208749801e1066d3d04", "committedDate": "2020-05-31T22:31:23Z", "message": "Merge branch 'master' of https://github.com/hyperledger/besu"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "121563821c3716d6f1bb805f403a850f9934a513", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/121563821c3716d6f1bb805f403a850f9934a513", "committedDate": "2020-06-01T22:55:40Z", "message": "Merge branch 'master' of https://github.com/hyperledger/besu"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c8ddfe2542944ddb2c2d907be1cf471dde71e2c", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/8c8ddfe2542944ddb2c2d907be1cf471dde71e2c", "committedDate": "2020-06-03T00:05:48Z", "message": "Merge branch 'master' of https://github.com/hyperledger/besu"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1b73fd235167d432354bc9436bc38b4a91447d9", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/b1b73fd235167d432354bc9436bc38b4a91447d9", "committedDate": "2020-06-03T21:55:15Z", "message": "Merge branch 'master' of https://github.com/hyperledger/besu"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46e27fd71dccf6d40c0574aa376ef89e4fd1de62", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/46e27fd71dccf6d40c0574aa376ef89e4fd1de62", "committedDate": "2020-06-04T02:25:52Z", "message": "check blocks are being produced BEFORE sending any transactions\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96e3a60abf7df9752c33d935bd580316efd22c88", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/96e3a60abf7df9752c33d935bd580316efd22c88", "committedDate": "2020-06-04T05:01:59Z", "message": "reduce number of validators, remove unnecessary checks for number of peers (this is already done in cluster.start) and reduce number of blocks we wait for\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9239252891990e24c0e4a8b2585b6c48605db63c", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/9239252891990e24c0e4a8b2585b6c48605db63c", "committedDate": "2020-06-04T06:50:55Z", "message": "imports\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MTU4NjAx", "url": "https://github.com/hyperledger/besu/pull/1040#pullrequestreview-424158601", "createdAt": "2020-06-04T07:09:08Z", "commit": {"oid": "9239252891990e24c0e4a8b2585b6c48605db63c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MTY4Nzc1", "url": "https://github.com/hyperledger/besu/pull/1040#pullrequestreview-424168775", "createdAt": "2020-06-04T07:23:40Z", "commit": {"oid": "9239252891990e24c0e4a8b2585b6c48605db63c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwNzoyMzo0MFrOGe5Bgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwNzoyMzo0MFrOGe5Bgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA0NDczOA==", "bodyText": "Think we should check all nodes have progressed not just the bootnode. So something like permissionedCluster.verify(blockchain.reachesHeight(bootnode, 1, 120))", "url": "https://github.com/hyperledger/besu/pull/1040#discussion_r435044738", "createdAt": "2020-06-04T07:23:40Z", "author": {"login": "jframe"}, "path": "acceptance-tests/tests/src/test/java/org/hyperledger/besu/tests/acceptance/permissioning/NodeSmartContractPermissioningIbftStallAcceptanceTest.java", "diffHunk": "@@ -73,12 +67,10 @@ public void restartedIbftClusterShouldNotStall() throws IOException {\n     bootnode.setPermissioningConfiguration(permissioningConfiguration);\n     nodeA.setPermissioningConfiguration(permissioningConfiguration);\n     nodeB.setPermissioningConfiguration(permissioningConfiguration);\n-    nodeC.setPermissioningConfiguration(permissioningConfiguration);\n-    nodeD.setPermissioningConfiguration(permissioningConfiguration);\n \n-    permissionedCluster.start(bootnode, nodeA, nodeB, nodeC, nodeD);\n+    permissionedCluster.start(bootnode, nodeA, nodeB);\n \n     // Verify blockchain is progressing\n-    waitForBlockHeight(bootnode, 15);\n+    bootnode.verify(blockchain.reachesHeight(bootnode, 1, 120));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9239252891990e24c0e4a8b2585b6c48605db63c"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NTQxODM0", "url": "https://github.com/hyperledger/besu/pull/1040#pullrequestreview-424541834", "createdAt": "2020-06-04T15:01:16Z", "commit": {"oid": "9239252891990e24c0e4a8b2585b6c48605db63c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78d8c579baddacb3a51e97fb09d2290b0732df82", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/78d8c579baddacb3a51e97fb09d2290b0732df82", "committedDate": "2020-06-05T01:54:26Z", "message": "check status of cluster not a single node\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb0f17c0b8dc38ceac68ecbd1d47ca3351acdedf", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/cb0f17c0b8dc38ceac68ecbd1d47ca3351acdedf", "committedDate": "2020-06-05T01:54:45Z", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into perm-ibft-stall-test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1565, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}