{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2MzUyMzY2", "number": 1352, "title": "Added event listener to remove unsubscribe websocket if user removed \u2026", "bodyText": "\u2026from privacy group.\nSigned-off-by: Mark Terry mark.terry@consensys.net\n\n\nPR description\nUpdated the multi-tenancy websocket management to unsubscribe if a subscribed user is removed from the corresponding privacy group.\nFixed Issue(s)\n\n\nFixes #884\nChangelog\n\n I thought about the changelog and included a changelog update if required.", "createdAt": "2020-08-31T14:57:21Z", "url": "https://github.com/hyperledger/besu/pull/1352", "merged": true, "mergeCommit": {"oid": "8118330cf8be3b645d09ee777be0421ddb2d95f3"}, "closed": true, "closedAt": "2020-09-10T11:38:43Z", "author": {"login": "mark-terry"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEUDzJgH2gAyNDc2MzUyMzY2OmM1YTQ5ZDdkN2VmOWFmNWFiZWRlZjVmOTRjZWRhOGZhM2NlYTJiYTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHetsZAH2gAyNDc2MzUyMzY2OjQ2ODgwMDBjYjVlN2UwNjJmYjA0ZmFiMDllZGE2NmQzZTc0ZmI4MzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c5a49d7d7ef9af5abedef5f94ceda8fa3cea2ba8", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/c5a49d7d7ef9af5abedef5f94ceda8fa3cea2ba8", "committedDate": "2020-08-31T14:55:11Z", "message": "Added event listener to remove unsubscribe websocket if user removed from privacy group.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5MDIxMjM4", "url": "https://github.com/hyperledger/besu/pull/1352#pullrequestreview-479021238", "createdAt": "2020-08-31T22:50:02Z", "commit": {"oid": "c5a49d7d7ef9af5abedef5f94ceda8fa3cea2ba8"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMjo1MDowMlrOHKMS5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMjo1MzoxOFrOHKMbIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ0OTI1NQ==", "bodyText": "do we have to worry about this request failing?", "url": "https://github.com/hyperledger/besu/pull/1352#discussion_r480449255", "createdAt": "2020-08-31T22:50:02Z", "author": {"login": "macfarla"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/websocket/subscription/SubscriptionManager.java", "diffHunk": "@@ -158,4 +161,20 @@ public void sendMessage(final Long subscriptionId, final JsonRpcResult msg) {\n           }\n         });\n   }\n+\n+  @Override\n+  public void onPrivateTransactionProcessed(final PrivateTransactionEvent event) {\n+    // When a user is removed from a privacy group, remove all subscriptions from that user to that\n+    // group\n+    subscriptionsOfType(SubscriptionType.LOGS, PrivateLogsSubscription.class).stream()\n+        .filter(\n+            subscription ->\n+                subscription.getEnclavePublicKey().equals(event.getEnclavePublicKey())\n+                    && subscription.getPrivacyGroupId().equals(event.getPrivacyGroupId()))\n+        .forEach(\n+            subscription ->\n+                this.unsubscribe(\n+                    new UnsubscribeRequest(\n+                        subscription.getSubscriptionId(), subscription.getConnectionId())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5a49d7d7ef9af5abedef5f94ceda8fa3cea2ba8"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ1MDU4OQ==", "bodyText": "is there a test to check multiTenancyCheckFail?", "url": "https://github.com/hyperledger/besu/pull/1352#discussion_r480450589", "createdAt": "2020-08-31T22:52:04Z", "author": {"login": "macfarla"}, "path": "ethereum/api/src/test/java/org/hyperledger/besu/ethereum/api/jsonrpc/websocket/methods/PrivSubscribeTest.java", "diffHunk": "@@ -134,6 +137,31 @@ public void multiTenancyCheckFailure() {\n         .hasMessageContaining(\"msg\");\n   }\n \n+  @Test\n+  public void multiTenancyCheckSuccess() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5a49d7d7ef9af5abedef5f94ceda8fa3cea2ba8"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ1MTM2Mw==", "bodyText": "should this enclavePublicKey be the variable not the string", "url": "https://github.com/hyperledger/besu/pull/1352#discussion_r480451363", "createdAt": "2020-08-31T22:53:18Z", "author": {"login": "macfarla"}, "path": "ethereum/api/src/test/java/org/hyperledger/besu/ethereum/api/jsonrpc/websocket/subscription/request/SubscriptionRequestMapperTest.java", "diffHunk": "@@ -409,7 +413,8 @@ public void mapRequestToPrivateSubscriptionWithInvalidType() {\n     thrown.expect(InvalidSubscriptionRequestException.class);\n     thrown.expectMessage(\"Invalid subscribe request. Invalid private subscription type.\");\n \n-    mapper.mapPrivateSubscribeRequest(new JsonRpcRequestContext(jsonRpcRequest));\n+    mapper.mapPrivateSubscribeRequest(\n+        new JsonRpcRequestContext(jsonRpcRequest), \"enclave_public_key\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5a49d7d7ef9af5abedef5f94ceda8fa3cea2ba8"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5MDk5NDU5", "url": "https://github.com/hyperledger/besu/pull/1352#pullrequestreview-479099459", "createdAt": "2020-08-31T23:58:41Z", "commit": {"oid": "c5a49d7d7ef9af5abedef5f94ceda8fa3cea2ba8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzo1ODo0MlrOHKOM-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMzo1ODo0MlrOHKOM-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQ4MDUwNg==", "bodyText": "Do you need to handle the same race condition as filters (eg user removed from group but then in the same block requests to create a new subscription) - which we solved by storing the private tx events until the block was processed.", "url": "https://github.com/hyperledger/besu/pull/1352#discussion_r480480506", "createdAt": "2020-08-31T23:58:42Z", "author": {"login": "macfarla"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/websocket/subscription/SubscriptionManager.java", "diffHunk": "@@ -158,4 +161,20 @@ public void sendMessage(final Long subscriptionId, final JsonRpcResult msg) {\n           }\n         });\n   }\n+\n+  @Override\n+  public void onPrivateTransactionProcessed(final PrivateTransactionEvent event) {\n+    // When a user is removed from a privacy group, remove all subscriptions from that user to that\n+    // group\n+    subscriptionsOfType(SubscriptionType.LOGS, PrivateLogsSubscription.class).stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5a49d7d7ef9af5abedef5f94ceda8fa3cea2ba8"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e5217392906e3e6615a02da7ceda8659b5438eb", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/2e5217392906e3e6615a02da7ceda8659b5438eb", "committedDate": "2020-09-02T14:27:56Z", "message": "PR fixes.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17d7989b63fcfde254deab694339ecf32e2e684f", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/17d7989b63fcfde254deab694339ecf32e2e684f", "committedDate": "2020-09-02T14:29:01Z", "message": "Merge branch 'master' into 884"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMjgzNTE5", "url": "https://github.com/hyperledger/besu/pull/1352#pullrequestreview-482283519", "createdAt": "2020-09-04T00:27:13Z", "commit": {"oid": "17d7989b63fcfde254deab694339ecf32e2e684f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4688000cb5e7e062fb04fab09eda66d3e74fb832", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/4688000cb5e7e062fb04fab09eda66d3e74fb832", "committedDate": "2020-09-10T11:01:46Z", "message": "Merge branch 'master' into 884"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1477, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}