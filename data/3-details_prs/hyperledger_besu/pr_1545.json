{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4MTc2MTEx", "number": 1545, "title": "Add Quorum Permissioning gate to Account and Node permissioning", "bodyText": "PR description\n\nIf qip714block option isn\u2019t set, yield to controller's providers.\nIf the option is set, monitor the chain for that height:\n\nBefore reaching the block height, allow everything\nUpon reaching that block height, yield to controller's providers.\n\n\nqip714block is inclusive, so if I set qip714block=123, permissioning will be enforced from block 123 onwards (including block 123).\n\nChangelog\n\n I thought about the changelog and included a changelog update if required.", "createdAt": "2020-11-10T03:13:27Z", "url": "https://github.com/hyperledger/besu/pull/1545", "merged": true, "mergeCommit": {"oid": "6e0a8748c9ecf103b2dff69fbdff8541cb90fca9"}, "closed": true, "closedAt": "2020-11-12T03:57:13Z", "author": {"login": "lucassaldanha"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbBLAXgFqTUyNjgyOTAzOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbqZMHgFqTUyODczMzIxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2ODI5MDM4", "url": "https://github.com/hyperledger/besu/pull/1545#pullrequestreview-526829038", "createdAt": "2020-11-10T03:37:53Z", "commit": {"oid": "d4ea3d0bd564251f6db2574b0a1479b88caa3d02"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwMzozNzo1M1rOHwKgAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwMzo0ODoyOFrOHwKq8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI2NTczMA==", "bodyText": "Why was this changed?", "url": "https://github.com/hyperledger/besu/pull/1545#discussion_r520265730", "createdAt": "2020-11-10T03:37:53Z", "author": {"login": "mark-terry"}, "path": "config/src/main/java/org/hyperledger/besu/config/JsonGenesisConfigOptions.java", "diffHunk": "@@ -302,7 +302,7 @@ public OptionalLong getEcip1017EraRounds() {\n \n   @Override\n   public boolean isQuorum() {\n-    return getOptionalBoolean(\"isQuorum\").orElse(false);\n+    return getOptionalBoolean(\"isquorum\").orElse(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4ea3d0bd564251f6db2574b0a1479b88caa3d02"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI2ODUzMA==", "bodyText": "Dupe in name", "url": "https://github.com/hyperledger/besu/pull/1545#discussion_r520268530", "createdAt": "2020-11-10T03:48:28Z", "author": {"login": "mark-terry"}, "path": "ethereum/permissioning/src/test/java/org/hyperledger/besu/ethereum/permissioning/node/NodePermissioningControllerTest.java", "diffHunk": "@@ -174,4 +183,45 @@ public void doesntStopAtInsufficientPeersWhenNoAnswer() {\n     verify(insufficientPeersPermissioningProvider, times(1)).isPermitted(any(), any());\n     providers.forEach(p -> verify(p, times(1)).isPermitted(any(), any()));\n   }\n+\n+  @Test\n+  public void whenQuorumQip714GateIsEmptyShouldDelegateToProviders() {\n+    this.controller =\n+        new NodePermissioningController(\n+            syncStatusNodePermissioningProviderOptional, Collections.emptyList(), Optional.empty());\n+\n+    controller.isPermitted(enode1, enode2);\n+\n+    verify(syncStatusNodePermissioningProvider, atLeast(1)).isPermitted(eq(enode1), eq(enode2));\n+  }\n+\n+  @Test\n+  public void whenQuorumQip714GateIsNotActiveShouldAlwaysReturnTrue() {\n+    this.controller =\n+        new NodePermissioningController(\n+            syncStatusNodePermissioningProviderOptional,\n+            Collections.emptyList(),\n+            Optional.of(quorumQip714Gate));\n+\n+    when(quorumQip714Gate.shouldCheckPermissions()).thenReturn(false);\n+\n+    assertThat(controller.isPermitted(enode1, enode2)).isTrue();\n+\n+    verifyNoInteractions(syncStatusNodePermissioningProvider);\n+  }\n+\n+  @Test\n+  public void whenQuorumQip714GateIsActiveActiveShouldDelegateToProviders() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4ea3d0bd564251f6db2574b0a1479b88caa3d02"}, "originalPosition": 116}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2ODQ2MzAw", "url": "https://github.com/hyperledger/besu/pull/1545#pullrequestreview-526846300", "createdAt": "2020-11-10T04:35:21Z", "commit": {"oid": "d4ea3d0bd564251f6db2574b0a1479b88caa3d02"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwNDozNToyMVrOHwLaVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwNDo1MTo0MFrOHwLqsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI4MDY2Mw==", "bodyText": "why true for disabled?", "url": "https://github.com/hyperledger/besu/pull/1545#discussion_r520280663", "createdAt": "2020-11-10T04:35:21Z", "author": {"login": "macfarla"}, "path": "ethereum/permissioning/src/main/java/org/hyperledger/besu/ethereum/permissioning/QuorumPermissioningConfiguration.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.ethereum.permissioning;\n+\n+public class QuorumPermissioningConfiguration {\n+\n+  public static final long QIP714_DEFAULT_BLOCK = 0;\n+\n+  private final long qip714Block;\n+  private final boolean enabled;\n+\n+  public QuorumPermissioningConfiguration(final long qip714Block, final boolean enabled) {\n+    this.qip714Block = qip714Block;\n+    this.enabled = enabled;\n+  }\n+\n+  public static QuorumPermissioningConfiguration enabled(final long qip714Block) {\n+    return new QuorumPermissioningConfiguration(qip714Block, true);\n+  }\n+\n+  public static QuorumPermissioningConfiguration disabled() {\n+    return new QuorumPermissioningConfiguration(QIP714_DEFAULT_BLOCK, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4ea3d0bd564251f6db2574b0a1479b88caa3d02"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI4MjMzNw==", "bodyText": "whenQuorumQip714GateIsNotActiveShouldNotCheckOtherPermissions ? BypassOtherPermissions?", "url": "https://github.com/hyperledger/besu/pull/1545#discussion_r520282337", "createdAt": "2020-11-10T04:42:01Z", "author": {"login": "macfarla"}, "path": "ethereum/permissioning/src/test/java/org/hyperledger/besu/ethereum/permissioning/account/AccountPermissioningControllerTest.java", "diffHunk": "@@ -85,4 +89,49 @@ public void shouldReturnFalseIfOneControllerPermitsAndTheOtherDoesNot() {\n     verify(localConfigController).isPermitted(any());\n     verify(smartContractController).isPermitted(any());\n   }\n+\n+  @Test\n+  public void whenQuorumQip714GateIsEmptyShouldDelegateToProviders() {\n+    this.permissioningController =\n+        new AccountPermissioningController(\n+            Optional.of(localConfigController),\n+            Optional.of(smartContractController),\n+            Optional.empty());\n+\n+    permissioningController.isPermitted(mock(Transaction.class), true, false);\n+\n+    verify(localConfigController).isPermitted(any());\n+  }\n+\n+  @Test\n+  public void whenQuorumQip714GateIsNotActiveShouldAlwaysReturnTrue() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4ea3d0bd564251f6db2574b0a1479b88caa3d02"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI4Mjk1NA==", "bodyText": "I don't love cfg as a name - config?", "url": "https://github.com/hyperledger/besu/pull/1545#discussion_r520282954", "createdAt": "2020-11-10T04:44:33Z", "author": {"login": "macfarla"}, "path": "ethereum/permissioning/src/main/java/org/hyperledger/besu/ethereum/permissioning/account/AccountPermissioningControllerFactory.java", "diffHunk": "@@ -56,10 +59,25 @@\n \n     if (accountLocalConfigPermissioningController.isPresent()\n         || transactionSmartContractPermissioningController.isPresent()) {\n+\n+      final Optional<QuorumQip714Gate> quorumQip714Gate =\n+          permissioningConfiguration\n+              .getQuorumPermissioningConfig()\n+              .flatMap(\n+                  cfg -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4ea3d0bd564251f6db2574b0a1479b88caa3d02"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI4NDU2Mg==", "bodyText": "nit: config vs configuration", "url": "https://github.com/hyperledger/besu/pull/1545#discussion_r520284562", "createdAt": "2020-11-10T04:50:29Z", "author": {"login": "macfarla"}, "path": "ethereum/permissioning/src/main/java/org/hyperledger/besu/ethereum/permissioning/PermissioningConfiguration.java", "diffHunk": "@@ -17,14 +17,18 @@\n import java.util.Optional;\n \n public class PermissioningConfiguration {\n+\n   private final Optional<LocalPermissioningConfiguration> localConfig;\n   private final Optional<SmartContractPermissioningConfiguration> smartContractConfig;\n+  private final Optional<QuorumPermissioningConfiguration> quorumPermissioningConfiguration;\n \n   public PermissioningConfiguration(\n       final Optional<LocalPermissioningConfiguration> localConfig,\n-      final Optional<SmartContractPermissioningConfiguration> smartContractConfig) {\n+      final Optional<SmartContractPermissioningConfiguration> smartContractConfig,\n+      final Optional<QuorumPermissioningConfiguration> quorumPermissioningConfiguration) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4ea3d0bd564251f6db2574b0a1479b88caa3d02"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI4NDg0OA==", "bodyText": "nit: would be good to standardise spelling of qip714block in logs", "url": "https://github.com/hyperledger/besu/pull/1545#discussion_r520284848", "createdAt": "2020-11-10T04:51:40Z", "author": {"login": "macfarla"}, "path": "ethereum/permissioning/src/main/java/org/hyperledger/besu/ethereum/permissioning/account/AccountPermissioningController.java", "diffHunk": "@@ -34,21 +35,32 @@\n       accountLocalConfigPermissioningController;\n   private final Optional<TransactionSmartContractPermissioningController>\n       transactionSmartContractPermissioningController;\n+  private final Optional<QuorumQip714Gate> quorumQip714Gate;\n \n   public AccountPermissioningController(\n       final Optional<AccountLocalConfigPermissioningController>\n           accountLocalConfigPermissioningController,\n       final Optional<TransactionSmartContractPermissioningController>\n-          transactionSmartContractPermissioningController) {\n+          transactionSmartContractPermissioningController,\n+      final Optional<QuorumQip714Gate> quorumQip714Gate) {\n     this.accountLocalConfigPermissioningController = accountLocalConfigPermissioningController;\n     this.transactionSmartContractPermissioningController =\n         transactionSmartContractPermissioningController;\n+    this.quorumQip714Gate = quorumQip714Gate;\n   }\n \n   public boolean isPermitted(\n       final Transaction transaction,\n       final boolean includeLocalCheck,\n       final boolean includeOnChainCheck) {\n+    final boolean checkPermissions =\n+        quorumQip714Gate.map(QuorumQip714Gate::shouldCheckPermissions).orElse(true);\n+    if (!checkPermissions) {\n+      LOG.trace(\"Skipping account permissioning check due to qip714block config\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4ea3d0bd564251f6db2574b0a1479b88caa3d02"}, "originalPosition": 34}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d4ea3d0bd564251f6db2574b0a1479b88caa3d02", "author": {"user": {"login": "lucassaldanha", "name": "Lucas Saldanha"}}, "url": "https://github.com/hyperledger/besu/commit/d4ea3d0bd564251f6db2574b0a1479b88caa3d02", "committedDate": "2020-11-10T03:29:08Z", "message": "Fix finals\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>"}, "afterCommit": {"oid": "29a14db383747a7c6792ccbc2a6ccf67b80f1ae1", "author": {"user": {"login": "lucassaldanha", "name": "Lucas Saldanha"}}, "url": "https://github.com/hyperledger/besu/commit/29a14db383747a7c6792ccbc2a6ccf67b80f1ae1", "committedDate": "2020-11-11T01:09:06Z", "message": "Fix another unit test\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "687a94ac07dca9a42003ac16792e0c356b153535", "author": {"user": {"login": "lucassaldanha", "name": "Lucas Saldanha"}}, "url": "https://github.com/hyperledger/besu/commit/687a94ac07dca9a42003ac16792e0c356b153535", "committedDate": "2020-11-12T03:18:17Z", "message": "Create Quorum QIP-714 gate\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcac4d38c99854e41c5fa18d6b7c22ebe607835b", "author": {"user": {"login": "lucassaldanha", "name": "Lucas Saldanha"}}, "url": "https://github.com/hyperledger/besu/commit/dcac4d38c99854e41c5fa18d6b7c22ebe607835b", "committedDate": "2020-11-12T03:18:17Z", "message": "Adding qip714 gate to node permissioning controller\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1177d9b808213194e4b8e54940ac8af92de76900", "author": {"user": {"login": "lucassaldanha", "name": "Lucas Saldanha"}}, "url": "https://github.com/hyperledger/besu/commit/1177d9b808213194e4b8e54940ac8af92de76900", "committedDate": "2020-11-12T03:18:17Z", "message": "Adding qip714 gate to account permissioning controller\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12987fb20e57836089e8ef7bc03144a4eb78eb54", "author": {"user": {"login": "lucassaldanha", "name": "Lucas Saldanha"}}, "url": "https://github.com/hyperledger/besu/commit/12987fb20e57836089e8ef7bc03144a4eb78eb54", "committedDate": "2020-11-12T03:18:17Z", "message": "Wiring quorum permissioning gate\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7eb6c9ab88d600e9392e3af784c9e474e5eb7d76", "author": {"user": {"login": "lucassaldanha", "name": "Lucas Saldanha"}}, "url": "https://github.com/hyperledger/besu/commit/7eb6c9ab88d600e9392e3af784c9e474e5eb7d76", "committedDate": "2020-11-12T03:18:17Z", "message": "Fix constructor\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1836be42ffd2405fc5c13157597b36be42188430", "author": {"user": {"login": "lucassaldanha", "name": "Lucas Saldanha"}}, "url": "https://github.com/hyperledger/besu/commit/1836be42ffd2405fc5c13157597b36be42188430", "committedDate": "2020-11-12T03:18:17Z", "message": "Fix finals\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cecfce9ff016f20f420968effb62b80335e38574", "author": {"user": {"login": "lucassaldanha", "name": "Lucas Saldanha"}}, "url": "https://github.com/hyperledger/besu/commit/cecfce9ff016f20f420968effb62b80335e38574", "committedDate": "2020-11-12T03:18:17Z", "message": "Fix another unit test\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fa850facad0d6dff47e8dc7540281335afaa2d7", "author": {"user": {"login": "lucassaldanha", "name": "Lucas Saldanha"}}, "url": "https://github.com/hyperledger/besu/commit/4fa850facad0d6dff47e8dc7540281335afaa2d7", "committedDate": "2020-11-12T03:18:17Z", "message": "PR comments\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff4513c1258021e2127eade70df95fa4787a34d7", "author": {"user": {"login": "lucassaldanha", "name": "Lucas Saldanha"}}, "url": "https://github.com/hyperledger/besu/commit/ff4513c1258021e2127eade70df95fa4787a34d7", "committedDate": "2020-11-12T03:18:17Z", "message": "Fixing tests (once more)\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d49588546c19ec1efa4ff4bd92392bb1941dc8f6", "author": {"user": {"login": "lucassaldanha", "name": "Lucas Saldanha"}}, "url": "https://github.com/hyperledger/besu/commit/d49588546c19ec1efa4ff4bd92392bb1941dc8f6", "committedDate": "2020-11-12T03:18:18Z", "message": "Handling error\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "66c4cb8cdf9fe438c1495ac02c760417f7984ae8", "author": {"user": {"login": "lucassaldanha", "name": "Lucas Saldanha"}}, "url": "https://github.com/hyperledger/besu/commit/66c4cb8cdf9fe438c1495ac02c760417f7984ae8", "committedDate": "2020-11-11T20:53:02Z", "message": "Fixing tests (once more)\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>"}, "afterCommit": {"oid": "d49588546c19ec1efa4ff4bd92392bb1941dc8f6", "author": {"user": {"login": "lucassaldanha", "name": "Lucas Saldanha"}}, "url": "https://github.com/hyperledger/besu/commit/d49588546c19ec1efa4ff4bd92392bb1941dc8f6", "committedDate": "2020-11-12T03:18:18Z", "message": "Handling error\n\nSigned-off-by: Lucas Saldanha <lucascrsaldanha@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NzMzMjE2", "url": "https://github.com/hyperledger/besu/pull/1545#pullrequestreview-528733216", "createdAt": "2020-11-12T03:56:43Z", "commit": {"oid": "d49588546c19ec1efa4ff4bd92392bb1941dc8f6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2071, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}