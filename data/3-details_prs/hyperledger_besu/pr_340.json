{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4NDExMDk2", "number": 340, "title": "[BESU-185] - CLI Option to enable TLS client auth for JSON-RPC HTTP", "bodyText": "PR description\nThe JSON-RPC HTTP endpoint TLS related CLI option currently exposes following to automatically enable client authentication while providing facility to read client certificates fingerprints to trust them. It also automatically allows a public CA signed client certificate.\n--rpc-http-tls-known-clients-file\nThis PR allows user to enable/disable TLS client auth and if enabled allows to provide a known-clients file as well as enabling CA signed clients. If client-auth is enabled, then user must either enable CA signed client OR provide a known-clients file. We raise an error if both CA signed clients are disabled as well as known-clients file is not specified.\nFollowing options are added\n--rpc-http-tls-client-auth-enabled  - Enable TLS client authentication for the JSON-RPC HTTP service (default: false)\n--rpc-http-tls-known-clients-file - Path to file containing client's certificate common name and fingerprint for client authentication.\n--rpc-http-tls-ca-clients-enabled - Enable to accept clients certificate signed by a valid CA for client authentication (default: false)\nSigned-off-by: Usman Saleem usman@usmans.info", "createdAt": "2020-01-29T07:23:06Z", "url": "https://github.com/hyperledger/besu/pull/340", "merged": true, "mergeCommit": {"oid": "eca91a90f3f51024b24b8391fe550eac1b17ee52"}, "closed": true, "closedAt": "2020-01-30T06:48:23Z", "author": {"login": "usmansaleem"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_AtT7gH2gAyMzY4NDExMDk2OjgyZjhjNWEzZDBkMjNlYjJlZWY1MGM0ZjA2OWQzNTI2OGU2ZjkxZGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_UYiwAFqTM1MDYwMDU4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "82f8c5a3d0d23eb2eef50c4f069d35268e6f91dc", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/hyperledger/besu/commit/82f8c5a3d0d23eb2eef50c4f069d35268e6f91dc", "committedDate": "2020-01-29T07:21:39Z", "message": "[BESU-185] - CLI Option to enable TLS client auth for JSON-RPC HTTP\n\nFollowing options are added\n\n--rpc-http-tls-client-auth-enabled  - Enable TLS client authentication for the JSON-RPC HTTP service (default: false)\n--rpc-http-tls-known-clients-file - Path to file containing client's certificate common name and fingerprint for client authentication.\n--rpc-http-tls-ca-clients-enabled - Enable to accept clients certificate signed by a valid CA for client authentication (default: false)\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e921b37f09f42aa896dec51d985e6152cb91b603", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/hyperledger/besu/commit/e921b37f09f42aa896dec51d985e6152cb91b603", "committedDate": "2020-01-29T08:31:27Z", "message": "errorprone fixes\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48ce63db29e4c4e767ec92694fb763da459ec74c", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/hyperledger/besu/commit/48ce63db29e4c4e767ec92694fb763da459ec74c", "committedDate": "2020-01-29T09:13:29Z", "message": "besu command unit tests for tls options\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "988e2a70a3455ba80ff2efd2f53acd6f8f82a246", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/hyperledger/besu/commit/988e2a70a3455ba80ff2efd2f53acd6f8f82a246", "committedDate": "2020-01-29T10:39:40Z", "message": "errorprone reported fix\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "388b1c13e7375fa65cc3959da07adb4b617ce50d", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/hyperledger/besu/commit/388b1c13e7375fa65cc3959da07adb4b617ce50d", "committedDate": "2020-01-29T11:50:41Z", "message": "adding license header\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32b454268f11052acc2721d32b59f5afa3fddd2f", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/hyperledger/besu/commit/32b454268f11052acc2721d32b59f5afa3fddd2f", "committedDate": "2020-01-29T21:07:54Z", "message": "Merge remote-tracking branch 'upstream/master' into rpc_tls_client_auth\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1863a5f3969a953cbc872dff989f29789645cb3f", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/hyperledger/besu/commit/1863a5f3969a953cbc872dff989f29789645cb3f", "committedDate": "2020-01-29T21:36:37Z", "message": "minor refactoring in unit tests\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d44adee69e7d455f33135f3f7f5b69d9988e1e2", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/hyperledger/besu/commit/6d44adee69e7d455f33135f3f7f5b69d9988e1e2", "committedDate": "2020-01-29T23:56:33Z", "message": "Extracting out tls client auth unit tests in a seperate class\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6322e9f9165d7490160a2665d0d3cbc11cba829b", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/hyperledger/besu/commit/6322e9f9165d7490160a2665d0d3cbc11cba829b", "committedDate": "2020-01-30T00:28:22Z", "message": "Adding unit test to assert ca signed clients\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNTgxOTI1", "url": "https://github.com/hyperledger/besu/pull/340#pullrequestreview-350581925", "createdAt": "2020-01-30T04:58:20Z", "commit": {"oid": "6322e9f9165d7490160a2665d0d3cbc11cba829b"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwNDo1ODoyMVrOFjfdAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwNDo1ODozNlrOFjfdNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjc1OTgxMA==", "bodyText": "Any reason we need to copy the input params?  It seems odd.  I feel there should be a comment explaining why (it may be a library thing, and it would be worth pointing out) or consider just mutating the options in place.", "url": "https://github.com/hyperledger/besu/pull/340#discussion_r372759810", "createdAt": "2020-01-30T04:58:21Z", "author": {"login": "shemnon"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/JsonRpcHttpService.java", "diffHunk": "@@ -279,34 +281,47 @@ private HttpServerOptions getHttpServerOptions() {\n     return applyTlsConfig(httpServerOptions);\n   }\n \n-  private HttpServerOptions applyTlsConfig(final HttpServerOptions httpServerOptions) {\n-    config\n-        .getTlsConfiguration()\n+  private HttpServerOptions applyTlsConfig(final HttpServerOptions input) {\n+    if (config.getTlsConfiguration().isEmpty()) {\n+      return input;\n+    }\n+\n+    final TlsConfiguration tlsConfiguration = config.getTlsConfiguration().get();\n+    final HttpServerOptions httpServerOptions = new HttpServerOptions(input);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6322e9f9165d7490160a2665d0d3cbc11cba829b"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjc1OTg2Mw==", "bodyText": "Same copy question above.", "url": "https://github.com/hyperledger/besu/pull/340#discussion_r372759863", "createdAt": "2020-01-30T04:58:36Z", "author": {"login": "shemnon"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/JsonRpcHttpService.java", "diffHunk": "@@ -279,34 +281,47 @@ private HttpServerOptions getHttpServerOptions() {\n     return applyTlsConfig(httpServerOptions);\n   }\n \n-  private HttpServerOptions applyTlsConfig(final HttpServerOptions httpServerOptions) {\n-    config\n-        .getTlsConfiguration()\n+  private HttpServerOptions applyTlsConfig(final HttpServerOptions input) {\n+    if (config.getTlsConfiguration().isEmpty()) {\n+      return input;\n+    }\n+\n+    final TlsConfiguration tlsConfiguration = config.getTlsConfiguration().get();\n+    final HttpServerOptions httpServerOptions = new HttpServerOptions(input);\n+    try {\n+      httpServerOptions\n+          .setSsl(true)\n+          .setPfxKeyCertOptions(\n+              new PfxOptions()\n+                  .setPath(tlsConfiguration.getKeyStorePath().toString())\n+                  .setPassword(tlsConfiguration.getKeyStorePassword()));\n+\n+      if (tlsConfiguration.getClientAuthConfiguration().isEmpty()) {\n+        return httpServerOptions;\n+      }\n+\n+      return applyTlsClientAuth(\n+          tlsConfiguration.getClientAuthConfiguration().get(), httpServerOptions);\n+    } catch (final RuntimeException re) {\n+      throw new JsonRpcServiceException(\n+          String.format(\n+              \"TLS options failed to initialize for Ethereum JSON RPC listener: %s\",\n+              re.getMessage()));\n+    }\n+  }\n+\n+  private HttpServerOptions applyTlsClientAuth(\n+      final TlsClientAuthConfiguration clientAuthConfiguration, final HttpServerOptions input) {\n+    final HttpServerOptions httpServerOptions = new HttpServerOptions(input);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6322e9f9165d7490160a2665d0d3cbc11cba829b"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e5833232fb78e56a491e30b5c28cfe17f023bbb", "author": {"user": {"login": "usmansaleem", "name": "Usman Saleem"}}, "url": "https://github.com/hyperledger/besu/commit/5e5833232fb78e56a491e30b5c28cfe17f023bbb", "committedDate": "2020-01-30T05:20:05Z", "message": "review suggestions\n\nSigned-off-by: Usman Saleem <usman@usmans.info>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNjAwNTg1", "url": "https://github.com/hyperledger/besu/pull/340#pullrequestreview-350600585", "createdAt": "2020-01-30T06:17:04Z", "commit": {"oid": "5e5833232fb78e56a491e30b5c28cfe17f023bbb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1910, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}