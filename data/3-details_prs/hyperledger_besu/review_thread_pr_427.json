{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4OTI0OTk3", "number": 427, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNjo0NjowOVrODiZfQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMjo0MzoxM1rODjRSKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3Mzk1Nzc2OnYy", "diffSide": "RIGHT", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/PivotBlockRetriever.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNjo0NjowOVrOFtnzrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNjo0NjowOVrOFtnzrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzM4MjQ0Ng==", "bodyText": "This is the wrong log message now, it should complain about the selected pivot block being negative or at genesis.  Retries won't trigger this.", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r383382446", "createdAt": "2020-02-24T16:46:09Z", "author": {"login": "shemnon"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/PivotBlockRetriever.java", "diffHunk": "@@ -147,9 +126,10 @@ private void handleContestedPivotBlock(final long contestedBlockNumber) {\n         contestedBlockNumber, contestedBlockNumber - pivotBlockNumberResetDelta)) {\n       LOG.info(\"Received conflicting pivot blocks for {}.\", contestedBlockNumber);\n \n-      final int retryCount = confirmationTasks.size();\n-      if (retryCount > maxPivotBlockResets\n-          || pivotBlockNumber.get() <= BlockHeader.GENESIS_BLOCK_NUMBER) {\n+      if (confirmationTasks.size() > SUSPICIOUS_NUMBER_OF_PIVOT_BLOCK_RESETS) {\n+        LOG.warn(\"Several attempts have been made without finding a pivot block\");\n+      }\n+      if (pivotBlockNumber.get() <= BlockHeader.GENESIS_BLOCK_NUMBER) {\n         LOG.info(\"Max retries reached, cancel pivot block download.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a964f93d03ba14270db056449a8710712400b91"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3NDM4NzgxOnYy", "diffSide": "RIGHT", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/PivotBlockRetriever.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxODo1NToxNlrOFtr8zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxODo1NToxNlrOFtr8zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzQ1MDMxOA==", "bodyText": "I'd print a warning periodically (every SUSPICIOUS_NUMBER_OF_PIVOT_BLOCK_RESETS retries?) rather than on every individual retry.  Also, confirmationTasks can now grow very large, so we'll probably need to rework how we track tasks so we don't hold onto every confirmation task we created.\nAlternatively, I wonder if we could alleviate the problem of prematurely switching to full sync by just increasing DEFAULT_MAX_PIVOT_BLOCK_RESETS and making sure we retry fast sync here: \n  \n    \n      besu/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/DefaultSynchronizer.java\n    \n    \n         Line 166\n      in\n      7fe1d47\n    \n    \n    \n    \n\n        \n          \n           LOG.error(\"Fast sync failed, switching to full sync.\", error); \n        \n    \n  \n\n ...", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r383450318", "createdAt": "2020-02-24T18:55:16Z", "author": {"login": "mbaxter"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/PivotBlockRetriever.java", "diffHunk": "@@ -147,9 +126,10 @@ private void handleContestedPivotBlock(final long contestedBlockNumber) {\n         contestedBlockNumber, contestedBlockNumber - pivotBlockNumberResetDelta)) {\n       LOG.info(\"Received conflicting pivot blocks for {}.\", contestedBlockNumber);\n \n-      final int retryCount = confirmationTasks.size();\n-      if (retryCount > maxPivotBlockResets\n-          || pivotBlockNumber.get() <= BlockHeader.GENESIS_BLOCK_NUMBER) {\n+      if (confirmationTasks.size() > SUSPICIOUS_NUMBER_OF_PIVOT_BLOCK_RESETS) {\n+        LOG.warn(\"Several attempts have been made without finding a pivot block\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a964f93d03ba14270db056449a8710712400b91"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MTI2NjM3OnYy", "diffSide": "RIGHT", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/FastSyncDownloader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNDoyNDoxMlrOFutcMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNTowNDoxMFrOFuvFdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUyMzMxMw==", "bodyText": "The catch-all log needs to be updated.  Probably worth keeping the more specific log message for the StalledDownload:\nelse if (ExceptionUtils.rootCause(error) instanceof StalledDownloadException) {\n      LOG.warn(\n          \"Fast sync was unable to download the world state. Retrying with a new pivot block.\");\n      return start(FastSyncState.EMPTY_SYNC_STATE);\n} else {\n      LOG.error(\n          \"Encountered an unexpected error during fast sync.  Restarting fast sync.\", error);\n      return start(FastSyncState.EMPTY_SYNC_STATE);\n}", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r384523313", "createdAt": "2020-02-26T14:24:12Z", "author": {"login": "mbaxter"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/FastSyncDownloader.java", "diffHunk": "@@ -80,17 +79,17 @@ public FastSyncDownloader(\n             .thenApply(this::updateMaxTrailingPeers)\n             .thenApply(this::storeState)\n             .thenCompose(this::downloadChainAndWorldState),\n-        this::handleWorldStateUnavailable);\n+        this::handleFailure);\n   }\n \n-  private CompletableFuture<FastSyncState> handleWorldStateUnavailable(final Throwable error) {\n+  private CompletableFuture<FastSyncState> handleFailure(final Throwable error) {\n     trailingPeerRequirements = Optional.empty();\n-    if (ExceptionUtils.rootCause(error) instanceof StalledDownloadException) {\n+    if (ExceptionUtils.rootCause(error) instanceof FastSyncException) {\n+      return completedExceptionally(error);\n+    } else {\n       LOG.warn(\n           \"Fast sync was unable to download the world state. Retrying with a new pivot block.\");\n       return start(FastSyncState.EMPTY_SYNC_STATE);\n-    } else {\n-      return completedExceptionally(error);\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66e56b30f17145685632c9ef2beefd57c4219837"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU1MDI2Mw==", "bodyText": "Done", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r384550263", "createdAt": "2020-02-26T15:04:10Z", "author": {"login": "matkt"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/FastSyncDownloader.java", "diffHunk": "@@ -80,17 +79,17 @@ public FastSyncDownloader(\n             .thenApply(this::updateMaxTrailingPeers)\n             .thenApply(this::storeState)\n             .thenCompose(this::downloadChainAndWorldState),\n-        this::handleWorldStateUnavailable);\n+        this::handleFailure);\n   }\n \n-  private CompletableFuture<FastSyncState> handleWorldStateUnavailable(final Throwable error) {\n+  private CompletableFuture<FastSyncState> handleFailure(final Throwable error) {\n     trailingPeerRequirements = Optional.empty();\n-    if (ExceptionUtils.rootCause(error) instanceof StalledDownloadException) {\n+    if (ExceptionUtils.rootCause(error) instanceof FastSyncException) {\n+      return completedExceptionally(error);\n+    } else {\n       LOG.warn(\n           \"Fast sync was unable to download the world state. Retrying with a new pivot block.\");\n       return start(FastSyncState.EMPTY_SYNC_STATE);\n-    } else {\n-      return completedExceptionally(error);\n     }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUyMzMxMw=="}, "originalCommit": {"oid": "66e56b30f17145685632c9ef2beefd57c4219837"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MTI4NDAwOnYy", "diffSide": "RIGHT", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/PivotBlockRetriever.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNDoyODo1MVrOFutnug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNTowNzoyNlrOFuvN2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUyNjI2Ng==", "bodyText": "(optional) Might be worth adding some more specific details:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    LOG.warn(\"Several attempts have been made without finding a pivot block\");\n          \n          \n            \n                    LOG.warn(\"{} attempts have failed to find a fast sync pivot block\", retryCount);", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r384526266", "createdAt": "2020-02-26T14:28:51Z", "author": {"login": "mbaxter"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/PivotBlockRetriever.java", "diffHunk": "@@ -148,6 +149,11 @@ private void handleContestedPivotBlock(final long contestedBlockNumber) {\n       LOG.info(\"Received conflicting pivot blocks for {}.\", contestedBlockNumber);\n \n       final int retryCount = confirmationTasks.size();\n+\n+      if ((retryCount % SUSPICIOUS_NUMBER_OF_RETRIES) == 0) {\n+        LOG.warn(\"Several attempts have been made without finding a pivot block\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66e56b30f17145685632c9ef2beefd57c4219837"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU1MjQxMQ==", "bodyText": "Done", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r384552411", "createdAt": "2020-02-26T15:07:26Z", "author": {"login": "matkt"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/PivotBlockRetriever.java", "diffHunk": "@@ -148,6 +149,11 @@ private void handleContestedPivotBlock(final long contestedBlockNumber) {\n       LOG.info(\"Received conflicting pivot blocks for {}.\", contestedBlockNumber);\n \n       final int retryCount = confirmationTasks.size();\n+\n+      if ((retryCount % SUSPICIOUS_NUMBER_OF_RETRIES) == 0) {\n+        LOG.warn(\"Several attempts have been made without finding a pivot block\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUyNjI2Ng=="}, "originalCommit": {"oid": "66e56b30f17145685632c9ef2beefd57c4219837"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MjQ1MzU0OnYy", "diffSide": "RIGHT", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/FastSyncDownloader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxOToyNzo1M1rOFu5A2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMDowMDoxMFrOFu6L4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDcxMjkyMA==", "bodyText": "We already have some utilities around executing timeouts.  I suggest hooking into those by adding a helper method to FastSyncActions which has access to EthScheduler - FastSyncActions.scheduleTask(Supplier<CompletableFuture<T>> future, Duration duration) perhaps?  See: \n  \n    \n      besu/ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/manager/EthScheduler.java\n    \n    \n         Line 170\n      in\n      2820587\n    \n    \n    \n    \n\n        \n          \n           public <T> CompletableFuture<T> scheduleFutureTask(", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r384712920", "createdAt": "2020-02-26T19:27:53Z", "author": {"login": "mbaxter"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/FastSyncDownloader.java", "diffHunk": "@@ -80,17 +87,31 @@ public FastSyncDownloader(\n             .thenApply(this::updateMaxTrailingPeers)\n             .thenApply(this::storeState)\n             .thenCompose(this::downloadChainAndWorldState),\n-        this::handleWorldStateUnavailable);\n+        this::handleFailure);\n   }\n \n-  private CompletableFuture<FastSyncState> handleWorldStateUnavailable(final Throwable error) {\n+  private CompletableFuture<FastSyncState> handleFailure(final Throwable error) {\n     trailingPeerRequirements = Optional.empty();\n-    if (ExceptionUtils.rootCause(error) instanceof StalledDownloadException) {\n+    if (ExceptionUtils.rootCause(error) instanceof FastSyncException) {\n+      return completedExceptionally(error);\n+    } else if (ExceptionUtils.rootCause(error) instanceof StalledDownloadException) {\n       LOG.warn(\n           \"Fast sync was unable to download the world state. Retrying with a new pivot block.\");\n       return start(FastSyncState.EMPTY_SYNC_STATE);\n     } else {\n-      return completedExceptionally(error);\n+      LOG.error(\"Encountered an unexpected error during fast sync.  Trying to restart fast sync.\");\n+      final ScheduledFuture<CompletableFuture<FastSyncState>> fastSyncCountdown =\n+          Executors.newSingleThreadScheduledExecutor()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e29644339f6075d521ae02504e4d60ab8271d5c5"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDczMjEzMQ==", "bodyText": "good idea. done", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r384732131", "createdAt": "2020-02-26T20:00:10Z", "author": {"login": "matkt"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/FastSyncDownloader.java", "diffHunk": "@@ -80,17 +87,31 @@ public FastSyncDownloader(\n             .thenApply(this::updateMaxTrailingPeers)\n             .thenApply(this::storeState)\n             .thenCompose(this::downloadChainAndWorldState),\n-        this::handleWorldStateUnavailable);\n+        this::handleFailure);\n   }\n \n-  private CompletableFuture<FastSyncState> handleWorldStateUnavailable(final Throwable error) {\n+  private CompletableFuture<FastSyncState> handleFailure(final Throwable error) {\n     trailingPeerRequirements = Optional.empty();\n-    if (ExceptionUtils.rootCause(error) instanceof StalledDownloadException) {\n+    if (ExceptionUtils.rootCause(error) instanceof FastSyncException) {\n+      return completedExceptionally(error);\n+    } else if (ExceptionUtils.rootCause(error) instanceof StalledDownloadException) {\n       LOG.warn(\n           \"Fast sync was unable to download the world state. Retrying with a new pivot block.\");\n       return start(FastSyncState.EMPTY_SYNC_STATE);\n     } else {\n-      return completedExceptionally(error);\n+      LOG.error(\"Encountered an unexpected error during fast sync.  Trying to restart fast sync.\");\n+      final ScheduledFuture<CompletableFuture<FastSyncState>> fastSyncCountdown =\n+          Executors.newSingleThreadScheduledExecutor()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDcxMjkyMA=="}, "originalCommit": {"oid": "e29644339f6075d521ae02504e4d60ab8271d5c5"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MjczNzIyOnYy", "diffSide": "RIGHT", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/FastSyncDownloader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMDo0ODo0OVrOFu7qTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMDo0ODo0OVrOFu7qTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc1NjMwMQ==", "bodyText": "We should log the error since we don't really want generic errors bubbling all the way up here.  Also, probably worth mentioning the delay here:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  LOG.error(\"Encountered an unexpected error during fast sync. Restarting fast sync.\");\n          \n          \n            \n                  LOG.error(\"Encountered an unexpected error during fast sync. Restarting fast sync in \" + FAST_SYNC_RETRY_DELAY + \" seconds.\", error);\n          \n      \n    \n    \n  \n\nNote: To get stack traces printed in the logs, you can only supply a single error parameter to the error method.", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r384756301", "createdAt": "2020-02-26T20:48:49Z", "author": {"login": "mbaxter"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/FastSyncDownloader.java", "diffHunk": "@@ -80,17 +84,21 @@ public FastSyncDownloader(\n             .thenApply(this::updateMaxTrailingPeers)\n             .thenApply(this::storeState)\n             .thenCompose(this::downloadChainAndWorldState),\n-        this::handleWorldStateUnavailable);\n+        this::handleFailure);\n   }\n \n-  private CompletableFuture<FastSyncState> handleWorldStateUnavailable(final Throwable error) {\n+  private CompletableFuture<FastSyncState> handleFailure(final Throwable error) {\n     trailingPeerRequirements = Optional.empty();\n-    if (ExceptionUtils.rootCause(error) instanceof StalledDownloadException) {\n+    if (ExceptionUtils.rootCause(error) instanceof FastSyncException) {\n+      return completedExceptionally(error);\n+    } else if (ExceptionUtils.rootCause(error) instanceof StalledDownloadException) {\n       LOG.warn(\n           \"Fast sync was unable to download the world state. Retrying with a new pivot block.\");\n       return start(FastSyncState.EMPTY_SYNC_STATE);\n     } else {\n-      return completedExceptionally(error);\n+      LOG.error(\"Encountered an unexpected error during fast sync. Restarting fast sync.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8438dacd566879450baa6cd6b7f7cfeed2ef0140"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MjczOTkxOnYy", "diffSide": "RIGHT", "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/FastSyncDownloader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMDo0OTo0NVrOFu7sGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMDo0OTo0NVrOFu7sGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc1Njc2Mg==", "bodyText": "(nit / optional) - I'd probably keep this constant as a Duration for readability (so its easy to see the time unit).", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r384756762", "createdAt": "2020-02-26T20:49:45Z", "author": {"login": "mbaxter"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/FastSyncDownloader.java", "diffHunk": "@@ -38,6 +39,9 @@\n import org.apache.logging.log4j.Logger;\n \n public class FastSyncDownloader<C> {\n+\n+  private static final long FAST_SYNC_RETRY_DELAY = 5;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8438dacd566879450baa6cd6b7f7cfeed2ef0140"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MzA5OTI5OnYy", "diffSide": "RIGHT", "path": "ethereum/eth/src/test/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/FastSyncDownloaderTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMjo0MzoxM1rOFu_HBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMTo1OTozNFrOFvPkoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgxMjgwNg==", "bodyText": "I think you should be able to validate the second run if you use thenAnswer to go ahead and run the future supplier with something like:\nwhen(fastSyncActions).scheduleFutureTask(any(), any())\n    .thenAnswer(invocation -> invocation.getArgument(0).get());", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r384812806", "createdAt": "2020-02-26T22:43:13Z", "author": {"login": "mbaxter"}, "path": "ethereum/eth/src/test/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/FastSyncDownloaderTest.java", "diffHunk": "@@ -413,17 +401,7 @@ public void shouldResetFastSyncStateAndRestartProcessIfANonFastSyncExceptionOccu\n     // A real chain downloader would cause the chainFuture to complete when cancel is called.\n     chainFuture.completeExceptionally(new CancellationException());\n \n-    verify(fastSyncActions, times(2)).waitForSuitablePeers(FastSyncState.EMPTY_SYNC_STATE);\n-    verify(fastSyncActions, times(2)).selectPivotBlock(FastSyncState.EMPTY_SYNC_STATE);\n-    verify(fastSyncActions).downloadPivotBlockHeader(secondSelectPivotBlockState);\n-    verify(storage).storeState(secondDownloadPivotBlockHeaderState);\n-    verify(fastSyncActions).createChainDownloader(secondDownloadPivotBlockHeaderState);\n-    verify(worldStateDownloader).run(secondPivotBlockHeader);\n-    verifyNoMoreInteractions(fastSyncActions, worldStateDownloader, storage);\n-\n-    secondWorldStateFuture.complete(null);\n-\n-    assertThat(result).isCompletedWithValue(secondDownloadPivotBlockHeaderState);\n+    verify(fastSyncActions).scheduleFutureTask(any(Supplier.class), any(Duration.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbd012ac32ea938d287a363200089294a3da99e4"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4MjUyOQ==", "bodyText": "Done", "url": "https://github.com/hyperledger/besu/pull/427#discussion_r385082529", "createdAt": "2020-02-27T11:59:34Z", "author": {"login": "matkt"}, "path": "ethereum/eth/src/test/java/org/hyperledger/besu/ethereum/eth/sync/fastsync/FastSyncDownloaderTest.java", "diffHunk": "@@ -413,17 +401,7 @@ public void shouldResetFastSyncStateAndRestartProcessIfANonFastSyncExceptionOccu\n     // A real chain downloader would cause the chainFuture to complete when cancel is called.\n     chainFuture.completeExceptionally(new CancellationException());\n \n-    verify(fastSyncActions, times(2)).waitForSuitablePeers(FastSyncState.EMPTY_SYNC_STATE);\n-    verify(fastSyncActions, times(2)).selectPivotBlock(FastSyncState.EMPTY_SYNC_STATE);\n-    verify(fastSyncActions).downloadPivotBlockHeader(secondSelectPivotBlockState);\n-    verify(storage).storeState(secondDownloadPivotBlockHeaderState);\n-    verify(fastSyncActions).createChainDownloader(secondDownloadPivotBlockHeaderState);\n-    verify(worldStateDownloader).run(secondPivotBlockHeader);\n-    verifyNoMoreInteractions(fastSyncActions, worldStateDownloader, storage);\n-\n-    secondWorldStateFuture.complete(null);\n-\n-    assertThat(result).isCompletedWithValue(secondDownloadPivotBlockHeaderState);\n+    verify(fastSyncActions).scheduleFutureTask(any(Supplier.class), any(Duration.class));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgxMjgwNg=="}, "originalCommit": {"oid": "cbd012ac32ea938d287a363200089294a3da99e4"}, "originalPosition": 71}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1134, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}