{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0NTIwNzk1", "number": 731, "title": "[BESU-507] Resolve crashing NAT detectors on GKE", "bodyText": "Signed-off-by: Karim TAAM karim.t2am@gmail.com\nPR description\nIssue : #507\n\nResolve the NatManager crash when besu is launched on GKE.\nImproved logs when switching to the fallback mode\n\nIt is no longer necessary in KUBERNETES to create a volume and to move the kubeconfig file in this volume\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app.kubernetes.io/name: besu\n    app.kubernetes.io/release: \"1.0.0\"\n  name: besu\nspec:\n  ports:\n  - name: \"json-rpc\"\n    port: 8545\n    targetPort: 8545\n  - name: \"rlpx\"\n    port: 30303\n    targetPort: 30303\n  selector:\n    app.kubernetes.io/name: besu\n    app.kubernetes.io/release: \"1.0.0\"\n  type: LoadBalancer\nYou can check the service thanks to this command\n\nkubectl describe services besu\n\nName:                     besu\nNamespace:                default\nLabels:                   app.kubernetes.io/name=besu\n                          app.kubernetes.io/release=1.0.0\nAnnotations:              kubectl.kubernetes.io/last-applied-configuration:\n                            {\"apiVersion\":\"v1\",\"kind\":\"Service\",\"metadata\":{\"annotations\":{},\"labels\":{\"app.kubernetes.io/name\":\"besu\",\"app.kubernetes.io/release\":\"1....\nSelector:                 app.kubernetes.io/name=besu,app.kubernetes.io/release=1.0.0\nType:                     LoadBalancer\nIP:                       --------\nLoadBalancer Ingress:     ***<IP>***\n\nAnd then deploy Besu\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: besu-config\n  labels:\n    app.kubernetes.io/name: besu\n    app.kubernetes.io/release: 1.0.0\ndata:\n  BESU_LOGGING: \"INFO\"\n  BESU_NETWORK: \"dev\"\n  BESU_P2P_ENABLED: \"true\"\n  BESU_RPC_HTTP_ENABLED: \"true\"\n  BESU_RPC_HTTP_APIS: \"eth,net,web3,debug,admin\"\n  KUBE_CONFIG_PATH: \"/opt/besu/shared/kube-config\"\n---\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name: besu\n  labels:\n    app.kubernetes.io/name: besu\n    app.kubernetes.io/release: \"1.0.0\"\nspec:\n  replicas: 1\n  strategy: {}\n  template:\n    metadata:\n      creationTimestamp: null\n      labels:\n        app.kubernetes.io/name: besu\n        app.kubernetes.io/release: \"1.0.0\"\n    spec:\n      containers:\n      - name: besu\n        image: \"hyperledger/besu:1.4.4-SNAPSHOT\"\n        imagePullPolicy: Always\n        ports:\n          - containerPort: 8545\n          - containerPort: 30303\n        envFrom:\n        - configMapRef:\n            name: besu-config\n      restartPolicy: Always\nstatus: {}\nOn GKE it may be necessary to give permissions to besu so that it can retrieve the list of services via the Kubernetes API\nA simple solution is to call this command.\n\nkubectl create clusterrolebinding myapp-view-binding --clusterrole=admin --serviceaccount=default:default\n\nThis command should only be used in DEV and not in production. In production we need a finer management of permissions using Kubernetes Role-based access control\nIf BESU does not have permissions (or if it does not detect the service) it will use the fallback mechanism by warning the user.\nIf the user does not want to use the detection he can call BESU with the --nat-method = NONE option", "createdAt": "2020-04-16T16:30:50Z", "url": "https://github.com/hyperledger/besu/pull/731", "merged": true, "mergeCommit": {"oid": "d7a65c0eba0eef56ea28a75fa8f55ba616d40129"}, "closed": true, "closedAt": "2020-04-17T12:47:28Z", "author": {"login": "matkt"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVjvzbgH2gAyNDA0NTIwNzk1OjJmYzAzMjRlMjUwYWJhNTZiN2E5NjNiNGRkMmVkZWI1MzQ5MWE1MGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYggWtAH2gAyNDA0NTIwNzk1OjA0ZjBjYTgzYjZiMDU1NTNhM2Q4NDhmZTBmNWIxZjljMjExNTdjMzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2fc0324e250aba56b7a963b4dd2edeb53491a50f", "author": {"user": {"login": "shemnon", "name": "Danno Ferrin"}}, "url": "https://github.com/hyperledger/besu/commit/2fc0324e250aba56b7a963b4dd2edeb53491a50f", "committedDate": "2020-04-08T08:37:23Z", "message": "Log to trace denied because of host whitelisting (#663)\n\nWhen we deny a connection based on HTTP hostname log to trace the\nrejected value.\n\nSigned-off-by: Danno Ferrin <danno.ferrin@gmail.com>\nCo-authored-by: Usman Saleem <usman@usmans.info>\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d521961d5be749f4195aa06c64cf69ddec500976", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/d521961d5be749f4195aa06c64cf69ddec500976", "committedDate": "2020-04-10T07:52:44Z", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into develop\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20e595679c69a376fcf0cfe40fbf6cb84adfdaa0", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/20e595679c69a376fcf0cfe40fbf6cb84adfdaa0", "committedDate": "2020-04-16T16:03:31Z", "message": "fix crashing NAT detectors on GKE\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a98f4c2fb70fbc902e8b153bf880f3670f9cc91", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/0a98f4c2fb70fbc902e8b153bf880f3670f9cc91", "committedDate": "2020-04-16T16:06:01Z", "message": "Merge commit '4a8f9996d9d3c59ced73188650efa14c6ff42326' into feature/besu-507-crash-gke-nat-detector\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2d4f2fa5d636e7fc41ba3975e4df6e41c5f1900", "author": {"user": {"login": "abdelhamidbakhta", "name": "Abdelhamid Bakhta"}}, "url": "https://github.com/hyperledger/besu/commit/b2d4f2fa5d636e7fc41ba3975e4df6e41c5f1900", "committedDate": "2020-04-17T08:16:49Z", "message": "Merge branch 'master' into feature/besu-507-crash-gke-nat-detector"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MjUyMTcx", "url": "https://github.com/hyperledger/besu/pull/731#pullrequestreview-395252171", "createdAt": "2020-04-17T08:17:19Z", "commit": {"oid": "0a98f4c2fb70fbc902e8b153bf880f3670f9cc91"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a53f060dea3b1e29422574a792646d91134d2e78", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/a53f060dea3b1e29422574a792646d91134d2e78", "committedDate": "2020-04-17T08:20:19Z", "message": "fix review issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MjU0MjI3", "url": "https://github.com/hyperledger/besu/pull/731#pullrequestreview-395254227", "createdAt": "2020-04-17T08:20:21Z", "commit": {"oid": "b2d4f2fa5d636e7fc41ba3975e4df6e41c5f1900"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwODoyMDoyMVrOGHEhig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwODoyMDoyMVrOGHEhig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA2NzMzOA==", "bodyText": "I suggest no to use pegasys as default namespace value. Rather use besu. And maybe make it configurable through env variable", "url": "https://github.com/hyperledger/besu/pull/731#discussion_r410067338", "createdAt": "2020-04-17T08:20:21Z", "author": {"login": "abdelhamidbakhta"}, "path": "nat/src/main/java/org/hyperledger/besu/nat/kubernetes/KubernetesNatManager.java", "diffHunk": "@@ -48,8 +45,8 @@\n public class KubernetesNatManager extends AbstractNatManager {\n   protected static final Logger LOG = LogManager.getLogger();\n \n-  private static final String KUBE_CONFIG_PATH_ENV = \"KUBE_CONFIG_PATH\";\n-  private static final String DEFAULT_KUBE_CONFIG_PATH = \"~/.kube/config\";\n+  private static final String DEFAULT_SERVICE_NAMESPACE = \"pegasys\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2d4f2fa5d636e7fc41ba3975e4df6e41c5f1900"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fb7ea309cbd36210ae37c64f2195a13a21158d4", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/7fb7ea309cbd36210ae37c64f2195a13a21158d4", "committedDate": "2020-04-17T08:21:56Z", "message": "Merge commit 'b2d4f2fa5d636e7fc41ba3975e4df6e41c5f1900' into feature/besu-507-crash-gke-nat-detector\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "696d6d06d41b4097643f9e65285d2a0621a445a7", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/696d6d06d41b4097643f9e65285d2a0621a445a7", "committedDate": "2020-04-17T12:09:19Z", "message": "fix IP detection for Kubernetes\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04f0ca83b6b05553a3d848fe0f5b1f9c21157c31", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/04f0ca83b6b05553a3d848fe0f5b1f9c21157c31", "committedDate": "2020-04-17T12:32:34Z", "message": "fix pipeline\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1744, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}