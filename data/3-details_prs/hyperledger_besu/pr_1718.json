{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwODkwNjY5", "number": 1718, "title": "Go quorum configuration", "bodyText": "When using the GoQuorum compatibility mode in besu make the configuration available.", "createdAt": "2020-12-16T05:03:10Z", "url": "https://github.com/hyperledger/besu/pull/1718", "merged": true, "mergeCommit": {"oid": "14789af5e521b0a10203bb755079e12648c3ef30"}, "closed": true, "closedAt": "2020-12-17T03:03:42Z", "author": {"login": "pinges"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmnq9tgH2gAyNTQwODkwNjY5OjY2MzUwMGQzMDVjOGExMDEwOWI5M2U4ZDM4NzEyNGYyNjBlZDcwMjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdm6TbGAH2gAyNTQwODkwNjY5OjgwYmEwNzdkYzA4MTdjNmNkYmEzMGEwMzNiMGE4MzAyNjQwNmJhNzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "663500d305c8a10109b93e8d387124f260ed7021", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/663500d305c8a10109b93e8d387124f260ed7021", "committedDate": "2020-12-16T04:59:35Z", "message": "add goquorum privacy configuration\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28b341b70cd172a0229fda340542cf0224aeb042", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/28b341b70cd172a0229fda340542cf0224aeb042", "committedDate": "2020-12-16T04:59:56Z", "message": "add goquorum privacy configuration\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d00e51b29f4459e3107ef01dc14f814abe462769", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/d00e51b29f4459e3107ef01dc14f814abe462769", "committedDate": "2020-12-16T05:04:32Z", "message": "Merge branch 'master' into GoQuorumConfiguration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0991a894ca200a948340408a6bb4e550a5184e6", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/e0991a894ca200a948340408a6bb4e550a5184e6", "committedDate": "2020-12-16T05:15:03Z", "message": "add goquorum privacy configuration\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f18e8298275d4f74786d9389d8fdd0e899a5fd9", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/4f18e8298275d4f74786d9389d8fdd0e899a5fd9", "committedDate": "2020-12-16T08:23:57Z", "message": "add goquorum privacy configuration\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3af46d3352b2f11d829f46be646cb02d476625bd", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/3af46d3352b2f11d829f46be646cb02d476625bd", "committedDate": "2020-12-16T22:36:27Z", "message": "Merge branch 'master' into GoQuorumConfiguration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35a05300c001f9b1f0e2898213ee4404db710b05", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/35a05300c001f9b1f0e2898213ee4404db710b05", "committedDate": "2020-12-16T23:57:33Z", "message": "add tests and error message\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7b0d65b12f458aaabc5b22bc392aae6646e35da", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/f7b0d65b12f458aaabc5b22bc392aae6646e35da", "committedDate": "2020-12-16T23:57:47Z", "message": "Merge branch 'GoQuorumConfiguration' of github.com:pinges/besu into GoQuorumConfiguration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41ff27eedf2d6318ff090154f227a5904e5615d8", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/41ff27eedf2d6318ff090154f227a5904e5615d8", "committedDate": "2020-12-16T23:59:56Z", "message": "remove comment\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MTkxMjUz", "url": "https://github.com/hyperledger/besu/pull/1718#pullrequestreview-554191253", "createdAt": "2020-12-17T00:26:05Z", "commit": {"oid": "41ff27eedf2d6318ff090154f227a5904e5615d8"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMDoyNjowNVrOIHfE3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMDoyOTozMFrOIHfJ5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcyMDA5Mg==", "bodyText": "s/Dile/File", "url": "https://github.com/hyperledger/besu/pull/1718#discussion_r544720092", "createdAt": "2020-12-17T00:26:05Z", "author": {"login": "macfarla"}, "path": "besu/src/test/java/org/hyperledger/besu/cli/BesuCommandTest.java", "diffHunk": "@@ -3987,10 +3987,44 @@ public void quorumInteropEnabledSucceedsWithGasPriceSetToZero() throws IOExcepti\n         \"--genesis-file\",\n         genesisFile.toString(),\n         \"--min-gas-price\",\n-        \"0\");\n+        \"0\",\n+        \"--privacy-public-key-file\",\n+        ENCLAVE_PUBLIC_KEY_PATH);\n     assertThat(commandErrorOutput.toString()).isEmpty();\n   }\n \n+  @Test\n+  public void quorumInteropEnabledFailsIfEnclaveKeyFileDoesNotExist() throws IOException {\n+    final Path genesisFile =\n+        createFakeGenesisFile(VALID_GENESIS_QUORUM_INTEROP_ENABLED_WITH_CHAINID);\n+    parseCommand(\n+        \"--goquorum-compatibility-enabled\",\n+        \"--genesis-file\",\n+        genesisFile.toString(),\n+        \"--min-gas-price\",\n+        \"0\",\n+        \"--privacy-public-key-file\",\n+        \"ThisDileDoesNotExist\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41ff27eedf2d6318ff090154f227a5904e5615d8"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcyMDkwOA==", "bodyText": "this is a no change, right?", "url": "https://github.com/hyperledger/besu/pull/1718#discussion_r544720908", "createdAt": "2020-12-17T00:28:11Z", "author": {"login": "macfarla"}, "path": "enclave/src/main/java/org/hyperledger/besu/enclave/EnclaveFactory.java", "diffHunk": "@@ -48,6 +48,22 @@ public Enclave createVertxEnclave(final URI enclaveUri) {\n     return new Enclave(vertxTransmitter);\n   }\n \n+  public Enclave createVertxEnclave(\n+      final URI enclaveUri,\n+      final Path privacyKeyStoreFile,\n+      final Path privacyKeyStorePasswordFile,\n+      final Path privacyAllowlistFile) {\n+\n+    final HttpClientOptions clientOptions =\n+        createTlsClientOptions(\n+            enclaveUri, privacyKeyStoreFile, privacyKeyStorePasswordFile, privacyAllowlistFile);\n+\n+    final RequestTransmitter vertxTransmitter =\n+        new VertxRequestTransmitter(vertx.createHttpClient(clientOptions));\n+\n+    return new Enclave(vertxTransmitter);\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41ff27eedf2d6318ff090154f227a5904e5615d8"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcyMTM4MQ==", "bodyText": "what happens if privacy-public-key-file isn't specified?", "url": "https://github.com/hyperledger/besu/pull/1718#discussion_r544721381", "createdAt": "2020-12-17T00:29:30Z", "author": {"login": "macfarla"}, "path": "besu/src/test/java/org/hyperledger/besu/cli/BesuCommandTest.java", "diffHunk": "@@ -3987,10 +3987,44 @@ public void quorumInteropEnabledSucceedsWithGasPriceSetToZero() throws IOExcepti\n         \"--genesis-file\",\n         genesisFile.toString(),\n         \"--min-gas-price\",\n-        \"0\");\n+        \"0\",\n+        \"--privacy-public-key-file\",\n+        ENCLAVE_PUBLIC_KEY_PATH);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41ff27eedf2d6318ff090154f227a5904e5615d8"}, "originalPosition": 86}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e63d065397b73227f34d917fc9d681fe855734bc", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/e63d065397b73227f34d917fc9d681fe855734bc", "committedDate": "2020-12-17T01:31:55Z", "message": "Merge branch 'master' into GoQuorumConfiguration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MjE0ODI4", "url": "https://github.com/hyperledger/besu/pull/1718#pullrequestreview-554214828", "createdAt": "2020-12-17T01:29:46Z", "commit": {"oid": "41ff27eedf2d6318ff090154f227a5904e5615d8"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMToyOTo0NlrOIHghew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMTozMzoyNFrOIHgmbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0MzgwMw==", "bodyText": "NIT: It would be nice to encapsulate all this logic to read the key into its own method. Something like readEnclaveKey or similar.", "url": "https://github.com/hyperledger/besu/pull/1718#discussion_r544743803", "createdAt": "2020-12-17T01:29:46Z", "author": {"login": "lucassaldanha"}, "path": "besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java", "diffHunk": "@@ -1502,10 +1505,46 @@ private BesuCommand configure() throws Exception {\n         .ifPresent(p -> ensureAllNodesAreInAllowlist(staticNodes, p));\n     metricsConfiguration = metricsConfiguration();\n \n+    if (isGoQuorumCompatibilityMode) {\n+      configureGoQuorumPrivacy();\n+    }\n+\n     logger.info(\"Security Module: {}\", securityModuleName);\n     return this;\n   }\n \n+  private void configureGoQuorumPrivacy() {\n+\n+    GoQuorumPrivacyParameters.isEnabled = true;\n+    final EnclaveFactory enclaveFactory = new EnclaveFactory(Vertx.vertx());\n+    if (privacyKeyStoreFile != null) {\n+      GoQuorumPrivacyParameters.goQuorumEnclave =\n+          enclaveFactory.createGoQuorumEnclave(\n+              privacyUrl,\n+              privacyKeyStoreFile,\n+              privacyKeyStorePasswordFile,\n+              privacyTlsKnownEnclaveFile);\n+    } else {\n+      GoQuorumPrivacyParameters.goQuorumEnclave = enclaveFactory.createGoQuorumEnclave(privacyUrl);\n+    }\n+    final String key;\n+    try {\n+      key = Files.asCharSource(privacyPublicKeyFile, UTF_8).read();\n+    } catch (final Exception e) {\n+      throw new ParameterException(\n+          this.commandLine,\n+          \"--privacy-public-key-file must be set when goquorum-compatibility-enabled is set to true.\",\n+          e);\n+    }\n+    if (key.length() != 44) {\n+      throw new IllegalArgumentException(\n+          \"Contents of enclave public key file needs to be 44 characters long to decode to a valid 32 byte public key.\");\n+    }\n+    // throws exception if invalid base 64\n+    Base64.getDecoder().decode(key);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41ff27eedf2d6318ff090154f227a5904e5615d8"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0NDIzOQ==", "bodyText": "NIT: it would be nice to see this logic into its own method. Something like createGoQuorumEnclave or similar.", "url": "https://github.com/hyperledger/besu/pull/1718#discussion_r544744239", "createdAt": "2020-12-17T01:31:03Z", "author": {"login": "lucassaldanha"}, "path": "besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java", "diffHunk": "@@ -1502,10 +1505,46 @@ private BesuCommand configure() throws Exception {\n         .ifPresent(p -> ensureAllNodesAreInAllowlist(staticNodes, p));\n     metricsConfiguration = metricsConfiguration();\n \n+    if (isGoQuorumCompatibilityMode) {\n+      configureGoQuorumPrivacy();\n+    }\n+\n     logger.info(\"Security Module: {}\", securityModuleName);\n     return this;\n   }\n \n+  private void configureGoQuorumPrivacy() {\n+\n+    GoQuorumPrivacyParameters.isEnabled = true;\n+    final EnclaveFactory enclaveFactory = new EnclaveFactory(Vertx.vertx());\n+    if (privacyKeyStoreFile != null) {\n+      GoQuorumPrivacyParameters.goQuorumEnclave =\n+          enclaveFactory.createGoQuorumEnclave(\n+              privacyUrl,\n+              privacyKeyStoreFile,\n+              privacyKeyStorePasswordFile,\n+              privacyTlsKnownEnclaveFile);\n+    } else {\n+      GoQuorumPrivacyParameters.goQuorumEnclave = enclaveFactory.createGoQuorumEnclave(privacyUrl);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41ff27eedf2d6318ff090154f227a5904e5615d8"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0NDU4OA==", "bodyText": "And why did we need to update a test that has nothing to do privacy?", "url": "https://github.com/hyperledger/besu/pull/1718#discussion_r544744588", "createdAt": "2020-12-17T01:31:55Z", "author": {"login": "lucassaldanha"}, "path": "besu/src/test/java/org/hyperledger/besu/cli/BesuCommandTest.java", "diffHunk": "@@ -3987,10 +3987,44 @@ public void quorumInteropEnabledSucceedsWithGasPriceSetToZero() throws IOExcepti\n         \"--genesis-file\",\n         genesisFile.toString(),\n         \"--min-gas-price\",\n-        \"0\");\n+        \"0\",\n+        \"--privacy-public-key-file\",\n+        ENCLAVE_PUBLIC_KEY_PATH);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcyMTM4MQ=="}, "originalCommit": {"oid": "41ff27eedf2d6318ff090154f227a5904e5615d8"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc0NTA2OQ==", "bodyText": "Inconsistency in using -- before the commands. Either we use the prefix in both or we don't use in either.", "url": "https://github.com/hyperledger/besu/pull/1718#discussion_r544745069", "createdAt": "2020-12-17T01:33:24Z", "author": {"login": "lucassaldanha"}, "path": "besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java", "diffHunk": "@@ -1502,10 +1505,46 @@ private BesuCommand configure() throws Exception {\n         .ifPresent(p -> ensureAllNodesAreInAllowlist(staticNodes, p));\n     metricsConfiguration = metricsConfiguration();\n \n+    if (isGoQuorumCompatibilityMode) {\n+      configureGoQuorumPrivacy();\n+    }\n+\n     logger.info(\"Security Module: {}\", securityModuleName);\n     return this;\n   }\n \n+  private void configureGoQuorumPrivacy() {\n+\n+    GoQuorumPrivacyParameters.isEnabled = true;\n+    final EnclaveFactory enclaveFactory = new EnclaveFactory(Vertx.vertx());\n+    if (privacyKeyStoreFile != null) {\n+      GoQuorumPrivacyParameters.goQuorumEnclave =\n+          enclaveFactory.createGoQuorumEnclave(\n+              privacyUrl,\n+              privacyKeyStoreFile,\n+              privacyKeyStorePasswordFile,\n+              privacyTlsKnownEnclaveFile);\n+    } else {\n+      GoQuorumPrivacyParameters.goQuorumEnclave = enclaveFactory.createGoQuorumEnclave(privacyUrl);\n+    }\n+    final String key;\n+    try {\n+      key = Files.asCharSource(privacyPublicKeyFile, UTF_8).read();\n+    } catch (final Exception e) {\n+      throw new ParameterException(\n+          this.commandLine,\n+          \"--privacy-public-key-file must be set when goquorum-compatibility-enabled is set to true.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e63d065397b73227f34d917fc9d681fe855734bc"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "894bf9b8ce2b3343eed8c8d8ebd62aa646462477", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/894bf9b8ce2b3343eed8c8d8ebd62aa646462477", "committedDate": "2020-12-17T01:54:21Z", "message": "changes after review comments\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80ba077dc0817c6cdba30a033b0a83026406ba72", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/80ba077dc0817c6cdba30a033b0a83026406ba72", "committedDate": "2020-12-17T02:42:04Z", "message": "changes after review comments\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2002, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}