{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNzQ1MTA1", "number": 680, "title": "Update BesuController to work with NodeKey (not KeyPair)", "bodyText": "PR description\nUpdate BesuController to use the NodeKey, rather than working with KeyPair - which in turn allows the crypto operations to be injected.\nFixed Issue(s)\nN/A", "createdAt": "2020-04-08T09:51:05Z", "url": "https://github.com/hyperledger/besu/pull/680", "merged": true, "mergeCommit": {"oid": "665ee1cbac3efc079aa7652bc811c0de1792a17c"}, "closed": true, "closedAt": "2020-04-09T06:06:59Z", "author": {"login": "rain-on"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVyh-HgH2gAyNDAwNzQ1MTA1OmM0NmIxMWQxMzRmYTk2ZWU3NGMyMjcwMjUxNzBkMDQxNDFmYTYxOTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcV2D9_AFqTM5MDUwOTAwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c46b11d134fa96ee74c227025170d04141fa6192", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/c46b11d134fa96ee74c227025170d04141fa6192", "committedDate": "2020-04-09T01:50:51Z", "message": "Update BesuController to work with NodeKey\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a814ba5190e2cec428b18bc6f878d3ddfaebb9a8", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/a814ba5190e2cec428b18bc6f878d3ddfaebb9a8", "committedDate": "2020-04-09T01:42:39Z", "message": "Merge remote-tracking branch 'upstream/master' into update_controller\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}, "afterCommit": {"oid": "c46b11d134fa96ee74c227025170d04141fa6192", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/c46b11d134fa96ee74c227025170d04141fa6192", "committedDate": "2020-04-09T01:50:51Z", "message": "Update BesuController to work with NodeKey\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c89d8dadda18a9a7d60e39511f79cb280ad9d4a", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/9c89d8dadda18a9a7d60e39511f79cb280ad9d4a", "committedDate": "2020-04-09T03:00:45Z", "message": "fix spotless\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/6b4d0b2dee53895f25ee7e32f00fbcabb581effe", "committedDate": "2020-04-09T03:16:49Z", "message": "Merge remote-tracking branch 'upstream/master' into update_controller2\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNDY2OTI4", "url": "https://github.com/hyperledger/besu/pull/680#pullrequestreview-390466928", "createdAt": "2020-04-09T03:23:44Z", "commit": {"oid": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMzoyMzo0NFrOGDIR-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMzoyMzo0NFrOGDIR-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNDU4NA==", "bodyText": "Is there any change here except removing try/catch block?", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405934584", "createdAt": "2020-04-09T03:23:44Z", "author": {"login": "usmansaleem"}, "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ThreadBesuNodeRunner.java", "diffHunk": "@@ -134,26 +133,21 @@ public void startNode(final BesuNode node) {\n             .withMetricsSystem(metricsSystem)\n             .build();\n \n-    final BesuController<?> besuController;\n-    try {\n-      besuController =\n-          builder\n-              .synchronizerConfiguration(new SynchronizerConfiguration.Builder().build())\n-              .dataDirectory(node.homeDirectory())\n-              .miningParameters(node.getMiningParameters())\n-              .privacyParameters(node.getPrivacyParameters())\n-              .nodePrivateKeyFile(KeyPairUtil.getDefaultKeyFile(node.homeDirectory()))\n-              .metricsSystem(metricsSystem)\n-              .transactionPoolConfiguration(TransactionPoolConfiguration.builder().build())\n-              .ethProtocolConfiguration(EthProtocolConfiguration.defaultConfig())\n-              .clock(Clock.systemUTC())\n-              .isRevertReasonEnabled(node.isRevertReasonEnabled())\n-              .storageProvider(storageProvider)\n-              .targetGasLimit(GasLimitCalculator.DEFAULT)\n-              .build();\n-    } catch (final IOException e) {\n-      throw new RuntimeException(\"Error building BesuController\", e);\n-    }\n+    final BesuController<?> besuController =\n+        builder\n+            .synchronizerConfiguration(new SynchronizerConfiguration.Builder().build())\n+            .dataDirectory(node.homeDirectory())\n+            .miningParameters(node.getMiningParameters())\n+            .privacyParameters(node.getPrivacyParameters())\n+            .nodePrivateKeyFile(KeyPairUtil.getDefaultKeyFile(node.homeDirectory()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNDY3ODc4", "url": "https://github.com/hyperledger/besu/pull/680#pullrequestreview-390467878", "createdAt": "2020-04-09T03:27:25Z", "commit": {"oid": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMzoyNzoyNlrOGDIVMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMzoyNzoyNlrOGDIVMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNTQxMA==", "bodyText": "shouldn't this be protected or private?", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405935410", "createdAt": "2020-04-09T03:27:26Z", "author": {"login": "usmansaleem"}, "path": "besu/src/main/java/org/hyperledger/besu/controller/BesuControllerBuilder.java", "diffHunk": "@@ -85,7 +85,7 @@\n   protected PrivacyParameters privacyParameters;\n   protected Path dataDirectory;\n   protected Clock clock;\n-  KeyPair nodeKeys;\n+  NodeKey nodeKey;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNDY4MjY0", "url": "https://github.com/hyperledger/besu/pull/680#pullrequestreview-390468264", "createdAt": "2020-04-09T03:29:05Z", "commit": {"oid": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMzoyOTowNlrOGDIWtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMzoyOTowNlrOGDIWtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNTc5OA==", "bodyText": "nit: getNodeKey instead of accessing super class member variable.", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405935798", "createdAt": "2020-04-09T03:29:06Z", "author": {"login": "usmansaleem"}, "path": "besu/src/main/java/org/hyperledger/besu/controller/CliqueBesuControllerBuilder.java", "diffHunk": "@@ -57,7 +56,7 @@\n \n   @Override\n   protected void prepForBuild() {\n-    localAddress = Util.publicKeyToAddress(nodeKeys.getPublicKey());\n+    localAddress = Util.publicKeyToAddress(nodeKey.getPublicKey());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNDY4NjI3", "url": "https://github.com/hyperledger/besu/pull/680#pullrequestreview-390468627", "createdAt": "2020-04-09T03:30:32Z", "commit": {"oid": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMzozMDozMlrOGDIX_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMzozMDozMlrOGDIX_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNjEyNQ==", "bodyText": "same as before, getNodeKey() instead of nodeKey??", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405936125", "createdAt": "2020-04-09T03:30:32Z", "author": {"login": "usmansaleem"}, "path": "besu/src/main/java/org/hyperledger/besu/controller/IbftBesuControllerBuilder.java", "diffHunk": "@@ -208,7 +204,6 @@ protected MiningCoordinator createMiningCoordinator(\n \n   @Override\n   protected PluginServiceFactory createAdditionalPluginServices(final Blockchain blockchain) {\n-    final NodeKey nodeKey = new BouncyCastleNodeKey(nodeKeys);\n     return new IbftQueryPluginServiceFactory(blockchain, nodeKey);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNDcwMzAw", "url": "https://github.com/hyperledger/besu/pull/680#pullrequestreview-390470300", "createdAt": "2020-04-09T03:37:07Z", "commit": {"oid": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNDkxNTMx", "url": "https://github.com/hyperledger/besu/pull/680#pullrequestreview-390491531", "createdAt": "2020-04-09T04:59:52Z", "commit": {"oid": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNDo1OTo1M1rOGDJpgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNTowOToyNlrOGDJyVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1Njk5Mw==", "bodyText": "Think can still fail here with an IOException probably trying to load the private key from file", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405956993", "createdAt": "2020-04-09T04:59:53Z", "author": {"login": "jframe"}, "path": "acceptance-tests/dsl/src/main/java/org/hyperledger/besu/tests/acceptance/dsl/node/ThreadBesuNodeRunner.java", "diffHunk": "@@ -134,26 +133,21 @@ public void startNode(final BesuNode node) {\n             .withMetricsSystem(metricsSystem)\n             .build();\n \n-    final BesuController<?> besuController;\n-    try {\n-      besuController =\n-          builder\n-              .synchronizerConfiguration(new SynchronizerConfiguration.Builder().build())\n-              .dataDirectory(node.homeDirectory())\n-              .miningParameters(node.getMiningParameters())\n-              .privacyParameters(node.getPrivacyParameters())\n-              .nodePrivateKeyFile(KeyPairUtil.getDefaultKeyFile(node.homeDirectory()))\n-              .metricsSystem(metricsSystem)\n-              .transactionPoolConfiguration(TransactionPoolConfiguration.builder().build())\n-              .ethProtocolConfiguration(EthProtocolConfiguration.defaultConfig())\n-              .clock(Clock.systemUTC())\n-              .isRevertReasonEnabled(node.isRevertReasonEnabled())\n-              .storageProvider(storageProvider)\n-              .targetGasLimit(GasLimitCalculator.DEFAULT)\n-              .build();\n-    } catch (final IOException e) {\n-      throw new RuntimeException(\"Error building BesuController\", e);\n-    }\n+    final BesuController<?> besuController =\n+        builder\n+            .synchronizerConfiguration(new SynchronizerConfiguration.Builder().build())\n+            .dataDirectory(node.homeDirectory())\n+            .miningParameters(node.getMiningParameters())\n+            .privacyParameters(node.getPrivacyParameters())\n+            .nodePrivateKeyFile(KeyPairUtil.getDefaultKeyFile(node.homeDirectory()))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNDU4NA=="}, "originalCommit": {"oid": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1NzQ4MQ==", "bodyText": "Why did you remove the try/catch here?", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405957481", "createdAt": "2020-04-09T05:01:57Z", "author": {"login": "jframe"}, "path": "besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java", "diffHunk": "@@ -1224,40 +1224,36 @@ private BesuCommand controller() {\n   }\n \n   public BesuControllerBuilder<?> getControllerBuilder() {\n-    try {\n-      addConfigurationService();\n-      return controllerBuilderFactory\n-          .fromEthNetworkConfig(updateNetworkConfig(getNetwork()), genesisConfigOverrides)\n-          .synchronizerConfiguration(buildSyncConfig())\n-          .ethProtocolConfiguration(ethProtocolOptions.toDomainObject())\n-          .dataDirectory(dataDir())\n-          .miningParameters(\n-              new MiningParameters(\n-                  coinbase,\n-                  minTransactionGasPrice,\n-                  extraData,\n-                  isMiningEnabled,\n-                  iStratumMiningEnabled,\n-                  stratumNetworkInterface,\n-                  stratumPort,\n-                  stratumExtranonce,\n-                  Optional.empty()))\n-          .transactionPoolConfiguration(buildTransactionPoolConfiguration())\n-          .nodePrivateKeyFile(nodePrivateKeyFile())\n-          .metricsSystem(metricsSystem.get())\n-          .privacyParameters(privacyParameters())\n-          .clock(Clock.systemUTC())\n-          .isRevertReasonEnabled(isRevertReasonEnabled)\n-          .storageProvider(keyStorageProvider(keyValueStorageName))\n-          .isPruningEnabled(isPruningEnabled())\n-          .pruningConfiguration(\n-              new PrunerConfiguration(pruningBlockConfirmations, pruningBlocksRetained))\n-          .genesisConfigOverrides(genesisConfigOverrides)\n-          .targetGasLimit(targetGasLimit == null ? Optional.empty() : Optional.of(targetGasLimit))\n-          .requiredBlocks(requiredBlocks);\n-    } catch (final IOException e) {\n-      throw new ExecutionException(this.commandLine, \"Invalid path\", e);\n-    }\n+    addConfigurationService();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1ODIzNw==", "bodyText": "Looks like it could be protected", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405958237", "createdAt": "2020-04-09T05:05:05Z", "author": {"login": "jframe"}, "path": "besu/src/main/java/org/hyperledger/besu/controller/BesuControllerBuilder.java", "diffHunk": "@@ -85,7 +85,7 @@\n   protected PrivacyParameters privacyParameters;\n   protected Path dataDirectory;\n   protected Clock clock;\n-  KeyPair nodeKeys;\n+  NodeKey nodeKey;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTkzNTQxMA=="}, "originalCommit": {"oid": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1OTEzMw==", "bodyText": "nit: NodeKey instead of nodeKey", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405959133", "createdAt": "2020-04-09T05:08:57Z", "author": {"login": "jframe"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/network/DefaultP2PNetwork.java", "diffHunk": "@@ -431,7 +429,7 @@ private P2PNetwork doBuild() {\n     }\n \n     private void validate() {\n-      checkState(keyPair != null, \"KeyPair must be set.\");\n+      checkState(nodeKey != null, \"nodeKey must be set.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk1OTI1NA==", "bodyText": "nit: nodeKey instead of NodeKey", "url": "https://github.com/hyperledger/besu/pull/680#discussion_r405959254", "createdAt": "2020-04-09T05:09:26Z", "author": {"login": "jframe"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/rlpx/RlpxAgent.java", "diffHunk": "@@ -563,17 +563,17 @@ public RlpxAgent build() {\n     }\n \n     private void validate() {\n-      checkState(keyPair != null, \"KeyPair must be configured\");\n+      checkState(nodeKey != null, \"nodeKey must be configured\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b4d0b2dee53895f25ee7e32f00fbcabb581effe"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5da822ca14c4618a43dee4ccb3d311bec18e5209", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/5da822ca14c4618a43dee4ccb3d311bec18e5209", "committedDate": "2020-04-09T05:19:39Z", "message": "Rename nodekeys to nodekey\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15aab7125bc79cc016161bd35af03c02802d4160", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/15aab7125bc79cc016161bd35af03c02802d4160", "committedDate": "2020-04-09T05:32:20Z", "message": "Post review\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNTA5MDAx", "url": "https://github.com/hyperledger/besu/pull/680#pullrequestreview-390509001", "createdAt": "2020-04-09T05:57:42Z", "commit": {"oid": "15aab7125bc79cc016161bd35af03c02802d4160"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1697, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}