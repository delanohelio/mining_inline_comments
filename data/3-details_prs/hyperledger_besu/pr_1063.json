{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxODQ3NTgz", "number": 1063, "title": "[BESU-1919] Add proper support for eth_hashrate", "bodyText": "PR description\n\nImplemented submitHashrate endpoint which is by default limited to 1000 sealers. Adding a 1001 will remove the oldest from the list (0x0 hashrate is refused)\nUpdated eth_hashrateendpoint so that it returns the cumulative hashrate of all sealers if the list is not empty. Otherwise it returns the local hashrate\nAdded hashrate submission with Stratum1EthProxyProtocol and Stratum1Protocol\nAdded CLI Option to modify the number of sealers limit\n\nTested\n\nTested the hashrate submission with stratum\nTested the hashrate submission with json rpc api\n\n{\"id\":1,\"jsonrpc\":\"2.0\",\"method\":\"eth_submitHashrate\",\"params\":[\"0x00\",\"0x01\"]}\n\n{\"id\":1,\"jsonrpc\":\"2.0\",\"method\":\"eth_submitHashrate\",\"params\":[\"0x01\",\"0x01\"]}\n\n\nTested with CPU and GPU mining\nTested submission TTL", "createdAt": "2020-06-09T14:44:25Z", "url": "https://github.com/hyperledger/besu/pull/1063", "merged": true, "mergeCommit": {"oid": "165be86aa90167822290e23e148b4da0ff1816ff"}, "closed": true, "closedAt": "2020-06-15T08:38:52Z", "author": {"login": "matkt"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpk693AH2gAyNDMxODQ3NTgzOjUwZjMzMWY3ZTQ1NmE4YTNmMGVjNzc3NzUyMmU3YjA3OWJlZTcyMzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcrb_llgH2gAyNDMxODQ3NTgzOmVjZDFkNGI0ZjkzMWUxNTY0OTgxNTc4ZDg1NjM1NTg0Mjc3MTU0MTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "50f331f7e456a8a3f0ec7777522e7b079bee7238", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/50f331f7e456a8a3f0ec7777522e7b079bee7238", "committedDate": "2020-06-09T13:17:58Z", "message": "add eth_submithashrate implementation\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d23c690f6edb7a9442f9dc2f61977ceaf004d8d9", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/d23c690f6edb7a9442f9dc2f61977ceaf004d8d9", "committedDate": "2020-06-09T13:24:55Z", "message": "add missing files\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "988ce6080b37b17cc1d393533d79502a9a36813d", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/988ce6080b37b17cc1d393533d79502a9a36813d", "committedDate": "2020-06-09T14:39:59Z", "message": "remove useless modification\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "628602aaa36b772f5b71b7cabd9413d551bac341", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/628602aaa36b772f5b71b7cabd9413d551bac341", "committedDate": "2020-06-09T15:27:54Z", "message": "add test for stratum\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4592ef6b0e910947410b3d46f62a81b046853987", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/4592ef6b0e910947410b3d46f62a81b046853987", "committedDate": "2020-06-09T15:32:40Z", "message": "spotless apply\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08e5280bf803854511e59f135765e123dfb2c010", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/08e5280bf803854511e59f135765e123dfb2c010", "committedDate": "2020-06-09T15:38:07Z", "message": "Merge branch 'upstream/master' into feature/besu-1919-eth-hashrate\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93d48dd7f208ca4db311fbb6c5472c911191e3ac", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/93d48dd7f208ca4db311fbb6c5472c911191e3ac", "committedDate": "2020-06-09T15:39:57Z", "message": "clean code\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "973e240f831ebc2462ae68ff6c64a574fd758e65", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/973e240f831ebc2462ae68ff6c64a574fd758e65", "committedDate": "2020-06-09T15:52:32Z", "message": "fix merge issue\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5MTYyMjU4", "url": "https://github.com/hyperledger/besu/pull/1063#pullrequestreview-429162258", "createdAt": "2020-06-11T18:02:23Z", "commit": {"oid": "973e240f831ebc2462ae68ff6c64a574fd758e65"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxODowMjoyM1rOGio4eA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxODoxOTowMVrOGipbow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3NDU4NA==", "bodyText": "Let's make this an --X option for the first few releases.  We can promote it later, but because this becomes part of the public API I want to have a window where it can be easily changed.", "url": "https://github.com/hyperledger/besu/pull/1063#discussion_r438974584", "createdAt": "2020-06-11T18:02:23Z", "author": {"login": "shemnon"}, "path": "besu/src/main/java/org/hyperledger/besu/cli/BesuCommand.java", "diffHunk": "@@ -724,6 +724,12 @@ void setBannedNodeIds(final List<String> values) {\n       description = \"Stratum port binding (default: ${DEFAULT-VALUE})\")\n   private final Integer stratumPort = 8008;\n \n+  @Option(\n+      names = {\"--miner-remote-sealers-limit\"},", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "973e240f831ebc2462ae68ff6c64a574fd758e65"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3ODMyOA==", "bodyText": "I think a guava cache may be more appropriate for this particular data set https://github.com/google/guava/wiki/CachesExplained - we can set the max size via the flag and we can expire values after a certain time.  Which given miners come and go I think is a good thing.  Perhaps 10 minutes?  Also set by a flag like the max cache size.", "url": "https://github.com/hyperledger/besu/pull/1063#discussion_r438978328", "createdAt": "2020-06-11T18:09:10Z", "author": {"login": "shemnon"}, "path": "ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/AbstractMiningCoordinator.java", "diffHunk": "@@ -40,6 +44,8 @@\n         M extends BlockMiner<? extends AbstractBlockCreator>>\n     implements BlockAddedObserver, MiningCoordinator {\n \n+  private final Map<String, SealerInfo> sealerInfos;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "973e240f831ebc2462ae68ff6c64a574fd758e65"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk4MzA3OQ==", "bodyText": "I think it would be better to move all the logic around submitting hashrate and storing the sealerInfo down into the EthashMiningCoordinator.  IBFT and Clique will never use these.", "url": "https://github.com/hyperledger/besu/pull/1063#discussion_r438983079", "createdAt": "2020-06-11T18:18:02Z", "author": {"login": "shemnon"}, "path": "ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/AbstractMiningCoordinator.java", "diffHunk": "@@ -215,4 +232,28 @@ public void setExtraData(final Bytes extraData) {\n \n   protected abstract boolean newChainHeadInvalidatesMiningOperation(\n       final BlockHeader newChainHeadHeader);\n+\n+  @Override\n+  public Map<String, SealerInfo> getSealerInfos() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "973e240f831ebc2462ae68ff6c64a574fd758e65"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk4MzU4Nw==", "bodyText": "I would remove this in favor or a new getHashRate() function that defaults to zero.", "url": "https://github.com/hyperledger/besu/pull/1063#discussion_r438983587", "createdAt": "2020-06-11T18:19:01Z", "author": {"login": "shemnon"}, "path": "ethereum/blockcreation/src/main/java/org/hyperledger/besu/ethereum/blockcreation/MiningCoordinator.java", "diffHunk": "@@ -77,6 +81,26 @@ default boolean submitWork(final EthHashSolution solution) {\n         \"Current consensus mechanism prevents submission of work solutions.\");\n   }\n \n+  /**\n+   * Allows to submit the hashrate of a sealer with a specific id\n+   *\n+   * @param id of the sealer\n+   * @param hashrate of the sealer\n+   * @return true if the hashrate has been added otherwise false\n+   */\n+  default boolean submitHashRate(final String id, final Long hashrate) {\n+    return false;\n+  }\n+\n+  /**\n+   * Returns a list of the current sealers\n+   *\n+   * @return a list of {@link SealerInfo}\n+   */\n+  default Map<String, SealerInfo> getSealerInfos() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "973e240f831ebc2462ae68ff6c64a574fd758e65"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d20adaeea7a238603e1f3d4844250514bf44ed53", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/d20adaeea7a238603e1f3d4844250514bf44ed53", "committedDate": "2020-06-12T09:36:43Z", "message": "Merge branch 'upstream/master' into feature/besu-1919-eth-hashrate\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c00bcf90d0ec39ad956cf0a8ebf09e679f941f6d", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/c00bcf90d0ec39ad956cf0a8ebf09e679f941f6d", "committedDate": "2020-06-12T16:35:58Z", "message": "resolve review issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e285f9cf46604958607c13ceef3b0c87ded4b431", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/e285f9cf46604958607c13ceef3b0c87ded4b431", "committedDate": "2020-06-12T16:43:22Z", "message": "resolve last review issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71d60a727d0dd8f7a508f9b50dd7e68659835300", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/71d60a727d0dd8f7a508f9b50dd7e68659835300", "committedDate": "2020-06-12T16:54:29Z", "message": "clean code\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4ad87bd634b96dd2d958383b2bafcb31aa1ab5c", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/c4ad87bd634b96dd2d958383b2bafcb31aa1ab5c", "committedDate": "2020-06-12T19:16:41Z", "message": "add cli option for hashrate time to live\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae8c4511455895d84c03c636a09a963eccc92101", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/ae8c4511455895d84c03c636a09a963eccc92101", "committedDate": "2020-06-12T20:34:30Z", "message": "fix command test\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMzI5NTQ1", "url": "https://github.com/hyperledger/besu/pull/1063#pullrequestreview-430329545", "createdAt": "2020-06-15T05:24:51Z", "commit": {"oid": "ae8c4511455895d84c03c636a09a963eccc92101"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecd1d4b4f931e1564981578d8563558427715412", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/ecd1d4b4f931e1564981578d8563558427715412", "committedDate": "2020-06-15T08:01:43Z", "message": "Merge branch 'upstream/master' into feature/besu-1919-eth-hashrate\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1486, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}