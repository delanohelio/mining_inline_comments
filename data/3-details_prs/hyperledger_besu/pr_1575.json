{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyMTg2NzQ4", "number": 1575, "title": "IBFT2 roundchange not sent if timeout after import", "bodyText": "There exists a window in which a \"RoundTimeout\" event can be inserted to the IBFT event queue, such that it is actioned after a block has been successfully imported, but before the NewBlockEvent is actioned.\nThis results in an unrequired (and potentially incorrect) RoundChange message being sent to other validators. This change prevents this spurious transmission, which in turn reduces potential attack vectors.", "createdAt": "2020-11-17T06:54:47Z", "url": "https://github.com/hyperledger/besu/pull/1575", "merged": true, "mergeCommit": {"oid": "a5df0fde2d31606bf31984031e4c51ec5af92dbc"}, "closed": true, "closedAt": "2020-11-19T02:31:02Z", "author": {"login": "rain-on"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddT8owABqjQwMDM4NzAyNzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdd41bkgH2gAyNTIyMTg2NzQ4OjYwNzJkZTJlY2QxOWVjNzA3Y2QyMjQ1Nzk3MmNhY2VlOWM4OGZlMmQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3a039e7b8356f08014d6206008962df5b3ac90de", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/3a039e7b8356f08014d6206008962df5b3ac90de", "committedDate": "2020-11-17T06:50:49Z", "message": "IBFT2 roundchange not sent if timeout after import"}, "afterCommit": {"oid": "3c034cc96d9f544679e2ac5eacfdf996623bfc1d", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/3c034cc96d9f544679e2ac5eacfdf996623bfc1d", "committedDate": "2020-11-17T06:55:18Z", "message": "IBFT2 roundchange not sent if timeout after import\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c034cc96d9f544679e2ac5eacfdf996623bfc1d", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/3c034cc96d9f544679e2ac5eacfdf996623bfc1d", "committedDate": "2020-11-17T06:55:18Z", "message": "IBFT2 roundchange not sent if timeout after import\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}, "afterCommit": {"oid": "8ec5c0a9866037b1591e5367626972e65100eae7", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/8ec5c0a9866037b1591e5367626972e65100eae7", "committedDate": "2020-11-17T06:56:34Z", "message": "IBFT2 roundchange not sent if timeout after import\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyOTQ1ODA4", "url": "https://github.com/hyperledger/besu/pull/1575#pullrequestreview-532945808", "createdAt": "2020-11-18T01:29:48Z", "commit": {"oid": "606e704936422dd691138b6200f0cba36f10243a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMToyOTo0OFrOH1SQ1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMToyOTo0OFrOH1SQ1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzNTc5OA==", "bodyText": "are these comments meant to be removed?", "url": "https://github.com/hyperledger/besu/pull/1575#discussion_r525635798", "createdAt": "2020-11-18T01:29:48Z", "author": {"login": "usmansaleem"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/privacy/methods/eea/EeaSendRawTransaction.java", "diffHunk": "@@ -140,7 +140,9 @@ public JsonRpcResponse response(final JsonRpcRequestContext requestContext) {\n             id, privateTransaction, privateTransactionLookupId, Address.DEFAULT_PRIVACY);\n       }\n     } catch (final IllegalArgumentException | RLPException e) {\n+      /// RIGHT HERE <----", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "606e704936422dd691138b6200f0cba36f10243a"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd3ac507bb23a4524d03a75006fe05c209c38ffc", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/bd3ac507bb23a4524d03a75006fe05c209c38ffc", "committedDate": "2020-11-18T01:55:20Z", "message": "Merge remote-tracking branch 'origin/ibft_rc_post_import' into ibft_rc_post_import"}, "afterCommit": {"oid": "3fe882dc8c48d328e904baea35aae6685f5a299a", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/3fe882dc8c48d328e904baea35aae6685f5a299a", "committedDate": "2020-11-18T01:56:20Z", "message": "IBFT2 roundchange not sent if timeout after import\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyOTk4NDY1", "url": "https://github.com/hyperledger/besu/pull/1575#pullrequestreview-532998465", "createdAt": "2020-11-18T02:14:15Z", "commit": {"oid": "3fe882dc8c48d328e904baea35aae6685f5a299a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a1306d22aa4876d615803318e1ecce8ac8758c8", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/7a1306d22aa4876d615803318e1ecce8ac8758c8", "committedDate": "2020-11-18T04:23:46Z", "message": "IBFT2 roundchange not sent if timeout after import\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "96683bc08e20519ea7b86f0b0f5a489fe234c96e", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/96683bc08e20519ea7b86f0b0f5a489fe234c96e", "committedDate": "2020-11-18T04:13:23Z", "message": "fix spotless"}, "afterCommit": {"oid": "7a1306d22aa4876d615803318e1ecce8ac8758c8", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/7a1306d22aa4876d615803318e1ecce8ac8758c8", "committedDate": "2020-11-18T04:23:46Z", "message": "IBFT2 roundchange not sent if timeout after import\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c2f0887b630e1a6e11ae6e447f4ecb670343c9d", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/0c2f0887b630e1a6e11ae6e447f4ecb670343c9d", "committedDate": "2020-11-18T04:43:54Z", "message": "fix tests\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8b605b86ed2e5af9133ede71042081c43e6f4037", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/8b605b86ed2e5af9133ede71042081c43e6f4037", "committedDate": "2020-11-18T04:41:53Z", "message": "fix tests"}, "afterCommit": {"oid": "0c2f0887b630e1a6e11ae6e447f4ecb670343c9d", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/0c2f0887b630e1a6e11ae6e447f4ecb670343c9d", "committedDate": "2020-11-18T04:43:54Z", "message": "fix tests\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "056efa929d1fc2c5773d9512f9e7cf2213bfe49b", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/056efa929d1fc2c5773d9512f9e7cf2213bfe49b", "committedDate": "2020-11-18T04:52:21Z", "message": "Change to <=\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c6e90fbe116cc7f6479ed86855dbd3d83dc4fd9", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/5c6e90fbe116cc7f6479ed86855dbd3d83dc4fd9", "committedDate": "2020-11-18T06:13:39Z", "message": "added new tests\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b35bdcaabe90a5d4aa612f286639760b17803eb6", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/b35bdcaabe90a5d4aa612f286639760b17803eb6", "committedDate": "2020-11-18T21:37:26Z", "message": "Merge remote-tracking branch 'upstream/master' into ibft_rc_post_import\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25277ce5b1f82d28a72bbb20958cde2f81d59835", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/25277ce5b1f82d28a72bbb20958cde2f81d59835", "committedDate": "2020-11-18T21:59:16Z", "message": "remove unneeded mocks\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f4f29923896542e8390013aa1c9cbbd821e31a10", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/f4f29923896542e8390013aa1c9cbbd821e31a10", "committedDate": "2020-11-18T21:47:18Z", "message": "remove unneeded mocks"}, "afterCommit": {"oid": "25277ce5b1f82d28a72bbb20958cde2f81d59835", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/25277ce5b1f82d28a72bbb20958cde2f81d59835", "committedDate": "2020-11-18T21:59:16Z", "message": "remove unneeded mocks\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzOTc3NTU1", "url": "https://github.com/hyperledger/besu/pull/1575#pullrequestreview-533977555", "createdAt": "2020-11-18T23:58:50Z", "commit": {"oid": "25277ce5b1f82d28a72bbb20958cde2f81d59835"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMzo1ODo1MFrOH2HJIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMDowMDozNVrOH2HLvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMjE3Nw==", "bodyText": "This comment seems like a nice check to add", "url": "https://github.com/hyperledger/besu/pull/1575#discussion_r526502177", "createdAt": "2020-11-18T23:58:50Z", "author": {"login": "jframe"}, "path": "consensus/ibft/src/integration-test/java/org/hyperledger/besu/consensus/ibft/tests/LocalNodeIsProposerTest.java", "diffHunk": "@@ -110,4 +112,47 @@ public void importsToChainWithoutReceivingPrepareMessages() {\n     assertThat(context.getBlockchain().getChainHeadBlockNumber()).isEqualTo(1);\n     peers.verifyNoMessagesReceived();\n   }\n+\n+  @Test\n+  public void nodeDoesNotSendRoundChangeIfRoundTimesOutAfterBlockImportButBeforeNewBlock() {\n+    peers.verifyMessagesReceived(expectedTxProposal);\n+    peers.getNonProposing(0).injectCommit(roundId, expectedProposedBlock.getHash());\n+    assertThat(context.getBlockchain().getChainHeadBlockNumber()).isEqualTo(0);\n+    peers.verifyNoMessagesReceived();\n+\n+    peers.getNonProposing(1).injectCommit(roundId, expectedProposedBlock.getHash());\n+    assertThat(context.getBlockchain().getChainHeadBlockNumber()).isEqualTo(1);\n+    peers.verifyNoMessagesReceived();\n+\n+    context.getController().handleRoundExpiry(new RoundExpiry(roundId));\n+    peers.verifyNoMessagesReceived();\n+\n+    context\n+        .getController()\n+        .handleNewBlockEvent(new NewChainHead(expectedProposedBlock.getHeader()));\n+    peers.verifyNoMessagesReceived();\n+  }\n+\n+  @Test\n+  public void nodeDoesNotGoIntoRoundChangeAfterImport() {\n+    peers.verifyMessagesReceived(expectedTxProposal);\n+    peers.getNonProposing(0).injectCommit(roundId, expectedProposedBlock.getHash());\n+    assertThat(context.getBlockchain().getChainHeadBlockNumber()).isEqualTo(0);\n+    peers.verifyNoMessagesReceived();\n+\n+    peers.getNonProposing(1).injectCommit(roundId, expectedProposedBlock.getHash());\n+    assertThat(context.getBlockchain().getChainHeadBlockNumber()).isEqualTo(1);\n+    peers.verifyNoMessagesReceived();\n+\n+    final ConsensusRoundIdentifier nextRound = new ConsensusRoundIdentifier(1, 1);\n+\n+    peers.getNonProposing(0).injectRoundChange(nextRound, Optional.empty());\n+    peers.verifyNoMessagesReceived();\n+    peers.getNonProposing(1).injectRoundChange(nextRound, Optional.empty());\n+    peers.verifyNoMessagesReceived();\n+    peers.getNonProposing(2).injectRoundChange(nextRound, Optional.empty());\n+\n+    // Prove local node is NOT in Round(1,1)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25277ce5b1f82d28a72bbb20958cde2f81d59835"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUwMjg0NQ==", "bodyText": "Think we should log if this happens", "url": "https://github.com/hyperledger/besu/pull/1575#discussion_r526502845", "createdAt": "2020-11-19T00:00:35Z", "author": {"login": "jframe"}, "path": "consensus/ibft/src/main/java/org/hyperledger/besu/consensus/ibft/statemachine/IbftController.java", "diffHunk": "@@ -129,6 +130,14 @@ private void handleMessage(final Message message) {\n   private <P extends IbftMessage<?>> void consumeMessage(\n       final Message message, final P ibftMessage, final Consumer<P> handleMessage) {\n     LOG.trace(\"Received IBFT {} message\", ibftMessage.getClass().getSimpleName());\n+\n+    // Discard all messages which target the BLOCKCHAIN height (which SHOULD be 1 less than\n+    // the currentHeightManager, but CAN be the same directly following import).\n+    if (ibftMessage.getRoundIdentifier().getSequenceNumber()\n+        <= blockchain.getChainHeadBlockNumber()) {\n+      return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25277ce5b1f82d28a72bbb20958cde2f81d59835"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3d9a61cc1bfe535b2a330ab5f0c016c030b5835", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/a3d9a61cc1bfe535b2a330ab5f0c016c030b5835", "committedDate": "2020-11-19T00:45:04Z", "message": "post review\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f293ab7a834eba9d9c1fc5885afe9fab17fe8fc3", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/f293ab7a834eba9d9c1fc5885afe9fab17fe8fc3", "committedDate": "2020-11-19T00:53:46Z", "message": "fix spotless\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MDE5NTI1", "url": "https://github.com/hyperledger/besu/pull/1575#pullrequestreview-534019525", "createdAt": "2020-11-19T01:49:31Z", "commit": {"oid": "f293ab7a834eba9d9c1fc5885afe9fab17fe8fc3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6155dab7daebbc2e25d76f5db710f1ff83ef64ae", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/6155dab7daebbc2e25d76f5db710f1ff83ef64ae", "committedDate": "2020-11-19T01:50:46Z", "message": "Merge remote-tracking branch 'upstream/master' into ibft_rc_post_import\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6072de2ecd19ec707cd22457972cacee9c88fe2d", "author": {"user": null}, "url": "https://github.com/hyperledger/besu/commit/6072de2ecd19ec707cd22457972cacee9c88fe2d", "committedDate": "2020-11-19T01:54:05Z", "message": "updated changelog\n\nSigned-off-by: Trent Mohay <trent.mohay@consensys.net>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2102, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}