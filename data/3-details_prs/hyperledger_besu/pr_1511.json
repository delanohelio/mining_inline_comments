{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0MjEwMDIy", "number": 1511, "title": "Remove Unnecessary LimitedNewPooledTransactionHashesMessage", "bodyText": "The reason this existed in the first place was only because the author wanted to impact the existing code as little as possible and so copied analogous classes. However, this class didn't make sense in the context of the eth65 changes because there isn't size-in-bytes limiting logic, only an implementaion-specific max-count logic that can easily fit in the sender class. The tests were deleted because we already have coverage of the 4096 batch size in PendingTransactionsMessageSenderTest.", "createdAt": "2020-11-02T17:24:26Z", "url": "https://github.com/hyperledger/besu/pull/1511", "merged": true, "mergeCommit": {"oid": "b325607577ccaecc960ff74247d949c5bdf4530a"}, "closed": true, "closedAt": "2020-11-10T12:42:54Z", "author": {"login": "RatanRSur"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYn1OVgH2gAyNTE0MjEwMDIyOjk3ZDE4Mjg4NDNjZGVkMTIxYmNjZDY1ZDljOGFiODE4ZjRiNTBjZTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABda_Z0OgH2gAyNTE0MjEwMDIyOjUzMmQxZWM3NTk2ODY1ODhlZGI0ZWZkM2Q4ZDFlMzA0OTNhNGVhNzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "97d1828843cded121bccd65d9c8ab818f4b50ce0", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/97d1828843cded121bccd65d9c8ab818f4b50ce0", "committedDate": "2020-11-02T17:15:51Z", "message": "move message size limitation to transaction message sender\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "338e71750e8c9625656a01caff49cef44c9a5c21", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/338e71750e8c9625656a01caff49cef44c9a5c21", "committedDate": "2020-11-02T17:21:12Z", "message": "remove test\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NjkxMTcw", "url": "https://github.com/hyperledger/besu/pull/1511#pullrequestreview-524691170", "createdAt": "2020-11-05T21:35:56Z", "commit": {"oid": "338e71750e8c9625656a01caff49cef44c9a5c21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMTozNTo1NlrOHuXlcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMTozNTo1NlrOHuXlcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM4Mjk2MA==", "bodyText": "I guess this needs to be a constant?", "url": "https://github.com/hyperledger/besu/pull/1511#discussion_r518382960", "createdAt": "2020-11-05T21:35:56Z", "author": {"login": "atoulme"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactionsMessageSender.java", "diffHunk": "@@ -37,16 +37,17 @@ public void sendTransactionsToPeers() {\n   }\n \n   private void sendTransactionsToPeer(final EthPeer peer) {\n-    final Set<Hash> allTxToSend = transactionTracker.claimTransactionsToSendToPeer(peer);\n-    while (!allTxToSend.isEmpty()) {\n-      final LimitedNewPooledTransactionHashesMessages limitedTransactionsMessages =\n-          LimitedNewPooledTransactionHashesMessages.createLimited(allTxToSend);\n-      allTxToSend.removeAll(limitedTransactionsMessages.getIncludedTransactions());\n-      try {\n-        peer.send(limitedTransactionsMessages.getTransactionsMessage());\n-      } catch (final PeerNotConnected e) {\n-        return;\n-      }\n-    }\n+    Iterables.partition(\n+            transactionTracker.claimTransactionsToSendToPeer(peer),\n+            4096 // implementation determined limit for how many hashes to send at once", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "338e71750e8c9625656a01caff49cef44c9a5c21"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NjkzNTk3", "url": "https://github.com/hyperledger/besu/pull/1511#pullrequestreview-524693597", "createdAt": "2020-11-05T21:39:55Z", "commit": {"oid": "338e71750e8c9625656a01caff49cef44c9a5c21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMTozOTo1NVrOHuXtlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMTozOTo1NVrOHuXtlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM4NTA0NQ==", "bodyText": "the original code would return early if the peer was disconnected.\nDo we want to check if the peer is still connected before sending?", "url": "https://github.com/hyperledger/besu/pull/1511#discussion_r518385045", "createdAt": "2020-11-05T21:39:55Z", "author": {"login": "atoulme"}, "path": "ethereum/eth/src/main/java/org/hyperledger/besu/ethereum/eth/transactions/PendingTransactionsMessageSender.java", "diffHunk": "@@ -37,16 +37,17 @@ public void sendTransactionsToPeers() {\n   }\n \n   private void sendTransactionsToPeer(final EthPeer peer) {\n-    final Set<Hash> allTxToSend = transactionTracker.claimTransactionsToSendToPeer(peer);\n-    while (!allTxToSend.isEmpty()) {\n-      final LimitedNewPooledTransactionHashesMessages limitedTransactionsMessages =\n-          LimitedNewPooledTransactionHashesMessages.createLimited(allTxToSend);\n-      allTxToSend.removeAll(limitedTransactionsMessages.getIncludedTransactions());\n-      try {\n-        peer.send(limitedTransactionsMessages.getTransactionsMessage());\n-      } catch (final PeerNotConnected e) {\n-        return;\n-      }\n-    }\n+    Iterables.partition(\n+            transactionTracker.claimTransactionsToSendToPeer(peer),\n+            4096 // implementation determined limit for how many hashes to send at once\n+            )\n+        .forEach(\n+            hashes -> {\n+              try {\n+                peer.send(NewPooledTransactionHashesMessage.create(hashes));\n+              } catch (final PeerNotConnected __) {\n+                // if the peer isn't connected anymore, don't do anything", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "338e71750e8c9625656a01caff49cef44c9a5c21"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NjkzODgz", "url": "https://github.com/hyperledger/besu/pull/1511#pullrequestreview-524693883", "createdAt": "2020-11-05T21:40:22Z", "commit": {"oid": "338e71750e8c9625656a01caff49cef44c9a5c21"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90703303fe87b9c629100df792d9564a239d99a5", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/90703303fe87b9c629100df792d9564a239d99a5", "committedDate": "2020-11-09T14:22:51Z", "message": "early exit\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d762eedb66cb137d4857eb2d9f21a82e1176a60c", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/d762eedb66cb137d4857eb2d9f21a82e1176a60c", "committedDate": "2020-11-09T14:25:08Z", "message": "use constant\n\nSigned-off-by: Ratan Rai Sur <ratan.r.sur@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NTI4MzAz", "url": "https://github.com/hyperledger/besu/pull/1511#pullrequestreview-526528303", "createdAt": "2020-11-09T18:19:12Z", "commit": {"oid": "d762eedb66cb137d4857eb2d9f21a82e1176a60c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "532d1ec759686588edb4efd3d8d1e30493a4ea70", "author": {"user": {"login": "RatanRSur", "name": "Ratan (Rai) Sur"}}, "url": "https://github.com/hyperledger/besu/commit/532d1ec759686588edb4efd3d8d1e30493a4ea70", "committedDate": "2020-11-10T01:51:29Z", "message": "Merge branch 'master' into remove-limited-class"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2053, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}