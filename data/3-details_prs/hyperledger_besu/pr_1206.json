{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2NTY1MDk3", "number": 1206, "title": "Fix #1110: Privacy: Restart caused by insufficient memory can cause inconsistent private state", "bodyText": "Signed-off-by: Stefan Pingel stefan.pingel@consensys.net\nFixed Issue(s)\n#1110", "createdAt": "2020-07-09T01:30:48Z", "url": "https://github.com/hyperledger/besu/pull/1206", "merged": true, "mergeCommit": {"oid": "eb3941976cadc2d14e6f416dd0853df4f415b05e"}, "closed": true, "closedAt": "2020-08-31T04:28:30Z", "author": {"login": "pinges"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczEtZ3AH2gAyNDQ2NTY1MDk3OjA0MDEwMWZkMzAxMjk1NmUyMjgzNmVlMjNjY2RhMTAwMmY4OGU1ZmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEKf97AH2gAyNDQ2NTY1MDk3OjkxODk4ZmMwZjM3ZTQyMDU0ZjBhNWFiZjBkYjI2NmY2MDBmNWJhNDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "040101fd3012956e22836ee23ccda1002f88e5fb", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/040101fd3012956e22836ee23ccda1002f88e5fb", "committedDate": "2020-07-09T01:25:26Z", "message": "Fix #1110: Privacy: Restart caused by insufficient memory can cause inconsistent private state\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb119153d9ccf221a221373d431c2d1612b728d4", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/fb119153d9ccf221a221373d431c2d1612b728d4", "committedDate": "2020-07-09T01:42:59Z", "message": "merge and fix conflicts\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cf16cc3d518c3b6c415490e32fda71731b6f6c2", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/7cf16cc3d518c3b6c415490e32fda71731b6f6c2", "committedDate": "2020-07-09T03:33:20Z", "message": "fix spotless, TODO, and test/resources\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f20be36f5fba178070cf0c8918fc249f624ac36", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/0f20be36f5fba178070cf0c8918fc249f624ac36", "committedDate": "2020-07-09T23:25:38Z", "message": "Merge branch 'master' into reorgBug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NDY3NzYz", "url": "https://github.com/hyperledger/besu/pull/1206#pullrequestreview-448467763", "createdAt": "2020-07-14T21:08:35Z", "commit": {"oid": "0f20be36f5fba178070cf0c8918fc249f624ac36"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQyMTowODozNVrOGxlaJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQyMToyMDozNlrOGxlx5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY0NjMxMQ==", "bodyText": "Should this ever happen? If we have a hash on our PrivacyGroupHeadBlockMap, we should always find the state root for it, should we?\nMaybe this should throw an error.", "url": "https://github.com/hyperledger/besu/pull/1206#discussion_r454646311", "createdAt": "2020-07-14T21:08:35Z", "author": {"login": "lucassaldanha"}, "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/PrivateStateRootResolver.java", "diffHunk": "@@ -33,6 +34,26 @@ public PrivateStateRootResolver(final PrivateStateStorage privateStateStorage) {\n     this.privateStateStorage = privateStateStorage;\n   }\n \n+  public Hash resolveLastStateRoot(\n+      final Bytes32 privacyGroupId, final PrivateMetadataUpdater privateMetadataUpdater) {\n+    final PrivateBlockMetadata privateBlockMetadata =\n+        privateMetadataUpdater.getPrivateBlockMetadata(privacyGroupId);\n+    if (privateBlockMetadata != null) {\n+      return privateBlockMetadata.getLatestStateRoot().get();\n+    } else {\n+      final Hash blockHashForLastBlockWithTx =\n+          privateMetadataUpdater.getPrivacyGroupHeadBlockMap().get(privacyGroupId);\n+      if (blockHashForLastBlockWithTx != null) {\n+        return privateStateStorage\n+            .getPrivateBlockMetadata(blockHashForLastBlockWithTx, privacyGroupId)\n+            .flatMap(PrivateBlockMetadata::getLatestStateRoot)\n+            .orElse(EMPTY_ROOT_HASH);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f20be36f5fba178070cf0c8918fc249f624ac36"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY1MDkwMA==", "bodyText": "I don't think I understand why we need this if statement. Is this because for each new block we need a new PrivateMetadataUpdater, and not reuse a previous one?", "url": "https://github.com/hyperledger/besu/pull/1206#discussion_r454650900", "createdAt": "2020-07-14T21:17:32Z", "author": {"login": "lucassaldanha"}, "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/PrivacyBlockProcessor.java", "diffHunk": "@@ -79,20 +80,23 @@ public Result processBlock(\n       final MutableWorldState worldState,\n       final BlockHeader blockHeader,\n       final List<Transaction> transactions,\n-      final List<BlockHeader> ommers) {\n+      final List<BlockHeader> ommers,\n+      final PrivateMetadataUpdater privateMetadataUpdater) {\n+\n+    if (privateMetadataUpdater != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f20be36f5fba178070cf0c8918fc249f624ac36"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDY1MjM5MQ==", "bodyText": "At this point, has Besu already commit the changes in public world state?", "url": "https://github.com/hyperledger/besu/pull/1206#discussion_r454652391", "createdAt": "2020-07-14T21:20:36Z", "author": {"login": "lucassaldanha"}, "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/PrivacyBlockProcessor.java", "diffHunk": "@@ -79,20 +80,23 @@ public Result processBlock(\n       final MutableWorldState worldState,\n       final BlockHeader blockHeader,\n       final List<Transaction> transactions,\n-      final List<BlockHeader> ommers) {\n+      final List<BlockHeader> ommers,\n+      final PrivateMetadataUpdater privateMetadataUpdater) {\n+\n+    if (privateMetadataUpdater != null) {\n+      throw new IllegalArgumentException(\"PrivateMetadataUpdater passed in is not null.\");\n+    }\n \n     maybeRehydrate(blockchain, blockHeader, transactions);\n \n-    final PrivacyGroupHeadBlockMap privacyGroupHeadBlockMap =\n-        new PrivacyGroupHeadBlockMap(\n-            privateStateStorage\n-                .getPrivacyGroupHeadBlockMap(blockHeader.getParentHash())\n-                .orElse(PrivacyGroupHeadBlockMap.EMPTY));\n-    privateStateStorage\n-        .updater()\n-        .putPrivacyGroupHeadBlockMap(blockHeader.getHash(), privacyGroupHeadBlockMap)\n-        .commit();\n-    return blockProcessor.processBlock(blockchain, worldState, blockHeader, transactions, ommers);\n+    final PrivateMetadataUpdater metadataUpdater =\n+        new PrivateMetadataUpdater(blockHeader, privateStateStorage);\n+\n+    final Result result =\n+        blockProcessor.processBlock(\n+            blockchain, worldState, blockHeader, transactions, ommers, metadataUpdater);\n+    metadataUpdater.commit();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f20be36f5fba178070cf0c8918fc249f624ac36"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c861fd61e22453a92faead70b75a1fb35d6af711", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/c861fd61e22453a92faead70b75a1fb35d6af711", "committedDate": "2020-07-14T22:51:13Z", "message": "Merge branch 'master' of github.com:hyperledger/besu into reorgBug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "842d29367de124f89bb7547b4209177002663107", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/842d29367de124f89bb7547b4209177002663107", "committedDate": "2020-07-15T02:33:53Z", "message": "fix after review\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "601b4361d77c0413c6ba9747aab985446f7e7177", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/601b4361d77c0413c6ba9747aab985446f7e7177", "committedDate": "2020-07-16T02:45:48Z", "message": "fix unit test\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a05dc59d6e34efc396f1de7c3c460c35b42cab8a", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/a05dc59d6e34efc396f1de7c3c460c35b42cab8a", "committedDate": "2020-07-16T03:51:40Z", "message": "Merge branch 'master' into reorgBug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32fbfcc5284dd9c6e31fa185688660e2dae4498d", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/32fbfcc5284dd9c6e31fa185688660e2dae4498d", "committedDate": "2020-08-31T00:53:28Z", "message": "merge into master\n\nSigned-off-by: Stefan Pingel <stefan.pingel@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca7856f3886acedf0db0c1beffa0abc5bd695bff", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/ca7856f3886acedf0db0c1beffa0abc5bd695bff", "committedDate": "2020-08-31T00:54:03Z", "message": "Merge branch 'master' of github.com:hyperledger/besu into reorgBug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cda381d2e23198d4b502d9d6ba67bb820f6f235e", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/cda381d2e23198d4b502d9d6ba67bb820f6f235e", "committedDate": "2020-08-31T00:55:22Z", "message": "Merge branch 'reorgBug' of github.com:pinges/besu into reorgBug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91898fc0f37e42054f0a5abf0db266f600f5ba41", "author": {"user": {"login": "pinges", "name": "Stefan Pingel"}}, "url": "https://github.com/hyperledger/besu/commit/91898fc0f37e42054f0a5abf0db266f600f5ba41", "committedDate": "2020-08-31T03:46:54Z", "message": "Merge branch 'master' into reorgBug"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1514, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}