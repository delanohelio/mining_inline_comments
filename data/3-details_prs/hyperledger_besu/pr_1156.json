{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwNjIxMzgw", "number": 1156, "title": "Add cluster ip for Kubernetes Nat Manager", "bodyText": "Signed-off-by: Karim TAAM karim.t2am@gmail.com\nPR description\nKubernetes nat manager could work with LoadBalancer services. This PR add compatibility with ClusterIP services.\nA code refactor was made in order to facilitate the addition of new services thereafter such as the NodePort\nSample of ClusterIP service :\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app.kubernetes.io/name: besu\n    app.kubernetes.io/release: \"1.0.0\"\n  name: besu\nspec:\n  ports:\n  - name: \"json-rpc\"\n    port: 8546\n    targetPort: 8545\n  - name: \"rlpx\"\n    port: 30303\n    targetPort: 30303\n  selector:\n    app.kubernetes.io/name: besu\n    app.kubernetes.io/release: \"1.0.0\"\n  type: ClusterIP\n\nYou can find the IP that will be used by BESU by launching the following command\n\nkubectl describe services besu\n\nName:              besu\nNamespace:         default\nLabels:            app.kubernetes.io/name=besu\n                   app.kubernetes.io/release=1.0.0\nAnnotations:       kubectl.kubernetes.io/last-applied-configuration:\n                     {\"apiVersion\":\"v1\",\"kind\":\"Service\",\"metadata\":{\"annotations\":{},\"labels\":{\"app.kubernetes.io/name\":\"besu\",\"app.kubernetes.io/release\":\"1....\nSelector:          app.kubernetes.io/name=besu,app.kubernetes.io/release=1.0.0\nType:              ClusterIP\nIP:                **<IP USED BY KUBERNETES NAT MANAGER>**\nPort:              json-rpc  8546/TCP\nTargetPort:        8545/TCP\nEndpoints:         <none>\nPort:              rlpx  30303/TCP\nTargetPort:        30303/TCP\nEndpoints:         <none>\nSession Affinity:  None\nEvents:            <none>\n\nUpdate of the fallback mechanism\n\n\nIf the nat-method is equal to AUTO (default). A bad configuration (invalid service, ingress not found, etc.) will cause a switch to the NONE mode.\n\n\nIf the nat-method is equal to KUBERNETES and Xnat-method-fallback-enabled is equal to true. A bad configuration will cause a switch to the NONE mode.\n\n\nIf the nat-method is equal to KUBERNETES and Xnat-method-fallback-enabledis equal to false. A bad configuration will cause a stop of BESU in order to indicate to him that the automatic configuration has failed\n\n\nNew error message added\nIf you are trying to use not implemented service you will now have an issue :\n\nFailed update information using pod metadata : NodePort is not implemented.\n\nTested\n\n\n\nTest\nResult expected\n\n\n\n\n\nDeploy with a ClusterIP\nWork\nOK\n\n\nDeploy with a LoadBalancer\nWork\nOK\n\n\nDeploy with a NodePort   (AUTO)\nThrow an exception and switch to NONE\nOK\n\n\nDeploy with a Missing service  (AUTO)\nThrow an exception and switch to NONE\nOK\n\n\nDeploy without fallback (KUBERNETES  and fallback=false)\nStop besu with an exception\nOK\n\n\nDeploy without fallback (KUBERNETES  and fallback=true)\nThrow an exception and switch to NONE\nOK\n\n\n\nFixed Issue(s)", "createdAt": "2020-06-26T14:35:15Z", "url": "https://github.com/hyperledger/besu/pull/1156", "merged": true, "mergeCommit": {"oid": "50db46f855980a48c1d3c115f52ab254a5d668c8"}, "closed": true, "closedAt": "2020-07-01T17:21:52Z", "author": {"login": "matkt"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvD0-XAH2gAyNDQwNjIxMzgwOjBkZTNlYmViNDBiZmU0NWUwODA0YmJiNWQ2NTliZGM3YzdkYWI0MzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwtGFKgH2gAyNDQwNjIxMzgwOjQzMjI5OTFhNDgyNzkyYWQ1NGY0MDIwODBiMWM0YmEyYjRkNDAxMGQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0de3ebeb40bfe45e0804bbb5d659bdc7c7dab430", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/0de3ebeb40bfe45e0804bbb5d659bdc7c7dab430", "committedDate": "2020-06-26T14:08:06Z", "message": "add cluster ip for nat manager\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53387c169c72b5ffb2b545cebbf971b4376a8320", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/53387c169c72b5ffb2b545cebbf971b4376a8320", "committedDate": "2020-06-26T14:43:43Z", "message": "Merge branch 'upstream/master' into feature/cluster-ip-for-nat-manager\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NDI5NzQ4", "url": "https://github.com/hyperledger/besu/pull/1156#pullrequestreview-438429748", "createdAt": "2020-06-26T16:23:12Z", "commit": {"oid": "53387c169c72b5ffb2b545cebbf971b4376a8320"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxNjoyMzoxM1rOGpm_Mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxNjoyOTozNFrOGpnL2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI4MzU3MQ==", "bodyText": "Don't use String.format, use standard logging placeholder instead.", "url": "https://github.com/hyperledger/besu/pull/1156#discussion_r446283571", "createdAt": "2020-06-26T16:23:13Z", "author": {"login": "abdelhamidbakhta"}, "path": "nat/src/main/java/org/hyperledger/besu/nat/NatService.java", "diffHunk": "@@ -88,10 +96,14 @@ public void start() {\n         getNatManager().orElseThrow().start();\n       } catch (Exception e) {\n         LOG.debug(\n-            \"Nat manager failed to configure itself automatically due to the following reason \"\n-                + e.getMessage()\n-                + \". NONE mode will be used\");\n-        disableNatManager();\n+            String.format(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53387c169c72b5ffb2b545cebbf971b4376a8320"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI4NTEzNg==", "bodyText": "Not worth creating a class for such a simple implementation IMO. You can inject the code as a lambda directly.", "url": "https://github.com/hyperledger/besu/pull/1156#discussion_r446285136", "createdAt": "2020-06-26T16:26:16Z", "author": {"login": "abdelhamidbakhta"}, "path": "nat/src/main/java/org/hyperledger/besu/nat/kubernetes/service/ClusterIpBasedDetector.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright ConsenSys AG.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on\n+ * an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ *\n+ * SPDX-License-Identifier: Apache-2.0\n+ */\n+package org.hyperledger.besu.nat.kubernetes.service;\n+\n+import org.hyperledger.besu.nat.core.IpDetector;\n+\n+import java.util.Optional;\n+\n+import io.kubernetes.client.models.V1Service;\n+\n+public class ClusterIpBasedDetector implements IpDetector {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53387c169c72b5ffb2b545cebbf971b4376a8320"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI4NTMxNQ==", "bodyText": "Return a lambda instead IMO", "url": "https://github.com/hyperledger/besu/pull/1156#discussion_r446285315", "createdAt": "2020-06-26T16:26:35Z", "author": {"login": "abdelhamidbakhta"}, "path": "nat/src/main/java/org/hyperledger/besu/nat/kubernetes/KubernetesNatManager.java", "diffHunk": "@@ -152,4 +144,16 @@ protected void doStop() {\n   public CompletableFuture<List<NatPortMapping>> getPortMappings() {\n     return CompletableFuture.completedFuture(forwardedPorts);\n   }\n+\n+  private IpDetector getIpDetector(final V1Service v1Service) throws NatInitializationException {\n+    final String serviceType = v1Service.getSpec().getType();\n+    switch (KubernetesServiceType.fromName(serviceType)) {\n+      case CLUSTER_IP:\n+        return new ClusterIpBasedDetector(v1Service);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53387c169c72b5ffb2b545cebbf971b4376a8320"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI4NjY1Mw==", "bodyText": "Use assertThatThrownBy instead.\nExample here: \n  \n    \n      besu/besu/src/test/java/org/hyperledger/besu/chainexport/RlpBlockExporterTest.java\n    \n    \n         Line 213\n      in\n      71f2872\n    \n    \n    \n    \n\n        \n          \n           assertThatThrownBy(() -> exporter.exportBlocks(outputPath, Optional.of(-1L), Optional.empty()))", "url": "https://github.com/hyperledger/besu/pull/1156#discussion_r446286653", "createdAt": "2020-06-26T16:29:17Z", "author": {"login": "abdelhamidbakhta"}, "path": "nat/src/test/java/org/hyperledger/besu/nat/NatServiceTest.java", "diffHunk": "@@ -197,6 +197,24 @@ public void assertThatManagerSwitchToNoneForInvalidNatEnvironment()\n     assertThat(natService.queryLocalIPAddress(fallbackLocalIp)).isEqualTo(fallbackLocalIp);\n   }\n \n+  @Test(expected = RuntimeException.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53387c169c72b5ffb2b545cebbf971b4376a8320"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI4NjgwOA==", "bodyText": "final ?", "url": "https://github.com/hyperledger/besu/pull/1156#discussion_r446286808", "createdAt": "2020-06-26T16:29:34Z", "author": {"login": "abdelhamidbakhta"}, "path": "nat/src/test/java/org/hyperledger/besu/nat/docker/DockerNatManagerTest.java", "diffHunk": "@@ -61,7 +63,14 @@ public void assertThatExternalIPIsEqualToRemoteHost()\n   @Test\n   public void assertThatExternalIPIsEqualToDefaultHostIfIpDetectorCannotRetrieveIP()\n       throws ExecutionException, InterruptedException {\n-    when(hostBasedIpDetector.detectExternalIp()).thenReturn(Optional.empty());\n+    NatManager natManager =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53387c169c72b5ffb2b545cebbf971b4376a8320"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02a9b1bc1c548f2c2ecac3ba2649f9c8c79b0a34", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/02a9b1bc1c548f2c2ecac3ba2649f9c8c79b0a34", "committedDate": "2020-06-26T16:45:02Z", "message": "fix review issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NDQ4MjA5", "url": "https://github.com/hyperledger/besu/pull/1156#pullrequestreview-438448209", "createdAt": "2020-06-26T16:50:34Z", "commit": {"oid": "53387c169c72b5ffb2b545cebbf971b4376a8320"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1db8b0a94737fb99c71d5459d297d9e92af0e4f4", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/1db8b0a94737fb99c71d5459d297d9e92af0e4f4", "committedDate": "2020-06-29T08:10:04Z", "message": "Merge branch 'upstream/master' into feature/cluster-ip-for-nat-manager\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90eecea52f2920181a280908f0f877dddce55cf5", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/90eecea52f2920181a280908f0f877dddce55cf5", "committedDate": "2020-07-01T12:16:26Z", "message": "change Xnat-kube-pod-name to Xnat-kube-service-name\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e9e56b8bd8c2fe53f3b41113f16d04d1964a03d", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/3e9e56b8bd8c2fe53f3b41113f16d04d1964a03d", "committedDate": "2020-07-01T12:19:05Z", "message": "Merge commit 'master' into feature/cluster-ip-for-nat-manager\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwODE3NDQ5", "url": "https://github.com/hyperledger/besu/pull/1156#pullrequestreview-440817449", "createdAt": "2020-07-01T12:21:30Z", "commit": {"oid": "3e9e56b8bd8c2fe53f3b41113f16d04d1964a03d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fb0de10d0b6fe2181edb35ed2f4f40e51c0ede5", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/2fb0de10d0b6fe2181edb35ed2f4f40e51c0ede5", "committedDate": "2020-07-01T12:41:58Z", "message": "fix test\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a60dae78dd54db69b275e16f6f1dfdcf05bcd47", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/8a60dae78dd54db69b275e16f6f1dfdcf05bcd47", "committedDate": "2020-07-01T15:53:34Z", "message": "add flag for the nat method fallback mechanism\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwOTk5NzY1", "url": "https://github.com/hyperledger/besu/pull/1156#pullrequestreview-440999765", "createdAt": "2020-07-01T15:55:51Z", "commit": {"oid": "8a60dae78dd54db69b275e16f6f1dfdcf05bcd47"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4322991a482792ad54f402080b1c4ba2b4d4010d", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/4322991a482792ad54f402080b1c4ba2b4d4010d", "committedDate": "2020-07-01T16:46:49Z", "message": "fix typo\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1504, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}