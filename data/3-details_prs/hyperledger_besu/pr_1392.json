{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxODk3OTE5", "number": 1392, "title": "Add debug_standardTraceBlockToFile JSON RPC method", "bodyText": "Signed-off-by: Karim TAAM karim.t2am@gmail.com\nPR description\nAdd debug_standardTraceBlockToFile JSON RPC API. This API accepts a block hash and will replay the block. It returns a list of files containing the result of the trace (one file per transaction). The files are stored in the machine that serves this API.\nRequest\n\nIf you want a specific transaction in a block\n\n{\n    \"jsonrpc\": \"2.0\",\n    \"method\": \"debug_standardTraceBlockToFile\",\n    \"params\": [\"0x346bf832874407208006572fd779be5a6a6e0022be76f21a27a2c88b65b0c323\", {\n        \"txHash\": \"0xaa190c4ed5375ce3577e6212357671ab0aca47dd8c517c177844bf84b4b5c261\",\n        \"disableMemory\": false\n    }],\n    \"id\": 1\n}\n\nIf you want all transactions of a block\n\n{\n    \"jsonrpc\": \"2.0\",\n    \"method\": \"debug_standardTraceBlockToFile\",\n    \"params\": [\"0x346bf832874407208006572fd779be5a6a6e0022be76f21a27a2c88b65b0c323\"],\n    \"id\": 1\n}\n\nIf you want disableMemory == false (default is true)\n\n{\n    \"jsonrpc\": \"2.0\",\n    \"method\": \"debug_standardTraceBlockToFile\",\n    \"params\": [\"0x346bf832874407208006572fd779be5a6a6e0022be76f21a27a2c88b65b0c323\", {\n        \"txHash\": \"0xaa190c4ed5375ce3577e6212357671ab0aca47dd8c517c177844bf84b4b5c261\",\n        \"disableMemory\": false\n    }],\n    \"id\": 1\n}\nResponse\n{\n    \"jsonrpc\": \"2.0\",\n    \"id\": 1,\n    \"result\": [\n        \"/Users/johndoe/private-network/Clique-Network/Node-1/data/traces/block_0x346bf832-0-0x407ec43d-1600951088172\"\n    ]\n}\nChangelog\n\n I thought about the changelog and included a changelog update if required.", "createdAt": "2020-09-23T16:24:35Z", "url": "https://github.com/hyperledger/besu/pull/1392", "merged": true, "mergeCommit": {"oid": "6034b89b54cf2797ba9a3d0e86ca157e6709bb38"}, "closed": true, "closedAt": "2020-09-28T17:06:50Z", "author": {"login": "matkt"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLvB7ngH2gAyNDkxODk3OTE5OmJjYmI4NGU2M2VhNmQwODc2ODcwZmI2MjNhMmE1MTUxMzg1ZWMwNmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNWe41AH2gAyNDkxODk3OTE5Ojc5OTY3NGZjNTQ1Y2VjNDhmMWE1NTBlZTA0YzgyOWU5MWEwNjExMmE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bcbb84e63ea6d0876870fb623a2a5151385ec06d", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/bcbb84e63ea6d0876870fb623a2a5151385ec06d", "committedDate": "2020-09-23T16:18:03Z", "message": "add debug_standardTraceBlockToFile JSON RPC method\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d332694f46ca845b0d8476d3066d809c8398df65", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/d332694f46ca845b0d8476d3066d809c8398df65", "committedDate": "2020-09-23T16:36:57Z", "message": "update CHANGELOG.md\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdba868a6b418c078bf3ad6240169139d03bfe95", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/bdba868a6b418c078bf3ad6240169139d03bfe95", "committedDate": "2020-09-23T16:37:33Z", "message": "Merge branch 'master' into feature/add-standard-trace-block-to-file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0ODQ5MTc5", "url": "https://github.com/hyperledger/besu/pull/1392#pullrequestreview-494849179", "createdAt": "2020-09-23T16:39:07Z", "commit": {"oid": "bdba868a6b418c078bf3ad6240169139d03bfe95"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNjozOTowN1rOHW3Opw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNjozOTowN1rOHW3Opw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzczNTU5MQ==", "bodyText": "Since it's been moved out of EVM tool perhaps a different name, StandardJsonTracer?", "url": "https://github.com/hyperledger/besu/pull/1392#discussion_r493735591", "createdAt": "2020-09-23T16:39:07Z", "author": {"login": "shemnon"}, "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/vm/EVMToolTracer.java", "diffHunk": "@@ -34,30 +32,42 @@\n import org.apache.tuweni.bytes.Bytes;\n import org.apache.tuweni.units.bigints.UInt256;\n \n-class EVMToolTracer implements OperationTracer {\n+public class EVMToolTracer implements OperationTracer {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdba868a6b418c078bf3ad6240169139d03bfe95"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0ODUzOTY4", "url": "https://github.com/hyperledger/besu/pull/1392#pullrequestreview-494853968", "createdAt": "2020-09-23T16:45:07Z", "commit": {"oid": "bdba868a6b418c078bf3ad6240169139d03bfe95"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNjo0NTowN1rOHW3dZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNjo0ODo1NlrOHW3mIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzczOTM2Nw==", "bodyText": "Use standard getter/setters", "url": "https://github.com/hyperledger/besu/pull/1392#discussion_r493739367", "createdAt": "2020-09-23T16:45:07Z", "author": {"login": "shemnon"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/parameters/TransactionTraceParams.java", "diffHunk": "@@ -14,30 +14,53 @@\n  */\n package org.hyperledger.besu.ethereum.api.jsonrpc.internal.parameters;\n \n+import org.hyperledger.besu.ethereum.core.Hash;\n import org.hyperledger.besu.ethereum.debug.TraceOptions;\n \n-import com.fasterxml.jackson.annotation.JsonCreator;\n+import java.util.Optional;\n+import javax.annotation.Nullable;\n+\n import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import org.immutables.value.Value;\n \n+@Value.Immutable\n+@JsonSerialize(as = ImmutableTransactionTraceParams.class)\n+@JsonDeserialize(as = ImmutableTransactionTraceParams.class)\n @JsonIgnoreProperties(ignoreUnknown = true)\n-public class TransactionTraceParams {\n-\n-  private final boolean disableStorage;\n-  private final boolean disableMemory;\n-  private final boolean disableStack;\n-\n-  @JsonCreator()\n-  public TransactionTraceParams(\n-      @JsonProperty(\"disableStorage\") final boolean disableStorage,\n-      @JsonProperty(\"disableMemory\") final boolean disableMemory,\n-      @JsonProperty(\"disableStack\") final boolean disableStack) {\n-    this.disableStorage = disableStorage;\n-    this.disableMemory = disableMemory;\n-    this.disableStack = disableStack;\n+public interface TransactionTraceParams {\n+\n+  @JsonProperty(\"txHash\")\n+  @Nullable\n+  String transactionHash();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdba868a6b418c078bf3ad6240169139d03bfe95"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzczOTY4NQ==", "bodyText": "This will need to be renamed, or dropped.", "url": "https://github.com/hyperledger/besu/pull/1392#discussion_r493739685", "createdAt": "2020-09-23T16:45:38Z", "author": {"login": "shemnon"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/parameters/TransactionTraceParams.java", "diffHunk": "@@ -14,30 +14,53 @@\n  */\n package org.hyperledger.besu.ethereum.api.jsonrpc.internal.parameters;\n \n+import org.hyperledger.besu.ethereum.core.Hash;\n import org.hyperledger.besu.ethereum.debug.TraceOptions;\n \n-import com.fasterxml.jackson.annotation.JsonCreator;\n+import java.util.Optional;\n+import javax.annotation.Nullable;\n+\n import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import org.immutables.value.Value;\n \n+@Value.Immutable\n+@JsonSerialize(as = ImmutableTransactionTraceParams.class)\n+@JsonDeserialize(as = ImmutableTransactionTraceParams.class)\n @JsonIgnoreProperties(ignoreUnknown = true)\n-public class TransactionTraceParams {\n-\n-  private final boolean disableStorage;\n-  private final boolean disableMemory;\n-  private final boolean disableStack;\n-\n-  @JsonCreator()\n-  public TransactionTraceParams(\n-      @JsonProperty(\"disableStorage\") final boolean disableStorage,\n-      @JsonProperty(\"disableMemory\") final boolean disableMemory,\n-      @JsonProperty(\"disableStack\") final boolean disableStack) {\n-    this.disableStorage = disableStorage;\n-    this.disableMemory = disableMemory;\n-    this.disableStack = disableStack;\n+public interface TransactionTraceParams {\n+\n+  @JsonProperty(\"txHash\")\n+  @Nullable\n+  String transactionHash();\n+\n+  @JsonProperty(value = \"disableStorage\")\n+  @Value.Default\n+  default boolean disableStorage() {\n+    return false;\n+  }\n+\n+  @JsonProperty(value = \"disableMemory\")\n+  @Value.Default\n+  default boolean disableMemory() {\n+    return false;\n+  }\n+\n+  @JsonProperty(value = \"disableStack\")\n+  @Value.Default\n+  default boolean disableStack() {\n+    return false;\n+  }\n+\n+  default TraceOptions traceOptions() {\n+    return new TraceOptions(!disableStorage(), !disableMemory(), !disableStack());\n   }\n \n-  public TraceOptions traceOptions() {\n-    return new TraceOptions(!disableStorage, !disableMemory, !disableStack);\n+  default Optional<Hash> getTransactionHash() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdba868a6b418c078bf3ad6240169139d03bfe95"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzc0MTYwMg==", "bodyText": "Do we want these going to tmp?  perhaps our data root under traces?", "url": "https://github.com/hyperledger/besu/pull/1392#discussion_r493741602", "createdAt": "2020-09-23T16:48:56Z", "author": {"login": "shemnon"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/processor/TransactionTracer.java", "diffHunk": "@@ -46,7 +61,71 @@ public TransactionTracer(final BlockReplay blockReplay) {\n                   tracer,\n                   new BlockHashLookup(header, blockchain),\n                   false);\n-          return new TransactionTrace(transaction, result, tracer.getTraceFrames());\n+          timer.stop();\n+          return new TransactionTrace(\n+              transaction, result, tracer.getTraceFrames(), timer.elapsed(TimeUnit.NANOSECONDS));\n+        });\n+  }\n+\n+  public Optional<TransactionTrace> traceTransaction(\n+      final Hash blockHash, final Hash transactionHash, final EVMToolTracer tracer) {\n+    return blockReplay.beforeTransactionInBlock(\n+        blockHash,\n+        transactionHash,\n+        (transaction, header, blockchain, mutableWorldState, transactionProcessor) -> {\n+          final Stopwatch timer = Stopwatch.createStarted();\n+          final Result result =\n+              transactionProcessor.processTransaction(\n+                  blockchain,\n+                  mutableWorldState.updater(),\n+                  header,\n+                  transaction,\n+                  header.getCoinbase(),\n+                  tracer,\n+                  new BlockHashLookup(header, blockchain),\n+                  false,\n+                  new TransactionValidationParams.Builder().allowFutureNonce(true).build());\n+\n+          timer.stop();\n+          return new TransactionTrace(\n+              transaction, result, new ArrayList<>(), timer.elapsed(TimeUnit.NANOSECONDS));\n         });\n   }\n+\n+  public List<String> traceTransactionToFile(\n+      final Hash blockHash,\n+      final List<Transaction> transactions,\n+      final Optional<TransactionTraceParams> transactionTraceParams) {\n+    final List<String> traces = new ArrayList<>();\n+    try {\n+      final Optional<Hash> selectedHash =\n+          transactionTraceParams.flatMap(TransactionTraceParams::getTransactionHash);\n+      final boolean showMemory =\n+          transactionTraceParams.map(TransactionTraceParams::disableMemory).orElse(true);\n+      for (int i = 0; i < transactions.size(); i++) {\n+        final Transaction transaction = transactions.get(i);\n+        if (selectedHash.isEmpty()\n+            || selectedHash.filter(isEqual(transaction.getHash())).isPresent()) {\n+          final File tmpFile =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdba868a6b418c078bf3ad6240169139d03bfe95"}, "originalPosition": 85}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50255af8e93df0aaac67ddee16548f79ac68265d", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/50255af8e93df0aaac67ddee16548f79ac68265d", "committedDate": "2020-09-24T12:46:54Z", "message": "fix review issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38046dacf9fca384ca33b81c2102936342ab6ae9", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/38046dacf9fca384ca33b81c2102936342ab6ae9", "committedDate": "2020-09-24T12:47:21Z", "message": "fix review issues\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c45752e92d40607de595998a9789770a9fdf9663", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/c45752e92d40607de595998a9789770a9fdf9663", "committedDate": "2020-09-24T12:51:16Z", "message": "Merge branch 'master' into feature/add-standard-trace-block-to-file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9742da8f3986a511b32a1be23f969b8fbb1581b6", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/9742da8f3986a511b32a1be23f969b8fbb1581b6", "committedDate": "2020-09-24T14:12:10Z", "message": "fix pipeline\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76cbd6300b8ccf881077ce85463a7d9239168258", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/76cbd6300b8ccf881077ce85463a7d9239168258", "committedDate": "2020-09-25T12:04:04Z", "message": "Merge branch 'master' into feature/add-standard-trace-block-to-file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2309566343460edeb19f2606299bbcdbe6500f03", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/2309566343460edeb19f2606299bbcdbe6500f03", "committedDate": "2020-09-28T09:22:20Z", "message": "Merge branch 'master' into feature/add-standard-trace-block-to-file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NjEwMDM0", "url": "https://github.com/hyperledger/besu/pull/1392#pullrequestreview-497610034", "createdAt": "2020-09-28T14:50:16Z", "commit": {"oid": "2309566343460edeb19f2606299bbcdbe6500f03"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNDo1MDoxNlrOHZBV1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNDo1MDoxNlrOHZBV1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk5ODQyMQ==", "bodyText": "This should be moved to the 1.6.0-RC1 section once merged.", "url": "https://github.com/hyperledger/besu/pull/1392#discussion_r495998421", "createdAt": "2020-09-28T14:50:16Z", "author": {"login": "shemnon"}, "path": "CHANGELOG.md", "diffHunk": "@@ -4,6 +4,7 @@\n \n ### Additions and Improvements\n * The new version of the [web3js-eea library (v0.10)](https://github.com/PegaSysEng/web3js-eea) supports the onchain privacy group management changes made in Besu v1.5.3.     \n+* Added `debug_standardTraceBlockToFile` JSON-RPC API. This API accepts a block hash and will replay the block. It returns a list of files containing the result of the trace (one file per transaction). [\\#1392](https://github.com/hyperledger/besu/pull/1392)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2309566343460edeb19f2606299bbcdbe6500f03"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4cffef63b52a3a3fd54e1a35bdca16389d19fe9", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/b4cffef63b52a3a3fd54e1a35bdca16389d19fe9", "committedDate": "2020-09-28T16:43:51Z", "message": "update CHANGELOG.md\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "799674fc545cec48f1a550ee04c829e91a06112a", "author": {"user": {"login": "matkt", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/799674fc545cec48f1a550ee04c829e91a06112a", "committedDate": "2020-09-28T16:49:54Z", "message": "Merge branch 'upstream/master' into feature/add-standard-trace-block-to-file\n\nSigned-off-by: Karim TAAM <karim.t2am@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2163, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}