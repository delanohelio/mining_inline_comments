{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2NDg0ODM4", "number": 1298, "title": "Private Log Filters track enclavePublicKey and are removed when user removed from group", "bodyText": "PR description\nWhen multi-tenancy and removing user from onchain privacy group, send an event which is processed by the FilterManager, which triggers removal of any private log filters created by that user in that privacy group.\nFixed Issue(s)\nSee #883\nChangelog\n\n I thought about the changelog and included a changelog update if required.\nNo changelog required since this is part of a larger feature", "createdAt": "2020-08-12T03:32:07Z", "url": "https://github.com/hyperledger/besu/pull/1298", "merged": true, "mergeCommit": {"oid": "b66d2e67bf45ee2acd974560ab85e4abb0380ade"}, "closed": true, "closedAt": "2020-08-21T05:09:23Z", "author": {"login": "macfarla"}, "timelineItems": {"totalCount": 34, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-AKmhAH2gAyNDY2NDg0ODM4OjEyMzVhYzk5N2VjOTY4NzczMDg3Y2E5YWMyZWE1NGU5MjZhYmJlYWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdA9QupgFqTQ3MjEzOTc3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1235ac997ec968773087ca9ac2ea54e926abbeaf", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/1235ac997ec968773087ca9ac2ea54e926abbeaf", "committedDate": "2020-08-12T00:20:58Z", "message": "added isRemovalTransaction\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "419bda72b5139abca26d0082f3c37476ffce2c75", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/419bda72b5139abca26d0082f3c37476ffce2c75", "committedDate": "2020-08-12T00:21:07Z", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into multi-tenancy-onchain-remove-filter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41945326c2e37c3b35087701cb712c4c5a8541d1", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/41945326c2e37c3b35087701cb712c4c5a8541d1", "committedDate": "2020-08-12T02:45:40Z", "message": "draft of processing Private Tx Event\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "deebbfafaa649ddbaf66e219331a83305b967834", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/deebbfafaa649ddbaf66e219331a83305b967834", "committedDate": "2020-08-12T02:47:23Z", "message": "typo\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edf27661e33b7fae3127c3af6593fc8a2e2e1e4a", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/edf27661e33b7fae3127c3af6593fc8a2e2e1e4a", "committedDate": "2020-08-12T03:13:09Z", "message": "added enclavePublicKey to private log filter\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "671385b07b191961e16e8283d14420872fa075a4", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/671385b07b191961e16e8283d14420872fa075a4", "committedDate": "2020-08-12T03:28:46Z", "message": "draft removal event\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da085c87f4cda191cde903b73db7fc561f24f071", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/da085c87f4cda191cde903b73db7fc561f24f071", "committedDate": "2020-08-12T03:36:47Z", "message": "final params\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NTk4Njk3", "url": "https://github.com/hyperledger/besu/pull/1298#pullrequestreview-465598697", "createdAt": "2020-08-12T05:22:55Z", "commit": {"oid": "da085c87f4cda191cde903b73db7fc561f24f071"}, "state": "DISMISSED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNToyMjo1NlrOG_SMmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNToyODoxOVrOG_SSfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxMTYwOQ==", "bodyText": "I think we need to check if the user is a member of the group before creating the private filter. Otherwise, an ex-member will be able to install the filter. And because they have already been removed, we will never have a removedEvent to destroy their filter.", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r469011609", "createdAt": "2020-08-12T05:22:56Z", "author": {"login": "lucassaldanha"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/privacy/methods/priv/PrivNewFilter.java", "diffHunk": "@@ -50,23 +50,27 @@ public String getName() {\n   public JsonRpcResponse response(final JsonRpcRequestContext request) {\n     final String privacyGroupId = request.getRequiredParameter(0, String.class);\n     final FilterParameter filter = request.getRequiredParameter(1, FilterParameter.class);\n+    final String enclavePublicKey = enclavePublicKeyProvider.getEnclaveKey(request.getUser());\n \n-    checkIfPrivacyGroupMatchesAuthenticatedEnclaveKey(request, privacyGroupId);\n+    checkIfPrivacyGroupMatchesAuthenticatedEnclaveKey(enclavePublicKey, privacyGroupId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da085c87f4cda191cde903b73db7fc561f24f071"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxMjU5Ng==", "bodyText": "Why do we need this method here? Maybe we should add it to the PrivateTransaction class itself? Or to an OnchainPrivateTransactionUtil kind of class.", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r469012596", "createdAt": "2020-08-12T05:26:22Z", "author": {"login": "lucassaldanha"}, "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/DefaultPrivacyController.java", "diffHunk": "@@ -414,6 +415,16 @@ public boolean isGroupAdditionTransaction(final PrivateTransaction privateTransa\n             .startsWith(ADD_TO_GROUP_METHOD_SIGNATURE.toHexString());\n   }\n \n+  @Override\n+  public boolean isGroupRemovalTransaction(final PrivateTransaction privateTransaction) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da085c87f4cda191cde903b73db7fc561f24f071"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAxMzExOQ==", "bodyText": "We can't do this here, it is too early in the private tx lifecycle. We need to send the event when the transaction is processed as part of the block import.\nBasically, only after we know the tx has been successfully processed we can send the event.", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r469013119", "createdAt": "2020-08-12T05:28:19Z", "author": {"login": "lucassaldanha"}, "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/privacy/MultiTenancyPrivacyController.java", "diffHunk": "@@ -72,8 +72,19 @@ public String sendTransaction(\n       verifyPrivacyGroupContainsEnclavePublicKey(\n           privateTransaction.getPrivacyGroupId().get().toBase64String(), enclavePublicKey);\n     }\n-    return privacyController.sendTransaction(\n-        privateTransaction, enclavePublicKey, maybePrivacyGroup);\n+\n+    final String transactionResult =\n+        privacyController.sendTransaction(privateTransaction, enclavePublicKey, maybePrivacyGroup);\n+\n+    if (isGroupRemovalTransaction(privateTransaction)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da085c87f4cda191cde903b73db7fc561f24f071"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "553f7bbadfa582eaf13a27204e7912c785e598a1", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/553f7bbadfa582eaf13a27204e7912c785e598a1", "committedDate": "2020-08-13T01:26:47Z", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into multi-tenancy-onchain-remove-filter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd8cf37a5df82ebba2d073e0358f7f69f2315e81", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/dd8cf37a5df82ebba2d073e0358f7f69f2315e81", "committedDate": "2020-08-17T02:22:51Z", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into multi-tenancy-onchain-remove-filter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a38db39bfe21f387aa7ff2c7b7d6bd4b2e3c5a1", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/4a38db39bfe21f387aa7ff2c7b7d6bd4b2e3c5a1", "committedDate": "2020-08-18T00:05:11Z", "message": "moved logic for checking group removal tx\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cce49cc9d499881a4e67be0e38bb77a1a838b9d4", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/cce49cc9d499881a4e67be0e38bb77a1a838b9d4", "committedDate": "2020-08-18T00:05:17Z", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into multi-tenancy-onchain-remove-filter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e7d05e8e22eee5c527ec1cd0e8428316c01888e", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/6e7d05e8e22eee5c527ec1cd0e8428316c01888e", "committedDate": "2020-08-18T04:00:30Z", "message": "wire up event subscription\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "175058019490a757cca83b3a5f50531da982e457", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/175058019490a757cca83b3a5f50531da982e457", "committedDate": "2020-08-18T04:27:37Z", "message": "spdx header\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc1edfbacc9abf44093d18e62d32cc1e7a194166", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/fc1edfbacc9abf44093d18e62d32cc1e7a194166", "committedDate": "2020-08-18T04:29:44Z", "message": "added param to javadoc\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6454b3f5ec1b726854a532057d4e8188edc1bdc6", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/6454b3f5ec1b726854a532057d4e8188edc1bdc6", "committedDate": "2020-08-18T23:14:50Z", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into multi-tenancy-onchain-remove-filter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cd819bccdb93b42203d9e7775378109544a7f2f", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/7cd819bccdb93b42203d9e7775378109544a7f2f", "committedDate": "2020-08-19T01:52:52Z", "message": "fixed todo's\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef680480f7cad5290f5ec9af14769d61ed5a4e6d", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/ef680480f7cad5290f5ec9af14769d61ed5a4e6d", "committedDate": "2020-08-19T03:26:23Z", "message": "removed unnecessary blank line\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ef2528d7dcc0789120db6964ea650b66d5ab5ab", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/7ef2528d7dcc0789120db6964ea650b66d5ab5ab", "committedDate": "2020-08-19T05:08:58Z", "message": "merge\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07052912a3aa123388eae2fe52f282f6d11e2ff3", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/07052912a3aa123388eae2fe52f282f6d11e2ff3", "committedDate": "2020-08-19T05:15:49Z", "message": "create event with removed user not tx sender\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bb848a0afbf5d18b9235314361683975a7cd6da", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/8bb848a0afbf5d18b9235314361683975a7cd6da", "committedDate": "2020-08-19T05:22:36Z", "message": "formatting\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwOTg5NTcz", "url": "https://github.com/hyperledger/besu/pull/1298#pullrequestreview-470989573", "createdAt": "2020-08-19T21:49:44Z", "commit": {"oid": "07052912a3aa123388eae2fe52f282f6d11e2ff3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQyMTo0OTo0NVrOHDbcPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQyMTo0OTo0NVrOHDbcPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM1NzM3Mg==", "bodyText": "We could move this to a private method SendRemovedParticipantEvent() to try to keep the compute() method a bit cleaner (I know it is already kinda messy, but let's try to not make it worse) :)", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r473357372", "createdAt": "2020-08-19T21:49:45Z", "author": {"login": "lucassaldanha"}, "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/OnChainPrivacyPrecompiledContract.java", "diffHunk": "@@ -190,10 +191,13 @@ public Bytes compute(final Bytes input, final MessageFrame messageFrame) {\n     }\n \n     if (privateTransaction.isGroupRemovalTransaction()) {\n+      // get first participant parameter - there will be only one for removal transaction\n+      final String removedParticipant = getParticipantsFromParameter(privateTransaction.getPayload()).get(0);\n+\n       final PrivateTransactionEvent removalEvent =\n           new PrivateTransactionEvent(\n               privateTransaction.getPrivacyGroupId().get().toBase64String(),\n-              privateTransaction.getPrivateFrom().toBase64String());\n+              removedParticipant);\n       privateTransactionEventObservers.forEach(\n           sub -> sub.onPrivateTransactionProcessed(removalEvent));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07052912a3aa123388eae2fe52f282f6d11e2ff3"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2f6ce5ea01057398e4e8cb1dca6457c97bb6ff0", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/d2f6ce5ea01057398e4e8cb1dca6457c97bb6ff0", "committedDate": "2020-08-20T02:10:24Z", "message": "get removed participant from tx payload\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5009793d1652334aff7d62c3b0dac90b71e44eca", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/5009793d1652334aff7d62c3b0dac90b71e44eca", "committedDate": "2020-08-20T02:30:38Z", "message": "final param\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdcc174e9358231d23cb348e659c8e37ae71aa66", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/bdcc174e9358231d23cb348e659c8e37ae71aa66", "committedDate": "2020-08-20T03:16:51Z", "message": "cleanup\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMjEwOTQ3", "url": "https://github.com/hyperledger/besu/pull/1298#pullrequestreview-471210947", "createdAt": "2020-08-20T04:37:40Z", "commit": {"oid": "bdcc174e9358231d23cb348e659c8e37ae71aa66"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwNDozNzo0MFrOHDpPYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwNjoxNzo1MlrOHDslRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4MzQ1Nw==", "bodyText": "We only really have to do that when multi-tenancy is enabled. If we do not do multi-tenancy we can return any data that is available to this client to the user.", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r473583457", "createdAt": "2020-08-20T04:37:40Z", "author": {"login": "pinges"}, "path": "besu/src/main/java/org/hyperledger/besu/RunnerBuilder.java", "diffHunk": "@@ -789,6 +795,23 @@ private void createLogsSubscriptionService(\n     }\n   }\n \n+  private void createPrivateTransactionObserver(\n+      final FilterManager filterManager, final PrivacyParameters privacyParameters) {\n+    // register filterManager as observer of events fired by the onchain precompile.\n+    // filterManager needs to remove filters when the creator is removed from onchain group\n+    if (privacyParameters.isOnchainPrivacyGroupsEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdcc174e9358231d23cb348e659c8e37ae71aa66"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4NDEyMA==", "bodyText": "I'm not sure I like the two VERY similar variable names. We could do the casting in line 803!", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r473584120", "createdAt": "2020-08-20T04:39:58Z", "author": {"login": "pinges"}, "path": "besu/src/main/java/org/hyperledger/besu/RunnerBuilder.java", "diffHunk": "@@ -789,6 +795,23 @@ private void createLogsSubscriptionService(\n     }\n   }\n \n+  private void createPrivateTransactionObserver(\n+      final FilterManager filterManager, final PrivacyParameters privacyParameters) {\n+    // register filterManager as observer of events fired by the onchain precompile.\n+    // filterManager needs to remove filters when the creator is removed from onchain group\n+    if (privacyParameters.isOnchainPrivacyGroupsEnabled()) {\n+      final PrecompiledContract onchainPrivacyPrecompiledContract =\n+          besuController\n+              .getProtocolSchedule()\n+              .getByBlockNumber(1)\n+              .getPrecompileContractRegistry()\n+              .get(Address.ONCHAIN_PRIVACY, Account.DEFAULT_VERSION);\n+      OnChainPrivacyPrecompiledContract onChainPrivacyPrecompiledContract =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdcc174e9358231d23cb348e659c8e37ae71aa66"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU4NzQ2Mg==", "bodyText": "I thought about the possibility of a race condition. I think we do have to do the actual removal once the block where it happened is finalised. I think that the method recordBlockEvent could be a good place.\nAnother option would be to make it impossible for that enclaveKey to install a new filter in that privacy group until the block has been finalised.", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r473587462", "createdAt": "2020-08-20T04:53:09Z", "author": {"login": "pinges"}, "path": "ethereum/api/src/main/java/org/hyperledger/besu/ethereum/api/jsonrpc/internal/filter/FilterManager.java", "diffHunk": "@@ -192,6 +197,20 @@ public void recordBlockEvent(final BlockAddedEvent event) {\n             });\n   }\n \n+  @Override\n+  public void onPrivateTransactionProcessed(final PrivateTransactionEvent event) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdcc174e9358231d23cb348e659c8e37ae71aa66"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzYzODIxNA==", "bodyText": "this should not be necessary, as there is only one parameter in that call that has to be 32 bytes long. As the transaction has succeeded I think it should be safe to assume that it really is 32 bytes long. Maybe checking that is OK as well?", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r473638214", "createdAt": "2020-08-20T06:17:52Z", "author": {"login": "pinges"}, "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/OnChainPrivacyPrecompiledContract.java", "diffHunk": "@@ -323,6 +353,11 @@ private boolean isMemberOfPrivacyGroup(\n     return participants;\n   }\n \n+  private String getRemovedParticipantFromParameter(final Bytes input) {\n+    final Bytes mungedParticipants = input.slice(4);\n+    return mungedParticipants.slice(0, 32).toBase64String();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdcc174e9358231d23cb348e659c8e37ae71aa66"}, "originalPosition": 78}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65edf1e3be15e4a64249a68322c5e638910c052d", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/65edf1e3be15e4a64249a68322c5e638910c052d", "committedDate": "2020-08-20T22:25:16Z", "message": "Merge branch 'master' of https://github.com/hyperledger/besu into multi-tenancy-onchain-remove-filter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c5baa0b3e93c379abfe5820ceef13b4437c59c4", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/5c5baa0b3e93c379abfe5820ceef13b4437c59c4", "committedDate": "2020-08-20T22:26:27Z", "message": "only set up filtermanager to listen for group removals if multi-tenancy AND onchain groups enabled\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2a2dd6f0895a87072613c8023a4a3533eab4997", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/b2a2dd6f0895a87072613c8023a4a3533eab4997", "committedDate": "2020-08-20T22:33:25Z", "message": "simplified similar variable names\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e41ca423e96f0b3f9f9b81a78646667ccf60dc1", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/6e41ca423e96f0b3f9f9b81a78646667ccf60dc1", "committedDate": "2020-08-20T23:54:16Z", "message": "store removal events and process with addBlockEvent\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b03933eb2ef30c2ed004ce356d5d22fe91f4912", "author": {"user": {"login": "macfarla", "name": "Sally MacFarlane"}}, "url": "https://github.com/hyperledger/besu/commit/7b03933eb2ef30c2ed004ce356d5d22fe91f4912", "committedDate": "2020-08-21T00:24:57Z", "message": "simplify getting param\n\nSigned-off-by: Sally MacFarlane <sally.macfarlane@consensys.net>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMTE5NDc0", "url": "https://github.com/hyperledger/besu/pull/1298#pullrequestreview-472119474", "createdAt": "2020-08-21T03:17:36Z", "commit": {"oid": "7b03933eb2ef30c2ed004ce356d5d22fe91f4912"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwMzoxNzozNlrOHEaNPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwMzoxNzozNlrOHEaNPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM4NTcyNw==", "bodyText": "Is there a chance for an NPE here?", "url": "https://github.com/hyperledger/besu/pull/1298#discussion_r474385727", "createdAt": "2020-08-21T03:17:36Z", "author": {"login": "mark-terry"}, "path": "ethereum/core/src/main/java/org/hyperledger/besu/ethereum/mainnet/precompiles/privacy/OnChainPrivacyPrecompiledContract.java", "diffHunk": "@@ -189,6 +205,20 @@ public Bytes compute(final Bytes input, final MessageFrame messageFrame) {\n     return result.getOutput();\n   }\n \n+  private void sendParticipantRemovedEvent(final PrivateTransaction privateTransaction) {\n+    if (privateTransaction.isGroupRemovalTransaction()) {\n+      // get first participant parameter - there is only one for removal transaction\n+      final String removedParticipant =\n+          getRemovedParticipantFromParameter(privateTransaction.getPayload());\n+\n+      final PrivateTransactionEvent removalEvent =\n+          new PrivateTransactionEvent(\n+              privateTransaction.getPrivacyGroupId().get().toBase64String(), removedParticipant);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b03933eb2ef30c2ed004ce356d5d22fe91f4912"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMTE5NjUz", "url": "https://github.com/hyperledger/besu/pull/1298#pullrequestreview-472119653", "createdAt": "2020-08-21T03:18:17Z", "commit": {"oid": "7b03933eb2ef30c2ed004ce356d5d22fe91f4912"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMTM5Nzcx", "url": "https://github.com/hyperledger/besu/pull/1298#pullrequestreview-472139771", "createdAt": "2020-08-21T04:39:43Z", "commit": {"oid": "7b03933eb2ef30c2ed004ce356d5d22fe91f4912"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1466, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}