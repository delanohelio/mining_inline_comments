{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzNjY2MDQ4", "number": 1590, "title": "Refactored genesis config fork logic.", "bodyText": "Signed-off-by: Mark Terry mark.terry@consensys.net\n\n\nPR description\nRefactored the default fork block determination logic to exclude unexpected forks that would currently break forkId generation.\nFixed Issue(s)\n\n\nFixes #1532\nChangelog\n\n I thought about the changelog and included a changelog update if required.", "createdAt": "2020-11-19T04:22:47Z", "url": "https://github.com/hyperledger/besu/pull/1590", "merged": true, "mergeCommit": {"oid": "fe2137a9cc0b937460bec017e727dea12940e60c"}, "closed": true, "closedAt": "2020-12-08T03:38:33Z", "author": {"login": "mark-terry"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeIt3VAFqTUzNDgxOTg4OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj9SvmAH2gAyNTIzNjY2MDQ4OmRiMTE0M2JlNjUwMzU2ODFmZDQ4ZjRhNmMwY2ZiYTNjYmYxNDI2ZWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0ODE5ODg4", "url": "https://github.com/hyperledger/besu/pull/1590#pullrequestreview-534819888", "createdAt": "2020-11-19T20:23:37Z", "commit": {"oid": "a0554a530a3302528c431cd92ca1628b319bab24"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMDoyMzozN1rOH2wL0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMDoyMzozN1rOH2wL0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzE3NDYwOQ==", "bodyText": "is this meant to be duplicated?", "url": "https://github.com/hyperledger/besu/pull/1590#discussion_r527174609", "createdAt": "2020-11-19T20:23:37Z", "author": {"login": "macfarla"}, "path": "config/src/main/java/org/hyperledger/besu/config/JsonGenesisConfigOptions.java", "diffHunk": "@@ -419,4 +422,36 @@ private OptionalInt getOptionalInt(final String key) {\n       return JsonUtil.getBoolean(configRoot, key);\n     }\n   }\n+\n+  @Override\n+  public List<Long> getForks() {\n+    Stream<OptionalLong> forkBlockNumbers =\n+        Stream.of(\n+            getHomesteadBlockNumber(),\n+            getDaoForkBlock(),\n+            getTangerineWhistleBlockNumber(),\n+            // duplicated for EIP155 and EIP158 handling\n+            getSpuriousDragonBlockNumber(),\n+            getSpuriousDragonBlockNumber(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0554a530a3302528c431cd92ca1628b319bab24"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NTk1MjY3", "url": "https://github.com/hyperledger/besu/pull/1590#pullrequestreview-536595267", "createdAt": "2020-11-23T15:41:59Z", "commit": {"oid": "a0554a530a3302528c431cd92ca1628b319bab24"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2b32540d59dc6b8e1b862f7dd2fb124133973a5", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/d2b32540d59dc6b8e1b862f7dd2fb124133973a5", "committedDate": "2020-12-02T23:18:22Z", "message": "Refactored genesis config fork logic.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2c30176cc7209facd6102e1e7e978faeb9aa0a3", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/d2c30176cc7209facd6102e1e7e978faeb9aa0a3", "committedDate": "2020-12-02T23:18:22Z", "message": "Progress commit - added test.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffdcb4cac1957891e8386d592a5bba91c59b3d42", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/ffdcb4cac1957891e8386d592a5bba91c59b3d42", "committedDate": "2020-12-02T23:18:22Z", "message": "Progress commit - slight refactor.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "512dba0b98a0bef28823a49b1da5a0c0751b8799", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/512dba0b98a0bef28823a49b1da5a0c0751b8799", "committedDate": "2020-12-03T01:26:24Z", "message": "Added tests.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a0554a530a3302528c431cd92ca1628b319bab24", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/a0554a530a3302528c431cd92ca1628b319bab24", "committedDate": "2020-11-19T04:17:17Z", "message": "Refactored genesis config fork logic.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>"}, "afterCommit": {"oid": "512dba0b98a0bef28823a49b1da5a0c0751b8799", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/512dba0b98a0bef28823a49b1da5a0c0751b8799", "committedDate": "2020-12-03T01:26:24Z", "message": "Added tests.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09ea837daca3a6eed3c85e7615b42c88c8bfbaa9", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/09ea837daca3a6eed3c85e7615b42c88c8bfbaa9", "committedDate": "2020-12-03T01:31:18Z", "message": "Merge branch 'master' into 1532"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzNTA3MTY0", "url": "https://github.com/hyperledger/besu/pull/1590#pullrequestreview-543507164", "createdAt": "2020-12-03T05:23:13Z", "commit": {"oid": "09ea837daca3a6eed3c85e7615b42c88c8bfbaa9"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwNToyMzoxM1rOH96Flw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwNTozMDoyMVrOH96P3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3Njg4Nw==", "bodyText": "so duplicates weren't removed before? Or did it happen after this point?", "url": "https://github.com/hyperledger/besu/pull/1590#discussion_r534676887", "createdAt": "2020-12-03T05:23:13Z", "author": {"login": "macfarla"}, "path": "config/src/test/java/org/hyperledger/besu/config/GenesisConfigFileTest.java", "diffHunk": "@@ -355,7 +355,43 @@ public void shouldLoadForksIgnoreClassicForkBlock() throws IOException {\n                         StandardCharsets.UTF_8)));\n     final GenesisConfigFile config = fromConfig(configNode);\n \n-    assertThat(config.getForks()).containsExactly(1L, 2L, 3L, 3L, 1035301L);\n+    assertThat(config.getForks()).containsExactly(1L, 2L, 3L, 1035301L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09ea837daca3a6eed3c85e7615b42c88c8bfbaa9"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3ODI5NA==", "bodyText": "Need to add back in the assertion that the result is the same as that generated from the config with no unexpected fork values", "url": "https://github.com/hyperledger/besu/pull/1590#discussion_r534678294", "createdAt": "2020-12-03T05:26:48Z", "author": {"login": "macfarla"}, "path": "config/src/test/java/org/hyperledger/besu/config/GenesisConfigFileTest.java", "diffHunk": "@@ -355,7 +355,43 @@ public void shouldLoadForksIgnoreClassicForkBlock() throws IOException {\n                         StandardCharsets.UTF_8)));\n     final GenesisConfigFile config = fromConfig(configNode);\n \n-    assertThat(config.getForks()).containsExactly(1L, 2L, 3L, 3L, 1035301L);\n+    assertThat(config.getForks()).containsExactly(1L, 2L, 3L, 1035301L);\n+    assertThat(config.getConfigOptions().getChainId()).hasValue(BigInteger.valueOf(61));\n+  }\n+\n+  @Test\n+  public void shouldLoadForksIgnoreUnexpectedValues() throws IOException {\n+    final ObjectNode configNode =\n+        new ObjectMapper()\n+            .createObjectNode()\n+            .set(\n+                \"config\",\n+                JsonUtil.objectNodeFromString(\n+                    Resources.toString(\n+                        Resources.getResource(\n+                            // If you inspect this config, you should see that classicForkBlock is\n+                            // declared (which we want to ignore)\n+                            \"valid_config_with_etc_forks.json\"),\n+                        StandardCharsets.UTF_8)));\n+\n+    final ObjectNode configNodeWithUnexpectedForks =\n+        new ObjectMapper()\n+            .createObjectNode()\n+            .set(\n+                \"config\",\n+                JsonUtil.objectNodeFromString(\n+                    Resources.toString(\n+                        Resources.getResource(\n+                            // If you inspect this config, you should see that classicForkBlock is\n+                            // declared (which we want to ignore)\n+                            \"valid_config_with_unexpected_forks.json\"),\n+                        StandardCharsets.UTF_8)));\n+\n+    final GenesisConfigFile config = fromConfig(configNode);\n+    final GenesisConfigFile configWithUnexpectedForks = fromConfig(configNodeWithUnexpectedForks);\n+\n+    assertThat(config.getForks()).containsExactly(1L, 2L, 3L, 1035301L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09ea837daca3a6eed3c85e7615b42c88c8bfbaa9"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3ODQ0OQ==", "bodyText": "I think some renaming would make things clearer", "url": "https://github.com/hyperledger/besu/pull/1590#discussion_r534678449", "createdAt": "2020-12-03T05:27:18Z", "author": {"login": "macfarla"}, "path": "config/src/test/java/org/hyperledger/besu/config/GenesisConfigFileTest.java", "diffHunk": "@@ -355,7 +355,43 @@ public void shouldLoadForksIgnoreClassicForkBlock() throws IOException {\n                         StandardCharsets.UTF_8)));\n     final GenesisConfigFile config = fromConfig(configNode);\n \n-    assertThat(config.getForks()).containsExactly(1L, 2L, 3L, 3L, 1035301L);\n+    assertThat(config.getForks()).containsExactly(1L, 2L, 3L, 1035301L);\n+    assertThat(config.getConfigOptions().getChainId()).hasValue(BigInteger.valueOf(61));\n+  }\n+\n+  @Test\n+  public void shouldLoadForksIgnoreUnexpectedValues() throws IOException {\n+    final ObjectNode configNode =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09ea837daca3a6eed3c85e7615b42c88c8bfbaa9"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3ODY3Ng==", "bodyText": "configWithNoUnexpectedForkBlocks\nconfigWithUnexpectedClassicForkBlock\nconfigWithMultipleUnexpectedForkBlocks", "url": "https://github.com/hyperledger/besu/pull/1590#discussion_r534678676", "createdAt": "2020-12-03T05:27:59Z", "author": {"login": "macfarla"}, "path": "config/src/test/java/org/hyperledger/besu/config/GenesisConfigFileTest.java", "diffHunk": "@@ -355,7 +355,43 @@ public void shouldLoadForksIgnoreClassicForkBlock() throws IOException {\n                         StandardCharsets.UTF_8)));\n     final GenesisConfigFile config = fromConfig(configNode);\n \n-    assertThat(config.getForks()).containsExactly(1L, 2L, 3L, 3L, 1035301L);\n+    assertThat(config.getForks()).containsExactly(1L, 2L, 3L, 1035301L);\n+    assertThat(config.getConfigOptions().getChainId()).hasValue(BigInteger.valueOf(61));\n+  }\n+\n+  @Test\n+  public void shouldLoadForksIgnoreUnexpectedValues() throws IOException {\n+    final ObjectNode configNode =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3ODQ0OQ=="}, "originalCommit": {"oid": "09ea837daca3a6eed3c85e7615b42c88c8bfbaa9"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY3OTUxNg==", "bodyText": "classicForkBlock doesn't get special treatment any more, but maybe it's still worth checking single vs multiple unexpected forks?", "url": "https://github.com/hyperledger/besu/pull/1590#discussion_r534679516", "createdAt": "2020-12-03T05:30:21Z", "author": {"login": "macfarla"}, "path": "config/src/test/java/org/hyperledger/besu/config/GenesisConfigFileTest.java", "diffHunk": "@@ -355,7 +355,43 @@ public void shouldLoadForksIgnoreClassicForkBlock() throws IOException {\n                         StandardCharsets.UTF_8)));\n     final GenesisConfigFile config = fromConfig(configNode);\n \n-    assertThat(config.getForks()).containsExactly(1L, 2L, 3L, 3L, 1035301L);\n+    assertThat(config.getForks()).containsExactly(1L, 2L, 3L, 1035301L);\n+    assertThat(config.getConfigOptions().getChainId()).hasValue(BigInteger.valueOf(61));\n+  }\n+\n+  @Test\n+  public void shouldLoadForksIgnoreUnexpectedValues() throws IOException {\n+    final ObjectNode configNode =\n+        new ObjectMapper()\n+            .createObjectNode()\n+            .set(\n+                \"config\",\n+                JsonUtil.objectNodeFromString(\n+                    Resources.toString(\n+                        Resources.getResource(\n+                            // If you inspect this config, you should see that classicForkBlock is\n+                            // declared (which we want to ignore)\n+                            \"valid_config_with_etc_forks.json\"),\n+                        StandardCharsets.UTF_8)));\n+\n+    final ObjectNode configNodeWithUnexpectedForks =\n+        new ObjectMapper()\n+            .createObjectNode()\n+            .set(\n+                \"config\",\n+                JsonUtil.objectNodeFromString(\n+                    Resources.toString(\n+                        Resources.getResource(\n+                            // If you inspect this config, you should see that classicForkBlock is\n+                            // declared (which we want to ignore)\n+                            \"valid_config_with_unexpected_forks.json\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09ea837daca3a6eed3c85e7615b42c88c8bfbaa9"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bd5bffc0a0e4f33ec429e492f8cd6cefdee218b", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/9bd5bffc0a0e4f33ec429e492f8cd6cefdee218b", "committedDate": "2020-12-03T12:59:54Z", "message": "Merge branch 'master' into 1532"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25f0b9d06319a8dc129b72846887d814c9abeeca", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/25f0b9d06319a8dc129b72846887d814c9abeeca", "committedDate": "2020-12-03T13:05:03Z", "message": "PR fixes.\n\nSigned-off-by: Mark Terry <mark.terry@consensys.net>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84a5c96f7100688720419234e33a560a08768926", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/84a5c96f7100688720419234e33a560a08768926", "committedDate": "2020-12-03T13:05:17Z", "message": "Merge branch '1532' of github.com:mark-terry/besu into 1532"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NDQ1NDI2", "url": "https://github.com/hyperledger/besu/pull/1590#pullrequestreview-544445426", "createdAt": "2020-12-03T21:01:39Z", "commit": {"oid": "84a5c96f7100688720419234e33a560a08768926"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f771e207a7c75075a30a339c1d67acb08c8661ac", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/f771e207a7c75075a30a339c1d67acb08c8661ac", "committedDate": "2020-12-07T02:51:55Z", "message": "Merge branch 'master' into 1532"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db1143be65035681fd48f4a6c0cfba3cbf1426ea", "author": {"user": {"login": "mark-terry", "name": null}}, "url": "https://github.com/hyperledger/besu/commit/db1143be65035681fd48f4a6c0cfba3cbf1426ea", "committedDate": "2020-12-07T22:29:16Z", "message": "Merge branch 'master' into 1532"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2108, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}