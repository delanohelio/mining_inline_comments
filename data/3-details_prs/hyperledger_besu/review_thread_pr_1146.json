{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwMDA1Mzkz", "number": 1146, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMzoxNjo1NVrOEIwW3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNjowNTowNVrOEJuk6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3NjE2MzUwOnYy", "diffSide": "RIGHT", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMzoxNjo1NVrOGo6NHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMzozNDo0NFrOGo68fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU0OTg1Mg==", "bodyText": "Nice catch", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r445549852", "createdAt": "2020-06-25T13:16:55Z", "author": {"login": "abdelhamidbakhta"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java", "diffHunk": "@@ -205,7 +207,7 @@ public void start() {\n         bootstrapNodes.stream()\n             .filter(peerPermissions::isAllowedInPeerTable)\n             .collect(Collectors.toList());\n-    initialDiscoveryPeers.stream().forEach(peerTable::tryAdd);\n+    initialDiscoveryPeers.forEach(peerTable::tryAdd);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d4f4ba1c98e5cc40f1c926939e063aba4e7c91f"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU2MTk4Mg==", "bodyText": "Thanks to SonarQube.", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r445561982", "createdAt": "2020-06-25T13:34:44Z", "author": {"login": "davemec"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java", "diffHunk": "@@ -205,7 +207,7 @@ public void start() {\n         bootstrapNodes.stream()\n             .filter(peerPermissions::isAllowedInPeerTable)\n             .collect(Collectors.toList());\n-    initialDiscoveryPeers.stream().forEach(peerTable::tryAdd);\n+    initialDiscoveryPeers.forEach(peerTable::tryAdd);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU0OTg1Mg=="}, "originalCommit": {"oid": "0d4f4ba1c98e5cc40f1c926939e063aba4e7c91f"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3NjE2ODE5OnYy", "diffSide": "RIGHT", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMzoxODowNlrOGo6QJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMzoxODowNlrOGo6QJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU1MDYzMQ==", "bodyText": "What about inlining instead of storing local variable", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r445550631", "createdAt": "2020-06-25T13:18:06Z", "author": {"login": "abdelhamidbakhta"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java", "diffHunk": "@@ -296,31 +298,41 @@ public void onMessage(final Packet packet, final DiscoveryPeer sender) {\n     // Load the peer from the table, or use the instance that comes in.\n     final Optional<DiscoveryPeer> maybeKnownPeer =\n         peerTable.get(sender).filter(known -> known.discoveryEndpointMatches(sender));\n-    final DiscoveryPeer peer = maybeKnownPeer.orElse(sender);\n+    DiscoveryPeer peer = maybeKnownPeer.orElse(sender);\n     final boolean peerKnown = maybeKnownPeer.isPresent();\n+    if (!peerKnown && bondingPeers.containsKey(sender.getId())) {\n+      peer = bondingPeers.get(sender.getId());\n+    }\n \n+    final DiscoveryPeer finalPeer = peer;\n     switch (packet.getType()) {\n       case PING:\n         if (peerPermissions.allowInboundBonding(peer)) {\n-          addToPeerTable(peer);\n+          long now = System.currentTimeMillis();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d4f4ba1c98e5cc40f1c926939e063aba4e7c91f"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3NjE4MDk2OnYy", "diffSide": "RIGHT", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMzoyMToxNVrOGo6YBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMzozMDo1NFrOGo6yhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU1MjY0NQ==", "bodyText": "is it not necessary to use a ConcurrentHashMap here?", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r445552645", "createdAt": "2020-06-25T13:21:15Z", "author": {"login": "matkt"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java", "diffHunk": "@@ -168,6 +169,7 @@ private PeerDiscoveryController(\n     this.outboundMessageHandler = outboundMessageHandler;\n     this.peerBondedObservers = peerBondedObservers;\n     this.discoveryProtocolLogger = new DiscoveryProtocolLogger(metricsSystem);\n+    this.bondingPeers = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d4f4ba1c98e5cc40f1c926939e063aba4e7c91f"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU1OTQyOQ==", "bodyText": "I don't think we need that here. My understanding is that each peer has it's own controller so the Map should be ok.", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r445559429", "createdAt": "2020-06-25T13:30:54Z", "author": {"login": "davemec"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java", "diffHunk": "@@ -168,6 +169,7 @@ private PeerDiscoveryController(\n     this.outboundMessageHandler = outboundMessageHandler;\n     this.peerBondedObservers = peerBondedObservers;\n     this.discoveryProtocolLogger = new DiscoveryProtocolLogger(metricsSystem);\n+    this.bondingPeers = new HashMap<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU1MjY0NQ=="}, "originalCommit": {"oid": "0d4f4ba1c98e5cc40f1c926939e063aba4e7c91f"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjAxMjYzOnYy", "diffSide": "RIGHT", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryAgent.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNDo0ODo0N1rOGqUhIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNDo0ODo0N1rOGqUhIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAyOTUzNw==", "bodyText": "Do we need this? Looks like sourceEndpoint.getTcpPort() will always be empty: \n  \n    \n      besu/ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/VertxPeerDiscoveryAgent.java\n    \n    \n        Lines 219 to 220\n      in\n      b0115a2\n    \n    \n    \n    \n\n        \n          \n           final Endpoint endpoint = new Endpoint(host, port, OptionalInt.empty()); \n        \n\n        \n          \n           handleIncomingPacket(endpoint, event.result());", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r447029537", "createdAt": "2020-06-29T14:48:47Z", "author": {"login": "mbaxter"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryAgent.java", "diffHunk": "@@ -190,6 +191,10 @@ protected void handleIncomingPacket(final Endpoint sourceEndpoint, final Packet\n       }\n     }\n \n+    if (PacketType.PONG.equals(packet.getType())) {\n+      tcpPort = sourceEndpoint.getTcpPort();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0f1afabbd7bce3989c5c3596900e6a964e8e07"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjA0MTMwOnYy", "diffSide": "RIGHT", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNDo1NDozNFrOGqUymA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNDo1NDozNFrOGqUymA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAzNDAwOA==", "bodyText": "We should only remove the peer from this collection if the interaction matches, right?\n        matchInteraction(packet)\n            .ifPresent(\n                interaction -> {\n                  bondingPeers.remove(peer.getId());\n                  addToPeerTable(peer);\n                  recursivePeerRefreshState.onBondingComplete(peer);\n                  addToPeerTable(finalPeer);\n                  recursivePeerRefreshState.onBondingComplete(finalPeer);\n                });", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r447034008", "createdAt": "2020-06-29T14:54:34Z", "author": {"login": "mbaxter"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java", "diffHunk": "@@ -296,31 +298,40 @@ public void onMessage(final Packet packet, final DiscoveryPeer sender) {\n     // Load the peer from the table, or use the instance that comes in.\n     final Optional<DiscoveryPeer> maybeKnownPeer =\n         peerTable.get(sender).filter(known -> known.discoveryEndpointMatches(sender));\n-    final DiscoveryPeer peer = maybeKnownPeer.orElse(sender);\n+    DiscoveryPeer peer = maybeKnownPeer.orElse(sender);\n     final boolean peerKnown = maybeKnownPeer.isPresent();\n+    if (!peerKnown && bondingPeers.containsKey(sender.getId())) {\n+      peer = bondingPeers.get(sender.getId());\n+    }\n \n+    final DiscoveryPeer finalPeer = peer;\n     switch (packet.getType()) {\n       case PING:\n         if (peerPermissions.allowInboundBonding(peer)) {\n-          addToPeerTable(peer);\n+          peer.setLastSeen(System.currentTimeMillis());\n           final PingPacketData ping = packet.getPacketData(PingPacketData.class).get();\n+          if (!PeerDiscoveryStatus.BONDED.equals(peer.getStatus())\n+              && !bondingPeers.containsKey(peer.getId())) {\n+            bond(peer);\n+          }\n           respondToPing(ping, packet.getHash(), peer);\n         }\n         break;\n       case PONG:\n+        bondingPeers.remove(peer.getId());\n         matchInteraction(packet)\n             .ifPresent(\n                 interaction -> {\n-                  addToPeerTable(peer);\n-                  recursivePeerRefreshState.onBondingComplete(peer);\n+                  addToPeerTable(finalPeer);\n+                  recursivePeerRefreshState.onBondingComplete(finalPeer);\n                 });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0f1afabbd7bce3989c5c3596900e6a964e8e07"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjA2MDMyOnYy", "diffSide": "RIGHT", "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNDo1ODozNFrOGqU98Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMDoxMzo1N1rOGqghfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAzNjkxMw==", "bodyText": "We already have a PeerStatus.BONDING state - why not just add bonding peers to our table with this status instead of creating a new collection?", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r447036913", "createdAt": "2020-06-29T14:58:34Z", "author": {"login": "mbaxter"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java", "diffHunk": "@@ -168,6 +169,7 @@ private PeerDiscoveryController(\n     this.outboundMessageHandler = outboundMessageHandler;\n     this.peerBondedObservers = peerBondedObservers;\n     this.discoveryProtocolLogger = new DiscoveryProtocolLogger(metricsSystem);\n+    this.bondingPeers = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0f1afabbd7bce3989c5c3596900e6a964e8e07"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIyNjIzOQ==", "bodyText": "I created the new collection so that the BONDING nodes did not interfere with the list of peers, specifically in regards to when the bucket is full and things need to be removed.", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r447226239", "createdAt": "2020-06-29T20:13:57Z", "author": {"login": "davemec"}, "path": "ethereum/p2p/src/main/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryController.java", "diffHunk": "@@ -168,6 +169,7 @@ private PeerDiscoveryController(\n     this.outboundMessageHandler = outboundMessageHandler;\n     this.peerBondedObservers = peerBondedObservers;\n     this.discoveryProtocolLogger = new DiscoveryProtocolLogger(metricsSystem);\n+    this.bondingPeers = new HashMap<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAzNjkxMw=="}, "originalCommit": {"oid": "5d0f1afabbd7bce3989c5c3596900e6a964e8e07"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjIxOTkxOnYy", "diffSide": "RIGHT", "path": "ethereum/p2p/src/test/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryAgentTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTozMzozNVrOGqWhAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTozMzozNVrOGqWhAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA2MjI3NQ==", "bodyText": "Why are there 3 packets here and not 2?  Seems like we should only have 1 incoming PING, and 1 incoming PONG.", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r447062275", "createdAt": "2020-06-29T15:33:35Z", "author": {"login": "mbaxter"}, "path": "ethereum/p2p/src/test/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryAgentTest.java", "diffHunk": "@@ -209,25 +217,33 @@ public void bonding_allowIncomingBonding() {\n     final PeerPermissions peerPermissions = mock(PeerPermissions.class);\n     final MockPeerDiscoveryAgent agent =\n         helper.startDiscoveryAgent(Collections.emptyList(), peerPermissions);\n+    assertThat(agent.getAdvertisedPeer().isPresent()).isTrue();\n     final Peer localNode = agent.getAdvertisedPeer().get();\n \n     // Setup peer and permissions\n     final MockPeerDiscoveryAgent otherNode = helper.startDiscoveryAgent();\n+    assertThat(otherNode.getAdvertisedPeer().isPresent()).isTrue();\n     final Peer remotePeer = otherNode.getAdvertisedPeer().get();\n     when(peerPermissions.isPermitted(eq(localNode), any(), any())).thenReturn(false);\n     when(peerPermissions.isPermitted(\n             eq(localNode), eq(remotePeer), eq(Action.DISCOVERY_ACCEPT_INBOUND_BONDING)))\n         .thenReturn(true);\n+    when(peerPermissions.isPermitted(\n+            any(), eq(remotePeer), eq(Action.DISCOVERY_ALLOW_IN_PEER_TABLE)))\n+        .thenReturn(true);\n \n     // Bond\n     bondViaIncomingPing(agent, otherNode);\n \n-    // Check that peer received a return pong\n     List<IncomingPacket> remoteIncomingPackets = otherNode.getIncomingPackets();\n-    assertThat(remoteIncomingPackets).hasSize(1);\n+    assertThat(remoteIncomingPackets).hasSize(3);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0f1afabbd7bce3989c5c3596900e6a964e8e07"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjI3NTc5OnYy", "diffSide": "RIGHT", "path": "ethereum/p2p/src/test/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryAgentTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTo0NTo1OVrOGqXDxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTo0NTo1OVrOGqXDxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA3MTE3NA==", "bodyText": "We shouldn't need to manually send a PONG here -remoteAgent is using agent as a bootnode, so they should automatically bond.", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r447071174", "createdAt": "2020-06-29T15:45:59Z", "author": {"login": "mbaxter"}, "path": "ethereum/p2p/src/test/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryAgentTest.java", "diffHunk": "@@ -349,11 +370,16 @@ public void simulatePeerRestartingOnDifferentEndpoint(\n \n     agent.start(999);\n     remoteAgent.start(888);\n+    assertThat(remoteAgent.getAdvertisedPeer().isPresent()).isTrue();\n     final DiscoveryPeer remotePeer = remoteAgent.getAdvertisedPeer().get();\n \n+    // Send PONG so that peers will be bonded\n+    final Packet pongPacket = helper.createPongPacket(agent, Hash.EMPTY);\n+    helper.sendMessageBetweenAgents(remoteAgent, agent, pongPacket);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0f1afabbd7bce3989c5c3596900e6a964e8e07"}, "originalPosition": 153}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjMxMTQ5OnYy", "diffSide": "RIGHT", "path": "ethereum/p2p/src/test/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryBondingTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTo1NDoyMlrOGqXZtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTo1NDoyMlrOGqXZtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA3Njc4OQ==", "bodyText": "There should only be 1 PONG here", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r447076789", "createdAt": "2020-06-29T15:54:22Z", "author": {"login": "mbaxter"}, "path": "ethereum/p2p/src/test/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryBondingTest.java", "diffHunk": "@@ -48,10 +48,14 @@ public void pongSentUponPing() {\n         otherAgent.getIncomingPackets().stream()\n             .filter(p -> p.packet.getType().equals(PacketType.PONG))\n             .collect(Collectors.toList());\n-    assertThat(otherAgentIncomingPongs.size()).isEqualTo(1);\n+    assertThat(otherAgentIncomingPongs.size()).isEqualTo(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0f1afabbd7bce3989c5c3596900e6a964e8e07"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjMxNjA1OnYy", "diffSide": "RIGHT", "path": "ethereum/p2p/src/test/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryBondingTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTo1NToyMVrOGqXchw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTo1NToyMVrOGqXchw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA3NzUxMQ==", "bodyText": "Again not sure why we have 2 PONG's here", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r447077511", "createdAt": "2020-06-29T15:55:21Z", "author": {"login": "mbaxter"}, "path": "ethereum/p2p/src/test/java/org/hyperledger/besu/ethereum/p2p/discovery/PeerDiscoveryBondingTest.java", "diffHunk": "@@ -86,10 +90,11 @@ public void neighborsPacketNotSentUnlessBonded() throws InterruptedException {\n         otherNode.getIncomingPackets().stream()\n             .filter(p -> p.packet.getType().equals(PacketType.PONG))\n             .collect(Collectors.toList());\n-    assertThat(incomingPongs.size()).isEqualTo(1);\n+    assertThat(incomingPongs.size()).isEqualTo(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0f1afabbd7bce3989c5c3596900e6a964e8e07"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjM1NzUyOnYy", "diffSide": "RIGHT", "path": "ethereum/p2p/src/test/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryControllerTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNjowNTowNVrOGqX2YQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNjowNTowNVrOGqX2YQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA4NDEyOQ==", "bodyText": "(nit) We should make these method names match:\n  private void mockPingPacketCreation(final DiscoveryPeer peer, final Packet mockPacket) {", "url": "https://github.com/hyperledger/besu/pull/1146#discussion_r447084129", "createdAt": "2020-06-29T16:05:05Z", "author": {"login": "mbaxter"}, "path": "ethereum/p2p/src/test/java/org/hyperledger/besu/ethereum/p2p/discovery/internal/PeerDiscoveryControllerTest.java", "diffHunk": "@@ -153,24 +153,25 @@ public void bootstrapPeersRetriesSent() {\n   }\n \n   private void mockPingPacketCreation(final Packet mockPacket) {\n-    mockPacketCreation(PacketType.PING, Optional.empty(), mockPacket);\n+    mockPacketCreation(Optional.empty(), mockPacket);\n   }\n \n-  private void mockPacketCreation(\n-      final PacketType type, final DiscoveryPeer peer, final Packet mockPacket) {\n-    mockPacketCreation(type, Optional.of(peer), mockPacket);\n+  private void mockPacketCreation(final DiscoveryPeer peer, final Packet mockPacket) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0f1afabbd7bce3989c5c3596900e6a964e8e07"}, "originalPosition": 11}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 828, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}