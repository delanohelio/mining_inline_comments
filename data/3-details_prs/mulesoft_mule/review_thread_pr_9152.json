{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMTgwODk2", "number": 9152, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMDozNDo0M1rOEUv62g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMDozNjozNlrOEUv9Ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMTkyMDkwOnYy", "diffSide": "RIGHT", "path": "modules/extensions-xml-support/src/test/java/org/mule/runtime/extension/internal/loader/validation/DefaultModelValidatorTestCase.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMDozNDo0M1rOG7H1YQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMDozNDo0M1rOG7H1YQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0NzUyMQ==", "bodyText": "should this be called depedencyExtensions or something like that? The intent of the parameter is now lost", "url": "https://github.com/mulesoft/mule/pull/9152#discussion_r464647521", "createdAt": "2020-08-03T20:34:43Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-xml-support/src/test/java/org/mule/runtime/extension/internal/loader/validation/DefaultModelValidatorTestCase.java", "diffHunk": "@@ -220,17 +221,17 @@ private ExtensionModel getExtensionModelFrom(String modulePath, Set<ExtensionMod\n   private Set<ExtensionModel> getDependencyExtensions() {\n     ExtensionModel petstore = loadExtension(PetStoreConnector.class, emptySet());\n     ExtensionModel heisenberg = loadExtension(HeisenbergExtension.class, emptySet());\n-    return ImmutableSet.<ExtensionModel>builder().add(petstore, heisenberg).build();\n+    return ImmutableSet.<ExtensionModel>builder().add(petstore, heisenberg, getExtensionModel()).build();\n   }\n \n-  private ExtensionModel loadExtension(Class extension, Set<ExtensionModel> deps) {\n+  private ExtensionModel loadExtension(Class extension, Set<ExtensionModel> extensions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b644ab8a74d569ac69f176f6aae6f4ae552d58a2"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMTkyMzUwOnYy", "diffSide": "RIGHT", "path": "modules/spring-config/src/main/java/org/mule/runtime/config/internal/model/type/ApplicationModelTypeUtils.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMDozNToyOFrOG7H23w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMDozOToyOVrOG7H-XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0NzkwMw==", "bodyText": "seems like nothing change here other than formatting? Is taht the case? Can it be reverted then?", "url": "https://github.com/mulesoft/mule/pull/9152#discussion_r464647903", "createdAt": "2020-08-03T20:35:28Z", "author": {"login": "marianogonzalez"}, "path": "modules/spring-config/src/main/java/org/mule/runtime/config/internal/model/type/ApplicationModelTypeUtils.java", "diffHunk": "@@ -236,38 +238,65 @@ private static void handleNestedParameters(ComponentModel componentModel, Stream\n                                              Multimap<ComponentIdentifier, ComponentModel> nestedComponents,\n                                              ExtensionModelHelper extensionModelHelper,\n                                              ParameterizedModel model, Predicate<ParameterModel> parameterModelFilter) {\n-    childrenComponentModels\n-        .forEach(childComp -> extensionModelHelper.findParameterModel(childComp.getIdentifier(), model)\n-            .filter(parameterModelFilter::test)\n-            // do not handle the callback parameters from the sources\n-            .filter(paramModel -> {\n-              if (model instanceof SourceModel) {\n-                return !(((SourceModel) model).getSuccessCallback()\n-                    .map(sc -> sc.getAllParameterModels().contains(paramModel))\n-                    .orElse(false) ||\n-                    ((SourceModel) model).getErrorCallback()\n-                        .map(ec -> ec.getAllParameterModels().contains(paramModel))\n-                        .orElse(false));\n-              } else {\n-                return true;\n-              }\n-            })\n-            .filter(paramModel -> paramModel.getDslConfiguration().allowsInlineDefinition())\n-            .ifPresent(paramModel -> {\n-              if (isContent(paramModel)) {\n-                componentModel.setParameter(paramModel,\n-                                            new DefaultComponentParameterAst(trim(((ComponentModel) childComp)\n-                                                .getTextContent()),\n-                                                                             () -> paramModel, childComp.getMetadata()));\n-              } else {\n-                enrichComponentModels(componentModel, nestedComponents,\n-                                      of(extensionModelHelper.resolveDslElementModel(paramModel,\n-                                                                                     componentModel\n-                                                                                         .getIdentifier())),\n-                                      paramModel, extensionModelHelper);\n-              }\n-\n-            }));\n+    model.getAllParameterModels()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b644ab8a74d569ac69f176f6aae6f4ae552d58a2"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0OTgyMQ==", "bodyText": "no, i turned this around, before it iterated the children and matched those against the parameter models, now it iterates the parameter models and looks it up in the dsl.", "url": "https://github.com/mulesoft/mule/pull/9152#discussion_r464649821", "createdAt": "2020-08-03T20:39:29Z", "author": {"login": "elrodro83"}, "path": "modules/spring-config/src/main/java/org/mule/runtime/config/internal/model/type/ApplicationModelTypeUtils.java", "diffHunk": "@@ -236,38 +238,65 @@ private static void handleNestedParameters(ComponentModel componentModel, Stream\n                                              Multimap<ComponentIdentifier, ComponentModel> nestedComponents,\n                                              ExtensionModelHelper extensionModelHelper,\n                                              ParameterizedModel model, Predicate<ParameterModel> parameterModelFilter) {\n-    childrenComponentModels\n-        .forEach(childComp -> extensionModelHelper.findParameterModel(childComp.getIdentifier(), model)\n-            .filter(parameterModelFilter::test)\n-            // do not handle the callback parameters from the sources\n-            .filter(paramModel -> {\n-              if (model instanceof SourceModel) {\n-                return !(((SourceModel) model).getSuccessCallback()\n-                    .map(sc -> sc.getAllParameterModels().contains(paramModel))\n-                    .orElse(false) ||\n-                    ((SourceModel) model).getErrorCallback()\n-                        .map(ec -> ec.getAllParameterModels().contains(paramModel))\n-                        .orElse(false));\n-              } else {\n-                return true;\n-              }\n-            })\n-            .filter(paramModel -> paramModel.getDslConfiguration().allowsInlineDefinition())\n-            .ifPresent(paramModel -> {\n-              if (isContent(paramModel)) {\n-                componentModel.setParameter(paramModel,\n-                                            new DefaultComponentParameterAst(trim(((ComponentModel) childComp)\n-                                                .getTextContent()),\n-                                                                             () -> paramModel, childComp.getMetadata()));\n-              } else {\n-                enrichComponentModels(componentModel, nestedComponents,\n-                                      of(extensionModelHelper.resolveDslElementModel(paramModel,\n-                                                                                     componentModel\n-                                                                                         .getIdentifier())),\n-                                      paramModel, extensionModelHelper);\n-              }\n-\n-            }));\n+    model.getAllParameterModels()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0NzkwMw=="}, "originalCommit": {"oid": "b644ab8a74d569ac69f176f6aae6f4ae552d58a2"}, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMTkyNzMxOnYy", "diffSide": "RIGHT", "path": "modules/spring-config/src/main/java/org/mule/runtime/config/internal/model/type/ApplicationModelTypeUtils.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMDozNjozNlrOG7H5EQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMDozNzo0M1rOG7H7Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0ODQ2NQ==", "bodyText": "the flatMaps in a row?? ufff...", "url": "https://github.com/mulesoft/mule/pull/9152#discussion_r464648465", "createdAt": "2020-08-03T20:36:36Z", "author": {"login": "marianogonzalez"}, "path": "modules/spring-config/src/main/java/org/mule/runtime/config/internal/model/type/ApplicationModelTypeUtils.java", "diffHunk": "@@ -309,26 +334,46 @@ private static void enrichComponentModels(ComponentModel componentModel,\n   }\n \n   private static void handleWrappedElement(ComponentModel componentModel, ComponentModel wrappedComponent,\n-                                           ParameterModel paramModel, ExtensionModelHelper extensionModelHelper) {\n+                                           ParameterModel paramModel, DslElementSyntax paramDsl,\n+                                           ExtensionModelHelper extensionModelHelper) {\n     Multimap<ComponentIdentifier, ComponentModel> nestedWrappedComponents = getNestedComponents(wrappedComponent);\n \n-    Map<ObjectType, Optional<DslElementSyntax>> objectTypeOptionalMap =\n-        extensionModelHelper.resolveSubTypes((ObjectType) paramModel.getType());\n+    paramModel.getType().accept(new MetadataTypeVisitor() {\n \n-    objectTypeOptionalMap.entrySet().stream().filter(entry -> {\n-      if (entry.getValue().isPresent()) {\n-        return getSingleComponentModel(nestedWrappedComponents, getIdentifier(entry.getValue().get())) != null;\n+      @Override\n+      public void visitObject(ObjectType objectType) {\n+        Map<ObjectType, Optional<DslElementSyntax>> objectTypeOptionalMap =\n+            extensionModelHelper.resolveSubTypes((ObjectType) paramModel.getType());\n+\n+        objectTypeOptionalMap.entrySet().stream().filter(entry -> {\n+          if (entry.getValue().isPresent()) {\n+            return getSingleComponentModel(nestedWrappedComponents, getIdentifier(entry.getValue().get())) != null;\n+          }\n+          return false;\n+        }).findFirst().ifPresent(wrappedEntryType -> {\n+          DslElementSyntax wrappedDsl = wrappedEntryType.getValue().get();\n+          wrappedEntryType.getKey()\n+              .accept(getComponentChildVisitor(componentModel,\n+                                               paramModel,\n+                                               wrappedDsl,\n+                                               getSingleComponentModel(nestedWrappedComponents, getIdentifier(wrappedDsl)),\n+                                               extensionModelHelper));\n+        });\n+      }\n+\n+      @Override\n+      public void visitUnion(UnionType unionType) {\n+        unionType.getTypes()\n+            .forEach(type -> getTypeId(type)\n+                .flatMap(paramDsl::getChild)\n+                .flatMap(childDsl -> getIdentifier(childDsl))\n+                .flatMap(childComponentId -> ofNullable(nestedWrappedComponents.get(childComponentId)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b644ab8a74d569ac69f176f6aae6f4ae552d58a2"}, "originalPosition": 227}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0ODk5NA==", "bodyText": "The revenge of the Optionals", "url": "https://github.com/mulesoft/mule/pull/9152#discussion_r464648994", "createdAt": "2020-08-03T20:37:43Z", "author": {"login": "elrodro83"}, "path": "modules/spring-config/src/main/java/org/mule/runtime/config/internal/model/type/ApplicationModelTypeUtils.java", "diffHunk": "@@ -309,26 +334,46 @@ private static void enrichComponentModels(ComponentModel componentModel,\n   }\n \n   private static void handleWrappedElement(ComponentModel componentModel, ComponentModel wrappedComponent,\n-                                           ParameterModel paramModel, ExtensionModelHelper extensionModelHelper) {\n+                                           ParameterModel paramModel, DslElementSyntax paramDsl,\n+                                           ExtensionModelHelper extensionModelHelper) {\n     Multimap<ComponentIdentifier, ComponentModel> nestedWrappedComponents = getNestedComponents(wrappedComponent);\n \n-    Map<ObjectType, Optional<DslElementSyntax>> objectTypeOptionalMap =\n-        extensionModelHelper.resolveSubTypes((ObjectType) paramModel.getType());\n+    paramModel.getType().accept(new MetadataTypeVisitor() {\n \n-    objectTypeOptionalMap.entrySet().stream().filter(entry -> {\n-      if (entry.getValue().isPresent()) {\n-        return getSingleComponentModel(nestedWrappedComponents, getIdentifier(entry.getValue().get())) != null;\n+      @Override\n+      public void visitObject(ObjectType objectType) {\n+        Map<ObjectType, Optional<DslElementSyntax>> objectTypeOptionalMap =\n+            extensionModelHelper.resolveSubTypes((ObjectType) paramModel.getType());\n+\n+        objectTypeOptionalMap.entrySet().stream().filter(entry -> {\n+          if (entry.getValue().isPresent()) {\n+            return getSingleComponentModel(nestedWrappedComponents, getIdentifier(entry.getValue().get())) != null;\n+          }\n+          return false;\n+        }).findFirst().ifPresent(wrappedEntryType -> {\n+          DslElementSyntax wrappedDsl = wrappedEntryType.getValue().get();\n+          wrappedEntryType.getKey()\n+              .accept(getComponentChildVisitor(componentModel,\n+                                               paramModel,\n+                                               wrappedDsl,\n+                                               getSingleComponentModel(nestedWrappedComponents, getIdentifier(wrappedDsl)),\n+                                               extensionModelHelper));\n+        });\n+      }\n+\n+      @Override\n+      public void visitUnion(UnionType unionType) {\n+        unionType.getTypes()\n+            .forEach(type -> getTypeId(type)\n+                .flatMap(paramDsl::getChild)\n+                .flatMap(childDsl -> getIdentifier(childDsl))\n+                .flatMap(childComponentId -> ofNullable(nestedWrappedComponents.get(childComponentId)))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY0ODQ2NQ=="}, "originalCommit": {"oid": "b644ab8a74d569ac69f176f6aae6f4ae552d58a2"}, "originalPosition": 227}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4861, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}