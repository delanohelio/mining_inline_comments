{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0NDM4MTI1", "number": 8711, "title": "MULE-18077: Performance issues with functional idioms", "bodyText": "", "createdAt": "2020-03-05T18:40:14Z", "url": "https://github.com/mulesoft/mule/pull/8711", "merged": true, "mergeCommit": {"oid": "4cfc39bba48093e2276ba6f57654e192d2451660"}, "closed": true, "closedAt": "2020-03-06T14:04:01Z", "author": {"login": "marianogonzalez"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKuYmvAH2gAyMzg0NDM4MTI1OjlhN2U4OGI3YzU0YWIxNjQ3ZDkzZmZlMWU4MGU5ZTU5NGM0MGE4MmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcLAWR1gFqTM3MDMyOTI1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9a7e88b7c54ab1647d93ffe1e80e9e594c40a82a", "author": {"user": {"login": "marianogonzalez", "name": "Mariano Gonzalez"}}, "url": "https://github.com/mulesoft/mule/commit/9a7e88b7c54ab1647d93ffe1e80e9e594c40a82a", "committedDate": "2020-03-05T16:47:50Z", "message": "cherry picking locks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "420851df01b5a6e63b5a47a69366a792603b3d87", "author": {"user": {"login": "marianogonzalez", "name": "Mariano Gonzalez"}}, "url": "https://github.com/mulesoft/mule/commit/420851df01b5a6e63b5a47a69366a792603b3d87", "committedDate": "2020-03-05T16:47:51Z", "message": "compilation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cee14ac0e97e32551cb2110a86cd4f1235b7705f", "author": {"user": {"login": "marianogonzalez", "name": "Mariano Gonzalez"}}, "url": "https://github.com/mulesoft/mule/commit/cee14ac0e97e32551cb2110a86cd4f1235b7705f", "committedDate": "2020-03-05T16:47:51Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e2d541aeee8995655f7d24ef098917c423a8916", "author": {"user": {"login": "marianogonzalez", "name": "Mariano Gonzalez"}}, "url": "https://github.com/mulesoft/mule/commit/3e2d541aeee8995655f7d24ef098917c423a8916", "committedDate": "2020-03-05T16:47:51Z", "message": "jdoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4096ad528a3ccc85b3bb869b19cc9abcc0cc98f3", "author": {"user": {"login": "marianogonzalez", "name": "Mariano Gonzalez"}}, "url": "https://github.com/mulesoft/mule/commit/4096ad528a3ccc85b3bb869b19cc9abcc0cc98f3", "committedDate": "2020-03-05T16:47:51Z", "message": "format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ee52ec591596a3de5f5016fe6f8d3da0f16e98c", "author": {"user": {"login": "marianogonzalez", "name": "Mariano Gonzalez"}}, "url": "https://github.com/mulesoft/mule/commit/2ee52ec591596a3de5f5016fe6f8d3da0f16e98c", "committedDate": "2020-03-05T18:15:48Z", "message": "rebase"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5ODIzOTk3", "url": "https://github.com/mulesoft/mule/pull/8711#pullrequestreview-369823997", "createdAt": "2020-03-05T18:48:59Z", "commit": {"oid": "2ee52ec591596a3de5f5016fe6f8d3da0f16e98c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxODo0OTowMFrOFyflbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxODo1NDowMlrOFyfwaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5MDYwNA==", "bodyText": "what's the purpose of this method if most of the dirty work has to be done by the caller?", "url": "https://github.com/mulesoft/mule/pull/8711#discussion_r388490604", "createdAt": "2020-03-05T18:49:00Z", "author": {"login": "elrodro83"}, "path": "core/src/main/java/org/mule/runtime/core/api/util/ClassUtils.java", "diffHunk": "@@ -957,17 +971,49 @@ public static void withContextClassLoader(ClassLoader classLoader, Runnable runn\n     }\n   }\n \n+  /**\n+   * Sets {@code newClassLoader} as the context class loader for the {@code thread}, as long as said classloader is not the\n+   * same instance as {@code currentClassLoader}.\n+   * <p>\n+   * Since obtaining and setting the context classloader from a thread are expensive operations, the purpose of this method\n+   * is to avoid performing those operations when possible, which is why the two classloaders are tested not to be the same\n+   * before performing the set operation. For this method to make sense, {@code currentClassLoader} should actually be the\n+   * current context classloader from the {@code thread}.\n+   * <p>\n+   * This is how a typical use should look like:\n+   * <pre>\n+   *   Thread thread = Thread.currentThread();\n+   *   ClassLoader currentClassLoader = thread.getContextClassLoader();\n+   *   ClassLoader newClassLoader = getNewContextClassLoader(); // this one depends on your logic\n+   *   ClassUtils.setContextClassLoader(thread, currentClassLoader, newClassLoader);\n+   *   try {\n+   *     // execute your logic\n+   *   } finally {\n+   *     // set things back as they were by reversing the arguments order\n+   *     ClassUtils.setContextClassLoader(thread, newClassLoader, currentClassLoader);\n+   *   }\n+   * </pre>\n+   *\n+   * @param thread             the thread which context classloader is to be changed\n+   * @param currentClassLoader the thread's current context classloader\n+   * @param newClassLoader     the new classloader to be set\n+   * @since 4.3.0\n+   */\n+  public static void setContextClassLoader(Thread thread, ClassLoader currentClassLoader, ClassLoader newClassLoader) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ee52ec591596a3de5f5016fe6f8d3da0f16e98c"}, "originalPosition": 224}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5MDkwMQ==", "bodyText": "see?", "url": "https://github.com/mulesoft/mule/pull/8711#discussion_r388490901", "createdAt": "2020-03-05T18:49:34Z", "author": {"login": "elrodro83"}, "path": "core/src/main/java/org/mule/runtime/core/internal/execution/MuleMessageProcessingManager.java", "diffHunk": "@@ -38,8 +39,15 @@ public void initialise() throws InitialisationException {\n   @Override\n   public void processMessage(FlowProcessTemplate messageProcessTemplate,\n                              MessageProcessContext messageProcessContext) {\n-    withContextClassLoader(messageProcessContext.getExecutionClassLoader(),\n-                           () -> mediator.process(messageProcessTemplate, messageProcessContext, this));\n+    Thread currentThread = currentThread();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ee52ec591596a3de5f5016fe6f8d3da0f16e98c"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ5MzQxNg==", "bodyText": ":O", "url": "https://github.com/mulesoft/mule/pull/8711#discussion_r388493416", "createdAt": "2020-03-05T18:54:02Z", "author": {"login": "elrodro83"}, "path": "core/src/main/java/org/mule/runtime/core/internal/processor/interceptor/ReactiveInterceptorAdapter.java", "diffHunk": "@@ -127,15 +128,22 @@ protected ReactiveProcessor doApply(Processor component, ReactiveProcessor next,\n         LOGGER.debug(\"Calling before() for '{}' in processor '{}'...\", interceptor,\n                      component.getLocation().getLocation());\n       }\n-\n       try {\n-        withContextClassLoader(interceptor.getClass().getClassLoader(),\n-                               () -> interceptor.before(component.getLocation(),\n-                                                        getResolvedParams(eventWithResolvedParams),\n-                                                        interceptionEvent));\n+        Thread currentThread = currentThread();\n+        ClassLoader currentClassLoader = currentThread.getContextClassLoader();\n+        ClassLoader contextClassLoader = interceptor.getClass().getClassLoader();\n+        setContextClassLoader(currentThread, currentClassLoader, contextClassLoader);\n+        try {\n+          interceptor.before(component.getLocation(),\n+                             getResolvedParams(eventWithResolvedParams),\n+                             interceptionEvent);\n+        } finally {\n+          setContextClassLoader(currentThread, contextClassLoader, currentClassLoader);\n+        }\n+\n         return interceptionEvent.resolve();\n       } catch (Exception e) {\n-        throw propagate(new MessagingException(interceptionEvent.resolve(), e.getCause(), component));\n+        throw propagate(new MessagingException(interceptionEvent.resolve(), e, component));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ee52ec591596a3de5f5016fe6f8d3da0f16e98c"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMzI5MjU5", "url": "https://github.com/mulesoft/mule/pull/8711#pullrequestreview-370329259", "createdAt": "2020-03-06T13:43:35Z", "commit": {"oid": "2ee52ec591596a3de5f5016fe6f8d3da0f16e98c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 917, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}