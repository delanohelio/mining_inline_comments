{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0OTExNDAw", "number": 8647, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMToyMzowOFrODg245A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMTozMjozNFrODg3D6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NzgwMzI0OnYy", "diffSide": "RIGHT", "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/reconnection/ReconnectionTestCase.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMToyMzowOFrOFrS54Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNTowMjo0N1rOFrrtYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0MjgxNw==", "bodyText": "use the ExpectedException rule and assert on the cause being THE SAME instance you are expecting and the actual exception being of the correct type", "url": "https://github.com/mulesoft/mule/pull/8647#discussion_r380942817", "createdAt": "2020-02-18T21:23:08Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/reconnection/ReconnectionTestCase.java", "diffHunk": "@@ -106,13 +108,13 @@ public void getInlineRetryPolicyTemplate() throws Exception {\n   public void reconnectAfterConnectionExceptionOnFirstPage() throws Exception {\n     resetCounters();\n     Iterator<ReconnectableConnection> iterator = getCursor(\"pagedOperation\", 1, CONNECTIVITY);\n-    ReconnectableConnection firstPage = iterator.next();\n-    assertThat(\"Connection was not disconnected.\", firstPage.getDisconnectCalls(), is(1));\n+    iterator.next();\n+    assertThat(\"Connection was not disconnected.\", disconnectCalls, is(1));\n     assertThat(\"Paging provider was not closed.\", closePagingProviderCalls, is(1));\n   }\n \n-  @Test\n-  public void doNotReconnectAfterOtherExceptionOnFirstPage() {\n+  @Test(expected = IllegalArgumentException.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76d275e6aff35d8e6eeab109e2e82bc4fbd203ae"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM0OTIxNw==", "bodyText": "I tried the approach with ExpectedException, but it does not allow me to assert other things after the exception is thrown (like the paging provider closing or the disconnection calls).", "url": "https://github.com/mulesoft/mule/pull/8647#discussion_r381349217", "createdAt": "2020-02-19T15:02:47Z", "author": {"login": "SebaElizalde"}, "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/reconnection/ReconnectionTestCase.java", "diffHunk": "@@ -106,13 +108,13 @@ public void getInlineRetryPolicyTemplate() throws Exception {\n   public void reconnectAfterConnectionExceptionOnFirstPage() throws Exception {\n     resetCounters();\n     Iterator<ReconnectableConnection> iterator = getCursor(\"pagedOperation\", 1, CONNECTIVITY);\n-    ReconnectableConnection firstPage = iterator.next();\n-    assertThat(\"Connection was not disconnected.\", firstPage.getDisconnectCalls(), is(1));\n+    iterator.next();\n+    assertThat(\"Connection was not disconnected.\", disconnectCalls, is(1));\n     assertThat(\"Paging provider was not closed.\", closePagingProviderCalls, is(1));\n   }\n \n-  @Test\n-  public void doNotReconnectAfterOtherExceptionOnFirstPage() {\n+  @Test(expected = IllegalArgumentException.class)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0MjgxNw=="}, "originalCommit": {"oid": "76d275e6aff35d8e6eeab109e2e82bc4fbd203ae"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NzgwNDA0OnYy", "diffSide": "RIGHT", "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/reconnection/ReconnectionTestCase.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMToyMzoyNlrOFrS6aA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMToyMzoyNlrOFrS6aA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0Mjk1Mg==", "bodyText": "replace all of this with the expectedException rule", "url": "https://github.com/mulesoft/mule/pull/8647#discussion_r380942952", "createdAt": "2020-02-18T21:23:26Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/reconnection/ReconnectionTestCase.java", "diffHunk": "@@ -123,18 +125,83 @@ public void doNotReconnectAfterOtherExceptionOnFirstPage() {\n       assertThat(e.getMessage(), is(\"An illegal argument was received.\"));\n       assertThat(\"Paging provider was not closed.\", closePagingProviderCalls, is(1));\n       assertThat(\"Connection was disconnected.\", disconnectCalls, is(0));\n+      throw e.getCause();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76d275e6aff35d8e6eeab109e2e82bc4fbd203ae"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NzgwNDgwOnYy", "diffSide": "RIGHT", "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/reconnection/ReconnectionTestCase.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMToyMzo0MFrOFrS63w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMToyMzo0MFrOFrS63w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0MzA3MQ==", "bodyText": "same as before", "url": "https://github.com/mulesoft/mule/pull/8647#discussion_r380943071", "createdAt": "2020-02-18T21:23:40Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/reconnection/ReconnectionTestCase.java", "diffHunk": "@@ -123,18 +125,83 @@ public void doNotReconnectAfterOtherExceptionOnFirstPage() {\n       assertThat(e.getMessage(), is(\"An illegal argument was received.\"));\n       assertThat(\"Paging provider was not closed.\", closePagingProviderCalls, is(1));\n       assertThat(\"Connection was disconnected.\", disconnectCalls, is(0));\n+      throw e.getCause();\n+    }\n+  }\n+\n+  @Test\n+  public void reconnectionDuringConnectionExceptionOnSecondPage() throws Exception {\n+    resetCounters();\n+    Iterator<ReconnectableConnection> iterator = getCursor(\"pagedOperation\", 2, CONNECTIVITY);\n+\n+    iterator.next();\n+    assertThat(\"Connection was disconnected.\", disconnectCalls, is(0));\n+    assertThat(\"Paging provider was closed.\", closePagingProviderCalls, is(0));\n+\n+    iterator.next();\n+    assertThat(\"Connection was not disconnected.\", disconnectCalls, is(1));\n+    assertThat(\"Paging provider was closed.\", closePagingProviderCalls, is(0));\n+  }\n+\n+  @Test(expected = IllegalArgumentException.class)\n+  public void doNotReconnectAfterOtherExceptionOnSecondPage() throws Exception {\n+    resetCounters();\n+    Iterator<ReconnectableConnection> iterator;\n+    try {\n+      iterator = getCursor(\"pagedOperation\", 2, VALIDATION);\n+      iterator.next();\n+      iterator.next();\n+    } catch (Exception e) {\n+      assertThat(e, instanceOf(IllegalArgumentException.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76d275e6aff35d8e6eeab109e2e82bc4fbd203ae"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NzgwNTEzOnYy", "diffSide": "RIGHT", "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/reconnection/ReconnectionTestCase.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMToyMzo0N1rOFrS7EQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMToyMzo0N1rOFrS7EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0MzEyMQ==", "bodyText": "same as before", "url": "https://github.com/mulesoft/mule/pull/8647#discussion_r380943121", "createdAt": "2020-02-18T21:23:47Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/reconnection/ReconnectionTestCase.java", "diffHunk": "@@ -123,18 +125,83 @@ public void doNotReconnectAfterOtherExceptionOnFirstPage() {\n       assertThat(e.getMessage(), is(\"An illegal argument was received.\"));\n       assertThat(\"Paging provider was not closed.\", closePagingProviderCalls, is(1));\n       assertThat(\"Connection was disconnected.\", disconnectCalls, is(0));\n+      throw e.getCause();\n+    }\n+  }\n+\n+  @Test\n+  public void reconnectionDuringConnectionExceptionOnSecondPage() throws Exception {\n+    resetCounters();\n+    Iterator<ReconnectableConnection> iterator = getCursor(\"pagedOperation\", 2, CONNECTIVITY);\n+\n+    iterator.next();\n+    assertThat(\"Connection was disconnected.\", disconnectCalls, is(0));\n+    assertThat(\"Paging provider was closed.\", closePagingProviderCalls, is(0));\n+\n+    iterator.next();\n+    assertThat(\"Connection was not disconnected.\", disconnectCalls, is(1));\n+    assertThat(\"Paging provider was closed.\", closePagingProviderCalls, is(0));\n+  }\n+\n+  @Test(expected = IllegalArgumentException.class)\n+  public void doNotReconnectAfterOtherExceptionOnSecondPage() throws Exception {\n+    resetCounters();\n+    Iterator<ReconnectableConnection> iterator;\n+    try {\n+      iterator = getCursor(\"pagedOperation\", 2, VALIDATION);\n+      iterator.next();\n+      iterator.next();\n+    } catch (Exception e) {\n+      assertThat(e, instanceOf(IllegalArgumentException.class));\n+      assertThat(e.getMessage(), is(\"An illegal argument was received.\"));\n+      assertThat(\"Paging provider was not closed.\", closePagingProviderCalls, is(0));\n+      assertThat(\"Connection was disconnected.\", disconnectCalls, is(0));\n+      throw e;\n     }\n   }\n \n   @Test\n   public void stickyConnectionIsClosedAndReconnectedDuringConnectionExceptionOnFirstPage() throws Exception {\n     resetCounters();\n     Iterator<ReconnectableConnection> iterator = getCursor(\"stickyPagedOperation\", 1, CONNECTIVITY);\n-    ReconnectableConnection firstPage = iterator.next();\n-    assertThat(\"Connection was not disconnected.\", firstPage.getDisconnectCalls(), is(1));\n+    iterator.next();\n+    assertThat(\"Connection was not disconnected.\", disconnectCalls, is(1));\n     assertThat(\"Paging provider was not closed.\", closePagingProviderCalls, is(1));\n   }\n \n+  @Test(expected = ModuleException.class)\n+  public void stickyConnectionIsNotReconnectedDuringConnectionExceptionOnSecondPage() throws Exception {\n+    resetCounters();\n+    try {\n+      Iterator<ReconnectableConnection> iterator = getCursor(\"stickyPagedOperation\", 2, CONNECTIVITY);\n+      iterator.next();\n+      iterator.next();\n+    } catch (Exception e) {\n+      assertThat(e, instanceOf(ModuleException.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76d275e6aff35d8e6eeab109e2e82bc4fbd203ae"}, "originalPosition": 92}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NzgwNTQ0OnYy", "diffSide": "RIGHT", "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/reconnection/ReconnectionTestCase.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMToyMzo1NFrOFrS7SQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMToyMzo1NFrOFrS7SQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0MzE3Nw==", "bodyText": "same as before", "url": "https://github.com/mulesoft/mule/pull/8647#discussion_r380943177", "createdAt": "2020-02-18T21:23:54Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/reconnection/ReconnectionTestCase.java", "diffHunk": "@@ -123,18 +125,83 @@ public void doNotReconnectAfterOtherExceptionOnFirstPage() {\n       assertThat(e.getMessage(), is(\"An illegal argument was received.\"));\n       assertThat(\"Paging provider was not closed.\", closePagingProviderCalls, is(1));\n       assertThat(\"Connection was disconnected.\", disconnectCalls, is(0));\n+      throw e.getCause();\n+    }\n+  }\n+\n+  @Test\n+  public void reconnectionDuringConnectionExceptionOnSecondPage() throws Exception {\n+    resetCounters();\n+    Iterator<ReconnectableConnection> iterator = getCursor(\"pagedOperation\", 2, CONNECTIVITY);\n+\n+    iterator.next();\n+    assertThat(\"Connection was disconnected.\", disconnectCalls, is(0));\n+    assertThat(\"Paging provider was closed.\", closePagingProviderCalls, is(0));\n+\n+    iterator.next();\n+    assertThat(\"Connection was not disconnected.\", disconnectCalls, is(1));\n+    assertThat(\"Paging provider was closed.\", closePagingProviderCalls, is(0));\n+  }\n+\n+  @Test(expected = IllegalArgumentException.class)\n+  public void doNotReconnectAfterOtherExceptionOnSecondPage() throws Exception {\n+    resetCounters();\n+    Iterator<ReconnectableConnection> iterator;\n+    try {\n+      iterator = getCursor(\"pagedOperation\", 2, VALIDATION);\n+      iterator.next();\n+      iterator.next();\n+    } catch (Exception e) {\n+      assertThat(e, instanceOf(IllegalArgumentException.class));\n+      assertThat(e.getMessage(), is(\"An illegal argument was received.\"));\n+      assertThat(\"Paging provider was not closed.\", closePagingProviderCalls, is(0));\n+      assertThat(\"Connection was disconnected.\", disconnectCalls, is(0));\n+      throw e;\n     }\n   }\n \n   @Test\n   public void stickyConnectionIsClosedAndReconnectedDuringConnectionExceptionOnFirstPage() throws Exception {\n     resetCounters();\n     Iterator<ReconnectableConnection> iterator = getCursor(\"stickyPagedOperation\", 1, CONNECTIVITY);\n-    ReconnectableConnection firstPage = iterator.next();\n-    assertThat(\"Connection was not disconnected.\", firstPage.getDisconnectCalls(), is(1));\n+    iterator.next();\n+    assertThat(\"Connection was not disconnected.\", disconnectCalls, is(1));\n     assertThat(\"Paging provider was not closed.\", closePagingProviderCalls, is(1));\n   }\n \n+  @Test(expected = ModuleException.class)\n+  public void stickyConnectionIsNotReconnectedDuringConnectionExceptionOnSecondPage() throws Exception {\n+    resetCounters();\n+    try {\n+      Iterator<ReconnectableConnection> iterator = getCursor(\"stickyPagedOperation\", 2, CONNECTIVITY);\n+      iterator.next();\n+      iterator.next();\n+    } catch (Exception e) {\n+      assertThat(e, instanceOf(ModuleException.class));\n+      assertThat(e.getCause(), instanceOf(ConnectionException.class));\n+      assertThat(e.getCause().getMessage(), is(\"Failed to retrieve Page\"));\n+      assertThat(\"Paging provider was not closed.\", closePagingProviderCalls, is(0));\n+      assertThat(\"Connection was not disconnected.\", disconnectCalls, is(1));\n+      throw e;\n+    }\n+  }\n+\n+  @Test(expected = IllegalArgumentException.class)\n+  public void stickyConnectionIsNotReconnectedDuringOtherExceptionOnSecondPage() throws Exception {\n+    resetCounters();\n+    try {\n+      Iterator<ReconnectableConnection> iterator = getCursor(\"stickyPagedOperation\", 2, VALIDATION);\n+      iterator.next();\n+      iterator.next();\n+    } catch (Exception e) {\n+      assertThat(e, instanceOf(IllegalArgumentException.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76d275e6aff35d8e6eeab109e2e82bc4fbd203ae"}, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NzgxNjMyOnYy", "diffSide": "RIGHT", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/streaming/PagingProviderProducer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMToyNzozNFrOFrTCCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMToyNzozNFrOFrTCCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0NDkwNQ==", "bodyText": "Define constant in org.mule.runtime.module.extension.internal.ExtensionProperties. Also the key should start with the proper prefix.", "url": "https://github.com/mulesoft/mule/pull/8647#discussion_r380944905", "createdAt": "2020-02-18T21:27:34Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/streaming/PagingProviderProducer.java", "diffHunk": "@@ -91,27 +101,58 @@ public int getSize() {\n    * @return\n    */\n   private <R> R performWithConnection(Function<Object, R> function) {\n+    Optional<MutableConfigurationStats> stats = getMutableConfigurationStats(executionContext);\n+    RetryPolicyTemplate retryPolicy =\n+        (RetryPolicyTemplate) executionContext.getRetryPolicyTemplate().orElseGet(NoRetryPolicyTemplate::new);\n+    CompletableFuture<R> future = retryPolicy.applyPolicy(() -> completedFuture(withConnection(function)),\n+                                                          e -> !isFirstPage && !delegate.useStickyConnections()\n+                                                              && shouldRetry(e, executionContext),\n+                                                          e -> {\n+                                                          },\n+                                                          e -> stats.ifPresent(s -> s.discountInflightOperation()),\n+                                                          identity(),\n+                                                          executionContext.getCurrentScheduler());\n+    try {\n+      return future.get();\n+    } catch (ExecutionException e) {\n+      if (e.getCause() instanceof RuntimeException) {\n+        throw (RuntimeException) e.getCause();\n+      }\n+      throw new MuleRuntimeException(createStaticMessage(COULD_NOT_EXECUTE), e.getCause());\n+    } catch (InterruptedException e) {\n+      throw new MuleRuntimeException(createStaticMessage(COULD_NOT_EXECUTE), e);\n+    }\n+  }\n+\n+  private <R> R withConnection(Function<Object, R> function) {\n     ConnectionSupplier connectionSupplier = getConnectionSupplier();\n     Object connection = getConnection(connectionSupplier);\n     try {\n       R result = function.apply(connection);\n       return result;\n-    } catch (Exception exception) {\n+    } catch (Exception caughtException) {\n       if (isFirstPage) {\n         safely(() -> delegate.close(connection), e -> LOGGER.debug(\"Found exception closing paging provider\", e));\n       }\n-      extractConnectionException(exception).ifPresent(ex -> {\n-        if (isTransactional()) {\n-          executionContext.setVariable(DO_NOT_RETRY, \"true\");\n-        }\n-        connectionSupplier.invalidateConnection();\n-      });\n-      throw exception;\n+      extractConnectionException(caughtException).ifPresent(e -> handleConnectionException(e, connectionSupplier));\n+      throw caughtException;\n     } finally {\n       safely(connectionSupplier::close, e -> LOGGER.debug(\"Found exception closing the connection supplier\", e));\n     }\n   }\n \n+  private void handleConnectionException(ConnectionException connectionException, ConnectionSupplier connectionSupplier) {\n+    Optional<String> exceptionConfigName =\n+        executionContext.getConfiguration().map(config -> ((ConfigurationInstance) config).getName());\n+    if (isTransactional()) {\n+      connectionException.addInfo(\"wasTransactional\", true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76d275e6aff35d8e6eeab109e2e82bc4fbd203ae"}, "originalPosition": 102}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NzgxODc4OnYy", "diffSide": "RIGHT", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/streaming/PagingProviderProducer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMToyODoyMlrOFrTDlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMToyODoyMlrOFrTDlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0NTMwMA==", "bodyText": "same", "url": "https://github.com/mulesoft/mule/pull/8647#discussion_r380945300", "createdAt": "2020-02-18T21:28:22Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/streaming/PagingProviderProducer.java", "diffHunk": "@@ -91,27 +101,58 @@ public int getSize() {\n    * @return\n    */\n   private <R> R performWithConnection(Function<Object, R> function) {\n+    Optional<MutableConfigurationStats> stats = getMutableConfigurationStats(executionContext);\n+    RetryPolicyTemplate retryPolicy =\n+        (RetryPolicyTemplate) executionContext.getRetryPolicyTemplate().orElseGet(NoRetryPolicyTemplate::new);\n+    CompletableFuture<R> future = retryPolicy.applyPolicy(() -> completedFuture(withConnection(function)),\n+                                                          e -> !isFirstPage && !delegate.useStickyConnections()\n+                                                              && shouldRetry(e, executionContext),\n+                                                          e -> {\n+                                                          },\n+                                                          e -> stats.ifPresent(s -> s.discountInflightOperation()),\n+                                                          identity(),\n+                                                          executionContext.getCurrentScheduler());\n+    try {\n+      return future.get();\n+    } catch (ExecutionException e) {\n+      if (e.getCause() instanceof RuntimeException) {\n+        throw (RuntimeException) e.getCause();\n+      }\n+      throw new MuleRuntimeException(createStaticMessage(COULD_NOT_EXECUTE), e.getCause());\n+    } catch (InterruptedException e) {\n+      throw new MuleRuntimeException(createStaticMessage(COULD_NOT_EXECUTE), e);\n+    }\n+  }\n+\n+  private <R> R withConnection(Function<Object, R> function) {\n     ConnectionSupplier connectionSupplier = getConnectionSupplier();\n     Object connection = getConnection(connectionSupplier);\n     try {\n       R result = function.apply(connection);\n       return result;\n-    } catch (Exception exception) {\n+    } catch (Exception caughtException) {\n       if (isFirstPage) {\n         safely(() -> delegate.close(connection), e -> LOGGER.debug(\"Found exception closing paging provider\", e));\n       }\n-      extractConnectionException(exception).ifPresent(ex -> {\n-        if (isTransactional()) {\n-          executionContext.setVariable(DO_NOT_RETRY, \"true\");\n-        }\n-        connectionSupplier.invalidateConnection();\n-      });\n-      throw exception;\n+      extractConnectionException(caughtException).ifPresent(e -> handleConnectionException(e, connectionSupplier));\n+      throw caughtException;\n     } finally {\n       safely(connectionSupplier::close, e -> LOGGER.debug(\"Found exception closing the connection supplier\", e));\n     }\n   }\n \n+  private void handleConnectionException(ConnectionException connectionException, ConnectionSupplier connectionSupplier) {\n+    Optional<String> exceptionConfigName =\n+        executionContext.getConfiguration().map(config -> ((ConfigurationInstance) config).getName());\n+    if (isTransactional()) {\n+      connectionException.addInfo(\"wasTransactional\", true);\n+    }\n+    if (isFirstPage) {\n+      exceptionConfigName.ifPresent(name -> connectionException.addInfo(\"operationConfigName\", name));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76d275e6aff35d8e6eeab109e2e82bc4fbd203ae"}, "originalPosition": 105}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NzgyNTg5OnYy", "diffSide": "RIGHT", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/util/ReconnectionUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMTozMDo0MlrOFrTILA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMTozMDo0MlrOFrTILA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0NjQ3Ng==", "bodyText": "return Objects.equals(operaetionConfigName, contextConfigName)", "url": "https://github.com/mulesoft/mule/pull/8647#discussion_r380946476", "createdAt": "2020-02-18T21:30:42Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/util/ReconnectionUtils.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.extension.internal.util;\n+\n+import static java.lang.Boolean.parseBoolean;\n+import static org.mule.runtime.core.api.transaction.TransactionCoordination.isTransactionActive;\n+import static org.mule.runtime.core.api.util.ExceptionUtils.extractConnectionException;\n+import static org.mule.runtime.module.extension.internal.ExtensionProperties.DO_NOT_RETRY;\n+\n+import org.mule.runtime.api.connection.ConnectionException;\n+import org.mule.runtime.core.api.transaction.Transaction;\n+import org.mule.runtime.core.api.transaction.TransactionCoordination;\n+import org.mule.runtime.extension.api.runtime.config.ConfigurationInstance;\n+import org.mule.runtime.module.extension.api.runtime.privileged.ExecutionContextAdapter;\n+import org.mule.runtime.module.extension.internal.runtime.transaction.ExtensionTransactionKey;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Utilities for handling reconnection on operations that use a connection.\n+ *\n+ * @since 4.2.3\n+ */\n+public class ReconnectionUtils {\n+\n+  /**\n+   * @param t the {@link Throwable} thrown during the execution of the operation\n+   * @param context the {@link ExecutionContextAdapter} that contains the context information about the operation's execution\n+   * @return whether or not the operation should be retried\n+   */\n+  public static boolean shouldRetry(Throwable t, ExecutionContextAdapter<?> context) {\n+    Optional<String> contextConfigName = context.getConfiguration().map(ConfigurationInstance::getName);\n+    Optional<ConnectionException> connectionException = extractConnectionException(t);\n+    if (Boolean.valueOf(context.getVariable(DO_NOT_RETRY)) || !connectionException.isPresent()) {\n+      return false;\n+    }\n+\n+    if (isTransactionActive()) {\n+      Transaction tx = TransactionCoordination.getInstance().getTransaction();\n+\n+      return !tx.hasResource(new ExtensionTransactionKey(context.getConfiguration().get()));\n+    }\n+\n+    return validateConnectionException(connectionException.get(), contextConfigName.orElse(null));\n+  }\n+\n+  private static boolean validateConnectionException(ConnectionException connectionException, String contextConfigName) {\n+    Boolean wasTransactional = (Boolean) connectionException.getInfo().get(\"wasTransactional\");\n+    if (wasTransactional != null && wasTransactional) {\n+      return false;\n+    }\n+    Object operationConfigName = connectionException.getInfo().get(\"operationConfigName\");\n+    if (operationConfigName != null && contextConfigName != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76d275e6aff35d8e6eeab109e2e82bc4fbd203ae"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NzgzMTQ3OnYy", "diffSide": "RIGHT", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/util/ReconnectionUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMTozMjozNFrOFrTLug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMTozMjozNFrOFrTLug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0NzM4Ng==", "bodyText": "a boolean method should not start with validate. Give this a more meaningful name and add a comment explaining why this is necessary", "url": "https://github.com/mulesoft/mule/pull/8647#discussion_r380947386", "createdAt": "2020-02-18T21:32:34Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/util/ReconnectionUtils.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.extension.internal.util;\n+\n+import static java.lang.Boolean.parseBoolean;\n+import static org.mule.runtime.core.api.transaction.TransactionCoordination.isTransactionActive;\n+import static org.mule.runtime.core.api.util.ExceptionUtils.extractConnectionException;\n+import static org.mule.runtime.module.extension.internal.ExtensionProperties.DO_NOT_RETRY;\n+\n+import org.mule.runtime.api.connection.ConnectionException;\n+import org.mule.runtime.core.api.transaction.Transaction;\n+import org.mule.runtime.core.api.transaction.TransactionCoordination;\n+import org.mule.runtime.extension.api.runtime.config.ConfigurationInstance;\n+import org.mule.runtime.module.extension.api.runtime.privileged.ExecutionContextAdapter;\n+import org.mule.runtime.module.extension.internal.runtime.transaction.ExtensionTransactionKey;\n+\n+import java.util.Optional;\n+\n+/**\n+ * Utilities for handling reconnection on operations that use a connection.\n+ *\n+ * @since 4.2.3\n+ */\n+public class ReconnectionUtils {\n+\n+  /**\n+   * @param t the {@link Throwable} thrown during the execution of the operation\n+   * @param context the {@link ExecutionContextAdapter} that contains the context information about the operation's execution\n+   * @return whether or not the operation should be retried\n+   */\n+  public static boolean shouldRetry(Throwable t, ExecutionContextAdapter<?> context) {\n+    Optional<String> contextConfigName = context.getConfiguration().map(ConfigurationInstance::getName);\n+    Optional<ConnectionException> connectionException = extractConnectionException(t);\n+    if (Boolean.valueOf(context.getVariable(DO_NOT_RETRY)) || !connectionException.isPresent()) {\n+      return false;\n+    }\n+\n+    if (isTransactionActive()) {\n+      Transaction tx = TransactionCoordination.getInstance().getTransaction();\n+\n+      return !tx.hasResource(new ExtensionTransactionKey(context.getConfiguration().get()));\n+    }\n+\n+    return validateConnectionException(connectionException.get(), contextConfigName.orElse(null));\n+  }\n+\n+  private static boolean validateConnectionException(ConnectionException connectionException, String contextConfigName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76d275e6aff35d8e6eeab109e2e82bc4fbd203ae"}, "originalPosition": 51}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 96, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}