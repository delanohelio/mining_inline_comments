{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzNjA4NTg3", "number": 8756, "title": "MULE-18219: Fix flaky DynamicConfigurationProviderTestCase", "bodyText": "Also fix:\n\nShutting down of app with dynamics configs restate already expired ones", "createdAt": "2020-03-25T14:06:59Z", "url": "https://github.com/mulesoft/mule/pull/8756", "merged": true, "mergeCommit": {"oid": "2ddb04fff5702cfca792dece011f8dcdab0e28d0"}, "closed": true, "closedAt": "2020-03-25T20:25:03Z", "author": {"login": "elrodro83"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRHERoAH2gAyMzkzNjA4NTg3OjEyNTUxZTc1ZTgyNjhlNzBhNWM4MGM1Y2RkMTc2YTFiMmJmNWVkNDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRMt8HAFqTM4MTQ3MTYyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "12551e75e8268e70a5c80c5cdd176a1b2bf5ed46", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/12551e75e8268e70a5c80c5cdd176a1b2bf5ed46", "committedDate": "2020-03-25T12:56:48Z", "message": "MULE-18219: Fix flaky DynamicConfigurationProviderTestCase"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMTg0MzQ3", "url": "https://github.com/mulesoft/mule/pull/8756#pullrequestreview-381184347", "createdAt": "2020-03-25T14:11:31Z", "commit": {"oid": "12551e75e8268e70a5c80c5cdd176a1b2bf5ed46"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNDoxMTozMlrOF7c7aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNDoxNDo0NFrOF7dEjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg4NDI2Nw==", "bodyText": "I don't think this added parameter is a good idea. Why not just injecting the MuleContext and using the isStopping() method?", "url": "https://github.com/mulesoft/mule/pull/8756#discussion_r397884267", "createdAt": "2020-03-25T14:11:32Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/ExtensionComponent.java", "diffHunk": "@@ -158,7 +159,7 @@\n \n   protected MetadataCacheIdGenerator<ComponentAst> cacheIdGenerator;\n \n-  private Function<CoreEvent, Optional<ConfigurationInstance>> configurationResolver;\n+  private BiFunction<CoreEvent, Boolean, Optional<ConfigurationInstance>> configurationResolver;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12551e75e8268e70a5c80c5cdd176a1b2bf5ed46"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzg4NjYwNQ==", "bodyText": "This isn't a matter of not populating the cache. If the context is stopping, the dynamic config shouldn't be spawned at all.", "url": "https://github.com/mulesoft/mule/pull/8756#discussion_r397886605", "createdAt": "2020-03-25T14:14:44Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/ExtensionComponent.java", "diffHunk": "@@ -215,26 +216,31 @@ private void initConfigurationResolver() {\n \n     Optional<ConfigurationInstance> staticConfiguration = getStaticConfiguration();\n     if (staticConfiguration.isPresent()) {\n-      configurationResolver = event -> staticConfiguration;\n+      configurationResolver = (event, stopping) -> staticConfiguration;\n       return;\n     }\n \n     if (isConfigurationSpecified()) {\n       // the config is dynamic\n-      configurationResolver = event -> {\n-        ConfigurationInstance instance = configurationProvider.get().get(event);\n-        if (instance == null) {\n-          throw new IllegalModelDefinitionException(format(\n-                                                           \"Root component '%s' contains a reference to config '%s' but it doesn't exists\",\n-                                                           getLocation().getRootContainerName(),\n-                                                           configurationProvider));\n-        }\n+      configurationResolver = (event, stopping) -> {\n+        if (stopping) {\n+          // Avoid populating the cache of dynamic connections if stopping\n+          return configurationProvider.get().getIfPresent(event);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12551e75e8268e70a5c80c5cdd176a1b2bf5ed46"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0589297367d6289ce00d74d5a46ba8364888b0bf", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/0589297367d6289ce00d74d5a46ba8364888b0bf", "committedDate": "2020-03-25T14:53:34Z", "message": "review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMjMyNjcy", "url": "https://github.com/mulesoft/mule/pull/8756#pullrequestreview-381232672", "createdAt": "2020-03-25T14:59:12Z", "commit": {"oid": "0589297367d6289ce00d74d5a46ba8364888b0bf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNDo1OToxMlrOF7fRlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNDo1OToxMlrOF7fRlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkyMjcxMA==", "bodyText": "this if seems to be inverted, but also conceptually wrong..\nif the context is not stopping, then you need to do getConfiguration() as usual so that the cache is used. If the context IS stopping, then no new config should be created. Also, the compute method you added should never be explicitly called. If a dynamic config is not added to the cache, then it will never be stopped and will generate a leak.", "url": "https://github.com/mulesoft/mule/pull/8756#discussion_r397922710", "createdAt": "2020-03-25T14:59:12Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/config/DynamicConfigurationProvider.java", "diffHunk": "@@ -140,15 +141,25 @@ public ConfigurationInstance get(Event event) {\n         if (connectionProviderResolver.getResolverSet().isPresent()) {\n           providerResult = ((ResolverSet) connectionProviderResolver.getResolverSet().get()).resolve(resolvingContext);\n         }\n-        return getConfiguration(new Pair<>(result, providerResult), (CoreEvent) event);\n+\n+        if (muleContext.isStopping() || muleContext.isStopped()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0589297367d6289ce00d74d5a46ba8364888b0bf"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14ec9913c6909ed9c5bff54fc0590aee282aed23", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/14ec9913c6909ed9c5bff54fc0590aee282aed23", "committedDate": "2020-03-25T17:02:25Z", "message": "different approach"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e24a69d96de813d5e60fe617a27ba43b4f26f9b8", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/e24a69d96de813d5e60fe617a27ba43b4f26f9b8", "committedDate": "2020-03-25T17:45:20Z", "message": "unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "807d1e1ca5d583f797af0d1cb2b80ec52c1757a1", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/807d1e1ca5d583f797af0d1cb2b80ec52c1757a1", "committedDate": "2020-03-25T17:48:51Z", "message": "format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cc0c37909783c5b37e5856ca558c1a8f233a95b", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/3cc0c37909783c5b37e5856ca558c1a8f233a95b", "committedDate": "2020-03-25T19:00:39Z", "message": "making MG happy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNDcxNjI3", "url": "https://github.com/mulesoft/mule/pull/8756#pullrequestreview-381471627", "createdAt": "2020-03-25T19:31:50Z", "commit": {"oid": "3cc0c37909783c5b37e5856ca558c1a8f233a95b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 752, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}