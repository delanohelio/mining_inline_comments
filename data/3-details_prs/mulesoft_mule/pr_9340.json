{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4MDYwNTc2", "number": 9340, "title": "MULE-18726: Support new SDK Result in the ReturnDelegate implementations", "bodyText": "", "createdAt": "2020-09-02T18:14:34Z", "url": "https://github.com/mulesoft/mule/pull/9340", "merged": true, "mergeCommit": {"oid": "d643fbc2fb553efd151e9b9e5d4e8e9b44f1cdf5"}, "closed": true, "closedAt": "2020-09-04T18:13:40Z", "author": {"login": "marianogonzalez"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFB651ABqjM3MjE2MTQ0Mzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFoQzogFqTQ4MjgxODY5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c5b9a2072b7c6a71eb5bbe4895410375104b9061", "author": {"user": {"login": "marianogonzalez", "name": "Mariano Gonzalez"}}, "url": "https://github.com/mulesoft/mule/commit/c5b9a2072b7c6a71eb5bbe4895410375104b9061", "committedDate": "2020-09-02T18:14:18Z", "message": "self review"}, "afterCommit": {"oid": "d181b84d53e123ceef40cadedbf3ee77ccb18154", "author": {"user": {"login": "marianogonzalez", "name": "Mariano Gonzalez"}}, "url": "https://github.com/mulesoft/mule/commit/d181b84d53e123ceef40cadedbf3ee77ccb18154", "committedDate": "2020-09-02T20:20:48Z", "message": "self review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72c8ae256b8acb05b9224db08c40f23ff2ca1a5b", "author": {"user": {"login": "marianogonzalez", "name": "Mariano Gonzalez"}}, "url": "https://github.com/mulesoft/mule/commit/72c8ae256b8acb05b9224db08c40f23ff2ca1a5b", "committedDate": "2020-09-03T15:38:36Z", "message": "MULE-18726: Support new SDK Result in the ReturnDelegate implementations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78baba7511e61db6e2435db017e4cd1b66f6baa0", "author": {"user": {"login": "marianogonzalez", "name": "Mariano Gonzalez"}}, "url": "https://github.com/mulesoft/mule/commit/78baba7511e61db6e2435db017e4cd1b66f6baa0", "committedDate": "2020-09-03T15:38:36Z", "message": "self review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00d85f471154aa5f15c77afaacff9152b19f66f5", "author": {"user": {"login": "marianogonzalez", "name": "Mariano Gonzalez"}}, "url": "https://github.com/mulesoft/mule/commit/00d85f471154aa5f15c77afaacff9152b19f66f5", "committedDate": "2020-09-03T15:38:36Z", "message": "formatter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8abf0239ba4080f5835b7db5aad0069d2db03cbb", "author": {"user": {"login": "marianogonzalez", "name": "Mariano Gonzalez"}}, "url": "https://github.com/mulesoft/mule/commit/8abf0239ba4080f5835b7db5aad0069d2db03cbb", "committedDate": "2020-09-03T20:56:51Z", "message": "test fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72aae3df5124fac839721c899a2fbf528e39f0b3", "author": {"user": {"login": "marianogonzalez", "name": "Mariano Gonzalez"}}, "url": "https://github.com/mulesoft/mule/commit/72aae3df5124fac839721c899a2fbf528e39f0b3", "committedDate": "2020-09-03T21:12:23Z", "message": "jdoc and moving packages"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c9ff5c04e36889ae76f278c5c4cf3f57d784b127", "author": {"user": {"login": "marianogonzalez", "name": "Mariano Gonzalez"}}, "url": "https://github.com/mulesoft/mule/commit/c9ff5c04e36889ae76f278c5c4cf3f57d784b127", "committedDate": "2020-09-02T20:43:00Z", "message": "formatter"}, "afterCommit": {"oid": "72aae3df5124fac839721c899a2fbf528e39f0b3", "author": {"user": {"login": "marianogonzalez", "name": "Mariano Gonzalez"}}, "url": "https://github.com/mulesoft/mule/commit/72aae3df5124fac839721c899a2fbf528e39f0b3", "committedDate": "2020-09-03T21:12:23Z", "message": "jdoc and moving packages"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMjEwOTk5", "url": "https://github.com/mulesoft/mule/pull/9340#pullrequestreview-482210999", "createdAt": "2020-09-03T21:20:15Z", "commit": {"oid": "72aae3df5124fac839721c899a2fbf528e39f0b3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QyMToyMDoxNVrOHM33zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QyMToyMDo0M1rOHM34kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI2MDM2NQ==", "bodyText": "if transformAll was already called, this TransformingIterator isn't needed and adds overhead", "url": "https://github.com/mulesoft/mule/pull/9340#discussion_r483260365", "createdAt": "2020-09-03T21:20:15Z", "author": {"login": "elrodro83"}, "path": "core/src/main/java/org/mule/runtime/core/internal/util/collection/TransformingCollection.java", "diffHunk": "@@ -78,18 +69,28 @@ public boolean contains(Object o) {\n     readLock.lock();\n     try {\n       boolean contains = delegate.contains(o);\n-      if (!contains && o instanceof Message) {\n-        contains = delegate.contains(Result.builder((Message) o));\n+      if (!contains && isTargetInstance(o)) {\n+        readLock.unlock();\n+        writeLock.lock();\n+        try {\n+          contains = delegate.contains(o);\n+          if (!contains) {\n+            transformAll();\n+          }\n+        } finally {\n+          readLock.lock();\n+          writeLock.unlock();\n+        }\n       }\n-      return contains;\n+      return delegate.contains(o);\n     } finally {\n       readLock.unlock();\n     }\n   }\n \n   @Override\n-  public Iterator<Message> iterator() {\n-    return new ResultToMessageIterator(delegate.iterator(), cursorProviderFactory, eventContext, originatingLocation);\n+  public Iterator<T> iterator() {\n+    return new TransformingIterator<>(delegate.iterator(), transformer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72aae3df5124fac839721c899a2fbf528e39f0b3"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI2MDU2MA==", "bodyText": "this applies to all menthods that do the transformation", "url": "https://github.com/mulesoft/mule/pull/9340#discussion_r483260560", "createdAt": "2020-09-03T21:20:43Z", "author": {"login": "elrodro83"}, "path": "core/src/main/java/org/mule/runtime/core/internal/util/collection/TransformingCollection.java", "diffHunk": "@@ -78,18 +69,28 @@ public boolean contains(Object o) {\n     readLock.lock();\n     try {\n       boolean contains = delegate.contains(o);\n-      if (!contains && o instanceof Message) {\n-        contains = delegate.contains(Result.builder((Message) o));\n+      if (!contains && isTargetInstance(o)) {\n+        readLock.unlock();\n+        writeLock.lock();\n+        try {\n+          contains = delegate.contains(o);\n+          if (!contains) {\n+            transformAll();\n+          }\n+        } finally {\n+          readLock.lock();\n+          writeLock.unlock();\n+        }\n       }\n-      return contains;\n+      return delegate.contains(o);\n     } finally {\n       readLock.unlock();\n     }\n   }\n \n   @Override\n-  public Iterator<Message> iterator() {\n-    return new ResultToMessageIterator(delegate.iterator(), cursorProviderFactory, eventContext, originatingLocation);\n+  public Iterator<T> iterator() {\n+    return new TransformingIterator<>(delegate.iterator(), transformer);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI2MDM2NQ=="}, "originalCommit": {"oid": "72aae3df5124fac839721c899a2fbf528e39f0b3"}, "originalPosition": 100}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0eca667e360dd240d2ba1a8d0b85f8625adfdb5d", "author": {"user": {"login": "marianogonzalez", "name": "Mariano Gonzalez"}}, "url": "https://github.com/mulesoft/mule/commit/0eca667e360dd240d2ba1a8d0b85f8625adfdb5d", "committedDate": "2020-09-03T21:45:58Z", "message": "pr feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMjI4MTUz", "url": "https://github.com/mulesoft/mule/pull/9340#pullrequestreview-482228153", "createdAt": "2020-09-03T21:53:00Z", "commit": {"oid": "0eca667e360dd240d2ba1a8d0b85f8625adfdb5d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMjI4NTcx", "url": "https://github.com/mulesoft/mule/pull/9340#pullrequestreview-482228571", "createdAt": "2020-09-03T21:53:51Z", "commit": {"oid": "0eca667e360dd240d2ba1a8d0b85f8625adfdb5d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QyMTo1Mzo1MlrOHM4uBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QyMTo1Mzo1MlrOHM4uBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI3NDI0NA==", "bodyText": "make volatile", "url": "https://github.com/mulesoft/mule/pull/9340#discussion_r483274244", "createdAt": "2020-09-03T21:53:52Z", "author": {"login": "elrodro83"}, "path": "core/src/main/java/org/mule/runtime/core/internal/util/collection/TransformingCollection.java", "diffHunk": "@@ -4,53 +4,45 @@\n  * license, a copy of which has been included with this distribution in the\n  * LICENSE.txt file.\n  */\n-package org.mule.runtime.core.internal.util.message;\n+package org.mule.runtime.core.internal.util.collection;\n \n import static java.util.stream.Collectors.toList;\n \n-import org.mule.runtime.api.component.location.ComponentLocation;\n-import org.mule.runtime.api.message.Message;\n-import org.mule.runtime.core.api.streaming.CursorProviderFactory;\n-import org.mule.runtime.core.privileged.event.BaseEventContext;\n-import org.mule.runtime.extension.api.runtime.operation.Result;\n-\n import java.util.Collection;\n import java.util.Iterator;\n import java.util.Spliterator;\n import java.util.concurrent.locks.Lock;\n import java.util.concurrent.locks.ReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n import java.util.function.Consumer;\n+import java.util.function.Function;\n import java.util.function.Predicate;\n import java.util.stream.Stream;\n \n /**\n- * Wraps a {@link Collection} of {@link Result} instances and exposes\n- * its contents as {@link Message} instances.\n- *\n- * This allows to avoid preemptive transformations of an entire collection\n- * of {@link Result} to {@link Message}\n+ * Decorates a {@link Collection} with items of random types and uses a {@link Function}\n+ * to guarantee that, when exposed, those items have been transformed.\n+ * <p>\n+ * This allows to lazily transform the items of the collection without making a full copy of the collection\n  *\n- * @since 4.0\n+ * @since 4.4.0\n  */\n-abstract class ResultsToMessageCollection implements Collection<Message> {\n+public abstract class TransformingCollection<T> implements Collection<T> {\n \n-  private final Collection<Object> delegate;\n-  protected final CursorProviderFactory cursorProviderFactory;\n-  protected final BaseEventContext eventContext;\n-  protected final ComponentLocation originatingLocation;\n+  private Collection<Object> delegate;\n+  protected final Class<T> targetType;\n+  protected final Function<Object, T> transformer;\n   protected final ReadWriteLock readWriteLock = new ReentrantReadWriteLock();\n   protected final Lock readLock = readWriteLock.readLock();\n   protected final Lock writeLock = readWriteLock.writeLock();\n+  protected boolean transformAllInvoked = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0eca667e360dd240d2ba1a8d0b85f8625adfdb5d"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMjQ2MDE0", "url": "https://github.com/mulesoft/mule/pull/9340#pullrequestreview-482246014", "createdAt": "2020-09-03T22:32:22Z", "commit": {"oid": "0eca667e360dd240d2ba1a8d0b85f8625adfdb5d"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01402db8b95b8b721b5a1aee6de6dd0a002ce35f", "author": {"user": {"login": "marianogonzalez", "name": "Mariano Gonzalez"}}, "url": "https://github.com/mulesoft/mule/commit/01402db8b95b8b721b5a1aee6de6dd0a002ce35f", "committedDate": "2020-09-04T15:52:31Z", "message": "fix missing case in return delegate"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNzcxMDMw", "url": "https://github.com/mulesoft/mule/pull/9340#pullrequestreview-482771030", "createdAt": "2020-09-04T15:55:17Z", "commit": {"oid": "01402db8b95b8b721b5a1aee6de6dd0a002ce35f"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c106ec8b5ba051c48f69e977da6be755a13c05a", "author": {"user": {"login": "marianogonzalez", "name": "Mariano Gonzalez"}}, "url": "https://github.com/mulesoft/mule/commit/0c106ec8b5ba051c48f69e977da6be755a13c05a", "committedDate": "2020-09-04T16:32:19Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyODE4Njky", "url": "https://github.com/mulesoft/mule/pull/9340#pullrequestreview-482818692", "createdAt": "2020-09-04T17:01:25Z", "commit": {"oid": "0c106ec8b5ba051c48f69e977da6be755a13c05a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1268, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}