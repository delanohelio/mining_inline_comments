{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwMjc4MTE1", "number": 9646, "title": "MULE-18929: DefaultPolicyManager's activePolicies increases size for cache-expired policies", "bodyText": "", "createdAt": "2020-10-26T20:09:37Z", "url": "https://github.com/mulesoft/mule/pull/9646", "merged": true, "mergeCommit": {"oid": "78f329b2e02f1e7a8d73f37778bd3ac46864d7d8"}, "closed": true, "closedAt": "2020-11-02T13:18:57Z", "author": {"login": "mbuchwald"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXoPQzAH2gAyNTEwMjc4MTE1OmRhNTI3NmMwNDRkZWVhNTkyNTI0YzUzMDhlYjdkODQxZjEzNmU1YmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXq_CzAFqTUyMDkyOTE2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "da5276c044deea592524c5308eb7d841f136e5be", "author": {"user": {"login": "mbuchwald", "name": "Mart\u00edn Buchwald"}}, "url": "https://github.com/mulesoft/mule/commit/da5276c044deea592524c5308eb7d841f136e5be", "committedDate": "2020-10-30T15:10:22Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "065610eaa29df263887ca9f2a5085c9f7987f600", "author": {"user": {"login": "mbuchwald", "name": "Mart\u00edn Buchwald"}}, "url": "https://github.com/mulesoft/mule/commit/065610eaa29df263887ca9f2a5085c9f7987f600", "committedDate": "2020-10-30T15:11:00Z", "message": "fixup doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98a6a92d1da55eb2c800ea1e4d7bfe6c72b20cca", "author": {"user": {"login": "mbuchwald", "name": "Mart\u00edn Buchwald"}}, "url": "https://github.com/mulesoft/mule/commit/98a6a92d1da55eb2c800ea1e4d7bfe6c72b20cca", "committedDate": "2020-10-30T15:44:46Z", "message": "test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47350725ba4c260dcb7adc40b846f4d170d9e690", "author": {"user": {"login": "mbuchwald", "name": "Mart\u00edn Buchwald"}}, "url": "https://github.com/mulesoft/mule/commit/47350725ba4c260dcb7adc40b846f4d170d9e690", "committedDate": "2020-10-30T15:46:44Z", "message": "reduce time"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b571d8d20bbbb032214b13057a4861bc8d5fc79f", "author": {"user": {"login": "mbuchwald", "name": "Mart\u00edn Buchwald"}}, "url": "https://github.com/mulesoft/mule/commit/b571d8d20bbbb032214b13057a4861bc8d5fc79f", "committedDate": "2020-10-26T20:08:45Z", "message": "test"}, "afterCommit": {"oid": "47350725ba4c260dcb7adc40b846f4d170d9e690", "author": {"user": {"login": "mbuchwald", "name": "Mart\u00edn Buchwald"}}, "url": "https://github.com/mulesoft/mule/commit/47350725ba4c260dcb7adc40b846f4d170d9e690", "committedDate": "2020-10-30T15:46:44Z", "message": "reduce time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b61d4b2767a24782112b403833678f7214ee2178", "author": {"user": {"login": "mbuchwald", "name": "Mart\u00edn Buchwald"}}, "url": "https://github.com/mulesoft/mule/commit/b61d4b2767a24782112b403833678f7214ee2178", "committedDate": "2020-10-30T15:53:11Z", "message": "static import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTA2OTY1", "url": "https://github.com/mulesoft/mule/pull/9646#pullrequestreview-520906965", "createdAt": "2020-10-30T17:51:54Z", "commit": {"oid": "b61d4b2767a24782112b403833678f7214ee2178"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNzo1MTo1NFrOHraIFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNzo1MzoyNFrOHraMSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI3ODg3MA==", "bodyText": "receive the unit as param es well", "url": "https://github.com/mulesoft/mule/pull/9646#discussion_r515278870", "createdAt": "2020-10-30T17:51:54Z", "author": {"login": "elrodro83"}, "path": "core/src/main/java/org/mule/runtime/core/internal/policy/DefaultPolicyManager.java", "diffHunk": "@@ -463,6 +463,20 @@ private void disposeStalePolicies() {\n     }\n   }\n \n+  // Testing purposes\n+  void setOuterCachesExpireTime(int timeout) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b61d4b2767a24782112b403833678f7214ee2178"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI3OTIzOQ==", "bodyText": "this will throw an NPE if the abject was already collected", "url": "https://github.com/mulesoft/mule/pull/9646#discussion_r515279239", "createdAt": "2020-10-30T17:52:37Z", "author": {"login": "elrodro83"}, "path": "core/src/main/java/org/mule/runtime/core/internal/policy/DefaultPolicyManager.java", "diffHunk": "@@ -476,5 +490,23 @@ public DeferredDisposableWeakReference(DeferredDisposable referent, ReferenceQue\n     public void dispose() {\n       deferredDispose.dispose();\n     }\n+\n+    /* MULE-18929: since outer cache has an expiring time but inner cache doesn't, we are could be creating\n+    * a new weak reference for the same policy. This will make that the activePolicies set will increase\n+    * its size for expired policies, unnecessary. Hence, overriding hashCode and equals methods to avoid having\n+    * more than one weak reference in the set */\n+    @Override\n+    public int hashCode() {\n+      return this.get().hashCode();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b61d4b2767a24782112b403833678f7214ee2178"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI3OTI4MA==", "bodyText": "this will throw an NPE if the abject was already collected", "url": "https://github.com/mulesoft/mule/pull/9646#discussion_r515279280", "createdAt": "2020-10-30T17:52:40Z", "author": {"login": "elrodro83"}, "path": "core/src/main/java/org/mule/runtime/core/internal/policy/DefaultPolicyManager.java", "diffHunk": "@@ -476,5 +490,23 @@ public DeferredDisposableWeakReference(DeferredDisposable referent, ReferenceQue\n     public void dispose() {\n       deferredDispose.dispose();\n     }\n+\n+    /* MULE-18929: since outer cache has an expiring time but inner cache doesn't, we are could be creating\n+    * a new weak reference for the same policy. This will make that the activePolicies set will increase\n+    * its size for expired policies, unnecessary. Hence, overriding hashCode and equals methods to avoid having\n+    * more than one weak reference in the set */\n+    @Override\n+    public int hashCode() {\n+      return this.get().hashCode();\n+    }\n+\n+    @Override\n+    public boolean equals(Object o) {\n+      if (!(o instanceof DeferredDisposableWeakReference)) {\n+        return false;\n+      }\n+      return this.get().equals(((DeferredDisposableWeakReference) o).get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b61d4b2767a24782112b403833678f7214ee2178"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI3OTk0NA==", "bodyText": "should be same instance r just equals? make it explicit in the test", "url": "https://github.com/mulesoft/mule/pull/9646#discussion_r515279944", "createdAt": "2020-10-30T17:53:24Z", "author": {"login": "elrodro83"}, "path": "core-tests/src/test/java/org/mule/runtime/core/internal/policy/DefaultPolicyManagerTestCase.java", "diffHunk": "@@ -440,6 +442,35 @@ public void cachesEvictedWhileLookingForPolicies() throws InterruptedException {\n     assertThat(policy2, instanceOf(NoSourcePolicy.class));\n   }\n \n+  @Test\n+  @Issue(\"MULE-18929\")\n+  public void cachesEvictedDoesntIncreaseActivePoliciesCount() throws InterruptedException {\n+    final Policy policy = mock(Policy.class, RETURNS_DEEP_STUBS);\n+    when(policyProvider.isSourcePoliciesAvailable()).thenReturn(true);\n+    when(policyProvider.findSourceParameterizedPolicies(any())).thenReturn(asList(policy));\n+    policiesChangeCallbackCaptor.getValue().run();\n+\n+    policyManager.setOuterCachesExpireTime(1);\n+\n+    InternalEvent event = mock(InternalEvent.class);\n+    SourcePolicyContext ctx = mock(SourcePolicyContext.class);\n+    when(event.getSourcePolicyContext()).thenReturn((EventInternalContext) ctx);\n+    when(ctx.getPointcutParameters()).thenReturn(mock(PolicyPointcutParameters.class));\n+\n+    when(policyProvider.findSourceParameterizedPolicies(any())).thenReturn(asList(policy));\n+\n+    final SourcePolicy policy1 = policyManager.createSourcePolicyInstance(flow1Component, event, ePub -> ePub,\n+                                                                          mock(MessageSourceResponseParametersProcessor.class));\n+\n+    sleep(1500);\n+\n+    final SourcePolicy policy2 = policyManager.createSourcePolicyInstance(flow1Component, event, ePub -> ePub,\n+                                                                          mock(MessageSourceResponseParametersProcessor.class));\n+\n+    assertThat(policy1, is(policy2));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b61d4b2767a24782112b403833678f7214ee2178"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "053b2b828aef7182b8566d10376681e28d2c3062", "author": {"user": {"login": "mbuchwald", "name": "Mart\u00edn Buchwald"}}, "url": "https://github.com/mulesoft/mule/commit/053b2b828aef7182b8566d10376681e28d2c3062", "committedDate": "2020-10-30T18:20:31Z", "message": "review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTI5MTY1", "url": "https://github.com/mulesoft/mule/pull/9646#pullrequestreview-520929165", "createdAt": "2020-10-30T18:22:22Z", "commit": {"oid": "053b2b828aef7182b8566d10376681e28d2c3062"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1112, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}