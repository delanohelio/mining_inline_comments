{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNDYzMjk4", "number": 9555, "title": "MULE-18895: Avoid cursor re-management with PayloadStatistics decorators", "bodyText": "", "createdAt": "2020-10-14T15:35:44Z", "url": "https://github.com/mulesoft/mule/pull/9555", "merged": true, "mergeCommit": {"oid": "c7aa1257072a4475f7333766bf83c661ddaad5cf"}, "closed": true, "closedAt": "2020-10-16T18:35:46Z", "author": {"login": "elrodro83"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSyE58gBqjM4ODE2ODYxNjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdTJCW3gFqTUxMDYyODkzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6d1d83aaa65565a0f1aeb8dabe53839b499d94f2", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/6d1d83aaa65565a0f1aeb8dabe53839b499d94f2", "committedDate": "2020-10-15T00:09:24Z", "message": "LongAdder and propagate int instead of long"}, "afterCommit": {"oid": "8a70b0b9ddf1bd720dbd48020fdb5e5ee89713a8", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/8a70b0b9ddf1bd720dbd48020fdb5e5ee89713a8", "committedDate": "2020-10-15T13:47:42Z", "message": "LongAdder, this addresses the contention issue."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cce772c99a2756b25a30e56263d53254b852d8d1", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/cce772c99a2756b25a30e56263d53254b852d8d1", "committedDate": "2020-10-16T03:40:43Z", "message": "remove returns"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38fa8d7a28907826a4f4b9535b289c4904d166fb", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/38fa8d7a28907826a4f4b9535b289c4904d166fb", "committedDate": "2020-10-16T03:40:44Z", "message": "no lambdas referencing outer scope"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1c8cb9b912631330b8f45c6125cd866d2fa44ca", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/f1c8cb9b912631330b8f45c6125cd866d2fa44ca", "committedDate": "2020-10-16T03:40:46Z", "message": "LongAdder and propagate int instead of long"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "539c38e411eb2fcdf16f332dffe2232415b05ea5", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/539c38e411eb2fcdf16f332dffe2232415b05ea5", "committedDate": "2020-10-16T03:40:48Z", "message": "Revert \"LongAdder and propagate int instead of long\"\n\nThis reverts commit 035766836c563ec429ff6ef3118190f9e6901dfe."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9992fc7922d00ab94fcba69193531cf1e5a98c9", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/a9992fc7922d00ab94fcba69193531cf1e5a98c9", "committedDate": "2020-10-16T03:40:49Z", "message": "Revert \"no lambdas referencing outer scope\"\n\nThis reverts commit 713d31af033a642d77aada12cd5674d48a411320."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ca43d02a4f23dd7939ccf9f23e4c2fadd961e47", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/1ca43d02a4f23dd7939ccf9f23e4c2fadd961e47", "committedDate": "2020-10-16T03:40:51Z", "message": "LongAdder, this addresses the contention issue."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3baff324209781cdc06032ba8ea9319ee5d3f8e2", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/3baff324209781cdc06032ba8ea9319ee5d3f8e2", "committedDate": "2020-10-16T03:40:53Z", "message": "avoid double manage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bac755acd30e196d93997aa695162079d67402d4", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/bac755acd30e196d93997aa695162079d67402d4", "committedDate": "2020-10-16T03:40:54Z", "message": "yet another decorator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17decfea53bc069d4a79d3d422d86046eb199178", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/17decfea53bc069d4a79d3d422d86046eb199178", "committedDate": "2020-10-16T03:41:09Z", "message": "Revert \"LongAdder, this addresses the contention issue.\"\n\nThis reverts commit 1ca43d02a4f23dd7939ccf9f23e4c2fadd961e47."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "88634da3d9da086cd482169486dd4f26c4684b8c", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/88634da3d9da086cd482169486dd4f26c4684b8c", "committedDate": "2020-10-15T22:29:09Z", "message": "avoid double manage"}, "afterCommit": {"oid": "17decfea53bc069d4a79d3d422d86046eb199178", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/17decfea53bc069d4a79d3d422d86046eb199178", "committedDate": "2020-10-16T03:41:09Z", "message": "Revert \"LongAdder, this addresses the contention issue.\"\n\nThis reverts commit 1ca43d02a4f23dd7939ccf9f23e4c2fadd961e47."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f53ea2cccb50848a3374db2f7ac4c02d06b0648", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/6f53ea2cccb50848a3374db2f7ac4c02d06b0648", "committedDate": "2020-10-16T13:39:59Z", "message": "fix format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d904f6aaf9ee96626976cf5e8510e6030dc9461c", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/d904f6aaf9ee96626976cf5e8510e6030dc9461c", "committedDate": "2020-10-16T15:02:28Z", "message": "dg"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2d46af5da10255b60c60b4d4e1fce866419f6b8", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/f2d46af5da10255b60c60b4d4e1fce866419f6b8", "committedDate": "2020-10-16T15:23:51Z", "message": "asdf"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da3332a8e5b071747dbd22de0581ee6a8921ac59", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/da3332a8e5b071747dbd22de0581ee6a8921ac59", "committedDate": "2020-10-16T15:25:16Z", "message": "dsfggs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNTgyOTMx", "url": "https://github.com/mulesoft/mule/pull/9555#pullrequestreview-510582931", "createdAt": "2020-10-16T15:34:49Z", "commit": {"oid": "da3332a8e5b071747dbd22de0581ee6a8921ac59"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNTozNDo0OVrOHjFbJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNTozNDo1N1rOHjFbsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU1MTA3OQ==", "bodyText": "functionality", "url": "https://github.com/mulesoft/mule/pull/9555#discussion_r506551079", "createdAt": "2020-10-16T15:34:49Z", "author": {"login": "fsgonz"}, "path": "core-tests/src/test/java/org/mule/runtime/core/internal/management/stats/PayloadStatisticsTestCase.java", "diffHunk": "@@ -766,6 +772,45 @@ public void flowProcessMediatorCollectionItems() throws Exception {\n     verify(sourcePolicy).process(any(), any(), any());\n   }\n \n+  @Test\n+  @Issue(\"MULE-18895\")\n+  @Description(\"Check that managing a decorator of a cursor provider returns the same instance instead of attempting to manage it again.\")\n+  public void managedProviderNotManagedTwice() throws MuleException {\n+    final DefaultStreamingManager streamingManager = new DefaultStreamingManager();\n+    initialiseIfNeeded(streamingManager, muleContext);\n+\n+    final ManagedCursorStreamProvider provider = mock(ManagedCursorStreamProvider.class);\n+    when(provider.isManaged()).thenCallRealMethod();\n+    final InputDecoratedCursorStreamProvider decoratedProvider =\n+        new InputDecoratedCursorStreamProvider(provider, decoratorFactory.componentDecoratorFactory(component1), CORR_ID);\n+\n+    final CursorProvider managed = streamingManager.manage(decoratedProvider, testEvent());\n+\n+    assertThat(managed, is(sameInstance(decoratedProvider)));\n+  }\n+\n+  @Test\n+  @Issue(\"MULE-18895\")\n+  @Description(\"Check that decorated cursors also are cursors so the fucntionality depending on instanceof is not affected.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da3332a8e5b071747dbd22de0581ee6a8921ac59"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU1MTIxNg==", "bodyText": "functionality", "url": "https://github.com/mulesoft/mule/pull/9555#discussion_r506551216", "createdAt": "2020-10-16T15:34:57Z", "author": {"login": "fsgonz"}, "path": "core-tests/src/test/java/org/mule/runtime/core/internal/management/stats/PayloadStatisticsTestCase.java", "diffHunk": "@@ -766,6 +772,45 @@ public void flowProcessMediatorCollectionItems() throws Exception {\n     verify(sourcePolicy).process(any(), any(), any());\n   }\n \n+  @Test\n+  @Issue(\"MULE-18895\")\n+  @Description(\"Check that managing a decorator of a cursor provider returns the same instance instead of attempting to manage it again.\")\n+  public void managedProviderNotManagedTwice() throws MuleException {\n+    final DefaultStreamingManager streamingManager = new DefaultStreamingManager();\n+    initialiseIfNeeded(streamingManager, muleContext);\n+\n+    final ManagedCursorStreamProvider provider = mock(ManagedCursorStreamProvider.class);\n+    when(provider.isManaged()).thenCallRealMethod();\n+    final InputDecoratedCursorStreamProvider decoratedProvider =\n+        new InputDecoratedCursorStreamProvider(provider, decoratorFactory.componentDecoratorFactory(component1), CORR_ID);\n+\n+    final CursorProvider managed = streamingManager.manage(decoratedProvider, testEvent());\n+\n+    assertThat(managed, is(sameInstance(decoratedProvider)));\n+  }\n+\n+  @Test\n+  @Issue(\"MULE-18895\")\n+  @Description(\"Check that decorated cursors also are cursors so the fucntionality depending on instanceof is not affected.\")\n+  public void managedCursorInputNotManagedTwice() throws MuleException {\n+    final InputStream stream = mock(CursorStream.class);\n+    final InputStream decorated =\n+        decoratorFactory.componentDecoratorFactory(component1).decorateInput(stream, CORR_ID);\n+\n+    assertThat(decorated, instanceOf(CursorStream.class));\n+  }\n+\n+  @Test\n+  @Issue(\"MULE-18895\")\n+  @Description(\"Check that decorated cursors also are cursors so the fucntionality depending on instanceof is not affected.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da3332a8e5b071747dbd22de0581ee6a8921ac59"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc968976e59a153c97a1378883c574797182ba32", "author": {"user": {"login": "elrodro83", "name": "Rodrigo Merino"}}, "url": "https://github.com/mulesoft/mule/commit/cc968976e59a153c97a1378883c574797182ba32", "committedDate": "2020-10-16T16:32:26Z", "message": "fix typos"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNjI4OTM4", "url": "https://github.com/mulesoft/mule/pull/9555#pullrequestreview-510628938", "createdAt": "2020-10-16T16:33:31Z", "commit": {"oid": "cc968976e59a153c97a1378883c574797182ba32"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1168, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}