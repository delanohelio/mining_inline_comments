{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0Nzg1OTg4", "number": 8845, "reviewThreads": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNjoxOTo0NFrOD6snEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzo1MTo0NVrOD-OmlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyODc0ODk4OnYy", "diffSide": "RIGHT", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNjoxOTo0NFrOGSrPdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxOTozNTo0NFrOGSxMGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIzNjAyMA==", "bodyText": "don't use maps. Build a explicit pojo.", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r422236020", "createdAt": "2020-05-08T16:19:44Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java", "diffHunk": "@@ -196,13 +196,14 @@ private synchronized void createSource(boolean restarting) throws Exception {\n     }\n   }\n \n-  private void startSource(boolean restarting) throws MuleException {\n+  private void startSource(boolean restarting, Map<String, Object> restartingContext) throws MuleException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba1231044265e1cbc5ff87e1a7dff2ff4157010e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI2Nzg0Nw==", "bodyText": "In the end I would need to use a POJO with at least a field that is a map, right? What is stored in the context is specific to the restarting of a polling source.", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r422267847", "createdAt": "2020-05-08T17:22:50Z", "author": {"login": "ndinu"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java", "diffHunk": "@@ -196,13 +196,14 @@ private synchronized void createSource(boolean restarting) throws Exception {\n     }\n   }\n \n-  private void startSource(boolean restarting) throws MuleException {\n+  private void startSource(boolean restarting, Map<String, Object> restartingContext) throws MuleException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIzNjAyMA=="}, "originalCommit": {"oid": "ba1231044265e1cbc5ff87e1a7dff2ff4157010e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjMyNjQ1Ng==", "bodyText": "why? right now you're using a map on which you only put two entries with well known keys. Just use a pojo with two well known fields... If in the future you need a map, you add a map, but I don't see why you would need that and you certainly don't need it now", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r422326456", "createdAt": "2020-05-08T19:21:08Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java", "diffHunk": "@@ -196,13 +196,14 @@ private synchronized void createSource(boolean restarting) throws Exception {\n     }\n   }\n \n-  private void startSource(boolean restarting) throws MuleException {\n+  private void startSource(boolean restarting, Map<String, Object> restartingContext) throws MuleException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIzNjAyMA=="}, "originalCommit": {"oid": "ba1231044265e1cbc5ff87e1a7dff2ff4157010e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjMzMjkwMA==", "bodyText": "My point is, the Restartable interface needs to be generic, not everything that can be restarted needs a Runnable and a Scheduler. Does it make sense?", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r422332900", "createdAt": "2020-05-08T19:34:33Z", "author": {"login": "ndinu"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java", "diffHunk": "@@ -196,13 +196,14 @@ private synchronized void createSource(boolean restarting) throws Exception {\n     }\n   }\n \n-  private void startSource(boolean restarting) throws MuleException {\n+  private void startSource(boolean restarting, Map<String, Object> restartingContext) throws MuleException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIzNjAyMA=="}, "originalCommit": {"oid": "ba1231044265e1cbc5ff87e1a7dff2ff4157010e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjMzMzQ2Ng==", "bodyText": "but this is internal. We can change it as much as we want.. Rename it to RestartableSource if you want", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r422333466", "createdAt": "2020-05-08T19:35:44Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/ExtensionMessageSource.java", "diffHunk": "@@ -196,13 +196,14 @@ private synchronized void createSource(boolean restarting) throws Exception {\n     }\n   }\n \n-  private void startSource(boolean restarting) throws MuleException {\n+  private void startSource(boolean restarting, Map<String, Object> restartingContext) throws MuleException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIzNjAyMA=="}, "originalCommit": {"oid": "ba1231044265e1cbc5ff87e1a7dff2ff4157010e"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyODc3MDcyOnYy", "diffSide": "RIGHT", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/PollingSourceWrapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNjoyNjoxOVrOGSrcWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNjoyNjoxOVrOGSrcWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIzOTMyMg==", "bodyText": "I don't understand the point of this... if this guy is reconnecting is because it failed while executing. That means that you first simply poll() and then simply  scheduler.schedule(executor, () -> poll(sourceCallback));... everything else you added seems unnecessary. What am I missing?", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r422239322", "createdAt": "2020-05-08T16:26:19Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/PollingSourceWrapper.java", "diffHunk": "@@ -133,7 +137,13 @@ public void onStart(SourceCallback<T, A> sourceCallback) throws MuleException {\n         .withName(formatKey(\"executor\")));\n \n     stopRequested.set(false);\n-    scheduler.schedule(executor, () -> poll(sourceCallback));\n+    if (restarting.compareAndSet(true, false)) {\n+      delegateRunnable.setDelegate(() -> poll(sourceCallback));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba1231044265e1cbc5ff87e1a7dff2ff4157010e"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyODc3MTM4OnYy", "diffSide": "RIGHT", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/PollingSourceWrapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNjoyNjozMFrOGSrcxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNjoyNjozMFrOGSrcxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjIzOTQyOA==", "bodyText": "what's the point of this?", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r422239428", "createdAt": "2020-05-08T16:26:30Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/PollingSourceWrapper.java", "diffHunk": "@@ -133,7 +137,13 @@ public void onStart(SourceCallback<T, A> sourceCallback) throws MuleException {\n         .withName(formatKey(\"executor\")));\n \n     stopRequested.set(false);\n-    scheduler.schedule(executor, () -> poll(sourceCallback));\n+    if (restarting.compareAndSet(true, false)) {\n+      delegateRunnable.setDelegate(() -> poll(sourceCallback));\n+      poll(sourceCallback);\n+    } else {\n+      delegateRunnable = new DelegateRunnable(() -> poll(sourceCallback));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba1231044265e1cbc5ff87e1a7dff2ff4157010e"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyODgzMzg5OnYy", "diffSide": "RIGHT", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/PollingSourceWrapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNjo0NjowOVrOGSsDcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNjo0NjowOVrOGSsDcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI0OTMyOQ==", "bodyText": "this class does literally nothing", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r422249329", "createdAt": "2020-05-08T16:46:09Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/PollingSourceWrapper.java", "diffHunk": "@@ -615,4 +648,22 @@ private void release() {\n       }\n     }\n   }\n+\n+  private class DelegateRunnable implements Runnable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba1231044265e1cbc5ff87e1a7dff2ff4157010e"}, "originalPosition": 107}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyODgzNjE0OnYy", "diffSide": "RIGHT", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/PollingSourceWrapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNjo0Njo1NVrOGSsE6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNjo0Njo1NVrOGSsE6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI0OTcwNg==", "bodyText": "although I insist this is not necesary, this isn't a bad idea as the delegate you're keeping from the prior instance is quite likely to have references to the old instance...potentially producing leaks", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r422249706", "createdAt": "2020-05-08T16:46:55Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/PollingSourceWrapper.java", "diffHunk": "@@ -204,6 +217,25 @@ private int compareWatermarks(Serializable w1, Serializable w2, Comparator compa\n     return comparator.compare(w1, w2);\n   }\n \n+  @Override\n+  public Map<String, Object> beginRestart() {\n+    Map<String, Object> restartingContext = new HashMap<>();\n+\n+    restarting.set(true);\n+\n+    restartingContext.put(POLLING_SOURCE_EXECUTOR_KEY, executor);\n+    restartingContext.put(RUNNABLE_KEY, delegateRunnable);\n+    return restartingContext;\n+  }\n+\n+  @Override\n+  public void finishRestart(Map<String, Object> restartingContext) {\n+    restarting.set(true);\n+\n+    executor = (org.mule.runtime.api.scheduler.Scheduler) restartingContext.get(POLLING_SOURCE_EXECUTOR_KEY);\n+    delegateRunnable = (DelegateRunnable) restartingContext.get(RUNNABLE_KEY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba1231044265e1cbc5ff87e1a7dff2ff4157010e"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyODg2NzkyOnYy", "diffSide": "RIGHT", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/Restartable.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNjo1NjoxM1rOGSsYhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNjo1NjoxM1rOGSsYhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI1NDcyNw==", "bodyText": "rename to getRestartContext and turn that map into an actual SourceRestartContext class", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r422254727", "createdAt": "2020-05-08T16:56:13Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/Restartable.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.extension.internal.runtime.source.poll;\n+\n+import java.util.Map;\n+\n+/**\n+ * A component that can be restarted.\n+ *\n+ * When restarted {@link #beginRestart()} needs to be called and will return a {@link Map}. After the restart is\n+ * performed, the {@link #finishRestart(Map)} will be called with the value that the {@link #beginRestart()} method\n+ * have generated.\n+ *\n+ * @since 4.2.3 4.3.1 4.4.0\n+ */\n+public interface Restartable {\n+\n+  /**\n+   * Method that needs to be called when a restart is performed.\n+   *\n+   * @return a context needed after a restart is performed.\n+   */\n+  Map<String, Object> beginRestart();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba1231044265e1cbc5ff87e1a7dff2ff4157010e"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyODg3MDQ1OnYy", "diffSide": "RIGHT", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/Restartable.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNjo1Njo1MlrOGSsaAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxNjo1Njo1MlrOGSsaAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjI1NTEwNw==", "bodyText": "rename to restart()", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r422255107", "createdAt": "2020-05-08T16:56:52Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/Restartable.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.extension.internal.runtime.source.poll;\n+\n+import java.util.Map;\n+\n+/**\n+ * A component that can be restarted.\n+ *\n+ * When restarted {@link #beginRestart()} needs to be called and will return a {@link Map}. After the restart is\n+ * performed, the {@link #finishRestart(Map)} will be called with the value that the {@link #beginRestart()} method\n+ * have generated.\n+ *\n+ * @since 4.2.3 4.3.1 4.4.0\n+ */\n+public interface Restartable {\n+\n+  /**\n+   * Method that needs to be called when a restart is performed.\n+   *\n+   * @return a context needed after a restart is performed.\n+   */\n+  Map<String, Object> beginRestart();\n+\n+  /**\n+   * Method that needs to be called to finish the process of restarting.\n+   *\n+   * @param restartingContext the context generated by {@link #beginRestart()}\n+   */\n+  void finishRestart(Map<String, Object> restartingContext);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba1231044265e1cbc5ff87e1a7dff2ff4157010e"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTY5MjA4OnYy", "diffSide": "RIGHT", "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/source/PollingSourceTestCase.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzozNTozM1rOGYL-yA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzozNTozM1rOGYL-yA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAxNTMwNA==", "bodyText": "I get what you mean, but the term rescheduled is quite misleading", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r428015304", "createdAt": "2020-05-20T13:35:33Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/source/PollingSourceTestCase.java", "diffHunk": "@@ -122,6 +135,37 @@ public void whenReconnectingAfterConnectionExceptionSchedulerRunsWithoutStartDel\n     assertAllPetsAdopted();\n   }\n \n+  @Description(\"This test reflects a behavior that we must preserve, when a polling source is stopped and started the scheduler must be rescheduled.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e44e37d4820d3c1ecb677b6725188260ad3b9da"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTcwMDM0OnYy", "diffSide": "RIGHT", "path": "modules/extensions-spring-support/src/test/resources/polling-source-config.xml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzozNzoxN1rOGYMD5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzozNzoxN1rOGYMD5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAxNjYxMw==", "bodyText": "why this change?", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r428016613", "createdAt": "2020-05-20T13:37:17Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-spring-support/src/test/resources/polling-source-config.xml", "diffHunk": "@@ -68,7 +68,7 @@\n                 <fixed-frequency frequency=\"1000\"/>\n             </scheduling-strategy>\n         </petstore:pet-adoption-source>\n-        <raise-error type=\"TEST:EXPECTED\"/>\n+        <test:processor throwException=\"true\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e44e37d4820d3c1ecb677b6725188260ad3b9da"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTcyMTkyOnYy", "diffSide": "RIGHT", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/DelegateRunnable.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzo0MTozNFrOGYMROA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMDozNTowOVrOGYc2sQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAyMDAyNA==", "bodyText": "add a comment explaining why", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r428020024", "createdAt": "2020-05-20T13:41:34Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/DelegateRunnable.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.extension.internal.runtime.source.poll;\n+\n+\n+import static org.slf4j.LoggerFactory.getLogger;\n+\n+import java.util.concurrent.locks.Lock;\n+import java.util.concurrent.locks.ReentrantLock;\n+\n+import org.slf4j.Logger;\n+\n+/**\n+ * {@link Runnable} that delegates its execution. The delegate can be switch at any time.\n+ * This is particulary useful when you want to schedule a task to be repeated, and you want to change the task for the next\n+ * executions without rescheduling.\n+ *\n+ * @since 4.2.3 4.3.1 4.4.0\n+ */\n+public class DelegateRunnable implements Runnable {\n+\n+  private static final Logger LOGGER = getLogger(DelegateRunnable.class);\n+\n+  private Runnable delegate;\n+  private Lock lock = new ReentrantLock();\n+\n+  public DelegateRunnable(Runnable delegate) {\n+    this.delegate = delegate;\n+  }\n+\n+  @Override\n+  public void run() {\n+    if (lock.tryLock()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e44e37d4820d3c1ecb677b6725188260ad3b9da"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI5MTc2MQ==", "bodyText": "this comment is unsufficient. The main reason for this was to make sure that the delegate is not invoked if the scheduler fires while the restart is in progress", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r428291761", "createdAt": "2020-05-20T20:35:09Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/DelegateRunnable.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.extension.internal.runtime.source.poll;\n+\n+\n+import static org.slf4j.LoggerFactory.getLogger;\n+\n+import java.util.concurrent.locks.Lock;\n+import java.util.concurrent.locks.ReentrantLock;\n+\n+import org.slf4j.Logger;\n+\n+/**\n+ * {@link Runnable} that delegates its execution. The delegate can be switch at any time.\n+ * This is particulary useful when you want to schedule a task to be repeated, and you want to change the task for the next\n+ * executions without rescheduling.\n+ *\n+ * @since 4.2.3 4.3.1 4.4.0\n+ */\n+public class DelegateRunnable implements Runnable {\n+\n+  private static final Logger LOGGER = getLogger(DelegateRunnable.class);\n+\n+  private Runnable delegate;\n+  private Lock lock = new ReentrantLock();\n+\n+  public DelegateRunnable(Runnable delegate) {\n+    this.delegate = delegate;\n+  }\n+\n+  @Override\n+  public void run() {\n+    if (lock.tryLock()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAyMDAyNA=="}, "originalCommit": {"oid": "1e44e37d4820d3c1ecb677b6725188260ad3b9da"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTcyOTA2OnYy", "diffSide": "RIGHT", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/PollingSourceWrapper.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzo0Mjo1OVrOGYMVpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMDozNTo0N1rOGYc4EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAyMTE1Nw==", "bodyText": "a get method should never have side effects", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r428021157", "createdAt": "2020-05-20T13:42:59Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/PollingSourceWrapper.java", "diffHunk": "@@ -204,6 +216,21 @@ private int compareWatermarks(Serializable w1, Serializable w2, Comparator compa\n     return comparator.compare(w1, w2);\n   }\n \n+  @Override\n+  public RestartContext getRestartContext() {\n+    restarting.set(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e44e37d4820d3c1ecb677b6725188260ad3b9da"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE5MDk4NA==", "bodyText": "The source need to know that a restart is coming so that it does not kill the scheduler. Maybe we should change the name of the method?", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r428190984", "createdAt": "2020-05-20T17:37:56Z", "author": {"login": "ndinu"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/PollingSourceWrapper.java", "diffHunk": "@@ -204,6 +216,21 @@ private int compareWatermarks(Serializable w1, Serializable w2, Comparator compa\n     return comparator.compare(w1, w2);\n   }\n \n+  @Override\n+  public RestartContext getRestartContext() {\n+    restarting.set(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAyMTE1Nw=="}, "originalCommit": {"oid": "1e44e37d4820d3c1ecb677b6725188260ad3b9da"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI5MjExMw==", "bodyText": "you can change the mehthod name, but still, is this the right place for doing this?", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r428292113", "createdAt": "2020-05-20T20:35:47Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/PollingSourceWrapper.java", "diffHunk": "@@ -204,6 +216,21 @@ private int compareWatermarks(Serializable w1, Serializable w2, Comparator compa\n     return comparator.compare(w1, w2);\n   }\n \n+  @Override\n+  public RestartContext getRestartContext() {\n+    restarting.set(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAyMTE1Nw=="}, "originalCommit": {"oid": "1e44e37d4820d3c1ecb677b6725188260ad3b9da"}, "originalPosition": 84}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTc0OTUzOnYy", "diffSide": "RIGHT", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/PollingSourceWrapper.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzo0NzowN1rOGYMiZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMDozNjoyNVrOGYc5RQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAyNDQyMA==", "bodyText": "this is still wrong. If you do this here.. the poll() method that this delegates into is the poll from the old instance you just discarded. this should be\ndelegateRunnable = restartContext.getDelegateRunnable();\ndelegateRunnable.setDelegate(() -> poll());", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r428024420", "createdAt": "2020-05-20T13:47:07Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/PollingSourceWrapper.java", "diffHunk": "@@ -204,6 +216,21 @@ private int compareWatermarks(Serializable w1, Serializable w2, Comparator compa\n     return comparator.compare(w1, w2);\n   }\n \n+  @Override\n+  public RestartContext getRestartContext() {\n+    restarting.set(true);\n+    delegateRunnable.setDelegate(null);\n+    return new RestartContext(executor, delegateRunnable);\n+  }\n+\n+  @Override\n+  public void restart(RestartContext restartContext) {\n+    restarting.set(true);\n+\n+    executor = restartContext.getExecutor();\n+    delegateRunnable = restartContext.getDelegateRunnable();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e44e37d4820d3c1ecb677b6725188260ad3b9da"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE5MDA0OQ==", "bodyText": "At this point the delegate is null, I can set it to null here instead of in the getRestartContext method, but I cannot set the delegate here since the poll method needs the SourceCallbackContext which is not available yet, we get it in the doStart method.", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r428190049", "createdAt": "2020-05-20T17:36:23Z", "author": {"login": "ndinu"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/PollingSourceWrapper.java", "diffHunk": "@@ -204,6 +216,21 @@ private int compareWatermarks(Serializable w1, Serializable w2, Comparator compa\n     return comparator.compare(w1, w2);\n   }\n \n+  @Override\n+  public RestartContext getRestartContext() {\n+    restarting.set(true);\n+    delegateRunnable.setDelegate(null);\n+    return new RestartContext(executor, delegateRunnable);\n+  }\n+\n+  @Override\n+  public void restart(RestartContext restartContext) {\n+    restarting.set(true);\n+\n+    executor = restartContext.getExecutor();\n+    delegateRunnable = restartContext.getDelegateRunnable();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAyNDQyMA=="}, "originalCommit": {"oid": "1e44e37d4820d3c1ecb677b6725188260ad3b9da"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI5MjQyMQ==", "bodyText": "then it is clear that this should happen in the doStart() method instead of here.........", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r428292421", "createdAt": "2020-05-20T20:36:25Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/PollingSourceWrapper.java", "diffHunk": "@@ -204,6 +216,21 @@ private int compareWatermarks(Serializable w1, Serializable w2, Comparator compa\n     return comparator.compare(w1, w2);\n   }\n \n+  @Override\n+  public RestartContext getRestartContext() {\n+    restarting.set(true);\n+    delegateRunnable.setDelegate(null);\n+    return new RestartContext(executor, delegateRunnable);\n+  }\n+\n+  @Override\n+  public void restart(RestartContext restartContext) {\n+    restarting.set(true);\n+\n+    executor = restartContext.getExecutor();\n+    delegateRunnable = restartContext.getDelegateRunnable();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAyNDQyMA=="}, "originalCommit": {"oid": "1e44e37d4820d3c1ecb677b6725188260ad3b9da"}, "originalPosition": 94}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTc2ODc5OnYy", "diffSide": "RIGHT", "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/source/PollingSourceTestCase.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzo1MDoyMlrOGYMtpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzo1MDoyMlrOGYMtpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAyNzMwMw==", "bodyText": "This test is yielding false positives. The test pases because the number of invokations you want is correct, but you're not seeing that the instance that is actually modifying this is not the one you wanted. Change this by a Map<Source, Integer> and also assert which instances had how many invokations", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r428027303", "createdAt": "2020-05-20T13:50:22Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/source/PollingSourceTestCase.java", "diffHunk": "@@ -51,6 +58,12 @@ protected String getConfigFile() {\n     return \"polling-source-config.xml\";\n   }\n \n+  @Before\n+  public void resetCounters() throws Exception {\n+    PetFailingPollingSource.STARTED_POLLS = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e44e37d4820d3c1ecb677b6725188260ad3b9da"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTc3NDIwOnYy", "diffSide": "RIGHT", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/PollingSourceWrapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzo1MToyN1rOGYMw4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzo1MToyN1rOGYMw4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAyODEyOQ==", "bodyText": "this should happen on the restart method, not here", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r428028129", "createdAt": "2020-05-20T13:51:27Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/PollingSourceWrapper.java", "diffHunk": "@@ -204,6 +216,21 @@ private int compareWatermarks(Serializable w1, Serializable w2, Comparator compa\n     return comparator.compare(w1, w2);\n   }\n \n+  @Override\n+  public RestartContext getRestartContext() {\n+    restarting.set(true);\n+    delegateRunnable.setDelegate(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e44e37d4820d3c1ecb677b6725188260ad3b9da"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTc3NTU2OnYy", "diffSide": "RIGHT", "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/RestartContext.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzo1MTo0NVrOGYMxuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMzo1MTo0NVrOGYMxuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAyODM0Nw==", "bodyText": "both fields final", "url": "https://github.com/mulesoft/mule/pull/8845#discussion_r428028347", "createdAt": "2020-05-20T13:51:45Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/RestartContext.java", "diffHunk": "@@ -0,0 +1,33 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.extension.internal.runtime.source.poll;\n+\n+import org.mule.runtime.api.scheduler.Scheduler;\n+\n+/**\n+ * Context needed to perform the restart of a source\n+ *\n+ * @since 4.2.3 4.3.1 4.4.0\n+ */\n+public class RestartContext {\n+\n+  private Scheduler executor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e44e37d4820d3c1ecb677b6725188260ad3b9da"}, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 27, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}