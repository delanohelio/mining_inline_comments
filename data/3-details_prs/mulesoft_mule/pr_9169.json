{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzOTk2NjQx", "number": 9169, "title": "CMTS-34: Support Metadata Types resolution", "bodyText": "", "createdAt": "2020-08-06T12:31:03Z", "url": "https://github.com/mulesoft/mule/pull/9169", "merged": true, "mergeCommit": {"oid": "3d90280dc5c2b5c0e76747142aabe8194208cd20"}, "closed": true, "closedAt": "2020-08-06T19:55:05Z", "author": {"login": "svacas"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8BSKggH2gAyNDYzOTk2NjQxOjMyNGFmMjA5OWRjMDgxYjcyOTg3MDZjMzJkOWRjNWE2YmZiMWM0Y2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8U5UlgFqTQ2MjgxMDA5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "324af2099dc081b7298706c32d9dc5a6bfb1c4ce", "author": {"user": {"login": "svacas", "name": null}}, "url": "https://github.com/mulesoft/mule/commit/324af2099dc081b7298706c32d9dc5a6bfb1c4ce", "committedDate": "2020-08-05T20:31:17Z", "message": "CMTS-34: Support Metadata Types resolution"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNTMwMzUz", "url": "https://github.com/mulesoft/mule/pull/9169#pullrequestreview-462530353", "createdAt": "2020-08-06T13:42:22Z", "commit": {"oid": "324af2099dc081b7298706c32d9dc5a6bfb1c4ce"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMzo0MjoyMlrOG80FaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMzo1NToxM1rOG80pCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQyMTA5Nw==", "bodyText": "@since 4.4", "url": "https://github.com/mulesoft/mule/pull/9169#discussion_r466421097", "createdAt": "2020-08-06T13:42:22Z", "author": {"login": "gsfernandes"}, "path": "modules/tooling-support-parent/tooling-support/src/main/java/org/mule/runtime/module/tooling/api/metadata/ComponentMetadataTypes.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.tooling.api.metadata;\n+\n+import static java.util.Objects.requireNonNull;\n+import static java.util.Optional.ofNullable;\n+\n+import org.mule.metadata.api.model.MetadataType;\n+import org.mule.runtime.api.metadata.descriptor.InputMetadataDescriptor;\n+import org.mule.runtime.api.metadata.descriptor.OutputMetadataDescriptor;\n+import org.mule.runtime.api.metadata.descriptor.ParameterMetadataDescriptor;\n+import org.mule.runtime.api.metadata.descriptor.TypeMetadataDescriptor;\n+import org.mule.runtime.api.metadata.resolving.MetadataResult;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+/**\n+ * Exposes all the dynamic metadata (input, output, attributes) of a given component.\n+ */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "324af2099dc081b7298706c32d9dc5a6bfb1c4ce"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQyMTQ2OQ==", "bodyText": "I would move this to a \"builder\" as this object would be used as POJO for sending the response to the client.", "url": "https://github.com/mulesoft/mule/pull/9169#discussion_r466421469", "createdAt": "2020-08-06T13:42:55Z", "author": {"login": "gsfernandes"}, "path": "modules/tooling-support-parent/tooling-support/src/main/java/org/mule/runtime/module/tooling/api/metadata/ComponentMetadataTypes.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.tooling.api.metadata;\n+\n+import static java.util.Objects.requireNonNull;\n+import static java.util.Optional.ofNullable;\n+\n+import org.mule.metadata.api.model.MetadataType;\n+import org.mule.runtime.api.metadata.descriptor.InputMetadataDescriptor;\n+import org.mule.runtime.api.metadata.descriptor.OutputMetadataDescriptor;\n+import org.mule.runtime.api.metadata.descriptor.ParameterMetadataDescriptor;\n+import org.mule.runtime.api.metadata.descriptor.TypeMetadataDescriptor;\n+import org.mule.runtime.api.metadata.resolving.MetadataResult;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+/**\n+ * Exposes all the dynamic metadata (input, output, attributes) of a given component.\n+ */\n+public class ComponentMetadataTypes {\n+\n+  private Map<String, MetadataType> input = new HashMap<>();\n+  private MetadataType output;\n+  private MetadataType outputAttributes;\n+\n+  public ComponentMetadataTypes(MetadataResult<InputMetadataDescriptor> inputMetadataResult,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "324af2099dc081b7298706c32d9dc5a6bfb1c4ce"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQyMTY2Nw==", "bodyText": "Static imports.", "url": "https://github.com/mulesoft/mule/pull/9169#discussion_r466421667", "createdAt": "2020-08-06T13:43:13Z", "author": {"login": "gsfernandes"}, "path": "modules/tooling-support-parent/tooling-support/src/main/java/org/mule/runtime/module/tooling/internal/config/DefaultDeclarationSession.java", "diffHunk": "@@ -83,6 +88,19 @@ public ValueResult getValues(ParameterizedElementDeclaration component, String p\n     }\n   }\n \n+  @Override\n+  public MetadataResult<ComponentMetadataTypes> getMetadataTypes(ComponentElementDeclaration component) {\n+    try {\n+      return withInternalService().getMetadataTypes(component);\n+    } catch (Exception e) {\n+      return MetadataResult.failure(MetadataFailure.Builder.newFailure()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "324af2099dc081b7298706c32d9dc5a6bfb1c4ce"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQyMjAyNw==", "bodyText": "static import", "url": "https://github.com/mulesoft/mule/pull/9169#discussion_r466422027", "createdAt": "2020-08-06T13:43:43Z", "author": {"login": "gsfernandes"}, "path": "modules/tooling-support-parent/tooling-support/src/main/java/org/mule/runtime/module/tooling/internal/config/InternalDeclarationSession.java", "diffHunk": "@@ -121,6 +147,141 @@ public ValueResult getValues(ParameterizedElementDeclaration component, String p\n     }\n   }\n \n+  @Override\n+  public MetadataResult<ComponentMetadataTypes> getMetadataTypes(ComponentElementDeclaration component) {\n+    return artifactHelper()\n+        .findComponentModel(component)\n+        .map(cm -> {\n+          Optional<ConfigurationInstance> configurationInstance =\n+              ofNullable(component.getConfigRef()).flatMap(name -> artifactHelper().getConfigurationInstance(name));\n+\n+          MetadataKey metadataKey = buildMetadataKey(cm, component);\n+          ClassLoader extensionClassLoader = getClassLoader(artifactHelper().getExtensionModel(component));\n+          return withContextClassLoader(extensionClassLoader, () -> {\n+            MetadataMediator<? extends ComponentModel> metadataMediator = new MetadataMediator<>(cm);\n+            MetadataResult<InputMetadataDescriptor> inputMetadata = metadataMediator\n+                .getInputMetadata(createMetadataContext(configurationInstance, extensionClassLoader),\n+                                  metadataKey);\n+            MetadataResult<OutputMetadataDescriptor> outputMetadata = null;\n+            if (cm instanceof HasOutputModel) {\n+              outputMetadata = metadataMediator\n+                  .getOutputMetadata(createMetadataContext(configurationInstance, extensionClassLoader),\n+                                     metadataKey);\n+            }\n+            return collectMetadata(inputMetadata, outputMetadata);\n+          });\n+        })\n+        .orElseGet(() -> MetadataResult.failure(MetadataFailure.Builder.newFailure()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "324af2099dc081b7298706c32d9dc5a6bfb1c4ce"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQzMDIxNw==", "bodyText": "This would be fine for resolving types but when resolving keys with a partial key as input we should not use default values and request to get the key completed in the declaration instead.", "url": "https://github.com/mulesoft/mule/pull/9169#discussion_r466430217", "createdAt": "2020-08-06T13:55:13Z", "author": {"login": "gsfernandes"}, "path": "modules/tooling-support-parent/tooling-support/src/main/java/org/mule/runtime/module/tooling/internal/config/InternalDeclarationSession.java", "diffHunk": "@@ -121,6 +147,141 @@ public ValueResult getValues(ParameterizedElementDeclaration component, String p\n     }\n   }\n \n+  @Override\n+  public MetadataResult<ComponentMetadataTypes> getMetadataTypes(ComponentElementDeclaration component) {\n+    return artifactHelper()\n+        .findComponentModel(component)\n+        .map(cm -> {\n+          Optional<ConfigurationInstance> configurationInstance =\n+              ofNullable(component.getConfigRef()).flatMap(name -> artifactHelper().getConfigurationInstance(name));\n+\n+          MetadataKey metadataKey = buildMetadataKey(cm, component);\n+          ClassLoader extensionClassLoader = getClassLoader(artifactHelper().getExtensionModel(component));\n+          return withContextClassLoader(extensionClassLoader, () -> {\n+            MetadataMediator<? extends ComponentModel> metadataMediator = new MetadataMediator<>(cm);\n+            MetadataResult<InputMetadataDescriptor> inputMetadata = metadataMediator\n+                .getInputMetadata(createMetadataContext(configurationInstance, extensionClassLoader),\n+                                  metadataKey);\n+            MetadataResult<OutputMetadataDescriptor> outputMetadata = null;\n+            if (cm instanceof HasOutputModel) {\n+              outputMetadata = metadataMediator\n+                  .getOutputMetadata(createMetadataContext(configurationInstance, extensionClassLoader),\n+                                     metadataKey);\n+            }\n+            return collectMetadata(inputMetadata, outputMetadata);\n+          });\n+        })\n+        .orElseGet(() -> MetadataResult.failure(MetadataFailure.Builder.newFailure()\n+            .withMessage(format(\"Error resolving metadata for the [%s:%s] component\",\n+                                component.getDeclaringExtension(), component.getName()))\n+            .withFailureCode(COMPONENT_NOT_FOUND)\n+            .onComponent()));\n+  }\n+\n+  private MetadataResult<ComponentMetadataTypes> collectMetadata(@Nonnull MetadataResult<InputMetadataDescriptor> inputMetadataResult,\n+                                                                 @Nullable MetadataResult<OutputMetadataDescriptor> outputMetadataResult) {\n+    if (inputMetadataResult.isSuccess() && (outputMetadataResult == null || outputMetadataResult.isSuccess())) {\n+      return MetadataResult.success(new ComponentMetadataTypes(inputMetadataResult, outputMetadataResult));\n+    }\n+    List<MetadataFailure> failures = new ArrayList<>(inputMetadataResult.getFailures());\n+    if (outputMetadataResult != null) {\n+      failures.addAll(outputMetadataResult.getFailures());\n+    }\n+    return MetadataResult.failure(failures);\n+  }\n+\n+  private DefaultMetadataContext createMetadataContext(Optional<ConfigurationInstance> configurationInstance,\n+                                                       ClassLoader extensionClassLoader) {\n+    return new DefaultMetadataContext(() -> configurationInstance,\n+                                      connectionManager,\n+                                      new DefaultMetadataCache(),\n+                                      new JavaTypeLoader(extensionClassLoader));\n+  }\n+\n+  private MetadataKey buildMetadataKey(ComponentModel componentModel, ComponentElementDeclaration<?> elementDeclaration) {\n+    List<ParameterModel> keyParts = getMetadataKeyParts(componentModel);\n+\n+    if (keyParts.isEmpty()) {\n+      return MetadataKeyBuilder.newKey(NullMetadataKey.ID).build();\n+    }\n+\n+    MetadataKeyBuilder rootMetadataKeyBuilder = null;\n+    MetadataKeyBuilder metadataKeyBuilder = null;\n+    Map<String, Object> componentElementDeclarationParameters =\n+        getComponentElementDeclarationParameters(elementDeclaration, componentModel);\n+    for (ParameterModel parameterModel : keyParts) {\n+      String id;\n+      if (componentElementDeclarationParameters.containsKey(parameterModel.getName())) {\n+        id = (String) componentElementDeclarationParameters.get(parameterModel.getName());\n+      } else {\n+        // It is only supported to defined parts in order\n+        break;\n+      }\n+\n+      if (id != null) {\n+        if (metadataKeyBuilder == null) {\n+          metadataKeyBuilder = MetadataKeyBuilder.newKey(id).withPartName(parameterModel.getName());\n+          rootMetadataKeyBuilder = metadataKeyBuilder;\n+        } else {\n+          MetadataKeyBuilder metadataKeyChildBuilder = MetadataKeyBuilder.newKey(id).withPartName(parameterModel.getName());\n+          metadataKeyBuilder.withChild(metadataKeyChildBuilder);\n+          metadataKeyBuilder = metadataKeyChildBuilder;\n+        }\n+      }\n+    }\n+\n+    if (metadataKeyBuilder == null) {\n+      return MetadataKeyBuilder.newKey(NullMetadataKey.ID).build();\n+    }\n+    return rootMetadataKeyBuilder.build();\n+  }\n+\n+  private List<ParameterModel> getMetadataKeyParts(ComponentModel componentModel) {\n+    return componentModel.getAllParameterModels().stream()\n+        .filter(p -> p.getModelProperty(MetadataKeyPartModelProperty.class).isPresent())\n+        .sorted(comparingInt(p -> p.getModelProperty(MetadataKeyPartModelProperty.class).get().getOrder()))\n+        .collect(toList());\n+  }\n+\n+  private <T extends ComponentModel> Map<String, Object> getComponentElementDeclarationParameters(ComponentElementDeclaration componentElementDeclaration,\n+                                                                                                  T model) {\n+    Map<String, Object> parametersMap = new HashMap<>();\n+\n+    Map<String, ParameterGroupModel> parameterGroups =\n+        model.getParameterGroupModels().stream().collect(toMap(NamedObject::getName, identity()));\n+\n+    List<String> parameterGroupsResolved = new ArrayList<>();\n+\n+    for (ParameterGroupElementDeclaration parameterGroupElement : componentElementDeclaration.getParameterGroups()) {\n+      final String parameterGroupName = parameterGroupElement.getName();\n+      final ParameterGroupModel parameterGroupModel = parameterGroups.get(parameterGroupName);\n+      if (parameterGroupModel == null) {\n+        throw new MuleRuntimeException(createStaticMessage(\"Could not find parameter group with name: %s in model\",\n+                                                           parameterGroupName));\n+      }\n+\n+      parameterGroupsResolved.add(parameterGroupName);\n+\n+      for (ParameterElementDeclaration parameterElement : parameterGroupElement.getParameters()) {\n+        final String parameterName = parameterElement.getName();\n+        final ParameterModel parameterModel = parameterGroupModel.getParameter(parameterName)\n+            .orElseThrow(() -> new MuleRuntimeException(createStaticMessage(\"Could not find parameter with name: %s in parameter group: %s\",\n+                                                                            parameterName, parameterGroupName)));\n+        parametersMap.put(parameterName,\n+                          extractValue(parameterElement.getValue(),\n+                                       artifactHelper().getParameterClass(parameterModel, componentElementDeclaration)));\n+      }\n+    }\n+\n+    // Default values", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "324af2099dc081b7298706c32d9dc5a6bfb1c4ce"}, "originalPosition": 202}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "918cecd2f248be06d93e1a5e4d8232fee6e45444", "author": {"user": {"login": "svacas", "name": null}}, "url": "https://github.com/mulesoft/mule/commit/918cecd2f248be06d93e1a5e4d8232fee6e45444", "committedDate": "2020-08-06T17:25:16Z", "message": "PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyODEwMDk2", "url": "https://github.com/mulesoft/mule/pull/9169#pullrequestreview-462810096", "createdAt": "2020-08-06T19:22:15Z", "commit": {"oid": "918cecd2f248be06d93e1a5e4d8232fee6e45444"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 488, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}