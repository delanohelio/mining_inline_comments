{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4MDYwNTc2", "number": 9340, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QyMToyMDoxNVrOEgKPfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QyMTo1Mzo1MlrOEgKyxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMTU3Njk0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/mule/runtime/core/internal/util/collection/TransformingCollection.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QyMToyMDoxNVrOHM33zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QyMToyMDo0M1rOHM34kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI2MDM2NQ==", "bodyText": "if transformAll was already called, this TransformingIterator isn't needed and adds overhead", "url": "https://github.com/mulesoft/mule/pull/9340#discussion_r483260365", "createdAt": "2020-09-03T21:20:15Z", "author": {"login": "elrodro83"}, "path": "core/src/main/java/org/mule/runtime/core/internal/util/collection/TransformingCollection.java", "diffHunk": "@@ -78,18 +69,28 @@ public boolean contains(Object o) {\n     readLock.lock();\n     try {\n       boolean contains = delegate.contains(o);\n-      if (!contains && o instanceof Message) {\n-        contains = delegate.contains(Result.builder((Message) o));\n+      if (!contains && isTargetInstance(o)) {\n+        readLock.unlock();\n+        writeLock.lock();\n+        try {\n+          contains = delegate.contains(o);\n+          if (!contains) {\n+            transformAll();\n+          }\n+        } finally {\n+          readLock.lock();\n+          writeLock.unlock();\n+        }\n       }\n-      return contains;\n+      return delegate.contains(o);\n     } finally {\n       readLock.unlock();\n     }\n   }\n \n   @Override\n-  public Iterator<Message> iterator() {\n-    return new ResultToMessageIterator(delegate.iterator(), cursorProviderFactory, eventContext, originatingLocation);\n+  public Iterator<T> iterator() {\n+    return new TransformingIterator<>(delegate.iterator(), transformer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72aae3df5124fac839721c899a2fbf528e39f0b3"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI2MDU2MA==", "bodyText": "this applies to all menthods that do the transformation", "url": "https://github.com/mulesoft/mule/pull/9340#discussion_r483260560", "createdAt": "2020-09-03T21:20:43Z", "author": {"login": "elrodro83"}, "path": "core/src/main/java/org/mule/runtime/core/internal/util/collection/TransformingCollection.java", "diffHunk": "@@ -78,18 +69,28 @@ public boolean contains(Object o) {\n     readLock.lock();\n     try {\n       boolean contains = delegate.contains(o);\n-      if (!contains && o instanceof Message) {\n-        contains = delegate.contains(Result.builder((Message) o));\n+      if (!contains && isTargetInstance(o)) {\n+        readLock.unlock();\n+        writeLock.lock();\n+        try {\n+          contains = delegate.contains(o);\n+          if (!contains) {\n+            transformAll();\n+          }\n+        } finally {\n+          readLock.lock();\n+          writeLock.unlock();\n+        }\n       }\n-      return contains;\n+      return delegate.contains(o);\n     } finally {\n       readLock.unlock();\n     }\n   }\n \n   @Override\n-  public Iterator<Message> iterator() {\n-    return new ResultToMessageIterator(delegate.iterator(), cursorProviderFactory, eventContext, originatingLocation);\n+  public Iterator<T> iterator() {\n+    return new TransformingIterator<>(delegate.iterator(), transformer);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI2MDM2NQ=="}, "originalCommit": {"oid": "72aae3df5124fac839721c899a2fbf528e39f0b3"}, "originalPosition": 100}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyMTY2NzI0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/org/mule/runtime/core/internal/util/collection/TransformingCollection.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QyMTo1Mzo1MlrOHM4uBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QyMTo1Mzo1MlrOHM4uBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI3NDI0NA==", "bodyText": "make volatile", "url": "https://github.com/mulesoft/mule/pull/9340#discussion_r483274244", "createdAt": "2020-09-03T21:53:52Z", "author": {"login": "elrodro83"}, "path": "core/src/main/java/org/mule/runtime/core/internal/util/collection/TransformingCollection.java", "diffHunk": "@@ -4,53 +4,45 @@\n  * license, a copy of which has been included with this distribution in the\n  * LICENSE.txt file.\n  */\n-package org.mule.runtime.core.internal.util.message;\n+package org.mule.runtime.core.internal.util.collection;\n \n import static java.util.stream.Collectors.toList;\n \n-import org.mule.runtime.api.component.location.ComponentLocation;\n-import org.mule.runtime.api.message.Message;\n-import org.mule.runtime.core.api.streaming.CursorProviderFactory;\n-import org.mule.runtime.core.privileged.event.BaseEventContext;\n-import org.mule.runtime.extension.api.runtime.operation.Result;\n-\n import java.util.Collection;\n import java.util.Iterator;\n import java.util.Spliterator;\n import java.util.concurrent.locks.Lock;\n import java.util.concurrent.locks.ReadWriteLock;\n import java.util.concurrent.locks.ReentrantReadWriteLock;\n import java.util.function.Consumer;\n+import java.util.function.Function;\n import java.util.function.Predicate;\n import java.util.stream.Stream;\n \n /**\n- * Wraps a {@link Collection} of {@link Result} instances and exposes\n- * its contents as {@link Message} instances.\n- *\n- * This allows to avoid preemptive transformations of an entire collection\n- * of {@link Result} to {@link Message}\n+ * Decorates a {@link Collection} with items of random types and uses a {@link Function}\n+ * to guarantee that, when exposed, those items have been transformed.\n+ * <p>\n+ * This allows to lazily transform the items of the collection without making a full copy of the collection\n  *\n- * @since 4.0\n+ * @since 4.4.0\n  */\n-abstract class ResultsToMessageCollection implements Collection<Message> {\n+public abstract class TransformingCollection<T> implements Collection<T> {\n \n-  private final Collection<Object> delegate;\n-  protected final CursorProviderFactory cursorProviderFactory;\n-  protected final BaseEventContext eventContext;\n-  protected final ComponentLocation originatingLocation;\n+  private Collection<Object> delegate;\n+  protected final Class<T> targetType;\n+  protected final Function<Object, T> transformer;\n   protected final ReadWriteLock readWriteLock = new ReentrantReadWriteLock();\n   protected final Lock readLock = readWriteLock.readLock();\n   protected final Lock writeLock = readWriteLock.writeLock();\n+  protected boolean transformAllInvoked = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0eca667e360dd240d2ba1a8d0b85f8625adfdb5d"}, "originalPosition": 53}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4764, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}