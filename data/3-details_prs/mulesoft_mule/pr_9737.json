{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxOTcxNDk4", "number": 9737, "title": "MULE-18984: Dynamic Configurations are not expired until the flow ends.", "bodyText": "", "createdAt": "2020-11-16T21:34:37Z", "url": "https://github.com/mulesoft/mule/pull/9737", "merged": true, "mergeCommit": {"oid": "914b7d565417f9a18047ac408883029195d2545a"}, "closed": true, "closedAt": "2020-11-21T00:55:12Z", "author": {"login": "SebaElizalde"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcGG2xAH2gAyNTIxOTcxNDk4Ojk5OWY3MDYzOTFiNTYyNzllM2Q0NTUzNmVmNTEwMTBlNDczZjAwMzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeXt7qgFqTUzNTQ0NDUxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "999f706391b56279e3d45536ef51010e473f0030", "author": {"user": {"login": "SebaElizalde", "name": "Sebastian Elizalde"}}, "url": "https://github.com/mulesoft/mule/commit/999f706391b56279e3d45536ef51010e473f0030", "committedDate": "2020-11-13T12:14:02Z", "message": "test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9b1437e7ea3ab00f2fe1f57affe3eaeff873f0d", "author": {"user": {"login": "SebaElizalde", "name": "Sebastian Elizalde"}}, "url": "https://github.com/mulesoft/mule/commit/b9b1437e7ea3ab00f2fe1f57affe3eaeff873f0d", "committedDate": "2020-11-16T21:27:53Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a41b1a1102ce8de85c458bbcce2214a0642e2014", "author": {"user": {"login": "SebaElizalde", "name": "Sebastian Elizalde"}}, "url": "https://github.com/mulesoft/mule/commit/a41b1a1102ce8de85c458bbcce2214a0642e2014", "committedDate": "2020-11-16T21:32:35Z", "message": "models"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90f0d50a24ae582f15553f5cf1584eb244d1d61e", "author": {"user": {"login": "SebaElizalde", "name": "Sebastian Elizalde"}}, "url": "https://github.com/mulesoft/mule/commit/90f0d50a24ae582f15553f5cf1584eb244d1d61e", "committedDate": "2020-11-17T13:50:43Z", "message": "on error test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1e684672707d452d0f9da6aa8b5ee646dad94d2", "author": {"user": {"login": "SebaElizalde", "name": "Sebastian Elizalde"}}, "url": "https://github.com/mulesoft/mule/commit/d1e684672707d452d0f9da6aa8b5ee646dad94d2", "committedDate": "2020-11-17T16:49:11Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb845a8735f57161734b6207d732a00b3f645005", "author": {"user": {"login": "SebaElizalde", "name": "Sebastian Elizalde"}}, "url": "https://github.com/mulesoft/mule/commit/fb845a8735f57161734b6207d732a00b3f645005", "committedDate": "2020-11-18T13:11:09Z", "message": "cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0NzA5MzUy", "url": "https://github.com/mulesoft/mule/pull/9737#pullrequestreview-534709352", "createdAt": "2020-11-19T17:58:44Z", "commit": {"oid": "fb845a8735f57161734b6207d732a00b3f645005"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNzo1ODo0NFrOH2q6BQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNzo1OTozM1rOH2q8Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA4ODEzMw==", "bodyText": "do this on the tearDown() as well, so that you're sure you're not accidentally leaking any classloaders or something like that", "url": "https://github.com/mulesoft/mule/pull/9737#discussion_r527088133", "createdAt": "2020-11-19T17:58:44Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/DynamicConfigExpirationTestCase.java", "diffHunk": "@@ -33,6 +43,29 @@ protected String getConfigFile() {\n     return \"dynamic-config-expiration.xml\";\n   }\n \n+  private static List<Integer> disposedStatuses;\n+  private static HeisenbergExtension config;\n+\n+  public static class CaptureProcessor implements Processor {\n+\n+    @Override\n+    public CoreEvent process(CoreEvent event) throws MuleException {\n+      synchronized (disposedStatuses) {\n+        if (config == null) {\n+          config = (HeisenbergExtension) event.getMessage().getPayload().getValue();\n+        }\n+        disposedStatuses.add(config.getDispose());\n+      }\n+      return event;\n+    }\n+  }\n+\n+  @Before\n+  public void setUp() {\n+    disposedStatuses = new ArrayList<>();\n+    config = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb845a8735f57161734b6207d732a00b3f645005"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA4ODU3Nw==", "bodyText": "=", "url": "https://github.com/mulesoft/mule/pull/9737#discussion_r527088577", "createdAt": "2020-11-19T17:59:23Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/DynamicConfigExpirationTestCase.java", "diffHunk": "@@ -85,6 +118,28 @@ public void expirationWorksAfterRestartingSource() throws Exception {\n     doNotExpireDynamicConfigWithCustomExpirationUsedBySource();\n   }\n \n+  @Test\n+  public void dynamicConfigIsExpiredBeforeFlowEnds() throws Exception {\n+    flowRunner(\"dynamicConfigIsExpiredBeforeFlowEnds\").withPayload(\"Walter Blanco\").run();\n+    check(PROBER_TIMEOUT, POLLING_FREQUENCY, () -> {\n+      synchronized (disposedStatuses) {\n+        return disposedStatuses.size() == 2;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb845a8735f57161734b6207d732a00b3f645005"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA4ODY5MQ==", "bodyText": "repeated code. reuse", "url": "https://github.com/mulesoft/mule/pull/9737#discussion_r527088691", "createdAt": "2020-11-19T17:59:33Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/DynamicConfigExpirationTestCase.java", "diffHunk": "@@ -85,6 +118,28 @@ public void expirationWorksAfterRestartingSource() throws Exception {\n     doNotExpireDynamicConfigWithCustomExpirationUsedBySource();\n   }\n \n+  @Test\n+  public void dynamicConfigIsExpiredBeforeFlowEnds() throws Exception {\n+    flowRunner(\"dynamicConfigIsExpiredBeforeFlowEnds\").withPayload(\"Walter Blanco\").run();\n+    check(PROBER_TIMEOUT, POLLING_FREQUENCY, () -> {\n+      synchronized (disposedStatuses) {\n+        return disposedStatuses.size() == 2;\n+      }\n+    });\n+    assertThat(disposedStatuses, contains(0, 1));\n+  }\n+\n+  @Test\n+  public void dynamicConfigIsExpiredBeforeFlowEndsWhenOperationFails() throws Exception {\n+    flowRunner(\"dynamicConfigIsExpiredBeforeFlowEndsWhenOperationFails\").run();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb845a8735f57161734b6207d732a00b3f645005"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5ac836ab90bd3b0e1469094dc19ece5f09a71f7", "author": {"user": {"login": "SebaElizalde", "name": "Sebastian Elizalde"}}, "url": "https://github.com/mulesoft/mule/commit/b5ac836ab90bd3b0e1469094dc19ece5f09a71f7", "committedDate": "2020-11-20T13:25:40Z", "message": "pr review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NDI3OTE5", "url": "https://github.com/mulesoft/mule/pull/9737#pullrequestreview-535427919", "createdAt": "2020-11-20T13:30:50Z", "commit": {"oid": "b5ac836ab90bd3b0e1469094dc19ece5f09a71f7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMzozMDo1MVrOH3PuaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMzozMDo1MVrOH3PuaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY5MTM2OA==", "bodyText": "null", "url": "https://github.com/mulesoft/mule/pull/9737#discussion_r527691368", "createdAt": "2020-11-20T13:30:51Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/DynamicConfigExpirationTestCase.java", "diffHunk": "@@ -66,6 +66,13 @@ public void setUp() {\n     config = null;\n   }\n \n+  @Override\n+  protected void doTearDown() throws Exception {\n+    disposedStatuses = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5ac836ab90bd3b0e1469094dc19ece5f09a71f7"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a9546acab0e512964a9d8b4c78ecbb4f155176f", "author": {"user": {"login": "SebaElizalde", "name": "Sebastian Elizalde"}}, "url": "https://github.com/mulesoft/mule/commit/6a9546acab0e512964a9d8b4c78ecbb4f155176f", "committedDate": "2020-11-20T13:31:23Z", "message": "review 2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NDQ0NTEy", "url": "https://github.com/mulesoft/mule/pull/9737#pullrequestreview-535444512", "createdAt": "2020-11-20T13:52:57Z", "commit": {"oid": "6a9546acab0e512964a9d8b4c78ecbb4f155176f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1083, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}