{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1NzM5NzU3", "number": 8719, "title": "MULE-18162: Enhance policy trace logger", "bodyText": "", "createdAt": "2020-03-09T18:11:05Z", "url": "https://github.com/mulesoft/mule/pull/8719", "merged": true, "mergeCommit": {"oid": "318a97a63898b07c087a2781d23877ff5f84fcc7"}, "closed": true, "closedAt": "2020-03-12T16:59:48Z", "author": {"login": "balbifm"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMCIh5AFqTM3MTQyMjY2MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMdv1UABqjMxMTcxMDEwODc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNDIyNjYw", "url": "https://github.com/mulesoft/mule/pull/8719#pullrequestreview-371422660", "createdAt": "2020-03-09T18:21:46Z", "commit": {"oid": "1b0959e5614ec0ce63a97e740507469e7afb0118"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxODoyMTo0NlrOFz0MhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxODoyMjoxMVrOFz0Naw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg3Njg2OQ==", "bodyText": "ask for this in the caller method, to avoid instantiating the lambda with the message", "url": "https://github.com/mulesoft/mule/pull/8719#discussion_r389876869", "createdAt": "2020-03-09T18:21:46Z", "author": {"login": "elrodro83"}, "path": "core/src/main/java/org/mule/runtime/core/internal/policy/PolicyTraceLogger.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.policy;\n+\n+import static org.mule.runtime.core.privileged.event.PrivilegedEvent.setCurrentEvent;\n+import static org.slf4j.LoggerFactory.getLogger;\n+\n+import org.mule.runtime.api.component.Component;\n+import org.mule.runtime.api.metadata.TypedValue;\n+import org.mule.runtime.core.api.event.CoreEvent;\n+import org.mule.runtime.core.api.policy.Policy;\n+import org.mule.runtime.core.privileged.event.PrivilegedEvent;\n+\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+\n+public class PolicyTraceLogger {\n+\n+  private static final Logger LOGGER = getLogger(PolicyTraceLogger.class);\n+  private static final String NL = System.lineSeparator();\n+  private static final String TAB = \"   \";\n+\n+  /**\n+   * Logs the event before starting to execute the source policy\n+   */\n+  public void logSourcePolicyStart(Policy policy, CoreEvent event) {\n+    if (LOGGER.isTraceEnabled()) {\n+      // Setting event in thread local so the correlation Id is printed with the log message\n+      setCurrentEvent((PrivilegedEvent) event);\n+      LOGGER.trace(NL + \"Executing policy \" + getPolicyName(policy) + NL + eventAsString(event));\n+    }\n+  }\n+\n+  /**\n+   * Logs the event before exiting current policy because of the execution of an execute-next element\n+   */\n+  public void logBeforeExecuteNext(String policyId, CoreEvent event) {\n+    logEvent(() -> NL + \"Jumping to next from policy \" + policyId, event);\n+  }\n+\n+  /**\n+   * Logs the event after execute-next is completed and resuming execution of a policy\n+   */\n+  public void logAfterExecuteNext(String policyId, CoreEvent event) {\n+    logEvent(() -> NL + \"Resuming execution of policy \" + policyId, event);\n+  }\n+\n+  /**\n+   * Logs the event before starting to execute the operation policy\n+   */\n+  public void logOperationPolicyStart(Policy policy, CoreEvent event) {\n+    logEvent(() -> NL + \"Executing operation policy \" + getPolicyName(policy), event);\n+  }\n+\n+  /**\n+   * Logs the event after execution of the source policy finished\n+   */\n+  public void logSourcePolicyEnd(Policy policy, CoreEvent event) {\n+    logEvent(() -> NL + \"Policy \" + getPolicyName(policy) + \" execution finished\", event);\n+  }\n+\n+  /**\n+   * Logs the event after execution of the operation policy finished\n+   */\n+  public void logOperationPolicyEnd(Policy policy, CoreEvent event) {\n+    logEvent(() -> NL + \"Operation policy \" + getPolicyName(policy) + \" execution finished\", event);\n+  }\n+\n+  public void logSourcePolicyFailureResult(SourcePolicyFailureResult result) {\n+    if (LOGGER.isTraceEnabled()) {\n+      LOGGER.trace(\"Event id: \" + result.getMessagingException().getEvent().getContext().getId()\n+          + \"\\nFinished processing with failure. \\n\" +\n+          \"Error message: \" + result.getMessagingException().getMessage());\n+    }\n+  }\n+\n+  private void logEvent(Supplier<String> initialLine, CoreEvent event) {\n+    if (LOGGER.isTraceEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b0959e5614ec0ce63a97e740507469e7afb0118"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg3Njk0OA==", "bodyText": "javadoc", "url": "https://github.com/mulesoft/mule/pull/8719#discussion_r389876948", "createdAt": "2020-03-09T18:21:56Z", "author": {"login": "elrodro83"}, "path": "core/src/main/java/org/mule/runtime/core/internal/policy/PolicyTraceLogger.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.policy;\n+\n+import static org.mule.runtime.core.privileged.event.PrivilegedEvent.setCurrentEvent;\n+import static org.slf4j.LoggerFactory.getLogger;\n+\n+import org.mule.runtime.api.component.Component;\n+import org.mule.runtime.api.metadata.TypedValue;\n+import org.mule.runtime.core.api.event.CoreEvent;\n+import org.mule.runtime.core.api.policy.Policy;\n+import org.mule.runtime.core.privileged.event.PrivilegedEvent;\n+\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+\n+public class PolicyTraceLogger {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b0959e5614ec0ce63a97e740507469e7afb0118"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg3NzAzNg==", "bodyText": "can this have package visibility?", "url": "https://github.com/mulesoft/mule/pull/8719#discussion_r389877036", "createdAt": "2020-03-09T18:22:04Z", "author": {"login": "elrodro83"}, "path": "core/src/main/java/org/mule/runtime/core/internal/policy/PolicyTraceLogger.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.policy;\n+\n+import static org.mule.runtime.core.privileged.event.PrivilegedEvent.setCurrentEvent;\n+import static org.slf4j.LoggerFactory.getLogger;\n+\n+import org.mule.runtime.api.component.Component;\n+import org.mule.runtime.api.metadata.TypedValue;\n+import org.mule.runtime.core.api.event.CoreEvent;\n+import org.mule.runtime.core.api.policy.Policy;\n+import org.mule.runtime.core.privileged.event.PrivilegedEvent;\n+\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+\n+public class PolicyTraceLogger {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b0959e5614ec0ce63a97e740507469e7afb0118"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg3NzA5OQ==", "bodyText": "@since", "url": "https://github.com/mulesoft/mule/pull/8719#discussion_r389877099", "createdAt": "2020-03-09T18:22:11Z", "author": {"login": "elrodro83"}, "path": "core/src/main/java/org/mule/runtime/core/internal/policy/PolicyTraceLogger.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.core.internal.policy;\n+\n+import static org.mule.runtime.core.privileged.event.PrivilegedEvent.setCurrentEvent;\n+import static org.slf4j.LoggerFactory.getLogger;\n+\n+import org.mule.runtime.api.component.Component;\n+import org.mule.runtime.api.metadata.TypedValue;\n+import org.mule.runtime.core.api.event.CoreEvent;\n+import org.mule.runtime.core.api.policy.Policy;\n+import org.mule.runtime.core.privileged.event.PrivilegedEvent;\n+\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+\n+public class PolicyTraceLogger {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b0959e5614ec0ce63a97e740507469e7afb0118"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNTAyOTQ0", "url": "https://github.com/mulesoft/mule/pull/8719#pullrequestreview-371502944", "createdAt": "2020-03-09T20:25:22Z", "commit": {"oid": "40dc4829fe5dfee569d6a221600a41b3c3304549"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b534c9de5b70f64a141aa24584c4200be9073d6c", "author": {"user": {"login": "balbifm", "name": "Federico Balbi"}}, "url": "https://github.com/mulesoft/mule/commit/b534c9de5b70f64a141aa24584c4200be9073d6c", "committedDate": "2020-03-10T14:33:34Z", "message": "Fix"}, "afterCommit": {"oid": "455c265e781c15b86804099166e5e3060f086112", "author": {"user": {"login": "balbifm", "name": "Federico Balbi"}}, "url": "https://github.com/mulesoft/mule/commit/455c265e781c15b86804099166e5e3060f086112", "committedDate": "2020-03-10T14:34:12Z", "message": "Fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMTEzNjQ2", "url": "https://github.com/mulesoft/mule/pull/8719#pullrequestreview-372113646", "createdAt": "2020-03-10T16:22:30Z", "commit": {"oid": "455c265e781c15b86804099166e5e3060f086112"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "455c265e781c15b86804099166e5e3060f086112", "author": {"user": {"login": "balbifm", "name": "Federico Balbi"}}, "url": "https://github.com/mulesoft/mule/commit/455c265e781c15b86804099166e5e3060f086112", "committedDate": "2020-03-10T14:34:12Z", "message": "Fix"}, "afterCommit": {"oid": "d5f50aa793d90978c76e8f53429b7ffa9be0fbc9", "author": {"user": {"login": "balbifm", "name": "Federico Balbi"}}, "url": "https://github.com/mulesoft/mule/commit/d5f50aa793d90978c76e8f53429b7ffa9be0fbc9", "committedDate": "2020-03-10T22:02:10Z", "message": "Fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2efc7338f3b2d224c5addc28f2d163694b1b075", "author": {"user": {"login": "balbifm", "name": "Federico Balbi"}}, "url": "https://github.com/mulesoft/mule/commit/d2efc7338f3b2d224c5addc28f2d163694b1b075", "committedDate": "2020-03-11T02:32:29Z", "message": "MULE-18162: Enhance policy trace logger"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "15dee9e0e3b9a102ce88a31c035a23e10fe7e7c6", "author": {"user": {"login": "balbifm", "name": "Federico Balbi"}}, "url": "https://github.com/mulesoft/mule/commit/15dee9e0e3b9a102ce88a31c035a23e10fe7e7c6", "committedDate": "2020-03-11T02:29:39Z", "message": "Revert \"MULE-18164: Fix policy fails to deploy when async scope is being used (#8721)\"\n\nThis reverts commit 1345e23c7a311f95c75369cb4f66c05b1b79525d."}, "afterCommit": {"oid": "d2efc7338f3b2d224c5addc28f2d163694b1b075", "author": {"user": {"login": "balbifm", "name": "Federico Balbi"}}, "url": "https://github.com/mulesoft/mule/commit/d2efc7338f3b2d224c5addc28f2d163694b1b075", "committedDate": "2020-03-11T02:32:29Z", "message": "MULE-18162: Enhance policy trace logger"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 921, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}