{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4NzMyMjA0", "number": 9802, "title": "MULE-18873: Scatter-Gather routes are dropping events during Flow-Ref processing", "bodyText": "", "createdAt": "2020-11-27T17:52:45Z", "url": "https://github.com/mulesoft/mule/pull/9802", "merged": true, "mergeCommit": {"oid": "79ce3b61d30e5d3a37c83faab8ac3f8cb99a0a33"}, "closed": true, "closedAt": "2020-12-04T02:29:18Z", "author": {"login": "IvanAndresFritzler"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgrJpaAH2gAyNTI4NzMyMjA0OjFlN2IzYjQzNjYxMmM5Y2ExNWVlMjM2ZDRlMTRjYzA0MmZhOTMyMTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdij1AVAFqTU0Mzk5NDA1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1e7b3b436612c9ca15ee236d4e14cc042fa93217", "author": {"user": {"login": "IvanAndresFritzler", "name": "Ivan Fritzler"}}, "url": "https://github.com/mulesoft/mule/commit/1e7b3b436612c9ca15ee236d4e14cc042fa93217", "committedDate": "2020-11-27T17:39:16Z", "message": "MULE-18873: Temporary change in order to look for the existence of a test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "063490bc2987b114912c5d0e7f89eae9cdd8a0d7", "author": {"user": {"login": "IvanAndresFritzler", "name": "Ivan Fritzler"}}, "url": "https://github.com/mulesoft/mule/commit/063490bc2987b114912c5d0e7f89eae9cdd8a0d7", "committedDate": "2020-11-27T17:39:16Z", "message": "Trying to fix using subscriberContext (not sure about \"main\" flow also switching to non scheduled completion)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ce8adbde9fe3a48e95e9fe7e690c43d07c9e847", "author": {"user": {"login": "IvanAndresFritzler", "name": "Ivan Fritzler"}}, "url": "https://github.com/mulesoft/mule/commit/9ce8adbde9fe3a48e95e9fe7e690c43d07c9e847", "committedDate": "2020-11-27T17:39:16Z", "message": "MULE-18873: Per suscriber logic in order to prevent event drops when Mono instances are present in the upstream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "579d96f10feea907cbdd3b6091e01ae62dc58e62", "author": {"user": {"login": "IvanAndresFritzler", "name": "Ivan Fritzler"}}, "url": "https://github.com/mulesoft/mule/commit/579d96f10feea907cbdd3b6091e01ae62dc58e62", "committedDate": "2020-11-27T17:39:16Z", "message": "MULE-18873: Fixing an issue: Downstream was not completed if a BaseEventContext.success() was called in response of a Mono emmitting the event"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "752a643b20f8a50e0b034fa86f9d7a24f5b0ca20", "author": {"user": {"login": "IvanAndresFritzler", "name": "Ivan Fritzler"}}, "url": "https://github.com/mulesoft/mule/commit/752a643b20f8a50e0b034fa86f9d7a24f5b0ca20", "committedDate": "2020-11-27T17:39:16Z", "message": "MULE-18873: Fixing error in chain build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9863677b3fddac635a0b955b019f626aa8c08b9", "author": {"user": {"login": "IvanAndresFritzler", "name": "Ivan Fritzler"}}, "url": "https://github.com/mulesoft/mule/commit/d9863677b3fddac635a0b955b019f626aa8c08b9", "committedDate": "2020-11-27T17:39:16Z", "message": "MULE-18873: Reverting unwanted modifications"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97b673323378cdaf3371f4475ff596f2c870890d", "author": {"user": {"login": "IvanAndresFritzler", "name": "Ivan Fritzler"}}, "url": "https://github.com/mulesoft/mule/commit/97b673323378cdaf3371f4475ff596f2c870890d", "committedDate": "2020-11-27T17:39:16Z", "message": "MULE-18873: Removing unwanted modifications"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "061c97654598eb218064688631f332568a2e2e5e", "author": {"user": {"login": "IvanAndresFritzler", "name": "Ivan Fritzler"}}, "url": "https://github.com/mulesoft/mule/commit/061c97654598eb218064688631f332568a2e2e5e", "committedDate": "2020-11-27T17:51:42Z", "message": "MULE-18873: Removing unwanted modifications"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "893f226b167505b054f466c1eebb59372afbc8d4", "author": {"user": {"login": "IvanAndresFritzler", "name": "Ivan Fritzler"}}, "url": "https://github.com/mulesoft/mule/commit/893f226b167505b054f466c1eebb59372afbc8d4", "committedDate": "2020-12-01T18:33:38Z", "message": "MULE-18873"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43b7516b5fbd2c6b8f865dd88bed10d143f87473", "author": {"user": {"login": "IvanAndresFritzler", "name": "Ivan Fritzler"}}, "url": "https://github.com/mulesoft/mule/commit/43b7516b5fbd2c6b8f865dd88bed10d143f87473", "committedDate": "2020-12-02T14:10:32Z", "message": "MULE-18873: Removing unused imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMDk5NTEz", "url": "https://github.com/mulesoft/mule/pull/9802#pullrequestreview-543099513", "createdAt": "2020-12-02T17:59:44Z", "commit": {"oid": "43b7516b5fbd2c6b8f865dd88bed10d143f87473"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNzo1OTo0NFrOH9na-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxODowNTo1MVrOH9np3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM3MTA2NA==", "bodyText": "static import", "url": "https://github.com/mulesoft/mule/pull/9802#discussion_r534371064", "createdAt": "2020-12-02T17:59:44Z", "author": {"login": "eze210"}, "path": "core-tests/src/test/java/org/mule/runtime/core/internal/construct/DefaultFlowTestCase.java", "diffHunk": "@@ -147,6 +157,11 @@ protected AbstractFlowConstruct getStoppedFlowConstruct() throws Exception {\n     return stoppedFlow;\n   }\n \n+  @Before\n+  public void before() {\n+    executor = Executors.newSingleThreadExecutor();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43b7516b5fbd2c6b8f865dd88bed10d143f87473"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM3MjE1MQ==", "bodyText": "remove extra blanks", "url": "https://github.com/mulesoft/mule/pull/9802#discussion_r534372151", "createdAt": "2020-12-02T18:01:22Z", "author": {"login": "eze210"}, "path": "core-tests/src/test/java/org/mule/runtime/core/internal/construct/DefaultFlowTestCase.java", "diffHunk": "@@ -503,7 +520,30 @@ public void doNotExecuteOnErrorContinueDefinedOutsideTheFlow() throws MuleExcept\n     assertThat(nonExpectedError.get(), is(false));\n   }\n \n-  private void startFlow() throws InitialisationException, MuleException {\n+  @Test\n+  @Issue(\"MULE-18873\")\n+  public void flowInsideProcessWithChildContextMustNotDropEvents()\n+      throws MuleException, ExecutionException, InterruptedException {\n+    CoreEvent testEvent = testEvent();\n+    flow = (DefaultFlow) Flow.builder(FLOW_NAME, muleContext)\n+        .source(flow.getSource())\n+        .processors(singletonList(new BlockMessageProcessor()))\n+        .processingStrategyFactory(new ProactorStreamEmitterProcessingStrategyFactory())\n+        .build();\n+    startFlow();\n+    Flux<CoreEvent> flowProcessing = Flux\n+        .from(MessageProcessors.processWithChildContext(testEvent, flow, Optional.of(from(FLOW_NAME))));\n+    Future validation = executor.submit(() -> StepVerifier.create(flowProcessing)\n+        .expectNext(testEvent)\n+        .expectComplete()\n+        .verifyThenAssertThat()\n+        .hasNotDroppedElements());\n+    validation.get();\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43b7516b5fbd2c6b8f865dd88bed10d143f87473"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM3Mjc2Mg==", "bodyText": "Isn't it possible to use a Latch?", "url": "https://github.com/mulesoft/mule/pull/9802#discussion_r534372762", "createdAt": "2020-12-02T18:02:22Z", "author": {"login": "eze210"}, "path": "core-tests/src/test/java/org/mule/runtime/core/internal/construct/DefaultFlowTestCase.java", "diffHunk": "@@ -524,4 +564,18 @@ public CoreEvent process(CoreEvent event) throws MuleException {\n           });\n     }\n   }\n+\n+  public static class BlockMessageProcessor extends AbstractComponent implements Processor {\n+\n+    @Override\n+    public CoreEvent process(CoreEvent event) throws MuleException {\n+      return sleepFor(event, muleContext.getConfiguration().getShutdownTimeout() * 2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43b7516b5fbd2c6b8f865dd88bed10d143f87473"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM3MzY5Nw==", "bodyText": "static import", "url": "https://github.com/mulesoft/mule/pull/9802#discussion_r534373697", "createdAt": "2020-12-02T18:03:57Z", "author": {"login": "eze210"}, "path": "core-tests/src/test/java/org/mule/runtime/core/internal/construct/DefaultFlowTestCase.java", "diffHunk": "@@ -503,7 +520,30 @@ public void doNotExecuteOnErrorContinueDefinedOutsideTheFlow() throws MuleExcept\n     assertThat(nonExpectedError.get(), is(false));\n   }\n \n-  private void startFlow() throws InitialisationException, MuleException {\n+  @Test\n+  @Issue(\"MULE-18873\")\n+  public void flowInsideProcessWithChildContextMustNotDropEvents()\n+      throws MuleException, ExecutionException, InterruptedException {\n+    CoreEvent testEvent = testEvent();\n+    flow = (DefaultFlow) Flow.builder(FLOW_NAME, muleContext)\n+        .source(flow.getSource())\n+        .processors(singletonList(new BlockMessageProcessor()))\n+        .processingStrategyFactory(new ProactorStreamEmitterProcessingStrategyFactory())\n+        .build();\n+    startFlow();\n+    Flux<CoreEvent> flowProcessing = Flux\n+        .from(MessageProcessors.processWithChildContext(testEvent, flow, Optional.of(from(FLOW_NAME))));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43b7516b5fbd2c6b8f865dd88bed10d143f87473"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM3NDg3OQ==", "bodyText": "Is the executor needed? What do you think about directly this?\nStepVerifier.create(flowProcessing)\n        .expectNext(testEvent)\n        .expectComplete()\n        .verifyThenAssertThat()\n        .hasNotDroppedElements();", "url": "https://github.com/mulesoft/mule/pull/9802#discussion_r534374879", "createdAt": "2020-12-02T18:05:51Z", "author": {"login": "eze210"}, "path": "core-tests/src/test/java/org/mule/runtime/core/internal/construct/DefaultFlowTestCase.java", "diffHunk": "@@ -503,7 +520,30 @@ public void doNotExecuteOnErrorContinueDefinedOutsideTheFlow() throws MuleExcept\n     assertThat(nonExpectedError.get(), is(false));\n   }\n \n-  private void startFlow() throws InitialisationException, MuleException {\n+  @Test\n+  @Issue(\"MULE-18873\")\n+  public void flowInsideProcessWithChildContextMustNotDropEvents()\n+      throws MuleException, ExecutionException, InterruptedException {\n+    CoreEvent testEvent = testEvent();\n+    flow = (DefaultFlow) Flow.builder(FLOW_NAME, muleContext)\n+        .source(flow.getSource())\n+        .processors(singletonList(new BlockMessageProcessor()))\n+        .processingStrategyFactory(new ProactorStreamEmitterProcessingStrategyFactory())\n+        .build();\n+    startFlow();\n+    Flux<CoreEvent> flowProcessing = Flux\n+        .from(MessageProcessors.processWithChildContext(testEvent, flow, Optional.of(from(FLOW_NAME))));\n+    Future validation = executor.submit(() -> StepVerifier.create(flowProcessing)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43b7516b5fbd2c6b8f865dd88bed10d143f87473"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84b6ccc99eb3199d9ee85cd7fbe75c4b9c43d467", "author": {"user": {"login": "IvanAndresFritzler", "name": "Ivan Fritzler"}}, "url": "https://github.com/mulesoft/mule/commit/84b6ccc99eb3199d9ee85cd7fbe75c4b9c43d467", "committedDate": "2020-12-03T03:25:20Z", "message": "MULE-18873: Code review changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzOTk0MDU2", "url": "https://github.com/mulesoft/mule/pull/9802#pullrequestreview-543994056", "createdAt": "2020-12-03T14:15:14Z", "commit": {"oid": "84b6ccc99eb3199d9ee85cd7fbe75c4b9c43d467"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1015, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}