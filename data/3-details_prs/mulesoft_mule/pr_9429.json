{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4NDE3MTM0", "number": 9429, "title": "MULE-18644: ValueProvider, Metadata fails due token is expired with OAuth Authorization Code Grant", "bodyText": "", "createdAt": "2020-09-17T05:37:03Z", "url": "https://github.com/mulesoft/mule/pull/9429", "merged": true, "mergeCommit": {"oid": "b117151e5c1bde894879f9b776e6c37edf0e4ce9"}, "closed": true, "closedAt": "2020-09-18T20:05:52Z", "author": {"login": "ndinu"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJLH6SgH2gAyNDg4NDE3MTM0OmQ0YTc3YjQyMDUxYzhkOTM2NTNjYjhjYjlhMDg2N2M1MzBkYTVmZGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdKKzvzgFqTQ5MTczMDY2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d4a77b42051c8d93653cb8cb9a0867c530da5fda", "author": {"user": {"login": "ndinu", "name": null}}, "url": "https://github.com/mulesoft/mule/commit/d4a77b42051c8d93653cb8cb9a0867c530da5fda", "committedDate": "2020-09-15T17:20:09Z", "message": "progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c09eefdc5f906ce26e08b93db2ca91f9859be37", "author": {"user": {"login": "ndinu", "name": null}}, "url": "https://github.com/mulesoft/mule/commit/5c09eefdc5f906ce26e08b93db2ca91f9859be37", "committedDate": "2020-09-15T17:20:09Z", "message": "progress."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e2617102ad34d7b5fb60e40b73bd678d2418a6d", "author": {"user": {"login": "ndinu", "name": null}}, "url": "https://github.com/mulesoft/mule/commit/6e2617102ad34d7b5fb60e40b73bd678d2418a6d", "committedDate": "2020-09-16T18:19:46Z", "message": "MULE-18644"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "942f4fcff936adebc9c294dbd80afd78539acb96", "author": {"user": {"login": "ndinu", "name": null}}, "url": "https://github.com/mulesoft/mule/commit/942f4fcff936adebc9c294dbd80afd78539acb96", "committedDate": "2020-09-16T18:42:16Z", "message": "self review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dec369bb5d49e80abcb9da996b54f10d6a1dbf36", "author": {"user": {"login": "ndinu", "name": null}}, "url": "https://github.com/mulesoft/mule/commit/dec369bb5d49e80abcb9da996b54f10d6a1dbf36", "committedDate": "2020-09-17T05:19:15Z", "message": "refactor util"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97cde479d35d9726aef4c6337e470ca85d79ef89", "author": {"user": {"login": "ndinu", "name": null}}, "url": "https://github.com/mulesoft/mule/commit/97cde479d35d9726aef4c6337e470ca85d79ef89", "committedDate": "2020-09-17T05:36:41Z", "message": "reword"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwNzA0MTE2", "url": "https://github.com/mulesoft/mule/pull/9429#pullrequestreview-490704116", "createdAt": "2020-09-17T15:10:38Z", "commit": {"oid": "97cde479d35d9726aef4c6337e470ca85d79ef89"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNToxMDozOVrOHTnZDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNToxMDozOVrOHTnZDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMzMDM4Mg==", "bodyText": "Unify with the definition of the variable\nSet<MetadataKey> metadataKeys = context instanceOf ConnectionProviderAwareMetadaContext...", "url": "https://github.com/mulesoft/mule/pull/9429#discussion_r490330382", "createdAt": "2020-09-17T15:10:39Z", "author": {"login": "gabrieldalborgo"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/metadata/MetadataKeysDelegate.java", "diffHunk": "@@ -85,11 +87,11 @@\n     try {\n       final Map<Integer, ParameterModel> partsByOrder = getPartOrderMapping(keyParts);\n       Set<MetadataKey> metadataKeys;\n-      if (keyResolver instanceof PartialTypeKeysResolver && hasInitialLevel(partialKey, partsByOrder, reflectionCache)) {\n-        metadataKeys = singleton(((PartialTypeKeysResolver) keyResolver).resolveChilds(context, partialKey));\n-      } else {\n-        metadataKeys = keyResolver.getKeys(context);\n-      }\n+\n+      metadataKeys = context instanceof ConnectionProviderAwareMetadataContext", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97cde479d35d9726aef4c6337e470ca85d79ef89"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c781ccdf6ad47cef795e9c1c246e4e29c5e548e", "author": {"user": {"login": "ndinu", "name": null}}, "url": "https://github.com/mulesoft/mule/commit/6c781ccdf6ad47cef795e9c1c246e4e29c5e548e", "committedDate": "2020-09-17T15:54:08Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc28d2062fc835a17173811a8cf2fba2c74fde94", "author": {"user": {"login": "ndinu", "name": null}}, "url": "https://github.com/mulesoft/mule/commit/dc28d2062fc835a17173811a8cf2fba2c74fde94", "committedDate": "2020-09-17T16:07:50Z", "message": "Adds requested changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNTI1MTk1", "url": "https://github.com/mulesoft/mule/pull/9429#pullrequestreview-491525195", "createdAt": "2020-09-18T14:36:47Z", "commit": {"oid": "dc28d2062fc835a17173811a8cf2fba2c74fde94"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNDozNjo0OFrOHUP56g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNDo0MjoyN1rOHUQIkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5NDE1NA==", "bodyText": "why 4.3.1?", "url": "https://github.com/mulesoft/mule/pull/9429#discussion_r490994154", "createdAt": "2020-09-18T14:36:48Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/metadata/ConnectionProviderAwareMetadataContext.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.extension.internal.metadata;\n+\n+import org.mule.runtime.api.connection.ConnectionProvider;\n+import org.mule.runtime.api.metadata.MetadataContext;\n+\n+import java.util.Optional;\n+\n+/**\n+ * A {@link MetadataContext} which is aware of the {@link ConnectionProvider} used to provide its connection.\n+ *\n+ * @since 4.4.0, 4.3.1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc28d2062fc835a17173811a8cf2fba2c74fde94"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5NDMxNw==", "bodyText": "why the specialization intstead of adding this to the general metadataContext ?", "url": "https://github.com/mulesoft/mule/pull/9429#discussion_r490994317", "createdAt": "2020-09-18T14:37:04Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/metadata/ConnectionProviderAwareMetadataContext.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.runtime.module.extension.internal.metadata;\n+\n+import org.mule.runtime.api.connection.ConnectionProvider;\n+import org.mule.runtime.api.metadata.MetadataContext;\n+\n+import java.util.Optional;\n+\n+/**\n+ * A {@link MetadataContext} which is aware of the {@link ConnectionProvider} used to provide its connection.\n+ *\n+ * @since 4.4.0, 4.3.1\n+ */\n+public interface ConnectionProviderAwareMetadataContext extends MetadataContext {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc28d2062fc835a17173811a8cf2fba2c74fde94"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5Njc4NA==", "bodyText": "this ternary construct is all over the place. Generalize it more.", "url": "https://github.com/mulesoft/mule/pull/9429#discussion_r490996784", "createdAt": "2020-09-18T14:40:46Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/metadata/MetadataKeysDelegate.java", "diffHunk": "@@ -84,12 +86,11 @@\n \n     try {\n       final Map<Integer, ParameterModel> partsByOrder = getPartOrderMapping(keyParts);\n-      Set<MetadataKey> metadataKeys;\n-      if (keyResolver instanceof PartialTypeKeysResolver && hasInitialLevel(partialKey, partsByOrder, reflectionCache)) {\n-        metadataKeys = singleton(((PartialTypeKeysResolver) keyResolver).resolveChilds(context, partialKey));\n-      } else {\n-        metadataKeys = keyResolver.getKeys(context);\n-      }\n+      Set<MetadataKey> metadataKeys = context instanceof ConnectionProviderAwareMetadataContext\n+          ? getWithTokenRefreshIfNecessary(((ConnectionProviderAwareMetadataContext) context).getConnectionProvider()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc28d2062fc835a17173811a8cf2fba2c74fde94"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5NzQxOQ==", "bodyText": "jdoc", "url": "https://github.com/mulesoft/mule/pull/9429#discussion_r490997419", "createdAt": "2020-09-18T14:41:44Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/connectivity/oauth/ExtensionsOAuthUtils.java", "diffHunk": "@@ -92,9 +94,12 @@ public static ClientCredentialsLocation toCredentialsLocation(CredentialsPlaceme\n \n   public static OAuthConnectionProviderWrapper getOAuthConnectionProvider(ExecutionContextAdapter operationContext) {\n     ConfigurationInstance config = ((ConfigurationInstance) operationContext.getConfiguration().get());\n-    ConnectionProvider provider =\n-        unwrapProviderWrapper(config.getConnectionProvider().get(), OAuthConnectionProviderWrapper.class);\n-    return provider instanceof OAuthConnectionProviderWrapper ? (OAuthConnectionProviderWrapper) provider : null;\n+    return getOAuthConnectionProvider(config.getConnectionProvider().get());\n+  }\n+\n+  public static OAuthConnectionProviderWrapper getOAuthConnectionProvider(ConnectionProvider provider) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc28d2062fc835a17173811a8cf2fba2c74fde94"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk5NzkwNQ==", "bodyText": "add jdoc and rename to withRefreshToken", "url": "https://github.com/mulesoft/mule/pull/9429#discussion_r490997905", "createdAt": "2020-09-18T14:42:27Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/connectivity/oauth/ExtensionsOAuthUtils.java", "diffHunk": "@@ -195,19 +200,57 @@ public static OAuthConnectionProviderWrapper getOAuthConnectionProvider(Executio\n     }\n   }\n \n+  public static <T> T getWithTokenRefreshIfNecessary(ConnectionProvider connectionProvider, CheckedSupplier<T> supplier)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc28d2062fc835a17173811a8cf2fba2c74fde94"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42b3836213d97acc8523710a6a67848f948751b7", "author": {"user": {"login": "ndinu", "name": null}}, "url": "https://github.com/mulesoft/mule/commit/42b3836213d97acc8523710a6a67848f948751b7", "committedDate": "2020-09-18T16:46:19Z", "message": "Adds feedback changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNzMwNjY4", "url": "https://github.com/mulesoft/mule/pull/9429#pullrequestreview-491730668", "createdAt": "2020-09-18T19:32:03Z", "commit": {"oid": "42b3836213d97acc8523710a6a67848f948751b7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1204, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}