{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1ODc2MDgy", "number": 9184, "title": "MULE-18547: ValueProviderModel does not provide information of the resolver implementation therefore caching mechanism are not going to work correctly with providerName only", "bodyText": "", "createdAt": "2020-08-11T05:32:38Z", "url": "https://github.com/mulesoft/mule/pull/9184", "merged": true, "mergeCommit": {"oid": "d259c181d743bf7489c24db0bde2c12dd7be5446"}, "closed": true, "closedAt": "2020-08-12T18:49:29Z", "author": {"login": "ndinu"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9lrMqAH2gAyNDY1ODc2MDgyOjBmZWEzODk3NDc2ODkzM2Q5NGZlM2UyNTdjOGFlZWMyNGRiYjAzYmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-O6TAAFqTQ2NjEyODQzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0fea38974768933d94fe3e257c8aeec24dbb03ba", "author": {"user": {"login": "ndinu", "name": null}}, "url": "https://github.com/mulesoft/mule/commit/0fea38974768933d94fe3e257c8aeec24dbb03ba", "committedDate": "2020-08-10T17:29:08Z", "message": "progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e348985536b96beddd82f74fcf9925c57c15a13", "author": {"user": {"login": "ndinu", "name": null}}, "url": "https://github.com/mulesoft/mule/commit/6e348985536b96beddd82f74fcf9925c57c15a13", "committedDate": "2020-08-10T17:29:08Z", "message": "more progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc30aefc31380144623538d7387efa434a3e98c3", "author": {"user": {"login": "ndinu", "name": null}}, "url": "https://github.com/mulesoft/mule/commit/dc30aefc31380144623538d7387efa434a3e98c3", "committedDate": "2020-08-10T17:29:08Z", "message": "adds validator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83a2c11296f5a03c6ed836dc91e969f9ddab6e23", "author": {"user": {"login": "ndinu", "name": null}}, "url": "https://github.com/mulesoft/mule/commit/83a2c11296f5a03c6ed836dc91e969f9ddab6e23", "committedDate": "2020-08-11T04:15:37Z", "message": "progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "121a021dae6f9422de01af030418f0388741933b", "author": {"user": {"login": "ndinu", "name": null}}, "url": "https://github.com/mulesoft/mule/commit/121a021dae6f9422de01af030418f0388741933b", "committedDate": "2020-08-11T05:31:56Z", "message": "removes empty spaces"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "675d06321b9e20bc2073aad6207abff50960d8f5", "author": {"user": {"login": "ndinu", "name": null}}, "url": "https://github.com/mulesoft/mule/commit/675d06321b9e20bc2073aad6207abff50960d8f5", "committedDate": "2020-08-11T14:17:40Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MjMzMTAy", "url": "https://github.com/mulesoft/mule/pull/9184#pullrequestreview-465233102", "createdAt": "2020-08-11T16:27:58Z", "commit": {"oid": "675d06321b9e20bc2073aad6207abff50960d8f5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNjoyNzo1OFrOG-_wjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNzozNzowNFrOG_CSOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwOTUxOA==", "bodyText": "exponential complexity algorithm. This will affect start up time. Optimize this.", "url": "https://github.com/mulesoft/mule/pull/9184#discussion_r468709518", "createdAt": "2020-08-11T16:27:58Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/loader/validation/ValueProviderModelValidator.java", "diffHunk": "@@ -45,48 +54,89 @@\n \n   @Override\n   public void validate(ExtensionModel model, ProblemsReporter problemsReporter) {\n+    final Map<String, ValueProviderInformation> valueProviders = new HashMap<>();\n     new IdempotentExtensionWalker() {\n \n       @Override\n       protected void onConfiguration(ConfigurationModel model) {\n-        validateModel(model, problemsReporter, false);\n+        validateModel(model, problemsReporter, false, valueProviders);\n       }\n \n       @Override\n       protected void onConnectionProvider(ConnectionProviderModel model) {\n-        validateModel(model, problemsReporter, false);\n+        validateModel(model, problemsReporter, false, valueProviders);\n       }\n \n       @Override\n       protected void onSource(SourceModel model) {\n-        validateModel(model, problemsReporter, true);\n+        validateModel(model, problemsReporter, true, valueProviders);\n       }\n \n       @Override\n       protected void onOperation(OperationModel model) {\n-        validateModel(model, problemsReporter, true);\n+        validateModel(model, problemsReporter, true, valueProviders);\n       }\n     }.walk(model);\n+    if (isCompiletime(model)) {\n+      validateProviderIds(valueProviders, problemsReporter);\n+    }\n+  }\n+\n+  private void validateProviderIds(Map<String, ValueProviderInformation> valueProviders, ProblemsReporter problemsReporter) {\n+    Set<String> processedValueProviders = new HashSet<>();\n+    valueProviders.entrySet().stream().forEach(entry -> {\n+      ValueProviderInformation valueProviderInformation = entry.getValue();\n+      ParameterizedModel ownerModel = valueProviderInformation.ownerModel;\n+      String valueProviderId = valueProviderInformation.getValueProviderModel().getProviderId();\n+      String valueProviderImplentation = entry.getKey();\n+      processedValueProviders.add(valueProviderImplentation);\n+      valueProviders.entrySet().stream().forEach(otherEntry -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "675d06321b9e20bc2073aad6207abff50960d8f5"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwOTg4Ng==", "bodyText": "you can simply use valueProviders.forEach((k, v) -> {})", "url": "https://github.com/mulesoft/mule/pull/9184#discussion_r468709886", "createdAt": "2020-08-11T16:28:29Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/loader/validation/ValueProviderModelValidator.java", "diffHunk": "@@ -45,48 +54,89 @@\n \n   @Override\n   public void validate(ExtensionModel model, ProblemsReporter problemsReporter) {\n+    final Map<String, ValueProviderInformation> valueProviders = new HashMap<>();\n     new IdempotentExtensionWalker() {\n \n       @Override\n       protected void onConfiguration(ConfigurationModel model) {\n-        validateModel(model, problemsReporter, false);\n+        validateModel(model, problemsReporter, false, valueProviders);\n       }\n \n       @Override\n       protected void onConnectionProvider(ConnectionProviderModel model) {\n-        validateModel(model, problemsReporter, false);\n+        validateModel(model, problemsReporter, false, valueProviders);\n       }\n \n       @Override\n       protected void onSource(SourceModel model) {\n-        validateModel(model, problemsReporter, true);\n+        validateModel(model, problemsReporter, true, valueProviders);\n       }\n \n       @Override\n       protected void onOperation(OperationModel model) {\n-        validateModel(model, problemsReporter, true);\n+        validateModel(model, problemsReporter, true, valueProviders);\n       }\n     }.walk(model);\n+    if (isCompiletime(model)) {\n+      validateProviderIds(valueProviders, problemsReporter);\n+    }\n+  }\n+\n+  private void validateProviderIds(Map<String, ValueProviderInformation> valueProviders, ProblemsReporter problemsReporter) {\n+    Set<String> processedValueProviders = new HashSet<>();\n+    valueProviders.entrySet().stream().forEach(entry -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "675d06321b9e20bc2073aad6207abff50960d8f5"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcxMDg5MQ==", "bodyText": "this cache should be received as an argument and be reused in the entire validate() method. It's not much of a cache otherwise", "url": "https://github.com/mulesoft/mule/pull/9184#discussion_r468710891", "createdAt": "2020-08-11T16:29:54Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/loader/validation/ValueProviderModelValidator.java", "diffHunk": "@@ -45,48 +54,89 @@\n \n   @Override\n   public void validate(ExtensionModel model, ProblemsReporter problemsReporter) {\n+    final Map<String, ValueProviderInformation> valueProviders = new HashMap<>();\n     new IdempotentExtensionWalker() {\n \n       @Override\n       protected void onConfiguration(ConfigurationModel model) {\n-        validateModel(model, problemsReporter, false);\n+        validateModel(model, problemsReporter, false, valueProviders);\n       }\n \n       @Override\n       protected void onConnectionProvider(ConnectionProviderModel model) {\n-        validateModel(model, problemsReporter, false);\n+        validateModel(model, problemsReporter, false, valueProviders);\n       }\n \n       @Override\n       protected void onSource(SourceModel model) {\n-        validateModel(model, problemsReporter, true);\n+        validateModel(model, problemsReporter, true, valueProviders);\n       }\n \n       @Override\n       protected void onOperation(OperationModel model) {\n-        validateModel(model, problemsReporter, true);\n+        validateModel(model, problemsReporter, true, valueProviders);\n       }\n     }.walk(model);\n+    if (isCompiletime(model)) {\n+      validateProviderIds(valueProviders, problemsReporter);\n+    }\n+  }\n+\n+  private void validateProviderIds(Map<String, ValueProviderInformation> valueProviders, ProblemsReporter problemsReporter) {\n+    Set<String> processedValueProviders = new HashSet<>();\n+    valueProviders.entrySet().stream().forEach(entry -> {\n+      ValueProviderInformation valueProviderInformation = entry.getValue();\n+      ParameterizedModel ownerModel = valueProviderInformation.ownerModel;\n+      String valueProviderId = valueProviderInformation.getValueProviderModel().getProviderId();\n+      String valueProviderImplentation = entry.getKey();\n+      processedValueProviders.add(valueProviderImplentation);\n+      valueProviders.entrySet().stream().forEach(otherEntry -> {\n+        String otherValueProviderId = otherEntry.getValue().getValueProviderModel().getProviderId();\n+        String otherValueProviderImplentation = otherEntry.getKey();\n+        if (processedValueProviders.contains(otherValueProviderImplentation)) {\n+          return;\n+        }\n+        if (valueProviderId.equals(otherValueProviderId)) {\n+          problemsReporter.addError(new Problem(valueProviderInformation.ownerModel,\n+                                                format(\"Parameter '%s' from the %s '%s' uses an implementation of ValueProviders\"\n+                                                    + \" [%s] with id '%s'. There is another implementations of ValueProviders\"\n+                                                    + \" [%s] that uses the same id. ValueProviders id must be unique.\",\n+                                                       valueProviderInformation.parameterModel.getName(),\n+                                                       getComponentModelTypeName(ownerModel), getModelName(ownerModel),\n+                                                       valueProviderImplentation, valueProviderId,\n+                                                       otherValueProviderImplentation)));\n+        }\n+      });\n+    });\n   }\n \n-  private void validateModel(ParameterizedModel model, ProblemsReporter problemsReporter, boolean supportsConnectionsAndConfigs) {\n+  private void validateModel(ParameterizedModel model, ProblemsReporter problemsReporter, boolean supportsConnectionsAndConfigs,\n+                             Map<String, ValueProviderInformation> valueProviders) {\n     ReflectionCache reflectionCache = new ReflectionCache();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "675d06321b9e20bc2073aad6207abff50960d8f5"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcxMjEzOQ==", "bodyText": "why enforce this? can't this break backwards compatiblity?", "url": "https://github.com/mulesoft/mule/pull/9184#discussion_r468712139", "createdAt": "2020-08-11T16:31:47Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/loader/validation/ValueProviderModelValidator.java", "diffHunk": "@@ -45,48 +54,89 @@\n \n   @Override\n   public void validate(ExtensionModel model, ProblemsReporter problemsReporter) {\n+    final Map<String, ValueProviderInformation> valueProviders = new HashMap<>();\n     new IdempotentExtensionWalker() {\n \n       @Override\n       protected void onConfiguration(ConfigurationModel model) {\n-        validateModel(model, problemsReporter, false);\n+        validateModel(model, problemsReporter, false, valueProviders);\n       }\n \n       @Override\n       protected void onConnectionProvider(ConnectionProviderModel model) {\n-        validateModel(model, problemsReporter, false);\n+        validateModel(model, problemsReporter, false, valueProviders);\n       }\n \n       @Override\n       protected void onSource(SourceModel model) {\n-        validateModel(model, problemsReporter, true);\n+        validateModel(model, problemsReporter, true, valueProviders);\n       }\n \n       @Override\n       protected void onOperation(OperationModel model) {\n-        validateModel(model, problemsReporter, true);\n+        validateModel(model, problemsReporter, true, valueProviders);\n       }\n     }.walk(model);\n+    if (isCompiletime(model)) {\n+      validateProviderIds(valueProviders, problemsReporter);\n+    }\n+  }\n+\n+  private void validateProviderIds(Map<String, ValueProviderInformation> valueProviders, ProblemsReporter problemsReporter) {\n+    Set<String> processedValueProviders = new HashSet<>();\n+    valueProviders.entrySet().stream().forEach(entry -> {\n+      ValueProviderInformation valueProviderInformation = entry.getValue();\n+      ParameterizedModel ownerModel = valueProviderInformation.ownerModel;\n+      String valueProviderId = valueProviderInformation.getValueProviderModel().getProviderId();\n+      String valueProviderImplentation = entry.getKey();\n+      processedValueProviders.add(valueProviderImplentation);\n+      valueProviders.entrySet().stream().forEach(otherEntry -> {\n+        String otherValueProviderId = otherEntry.getValue().getValueProviderModel().getProviderId();\n+        String otherValueProviderImplentation = otherEntry.getKey();\n+        if (processedValueProviders.contains(otherValueProviderImplentation)) {\n+          return;\n+        }\n+        if (valueProviderId.equals(otherValueProviderId)) {\n+          problemsReporter.addError(new Problem(valueProviderInformation.ownerModel,\n+                                                format(\"Parameter '%s' from the %s '%s' uses an implementation of ValueProviders\"\n+                                                    + \" [%s] with id '%s'. There is another implementations of ValueProviders\"\n+                                                    + \" [%s] that uses the same id. ValueProviders id must be unique.\",\n+                                                       valueProviderInformation.parameterModel.getName(),\n+                                                       getComponentModelTypeName(ownerModel), getModelName(ownerModel),\n+                                                       valueProviderImplentation, valueProviderId,\n+                                                       otherValueProviderImplentation)));\n+        }\n+      });\n+    });\n   }\n \n-  private void validateModel(ParameterizedModel model, ProblemsReporter problemsReporter, boolean supportsConnectionsAndConfigs) {\n+  private void validateModel(ParameterizedModel model, ProblemsReporter problemsReporter, boolean supportsConnectionsAndConfigs,\n+                             Map<String, ValueProviderInformation> valueProviders) {\n     ReflectionCache reflectionCache = new ReflectionCache();\n     model.getAllParameterModels()\n         .forEach(param -> param\n             .getModelProperty(ValueProviderFactoryModelProperty.class)\n             .ifPresent(modelProperty -> validateOptionsResolver(param, modelProperty, model, problemsReporter,\n-                                                                supportsConnectionsAndConfigs, reflectionCache)));\n+                                                                supportsConnectionsAndConfigs, reflectionCache, valueProviders)));\n   }\n \n   private void validateOptionsResolver(ParameterModel param, ValueProviderFactoryModelProperty modelProperty,\n                                        ParameterizedModel model, ProblemsReporter problemsReporter,\n-                                       boolean supportsConnectionsAndConfigs, ReflectionCache reflectionCache) {\n+                                       boolean supportsConnectionsAndConfigs, ReflectionCache reflectionCache,\n+                                       Map<String, ValueProviderInformation> valueProviders) {\n     Class<? extends ValueProvider> valueProvider = modelProperty.getValueProvider();\n     String providerName = valueProvider.getSimpleName();\n+    Optional<ValueProviderModel> valueProviderModel = param.getValueProviderModel();\n+    if (!valueProviderModel.isPresent()) {\n+      throw new IllegalStateException(format(\"Parameter %s from %s with name %s has should have a ValueProviderModel associated.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "675d06321b9e20bc2073aad6207abff50960d8f5"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODc1MDkwNg==", "bodyText": "if this method is called add, then it should just add, not validate. It's also weird that  you also have the  validateProviderIds  method traversing the map again validating other aspects. You should either completely separate data gathering from data validation all-together, or validate as you gather, but this mix up is not a good idea and ultimately needs to the algorithm being highly inefficient.", "url": "https://github.com/mulesoft/mule/pull/9184#discussion_r468750906", "createdAt": "2020-08-11T17:37:04Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/loader/validation/ValueProviderModelValidator.java", "diffHunk": "@@ -146,4 +196,46 @@ private void validateOptionsResolver(ParameterModel param, ValueProviderFactoryM\n       }\n     }\n   }\n+\n+  private void addValueProvider(String providerName, ValueProviderModel valueProviderModel,\n+                                Map<String, ValueProviderInformation> valueProviders, ProblemsReporter problemsReporter,\n+                                ParameterizedModel model, ParameterModel parameterModel) {\n+    if (valueProviders.containsKey(providerName)) {\n+      String storedProviderId = valueProviders.get(providerName).getValueProviderModel().getProviderId();\n+      String providerId = valueProviderModel.getProviderId();\n+      if (!providerId.equals(storedProviderId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "675d06321b9e20bc2073aad6207abff50960d8f5"}, "originalPosition": 133}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df4af95f637186a99546661c4391bba8404640cf", "author": {"user": {"login": "ndinu", "name": null}}, "url": "https://github.com/mulesoft/mule/commit/df4af95f637186a99546661c4391bba8404640cf", "committedDate": "2020-08-12T02:21:27Z", "message": "progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e67a57cac1a64326ef469d5d3898ef0673a5efb2", "author": {"user": {"login": "ndinu", "name": null}}, "url": "https://github.com/mulesoft/mule/commit/e67a57cac1a64326ef469d5d3898ef0673a5efb2", "committedDate": "2020-08-12T06:18:26Z", "message": "Adds requested changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1OTgyMzM2", "url": "https://github.com/mulesoft/mule/pull/9184#pullrequestreview-465982336", "createdAt": "2020-08-12T14:38:41Z", "commit": {"oid": "e67a57cac1a64326ef469d5d3898ef0673a5efb2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDozODo0MVrOG_kXHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDozODo0MVrOG_kXHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwOTIxNA==", "bodyText": "the runtime already has a centralized control to decide when to invoke validators and when not. If the runtime decides it wants to run the validations, the validator should not go rogue and decide otherwise. This is just a flag which doesn't fix the problems with this algorithms", "url": "https://github.com/mulesoft/mule/pull/9184#discussion_r469309214", "createdAt": "2020-08-12T14:38:41Z", "author": {"login": "marianogonzalez"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/loader/validation/ValueProviderModelValidator.java", "diffHunk": "@@ -45,48 +54,111 @@\n \n   @Override\n   public void validate(ExtensionModel model, ProblemsReporter problemsReporter) {\n+    final ReflectionCache reflectionCache = new ReflectionCache();\n+    boolean isCompileTime = isCompiletime(model);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e67a57cac1a64326ef469d5d3898ef0673a5efb2"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1263f2c0c26f69118a522259e74d8753f19b3759", "author": {"user": {"login": "ndinu", "name": null}}, "url": "https://github.com/mulesoft/mule/commit/1263f2c0c26f69118a522259e74d8753f19b3759", "committedDate": "2020-08-12T16:13:52Z", "message": "Adds requested changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MTI4NDMz", "url": "https://github.com/mulesoft/mule/pull/9184#pullrequestreview-466128433", "createdAt": "2020-08-12T17:31:44Z", "commit": {"oid": "1263f2c0c26f69118a522259e74d8753f19b3759"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 513, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}