{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3MTg4MDIw", "number": 8942, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzoxMjoyOVrOEHL2Sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzoxNTo1OFrOEHL5jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1OTY5NjExOnYy", "diffSide": "RIGHT", "path": "modules/http/src/test/java/org/mule/module/http/internal/listener/grizzly/ResponseDeferringCompletionHandlerOnFailureTestCase.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzoxMjoyOVrOGmb6Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzoxMjoyOVrOGmb6Xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk1NjM4Mg==", "bodyText": "chunk", "url": "https://github.com/mulesoft/mule/pull/8942#discussion_r442956382", "createdAt": "2020-06-19T17:12:29Z", "author": {"login": "eze210"}, "path": "modules/http/src/test/java/org/mule/module/http/internal/listener/grizzly/ResponseDeferringCompletionHandlerOnFailureTestCase.java", "diffHunk": "@@ -0,0 +1,158 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.module.http.internal.listener.grizzly;\n+\n+import static java.lang.Boolean.TRUE;\n+import static org.glassfish.grizzly.http.Protocol.HTTP_1_1;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.instanceOf;\n+import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.not;\n+import static org.hamcrest.Matchers.nullValue;\n+import static org.junit.Assert.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.mule.module.http.internal.listener.grizzly.ResponseDeferringCompletionHandler.FAILURE_WHILE_PROCESSING_HTTP_RESPONSE_BODY;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.util.concurrent.Semaphore;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.apache.commons.collections.MultiHashMap;\n+import org.glassfish.grizzly.Connection;\n+import org.glassfish.grizzly.Transport;\n+import org.glassfish.grizzly.filterchain.FilterChain;\n+import org.glassfish.grizzly.filterchain.FilterChainContext;\n+import org.glassfish.grizzly.http.HttpRequestPacket;\n+import org.glassfish.grizzly.memory.HeapMemoryManager;\n+import org.glassfish.grizzly.memory.MemoryManager;\n+import org.hamcrest.Matchers;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mule.api.MuleEvent;\n+import org.mule.api.transport.OutputHandler;\n+import org.mule.module.http.internal.domain.OutputHandlerHttpEntity;\n+import org.mule.module.http.internal.domain.response.DefaultHttpResponse;\n+import org.mule.module.http.internal.domain.response.HttpResponse;\n+import org.mule.module.http.internal.domain.response.ResponseStatus;\n+import org.mule.module.http.internal.listener.async.ResponseStatusCallback;\n+import org.mule.tck.junit4.AbstractMuleTestCase;\n+import org.mule.tck.probe.PollingProber;\n+import org.mule.tck.probe.Probe;\n+\n+public class ResponseDeferringCompletionHandlerOnFailureTestCase extends AbstractMuleTestCase implements OutputHandler\n+{\n+\n+    private static final int POOLING_FREQUENCY_MILLIS = 1000;\n+    private static final int POOLING_TIMEOUT_MILLIS = 20000;\n+\n+    private FilterChainContext ctx = mock(FilterChainContext.class);\n+    private FilterChain filterChain = mock(FilterChain.class);\n+    private Connection connection = mock(Connection.class);\n+    private Transport transport = mock(Transport.class);\n+    private MemoryManager memoryManager = new HeapMemoryManager();\n+    private HttpRequestPacket request = mock(HttpRequestPacket.class);\n+    private HttpResponse response;\n+    private Exception exceptionOnFlush;\n+\n+    private ResponseDeferringCompletionHandler responseDeferringCompletionHandler;\n+\n+    private AtomicBoolean firstChunkWritten = new AtomicBoolean(false);\n+    private AtomicBoolean contentWritten = new AtomicBoolean(false);\n+    private Semaphore stepSync = new Semaphore(0);\n+\n+    private OutputStream outputStream;\n+\n+\n+    @Before\n+    public void setUp() throws Exception\n+    {\n+        mockHttpRequestAndResponse();\n+        responseDeferringCompletionHandler = new ResponseDeferringCompletionHandler(ctx, request, response, mock(ResponseStatusCallback.class));\n+    }\n+\n+    @Test\n+    public void testFlushFailsAndDoNotHangOnFailure() throws IOException, InterruptedException\n+    {\n+        responseDeferringCompletionHandler.start();\n+\n+        waitUntilContentSynchronizer(firstChunkWritten);\n+\n+        // It fails\n+        responseDeferringCompletionHandler.failed(new IOException(\"Broken pipe\"));\n+\n+        // Step sync is released so that the response attempts to flush a chunl again.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "caa8820c8dc9740478746c11cba7345ad2c5e463"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1OTcwNDQ2OnYy", "diffSide": "RIGHT", "path": "modules/http/src/test/java/org/mule/module/http/internal/listener/grizzly/ResponseDeferringCompletionHandlerOnFailureTestCase.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzoxNTo1OFrOGmb_6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzoxNTo1OFrOGmb_6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk1NzgwMA==", "bodyText": "Use a scheduler", "url": "https://github.com/mulesoft/mule/pull/8942#discussion_r442957800", "createdAt": "2020-06-19T17:15:58Z", "author": {"login": "eze210"}, "path": "modules/http/src/test/java/org/mule/module/http/internal/listener/grizzly/ResponseDeferringCompletionHandlerOnFailureTestCase.java", "diffHunk": "@@ -0,0 +1,158 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.module.http.internal.listener.grizzly;\n+\n+import static java.lang.Boolean.TRUE;\n+import static org.glassfish.grizzly.http.Protocol.HTTP_1_1;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.instanceOf;\n+import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.not;\n+import static org.hamcrest.Matchers.nullValue;\n+import static org.junit.Assert.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.mule.module.http.internal.listener.grizzly.ResponseDeferringCompletionHandler.FAILURE_WHILE_PROCESSING_HTTP_RESPONSE_BODY;\n+\n+import java.io.IOException;\n+import java.io.OutputStream;\n+import java.util.concurrent.Semaphore;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.apache.commons.collections.MultiHashMap;\n+import org.glassfish.grizzly.Connection;\n+import org.glassfish.grizzly.Transport;\n+import org.glassfish.grizzly.filterchain.FilterChain;\n+import org.glassfish.grizzly.filterchain.FilterChainContext;\n+import org.glassfish.grizzly.http.HttpRequestPacket;\n+import org.glassfish.grizzly.memory.HeapMemoryManager;\n+import org.glassfish.grizzly.memory.MemoryManager;\n+import org.hamcrest.Matchers;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mule.api.MuleEvent;\n+import org.mule.api.transport.OutputHandler;\n+import org.mule.module.http.internal.domain.OutputHandlerHttpEntity;\n+import org.mule.module.http.internal.domain.response.DefaultHttpResponse;\n+import org.mule.module.http.internal.domain.response.HttpResponse;\n+import org.mule.module.http.internal.domain.response.ResponseStatus;\n+import org.mule.module.http.internal.listener.async.ResponseStatusCallback;\n+import org.mule.tck.junit4.AbstractMuleTestCase;\n+import org.mule.tck.probe.PollingProber;\n+import org.mule.tck.probe.Probe;\n+\n+public class ResponseDeferringCompletionHandlerOnFailureTestCase extends AbstractMuleTestCase implements OutputHandler\n+{\n+\n+    private static final int POOLING_FREQUENCY_MILLIS = 1000;\n+    private static final int POOLING_TIMEOUT_MILLIS = 20000;\n+\n+    private FilterChainContext ctx = mock(FilterChainContext.class);\n+    private FilterChain filterChain = mock(FilterChain.class);\n+    private Connection connection = mock(Connection.class);\n+    private Transport transport = mock(Transport.class);\n+    private MemoryManager memoryManager = new HeapMemoryManager();\n+    private HttpRequestPacket request = mock(HttpRequestPacket.class);\n+    private HttpResponse response;\n+    private Exception exceptionOnFlush;\n+\n+    private ResponseDeferringCompletionHandler responseDeferringCompletionHandler;\n+\n+    private AtomicBoolean firstChunkWritten = new AtomicBoolean(false);\n+    private AtomicBoolean contentWritten = new AtomicBoolean(false);\n+    private Semaphore stepSync = new Semaphore(0);\n+\n+    private OutputStream outputStream;\n+\n+\n+    @Before\n+    public void setUp() throws Exception\n+    {\n+        mockHttpRequestAndResponse();\n+        responseDeferringCompletionHandler = new ResponseDeferringCompletionHandler(ctx, request, response, mock(ResponseStatusCallback.class));\n+    }\n+\n+    @Test\n+    public void testFlushFailsAndDoNotHangOnFailure() throws IOException, InterruptedException\n+    {\n+        responseDeferringCompletionHandler.start();\n+\n+        waitUntilContentSynchronizer(firstChunkWritten);\n+\n+        // It fails\n+        responseDeferringCompletionHandler.failed(new IOException(\"Broken pipe\"));\n+\n+        // Step sync is released so that the response attempts to flush a chunl again.\n+        stepSync.release();\n+\n+        waitUntilContentSynchronizer(contentWritten);\n+        assertThat(exceptionOnFlush, is(not(nullValue())));\n+        assertThat(exceptionOnFlush, instanceOf(IOException.class));\n+        assertThat(exceptionOnFlush.getMessage(), equalTo(FAILURE_WHILE_PROCESSING_HTTP_RESPONSE_BODY));\n+        assertThat(firstChunkWritten.get(), is(TRUE));\n+    }\n+\n+    @Override\n+    public void write(MuleEvent event, final OutputStream out) throws IOException\n+    {\n+        outputStream = out;\n+\n+        new Thread(\"Thread that flushes\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "caa8820c8dc9740478746c11cba7345ad2c5e463"}, "originalPosition": 104}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4952, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}