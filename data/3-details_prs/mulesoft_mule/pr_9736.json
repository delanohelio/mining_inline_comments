{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxOTU3NTkw", "number": 9736, "title": "MULE-18906: Watermark in polling sources is updated when source is stopping.", "bodyText": "", "createdAt": "2020-11-16T21:05:09Z", "url": "https://github.com/mulesoft/mule/pull/9736", "merged": true, "mergeCommit": {"oid": "127a17fb4ba108573c7cfcf5ec188fe5a370ea5c"}, "closed": true, "closedAt": "2020-11-18T13:16:00Z", "author": {"login": "SebaElizalde"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddLfj2AH2gAyNTIxOTU3NTkwOjBmNTUzMjRkMzRiZWE1NDJmYTQzZDBmMDI1Njc2YWZiMTdjMmFhZDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddg6WUAFqTUzMjg0OTI0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0f55324d34bea542fa43d0f025676afb17c2aad7", "author": {"user": {"login": "SebaElizalde", "name": "Sebastian Elizalde"}}, "url": "https://github.com/mulesoft/mule/commit/0f55324d34bea542fa43d0f025676afb17c2aad7", "committedDate": "2020-11-16T21:04:28Z", "message": "all"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNzc5NTYx", "url": "https://github.com/mulesoft/mule/pull/9736#pullrequestreview-531779561", "createdAt": "2020-11-16T21:06:17Z", "commit": {"oid": "0f55324d34bea542fa43d0f025676afb17c2aad7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMTowNjoxN1rOH0R0PQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMTowNjoxN1rOH0R0PQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU3OTkwMQ==", "bodyText": "Comment from @Bardammu :\n\"We can try to retrieve all the values of recentlyProcessedIds and then call contains for each key. In this way, we avoid making a request for each key to OSv2.\nNot in this PR, it's something we should think about.\"", "url": "https://github.com/mulesoft/mule/pull/9736#discussion_r524579901", "createdAt": "2020-11-16T21:06:17Z", "author": {"login": "SebaElizalde"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/PollingSourceWrapper.java", "diffHunk": "@@ -603,14 +607,19 @@ private void setCurrentWatermarkAsMinimumRejectWatermark(Serializable minimumRej\n     watermarkObjectStore.store(WATERMARK_ITEM_OS_KEY, minimumRejectedByLimitPassingWatermark);\n   }\n \n-  private void updateRecentlyProcessedIds() throws ObjectStoreException {\n+  private void updateRecentlyProcessedIds(boolean clearRecentlyProcessed) throws ObjectStoreException {\n     Lock osClearingLock = lockFactory.createLock(UPDATE_PROCESSED_LOCK);\n     try {\n       osClearingLock.lock();\n       List<String> strings = idsOnUpdatedWatermark.allKeys();\n-      recentlyProcessedIds.clear();\n+      if (clearRecentlyProcessed) {\n+        recentlyProcessedIds.clear();\n+      }\n       strings.forEach(key -> {\n         try {\n+          if (!clearRecentlyProcessed && recentlyProcessedIds.contains(key)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f55324d34bea542fa43d0f025676afb17c2aad7"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMzE5MjQ2", "url": "https://github.com/mulesoft/mule/pull/9736#pullrequestreview-532319246", "createdAt": "2020-11-17T12:38:32Z", "commit": {"oid": "0f55324d34bea542fa43d0f025676afb17c2aad7"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMjozODozMlrOH0y66g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMzowNToyMlrOH0z3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTEyMjI4Mg==", "bodyText": "Why are these changes necesary? Can't we just skip this step if the source is stopping?", "url": "https://github.com/mulesoft/mule/pull/9736#discussion_r525122282", "createdAt": "2020-11-17T12:38:32Z", "author": {"login": "ndinu"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/PollingSourceWrapper.java", "diffHunk": "@@ -603,14 +607,19 @@ private void setCurrentWatermarkAsMinimumRejectWatermark(Serializable minimumRej\n     watermarkObjectStore.store(WATERMARK_ITEM_OS_KEY, minimumRejectedByLimitPassingWatermark);\n   }\n \n-  private void updateRecentlyProcessedIds() throws ObjectStoreException {\n+  private void updateRecentlyProcessedIds(boolean clearRecentlyProcessed) throws ObjectStoreException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f55324d34bea542fa43d0f025676afb17c2aad7"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTEyMzAzNw==", "bodyText": "where does the need of doing this comes from? I though that if the source was stopping we could skip this.", "url": "https://github.com/mulesoft/mule/pull/9736#discussion_r525123037", "createdAt": "2020-11-17T12:39:51Z", "author": {"login": "ndinu"}, "path": "modules/extensions-support/src/main/java/org/mule/runtime/module/extension/internal/runtime/source/poll/PollingSourceWrapper.java", "diffHunk": "@@ -200,9 +200,13 @@ private void poll(SourceCallback<T, A> sourceCallback) {\n       DefaultPollContext pollContext = new DefaultPollContext(sourceCallback, getCurrentWatermark(), getUpdatedWatermark());\n       try {\n         delegate.poll(pollContext);\n-        pollContext.getUpdatedWatermark()\n-            .ifPresent(w -> updateWatermark(w, pollContext.getWatermarkComparator(),\n-                                            pollContext.getMinimumRejectedByLimitPassingWatermark().orElse(null)));\n+        if (isRequestedToStop()) {\n+          updateRecentlyProcessedIds(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f55324d34bea542fa43d0f025676afb17c2aad7"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTEyNzA4NQ==", "bodyText": "Should the default for this mean, never await? so that we do not affect existing tests.", "url": "https://github.com/mulesoft/mule/pull/9736#discussion_r525127085", "createdAt": "2020-11-17T12:46:57Z", "author": {"login": "ndinu"}, "path": "tests/test-extensions/petstore-extension/src/main/java/org/mule/test/petstore/extension/WatermarkingPetAdoptionSource.java", "diffHunk": "@@ -22,22 +22,22 @@\n import org.mule.runtime.extension.api.runtime.source.SourceCallbackContext;\n \n import java.util.List;\n+import java.util.concurrent.CountDownLatch;\n \n @MetadataScope(outputResolver = PollingSourceMetadataResolver.class)\n @MediaType(TEXT_PLAIN)\n-public class WatermarkingPetAdoptionSource extends PollingSource<String, Void> {\n+public class WatermarkingPetAdoptionSource extends PollingSource<String, Integer> {\n \n-  public static int STARTED_POLLS;\n-  private int index;\n-  private int polls;\n+  private int pollCounter;\n+  private static int index = 0;\n+  private static boolean alreadyWaited = false;\n+  private static CountDownLatch continueLatch = new CountDownLatch(1);\n \n-  @Parameter\n-  @org.mule.runtime.extension.api.annotation.param.Optional(defaultValue = \"false\")\n-  protected boolean useWatermark;\n+  public static CountDownLatch beginLatch = new CountDownLatch(1);\n \n   @Parameter\n-  @org.mule.runtime.extension.api.annotation.param.Optional(defaultValue = \"false\")\n-  protected boolean idempotent;\n+  @org.mule.runtime.extension.api.annotation.param.Optional(defaultValue = \"0\")\n+  protected Integer awaitOnItem;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f55324d34bea542fa43d0f025676afb17c2aad7"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTEzNzcxOQ==", "bodyText": "Use constants for timeout and frequency", "url": "https://github.com/mulesoft/mule/pull/9736#discussion_r525137719", "createdAt": "2020-11-17T13:05:22Z", "author": {"login": "ndinu"}, "path": "modules/extensions-spring-support/src/test/java/org/mule/test/module/extension/source/PollingSourceRestartingTestCase.java", "diffHunk": "@@ -0,0 +1,166 @@\n+/*\n+ * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com\n+ * The software in this package is published under the terms of the CPAL v1.0\n+ * license, a copy of which has been included with this distribution in the\n+ * LICENSE.txt file.\n+ */\n+package org.mule.test.module.extension.source;\n+\n+import static java.util.Arrays.asList;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.contains;\n+import static org.hamcrest.Matchers.hasSize;\n+import static org.hamcrest.number.OrderingComparison.lessThanOrEqualTo;\n+import static org.mule.runtime.module.extension.internal.ExtensionProperties.ENABLE_POLLING_SOURCE_LIMIT_PARAMETER;\n+import static org.mule.tck.probe.PollingProber.check;\n+import static org.mule.tck.probe.PollingProber.checkNot;\n+import static org.mule.test.petstore.extension.WatermarkingPetAdoptionSource.beginLatch;\n+import static org.mule.test.petstore.extension.WatermarkingPetAdoptionSource.resetSource;\n+\n+import org.mule.runtime.api.exception.MuleException;\n+import org.mule.runtime.api.lifecycle.Startable;\n+import org.mule.runtime.api.lifecycle.Stoppable;\n+import org.mule.runtime.api.util.MultiMap;\n+import org.mule.runtime.core.api.event.CoreEvent;\n+import org.mule.runtime.core.api.processor.Processor;\n+import org.mule.test.module.extension.AbstractExtensionFunctionalTestCase;\n+\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.junit.Test;\n+\n+public class PollingSourceRestartingTestCase extends AbstractExtensionFunctionalTestCase {\n+\n+  private static int PROBER_TIMEOUT = 30000;\n+  private static int CHECK_NOT_PROBER_TIMEOUT = 5000;\n+  private static int PROBER_FREQUENCY = 500;\n+\n+  protected static final Map<String, Object> EXTENSION_LOADER_CONTEXT_ADDITIONAL_PARAMS = new HashMap<String, Object>() {\n+\n+    {\n+      put(ENABLE_POLLING_SOURCE_LIMIT_PARAMETER, true);\n+    }\n+  };\n+\n+  protected static MultiMap<Integer, String> ADOPTIONS = new MultiMap<>();\n+\n+  public static class AdoptionProcessor implements Processor {\n+\n+    @Override\n+    public CoreEvent process(CoreEvent event) throws MuleException {\n+      String pet = (String) event.getMessage().getPayload().getValue();\n+      Integer poll = (Integer) event.getMessage().getAttributes().getValue();\n+      synchronized (ADOPTIONS) {\n+        ADOPTIONS.put(poll, pet);\n+      }\n+      return event;\n+    }\n+  }\n+\n+  @Override\n+  protected boolean mustRegenerateExtensionModels() {\n+    return true;\n+  }\n+\n+  @Override\n+  protected Map<String, Object> getExtensionLoaderContextAdditionalParameters() {\n+    return EXTENSION_LOADER_CONTEXT_ADDITIONAL_PARAMS;\n+  }\n+\n+  @Override\n+  protected String getConfigFile() {\n+    return \"polling-source-restarting-config.xml\";\n+  }\n+\n+  @Override\n+  protected void doTearDown() throws Exception {\n+    ADOPTIONS.clear();\n+    resetSource();\n+  }\n+\n+  @Test\n+  public void unprocessedItemsAreProcessedWhenSourceIsRestartedMidPoll() throws Exception {\n+    assertWatermarkingForStopStartScenario(asList(\"Anibal\", \"Barbara\", \"Colonel Meow\", \"Daphne\", \"Elsa\"),\n+                                           \"unprocessedItemsAreProcessedWhenSourceIsRestartedMidPoll\");\n+  }\n+\n+  @Test\n+  public void processedItemsWithSameWatermarkAreNotReprocessedWhenSourceIsRestartedMidPoll() throws Exception {\n+    assertWatermarkingForStopStartScenario(asList(\"Anibal\", \"Barbara\"),\n+                                           \"processedItemsWithSameWatermarkAreNotReprocessedWhenSourceIsRestartedMidPoll\");\n+  }\n+\n+  @Test\n+  public void processedItemsWithNewWatermarkAreReprocessedWhenSourceIsRestartedMidPoll() throws Exception {\n+    assertWatermarkingForStopStartScenario(asList(\"Anibal\", \"Barbara\", \"ANIBAL\", \"BARBARA\", \"Colonel Meow\"),\n+                                           \"processedItemsWithNewWatermarkAreReprocessedWhenSourceIsRestartedMidPoll\");\n+  }\n+\n+  @Test\n+  public void unprocessedItemsAreProcessedWhenSourceIsRestartedMidPollWithLimit() throws Exception {\n+    assertWatermarkingForStopStartScenario(asList(\"Anibal\", \"Barbara\", \"Colonel Meow\", \"Daphne\", \"Elsa\"),\n+                                           \"unprocessedItemsAreProcessedWhenSourceIsRestartedMidPollWithLimit\");\n+    assertLimitIsApplied(3);\n+  }\n+\n+  @Test\n+  public void processedItemsWithSameWatermarkAreNotReprocessedWhenSourceIsRestartedMidPollWithLimit() throws Exception {\n+    assertWatermarkingForStopStartScenario(asList(\"Anibal\", \"Barbara\"),\n+                                           \"processedItemsWithSameWatermarkAreNotReprocessedWhenSourceIsRestartedMidPollWithLimit\");\n+    assertLimitIsApplied(2);\n+  }\n+\n+  @Test\n+  public void processedItemsWithNewWatermarkAreReprocessedWhenSourceIsRestartedMidPollWithLimit() throws Exception {\n+    assertWatermarkingForStopStartScenario(asList(\"Anibal\", \"Barbara\", \"ANIBAL\", \"BARBARA\", \"Colonel Meow\"),\n+                                           \"processedItemsWithNewWatermarkAreReprocessedWhenSourceIsRestartedMidPollWithLimit\");\n+    assertLimitIsApplied(2);\n+  }\n+\n+  private void assertWatermarkingForStopStartScenario(List<String> expectedPets, String flowName) throws Exception {\n+    startFlow(flowName);\n+    beginLatch.await();\n+    stopFlow(flowName);\n+    check(5000, 1000, () -> getFlowConstruct(flowName).getLifecycleState().isStopped());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f55324d34bea542fa43d0f025676afb17c2aad7"}, "originalPosition": 127}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6b56cca5bbed65b941a47efbedea03fb2e37e18", "author": {"user": {"login": "SebaElizalde", "name": "Sebastian Elizalde"}}, "url": "https://github.com/mulesoft/mule/commit/d6b56cca5bbed65b941a47efbedea03fb2e37e18", "committedDate": "2020-11-17T19:30:01Z", "message": "pr review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyODAyNjM1", "url": "https://github.com/mulesoft/mule/pull/9736#pullrequestreview-532802635", "createdAt": "2020-11-17T20:52:53Z", "commit": {"oid": "d6b56cca5bbed65b941a47efbedea03fb2e37e18"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a47efef6f232335975eaeb9a0f16285a2737e6f", "author": {"user": {"login": "SebaElizalde", "name": "Sebastian Elizalde"}}, "url": "https://github.com/mulesoft/mule/commit/8a47efef6f232335975eaeb9a0f16285a2737e6f", "committedDate": "2020-11-17T21:23:00Z", "message": "constants"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyODQ5MjQ2", "url": "https://github.com/mulesoft/mule/pull/9736#pullrequestreview-532849246", "createdAt": "2020-11-17T22:01:44Z", "commit": {"oid": "8a47efef6f232335975eaeb9a0f16285a2737e6f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1080, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}