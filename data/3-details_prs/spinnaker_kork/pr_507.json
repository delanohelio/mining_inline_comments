{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyMTc5NDUx", "number": 507, "title": "feat(plugins): HTTP client plugin API", "bodyText": "The first actual API for kork-plugins-api and one that will be necessary pretty quick here as we at Netflix start getting closer to moving our internal extensions into plugins. This HTTP client is designed to allow plugins to make HTTP requests without directly wiring up & configuring their own HTTP clients, per-se.\nAn extension could have a constructor dependency on HttpClientProvider and with #506, it would be injected and the implementation of the HttpClients themselves would be encapsulated within the service internals, allowing us to iterate the client without forcing transitive dependencies on plugin developers.\nACTION: Review the API. I went with simple being the primary guiding light. I explicitly decided not to follow in a pattern like Retrofit despite its nice API because it's not very simple and we'd be stuck with that pattern for a long time. We can always make the API more complex, but it'll be hard to make it simpler as time goes on. Does the API do the trick? Does it make sense?\nIf we like this, I'll add class docs, tests and make it work and so-on.", "createdAt": "2020-02-07T00:34:01Z", "url": "https://github.com/spinnaker/kork/pull/507", "merged": true, "mergeCommit": {"oid": "1f27a13db31f222b5022bb9f7261119644e2b65c"}, "closed": true, "closedAt": "2020-03-02T21:02:38Z", "author": {"login": "robzienert"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcB0R-NAFqTM1NDg2NzMwNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcJ0JmagH2gAyMzcyMTc5NDUxOmQzNGIwMzNjMzU1OWVjMjAzZWM4YjNmMjc5NzYzZGVmY2Y0NTEyYzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0ODY3MzA1", "url": "https://github.com/spinnaker/kork/pull/507#pullrequestreview-354867305", "createdAt": "2020-02-07T00:34:41Z", "commit": {"oid": "a36812a317c86d57be243fb5f9bc5005cab3862b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMDozNDo0MlrOFmu6GQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwMDozNDo0MlrOFmu6GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjE1ODc0NQ==", "bodyText": "I'm adding a new dependency for the kork-plugins-api. I think having @Nonnull and so-on are pretty valuable, and this dependency changes once in never.", "url": "https://github.com/spinnaker/kork/pull/507#discussion_r376158745", "createdAt": "2020-02-07T00:34:42Z", "author": {"login": "robzienert"}, "path": "kork-plugins-api/kork-plugins-api.gradle", "diffHunk": "@@ -15,10 +15,12 @@\n  */\n \n apply plugin: \"java-library\"\n+apply from: \"$rootDir/gradle/kotlin-test.gradle\"\n \n dependencies {\n   api(platform(project(\":spinnaker-dependencies\")))\n \n+  api \"javax.annotation:javax.annotation-api\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a36812a317c86d57be243fb5f9bc5005cab3862b"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1Mzg2NDMz", "url": "https://github.com/spinnaker/kork/pull/507#pullrequestreview-355386433", "createdAt": "2020-02-07T19:30:37Z", "commit": {"oid": "a36812a317c86d57be243fb5f9bc5005cab3862b"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxOTozMDozOFrOFnH3UA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QyMDo1MjozM1rOFnJ9hA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU2NzYzMg==", "bodyText": "possible that we may have a concurrency/thread safety around accessing this method ?", "url": "https://github.com/spinnaker/kork/pull/507#discussion_r376567632", "createdAt": "2020-02-07T19:30:38Z", "author": {"login": "srekapalli"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/httpclient/Ok3HttpClientProvider.kt", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.httpclient\n+\n+import com.fasterxml.jackson.databind.ObjectMapper\n+import com.netflix.spinnaker.config.OkHttp3ClientConfiguration\n+import com.netflix.spinnaker.kork.exceptions.IntegrationException\n+import com.netflix.spinnaker.kork.plugins.api.httpclient.HttpClient\n+import com.netflix.spinnaker.kork.plugins.api.httpclient.HttpClientConfig\n+import com.netflix.spinnaker.kork.plugins.api.httpclient.HttpClientProvider\n+import com.netflix.spinnaker.okhttp.OkHttp3MetricsInterceptor\n+import com.netflix.spinnaker.okhttp.OkHttpClientConfigurationProperties\n+import okhttp3.OkHttpClient\n+import org.springframework.context.ApplicationContext\n+\n+class Ok3HttpClientProvider(\n+  private val pluginId: String,\n+  private val applicationContext: ApplicationContext,\n+  private val objectMapper: ObjectMapper,\n+  okHttp3ClientConfiguration: OkHttp3ClientConfiguration\n+) : HttpClientProvider {\n+\n+  private val internalServicesClient = okHttp3ClientConfiguration.create().build()\n+  private val okClients: MutableMap<HttpClientConfig, OkHttpClient> = mutableMapOf()\n+  private val clients: MutableMap<String, Ok3HttpClient> = mutableMapOf()\n+\n+  override fun configure(name: String, baseUrl: String, config: HttpClientConfig) {\n+    clients.computeIfAbsent(\"$pluginId.$name\") {\n+      // Try to reduce the number of OkHttpClient instances that are floating around. We'll only create a new client\n+      // if the config is different from any other OkHttpClient.\n+      val okClient = okClients.computeIfAbsent(config) {\n+        OkHttp3ClientConfiguration(\n+          OkHttpClientConfigurationProperties().apply {\n+            config.connectionPool.keepAlive?.let {\n+              connectionPool.keepAliveDurationMs = it.toMillis().toInt()\n+            }\n+            config.connectionPool.maxIdleConnections?.let {\n+              connectionPool.maxIdleConnections = it\n+            }\n+\n+            config.connection.connectTimeout?.let {\n+              connectTimeoutMs = it.toMillis()\n+            }\n+            config.connection.readTimeout?.let {\n+              readTimeoutMs = it.toMillis()\n+            }\n+            retryOnConnectionFailure = config.connection.isRetryOnConnectionFailure\n+\n+            if (config.security.keyStorePath != null && config.security.trustStorePath != null) {\n+              keyStore = config.security.keyStorePath.toFile()\n+              keyStoreType = config.security.keyStoreType\n+              keyStorePassword = config.security.keyStorePassword\n+\n+              trustStore = config.security.trustStorePath.toFile()\n+              trustStoreType = config.security.trustStoreType\n+              trustStorePassword = config.security.trustStorePassword\n+\n+              tlsVersions = config.security.tlsVersions\n+              cipherSuites = config.security.cipherSuites\n+            }\n+          },\n+          applicationContext.getBean(OkHttp3MetricsInterceptor::class.java)\n+        ).create().build()\n+      }\n+\n+      Ok3HttpClient(\"$pluginId.$name\", baseUrl, okClient, objectMapper)\n+    }\n+  }\n+\n+  override fun get(name: String): HttpClient {\n+    return clients[\"$pluginId.$name\"] ?: throw IntegrationException(\"No client configured for '$name'\")\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a36812a317c86d57be243fb5f9bc5005cab3862b"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYwMTMxOQ==", "bodyText": "Prob. We can get the response Object straight back from the HTTP method and throw a error/exception back for unsuccessful calls. ?", "url": "https://github.com/spinnaker/kork/pull/507#discussion_r376601319", "createdAt": "2020-02-07T20:50:46Z", "author": {"login": "srekapalli"}, "path": "kork-plugins-api/src/test/kotlin/com/netflix/spinnaker/kork/plugins/httpclient/HttpClientIntegrationTest.kt", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.httpclient\n+\n+import com.netflix.spinnaker.kork.plugins.api.httpclient.HttpClientProvider\n+import com.netflix.spinnaker.kork.plugins.api.httpclient.Request\n+import dev.minutest.junit.JUnit5Minutests\n+import dev.minutest.rootContext\n+import io.mockk.mockk\n+\n+class HttpClientIntegrationTest : JUnit5Minutests {\n+\n+  fun tests() = rootContext {\n+    test(\"wip - dsl\") {\n+      val clientProvider: HttpClientProvider = mockk(relaxed = true)\n+\n+      val front50 = clientProvider.getInternal(\"front50\")\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a36812a317c86d57be243fb5f9bc5005cab3862b"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYwMTk4OA==", "bodyText": "How about getInternalServiceClient instead of getInternal ?", "url": "https://github.com/spinnaker/kork/pull/507#discussion_r376601988", "createdAt": "2020-02-07T20:52:33Z", "author": {"login": "srekapalli"}, "path": "kork-plugins-api/src/test/kotlin/com/netflix/spinnaker/kork/plugins/httpclient/HttpClientIntegrationTest.kt", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.httpclient\n+\n+import com.netflix.spinnaker.kork.plugins.api.httpclient.HttpClientProvider\n+import com.netflix.spinnaker.kork.plugins.api.httpclient.Request\n+import dev.minutest.junit.JUnit5Minutests\n+import dev.minutest.rootContext\n+import io.mockk.mockk\n+\n+class HttpClientIntegrationTest : JUnit5Minutests {\n+\n+  fun tests() = rootContext {\n+    test(\"wip - dsl\") {\n+      val clientProvider: HttpClientProvider = mockk(relaxed = true)\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a36812a317c86d57be243fb5f9bc5005cab3862b"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTgxNzg2", "url": "https://github.com/spinnaker/kork/pull/507#pullrequestreview-355581786", "createdAt": "2020-02-09T03:43:27Z", "commit": {"oid": "a36812a317c86d57be243fb5f9bc5005cab3862b"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQwMzo0MzoyN1rOFnTI2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQwMzo1NTozN1rOFnTKoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc1MjM0NA==", "bodyText": "I suspect there\u2019s value in by-default making it easy to access response headers, status codes, etc. which I believe this is supporting.\n(Versus just the object)", "url": "https://github.com/spinnaker/kork/pull/507#discussion_r376752344", "createdAt": "2020-02-09T03:43:27Z", "author": {"login": "ajordens"}, "path": "kork-plugins-api/src/test/kotlin/com/netflix/spinnaker/kork/plugins/httpclient/HttpClientIntegrationTest.kt", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.httpclient\n+\n+import com.netflix.spinnaker.kork.plugins.api.httpclient.HttpClientProvider\n+import com.netflix.spinnaker.kork.plugins.api.httpclient.Request\n+import dev.minutest.junit.JUnit5Minutests\n+import dev.minutest.rootContext\n+import io.mockk.mockk\n+\n+class HttpClientIntegrationTest : JUnit5Minutests {\n+\n+  fun tests() = rootContext {\n+    test(\"wip - dsl\") {\n+      val clientProvider: HttpClientProvider = mockk(relaxed = true)\n+\n+      val front50 = clientProvider.getInternal(\"front50\")\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYwMTMxOQ=="}, "originalCommit": {"oid": "a36812a317c86d57be243fb5f9bc5005cab3862b"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc1MjM5Mw==", "bodyText": "getBody(clazz) might be more idiomatic.", "url": "https://github.com/spinnaker/kork/pull/507#discussion_r376752393", "createdAt": "2020-02-09T03:45:06Z", "author": {"login": "ajordens"}, "path": "kork-plugins-api/src/test/kotlin/com/netflix/spinnaker/kork/plugins/httpclient/HttpClientIntegrationTest.kt", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.httpclient\n+\n+import com.netflix.spinnaker.kork.plugins.api.httpclient.HttpClientProvider\n+import com.netflix.spinnaker.kork.plugins.api.httpclient.Request\n+import dev.minutest.junit.JUnit5Minutests\n+import dev.minutest.rootContext\n+import io.mockk.mockk\n+\n+class HttpClientIntegrationTest : JUnit5Minutests {\n+\n+  fun tests() = rootContext {\n+    test(\"wip - dsl\") {\n+      val clientProvider: HttpClientProvider = mockk(relaxed = true)\n+\n+      val front50 = clientProvider.getInternal(\"front50\")\n+\n+      val response = front50.get(Request(\"getGate\", \"/v2/applications/gate\"))\n+\n+      val app = response.getPayload(Application::class.java)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a36812a317c86d57be243fb5f9bc5005cab3862b"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc1MjYxMQ==", "bodyText": "Had an error response body or just returned a 4xx/5xx?", "url": "https://github.com/spinnaker/kork/pull/507#discussion_r376752611", "createdAt": "2020-02-09T03:50:45Z", "author": {"login": "ajordens"}, "path": "kork-plugins-api/src/main/java/com/netflix/spinnaker/kork/plugins/api/httpclient/Response.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.api.httpclient;\n+\n+import java.util.Map;\n+import java.util.Optional;\n+import javax.annotation.Nonnull;\n+\n+/** HTTP Response wrapper. */\n+public interface Response {\n+\n+  /** Get the response payload. */\n+  Object getPayload();\n+\n+  <T> T getPayload(@Nonnull Class<T> expectedType);\n+\n+  /** Get the error exception, if present. */\n+  Optional<Exception> getException();\n+\n+  /** Get the response code. */\n+  int getStatusCode();\n+\n+  /** Get the response headers. */\n+  Map<String, String> getHeaders();\n+\n+  /** Returns whether or not the request had an error. */\n+  default boolean isError() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a36812a317c86d57be243fb5f9bc5005cab3862b"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc1MjgwMA==", "bodyText": "Some of the existing services have this nested within services.BLAH.baseUrl.\nWe going to try and make that consistent or ...?", "url": "https://github.com/spinnaker/kork/pull/507#discussion_r376752800", "createdAt": "2020-02-09T03:55:37Z", "author": {"login": "ajordens"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/httpclient/Ok3HttpClientProvider.kt", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.httpclient\n+\n+import com.fasterxml.jackson.databind.ObjectMapper\n+import com.netflix.spinnaker.config.OkHttp3ClientConfiguration\n+import com.netflix.spinnaker.kork.exceptions.IntegrationException\n+import com.netflix.spinnaker.kork.plugins.api.httpclient.HttpClient\n+import com.netflix.spinnaker.kork.plugins.api.httpclient.HttpClientConfig\n+import com.netflix.spinnaker.kork.plugins.api.httpclient.HttpClientProvider\n+import com.netflix.spinnaker.okhttp.OkHttp3MetricsInterceptor\n+import com.netflix.spinnaker.okhttp.OkHttpClientConfigurationProperties\n+import okhttp3.OkHttpClient\n+import org.springframework.context.ApplicationContext\n+\n+class Ok3HttpClientProvider(\n+  private val pluginId: String,\n+  private val applicationContext: ApplicationContext,\n+  private val objectMapper: ObjectMapper,\n+  okHttp3ClientConfiguration: OkHttp3ClientConfiguration\n+) : HttpClientProvider {\n+\n+  private val internalServicesClient = okHttp3ClientConfiguration.create().build()\n+  private val okClients: MutableMap<HttpClientConfig, OkHttpClient> = mutableMapOf()\n+  private val clients: MutableMap<String, Ok3HttpClient> = mutableMapOf()\n+\n+  override fun configure(name: String, baseUrl: String, config: HttpClientConfig) {\n+    clients.computeIfAbsent(\"$pluginId.$name\") {\n+      // Try to reduce the number of OkHttpClient instances that are floating around. We'll only create a new client\n+      // if the config is different from any other OkHttpClient.\n+      val okClient = okClients.computeIfAbsent(config) {\n+        OkHttp3ClientConfiguration(\n+          OkHttpClientConfigurationProperties().apply {\n+            config.connectionPool.keepAlive?.let {\n+              connectionPool.keepAliveDurationMs = it.toMillis().toInt()\n+            }\n+            config.connectionPool.maxIdleConnections?.let {\n+              connectionPool.maxIdleConnections = it\n+            }\n+\n+            config.connection.connectTimeout?.let {\n+              connectTimeoutMs = it.toMillis()\n+            }\n+            config.connection.readTimeout?.let {\n+              readTimeoutMs = it.toMillis()\n+            }\n+            retryOnConnectionFailure = config.connection.isRetryOnConnectionFailure\n+\n+            if (config.security.keyStorePath != null && config.security.trustStorePath != null) {\n+              keyStore = config.security.keyStorePath.toFile()\n+              keyStoreType = config.security.keyStoreType\n+              keyStorePassword = config.security.keyStorePassword\n+\n+              trustStore = config.security.trustStorePath.toFile()\n+              trustStoreType = config.security.trustStoreType\n+              trustStorePassword = config.security.trustStorePassword\n+\n+              tlsVersions = config.security.tlsVersions\n+              cipherSuites = config.security.cipherSuites\n+            }\n+          },\n+          applicationContext.getBean(OkHttp3MetricsInterceptor::class.java)\n+        ).create().build()\n+      }\n+\n+      Ok3HttpClient(\"$pluginId.$name\", baseUrl, okClient, objectMapper)\n+    }\n+  }\n+\n+  override fun get(name: String): HttpClient {\n+    return clients[\"$pluginId.$name\"] ?: throw IntegrationException(\"No client configured for '$name'\")\n+  }\n+\n+  override fun getInternal(name: String): HttpClient {\n+    val baseUrl = applicationContext.environment.getProperty(\"${name.toLowerCase()}.baseUrl\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a36812a317c86d57be243fb5f9bc5005cab3862b"}, "originalPosition": 88}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTgyNjkz", "url": "https://github.com/spinnaker/kork/pull/507#pullrequestreview-355582693", "createdAt": "2020-02-09T04:17:56Z", "commit": {"oid": "a36812a317c86d57be243fb5f9bc5005cab3862b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQwNDoxNzo1NlrOFnTNtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOVQwNDoxNzo1NlrOFnTNtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njc1MzU4OA==", "bodyText": "Cool beans, having the normal set of metrics will be handy.\nDo we think there would be any value in an additional tag to indicate the originating pluginId?", "url": "https://github.com/spinnaker/kork/pull/507#discussion_r376753588", "createdAt": "2020-02-09T04:17:56Z", "author": {"login": "ajordens"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/httpclient/Ok3HttpClientProvider.kt", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.httpclient\n+\n+import com.fasterxml.jackson.databind.ObjectMapper\n+import com.netflix.spinnaker.config.OkHttp3ClientConfiguration\n+import com.netflix.spinnaker.kork.exceptions.IntegrationException\n+import com.netflix.spinnaker.kork.plugins.api.httpclient.HttpClient\n+import com.netflix.spinnaker.kork.plugins.api.httpclient.HttpClientConfig\n+import com.netflix.spinnaker.kork.plugins.api.httpclient.HttpClientProvider\n+import com.netflix.spinnaker.okhttp.OkHttp3MetricsInterceptor\n+import com.netflix.spinnaker.okhttp.OkHttpClientConfigurationProperties\n+import okhttp3.OkHttpClient\n+import org.springframework.context.ApplicationContext\n+\n+class Ok3HttpClientProvider(\n+  private val pluginId: String,\n+  private val applicationContext: ApplicationContext,\n+  private val objectMapper: ObjectMapper,\n+  okHttp3ClientConfiguration: OkHttp3ClientConfiguration\n+) : HttpClientProvider {\n+\n+  private val internalServicesClient = okHttp3ClientConfiguration.create().build()\n+  private val okClients: MutableMap<HttpClientConfig, OkHttpClient> = mutableMapOf()\n+  private val clients: MutableMap<String, Ok3HttpClient> = mutableMapOf()\n+\n+  override fun configure(name: String, baseUrl: String, config: HttpClientConfig) {\n+    clients.computeIfAbsent(\"$pluginId.$name\") {\n+      // Try to reduce the number of OkHttpClient instances that are floating around. We'll only create a new client\n+      // if the config is different from any other OkHttpClient.\n+      val okClient = okClients.computeIfAbsent(config) {\n+        OkHttp3ClientConfiguration(\n+          OkHttpClientConfigurationProperties().apply {\n+            config.connectionPool.keepAlive?.let {\n+              connectionPool.keepAliveDurationMs = it.toMillis().toInt()\n+            }\n+            config.connectionPool.maxIdleConnections?.let {\n+              connectionPool.maxIdleConnections = it\n+            }\n+\n+            config.connection.connectTimeout?.let {\n+              connectTimeoutMs = it.toMillis()\n+            }\n+            config.connection.readTimeout?.let {\n+              readTimeoutMs = it.toMillis()\n+            }\n+            retryOnConnectionFailure = config.connection.isRetryOnConnectionFailure\n+\n+            if (config.security.keyStorePath != null && config.security.trustStorePath != null) {\n+              keyStore = config.security.keyStorePath.toFile()\n+              keyStoreType = config.security.keyStoreType\n+              keyStorePassword = config.security.keyStorePassword\n+\n+              trustStore = config.security.trustStorePath.toFile()\n+              trustStoreType = config.security.trustStoreType\n+              trustStorePassword = config.security.trustStorePassword\n+\n+              tlsVersions = config.security.tlsVersions\n+              cipherSuites = config.security.cipherSuites\n+            }\n+          },\n+          applicationContext.getBean(OkHttp3MetricsInterceptor::class.java)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a36812a317c86d57be243fb5f9bc5005cab3862b"}, "originalPosition": 75}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a36812a317c86d57be243fb5f9bc5005cab3862b", "author": {"user": {"login": "robzienert", "name": "Rob Zienert"}}, "url": "https://github.com/spinnaker/kork/commit/a36812a317c86d57be243fb5f9bc5005cab3862b", "committedDate": "2020-02-07T00:28:01Z", "message": "feat(plugins): HTTP client plugin API"}, "afterCommit": {"oid": "9fdd5c4ab5e5c0a23f707f9c8b5ea4088b2e0e62", "author": {"user": {"login": "robzienert", "name": "Rob Zienert"}}, "url": "https://github.com/spinnaker/kork/commit/9fdd5c4ab5e5c0a23f707f9c8b5ea4088b2e0e62", "committedDate": "2020-02-23T18:48:46Z", "message": "feat(plugins): HTTP client plugin API"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9fdd5c4ab5e5c0a23f707f9c8b5ea4088b2e0e62", "author": {"user": {"login": "robzienert", "name": "Rob Zienert"}}, "url": "https://github.com/spinnaker/kork/commit/9fdd5c4ab5e5c0a23f707f9c8b5ea4088b2e0e62", "committedDate": "2020-02-23T18:48:46Z", "message": "feat(plugins): HTTP client plugin API"}, "afterCommit": {"oid": "8338924b3423bb0531fc3df0dd79db3b955458dd", "author": {"user": {"login": "robzienert", "name": "Rob Zienert"}}, "url": "https://github.com/spinnaker/kork/commit/8338924b3423bb0531fc3df0dd79db3b955458dd", "committedDate": "2020-02-24T21:13:34Z", "message": "feat(plugins): HTTP client plugin API"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8338924b3423bb0531fc3df0dd79db3b955458dd", "author": {"user": {"login": "robzienert", "name": "Rob Zienert"}}, "url": "https://github.com/spinnaker/kork/commit/8338924b3423bb0531fc3df0dd79db3b955458dd", "committedDate": "2020-02-24T21:13:34Z", "message": "feat(plugins): HTTP client plugin API"}, "afterCommit": {"oid": "195b16b1e1401abddcf1596f7f231b4c6f4088c2", "author": {"user": {"login": "robzienert", "name": "Rob Zienert"}}, "url": "https://github.com/spinnaker/kork/commit/195b16b1e1401abddcf1596f7f231b4c6f4088c2", "committedDate": "2020-02-25T19:59:00Z", "message": "feat(plugins): HTTP client plugin API"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "195b16b1e1401abddcf1596f7f231b4c6f4088c2", "author": {"user": {"login": "robzienert", "name": "Rob Zienert"}}, "url": "https://github.com/spinnaker/kork/commit/195b16b1e1401abddcf1596f7f231b4c6f4088c2", "committedDate": "2020-02-25T19:59:00Z", "message": "feat(plugins): HTTP client plugin API"}, "afterCommit": {"oid": "db92a070af2121d9425b7cd9ae4bfea99ac7ca5c", "author": {"user": {"login": "robzienert", "name": "Rob Zienert"}}, "url": "https://github.com/spinnaker/kork/commit/db92a070af2121d9425b7cd9ae4bfea99ac7ca5c", "committedDate": "2020-02-25T20:00:27Z", "message": "feat(plugins): HTTP client plugin API"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "db92a070af2121d9425b7cd9ae4bfea99ac7ca5c", "author": {"user": {"login": "robzienert", "name": "Rob Zienert"}}, "url": "https://github.com/spinnaker/kork/commit/db92a070af2121d9425b7cd9ae4bfea99ac7ca5c", "committedDate": "2020-02-25T20:00:27Z", "message": "feat(plugins): HTTP client plugin API"}, "afterCommit": {"oid": "778d6c4b1ccce510340e7acd708fc24729d38e43", "author": {"user": {"login": "robzienert", "name": "Rob Zienert"}}, "url": "https://github.com/spinnaker/kork/commit/778d6c4b1ccce510340e7acd708fc24729d38e43", "committedDate": "2020-02-25T20:07:34Z", "message": "feat(plugins): HTTP client plugin API"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "778d6c4b1ccce510340e7acd708fc24729d38e43", "author": {"user": {"login": "robzienert", "name": "Rob Zienert"}}, "url": "https://github.com/spinnaker/kork/commit/778d6c4b1ccce510340e7acd708fc24729d38e43", "committedDate": "2020-02-25T20:07:34Z", "message": "feat(plugins): HTTP client plugin API"}, "afterCommit": {"oid": "00384b739b37aff5cc5aa87eec7b97ece874e5d4", "author": {"user": {"login": "robzienert", "name": "Rob Zienert"}}, "url": "https://github.com/spinnaker/kork/commit/00384b739b37aff5cc5aa87eec7b97ece874e5d4", "committedDate": "2020-02-25T20:10:30Z", "message": "feat(plugins): HTTP client plugin API"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "00384b739b37aff5cc5aa87eec7b97ece874e5d4", "author": {"user": {"login": "robzienert", "name": "Rob Zienert"}}, "url": "https://github.com/spinnaker/kork/commit/00384b739b37aff5cc5aa87eec7b97ece874e5d4", "committedDate": "2020-02-25T20:10:30Z", "message": "feat(plugins): HTTP client plugin API"}, "afterCommit": {"oid": "ed23c2da019ea27635570d4234aa8092781430a3", "author": {"user": {"login": "robzienert", "name": "Rob Zienert"}}, "url": "https://github.com/spinnaker/kork/commit/ed23c2da019ea27635570d4234aa8092781430a3", "committedDate": "2020-02-25T20:13:13Z", "message": "feat(plugins): HTTP client plugin API"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NjIxMzEy", "url": "https://github.com/spinnaker/kork/pull/507#pullrequestreview-364621312", "createdAt": "2020-02-26T04:49:15Z", "commit": {"oid": "ed23c2da019ea27635570d4234aa8092781430a3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQwNDo0OToxNVrOFueLPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQwNDo0OToxNVrOFueLPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDI3MzIxNA==", "bodyText": "Oh my goodness c-3PO!", "url": "https://github.com/spinnaker/kork/pull/507#discussion_r384273214", "createdAt": "2020-02-26T04:49:15Z", "author": {"login": "jonsie"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/sdk/httpclient/HttpClientSdkFactory.kt", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.sdk.httpclient\n+\n+import com.fasterxml.jackson.databind.ObjectMapper\n+import com.netflix.spinnaker.config.OkHttp3ClientConfiguration\n+import com.netflix.spinnaker.kork.plugins.sdk.IdResolver\n+import com.netflix.spinnaker.kork.plugins.sdk.SdkFactory\n+import com.netflix.spinnaker.kork.plugins.sdk.httpclient.internal.CompositeOkHttpClientFactory\n+import org.pf4j.PluginWrapper\n+import org.springframework.core.env.Environment\n+\n+/**\n+ * Creates [Ohc3HttpClientRegistry]s for a given extension.\n+ */\n+class HttpClientSdkFactory(\n+  private val okHttpClientFactory: CompositeOkHttpClientFactory,\n+  private val environment: Environment,\n+  private val objectMapper: ObjectMapper,\n+  private val okHttp3ClientConfiguration: OkHttp3ClientConfiguration\n+) : SdkFactory {\n+  override fun create(extensionClass: Class<*>, pluginWrapper: PluginWrapper?): Any {\n+    return Ohc3HttpClientRegistry(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed23c2da019ea27635570d4234aa8092781430a3"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NjIxNTk5", "url": "https://github.com/spinnaker/kork/pull/507#pullrequestreview-364621599", "createdAt": "2020-02-26T04:50:28Z", "commit": {"oid": "ed23c2da019ea27635570d4234aa8092781430a3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQwNDo1MDoyOVrOFueMMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQwNDo1MDoyOVrOFueMMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDI3MzQ1Nw==", "bodyText": "Going deep with the rename, I like it.", "url": "https://github.com/spinnaker/kork/pull/507#discussion_r384273457", "createdAt": "2020-02-26T04:50:29Z", "author": {"login": "jonsie"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/sdk/httpclient/Ohc3Response.kt", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.sdk.httpclient\n+\n+import com.fasterxml.jackson.databind.ObjectMapper\n+import com.netflix.spinnaker.kork.plugins.api.httpclient.Response\n+import okhttp3.ResponseBody\n+import java.io.InputStream\n+import java.lang.Exception\n+import java.util.Optional\n+\n+class Ohc3Response(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed23c2da019ea27635570d4234aa8092781430a3"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MjQ1MjIy", "url": "https://github.com/spinnaker/kork/pull/507#pullrequestreview-365245222", "createdAt": "2020-02-26T21:12:02Z", "commit": {"oid": "ed23c2da019ea27635570d4234aa8092781430a3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMToxMjowMlrOFu8YCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMToxMjowMlrOFu8YCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc2ODAwOA==", "bodyText": "I wonder if we should use ObjectProvider instead of Provider?  I have run into situations wherein Provider was not on the classpath (haven't actually tracked down exactly where this gets pulled in, but last I checked it was not part of kork-plugins).  ObjectProvider is the modern Spring way, as far as I can tell, and I've used it before for this purpose - https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/beans/factory/ObjectProvider.html", "url": "https://github.com/spinnaker/kork/pull/507#discussion_r384768008", "createdAt": "2020-02-26T21:12:02Z", "author": {"login": "jonsie"}, "path": "kork-web/src/main/groovy/com/netflix/spinnaker/config/OkHttpClientComponents.groovy", "diffHunk": "@@ -36,17 +38,17 @@ class OkHttpClientComponents {\n \n   @Bean\n   OkHttpMetricsInterceptor okHttpMetricsInterceptor(\n-    Registry registry,\n-    @Value('${ok-http-client.interceptor.skip-header-check:false}') boolean skipHeaderCheck) {\n+    Provider<Registry> registry,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed23c2da019ea27635570d4234aa8092781430a3"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MjUyNjA0", "url": "https://github.com/spinnaker/kork/pull/507#pullrequestreview-365252604", "createdAt": "2020-02-26T21:23:45Z", "commit": {"oid": "ed23c2da019ea27635570d4234aa8092781430a3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d610685007ee72c6fa72646d71516510f20e0864", "author": {"user": {"login": "robzienert", "name": "Rob Zienert"}}, "url": "https://github.com/spinnaker/kork/commit/d610685007ee72c6fa72646d71516510f20e0864", "committedDate": "2020-02-27T18:07:06Z", "message": "feat(plugins): HTTP client plugin API"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed23c2da019ea27635570d4234aa8092781430a3", "author": {"user": {"login": "robzienert", "name": "Rob Zienert"}}, "url": "https://github.com/spinnaker/kork/commit/ed23c2da019ea27635570d4234aa8092781430a3", "committedDate": "2020-02-25T20:13:13Z", "message": "feat(plugins): HTTP client plugin API"}, "afterCommit": {"oid": "d610685007ee72c6fa72646d71516510f20e0864", "author": {"user": {"login": "robzienert", "name": "Rob Zienert"}}, "url": "https://github.com/spinnaker/kork/commit/d610685007ee72c6fa72646d71516510f20e0864", "committedDate": "2020-02-27T18:07:06Z", "message": "feat(plugins): HTTP client plugin API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed2ff253fef6b0eb3b4626edc711e53b06177111", "author": {"user": {"login": "mergify[bot]", "name": null}}, "url": "https://github.com/spinnaker/kork/commit/ed2ff253fef6b0eb3b4626edc711e53b06177111", "committedDate": "2020-02-27T18:24:39Z", "message": "Merge branch 'master' into http-builder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d34b033c3559ec203ec8b3f279763defcf4512c2", "author": {"user": {"login": "robzienert", "name": "Rob Zienert"}}, "url": "https://github.com/spinnaker/kork/commit/d34b033c3559ec203ec8b3f279763defcf4512c2", "committedDate": "2020-03-02T20:56:57Z", "message": "Merge branch 'master' into http-builder"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1547, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}