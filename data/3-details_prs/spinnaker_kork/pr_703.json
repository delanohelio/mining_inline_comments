{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzNjAzNDA1", "number": 703, "title": "feat(plugins): Support range constraint", "bodyText": "This PR is about to support range constraint on a service that a plugin requires on.\nWith this change, they would be two valid formats for the required field:\norca>=1.0.0  <-- currently supported\norca>=1.0.0 & <2.0.0  <-- new constraint supported\nWhen a range constraint is found It creates a list with two VersionRequirements that will be validated with SpinnakerServiceVersionManager as it works currently.", "createdAt": "2020-07-02T15:46:52Z", "url": "https://github.com/spinnaker/kork/pull/703", "merged": true, "mergeCommit": {"oid": "f2029eb0be36a4125d78d7e88530859e07059054"}, "closed": true, "closedAt": "2020-07-10T19:54:15Z", "author": {"login": "edgarulg"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxASjPAH2gAyNDQzNjAzNDA1OjQ0Mjk4Y2ViYWUyMmRhMmE4ZjEwMTE1OTc4NDBhN2MzZDgxMGM1Zjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczpKp_AFqTQ0NjY2NTA2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "44298cebae22da2a8f1011597840a7c3d810c5f7", "author": {"user": {"login": "edgarulg", "name": "Edgar Garcia"}}, "url": "https://github.com/spinnaker/kork/commit/44298cebae22da2a8f1011597840a7c3d810c5f7", "committedDate": "2020-07-02T15:08:38Z", "message": "feat(plugins): support constraint by range on service required for plugin."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3971ffa1008213301ff81e23648c0387163e9a6", "author": {"user": {"login": "edgarulg", "name": "Edgar Garcia"}}, "url": "https://github.com/spinnaker/kork/commit/a3971ffa1008213301ff81e23648c0387163e9a6", "committedDate": "2020-07-02T15:20:01Z", "message": "feat(plugins): support constraint by range on service required for plugin."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "165a556470cc85af15cc866157c8d349b1997fcb", "author": {"user": {"login": "edgarulg", "name": "Edgar Garcia"}}, "url": "https://github.com/spinnaker/kork/commit/165a556470cc85af15cc866157c8d349b1997fcb", "committedDate": "2020-07-02T15:26:05Z", "message": "Merge branch 'support-range-constraint' of github.com:armory-io/kork into support-range-constraint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0Mjk0MDU4", "url": "https://github.com/spinnaker/kork/pull/703#pullrequestreview-444294058", "createdAt": "2020-07-07T22:29:33Z", "commit": {"oid": "165a556470cc85af15cc866157c8d349b1997fcb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMjoyOTozM1rOGuR14A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMjozMDowM1rOGuR2pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE4MDAwMA==", "bodyText": "Oh jeez. This is what I get for using regex to begin with. \ud83e\udd23\nWe should switch this class to wrap jsemver instead of doubling down on our regex pattern.", "url": "https://github.com/spinnaker/kork/pull/703#discussion_r451180000", "createdAt": "2020-07-07T22:29:33Z", "author": {"login": "robzienert"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/VersionRequirementsParser.kt", "diffHunk": "@@ -27,41 +27,54 @@ import java.util.regex.Pattern\n  * - `operator` is a version constraint operator (`>`, `<`, `>=`, `<=`)\n  * - `version` is the service version that is being constrained\n  *\n- * TODO(jonsie): Add range constraint support (>= 1.0.0 & < 2.0.0)\n  */\n object VersionRequirementsParser {\n \n   private val SUPPORTS_PATTERN = Pattern.compile(\n-    \"^(?<service>[\\\\w\\\\-]+)(?<operator>[><=]{1,2})(?<version>[0-9]+\\\\.[0-9]+\\\\.[0-9]+)$\")\n+    \"^(?<service>[\\\\w\\\\-]+)(?<operator>[><=]{1,2})(?<version>[0-9]+\\\\.[0-9]+\\\\.[0-9]+)( & (?<rOperator>[><=]{1,2})(?<rVersion>[0-9]+\\\\.[0-9]+\\\\.[0-9]+))?$\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165a556470cc85af15cc866157c8d349b1997fcb"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE4MDE5OA==", "bodyText": "Why?", "url": "https://github.com/spinnaker/kork/pull/703#discussion_r451180198", "createdAt": "2020-07-07T22:30:03Z", "author": {"login": "robzienert"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/VersionRequirementsParser.kt", "diffHunk": "@@ -27,41 +27,54 @@ import java.util.regex.Pattern\n  * - `operator` is a version constraint operator (`>`, `<`, `>=`, `<=`)\n  * - `version` is the service version that is being constrained\n  *\n- * TODO(jonsie): Add range constraint support (>= 1.0.0 & < 2.0.0)\n  */\n object VersionRequirementsParser {\n \n   private val SUPPORTS_PATTERN = Pattern.compile(\n-    \"^(?<service>[\\\\w\\\\-]+)(?<operator>[><=]{1,2})(?<version>[0-9]+\\\\.[0-9]+\\\\.[0-9]+)$\")\n+    \"^(?<service>[\\\\w\\\\-]+)(?<operator>[><=]{1,2})(?<version>[0-9]+\\\\.[0-9]+\\\\.[0-9]+)( & (?<rOperator>[><=]{1,2})(?<rVersion>[0-9]+\\\\.[0-9]+\\\\.[0-9]+))?$\")\n \n   private const val SUPPORTS_PATTERN_SERVICE_GROUP = \"service\"\n   private const val SUPPORTS_PATTERN_OPERATOR_GROUP = \"operator\"\n   private const val SUPPORTS_PATTERN_VERSION_GROUP = \"version\"\n+  private const val SUPPORTS_PATTERN_RANGE_OPERATOR_GROUP = \"rOperator\"\n+  private const val SUPPORTS_PATTERN_RANGE_VERSION_GROUP = \"rVersion\"\n \n   /**\n    * Parse a single version.\n    */\n-  fun parse(version: String): VersionRequirements {\n-    return SUPPORTS_PATTERN.matcher(version)\n+  fun parse(version: String): List<VersionRequirements> {\n+    SUPPORTS_PATTERN.matcher(version)\n       .also {\n         if (!it.matches()) {\n           throw InvalidPluginVersionRequirementException(version)\n         }\n       }\n       .let {\n-        VersionRequirements(\n+        val versions = mutableListOf(VersionRequirements(\n           service = it.group(SUPPORTS_PATTERN_SERVICE_GROUP),\n           operator = VersionRequirementOperator.from(it.group(SUPPORTS_PATTERN_OPERATOR_GROUP)),\n           version = it.group(SUPPORTS_PATTERN_VERSION_GROUP)\n-        )\n+        ))\n+        if (!it.group(SUPPORTS_PATTERN_RANGE_OPERATOR_GROUP).isNullOrBlank()) {\n+          versions.add(VersionRequirements(\n+            service = it.group(SUPPORTS_PATTERN_SERVICE_GROUP),\n+            operator = VersionRequirementOperator.from(it.group(SUPPORTS_PATTERN_RANGE_OPERATOR_GROUP)),\n+            version = it.group(SUPPORTS_PATTERN_RANGE_VERSION_GROUP)))\n+        }\n+        return versions\n       }\n   }\n \n   /**\n    * Parse a list of comma-delimited versions.\n    */\n-  fun parseAll(version: String): List<VersionRequirements> =\n-    version.split(',').map { parse(it.trim()) }\n+  fun parseAll(version: String): List<VersionRequirements> {\n+    val result = mutableListOf<VersionRequirements>()\n+    version.split(',').forEach {\n+      result.addAll(parse(it.trim()))\n+    }\n+    return result", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165a556470cc85af15cc866157c8d349b1997fcb"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8557ba99e7a3ea296d342becc64d493cf1767be7", "author": {"user": {"login": "edgarulg", "name": "Edgar Garcia"}}, "url": "https://github.com/spinnaker/kork/commit/8557ba99e7a3ea296d342becc64d493cf1767be7", "committedDate": "2020-07-08T23:27:54Z", "message": "feat(plugins): remove regular expression and uses Version object to validate version constraint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38545d75b4576123a9e887c581947a14d5012227", "author": {"user": {"login": "edgarulg", "name": "Edgar Garcia"}}, "url": "https://github.com/spinnaker/kork/commit/38545d75b4576123a9e887c581947a14d5012227", "committedDate": "2020-07-08T23:47:46Z", "message": "Merge branch 'master' into support-range-constraint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDY0NzQ4", "url": "https://github.com/spinnaker/kork/pull/703#pullrequestreview-446064748", "createdAt": "2020-07-10T01:18:47Z", "commit": {"oid": "38545d75b4576123a9e887c581947a14d5012227"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwMToxODo0N1rOGvm00w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwMToxODo0N1rOGvm00w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU3MjM3MQ==", "bodyText": "nit: Let's break this up into multiple lines.", "url": "https://github.com/spinnaker/kork/pull/703#discussion_r452572371", "createdAt": "2020-07-10T01:18:47Z", "author": {"login": "robzienert"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/VersionRequirementsParser.kt", "diffHunk": "@@ -47,12 +47,12 @@ object VersionRequirementsParser {\n         if (!it.matches()) {\n           throw InvalidPluginVersionRequirementException(version)\n         }\n+        try { CONSTRAINT_VALIDATOR.satisfies(it.group(SUPPORTS_PATTERN_CONSTRAINT_GROUP)) } catch (e: ParseException) { throw InvalidPluginVersionRequirementException(version) }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38545d75b4576123a9e887c581947a14d5012227"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDY0ODUy", "url": "https://github.com/spinnaker/kork/pull/703#pullrequestreview-446064852", "createdAt": "2020-07-10T01:19:10Z", "commit": {"oid": "38545d75b4576123a9e887c581947a14d5012227"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eede1824e2c96e3afc03b9560699f0fcd6ab90ac", "author": {"user": {"login": "edgarulg", "name": "Edgar Garcia"}}, "url": "https://github.com/spinnaker/kork/commit/eede1824e2c96e3afc03b9560699f0fcd6ab90ac", "committedDate": "2020-07-10T19:33:32Z", "message": "feat(plugins): breaking up in multiple lines"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5424d7a325cf4f7d338bbcb9adf5fe05f370a83", "author": {"user": {"login": "edgarulg", "name": "Edgar Garcia"}}, "url": "https://github.com/spinnaker/kork/commit/a5424d7a325cf4f7d338bbcb9adf5fe05f370a83", "committedDate": "2020-07-10T19:34:32Z", "message": "Merge branch 'support-range-constraint' of github.com:armory-io/kork into support-range-constraint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45325a79489a8c2fb1ad15af612b7365f6130c10", "author": {"user": {"login": "edgarulg", "name": "Edgar Garcia"}}, "url": "https://github.com/spinnaker/kork/commit/45325a79489a8c2fb1ad15af612b7365f6130c10", "committedDate": "2020-07-10T19:45:55Z", "message": "Merge branch 'master' into support-range-constraint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NjY1MDY0", "url": "https://github.com/spinnaker/kork/pull/703#pullrequestreview-446665064", "createdAt": "2020-07-10T19:53:58Z", "commit": {"oid": "45325a79489a8c2fb1ad15af612b7365f6130c10"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1435, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}