{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5OTY5NTY3", "number": 775, "title": "feat(credentials): Add credentials abstraction", "bodyText": "This is the first part of the work related to https://github.com/spinnaker/governance/blob/master/rfc/account-management.md.\nIt adds the concept of Credentials, CredentialsRepository that stores credentials of a given type, as well as bricks to populate and manage these credentials:\n\nCredentialsDefinition is the data with which we can build Credentials. It's optional but most implementation have them deserialized from yaml/json/something else.\nCredentialsDefinitionSource represents a source of definitions. By default, it's a getter on a Spring configuration object. It is pluggable and could make external calls - or just read a local file.\nCredentialsParser take a definition and transforms it into Credentials. It typically wires Spinnaker internals to do so (e.g. using Spring managed beans)\nAbstractCredentialsLoader keeps a source in sync with a repository. BaseCredentialsLoader does it by getting the full credentials list and comparing what is in the repository. Another possible implementation could be event based (receiving changes from an external system).\n\nFinally, the poller package provides a way to frequently poll a credentials loader using Spring scheduled tasks.", "createdAt": "2020-09-04T18:42:07Z", "url": "https://github.com/spinnaker/kork/pull/775", "merged": true, "mergeCommit": {"oid": "45c6e39c6b93beb49db8953f2194e25d536a157e"}, "closed": true, "closedAt": "2020-09-14T23:42:50Z", "author": {"login": "ncknt"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEvsz8gH2gAyNDc5OTY5NTY3OjMxYzBlYjQ3OTVlYzQ1ZjBiOTEwYjdjOTE5NDY3ZmViMGYzYmU3Yjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdI6_fGAH2gAyNDc5OTY5NTY3OjQyZDE4NDIzZTZkYjY0Yzg4OWFmYzU5MWExMDk4ODNlYWViMDEwYTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "31c0eb4795ec45f0b910b7c919467feb0f3be7b8", "author": {"user": {"login": "ncknt", "name": "Nicolas Cohen"}}, "url": "https://github.com/spinnaker/kork/commit/31c0eb4795ec45f0b910b7c919467feb0f3be7b8", "committedDate": "2020-09-01T23:07:25Z", "message": "feat(credentials): Add credential abstraction\nCredentials are held in a CredentialsRepository - one per type of credentials. They can be built from CredentialsDefinitions obtained from a CredentialsSource and parsed in a CredentialsParser."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "836d861e4e97ff2f7c7020a4ff59b7b32f493ee9", "author": {"user": {"login": "ncknt", "name": "Nicolas Cohen"}}, "url": "https://github.com/spinnaker/kork/commit/836d861e4e97ff2f7c7020a4ff59b7b32f493ee9", "committedDate": "2020-09-04T02:41:59Z", "message": "feat(credentials): Rename loader to poller\nAdd test, support optionally parallel lifecycle handlers to speed startup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed3bf057c618a952cae0f4e6e013e176bfb530b6", "author": {"user": {"login": "ncknt", "name": "Nicolas Cohen"}}, "url": "https://github.com/spinnaker/kork/commit/ed3bf057c618a952cae0f4e6e013e176bfb530b6", "committedDate": "2020-09-04T02:44:19Z", "message": "feat(credentials): Add credential abstraction\nCredentials are held in a CredentialsRepository - one per type of credentials. They can be built from CredentialsDefinitions obtained from a CredentialsSource and parsed in a CredentialsParser."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c67f0e19fab361101b4d2df571b02a00c7912ca9", "author": {"user": {"login": "ncknt", "name": "Nicolas Cohen"}}, "url": "https://github.com/spinnaker/kork/commit/c67f0e19fab361101b4d2df571b02a00c7912ca9", "committedDate": "2020-09-04T17:59:59Z", "message": "feat(credentials): more tests and cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ec1df36f5efda51d91e194043ab23235836b1ab", "author": {"user": {"login": "ncknt", "name": "Nicolas Cohen"}}, "url": "https://github.com/spinnaker/kork/commit/6ec1df36f5efda51d91e194043ab23235836b1ab", "committedDate": "2020-09-04T18:45:20Z", "message": "Merge branch 'master' into feat/kork-credentials"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd8765a48aba79dbcc5834890ce19f75be68991f", "author": {"user": {"login": "ncknt", "name": "Nicolas Cohen"}}, "url": "https://github.com/spinnaker/kork/commit/bd8765a48aba79dbcc5834890ce19f75be68991f", "committedDate": "2020-09-04T20:42:28Z", "message": "Merge branch 'master' into feat/kork-credentials"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07bd0e32ca32915324961a6cd0c8e941f6252948", "author": {"user": {"login": "ncknt", "name": "Nicolas Cohen"}}, "url": "https://github.com/spinnaker/kork/commit/07bd0e32ca32915324961a6cd0c8e941f6252948", "committedDate": "2020-09-08T16:28:51Z", "message": "Merge branch 'master' into feat/kork-credentials"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0Mzk4ODQ4", "url": "https://github.com/spinnaker/kork/pull/775#pullrequestreview-484398848", "createdAt": "2020-09-08T18:37:55Z", "commit": {"oid": "07bd0e32ca32915324961a6cd0c8e941f6252948"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxODozNzo1NVrOHOpa7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxODo1MzozNFrOHOp7zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMDc0OA==", "bodyText": "Could be Strings.isEmptyOrNull()?", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485120748", "createdAt": "2020-09-08T18:37:55Z", "author": {"login": "robzienert"}, "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/CompositeCredentialsRepository.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials;\n+\n+import java.util.*;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Provides access to credentials (or extension of Credentials) across credentials types.\n+ *\n+ * @param <T>\n+ */\n+public class CompositeCredentialsRepository<T extends Credentials> {\n+  private Map<String, CredentialsRepository<? extends T>> allRepositories;\n+\n+  public CompositeCredentialsRepository(List<CredentialsRepository<? extends T>> repositories) {\n+    allRepositories = new HashMap<>();\n+    repositories.forEach(this::registerRepository);\n+  }\n+\n+  public void registerRepository(CredentialsRepository<? extends T> repository) {\n+    allRepositories.put(repository.getType(), repository);\n+  }\n+\n+  public T getCredentials(String accountName, String type) {\n+    if (accountName == null || accountName.equals(\"\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07bd0e32ca32915324961a6cd0c8e941f6252948"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMTQwNw==", "bodyText": "Please make use of SpinnakerException and its child exception classes, making subclasses where it makes sense.", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485121407", "createdAt": "2020-09-08T18:39:14Z", "author": {"login": "robzienert"}, "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/CompositeCredentialsRepository.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials;\n+\n+import java.util.*;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Provides access to credentials (or extension of Credentials) across credentials types.\n+ *\n+ * @param <T>\n+ */\n+public class CompositeCredentialsRepository<T extends Credentials> {\n+  private Map<String, CredentialsRepository<? extends T>> allRepositories;\n+\n+  public CompositeCredentialsRepository(List<CredentialsRepository<? extends T>> repositories) {\n+    allRepositories = new HashMap<>();\n+    repositories.forEach(this::registerRepository);\n+  }\n+\n+  public void registerRepository(CredentialsRepository<? extends T> repository) {\n+    allRepositories.put(repository.getType(), repository);\n+  }\n+\n+  public T getCredentials(String accountName, String type) {\n+    if (accountName == null || accountName.equals(\"\")) {\n+      throw new IllegalArgumentException(\"An account name must be supplied\");\n+    }\n+\n+    CredentialsRepository<? extends T> repository = allRepositories.get(type);\n+    if (repository == null) {\n+      throw new IllegalArgumentException(\"No credentials of type '\" + type + \"' found\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07bd0e32ca32915324961a6cd0c8e941f6252948"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMTc5Mw==", "bodyText": "Need docs. What's the difference between these two, what are they used for?", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485121793", "createdAt": "2020-09-08T18:39:57Z", "author": {"login": "robzienert"}, "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/Credentials.java", "diffHunk": "@@ -0,0 +1,25 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials;\n+\n+/** Credentials to an external system. Each credentials has a unique name for its type. */\n+public interface Credentials {\n+\n+  String getName();\n+\n+  String getType();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07bd0e32ca32915324961a6cd0c8e941f6252948"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMTk0OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * Credentials have been added. This is called before credentials are available in @{@link\n          \n          \n            \n               * Credentials have been added. This is called before credentials are available in {@link", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485121949", "createdAt": "2020-09-08T18:40:19Z", "author": {"login": "robzienert"}, "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/CredentialsLifecycleHandler.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials;\n+\n+/**\n+ * After {@link Credentials} have been parsed, they can be activated, refreshed, or retired - e.g.\n+ * adding agents. This happens before credentials are added or updated in the {@link\n+ * CredentialsRepository} and after credentials are removed from the {@link CredentialsRepository}.\n+ *\n+ * @param <T>\n+ */\n+public interface CredentialsLifecycleHandler<T extends Credentials> {\n+\n+  /**\n+   * Credentials have been added. This is called before credentials are available in @{@link", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07bd0e32ca32915324961a6cd0c8e941f6252948"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMjA5MA==", "bodyText": "This change should be applied to the other areas this happens, too.", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485122090", "createdAt": "2020-09-08T18:40:33Z", "author": {"login": "robzienert"}, "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/CredentialsLifecycleHandler.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials;\n+\n+/**\n+ * After {@link Credentials} have been parsed, they can be activated, refreshed, or retired - e.g.\n+ * adding agents. This happens before credentials are added or updated in the {@link\n+ * CredentialsRepository} and after credentials are removed from the {@link CredentialsRepository}.\n+ *\n+ * @param <T>\n+ */\n+public interface CredentialsLifecycleHandler<T extends Credentials> {\n+\n+  /**\n+   * Credentials have been added. This is called before credentials are available in @{@link", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMTk0OQ=="}, "originalCommit": {"oid": "07bd0e32ca32915324961a6cd0c8e941f6252948"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMjQxNQ==", "bodyText": "Docs on interfaces and their methods, as well as any classes that do not implement an interface and cannot inherit the docs from a parent.", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485122415", "createdAt": "2020-09-08T18:41:11Z", "author": {"login": "robzienert"}, "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/CredentialsRepository.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials;\n+\n+import java.util.Set;\n+\n+/**\n+ * Repository of credentials of a given type\n+ *\n+ * @param <T>\n+ */\n+public interface CredentialsRepository<T extends Credentials> {\n+  T getOne(String name);\n+\n+  boolean has(String name);\n+\n+  Set<T> getAll();\n+\n+  T save(T credentials);\n+\n+  void delete(String name);\n+\n+  String getType();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07bd0e32ca32915324961a6cd0c8e941f6252948"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyMzEzMA==", "bodyText": "Are we at risk of concurrent modification issues by having this just be a HashMap?", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485123130", "createdAt": "2020-09-08T18:42:32Z", "author": {"login": "robzienert"}, "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/MapBackedCredentialsRepository.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials;\n+\n+import java.util.*;\n+import javax.annotation.Nonnull;\n+import lombok.Getter;\n+\n+public class MapBackedCredentialsRepository<T extends Credentials>\n+    implements CredentialsRepository<T> {\n+  protected Map<String, T> credentials = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07bd0e32ca32915324961a6cd0c8e941f6252948"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNDA4Mw==", "bodyText": "Docs would be useful here. Since the return value is void, I'm having to assume each implementor would be responsible for adding the final loaded credentials into the CredentialsRepository themselves?", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485124083", "createdAt": "2020-09-08T18:44:19Z", "author": {"login": "robzienert"}, "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/definition/AbstractCredentialsLoader.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials.definition;\n+\n+import com.netflix.spinnaker.credentials.Credentials;\n+import com.netflix.spinnaker.credentials.CredentialsRepository;\n+import com.netflix.spinnaker.kork.annotations.NonnullByDefault;\n+import javax.annotation.PostConstruct;\n+import lombok.Getter;\n+\n+@NonnullByDefault\n+public abstract class AbstractCredentialsLoader<T extends Credentials> {\n+  @Getter protected final CredentialsRepository<T> credentialsRepository;\n+\n+  public AbstractCredentialsLoader(CredentialsRepository<T> credentialsRepository) {\n+    this.credentialsRepository = credentialsRepository;\n+  }\n+\n+  @PostConstruct\n+  public abstract void load();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07bd0e32ca32915324961a6cd0c8e941f6252948"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNDUyMA==", "bodyText": "Also curious about concurrency here.", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485124520", "createdAt": "2020-09-08T18:45:05Z", "author": {"login": "robzienert"}, "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/definition/BasicCredentialsLoader.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials.definition;\n+\n+import com.netflix.spinnaker.credentials.Credentials;\n+import com.netflix.spinnaker.credentials.CredentialsRepository;\n+import com.netflix.spinnaker.kork.annotations.NonnullByDefault;\n+import java.util.*;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+import lombok.Getter;\n+import lombok.Setter;\n+\n+/**\n+ * CredentialsLoader that expects the full list of credentials on each load, and updates the\n+ * credential repository on each run. It can be run once or multiple times.\n+ *\n+ * @param <T>\n+ * @param <U>\n+ */\n+@NonnullByDefault\n+public class BasicCredentialsLoader<T extends CredentialsDefinition, U extends Credentials>\n+    extends AbstractCredentialsLoader<U> {\n+  protected final CredentialsParser<T, U> parser;\n+  protected final CredentialsDefinitionSource<T> definitionSource;\n+  /**\n+   * When parallel is true, the loader may apply changes in parallel. See {@link\n+   * java.util.concurrent.ForkJoinPool} for limitations. This can be useful when adding or updating\n+   * credentials is expected to take some time, as for instance when making a network call.\n+   */\n+  @Setter @Getter protected boolean parallel;\n+  // Definition is kept so we can quickly check for changes before parsing\n+  protected final Map<String, T> loadedDefinitions = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07bd0e32ca32915324961a6cd0c8e941f6252948"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNzk3OA==", "bodyText": "You're not using Spock (yay!), don't need these deps.", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485127978", "createdAt": "2020-09-08T18:51:18Z", "author": {"login": "robzienert"}, "path": "kork-credentials/kork-credentials.gradle", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+apply plugin: \"java-library\"\n+apply from: \"$rootDir/gradle/lombok.gradle\"\n+\n+dependencies {\n+  implementation(platform(project(\":spinnaker-dependencies\")))\n+  api project(\":kork-core\")\n+  api \"com.fasterxml.jackson.core:jackson-annotations\"\n+\n+  testImplementation \"org.spockframework:spock-core\"\n+  testImplementation \"org.spockframework:spock-spring\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07bd0e32ca32915324961a6cd0c8e941f6252948"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyOTE2Ng==", "bodyText": "Avoid api scope when possible. We're trying to be more mindful of transient dependencies.\nAlso, Jackson isn't even used in this PR, so it can be removed.", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r485129166", "createdAt": "2020-09-08T18:53:34Z", "author": {"login": "robzienert"}, "path": "kork-credentials/kork-credentials.gradle", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+apply plugin: \"java-library\"\n+apply from: \"$rootDir/gradle/lombok.gradle\"\n+\n+dependencies {\n+  implementation(platform(project(\":spinnaker-dependencies\")))\n+  api project(\":kork-core\")\n+  api \"com.fasterxml.jackson.core:jackson-annotations\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07bd0e32ca32915324961a6cd0c8e941f6252948"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "619620f217f9b70efeb21fa36e2770d61007706e", "author": {"user": {"login": "ncknt", "name": "Nicolas Cohen"}}, "url": "https://github.com/spinnaker/kork/commit/619620f217f9b70efeb21fa36e2770d61007706e", "committedDate": "2020-09-08T20:38:03Z", "message": "feat(credentials): more tests and cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03b0dd720b0fd322ccd0f47c68d34204627db7a6", "author": {"user": {"login": "ncknt", "name": "Nicolas Cohen"}}, "url": "https://github.com/spinnaker/kork/commit/03b0dd720b0fd322ccd0f47c68d34204627db7a6", "committedDate": "2020-09-08T20:43:45Z", "message": "feat(credentials): Strings.isEmpty"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "186a4658b6778c69f6034717a3e75d26a829a3dc", "author": {"user": {"login": "ncknt", "name": "Nicolas Cohen"}}, "url": "https://github.com/spinnaker/kork/commit/186a4658b6778c69f6034717a3e75d26a829a3dc", "committedDate": "2020-09-08T20:59:53Z", "message": "Merge branch 'master' into feat/kork-credentials"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5ee2d22a3575f2b034f3d5e8b10f731234d7342", "author": {"user": {"login": "ncknt", "name": "Nicolas Cohen"}}, "url": "https://github.com/spinnaker/kork/commit/f5ee2d22a3575f2b034f3d5e8b10f731234d7342", "committedDate": "2020-09-08T21:10:41Z", "message": "feat(credentials): Add test for type check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "182d4d4015998d7cabeff611dfb9d6ed3fb2bb56", "author": {"user": {"login": "ncknt", "name": "Nicolas Cohen"}}, "url": "https://github.com/spinnaker/kork/commit/182d4d4015998d7cabeff611dfb9d6ed3fb2bb56", "committedDate": "2020-09-09T20:07:53Z", "message": "Merge branch 'master' into feat/kork-credentials"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03f8ce49ab8668a069a050d11c1ef5eb5d7ddc29", "author": {"user": {"login": "ncknt", "name": "Nicolas Cohen"}}, "url": "https://github.com/spinnaker/kork/commit/03f8ce49ab8668a069a050d11c1ef5eb5d7ddc29", "committedDate": "2020-09-09T22:46:08Z", "message": "Merge branch 'master' into feat/kork-credentials"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43b9200f7eee632bc838915619cf87713ec3795e", "author": {"user": {"login": "ncknt", "name": "Nicolas Cohen"}}, "url": "https://github.com/spinnaker/kork/commit/43b9200f7eee632bc838915619cf87713ec3795e", "committedDate": "2020-09-11T18:25:19Z", "message": "Merge branch 'master' into feat/kork-credentials"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MTE1NTA0", "url": "https://github.com/spinnaker/kork/pull/775#pullrequestreview-487115504", "createdAt": "2020-09-11T20:48:46Z", "commit": {"oid": "03f8ce49ab8668a069a050d11c1ef5eb5d7ddc29"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b94eda1cf9036ee420c95fd7518b17c3ea9e8bb", "author": {"user": {"login": "ncknt", "name": "Nicolas Cohen"}}, "url": "https://github.com/spinnaker/kork/commit/4b94eda1cf9036ee420c95fd7518b17c3ea9e8bb", "committedDate": "2020-09-11T21:09:42Z", "message": "feat(credentials): Default non nullable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MDYyODAx", "url": "https://github.com/spinnaker/kork/pull/775#pullrequestreview-488062801", "createdAt": "2020-09-14T19:07:13Z", "commit": {"oid": "4b94eda1cf9036ee420c95fd7518b17c3ea9e8bb"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxOTowNzoxNFrOHRi1Hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxOToxMTozMVrOHRi-pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE1ODQ5NQ==", "bodyText": "Would be useful to move to SpinnakerException family for all exceptions. There's a number of places in the PR that need to change beyond this one point. Also happy to explain this (or doc if I haven't) why it's beneficial to do so.", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r488158495", "createdAt": "2020-09-14T19:07:14Z", "author": {"login": "robzienert"}, "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/CompositeCredentialsRepository.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials;\n+\n+import com.netflix.spinnaker.kork.exceptions.UnknownCredentialsTypeException;\n+import java.util.*;\n+import java.util.stream.Collectors;\n+import javax.annotation.Nullable;\n+import org.springframework.util.StringUtils;\n+\n+/**\n+ * Provides access to credentials (or extension of Credentials) across credentials types.\n+ *\n+ * @param <T>\n+ */\n+public class CompositeCredentialsRepository<T extends Credentials> {\n+  private Map<String, CredentialsRepository<? extends T>> allRepositories;\n+\n+  public CompositeCredentialsRepository(List<CredentialsRepository<? extends T>> repositories) {\n+    allRepositories = new HashMap<>();\n+    repositories.forEach(this::registerRepository);\n+  }\n+\n+  public void registerRepository(CredentialsRepository<? extends T> repository) {\n+    allRepositories.put(repository.getType(), repository);\n+  }\n+\n+  public T getCredentials(String credentialsName, String type) {\n+    if (StringUtils.isEmpty(credentialsName)) {\n+      throw new IllegalArgumentException(\"Credentials name must be supplied\");\n+    }\n+\n+    CredentialsRepository<? extends T> repository = allRepositories.get(type);\n+    if (repository == null) {\n+      throw new UnknownCredentialsTypeException(\"No credentials of type '\" + type + \"' found\");\n+    }\n+\n+    T creds = repository.getOne(credentialsName);\n+    if (creds == null) {\n+      throw new IllegalArgumentException(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b94eda1cf9036ee420c95fd7518b17c3ea9e8bb"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE2MDUxOQ==", "bodyText": "This is helpful, thanks. I think it would be beneficial to capture this reasoning in the abstract class docs.", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r488160519", "createdAt": "2020-09-14T19:10:49Z", "author": {"login": "robzienert"}, "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/definition/AbstractCredentialsLoader.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials.definition;\n+\n+import com.netflix.spinnaker.credentials.Credentials;\n+import com.netflix.spinnaker.credentials.CredentialsRepository;\n+import com.netflix.spinnaker.kork.annotations.NonnullByDefault;\n+import javax.annotation.PostConstruct;\n+import lombok.Getter;\n+\n+@NonnullByDefault\n+public abstract class AbstractCredentialsLoader<T extends Credentials> {\n+  @Getter protected final CredentialsRepository<T> credentialsRepository;\n+\n+  public AbstractCredentialsLoader(CredentialsRepository<T> credentialsRepository) {\n+    this.credentialsRepository = credentialsRepository;\n+  }\n+\n+  @PostConstruct\n+  public abstract void load();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTEyNDA4Mw=="}, "originalCommit": {"oid": "07bd0e32ca32915324961a6cd0c8e941f6252948"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODE2MDkzNQ==", "bodyText": "How is the interval configured? For sake of docs, I see it's done via PollerConfiguration here - even just {@link PollerConfiguration} would be valuable.", "url": "https://github.com/spinnaker/kork/pull/775#discussion_r488160935", "createdAt": "2020-09-14T19:11:31Z", "author": {"login": "robzienert"}, "path": "kork-credentials/src/main/java/com/netflix/spinnaker/credentials/poller/Poller.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * Copyright 2020 Armory\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.credentials.poller;\n+\n+import com.netflix.spinnaker.credentials.Credentials;\n+import com.netflix.spinnaker.credentials.definition.AbstractCredentialsLoader;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.slf4j.Slf4j;\n+\n+/**\n+ * A poller attempts to reload credentials from its source at a regular interval.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b94eda1cf9036ee420c95fd7518b17c3ea9e8bb"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3032289ffa33d9bbdbc3c91258980c4b7dfcec00", "author": {"user": {"login": "ncknt", "name": "Nicolas Cohen"}}, "url": "https://github.com/spinnaker/kork/commit/3032289ffa33d9bbdbc3c91258980c4b7dfcec00", "committedDate": "2020-09-14T19:21:46Z", "message": "Merge branch 'master' into feat/kork-credentials"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f30801dcc77adc4557521f0195ed58729ff4b53b", "author": {"user": {"login": "ncknt", "name": "Nicolas Cohen"}}, "url": "https://github.com/spinnaker/kork/commit/f30801dcc77adc4557521f0195ed58729ff4b53b", "committedDate": "2020-09-14T19:34:52Z", "message": "feat(credentials): Default non nullable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d3a858dd0959c16ef3865646e2a3111d0f8c9cc", "author": {"user": {"login": "ncknt", "name": "Nicolas Cohen"}}, "url": "https://github.com/spinnaker/kork/commit/9d3a858dd0959c16ef3865646e2a3111d0f8c9cc", "committedDate": "2020-09-14T21:49:22Z", "message": "feat(credentials): Move poller.enabled to kork"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42d18423e6db64c889afc591a109883eaeb010a6", "author": {"user": {"login": "ncknt", "name": "Nicolas Cohen"}}, "url": "https://github.com/spinnaker/kork/commit/42d18423e6db64c889afc591a109883eaeb010a6", "committedDate": "2020-09-14T22:32:28Z", "message": "feat(credentials): clean up dependencies"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1484, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}