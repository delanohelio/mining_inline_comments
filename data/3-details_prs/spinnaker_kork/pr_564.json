{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxNDU5MzYx", "number": 564, "title": "fix(plugins): allow for plugin configs on all services", "bodyText": "Halyard does not currently have knowledge of which plugins should be placed onto each spinnaker service. For now, we can log a warning if there are plugin configs placed onto services that are not required for the plugin to function, so that halyard can successfully deploy plugins to Spinnaker.\nCurrently Spinnaker throws an error if plugin configs are laid down upon a service that does not require it", "createdAt": "2020-03-20T10:36:21Z", "url": "https://github.com/spinnaker/kork/pull/564", "merged": true, "mergeCommit": {"oid": "39ea2e161c462fbb60727d2a78e008e8a42ee6b8"}, "closed": true, "closedAt": "2020-03-25T19:59:25Z", "author": {"login": "link108"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPd9RTgH2gAyMzkxNDU5MzYxOjRkMzE3NzU1Zjk4YTQzZmJlN2E3NGIzOTI5NDVlNjkxMzI2NjUzZjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRNGpKgFqTM4MTQ5MDA4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4d317755f98a43fbe7a74b392945e691326653f4", "author": {"user": {"login": "link108", "name": "Cameron Motevasselani"}}, "url": "https://github.com/spinnaker/kork/commit/4d317755f98a43fbe7a74b392945e691326653f4", "committedDate": "2020-03-20T10:29:07Z", "message": "fix(plugins): allow for plugin configs on all services"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NjY2ODkx", "url": "https://github.com/spinnaker/kork/pull/564#pullrequestreview-378666891", "createdAt": "2020-03-20T17:11:51Z", "commit": {"oid": "4d317755f98a43fbe7a74b392945e691326653f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNzoxMTo1MVrOF5cXCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNzoxMTo1MVrOF5cXCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc3NzgwMw==", "bodyText": "add a config / flag to allow for strict mode", "url": "https://github.com/spinnaker/kork/pull/564#discussion_r395777803", "createdAt": "2020-03-20T17:11:51Z", "author": {"login": "link108"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/SpinnakerPluginManager.kt", "diffHunk": "@@ -127,4 +131,14 @@ open class SpinnakerPluginManager(\n     .add(super.createPluginRepository())\n \n   override fun getPluginFactory(): PluginFactory = spinnakerPluginFactory\n+\n+  // TODO (link108): remove this override, once plugin deployments via halyard are fixed\n+  override fun loadPlugin(pluginPath: Path?): String? {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d317755f98a43fbe7a74b392945e691326653f4"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a80671fe06307b9e8322d28d54d391324592b703", "author": {"user": {"login": "link108", "name": "Cameron Motevasselani"}}, "url": "https://github.com/spinnaker/kork/commit/a80671fe06307b9e8322d28d54d391324592b703", "committedDate": "2020-03-24T08:53:30Z", "message": "feat(plugins): add property for strict plugin loading"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c69c6738de5de109e549144c9eced351cc2b7e4a", "author": {"user": {"login": "link108", "name": "Cameron Motevasselani"}}, "url": "https://github.com/spinnaker/kork/commit/c69c6738de5de109e549144c9eced351cc2b7e4a", "committedDate": "2020-03-24T17:58:38Z", "message": "Merge branch 'master' into log-plugin-service-mismatch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNTg5Mzk1", "url": "https://github.com/spinnaker/kork/pull/564#pullrequestreview-380589395", "createdAt": "2020-03-24T18:30:53Z", "commit": {"oid": "c69c6738de5de109e549144c9eced351cc2b7e4a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxODozMDo1M1rOF690AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxODozNDozOFrOF6982g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM3NDQ2NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  log.warn(\"Downloaded plugin bundle: {}, does not have plugin for service: {}\", bundlePath.fileName, service)\n          \n          \n            \n                  log.warn(\"Downloaded plugin bundle '{}' does not have plugin for service: {}\", bundlePath.fileName, service)", "url": "https://github.com/spinnaker/kork/pull/564#discussion_r397374465", "createdAt": "2020-03-24T18:30:53Z", "author": {"login": "robzienert"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/bundle/PluginBundleExtractor.kt", "diffHunk": "@@ -55,12 +58,20 @@ class PluginBundleExtractor {\n       return FileUtils.expandIfZip(servicePluginZipPath)\n     }\n \n-    // If thrown, this is an indicator that either: A) There's a bug in the plugin framework resolving which plugin\n-    // bundles should actually be downloaded, or B) The plugin author incorrectly identified this [service] as one\n-    // that the plugin extends (via the PluginInfo `requires` list).\n-    throw IntegrationException(\"Downloaded plugin bundle does not have plugin for service '$service'\")\n+    if (isStrictPluginLoading()) {\n+      // If thrown, this is an indicator that either: A) There's a bug in the plugin framework resolving which plugin\n+      // bundles should actually be downloaded, or B) The plugin author incorrectly identified this [service] as one\n+      // that the plugin extends (via the PluginInfo `requires` list).\n+      throw IntegrationException(\"Downloaded plugin bundle does not have plugin for service '$service'\")\n+    } else {\n+      log.warn(\"Downloaded plugin bundle: {}, does not have plugin for service: {}\", bundlePath.fileName, service)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c69c6738de5de109e549144c9eced351cc2b7e4a"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM3NTE5Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                require(!(pluginPath == null || Files.notExists(pluginPath))) { String.format(\"Specified plugin %s does not exist!\", pluginPath) }\n          \n          \n            \n                require(!(pluginPath == null || Files.notExists(pluginPath))) { \"Specified plugin '$pluginPath' does not exist!\" }", "url": "https://github.com/spinnaker/kork/pull/564#discussion_r397375196", "createdAt": "2020-03-24T18:32:11Z", "author": {"login": "robzienert"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/SpinnakerPluginManager.kt", "diffHunk": "@@ -127,4 +133,14 @@ open class SpinnakerPluginManager(\n     .add(super.createPluginRepository())\n \n   override fun getPluginFactory(): PluginFactory = spinnakerPluginFactory\n+\n+  // TODO (link108): remove this override, once plugin deployments via halyard are fixed\n+  override fun loadPlugin(pluginPath: Path?): String? {\n+    require(!(pluginPath == null || Files.notExists(pluginPath))) { String.format(\"Specified plugin %s does not exist!\", pluginPath) }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c69c6738de5de109e549144c9eced351cc2b7e4a"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM3NjczMA==", "bodyText": "!! is a code smell, let's avoid it when it's easy to do so:\nreturn loadPluginFromPath(pluginPath)\n  ?.let {\n    // try to resolve  the loaded plugin together with other possible plugins that depend on this plugin\n    resolvePlugins()\n    it.descriptor.pluginId\n  }", "url": "https://github.com/spinnaker/kork/pull/564#discussion_r397376730", "createdAt": "2020-03-24T18:34:38Z", "author": {"login": "robzienert"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/SpinnakerPluginManager.kt", "diffHunk": "@@ -127,4 +133,14 @@ open class SpinnakerPluginManager(\n     .add(super.createPluginRepository())\n \n   override fun getPluginFactory(): PluginFactory = spinnakerPluginFactory\n+\n+  // TODO (link108): remove this override, once plugin deployments via halyard are fixed\n+  override fun loadPlugin(pluginPath: Path?): String? {\n+    require(!(pluginPath == null || Files.notExists(pluginPath))) { String.format(\"Specified plugin %s does not exist!\", pluginPath) }\n+    log.debug(\"Loading plugin from '{}'\", pluginPath)\n+    val pluginWrapper = loadPluginFromPath(pluginPath) ?: return null\n+    // try to resolve  the loaded plugin together with other possible plugins that depend on this plugin\n+    resolvePlugins()\n+    return pluginWrapper!!.descriptor.pluginId", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c69c6738de5de109e549144c9eced351cc2b7e4a"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNjYwNDI0", "url": "https://github.com/spinnaker/kork/pull/564#pullrequestreview-380660424", "createdAt": "2020-03-24T20:12:18Z", "commit": {"oid": "c69c6738de5de109e549144c9eced351cc2b7e4a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMDoxMjoxOFrOF7BRxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMDoxMjoxOFrOF7BRxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQzMTIzOQ==", "bodyText": "Nit: Mayne pass an instance of PluginBundleExtractor to the SpinnakerPluginManager and avoid adding a new member field environment which has the sole purpose of being used as a constructor arg for PluginBundleExtractor.", "url": "https://github.com/spinnaker/kork/pull/564#discussion_r397431239", "createdAt": "2020-03-24T20:12:18Z", "author": {"login": "jonsie"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/SpinnakerPluginManager.kt", "diffHunk": "@@ -54,16 +57,19 @@ open class SpinnakerPluginManager(\n   val statusProvider: PluginStatusProvider,\n   configFactory: ConfigFactory,\n   sdkFactories: List<SdkFactory>,\n-  private val serviceName: String,\n-  pluginsRoot: Path\n+  val serviceName: String,\n+  pluginsRoot: Path,\n+  private val environment: Environment\n ) : DefaultPluginManager(pluginsRoot) {\n \n+  private val log by lazy { LoggerFactory.getLogger(javaClass) }\n+\n   private val springExtensionFactory: ExtensionFactory = SpinnakerExtensionFactory(\n     this,\n     configFactory,\n     sdkFactories\n   )\n-  private val bundleExtractor = PluginBundleExtractor()\n+  private val bundleExtractor = PluginBundleExtractor(environment)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c69c6738de5de109e549144c9eced351cc2b7e4a"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6474d7ea8ffd50dd05f1b5e149e54e0e9c020506", "author": {"user": {"login": "link108", "name": "Cameron Motevasselani"}}, "url": "https://github.com/spinnaker/kork/commit/6474d7ea8ffd50dd05f1b5e149e54e0e9c020506", "committedDate": "2020-03-24T21:39:06Z", "message": "Update kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/bundle/PluginBundleExtractor.kt\n\nCo-Authored-By: Rob Zienert <rob@robzienert.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d127bbdda6ebdcc6afa2b7a832a7a10092102409", "author": {"user": {"login": "link108", "name": "Cameron Motevasselani"}}, "url": "https://github.com/spinnaker/kork/commit/d127bbdda6ebdcc6afa2b7a832a7a10092102409", "committedDate": "2020-03-24T21:45:31Z", "message": "Update kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/SpinnakerPluginManager.kt\n\nCo-Authored-By: Rob Zienert <rob@robzienert.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "411b724d67a66c159840358bd13d001db7979c08", "author": {"user": {"login": "link108", "name": "Cameron Motevasselani"}}, "url": "https://github.com/spinnaker/kork/commit/411b724d67a66c159840358bd13d001db7979c08", "committedDate": "2020-03-24T23:06:57Z", "message": "style(plugins): use safe call operator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e98e96dc5fdcc396d62b4032a91f3b652c85a7ab", "author": {"user": {"login": "link108", "name": "Cameron Motevasselani"}}, "url": "https://github.com/spinnaker/kork/commit/e98e96dc5fdcc396d62b4032a91f3b652c85a7ab", "committedDate": "2020-03-24T23:06:57Z", "message": "style(plugins): create PluginBundleExtractor Bean vs passing environment around"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33612ba5cdef54ab3b9a58313d22c84a6113a062", "author": {"user": {"login": "link108", "name": "Cameron Motevasselani"}}, "url": "https://github.com/spinnaker/kork/commit/33612ba5cdef54ab3b9a58313d22c84a6113a062", "committedDate": "2020-03-25T18:03:49Z", "message": "Merge branch 'master' into log-plugin-service-mismatch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNDkwMDg2", "url": "https://github.com/spinnaker/kork/pull/564#pullrequestreview-381490086", "createdAt": "2020-03-25T19:58:49Z", "commit": {"oid": "33612ba5cdef54ab3b9a58313d22c84a6113a062"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1587, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}