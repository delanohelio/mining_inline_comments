{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4ODQ0MTg3", "number": 624, "title": "refactor(plugins): Add AggregatePluginInfoReleaseProvider that aggregates over list of PluginInfoReleaseSource", "bodyText": "I had this idea as a result of investigating how I can re-use something like SpringPluginInfoReleaseSource in Gate for Deck, and it led me down a bit of a rabbit hole of deleting things and drawing clearer lines between dependencies.\nThis sets us up nicely to use some of the same versioning logic for Deck plugins, and I also think this is much cleaner and easier to reason about.", "createdAt": "2020-04-25T04:05:08Z", "url": "https://github.com/spinnaker/kork/pull/624", "merged": true, "mergeCommit": {"oid": "64376c116e0a612bc06ab8f1389fc5727be199a7"}, "closed": true, "closedAt": "2020-04-28T16:19:55Z", "author": {"login": "jonsie"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABca-BFsgH2gAyNDA4ODQ0MTg3OmJlNzI0Y2JkMDg5OWNlMDhkNzZjZGZkYTI3NmVlMjVhNDMxZmZiYjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcb83s9gFqTQwMTUwMzU1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "be724cbd0899ce08d76cdfda276ee25a431ffbb1", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/be724cbd0899ce08d76cdfda276ee25a431ffbb1", "committedDate": "2020-04-25T04:03:25Z", "message": "refactor(plugins): Add AggregatePluginInfoReleaseProvider that aggregates over list of PluginInfoReleaseSource"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMzU0NTkz", "url": "https://github.com/spinnaker/kork/pull/624#pullrequestreview-400354593", "createdAt": "2020-04-25T04:06:20Z", "commit": {"oid": "be724cbd0899ce08d76cdfda276ee25a431ffbb1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwNDowNjoyMVrOGLv4WQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwNDowNjoyMVrOGLv4WQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk3MTk5Mw==", "bodyText": "The motivation here is, I wanted to use something like this in Gate except I didn't want to bring in the fallback logic and I didn't want to bring in the versionManager (which turns out is unnecessary here, since it is called when the plugin is loaded).  So I started pulling stuff out of this class, and then I ended up with this draft.  \ud83e\udd37\u200d\u2642\ufe0f", "url": "https://github.com/spinnaker/kork/pull/624#discussion_r414971993", "createdAt": "2020-04-25T04:06:21Z", "author": {"login": "jonsie"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/update/release/SpringPluginInfoReleaseProvider.kt", "diffHunk": "@@ -1,76 +0,0 @@\n-/*\n- * Copyright 2020 Netflix, Inc.\n- *\n- * Licensed under the Apache License, Version 2.0 (the \"License\");\n- * you may not use this file except in compliance with the License.\n- * You may obtain a copy of the License at\n- *\n- *   http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-\n-package com.netflix.spinnaker.kork.plugins.update.release\n-\n-import com.netflix.spinnaker.kork.plugins.SpinnakerPluginManager\n-import com.netflix.spinnaker.kork.plugins.SpringPluginStatusProvider\n-import com.netflix.spinnaker.kork.plugins.SpringStrictPluginLoaderStatusProvider\n-import com.netflix.spinnaker.kork.plugins.update.SpinnakerUpdateManager\n-import org.pf4j.VersionManager\n-import org.pf4j.update.PluginInfo\n-import org.slf4j.LoggerFactory\n-\n-/**\n- * Determines plugin releases based on Spring properties via [SpringPluginStatusProvider].\n- */\n-class SpringPluginInfoReleaseProvider(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be724cbd0899ce08d76cdfda276ee25a431ffbb1"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7b8c5437b665e68e906e08f9baa331cc0d2585f", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/e7b8c5437b665e68e906e08f9baa331cc0d2585f", "committedDate": "2020-04-27T19:59:56Z", "message": "refactor(plugins): Test progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56340d16f4e5d08e7808c924ba37bf2ce1d9a479", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/56340d16f4e5d08e7808c924ba37bf2ce1d9a479", "committedDate": "2020-04-27T23:43:29Z", "message": "refactor(plugins): AggregatePluginInfoReleaseProvider test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea05af0268df70fa8b9c8ef9c86bfc4c17c21ed1", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/ea05af0268df70fa8b9c8ef9c86bfc4c17c21ed1", "committedDate": "2020-04-27T23:44:24Z", "message": "Merge branch 'master' into refactor-version-release-finding"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2e73f5ef8af0e826f89713073f2acdaaa4b9a39", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/c2e73f5ef8af0e826f89713073f2acdaaa4b9a39", "committedDate": "2020-04-27T23:50:57Z", "message": "refactor(plugins): kotlin spotless"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNDA1NTg0", "url": "https://github.com/spinnaker/kork/pull/624#pullrequestreview-401405584", "createdAt": "2020-04-27T23:52:22Z", "commit": {"oid": "c2e73f5ef8af0e826f89713073f2acdaaa4b9a39"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMzo1MjoyMlrOGM8fpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMzo1MjoyMlrOGM8fpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyNzIzOA==", "bodyText": "Filtering for enabled/disabled plugins shouldn't be something that the PluginInfoReleaseProvider cares about, so I moved this out.", "url": "https://github.com/spinnaker/kork/pull/624#discussion_r416227238", "createdAt": "2020-04-27T23:52:22Z", "author": {"login": "jonsie"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/ExtensionBeanDefinitionRegistryPostProcessor.kt", "diffHunk": "@@ -50,8 +50,10 @@ class ExtensionBeanDefinitionRegistryPostProcessor(\n     // 1) Load plugins prior to downloading so we can resolve what needs to be updated\n     pluginManager.loadPlugins()\n \n-    // 2) Determine the plugins for release from the list of plugins\n-    val releases = pluginInfoReleaseProvider.getReleases(updateManager.plugins)\n+    // 2) Determine the plugins for release from the list of enabled plugins\n+    val releases = updateManager.plugins\n+      .filter { !pluginManager.statusProvider.isPluginDisabled(it.id) }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2e73f5ef8af0e826f89713073f2acdaaa4b9a39"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNDA1ODI2", "url": "https://github.com/spinnaker/kork/pull/624#pullrequestreview-401405826", "createdAt": "2020-04-27T23:52:57Z", "commit": {"oid": "c2e73f5ef8af0e826f89713073f2acdaaa4b9a39"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMzo1Mjo1N1rOGM8gkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMzo1Mjo1N1rOGM8gkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjIyNzQ3Mg==", "bodyText": "I want to use this in Gate, but the root path to the Deck plugins will be something like spinnaker.extensibility.deck-proxy so I moved the root config to the constructor.", "url": "https://github.com/spinnaker/kork/pull/624#discussion_r416227472", "createdAt": "2020-04-27T23:52:57Z", "author": {"login": "jonsie"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/SpringPluginStatusProvider.kt", "diffHunk": "@@ -15,21 +15,20 @@\n  */\n package com.netflix.spinnaker.kork.plugins\n \n-import com.netflix.spinnaker.config.PluginsConfigurationProperties.CONFIG_NAMESPACE\n-import com.netflix.spinnaker.config.PluginsConfigurationProperties.DEFAULT_ROOT_PATH\n+import com.netflix.spinnaker.kork.dynamicconfig.DynamicConfigService\n import kotlin.collections.set\n import org.pf4j.PluginStatusProvider\n import org.slf4j.LoggerFactory\n import org.springframework.boot.context.event.ApplicationEnvironmentPreparedEvent\n import org.springframework.context.ApplicationListener\n-import org.springframework.core.env.Environment\n import org.springframework.core.env.MapPropertySource\n \n /**\n  * Backs plugin status by the Spring environment, instead of using text files.\n  */\n class SpringPluginStatusProvider(\n-  private val environment: Environment\n+  private val dynamicConfigService: DynamicConfigService,\n+  private val rootConfig: String", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2e73f5ef8af0e826f89713073f2acdaaa4b9a39"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMjgzODUx", "url": "https://github.com/spinnaker/kork/pull/624#pullrequestreview-401283851", "createdAt": "2020-04-27T20:02:55Z", "commit": {"oid": "e7b8c5437b665e68e906e08f9baa331cc0d2585f"}, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMDowMjo1NVrOGM1Vaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwMToyODozMlrOGM-kPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjEwOTkzMQ==", "bodyText": "nit: Should have isEnabled(it.id) so you don't need to negate.", "url": "https://github.com/spinnaker/kork/pull/624#discussion_r416109931", "createdAt": "2020-04-27T20:02:55Z", "author": {"login": "robzienert"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/ExtensionBeanDefinitionRegistryPostProcessor.kt", "diffHunk": "@@ -50,8 +50,10 @@ class ExtensionBeanDefinitionRegistryPostProcessor(\n     // 1) Load plugins prior to downloading so we can resolve what needs to be updated\n     pluginManager.loadPlugins()\n \n-    // 2) Determine the plugins for release from the list of plugins\n-    val releases = pluginInfoReleaseProvider.getReleases(updateManager.plugins)\n+    // 2) Determine the plugins for release from the list of enabled plugins\n+    val releases = updateManager.plugins\n+      .filter { !pluginManager.statusProvider.isPluginDisabled(it.id) }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7b8c5437b665e68e906e08f9baa331cc0d2585f"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI2MDQ2MQ==", "bodyText": "nit: Long conditionals like this, I think, should be extracted to their own methods. Something to the effect of missingPluginWithStrictLoading(pluginInfoReleases, plugin)", "url": "https://github.com/spinnaker/kork/pull/624#discussion_r416260461", "createdAt": "2020-04-28T01:26:29Z", "author": {"login": "robzienert"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/update/release/provider/AggregatePluginInfoReleaseProvider.kt", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package com.netflix.spinnaker.kork.plugins.update.release.provider\n+\n+import com.netflix.spinnaker.kork.plugins.SpringStrictPluginLoaderStatusProvider\n+import com.netflix.spinnaker.kork.plugins.update.release.PluginInfoRelease\n+import com.netflix.spinnaker.kork.plugins.update.release.source.PluginInfoReleaseSource\n+import org.pf4j.update.PluginInfo\n+\n+class AggregatePluginInfoReleaseProvider(\n+  private val pluginInfoReleaseSources: List<PluginInfoReleaseSource>,\n+  private val strictPluginLoaderStatusProvider: SpringStrictPluginLoaderStatusProvider\n+) : PluginInfoReleaseProvider {\n+\n+  override fun getReleases(pluginInfo: List<PluginInfo>): Set<PluginInfoRelease> {\n+    val pluginInfoReleases: MutableSet<PluginInfoRelease> = mutableSetOf()\n+\n+    pluginInfoReleaseSources.forEach { source ->\n+      source.getReleases(pluginInfo).forEach { release ->\n+        val hit = pluginInfoReleases.find { it.pluginId == release.pluginId }\n+        if (hit != null) {\n+          pluginInfoReleases.remove(hit)\n+          pluginInfoReleases.add(release)\n+        } else {\n+          pluginInfoReleases.add(release)\n+        }\n+      }\n+\n+      source.processReleases(pluginInfoReleases)\n+    }\n+\n+    pluginInfo.forEach { plugin ->\n+      if (pluginInfoReleases.find { it.pluginId == plugin.id } == null &&\n+        strictPluginLoaderStatusProvider.isStrictPluginLoading()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2e73f5ef8af0e826f89713073f2acdaaa4b9a39"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI2MDg0NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  log.info(\"Latest release version {} for plugin {}\", latestRelease.version, pluginInfo.id)\n          \n          \n            \n                  log.info(\"Latest release version '{}' for plugin '{}'\", latestRelease.version, pluginInfo.id)", "url": "https://github.com/spinnaker/kork/pull/624#discussion_r416260844", "createdAt": "2020-04-28T01:27:36Z", "author": {"login": "robzienert"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/update/release/source/LatestPluginInfoReleaseSource.kt", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package com.netflix.spinnaker.kork.plugins.update.release.source\n+\n+import com.netflix.spinnaker.kork.plugins.update.SpinnakerUpdateManager\n+import com.netflix.spinnaker.kork.plugins.update.release.PluginInfoRelease\n+import org.pf4j.update.PluginInfo\n+import org.slf4j.LoggerFactory\n+import org.springframework.core.Ordered.HIGHEST_PRECEDENCE\n+\n+/**\n+ * Source the last published plugin info release.\n+ */\n+class LatestPluginInfoReleaseSource(\n+  private val updateManager: SpinnakerUpdateManager\n+) : PluginInfoReleaseSource {\n+\n+  private val log by lazy { LoggerFactory.getLogger(javaClass) }\n+\n+  override fun getReleases(pluginInfo: List<PluginInfo>): Set<PluginInfoRelease> {\n+    return pluginInfo.mapNotNull { pluginInfoRelease(it) }.toSet()\n+  }\n+\n+  private fun pluginInfoRelease(pluginInfo: PluginInfo): PluginInfoRelease? {\n+    val latestRelease = updateManager.getLastPluginRelease(pluginInfo.id)\n+    return if (latestRelease != null) {\n+      log.info(\"Latest release version {} for plugin {}\", latestRelease.version, pluginInfo.id)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2e73f5ef8af0e826f89713073f2acdaaa4b9a39"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI2MDkwNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  log.info(\"Latest release version not found for plugin {}\", pluginInfo.id)\n          \n          \n            \n                  log.info(\"Latest release version not found for plugin '{}'\", pluginInfo.id)", "url": "https://github.com/spinnaker/kork/pull/624#discussion_r416260905", "createdAt": "2020-04-28T01:27:47Z", "author": {"login": "robzienert"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/update/release/source/LatestPluginInfoReleaseSource.kt", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package com.netflix.spinnaker.kork.plugins.update.release.source\n+\n+import com.netflix.spinnaker.kork.plugins.update.SpinnakerUpdateManager\n+import com.netflix.spinnaker.kork.plugins.update.release.PluginInfoRelease\n+import org.pf4j.update.PluginInfo\n+import org.slf4j.LoggerFactory\n+import org.springframework.core.Ordered.HIGHEST_PRECEDENCE\n+\n+/**\n+ * Source the last published plugin info release.\n+ */\n+class LatestPluginInfoReleaseSource(\n+  private val updateManager: SpinnakerUpdateManager\n+) : PluginInfoReleaseSource {\n+\n+  private val log by lazy { LoggerFactory.getLogger(javaClass) }\n+\n+  override fun getReleases(pluginInfo: List<PluginInfo>): Set<PluginInfoRelease> {\n+    return pluginInfo.mapNotNull { pluginInfoRelease(it) }.toSet()\n+  }\n+\n+  private fun pluginInfoRelease(pluginInfo: PluginInfo): PluginInfoRelease? {\n+    val latestRelease = updateManager.getLastPluginRelease(pluginInfo.id)\n+    return if (latestRelease != null) {\n+      log.info(\"Latest release version {} for plugin {}\", latestRelease.version, pluginInfo.id)\n+      PluginInfoRelease(pluginInfo.id, latestRelease)\n+    } else {\n+      log.info(\"Latest release version not found for plugin {}\", pluginInfo.id)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2e73f5ef8af0e826f89713073f2acdaaa4b9a39"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI2MTEzNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  log.info(\"Spring configured release version {} for plugin {}\", release.version, pluginInfo.id)\n          \n          \n            \n                  log.info(\"Spring configured release version '{}' for plugin '{}'\", release.version, pluginInfo.id)", "url": "https://github.com/spinnaker/kork/pull/624#discussion_r416261136", "createdAt": "2020-04-28T01:28:24Z", "author": {"login": "robzienert"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/update/release/source/SpringPluginInfoReleaseSource.kt", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package com.netflix.spinnaker.kork.plugins.update.release.source\n+\n+import com.netflix.spinnaker.kork.plugins.SpringPluginStatusProvider\n+import com.netflix.spinnaker.kork.plugins.update.release.PluginInfoRelease\n+import org.pf4j.update.PluginInfo\n+import org.slf4j.LoggerFactory\n+\n+/**\n+ * Sources plugin releases from Spring properties via [SpringPluginStatusProvider].\n+ */\n+class SpringPluginInfoReleaseSource(\n+  private val pluginStatusProvider: SpringPluginStatusProvider\n+) : PluginInfoReleaseSource {\n+\n+  private val log by lazy { LoggerFactory.getLogger(javaClass) }\n+\n+  override fun getReleases(pluginInfo: List<PluginInfo>): Set<PluginInfoRelease> {\n+    return pluginInfo.mapNotNull { pluginInfoRelease(it) }.toSet()\n+  }\n+\n+  private fun pluginInfoRelease(pluginInfo: PluginInfo): PluginInfoRelease? {\n+    val pluginVersion = pluginStatusProvider.pluginVersion(pluginInfo.id)\n+    val release = pluginInfo.releases.firstOrNull { it.version == pluginVersion }\n+    return if (release != null) {\n+      log.info(\"Spring configured release version {} for plugin {}\", release.version, pluginInfo.id)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2e73f5ef8af0e826f89713073f2acdaaa4b9a39"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjI2MTE4MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  log.info(\"Spring configured release version not found for plugin {}\", pluginInfo.id)\n          \n          \n            \n                  log.info(\"Spring configured release version not found for plugin '{}'\", pluginInfo.id)", "url": "https://github.com/spinnaker/kork/pull/624#discussion_r416261180", "createdAt": "2020-04-28T01:28:32Z", "author": {"login": "robzienert"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/update/release/source/SpringPluginInfoReleaseSource.kt", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package com.netflix.spinnaker.kork.plugins.update.release.source\n+\n+import com.netflix.spinnaker.kork.plugins.SpringPluginStatusProvider\n+import com.netflix.spinnaker.kork.plugins.update.release.PluginInfoRelease\n+import org.pf4j.update.PluginInfo\n+import org.slf4j.LoggerFactory\n+\n+/**\n+ * Sources plugin releases from Spring properties via [SpringPluginStatusProvider].\n+ */\n+class SpringPluginInfoReleaseSource(\n+  private val pluginStatusProvider: SpringPluginStatusProvider\n+) : PluginInfoReleaseSource {\n+\n+  private val log by lazy { LoggerFactory.getLogger(javaClass) }\n+\n+  override fun getReleases(pluginInfo: List<PluginInfo>): Set<PluginInfoRelease> {\n+    return pluginInfo.mapNotNull { pluginInfoRelease(it) }.toSet()\n+  }\n+\n+  private fun pluginInfoRelease(pluginInfo: PluginInfo): PluginInfoRelease? {\n+    val pluginVersion = pluginStatusProvider.pluginVersion(pluginInfo.id)\n+    val release = pluginInfo.releases.firstOrNull { it.version == pluginVersion }\n+    return if (release != null) {\n+      log.info(\"Spring configured release version {} for plugin {}\", release.version, pluginInfo.id)\n+      PluginInfoRelease(pluginInfo.id, release)\n+    } else {\n+      log.info(\"Spring configured release version not found for plugin {}\", pluginInfo.id)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c2e73f5ef8af0e826f89713073f2acdaaa4b9a39"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e95eca989c55b9d947b0561c654b74613183ec4a", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/e95eca989c55b9d947b0561c654b74613183ec4a", "committedDate": "2020-04-28T02:24:17Z", "message": "refactor(plugins): Addressing comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "656d4d7983c6f1182e145ab990084dbaf042c10d", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/656d4d7983c6f1182e145ab990084dbaf042c10d", "committedDate": "2020-04-28T02:32:35Z", "message": "fix(plugins): Fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNTAzNTU2", "url": "https://github.com/spinnaker/kork/pull/624#pullrequestreview-401503556", "createdAt": "2020-04-28T05:17:11Z", "commit": {"oid": "656d4d7983c6f1182e145ab990084dbaf042c10d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1505, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}