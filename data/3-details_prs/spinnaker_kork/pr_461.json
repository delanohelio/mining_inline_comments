{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwNjY4NzY3", "number": 461, "title": "fix(secrets): Do not share yamlparser across threads", "bodyText": "Closes spinnaker/spinnaker#5287\nThe issue is caused by a multithreading race condition, in which there are separate threads trying to read the InputStream and parse the file into memory. It seems that one thread closed the stream while the other was still reading from it, hence the warning Not all bytes were read from the S3ObjectInputStream, aborting HTTP connection. Snake yaml library is clear with regard to Yaml instance not being thread safe: https://bitbucket.org/asomov/snakeyaml/wiki/Documentation#markdown-header-threading\nThis is a log of the error with added lines before and after the call to yamlParser.load(inputStream), note that the log line Before yamlParser.load is printed twice from different threads, then the warning is also printed twice from those same threads:\n2020-01-08 18:58:46.952  INFO 1 --- [           main] c.n.s.k.s.e.AbstractStorageSecretEngine  : Before yamlParser.load\n2020-01-08 18:58:46.952  INFO 1 --- [igurationSource] c.n.s.k.s.e.AbstractStorageSecretEngine  : Before yamlParser.load\n2020-01-08 18:58:46.952  WARN 1 --- [igurationSource] c.a.s.s.internal.S3AbortableInputStream  : Not all bytes were read from the S3ObjectInputStream, aborting HTTP connection. This is likely an error and\n may result in sub-optimal behavior. Request only the bytes you need via a ranged GET or drain the input stream after use.\n2020-01-08 18:58:46.953  WARN 1 --- [           main] c.a.s.s.internal.S3AbortableInputStream  : Not all bytes were read from the S3ObjectInputStream, aborting HTTP connection. This is likely an error and\n may result in sub-optimal behavior. Request only the bytes you need via a ranged GET or drain the input stream after use.\n2020-01-08 18:58:46.957 ERROR 1 --- [igurationSource] c.n.config.AbstractPollingScheduler      : Error getting result from polling source\n\njava.lang.IndexOutOfBoundsException: Index: 0, Size: 0\n        at java.util.ArrayList.rangeCheck(ArrayList.java:657)\n        at java.util.ArrayList.remove(ArrayList.java:496)\n        at org.yaml.snakeyaml.scanner.ScannerImpl.getToken(ScannerImpl.java:260)\n        at org.yaml.snakeyaml.parser.ParserImpl$ParseStreamStart.produce(ParserImpl.java:184)\n        at org.yaml.snakeyaml.parser.ParserImpl.peekEvent(ParserImpl.java:158)\n        at org.yaml.snakeyaml.parser.ParserImpl.getEvent(ParserImpl.java:168)\n        at org.yaml.snakeyaml.composer.Composer.getSingleNode(Composer.java:104)\n        at org.yaml.snakeyaml.constructor.BaseConstructor.getSingleData(BaseConstructor.java:141)\n        at org.yaml.snakeyaml.Yaml.loadFromReader(Yaml.java:525)\n        at org.yaml.snakeyaml.Yaml.load(Yaml.java:453)\n        at com.netflix.spinnaker.kork.secrets.engines.AbstractStorageSecretEngine.parseAsYaml(AbstractStorageSecretEngine.java:117)\n        at com.netflix.spinnaker.kork.secrets.engines.AbstractStorageSecretEngine.decrypt(AbstractStorageSecretEngine.java:61)\n        at com.netflix.spinnaker.kork.secrets.SecretManager.decryptAsBytes(SecretManager.java:90)\n        at com.netflix.spinnaker.kork.secrets.SecretManager.decrypt(SecretManager.java:48)\n        at com.netflix.spinnaker.kork.secrets.SecretAwarePropertySource.getProperty(SecretAwarePropertySource.java:44)\n        at com.netflix.spinnaker.kork.archaius.SpringEnvironmentPolledConfigurationSource.lambda$poll$0(SpringEnvironmentPolledConfigurationSource.java:46)\n        at java.util.concurrent.CopyOnWriteArrayList$COWIterator.forEachRemaining(CopyOnWriteArrayList.java:1206)\n        at com.netflix.spinnaker.kork.archaius.SpringEnvironmentPolledConfigurationSource.poll(SpringEnvironmentPolledConfigurationSource.java:41)\n        at com.netflix.config.AbstractPollingScheduler$1.run(AbstractPollingScheduler.java:163)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)\n        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)\n        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n        at java.lang.Thread.run(Thread.java:748)\n2020-01-08 18:58:46.964  WARN 1 --- [           main] ConfigServletWebServerApplicationContext : Exception encountered during context initialization - cancelling refresh attempt: org.springframework.beans\n.factory.UnsatisfiedDependencyException: Error creating bean with name 'artifactCredentialsRepository' defined in URL [jar:file:/opt/clouddriver/lib/clouddriver-artifacts-6.4.4-22f8150-stable544.jar!/com/\nnetflix/spinnaker/clouddriver/artifacts/ArtifactCredentialsRepository.class]: Unsatisfied dependency expressed through constructor parameter 0; nested exception is org.springframework.beans.factory.Unsati\nsfiedDependencyException: Error creating bean with name 'bitbucketArtifactConfiguration' defined in URL [jar:file:/opt/clouddriver/lib/clouddriver-artifacts-6.4.4-22f8150-stable544.jar!/com/netflix/spinna\nker/clouddriver/artifacts/bitbucket/BitbucketArtifactConfiguration.class]: Unsatisfied dependency expressed through constructor parameter 0; nested exception is org.springframework.boot.context.properties\n.ConfigurationPropertiesBindException: Error creating bean with name 'artifacts.bitbucket-com.netflix.spinnaker.clouddriver.artifacts.bitbucket.BitbucketArtifactProviderProperties': Could not bind propert\nies to 'BitbucketArtifactProviderProperties' : prefix=artifacts.bitbucket, ignoreInvalidFields=false, ignoreUnknownFields=true; nested exception is org.springframework.boot.context.properties.bind.BindExc\neption: Failed to bind properties under 'artifacts.bitbucket.accounts' to java.util.List<com.netflix.spinnaker.clouddriver.artifacts.bitbucket.BitbucketArtifactAccount>\n2020-01-08 18:58:46.973  INFO 1 --- [           main] o.apache.catalina.core.StandardService   : Stopping service [Tomcat]\n2020-01-08 18:58:46.983  WARN 1 --- [           main] o.a.c.loader.WebappClassLoaderBase       : The web application [ROOT] appears to have started a thread named [spectator-gauge-polling-0] but has faile\nd to stop it. This is very likely to create a memory leak. Stack trace of thread:\n sun.misc.Unsafe.park(Native Method)\n java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)\n java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2078)\n java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:1093)\n java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:809)\n java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1074)\n java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1134)\n java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n java.lang.Thread.run(Thread.java:748)\n2020-01-08 18:58:47.002  INFO 1 --- [           main] ConditionEvaluationReportLoggingListener :\n\nError starting ApplicationContext. To display the conditions report re-run your application with 'debug' enabled.\n2020-01-08 18:58:47.006 ERROR 1 --- [           main] o.s.b.d.LoggingFailureAnalysisReporter   :\n\n***************************\nAPPLICATION FAILED TO START\n***************************\n\n\nDescription:\n\nFailed to bind properties under 'artifacts.bitbucket.accounts' to java.util.List<com.netflix.spinnaker.clouddriver.artifacts.bitbucket.BitbucketArtifactAccount>:\n\n    Reason: Socket is closed\n\nAction:\n\nUpdate your application's configuration\n\n\nAfter the changes in this PR the log looks like:\n2020-01-08 19:51:58.764  INFO 1 --- [           main] c.n.s.k.s.e.AbstractStorageSecretEngine  : Before yamlParser.load\n2020-01-08 19:51:58.764  INFO 1 --- [igurationSource] c.n.s.k.s.e.AbstractStorageSecretEngine  : Before yamlParser.load\n2020-01-08 19:51:58.766  INFO 1 --- [           main] c.n.s.k.s.e.AbstractStorageSecretEngine  : After yamlParser.load\n2020-01-08 19:51:58.766  INFO 1 --- [igurationSource] c.n.s.k.s.e.AbstractStorageSecretEngine  : After yamlParser.load\n\nAfter several restarts the original issue no longer appears.", "createdAt": "2020-01-08T21:43:53Z", "url": "https://github.com/spinnaker/kork/pull/461", "merged": true, "mergeCommit": {"oid": "de839956143a62a8da44396966204aeb78164c8a"}, "closed": true, "closedAt": "2020-01-21T14:23:01Z", "author": {"login": "german-muzquiz"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4cKJngH2gAyMzYwNjY4NzY3OmE5NDQwMmYwZWZlMDdiMjBhYmVjMjE4NjZmMTE1ZGFkOWJmNGJhYTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8hnzuAH2gAyMzYwNjY4NzY3OjZlNWYxOWE4ODUwMDE4ZDE5NGMzY2EyMWI0ZGUzZDkzN2MzM2YyNmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a94402f0efe07b20abec21866f115dad9bf4baa3", "author": {"user": {"login": "german-muzquiz", "name": "German Muzquiz"}}, "url": "https://github.com/spinnaker/kork/commit/a94402f0efe07b20abec21866f115dad9bf4baa3", "committedDate": "2020-01-08T21:23:07Z", "message": "fix(secrets): Do not share yamlparser across threads"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMTg2MTAw", "url": "https://github.com/spinnaker/kork/pull/461#pullrequestreview-340186100", "createdAt": "2020-01-08T22:27:41Z", "commit": {"oid": "a94402f0efe07b20abec21866f115dad9bf4baa3"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMjoyNzo0MVrOFblxYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMjoyNzo0MVrOFblxYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ3NDcyMg==", "bodyText": "Small nit - If all you're doing in getYamlParser() is returning a new Yaml() why not just make this line new Yaml().load(...) and eliminate the extra method?", "url": "https://github.com/spinnaker/kork/pull/461#discussion_r364474722", "createdAt": "2020-01-08T22:27:41Z", "author": {"login": "ethanfrogers"}, "path": "kork-secrets/src/main/java/com/netflix/spinnaker/kork/secrets/engines/AbstractStorageSecretEngine.java", "diffHunk": "@@ -110,7 +114,7 @@ protected abstract InputStream downloadRemoteFile(EncryptedSecret encryptedSecre\n   }\n \n   protected void parseAsYaml(String fileURI, InputStream inputStream) {\n-    Map<String, Object> parsed = yamlParser.load(inputStream);\n+    Map<String, Object> parsed = getYamlParser().load(inputStream);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a94402f0efe07b20abec21866f115dad9bf4baa3"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f123bb5e06c56fcf208b41e032dd7fb47f9d7c8", "author": {"user": {"login": "german-muzquiz", "name": "German Muzquiz"}}, "url": "https://github.com/spinnaker/kork/commit/0f123bb5e06c56fcf208b41e032dd7fb47f9d7c8", "committedDate": "2020-01-14T15:51:30Z", "message": "Merge branch 'master' into fix/secrets-multithreading"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNzE1NjA4", "url": "https://github.com/spinnaker/kork/pull/461#pullrequestreview-342715608", "createdAt": "2020-01-14T17:38:58Z", "commit": {"oid": "0f123bb5e06c56fcf208b41e032dd7fb47f9d7c8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNzozODo1OVrOFdgDLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNzozODo1OVrOFdgDLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ3ODEyNg==", "bodyText": "Can you mark it @Deprecated and use new Yaml() below?", "url": "https://github.com/spinnaker/kork/pull/461#discussion_r366478126", "createdAt": "2020-01-14T17:38:59Z", "author": {"login": "ncknt"}, "path": "kork-secrets/src/main/java/com/netflix/spinnaker/kork/secrets/engines/AbstractStorageSecretEngine.java", "diffHunk": "@@ -92,6 +90,12 @@ public EncryptedSecret encrypt(String secretToEncrypt) throws UnsupportedOperati\n     throw new UnsupportedOperationException(\"This operation is not supported\");\n   }\n \n+  protected Yaml getYamlParser() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f123bb5e06c56fcf208b41e032dd7fb47f9d7c8"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff27be95e46364874af0edf618de3096b2ab5da9", "author": {"user": {"login": "german-muzquiz", "name": "German Muzquiz"}}, "url": "https://github.com/spinnaker/kork/commit/ff27be95e46364874af0edf618de3096b2ab5da9", "committedDate": "2020-01-14T17:42:13Z", "message": "Merge branch 'master' into fix/secrets-multithreading"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f40acbca8df18d5ea110a50d63935237a5d96ae0", "author": {"user": {"login": "german-muzquiz", "name": "German Muzquiz"}}, "url": "https://github.com/spinnaker/kork/commit/f40acbca8df18d5ea110a50d63935237a5d96ae0", "committedDate": "2020-01-14T17:46:04Z", "message": "fix(secrets): yamlParser variable marked deprecated in favor of method."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b7d43a06009e132ddfc248d38472445202ed44f", "author": {"user": {"login": "german-muzquiz", "name": "German Muzquiz"}}, "url": "https://github.com/spinnaker/kork/commit/8b7d43a06009e132ddfc248d38472445202ed44f", "committedDate": "2020-01-14T18:47:08Z", "message": "Merge branch 'master' into fix/secrets-multithreading"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8ade0666d1cc370c83b618ffbbac57f0027b91f", "author": {"user": {"login": "german-muzquiz", "name": "German Muzquiz"}}, "url": "https://github.com/spinnaker/kork/commit/b8ade0666d1cc370c83b618ffbbac57f0027b91f", "committedDate": "2020-01-14T21:38:32Z", "message": "fix(secrets): Removed method to get yaml parser and instantiate it inline instead"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f5edd24d513a4263bbf6c01105fc03814ec746c", "author": {"user": {"login": "german-muzquiz", "name": "German Muzquiz"}}, "url": "https://github.com/spinnaker/kork/commit/3f5edd24d513a4263bbf6c01105fc03814ec746c", "committedDate": "2020-01-14T21:38:50Z", "message": "Merge branch 'fix/secrets-multithreading' of github.com:armory-io/kork into fix/secrets-multithreading"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyODkxMTM0", "url": "https://github.com/spinnaker/kork/pull/461#pullrequestreview-342891134", "createdAt": "2020-01-14T22:48:44Z", "commit": {"oid": "3f5edd24d513a4263bbf6c01105fc03814ec746c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ab3f8f8cbb5074df7c5c155a425f6ca7f4a33bd", "author": {"user": {"login": "german-muzquiz", "name": "German Muzquiz"}}, "url": "https://github.com/spinnaker/kork/commit/0ab3f8f8cbb5074df7c5c155a425f6ca7f4a33bd", "committedDate": "2020-01-17T15:47:45Z", "message": "Merge branch 'master' into fix/secrets-multithreading"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f55326bbd70880c49ce0c3807000043bb32ddd38", "author": {"user": {"login": "german-muzquiz", "name": "German Muzquiz"}}, "url": "https://github.com/spinnaker/kork/commit/f55326bbd70880c49ce0c3807000043bb32ddd38", "committedDate": "2020-01-20T16:17:14Z", "message": "Merge branch 'master' into fix/secrets-multithreading"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cab0f42ce6d6ca1cdc01f4b3d6b10ea8b711d56", "author": {"user": {"login": "german-muzquiz", "name": "German Muzquiz"}}, "url": "https://github.com/spinnaker/kork/commit/0cab0f42ce6d6ca1cdc01f4b3d6b10ea8b711d56", "committedDate": "2020-01-20T21:09:19Z", "message": "Merge branch 'master' into fix/secrets-multithreading"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e5f19a8850018d194c3ca21b4de3d937c33f26e", "author": {"user": {"login": "ethanfrogers", "name": "Ethan Rogers"}}, "url": "https://github.com/spinnaker/kork/commit/6e5f19a8850018d194c3ca21b4de3d937c33f26e", "committedDate": "2020-01-21T14:00:44Z", "message": "Merge branch 'master' into fix/secrets-multithreading"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1610, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}