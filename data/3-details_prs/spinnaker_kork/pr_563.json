{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMTQxMTUx", "number": 563, "title": "feat(configuration): Add support for spring cloud config with S3", "bodyText": "Due to corporate restrictions we cannot add git as a backend for spring-cloud-config. In the latest releases of spring cloud, S3 was added as supported backend. It would be great to use S3 for storing both clouddriver account definitions and kubeconfigs.\nThis PR starts from a previous one here and reverted here due to the following issue\nThe issue identified is that when using spring-cloud-starter-aws it includes spring-cloud-aws-autoconfigure with lots of Autoconfiguration classes causing failures at startup for non aws environments.\nApproach: Use only spring-cloud-aws-contex and configure the ContextResourceLoaderConfiguration for S3\nTested on spinnaker installed in an EKS cluster with latest clouddriver and the following config:\nspinnakerconfig.yml\nspring:\n  profiles:\n    include: awss3\n  cloud:\n    config:\n      server:\n        awss3:\n          region: us-east-1\n          bucket: <my-bucket>\n\nThe s3 bucket my-bucket contains a clouddriver-local.yml with K8s cluster definitions and reference to kubeconfig files kubeconfigFile: configserver:my_kubeconfig.yml and under my-bucket/clouddriver/ the kubeconfig files: my_kubeconfig.yml\nISSUE: spinnaker/spinnaker#5532", "createdAt": "2020-03-19T17:33:15Z", "url": "https://github.com/spinnaker/kork/pull/563", "merged": true, "mergeCommit": {"oid": "16dcd3e30074e126704e13739831276461eaabd6"}, "closed": true, "closedAt": "2020-09-30T19:32:40Z", "author": {"login": "titirigaiulian"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPb8vuABqjMxNDgzNjEyMjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOB9CcgH2gAyMzkxMTQxMTUxOmU0ZDNmMGRjNjU1ZjUzYTM2M2ViMDJlZWVjOGU0YjQ5ZDg2MjcxYzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d0c966b56a09169a174c36cd7ad3a36e46fa901c", "author": {"user": null}, "url": "https://github.com/spinnaker/kork/commit/d0c966b56a09169a174c36cd7ad3a36e46fa901c", "committedDate": "2020-03-19T16:54:32Z", "message": "feat(configuration): Add support for spring cloud configuration with S3 backend"}, "afterCommit": {"oid": "bceb72794a019811f0c2c8b4bf50b75c95aaac33", "author": {"user": null}, "url": "https://github.com/spinnaker/kork/commit/bceb72794a019811f0c2c8b4bf50b75c95aaac33", "committedDate": "2020-03-20T08:08:20Z", "message": "feat(configuration): Add support for spring cloud configuration with S3 backend"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NTE2OTcx", "url": "https://github.com/spinnaker/kork/pull/563#pullrequestreview-378516971", "createdAt": "2020-03-20T14:12:31Z", "commit": {"oid": "bceb72794a019811f0c2c8b4bf50b75c95aaac33"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDoxMjozMVrOF5VVag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDoxMjozMVrOF5VVag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2MjY5OA==", "bodyText": "Is this needed? I believe if we skip this line, the default credential is used either way.", "url": "https://github.com/spinnaker/kork/pull/563#discussion_r395662698", "createdAt": "2020-03-20T14:12:31Z", "author": {"login": "costimuraru"}, "path": "kork-config/src/main/java/com/netflix/spinnaker/kork/configserver/autoconfig/SpringCloudAwsConfiguration.java", "diffHunk": "@@ -0,0 +1,23 @@\n+package com.netflix.spinnaker.kork.configserver.autoconfig;\n+\n+import com.amazonaws.auth.DefaultAWSCredentialsProviderChain;\n+import com.amazonaws.services.s3.AmazonS3Client;\n+import com.amazonaws.services.s3.AmazonS3ClientBuilder;\n+import org.springframework.cloud.config.server.environment.AwsS3EnvironmentProperties;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Profile;\n+\n+@Profile(\"awss3\")\n+@Configuration\n+class SpringCloudAwsConfiguration {\n+\n+  @Bean\n+  public static AmazonS3Client amazonS3(AwsS3EnvironmentProperties s3EnvironmentProperties) {\n+    return (AmazonS3Client)\n+        AmazonS3ClientBuilder.standard()\n+            .withRegion(s3EnvironmentProperties.getRegion())\n+            .withCredentials(new DefaultAWSCredentialsProviderChain())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bceb72794a019811f0c2c8b4bf50b75c95aaac33"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3OTYwODQx", "url": "https://github.com/spinnaker/kork/pull/563#pullrequestreview-377960841", "createdAt": "2020-03-19T17:53:15Z", "commit": {"oid": "d0c966b56a09169a174c36cd7ad3a36e46fa901c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNzo1MzoxNVrOF45-DQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNzo1MzoyM1rOF45-XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIxNDM0OQ==", "bodyText": "This is unnecessary: The AWS SDK BOM is included just 2 lines up.", "url": "https://github.com/spinnaker/kork/pull/563#discussion_r395214349", "createdAt": "2020-03-19T17:53:15Z", "author": {"login": "robzienert"}, "path": "spinnaker-dependencies/spinnaker-dependencies.gradle", "diffHunk": "@@ -58,6 +58,7 @@ dependencies {\n   api(platform(\"org.springframework.boot:spring-boot-dependencies:${versions.springBoot}\"))\n   api(platform(\"com.amazonaws:aws-java-sdk-bom:${versions.aws}\"))\n   api(platform(\"org.springframework.cloud:spring-cloud-dependencies:${versions.springCloud}\"))\n+  api(platform(\"com.amazonaws:aws-java-sdk-s3:${versions.aws}\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0c966b56a09169a174c36cd7ad3a36e46fa901c"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIxNDQyOA==", "bodyText": "Why?", "url": "https://github.com/spinnaker/kork/pull/563#discussion_r395214428", "createdAt": "2020-03-19T17:53:23Z", "author": {"login": "robzienert"}, "path": "spinnaker-dependencies/spinnaker-dependencies.gradle", "diffHunk": "@@ -123,7 +124,7 @@ dependencies {\n     api(\"commons-io:commons-io:2.5\")\n     api(\"de.danielbechler:java-object-diff:0.95\")\n     api(\"de.huxhorn.sulky:de.huxhorn.sulky.ulid:8.2.0\")\n-    api(\"dev.minutest:minutest:1.11.0\")\n+    api(\"dev.minutest:minutest:1.10.0\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0c966b56a09169a174c36cd7ad3a36e46fa901c"}, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bceb72794a019811f0c2c8b4bf50b75c95aaac33", "author": {"user": null}, "url": "https://github.com/spinnaker/kork/commit/bceb72794a019811f0c2c8b4bf50b75c95aaac33", "committedDate": "2020-03-20T08:08:20Z", "message": "feat(configuration): Add support for spring cloud configuration with S3 backend"}, "afterCommit": {"oid": "a435f5003bdfa37c9c7394c0ded123035ddb57bc", "author": {"user": null}, "url": "https://github.com/spinnaker/kork/commit/a435f5003bdfa37c9c7394c0ded123035ddb57bc", "committedDate": "2020-03-25T19:03:44Z", "message": "Address reviews"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyOTExMDY2", "url": "https://github.com/spinnaker/kork/pull/563#pullrequestreview-382911066", "createdAt": "2020-03-27T14:31:59Z", "commit": {"oid": "a435f5003bdfa37c9c7394c0ded123035ddb57bc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a145d32931e787a4f6836bc3d0e6abf96f899aab", "author": {"user": {"login": "titirigaiulian", "name": "Iulian Titiriga"}}, "url": "https://github.com/spinnaker/kork/commit/a145d32931e787a4f6836bc3d0e6abf96f899aab", "committedDate": "2020-04-14T16:27:13Z", "message": "Merge branch 'master' into master"}, "afterCommit": {"oid": "06daba34dc11230b2b602affb56ba02181cff568", "author": {"user": null}, "url": "https://github.com/spinnaker/kork/commit/06daba34dc11230b2b602affb56ba02181cff568", "committedDate": "2020-06-12T12:25:30Z", "message": "Address reviews"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "06daba34dc11230b2b602affb56ba02181cff568", "author": {"user": null}, "url": "https://github.com/spinnaker/kork/commit/06daba34dc11230b2b602affb56ba02181cff568", "committedDate": "2020-06-12T12:25:30Z", "message": "Address reviews"}, "afterCommit": {"oid": "a792e0b62e6a084a39fada0a833b6375f44f0314", "author": {"user": null}, "url": "https://github.com/spinnaker/kork/commit/a792e0b62e6a084a39fada0a833b6375f44f0314", "committedDate": "2020-06-12T12:30:09Z", "message": "Address reviews"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5OTM5MjY3", "url": "https://github.com/spinnaker/kork/pull/563#pullrequestreview-429939267", "createdAt": "2020-06-12T18:03:16Z", "commit": {"oid": "a792e0b62e6a084a39fada0a833b6375f44f0314"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxODowMzoxN1rOGjNGnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxODowMzoxN1rOGjNGnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU2ODAyOA==", "bodyText": "I believe these should be implementation not api", "url": "https://github.com/spinnaker/kork/pull/563#discussion_r439568028", "createdAt": "2020-06-12T18:03:17Z", "author": {"login": "cfieber"}, "path": "kork-config/kork-config.gradle", "diffHunk": "@@ -11,6 +11,8 @@ dependencies {\n \n   api \"org.springframework.cloud:spring-cloud-context\"\n   api \"org.springframework.cloud:spring-cloud-config-server\"\n+  api \"org.springframework.cloud:spring-cloud-aws-context\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a792e0b62e6a084a39fada0a833b6375f44f0314"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "400282c67d821071d20257fa9077e4a74c40d16e", "author": {"user": null}, "url": "https://github.com/spinnaker/kork/commit/400282c67d821071d20257fa9077e4a74c40d16e", "committedDate": "2020-09-25T09:32:57Z", "message": "feat(configuration): Add support for spring cloud configuration with S3 backend"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c58bf71f6669c86fb55fa9701b4e1ecd17788f78", "author": {"user": null}, "url": "https://github.com/spinnaker/kork/commit/c58bf71f6669c86fb55fa9701b4e1ecd17788f78", "committedDate": "2020-09-25T09:37:55Z", "message": "Address reviews"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a792e0b62e6a084a39fada0a833b6375f44f0314", "author": {"user": null}, "url": "https://github.com/spinnaker/kork/commit/a792e0b62e6a084a39fada0a833b6375f44f0314", "committedDate": "2020-06-12T12:30:09Z", "message": "Address reviews"}, "afterCommit": {"oid": "4d650465fff9fa08644a3fa4291cb428d400a354", "author": {"user": null}, "url": "https://github.com/spinnaker/kork/commit/4d650465fff9fa08644a3fa4291cb428d400a354", "committedDate": "2020-09-28T12:04:03Z", "message": "Rebase + reviews"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e5be9465593f121fdd8a60bd138610a055201f0", "author": {"user": null}, "url": "https://github.com/spinnaker/kork/commit/0e5be9465593f121fdd8a60bd138610a055201f0", "committedDate": "2020-09-28T12:15:47Z", "message": "Rebase + reviews"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4d650465fff9fa08644a3fa4291cb428d400a354", "author": {"user": null}, "url": "https://github.com/spinnaker/kork/commit/4d650465fff9fa08644a3fa4291cb428d400a354", "committedDate": "2020-09-28T12:04:03Z", "message": "Rebase + reviews"}, "afterCommit": {"oid": "0e5be9465593f121fdd8a60bd138610a055201f0", "author": {"user": null}, "url": "https://github.com/spinnaker/kork/commit/0e5be9465593f121fdd8a60bd138610a055201f0", "committedDate": "2020-09-28T12:15:47Z", "message": "Rebase + reviews"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfba47af29fe5063abd089a00a112c3ad05a57bd", "author": {"user": {"login": "titirigaiulian", "name": "Iulian Titiriga"}}, "url": "https://github.com/spinnaker/kork/commit/bfba47af29fe5063abd089a00a112c3ad05a57bd", "committedDate": "2020-09-29T09:17:38Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NzM5MzQx", "url": "https://github.com/spinnaker/kork/pull/563#pullrequestreview-499739341", "createdAt": "2020-09-30T19:19:49Z", "commit": {"oid": "bfba47af29fe5063abd089a00a112c3ad05a57bd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfe76910e46c46f5bd04f48fb1e99c78ff65f772", "author": {"user": {"login": "mergify[bot]", "name": null}}, "url": "https://github.com/spinnaker/kork/commit/bfe76910e46c46f5bd04f48fb1e99c78ff65f772", "committedDate": "2020-09-30T19:20:17Z", "message": "Merge branch 'master' into master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4d3f0dc655f53a363eb02eeec8e4b49d86271c3", "author": {"user": {"login": "mergify[bot]", "name": null}}, "url": "https://github.com/spinnaker/kork/commit/e4d3f0dc655f53a363eb02eeec8e4b49d86271c3", "committedDate": "2020-09-30T19:28:45Z", "message": "Merge branch 'master' into master"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1585, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}