{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4MDY3NTU0", "number": 526, "title": "feat(plugins): Use configured plugin version (falling back to latest if not specified) and check service version requirement constraints", "bodyText": "Todo:\n\n Write tests", "createdAt": "2020-02-21T02:05:56Z", "url": "https://github.com/spinnaker/kork/pull/526", "merged": true, "mergeCommit": {"oid": "ba7858026eb2f6a5352c3cbf13cc94f197708072"}, "closed": true, "closedAt": "2020-02-26T19:29:42Z", "author": {"login": "jonsie"}, "timelineItems": {"totalCount": 33, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGWbK6gBqjMwNTkwNDkyMjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIL3e3AFqTM2NTE3Nzc3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ec35e5aeff691a9c394565d308f3d16794d973a", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/3ec35e5aeff691a9c394565d308f3d16794d973a", "committedDate": "2020-02-21T02:04:21Z", "message": "feat(plugins): Use configured plugin version (falling back to latest if not specified) and check service version requirement constraints"}, "afterCommit": {"oid": "4fa9e20f884b5ff6bca215a17c9a24d1eb4476d7", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/4fa9e20f884b5ff6bca215a17c9a24d1eb4476d7", "committedDate": "2020-02-21T02:36:58Z", "message": "feat(plugins): Use configured plugin version (falling back to latest if not specified) and check service version requirement constraints"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4fa9e20f884b5ff6bca215a17c9a24d1eb4476d7", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/4fa9e20f884b5ff6bca215a17c9a24d1eb4476d7", "committedDate": "2020-02-21T02:36:58Z", "message": "feat(plugins): Use configured plugin version (falling back to latest if not specified) and check service version requirement constraints"}, "afterCommit": {"oid": "98c9ad592fe4275ba33706f8397edf9a6e7ee269", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/98c9ad592fe4275ba33706f8397edf9a6e7ee269", "committedDate": "2020-02-21T02:43:02Z", "message": "feat(plugins): Use configured plugin version (falling back to latest if not specified) and check service version requirement constraints"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "98c9ad592fe4275ba33706f8397edf9a6e7ee269", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/98c9ad592fe4275ba33706f8397edf9a6e7ee269", "committedDate": "2020-02-21T02:43:02Z", "message": "feat(plugins): Use configured plugin version (falling back to latest if not specified) and check service version requirement constraints"}, "afterCommit": {"oid": "311e9537518c06e6fea2bd0b27d8bfa2a42afadb", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/311e9537518c06e6fea2bd0b27d8bfa2a42afadb", "committedDate": "2020-02-21T02:45:17Z", "message": "feat(plugins): Use configured plugin version (falling back to latest if not specified) and check service version requirement constraints"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "311e9537518c06e6fea2bd0b27d8bfa2a42afadb", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/311e9537518c06e6fea2bd0b27d8bfa2a42afadb", "committedDate": "2020-02-21T02:45:17Z", "message": "feat(plugins): Use configured plugin version (falling back to latest if not specified) and check service version requirement constraints"}, "afterCommit": {"oid": "a29b97ef62523b0c1efe79ca38de30fafaa61b43", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/a29b97ef62523b0c1efe79ca38de30fafaa61b43", "committedDate": "2020-02-21T06:21:06Z", "message": "feat(plugins): Use configured plugin version (falling back to latest if not specified) and check service version requirement constraints"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a29b97ef62523b0c1efe79ca38de30fafaa61b43", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/a29b97ef62523b0c1efe79ca38de30fafaa61b43", "committedDate": "2020-02-21T06:21:06Z", "message": "feat(plugins): Use configured plugin version (falling back to latest if not specified) and check service version requirement constraints"}, "afterCommit": {"oid": "0a671422c9844b7db1e099fdc9ea6b4d010ba47d", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/0a671422c9844b7db1e099fdc9ea6b4d010ba47d", "committedDate": "2020-02-21T06:28:44Z", "message": "feat(plugins): Use configured plugin version (falling back to latest if not specified) and check service version requirement constraints"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a671422c9844b7db1e099fdc9ea6b4d010ba47d", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/0a671422c9844b7db1e099fdc9ea6b4d010ba47d", "committedDate": "2020-02-21T06:28:44Z", "message": "feat(plugins): Use configured plugin version (falling back to latest if not specified) and check service version requirement constraints"}, "afterCommit": {"oid": "0811b565afce4a66ade5fb3f1604dcb5caa03774", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/0811b565afce4a66ade5fb3f1604dcb5caa03774", "committedDate": "2020-02-21T06:38:44Z", "message": "feat(plugins): Use configured plugin version (falling back to latest if not specified) and check service version requirement constraints"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0811b565afce4a66ade5fb3f1604dcb5caa03774", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/0811b565afce4a66ade5fb3f1604dcb5caa03774", "committedDate": "2020-02-21T06:38:44Z", "message": "feat(plugins): Use configured plugin version (falling back to latest if not specified) and check service version requirement constraints"}, "afterCommit": {"oid": "43013bb019821981f79dc8cf5c3eaee3103daaea", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/43013bb019821981f79dc8cf5c3eaee3103daaea", "committedDate": "2020-02-21T06:41:52Z", "message": "feat(plugins): Use configured plugin version (falling back to latest if not specified) and check service version requirement constraints"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "43013bb019821981f79dc8cf5c3eaee3103daaea", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/43013bb019821981f79dc8cf5c3eaee3103daaea", "committedDate": "2020-02-21T06:41:52Z", "message": "feat(plugins): Use configured plugin version (falling back to latest if not specified) and check service version requirement constraints"}, "afterCommit": {"oid": "2e6dfb6821a99539ffc56cb05530164f91472767", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/2e6dfb6821a99539ffc56cb05530164f91472767", "committedDate": "2020-02-21T06:44:38Z", "message": "feat(plugins): Use configured plugin version (falling back to latest if not specified) and check service version requirement constraints"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab93205d97031eb9091d601c64eabbdea4c41512", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/ab93205d97031eb9091d601c64eabbdea4c41512", "committedDate": "2020-02-21T06:51:15Z", "message": "feat(plugins): Use configured plugin version (falling back to latest if not specified) and check service version requirement constraints"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e6dfb6821a99539ffc56cb05530164f91472767", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/2e6dfb6821a99539ffc56cb05530164f91472767", "committedDate": "2020-02-21T06:44:38Z", "message": "feat(plugins): Use configured plugin version (falling back to latest if not specified) and check service version requirement constraints"}, "afterCommit": {"oid": "ab93205d97031eb9091d601c64eabbdea4c41512", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/ab93205d97031eb9091d601c64eabbdea4c41512", "committedDate": "2020-02-21T06:51:15Z", "message": "feat(plugins): Use configured plugin version (falling back to latest if not specified) and check service version requirement constraints"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fdb537aa4b46976d8e102979d1c81fcd1869e45", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/0fdb537aa4b46976d8e102979d1c81fcd1869e45", "committedDate": "2020-02-21T18:49:38Z", "message": "fix(plugins): Add PluginNotFoundException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51dd25a8e91b9aaeb2de41eb1d56ab9914f12aeb", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/51dd25a8e91b9aaeb2de41eb1d56ab9914f12aeb", "committedDate": "2020-02-21T19:00:08Z", "message": "fix(plugins): Add PluginDownloadException"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODUwMDA2", "url": "https://github.com/spinnaker/kork/pull/526#pullrequestreview-362850006", "createdAt": "2020-02-21T19:05:03Z", "commit": {"oid": "51dd25a8e91b9aaeb2de41eb1d56ab9914f12aeb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxOTowNTowNFrOFtBb6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxOTowNTowNFrOFtBb6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc1Mzc3MA==", "bodyText": "I don't understand the purpose of this flag. Can't the logic just be something like this:\nval version = attributes.getValue(\"Implementation-OSS-Version\") ?: attributes.getValue(\"Implementation-Version\")", "url": "https://github.com/spinnaker/kork/pull/526#discussion_r382753770", "createdAt": "2020-02-21T19:05:04Z", "author": {"login": "robzienert"}, "path": "kork-core/src/main/java/com/netflix/spinnaker/kork/version/ManifestVersionResolver.java", "diffHunk": "@@ -35,18 +35,28 @@\n  *\n  * <p>This class iterates through matching JARs, rather than looking directly at itself, to support\n  * the use case where OSS services are being extended via a library pattern.\n+ *\n+ * <p>This class also supports reading the custom attribute `Implementation-OSS-Version`. This\n+ * attribute is useful if JARs are built in a process outside the context of OSS, but you need a\n+ * mechanism to get the underlining OSS version.\n  */\n @Slf4j\n public class ManifestVersionResolver implements VersionResolver {\n \n   private static final String GROUP = \"com.netflix.spinnaker\";\n \n   private final String group;\n+  private boolean ossAttribute = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51dd25a8e91b9aaeb2de41eb1d56ab9914f12aeb"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODUxMDY3", "url": "https://github.com/spinnaker/kork/pull/526#pullrequestreview-362851067", "createdAt": "2020-02-21T19:06:47Z", "commit": {"oid": "51dd25a8e91b9aaeb2de41eb1d56ab9914f12aeb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxOTowNjo0OFrOFtBfTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxOTowNjo0OFrOFtBfTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc1NDYzNg==", "bodyText": "Should make this match case insensitive.", "url": "https://github.com/spinnaker/kork/pull/526#discussion_r382754636", "createdAt": "2020-02-21T19:06:48Z", "author": {"login": "robzienert"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/SpinnakerServiceVersionManager.kt", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright 2020 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.netflix.spinnaker.kork.plugins\n+\n+import com.github.zafarkhaja.semver.Version\n+import org.pf4j.VersionManager\n+import org.pf4j.util.StringUtils\n+\n+/**\n+ * Since plugins can require multiple services, this class is necessary to ensure we are making the\n+ * constraint check against the correct service.\n+ */\n+class SpinnakerServiceVersionManager(\n+  private val serviceName: String\n+) : VersionManager {\n+\n+  override fun checkVersionConstraint(version: String, requires: String): Boolean {\n+    val serviceVersionRequirements =\n+      VersionRequirementsParser\n+        .parseAll(requires)\n+        .find { it.service == serviceName }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51dd25a8e91b9aaeb2de41eb1d56ab9914f12aeb"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODUyNjI4", "url": "https://github.com/spinnaker/kork/pull/526#pullrequestreview-362852628", "createdAt": "2020-02-21T19:09:24Z", "commit": {"oid": "51dd25a8e91b9aaeb2de41eb1d56ab9914f12aeb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxOTowOToyNFrOFtBj8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxOTowOToyNFrOFtBj8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc1NTgyNw==", "bodyText": "Hmm, what object is this run on?", "url": "https://github.com/spinnaker/kork/pull/526#discussion_r382755827", "createdAt": "2020-02-21T19:09:24Z", "author": {"login": "robzienert"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/update/PluginDownloadService.kt", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright 2019 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.update\n+\n+import com.netflix.spinnaker.kork.exceptions.IntegrationException\n+import com.netflix.spinnaker.kork.plugins.SpinnakerPluginManager\n+import com.netflix.spinnaker.kork.plugins.SpringPluginStatusProvider\n+import com.netflix.spinnaker.kork.plugins.events.PluginDownloaded\n+import com.netflix.spinnaker.kork.plugins.events.PluginDownloaded.Status.SUCCEEDED\n+import org.pf4j.PluginRuntimeException\n+import org.slf4j.LoggerFactory\n+import org.springframework.context.ApplicationEventPublisher\n+import java.io.File\n+import java.io.IOException\n+import java.lang.UnsupportedOperationException\n+import java.nio.file.Files\n+import java.nio.file.Path\n+import java.nio.file.StandardCopyOption\n+\n+/**\n+ * The [PluginDownloadService] is responsible for downloading the correct plugins from the plugin\n+ * update repositories.\n+ *\n+ * Plugins will not be loaded or started from this service.  All plugin loading and starting occurs\n+ * via [com.netflix.spinnaker.kork.plugins.ExtensionBeanDefinitionRegistryPostProcessor].\n+ *\n+ */\n+class PluginDownloadService(\n+  internal val updateManager: SpinnakerUpdateManager,\n+  internal val pluginManager: SpinnakerPluginManager,\n+  private val pluginStatusProvider: SpringPluginStatusProvider,\n+  private val applicationEventPublisher: ApplicationEventPublisher\n+) {\n+\n+  private val log by lazy { LoggerFactory.getLogger(javaClass) }\n+\n+  /**\n+   * This is the algorithm for determining which plugins to download.\n+   *\n+   * This function first retrieves all available plugins from the plugin info cache.  It then filters\n+   * based on plugins that are enabled in the configuration for the service.  After that, it checks\n+   * the plugin version for the enabled plugin.  If the plugin version does not exist, then the latest\n+   * plugin release is selected.  Otherwise, it checks if the plugin has a version that matches the\n+   * configured plugin version AND the constraint for that version satisfies the service version\n+   * constraint (i.e., orca>=1.0.0 & <2.0.0).\n+   *\n+   * TODO(jonsie): Consider removing the fallback and throwing PluginNotFoundException once\n+   *  plugins are out of beta.\n+   */\n+  internal fun downloadPlugins() {\n+    val availablePlugins = updateManager.availablePlugins as MutableList<SpinnakerPluginInfo>\n+    log.info(\"Found '{}' available plugins\", availablePlugins.size)\n+\n+    availablePlugins\n+      .filter { !pluginStatusProvider.isPluginDisabled(it.id) }\n+      .forEach { enabledPlugin ->\n+        val configuredPluginVersion = pluginStatusProvider.configuredPluginVersion(enabledPlugin.id)\n+\n+        val pluginRelease = if (configuredPluginVersion == null) {\n+          val fallbackRelease = updateManager.getLastPluginRelease(enabledPlugin.id)\n+            ?: throw PluginNotFoundException(enabledPlugin.id, configuredPluginVersion)\n+          run {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51dd25a8e91b9aaeb2de41eb1d56ab9914f12aeb"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODUzMDkw", "url": "https://github.com/spinnaker/kork/pull/526#pullrequestreview-362853090", "createdAt": "2020-02-21T19:10:11Z", "commit": {"oid": "51dd25a8e91b9aaeb2de41eb1d56ab9914f12aeb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxOToxMDoxMVrOFtBlXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxOToxMDoxMVrOFtBlXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc1NjE4OQ==", "bodyText": "Great exception message.", "url": "https://github.com/spinnaker/kork/pull/526#discussion_r382756189", "createdAt": "2020-02-21T19:10:11Z", "author": {"login": "robzienert"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/update/PluginDownloadService.kt", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright 2019 Netflix, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.netflix.spinnaker.kork.plugins.update\n+\n+import com.netflix.spinnaker.kork.exceptions.IntegrationException\n+import com.netflix.spinnaker.kork.plugins.SpinnakerPluginManager\n+import com.netflix.spinnaker.kork.plugins.SpringPluginStatusProvider\n+import com.netflix.spinnaker.kork.plugins.events.PluginDownloaded\n+import com.netflix.spinnaker.kork.plugins.events.PluginDownloaded.Status.SUCCEEDED\n+import org.pf4j.PluginRuntimeException\n+import org.slf4j.LoggerFactory\n+import org.springframework.context.ApplicationEventPublisher\n+import java.io.File\n+import java.io.IOException\n+import java.lang.UnsupportedOperationException\n+import java.nio.file.Files\n+import java.nio.file.Path\n+import java.nio.file.StandardCopyOption\n+\n+/**\n+ * The [PluginDownloadService] is responsible for downloading the correct plugins from the plugin\n+ * update repositories.\n+ *\n+ * Plugins will not be loaded or started from this service.  All plugin loading and starting occurs\n+ * via [com.netflix.spinnaker.kork.plugins.ExtensionBeanDefinitionRegistryPostProcessor].\n+ *\n+ */\n+class PluginDownloadService(\n+  internal val updateManager: SpinnakerUpdateManager,\n+  internal val pluginManager: SpinnakerPluginManager,\n+  private val pluginStatusProvider: SpringPluginStatusProvider,\n+  private val applicationEventPublisher: ApplicationEventPublisher\n+) {\n+\n+  private val log by lazy { LoggerFactory.getLogger(javaClass) }\n+\n+  /**\n+   * This is the algorithm for determining which plugins to download.\n+   *\n+   * This function first retrieves all available plugins from the plugin info cache.  It then filters\n+   * based on plugins that are enabled in the configuration for the service.  After that, it checks\n+   * the plugin version for the enabled plugin.  If the plugin version does not exist, then the latest\n+   * plugin release is selected.  Otherwise, it checks if the plugin has a version that matches the\n+   * configured plugin version AND the constraint for that version satisfies the service version\n+   * constraint (i.e., orca>=1.0.0 & <2.0.0).\n+   *\n+   * TODO(jonsie): Consider removing the fallback and throwing PluginNotFoundException once\n+   *  plugins are out of beta.\n+   */\n+  internal fun downloadPlugins() {\n+    val availablePlugins = updateManager.availablePlugins as MutableList<SpinnakerPluginInfo>\n+    log.info(\"Found '{}' available plugins\", availablePlugins.size)\n+\n+    availablePlugins\n+      .filter { !pluginStatusProvider.isPluginDisabled(it.id) }\n+      .forEach { enabledPlugin ->\n+        val configuredPluginVersion = pluginStatusProvider.configuredPluginVersion(enabledPlugin.id)\n+\n+        val pluginRelease = if (configuredPluginVersion == null) {\n+          val fallbackRelease = updateManager.getLastPluginRelease(enabledPlugin.id)\n+            ?: throw PluginNotFoundException(enabledPlugin.id, configuredPluginVersion)\n+          run {\n+              log.warn(\"'{}' is enabled but does not have a configured version, falling back to \" +\n+                \"version '{}'.\", enabledPlugin.id, fallbackRelease.version)\n+              fallbackRelease\n+          }\n+        } else {\n+          enabledPlugin.getReleases()\n+            .filter { release ->\n+              release.version == configuredPluginVersion\n+            }\n+            .firstOrNull { release ->\n+              pluginManager.versionManager.checkVersionConstraint(release.version, release.requires)\n+            } ?: throw PluginNotFoundException(enabledPlugin.id, configuredPluginVersion)\n+        }\n+\n+        log.debug(\"Downloading plugin '{}' with version '{}'\", enabledPlugin.id, pluginRelease.version)\n+        val downloaded = updateManager.downloadPluginRelease(enabledPlugin.id, pluginRelease.version)\n+        val succeeded = pluginManager.pluginsRoot.write(downloaded)\n+\n+        if (succeeded) {\n+          log.debug(\"Downloaded plugin '{}'\", enabledPlugin.id)\n+          applicationEventPublisher.publishEvent(\n+            PluginDownloaded(this, SUCCEEDED, enabledPlugin.id, pluginRelease.version)\n+          )\n+        } else {\n+          throw PluginDownloadException(enabledPlugin.id, pluginRelease.version)\n+        }\n+      }\n+  }\n+\n+  /**\n+   * Write the plugin, creating the the plugins root directory defined in [pluginManager] if\n+   * necessary.\n+   */\n+  private fun Path.write(downloaded: Path): Boolean {\n+    if (pluginManager.pluginsRoot == this) {\n+      val file = this.resolve(downloaded.fileName)\n+      File(this.toString()).mkdirs()\n+      try {\n+        return Files.move(downloaded, file, StandardCopyOption.REPLACE_EXISTING)\n+          .contains(downloaded.fileName)\n+      } catch (e: IOException) {\n+        throw PluginRuntimeException(e, \"Failed to write file '{}' to plugins folder\", file)\n+      }\n+    } else {\n+      throw UnsupportedOperationException(\"This operation is only supported on the specified plugins root directory.\")\n+    }\n+  }\n+\n+  internal class PluginNotFoundException(pluginId: String, configuredPluginVersion: String?) :\n+    IntegrationException(\n+      \"'$pluginId' is enabled with version '${configuredPluginVersion ?: \"undefined\" }', but a \" +\n+        \"release version could not be found that satisfies the version and/or the service \" +\n+        \"requirement constraints.\"\n+  )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51dd25a8e91b9aaeb2de41eb1d56ab9914f12aeb"}, "originalPosition": 129}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1be4e265364e63e271ca164b02c2d2f9dbe5cce4", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/1be4e265364e63e271ca164b02c2d2f9dbe5cce4", "committedDate": "2020-02-21T20:00:17Z", "message": "fix(plugins): Ignore case, remove unnecessary run block, change oss version logic in ManifestVersionResolver, better comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06a9782238b96ace9d4c1c184ccaeb7af1302dad", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/06a9782238b96ace9d4c1c184ccaeb7af1302dad", "committedDate": "2020-02-21T21:30:29Z", "message": "fix(plugins): Service version resolution configuration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52242677a8fef47d491cc4653c1b4828ae6b3f44", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/52242677a8fef47d491cc4653c1b4828ae6b3f44", "committedDate": "2020-02-21T21:41:40Z", "message": "fix(plugins): Use the Binder API for service resolution boolean instead of ConfigResolver"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03b2dc51217299307d75e9a26470a8efbeb743b9", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/03b2dc51217299307d75e9a26470a8efbeb743b9", "committedDate": "2020-02-21T21:42:19Z", "message": "fix(plugins): Use the Binder API for service resolution boolean instead of ConfigResolver"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ed35718bcaf22e826b71b714511a60b007b8a58", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/3ed35718bcaf22e826b71b714511a60b007b8a58", "committedDate": "2020-02-25T02:51:19Z", "message": "Merge branch 'master' into feat-plugin-versions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9735a2728e66c63301e99f6133014fd71ea0b091", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/9735a2728e66c63301e99f6133014fd71ea0b091", "committedDate": "2020-02-25T18:21:41Z", "message": "fix(plugins): Big refactor to support mutliple mechanisms for determing plugin releases and also pre-existing plugins on the filesystem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6c3a8fcd729e9ac1c113647b6fe5f00f8be2a6c", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/c6c3a8fcd729e9ac1c113647b6fe5f00f8be2a6c", "committedDate": "2020-02-25T18:28:16Z", "message": "fix(plugins): Spotless"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0MzQ4MDYx", "url": "https://github.com/spinnaker/kork/pull/526#pullrequestreview-364348061", "createdAt": "2020-02-25T18:30:26Z", "commit": {"oid": "c6c3a8fcd729e9ac1c113647b6fe5f00f8be2a6c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxODozMDoyNlrOFuQRfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxODozMDoyNlrOFuQRfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA0NTQzNw==", "bodyText": "pluginManager.loadPlugins() needs to run before we download plugins so we know what is loaded and if there is a new version that should be downloaded.", "url": "https://github.com/spinnaker/kork/pull/526#discussion_r384045437", "createdAt": "2020-02-25T18:30:26Z", "author": {"login": "jonsie"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/ExtensionBeanDefinitionRegistryPostProcessor.kt", "diffHunk": "@@ -47,8 +49,10 @@ class ExtensionBeanDefinitionRegistryPostProcessor(\n   override fun postProcessBeanDefinitionRegistry(registry: BeanDefinitionRegistry) {\n     val start = System.currentTimeMillis()\n     log.debug(\"Preparing plugins\")\n-    updateManagerService.checkForUpdates()\n     pluginManager.loadPlugins()\n+    updateManager.downloadPlugins(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6c3a8fcd729e9ac1c113647b6fe5f00f8be2a6c"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a037be30609e3a0b3cb6c863743db0698a05ca8", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/2a037be30609e3a0b3cb6c863743db0698a05ca8", "committedDate": "2020-02-25T19:12:35Z", "message": "Merge branch 'master' into feat-plugin-versions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0MzgwODI1", "url": "https://github.com/spinnaker/kork/pull/526#pullrequestreview-364380825", "createdAt": "2020-02-25T19:18:37Z", "commit": {"oid": "c6c3a8fcd729e9ac1c113647b6fe5f00f8be2a6c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxOToxOTowOFrOFuR5rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNVQxOToxOTozN1rOFuR6gQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3MjEwOA==", "bodyText": "Worded a little confusingly. Perhaps:\n\nDefines what MANIFEST.MF attribute to use in determining a service version. By default, a service version is determined by reading the \"Implementation-Version\" attribute. If this property is set to true, however, \"Implementation-OSS-Version\" will be used to support use cases where services are being extended and rebuilt. Unless you're re-building services, this should remain its default value.", "url": "https://github.com/spinnaker/kork/pull/526#discussion_r384072108", "createdAt": "2020-02-25T19:19:08Z", "author": {"login": "robzienert"}, "path": "kork-plugins/src/main/java/com/netflix/spinnaker/config/PluginsConfigurationProperties.java", "diffHunk": "@@ -98,4 +98,12 @@ public boolean isEnabled() {\n       return enabled;\n     }\n   }\n+\n+  /**\n+   * If set to true, the service version resolution will use the MANIFEST.MF attribute\n+   * \"Implementation-OSS-Version\". By default, this is false which means the version attribute\n+   * lookup will be \"Implementation-Version\" -- for most OSS users that will still be the OSS\n+   * version.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a037be30609e3a0b3cb6c863743db0698a05ca8"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3MjMyMQ==", "bodyText": "Code comment instead of PR comment. That's valuable context that shouldn't require hunting for this PR comment.", "url": "https://github.com/spinnaker/kork/pull/526#discussion_r384072321", "createdAt": "2020-02-25T19:19:37Z", "author": {"login": "robzienert"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/ExtensionBeanDefinitionRegistryPostProcessor.kt", "diffHunk": "@@ -47,8 +49,10 @@ class ExtensionBeanDefinitionRegistryPostProcessor(\n   override fun postProcessBeanDefinitionRegistry(registry: BeanDefinitionRegistry) {\n     val start = System.currentTimeMillis()\n     log.debug(\"Preparing plugins\")\n-    updateManagerService.checkForUpdates()\n     pluginManager.loadPlugins()\n+    updateManager.downloadPlugins(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA0NTQzNw=="}, "originalCommit": {"oid": "c6c3a8fcd729e9ac1c113647b6fe5f00f8be2a6c"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56c3200b169d4509788739d505212f56001da0de", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/56c3200b169d4509788739d505212f56001da0de", "committedDate": "2020-02-25T23:26:06Z", "message": "fix(plugins): Add PropertySourcePluginReleaseProviderTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60bebe9cd79b5896f4c78bd84f3a37e82e34350c", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/60bebe9cd79b5896f4c78bd84f3a37e82e34350c", "committedDate": "2020-02-26T00:03:42Z", "message": "fix(plugins): Slight renaming of things"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NTM5NjQ5", "url": "https://github.com/spinnaker/kork/pull/526#pullrequestreview-364539649", "createdAt": "2020-02-26T00:05:32Z", "commit": {"oid": "60bebe9cd79b5896f4c78bd84f3a37e82e34350c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQwMDowNTozMlrOFuZ23A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQwMDowNTozMlrOFuZ23A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDIwMjQ2MA==", "bodyText": "Feels like steps 1-4 could eventually be broken out into a separate service class - would make it much easier to test.", "url": "https://github.com/spinnaker/kork/pull/526#discussion_r384202460", "createdAt": "2020-02-26T00:05:32Z", "author": {"login": "jonsie"}, "path": "kork-plugins/src/main/kotlin/com/netflix/spinnaker/kork/plugins/ExtensionBeanDefinitionRegistryPostProcessor.kt", "diffHunk": "@@ -47,8 +49,19 @@ class ExtensionBeanDefinitionRegistryPostProcessor(\n   override fun postProcessBeanDefinitionRegistry(registry: BeanDefinitionRegistry) {\n     val start = System.currentTimeMillis()\n     log.debug(\"Preparing plugins\")\n-    updateManagerService.checkForUpdates()\n+\n+    // 1) Load plugins prior to downloading so we can resolve what needs to be updated\n     pluginManager.loadPlugins()\n+\n+    // 2) Determine the plugins for release from the list of available plugins\n+    val releases = pluginInfoReleaseProvider.getReleases(updateManager.availablePlugins)\n+\n+    // 3) Download releases, updating previously loaded plugins where necessary\n+    updateManager.downloadPluginReleases(releases).forEach { pluginPath ->\n+      pluginManager.loadPlugin(pluginPath)\n+    }\n+\n+    // 4) Start plugins - should only be called once in kork-plugins\n     pluginManager.startPlugins()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60bebe9cd79b5896f4c78bd84f3a37e82e34350c"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "340f0b0da28656b25f35f7d54e590aeacb946cc3", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/340f0b0da28656b25f35f7d54e590aeacb946cc3", "committedDate": "2020-02-26T01:15:34Z", "message": "fix(plugins): SpinnakerUpdateManagerTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1dd32e3e631b45cbab52654d4db01385635cfc9", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/b1dd32e3e631b45cbab52654d4db01385635cfc9", "committedDate": "2020-02-26T01:20:32Z", "message": "Merge branch 'master' into feat-plugin-versions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35705cfb644e6f151e4c72bd86dc1c3e9723b7df", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/35705cfb644e6f151e4c72bd86dc1c3e9723b7df", "committedDate": "2020-02-26T01:40:26Z", "message": "fix(plugins): Add another test to SpinnakerUpdateManagerTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MTc3Nzcy", "url": "https://github.com/spinnaker/kork/pull/526#pullrequestreview-365177772", "createdAt": "2020-02-26T19:27:02Z", "commit": {"oid": "35705cfb644e6f151e4c72bd86dc1c3e9723b7df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1562, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}