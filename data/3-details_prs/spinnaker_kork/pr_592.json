{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5NjQ3OTI5", "number": 592, "title": "fix(core): Fix micrometer integration by using spectator-reg-micrometer library", "bodyText": "feature(web): MetricInterceptor to publish equal set of tags; MetricInterceptor now supports publishing query parameters to metrics (extracted from Kayenta)\nWe are using standalone Kayenta in our environment. By default Kayenta is exposing all it's internal metrics into Spectator registry -- currently these metrics are available only on /spectator/metrics endpoint. This PR makes all Spectator metrics to be available for whatever metrics exporter is used in the app. Please also note that this change also exposes all other metrics that were previously not available on /spectator/metrics.", "createdAt": "2020-04-06T13:31:00Z", "url": "https://github.com/spinnaker/kork/pull/592", "merged": true, "mergeCommit": {"oid": "01aae1985e83c55bf802c602c54997bef4ea5efa"}, "closed": true, "closedAt": "2020-04-21T09:38:26Z", "author": {"login": "Aloren"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcU-fknAH2gAyMzk5NjQ3OTI5OjY2NWZkMmJhOWE0YTdlYzcwZmJjY2RhY2ZhNzNjYmUxYWU5YjY3ZmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZwaOygFqTM5NzE2MDUzOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "665fd2ba9a4a7ec70fbccdacfa73cbe1ae9b67fc", "author": {"user": {"login": "Aloren", "name": "Anastasiia Smirnova"}}, "url": "https://github.com/spinnaker/kork/commit/665fd2ba9a4a7ec70fbccdacfa73cbe1ae9b67fc", "committedDate": "2020-04-06T13:13:10Z", "message": "fix(core): Fix micrometer integration by using spectator-reg-micrometer library\nfeature(web): MetricInterceptor to publish equal set of tags; MetricInterceptor now supports publishing query parameters to metrics (extracted from Kayenta)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4MjU3OTAz", "url": "https://github.com/spinnaker/kork/pull/592#pullrequestreview-388257903", "createdAt": "2020-04-06T13:39:27Z", "commit": {"oid": "665fd2ba9a4a7ec70fbccdacfa73cbe1ae9b67fc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMzozOToyN1rOGBYKbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMzozOToyN1rOGBYKbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA5NzY0NA==", "bodyText": "We are exporting our metrics to Prometheus and requirement is that all meters with the same name must have the same set of tag keys. I've used default behavior for this kind of metrics from spring mvc metrics filter. If you guys think this is not backward compatible I could probably make it customizable via property. What do you think?", "url": "https://github.com/spinnaker/kork/pull/592#discussion_r404097644", "createdAt": "2020-04-06T13:39:27Z", "author": {"login": "Aloren"}, "path": "kork-web/src/main/java/com/netflix/spinnaker/kork/web/interceptors/MetricsInterceptor.java", "diffHunk": "@@ -111,13 +127,24 @@ public void afterCompletion(\n       for (String pathVariable : pathVariablesToTag) {\n         if (variables.containsKey(pathVariable)) {\n           id = id.withTag(pathVariable, variables.get(pathVariable).toString());\n+        } else {\n+          id = id.withTag(pathVariable, \"None\");\n+        }\n+      }\n+\n+      for (String queryParamName : queryParamsToTag) {\n+        String parameter = request.getParameter(queryParamName);\n+        if (parameter != null) {\n+          id = id.withTag(queryParamName, parameter);\n+        } else {\n+          id = id.withTag(queryParamName, \"None\");\n         }\n       }\n \n       if (ex != null) {\n         id = id.withTag(\"success\", \"false\").withTag(\"cause\", ex.getClass().getSimpleName());\n       } else {\n-        id = id.withTag(\"success\", \"true\");\n+        id = id.withTag(\"success\", \"true\").withTag(\"cause\", \"None\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "665fd2ba9a4a7ec70fbccdacfa73cbe1ae9b67fc"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09d6c9cf9ee3e32b11b2f9d03252f233a6fc53d5", "author": {"user": {"login": "Aloren", "name": "Anastasiia Smirnova"}}, "url": "https://github.com/spinnaker/kork/commit/09d6c9cf9ee3e32b11b2f9d03252f233a6fc53d5", "committedDate": "2020-04-09T12:51:15Z", "message": "Merge branch 'master' into fix/micrometer-integration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxODE2NzU5", "url": "https://github.com/spinnaker/kork/pull/592#pullrequestreview-391816759", "createdAt": "2020-04-12T02:47:57Z", "commit": {"oid": "09d6c9cf9ee3e32b11b2f9d03252f233a6fc53d5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMjo0Nzo1OFrOGERrxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMlQwMjo0Nzo1OFrOGERrxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzEzNzIyMQ==", "bodyText": "Should be implementation not api", "url": "https://github.com/spinnaker/kork/pull/592#discussion_r407137221", "createdAt": "2020-04-12T02:47:58Z", "author": {"login": "cfieber"}, "path": "kork-core/kork-core.gradle", "diffHunk": "@@ -13,6 +13,7 @@ dependencies {\n   api \"org.springframework.boot:spring-boot-starter-actuator\"\n   api \"com.netflix.eureka:eureka-client\"\n   api \"com.netflix.spectator:spectator-api\"\n+  api \"com.netflix.spectator:spectator-reg-micrometer\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09d6c9cf9ee3e32b11b2f9d03252f233a6fc53d5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17aacdf5fb21781534a19c11a8c6485922296353", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/17aacdf5fb21781534a19c11a8c6485922296353", "committedDate": "2020-04-15T02:43:45Z", "message": "Merge branch 'master' into fix/micrometer-integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb5feb9e2f46d17fd758d5e9de8c57b7d5cabf16", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/eb5feb9e2f46d17fd758d5e9de8c57b7d5cabf16", "committedDate": "2020-04-16T04:13:23Z", "message": "Merge branch 'master' into fix/micrometer-integration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0Mjg4ODQ3", "url": "https://github.com/spinnaker/kork/pull/592#pullrequestreview-394288847", "createdAt": "2020-04-16T04:23:06Z", "commit": {"oid": "17aacdf5fb21781534a19c11a8c6485922296353"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b5fc8b7e664ea5bddf982dd917dcb8c875fe7f4", "author": {"user": {"login": "jonsie", "name": "Chris Smalley"}}, "url": "https://github.com/spinnaker/kork/commit/5b5fc8b7e664ea5bddf982dd917dcb8c875fe7f4", "committedDate": "2020-04-21T05:17:11Z", "message": "Merge branch 'master' into fix/micrometer-integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b281ab00b8d550b35a5d5ece0d00116217a587c", "author": {"user": {"login": "Aloren", "name": "Anastasiia Smirnova"}}, "url": "https://github.com/spinnaker/kork/commit/6b281ab00b8d550b35a5d5ece0d00116217a587c", "committedDate": "2020-04-21T09:15:23Z", "message": "fix(core): Fix micrometer integration by using spectator-reg-micrometer library\nfeature(web): MetricInterceptor to publish equal set of tags; MetricInterceptor now supports publishing query parameters to metrics (extracted from Kayenta)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5f20d94030d816daab9c134632f8095a83bd5eb", "author": {"user": {"login": "Aloren", "name": "Anastasiia Smirnova"}}, "url": "https://github.com/spinnaker/kork/commit/b5f20d94030d816daab9c134632f8095a83bd5eb", "committedDate": "2020-04-21T09:19:09Z", "message": "Merge branch 'fix/micrometer-integration' of https://github.com/Aloren/kork into fix/micrometer-integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d89b031ea87b9678d76b294003af538de14cc11e", "author": {"user": {"login": "Aloren", "name": "Anastasiia Smirnova"}}, "url": "https://github.com/spinnaker/kork/commit/d89b031ea87b9678d76b294003af538de14cc11e", "committedDate": "2020-04-21T09:22:31Z", "message": "fix spectator-reg-micrometer scope"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8daa5b682b35e4e08fb466c470f0ca9488ef24a0", "author": {"user": {"login": "Aloren", "name": "Anastasiia Smirnova"}}, "url": "https://github.com/spinnaker/kork/commit/8daa5b682b35e4e08fb466c470f0ca9488ef24a0", "committedDate": "2020-04-21T09:24:35Z", "message": "Merge branch 'master' into fix/micrometer-integration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MTYwNTM5", "url": "https://github.com/spinnaker/kork/pull/592#pullrequestreview-397160539", "createdAt": "2020-04-21T09:38:17Z", "commit": {"oid": "8daa5b682b35e4e08fb466c470f0ca9488ef24a0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1606, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}