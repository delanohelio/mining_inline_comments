{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5NTE4MjQ0", "number": 3795, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNjo1MTo1M1rODWKgyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMDoyNTozMVrODWNSiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NTY3NDk4OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/cloudstack/agent/lb/IndirectAgentLBServiceImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNjo1MTo1NFrOFaxGjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNjo1MTo1NFrOFaxGjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYxMTc5MQ==", "bodyText": "We can do null checks and if host is removed or is some unsupported state like error etc.?", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363611791", "createdAt": "2020-01-07T06:51:54Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/org/apache/cloudstack/agent/lb/IndirectAgentLBServiceImpl.java", "diffHunk": "@@ -136,17 +144,48 @@ public int compare(Long x, Long y) {\n         }\n         final List <Host> agentBasedHosts = new ArrayList<>();\n         for (final Host host : allHosts) {\n-            if (host == null || host.getResourceState() == ResourceState.Creating || host.getResourceState() == ResourceState.Error) {\n-                continue;\n+            conditionallyAddHost(agentBasedHosts, host);\n+        }\n+        return agentBasedHosts;\n+    }\n+\n+    private void conditionallyAddHost(List<Host> agentBasedHosts, Host host) {\n+        if (host == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5808ad89bf0b41209801848890ad1714540e5532"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NTY3NTk5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/cloudstack/agent/lb/IndirectAgentLBServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNjo1Mjo0MFrOFaxHHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwOTo0MToyNVrOFa0Ufw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYxMTkzNA==", "bodyText": "oh I see it's already here, we could probably do something like item in array where array is list of unsupported states?", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363611934", "createdAt": "2020-01-07T06:52:40Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/org/apache/cloudstack/agent/lb/IndirectAgentLBServiceImpl.java", "diffHunk": "@@ -136,17 +144,48 @@ public int compare(Long x, Long y) {\n         }\n         final List <Host> agentBasedHosts = new ArrayList<>();\n         for (final Host host : allHosts) {\n-            if (host == null || host.getResourceState() == ResourceState.Creating || host.getResourceState() == ResourceState.Error) {\n-                continue;\n+            conditionallyAddHost(agentBasedHosts, host);\n+        }\n+        return agentBasedHosts;\n+    }\n+\n+    private void conditionallyAddHost(List<Host> agentBasedHosts, Host host) {\n+        if (host == null) {\n+            if (LOG.isTraceEnabled()) {\n+                LOG.trace(\"trying to add no host to a list\");\n             }\n-            if (host.getType() == Host.Type.Routing || host.getType() == Host.Type.ConsoleProxy || host.getType() == Host.Type.SecondaryStorage || host.getType() == Host.Type.SecondaryStorageVM) {\n-                if (host.getHypervisorType() != null && host.getHypervisorType() != Hypervisor.HypervisorType.KVM && host.getHypervisorType() != Hypervisor.HypervisorType.LXC) {\n-                    continue;\n-                }\n-                agentBasedHosts.add(host);\n+            return;\n+        }\n+        if (host.getResourceState() == ResourceState.Creating) {\n+            if (LOG.isTraceEnabled()) {\n+                LOG.trace(String.format(\"host is in creating state, not adding to the host list, (id = %s)\", host.getUuid()));\n             }\n+            return;\n         }\n-        return agentBasedHosts;\n+        if (host.getResourceState() == ResourceState.Error) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5808ad89bf0b41209801848890ad1714540e5532"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY2NDUxMQ==", "bodyText": "refactorred have a look, @rhtyd . I think it is cosmetic but it does make a point.", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363664511", "createdAt": "2020-01-07T09:41:25Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/org/apache/cloudstack/agent/lb/IndirectAgentLBServiceImpl.java", "diffHunk": "@@ -136,17 +144,48 @@ public int compare(Long x, Long y) {\n         }\n         final List <Host> agentBasedHosts = new ArrayList<>();\n         for (final Host host : allHosts) {\n-            if (host == null || host.getResourceState() == ResourceState.Creating || host.getResourceState() == ResourceState.Error) {\n-                continue;\n+            conditionallyAddHost(agentBasedHosts, host);\n+        }\n+        return agentBasedHosts;\n+    }\n+\n+    private void conditionallyAddHost(List<Host> agentBasedHosts, Host host) {\n+        if (host == null) {\n+            if (LOG.isTraceEnabled()) {\n+                LOG.trace(\"trying to add no host to a list\");\n             }\n-            if (host.getType() == Host.Type.Routing || host.getType() == Host.Type.ConsoleProxy || host.getType() == Host.Type.SecondaryStorage || host.getType() == Host.Type.SecondaryStorageVM) {\n-                if (host.getHypervisorType() != null && host.getHypervisorType() != Hypervisor.HypervisorType.KVM && host.getHypervisorType() != Hypervisor.HypervisorType.LXC) {\n-                    continue;\n-                }\n-                agentBasedHosts.add(host);\n+            return;\n+        }\n+        if (host.getResourceState() == ResourceState.Creating) {\n+            if (LOG.isTraceEnabled()) {\n+                LOG.trace(String.format(\"host is in creating state, not adding to the host list, (id = %s)\", host.getUuid()));\n             }\n+            return;\n         }\n-        return agentBasedHosts;\n+        if (host.getResourceState() == ResourceState.Error) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYxMTkzNA=="}, "originalCommit": {"oid": "5808ad89bf0b41209801848890ad1714540e5532"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NjEyOTIzOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/cloudstack/agent/lb/IndirectAgentLBServiceImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMDoyNToxNVrOFa1bBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMDoyNToxNVrOFa1bBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4MjU2NQ==", "bodyText": "Why not use Arrays.asList()?", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363682565", "createdAt": "2020-01-07T10:25:15Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/org/apache/cloudstack/agent/lb/IndirectAgentLBServiceImpl.java", "diffHunk": "@@ -136,17 +146,54 @@ public int compare(Long x, Long y) {\n         }\n         final List <Host> agentBasedHosts = new ArrayList<>();\n         for (final Host host : allHosts) {\n-            if (host == null || host.getResourceState() == ResourceState.Creating || host.getResourceState() == ResourceState.Error) {\n-                continue;\n+            conditionallyAddHost(agentBasedHosts, host);\n+        }\n+        return agentBasedHosts;\n+    }\n+\n+    private void conditionallyAddHost(List<Host> agentBasedHosts, Host host) {\n+        if (host == null) {\n+            if (LOG.isTraceEnabled()) {\n+                LOG.trace(\"trying to add no host to a list\");\n             }\n-            if (host.getType() == Host.Type.Routing || host.getType() == Host.Type.ConsoleProxy || host.getType() == Host.Type.SecondaryStorage || host.getType() == Host.Type.SecondaryStorageVM) {\n-                if (host.getHypervisorType() != null && host.getHypervisorType() != Hypervisor.HypervisorType.KVM && host.getHypervisorType() != Hypervisor.HypervisorType.LXC) {\n-                    continue;\n-                }\n-                agentBasedHosts.add(host);\n+            return;\n+        }\n+\n+        ResourceState[] allowedStates = new ResourceState[]{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5735e6eaecca28258f31db93c482f927647f5024"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NjEzMDAwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/apache/cloudstack/agent/lb/IndirectAgentLBServiceImpl.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMDoyNTozMVrOFa1bfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNDowNDo0OFrOFa6RHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4MjY4Nw==", "bodyText": "Why not use list.contains()?", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363682687", "createdAt": "2020-01-07T10:25:31Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/org/apache/cloudstack/agent/lb/IndirectAgentLBServiceImpl.java", "diffHunk": "@@ -136,17 +146,54 @@ public int compare(Long x, Long y) {\n         }\n         final List <Host> agentBasedHosts = new ArrayList<>();\n         for (final Host host : allHosts) {\n-            if (host == null || host.getResourceState() == ResourceState.Creating || host.getResourceState() == ResourceState.Error) {\n-                continue;\n+            conditionallyAddHost(agentBasedHosts, host);\n+        }\n+        return agentBasedHosts;\n+    }\n+\n+    private void conditionallyAddHost(List<Host> agentBasedHosts, Host host) {\n+        if (host == null) {\n+            if (LOG.isTraceEnabled()) {\n+                LOG.trace(\"trying to add no host to a list\");\n             }\n-            if (host.getType() == Host.Type.Routing || host.getType() == Host.Type.ConsoleProxy || host.getType() == Host.Type.SecondaryStorage || host.getType() == Host.Type.SecondaryStorageVM) {\n-                if (host.getHypervisorType() != null && host.getHypervisorType() != Hypervisor.HypervisorType.KVM && host.getHypervisorType() != Hypervisor.HypervisorType.LXC) {\n-                    continue;\n-                }\n-                agentBasedHosts.add(host);\n+            return;\n+        }\n+\n+        ResourceState[] allowedStates = new ResourceState[]{\n+                ResourceState.Enabled,\n+                ResourceState.Maintenance,\n+                ResourceState.Disabled,\n+                ResourceState.ErrorInMaintenance,\n+                ResourceState.PrepareForMaintenance\n+        };\n+        // so the remaining ResourceState[] disallowedStates = new ResourceState[]{ResourceState.Creating, ResourceState.Error};\n+        if (binarySearch(allowedStates, host.getResourceState()) < 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5735e6eaecca28258f31db93c482f927647f5024"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzcwMDI2MQ==", "bodyText": "seems like less cpu power/more code?", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363700261", "createdAt": "2020-01-07T11:11:39Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/org/apache/cloudstack/agent/lb/IndirectAgentLBServiceImpl.java", "diffHunk": "@@ -136,17 +146,54 @@ public int compare(Long x, Long y) {\n         }\n         final List <Host> agentBasedHosts = new ArrayList<>();\n         for (final Host host : allHosts) {\n-            if (host == null || host.getResourceState() == ResourceState.Creating || host.getResourceState() == ResourceState.Error) {\n-                continue;\n+            conditionallyAddHost(agentBasedHosts, host);\n+        }\n+        return agentBasedHosts;\n+    }\n+\n+    private void conditionallyAddHost(List<Host> agentBasedHosts, Host host) {\n+        if (host == null) {\n+            if (LOG.isTraceEnabled()) {\n+                LOG.trace(\"trying to add no host to a list\");\n             }\n-            if (host.getType() == Host.Type.Routing || host.getType() == Host.Type.ConsoleProxy || host.getType() == Host.Type.SecondaryStorage || host.getType() == Host.Type.SecondaryStorageVM) {\n-                if (host.getHypervisorType() != null && host.getHypervisorType() != Hypervisor.HypervisorType.KVM && host.getHypervisorType() != Hypervisor.HypervisorType.LXC) {\n-                    continue;\n-                }\n-                agentBasedHosts.add(host);\n+            return;\n+        }\n+\n+        ResourceState[] allowedStates = new ResourceState[]{\n+                ResourceState.Enabled,\n+                ResourceState.Maintenance,\n+                ResourceState.Disabled,\n+                ResourceState.ErrorInMaintenance,\n+                ResourceState.PrepareForMaintenance\n+        };\n+        // so the remaining ResourceState[] disallowedStates = new ResourceState[]{ResourceState.Creating, ResourceState.Error};\n+        if (binarySearch(allowedStates, host.getResourceState()) < 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4MjY4Nw=="}, "originalCommit": {"oid": "5735e6eaecca28258f31db93c482f927647f5024"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc0NzUxMQ==", "bodyText": "@rhtyd ?", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363747511", "createdAt": "2020-01-07T13:30:52Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/org/apache/cloudstack/agent/lb/IndirectAgentLBServiceImpl.java", "diffHunk": "@@ -136,17 +146,54 @@ public int compare(Long x, Long y) {\n         }\n         final List <Host> agentBasedHosts = new ArrayList<>();\n         for (final Host host : allHosts) {\n-            if (host == null || host.getResourceState() == ResourceState.Creating || host.getResourceState() == ResourceState.Error) {\n-                continue;\n+            conditionallyAddHost(agentBasedHosts, host);\n+        }\n+        return agentBasedHosts;\n+    }\n+\n+    private void conditionallyAddHost(List<Host> agentBasedHosts, Host host) {\n+        if (host == null) {\n+            if (LOG.isTraceEnabled()) {\n+                LOG.trace(\"trying to add no host to a list\");\n             }\n-            if (host.getType() == Host.Type.Routing || host.getType() == Host.Type.ConsoleProxy || host.getType() == Host.Type.SecondaryStorage || host.getType() == Host.Type.SecondaryStorageVM) {\n-                if (host.getHypervisorType() != null && host.getHypervisorType() != Hypervisor.HypervisorType.KVM && host.getHypervisorType() != Hypervisor.HypervisorType.LXC) {\n-                    continue;\n-                }\n-                agentBasedHosts.add(host);\n+            return;\n+        }\n+\n+        ResourceState[] allowedStates = new ResourceState[]{\n+                ResourceState.Enabled,\n+                ResourceState.Maintenance,\n+                ResourceState.Disabled,\n+                ResourceState.ErrorInMaintenance,\n+                ResourceState.PrepareForMaintenance\n+        };\n+        // so the remaining ResourceState[] disallowedStates = new ResourceState[]{ResourceState.Creating, ResourceState.Error};\n+        if (binarySearch(allowedStates, host.getResourceState()) < 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4MjY4Nw=="}, "originalCommit": {"oid": "5735e6eaecca28258f31db93c482f927647f5024"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc1MzM1MA==", "bodyText": "@DaanHoogland premature optimisation is... nope there won't be a lot of performance gain. If you have to you can use Collections.binarySearch()", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363753350", "createdAt": "2020-01-07T13:45:25Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/org/apache/cloudstack/agent/lb/IndirectAgentLBServiceImpl.java", "diffHunk": "@@ -136,17 +146,54 @@ public int compare(Long x, Long y) {\n         }\n         final List <Host> agentBasedHosts = new ArrayList<>();\n         for (final Host host : allHosts) {\n-            if (host == null || host.getResourceState() == ResourceState.Creating || host.getResourceState() == ResourceState.Error) {\n-                continue;\n+            conditionallyAddHost(agentBasedHosts, host);\n+        }\n+        return agentBasedHosts;\n+    }\n+\n+    private void conditionallyAddHost(List<Host> agentBasedHosts, Host host) {\n+        if (host == null) {\n+            if (LOG.isTraceEnabled()) {\n+                LOG.trace(\"trying to add no host to a list\");\n             }\n-            if (host.getType() == Host.Type.Routing || host.getType() == Host.Type.ConsoleProxy || host.getType() == Host.Type.SecondaryStorage || host.getType() == Host.Type.SecondaryStorageVM) {\n-                if (host.getHypervisorType() != null && host.getHypervisorType() != Hypervisor.HypervisorType.KVM && host.getHypervisorType() != Hypervisor.HypervisorType.LXC) {\n-                    continue;\n-                }\n-                agentBasedHosts.add(host);\n+            return;\n+        }\n+\n+        ResourceState[] allowedStates = new ResourceState[]{\n+                ResourceState.Enabled,\n+                ResourceState.Maintenance,\n+                ResourceState.Disabled,\n+                ResourceState.ErrorInMaintenance,\n+                ResourceState.PrepareForMaintenance\n+        };\n+        // so the remaining ResourceState[] disallowedStates = new ResourceState[]{ResourceState.Creating, ResourceState.Error};\n+        if (binarySearch(allowedStates, host.getResourceState()) < 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4MjY4Nw=="}, "originalCommit": {"oid": "5735e6eaecca28258f31db93c482f927647f5024"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc2MTk0OQ==", "bodyText": "ok, it felt quite natural to me, but will use an EnumSet.contains().", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363761949", "createdAt": "2020-01-07T14:04:48Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/org/apache/cloudstack/agent/lb/IndirectAgentLBServiceImpl.java", "diffHunk": "@@ -136,17 +146,54 @@ public int compare(Long x, Long y) {\n         }\n         final List <Host> agentBasedHosts = new ArrayList<>();\n         for (final Host host : allHosts) {\n-            if (host == null || host.getResourceState() == ResourceState.Creating || host.getResourceState() == ResourceState.Error) {\n-                continue;\n+            conditionallyAddHost(agentBasedHosts, host);\n+        }\n+        return agentBasedHosts;\n+    }\n+\n+    private void conditionallyAddHost(List<Host> agentBasedHosts, Host host) {\n+        if (host == null) {\n+            if (LOG.isTraceEnabled()) {\n+                LOG.trace(\"trying to add no host to a list\");\n             }\n-            if (host.getType() == Host.Type.Routing || host.getType() == Host.Type.ConsoleProxy || host.getType() == Host.Type.SecondaryStorage || host.getType() == Host.Type.SecondaryStorageVM) {\n-                if (host.getHypervisorType() != null && host.getHypervisorType() != Hypervisor.HypervisorType.KVM && host.getHypervisorType() != Hypervisor.HypervisorType.LXC) {\n-                    continue;\n-                }\n-                agentBasedHosts.add(host);\n+            return;\n+        }\n+\n+        ResourceState[] allowedStates = new ResourceState[]{\n+                ResourceState.Enabled,\n+                ResourceState.Maintenance,\n+                ResourceState.Disabled,\n+                ResourceState.ErrorInMaintenance,\n+                ResourceState.PrepareForMaintenance\n+        };\n+        // so the remaining ResourceState[] disallowedStates = new ResourceState[]{ResourceState.Creating, ResourceState.Error};\n+        if (binarySearch(allowedStates, host.getResourceState()) < 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4MjY4Nw=="}, "originalCommit": {"oid": "5735e6eaecca28258f31db93c482f927647f5024"}, "originalPosition": 56}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3988, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}