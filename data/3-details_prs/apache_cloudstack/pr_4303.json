{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4NjQ5NjEy", "number": 4303, "title": "Ubuntu 20.04: Fix systemvm cannot start up", "bodyText": "Description\n\nWhen use Ubuntu 20.04 as hypervisor, and create an advanced zone with security groups, the systemvms (ssvm and cpvm) are started but the cloud service is not be Up.\nin /var/log/cloud.log, it says vm is unable to connect to management server on port 8250.\nLater I found there is caused by a iptables rule below\n-A BF-cloudbr0 -m physdev --physdev-out ens3: --physdev-is-bridged -j ACCEPT\n\nThe physical device should be \"ens3\" and \"ens3:\", which comes from\nroot@node62:~# bridge -o link show | awk '/master cloudbr0 / && !/^[0-9]+: vnet/ {print $2}' | head -1\nens3:\n\nThere is no issue with ubuntu 16.04\nroot@node12:~# bridge -o link show | awk '/master cloudbr0 / && !/^[0-9]+: vnet/ {print $2}' | head -1\neth0\n\n\n\n\n\n\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?", "createdAt": "2020-09-03T13:53:05Z", "url": "https://github.com/apache/cloudstack/pull/4303", "merged": true, "mergeCommit": {"oid": "00ceafe47fd9ff4e147c94a9f5b77b2fa7d74b7e"}, "closed": true, "closedAt": "2020-09-22T15:26:55Z", "author": {"login": "ustcweizhou"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFQ1sRgH2gAyNDc4NjQ5NjEyOjFhZmI4YmJiYzhkOTc2NjdlYWI5YWRhY2QyMzc3MzBmMzJlYzIzMTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLXY6nAFqTQ5MzQxOTA0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1afb8bbbc8d97667eab9adacd237730f32ec2316", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/1afb8bbbc8d97667eab9adacd237730f32ec2316", "committedDate": "2020-09-03T13:43:59Z", "message": "security_group.py: fix SyntaxWarning: \"is\" with a literal.\n\n2020-04-27 09:43:54,172 DEBUG [kvm.resource.LibvirtComputingResource] (Agent-Handler-2:null) (logid:c33ba330) /usr/share/cloudstack-common/scripts/vm/network/security_group.py:513: SyntaxWarning: \"is\" with a literal. Did you mean \"==\"?\n  if rules is None or rules is \"\":\n/usr/share/cloudstack-common/scripts/vm/network/security_group.py:522: SyntaxWarning: \"is\" with a literal. Did you mean \"==\"?\n  if rules is None or rules is \"\":\n/usr/share/cloudstack-common/scripts/vm/network/security_group.py:823: SyntaxWarning: \"is\" with a literal. Did you mean \"==\"?\n  if brName is None or brName is \"\":"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76f0e3fa1a295f27d15d87751bd3fd148ea0f1c3", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/76f0e3fa1a295f27d15d87751bd3fd148ea0f1c3", "committedDate": "2020-09-03T13:44:05Z", "message": "Ubuntu 20.04: Fix systemvm cannot start up\n\nin Ubuntu 16.04:\n\nroot@node13:~# bridge -o link show\n2: eth0 state UP : <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master cloudbr0 state forwarding priority 32 cost 100\n5: vnet0 state UNKNOWN : <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master cloud0 state forwarding priority 32 cost 100\n6: vnet1 state UNKNOWN : <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master cloudbr0 state forwarding priority 32 cost 100\n7: vnet2 state UNKNOWN : <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master cloudbr0 state forwarding priority 32 cost 100\n\nroot@node13:~# bridge -o link show | awk '/master cloudbr0 / && !/^[0-9]+: vnet/ {print $2}' | head -1\neth0\n\nroot@node13:~# bridge -o link show | awk '/master cloudbr0 / && !/^[0-9]+: vnet/ {print $2}' | head -1 |cut -d \":\" -f1\neth0\n\nin Ubuntu 20.04:\n\nroot@node62:~# bridge -o link show\n2: ens3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master cloudbr0 state forwarding priority 32 cost 100\n10: vnet3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master cloud0 state forwarding priority 32 cost 100\n11: vnet4: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master cloudbr0 state forwarding priority 32 cost 100\n12: vnet5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master cloudbr0 state forwarding priority 32 cost 100\n\nroot@node62:~# bridge -o link show | awk '/master cloudbr0 / && !/^[0-9]+: vnet/ {print $2}' | head -1\nens3:\n\nroot@node62:~# bridge -o link show | awk '/master cloudbr0 / && !/^[0-9]+: vnet/ {print $2}' | head -1 |cut -d ':' -f1\nens3"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNDQ5OTQz", "url": "https://github.com/apache/cloudstack/pull/4303#pullrequestreview-482449943", "createdAt": "2020-09-04T08:12:54Z", "commit": {"oid": "76f0e3fa1a295f27d15d87751bd3fd148ea0f1c3"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwODoxMjo1NFrOHNEGcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQwODoxMzo1NVrOHNEIrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ2MDcyMw==", "bodyText": "Maybe better to change this to:\nif not rules:\nThat captures the None and empty string case right away.", "url": "https://github.com/apache/cloudstack/pull/4303#discussion_r483460723", "createdAt": "2020-09-04T08:12:54Z", "author": {"login": "wido"}, "path": "scripts/vm/network/security_group.py", "diffHunk": "@@ -510,7 +510,7 @@ def check_default_network_rules(vm_name, vm_id, vm_ip, vm_ip6, vm_mac, vif, brna\n         rules = execute(\"iptables-save |grep -w %s |grep -w %s |grep -w %s\" % (brfw, vif, vmchain_default))\n     except:\n         rules = None\n-    if rules is None or rules is \"\":\n+    if rules is None or rules == \"\":", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76f0e3fa1a295f27d15d87751bd3fd148ea0f1c3"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzQ2MTI5Mg==", "bodyText": "Do we know what changed in Ubuntu 20.04? As the '-o' flag should make it stable to use on the CLI", "url": "https://github.com/apache/cloudstack/pull/4303#discussion_r483461292", "createdAt": "2020-09-04T08:13:55Z", "author": {"login": "wido"}, "path": "scripts/vm/network/security_group.py", "diffHunk": "@@ -185,7 +185,7 @@ def destroy_network_rules_for_nic(vm_name, vm_ip, vm_mac, vif, sec_ips):\n         logging.debug(\"Ignoring failure to delete ebtable rules for vm: \" + vm_name)\n \n def get_bridge_physdev(brname):\n-    physdev = execute(\"bridge -o link show | awk '/master %s / && !/^[0-9]+: vnet/ {print $2}' | head -1\" % brname)\n+    physdev = execute(\"bridge -o link show | awk '/master %s / && !/^[0-9]+: vnet/ {print $2}' | head -1 | cut -d ':' -f1\" % brname)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76f0e3fa1a295f27d15d87751bd3fd148ea0f1c3"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d21db449d80ca5452dd53b638cf458228cf5232", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/3d21db449d80ca5452dd53b638cf458228cf5232", "committedDate": "2020-09-04T08:56:28Z", "message": "security_group.py: use 'if not' instead"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNDE5MDQ1", "url": "https://github.com/apache/cloudstack/pull/4303#pullrequestreview-493419045", "createdAt": "2020-09-22T12:45:26Z", "commit": {"oid": "3d21db449d80ca5452dd53b638cf458228cf5232"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4104, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}