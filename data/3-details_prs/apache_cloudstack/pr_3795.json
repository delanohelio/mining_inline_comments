{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5NTE4MjQ0", "number": 3795, "title": "Agent lb on svm", "bodyText": "Description\n\nIf a host is not in the list of hosts and an agent load balancing list is required for it, add it to the list to get a valid MSlist.\n\n\n\n\n\nFixes: #3722\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?", "createdAt": "2020-01-06T12:13:09Z", "url": "https://github.com/apache/cloudstack/pull/3795", "merged": true, "mergeCommit": {"oid": "6ebd02e7af2dfdfbd54728f367464eba2cec8ca5"}, "closed": true, "closedAt": "2020-01-14T14:40:21Z", "author": {"login": "DaanHoogland"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb3qyf2AH2gAyMzU5NTE4MjQ0OmQzOTJlNmFkMjM2MjI1OTAzNjRiOWZlYjM2ZTdiNTJkMjUxYzUyMDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6R-ETgFqTM0MjU3OTIxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d392e6ad23622590364b9feb36e7b52d251c5205", "author": {"user": {"login": "DaanHoogland", "name": "dahn"}}, "url": "https://github.com/apache/cloudstack/commit/d392e6ad23622590364b9feb36e7b52d251c5205", "committedDate": "2020-01-06T11:51:56Z", "message": "add host if needed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5808ad89bf0b41209801848890ad1714540e5532", "author": {"user": {"login": "DaanHoogland", "name": "dahn"}}, "url": "https://github.com/apache/cloudstack/commit/5808ad89bf0b41209801848890ad1714540e5532", "committedDate": "2020-01-06T13:33:07Z", "message": "allow for test with null-host"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MDU2Nzcy", "url": "https://github.com/apache/cloudstack/pull/3795#pullrequestreview-339056772", "createdAt": "2020-01-07T06:51:53Z", "commit": {"oid": "5808ad89bf0b41209801848890ad1714540e5532"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNjo1MTo1NFrOFaxGjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNjo1MTo1NFrOFaxGjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYxMTc5MQ==", "bodyText": "We can do null checks and if host is removed or is some unsupported state like error etc.?", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363611791", "createdAt": "2020-01-07T06:51:54Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/org/apache/cloudstack/agent/lb/IndirectAgentLBServiceImpl.java", "diffHunk": "@@ -136,17 +144,48 @@ public int compare(Long x, Long y) {\n         }\n         final List <Host> agentBasedHosts = new ArrayList<>();\n         for (final Host host : allHosts) {\n-            if (host == null || host.getResourceState() == ResourceState.Creating || host.getResourceState() == ResourceState.Error) {\n-                continue;\n+            conditionallyAddHost(agentBasedHosts, host);\n+        }\n+        return agentBasedHosts;\n+    }\n+\n+    private void conditionallyAddHost(List<Host> agentBasedHosts, Host host) {\n+        if (host == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5808ad89bf0b41209801848890ad1714540e5532"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MDU2OTYy", "url": "https://github.com/apache/cloudstack/pull/3795#pullrequestreview-339056962", "createdAt": "2020-01-07T06:52:40Z", "commit": {"oid": "5808ad89bf0b41209801848890ad1714540e5532"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNjo1Mjo0MFrOFaxHHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNjo1Mjo0MFrOFaxHHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzYxMTkzNA==", "bodyText": "oh I see it's already here, we could probably do something like item in array where array is list of unsupported states?", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363611934", "createdAt": "2020-01-07T06:52:40Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/org/apache/cloudstack/agent/lb/IndirectAgentLBServiceImpl.java", "diffHunk": "@@ -136,17 +144,48 @@ public int compare(Long x, Long y) {\n         }\n         final List <Host> agentBasedHosts = new ArrayList<>();\n         for (final Host host : allHosts) {\n-            if (host == null || host.getResourceState() == ResourceState.Creating || host.getResourceState() == ResourceState.Error) {\n-                continue;\n+            conditionallyAddHost(agentBasedHosts, host);\n+        }\n+        return agentBasedHosts;\n+    }\n+\n+    private void conditionallyAddHost(List<Host> agentBasedHosts, Host host) {\n+        if (host == null) {\n+            if (LOG.isTraceEnabled()) {\n+                LOG.trace(\"trying to add no host to a list\");\n             }\n-            if (host.getType() == Host.Type.Routing || host.getType() == Host.Type.ConsoleProxy || host.getType() == Host.Type.SecondaryStorage || host.getType() == Host.Type.SecondaryStorageVM) {\n-                if (host.getHypervisorType() != null && host.getHypervisorType() != Hypervisor.HypervisorType.KVM && host.getHypervisorType() != Hypervisor.HypervisorType.LXC) {\n-                    continue;\n-                }\n-                agentBasedHosts.add(host);\n+            return;\n+        }\n+        if (host.getResourceState() == ResourceState.Creating) {\n+            if (LOG.isTraceEnabled()) {\n+                LOG.trace(String.format(\"host is in creating state, not adding to the host list, (id = %s)\", host.getUuid()));\n             }\n+            return;\n         }\n-        return agentBasedHosts;\n+        if (host.getResourceState() == ResourceState.Error) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5808ad89bf0b41209801848890ad1714540e5532"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5735e6eaecca28258f31db93c482f927647f5024", "author": {"user": {"login": "DaanHoogland", "name": "dahn"}}, "url": "https://github.com/apache/cloudstack/commit/5735e6eaecca28258f31db93c482f927647f5024", "committedDate": "2020-01-07T09:38:06Z", "message": "full coverage of states"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MTUwMDM5", "url": "https://github.com/apache/cloudstack/pull/3795#pullrequestreview-339150039", "createdAt": "2020-01-07T10:25:15Z", "commit": {"oid": "5735e6eaecca28258f31db93c482f927647f5024"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMDoyNToxNVrOFa1bBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMDoyNToxNVrOFa1bBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4MjU2NQ==", "bodyText": "Why not use Arrays.asList()?", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363682565", "createdAt": "2020-01-07T10:25:15Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/org/apache/cloudstack/agent/lb/IndirectAgentLBServiceImpl.java", "diffHunk": "@@ -136,17 +146,54 @@ public int compare(Long x, Long y) {\n         }\n         final List <Host> agentBasedHosts = new ArrayList<>();\n         for (final Host host : allHosts) {\n-            if (host == null || host.getResourceState() == ResourceState.Creating || host.getResourceState() == ResourceState.Error) {\n-                continue;\n+            conditionallyAddHost(agentBasedHosts, host);\n+        }\n+        return agentBasedHosts;\n+    }\n+\n+    private void conditionallyAddHost(List<Host> agentBasedHosts, Host host) {\n+        if (host == null) {\n+            if (LOG.isTraceEnabled()) {\n+                LOG.trace(\"trying to add no host to a list\");\n             }\n-            if (host.getType() == Host.Type.Routing || host.getType() == Host.Type.ConsoleProxy || host.getType() == Host.Type.SecondaryStorage || host.getType() == Host.Type.SecondaryStorageVM) {\n-                if (host.getHypervisorType() != null && host.getHypervisorType() != Hypervisor.HypervisorType.KVM && host.getHypervisorType() != Hypervisor.HypervisorType.LXC) {\n-                    continue;\n-                }\n-                agentBasedHosts.add(host);\n+            return;\n+        }\n+\n+        ResourceState[] allowedStates = new ResourceState[]{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5735e6eaecca28258f31db93c482f927647f5024"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MTUwMTk3", "url": "https://github.com/apache/cloudstack/pull/3795#pullrequestreview-339150197", "createdAt": "2020-01-07T10:25:31Z", "commit": {"oid": "5735e6eaecca28258f31db93c482f927647f5024"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMDoyNTozMVrOFa1bfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMDoyNTozMVrOFa1bfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzY4MjY4Nw==", "bodyText": "Why not use list.contains()?", "url": "https://github.com/apache/cloudstack/pull/3795#discussion_r363682687", "createdAt": "2020-01-07T10:25:31Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/org/apache/cloudstack/agent/lb/IndirectAgentLBServiceImpl.java", "diffHunk": "@@ -136,17 +146,54 @@ public int compare(Long x, Long y) {\n         }\n         final List <Host> agentBasedHosts = new ArrayList<>();\n         for (final Host host : allHosts) {\n-            if (host == null || host.getResourceState() == ResourceState.Creating || host.getResourceState() == ResourceState.Error) {\n-                continue;\n+            conditionallyAddHost(agentBasedHosts, host);\n+        }\n+        return agentBasedHosts;\n+    }\n+\n+    private void conditionallyAddHost(List<Host> agentBasedHosts, Host host) {\n+        if (host == null) {\n+            if (LOG.isTraceEnabled()) {\n+                LOG.trace(\"trying to add no host to a list\");\n             }\n-            if (host.getType() == Host.Type.Routing || host.getType() == Host.Type.ConsoleProxy || host.getType() == Host.Type.SecondaryStorage || host.getType() == Host.Type.SecondaryStorageVM) {\n-                if (host.getHypervisorType() != null && host.getHypervisorType() != Hypervisor.HypervisorType.KVM && host.getHypervisorType() != Hypervisor.HypervisorType.LXC) {\n-                    continue;\n-                }\n-                agentBasedHosts.add(host);\n+            return;\n+        }\n+\n+        ResourceState[] allowedStates = new ResourceState[]{\n+                ResourceState.Enabled,\n+                ResourceState.Maintenance,\n+                ResourceState.Disabled,\n+                ResourceState.ErrorInMaintenance,\n+                ResourceState.PrepareForMaintenance\n+        };\n+        // so the remaining ResourceState[] disallowedStates = new ResourceState[]{ResourceState.Creating, ResourceState.Error};\n+        if (binarySearch(allowedStates, host.getResourceState()) < 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5735e6eaecca28258f31db93c482f927647f5024"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MTUwNTE5", "url": "https://github.com/apache/cloudstack/pull/3795#pullrequestreview-339150519", "createdAt": "2020-01-07T10:26:02Z", "commit": {"oid": "5735e6eaecca28258f31db93c482f927647f5024"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78db672ffe18ab93289152137b406ed04c1556f4", "author": {"user": {"login": "DaanHoogland", "name": "dahn"}}, "url": "https://github.com/apache/cloudstack/commit/78db672ffe18ab93289152137b406ed04c1556f4", "committedDate": "2020-01-07T14:12:14Z", "message": "EnumSet.contains instead of Arrays.binarySearch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNTc5MjEx", "url": "https://github.com/apache/cloudstack/pull/3795#pullrequestreview-342579211", "createdAt": "2020-01-14T14:38:43Z", "commit": {"oid": "78db672ffe18ab93289152137b406ed04c1556f4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4519, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}