{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzMjM4MTc5", "number": 4144, "title": "Fix Usage failed to get pid", "bodyText": "Description\n\ncloudstack-usage use System.getProperty(\"pid\") to get the process PID\nSystem.getProperty cannot get the Pid, which will cause the service to stay in the config stage. Cannot continue to start, and there will be no log output.\nThis PR uses ManagementFactory instead of System.getProperty to get Pid, and throws an exception when Pid cannot be obtained\n\n\n\n\n\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?", "createdAt": "2020-06-11T17:38:18Z", "url": "https://github.com/apache/cloudstack/pull/4144", "merged": true, "mergeCommit": {"oid": "f66ae34ea713e57a7aa2a049f7cf5984bfd8cd39"}, "closed": true, "closedAt": "2020-10-28T10:19:54Z", "author": {"login": "div8cn"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqRskTAH2gAyNDMzMjM4MTc5OmMzNTczY2JjNjE1YWI0NDVkNjBmYjA2YTBmMmQwMjU2OWY5N2VhZmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdW64HCgFqTUxODUxMDcwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c3573cbc615ab445d60fb06a0f2d02569f97eafb", "author": {"user": {"login": "div8cn", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/c3573cbc615ab445d60fb06a0f2d02569f97eafb", "committedDate": "2020-06-11T17:27:58Z", "message": "Update UsageManagerImpl.java\n\nWhen System.getProperty Failure to get the PID will cause the service to stay in the config phase. The startup cannot continue and there will be no log output\r\nUse managementfactory to get the PID and throw an exception when the PID cannot be obtained."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NDg5NzUz", "url": "https://github.com/apache/cloudstack/pull/4144#pullrequestreview-439489753", "createdAt": "2020-06-29T20:49:45Z", "commit": {"oid": "c3573cbc615ab445d60fb06a0f2d02569f97eafb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMDo0OTo0NVrOGqhsSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMDo0OTo0NVrOGqhsSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI0NTM4Ng==", "bodyText": "Should we add a more meaningful message here so its more clear?", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r447245386", "createdAt": "2020-06-29T20:49:45Z", "author": {"login": "ravening"}, "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "diffHunk": "@@ -275,7 +277,14 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n             s_logger.error(\"Unhandled exception configuring UsageManger\", e);\n             throw new ConfigurationException(\"Unhandled exception configuring UsageManager \" + e.toString());\n         }\n-        _pid = Integer.parseInt(System.getProperty(\"pid\"));\n+\n+        try {\n+            String processName = ManagementFactory.getRuntimeMXBean().getName();\n+            _pid = Integer.parseInt(processName.split(\"@\")[0]);\n+        } catch (Exception e) {\n+            s_logger.error(\"Unable to get process pid \", e);\n+            throw new ConfigurationException(\"Unable to get process pid \" + e.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3573cbc615ab445d60fb06a0f2d02569f97eafb"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NzA1MjU4", "url": "https://github.com/apache/cloudstack/pull/4144#pullrequestreview-456705258", "createdAt": "2020-07-28T14:41:23Z", "commit": {"oid": "c3573cbc615ab445d60fb06a0f2d02569f97eafb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDo0MToyM1rOG4QCDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDo0MToyM1rOG4QCDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYzNjExMA==", "bodyText": "twice the same message should be in a string constand\nrethrown should not abandon the stack trace for the original problem\n\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    try {\n          \n          \n            \n                        String processName = ManagementFactory.getRuntimeMXBean().getName();\n          \n          \n            \n                        _pid = Integer.parseInt(processName.split(\"@\")[0]);\n          \n          \n            \n                    } catch (Exception e) {\n          \n          \n            \n                        s_logger.error(\"Unable to get process pid \", e);\n          \n          \n            \n                        throw new ConfigurationException(\"Unable to get process pid \" + e.toString());\n          \n          \n            \n                    }\n          \n          \n            \n                    String processName;\n          \n          \n            \n                    try {\n          \n          \n            \n                        processName = ManagementFactory.getRuntimeMXBean().getName();\n          \n          \n            \n                        _pid = Integer.parseInt(processName.split(\"@\")[0]);\n          \n          \n            \n                    } catch (Exception e) {\n          \n          \n            \n                        String msg = String.format(\"Unable to get process Id for %s!\", processName);\n          \n          \n            \n                        s_logger.error(msg);\n          \n          \n            \n                        throw new ConfigurationException(msg, e);\n          \n          \n            \n                    }\n          \n      \n    \n    \n  \n\nor\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    try {\n          \n          \n            \n                        String processName = ManagementFactory.getRuntimeMXBean().getName();\n          \n          \n            \n                        _pid = Integer.parseInt(processName.split(\"@\")[0]);\n          \n          \n            \n                    } catch (Exception e) {\n          \n          \n            \n                        s_logger.error(\"Unable to get process pid \", e);\n          \n          \n            \n                        throw new ConfigurationException(\"Unable to get process pid \" + e.toString());\n          \n          \n            \n                    }\n          \n          \n            \n                    String processName;\n          \n          \n            \n                    try {\n          \n          \n            \n                        processName = ManagementFactory.getRuntimeMXBean().getName();\n          \n          \n            \n                        _pid = Integer.parseInt(processName.split(\"@\")[0]);\n          \n          \n            \n                    } catch (Exception e) {\n          \n          \n            \n                        String msg = String.format(\"Unable to get process Id for %s!\", processName);\n          \n          \n            \n                        s_logger.debug(msg , e);\n          \n          \n            \n                        throw new ConfigurationException(msg, e);\n          \n          \n            \n                    }", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r461636110", "createdAt": "2020-07-28T14:41:23Z", "author": {"login": "DaanHoogland"}, "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "diffHunk": "@@ -275,7 +277,14 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n             s_logger.error(\"Unhandled exception configuring UsageManger\", e);\n             throw new ConfigurationException(\"Unhandled exception configuring UsageManager \" + e.toString());\n         }\n-        _pid = Integer.parseInt(System.getProperty(\"pid\"));\n+\n+        try {\n+            String processName = ManagementFactory.getRuntimeMXBean().getName();\n+            _pid = Integer.parseInt(processName.split(\"@\")[0]);\n+        } catch (Exception e) {\n+            s_logger.error(\"Unable to get process pid \", e);\n+            throw new ConfigurationException(\"Unable to get process pid \" + e.toString());\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3573cbc615ab445d60fb06a0f2d02569f97eafb"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eba35575a0ad2f1b8bbeea062e9dd058282741c5", "author": {"user": {"login": "div8cn", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/eba35575a0ad2f1b8bbeea062e9dd058282741c5", "committedDate": "2020-07-28T14:43:41Z", "message": "Update usage/src/main/java/com/cloud/usage/UsageManagerImpl.java\n\nCo-authored-by: dahn <daan.hoogland@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NzI2MjIw", "url": "https://github.com/apache/cloudstack/pull/4144#pullrequestreview-457726220", "createdAt": "2020-07-29T17:13:29Z", "commit": {"oid": "eba35575a0ad2f1b8bbeea062e9dd058282741c5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1383d18bc90d7941bc3a534021620764e6082675", "author": {"user": {"login": "div8cn", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/1383d18bc90d7941bc3a534021620764e6082675", "committedDate": "2020-08-04T11:42:53Z", "message": "Update UsageManagerImpl.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMzAzODU5", "url": "https://github.com/apache/cloudstack/pull/4144#pullrequestreview-461303859", "createdAt": "2020-08-05T02:50:53Z", "commit": {"oid": "1383d18bc90d7941bc3a534021620764e6082675"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwMjo1MDo1M1rOG74Q7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwMjo1MDo1M1rOG74Q7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ0MTAwNg==", "bodyText": "@DaanHoogland @div8cn What do you think of using e.printStackTrace() to add the stack on the log/ConfigurationException?\nWith toString (or simply s_logger.debug(msg , e)) it logs only the exception name and the error message (if there is any message). On the other hand, printStackTrace() presents the whole stack trace of an exception, which is very helpful for debugging.", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r465441006", "createdAt": "2020-08-05T02:50:53Z", "author": {"login": "GabrielBrascher"}, "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "diffHunk": "@@ -275,7 +277,16 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n             s_logger.error(\"Unhandled exception configuring UsageManger\", e);\n             throw new ConfigurationException(\"Unhandled exception configuring UsageManager \" + e.toString());\n         }\n-        _pid = Integer.parseInt(System.getProperty(\"pid\"));\n+\n+        String processName = null;\n+        try {\n+            processName = ManagementFactory.getRuntimeMXBean().getName();\n+            _pid = Integer.parseInt(processName.split(\"@\")[0]);\n+        } catch (Exception e) {\n+            String msg = String.format(\"Unable to get process Id for %s!\", processName);\n+            s_logger.debug(msg , e);\n+            throw new ConfigurationException(msg + \" \" + e.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1383d18bc90d7941bc3a534021620764e6082675"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NTA2MDQz", "url": "https://github.com/apache/cloudstack/pull/4144#pullrequestreview-479506043", "createdAt": "2020-09-01T08:19:39Z", "commit": {"oid": "1383d18bc90d7941bc3a534021620764e6082675"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwODoxOTozOVrOHKrXrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwODoxOTozOVrOHKrXrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk1ODM4MQ==", "bodyText": "@div8cn master is on java 11 now, can you use ProcessHandle.current().pid()? I did a quick test:\n> jshell \n|  Welcome to JShell -- Version 11.0.7\n|  For an introduction type: /help intro\n\njshell> ProcessHandle.current().pid()\n$1 ==> 20380", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r480958381", "createdAt": "2020-09-01T08:19:39Z", "author": {"login": "rhtyd"}, "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "diffHunk": "@@ -275,7 +277,16 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n             s_logger.error(\"Unhandled exception configuring UsageManger\", e);\n             throw new ConfigurationException(\"Unhandled exception configuring UsageManager \" + e.toString());\n         }\n-        _pid = Integer.parseInt(System.getProperty(\"pid\"));\n+\n+        String processName = null;\n+        try {\n+            processName = ManagementFactory.getRuntimeMXBean().getName();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1383d18bc90d7941bc3a534021620764e6082675"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "469652aaccc55cc165bb50a5eaffef446183be70", "author": {"user": {"login": "div8cn", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/469652aaccc55cc165bb50a5eaffef446183be70", "committedDate": "2020-09-02T00:33:06Z", "message": "Update UsageManagerImpl.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNjE0OTMx", "url": "https://github.com/apache/cloudstack/pull/4144#pullrequestreview-480614931", "createdAt": "2020-09-02T08:51:34Z", "commit": {"oid": "469652aaccc55cc165bb50a5eaffef446183be70"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODo1MTozNVrOHLlGxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODo1MTozNVrOHLlGxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwNDMyNg==", "bodyText": "processName is always null .", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r481904326", "createdAt": "2020-09-02T08:51:35Z", "author": {"login": "weizhouapache"}, "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "diffHunk": "@@ -280,8 +278,7 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n \n         String processName = null;\n         try {\n-            processName = ManagementFactory.getRuntimeMXBean().getName();\n-            _pid = Integer.parseInt(processName.split(\"@\")[0]);\n+            _pid = (int) ProcessHandle.current().pid();\n         } catch (Exception e) {\n             String msg = String.format(\"Unable to get process Id for %s!\", processName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469652aaccc55cc165bb50a5eaffef446183be70"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNjUwMzIy", "url": "https://github.com/apache/cloudstack/pull/4144#pullrequestreview-480650322", "createdAt": "2020-09-02T09:36:50Z", "commit": {"oid": "469652aaccc55cc165bb50a5eaffef446183be70"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwOTozNjo1MFrOHLnIWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwOTozNjo1MFrOHLnIWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkzNzQ5OA==", "bodyText": "processName is not used and can be removed @div8cn", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r481937498", "createdAt": "2020-09-02T09:36:50Z", "author": {"login": "rhtyd"}, "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "diffHunk": "@@ -275,7 +275,15 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n             s_logger.error(\"Unhandled exception configuring UsageManger\", e);\n             throw new ConfigurationException(\"Unhandled exception configuring UsageManager \" + e.toString());\n         }\n-        _pid = Integer.parseInt(System.getProperty(\"pid\"));\n+\n+        String processName = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469652aaccc55cc165bb50a5eaffef446183be70"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b63caa5c7c75a1391281e08fa63e939657cfe4d", "author": {"user": {"login": "div8cn", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/2b63caa5c7c75a1391281e08fa63e939657cfe4d", "committedDate": "2020-09-02T10:28:17Z", "message": "Update UsageManagerImpl.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0MTY1NzQ1", "url": "https://github.com/apache/cloudstack/pull/4144#pullrequestreview-494165745", "createdAt": "2020-09-23T05:42:50Z", "commit": {"oid": "2b63caa5c7c75a1391281e08fa63e939657cfe4d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NTEwNzAw", "url": "https://github.com/apache/cloudstack/pull/4144#pullrequestreview-518510700", "createdAt": "2020-10-28T10:19:21Z", "commit": {"oid": "2b63caa5c7c75a1391281e08fa63e939657cfe4d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4380, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}