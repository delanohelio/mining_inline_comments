{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2MzEzNTcy", "number": 4154, "title": "server: fix for wrong affinity group count", "bodyText": "Description\nFixes wrong count in listAffinityGroup API.\nAPI was returning the count of AffinityGroupJoinVO records.\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?\nWith a running environment,\nBefore fix - count is equal to VM count for the affinity groups\n(local) \ud83d\udc31 > list affinitygroups \n{\n  \"affinitygroup\": [\n    {\n      \"account\": \"admin\",\n      \"domain\": \"ROOT\",\n      \"domainid\": \"1db59a3e-b131-11ea-94f6-645d8651f45a\",\n      \"id\": \"b878f4e6-fbcd-44f3-9a95-ad8102fd14da\",\n      \"name\": \"bvcn\",\n      \"type\": \"host anti-affinity\",\n      \"virtualmachineIds\": [\n        \"0c6bee5e-2d50-4b7a-b26f-30bff5818777\"\n      ]\n    },\n    {\n      \"account\": \"admin\",\n      \"domain\": \"ROOT\",\n      \"domainid\": \"1db59a3e-b131-11ea-94f6-645d8651f45a\",\n      \"id\": \"10b78b41-8fe4-47c1-8972-3bedd0690fd3\",\n      \"name\": \"hfd\",\n      \"type\": \"host anti-affinity\",\n      \"virtualmachineIds\": [\n        \"0c6bee5e-2d50-4b7a-b26f-30bff5818777\",\n        \"f4ca8c20-4887-4bc1-a532-b39cf140c4e4\"\n      ]\n    },\n    {\n      \"account\": \"admin\",\n      \"domain\": \"ROOT\",\n      \"domainid\": \"1db59a3e-b131-11ea-94f6-645d8651f45a\",\n      \"id\": \"63d02962-ac8a-419a-bb88-eabec223828d\",\n      \"name\": \"dfsf\",\n      \"type\": \"host anti-affinity\",\n      \"virtualmachineIds\": [\n        \"0c6bee5e-2d50-4b7a-b26f-30bff5818777\",\n        \"f4ca8c20-4887-4bc1-a532-b39cf140c4e4\",\n        \"cf8d9565-b1c5-40f0-a436-56a52fc86106\"\n      ]\n    }\n  ],\n  \"count\": 6\n}\n\n\nAfter fix - actual count of affinity groups\n{\n  \"affinitygroup\": [\n    {\n      \"account\": \"admin\",\n      \"domain\": \"ROOT\",\n      \"domainid\": \"1db59a3e-b131-11ea-94f6-645d8651f45a\",\n      \"id\": \"b878f4e6-fbcd-44f3-9a95-ad8102fd14da\",\n      \"name\": \"bvcn\",\n      \"type\": \"host anti-affinity\",\n      \"virtualmachineIds\": [\n        \"0c6bee5e-2d50-4b7a-b26f-30bff5818777\"\n      ]\n    },\n    {\n      \"account\": \"admin\",\n      \"domain\": \"ROOT\",\n      \"domainid\": \"1db59a3e-b131-11ea-94f6-645d8651f45a\",\n      \"id\": \"10b78b41-8fe4-47c1-8972-3bedd0690fd3\",\n      \"name\": \"hfd\",\n      \"type\": \"host anti-affinity\",\n      \"virtualmachineIds\": [\n        \"0c6bee5e-2d50-4b7a-b26f-30bff5818777\",\n        \"f4ca8c20-4887-4bc1-a532-b39cf140c4e4\"\n      ]\n    },\n    {\n      \"account\": \"admin\",\n      \"domain\": \"ROOT\",\n      \"domainid\": \"1db59a3e-b131-11ea-94f6-645d8651f45a\",\n      \"id\": \"63d02962-ac8a-419a-bb88-eabec223828d\",\n      \"name\": \"dfsf\",\n      \"type\": \"host anti-affinity\",\n      \"virtualmachineIds\": [\n        \"0c6bee5e-2d50-4b7a-b26f-30bff5818777\",\n        \"f4ca8c20-4887-4bc1-a532-b39cf140c4e4\",\n        \"cf8d9565-b1c5-40f0-a436-56a52fc86106\"\n      ]\n    }\n  ],\n  \"count\": 3\n}", "createdAt": "2020-06-18T08:28:34Z", "url": "https://github.com/apache/cloudstack/pull/4154", "merged": true, "mergeCommit": {"oid": "801071887810dbeb68a24e94e36f117e911883bc"}, "closed": true, "closedAt": "2020-06-24T01:32:56Z", "author": {"login": "shwstppr"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsaFW4AH2gAyNDM2MzEzNTcyOmY1MzhkYjM5NDkxNjZiYzExZDliNzMyNGU4MDI4Y2E5ZTQ4YmY0ODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABctptHyAH2gAyNDM2MzEzNTcyOmQwNmU3NjkyNzc4NDJhNmE0MWY1ZjI2NjNmYjA5YTA1ZWM0ZGUwNjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f538db3949166bc11d9b7324e8028ca9e48bf489", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/f538db3949166bc11d9b7324e8028ca9e48bf489", "committedDate": "2020-06-18T08:22:08Z", "message": "server: fix for wrong affinity group count\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMDU3Mjk5", "url": "https://github.com/apache/cloudstack/pull/4154#pullrequestreview-433057299", "createdAt": "2020-06-18T08:31:05Z", "commit": {"oid": "f538db3949166bc11d9b7324e8028ca9e48bf489"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MDMzOTEx", "url": "https://github.com/apache/cloudstack/pull/4154#pullrequestreview-434033911", "createdAt": "2020-06-19T12:23:19Z", "commit": {"oid": "f538db3949166bc11d9b7324e8028ca9e48bf489"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMjoyMzoxOVrOGmS5oA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMjoyMzoxOVrOGmS5oA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgwODczNg==", "bodyText": "Could this return Ids that are already there in affinityGroups ?", "url": "https://github.com/apache/cloudstack/pull/4154#discussion_r442808736", "createdAt": "2020-06-19T12:23:19Z", "author": {"login": "davidjumani"}, "path": "server/src/main/java/com/cloud/api/query/QueryManagerImpl.java", "diffHunk": "@@ -3624,25 +3624,30 @@ private void fillVMOrTemplateDetailOptions(final Map<String, List<String>> optio\n             if (domainId != null) {\n                 SearchCriteria<AffinityGroupJoinVO> scDomain = buildAffinityGroupSearchCriteria(null, isRecursive, new ArrayList<Long>(), listProjectResourcesCriteria, affinityGroupId,\n                         affinityGroupName, affinityGroupType, keyword);\n-                affinityGroups.addAll(listDomainLevelAffinityGroups(scDomain, searchFilter, domainId));\n+                List<AffinityGroupJoinVO> groups = listDomainLevelAffinityGroups(scDomain, searchFilter, domainId);\n+                affinityGroups.addAll(groups);\n+                count += groups.size();\n             } else {\n \n                 for (Long permAcctId : permittedAccounts) {\n                     Account permittedAcct = _accountDao.findById(permAcctId);\n                     SearchCriteria<AffinityGroupJoinVO> scDomain = buildAffinityGroupSearchCriteria(null, isRecursive, new ArrayList<Long>(), listProjectResourcesCriteria, affinityGroupId,\n                             affinityGroupName, affinityGroupType, keyword);\n-\n-                    affinityGroups.addAll(listDomainLevelAffinityGroups(scDomain, searchFilter, permittedAcct.getDomainId()));\n+                    List<AffinityGroupJoinVO> groups = listDomainLevelAffinityGroups(scDomain, searchFilter, permittedAcct.getDomainId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f538db3949166bc11d9b7324e8028ca9e48bf489"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NDQ4NTUy", "url": "https://github.com/apache/cloudstack/pull/4154#pullrequestreview-434448552", "createdAt": "2020-06-20T19:21:21Z", "commit": {"oid": "f538db3949166bc11d9b7324e8028ca9e48bf489"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d06e769277842a6a41f5f2663fb09a05ec4de063", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/d06e769277842a6a41f5f2663fb09a05ec4de063", "committedDate": "2020-06-22T05:08:04Z", "message": "fix for correct unique domain level AG count\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3864, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}