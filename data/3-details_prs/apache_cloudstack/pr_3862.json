{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwNzQ4ODA3", "number": 3862, "title": "Userdata to display static NAT as public ip instead of VR ip", "bodyText": "Description\n\nIf static nat is enabled on VM then metadata service should return\nthe static nat instead of gateway IP.\nIf static not is not enabled then it should return the gateway IP\nas the public IP\n\n\n\n\n\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?\n\n\n\nStep to reproduce:\n\n\nCreate a vm\n\n\nSsh to vm.\n\n\nRun the below command inside the vm\nwget http://<VR public ip>/latest/meta-data/public-ipv4\nNote down the output of the above command\n\n\nNow acquire a new public and enable static NAT on that IP to this vm\n\n\nNow run the same command mentioned above in the VM\nThis should display the static NAT ip instead of VR public IP\n\n\nOutput:\nBefore enabling static nat\nwget http://10.10.10.40/latest/meta-data/public-ipv4\n$ cat public-ipv4\n10.10.10.29\nAfter enabling static nat\nwget http://10.10.10.40/latest/meta-data/public-ipv4\n$ cat public-ipv4\n10.11.10.30", "createdAt": "2020-02-04T10:09:08Z", "url": "https://github.com/apache/cloudstack/pull/3862", "merged": true, "mergeCommit": {"oid": "9c6b02fd8b2282ceb80a1b9205871a4e93a00682"}, "closed": true, "closedAt": "2020-03-05T11:49:18Z", "author": {"login": "ravening"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBB3zmAFqTM1Mjk4NzcwNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKqGUDAFqTM2OTUwNDE4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyOTg3NzA0", "url": "https://github.com/apache/cloudstack/pull/3862#pullrequestreview-352987704", "createdAt": "2020-02-04T13:50:52Z", "commit": {"oid": "e64396882b7db4a5f28e14307f1066edde994c25"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyOTg4NTMx", "url": "https://github.com/apache/cloudstack/pull/3862#pullrequestreview-352988531", "createdAt": "2020-02-04T13:52:02Z", "commit": {"oid": "e64396882b7db4a5f28e14307f1066edde994c25"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNDg5NDk4", "url": "https://github.com/apache/cloudstack/pull/3862#pullrequestreview-353489498", "createdAt": "2020-02-05T06:27:51Z", "commit": {"oid": "e64396882b7db4a5f28e14307f1066edde994c25"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "20cc83227139def1f6ca63ee7a67609766b01f93", "author": {"user": {"login": "ravening", "name": "Rakesh"}}, "url": "https://github.com/apache/cloudstack/commit/20cc83227139def1f6ca63ee7a67609766b01f93", "committedDate": "2020-02-12T10:14:46Z", "message": "Merge branch '4.13' into display_static_nat"}, "afterCommit": {"oid": "b131cf1961414170c793fb09f050477d8d83340f", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/b131cf1961414170c793fb09f050477d8d83340f", "committedDate": "2020-02-12T10:20:08Z", "message": "Userdata to display static NAT as public ip instead of VR ip\n\nIf static nat is enabled on VM then metadata service should return\nthe static nat instead of gateway IP.\nIf static not is not enabled then it should return the gateway IP\nas the public IP\n\nTest results:\n\nStep to reproduce:\n\n1. Create a vm\n2. Ssh to vm.\n3. Run the below command inside the vm\nwget http://<VR public ip>/latest/meta-data/public-ipv4\n\nNote down the output of the above command\n4. Now acquire a new public and enable static NAT on that IP to this vm\n5. Now run the same command mentioned above in the VM\nThis should display the static NAT ip instead of VR public IP\n\nOutput:\n\nBefore enabling static nat\n\nwget http://10.10.10.40/latest/meta-data/public-ipv4\n$ cat public-ipv4\n10.10.10.29\n\nAfter enabling static nat\n\nwget http://10.10.10.40/latest/meta-data/public-ipv4\n$ cat public-ipv4\n10.11.10.30"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNDA1NzY0", "url": "https://github.com/apache/cloudstack/pull/3862#pullrequestreview-361405764", "createdAt": "2020-02-19T20:16:38Z", "commit": {"oid": "b131cf1961414170c793fb09f050477d8d83340f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMDoxNjozOFrOFr2ITA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMDoxNjozOFrOFr2ITA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTUxOTk0OA==", "bodyText": "@ravening you missed one check here\n-            } else {\n+            } else if (router.getPublicIpAddress() != null) {", "url": "https://github.com/apache/cloudstack/pull/3862#discussion_r381519948", "createdAt": "2020-02-19T20:16:38Z", "author": {"login": "weizhouapache"}, "path": "server/src/main/java/com/cloud/network/router/CommandSetupHelper.java", "diffHunk": "@@ -1024,18 +1026,21 @@ private VmDataCommand generateVmDataCommand(final VirtualRouter router, final St\n         cmd.addVmData(\"userdata\", \"user-data\", userData);\n         cmd.addVmData(\"metadata\", \"service-offering\", StringUtils.unicodeEscape(serviceOffering));\n         cmd.addVmData(\"metadata\", \"availability-zone\", StringUtils.unicodeEscape(zoneName));\n-        cmd.addVmData(\"metadata\", \"local-ipv4\", guestIpAddress);\n+        cmd.addVmData(\"metadata\", \"local-ipv4\", vmPrivateIpAddress);\n         cmd.addVmData(\"metadata\", \"local-hostname\", StringUtils.unicodeEscape(vmName));\n-        if (dcVo.getNetworkType() == NetworkType.Basic) {\n-            cmd.addVmData(\"metadata\", \"public-ipv4\", guestIpAddress);\n+\n+        Network network = _networkDao.findById(guestNetworkId);\n+        if (dcVo.getNetworkType() == NetworkType.Basic || network.getGuestType() == Network.GuestType.Shared) {\n+            cmd.addVmData(\"metadata\", \"public-ipv4\", vmPrivateIpAddress);\n             cmd.addVmData(\"metadata\", \"public-hostname\", StringUtils.unicodeEscape(vmName));\n         } else {\n-            if (router.getPublicIpAddress() == null) {\n-                cmd.addVmData(\"metadata\", \"public-ipv4\", guestIpAddress);\n+            if (publicIpAddress != null) {\n+                cmd.addVmData(\"metadata\", \"public-ipv4\", publicIpAddress);\n+                cmd.addVmData(\"metadata\", \"public-hostname\", publicIpAddress);\n             } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b131cf1961414170c793fb09f050477d8d83340f"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bef2f533ec8b5cc8e6a83ba47b40086ecc8a9444", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/bef2f533ec8b5cc8e6a83ba47b40086ecc8a9444", "committedDate": "2020-02-20T09:36:08Z", "message": "Userdata to display static NAT as public ip instead of VR ip\n\nIf static nat is enabled on VM then metadata service should return\nthe static nat instead of gateway IP.\nIf static not is not enabled then it should return the gateway IP\nas the public IP\n\nTest results:\n\nStep to reproduce:\n\n1. Create a vm\n2. Ssh to vm.\n3. Run the below command inside the vm\nwget http://<VR public ip>/latest/meta-data/public-ipv4\n\nNote down the output of the above command\n4. Now acquire a new public and enable static NAT on that IP to this vm\n5. Now run the same command mentioned above in the VM\nThis should display the static NAT ip instead of VR public IP\n\nOutput:\n\nBefore enabling static nat\n\nwget http://10.10.10.40/latest/meta-data/public-ipv4\n$ cat public-ipv4\n10.10.10.29\n\nAfter enabling static nat\n\nwget http://10.10.10.40/latest/meta-data/public-ipv4\n$ cat public-ipv4\n10.11.10.30"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b131cf1961414170c793fb09f050477d8d83340f", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/b131cf1961414170c793fb09f050477d8d83340f", "committedDate": "2020-02-12T10:20:08Z", "message": "Userdata to display static NAT as public ip instead of VR ip\n\nIf static nat is enabled on VM then metadata service should return\nthe static nat instead of gateway IP.\nIf static not is not enabled then it should return the gateway IP\nas the public IP\n\nTest results:\n\nStep to reproduce:\n\n1. Create a vm\n2. Ssh to vm.\n3. Run the below command inside the vm\nwget http://<VR public ip>/latest/meta-data/public-ipv4\n\nNote down the output of the above command\n4. Now acquire a new public and enable static NAT on that IP to this vm\n5. Now run the same command mentioned above in the VM\nThis should display the static NAT ip instead of VR public IP\n\nOutput:\n\nBefore enabling static nat\n\nwget http://10.10.10.40/latest/meta-data/public-ipv4\n$ cat public-ipv4\n10.10.10.29\n\nAfter enabling static nat\n\nwget http://10.10.10.40/latest/meta-data/public-ipv4\n$ cat public-ipv4\n10.11.10.30"}, "afterCommit": {"oid": "bef2f533ec8b5cc8e6a83ba47b40086ecc8a9444", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/bef2f533ec8b5cc8e6a83ba47b40086ecc8a9444", "committedDate": "2020-02-20T09:36:08Z", "message": "Userdata to display static NAT as public ip instead of VR ip\n\nIf static nat is enabled on VM then metadata service should return\nthe static nat instead of gateway IP.\nIf static not is not enabled then it should return the gateway IP\nas the public IP\n\nTest results:\n\nStep to reproduce:\n\n1. Create a vm\n2. Ssh to vm.\n3. Run the below command inside the vm\nwget http://<VR public ip>/latest/meta-data/public-ipv4\n\nNote down the output of the above command\n4. Now acquire a new public and enable static NAT on that IP to this vm\n5. Now run the same command mentioned above in the VM\nThis should display the static NAT ip instead of VR public IP\n\nOutput:\n\nBefore enabling static nat\n\nwget http://10.10.10.40/latest/meta-data/public-ipv4\n$ cat public-ipv4\n10.10.10.29\n\nAfter enabling static nat\n\nwget http://10.10.10.40/latest/meta-data/public-ipv4\n$ cat public-ipv4\n10.11.10.30"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e77d23e8f943d4fbb6912573598ff584d377e60c", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/e77d23e8f943d4fbb6912573598ff584d377e60c", "committedDate": "2020-02-25T09:54:32Z", "message": "server: apply vm user data when release a public ip"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NzMzNjAz", "url": "https://github.com/apache/cloudstack/pull/3862#pullrequestreview-367733603", "createdAt": "2020-03-03T06:44:41Z", "commit": {"oid": "e77d23e8f943d4fbb6912573598ff584d377e60c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NTA0MTg0", "url": "https://github.com/apache/cloudstack/pull/3862#pullrequestreview-369504184", "createdAt": "2020-03-05T11:48:14Z", "commit": {"oid": "e77d23e8f943d4fbb6912573598ff584d377e60c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4590, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}