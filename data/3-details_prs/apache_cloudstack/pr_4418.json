{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3NzcwMzY2", "number": 4418, "title": "Create Event in case of OOBM failure", "bodyText": "Description\n\nOut of band power operations are constantly issued to assess the host power status. However, if such actions fail the Admins receive a warning message on the log. In order to help Admins to easily track such failures, this PR creates an Event each time an Out-of-band power operation fails.\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)", "createdAt": "2020-10-21T18:17:19Z", "url": "https://github.com/apache/cloudstack/pull/4418", "merged": true, "mergeCommit": {"oid": "823111ddb7dc9adf7d3100be6315454b40d08bec"}, "closed": true, "closedAt": "2020-11-10T20:48:38Z", "author": {"login": "GabrielBrascher"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdU8fzrAFqTUxNDQxNTQ4NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYjPP4gFqTUyMTU2NDE5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0NDE1NDg0", "url": "https://github.com/apache/cloudstack/pull/4418#pullrequestreview-514415484", "createdAt": "2020-10-22T07:03:24Z", "commit": {"oid": "3ae14d14eb3c3594b94963c839e981a44b57c996"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNzowMzoyNFrOHmTVoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNzowNDozOFrOHmTX_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkyNDc2OQ==", "bodyText": "In general in CloudStack we try to not log the 'hostid' as it doesn't say anything. The ID can only be fetched from the DB and not from the API and thus UI.", "url": "https://github.com/apache/cloudstack/pull/4418#discussion_r509924769", "createdAt": "2020-10-22T07:03:24Z", "author": {"login": "wido"}, "path": "server/src/main/java/org/apache/cloudstack/outofbandmanagement/PowerOperationTask.java", "diffHunk": "@@ -43,8 +53,26 @@ public void run() {\n         try {\n             service.executePowerOperation(host, powerOperation, null);\n         } catch (Exception e) {\n-            LOG.warn(String.format(\"Out-of-band management background task operation=%s for host id=%d failed with: %s\",\n-                    powerOperation.name(), host.getId(), e.getMessage()));\n+            LOG.warn(String.format(\"Out-of-band management background task operation=%s for host id=%d name=%s failed with: %s\",\n+                    powerOperation.name(), host.getId(), host.getName(), e.getMessage()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ae14d14eb3c3594b94963c839e981a44b57c996"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkyNDg3NA==", "bodyText": "Same applies here", "url": "https://github.com/apache/cloudstack/pull/4418#discussion_r509924874", "createdAt": "2020-10-22T07:03:40Z", "author": {"login": "wido"}, "path": "server/src/main/java/org/apache/cloudstack/outofbandmanagement/PowerOperationTask.java", "diffHunk": "@@ -43,8 +53,26 @@ public void run() {\n         try {\n             service.executePowerOperation(host, powerOperation, null);\n         } catch (Exception e) {\n-            LOG.warn(String.format(\"Out-of-band management background task operation=%s for host id=%d failed with: %s\",\n-                    powerOperation.name(), host.getId(), e.getMessage()));\n+            LOG.warn(String.format(\"Out-of-band management background task operation=%s for host id=%d name=%s failed with: %s\",\n+                    powerOperation.name(), host.getId(), host.getName(), e.getMessage()));\n+\n+            if(CREATE_EVENT_ON_OOBM_FAILURE.value()) {\n+                String eventMessage = String.format(\"Error while issuing out-of-band management action (%s) for host (id: %d, name: %s)\",\n+                        powerOperation.name(), host.getId(), host.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ae14d14eb3c3594b94963c839e981a44b57c996"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkyNTM3NQ==", "bodyText": "I know there is no naming scheme here, but isn't it easier if OOB related config keys are prefixed with oob?\noob.create.event.on.failure\nFor example", "url": "https://github.com/apache/cloudstack/pull/4418#discussion_r509925375", "createdAt": "2020-10-22T07:04:38Z", "author": {"login": "wido"}, "path": "server/src/main/java/org/apache/cloudstack/outofbandmanagement/PowerOperationTask.java", "diffHunk": "@@ -17,16 +17,26 @@\n \n package org.apache.cloudstack.outofbandmanagement;\n \n+import com.cloud.event.ActionEventUtils;\n+import com.cloud.event.EventTypes;\n+import com.cloud.event.EventVO;\n import com.cloud.host.Host;\n+import org.apache.cloudstack.context.CallContext;\n+import org.apache.cloudstack.framework.config.ConfigKey;\n+import org.apache.cloudstack.framework.config.Configurable;\n import org.apache.log4j.Logger;\n \n-public class PowerOperationTask implements Runnable {\n+public class PowerOperationTask implements Runnable, Configurable {\n     public static final Logger LOG = Logger.getLogger(PowerOperationTask.class);\n \n     final private OutOfBandManagementService service;\n     final private Host host;\n     final private OutOfBandManagement.PowerOperation powerOperation;\n \n+    public static final ConfigKey<Boolean> CREATE_EVENT_ON_OOBM_FAILURE = new ConfigKey<Boolean>(\"Advanced\", Boolean.class, \"create.event.on.oob.failure\", \"true\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ae14d14eb3c3594b94963c839e981a44b57c996"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ae14d14eb3c3594b94963c839e981a44b57c996", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/3ae14d14eb3c3594b94963c839e981a44b57c996", "committedDate": "2020-10-21T18:03:40Z", "message": "Create Error EVENT in case of oobm failure"}, "afterCommit": {"oid": "d931b09b902b745f28c06270c952fc5adb2bc210", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/d931b09b902b745f28c06270c952fc5adb2bc210", "committedDate": "2020-10-22T09:24:03Z", "message": "Create Error EVENT in case of oobm failure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28f1baa610fe86f34cf20a4941b546bdc46b189c", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/28f1baa610fe86f34cf20a4941b546bdc46b189c", "committedDate": "2020-10-22T16:53:41Z", "message": "Create Error EVENT in case of oobm failure"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d931b09b902b745f28c06270c952fc5adb2bc210", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/d931b09b902b745f28c06270c952fc5adb2bc210", "committedDate": "2020-10-22T09:24:03Z", "message": "Create Error EVENT in case of oobm failure"}, "afterCommit": {"oid": "28f1baa610fe86f34cf20a4941b546bdc46b189c", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/28f1baa610fe86f34cf20a4941b546bdc46b189c", "committedDate": "2020-10-22T16:53:41Z", "message": "Create Error EVENT in case of oobm failure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8de5434252473a94c814afa0b3b20f902a935e88", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/8de5434252473a94c814afa0b3b20f902a935e88", "committedDate": "2020-10-22T20:08:45Z", "message": "Choose host name over host id on messages"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NTI2MDQ5", "url": "https://github.com/apache/cloudstack/pull/4418#pullrequestreview-518526049", "createdAt": "2020-10-28T10:38:38Z", "commit": {"oid": "8de5434252473a94c814afa0b3b20f902a935e88"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNTY0MTkx", "url": "https://github.com/apache/cloudstack/pull/4418#pullrequestreview-521564191", "createdAt": "2020-11-02T11:54:45Z", "commit": {"oid": "8de5434252473a94c814afa0b3b20f902a935e88"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4722, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}