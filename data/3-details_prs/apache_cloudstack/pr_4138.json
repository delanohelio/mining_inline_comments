{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyMzI3NTk4", "number": 4138, "title": "Fixed incorrect error message on invalid template type download", "bodyText": "Description\n\nWhen a template is downloaded, the first 1MB of the template is validated to determine if the template is of correct file type. On failure, the download is aborted and the input stream is set to null. This leads to a second error when the try-with-resources block tries to auto-close the stream and throws an ioexception. The \"stream closed\" error message is then written to the db.\nThis PR checks if an error has been stored before setting a new error message.\n\n\n\n\n\nFixes: #4127\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?\n\n\n\nThis has been tested by downloading an invalid template and checking the error message from the UI or in cloud.template_store_ref.error_str in the db.\nThe cleanup has been tested by restarting the management server to trigger template sync to verify if the dead template has been removed.", "createdAt": "2020-06-10T09:27:33Z", "url": "https://github.com/apache/cloudstack/pull/4138", "merged": true, "mergeCommit": {"oid": "affd010418cbe65cf87d17cbd80f0096ec9df387"}, "closed": true, "closedAt": "2020-07-15T10:29:19Z", "author": {"login": "Spaceman1984"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcp1XGxgH2gAyNDMyMzI3NTk4Ojk3NzVkZDU3ZjM3NjBmYWNiNzlhYWE2ZmRiZWZjMGNmYzRmY2U0NDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1IEvMgFqTQ0ODgyNjY0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9775dd57f3760facb79aaa6fdbefc0cfc4fce445", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/9775dd57f3760facb79aaa6fdbefc0cfc4fce445", "committedDate": "2020-06-10T08:27:11Z", "message": "Added a check for the original error message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dabb83e4abab516cdab522936aff584f64feb83d", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/dabb83e4abab516cdab522936aff584f64feb83d", "committedDate": "2020-06-10T09:14:23Z", "message": "Added some cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3OTQ1MTA3", "url": "https://github.com/apache/cloudstack/pull/4138#pullrequestreview-427945107", "createdAt": "2020-06-10T11:04:16Z", "commit": {"oid": "dabb83e4abab516cdab522936aff584f64feb83d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMTowNDoxNlrOGhv2bQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMTowNDoxNlrOGhv2bQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA0MDE3Mw==", "bodyText": "errorString contains a single space initially. String.isEmpty returns (this.value.length == 0)\nso this is never happening.", "url": "https://github.com/apache/cloudstack/pull/4138#discussion_r438040173", "createdAt": "2020-06-10T11:04:16Z", "author": {"login": "DaanHoogland"}, "path": "core/src/main/java/com/cloud/storage/template/HttpTemplateDownloader.java", "diffHunk": "@@ -218,7 +218,10 @@ public long download(boolean resume, DownloadCompleteCallback callback) {\n             errorString = hte.getMessage();\n         } catch (IOException ioe) {\n             status = TemplateDownloader.Status.UNRECOVERABLE_ERROR; //probably a file write error?\n-            errorString = ioe.getMessage();\n+            // Let's not overwrite the original error message.\n+            if (errorString.isEmpty()){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dabb83e4abab516cdab522936aff584f64feb83d"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4db5f192c1c265b41cccf9dc66559cbda158e716", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/4db5f192c1c265b41cccf9dc66559cbda158e716", "committedDate": "2020-06-10T11:36:25Z", "message": "Changed empty string check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4ODA2MDQ2", "url": "https://github.com/apache/cloudstack/pull/4138#pullrequestreview-428806046", "createdAt": "2020-06-11T11:02:09Z", "commit": {"oid": "4db5f192c1c265b41cccf9dc66559cbda158e716"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMTowMjowOVrOGiYf4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMTowMjowOVrOGiYf4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcwNjE0Ng==", "bodyText": "i'd go for errorString.trim().isEmpty() to be honest (to be more defensive, but this should work as well. And it might be wise to alter the initialisation statement as well???", "url": "https://github.com/apache/cloudstack/pull/4138#discussion_r438706146", "createdAt": "2020-06-11T11:02:09Z", "author": {"login": "DaanHoogland"}, "path": "core/src/main/java/com/cloud/storage/template/HttpTemplateDownloader.java", "diffHunk": "@@ -219,7 +219,7 @@ public long download(boolean resume, DownloadCompleteCallback callback) {\n         } catch (IOException ioe) {\n             status = TemplateDownloader.Status.UNRECOVERABLE_ERROR; //probably a file write error?\n             // Let's not overwrite the original error message.\n-            if (errorString.isEmpty()){\n+            if (errorString.equals(\" \")){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5f192c1c265b41cccf9dc66559cbda158e716"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6ccb523040b90f69fdcee831f87b78f2da625b9", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/c6ccb523040b90f69fdcee831f87b78f2da625b9", "committedDate": "2020-06-23T09:16:37Z", "message": "Initialised errorString to null and added exception when format is invalid"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MjkyOTg0", "url": "https://github.com/apache/cloudstack/pull/4138#pullrequestreview-436292984", "createdAt": "2020-06-24T03:04:21Z", "commit": {"oid": "c6ccb523040b90f69fdcee831f87b78f2da625b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMzowNDoyMVrOGoBXrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMzowNDoyMVrOGoBXrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxODY2OA==", "bodyText": "@Spaceman1984 this probably needs checking, what if the templates are OK for other secondary storages within the same zone; and across zones?", "url": "https://github.com/apache/cloudstack/pull/4138#discussion_r444618668", "createdAt": "2020-06-24T03:04:21Z", "author": {"login": "rhtyd"}, "path": "engine/storage/image/src/main/java/org/apache/cloudstack/storage/image/TemplateServiceImpl.java", "diffHunk": "@@ -489,6 +489,10 @@ public void handleTemplateSync(DataStore store) {\n                                     s_logger.info(\"Removing leftover template \" + uniqueName + \" entry from template store table\");\n                                     // remove those leftover entries\n                                     _vmTemplateStoreDao.remove(tmpltStore.getId());\n+                                    // remove from zones\n+                                    _vmTemplateZoneDao.deletePrimaryRecordsForTemplate(tmplt.getId());\n+                                    // remove template\n+                                    _templateDao.remove(tmplt.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6ccb523040b90f69fdcee831f87b78f2da625b9"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdfe7e85cf4158ded47d7b7e9a2deac9ee9ec564", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/fdfe7e85cf4158ded47d7b7e9a2deac9ee9ec564", "committedDate": "2020-06-24T10:09:14Z", "message": "Reverting this change due to unintended side effects"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5OTU0MDgw", "url": "https://github.com/apache/cloudstack/pull/4138#pullrequestreview-439954080", "createdAt": "2020-06-30T12:16:12Z", "commit": {"oid": "fdfe7e85cf4158ded47d7b7e9a2deac9ee9ec564"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMjoxNjoxM1rOGq5kJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMjoxOTo0NlrOGq5sDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYzNjUxOQ==", "bodyText": "Why not set it if errorString is null as below?", "url": "https://github.com/apache/cloudstack/pull/4138#discussion_r447636519", "createdAt": "2020-06-30T12:16:13Z", "author": {"login": "nvazquez"}, "path": "core/src/main/java/com/cloud/storage/template/HttpTemplateDownloader.java", "diffHunk": "@@ -218,7 +219,10 @@ public long download(boolean resume, DownloadCompleteCallback callback) {\n             errorString = hte.getMessage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fdfe7e85cf4158ded47d7b7e9a2deac9ee9ec564"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYzODU0MA==", "bodyText": "Minor format one: can you leave a space between the closing parenthesis and the opening brace?", "url": "https://github.com/apache/cloudstack/pull/4138#discussion_r447638540", "createdAt": "2020-06-30T12:19:46Z", "author": {"login": "nvazquez"}, "path": "core/src/main/java/com/cloud/storage/template/HttpTemplateDownloader.java", "diffHunk": "@@ -218,7 +219,10 @@ public long download(boolean resume, DownloadCompleteCallback callback) {\n             errorString = hte.getMessage();\n         } catch (IOException ioe) {\n             status = TemplateDownloader.Status.UNRECOVERABLE_ERROR; //probably a file write error?\n-            errorString = ioe.getMessage();\n+            // Let's not overwrite the original error message.\n+            if (errorString == null){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fdfe7e85cf4158ded47d7b7e9a2deac9ee9ec564"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "977335e2fad27fb52ddb5fb793c9afefb6224162", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/977335e2fad27fb52ddb5fb793c9afefb6224162", "committedDate": "2020-07-03T14:43:55Z", "message": "Formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b77a929e16b69854e4948e4e5f08609236d0bf49", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/b77a929e16b69854e4948e4e5f08609236d0bf49", "committedDate": "2020-07-03T15:08:56Z", "message": "Removed executable flag from file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNTEwMTQx", "url": "https://github.com/apache/cloudstack/pull/4138#pullrequestreview-443510141", "createdAt": "2020-07-07T01:53:43Z", "commit": {"oid": "b77a929e16b69854e4948e4e5f08609236d0bf49"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NDMyODM3", "url": "https://github.com/apache/cloudstack/pull/4138#pullrequestreview-444432837", "createdAt": "2020-07-08T05:56:34Z", "commit": {"oid": "b77a929e16b69854e4948e4e5f08609236d0bf49"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwNTo1NjozNFrOGuZLnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwNTo1NjozNFrOGuZLnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwMDI1NQ==", "bodyText": "@Spaceman1984 cc @nvazquez why are we not validating format now?", "url": "https://github.com/apache/cloudstack/pull/4138#discussion_r451300255", "createdAt": "2020-07-08T05:56:34Z", "author": {"login": "rhtyd"}, "path": "core/src/main/java/com/cloud/storage/template/HttpTemplateDownloader.java", "diffHunk": "@@ -243,7 +247,6 @@ private boolean copyBytes(File file, InputStream in, RandomAccessFile out) throw\n                 offset = writeBlock(bytes, out, block, offset);\n                 if (!verifyFormat.isVerifiedFormat() && (offset >= 1048576 || offset >= remoteSize)) { //let's check format after we get 1MB or full file\n                     verifyFormat.invoke();\n-                    if (verifyFormat.isInvalid()) return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b77a929e16b69854e4948e4e5f08609236d0bf49"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4ODI2NjQz", "url": "https://github.com/apache/cloudstack/pull/4138#pullrequestreview-448826643", "createdAt": "2020-07-15T10:28:29Z", "commit": {"oid": "b77a929e16b69854e4948e4e5f08609236d0bf49"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4360, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}