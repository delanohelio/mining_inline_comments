{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzNDYzOTQ5", "number": 4316, "title": "Handle listProjects API to list projects with user as members when listAll=true", "bodyText": "Description\n\nWhen listAll is true, listProjects API doesn't list projects that have users as members\nAdded defensive checks to overcome NPEs\n\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nHow Has This Been Tested?\nThis has been verified using the cmk and UI\nThere exists 7 projects:\nMariaDB [cloud]> select name, account_id, user_id, created, removed from project_view where removed is NULL;\n+--------------+------------+---------+---------------------+---------+\n| name         | account_id | user_id | created             | removed |\n+--------------+------------+---------+---------------------+---------+\n| Project2     |          4 |    NULL | 2020-09-09 10:08:52 | NULL    |\n| Project2     |          5 |       6 | 2020-09-09 10:08:52 | NULL    |\n| p3           |          2 |    NULL | 2020-09-09 11:43:50 | NULL    |\n| p3           |          5 |       5 | 2020-09-09 11:43:50 | NULL    |\n| Project1     |          2 |    NULL | 2020-09-09 12:36:03 | NULL    |\n| Project1     |          5 |       5 | 2020-09-09 12:36:03 | NULL    |\n| p1           |          2 |       2 | 2020-09-09 13:16:11 | NULL    |\n| p1           |          5 |       5 | 2020-09-09 13:16:11 | NULL    |\n| d1           |         12 |       8 | 2020-09-09 13:21:38 | NULL    |\n| p1           |          2 |       2 | 2020-09-09 13:16:11 | NULL    |\n| p1           |          5 |       5 | 2020-09-09 13:16:11 | NULL    |\n| p4           |         15 |      10 | 2020-09-10 05:54:44 | NULL    |\n| p41useradmin |         17 |      12 | 2020-09-10 06:23:43 | NULL    |\n| Project1     |          2 |    NULL | 2020-09-09 12:36:03 | NULL    |\n| Project1     |          5 |       5 | 2020-09-09 12:36:03 | NULL    |\n+--------------+------------+---------+---------------------+---------+\n\n\nBefore fix:\n(localcloud) SBCM5> > list projects filter=account,owner,name,id, listall=true \n{\n  \"count\": 2,\n  \"project\": [\n    {\n      \"id\": \"cab2a46a-8250-4825-85ff-e18e7275eb18\",\n      \"name\": \"p3\",\n      \"owner\": [\n        {\n          \"account\": \"admin\"\n        }\n      ]\n    },\n    {\n      \"id\": \"f0e64573-3483-4e4c-8164-c92e9efda80f\",\n      \"name\": \"Project2\",\n      \"owner\": [\n        {\n          \"account\": \"ACSUser\"\n        }\n      ]\n    }\n  ]\n}\n\nWith fix:\n(localcloud) SBCM5> > list projects filter=account,owner,name,id, listall=true \n{\n  \"count\": 7,\n  \"project\": [\n    {\n      \"id\": \"0f4a6c4f-a95e-4ea2-b840-e16eedf1085a\",\n      \"name\": \"p41useradmin\",\n      \"owner\": [\n        {\n          \"account\": \"u4\",\n          \"user\": \"u41\",\n          \"userid\": \"9d523792-a777-45c2-8b34-84052b8d4b34\"\n        }\n      ]\n    },\n    {\n      \"id\": \"352b9a95-cc6e-412f-ad1a-7671eaebfdff\",\n      \"name\": \"p4\",\n      \"owner\": [\n        {\n          \"account\": \"u3\",\n          \"user\": \"u3\",\n          \"userid\": \"41d2a5e2-f45f-479b-bc2b-3c911d2b7b46\"\n        }\n      ]\n    },\n    {\n      \"id\": \"02b5bc7b-a1e7-4e77-860e-99fd5fb30ec3\",\n      \"name\": \"d1\",\n      \"owner\": [\n        {\n          \"account\": \"dom1\",\n          \"user\": \"dom1\",\n          \"userid\": \"a534379c-804d-4a45-bf09-73e784adacb0\"\n        }\n      ]\n    },\n    {\n      \"id\": \"7ab34cd7-2403-477a-a3cf-9d03c517345c\",\n      \"name\": \"p1\",\n      \"owner\": [\n        {\n          \"account\": \"admin\",\n          \"user\": \"admin\",\n          \"userid\": \"e125c80a-eebf-11ea-ba61-1e006a013aee\"\n        },\n        {\n          \"account\": \"user1\",\n          \"user\": \"user1\",\n          \"userid\": \"705136fe-2c09-4031-873f-835ee3dfad02\"\n        }\n      ]\n    },\n    {\n      \"id\": \"f5884fbe-9ce1-4315-9a76-c1564d13dac0\",\n      \"name\": \"Project1\",\n      \"owner\": [\n        {\n          \"account\": \"admin\"\n        },\n        {\n          \"account\": \"user1\",\n          \"user\": \"user1\",\n          \"userid\": \"705136fe-2c09-4031-873f-835ee3dfad02\"\n        }\n      ]\n    },\n    {\n      \"id\": \"cab2a46a-8250-4825-85ff-e18e7275eb18\",\n      \"name\": \"p3\",\n      \"owner\": [\n        {\n          \"account\": \"admin\"\n        }\n      ]\n    },\n    {\n      \"id\": \"f0e64573-3483-4e4c-8164-c92e9efda80f\",\n      \"name\": \"Project2\",\n      \"owner\": [\n        {\n          \"account\": \"ACSUser\"\n        }\n      ]\n    }\n  ]\n}", "createdAt": "2020-09-10T07:06:54Z", "url": "https://github.com/apache/cloudstack/pull/4316", "merged": true, "mergeCommit": {"oid": "82b6971258a2f63360dbd0cb404fcf87669a5327"}, "closed": true, "closedAt": "2020-09-17T04:50:35Z", "author": {"login": "Pearl1594"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHayG1AH2gAyNDgzNDYzOTQ5OjYxZjJkYzI5Zjc3ZTRmOTEyMDY2NmJhMDMyYjIwZDA3ZWI2YTYwZTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJpiRrAFqTQ5MDIzOTQ1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "61f2dc29f77e4f9120666ba032b20d07eb6a60e3", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/61f2dc29f77e4f9120666ba032b20d07eb6a60e3", "committedDate": "2020-09-10T06:26:58Z", "message": "added defensive checks for avoiding NPE and list projects API fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9443fdc11245073bfbe5bf6dc598d39409701e0", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/b9443fdc11245073bfbe5bf6dc598d39409701e0", "committedDate": "2020-09-10T06:27:12Z", "message": "Merge branch 'master' of https://github.com/apache/cloudstack into list_project_users_filter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NjQ3MzUz", "url": "https://github.com/apache/cloudstack/pull/4316#pullrequestreview-485647353", "createdAt": "2020-09-10T07:20:23Z", "commit": {"oid": "b9443fdc11245073bfbe5bf6dc598d39409701e0"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNzoyMDoyM1rOHPmXLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNzoyMDo0MlrOHPmX9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjExOTIxNA==", "bodyText": "Are there usage of this method where throwing an exception would break flow? (or, are we expecting all usages of this method to be project related?)", "url": "https://github.com/apache/cloudstack/pull/4316#discussion_r486119214", "createdAt": "2020-09-10T07:20:23Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/com/cloud/acl/DomainChecker.java", "diffHunk": "@@ -199,6 +200,9 @@ public boolean checkAccess(Account caller, ControlledEntity entity, AccessType a\n     private boolean checkOperationPermitted(Account caller, ControlledEntity entity) {\n         User user = CallContext.current().getCallingUser();\n         Project project = projectDao.findByProjectAccountId(entity.getAccountId());\n+        if (project == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9443fdc11245073bfbe5bf6dc598d39409701e0"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjExOTQxNQ==", "bodyText": "Same as previous comment", "url": "https://github.com/apache/cloudstack/pull/4316#discussion_r486119415", "createdAt": "2020-09-10T07:20:42Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/com/cloud/network/NetworkModelImpl.java", "diffHunk": "@@ -1658,6 +1658,9 @@ public void checkNetworkPermissions(Account owner, Network network) {\n             if (owner.getType() != Account.ACCOUNT_TYPE_PROJECT && networkOwner.getType() == Account.ACCOUNT_TYPE_PROJECT) {\n                 User user = CallContext.current().getCallingUser();\n                 Project project = projectDao.findByProjectAccountId(network.getAccountId());\n+                if (project == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9443fdc11245073bfbe5bf6dc598d39409701e0"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NjUyNDA2", "url": "https://github.com/apache/cloudstack/pull/4316#pullrequestreview-485652406", "createdAt": "2020-09-10T07:27:43Z", "commit": {"oid": "b9443fdc11245073bfbe5bf6dc598d39409701e0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63c516afda6ef602ea7a754f92750a39beaf1086", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/63c516afda6ef602ea7a754f92750a39beaf1086", "committedDate": "2020-09-11T03:49:34Z", "message": "list projects with account name provided to not include users in the account in response"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMjM5NDU1", "url": "https://github.com/apache/cloudstack/pull/4316#pullrequestreview-490239455", "createdAt": "2020-09-17T04:46:06Z", "commit": {"oid": "63c516afda6ef602ea7a754f92750a39beaf1086"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4145, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}