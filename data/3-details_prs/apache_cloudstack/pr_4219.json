{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUzODI2OTI2", "number": 4219, "title": "iscsi session cleanup now configurable, filters iscsi partitions", "bodyText": "Description\nAdded property to agent.properties that enables or disables the iscsi session clean up feature. #4210\nAdded a condition to prevent disk partitions from being cleaned up. #4216\n\n\n\n\n\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?", "createdAt": "2020-07-20T20:51:41Z", "url": "https://github.com/apache/cloudstack/pull/4219", "merged": true, "mergeCommit": {"oid": "1da76d27f13e045ac88e6c494d604d6133486c9c"}, "closed": true, "closedAt": "2020-08-21T09:08:37Z", "author": {"login": "skattoju4"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3CeMBAFqTQ1MjA1MDc5Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-3JDLgBqjM2NTY4ODk4ODg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMDUwNzk2", "url": "https://github.com/apache/cloudstack/pull/4219#pullrequestreview-452050796", "createdAt": "2020-07-21T00:44:00Z", "commit": {"oid": "91648e4011a87dacecb404499daf70d088e5030a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwMDo0NDowMFrOG0kDsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwODo1NDoyM1rOG0ujqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc2OTkwNA==", "bodyText": "Considering compatibility on cases where the file remains the old one and does not receive the upgraded agent.properties (system admin can choose between keeping an old file or update it during CloudStack agent upgrade), this implementation should handle null.\n\n\nAs far as I understood, the iSCSI session cleanup works only on managed storage (e.g. Solidfire). If that is the case indeed I think that the parameter details/documentation should add details regarding when it is recommended to use it and when it is risky. Additionally, following other parameters approach, this one (maybe)  could also begin commented as it should be set to false / null on most cases.", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r457769904", "createdAt": "2020-07-21T00:44:00Z", "author": {"login": "GabrielBrascher"}, "path": "agent/conf/agent.properties", "diffHunk": "@@ -258,3 +258,6 @@ hypervisor.type=kvm\n # timer.\n # For all actions refer to the libvirt documentation.\n # Recommended values are: none, reset and poweroff.\n+#\n+iscsi.session.cleanup.enabled=false", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91648e4011a87dacecb404499daf70d088e5030a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc4ODM3OA==", "bodyText": "To be honest, I am not 100% sure on this one, but I think that (boolean)params.get(\"config\") does not handle null parameters (e.g. when commented or removed from configurations).\nCan you please take a look and run a few tests considering those cases where the parameter is not on the configuration file?\nOne approach that I know it would work is Boolean.parseBoolean; parseBoolean handles null values (value = \"null->false\", pure = true).\nExample:\nBoolean _iscsiCleanUpEnabled = Boolean.parseBoolean((String)params.get(\"iscsi.session.cleanup.enabled\"));\n        \nif (BooleanUtils.isTrue(_iscsiCleanUpEnabled)) {", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r457788378", "createdAt": "2020-07-21T01:50:51Z", "author": {"login": "GabrielBrascher"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -1156,9 +1156,15 @@ public boolean configure(final String name, final Map<String, Object> params) th\n         storageProcessor.configure(name, params);\n         storageHandler = new StorageSubsystemCommandHandlerBase(storageProcessor);\n \n-        IscsiStorageCleanupMonitor isciCleanupMonitor = new IscsiStorageCleanupMonitor();\n-        final Thread cleanupMonitor = new Thread(isciCleanupMonitor);\n-        cleanupMonitor.start();\n+        boolean _iscsiCleanUpEnabled = (boolean)params.get(\"iscsi.session.cleanup.enabled\");\n+\n+        if (_iscsiCleanUpEnabled) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91648e4011a87dacecb404499daf70d088e5030a"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzk0MTkyOA==", "bodyText": "Can you please extract \"part\" to a constant?\nAdding some details/documentation on why it is important to have this constant checked might be a plus as well.", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r457941928", "createdAt": "2020-07-21T08:54:23Z", "author": {"login": "GabrielBrascher"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -114,7 +114,7 @@ private void updateDiskStatusMapWithInactiveIscsiSessions(Connect conn){\n \n                     //check the volume map. If an entry exists change the status to True\n                     for (final LibvirtVMDef.DiskDef disk : disks) {\n-                        if (diskStatusMap.containsKey(disk.getDiskPath())) {\n+                        if (diskStatusMap.containsKey(disk.getDiskPath())&&!disk.getDiskPath().contains(\"part\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91648e4011a87dacecb404499daf70d088e5030a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNjEyNDg5", "url": "https://github.com/apache/cloudstack/pull/4219#pullrequestreview-452612489", "createdAt": "2020-07-21T16:07:58Z", "commit": {"oid": "91648e4011a87dacecb404499daf70d088e5030a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNjowNzo1OFrOG0_TBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNjowNzo1OFrOG0_TBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIxNjE5OQ==", "bodyText": "I believe you have forgotten the ';' on here.", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r458216199", "createdAt": "2020-07-21T16:07:58Z", "author": {"login": "RodrigoDLopez"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -1156,9 +1156,15 @@ public boolean configure(final String name, final Map<String, Object> params) th\n         storageProcessor.configure(name, params);\n         storageHandler = new StorageSubsystemCommandHandlerBase(storageProcessor);\n \n-        IscsiStorageCleanupMonitor isciCleanupMonitor = new IscsiStorageCleanupMonitor();\n-        final Thread cleanupMonitor = new Thread(isciCleanupMonitor);\n-        cleanupMonitor.start();\n+        boolean _iscsiCleanUpEnabled = (boolean)params.get(\"iscsi.session.cleanup.enabled\");\n+\n+        if (_iscsiCleanUpEnabled) {\n+            IscsiStorageCleanupMonitor isciCleanupMonitor = new IscsiStorageCleanupMonitor();\n+            final Thread cleanupMonitor = new Thread(isciCleanupMonitor);\n+            cleanupMonitor.start();\n+        } else {\n+            s_logger.info(\"iscsi session clean up is disabled\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91648e4011a87dacecb404499daf70d088e5030a"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNTAyMDk2", "url": "https://github.com/apache/cloudstack/pull/4219#pullrequestreview-453502096", "createdAt": "2020-07-22T16:46:53Z", "commit": {"oid": "18ad7c7b9726ef5530733bbef00f012e67585ca0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNjo0Njo1M1rOG1rRNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNjo0Njo1M1rOG1rRNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkzNjYyOQ==", "bodyText": "Is this constant used anywhere?", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r458936629", "createdAt": "2020-07-22T16:46:53Z", "author": {"login": "mike-tutkowski"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -38,6 +38,8 @@\n     private static final String ISCSI_PATH_PREFIX = \"/dev/disk/by-path\";\n     private static final String KEYWORD_ISCSI = \"iscsi\";\n     private static final String KEYWORD_IQN = \"iqn\";\n+    private static final String KEYWORD_PART = \"part\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18ad7c7b9726ef5530733bbef00f012e67585ca0"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNTAyNTQ3", "url": "https://github.com/apache/cloudstack/pull/4219#pullrequestreview-453502547", "createdAt": "2020-07-22T16:47:32Z", "commit": {"oid": "18ad7c7b9726ef5530733bbef00f012e67585ca0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNjo0NzozMlrOG1rSow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNjo0NzozMlrOG1rSow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkzNjk5NQ==", "bodyText": "Perhaps we want to use KEYWORD_PART here instead of \"part\"?", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r458936995", "createdAt": "2020-07-22T16:47:32Z", "author": {"login": "mike-tutkowski"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -38,6 +38,8 @@\n     private static final String ISCSI_PATH_PREFIX = \"/dev/disk/by-path\";\n     private static final String KEYWORD_ISCSI = \"iscsi\";\n     private static final String KEYWORD_IQN = \"iqn\";\n+    private static final String KEYWORD_PART = \"part\";\n+    private static final String REGEX_PART = \"\\\\S+part\\\\d+$\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18ad7c7b9726ef5530733bbef00f012e67585ca0"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNjM2OTg2", "url": "https://github.com/apache/cloudstack/pull/4219#pullrequestreview-453636986", "createdAt": "2020-07-22T19:54:32Z", "commit": {"oid": "7697ad6a543ad60de75cabdc645b89f85949fbe9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxOTc1NjIy", "url": "https://github.com/apache/cloudstack/pull/4219#pullrequestreview-461975622", "createdAt": "2020-08-05T19:52:26Z", "commit": {"oid": "7697ad6a543ad60de75cabdc645b89f85949fbe9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a668d042633885cf398a514af78303c26e6523ac", "author": {"user": {"login": "skattoju4", "name": "Sid Kattoju"}}, "url": "https://github.com/apache/cloudstack/commit/a668d042633885cf398a514af78303c26e6523ac", "committedDate": "2020-08-14T16:17:21Z", "message": "resolved conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0c68643c3b4aaeb0b04da24d98695dc583a3ed1", "author": {"user": {"login": "skattoju4", "name": "Sid Kattoju"}}, "url": "https://github.com/apache/cloudstack/commit/e0c68643c3b4aaeb0b04da24d98695dc583a3ed1", "committedDate": "2020-08-14T16:19:05Z", "message": "resolved conflict in clean up monitor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64bf2aaa8cea0f55ed8421dde3623e90cb57d753", "author": {"user": {"login": "skattoju4", "name": "Sid Kattoju"}}, "url": "https://github.com/apache/cloudstack/commit/64bf2aaa8cea0f55ed8421dde3623e90cb57d753", "committedDate": "2020-08-14T16:20:39Z", "message": "resolved conflict in agent properties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0e75cf2212cb6a5b719008f395796352b9aba16", "author": {"user": {"login": "skattoju4", "name": "Sid Kattoju"}}, "url": "https://github.com/apache/cloudstack/commit/b0e75cf2212cb6a5b719008f395796352b9aba16", "committedDate": "2020-08-14T16:20:52Z", "message": "use regex instead of contains"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a36abdbe05cef812573a140b515731aaddf56c0", "author": {"user": {"login": "skattoju4", "name": "Sid Kattoju"}}, "url": "https://github.com/apache/cloudstack/commit/9a36abdbe05cef812573a140b515731aaddf56c0", "committedDate": "2020-08-14T16:20:52Z", "message": "remove excess \\"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4011dfd6b1f69840be4fec8c239ae1764d9cdc2", "author": {"user": {"login": "skattoju4", "name": "Sid Kattoju"}}, "url": "https://github.com/apache/cloudstack/commit/c4011dfd6b1f69840be4fec8c239ae1764d9cdc2", "committedDate": "2020-08-14T16:20:52Z", "message": "Revert \"remove excess \\\"\n\nThis reverts commit 26776adde6b9818031b2d3e1785dbab05547b7da."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f34c9ed1850abd462388bdafa3f88faa062f921", "author": {"user": {"login": "skattoju4", "name": "Sid Kattoju"}}, "url": "https://github.com/apache/cloudstack/commit/7f34c9ed1850abd462388bdafa3f88faa062f921", "committedDate": "2020-08-14T16:20:52Z", "message": "import BooleanUtils removed unused constant"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7697ad6a543ad60de75cabdc645b89f85949fbe9", "author": {"user": {"login": "skattoju4", "name": "Sid Kattoju"}}, "url": "https://github.com/apache/cloudstack/commit/7697ad6a543ad60de75cabdc645b89f85949fbe9", "committedDate": "2020-07-22T17:25:46Z", "message": "import BooleanUtils removed unused constant"}, "afterCommit": {"oid": "7f34c9ed1850abd462388bdafa3f88faa062f921", "author": {"user": {"login": "skattoju4", "name": "Sid Kattoju"}}, "url": "https://github.com/apache/cloudstack/commit/7f34c9ed1850abd462388bdafa3f88faa062f921", "committedDate": "2020-08-14T16:20:52Z", "message": "import BooleanUtils removed unused constant"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3963, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}