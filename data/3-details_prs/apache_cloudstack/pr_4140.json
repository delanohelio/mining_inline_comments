{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyNDA2NzI0", "number": 4140, "title": "Adding showunique parameter to list templates and isos", "bodyText": "Description\nAdds a new parameter showunique to listTemplate and listIsos to return only unique templates / isos across all zones\nFixes #4041\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)", "createdAt": "2020-06-10T11:59:05Z", "url": "https://github.com/apache/cloudstack/pull/4140", "merged": true, "mergeCommit": {"oid": "e9f59e2fd3ce7a44981971f4771c335f651bf8e1"}, "closed": true, "closedAt": "2020-06-18T03:35:37Z", "author": {"login": "davidjumani"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqK9lSgFqTQyODc0OTk1NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsC3JsABqjM0NTE4NjM0MzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NzQ5OTU0", "url": "https://github.com/apache/cloudstack/pull/4140#pullrequestreview-428749954", "createdAt": "2020-06-11T09:37:13Z", "commit": {"oid": "9750d0ff2ad22f4bb9166e82f637acee5693b308"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMjk1MTA3", "url": "https://github.com/apache/cloudstack/pull/4140#pullrequestreview-430295107", "createdAt": "2020-06-15T03:00:09Z", "commit": {"oid": "c702dcd98b033572a24d284d3d25af34a047e179"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwMzowMDowOVrOGjh2Aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwMzowMDowOVrOGjh2Aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTkwNzg0Mw==", "bodyText": "@davidjumani add version 4.15", "url": "https://github.com/apache/cloudstack/pull/4140#discussion_r439907843", "createdAt": "2020-06-15T03:00:09Z", "author": {"login": "rhtyd"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/user/template/ListTemplatesCmd.java", "diffHunk": "@@ -78,6 +78,9 @@\n     @Parameter(name = ApiConstants.PARENT_TEMPLATE_ID, type = CommandType.UUID, entityType = TemplateResponse.class, description = \"list datadisk templates by parent template id\", since = \"4.4\")\n     private Long parentTemplateId;\n \n+    @Parameter(name = ApiConstants.SHOW_UNIQUE, type = CommandType.BOOLEAN, description = \"If set to true, list only unique templates across zones\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c702dcd98b033572a24d284d3d25af34a047e179"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMjk1Mjkz", "url": "https://github.com/apache/cloudstack/pull/4140#pullrequestreview-430295293", "createdAt": "2020-06-15T03:00:52Z", "commit": {"oid": "c702dcd98b033572a24d284d3d25af34a047e179"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwMzowMDo1M1rOGjh2uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwMzowMDo1M1rOGjh2uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTkwODAyNw==", "bodyText": "Can be simplified as return showUnique != null && showUnique;", "url": "https://github.com/apache/cloudstack/pull/4140#discussion_r439908027", "createdAt": "2020-06-15T03:00:53Z", "author": {"login": "rhtyd"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/user/iso/ListIsosCmd.java", "diffHunk": "@@ -118,6 +121,10 @@ public Boolean getShowRemoved() {\n         return (showRemoved != null ? showRemoved : false);\n     }\n \n+    public Boolean getShowUnique() {\n+        return (showUnique != null ? showUnique : false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c702dcd98b033572a24d284d3d25af34a047e179"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMjk1NDMy", "url": "https://github.com/apache/cloudstack/pull/4140#pullrequestreview-430295432", "createdAt": "2020-06-15T03:01:28Z", "commit": {"oid": "c702dcd98b033572a24d284d3d25af34a047e179"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwMzowMToyOVrOGjh3NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwMzowMToyOVrOGjh3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTkwODE0OQ==", "bodyText": "Please explore if you can simplify the code", "url": "https://github.com/apache/cloudstack/pull/4140#discussion_r439908149", "createdAt": "2020-06-15T03:01:29Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/com/cloud/api/query/QueryManagerImpl.java", "diffHunk": "@@ -3423,12 +3432,32 @@ else if (!template.isPublicTemplate() && caller.getType() != Account.ACCOUNT_TYP\n             return uniqueTmplPair;\n         }\n         List<TemplateJoinVO> uniqueTmpls = uniqueTmplPair.first();\n-        String[] tzIds = new String[uniqueTmpls.size()];\n         int i = 0;\n-        for (TemplateJoinVO v : uniqueTmpls) {\n-            tzIds[i++] = v.getTempZonePair();\n+        List<TemplateJoinVO> vrs = null;\n+        if (showUnique) {\n+            Long[] tzIds = new Long[uniqueTmpls.size()];\n+            for (TemplateJoinVO v : uniqueTmpls) {\n+                tzIds[i++] = v.getId();\n+            }\n+            vrs = _templateJoinDao.findByIds(tzIds);\n+\n+            // Get only unique id rows\n+            Long lastId = null;\n+            for(i = vrs.size() - 1; i >= 0; i--) {\n+                if (new Long(vrs.get(i).getId()).equals(lastId)) {\n+                    vrs.remove(i);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c702dcd98b033572a24d284d3d25af34a047e179"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwMjk1NTE4", "url": "https://github.com/apache/cloudstack/pull/4140#pullrequestreview-430295518", "createdAt": "2020-06-15T03:01:46Z", "commit": {"oid": "c702dcd98b033572a24d284d3d25af34a047e179"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMTQ5OTIx", "url": "https://github.com/apache/cloudstack/pull/4140#pullrequestreview-431149921", "createdAt": "2020-06-16T04:23:30Z", "commit": {"oid": "646771c5773ba795652ee93966f078cdc87b7860"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNDgwODcw", "url": "https://github.com/apache/cloudstack/pull/4140#pullrequestreview-431480870", "createdAt": "2020-06-16T13:05:47Z", "commit": {"oid": "c580555c27e87f59a12e52ac868df8df19fd48ff"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNDgzMTE5", "url": "https://github.com/apache/cloudstack/pull/4140#pullrequestreview-431483119", "createdAt": "2020-06-16T13:08:20Z", "commit": {"oid": "c580555c27e87f59a12e52ac868df8df19fd48ff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMzowODoyMFrOGkab8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMzowODoyMFrOGkab8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgzNTA1OQ==", "bodyText": "Unit testing for such a huge/complex method is not easy. However, it would be great to address small pieces.\nWith that said, lines 3436 - 3448 could be extracted into a method that would allow testing this specific piece of code.", "url": "https://github.com/apache/cloudstack/pull/4140#discussion_r440835059", "createdAt": "2020-06-16T13:08:20Z", "author": {"login": "GabrielBrascher"}, "path": "server/src/main/java/com/cloud/api/query/QueryManagerImpl.java", "diffHunk": "@@ -3423,12 +3432,22 @@ else if (!template.isPublicTemplate() && caller.getType() != Account.ACCOUNT_TYP\n             return uniqueTmplPair;\n         }\n         List<TemplateJoinVO> uniqueTmpls = uniqueTmplPair.first();\n-        String[] tzIds = new String[uniqueTmpls.size()];\n         int i = 0;\n-        for (TemplateJoinVO v : uniqueTmpls) {\n-            tzIds[i++] = v.getTempZonePair();\n+        List<TemplateJoinVO> vrs = null;\n+        if (showUnique) {\n+            Long[] tzIds = new Long[uniqueTmpls.size()];\n+            for (TemplateJoinVO v : uniqueTmpls) {\n+                tzIds[i++] = v.getId();\n+            }\n+            vrs = _templateJoinDao.findByDistinctIds(tzIds);\n+        } else {\n+            String[] tzIds = new String[uniqueTmpls.size()];\n+            for (TemplateJoinVO v : uniqueTmpls) {\n+                tzIds[i++] = v.getTempZonePair();\n+            }\n+            vrs = _templateJoinDao.searchByTemplateZonePair(showRemovedTmpl, tzIds);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c580555c27e87f59a12e52ac868df8df19fd48ff"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMDAzOTU3", "url": "https://github.com/apache/cloudstack/pull/4140#pullrequestreview-432003957", "createdAt": "2020-06-17T01:49:57Z", "commit": {"oid": "c580555c27e87f59a12e52ac868df8df19fd48ff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwMTo0OTo1N1rOGky1pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwMTo0OTo1N1rOGky1pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIzNDg1NA==", "bodyText": "@davidjumani make it defensive, for example do a null check on ids", "url": "https://github.com/apache/cloudstack/pull/4140#discussion_r441234854", "createdAt": "2020-06-17T01:49:57Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/com/cloud/api/query/dao/TemplateJoinDaoImpl.java", "diffHunk": "@@ -481,4 +488,14 @@ public TemplateResponse newIsoResponse(TemplateJoinVO iso) {\n         return new Pair<List<TemplateJoinVO>, Integer>(objects, count);\n     }\n \n+    @Override\n+    public List<TemplateJoinVO> findByDistinctIds(Long... ids) {\n+        if (ids.length == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c580555c27e87f59a12e52ac868df8df19fd48ff"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMDA5MjA4", "url": "https://github.com/apache/cloudstack/pull/4140#pullrequestreview-432009208", "createdAt": "2020-06-17T02:06:54Z", "commit": {"oid": "c580555c27e87f59a12e52ac868df8df19fd48ff"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwMjowNjo1NFrOGkzG9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwMjowNjo1NFrOGkzG9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIzOTI4Ng==", "bodyText": "@davidjumani nit - let's refactor and use a more modern form of writing code, the current code looks less like Java, more like C/C++; can be written as:\nLong[] templateIds = uniqueTmpls.stream().map(template -> template.getId()).toArray(Long[]::new);", "url": "https://github.com/apache/cloudstack/pull/4140#discussion_r441239286", "createdAt": "2020-06-17T02:06:54Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/com/cloud/api/query/QueryManagerImpl.java", "diffHunk": "@@ -3423,12 +3432,22 @@ else if (!template.isPublicTemplate() && caller.getType() != Account.ACCOUNT_TYP\n             return uniqueTmplPair;\n         }\n         List<TemplateJoinVO> uniqueTmpls = uniqueTmplPair.first();\n-        String[] tzIds = new String[uniqueTmpls.size()];\n         int i = 0;\n-        for (TemplateJoinVO v : uniqueTmpls) {\n-            tzIds[i++] = v.getTempZonePair();\n+        List<TemplateJoinVO> vrs = null;\n+        if (showUnique) {\n+            Long[] tzIds = new Long[uniqueTmpls.size()];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c580555c27e87f59a12e52ac868df8df19fd48ff"}, "originalPosition": 54}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c71dae81cfec13ca81b347ec58eb2cd7cf29917", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/9c71dae81cfec13ca81b347ec58eb2cd7cf29917", "committedDate": "2020-06-17T04:40:45Z", "message": "Refactoring for showUnique templates"}, "afterCommit": {"oid": "b271cb3e6d0c72b35b5789bb4fd1608a2a10a907", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/b271cb3e6d0c72b35b5789bb4fd1608a2a10a907", "committedDate": "2020-06-17T04:42:34Z", "message": "Refactoring for showUnique templates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMDU3MTE1", "url": "https://github.com/apache/cloudstack/pull/4140#pullrequestreview-432057115", "createdAt": "2020-06-17T04:53:25Z", "commit": {"oid": "b271cb3e6d0c72b35b5789bb4fd1608a2a10a907"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b271cb3e6d0c72b35b5789bb4fd1608a2a10a907", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/b271cb3e6d0c72b35b5789bb4fd1608a2a10a907", "committedDate": "2020-06-17T04:42:34Z", "message": "Refactoring for showUnique templates"}, "afterCommit": {"oid": "35b5bfa2bd95b08a9a5cb61b50716504f7b00ef3", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/35b5bfa2bd95b08a9a5cb61b50716504f7b00ef3", "committedDate": "2020-06-17T05:07:00Z", "message": "Refactoring for showUnique templates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2501452faeb473b355abc8ba9cc318b493285a9", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/b2501452faeb473b355abc8ba9cc318b493285a9", "committedDate": "2020-06-17T05:17:36Z", "message": "Adding showunique parameter to list templates and isos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "775e4872b104fd9238555025960de8108d3320a0", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/775e4872b104fd9238555025960de8108d3320a0", "committedDate": "2020-06-17T05:17:46Z", "message": "Update ListIsosCmd.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77ba5a873a97046cfa1ab4ad32a438d2894d1cd3", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/77ba5a873a97046cfa1ab4ad32a438d2894d1cd3", "committedDate": "2020-06-17T05:17:52Z", "message": "Update ListTemplatesCmd.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9f48ff2d20d2b5dfb35a80341ef4cf9c4ac5cf6", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/e9f48ff2d20d2b5dfb35a80341ef4cf9c4ac5cf6", "committedDate": "2020-06-17T05:17:55Z", "message": "Update ListIsosCmd.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1997abf22c2d694e11ed6bd50e7a5ffabeb277ee", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/1997abf22c2d694e11ed6bd50e7a5ffabeb277ee", "committedDate": "2020-06-17T05:18:02Z", "message": "Fixing count bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ccdfd190ff50d5c98fdec3ec9e3e59e5668aa36", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/8ccdfd190ff50d5c98fdec3ec9e3e59e5668aa36", "committedDate": "2020-06-17T05:18:07Z", "message": "Simplifying"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94963dffc16583a4dc8805c70fa11cf41c7f56b5", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/94963dffc16583a4dc8805c70fa11cf41c7f56b5", "committedDate": "2020-06-17T05:18:20Z", "message": "Update ListTemplatesCmd.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b83a4c47046d782114d74f32056150a89bd0190c", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/b83a4c47046d782114d74f32056150a89bd0190c", "committedDate": "2020-06-17T05:18:24Z", "message": "Update ListIsosCmd.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83bd4177373f131c64107983b90a806aacb46c5f", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/83bd4177373f131c64107983b90a806aacb46c5f", "committedDate": "2020-06-17T05:18:28Z", "message": "fix trailing white space - remind me to not use Github editor\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28137f6283093793c66497e97c3e101b12062429", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/28137f6283093793c66497e97c3e101b12062429", "committedDate": "2020-06-17T05:18:32Z", "message": "Refactoring for showUnique templates"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "35b5bfa2bd95b08a9a5cb61b50716504f7b00ef3", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/35b5bfa2bd95b08a9a5cb61b50716504f7b00ef3", "committedDate": "2020-06-17T05:07:00Z", "message": "Refactoring for showUnique templates"}, "afterCommit": {"oid": "28137f6283093793c66497e97c3e101b12062429", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/28137f6283093793c66497e97c3e101b12062429", "committedDate": "2020-06-17T05:18:32Z", "message": "Refactoring for showUnique templates"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4365, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}