{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0MTk1OTYw", "number": 3819, "title": "Clean up inactive iscsi sessions when VMs get moved due to crashes", "bodyText": "Description\n\nPreviously, iscsi sessions would not be cleaned up on KVM when\n\nvms are crashed or rebooted on another host\na hypervisor host crashed and ha enabled vms\n\nThis leads to to long boot times from the hypervisor host and session overloading of the netapp solidfire nodes. Each node can have a maximum of 700 iSCSI sessions. The iSCSI Daemon on the hypervisor host holds iSCSI sessions that are not cleaned up. The iSCSI Daemon tried to reconnect every time resulting in holding the unused sessions. Only a logout of the iSCSI daemon to the volume will solve the problem. This changes adds a kvm.storage.IscsiStorageCleanupMonitor class that scans for and cleans up inactive iscsi sessions.\nsteps to reproduce:\n\ncheck there are a vm is running and sessions to Netapp Solidfire are there \u00ecscsiadm -m session -P 0\ncrash the kvm host (e.g. power off, be sure there are running vms on it) or destroy a virtual machine (virsh destroy vmname)\nlook with \u00ecscsiadm -m session -P 0 and you will see sessions they should not be there\n\n\n\n\n\n\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?\n\n\n\nThis has been tested by observing that inactive iscsi sessions are cleaned up when VMs are removed.", "createdAt": "2020-01-17T15:31:59Z", "url": "https://github.com/apache/cloudstack/pull/3819", "merged": true, "mergeCommit": {"oid": "6baa598033fa3f78b5b0144275de8c1404f67f29"}, "closed": true, "closedAt": "2020-01-30T18:52:29Z", "author": {"login": "skattoju4"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9KVnNAFqTM0NzI5MjM4MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_J527AFqTM1MDMxMzc4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MjkyMzgx", "url": "https://github.com/apache/cloudstack/pull/3819#pullrequestreview-347292381", "createdAt": "2020-01-23T13:26:41Z", "commit": {"oid": "c7e8f6982f5435b15996b55c0f1368539fa015e8"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMzoyNjo0MVrOFg9_dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMzoyNjo0MVrOFg9_dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDExNDQyMw==", "bodyText": "you need a license here to pass (rat failure)", "url": "https://github.com/apache/cloudstack/pull/3819#discussion_r370114423", "createdAt": "2020-01-23T13:26:41Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -0,0 +1,127 @@\n+package com.cloud.hypervisor.kvm.storage;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7e8f6982f5435b15996b55c0f1368539fa015e8"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3NDcwNTgz", "url": "https://github.com/apache/cloudstack/pull/3819#pullrequestreview-347470583", "createdAt": "2020-01-23T17:16:35Z", "commit": {"oid": "c7e8f6982f5435b15996b55c0f1368539fa015e8"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNzoxNjozNlrOFhGNmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNzozOTo1OVrOFhG51Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI0OTExNA==", "bodyText": "I am OK with the way it is, but I would like to raise the following question: Is it interesting to externalize CLEANUP_INTERVAL_SEC this on a global settings variable (config keys)?", "url": "https://github.com/apache/cloudstack/pull/3819#discussion_r370249114", "createdAt": "2020-01-23T17:16:36Z", "author": {"login": "GabrielBrascher"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -0,0 +1,127 @@\n+package com.cloud.hypervisor.kvm.storage;\n+\n+import com.cloud.hypervisor.kvm.resource.LibvirtConnection;\n+import com.cloud.hypervisor.kvm.resource.LibvirtDomainXMLParser;\n+import com.cloud.hypervisor.kvm.resource.LibvirtVMDef;\n+import org.apache.cloudstack.managed.context.ManagedContextRunnable;\n+import org.apache.log4j.Logger;\n+import org.libvirt.Connect;\n+import org.libvirt.Domain;\n+import org.libvirt.LibvirtException;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class IscsiStorageCleanupMonitor implements Runnable{\n+    private static final Logger s_logger = Logger.getLogger(IscsiStorageCleanupMonitor.class);\n+    private static final int CLEANUP_INTERVAL_SEC = 60; // check every X seconds", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7e8f6982f5435b15996b55c0f1368539fa015e8"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI2MDQzNw==", "bodyText": "I would recommend creating a few methods  (e.g. checkIfIscsSessionBelongAnyVm(Connect), etc) which would allow documenting (Javadoc) and creating unit tests (JUnit).", "url": "https://github.com/apache/cloudstack/pull/3819#discussion_r370260437", "createdAt": "2020-01-23T17:39:59Z", "author": {"login": "GabrielBrascher"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -0,0 +1,127 @@\n+package com.cloud.hypervisor.kvm.storage;\n+\n+import com.cloud.hypervisor.kvm.resource.LibvirtConnection;\n+import com.cloud.hypervisor.kvm.resource.LibvirtDomainXMLParser;\n+import com.cloud.hypervisor.kvm.resource.LibvirtVMDef;\n+import org.apache.cloudstack.managed.context.ManagedContextRunnable;\n+import org.apache.log4j.Logger;\n+import org.libvirt.Connect;\n+import org.libvirt.Domain;\n+import org.libvirt.LibvirtException;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class IscsiStorageCleanupMonitor implements Runnable{\n+    private static final Logger s_logger = Logger.getLogger(IscsiStorageCleanupMonitor.class);\n+    private static final int CLEANUP_INTERVAL_SEC = 60; // check every X seconds\n+    private static final String ISCSI_PATH_PREFIX = \"/dev/disk/by-path\";\n+    private static final String KEYWORD_ISCSI = \"iscsi\";\n+    private static final String KEYWORD_IQN = \"iqn\";\n+\n+    private IscsiAdmStorageAdaptor iscsiStorageAdaptor;\n+\n+    private Map<String, Boolean> diskStatusMap;\n+\n+    public IscsiStorageCleanupMonitor() {\n+        diskStatusMap = new HashMap<>();\n+        s_logger.debug(\"Initialize cleanup thread\");\n+        iscsiStorageAdaptor = new IscsiAdmStorageAdaptor();\n+    }\n+\n+\n+    private class Monitor extends ManagedContextRunnable {\n+\n+        @Override\n+        protected void runInContext() {\n+            Connect conn = null;\n+            try {\n+                conn = LibvirtConnection.getConnection();\n+\n+                //populate all the iscsi disks currently attached to this host\n+                diskStatusMap.clear();\n+                File[] iscsiVolumes = new File(ISCSI_PATH_PREFIX).listFiles();\n+\n+                if (iscsiVolumes == null || iscsiVolumes.length == 0) {\n+                    s_logger.debug(\"No iscsi sessions found for cleanup\");\n+                    return;\n+                }\n+\n+                for( File v : iscsiVolumes) {\n+                    if (isIscsiDisk(v.getAbsolutePath())) {\n+                        s_logger.debug(\"found iscsi disk by cleanup thread, marking inactive:\" + v.getAbsolutePath());\n+                        diskStatusMap.put(v.getAbsolutePath(), false);\n+                    }\n+                }\n+\n+                // check if they belong to any VM\n+                int[] domains = conn.listDomains();\n+                s_logger.debug(String.format(\"found %d domains\", domains.length));\n+                for (int domId : domains) {\n+                    Domain dm = conn.domainLookupByID(domId);\n+                    final String domXml = dm.getXMLDesc(0);\n+                    final LibvirtDomainXMLParser parser = new LibvirtDomainXMLParser();\n+                    parser.parseDomainXML(domXml);\n+                    List<LibvirtVMDef.DiskDef> disks = parser.getDisks();\n+\n+                    //check the volume map. If an entry exists change the status to True\n+                    for (final LibvirtVMDef.DiskDef disk : disks) {\n+                        if (diskStatusMap.containsKey(disk.getDiskPath())) {\n+                            diskStatusMap.put(disk.getDiskPath(), true);\n+                            s_logger.debug(\"active disk found by cleanup thread\" + disk.getDiskPath());\n+                        }\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7e8f6982f5435b15996b55c0f1368539fa015e8"}, "originalPosition": 77}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d253980efc7001a83d4f563f18d377f1696619bd", "author": {"user": {"login": "skattoju4", "name": "Sid Kattoju"}}, "url": "https://github.com/apache/cloudstack/commit/d253980efc7001a83d4f563f18d377f1696619bd", "committedDate": "2020-01-27T19:21:08Z", "message": "Merge branch 'iscsi-session-cleanup-master' of github.com:syed/cloudstack into iscsi-session-cleanup-master"}, "afterCommit": {"oid": "cc3402fbf6bfe28cd6be37cfdcf161f34e3e63c5", "author": {"user": {"login": "syed", "name": "Syed Mushtaq Ahmed"}}, "url": "https://github.com/apache/cloudstack/commit/cc3402fbf6bfe28cd6be37cfdcf161f34e3e63c5", "committedDate": "2020-01-27T16:10:19Z", "message": "Merge pull request #7 from skattoju4/patch-1\n\nadd apache license to IscsiStorageCleanupMonitor.java"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc3402fbf6bfe28cd6be37cfdcf161f34e3e63c5", "author": {"user": {"login": "syed", "name": "Syed Mushtaq Ahmed"}}, "url": "https://github.com/apache/cloudstack/commit/cc3402fbf6bfe28cd6be37cfdcf161f34e3e63c5", "committedDate": "2020-01-27T16:10:19Z", "message": "Merge pull request #7 from skattoju4/patch-1\n\nadd apache license to IscsiStorageCleanupMonitor.java"}, "afterCommit": {"oid": "a750ce07dd1d3af117c3a1c6eef7540a35f49b83", "author": {"user": {"login": "skattoju4", "name": "Sid Kattoju"}}, "url": "https://github.com/apache/cloudstack/commit/a750ce07dd1d3af117c3a1c6eef7540a35f49b83", "committedDate": "2020-01-27T20:17:12Z", "message": "Update IscsiStorageCleanupMonitor.java\n\nadd apache license"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a750ce07dd1d3af117c3a1c6eef7540a35f49b83", "author": {"user": {"login": "skattoju4", "name": "Sid Kattoju"}}, "url": "https://github.com/apache/cloudstack/commit/a750ce07dd1d3af117c3a1c6eef7540a35f49b83", "committedDate": "2020-01-27T20:17:12Z", "message": "Update IscsiStorageCleanupMonitor.java\n\nadd apache license"}, "afterCommit": {"oid": "932a98b7e6c17df418869b3da3ec332dc4e8543d", "author": {"user": {"login": "skattoju4", "name": "Sid Kattoju"}}, "url": "https://github.com/apache/cloudstack/commit/932a98b7e6c17df418869b3da3ec332dc4e8543d", "committedDate": "2020-01-27T20:59:48Z", "message": "Update IscsiStorageCleanupMonitor.java\n\nadd apache license"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ad47e5ac41a66277d82fd4ec01f786086389548", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/0ad47e5ac41a66277d82fd4ec01f786086389548", "committedDate": "2020-01-27T21:33:34Z", "message": "ISCI Session cleanup for KVM managed storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d06cf28b60b3ffc191e68731071e3e407ad863d", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/6d06cf28b60b3ffc191e68731071e3e407ad863d", "committedDate": "2020-01-27T21:33:41Z", "message": "Remove the key delete logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bf605ba335241d81280092823a7a0e4bb1570db", "author": {"user": {"login": "skattoju4", "name": "Sid Kattoju"}}, "url": "https://github.com/apache/cloudstack/commit/0bf605ba335241d81280092823a7a0e4bb1570db", "committedDate": "2020-01-27T21:33:51Z", "message": "Update IscsiStorageCleanupMonitor.java\n\nadd apache license"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "932a98b7e6c17df418869b3da3ec332dc4e8543d", "author": {"user": {"login": "skattoju4", "name": "Sid Kattoju"}}, "url": "https://github.com/apache/cloudstack/commit/932a98b7e6c17df418869b3da3ec332dc4e8543d", "committedDate": "2020-01-27T20:59:48Z", "message": "Update IscsiStorageCleanupMonitor.java\n\nadd apache license"}, "afterCommit": {"oid": "0bf605ba335241d81280092823a7a0e4bb1570db", "author": {"user": {"login": "skattoju4", "name": "Sid Kattoju"}}, "url": "https://github.com/apache/cloudstack/commit/0bf605ba335241d81280092823a7a0e4bb1570db", "committedDate": "2020-01-27T21:33:51Z", "message": "Update IscsiStorageCleanupMonitor.java\n\nadd apache license"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MzkzNzY3", "url": "https://github.com/apache/cloudstack/pull/3819#pullrequestreview-349393767", "createdAt": "2020-01-28T14:00:25Z", "commit": {"oid": "0bf605ba335241d81280092823a7a0e4bb1570db"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NDUyOTU4", "url": "https://github.com/apache/cloudstack/pull/3819#pullrequestreview-349452958", "createdAt": "2020-01-28T15:12:46Z", "commit": {"oid": "0bf605ba335241d81280092823a7a0e4bb1570db"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NTQwMzY0", "url": "https://github.com/apache/cloudstack/pull/3819#pullrequestreview-349540364", "createdAt": "2020-01-28T16:55:32Z", "commit": {"oid": "0bf605ba335241d81280092823a7a0e4bb1570db"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNjo1NTozMlrOFisysg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNjo1NTozMlrOFisysg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTkyOTc3OA==", "bodyText": "long method with a lot of comment. can you please factor out the pieces that need commenting in their own method with clear names? that would make this thread code more maintainable for future generations.", "url": "https://github.com/apache/cloudstack/pull/3819#discussion_r371929778", "createdAt": "2020-01-28T16:55:32Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -0,0 +1,143 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package com.cloud.hypervisor.kvm.storage;\n+\n+import com.cloud.hypervisor.kvm.resource.LibvirtConnection;\n+import com.cloud.hypervisor.kvm.resource.LibvirtDomainXMLParser;\n+import com.cloud.hypervisor.kvm.resource.LibvirtVMDef;\n+import org.apache.cloudstack.managed.context.ManagedContextRunnable;\n+import org.apache.log4j.Logger;\n+import org.libvirt.Connect;\n+import org.libvirt.Domain;\n+import org.libvirt.LibvirtException;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class IscsiStorageCleanupMonitor implements Runnable{\n+    private static final Logger s_logger = Logger.getLogger(IscsiStorageCleanupMonitor.class);\n+    private static final int CLEANUP_INTERVAL_SEC = 60; // check every X seconds\n+    private static final String ISCSI_PATH_PREFIX = \"/dev/disk/by-path\";\n+    private static final String KEYWORD_ISCSI = \"iscsi\";\n+    private static final String KEYWORD_IQN = \"iqn\";\n+\n+    private IscsiAdmStorageAdaptor iscsiStorageAdaptor;\n+\n+    private Map<String, Boolean> diskStatusMap;\n+\n+    public IscsiStorageCleanupMonitor() {\n+        diskStatusMap = new HashMap<>();\n+        s_logger.debug(\"Initialize cleanup thread\");\n+        iscsiStorageAdaptor = new IscsiAdmStorageAdaptor();\n+    }\n+\n+\n+    private class Monitor extends ManagedContextRunnable {\n+\n+        @Override\n+        protected void runInContext() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bf605ba335241d81280092823a7a0e4bb1570db"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NTQzMDI4", "url": "https://github.com/apache/cloudstack/pull/3819#pullrequestreview-349543028", "createdAt": "2020-01-28T16:58:54Z", "commit": {"oid": "0bf605ba335241d81280092823a7a0e4bb1570db"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNjo1ODo1NFrOFis6ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNjo1ODo1NFrOFis6ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTkzMTg0Mw==", "bodyText": "populateDiskStatusMap();", "url": "https://github.com/apache/cloudstack/pull/3819#discussion_r371931843", "createdAt": "2020-01-28T16:58:54Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -0,0 +1,143 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package com.cloud.hypervisor.kvm.storage;\n+\n+import com.cloud.hypervisor.kvm.resource.LibvirtConnection;\n+import com.cloud.hypervisor.kvm.resource.LibvirtDomainXMLParser;\n+import com.cloud.hypervisor.kvm.resource.LibvirtVMDef;\n+import org.apache.cloudstack.managed.context.ManagedContextRunnable;\n+import org.apache.log4j.Logger;\n+import org.libvirt.Connect;\n+import org.libvirt.Domain;\n+import org.libvirt.LibvirtException;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class IscsiStorageCleanupMonitor implements Runnable{\n+    private static final Logger s_logger = Logger.getLogger(IscsiStorageCleanupMonitor.class);\n+    private static final int CLEANUP_INTERVAL_SEC = 60; // check every X seconds\n+    private static final String ISCSI_PATH_PREFIX = \"/dev/disk/by-path\";\n+    private static final String KEYWORD_ISCSI = \"iscsi\";\n+    private static final String KEYWORD_IQN = \"iqn\";\n+\n+    private IscsiAdmStorageAdaptor iscsiStorageAdaptor;\n+\n+    private Map<String, Boolean> diskStatusMap;\n+\n+    public IscsiStorageCleanupMonitor() {\n+        diskStatusMap = new HashMap<>();\n+        s_logger.debug(\"Initialize cleanup thread\");\n+        iscsiStorageAdaptor = new IscsiAdmStorageAdaptor();\n+    }\n+\n+\n+    private class Monitor extends ManagedContextRunnable {\n+\n+        @Override\n+        protected void runInContext() {\n+            Connect conn = null;\n+            try {\n+                conn = LibvirtConnection.getConnection();\n+\n+                //populate all the iscsi disks currently attached to this host\n+                diskStatusMap.clear();\n+                File[] iscsiVolumes = new File(ISCSI_PATH_PREFIX).listFiles();\n+\n+                if (iscsiVolumes == null || iscsiVolumes.length == 0) {\n+                    s_logger.debug(\"No iscsi sessions found for cleanup\");\n+                    return;\n+                }\n+\n+                for( File v : iscsiVolumes) {\n+                    if (isIscsiDisk(v.getAbsolutePath())) {\n+                        s_logger.debug(\"found iscsi disk by cleanup thread, marking inactive:\" + v.getAbsolutePath());\n+                        diskStatusMap.put(v.getAbsolutePath(), false);\n+                    }\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bf605ba335241d81280092823a7a0e4bb1570db"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NTQzMzY2", "url": "https://github.com/apache/cloudstack/pull/3819#pullrequestreview-349543366", "createdAt": "2020-01-28T16:59:21Z", "commit": {"oid": "0bf605ba335241d81280092823a7a0e4bb1570db"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNjo1OToyMlrOFis7ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNjo1OToyMlrOFis7ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTkzMjA5MA==", "bodyText": "checkDiskStatusMap();", "url": "https://github.com/apache/cloudstack/pull/3819#discussion_r371932090", "createdAt": "2020-01-28T16:59:22Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -0,0 +1,143 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package com.cloud.hypervisor.kvm.storage;\n+\n+import com.cloud.hypervisor.kvm.resource.LibvirtConnection;\n+import com.cloud.hypervisor.kvm.resource.LibvirtDomainXMLParser;\n+import com.cloud.hypervisor.kvm.resource.LibvirtVMDef;\n+import org.apache.cloudstack.managed.context.ManagedContextRunnable;\n+import org.apache.log4j.Logger;\n+import org.libvirt.Connect;\n+import org.libvirt.Domain;\n+import org.libvirt.LibvirtException;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class IscsiStorageCleanupMonitor implements Runnable{\n+    private static final Logger s_logger = Logger.getLogger(IscsiStorageCleanupMonitor.class);\n+    private static final int CLEANUP_INTERVAL_SEC = 60; // check every X seconds\n+    private static final String ISCSI_PATH_PREFIX = \"/dev/disk/by-path\";\n+    private static final String KEYWORD_ISCSI = \"iscsi\";\n+    private static final String KEYWORD_IQN = \"iqn\";\n+\n+    private IscsiAdmStorageAdaptor iscsiStorageAdaptor;\n+\n+    private Map<String, Boolean> diskStatusMap;\n+\n+    public IscsiStorageCleanupMonitor() {\n+        diskStatusMap = new HashMap<>();\n+        s_logger.debug(\"Initialize cleanup thread\");\n+        iscsiStorageAdaptor = new IscsiAdmStorageAdaptor();\n+    }\n+\n+\n+    private class Monitor extends ManagedContextRunnable {\n+\n+        @Override\n+        protected void runInContext() {\n+            Connect conn = null;\n+            try {\n+                conn = LibvirtConnection.getConnection();\n+\n+                //populate all the iscsi disks currently attached to this host\n+                diskStatusMap.clear();\n+                File[] iscsiVolumes = new File(ISCSI_PATH_PREFIX).listFiles();\n+\n+                if (iscsiVolumes == null || iscsiVolumes.length == 0) {\n+                    s_logger.debug(\"No iscsi sessions found for cleanup\");\n+                    return;\n+                }\n+\n+                for( File v : iscsiVolumes) {\n+                    if (isIscsiDisk(v.getAbsolutePath())) {\n+                        s_logger.debug(\"found iscsi disk by cleanup thread, marking inactive:\" + v.getAbsolutePath());\n+                        diskStatusMap.put(v.getAbsolutePath(), false);\n+                    }\n+                }\n+\n+                // check if they belong to any VM\n+                int[] domains = conn.listDomains();\n+                s_logger.debug(String.format(\"found %d domains\", domains.length));\n+                for (int domId : domains) {\n+                    Domain dm = conn.domainLookupByID(domId);\n+                    final String domXml = dm.getXMLDesc(0);\n+                    final LibvirtDomainXMLParser parser = new LibvirtDomainXMLParser();\n+                    parser.parseDomainXML(domXml);\n+                    List<LibvirtVMDef.DiskDef> disks = parser.getDisks();\n+\n+                    //check the volume map. If an entry exists change the status to True\n+                    for (final LibvirtVMDef.DiskDef disk : disks) {\n+                        if (diskStatusMap.containsKey(disk.getDiskPath())) {\n+                            diskStatusMap.put(disk.getDiskPath(), true);\n+                            s_logger.debug(\"active disk found by cleanup thread\" + disk.getDiskPath());\n+                        }\n+                    }\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bf605ba335241d81280092823a7a0e4bb1570db"}, "originalPosition": 94}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NTQzNzI2", "url": "https://github.com/apache/cloudstack/pull/3819#pullrequestreview-349543726", "createdAt": "2020-01-28T16:59:49Z", "commit": {"oid": "0bf605ba335241d81280092823a7a0e4bb1570db"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNjo1OTo0OVrOFis8zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNjo1OTo0OVrOFis8zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTkzMjM2Nw==", "bodyText": "space needed in log message before the path.", "url": "https://github.com/apache/cloudstack/pull/3819#discussion_r371932367", "createdAt": "2020-01-28T16:59:49Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -0,0 +1,143 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package com.cloud.hypervisor.kvm.storage;\n+\n+import com.cloud.hypervisor.kvm.resource.LibvirtConnection;\n+import com.cloud.hypervisor.kvm.resource.LibvirtDomainXMLParser;\n+import com.cloud.hypervisor.kvm.resource.LibvirtVMDef;\n+import org.apache.cloudstack.managed.context.ManagedContextRunnable;\n+import org.apache.log4j.Logger;\n+import org.libvirt.Connect;\n+import org.libvirt.Domain;\n+import org.libvirt.LibvirtException;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class IscsiStorageCleanupMonitor implements Runnable{\n+    private static final Logger s_logger = Logger.getLogger(IscsiStorageCleanupMonitor.class);\n+    private static final int CLEANUP_INTERVAL_SEC = 60; // check every X seconds\n+    private static final String ISCSI_PATH_PREFIX = \"/dev/disk/by-path\";\n+    private static final String KEYWORD_ISCSI = \"iscsi\";\n+    private static final String KEYWORD_IQN = \"iqn\";\n+\n+    private IscsiAdmStorageAdaptor iscsiStorageAdaptor;\n+\n+    private Map<String, Boolean> diskStatusMap;\n+\n+    public IscsiStorageCleanupMonitor() {\n+        diskStatusMap = new HashMap<>();\n+        s_logger.debug(\"Initialize cleanup thread\");\n+        iscsiStorageAdaptor = new IscsiAdmStorageAdaptor();\n+    }\n+\n+\n+    private class Monitor extends ManagedContextRunnable {\n+\n+        @Override\n+        protected void runInContext() {\n+            Connect conn = null;\n+            try {\n+                conn = LibvirtConnection.getConnection();\n+\n+                //populate all the iscsi disks currently attached to this host\n+                diskStatusMap.clear();\n+                File[] iscsiVolumes = new File(ISCSI_PATH_PREFIX).listFiles();\n+\n+                if (iscsiVolumes == null || iscsiVolumes.length == 0) {\n+                    s_logger.debug(\"No iscsi sessions found for cleanup\");\n+                    return;\n+                }\n+\n+                for( File v : iscsiVolumes) {\n+                    if (isIscsiDisk(v.getAbsolutePath())) {\n+                        s_logger.debug(\"found iscsi disk by cleanup thread, marking inactive:\" + v.getAbsolutePath());\n+                        diskStatusMap.put(v.getAbsolutePath(), false);\n+                    }\n+                }\n+\n+                // check if they belong to any VM\n+                int[] domains = conn.listDomains();\n+                s_logger.debug(String.format(\"found %d domains\", domains.length));\n+                for (int domId : domains) {\n+                    Domain dm = conn.domainLookupByID(domId);\n+                    final String domXml = dm.getXMLDesc(0);\n+                    final LibvirtDomainXMLParser parser = new LibvirtDomainXMLParser();\n+                    parser.parseDomainXML(domXml);\n+                    List<LibvirtVMDef.DiskDef> disks = parser.getDisks();\n+\n+                    //check the volume map. If an entry exists change the status to True\n+                    for (final LibvirtVMDef.DiskDef disk : disks) {\n+                        if (diskStatusMap.containsKey(disk.getDiskPath())) {\n+                            diskStatusMap.put(disk.getDiskPath(), true);\n+                            s_logger.debug(\"active disk found by cleanup thread\" + disk.getDiskPath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bf605ba335241d81280092823a7a0e4bb1570db"}, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NTQ2Nzcy", "url": "https://github.com/apache/cloudstack/pull/3819#pullrequestreview-349546772", "createdAt": "2020-01-28T17:03:58Z", "commit": {"oid": "0bf605ba335241d81280092823a7a0e4bb1570db"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNzowMzo1OFrOFitGIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNzowMzo1OFrOFitGIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTkzNDc1Mg==", "bodyText": "disconnectPhysicalDisks();", "url": "https://github.com/apache/cloudstack/pull/3819#discussion_r371934752", "createdAt": "2020-01-28T17:03:58Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -0,0 +1,143 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package com.cloud.hypervisor.kvm.storage;\n+\n+import com.cloud.hypervisor.kvm.resource.LibvirtConnection;\n+import com.cloud.hypervisor.kvm.resource.LibvirtDomainXMLParser;\n+import com.cloud.hypervisor.kvm.resource.LibvirtVMDef;\n+import org.apache.cloudstack.managed.context.ManagedContextRunnable;\n+import org.apache.log4j.Logger;\n+import org.libvirt.Connect;\n+import org.libvirt.Domain;\n+import org.libvirt.LibvirtException;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class IscsiStorageCleanupMonitor implements Runnable{\n+    private static final Logger s_logger = Logger.getLogger(IscsiStorageCleanupMonitor.class);\n+    private static final int CLEANUP_INTERVAL_SEC = 60; // check every X seconds\n+    private static final String ISCSI_PATH_PREFIX = \"/dev/disk/by-path\";\n+    private static final String KEYWORD_ISCSI = \"iscsi\";\n+    private static final String KEYWORD_IQN = \"iqn\";\n+\n+    private IscsiAdmStorageAdaptor iscsiStorageAdaptor;\n+\n+    private Map<String, Boolean> diskStatusMap;\n+\n+    public IscsiStorageCleanupMonitor() {\n+        diskStatusMap = new HashMap<>();\n+        s_logger.debug(\"Initialize cleanup thread\");\n+        iscsiStorageAdaptor = new IscsiAdmStorageAdaptor();\n+    }\n+\n+\n+    private class Monitor extends ManagedContextRunnable {\n+\n+        @Override\n+        protected void runInContext() {\n+            Connect conn = null;\n+            try {\n+                conn = LibvirtConnection.getConnection();\n+\n+                //populate all the iscsi disks currently attached to this host\n+                diskStatusMap.clear();\n+                File[] iscsiVolumes = new File(ISCSI_PATH_PREFIX).listFiles();\n+\n+                if (iscsiVolumes == null || iscsiVolumes.length == 0) {\n+                    s_logger.debug(\"No iscsi sessions found for cleanup\");\n+                    return;\n+                }\n+\n+                for( File v : iscsiVolumes) {\n+                    if (isIscsiDisk(v.getAbsolutePath())) {\n+                        s_logger.debug(\"found iscsi disk by cleanup thread, marking inactive:\" + v.getAbsolutePath());\n+                        diskStatusMap.put(v.getAbsolutePath(), false);\n+                    }\n+                }\n+\n+                // check if they belong to any VM\n+                int[] domains = conn.listDomains();\n+                s_logger.debug(String.format(\"found %d domains\", domains.length));\n+                for (int domId : domains) {\n+                    Domain dm = conn.domainLookupByID(domId);\n+                    final String domXml = dm.getXMLDesc(0);\n+                    final LibvirtDomainXMLParser parser = new LibvirtDomainXMLParser();\n+                    parser.parseDomainXML(domXml);\n+                    List<LibvirtVMDef.DiskDef> disks = parser.getDisks();\n+\n+                    //check the volume map. If an entry exists change the status to True\n+                    for (final LibvirtVMDef.DiskDef disk : disks) {\n+                        if (diskStatusMap.containsKey(disk.getDiskPath())) {\n+                            diskStatusMap.put(disk.getDiskPath(), true);\n+                            s_logger.debug(\"active disk found by cleanup thread\" + disk.getDiskPath());\n+                        }\n+                    }\n+                }\n+\n+                // the ones where the state is false, they are stale. They may be\n+                // removed we go through each volume which is false, check iscsiadm,\n+                // if the volume still exisits, logout of that volume and remove it from the map\n+\n+                // XXX: It is possible that someone had manually added an iSCSI volume.\n+                // we would not be able to detect that\n+                for (String diskPath : diskStatusMap.keySet()) {\n+                    if (!diskStatusMap.get(diskPath)) {\n+                        if (Files.exists(Paths.get(diskPath))) {\n+                            try {\n+                                s_logger.info(\"Cleaning up disk \" + diskPath);\n+                                iscsiStorageAdaptor.disconnectPhysicalDiskByPath(diskPath);\n+                            } catch (Exception e) {\n+                                s_logger.warn(\"[ignored] Error cleaning up \" + diskPath, e);\n+                            }\n+                        }\n+                    }\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bf605ba335241d81280092823a7a0e4bb1570db"}, "originalPosition": 113}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NTQ4MjE2", "url": "https://github.com/apache/cloudstack/pull/3819#pullrequestreview-349548216", "createdAt": "2020-01-28T17:05:57Z", "commit": {"oid": "0bf605ba335241d81280092823a7a0e4bb1570db"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f34eca68d2e21161e9fa9b88a3a5bd756f1ed733", "author": {"user": {"login": "skattoju4", "name": "Sid Kattoju"}}, "url": "https://github.com/apache/cloudstack/commit/f34eca68d2e21161e9fa9b88a3a5bd756f1ed733", "committedDate": "2020-01-28T18:51:40Z", "message": "factor code into methods"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMzEzNzg3", "url": "https://github.com/apache/cloudstack/pull/3819#pullrequestreview-350313787", "createdAt": "2020-01-29T18:04:30Z", "commit": {"oid": "f34eca68d2e21161e9fa9b88a3a5bd756f1ed733"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4541, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}