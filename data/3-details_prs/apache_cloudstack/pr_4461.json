{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5MDc4MzEz", "number": 4461, "title": "Fix destroying k8s cluster on shared networks", "bodyText": "Description\nDeletion of K8s cluster on shared networks fails due to attempt to clear network rules, however, no network rules get added for clusters brought up on Shared networks.\n2020-11-10 16:46:26,125 WARN  [c.c.k.c.a.KubernetesClusterActionWorker] (API-Job-Executor-7:ctx-46554d1f job-67 ctx-cf887921) (logid:ed80132a) Failed to remove network rules of Kubernetes cluster : c1\ncom.cloud.exception.ManagementServerException: No source NAT IP addresses found for network : shared1\n        at com.cloud.kubernetes.cluster.actionworkers.KubernetesClusterDestroyWorker.deleteKubernetesClusterNetworkRules(KubernetesClusterDestroyWorker.java:145)\n        at com.cloud.kubernetes.cluster.actionworkers.KubernetesClusterDestroyWorker.destroy(KubernetesClusterDestroyWorker.java:242)\n        at com.cloud.kubernetes.cluster.KubernetesClusterManagerImpl.deleteKubernetesCluster(KubernetesClusterManagerImpl.java:1144)\n        at org.apache.cloudstack.api.command.user.kubernetes.cluster.DeleteKubernetesClusterCmd.execute(DeleteKubernetesClusterCmd.java:77)\n        at com.cloud.api.ApiDispatcher.dispatch(ApiDispatcher.java:156)\n        at com.cloud.api.ApiAsyncJobDispatcher.runJob(ApiAsyncJobDispatcher.java:108)\n        at org.apache.cloudstack.framework.jobs.impl.AsyncJobManagerImpl$5.runInContext(AsyncJobManagerImpl.java:620)\n        at org.apache.cloudstack.managed.context.ManagedContextRunnable$1.run(ManagedContextRunnable.java:48)\n        at org.apache.cloudstack.managed.context.impl.DefaultManagedContext$1.call(DefaultManagedContext.java:55)\n        at org.apache.cloudstack.managed.context.impl.DefaultManagedContext.callWithContext(DefaultManagedContext.java:102)\n        at org.apache.cloudstack.managed.context.impl.DefaultManagedContext.runWithContext(DefaultManagedContext.java:52)\n        at org.apache.cloudstack.managed.context.ManagedContextRunnable.run(ManagedContextRunnable.java:45)\n        at org.apache.cloudstack.framework.jobs.impl.AsyncJobManagerImpl$5.run(AsyncJobManagerImpl.java:568)\n        at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)\n        at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)\n        at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\n        at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\n\n\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nHow Has This Been Tested?\nDeployed a cluster on a shared network and then cleaned it up", "createdAt": "2020-11-11T09:45:28Z", "url": "https://github.com/apache/cloudstack/pull/4461", "merged": true, "mergeCommit": {"oid": "1692df421c94eed4a40e5a03a3f7f8794b359464"}, "closed": true, "closedAt": "2020-11-18T23:21:57Z", "author": {"login": "Pearl1594"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbb1hKgFqTUyODA2OTA1Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABddvqZQgFqTUzMzU0NjU0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MDY5MDU3", "url": "https://github.com/apache/cloudstack/pull/4461#pullrequestreview-528069057", "createdAt": "2020-11-11T10:59:04Z", "commit": {"oid": "452dd2f7e6ff2ddc0be2e3ed2b67014d2317c74e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMDo1OTowNFrOHxISuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMDo1OTowNFrOHxISuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI3ODEzNw==", "bodyText": "I know I'm not a nice guy, but can we please have new code in separate methods:\nprivate void checkForRulesToDelete(){\n    NetworkVO kubernetesClusterNetwork = networkDao.findById(kubernetesCluster.getNetworkId());\n    if (kubernetesClusterNetwork != null && kubernetesClusterNetwork.getGuestType() != Network.GuestType.Shared) {\n        deleteKubernetesClusterNetworkRules();\n    }\n}\n\nand then\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                NetworkVO kubernetesClusterNetwork = networkDao.findById(kubernetesCluster.getNetworkId());\n          \n          \n            \n                                if (kubernetesClusterNetwork != null && kubernetesClusterNetwork.getGuestType() != Network.GuestType.Shared) {\n          \n          \n            \n                                    deleteKubernetesClusterNetworkRules();\n          \n          \n            \n                                }\n          \n          \n            \n                                checkForRulesToDelete();", "url": "https://github.com/apache/cloudstack/pull/4461#discussion_r521278137", "createdAt": "2020-11-11T10:59:04Z", "author": {"login": "DaanHoogland"}, "path": "plugins/integrations/kubernetes-service/src/main/java/com/cloud/kubernetes/cluster/actionworkers/KubernetesClusterDestroyWorker.java", "diffHunk": "@@ -239,7 +240,10 @@ public boolean destroy() throws CloudRuntimeException {\n                 }\n             } else {\n                 try {\n-                    deleteKubernetesClusterNetworkRules();\n+                    NetworkVO kubernetesClusterNetwork = networkDao.findById(kubernetesCluster.getNetworkId());\n+                    if (kubernetesClusterNetwork != null && kubernetesClusterNetwork.getGuestType() != Network.GuestType.Shared) {\n+                        deleteKubernetesClusterNetworkRules();\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "452dd2f7e6ff2ddc0be2e3ed2b67014d2317c74e"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNzU4NzA5", "url": "https://github.com/apache/cloudstack/pull/4461#pullrequestreview-532758709", "createdAt": "2020-11-17T19:53:59Z", "commit": {"oid": "cf2e01112763f20d5907da146bc7d01a14c4e8e2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0bceaa7693b53246c1f6e397dbae7b588a2f5f2", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/b0bceaa7693b53246c1f6e397dbae7b588a2f5f2", "committedDate": "2020-11-18T09:56:17Z", "message": "Fix destroying k8s cluster on shared networks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b09f3c3e16ce06dfeccf200b778a8a4763b5fc1", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/7b09f3c3e16ce06dfeccf200b778a8a4763b5fc1", "committedDate": "2020-11-18T09:56:58Z", "message": "Extracted code"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cf2e01112763f20d5907da146bc7d01a14c4e8e2", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/cf2e01112763f20d5907da146bc7d01a14c4e8e2", "committedDate": "2020-11-11T13:09:15Z", "message": "Extracted code"}, "afterCommit": {"oid": "7b09f3c3e16ce06dfeccf200b778a8a4763b5fc1", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/7b09f3c3e16ce06dfeccf200b778a8a4763b5fc1", "committedDate": "2020-11-18T09:56:58Z", "message": "Extracted code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNTQ2NTQ1", "url": "https://github.com/apache/cloudstack/pull/4461#pullrequestreview-533546545", "createdAt": "2020-11-18T15:12:53Z", "commit": {"oid": "7b09f3c3e16ce06dfeccf200b778a8a4763b5fc1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4784, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}