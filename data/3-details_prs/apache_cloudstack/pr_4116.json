{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0NjAxMDI0", "number": 4116, "title": "cks: fix template, deployment issues", "bodyText": "Description\nFixes #4056\nFixes #4107\nFixes #4113\nFixes #4133\nCheck for compute offering host tags while finding suitable host/deployment destination for k8s cluster node VM during deploy and scale cluster.\nCheck for k8s cluster template's hypervisor type during scale as the template is tied to the k8s cluster therefore new node VM must be deployed in the same hypervisor host.\nFixes template checks\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?", "createdAt": "2020-05-28T16:31:51Z", "url": "https://github.com/apache/cloudstack/pull/4116", "merged": true, "mergeCommit": {"oid": "a7f56d41c8bc04383d4f2c67cf5433e496cdc7a5"}, "closed": true, "closedAt": "2020-08-04T05:57:33Z", "author": {"login": "shwstppr"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpGkAQAFqTQyNTg3ODY1OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6FRMsAFqTQ1ODcxNTM3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1ODc4NjU4", "url": "https://github.com/apache/cloudstack/pull/4116#pullrequestreview-425878658", "createdAt": "2020-06-08T01:55:43Z", "commit": {"oid": "8c6861bdc0f6b9fbf58a1c099f36ba08348dd204"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwMTo1NTo0M1rOGgNXwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwMTo1NTo0M1rOGgNXwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQyNjY4OQ==", "bodyText": "Remove unused/commented method", "url": "https://github.com/apache/cloudstack/pull/4116#discussion_r436426689", "createdAt": "2020-06-08T01:55:43Z", "author": {"login": "rhtyd"}, "path": "engine/schema/src/main/java/com/cloud/storage/dao/VMTemplateDao.java", "diffHunk": "@@ -36,6 +36,8 @@\n \n     public VMTemplateVO findByTemplateName(String templateName);\n \n+    public VMTemplateVO findValidByTemplateName(String templateName);\n+\n     // public void update(VMTemplateVO template);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c6861bdc0f6b9fbf58a1c099f36ba08348dd204"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1ODc4NzU5", "url": "https://github.com/apache/cloudstack/pull/4116#pullrequestreview-425878759", "createdAt": "2020-06-08T01:56:13Z", "commit": {"oid": "8c6861bdc0f6b9fbf58a1c099f36ba08348dd204"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwMTo1NjoxM1rOGgNYIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwMTo1NjoxM1rOGgNYIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjQyNjc4Nw==", "bodyText": "Is logAndThrow a new utility?", "url": "https://github.com/apache/cloudstack/pull/4116#discussion_r436426787", "createdAt": "2020-06-08T01:56:13Z", "author": {"login": "rhtyd"}, "path": "plugins/integrations/kubernetes-service/src/main/java/com/cloud/kubernetes/cluster/KubernetesClusterManagerImpl.java", "diffHunk": "@@ -908,6 +910,10 @@ private void validateKubernetesClusterUpgradeParameters(UpgradeKubernetesCluster\n         if (!KubernetesCluster.State.Running.equals(kubernetesCluster.getState())) {\n             throw new InvalidParameterValueException(String.format(\"Kubernetes cluster ID: %s is not in running state\", kubernetesCluster.getUuid()));\n         }\n+        final DataCenter zone = dataCenterDao.findById(kubernetesCluster.getZoneId());\n+        if (zone == null) {\n+            logAndThrow(Level.WARN, String.format(\"Unable to find zone for Kubernetes cluster ID: %s\", kubernetesCluster.getUuid()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c6861bdc0f6b9fbf58a1c099f36ba08348dd204"}, "originalPosition": 92}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMTgzNDMz", "url": "https://github.com/apache/cloudstack/pull/4116#pullrequestreview-431183433", "createdAt": "2020-06-16T06:04:56Z", "commit": {"oid": "d4b763f79146fafee693af54132f2290b9597b28"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MzI1MDM3", "url": "https://github.com/apache/cloudstack/pull/4116#pullrequestreview-434325037", "createdAt": "2020-06-19T20:27:02Z", "commit": {"oid": "d4b763f79146fafee693af54132f2290b9597b28"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQyMDoyNzowMlrOGmgbig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQyMDoyNzowMlrOGmgbig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAzMDQxMA==", "bodyText": "The call public List<TemplateJoinVO> newTemplateView(VirtualMachineTemplate template, long zoneId, boolean readyOnly) as implemented in TemplateJoinDaoImpl, does a search including removed leading to a hit for a template that is not available. Is this intended?", "url": "https://github.com/apache/cloudstack/pull/4116#discussion_r443030410", "createdAt": "2020-06-19T20:27:02Z", "author": {"login": "DaanHoogland"}, "path": "plugins/integrations/kubernetes-service/src/main/java/com/cloud/kubernetes/cluster/KubernetesClusterManagerImpl.java", "diffHunk": "@@ -300,8 +294,7 @@ private boolean isKubernetesServiceTemplateConfigured(DataCenter zone) {\n                 LOGGER.warn(String.format(\"Unable to find the template %s to be used for provisioning Kubernetes cluster nodes\", templateName));\n                 return false;\n             }\n-            List<VMTemplateZoneVO> listZoneTemplate = templateZoneDao.listByZoneTemplate(zone.getId(), template.getId());\n-            if (listZoneTemplate == null || listZoneTemplate.isEmpty()) {\n+            if (CollectionUtils.isEmpty(templateJoinDao.newTemplateView(template, zone.getId(), true))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4b763f79146fafee693af54132f2290b9597b28"}, "originalPosition": 41}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d4b763f79146fafee693af54132f2290b9597b28", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/d4b763f79146fafee693af54132f2290b9597b28", "committedDate": "2020-06-08T05:22:39Z", "message": "cleanup\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}, "afterCommit": {"oid": "3c66d2a8acc2bee290e0c198509e1a5e855037ea", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/3c66d2a8acc2bee290e0c198509e1a5e855037ea", "committedDate": "2020-06-24T19:00:51Z", "message": "cleanup\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "223f3562e4c3a21d49f4ec591673028d14a718f7", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/223f3562e4c3a21d49f4ec591673028d14a718f7", "committedDate": "2020-07-08T22:10:06Z", "message": "wrong condition\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}, "afterCommit": {"oid": "10d604a2710a3a77e08be1df46978862192a2f0c", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/10d604a2710a3a77e08be1df46978862192a2f0c", "committedDate": "2020-07-08T22:25:44Z", "message": "Merge branch 'master' into fix-cks-template-name-bug-4107"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "10d604a2710a3a77e08be1df46978862192a2f0c", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/10d604a2710a3a77e08be1df46978862192a2f0c", "committedDate": "2020-07-08T22:25:44Z", "message": "Merge branch 'master' into fix-cks-template-name-bug-4107"}, "afterCommit": {"oid": "6a02e2e2167a5f49ab9f98325fae40e4ac2fe1e1", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/6a02e2e2167a5f49ab9f98325fae40e4ac2fe1e1", "committedDate": "2020-07-08T22:31:30Z", "message": "wrong condition\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6a02e2e2167a5f49ab9f98325fae40e4ac2fe1e1", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/6a02e2e2167a5f49ab9f98325fae40e4ac2fe1e1", "committedDate": "2020-07-08T22:31:30Z", "message": "wrong condition\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}, "afterCommit": {"oid": "05b4eff6ed755ffcb85a1d426b91c2a2181ec7a4", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/05b4eff6ed755ffcb85a1d426b91c2a2181ec7a4", "committedDate": "2020-07-08T22:33:59Z", "message": "cks: fixes\n\nFixes deployment, template and network deletion.\nAlso allows filetering in listKubernetesSupportedVersions with keyword\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "05b4eff6ed755ffcb85a1d426b91c2a2181ec7a4", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/05b4eff6ed755ffcb85a1d426b91c2a2181ec7a4", "committedDate": "2020-07-08T22:33:59Z", "message": "cks: fixes\n\nFixes deployment, template and network deletion.\nAlso allows filetering in listKubernetesSupportedVersions with keyword\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}, "afterCommit": {"oid": "94c31d3f7c526f84b70475f4293bd529a19bafb0", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/94c31d3f7c526f84b70475f4293bd529a19bafb0", "committedDate": "2020-07-08T22:39:01Z", "message": "cks: fixes\n\nFixes deployment, template and network deletion.\nAlso allows filetering in listKubernetesSupportedVersions with keyword\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23369e52774d1de838360a531ff492446aa8c405", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/23369e52774d1de838360a531ff492446aa8c405", "committedDate": "2020-07-08T22:42:52Z", "message": "cks: fixes\n\nFixes deployment, template and network deletion.\nAlso allows filetering in listKubernetesSupportedVersions with keyword\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "94c31d3f7c526f84b70475f4293bd529a19bafb0", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/94c31d3f7c526f84b70475f4293bd529a19bafb0", "committedDate": "2020-07-08T22:39:01Z", "message": "cks: fixes\n\nFixes deployment, template and network deletion.\nAlso allows filetering in listKubernetesSupportedVersions with keyword\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}, "afterCommit": {"oid": "23369e52774d1de838360a531ff492446aa8c405", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/23369e52774d1de838360a531ff492446aa8c405", "committedDate": "2020-07-08T22:42:52Z", "message": "cks: fixes\n\nFixes deployment, template and network deletion.\nAlso allows filetering in listKubernetesSupportedVersions with keyword\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NzE1Mzc2", "url": "https://github.com/apache/cloudstack/pull/4116#pullrequestreview-458715376", "createdAt": "2020-07-30T20:02:00Z", "commit": {"oid": "23369e52774d1de838360a531ff492446aa8c405"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4329, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}