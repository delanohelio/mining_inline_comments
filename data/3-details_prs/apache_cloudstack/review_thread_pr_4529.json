{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1ODY4NzAy", "number": 4529, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwODo0NTo1NlrOFD4NBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwOTozNjo0M1rOFD5gvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5NjEwODg0OnYy", "diffSide": "RIGHT", "path": "systemvm/debian/opt/cloud/bin/cs/CsDhcp.py", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwODo0NTo1NlrOIDuuvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwODo0ODowNVrOIDuzkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc4MjI3MQ==", "bodyText": "same as above - can you check if the lease should have a high expiry (80yrs or inf?) instead of *, I'm not sure what 0 and * mean here", "url": "https://github.com/apache/cloudstack/pull/4529#discussion_r540782271", "createdAt": "2020-12-11T08:45:56Z", "author": {"login": "rhtyd"}, "path": "systemvm/debian/opt/cloud/bin/cs/CsDhcp.py", "diffHunk": "@@ -196,6 +203,9 @@ def add(self, entry):\n             self.dhcp_opts.add(\"%s,%s\" % (tag, 3))\n             self.dhcp_opts.add(\"%s,%s\" % (tag, 6))\n             self.dhcp_opts.add(\"%s,%s\" % (tag, 15))\n+            self.dhcp_leases.search(entry['mac_address'], \"0 %s %s %s *\" % (entry['mac_address'],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ac4c78a4233688545e9760c67df861243eb5cc3"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc4MzUwNQ==", "bodyText": "0 is infinite lease time (generally the epoch when the lease expires), * is the client id (which is generally the mac, but can change)\nTaken this format from existing leases file\nhttps://dnsmasq-discuss.thekelleys.org.narkive.com/ia9YNLmE/dnsmasq-leases-file-format-specification", "url": "https://github.com/apache/cloudstack/pull/4529#discussion_r540783505", "createdAt": "2020-12-11T08:48:05Z", "author": {"login": "davidjumani"}, "path": "systemvm/debian/opt/cloud/bin/cs/CsDhcp.py", "diffHunk": "@@ -196,6 +203,9 @@ def add(self, entry):\n             self.dhcp_opts.add(\"%s,%s\" % (tag, 3))\n             self.dhcp_opts.add(\"%s,%s\" % (tag, 6))\n             self.dhcp_opts.add(\"%s,%s\" % (tag, 15))\n+            self.dhcp_leases.search(entry['mac_address'], \"0 %s %s %s *\" % (entry['mac_address'],", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc4MjI3MQ=="}, "originalCommit": {"oid": "1ac4c78a4233688545e9760c67df861243eb5cc3"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5NjMyMzE5OnYy", "diffSide": "RIGHT", "path": "systemvm/debian/opt/cloud/bin/cs/CsDhcp.py", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwOTozNjo0M1rOIDwpNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMDoxNzozNFrOIDyO0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgxMzYyMg==", "bodyText": "@rhtyd @davidjumani\nthe only issue I see is, dnsmasq will be restarted each time when conf/host/dhcp lease is changed.\nif there are many vms in the network, might it be a problem ?\nit is not caused by this pr , but the line above\n        if self.cloud.commit():\n            restart_dnsmasq = True\n\nmight it be better to restart dnsmasq when all are processed ?", "url": "https://github.com/apache/cloudstack/pull/4529#discussion_r540813622", "createdAt": "2020-12-11T09:36:43Z", "author": {"login": "weizhouapache"}, "path": "systemvm/debian/opt/cloud/bin/cs/CsDhcp.py", "diffHunk": "@@ -60,6 +61,9 @@ def process(self):\n         if self.cloud.commit():\n             restart_dnsmasq = True\n \n+        if self.dhcp_leases.commit():\n+            restart_dnsmasq = True", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f1a4446c340f150d4f8ebb02e671aafd97a670a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgxNjYzMw==", "bodyText": "From what I could see at https://github.com/apache/cloudstack/blob/master/systemvm/debian/opt/cloud/bin/cs/CsFile.py#L58, a commit returns a boolean value of whether the file has changed, so if it tries to add a host which already exists in the file, it shouldn't restart dnsmasq", "url": "https://github.com/apache/cloudstack/pull/4529#discussion_r540816633", "createdAt": "2020-12-11T09:41:23Z", "author": {"login": "davidjumani"}, "path": "systemvm/debian/opt/cloud/bin/cs/CsDhcp.py", "diffHunk": "@@ -60,6 +61,9 @@ def process(self):\n         if self.cloud.commit():\n             restart_dnsmasq = True\n \n+        if self.dhcp_leases.commit():\n+            restart_dnsmasq = True", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgxMzYyMg=="}, "originalCommit": {"oid": "3f1a4446c340f150d4f8ebb02e671aafd97a670a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgxNzg0Ng==", "bodyText": "@rhtyd @davidjumani no worries, it looks good.\n2020-12-11 09:39:48,228 INFO     Processing JSON file cmd_line.json\n2020-12-11 09:39:49,165 INFO     Wrote edited file /etc/dnsmasq.d/cloud.conf\n2020-12-11 09:39:49,166 INFO     Nothing to commit. The /var/lib/misc/dnsmasq.leases file did not change\n2020-12-11 09:39:49,166 INFO     Attempting to delete entries from dnsmasq.leases file for VMs which are not on dhcphosts file\n2020-12-11 09:39:49,167 ERROR    Caught error while trying to delete entries from dnsmasq.leases file: [Errno 2] No such file or directory: '/etc/dhcphosts.txt'\n2020-12-11 09:39:49,168 INFO     Executing: systemctl restart dnsmasq\n2020-12-11 09:39:49,704 INFO     Service dnsmasq restart\n2020-12-11 09:39:49,795 INFO     Nothing to commit. The /etc/dnsmasq.d/cloud.conf file did not change\n2020-12-11 09:39:49,795 INFO     Nothing to commit. The /var/lib/misc/dnsmasq.leases file did not change\n2020-12-11 09:39:49,795 INFO     Executing: systemctl is-active dnsmasq\n2020-12-11 09:39:49,820 INFO     Executing: systemctl reload dnsmasq\n2020-12-11 09:39:49,878 INFO     Service dnsmasq reload\n2020-12-11 09:40:11,302 INFO     Processing JSON file ip_associations.json.a72a28ec-caed-4f3a-908f-e8d8df726d57\n2020-12-11 09:40:11,910 INFO     Processing JSON file monitor_service.json.335af30e-fd9e-44b1-a6c0-248a98c480db\n2020-12-11 09:40:12,587 INFO     Processing JSON file vm_dhcp_entry.json.afaa3985-b0e0-4f2f-bd73-f61282006e0e\n2020-12-11 09:40:12,794 INFO     Processing JSON file vm_dhcp_entry.json.fbba4e25-3569-4513-99ab-39d9f38a80d2\n2020-12-11 09:40:13,129 INFO     Processing JSON file vm_dhcp_entry.json.b6a1f368-180b-4a48-b664-22aa8e89cfba\n2020-12-11 09:40:13,530 INFO     Processing JSON file vm_metadata.json.ab86c2c2-acfc-4d01-8e4b-bd11ae7101ed\n2020-12-11 09:40:13,993 INFO     Processing JSON file vm_metadata.json.8750a124-ba49-4fb5-8484-50ff65971f9a\n2020-12-11 09:40:14,256 INFO     Processing JSON file vm_metadata.json.72e3d268-5e11-4bcd-a693-ab8fc599718b\n2020-12-11 09:40:14,713 INFO     Wrote edited file /etc/dnsmasq.d/cloud.conf\n2020-12-11 09:40:14,714 INFO     Wrote edited file /var/lib/misc/dnsmasq.leases\n2020-12-11 09:40:14,715 INFO     Attempting to delete entries from dnsmasq.leases file for VMs which are not on dhcphosts file\n2020-12-11 09:40:14,724 INFO     Deleted 0 entries from dnsmasq.leases file\n2020-12-11 09:40:14,725 INFO     Executing: systemctl restart dnsmasq\n2020-12-11 09:40:14,866 INFO     Service dnsmasq restart\n2020-12-11 09:40:23,530 INFO     Processing JSON file firewall_rules.json.0b59db02-5eb7-44b3-a6d7-2ab3f1ad03b5\n2020-12-11 09:40:24,646 INFO     Nothing to commit. The /etc/dnsmasq.d/cloud.conf file did not change\n2020-12-11 09:40:24,646 INFO     Nothing to commit. The /var/lib/misc/dnsmasq.leases file did not change\n2020-12-11 09:40:24,648 INFO     Executing: systemctl is-active dnsmasq\n2020-12-11 09:40:24,660 INFO     Executing: systemctl reload dnsmasq\n2020-12-11 09:40:24,688 INFO     Service dnsmasq reload", "url": "https://github.com/apache/cloudstack/pull/4529#discussion_r540817846", "createdAt": "2020-12-11T09:43:11Z", "author": {"login": "weizhouapache"}, "path": "systemvm/debian/opt/cloud/bin/cs/CsDhcp.py", "diffHunk": "@@ -60,6 +61,9 @@ def process(self):\n         if self.cloud.commit():\n             restart_dnsmasq = True\n \n+        if self.dhcp_leases.commit():\n+            restart_dnsmasq = True", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgxMzYyMg=="}, "originalCommit": {"oid": "3f1a4446c340f150d4f8ebb02e671aafd97a670a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgxOTg3Nw==", "bodyText": "From what I could see at https://github.com/apache/cloudstack/blob/master/systemvm/debian/opt/cloud/bin/cs/CsFile.py#L58, a commit returns a boolean value of whether the file has changed, so if it tries to add a host which already exists in the file, it shouldn't restart dnsmasq\n\n@davidjumani from my testing, dnsmasq will be restarted each time when start a vm.\nit's better to reload it. not a big problem.\n2020-12-11 09:44:56,927 INFO     Processing JSON file vm_dhcp_entry.json.c0a11309-5ec0-4166-8c17-ae2c56a44b8e\n2020-12-11 09:44:57,244 INFO     Nothing to commit. The /etc/dnsmasq.d/cloud.conf file did not change\n2020-12-11 09:44:57,244 INFO     Wrote edited file /var/lib/misc/dnsmasq.leases\n2020-12-11 09:44:57,245 INFO     Attempting to delete entries from dnsmasq.leases file for VMs which are not on dhcphosts file\n2020-12-11 09:44:57,245 INFO     Deleted 0 entries from dnsmasq.leases file\n2020-12-11 09:44:57,245 INFO     Executing: systemctl restart dnsmasq\n2020-12-11 09:44:57,366 INFO     Service dnsmasq restart\n2020-12-11 09:44:58,253 INFO     Processing JSON file vm_metadata.json.250b5ba8-fd86-4dcb-86ef-2bc6c634d224", "url": "https://github.com/apache/cloudstack/pull/4529#discussion_r540819877", "createdAt": "2020-12-11T09:46:26Z", "author": {"login": "weizhouapache"}, "path": "systemvm/debian/opt/cloud/bin/cs/CsDhcp.py", "diffHunk": "@@ -60,6 +61,9 @@ def process(self):\n         if self.cloud.commit():\n             restart_dnsmasq = True\n \n+        if self.dhcp_leases.commit():\n+            restart_dnsmasq = True", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgxMzYyMg=="}, "originalCommit": {"oid": "3f1a4446c340f150d4f8ebb02e671aafd97a670a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgyNzQxMw==", "bodyText": "That's linked to #3613\nI can create a separate PR to change it globally, but that will require extensive testing", "url": "https://github.com/apache/cloudstack/pull/4529#discussion_r540827413", "createdAt": "2020-12-11T09:58:06Z", "author": {"login": "davidjumani"}, "path": "systemvm/debian/opt/cloud/bin/cs/CsDhcp.py", "diffHunk": "@@ -60,6 +61,9 @@ def process(self):\n         if self.cloud.commit():\n             restart_dnsmasq = True\n \n+        if self.dhcp_leases.commit():\n+            restart_dnsmasq = True", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgxMzYyMg=="}, "originalCommit": {"oid": "3f1a4446c340f150d4f8ebb02e671aafd97a670a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgzOTYzMg==", "bodyText": "That's linked to #3613\nI can create a separate PR to change it globally, but that will require extensive testing\n\n@davidjumani yeah.\n@rhtyd this is ready for merge.", "url": "https://github.com/apache/cloudstack/pull/4529#discussion_r540839632", "createdAt": "2020-12-11T10:17:34Z", "author": {"login": "weizhouapache"}, "path": "systemvm/debian/opt/cloud/bin/cs/CsDhcp.py", "diffHunk": "@@ -60,6 +61,9 @@ def process(self):\n         if self.cloud.commit():\n             restart_dnsmasq = True\n \n+        if self.dhcp_leases.commit():\n+            restart_dnsmasq = True", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgxMzYyMg=="}, "originalCommit": {"oid": "3f1a4446c340f150d4f8ebb02e671aafd97a670a"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4032, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}