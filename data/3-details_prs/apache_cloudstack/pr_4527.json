{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1MjI5MTc4", "number": 4527, "title": "kvm: set cpu topology only if cpucore per socket is set", "bodyText": "Description\nThis PR fixes a regression issue in #4497\nIn cloudstack 4.14 or before, the cpu topology is set only when cpucore per socket is set (to 4 or 6).\nin other conditions, there is no cpu topology in vm xml definition.\nwith #4497, vm will have cpu topology in its xml definition, if cpucore per socket is not set.\n    <topology sockets='<vm cpu cores>' cores='1' threads='1'/>\n\nNot sure if it causes any issue. I think it would be better not to add this part in vm xml definition if cpucore per socket is not set.\nfyi, in https://libvirt.org/formatdomain.html#cpu-model-and-topology, it says\ntopology\nThe topology element specifies requested topology of virtual CPU provided to the guest. Four attributes, sockets, dies, cores, and threads, accept non-zero positive integer values. They refer to the number of CPU sockets per NUMA node, number of dies per socket, number of cores per die, and number of threads per core, respectively. The dies attribute is optional and will default to 1 if omitted, while the other attributes are all mandatory. Hypervisors may require that the maximum number of vCPUs specified by the cpus element equals to the number of vcpus resulting from the topology.\n\n\n\n\n\n\n\n\n\n\n\nTypes of changes\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nFeature/Enhancement Scale or Bug Severity\nBug Severity\n\n BLOCKER\n Critical\n Major\n Minor\n Trivial\n\nScreenshots (if appropriate):\nHow Has This Been Tested?", "createdAt": "2020-12-09T14:42:36Z", "url": "https://github.com/apache/cloudstack/pull/4527", "merged": true, "mergeCommit": {"oid": "1a4771958860a72f50d179b58c4e319c99d12308"}, "closed": true, "closedAt": "2020-12-10T08:59:28Z", "author": {"login": "ustcweizhou"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkfsqcgH2gAyNTM1MjI5MTc4OjQzZGNkNjVlZmUwM2VmYzI5NGJhZDdkMjFjMmFhYTQ1NzNjYTg5M2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdktHOsAFqTU0ODg4MDkxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "43dcd65efe03efc294bad7d21c2aaa4573ca893b", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/43dcd65efe03efc294bad7d21c2aaa4573ca893b", "committedDate": "2020-12-09T14:34:21Z", "message": "kvm: set cpu topology only if cpucore per socket is positive value"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4Mzg5MjMy", "url": "https://github.com/apache/cloudstack/pull/4527#pullrequestreview-548389232", "createdAt": "2020-12-09T16:51:33Z", "commit": {"oid": "43dcd65efe03efc294bad7d21c2aaa4573ca893b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4ODc0MDk0", "url": "https://github.com/apache/cloudstack/pull/4527#pullrequestreview-548874094", "createdAt": "2020-12-10T05:57:47Z", "commit": {"oid": "43dcd65efe03efc294bad7d21c2aaa4573ca893b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4ODgwODM3", "url": "https://github.com/apache/cloudstack/pull/4527#pullrequestreview-548880837", "createdAt": "2020-12-10T06:11:57Z", "commit": {"oid": "43dcd65efe03efc294bad7d21c2aaa4573ca893b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNjoxMTo1N1rOIC3akg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwNjoxMTo1N1rOIC3akg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTg3NTk4Ng==", "bodyText": "code LGTM", "url": "https://github.com/apache/cloudstack/pull/4527#discussion_r539875986", "createdAt": "2020-12-10T06:11:57Z", "author": {"login": "sureshanaparti"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -4239,10 +4239,10 @@ private void setCpuTopology(CpuModeDef cmd, int vcpus, Map<String, String> detai\n                 numCoresPerSocket = 6;\n             } else if (vcpus % 4 == 0) {\n                 numCoresPerSocket = 4;\n-            } else {\n-                numCoresPerSocket = 1;\n             }\n         }\n-        cmd.setTopology(numCoresPerSocket, vcpus / numCoresPerSocket);\n+        if (numCoresPerSocket > 0) {\n+            cmd.setTopology(numCoresPerSocket, vcpus / numCoresPerSocket);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43dcd65efe03efc294bad7d21c2aaa4573ca893b"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4ODgwOTEw", "url": "https://github.com/apache/cloudstack/pull/4527#pullrequestreview-548880910", "createdAt": "2020-12-10T06:12:09Z", "commit": {"oid": "43dcd65efe03efc294bad7d21c2aaa4573ca893b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4606, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}