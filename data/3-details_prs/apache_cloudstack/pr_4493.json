{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1NTQ2ODgy", "number": 4493, "title": "Recover VM not able to attach the data disks which were attached before destroy", "bodyText": "Description\nThis PR  fixes: #4462\nProblem Statement:\nIn case of VMware, when a VM having multiple data disk is destroyed (without expunge) and tried to recover the VM then the previous data disks are not attached to the VM like before destroy. Only root disk is attached to the VM.\nRoot cause:\nAll data disks were removed as part of VM destroy. Only the volumes which are selected to delete (while destroying VM) are supposed to be detached and destroyed.\nSolution:\nDuring VM destroy, detach and destroy only volumes which are selected during VM destroy. Detach the other volumes during expunge of VM.\n\n\n\n\n\n\n\n\n\n\nTypes of changes\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nFeature/Enhancement Scale or Bug Severity\nFeature/Enhancement Scale\n\n Major\n Minor\n\nBug Severity\n\n BLOCKER\n Critical\n Major\n Minor\n Trivial\n\nScreenshots (if appropriate):\nHow Has This Been Tested?\nTest cases covered:\n\nVM destroy and recover VM\n- created VM with two data disks\n- destroyed VM (without expunge) along with one data disk\n- recovered VM, VM successfully came up with other data disk which is not selected to delete\nVM destroy with expunge\n\ncreated VM with two data disks\ndestroyed VM with expunge\nVM expunged successfully and two data disks were detached and ready to use for other VMs\n\n\nVM destroy with expunge and leave a data disk not to delete\n- created VM with two data disks\n- destroy VM with expunge and select only data disk to delete\n- VM expunged successfully and one data disk is deleted and other data disk was detached and ready to use for other VMs", "createdAt": "2020-11-23T08:15:22Z", "url": "https://github.com/apache/cloudstack/pull/4493", "merged": true, "mergeCommit": {"oid": "f00b5fc7ac275992c494f2329136568980ae2f19"}, "closed": true, "closedAt": "2021-04-15T07:20:53Z", "author": {"login": "harikrishna-patnala"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfQiNWAH2gAyNTI1NTQ2ODgyOjQyNmUzNDdhMjM4Y2FhNWRjZWY0ZmE4ZjEwMWQ0MjZkYjc1MjYyNDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABeLZtQkgFqTYzMjMxODI3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "426e347a238caa5dcef4fa8f101d426db7526243", "author": {"user": {"login": "harikrishna-patnala", "name": "Harikrishna"}}, "url": "https://github.com/apache/cloudstack/commit/426e347a238caa5dcef4fa8f101d426db7526243", "committedDate": "2020-11-23T08:04:44Z", "message": "Fix for the issue of recover VM not able to attach the data disks which are there before destroy in case of VMware"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MjYwNzk5", "url": "https://github.com/apache/cloudstack/pull/4493#pullrequestreview-536260799", "createdAt": "2020-11-23T08:41:51Z", "commit": {"oid": "426e347a238caa5dcef4fa8f101d426db7526243"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MDg3MjIy", "url": "https://github.com/apache/cloudstack/pull/4493#pullrequestreview-537087222", "createdAt": "2020-11-24T05:25:20Z", "commit": {"oid": "426e347a238caa5dcef4fa8f101d426db7526243"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwNToyNToyMFrOH4seag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwNToyNToyMFrOH4seag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIxMDk4Ng==", "bodyText": "@harikrishna-patnala Checked the changes done in the PR #4307, which is breaking the old behavior (On destroy VM, detach the data disks which are marked to be deleted, and keep other disks attached). and these changes are reverted here to bring back the old behavior. Am I correct?", "url": "https://github.com/apache/cloudstack/pull/4493#discussion_r529210986", "createdAt": "2020-11-24T05:25:20Z", "author": {"login": "sureshanaparti"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -2946,13 +2946,7 @@ public UserVm destroyVm(DestroyVMCmd cmd) throws ResourceUnavailableException, C\n \n         stopVirtualMachine(vmId, VmDestroyForcestop.value());\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "426e347a238caa5dcef4fa8f101d426db7526243"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MjM5OTQw", "url": "https://github.com/apache/cloudstack/pull/4493#pullrequestreview-538239940", "createdAt": "2020-11-25T08:08:00Z", "commit": {"oid": "426e347a238caa5dcef4fa8f101d426db7526243"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MjU0Njk4", "url": "https://github.com/apache/cloudstack/pull/4493#pullrequestreview-538254698", "createdAt": "2020-11-25T08:29:06Z", "commit": {"oid": "426e347a238caa5dcef4fa8f101d426db7526243"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjMyMzE4Mjcw", "url": "https://github.com/apache/cloudstack/pull/4493#pullrequestreview-632318270", "createdAt": "2021-04-09T11:38:37Z", "commit": {"oid": "426e347a238caa5dcef4fa8f101d426db7526243"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4820, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}