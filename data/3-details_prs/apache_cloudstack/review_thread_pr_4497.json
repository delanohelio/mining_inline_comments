{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1Nzk4Mjgy", "number": 4497, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMjo1Mzo0NlrOE9n56g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwNzoxODo1NlrOFCxQDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDUyMzk0OnYy", "diffSide": "RIGHT", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMjo1Mzo0NlrOH6aPsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwNTo1NTo1MlrOH8ZNXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAwOTQ1OA==", "bodyText": "when vcpus are 8, it is considered as 4 cores per socket here, instead 8 cores.", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r531009458", "createdAt": "2020-11-26T12:53:46Z", "author": {"login": "sureshanaparti"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -4230,4 +4223,26 @@ public boolean isSecureMode(String bootMode) {\n \n         return false;\n     }\n+\n+    private void setCpuTopology(CpuModeDef cmd, int vcpus, Map<String, String> details) {\n+        // multi cores per socket, for larger core configs\n+        int numCoresPerSocket = -1;\n+        if (details != null) {\n+            final String coresPerSocket = details.get(VmDetailConstants.CPU_CORE_PER_SOCKET);\n+            final int intCoresPerSocket = NumbersUtil.parseInt(coresPerSocket, numCoresPerSocket);\n+            if (intCoresPerSocket > 0 && vcpus % intCoresPerSocket == 0) {\n+                numCoresPerSocket = intCoresPerSocket;\n+            }\n+        }\n+        if (numCoresPerSocket <= 0) {\n+            if (vcpus % 6 == 0) {\n+                numCoresPerSocket = 6;\n+            } else if (vcpus % 4 == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2009802b1c58b979f0374479cde9806aa6f4db9"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzNDIyMA==", "bodyText": "@sureshanaparti this is the current behavior.", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r531034220", "createdAt": "2020-11-26T13:36:58Z", "author": {"login": "weizhouapache"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -4230,4 +4223,26 @@ public boolean isSecureMode(String bootMode) {\n \n         return false;\n     }\n+\n+    private void setCpuTopology(CpuModeDef cmd, int vcpus, Map<String, String> details) {\n+        // multi cores per socket, for larger core configs\n+        int numCoresPerSocket = -1;\n+        if (details != null) {\n+            final String coresPerSocket = details.get(VmDetailConstants.CPU_CORE_PER_SOCKET);\n+            final int intCoresPerSocket = NumbersUtil.parseInt(coresPerSocket, numCoresPerSocket);\n+            if (intCoresPerSocket > 0 && vcpus % intCoresPerSocket == 0) {\n+                numCoresPerSocket = intCoresPerSocket;\n+            }\n+        }\n+        if (numCoresPerSocket <= 0) {\n+            if (vcpus % 6 == 0) {\n+                numCoresPerSocket = 6;\n+            } else if (vcpus % 4 == 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAwOTQ1OA=="}, "originalCommit": {"oid": "f2009802b1c58b979f0374479cde9806aa6f4db9"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM4NzQ5Mw==", "bodyText": "@sureshanaparti this is the current behavior.\n\nagree, any plan to address here?", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r531387493", "createdAt": "2020-11-27T05:19:04Z", "author": {"login": "sureshanaparti"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -4230,4 +4223,26 @@ public boolean isSecureMode(String bootMode) {\n \n         return false;\n     }\n+\n+    private void setCpuTopology(CpuModeDef cmd, int vcpus, Map<String, String> details) {\n+        // multi cores per socket, for larger core configs\n+        int numCoresPerSocket = -1;\n+        if (details != null) {\n+            final String coresPerSocket = details.get(VmDetailConstants.CPU_CORE_PER_SOCKET);\n+            final int intCoresPerSocket = NumbersUtil.parseInt(coresPerSocket, numCoresPerSocket);\n+            if (intCoresPerSocket > 0 && vcpus % intCoresPerSocket == 0) {\n+                numCoresPerSocket = intCoresPerSocket;\n+            }\n+        }\n+        if (numCoresPerSocket <= 0) {\n+            if (vcpus % 6 == 0) {\n+                numCoresPerSocket = 6;\n+            } else if (vcpus % 4 == 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAwOTQ1OA=="}, "originalCommit": {"oid": "f2009802b1c58b979f0374479cde9806aa6f4db9"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQzMTU0MQ==", "bodyText": "@sureshanaparti you mean change the current behavior ? No. I am not going to change it\nIt worked since cloudstack 4.13 in commit 2f53295\nhttps://issues.apache.org/jira/browse/CLOUDSTACK-5521", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r531431541", "createdAt": "2020-11-27T07:51:14Z", "author": {"login": "weizhouapache"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -4230,4 +4223,26 @@ public boolean isSecureMode(String bootMode) {\n \n         return false;\n     }\n+\n+    private void setCpuTopology(CpuModeDef cmd, int vcpus, Map<String, String> details) {\n+        // multi cores per socket, for larger core configs\n+        int numCoresPerSocket = -1;\n+        if (details != null) {\n+            final String coresPerSocket = details.get(VmDetailConstants.CPU_CORE_PER_SOCKET);\n+            final int intCoresPerSocket = NumbersUtil.parseInt(coresPerSocket, numCoresPerSocket);\n+            if (intCoresPerSocket > 0 && vcpus % intCoresPerSocket == 0) {\n+                numCoresPerSocket = intCoresPerSocket;\n+            }\n+        }\n+        if (numCoresPerSocket <= 0) {\n+            if (vcpus % 6 == 0) {\n+                numCoresPerSocket = 6;\n+            } else if (vcpus % 4 == 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAwOTQ1OA=="}, "originalCommit": {"oid": "f2009802b1c58b979f0374479cde9806aa6f4db9"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA4OTYzMA==", "bodyText": "@sureshanaparti you mean change the current behavior ? No. I am not going to change it\nIt worked since cloudstack 4.13 in commit 2f53295\nhttps://issues.apache.org/jira/browse/CLOUDSTACK-5521\n\nok @weizhouapache so no change in the behavior. thanks.", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r533089630", "createdAt": "2020-12-01T05:55:52Z", "author": {"login": "sureshanaparti"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -4230,4 +4223,26 @@ public boolean isSecureMode(String bootMode) {\n \n         return false;\n     }\n+\n+    private void setCpuTopology(CpuModeDef cmd, int vcpus, Map<String, String> details) {\n+        // multi cores per socket, for larger core configs\n+        int numCoresPerSocket = -1;\n+        if (details != null) {\n+            final String coresPerSocket = details.get(VmDetailConstants.CPU_CORE_PER_SOCKET);\n+            final int intCoresPerSocket = NumbersUtil.parseInt(coresPerSocket, numCoresPerSocket);\n+            if (intCoresPerSocket > 0 && vcpus % intCoresPerSocket == 0) {\n+                numCoresPerSocket = intCoresPerSocket;\n+            }\n+        }\n+        if (numCoresPerSocket <= 0) {\n+            if (vcpus % 6 == 0) {\n+                numCoresPerSocket = 6;\n+            } else if (vcpus % 4 == 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAwOTQ1OA=="}, "originalCommit": {"oid": "f2009802b1c58b979f0374479cde9806aa6f4db9"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM4NDQ4Mzk5OnYy", "diffSide": "RIGHT", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwNzoxODo1NlrOICF3qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMTo0MDo1OVrOICQWOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA2NDIzNQ==", "bodyText": "@ustcweizhou possible to pass coresPerSocket here, instead complete VM details here ?", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r539064235", "createdAt": "2020-12-09T07:18:56Z", "author": {"login": "sureshanaparti"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -4230,4 +4223,26 @@ public boolean isSecureMode(String bootMode) {\n \n         return false;\n     }\n+\n+    private void setCpuTopology(CpuModeDef cmd, int vcpus, Map<String, String> details) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2009802b1c58b979f0374479cde9806aa6f4db9"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA3MzQ0OA==", "bodyText": "@sureshanaparti\nI was thinking about it. at the end I decided to pass vm details based on two reasons\n(1) setCpuTopology is a complete function now. if pass coresPerSocket , we need to get coresPerSocket out of the method.\n(2) it is better if add more cpu settings , for example the pr #4178", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r539073448", "createdAt": "2020-12-09T07:38:10Z", "author": {"login": "weizhouapache"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -4230,4 +4223,26 @@ public boolean isSecureMode(String bootMode) {\n \n         return false;\n     }\n+\n+    private void setCpuTopology(CpuModeDef cmd, int vcpus, Map<String, String> details) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA2NDIzNQ=="}, "originalCommit": {"oid": "f2009802b1c58b979f0374479cde9806aa6f4db9"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA3ODEzNg==", "bodyText": "@sureshanaparti\nI was thinking about it. at the end I decided to pass vm details based on two reasons\n(1) setCpuTopology is a complete function now. if pass coresPerSocket , we need to get coresPerSocket out of the method.\n(2) it is better if add more cpu settings , for example the pr #4178\n\nOk @weizhouapache so going forward, cpu hyperthreading detail mentioned in PR #4178 will be added to this method, right?", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r539078136", "createdAt": "2020-12-09T07:46:59Z", "author": {"login": "sureshanaparti"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -4230,4 +4223,26 @@ public boolean isSecureMode(String bootMode) {\n \n         return false;\n     }\n+\n+    private void setCpuTopology(CpuModeDef cmd, int vcpus, Map<String, String> details) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA2NDIzNQ=="}, "originalCommit": {"oid": "f2009802b1c58b979f0374479cde9806aa6f4db9"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIwMDQxNw==", "bodyText": "@sureshanaparti yes. but I need to discuss with @div8cn about some details. it will be an improvement in 4.16", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r539200417", "createdAt": "2020-12-09T10:46:08Z", "author": {"login": "weizhouapache"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -4230,4 +4223,26 @@ public boolean isSecureMode(String bootMode) {\n \n         return false;\n     }\n+\n+    private void setCpuTopology(CpuModeDef cmd, int vcpus, Map<String, String> details) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA2NDIzNQ=="}, "originalCommit": {"oid": "f2009802b1c58b979f0374479cde9806aa6f4db9"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIyNzIzNg==", "bodyText": "@sureshanaparti yes. but I need to discuss with @div8cn about some details. it will be an improvement in 4.16\n\nOK, Pls update details here. As this PR is targeted for 4.14.1.0, the proposed changes with cpu hyperthreading detail will be targeted for 4.16, Right?", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r539227236", "createdAt": "2020-12-09T11:27:15Z", "author": {"login": "sureshanaparti"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -4230,4 +4223,26 @@ public boolean isSecureMode(String bootMode) {\n \n         return false;\n     }\n+\n+    private void setCpuTopology(CpuModeDef cmd, int vcpus, Map<String, String> details) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA2NDIzNQ=="}, "originalCommit": {"oid": "f2009802b1c58b979f0374479cde9806aa6f4db9"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzNTg5Nw==", "bodyText": "@sureshanaparti yes, this is a bug which should be fixed in 4.14 and 4.15.\nthe other pr is an improvement. it will not impact this pr.", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r539235897", "createdAt": "2020-12-09T11:40:59Z", "author": {"login": "weizhouapache"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -4230,4 +4223,26 @@ public boolean isSecureMode(String bootMode) {\n \n         return false;\n     }\n+\n+    private void setCpuTopology(CpuModeDef cmd, int vcpus, Map<String, String> details) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA2NDIzNQ=="}, "originalCommit": {"oid": "f2009802b1c58b979f0374479cde9806aa6f4db9"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4151, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}