{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4MzMwNDEy", "number": 4378, "title": "server: Optional destination host when migrate a vm", "bodyText": "Description\n\nFor now, destination host is required when migrate a vm.\nMake it optional and let cloudstack to choose an destination host.\n\n\n\n\n\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?", "createdAt": "2020-10-06T07:26:38Z", "url": "https://github.com/apache/cloudstack/pull/4378", "merged": true, "mergeCommit": {"oid": "846efdbfe4b218d71063f628449adda22a6f9902"}, "closed": true, "closedAt": "2021-08-10T04:25:58Z", "author": {"login": "ustcweizhou"}, "timelineItems": {"totalCount": 34, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQxvc0AFqTUwNTQ1ODA0NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABeuyv1EAH2gAyNDk4MzMwNDEyOjY1MzBhYmVhZmRjOWIwZGMxODI2OGE0ODhmMjQ1OTFkNTM5ZjNjNjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NDU4MDQ1", "url": "https://github.com/apache/cloudstack/pull/4378#pullrequestreview-505458045", "createdAt": "2020-10-09T08:17:12Z", "commit": {"oid": "37e570f9f10fd5e62569c69250fa18230d89c051"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODoxNzoxMlrOHe_yXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODoxNzoxMlrOHe_yXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI2NDQxMg==", "bodyText": "@ustcweizhou finding a suitable host anywhere within the zone might result in returning a host in a different pod or cluster. This might also need storage migration. Will that be an issue? Especially when VM is having data disks attached. Also, cross-cluster at present fails on VMware when storage pools are cluster scoped. #4385", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r502264412", "createdAt": "2020-10-09T08:17:12Z", "author": {"login": "shwstppr"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5627,6 +5629,50 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n \n         // check if migrating to same host\n         long srcHostId = vm.getHostId();\n+\n+        DeployDestination dest = null;\n+        if (destinationHost == null) {\n+            vm.setLastHostId(null); // Do not check last host\n+            final VirtualMachineProfile profile = new VirtualMachineProfileImpl(vm);\n+            final Host host = _hostDao.findById(srcHostId);\n+            final DataCenterDeployment plan = new DataCenterDeployment(host.getDataCenterId(), null, null, null, null, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37e570f9f10fd5e62569c69250fa18230d89c051"}, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fcf842740c110f68101c9c99a86b53f5052fabb5", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/fcf842740c110f68101c9c99a86b53f5052fabb5", "committedDate": "2020-10-10T11:03:48Z", "message": " #4378: look for host in same cluster in vm migration"}, "afterCommit": {"oid": "de06a9a71e148b7345933bc24075aa38a1dea579", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/de06a9a71e148b7345933bc24075aa38a1dea579", "committedDate": "2020-10-10T13:21:37Z", "message": " #4378: look for host in same cluster in vm migration"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de06a9a71e148b7345933bc24075aa38a1dea579", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/de06a9a71e148b7345933bc24075aa38a1dea579", "committedDate": "2020-10-10T13:21:37Z", "message": " #4378: look for host in same cluster in vm migration"}, "afterCommit": {"oid": "3bc3773ef5307251d07edab20b682faafe660a9a", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/3bc3773ef5307251d07edab20b682faafe660a9a", "committedDate": "2020-10-10T14:15:56Z", "message": " #4378: look for host in same cluster in vm migration"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e4758ae5055a4596fd25c89eaeca8500ee0dafd1", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/e4758ae5055a4596fd25c89eaeca8500ee0dafd1", "committedDate": "2020-10-13T08:47:40Z", "message": " #4378: Remove last host from excludes list"}, "afterCommit": {"oid": "4e22e640837f0fb284eb22a90f1d3cb07ee3d4bd", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/4e22e640837f0fb284eb22a90f1d3cb07ee3d4bd", "committedDate": "2020-10-30T08:54:19Z", "message": " #4378: Remove last host from excludes list"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4e22e640837f0fb284eb22a90f1d3cb07ee3d4bd", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/4e22e640837f0fb284eb22a90f1d3cb07ee3d4bd", "committedDate": "2020-10-30T08:54:19Z", "message": " #4378: Remove last host from excludes list"}, "afterCommit": {"oid": "f7078b5bdd4f1dfd6f9653e2d45c095e29e53514", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/f7078b5bdd4f1dfd6f9653e2d45c095e29e53514", "committedDate": "2021-01-26T13:33:45Z", "message": " #4378: fix NPE while migrate vm with custom offering"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f7078b5bdd4f1dfd6f9653e2d45c095e29e53514", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/f7078b5bdd4f1dfd6f9653e2d45c095e29e53514", "committedDate": "2021-01-26T13:33:45Z", "message": " #4378: fix NPE while migrate vm with custom offering"}, "afterCommit": {"oid": "b69e728fcd4695cab95f38a2617959b5610889d7", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/b69e728fcd4695cab95f38a2617959b5610889d7", "committedDate": "2021-02-18T22:10:07Z", "message": "server: Optional destination host when migrate a vm"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51ea345a076a72cfeefecbf12ef7bc7b84569a0f", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/51ea345a076a72cfeefecbf12ef7bc7b84569a0f", "committedDate": "2021-03-15T13:37:40Z", "message": "server: Optional destination host when migrate a vm"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bdc324d860acfc074fa94707467f9131bdbc88a", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/9bdc324d860acfc074fa94707467f9131bdbc88a", "committedDate": "2021-03-15T13:44:25Z", "message": " #4378: migrate systemvms/routers with optional host"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b69e728fcd4695cab95f38a2617959b5610889d7", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/b69e728fcd4695cab95f38a2617959b5610889d7", "committedDate": "2021-02-18T22:10:07Z", "message": "server: Optional destination host when migrate a vm"}, "afterCommit": {"oid": "9bdc324d860acfc074fa94707467f9131bdbc88a", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/9bdc324d860acfc074fa94707467f9131bdbc88a", "committedDate": "2021-03-15T13:44:25Z", "message": " #4378: migrate systemvms/routers with optional host"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjEzMTkyOTUz", "url": "https://github.com/apache/cloudstack/pull/4378#pullrequestreview-613192953", "createdAt": "2021-03-16T12:41:23Z", "commit": {"oid": "9bdc324d860acfc074fa94707467f9131bdbc88a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xNlQxMjo0MToyM1rOI3j7Lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xNlQxMjo0MToyM1rOI3j7Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTEzMTE4Mw==", "bodyText": "@weizhouapache do you need to remove this condition else either hostid or storageid must be provided", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595131183", "createdAt": "2021-03-16T12:41:23Z", "author": {"login": "shwstppr"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "diffHunk": "@@ -126,30 +126,30 @@ public void execute() {\n             throw new InvalidParameterValueException(\"Either hostId or storageId must be specified\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bdc324d860acfc074fa94707467f9131bdbc88a"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjEzMTk2MjEw", "url": "https://github.com/apache/cloudstack/pull/4378#pullrequestreview-613196210", "createdAt": "2021-03-16T12:44:43Z", "commit": {"oid": "9bdc324d860acfc074fa94707467f9131bdbc88a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6", "committedDate": "2021-03-16T14:04:00Z", "message": " #4378: fix mistake"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjEzOTY5NTE2", "url": "https://github.com/apache/cloudstack/pull/4378#pullrequestreview-613969516", "createdAt": "2021-03-17T06:56:47Z", "commit": {"oid": "f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xN1QwNjo1Njo0N1rOI4J-Kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xN1QwNjo1Njo0N1rOI4J-Kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc1NDUzOQ==", "bodyText": "@ustcweizhou whenever host / storage pool is not specified in the cmd, instead of directly picking a suitable dest host to migrate to, I think it is better to confirm it (from the user) through a API cmd param (something like chooseHost  / selectHost). If user is not OK to auto select host, then throw appropriate message.", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595754539", "createdAt": "2021-03-17T06:56:47Z", "author": {"login": "sureshanaparti"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVMCmd.java", "diffHunk": "@@ -169,9 +165,9 @@ public void execute() {\n \n         try {\n             VirtualMachine migratedVm = null;\n-            if (getHostId() != null) {\n+            if (getStoragePoolId() == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjEzOTg3ODE3", "url": "https://github.com/apache/cloudstack/pull/4378#pullrequestreview-613987817", "createdAt": "2021-03-17T07:29:52Z", "commit": {"oid": "f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xN1QwNzoyOTo1MlrOI4K4Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xN1QwNzoyOTo1MlrOI4K4Ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc2OTQzNQ==", "bodyText": "@weizhouapache change added in UserVmManagerImpl to find suitable host is only for migrateVirtualMachine method while we call migrateVirtualMachineWithVolume\nCurrently we will get NPE on \n  \n    \n      cloudstack/server/src/main/java/com/cloud/vm/UserVmManagerImpl.java\n    \n    \n         Line 6289\n      in\n      f5aed32\n    \n    \n    \n    \n\n        \n          \n           if (destinationHost.getId() == srcHostId) {", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595769435", "createdAt": "2021-03-17T07:29:52Z", "author": {"login": "shwstppr"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "diffHunk": "@@ -122,34 +122,34 @@ public String getEventDescription() {\n \n     @Override\n     public void execute() {\n-        if (getHostId() == null && getStorageId() == null) {\n-            throw new InvalidParameterValueException(\"Either hostId or storageId must be specified\");\n-        }\n-\n         if (getHostId() != null && getStorageId() != null) {\n             throw new InvalidParameterValueException(\"Only one of hostId and storageId can be specified\");\n         }\n+\n         try {\n             //FIXME : Should not be calling UserVmService to migrate all types of VMs - need a generic VM layer\n             VirtualMachine migratedVm = null;\n-            if (getHostId() != null) {\n-                Host destinationHost = _resourceService.getHost(getHostId());\n-                if (destinationHost == null) {\n-                    throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n-                }\n-                if (destinationHost.getType() != Host.Type.Routing) {\n-                    throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n-                }\n-                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n-                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());\n-            } else if (getStorageId() != null) {\n+            if (getStorageId() != null) {\n                 // OfflineMigration performed when this parameter is specified\n                 StoragePool destStoragePool = _storageService.getStoragePool(getStorageId());\n                 if (destStoragePool == null) {\n                     throw new InvalidParameterValueException(\"Unable to find the storage pool to migrate the VM\");\n                 }\n                 CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to storage pool Id: \" + getStorageId());\n                 migratedVm = _userVmService.vmStorageMigration(getVirtualMachineId(), destStoragePool);\n+            } else {\n+                Host destinationHost = null;\n+                if (getHostId() != null) {\n+                    destinationHost =_resourceService.getHost(getHostId());\n+                    if (destinationHost == null) {\n+                        throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n+                    }\n+                    if (destinationHost.getType() != Host.Type.Routing) {\n+                        throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n+                    }\n+                }\n+                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n+                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92b8f7370c599a2260a2055ca8fb13166bea6b52", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/92b8f7370c599a2260a2055ca8fb13166bea6b52", "committedDate": "2021-03-17T13:43:36Z", "message": " #4378: fix issue when migrate systemvm"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjE1MDgzMTAx", "url": "https://github.com/apache/cloudstack/pull/4378#pullrequestreview-615083101", "createdAt": "2021-03-18T08:17:40Z", "commit": {"oid": "92b8f7370c599a2260a2055ca8fb13166bea6b52"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1a1e2a08c9405e64f30a333f83e39795f4a7f21", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/c1a1e2a08c9405e64f30a333f83e39795f4a7f21", "committedDate": "2021-03-22T15:17:42Z", "message": " #4378 add autoselect to migrate api commands"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjU1MjgzNzEy", "url": "https://github.com/apache/cloudstack/pull/4378#pullrequestreview-655283712", "createdAt": "2021-05-10T06:56:22Z", "commit": {"oid": "c1a1e2a08c9405e64f30a333f83e39795f4a7f21"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62a4886ea622773c8d7ef7d68b1cd6ab53152121", "author": {"user": {"login": "weizhouapache", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/62a4886ea622773c8d7ef7d68b1cd6ab53152121", "committedDate": "2021-06-21T11:01:00Z", "message": "  #4378: more ui change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Njg4MzE4NTM3", "url": "https://github.com/apache/cloudstack/pull/4378#pullrequestreview-688318537", "createdAt": "2021-06-21T11:32:05Z", "commit": {"oid": "62a4886ea622773c8d7ef7d68b1cd6ab53152121"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yMVQxMTozMjowNVrOJw8Lww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yMVQxMTozMjowNVrOJw8Lww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTI5NzQ3NQ==", "bodyText": "@weizhouapache do we need to add this string - autoselect in translation?", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r655297475", "createdAt": "2021-06-21T11:32:05Z", "author": {"login": "shwstppr"}, "path": "ui/src/views/compute/MigrateWizard.vue", "diffHunk": "@@ -168,6 +170,12 @@ export default {\n         this.hosts.sort((a, b) => {\n           return b.suitableformigration - a.suitableformigration\n         })\n+        for (const key in this.hosts) {\n+          if (this.hosts[key].suitableformigration && !this.hosts[key].requiresstoragemigration) {\n+            this.hosts.unshift({ id: -1, name: 'autoselect', suitableformigration: true, requiresstoragemigration: false })", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62a4886ea622773c8d7ef7d68b1cd6ab53152121"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a258544ca957d77077e0d3eb5caf54bb34d713d7", "author": {"user": {"login": "weizhouapache", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/a258544ca957d77077e0d3eb5caf54bb34d713d7", "committedDate": "2021-06-21T12:06:28Z", "message": " #4378: add label label.migrate.auto.select"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Njg4MzU4MzMx", "url": "https://github.com/apache/cloudstack/pull/4378#pullrequestreview-688358331", "createdAt": "2021-06-21T12:21:56Z", "commit": {"oid": "a258544ca957d77077e0d3eb5caf54bb34d713d7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjkyNTQxMjA1", "url": "https://github.com/apache/cloudstack/pull/4378#pullrequestreview-692541205", "createdAt": "2021-06-25T07:49:30Z", "commit": {"oid": "a258544ca957d77077e0d3eb5caf54bb34d713d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQwNzo0OTozMFrOJ0CiaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQwNzo0OTozMFrOJ0CiaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODU0NzMwNA==", "bodyText": "@weizhouapache just to check, auto select here picks the suitable host for VM migration. In the similar way, any possibility to pick suitable storage ? If so, can this API have both parameters: autoselecthost & autoselectstorage (only one of them should be true).", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r658547304", "createdAt": "2021-06-25T07:49:30Z", "author": {"login": "sureshanaparti"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVMCmd.java", "diffHunk": "@@ -155,6 +161,8 @@ public void execute() {\n                 throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n             }\n             CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n+        } else if (! isAutoSelect()) {\n+            throw new InvalidParameterValueException(\"Please specify a host or storage as destination, or pass 'autoselect=true' to automatically select a destination host which do not require storage migration\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a258544ca957d77077e0d3eb5caf54bb34d713d7"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjkyNzI4NjU2", "url": "https://github.com/apache/cloudstack/pull/4378#pullrequestreview-692728656", "createdAt": "2021-06-25T11:36:04Z", "commit": {"oid": "a258544ca957d77077e0d3eb5caf54bb34d713d7"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQxMTozNjowNFrOJ0Lspw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQxMTozNjozOFrOJ0Lt2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODY5NzM4Mw==", "bodyText": "can you factor this out to a separate method, please", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r658697383", "createdAt": "2021-06-25T11:36:04Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5895,8 +5897,46 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Cannot migrate VM, host with id: \" + srcHostId + \" for VM not found\");\n         }\n \n+        DeployDestination dest = null;\n+        if (destinationHost == null) {\n+            vm.setLastHostId(null); // Last host does not have higher priority in vm migration\n+            final ServiceOfferingVO offering = _offeringDao.findById(vm.getId(), vm.getServiceOfferingId());\n+            final VirtualMachineProfile profile = new VirtualMachineProfileImpl(vm, null, offering, null, null);\n+            final Host host = _hostDao.findById(srcHostId);\n+            final DataCenterDeployment plan = new DataCenterDeployment(host.getDataCenterId(), host.getPodId(), host.getClusterId(), null, null, null);\n+            ExcludeList excludes = new ExcludeList();\n+            excludes.addHost(srcHostId);\n+            try {\n+                dest = _planningMgr.planDeployment(profile, plan, excludes, null);\n+            } catch (final AffinityConflictException e2) {\n+                s_logger.warn(\"Unable to create deployment, affinity rules associted to the VM conflict\", e2);\n+                throw new CloudRuntimeException(\"Unable to create deployment, affinity rules associted to the VM conflict\");\n+            } catch (final InsufficientServerCapacityException e3) {\n+                throw new CloudRuntimeException(\"Unable to find a server to migrate the vm to\");\n+            }\n+        } else {\n+            dest = checkVmMigrationDestination(vm, srcHost, destinationHost);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a258544ca957d77077e0d3eb5caf54bb34d713d7"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODY5NzY4OQ==", "bodyText": "and this, please?", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r658697689", "createdAt": "2021-06-25T11:36:38Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5895,8 +5897,46 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Cannot migrate VM, host with id: \" + srcHostId + \" for VM not found\");\n         }\n \n+        DeployDestination dest = null;\n+        if (destinationHost == null) {\n+            vm.setLastHostId(null); // Last host does not have higher priority in vm migration\n+            final ServiceOfferingVO offering = _offeringDao.findById(vm.getId(), vm.getServiceOfferingId());\n+            final VirtualMachineProfile profile = new VirtualMachineProfileImpl(vm, null, offering, null, null);\n+            final Host host = _hostDao.findById(srcHostId);\n+            final DataCenterDeployment plan = new DataCenterDeployment(host.getDataCenterId(), host.getPodId(), host.getClusterId(), null, null, null);\n+            ExcludeList excludes = new ExcludeList();\n+            excludes.addHost(srcHostId);\n+            try {\n+                dest = _planningMgr.planDeployment(profile, plan, excludes, null);\n+            } catch (final AffinityConflictException e2) {\n+                s_logger.warn(\"Unable to create deployment, affinity rules associted to the VM conflict\", e2);\n+                throw new CloudRuntimeException(\"Unable to create deployment, affinity rules associted to the VM conflict\");\n+            } catch (final InsufficientServerCapacityException e3) {\n+                throw new CloudRuntimeException(\"Unable to find a server to migrate the vm to\");\n+            }\n+        } else {\n+            dest = checkVmMigrationDestination(vm, srcHost, destinationHost);\n+        }\n \n-        if (destinationHost.getId() == srcHostId) {\n+        // If no suitable destination found then throw exception\n+        if (dest == null) {\n+            throw new CloudRuntimeException(\"Unable to find suitable destination to migrate VM \" + vm.getInstanceName());\n+        }\n+\n+        UserVmVO uservm = _vmDao.findById(vmId);\n+        if (uservm != null) {\n+            collectVmDiskStatistics(uservm);\n+            collectVmNetworkStatistics(uservm);\n+        }\n+        _itMgr.migrate(vm.getUuid(), srcHostId, dest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a258544ca957d77077e0d3eb5caf54bb34d713d7"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90b1ff5e01275bd8976f179075516aa6483c465e", "author": {"user": {"login": "weizhouapache", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/90b1ff5e01275bd8976f179075516aa6483c465e", "committedDate": "2021-06-25T13:16:29Z", "message": " #4378: add method chooseVmMigrationDestination"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7216e18a89dc0d81c8a0feedd503bc707c9b31e", "author": {"user": {"login": "weizhouapache", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/e7216e18a89dc0d81c8a0feedd503bc707c9b31e", "committedDate": "2021-06-29T15:15:17Z", "message": " #4378: fix vm migration wih storageid on vmware"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Njk1NDU1MjYw", "url": "https://github.com/apache/cloudstack/pull/4378#pullrequestreview-695455260", "createdAt": "2021-06-29T20:10:35Z", "commit": {"oid": "e7216e18a89dc0d81c8a0feedd503bc707c9b31e"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e54dc33d10595e083f0ae6fa7588e05281ddd5c", "author": {"user": {"login": "weizhouapache", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/6e54dc33d10595e083f0ae6fa7588e05281ddd5c", "committedDate": "2021-07-02T10:46:52Z", "message": " #4378: add method to collect vm disk/network statistics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06e3a8a56aeda6d8296db19bb205e815f5781f68", "author": {"user": {"login": "weizhouapache", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/06e3a8a56aeda6d8296db19bb205e815f5781f68", "committedDate": "2021-07-21T06:52:39Z", "message": "Merge remote-tracking branch 'apache/main' into 4.15-migration-vm-optional-host"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d8175c7ea3f8a661482dee48829f7469d771b6a", "author": {"user": {"login": "weizhouapache", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/0d8175c7ea3f8a661482dee48829f7469d771b6a", "committedDate": "2021-07-23T07:17:05Z", "message": " #4378: set autoSelect to default 'true'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "107fd3ad85c30802d919eb6fdea6248387693353", "author": {"user": {"login": "weizhouapache", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/107fd3ad85c30802d919eb6fdea6248387693353", "committedDate": "2021-07-26T13:58:47Z", "message": "Merge remote-tracking branch 'apache/main' into 4.15-migration-vm-optional-host"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73e1c2bdad9b6cfd233e6f202ba31755f14c1251", "author": {"user": {"login": "weizhouapache", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/73e1c2bdad9b6cfd233e6f202ba31755f14c1251", "committedDate": "2021-07-27T06:35:50Z", "message": "Merge remote-tracking branch 'apache/main' into 4.15-migration-vm-optional-host"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzE2NDU0OTc5", "url": "https://github.com/apache/cloudstack/pull/4378#pullrequestreview-716454979", "createdAt": "2021-07-27T23:19:00Z", "commit": {"oid": "73e1c2bdad9b6cfd233e6f202ba31755f14c1251"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0yN1QyMzoxOTowMFrOKGdifg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0yN1QyMzoyMDoyNVrOKGdkhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3Nzg2NDA2Mg==", "bodyText": "Minor suggestion: to use BooleanUtils.toBoolean(autoSelect) here", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r677864062", "createdAt": "2021-07-27T23:19:00Z", "author": {"login": "nvazquez"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "diffHunk": "@@ -91,6 +97,10 @@ public Long getStorageId() {\n         return storageId;\n     }\n \n+    public Boolean isAutoSelect() {\n+        return autoSelect != null ? autoSelect : true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73e1c2bdad9b6cfd233e6f202ba31755f14c1251"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3Nzg2NDU4Mw==", "bodyText": "Same here", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r677864583", "createdAt": "2021-07-27T23:20:25Z", "author": {"login": "nvazquez"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVMCmd.java", "diffHunk": "@@ -93,6 +99,10 @@ public Long getStoragePoolId() {\n         return storageId;\n     }\n \n+    public Boolean isAutoSelect() {\n+        return autoSelect != null ? autoSelect : true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73e1c2bdad9b6cfd233e6f202ba31755f14c1251"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6530abeafdc9b0dc18268a488f24591d539f3c62", "author": {"user": {"login": "weizhouapache", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/6530abeafdc9b0dc18268a488f24591d539f3c62", "committedDate": "2021-07-28T10:36:24Z", "message": " #4378: use BooleanUtils.isNotFalse"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4966, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}