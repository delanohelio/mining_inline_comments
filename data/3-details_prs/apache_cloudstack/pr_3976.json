{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5NjczMTc2", "number": 3976, "title": "Enable sending hypervior host name via metadata - VR and Config Drive", "bodyText": "Description\nEnable sending hypervisor host details via metadata for VR and Config Drive providers\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)", "createdAt": "2020-03-17T07:37:24Z", "url": "https://github.com/apache/cloudstack/pull/3976", "merged": true, "mergeCommit": {"oid": "a73712ec4ea0deae58d0b43edcbe9ca5e8f33fd4"}, "closed": true, "closedAt": "2020-07-01T03:14:12Z", "author": {"login": "Pearl1594"}, "timelineItems": {"totalCount": 55, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOeh7dABqjMxMzYzMjM4OTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwm1FGgFqTQ0MDcwMTMwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "18ffae761b1e58c33b8afcc365614cdf20657b13", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/18ffae761b1e58c33b8afcc365614cdf20657b13", "committedDate": "2020-03-17T07:28:53Z", "message": "Enable sending hypervior host name via metadata"}, "afterCommit": {"oid": "04b6bee46ced5a93212adc8d29fed3b5a57b14c8", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/04b6bee46ced5a93212adc8d29fed3b5a57b14c8", "committedDate": "2020-03-17T08:34:18Z", "message": "Enable sending hypervior host name via metadata"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "04b6bee46ced5a93212adc8d29fed3b5a57b14c8", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/04b6bee46ced5a93212adc8d29fed3b5a57b14c8", "committedDate": "2020-03-17T08:34:18Z", "message": "Enable sending hypervior host name via metadata"}, "afterCommit": {"oid": "f4c218ea08043beb519141740313f187c964c1e7", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/f4c218ea08043beb519141740313f187c964c1e7", "committedDate": "2020-03-17T08:58:36Z", "message": "Enable sending hypervior host name via metadata"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f4c218ea08043beb519141740313f187c964c1e7", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/f4c218ea08043beb519141740313f187c964c1e7", "committedDate": "2020-03-17T08:58:36Z", "message": "Enable sending hypervior host name via metadata"}, "afterCommit": {"oid": "af40d471388bb967c855ed45d45eb12dd6b340d5", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/af40d471388bb967c855ed45d45eb12dd6b340d5", "committedDate": "2020-03-17T17:14:46Z", "message": "Enable sending hypervior host name via metadata"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "af40d471388bb967c855ed45d45eb12dd6b340d5", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/af40d471388bb967c855ed45d45eb12dd6b340d5", "committedDate": "2020-03-17T17:14:46Z", "message": "Enable sending hypervior host name via metadata"}, "afterCommit": {"oid": "e333053f82b81109f0d8fee69fb453d092a9e936", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/e333053f82b81109f0d8fee69fb453d092a9e936", "committedDate": "2020-03-17T18:44:10Z", "message": "Enable sending hypervior host name via metadata"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e333053f82b81109f0d8fee69fb453d092a9e936", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/e333053f82b81109f0d8fee69fb453d092a9e936", "committedDate": "2020-03-17T18:44:10Z", "message": "Enable sending hypervior host name via metadata"}, "afterCommit": {"oid": "2d11a073fdd66e2c1d7dd4e9d9661b6f4875cc5b", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/2d11a073fdd66e2c1d7dd4e9d9661b6f4875cc5b", "committedDate": "2020-03-19T08:37:13Z", "message": "Enable sending hypervior host name via metadata"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d11a073fdd66e2c1d7dd4e9d9661b6f4875cc5b", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/2d11a073fdd66e2c1d7dd4e9d9661b6f4875cc5b", "committedDate": "2020-03-19T08:37:13Z", "message": "Enable sending hypervior host name via metadata"}, "afterCommit": {"oid": "767a8d01c37169c4029ce4e7701aa655a5829ab4", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/767a8d01c37169c4029ce4e7701aa655a5829ab4", "committedDate": "2020-03-19T09:07:54Z", "message": "Enable sending hypervior host name via metadata"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "767a8d01c37169c4029ce4e7701aa655a5829ab4", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/767a8d01c37169c4029ce4e7701aa655a5829ab4", "committedDate": "2020-03-19T09:07:54Z", "message": "Enable sending hypervior host name via metadata"}, "afterCommit": {"oid": "8cd446d7c281263e3b80ab82f66c94b4eab53ea9", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/8cd446d7c281263e3b80ab82f66c94b4eab53ea9", "committedDate": "2020-03-19T10:21:14Z", "message": "Enable sending hypervior host name via metadata"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8cd446d7c281263e3b80ab82f66c94b4eab53ea9", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/8cd446d7c281263e3b80ab82f66c94b4eab53ea9", "committedDate": "2020-03-19T10:21:14Z", "message": "Enable sending hypervior host name via metadata"}, "afterCommit": {"oid": "e98ff37001662738c82b18c08f43a2f30cd2a5ab", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/e98ff37001662738c82b18c08f43a2f30cd2a5ab", "committedDate": "2020-03-19T13:51:06Z", "message": "Enable sending hypervior host name via metadata"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e98ff37001662738c82b18c08f43a2f30cd2a5ab", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/e98ff37001662738c82b18c08f43a2f30cd2a5ab", "committedDate": "2020-03-19T13:51:06Z", "message": "Enable sending hypervior host name via metadata"}, "afterCommit": {"oid": "2af957a46b095b8bb4a5bcc5471acb2a0b2887b9", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/2af957a46b095b8bb4a5bcc5471acb2a0b2887b9", "committedDate": "2020-03-20T06:32:48Z", "message": "Enable sending hypervior host name via metadata"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1262fa26d67261922b591fcc7021c114aa71f66b", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/1262fa26d67261922b591fcc7021c114aa71f66b", "committedDate": "2020-03-23T07:16:59Z", "message": "Enable sending hypervior host name via metadata"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2af957a46b095b8bb4a5bcc5471acb2a0b2887b9", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/2af957a46b095b8bb4a5bcc5471acb2a0b2887b9", "committedDate": "2020-03-20T06:32:48Z", "message": "Enable sending hypervior host name via metadata"}, "afterCommit": {"oid": "1262fa26d67261922b591fcc7021c114aa71f66b", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/1262fa26d67261922b591fcc7021c114aa71f66b", "committedDate": "2020-03-23T07:16:59Z", "message": "Enable sending hypervior host name via metadata"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NDk5NTQ3", "url": "https://github.com/apache/cloudstack/pull/3976#pullrequestreview-379499547", "createdAt": "2020-03-23T14:46:35Z", "commit": {"oid": "1262fa26d67261922b591fcc7021c114aa71f66b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNDo0NjozNVrOF6Ixeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNDo0NjozNVrOF6Ixeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUwNTQ2Ng==", "bodyText": "Minor comment: will you consider removing 'account' from the config name?", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r396505466", "createdAt": "2020-03-23T14:46:35Z", "author": {"login": "nvazquez"}, "path": "engine/api/src/main/java/com/cloud/vm/VirtualMachineManager.java", "diffHunk": "@@ -61,6 +61,12 @@\n     ConfigKey<Boolean> ResoureCountRunningVMsonly = new ConfigKey<Boolean>(\"Advanced\", Boolean.class, \"resource.count.running.vms.only\", \"false\",\n             \"Count the resources of only running VMs in resource limitation.\", true);\n \n+    ConfigKey<Boolean> AllowExposeHypervisorHostnameAccoutLevel = new ConfigKey<Boolean>(\"Advanced\", Boolean.class, \"allow.expose.host.hostname.account\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1262fa26d67261922b591fcc7021c114aa71f66b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74205ae7330dcbad19c760d0f7e86ef4d3f3926a", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/74205ae7330dcbad19c760d0f7e86ef4d3f3926a", "committedDate": "2020-03-24T13:26:31Z", "message": "Merge branch 'FR44_master' of github.com:shapeblue/cloudstack into FR44_master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "760f9afb07c2e28e3b4c973af82dddb0660ab9be", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/760f9afb07c2e28e3b4c973af82dddb0660ab9be", "committedDate": "2020-03-24T14:54:13Z", "message": "modify global setting + handle attachment of iso for vmware"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6679e3dd4fd6f5254b6e80391ea84fdbc496848a", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/6679e3dd4fd6f5254b6e80391ea84fdbc496848a", "committedDate": "2020-03-26T07:14:23Z", "message": "Reverted ISO attachment for VMware"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNzc1NDcx", "url": "https://github.com/apache/cloudstack/pull/3976#pullrequestreview-382775471", "createdAt": "2020-03-27T11:26:35Z", "commit": {"oid": "6679e3dd4fd6f5254b6e80391ea84fdbc496848a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMToyNjozNVrOF8tJIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMToyNjozNVrOF8tJIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE5ODQ5Ng==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399198496", "createdAt": "2020-03-27T11:26:35Z", "author": {"login": "DaanHoogland"}, "path": "core/src/main/java/com/cloud/agent/api/routing/VmDataCommand.java", "diffHunk": "@@ -72,5 +72,4 @@ public String getVmIpAddress() {\n     public void addVmData(String folder, String file, String contents) {\n         vmData.add(new String[] {folder, file, contents});\n     }\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6679e3dd4fd6f5254b6e80391ea84fdbc496848a"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNzc2NDgy", "url": "https://github.com/apache/cloudstack/pull/3976#pullrequestreview-382776482", "createdAt": "2020-03-27T11:28:21Z", "commit": {"oid": "6679e3dd4fd6f5254b6e80391ea84fdbc496848a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMToyODoyMVrOF8tMOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMToyODoyMVrOF8tMOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE5OTI5MQ==", "bodyText": "spello : var name ending in AccoutLevel, missing an 'n'", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399199291", "createdAt": "2020-03-27T11:28:21Z", "author": {"login": "DaanHoogland"}, "path": "engine/api/src/main/java/com/cloud/vm/VirtualMachineManager.java", "diffHunk": "@@ -61,6 +61,12 @@\n     ConfigKey<Boolean> ResoureCountRunningVMsonly = new ConfigKey<Boolean>(\"Advanced\", Boolean.class, \"resource.count.running.vms.only\", \"false\",\n             \"Count the resources of only running VMs in resource limitation.\", true);\n \n+    ConfigKey<Boolean> AllowExposeHypervisorHostnameAccoutLevel = new ConfigKey<Boolean>(\"Advanced\", Boolean.class, \"allow.expose.host.hostname\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6679e3dd4fd6f5254b6e80391ea84fdbc496848a"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/c70ba9b7dcb459922020d4f89a61c9367dad7c2c", "committedDate": "2020-03-27T13:17:53Z", "message": "Fixed typo in variable name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNzc3MjA1", "url": "https://github.com/apache/cloudstack/pull/3976#pullrequestreview-382777205", "createdAt": "2020-03-27T11:29:34Z", "commit": {"oid": "6679e3dd4fd6f5254b6e80391ea84fdbc496848a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 31, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMToyOTozNVrOF8tOrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNTowNzo1NVrOF81YxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE5OTkxOQ==", "bodyText": "Two config keys at different scopes, with the same name. I will want to see tests for that (unit and integration)\nIt might work but is not by design and we need to protect this or signal if it fails after any kind of refactor.", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399199919", "createdAt": "2020-03-27T11:29:35Z", "author": {"login": "DaanHoogland"}, "path": "engine/api/src/main/java/com/cloud/vm/VirtualMachineManager.java", "diffHunk": "@@ -61,6 +61,12 @@\n     ConfigKey<Boolean> ResoureCountRunningVMsonly = new ConfigKey<Boolean>(\"Advanced\", Boolean.class, \"resource.count.running.vms.only\", \"false\",\n             \"Count the resources of only running VMs in resource limitation.\", true);\n \n+    ConfigKey<Boolean> AllowExposeHypervisorHostnameAccoutLevel = new ConfigKey<Boolean>(\"Advanced\", Boolean.class, \"allow.expose.host.hostname\",\n+            \"false\", \"If set to true, it allows the hypervisor host name on which the VM is spawned on to be exposed to the VM\", true, ConfigKey.Scope.Account);\n+\n+    ConfigKey<Boolean> AllowExposeHypervisorHostname = new ConfigKey<Boolean>(\"Advanced\", Boolean.class, \"allow.expose.host.hostname\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6679e3dd4fd6f5254b6e80391ea84fdbc496848a"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1NTk5Mg==", "bodyText": "also, I know this was countered before, but I woud like to see account in the name of this setting. i.e. \"account.allow.expose.host.hostname\" and \"general.allow.expose.host.hostname\"", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399255992", "createdAt": "2020-03-27T13:16:53Z", "author": {"login": "DaanHoogland"}, "path": "engine/api/src/main/java/com/cloud/vm/VirtualMachineManager.java", "diffHunk": "@@ -61,6 +61,12 @@\n     ConfigKey<Boolean> ResoureCountRunningVMsonly = new ConfigKey<Boolean>(\"Advanced\", Boolean.class, \"resource.count.running.vms.only\", \"false\",\n             \"Count the resources of only running VMs in resource limitation.\", true);\n \n+    ConfigKey<Boolean> AllowExposeHypervisorHostnameAccoutLevel = new ConfigKey<Boolean>(\"Advanced\", Boolean.class, \"allow.expose.host.hostname\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE5OTI5MQ=="}, "originalCommit": {"oid": "6679e3dd4fd6f5254b6e80391ea84fdbc496848a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI1ODkyMg==", "bodyText": "it looks like both must be true so the account level cannot be used to override the global setting. Is that intentional? (this is both a functional as well as a technical question)", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399258922", "createdAt": "2020-03-27T13:21:52Z", "author": {"login": "DaanHoogland"}, "path": "engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java", "diffHunk": "@@ -2802,9 +2802,10 @@ private void orchestrateMigrateWithStorage(final String vmUuid, final long srcHo\n                 if (_networkModel.isSharedNetworkWithoutServices(network.getId())) {\n                     final String serviceOffering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId()).getDisplayText();\n                     boolean isWindows = _guestOSCategoryDao.findById(_guestOSDao.findById(vm.getGuestOSId()).getCategoryId()).getName().equalsIgnoreCase(\"Windows\");\n-\n+                    final Account caller = CallContext.current().getCallingAccount();\n+                    String destHostname = (VirtualMachineManager.AllowExposeHypervisorHostname.value() && VirtualMachineManager.AllowExposeHypervisorHostnameAccoutLevel.valueIn(caller.getId())) ? destination.getHost().getName() : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6679e3dd4fd6f5254b6e80391ea84fdbc496848a"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI2NzI1OQ==", "bodyText": "in view of what this method does, the name \"addNewDisk\" seems completely wrong. Why is it named like this?", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399267259", "createdAt": "2020-03-27T13:34:10Z", "author": {"login": "DaanHoogland"}, "path": "engine/orchestration/src/main/java/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java", "diffHunk": "@@ -1610,6 +1612,26 @@ public void finalizeUpdateInSequence(Network network, boolean success) {\n         }\n     }\n \n+    @Override\n+    public void addNewDisk(VirtualMachineProfile vm, DeployDestination dest) throws ResourceUnavailableException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6679e3dd4fd6f5254b6e80391ea84fdbc496848a"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI3MjQxOA==", "bodyText": "please add javadoc. the purpose of this method is not obvious from the name, parameters or return type.", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399272418", "createdAt": "2020-03-27T13:42:02Z", "author": {"login": "DaanHoogland"}, "path": "engine/api/src/main/java/org/apache/cloudstack/engine/orchestration/service/NetworkOrchestrationService.java", "diffHunk": "@@ -294,6 +294,8 @@ void implementNetworkElementsAndResources(DeployDestination dest, ReservationCon\n \n     void finalizeUpdateInSequence(Network network, boolean success);\n \n+    void addNewDisk(VirtualMachineProfile vm, DeployDestination dest) throws ResourceUnavailableException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6679e3dd4fd6f5254b6e80391ea84fdbc496848a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI3NjExOQ==", "bodyText": "so if we have an element that fits, do we still iterate over the rest, or should we break on the outer if? which makes me think this method has a high complexity can you disect it for readability, please?", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399276119", "createdAt": "2020-03-27T13:47:48Z", "author": {"login": "DaanHoogland"}, "path": "engine/orchestration/src/main/java/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java", "diffHunk": "@@ -1610,6 +1612,26 @@ public void finalizeUpdateInSequence(Network network, boolean success) {\n         }\n     }\n \n+    @Override\n+    public void addNewDisk(VirtualMachineProfile vm, DeployDestination dest) throws ResourceUnavailableException {\n+        final List<NicVO> nics = _nicDao.listByVmId(vm.getId());\n+        for (final NicVO nic : nics) {\n+            final NetworkVO network = _networksDao.findById(nic.getNetworkId());\n+            final Integer networkRate = _networkModel.getNetworkRate(network.getId(), vm.getId());\n+            final NicProfile profile = new NicProfile(nic, network, nic.getBroadcastUri(), nic.getIsolationUri(), networkRate, _networkModel.isSecurityGroupSupportedInNetwork(network),\n+                    _networkModel.getNetworkTag(vm.getHypervisorType(), network));\n+            for (final NetworkElement element : networkElements) {\n+                if (_networkModel.areServicesSupportedInNetwork(network.getId(), Service.UserData)\n+                        && element instanceof UserDataServiceProvider &&\n+                        (element instanceof ConfigDriveNetworkElement || element instanceof VirtualRouterElement)) {\n+                    final UserDataServiceProvider sp = (UserDataServiceProvider) element;\n+                    if (!sp.addNewDisk(profile, network, vm, dest)) {\n+                        throw new CloudRuntimeException(\"Failed to create New Iso Disk\");\n+                    }\n+                }\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6679e3dd4fd6f5254b6e80391ea84fdbc496848a"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI3NjcyOA==", "bodyText": "space spilled over in the file ;)", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399276728", "createdAt": "2020-03-27T13:48:37Z", "author": {"login": "DaanHoogland"}, "path": "engine/schema/src/main/java/com/cloud/vm/dao/UserVmDaoImpl.java", "diffHunk": "@@ -1,4 +1,4 @@\n-// Licensed to the Apache Software Foundation (ASF) under one\n+    // Licensed to the Apache Software Foundation (ASF) under one", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6679e3dd4fd6f5254b6e80391ea84fdbc496848a"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI3OTY4NA==", "bodyText": "this method is already 200 lines, please add your logic in a new method/class or module.", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399279684", "createdAt": "2020-03-27T13:53:03Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtMigrateCommandWrapper.java", "diffHunk": "@@ -115,6 +118,30 @@ public Answer execute(final MigrateCommand command, final LibvirtComputingResour\n             conn = libvirtUtilitiesHelper.getConnectionByVmName(vmName);\n             ifaces = libvirtComputingResource.getInterfaces(conn, vmName);\n             disks = libvirtComputingResource.getDisks(conn, vmName);\n+\n+            String oldIsoVolumePath = null;\n+            for (DiskDef disk : disks) {\n+                if (disk.getDiskPath() != null && disk.getDiskPath().contains(vmName)) {\n+                    oldIsoVolumePath = disk.getDiskPath();\n+                    break;\n+                }\n+            }\n+\n+            VirtualMachineTO to = command.getVirtualMachine();\n+\n+            DiskTO newDisk = null;\n+            for (DiskTO disk : to.getDisks()) {\n+                if (disk.getPath() != null && disk.getPath().contains(\"configdrive\")) {\n+                    newDisk = disk;\n+                    break;\n+                }\n+            }\n+\n+            String newIsoVolumePath = null;\n+            if (newDisk != null) {\n+                 newIsoVolumePath = libvirtComputingResource.getVolumePath(conn, newDisk);\n+            }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI4NDY4Nw==", "bodyText": "this means the VM could not have another iso mounted?", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399284687", "createdAt": "2020-03-27T14:00:18Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtMigrateCommandWrapper.java", "diffHunk": "@@ -115,6 +118,30 @@ public Answer execute(final MigrateCommand command, final LibvirtComputingResour\n             conn = libvirtUtilitiesHelper.getConnectionByVmName(vmName);\n             ifaces = libvirtComputingResource.getInterfaces(conn, vmName);\n             disks = libvirtComputingResource.getDisks(conn, vmName);\n+\n+            String oldIsoVolumePath = null;\n+            for (DiskDef disk : disks) {\n+                if (disk.getDiskPath() != null && disk.getDiskPath().contains(vmName)) {\n+                    oldIsoVolumePath = disk.getDiskPath();\n+                    break;\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI4ODQ0Nw==", "bodyText": "please extract, and if not to much trouble other bits as well.", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399288447", "createdAt": "2020-03-27T14:05:51Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtMigrateCommandWrapper.java", "diffHunk": "@@ -141,6 +168,10 @@ Use VIR_DOMAIN_XML_SECURE (value = 1) prior to v1.0.0.\n             xmlDesc = dm.getXMLDesc(xmlFlag);\n             xmlDesc = replaceIpForVNCInDescFile(xmlDesc, target);\n \n+            if (newIsoVolumePath != null && oldIsoVolumePath != newIsoVolumePath) {\n+                s_logger.debug(\"editing mount path\");\n+                xmlDesc = replaceDiskSourceFile(xmlDesc, newIsoVolumePath, vmName);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI5OTY4OQ==", "bodyText": "this is a c&p of a bad pattern for two reasons:\n\nthe message if available should be explaining that it is a uri syntax issue.\nas in most of the other catch clauses this can be replaced by something like String.format(\"%s: %s\", e.getClass().getSimpleName(), e.getMessage()). And we should then unify the catch clauses.\n\nI suggest replacing with (something like):\n        } catch (final TimeoutException e) {\n            s_logger.debug(\"Timed out while migrating domain: \" + e.getMessage());\n            result = e.getMessage();\n        } catch (final IOException\n                | ParserConfigurationException\n                | SAXException\n                | TransformerException\n                | URISyntaxException e) {\n            s_logger.debug(String.format(\"%s: %s\", e.getClass().getSimpleName(), e.getMessage()));\n            result = \"Exception during migrate, see hypervisor for details; \" + e.getMessage();\n        } finally {", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399299689", "createdAt": "2020-03-27T14:22:05Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtMigrateCommandWrapper.java", "diffHunk": "@@ -250,6 +281,9 @@ Use VIR_DOMAIN_XML_SECURE (value = 1) prior to v1.0.0.\n         } catch (final TransformerException e) {\n             s_logger.debug(\"TransformerException: \" + e.getMessage());\n             result = e.getMessage();\n+        } catch (URISyntaxException e) {\n+            s_logger.debug(\"UriSyntaxException: \"+ e.getMessage());\n+            result = e.getMessage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMwMDk4NA==", "bodyText": "for - if - for - if - for - if - if, this should definitely be dissected and simplified.", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399300984", "createdAt": "2020-03-27T14:23:55Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtMigrateCommandWrapper.java", "diffHunk": "@@ -572,4 +606,49 @@ private String getXml(Document doc) throws TransformerException {\n \n         return byteArrayOutputStream.toString();\n     }\n+\n+    private String replaceDiskSourceFile(String xmlDesc, String isoPath, String vmName) throws IOException, SAXException, ParserConfigurationException, TransformerException {\n+        InputStream in = IOUtils.toInputStream(xmlDesc);\n+\n+        DocumentBuilderFactory docFactory = DocumentBuilderFactory.newInstance();\n+        DocumentBuilder docBuilder = docFactory.newDocumentBuilder();\n+        Document doc = docBuilder.parse(in);\n+\n+        // Get the root element\n+        Node domainNode = doc.getFirstChild();\n+\n+        NodeList domainChildNodes = domainNode.getChildNodes();\n+\n+        for (int i = 0; i < domainChildNodes.getLength(); i++) {\n+            Node domainChildNode = domainChildNodes.item(i);\n+\n+            if (\"devices\".equals(domainChildNode.getNodeName())) {\n+                NodeList devicesChildNodes = domainChildNode.getChildNodes();\n+\n+                for (int x = 0; x < devicesChildNodes.getLength(); x++) {\n+                    Node deviceChildNode = devicesChildNodes.item(x);\n+                    if (\"disk\".equals(deviceChildNode.getNodeName())) {\n+                        Node diskNode = deviceChildNode;\n+                        String sourceText = getSourceText(diskNode);\n+                        NodeList diskChildNodes = diskNode.getChildNodes();\n+                        for (int z = 0; z < diskChildNodes.getLength(); z++) {\n+                            Node diskChildNode = diskChildNodes.item(z);\n+                            if (\"source\".equals(diskChildNode.getNodeName())) {\n+                                Node sourceNode = diskChildNode;\n+                                NamedNodeMap sourceNodeAttributes = sourceNode.getAttributes();\n+                                Node sourceNodeAttribute = sourceNodeAttributes.getNamedItem(\"file\");\n+                                if ( sourceNodeAttribute.getNodeValue().contains(vmName)) {\n+                                    diskNode.removeChild(diskChildNode);\n+                                    Element newChildSourceNode = doc.createElement(\"source\");\n+                                    newChildSourceNode.setAttribute(\"file\", isoPath);\n+                                    diskNode.appendChild(newChildSourceNode);\n+                                }\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+        return getXml(doc);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMwMzczMA==", "bodyText": "and finally for (Node diskChildNode : diskChildNodes)", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399303730", "createdAt": "2020-03-27T14:27:36Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtMigrateCommandWrapper.java", "diffHunk": "@@ -572,4 +606,49 @@ private String getXml(Document doc) throws TransformerException {\n \n         return byteArrayOutputStream.toString();\n     }\n+\n+    private String replaceDiskSourceFile(String xmlDesc, String isoPath, String vmName) throws IOException, SAXException, ParserConfigurationException, TransformerException {\n+        InputStream in = IOUtils.toInputStream(xmlDesc);\n+\n+        DocumentBuilderFactory docFactory = DocumentBuilderFactory.newInstance();\n+        DocumentBuilder docBuilder = docFactory.newDocumentBuilder();\n+        Document doc = docBuilder.parse(in);\n+\n+        // Get the root element\n+        Node domainNode = doc.getFirstChild();\n+\n+        NodeList domainChildNodes = domainNode.getChildNodes();\n+\n+        for (int i = 0; i < domainChildNodes.getLength(); i++) {\n+            Node domainChildNode = domainChildNodes.item(i);\n+\n+            if (\"devices\".equals(domainChildNode.getNodeName())) {\n+                NodeList devicesChildNodes = domainChildNode.getChildNodes();\n+\n+                for (int x = 0; x < devicesChildNodes.getLength(); x++) {\n+                    Node deviceChildNode = devicesChildNodes.item(x);\n+                    if (\"disk\".equals(deviceChildNode.getNodeName())) {\n+                        Node diskNode = deviceChildNode;\n+                        String sourceText = getSourceText(diskNode);\n+                        NodeList diskChildNodes = diskNode.getChildNodes();\n+                        for (int z = 0; z < diskChildNodes.getLength(); z++) {\n+                            Node diskChildNode = diskChildNodes.item(z);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMwNTAyMQ==", "bodyText": "extract from here? by name of process- or search- or replaceChildDevices()?", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399305021", "createdAt": "2020-03-27T14:29:10Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtMigrateCommandWrapper.java", "diffHunk": "@@ -572,4 +606,49 @@ private String getXml(Document doc) throws TransformerException {\n \n         return byteArrayOutputStream.toString();\n     }\n+\n+    private String replaceDiskSourceFile(String xmlDesc, String isoPath, String vmName) throws IOException, SAXException, ParserConfigurationException, TransformerException {\n+        InputStream in = IOUtils.toInputStream(xmlDesc);\n+\n+        DocumentBuilderFactory docFactory = DocumentBuilderFactory.newInstance();\n+        DocumentBuilder docBuilder = docFactory.newDocumentBuilder();\n+        Document doc = docBuilder.parse(in);\n+\n+        // Get the root element\n+        Node domainNode = doc.getFirstChild();\n+\n+        NodeList domainChildNodes = domainNode.getChildNodes();\n+\n+        for (int i = 0; i < domainChildNodes.getLength(); i++) {\n+            Node domainChildNode = domainChildNodes.item(i);\n+\n+            if (\"devices\".equals(domainChildNode.getNodeName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMwNjExOA==", "bodyText": "extract here again (as process, search, replaceChildDisks())?", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399306118", "createdAt": "2020-03-27T14:30:35Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtMigrateCommandWrapper.java", "diffHunk": "@@ -572,4 +606,49 @@ private String getXml(Document doc) throws TransformerException {\n \n         return byteArrayOutputStream.toString();\n     }\n+\n+    private String replaceDiskSourceFile(String xmlDesc, String isoPath, String vmName) throws IOException, SAXException, ParserConfigurationException, TransformerException {\n+        InputStream in = IOUtils.toInputStream(xmlDesc);\n+\n+        DocumentBuilderFactory docFactory = DocumentBuilderFactory.newInstance();\n+        DocumentBuilder docBuilder = docFactory.newDocumentBuilder();\n+        Document doc = docBuilder.parse(in);\n+\n+        // Get the root element\n+        Node domainNode = doc.getFirstChild();\n+\n+        NodeList domainChildNodes = domainNode.getChildNodes();\n+\n+        for (int i = 0; i < domainChildNodes.getLength(); i++) {\n+            Node domainChildNode = domainChildNodes.item(i);\n+\n+            if (\"devices\".equals(domainChildNode.getNodeName())) {\n+                NodeList devicesChildNodes = domainChildNode.getChildNodes();\n+\n+                for (int x = 0; x < devicesChildNodes.getLength(); x++) {\n+                    Node deviceChildNode = devicesChildNodes.item(x);\n+                    if (\"disk\".equals(deviceChildNode.getNodeName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMwODg5OA==", "bodyText": "are we sure there will be only one? how about a VM with multiple disks/isos mounted? are we sure this contains() is selective enough?", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399308898", "createdAt": "2020-03-27T14:34:29Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtMigrateCommandWrapper.java", "diffHunk": "@@ -572,4 +606,49 @@ private String getXml(Document doc) throws TransformerException {\n \n         return byteArrayOutputStream.toString();\n     }\n+\n+    private String replaceDiskSourceFile(String xmlDesc, String isoPath, String vmName) throws IOException, SAXException, ParserConfigurationException, TransformerException {\n+        InputStream in = IOUtils.toInputStream(xmlDesc);\n+\n+        DocumentBuilderFactory docFactory = DocumentBuilderFactory.newInstance();\n+        DocumentBuilder docBuilder = docFactory.newDocumentBuilder();\n+        Document doc = docBuilder.parse(in);\n+\n+        // Get the root element\n+        Node domainNode = doc.getFirstChild();\n+\n+        NodeList domainChildNodes = domainNode.getChildNodes();\n+\n+        for (int i = 0; i < domainChildNodes.getLength(); i++) {\n+            Node domainChildNode = domainChildNodes.item(i);\n+\n+            if (\"devices\".equals(domainChildNode.getNodeName())) {\n+                NodeList devicesChildNodes = domainChildNode.getChildNodes();\n+\n+                for (int x = 0; x < devicesChildNodes.getLength(); x++) {\n+                    Node deviceChildNode = devicesChildNodes.item(x);\n+                    if (\"disk\".equals(deviceChildNode.getNodeName())) {\n+                        Node diskNode = deviceChildNode;\n+                        String sourceText = getSourceText(diskNode);\n+                        NodeList diskChildNodes = diskNode.getChildNodes();\n+                        for (int z = 0; z < diskChildNodes.getLength(); z++) {\n+                            Node diskChildNode = diskChildNodes.item(z);\n+                            if (\"source\".equals(diskChildNode.getNodeName())) {\n+                                Node sourceNode = diskChildNode;\n+                                NamedNodeMap sourceNodeAttributes = sourceNode.getAttributes();\n+                                Node sourceNodeAttribute = sourceNodeAttributes.getNamedItem(\"file\");\n+                                if ( sourceNodeAttribute.getNodeValue().contains(vmName)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMwOTUxOA==", "bodyText": "and how about when we are sure we have the right disk, do we just continue processing or should we escape somehow and not process the rest?", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399309518", "createdAt": "2020-03-27T14:35:25Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtMigrateCommandWrapper.java", "diffHunk": "@@ -572,4 +606,49 @@ private String getXml(Document doc) throws TransformerException {\n \n         return byteArrayOutputStream.toString();\n     }\n+\n+    private String replaceDiskSourceFile(String xmlDesc, String isoPath, String vmName) throws IOException, SAXException, ParserConfigurationException, TransformerException {\n+        InputStream in = IOUtils.toInputStream(xmlDesc);\n+\n+        DocumentBuilderFactory docFactory = DocumentBuilderFactory.newInstance();\n+        DocumentBuilder docBuilder = docFactory.newDocumentBuilder();\n+        Document doc = docBuilder.parse(in);\n+\n+        // Get the root element\n+        Node domainNode = doc.getFirstChild();\n+\n+        NodeList domainChildNodes = domainNode.getChildNodes();\n+\n+        for (int i = 0; i < domainChildNodes.getLength(); i++) {\n+            Node domainChildNode = domainChildNodes.item(i);\n+\n+            if (\"devices\".equals(domainChildNode.getNodeName())) {\n+                NodeList devicesChildNodes = domainChildNode.getChildNodes();\n+\n+                for (int x = 0; x < devicesChildNodes.getLength(); x++) {\n+                    Node deviceChildNode = devicesChildNodes.item(x);\n+                    if (\"disk\".equals(deviceChildNode.getNodeName())) {\n+                        Node diskNode = deviceChildNode;\n+                        String sourceText = getSourceText(diskNode);\n+                        NodeList diskChildNodes = diskNode.getChildNodes();\n+                        for (int z = 0; z < diskChildNodes.getLength(); z++) {\n+                            Node diskChildNode = diskChildNodes.item(z);\n+                            if (\"source\".equals(diskChildNode.getNodeName())) {\n+                                Node sourceNode = diskChildNode;\n+                                NamedNodeMap sourceNodeAttributes = sourceNode.getAttributes();\n+                                Node sourceNodeAttribute = sourceNodeAttributes.getNamedItem(\"file\");\n+                                if ( sourceNodeAttribute.getNodeValue().contains(vmName)) {\n+                                    diskNode.removeChild(diskChildNode);\n+                                    Element newChildSourceNode = doc.createElement(\"source\");\n+                                    newChildSourceNode.setAttribute(\"file\", isoPath);\n+                                    diskNode.appendChild(newChildSourceNode);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMxMTUyMg==", "bodyText": "again, no override but a double condition. It also constitutes double code, this is a value that should be returned by the VirtualMachineManager and not be implemented in two places, obviously.", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399311522", "createdAt": "2020-03-27T14:38:17Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/network/element/CloudZonesNetworkElement.java", "diffHunk": "@@ -217,11 +220,12 @@ public boolean addPasswordAndUserdata(Network network, NicProfile nic, VirtualMa\n             }\n             String serviceOffering = _serviceOfferingDao.findByIdIncludingRemoved(uservm.getServiceOfferingId()).getDisplayText();\n             String zoneName = _dcDao.findById(network.getDataCenterId()).getName();\n-\n+            final Account caller = CallContext.current().getCallingAccount();\n+            String destHostname = (VirtualMachineManager.AllowExposeHypervisorHostname.value() && VirtualMachineManager.AllowExposeHypervisorHostnameAccountLevel.valueIn(caller.getId())) ? dest.getHost().getName() : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMxMzkxNA==", "bodyText": "triple code ;)", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399313914", "createdAt": "2020-03-27T14:41:28Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/network/element/ConfigDriveNetworkElement.java", "diffHunk": "@@ -327,6 +355,30 @@ public void rollbackMigration(NicProfile nic, Network network, VirtualMachinePro\n     public void commitMigration(NicProfile nic, Network network, VirtualMachineProfile vm, ReservationContext src, ReservationContext dst) {\n     }\n \n+    private void recreateConfigDriveIso(NicProfile nic, Network network, VirtualMachineProfile vm, DeployDestination dest) throws ResourceUnavailableException {\n+        if (nic.isDefaultNic() && _networkModel.getUserDataUpdateProvider(network).getProvider().equals(Provider.ConfigDrive)) {\n+            DiskTO diskToUse = null;\n+            for (DiskTO disk : vm.getDisks()) {\n+                if (disk.getType() == Volume.Type.ISO && disk.getPath() != null && disk.getPath().contains(\"configdrive\")) {\n+                    diskToUse = disk;\n+                    break;\n+                }\n+            }\n+            final UserVmVO userVm = _userVmDao.findById(vm.getId());\n+            final Account caller = CallContext.current().getCallingAccount();\n+\n+            if (userVm != null) {\n+                final boolean isWindows = _guestOSCategoryDao.findById(_guestOSDao.findById(userVm.getGuestOSId()).getCategoryId()).getName().equalsIgnoreCase(\"Windows\");\n+                String destHostname = (VirtualMachineManager.AllowExposeHypervisorHostname.value() && VirtualMachineManager.AllowExposeHypervisorHostnameAccountLevel.valueIn(caller.getId())) ? dest.getHost().getName() : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMxNDc1OA==", "bodyText": "seems like this statement could do with its own method for readability (will be optimised out by the compiler anyway).", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399314758", "createdAt": "2020-03-27T14:42:35Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/network/element/ConfigDriveNetworkElement.java", "diffHunk": "@@ -327,6 +355,30 @@ public void rollbackMigration(NicProfile nic, Network network, VirtualMachinePro\n     public void commitMigration(NicProfile nic, Network network, VirtualMachineProfile vm, ReservationContext src, ReservationContext dst) {\n     }\n \n+    private void recreateConfigDriveIso(NicProfile nic, Network network, VirtualMachineProfile vm, DeployDestination dest) throws ResourceUnavailableException {\n+        if (nic.isDefaultNic() && _networkModel.getUserDataUpdateProvider(network).getProvider().equals(Provider.ConfigDrive)) {\n+            DiskTO diskToUse = null;\n+            for (DiskTO disk : vm.getDisks()) {\n+                if (disk.getType() == Volume.Type.ISO && disk.getPath() != null && disk.getPath().contains(\"configdrive\")) {\n+                    diskToUse = disk;\n+                    break;\n+                }\n+            }\n+            final UserVmVO userVm = _userVmDao.findById(vm.getId());\n+            final Account caller = CallContext.current().getCallingAccount();\n+\n+            if (userVm != null) {\n+                final boolean isWindows = _guestOSCategoryDao.findById(_guestOSDao.findById(userVm.getGuestOSId()).getCategoryId()).getName().equalsIgnoreCase(\"Windows\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyMDEwNA==", "bodyText": "can you put in getOrDecideOnWhichDataStoreToUseOrSomeNameLikeThat()?", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399320104", "createdAt": "2020-03-27T14:49:42Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/network/element/ConfigDriveNetworkElement.java", "diffHunk": "@@ -424,8 +476,25 @@ private Long findAgentId(VirtualMachineProfile profile, DeployDestination dest,\n         return agentId;\n     }\n \n-    private boolean createConfigDriveIso(VirtualMachineProfile profile, DeployDestination dest) throws ResourceUnavailableException {\n-        final DataStore dataStore = findDataStore(profile, dest);\n+    private boolean createConfigDriveIso(VirtualMachineProfile profile, DeployDestination dest, DiskTO disk) throws ResourceUnavailableException {\n+        DataStore dataStore = null;\n+        if (disk != null) {\n+            String dId = disk.getData().getDataStore().getUuid();\n+            if (VirtualMachineManager.VmConfigDriveOnPrimaryPool.value()) {\n+                dataStore = _dataStoreMgr.getDataStore(dId, DataStoreRole.Primary);\n+            } else {\n+                List<DataStore> dataStores = _dataStoreMgr.listImageStores();\n+                String url = disk.getData().getDataStore().getUrl();\n+                for(DataStore ds : dataStores) {\n+                    if (url.equals(ds.getUri()) && DataStoreRole.Image.equals(ds.getRole())) {\n+                        dataStore = ds;\n+                        break;\n+                    }\n+                }\n+            }\n+        } else {\n+            dataStore = findDataStore(profile, dest);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 160}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyMDYxNw==", "bodyText": "quadruple code...", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399320617", "createdAt": "2020-03-27T14:50:24Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/network/element/ConfigDriveNetworkElement.java", "diffHunk": "@@ -514,9 +584,11 @@ private boolean configureConfigDriveData(final VirtualMachineProfile profile, fi\n             final String sshPublicKey = getSshKey(profile);\n             final String serviceOffering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId()).getDisplayText();\n             boolean isWindows = _guestOSCategoryDao.findById(_guestOSDao.findById(vm.getGuestOSId()).getCategoryId()).getName().equalsIgnoreCase(\"Windows\");\n-\n+            String hostname = _hostDao.findById(vm.getHostId()).getName();\n+            final Account caller = CallContext.current().getCallingAccount();\n+            String destHostname = (VirtualMachineManager.AllowExposeHypervisorHostname.value() && VirtualMachineManager.AllowExposeHypervisorHostnameAccountLevel.valueIn(caller.getId())) ? hostname : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 179}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyMTE5OQ==", "bodyText": "maybe the hostname retrieval and caller account should be added inside the call as well.", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399321199", "createdAt": "2020-03-27T14:51:14Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/network/element/ConfigDriveNetworkElement.java", "diffHunk": "@@ -514,9 +584,11 @@ private boolean configureConfigDriveData(final VirtualMachineProfile profile, fi\n             final String sshPublicKey = getSshKey(profile);\n             final String serviceOffering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId()).getDisplayText();\n             boolean isWindows = _guestOSCategoryDao.findById(_guestOSDao.findById(vm.getGuestOSId()).getCategoryId()).getName().equalsIgnoreCase(\"Windows\");\n-\n+            String hostname = _hostDao.findById(vm.getHostId()).getName();\n+            final Account caller = CallContext.current().getCallingAccount();\n+            String destHostname = (VirtualMachineManager.AllowExposeHypervisorHostname.value() && VirtualMachineManager.AllowExposeHypervisorHostnameAccountLevel.valueIn(caller.getId())) ? hostname : null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyMDYxNw=="}, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 179}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyNjI3MA==", "bodyText": "this one is certainly not adding any disk. we need to change that name.", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399326270", "createdAt": "2020-03-27T14:58:03Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/network/element/VirtualRouterElement.java", "diffHunk": "@@ -765,6 +772,33 @@ public boolean saveSSHKey(final Network network, final NicProfile nic, final Vir\n         return result;\n     }\n \n+    @Override\n+    public boolean addNewDisk(NicProfile nicProfile, Network network, VirtualMachineProfile vm, DeployDestination dest) throws ResourceUnavailableException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyNzU0Ng==", "bodyText": "\ud83d\udc4e", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399327546", "createdAt": "2020-03-27T14:59:49Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/network/element/VpcVirtualRouterElement.java", "diffHunk": "@@ -711,4 +711,5 @@ public boolean stopVpn(final RemoteAccessVpn vpn) throws ResourceUnavailableExce\n         }\n         return result;\n     }\n-}\n\\ No newline at end of file\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyODQ1NA==", "bodyText": "fifth", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399328454", "createdAt": "2020-03-27T15:01:02Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/network/router/CommandSetupHelper.java", "diffHunk": "@@ -177,23 +180,30 @@\n     private VlanDao _vlanDao;\n     @Inject\n     private IPAddressDao _ipAddressDao;\n-\n     @Inject\n     private RouterControlHelper _routerControlHelper;\n+    @Inject\n+    private HostDao _hostDao;\n \n     @Autowired\n     @Qualifier(\"networkHelper\")\n     protected NetworkHelper _networkHelper;\n \n     public void createVmDataCommand(final VirtualRouter router, final UserVm vm, final NicVO nic, final String publicKey, final Commands cmds) {\n-        final String serviceOffering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId()).getDisplayText();\n-        final String zoneName = _dcDao.findById(router.getDataCenterId()).getName();\n-        final IPAddressVO staticNatIp = _ipAddressDao.findByVmIdAndNetworkId(nic.getNetworkId(), vm.getId());\n-        cmds.addCommand(\n-                \"vmdata\",\n-                generateVmDataCommand(router, nic.getIPv4Address(), vm.getUserData(), serviceOffering, zoneName,\n-                        staticNatIp == null || staticNatIp.getState() != IpAddress.State.Allocated ? null : staticNatIp.getAddress().addr(), vm.getHostName(), vm.getInstanceName(),\n-                        vm.getId(), vm.getUuid(), publicKey, nic.getNetworkId()));\n+        if (vm != null && router != null && nic != null) {\n+            final String serviceOffering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId()).getDisplayText();\n+            final String zoneName = _dcDao.findById(router.getDataCenterId()).getName();\n+            final IPAddressVO staticNatIp = _ipAddressDao.findByVmIdAndNetworkId(nic.getNetworkId(), vm.getId());\n+\n+            Host host = _hostDao.findById(vm.getHostId());\n+            final Account caller = CallContext.current().getCallingAccount();\n+            String destHostname = (VirtualMachineManager.AllowExposeHypervisorHostname.value() && VirtualMachineManager.AllowExposeHypervisorHostnameAccountLevel.valueIn(caller.getId())) ? host.getName() : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyOTQ2NQ==", "bodyText": "so why wasn't this needed before?", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399329465", "createdAt": "2020-03-27T15:02:18Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/network/router/CommandSetupHelper.java", "diffHunk": "@@ -177,23 +180,30 @@\n     private VlanDao _vlanDao;\n     @Inject\n     private IPAddressDao _ipAddressDao;\n-\n     @Inject\n     private RouterControlHelper _routerControlHelper;\n+    @Inject\n+    private HostDao _hostDao;\n \n     @Autowired\n     @Qualifier(\"networkHelper\")\n     protected NetworkHelper _networkHelper;\n \n     public void createVmDataCommand(final VirtualRouter router, final UserVm vm, final NicVO nic, final String publicKey, final Commands cmds) {\n-        final String serviceOffering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId()).getDisplayText();\n-        final String zoneName = _dcDao.findById(router.getDataCenterId()).getName();\n-        final IPAddressVO staticNatIp = _ipAddressDao.findByVmIdAndNetworkId(nic.getNetworkId(), vm.getId());\n-        cmds.addCommand(\n-                \"vmdata\",\n-                generateVmDataCommand(router, nic.getIPv4Address(), vm.getUserData(), serviceOffering, zoneName,\n-                        staticNatIp == null || staticNatIp.getState() != IpAddress.State.Allocated ? null : staticNatIp.getAddress().addr(), vm.getHostName(), vm.getInstanceName(),\n-                        vm.getId(), vm.getUuid(), publicKey, nic.getNetworkId()));\n+        if (vm != null && router != null && nic != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyOTg1NA==", "bodyText": "Why?", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399329854", "createdAt": "2020-03-27T15:02:50Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/network/rules/UserdataToRouterRules.java", "diffHunk": "@@ -50,6 +50,7 @@ public boolean accept(final NetworkTopologyVisitor visitor, final VirtualRouter\n \n         UserVmDao userVmDao = visitor.getVirtualNetworkApplianceFactory().getUserVmDao();\n         _userVM = userVmDao.findById(_profile.getVirtualMachine().getId());\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzMDQ4OQ==", "bodyText": "method (sixth use)", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399330489", "createdAt": "2020-03-27T15:03:38Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -4352,9 +4352,10 @@ public boolean finalizeVirtualMachineProfile(VirtualMachineProfile profile, Depl\n             if (_networkModel.isSharedNetworkWithoutServices(network.getId())) {\n                 final String serviceOffering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId()).getDisplayText();\n                 boolean isWindows = _guestOSCategoryDao.findById(_guestOSDao.findById(vm.getGuestOSId()).getCategoryId()).getName().equalsIgnoreCase(\"Windows\");\n-\n+                final Account caller = CallContext.current().getCallingAccount();\n+                String destHostname = (VirtualMachineManager.AllowExposeHypervisorHostname.value() && VirtualMachineManager.AllowExposeHypervisorHostnameAccountLevel.valueIn(caller.getId())) ? dest.getHost().getName() : null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzMzM2MQ==", "bodyText": "same name as the next (line 243)", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399333361", "createdAt": "2020-03-27T15:07:37Z", "author": {"login": "DaanHoogland"}, "path": "test/integration/component/test_vr_metadata.py", "diffHunk": "@@ -0,0 +1,347 @@\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#   http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing,\n+# software distributed under the License is distributed on an\n+# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+# KIND, either express or implied.  See the License for the\n+# specific language governing permissions and limitations\n+# under the License.\n+\n+\n+# this script will cover VMdeployment  with Userdata tests\n+\n+from marvin.cloudstackTestCase import cloudstackTestCase\n+from marvin.lib.base import *\n+from marvin.lib.utils import (validateList, cleanup_resources)\n+from marvin.lib.common import *\n+from nose.plugins.attrib import attr\n+from marvin.codes import PASS,FAIL\n+\n+_multiprocess_shared_ = True\n+\n+class Services:\n+    def __init__(self):\n+        self.services = {\n+            \"virtual_machine\": {\n+                \"displayname\": \"TesVM1\",\n+                \"username\": \"root\",\n+                \"password\": \"password\",\n+                \"ssh_port\": 22,\n+                \"hypervisor\": 'XenServer',\n+                \"privateport\": 22,\n+                \"publicport\": 22,\n+                \"protocol\": 'TCP',\n+                },\n+            \"ostype\": 'CentOS 5.5 (64-bit)',\n+            \"service_offering\": {\n+                \"name\": \"Tiny Instance\",\n+                \"displaytext\": \"Tiny Instance\",\n+                \"cpunumber\": 1,\n+                \"cpuspeed\": 100,\n+                \"memory\": 256,\n+                },\n+            }\n+\n+class TestDeployVmWithMetaData(cloudstackTestCase):\n+    @classmethod\n+    def setUpClass(cls):\n+        cls.testclient = super(TestDeployVmWithMetaData, cls).getClsTestClient()\n+        cls.apiclient = cls.testclient.getApiClient()\n+        cls._cleanup = []\n+        #cls.services = Services().services\n+        cls.services = cls.testclient.getParsedTestDataConfig()\n+        cls.zone = get_zone(cls.apiclient, cls.testclient.getZoneForTests())\n+        cls.service_offering = ServiceOffering.create(\n+            cls.apiclient,\n+            cls.services[\"service_offering\"]\n+        )\n+\n+        cls.template = get_template(\n+            cls.apiclient,\n+            cls.zone.id,\n+            cls.services[\"ostype\"]\n+        )\n+\n+\n+    @classmethod\n+    def tearDownClass(cls):\n+        try:\n+            cls._cleanup = cls._cleanup[::-1]\n+            cleanup_resources(cls.apiclient, cls._cleanup)\n+        except Exception as e:\n+            raise Exception(\"Warning: Exception during cleanup : %s\" % e)\n+\n+    def setUp(self):\n+        self.apiclient = self.testClient.getApiClient()\n+        self.cleanup = []\n+\n+    def tearDown(self):\n+        try:\n+            self.cleanup = self.cleanup[::-1]\n+            cleanup_resources(self.apiclient, self.cleanup)\n+        except Exception as e:\n+            raise Exception(\"Warning: Exception during cleanup : %s\" % e)\n+        return\n+\n+    def migrate_VM(self, vm):\n+        \"\"\"Migrates VM to another host, if available\"\"\"\n+        self.debug(\"+++ Migrating one of the VMs in the created \"\n+                   \"VPC Tier network to another host, if available...\")\n+        self.debug(\"Checking if a host is available for migration...\")\n+        hosts = Host.listForMigration(self.apiclient, virtualmachineid=vm.id)\n+        if hosts:\n+            self.assertEqual(isinstance(hosts, list), True,\n+                             \"List hosts should return a valid list\"\n+                             )\n+            host = hosts[0]\n+            self.debug(\"Migrating VM with ID: \"\n+                       \"%s to Host: %s\" % (vm.id, host.id))\n+            try:\n+                vm.migrate(self.apiclient, hostid=host.id)\n+            except Exception as e:\n+                self.fail(\"Failed to migrate instance, %s\" % e)\n+            self.debug(\"Migrated VM with ID: \"\n+                       \"%s to Host: %s\" % (vm.id, host.id))\n+        else:\n+            self.debug(\"No host available for migration. \"\n+                       \"Test requires at-least 2 hosts\")\n+        return host\n+\n+    def list_nics(self, vm_id):\n+        list_vm_res = VirtualMachine.list(self.apiclient, id=vm_id)\n+        self.assertEqual(validateList(list_vm_res)[0], PASS, \"List vms returned invalid response\")\n+        nics = list_vm_res[0].nic\n+        for nic in nics:\n+            if nic.type == \"Shared\":\n+                nic_res = NIC.list(\n+                    self.apiclient,\n+                    virtualmachineid=vm_id,\n+                    nicid=nic.id\n+                )\n+                nic_ip = nic_res[0].ipaddress\n+                self.assertIsNotNone(nic_ip, \"listNics API response does not have the ip address\")\n+            else:\n+                continue\n+        return\n+\n+    @attr(tags=[\"advanced\"], required_hardware='True')\n+    def test_deployVM_verify_metadata_in_VR(self):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 136}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMzMzU3Mg==", "bodyText": "this method has the same name as the previous (line 136)", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r399333572", "createdAt": "2020-03-27T15:07:55Z", "author": {"login": "DaanHoogland"}, "path": "test/integration/component/test_vr_metadata.py", "diffHunk": "@@ -0,0 +1,347 @@\n+# Licensed to the Apache Software Foundation (ASF) under one\n+# or more contributor license agreements.  See the NOTICE file\n+# distributed with this work for additional information\n+# regarding copyright ownership.  The ASF licenses this file\n+# to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance\n+# with the License.  You may obtain a copy of the License at\n+#\n+#   http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing,\n+# software distributed under the License is distributed on an\n+# \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+# KIND, either express or implied.  See the License for the\n+# specific language governing permissions and limitations\n+# under the License.\n+\n+\n+# this script will cover VMdeployment  with Userdata tests\n+\n+from marvin.cloudstackTestCase import cloudstackTestCase\n+from marvin.lib.base import *\n+from marvin.lib.utils import (validateList, cleanup_resources)\n+from marvin.lib.common import *\n+from nose.plugins.attrib import attr\n+from marvin.codes import PASS,FAIL\n+\n+_multiprocess_shared_ = True\n+\n+class Services:\n+    def __init__(self):\n+        self.services = {\n+            \"virtual_machine\": {\n+                \"displayname\": \"TesVM1\",\n+                \"username\": \"root\",\n+                \"password\": \"password\",\n+                \"ssh_port\": 22,\n+                \"hypervisor\": 'XenServer',\n+                \"privateport\": 22,\n+                \"publicport\": 22,\n+                \"protocol\": 'TCP',\n+                },\n+            \"ostype\": 'CentOS 5.5 (64-bit)',\n+            \"service_offering\": {\n+                \"name\": \"Tiny Instance\",\n+                \"displaytext\": \"Tiny Instance\",\n+                \"cpunumber\": 1,\n+                \"cpuspeed\": 100,\n+                \"memory\": 256,\n+                },\n+            }\n+\n+class TestDeployVmWithMetaData(cloudstackTestCase):\n+    @classmethod\n+    def setUpClass(cls):\n+        cls.testclient = super(TestDeployVmWithMetaData, cls).getClsTestClient()\n+        cls.apiclient = cls.testclient.getApiClient()\n+        cls._cleanup = []\n+        #cls.services = Services().services\n+        cls.services = cls.testclient.getParsedTestDataConfig()\n+        cls.zone = get_zone(cls.apiclient, cls.testclient.getZoneForTests())\n+        cls.service_offering = ServiceOffering.create(\n+            cls.apiclient,\n+            cls.services[\"service_offering\"]\n+        )\n+\n+        cls.template = get_template(\n+            cls.apiclient,\n+            cls.zone.id,\n+            cls.services[\"ostype\"]\n+        )\n+\n+\n+    @classmethod\n+    def tearDownClass(cls):\n+        try:\n+            cls._cleanup = cls._cleanup[::-1]\n+            cleanup_resources(cls.apiclient, cls._cleanup)\n+        except Exception as e:\n+            raise Exception(\"Warning: Exception during cleanup : %s\" % e)\n+\n+    def setUp(self):\n+        self.apiclient = self.testClient.getApiClient()\n+        self.cleanup = []\n+\n+    def tearDown(self):\n+        try:\n+            self.cleanup = self.cleanup[::-1]\n+            cleanup_resources(self.apiclient, self.cleanup)\n+        except Exception as e:\n+            raise Exception(\"Warning: Exception during cleanup : %s\" % e)\n+        return\n+\n+    def migrate_VM(self, vm):\n+        \"\"\"Migrates VM to another host, if available\"\"\"\n+        self.debug(\"+++ Migrating one of the VMs in the created \"\n+                   \"VPC Tier network to another host, if available...\")\n+        self.debug(\"Checking if a host is available for migration...\")\n+        hosts = Host.listForMigration(self.apiclient, virtualmachineid=vm.id)\n+        if hosts:\n+            self.assertEqual(isinstance(hosts, list), True,\n+                             \"List hosts should return a valid list\"\n+                             )\n+            host = hosts[0]\n+            self.debug(\"Migrating VM with ID: \"\n+                       \"%s to Host: %s\" % (vm.id, host.id))\n+            try:\n+                vm.migrate(self.apiclient, hostid=host.id)\n+            except Exception as e:\n+                self.fail(\"Failed to migrate instance, %s\" % e)\n+            self.debug(\"Migrated VM with ID: \"\n+                       \"%s to Host: %s\" % (vm.id, host.id))\n+        else:\n+            self.debug(\"No host available for migration. \"\n+                       \"Test requires at-least 2 hosts\")\n+        return host\n+\n+    def list_nics(self, vm_id):\n+        list_vm_res = VirtualMachine.list(self.apiclient, id=vm_id)\n+        self.assertEqual(validateList(list_vm_res)[0], PASS, \"List vms returned invalid response\")\n+        nics = list_vm_res[0].nic\n+        for nic in nics:\n+            if nic.type == \"Shared\":\n+                nic_res = NIC.list(\n+                    self.apiclient,\n+                    virtualmachineid=vm_id,\n+                    nicid=nic.id\n+                )\n+                nic_ip = nic_res[0].ipaddress\n+                self.assertIsNotNone(nic_ip, \"listNics API response does not have the ip address\")\n+            else:\n+                continue\n+        return\n+\n+    @attr(tags=[\"advanced\"], required_hardware='True')\n+    def test_deployVM_verify_metadata_in_VR(self):\n+        \"\"\"\n+        1. Create a network (VR as a provider)\n+        2. Deploy a VM in the network\n+        3. Verify VM deployment\n+        4. From the VM, curl the gateway of the VR to verify the corresponding metadata - hypervisor host name\n+            if the respective Global level and account level flags are set to true\n+        \"\"\"\n+        # Update global setting for \"allow.expose.host.hostname\"\n+        Configurations.update(self.apiclient,\n+                              name=\"allow.expose.host.hostname\",\n+                              value=\"true\"\n+                              )\n+\n+        # Update Account level setting\n+        Configurations.update(self.apiclient,\n+                              name=\"allow.expose.host.hostname\",\n+                              value=\"true\",\n+                              accountid=1\n+                              )\n+\n+        # Verify that the above mentioned settings are set to true before proceeding\n+        if not is_config_suitable(\n+                apiclient=self.apiclient,\n+                name='allow.expose.host.hostname',\n+                value='true'):\n+            self.skipTest('allow.expose.host.hostname should be true. skipping')\n+\n+        if not is_config_suitable(\n+                apiclient=self.apiclient,\n+                name='allow.expose.host.hostname',\n+                value='true'):\n+            self.skipTest('allow.expose.host.hostname should be true. skipping')\n+\n+        self.no_isolate = NetworkOffering.create(\n+            self.apiclient,\n+            self.services[\"isolated_network_offering\"]\n+        )\n+        self.no_isolate.update(self.apiclient, state='Enabled')\n+        self.isolated_network = Network.create(\n+            self.apiclient,\n+            self.services[\"network\"],\n+            networkofferingid=self.no_isolate.id,\n+            zoneid=self.zone.id,\n+            accountid=\"admin\",\n+            domainid=1\n+        )\n+        self.cleanup.append(self.isolated_network)\n+\n+        self.vm = VirtualMachine.create(\n+            self.apiclient,\n+            self.services[\"virtual_machine\"],\n+            templateid=self.template.id,\n+            accountid=\"admin\",\n+            domainid=1,\n+            serviceofferingid=self.service_offering.id,\n+            zoneid=self.zone.id,\n+            networkids=[self.isolated_network.id],\n+        )\n+        self.assertIsNotNone(\n+            self.vm,\n+            \"VM creation failed in the isolated network\"\n+        )\n+        self.cleanup.append(self.vm)\n+\n+        ip_addr = self.vm.ipaddress\n+        self.debug(\"VM ip address = %s\" % ip_addr)\n+        # ip_status, ip_addr = self.getVMIPAddress(self.vm.id)\n+        # self.assertEqual(\n+        #     ip_status,\n+        #     1,\n+        #     \"Failed to retrieve vm ip address\"\n+        # )\n+\n+        # Verify the retrieved ip address in listNICs API response\n+        self.list_nics(self.vm.id)\n+        vr_res = Router.list(\n+            self.apiclient,\n+            networkid=self.isolated_network.id,\n+            listAll=True\n+        )\n+        self.assertEqual(validateList(vr_res)[0], PASS, \"List Routers returned invalid response\")\n+        vr_ip = vr_res[0].guestipaddress\n+        ssh = self.vm.get_ssh_client(ipaddress=ip_addr)\n+        cmd = \"curl http://%s/latest/hypervisor-host-name\" % vr_ip\n+        res = ssh.execute(cmd)\n+        self.debug(\"Verifying hypervisor hostname details in the VR\")\n+        self.assertEqual(\n+            str(res),\n+            self.vm.hostname,\n+            \"Failed to get the hypervisor host name from VR in isolated network\"\n+        )\n+        # Reset configuration values to default values i.e., false\n+        Configurations.update(self.apiclient,\n+                              name=\"allow.expose.host.hostname\",\n+                              value=\"false\"\n+                              )\n+\n+        # Update Account level setting\n+        Configurations.update(self.apiclient,\n+                              name=\"allow.expose.host.hostname\",\n+                              value=\"false\",\n+                              accountid=1\n+                              )\n+        return\n+\n+    @attr(tags=[\"advanced\"], required_hardware='True')\n+    def test_deployVM_verify_metadata_in_VR(self):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c70ba9b7dcb459922020d4f89a61c9367dad7c2c"}, "originalPosition": 243}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "105b8974a9ab73118fd4323a66bb4424bb04b1b6", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/105b8974a9ab73118fd4323a66bb4424bb04b1b6", "committedDate": "2020-03-30T06:19:42Z", "message": "Addressed Comments and fixed issues with ISO attachment when secondary storage is used"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5fa897d3e3e1f9a132636d13aee3135d8513f02", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/e5fa897d3e3e1f9a132636d13aee3135d8513f02", "committedDate": "2020-03-30T13:50:06Z", "message": "formatting code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "699661d73e3df09a6b6a53fef04682dc1678933a", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/699661d73e3df09a6b6a53fef04682dc1678933a", "committedDate": "2020-03-31T06:20:49Z", "message": "Changed addNewDisk() to addHypervisorHostname"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6833d8b1d0f91c78c509dccd063788c66e8b5dcc", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/6833d8b1d0f91c78c509dccd063788c66e8b5dcc", "committedDate": "2020-03-31T08:20:16Z", "message": "Fixed null pointer and deployment issue on configDrive network"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MDIzMzIx", "url": "https://github.com/apache/cloudstack/pull/3976#pullrequestreview-385023321", "createdAt": "2020-03-31T19:05:29Z", "commit": {"oid": "699661d73e3df09a6b6a53fef04682dc1678933a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxOTowNToyOVrOF-kGvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxOTowNToyOVrOF-kGvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTE0NzU4MQ==", "bodyText": "Javadoc still missing - suggested on prior comment from Daan", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r401147581", "createdAt": "2020-03-31T19:05:29Z", "author": {"login": "nvazquez"}, "path": "engine/api/src/main/java/org/apache/cloudstack/engine/orchestration/service/NetworkOrchestrationService.java", "diffHunk": "@@ -294,6 +294,8 @@ void implementNetworkElementsAndResources(DeployDestination dest, ReservationCon\n \n     void finalizeUpdateInSequence(Network network, boolean success);\n \n+    void addHypervisorHostname(VirtualMachineProfile vm, DeployDestination dest) throws ResourceUnavailableException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "699661d73e3df09a6b6a53fef04682dc1678933a"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b38ef407a5ad062ba1314143054e7c81b4362fba", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/b38ef407a5ad062ba1314143054e7c81b4362fba", "committedDate": "2020-04-01T04:10:56Z", "message": "Added javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "832e90d6e58c84f5ab22c3371b46a2eb80ac4aa9", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/832e90d6e58c84f5ab22c3371b46a2eb80ac4aa9", "committedDate": "2020-04-01T06:23:20Z", "message": "Code refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb12eaed23ab1f98b1bb18dec36b146d4ab9edfd", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/cb12eaed23ab1f98b1bb18dec36b146d4ab9edfd", "committedDate": "2020-04-01T06:33:12Z", "message": "added comments explaining function usage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1OTA0ODkx", "url": "https://github.com/apache/cloudstack/pull/3976#pullrequestreview-385904891", "createdAt": "2020-04-01T19:58:06Z", "commit": {"oid": "cb12eaed23ab1f98b1bb18dec36b146d4ab9edfd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxOTo1ODowN1rOF_QZkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxOTo1ODowN1rOF_QZkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg3MzI5OQ==", "bodyText": "please remove or add description of use/reason for throwing", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r401873299", "createdAt": "2020-04-01T19:58:07Z", "author": {"login": "DaanHoogland"}, "path": "engine/api/src/main/java/org/apache/cloudstack/engine/orchestration/service/NetworkOrchestrationService.java", "diffHunk": "@@ -294,6 +294,15 @@ void implementNetworkElementsAndResources(DeployDestination dest, ReservationCon\n \n     void finalizeUpdateInSequence(Network network, boolean success);\n \n+    /**\n+     * Adds hypervisor hostname to a file - hypervisor-host-name if the userdata\n+     * service provider is ConfigDrive or VirtualRouter\n+     * @param vm\n+     * @param dest\n+     * @throws ResourceUnavailableException", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb12eaed23ab1f98b1bb18dec36b146d4ab9edfd"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1OTEwODg0", "url": "https://github.com/apache/cloudstack/pull/3976#pullrequestreview-385910884", "createdAt": "2020-04-01T20:06:59Z", "commit": {"oid": "cb12eaed23ab1f98b1bb18dec36b146d4ab9edfd"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMDowNjo1OVrOF_Qrzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMDowNjo1OVrOF_Qrzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg3Nzk2Ng==", "bodyText": "I think even this part could be factorred out. the method is still almost 200 lines. (no biggy)", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r401877966", "createdAt": "2020-04-01T20:06:59Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtMigrateCommandWrapper.java", "diffHunk": "@@ -141,6 +146,12 @@ Use VIR_DOMAIN_XML_SECURE (value = 1) prior to v1.0.0.\n             xmlDesc = dm.getXMLDesc(xmlFlag);\n             xmlDesc = replaceIpForVNCInDescFile(xmlDesc, target);\n \n+            String oldIsoVolumePath = getOldVolumePath(disks, vmName);\n+            String newIsoVolumePath = getNewVolumePathIfDatastoreHasChanged(libvirtComputingResource, conn, to);\n+            if (newIsoVolumePath != null && !newIsoVolumePath.equals(oldIsoVolumePath)) {\n+                s_logger.debug(\"Editing mount path\");\n+                xmlDesc = replaceDiskSourceFile(xmlDesc, newIsoVolumePath, vmName);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb12eaed23ab1f98b1bb18dec36b146d4ab9edfd"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1OTQxNTM2", "url": "https://github.com/apache/cloudstack/pull/3976#pullrequestreview-385941536", "createdAt": "2020-04-01T20:54:25Z", "commit": {"oid": "cb12eaed23ab1f98b1bb18dec36b146d4ab9edfd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d223178815332fa786395259c4f199f509587ad9", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/d223178815332fa786395259c4f199f509587ad9", "committedDate": "2020-04-02T08:29:50Z", "message": "Added javadoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MTc3MTk3", "url": "https://github.com/apache/cloudstack/pull/3976#pullrequestreview-387177197", "createdAt": "2020-04-03T11:35:14Z", "commit": {"oid": "d223178815332fa786395259c4f199f509587ad9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMTozNToxNVrOGARs6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxMTozNToxNVrOGARs6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjk0MzIxMQ==", "bodyText": "please add descriptions or remove", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r402943211", "createdAt": "2020-04-03T11:35:15Z", "author": {"login": "DaanHoogland"}, "path": "engine/api/src/main/java/org/apache/cloudstack/engine/orchestration/service/NetworkOrchestrationService.java", "diffHunk": "@@ -299,7 +299,7 @@ void implementNetworkElementsAndResources(DeployDestination dest, ReservationCon\n      * service provider is ConfigDrive or VirtualRouter\n      * @param vm\n      * @param dest", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d223178815332fa786395259c4f199f509587ad9"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1da2803cef51dd3bfcfa1c68b4551fe7a6c78b50", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/1da2803cef51dd3bfcfa1c68b4551fe7a6c78b50", "committedDate": "2020-04-03T11:40:23Z", "message": "javadoc addition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "412694c5676f5b5d0e6667826e832d6bcab5a662", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/412694c5676f5b5d0e6667826e832d6bcab5a662", "committedDate": "2020-04-17T08:07:37Z", "message": "Review changes - Created const value for user device id and refactored disk prepare method."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c2773c82f85c9c0169eefa4c409c078ff7b4fcc", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/0c2773c82f85c9c0169eefa4c409c078ff7b4fcc", "committedDate": "2020-04-20T09:57:45Z", "message": "Fixed vm with configdrive migration error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea077bcfb221f0d42342615a91e6418c4249ecc2", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/ea077bcfb221f0d42342615a91e6418c4249ecc2", "committedDate": "2020-05-04T08:20:22Z", "message": "Fixed iso not attaching after migration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1779e3653b69d192e128d989e09d76d4b1ed021", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/f1779e3653b69d192e128d989e09d76d4b1ed021", "committedDate": "2020-05-04T08:26:09Z", "message": "Added static string"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbbaad89991c667d58cfb3a8e46079d725146273", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/cbbaad89991c667d58cfb3a8e46079d725146273", "committedDate": "2020-05-04T08:42:00Z", "message": "Added static string"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74f8488bbdf3402b9ebed123c11d5175f2ecde13", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/74f8488bbdf3402b9ebed123c11d5175f2ecde13", "committedDate": "2020-05-08T05:54:40Z", "message": "Merge branch 'FR44_master' of github.com:shapeblue/cloudstack into FR44_master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "637ba955363e31f94691df8f9674cc0bb7cff1e9", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/637ba955363e31f94691df8f9674cc0bb7cff1e9", "committedDate": "2020-05-28T10:06:45Z", "message": "modified global setting name"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c72117104a5cf332acf8c720b9ca2a32c98c3bab", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/c72117104a5cf332acf8c720b9ca2a32c98c3bab", "committedDate": "2020-05-28T09:28:25Z", "message": "modified global setting name"}, "afterCommit": {"oid": "637ba955363e31f94691df8f9674cc0bb7cff1e9", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/637ba955363e31f94691df8f9674cc0bb7cff1e9", "committedDate": "2020-05-28T10:06:45Z", "message": "modified global setting name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f5df355fc02a8e43ed7567b5311c56d16fda86e", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/1f5df355fc02a8e43ed7567b5311c56d16fda86e", "committedDate": "2020-06-02T07:24:02Z", "message": "Removed public modifier"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0018999f5b232fc4e63d5e80baf922eba0fd775d", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/0018999f5b232fc4e63d5e80baf922eba0fd775d", "committedDate": "2020-06-11T10:44:21Z", "message": "Merge branch 'master' of github.com:shapeblue/cloudstack into FR44_master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMjA5NzE4", "url": "https://github.com/apache/cloudstack/pull/3976#pullrequestreview-431209718", "createdAt": "2020-06-16T06:57:54Z", "commit": {"oid": "637ba955363e31f94691df8f9674cc0bb7cff1e9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1482686e07e1589223df5fe09670c3d03e6870e", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/d1482686e07e1589223df5fe09670c3d03e6870e", "committedDate": "2020-06-17T03:14:37Z", "message": "Merge branch 'master' of github.com:shapeblue/cloudstack into FR44_master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "565ed58a9c91f8826f3cc26365450bc8c04f2e60", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/565ed58a9c91f8826f3cc26365450bc8c04f2e60", "committedDate": "2020-06-17T03:16:46Z", "message": "Merge branch 'null-pointer-on-xen-instance' of github.com:shapeblue/cloudstack into 44_test_4004"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b7ce2741a463b453538fb3ee2166801ba6ad068", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/7b7ce2741a463b453538fb3ee2166801ba6ad068", "committedDate": "2020-06-19T07:34:41Z", "message": "refactored code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f121f3c9b5f4d0fee2855caf1a458a737d6a91b", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/9f121f3c9b5f4d0fee2855caf1a458a737d6a91b", "committedDate": "2020-06-19T07:47:33Z", "message": "Merge branch 'master' of github.com:shapeblue/cloudstack into 44_test_4004"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56a3d8c1fced61c430862d0280021d03e473edaf", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/56a3d8c1fced61c430862d0280021d03e473edaf", "committedDate": "2020-06-23T07:09:05Z", "message": "Merge branch 'master' of github.com:shapeblue/cloudstack into FR44_master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66ad63f23b6a9a39c887c28fb7d224e825fc8e94", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/66ad63f23b6a9a39c887c28fb7d224e825fc8e94", "committedDate": "2020-06-23T16:32:58Z", "message": "addressed conflicts/ discrepency due to xenserver bug fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "baf46648e7031b0a1dd3e756be14b7f521c1f2ed", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/baf46648e7031b0a1dd3e756be14b7f521c1f2ed", "committedDate": "2020-06-23T07:10:05Z", "message": "addressed conflicts/ discrepency due to xenserver bug fix"}, "afterCommit": {"oid": "66ad63f23b6a9a39c887c28fb7d224e825fc8e94", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/66ad63f23b6a9a39c887c28fb7d224e825fc8e94", "committedDate": "2020-06-23T16:32:58Z", "message": "addressed conflicts/ discrepency due to xenserver bug fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MDQ2NDMy", "url": "https://github.com/apache/cloudstack/pull/3976#pullrequestreview-439046432", "createdAt": "2020-06-29T11:30:16Z", "commit": {"oid": "66ad63f23b6a9a39c887c28fb7d224e825fc8e94"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d616ddd7bac2e0fefa2fd93ef97c1a7e57af053", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/1d616ddd7bac2e0fefa2fd93ef97c1a7e57af053", "committedDate": "2020-06-29T19:29:50Z", "message": "Merge branch 'master' of github.com:shapeblue/cloudstack into FR44_master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ec609a5334adc597ac0973cc1b4ef7985e58345", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/7ec609a5334adc597ac0973cc1b4ef7985e58345", "committedDate": "2020-06-29T19:38:53Z", "message": "Merge remote-tracking branch 'upstream/master' into FR44_master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNzAxMzA1", "url": "https://github.com/apache/cloudstack/pull/3976#pullrequestreview-440701305", "createdAt": "2020-07-01T09:28:41Z", "commit": {"oid": "7ec609a5334adc597ac0973cc1b4ef7985e58345"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwOToyODo0MVrOGreO6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwOToyODo0MVrOGreO6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIzNzI5MQ==", "bodyText": "this part aims to fix another issue, right ?", "url": "https://github.com/apache/cloudstack/pull/3976#discussion_r448237291", "createdAt": "2020-07-01T09:28:41Z", "author": {"login": "weizhouapache"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtMigrateCommandWrapper.java", "diffHunk": "@@ -141,6 +146,12 @@ Use VIR_DOMAIN_XML_SECURE (value = 1) prior to v1.0.0.\n             xmlDesc = dm.getXMLDesc(xmlFlag);\n             xmlDesc = replaceIpForVNCInDescFile(xmlDesc, target);\n \n+            String oldIsoVolumePath = getOldVolumePath(disks, vmName);\n+            String newIsoVolumePath = getNewVolumePathIfDatastoreHasChanged(libvirtComputingResource, conn, to);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ec609a5334adc597ac0973cc1b4ef7985e58345"}, "originalPosition": 45}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4492, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}