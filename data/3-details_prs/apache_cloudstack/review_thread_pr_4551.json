{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyMzA5MTIy", "number": 4551, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMDoxMDo0MFrOFHHtJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0wNlQwNjo0NDo1MlrOFuYJDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzMDEwNTk5OnYy", "diffSide": "RIGHT", "path": "engine/storage/src/main/java/org/apache/cloudstack/storage/image/db/VolumeDataStoreDaoImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMDoxMDo0MFrOIIc0DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMDoxMDo0MFrOIIc0DA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTczMTU5Ng==", "bodyText": "it looks same as storeVolumeSearch", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r545731596", "createdAt": "2020-12-18T10:10:40Z", "author": {"login": "weizhouapache"}, "path": "engine/storage/src/main/java/org/apache/cloudstack/storage/image/db/VolumeDataStoreDaoImpl.java", "diffHunk": "@@ -120,6 +120,11 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n         uploadVolumeStateSearch.and(\"destroyed\", uploadVolumeStateSearch.entity().getDestroyed(), SearchCriteria.Op.EQ);\n         uploadVolumeStateSearch.done();\n \n+        allVolumesSearch = this.createSearchBuilder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ded3a248f2609e774eedb510b541aeee790b393"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzgxNzExNjk2OnYy", "diffSide": "RIGHT", "path": "engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/AncientDataMotionStrategy.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0zMFQwOTo1NzowM1rOI_-c4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0wNVQxMTowMDoyNlrOJC6cMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzk1NDQwMQ==", "bodyText": "is not null enough? what if it is an object but doesn't exist? or it does but not on imageStore?", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r603954401", "createdAt": "2021-03-30T09:57:03Z", "author": {"login": "DaanHoogland"}, "path": "engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/AncientDataMotionStrategy.java", "diffHunk": "@@ -392,15 +405,16 @@ protected Answer copyVolumeBetweenPools(DataObject srcData, DataObject destData)\n                     return answer;\n                 }\n             } catch (Exception e) {\n-                if (imageStore.exists(objOnImageStore)) {\n+                if (objOnImageStore != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717a849e277da2ba749db1bc94cc04b6eb79395e"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDYxNTgzMA==", "bodyText": "imagestore.exists() eventually calls volumeDataStoreDao.findByStoreVolume(...) for volumes, which in case of multiple entries could possibly return the wrong record", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r604615830", "createdAt": "2021-03-31T06:02:24Z", "author": {"login": "Pearl1594"}, "path": "engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/AncientDataMotionStrategy.java", "diffHunk": "@@ -392,15 +405,16 @@ protected Answer copyVolumeBetweenPools(DataObject srcData, DataObject destData)\n                     return answer;\n                 }\n             } catch (Exception e) {\n-                if (imageStore.exists(objOnImageStore)) {\n+                if (objOnImageStore != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzk1NDQwMQ=="}, "originalCommit": {"oid": "717a849e277da2ba749db1bc94cc04b6eb79395e"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjIwMTA0Nw==", "bodyText": "ok, but still, the objOnImageStore may be a valid object that represents nothing on our imageStore, can it? shouldn't we protect against that as well?", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r606201047", "createdAt": "2021-04-02T11:45:05Z", "author": {"login": "DaanHoogland"}, "path": "engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/AncientDataMotionStrategy.java", "diffHunk": "@@ -392,15 +405,16 @@ protected Answer copyVolumeBetweenPools(DataObject srcData, DataObject destData)\n                     return answer;\n                 }\n             } catch (Exception e) {\n-                if (imageStore.exists(objOnImageStore)) {\n+                if (objOnImageStore != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzk1NDQwMQ=="}, "originalCommit": {"oid": "717a849e277da2ba749db1bc94cc04b6eb79395e"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjk5NjE4OQ==", "bodyText": "@DaanHoogland I didn't quite understand your previous comment. Could you please explain what you mean by it. Thanks", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r606996189", "createdAt": "2021-04-05T09:09:40Z", "author": {"login": "Pearl1594"}, "path": "engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/AncientDataMotionStrategy.java", "diffHunk": "@@ -392,15 +405,16 @@ protected Answer copyVolumeBetweenPools(DataObject srcData, DataObject destData)\n                     return answer;\n                 }\n             } catch (Exception e) {\n-                if (imageStore.exists(objOnImageStore)) {\n+                if (objOnImageStore != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzk1NDQwMQ=="}, "originalCommit": {"oid": "717a849e277da2ba749db1bc94cc04b6eb79395e"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzAzNDQxNg==", "bodyText": "@Pearl1594 what you are saying might be true but during catch() we have to check if DB entry really exists or not and process the image storage object by marking it OperationFailed. objOnImageStore will always be != null (\"DataObject objOnImageStore = imageStore.create(srcData);\") since no where in try{} block we are setting to null or changing the object.\n@DaanHoogland in that method we are dealing only with database entries. If you are asking if it represents nothing on imagestore \"physically\" then the answer is we don't need to be concerned about that.", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r607034416", "createdAt": "2021-04-05T11:00:26Z", "author": {"login": "harikrishna-patnala"}, "path": "engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/AncientDataMotionStrategy.java", "diffHunk": "@@ -392,15 +405,16 @@ protected Answer copyVolumeBetweenPools(DataObject srcData, DataObject destData)\n                     return answer;\n                 }\n             } catch (Exception e) {\n-                if (imageStore.exists(objOnImageStore)) {\n+                if (objOnImageStore != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzk1NDQwMQ=="}, "originalCommit": {"oid": "717a849e277da2ba749db1bc94cc04b6eb79395e"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzg0MTc0MzQ4OnYy", "diffSide": "RIGHT", "path": "engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/AncientDataMotionStrategy.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0wNlQwNjo0NDo1MlrOJDa17g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yOVQxMzowNzo1MVrOJ1_vWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzU2NTI5NA==", "bodyText": "if any volumes on store at this point, have to remove  them. check if you have to call deleteVolumeOnSecondaryStore() in this case as well", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r607565294", "createdAt": "2021-04-06T06:44:52Z", "author": {"login": "sureshanaparti"}, "path": "engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/AncientDataMotionStrategy.java", "diffHunk": "@@ -392,15 +405,16 @@ protected Answer copyVolumeBetweenPools(DataObject srcData, DataObject destData)\n                     return answer;\n                 }\n             } catch (Exception e) {\n-                if (imageStore.exists(objOnImageStore)) {\n+                if (objOnImageStore != null) {\n                     objOnImageStore.processEvent(Event.OperationFailed);\n                     imageStore.delete(objOnImageStore);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717a849e277da2ba749db1bc94cc04b6eb79395e"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzgxODEzNg==", "bodyText": "@Pearl1594 can you reply ^^", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r613818136", "createdAt": "2021-04-15T07:22:07Z", "author": {"login": "rhtyd"}, "path": "engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/AncientDataMotionStrategy.java", "diffHunk": "@@ -392,15 +405,16 @@ protected Answer copyVolumeBetweenPools(DataObject srcData, DataObject destData)\n                     return answer;\n                 }\n             } catch (Exception e) {\n-                if (imageStore.exists(objOnImageStore)) {\n+                if (objOnImageStore != null) {\n                     objOnImageStore.processEvent(Event.OperationFailed);\n                     imageStore.delete(objOnImageStore);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzU2NTI5NA=="}, "originalCommit": {"oid": "717a849e277da2ba749db1bc94cc04b6eb79395e"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzgxOTA1Mg==", "bodyText": "It makes sense to delete the volume on secondary store on failure. Will add that - needs testing.", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r613819052", "createdAt": "2021-04-15T07:23:34Z", "author": {"login": "Pearl1594"}, "path": "engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/AncientDataMotionStrategy.java", "diffHunk": "@@ -392,15 +405,16 @@ protected Answer copyVolumeBetweenPools(DataObject srcData, DataObject destData)\n                     return answer;\n                 }\n             } catch (Exception e) {\n-                if (imageStore.exists(objOnImageStore)) {\n+                if (objOnImageStore != null) {\n                     objOnImageStore.processEvent(Event.OperationFailed);\n                     imageStore.delete(objOnImageStore);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzU2NTI5NA=="}, "originalCommit": {"oid": "717a849e277da2ba749db1bc94cc04b6eb79395e"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDU2ODYwMg==", "bodyText": "@Pearl1594 any update on the changes / testing ?", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r660568602", "createdAt": "2021-06-29T12:30:59Z", "author": {"login": "sureshanaparti"}, "path": "engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/AncientDataMotionStrategy.java", "diffHunk": "@@ -392,15 +405,16 @@ protected Answer copyVolumeBetweenPools(DataObject srcData, DataObject destData)\n                     return answer;\n                 }\n             } catch (Exception e) {\n-                if (imageStore.exists(objOnImageStore)) {\n+                if (objOnImageStore != null) {\n                     objOnImageStore.processEvent(Event.OperationFailed);\n                     imageStore.delete(objOnImageStore);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzU2NTI5NA=="}, "originalCommit": {"oid": "717a849e277da2ba749db1bc94cc04b6eb79395e"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDU5ODYxNg==", "bodyText": "Haven't had the chance to get to testing this yet @sureshanaparti  - Will do it by end of this week.", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r660598616", "createdAt": "2021-06-29T13:07:51Z", "author": {"login": "Pearl1594"}, "path": "engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/AncientDataMotionStrategy.java", "diffHunk": "@@ -392,15 +405,16 @@ protected Answer copyVolumeBetweenPools(DataObject srcData, DataObject destData)\n                     return answer;\n                 }\n             } catch (Exception e) {\n-                if (imageStore.exists(objOnImageStore)) {\n+                if (objOnImageStore != null) {\n                     objOnImageStore.processEvent(Event.OperationFailed);\n                     imageStore.delete(objOnImageStore);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzU2NTI5NA=="}, "originalCommit": {"oid": "717a849e277da2ba749db1bc94cc04b6eb79395e"}, "originalPosition": 61}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4037, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}