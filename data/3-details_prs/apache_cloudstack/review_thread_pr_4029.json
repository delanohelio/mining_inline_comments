{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzMzYxMDU2", "number": 4029, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMDoxOTowMlrODyb57A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMDoxOTowMlrODyb57A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0MjEyNTg4OnYy", "diffSide": "RIGHT", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/KVMStorageProcessor.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMDoxOTowMlrOGGejqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMTo1MDozMlrOGGhkQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ0NTI5MA==", "bodyText": "same comment as in #4033: first we suspend unconditionaly, and than, we just assume it need resuming without checking if it was running in the first place. Are there situations we should guard against more diligently? (cc @weizhouapache @rhtyd )", "url": "https://github.com/apache/cloudstack/pull/4029#discussion_r409445290", "createdAt": "2020-04-16T10:19:02Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/KVMStorageProcessor.java", "diffHunk": "@@ -1005,6 +1005,13 @@ public Answer backupSnapshot(final CopyCommand cmd) {\n                             primaryStore.getUuid());\n                     if (state == DomainInfo.DomainState.VIR_DOMAIN_RUNNING && !primaryStorage.isExternalSnapshot()) {\n                         final DomainSnapshot snap = vm.snapshotLookupByName(snapshotName);\n+                        try {\n+                            s_logger.info(String.format(\"Suspending VM '%s' to delete snapshot,\", vm.getName()));\n+                            vm.suspend();\n+                        } catch (final LibvirtException e) {\n+                            s_logger.error(\"Failed to suspend the VM\", e);\n+                            throw e;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f5e51133967bae750f089e53f7c78fa85d8a396"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5MDE2NQ==", "bodyText": "@DaanHoogland I see on line 1007, we are checking that domain is running? Did I miss anything?", "url": "https://github.com/apache/cloudstack/pull/4029#discussion_r409490165", "createdAt": "2020-04-16T11:42:07Z", "author": {"login": "rhtyd"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/KVMStorageProcessor.java", "diffHunk": "@@ -1005,6 +1005,13 @@ public Answer backupSnapshot(final CopyCommand cmd) {\n                             primaryStore.getUuid());\n                     if (state == DomainInfo.DomainState.VIR_DOMAIN_RUNNING && !primaryStorage.isExternalSnapshot()) {\n                         final DomainSnapshot snap = vm.snapshotLookupByName(snapshotName);\n+                        try {\n+                            s_logger.info(String.format(\"Suspending VM '%s' to delete snapshot,\", vm.getName()));\n+                            vm.suspend();\n+                        } catch (final LibvirtException e) {\n+                            s_logger.error(\"Failed to suspend the VM\", e);\n+                            throw e;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ0NTI5MA=="}, "originalCommit": {"oid": "0f5e51133967bae750f089e53f7c78fa85d8a396"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5NDU5Mw==", "bodyText": "yes, we are, i am confusing PRs. this one actually doesn't do anything in the delete vmshapshot scenario.", "url": "https://github.com/apache/cloudstack/pull/4029#discussion_r409494593", "createdAt": "2020-04-16T11:50:32Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/KVMStorageProcessor.java", "diffHunk": "@@ -1005,6 +1005,13 @@ public Answer backupSnapshot(final CopyCommand cmd) {\n                             primaryStore.getUuid());\n                     if (state == DomainInfo.DomainState.VIR_DOMAIN_RUNNING && !primaryStorage.isExternalSnapshot()) {\n                         final DomainSnapshot snap = vm.snapshotLookupByName(snapshotName);\n+                        try {\n+                            s_logger.info(String.format(\"Suspending VM '%s' to delete snapshot,\", vm.getName()));\n+                            vm.suspend();\n+                        } catch (final LibvirtException e) {\n+                            s_logger.error(\"Failed to suspend the VM\", e);\n+                            throw e;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ0NTI5MA=="}, "originalCommit": {"oid": "0f5e51133967bae750f089e53f7c78fa85d8a396"}, "originalPosition": 9}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3860, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}