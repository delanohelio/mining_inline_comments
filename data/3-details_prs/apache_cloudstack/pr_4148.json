{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1MDQ4NjE3", "number": 4148, "title": "server: Do not resize volume of running vm on KVM host if host is not Up or not Enabled", "bodyText": "Description\n\n\n\n\n\n\nIf we resize a volume of a vm running on a host which is not Up or not Enable, the job will be scheduled to another normal host. Then the volume will be resized by \"qemu-img resize\" instead of \"virsh blockresize\", the image might be corrupted after resize.\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?", "createdAt": "2020-06-16T08:12:27Z", "url": "https://github.com/apache/cloudstack/pull/4148", "merged": true, "mergeCommit": {"oid": "5526342f4ab7fe712ec272a89c7a962161889da6"}, "closed": true, "closedAt": "2020-06-25T05:10:32Z", "author": {"login": "ustcweizhou"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrwgspgH2gAyNDM1MDQ4NjE3OmE1NWJhMmI4ZTMwNDdhMTg4OGFiN2ViMzc3NjFlNjcwNTAxMzZhNGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcunjmjgFqTQzNzE3MjMyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a55ba2b8e3047a1888ab7eb37761e67050136a4c", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/a55ba2b8e3047a1888ab7eb37761e67050136a4c", "committedDate": "2020-06-16T07:55:59Z", "message": "server: Do not resize volume of running vm on KVM host if host is not Up or not Enabled"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMDEzNjgx", "url": "https://github.com/apache/cloudstack/pull/4148#pullrequestreview-432013681", "createdAt": "2020-06-17T02:21:50Z", "commit": {"oid": "a55ba2b8e3047a1888ab7eb37761e67050136a4c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMDEzOTAy", "url": "https://github.com/apache/cloudstack/pull/4148#pullrequestreview-432013902", "createdAt": "2020-06-17T02:22:30Z", "commit": {"oid": "a55ba2b8e3047a1888ab7eb37761e67050136a4c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwMjoyMjozMFrOGkzW7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwMjoyMjozMFrOGkzW7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI0MzM3NQ==", "bodyText": "@ustcweizhou should you do a null check, what if the host was removed?", "url": "https://github.com/apache/cloudstack/pull/4148#discussion_r441243375", "createdAt": "2020-06-17T02:22:30Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/com/cloud/storage/VolumeApiServiceImpl.java", "diffHunk": "@@ -1187,6 +1189,16 @@ private VolumeVO orchestrateResizeVolume(long volumeId, long currentSize, long n\n             if (currentSize != newSize && _volsDao.getHypervisorType(volume.getId()) == HypervisorType.XenServer && !userVm.getState().equals(State.Stopped)) {\n                 throw new InvalidParameterValueException(errorMsg);\n             }\n+\n+            /* Do not resize volume of running vm on KVM host if host is not Up or not Enabled */\n+            if (currentSize != newSize && userVm.getState() == State.Running && userVm.getHypervisorType() == HypervisorType.KVM) {\n+                HostVO host = _hostDao.findById(userVm.getHostId());\n+                if (host.getStatus() != Status.Up) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a55ba2b8e3047a1888ab7eb37761e67050136a4c"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5309aa008dfb0ce24202592251495cb345b92c9", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/f5309aa008dfb0ce24202592251495cb345b92c9", "committedDate": "2020-06-19T19:02:08Z", "message": "add null check for PR 4148"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MjkyMDMz", "url": "https://github.com/apache/cloudstack/pull/4148#pullrequestreview-436292033", "createdAt": "2020-06-24T03:01:01Z", "commit": {"oid": "f5309aa008dfb0ce24202592251495cb345b92c9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MTcyMzIx", "url": "https://github.com/apache/cloudstack/pull/4148#pullrequestreview-437172321", "createdAt": "2020-06-25T05:11:48Z", "commit": {"oid": "f5309aa008dfb0ce24202592251495cb345b92c9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3861, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}