{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1ODY4NzAy", "number": 4529, "title": "vr: Ensuring dnsmasq.leases file is populated", "bodyText": "Description\nFixes #3788\nWhen a VR is deleted and a new one brought up it populates the dhcphosts.txt with all hosts in the network, but the dnsmasq.leases file is blank which can cause issues if VMs try to renew their lease.\nThis PR also adds an entry in the dnsmasq.leases file for each host when the dhcphosts.txt file is populated\nAn existing lease when a VM tries to acquire a new one doesn't seem to cause any issues\nTypes of changes\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nHow Has This Been Tested?\n\nCreate a network with a couple of VMs on them\nRestart the network with cleanup\nWait for the new router to come up\nCat /var/log/dnsmasq.log to verify that no DHCP request has been made\nCheck out /var/lib/misc/dnsmasq.leases\n\n/var/log/dnsmasq.log - No DHCP requests received\nroot@r-8-VM:~# cat /var/log/dnsmasq.log\nDec 10 13:01:44 dnsmasq[928]: started, version 2.80 cachesize 150\nDec 10 13:01:44 dnsmasq[928]: compile time options: IPv6 GNU-getopt DBus i18n IDN DHCP DHCPv6 no-Lua TFTP conntrack ipset auth DNSSEC loop-detect inotify dumpfile\nDec 10 13:01:44 dnsmasq-dhcp[928]: DHCP, static leases only on 10.1.1.1, lease time 1h\nDec 10 13:01:44 dnsmasq-tftp[928]: TFTP root is /opt/tftpboot \nDec 10 13:01:44 dnsmasq[928]: using local addresses only for domain cs2cloud.internal\nDec 10 13:01:44 dnsmasq[928]: reading /etc/dnsmasq-resolv.conf\nDec 10 13:01:44 dnsmasq[928]: using local addresses only for domain cs2cloud.internal\nDec 10 13:01:44 dnsmasq[928]: using nameserver 10.2.0.50#53\nDec 10 13:01:44 dnsmasq[928]: using nameserver 8.8.8.8#53\nDec 10 13:01:44 dnsmasq[928]: read /etc/hosts - 6 addresses\nDec 10 13:01:44 dnsmasq[928]: cannot read /etc/dhcphosts.txt: No such file or directory\nDec 10 13:01:44 dnsmasq-dhcp[928]: read /etc/dhcpopts.txt\nDec 10 13:01:44 dnsmasq[928]: read /etc/hosts - 6 addresses\nDec 10 13:01:44 dnsmasq[928]: cannot read /etc/dhcphosts.txt: No such file or directory\nDec 10 13:01:44 dnsmasq-dhcp[928]: read /etc/dhcpopts.txt\nDec 10 13:01:50 dnsmasq[928]: exiting on receipt of SIGTERM\nDec 10 13:01:50 dnsmasq[1841]: started, version 2.80 cachesize 150\nDec 10 13:01:50 dnsmasq[1841]: compile time options: IPv6 GNU-getopt DBus i18n IDN DHCP DHCPv6 no-Lua TFTP conntrack ipset auth DNSSEC loop-detect inotify dumpfile\nDec 10 13:01:50 dnsmasq-dhcp[1841]: DHCP, static leases only on 10.1.1.1, lease time 1h\nDec 10 13:01:50 dnsmasq-dhcp[1841]: DHCP, static leases only on 10.1.1.1, lease time 1h\nDec 10 13:01:50 dnsmasq-tftp[1841]: TFTP root is /opt/tftpboot \nDec 10 13:01:50 dnsmasq[1841]: using local addresses only for domain cs2cloud.internal\nDec 10 13:01:50 dnsmasq[1841]: reading /etc/dnsmasq-resolv.conf\nDec 10 13:01:50 dnsmasq[1841]: using local addresses only for domain cs2cloud.internal\nDec 10 13:01:50 dnsmasq[1841]: using nameserver 10.2.0.50#53\nDec 10 13:01:50 dnsmasq[1841]: using nameserver 8.8.8.8#53\nDec 10 13:01:50 dnsmasq[1841]: read /etc/hosts - 8 addresses\nDec 10 13:01:50 dnsmasq-dhcp[1841]: read /etc/dhcphosts.txt\nDec 10 13:01:50 dnsmasq-dhcp[1841]: read /etc/dhcpopts.txt\nDec 10 13:01:56 dnsmasq[1841]: read /etc/hosts - 8 addresses\nDec 10 13:01:56 dnsmasq-dhcp[1841]: read /etc/dhcphosts.txt\nDec 10 13:01:56 dnsmasq-dhcp[1841]: read /etc/dhcpopts.txt\n\n/var/lib/misc/dnsmasq.leases - They exist \u2728\nroot@r-8-VM:~# cat /var/lib/misc/dnsmasq.leases \n0 02:00:62:58:00:04 10.1.1.52 vm-2 *\n0 02:00:50:85:00:01 10.1.1.224 VM-1 *\n\nBEFORE :\nLogs when rebooting a VM after network restart with cleanup\nDec 10 13:12:45 dnsmasq[2240]: read /etc/hosts - 9 addresses\nDec 10 13:12:45 dnsmasq-dhcp[2240]: read /etc/dhcphosts.txt\nDec 10 13:12:45 dnsmasq-dhcp[2240]: read /etc/dhcpopts.txt\n\nDec 10 13:13:48 dnsmasq-dhcp[2240]: DHCPDISCOVER(eth0) 10.1.1.24 02:00:24:5c:00:03 \nDec 10 13:13:48 dnsmasq-dhcp[2240]: DHCPOFFER(eth0) 10.1.1.24 02:00:24:5c:00:03 \nDec 10 13:13:48 dnsmasq-dhcp[2240]: DHCPREQUEST(eth0) 10.1.1.24 02:00:24:5c:00:03 \nDec 10 13:13:48 dnsmasq-dhcp[2240]: DHCPACK(eth0) 10.1.1.24 02:00:24:5c:00:03 VM-2\n\n\nAFTER :\nLogs when rebooting a VM after network restart with cleanup\nDec 10 13:06:19 dnsmasq[1841]: read /etc/hosts - 8 addresses\nDec 10 13:06:19 dnsmasq-dhcp[1841]: read /etc/dhcphosts.txt\nDec 10 13:06:19 dnsmasq-dhcp[1841]: read /etc/dhcpopts.txt\n\nDec 10 13:07:03 dnsmasq-dhcp[1841]: DHCPREQUEST(eth0) 10.1.1.52 02:00:62:58:00:04 \nDec 10 13:07:03 dnsmasq-dhcp[1841]: DHCPACK(eth0) 10.1.1.52 02:00:62:58:00:04 vm-2", "createdAt": "2020-12-10T11:30:55Z", "url": "https://github.com/apache/cloudstack/pull/4529", "merged": true, "mergeCommit": {"oid": "4d33e159f7d810a7532acc10ecaa4f0e29af5fbe"}, "closed": true, "closedAt": "2020-12-14T09:06:25Z", "author": {"login": "davidjumani"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdk_3-WABqjQwOTgzNTY4NDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdlEo94AFqTU0OTkzODMwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4f61604fa6d8df84325d79017b157bfe8aa084dc", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/4f61604fa6d8df84325d79017b157bfe8aa084dc", "committedDate": "2020-12-10T17:41:15Z", "message": "Fix pylint issues"}, "afterCommit": {"oid": "1ac4c78a4233688545e9760c67df861243eb5cc3", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/1ac4c78a4233688545e9760c67df861243eb5cc3", "committedDate": "2020-12-11T04:03:27Z", "message": "Fix pylint issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5OTAwOTQw", "url": "https://github.com/apache/cloudstack/pull/4529#pullrequestreview-549900940", "createdAt": "2020-12-11T08:45:20Z", "commit": {"oid": "1ac4c78a4233688545e9760c67df861243eb5cc3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5OTAxMzU3", "url": "https://github.com/apache/cloudstack/pull/4529#pullrequestreview-549901357", "createdAt": "2020-12-11T08:45:56Z", "commit": {"oid": "1ac4c78a4233688545e9760c67df861243eb5cc3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwODo0NTo1NlrOIDuuvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwODo0NTo1NlrOIDuuvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc4MjI3MQ==", "bodyText": "same as above - can you check if the lease should have a high expiry (80yrs or inf?) instead of *, I'm not sure what 0 and * mean here", "url": "https://github.com/apache/cloudstack/pull/4529#discussion_r540782271", "createdAt": "2020-12-11T08:45:56Z", "author": {"login": "rhtyd"}, "path": "systemvm/debian/opt/cloud/bin/cs/CsDhcp.py", "diffHunk": "@@ -196,6 +203,9 @@ def add(self, entry):\n             self.dhcp_opts.add(\"%s,%s\" % (tag, 3))\n             self.dhcp_opts.add(\"%s,%s\" % (tag, 6))\n             self.dhcp_opts.add(\"%s,%s\" % (tag, 15))\n+            self.dhcp_leases.search(entry['mac_address'], \"0 %s %s %s *\" % (entry['mac_address'],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ac4c78a4233688545e9760c67df861243eb5cc3"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5OTI4MTgz", "url": "https://github.com/apache/cloudstack/pull/4529#pullrequestreview-549928183", "createdAt": "2020-12-11T09:23:18Z", "commit": {"oid": "1ac4c78a4233688545e9760c67df861243eb5cc3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a19faf9eaf606d8a177d490aa224ebe5c8c7448a", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/a19faf9eaf606d8a177d490aa224ebe5c8c7448a", "committedDate": "2020-12-11T09:29:07Z", "message": "vr: Ensuring dnsmasq.leases file is populated"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f1a4446c340f150d4f8ebb02e671aafd97a670a", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/3f1a4446c340f150d4f8ebb02e671aafd97a670a", "committedDate": "2020-12-11T09:29:07Z", "message": "Fix pylint issues"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1ac4c78a4233688545e9760c67df861243eb5cc3", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/1ac4c78a4233688545e9760c67df861243eb5cc3", "committedDate": "2020-12-11T04:03:27Z", "message": "Fix pylint issues"}, "afterCommit": {"oid": "3f1a4446c340f150d4f8ebb02e671aafd97a670a", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/3f1a4446c340f150d4f8ebb02e671aafd97a670a", "committedDate": "2020-12-11T09:29:07Z", "message": "Fix pylint issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5OTM4MzA2", "url": "https://github.com/apache/cloudstack/pull/4529#pullrequestreview-549938306", "createdAt": "2020-12-11T09:36:43Z", "commit": {"oid": "3f1a4446c340f150d4f8ebb02e671aafd97a670a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwOTozNjo0M1rOIDwpNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwOTozNjo0M1rOIDwpNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgxMzYyMg==", "bodyText": "@rhtyd @davidjumani\nthe only issue I see is, dnsmasq will be restarted each time when conf/host/dhcp lease is changed.\nif there are many vms in the network, might it be a problem ?\nit is not caused by this pr , but the line above\n        if self.cloud.commit():\n            restart_dnsmasq = True\n\nmight it be better to restart dnsmasq when all are processed ?", "url": "https://github.com/apache/cloudstack/pull/4529#discussion_r540813622", "createdAt": "2020-12-11T09:36:43Z", "author": {"login": "weizhouapache"}, "path": "systemvm/debian/opt/cloud/bin/cs/CsDhcp.py", "diffHunk": "@@ -60,6 +61,9 @@ def process(self):\n         if self.cloud.commit():\n             restart_dnsmasq = True\n \n+        if self.dhcp_leases.commit():\n+            restart_dnsmasq = True", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f1a4446c340f150d4f8ebb02e671aafd97a670a"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4609, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}