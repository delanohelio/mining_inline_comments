{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyMDM3NTU2", "number": 4341, "title": "Allow to configure root disk size via Service Offering (diskoffering of type Service).", "bodyText": "Description\nService Offering allows ADMINs to set multiple parameters such as IOPS, memory, and CPU; however, we still are not able to configure the Root Disk size of a VM via service Offering.\nThis PR adds control over the Root disk size and therefore helps providers that want to enforce the root disk size in the same way that it is done with compute offering.\nHow does it work?\n\nIf the Service Offering is created without setting root disk size, all operations over root volume size are done as currently.\nIf a Service Offering is created with a root disk size, then there are some (intentionally) limitations under the root disk size resizing, as the following ones:\n\n1. Users cannot deploy VMs with custom root disk size when using such offerings\n2. Users cannot resize the VM root disk size when using such offerings\n3. the Root Volume of such VMs can only be resized when changing to another Service Offering with a Root disk size equals or larger than the current one.\n4. Users can change the VM offering to a service offering with a Root size of 0GB (default), and then customize the volume size.\n\nTo easily view all possible service offering resizing, the following table shows if such offering migration is supported:\n\n\n\n#\nService Offering Root size\nnew Service Offering Root\nDoes support offering resize?\n\n\n\n\n1\n0GB (default)\nAny\nYES\n\n\n2\n5GB\n5GB\nYES\n\n\n3\n5GB\n10GB\nYES\n\n\n4\n10GB\n5GB\nNO\n\n\n5\nAny\n0GB\nYES\n\n\n\nHow users can resize the root volume if the VM was deployed with a Root disk size configured via its Service offering?\n\nUsers/Admins can at any time change to an offering with the default root disk size of 0; on such case, then it would be possible to resize as it is done nowadays.\n\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nSetting root disk size for service offering via UI\n\nHow Has This Been Tested?\nTests:\nCreated the following service offerings (via API and also via UI):\n\n0GB - default behavior with no Root Disk Size  configured\n5GB - 5GB Root\n10GB - 10GB Root\n15GB - 15GB Root\n\nExecuted following tests\n1. Test root volume resize.\nExpected result: not allowed to resize\nSteps:\na - deploy a VM with any of the root size configured offerings (e.g. 5GB)\nb - Change root volume size\nc - not allowed\n2. Test resize via service offering.\nExpected result: allow 5GB -> 10GB, and 10 GB -> 15, fail to \"dowsize\" from 10GB -> 5GB\nSteps:\na - deploy VM with offering 5GB\nb - Stop VM\nc - Change Service offering to 10GB\nd - Change offering back to 5GB, fails (as expected)\ne - Change offering to 15GB\n3. Test resize via offering to a Service offering with the default root size (0 GB) and then customize the volume\nExpected result: allow 5GB -> 0GB, successfully change the root volume to a custom size\nSteps:\na - deploy VM with offering 5GB\nb - Stop VM\nc - Change Service offering to 0GB\nd - resize volume to custom size, e.g 50 GB", "createdAt": "2020-09-23T21:00:04Z", "url": "https://github.com/apache/cloudstack/pull/4341", "merged": true, "mergeCommit": {"oid": "b3a1cb41c81bec1ee661a87741451a54daa83509"}, "closed": true, "closedAt": "2020-10-30T15:56:12Z", "author": {"login": "GabrielBrascher"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdU-KVDgFqTUxNDQ3MjYyMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXm6yjAFqTUyMDY3NDY1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0NDcyNjIy", "url": "https://github.com/apache/cloudstack/pull/4341#pullrequestreview-514472622", "createdAt": "2020-10-22T08:19:40Z", "commit": {"oid": "4f501f0624a44fe2414835f17f210bf977f08846"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwODoxOTo0MFrOHmWClQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwODo1OTozNlrOHmXsxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk2OTA0NQ==", "bodyText": "Do we need since parameter here?", "url": "https://github.com/apache/cloudstack/pull/4341#discussion_r509969045", "createdAt": "2020-10-22T08:19:40Z", "author": {"login": "ravening"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/offering/CreateServiceOfferingCmd.java", "diffHunk": "@@ -126,6 +126,9 @@\n     @Parameter(name = ApiConstants.SERVICE_OFFERING_DETAILS, type = CommandType.MAP, description = \"details for planner, used to store specific parameters\")\n     private Map details;\n \n+    @Parameter(name = ApiConstants.ROOT_DISK_SIZE, type = CommandType.LONG, required = false, description = \"the Root disk size in GB.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f501f0624a44fe2414835f17f210bf977f08846"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk3MTY2NQ==", "bodyText": "An optimization suggestion here. You can write below one liner since rootDiskSizeInBytes is not used anywhere else\noffering.setDiskSize(rootDiskSizeInGiB * GiB_TO_BYTES)", "url": "https://github.com/apache/cloudstack/pull/4341#discussion_r509971665", "createdAt": "2020-10-22T08:23:22Z", "author": {"login": "ravening"}, "path": "server/src/main/java/com/cloud/configuration/ConfigurationManagerImpl.java", "diffHunk": "@@ -2518,6 +2520,12 @@ protected ServiceOfferingVO createServiceOffering(final long userId, final boole\n             }\n         }\n \n+        if (rootDiskSizeInGiB != null && rootDiskSizeInGiB <= 0L) {\n+            throw new InvalidParameterValueException(String.format(\"The Root disk size is of %s GB but it must be greater than 0.\", rootDiskSizeInGiB));\n+        } else if (rootDiskSizeInGiB != null) {\n+            long rootDiskSizeInBytes = rootDiskSizeInGiB * GiB_TO_BYTES;\n+            offering.setDiskSize(rootDiskSizeInBytes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f501f0624a44fe2414835f17f210bf977f08846"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk5NjIzMA==", "bodyText": "Any specific reason why we are not allowing resizing when vm is running?", "url": "https://github.com/apache/cloudstack/pull/4341#discussion_r509996230", "createdAt": "2020-10-22T08:59:36Z", "author": {"login": "ravening"}, "path": "server/src/main/java/com/cloud/storage/VolumeApiServiceImpl.java", "diffHunk": "@@ -1139,6 +1143,13 @@ public VolumeVO resizeVolume(ResizeVolumeCmd cmd) throws ResourceAllocationExcep\n                 shrinkOk);\n     }\n \n+    private void checkIfVolumeIsRootAndVmIsRunning(Long newSize, VolumeVO volume, VMInstanceVO vmInstanceVO) {\n+        if (!volume.getSize().equals(newSize) && volume.getVolumeType().equals(Volume.Type.ROOT) && !State.Stopped.equals(vmInstanceVO.getState())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f501f0624a44fe2414835f17f210bf977f08846"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f6f7f024bec236a7229783a4d60dc8afa3b26d7", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/4f6f7f024bec236a7229783a4d60dc8afa3b26d7", "committedDate": "2020-10-29T10:31:27Z", "message": "Allow to resize root size via diskoffering of type service.\n\nService Offering can then have a root disk size configured. On such a case the Root Volume can only be resized when changing to another Service Offering with a Root disk size equals or larger than the current one."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3324b0cd8b50ff844a93971d2e545301b087be37", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/3324b0cd8b50ff844a93971d2e545301b087be37", "committedDate": "2020-10-27T03:50:33Z", "message": "Add since 4.15 on rootDiskSize parameter"}, "afterCommit": {"oid": "4f6f7f024bec236a7229783a4d60dc8afa3b26d7", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/4f6f7f024bec236a7229783a4d60dc8afa3b26d7", "committedDate": "2020-10-29T10:31:27Z", "message": "Allow to resize root size via diskoffering of type service.\n\nService Offering can then have a root disk size configured. On such a case the Root Volume can only be resized when changing to another Service Offering with a Root disk size equals or larger than the current one."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNDM4NDUx", "url": "https://github.com/apache/cloudstack/pull/4341#pullrequestreview-520438451", "createdAt": "2020-10-30T07:54:10Z", "commit": {"oid": "4f6f7f024bec236a7229783a4d60dc8afa3b26d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNzo1NDoxMFrOHrEYlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNzo1NDoxMFrOHrEYlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkyMjY0NA==", "bodyText": "this comment could be a method name instead canServiceOfferingBeAppliedToInstance(...)", "url": "https://github.com/apache/cloudstack/pull/4341#discussion_r514922644", "createdAt": "2020-10-30T07:54:10Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -1183,24 +1183,27 @@ private UserVm upgradeStoppedVirtualMachine(Long vmId, Long svcOffId, Map<String\n         // Check that the specified service offering ID is valid\n         _itMgr.checkIfCanUpgrade(vmInstance, newServiceOffering);\n \n-        DiskOfferingVO newROOTDiskOffering = _diskOfferingDao.findById(newServiceOffering.getId());\n+        // Check if the new service offering can be applied to vm instance", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f6f7f024bec236a7229783a4d60dc8afa3b26d7"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNjc0NjU5", "url": "https://github.com/apache/cloudstack/pull/4341#pullrequestreview-520674659", "createdAt": "2020-10-30T13:38:06Z", "commit": {"oid": "4f6f7f024bec236a7229783a4d60dc8afa3b26d7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4907, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}