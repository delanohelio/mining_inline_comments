{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1Nzg2NTMw", "number": 4442, "title": "Preventing port 53 being added as lb rule when dns service is availab\u2026", "bodyText": "\u2026le in network offering\nDescription\n\nThrowing an error when port 53 is added to a load balancer when DNS is available on the network service offering.\n\n\n\n\n\nFixes: #4285\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?\n\n\n\nTry to add port 53 as a public port as a load balancer rule, an error will be returned.", "createdAt": "2020-11-05T04:32:31Z", "url": "https://github.com/apache/cloudstack/pull/4442", "merged": true, "mergeCommit": {"oid": "9a253c473ba0e3c1a0e361f43572952b9d2662f6"}, "closed": true, "closedAt": "2020-11-06T15:27:27Z", "author": {"login": "Spaceman1984"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZaqZdgH2gAyNTE1Nzg2NTMwOjA3ODM2YTJkYjRjMWRjOGUyN2RiYmE5OGI5Y2MxYmZjZWQ5YTM5ODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZ2gSegH2gAyNTE1Nzg2NTMwOjdlMmM3ZDRmMmNjYjQyOWUxYTQyZThiZDZkMzJmMTg1YzBmY2VmNTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "07836a2db4c1dc8e27dbba98b9cc1bfced9a3989", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/07836a2db4c1dc8e27dbba98b9cc1bfced9a3989", "committedDate": "2020-11-05T04:29:11Z", "message": "Preventing port 53 being added as lb rule when dns service is available in network offering"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0MDA3OTA2", "url": "https://github.com/apache/cloudstack/pull/4442#pullrequestreview-524007906", "createdAt": "2020-11-05T08:10:10Z", "commit": {"oid": "07836a2db4c1dc8e27dbba98b9cc1bfced9a3989"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MDI0NzUz", "url": "https://github.com/apache/cloudstack/pull/4442#pullrequestreview-525024753", "createdAt": "2020-11-06T10:21:33Z", "commit": {"oid": "07836a2db4c1dc8e27dbba98b9cc1bfced9a3989"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMDoyMTozM1rOHuoPTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMDoyMTozM1rOHuoPTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODY1NTgyMQ==", "bodyText": "can you factor 53 out as DNS_PORT?", "url": "https://github.com/apache/cloudstack/pull/4442#discussion_r518655821", "createdAt": "2020-11-06T10:21:33Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/network/lb/LoadBalancingRulesManagerImpl.java", "diffHunk": "@@ -1598,65 +1602,73 @@ public LoadBalancer createPublicLoadBalancerRule(String xId, String name, String\n         // LoadBalancer result = _elbMgr.handleCreateLoadBalancerRule(lb,\n         // lbOwner, lb.getNetworkId());\n         LoadBalancer result = null;\n-        if (result == null) {\n-            IpAddress systemIp = null;\n-            NetworkOffering off = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n-            if (off.isElasticLb() && ipVO == null && network.getVpcId() == null) {\n-                systemIp = _ipAddrMgr.assignSystemIp(networkId, lbOwner, true, false);\n-                if (systemIp != null) {\n-                    ipVO = _ipAddressDao.findById(systemIp.getId());\n+        IpAddress systemIp = null;\n+        NetworkOffering off = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n+\n+        if (srcPortStart == 53 && ipVO.isSourceNat()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07836a2db4c1dc8e27dbba98b9cc1bfced9a3989"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e2c7d4f2ccb429e1a42e8bd6d32f185c0fcef54", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/7e2c7d4f2ccb429e1a42e8bd6d32f185c0fcef54", "committedDate": "2020-11-06T12:55:29Z", "message": "Changed dns port to static final var"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4760, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}