{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5MzMzOTY2", "number": 4176, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNzowNDoyOFrOEIdBQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxODoxMTozMVrOEIeYhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3Mjk5NTIwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/com/cloud/api/ApiServlet.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNzowNDoyOFrOGobPVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNToxMDoxN1rOGo_QKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA0MjUxNw==", "bodyText": "We need to check if this is necessary or not", "url": "https://github.com/apache/cloudstack/pull/4176#discussion_r445042517", "createdAt": "2020-06-24T17:04:28Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/com/cloud/api/ApiServlet.java", "diffHunk": "@@ -213,7 +213,7 @@ void processRequestInContext(final HttpServletRequest req, final HttpServletResp\n                     try {\n                         responseString = apiAuthenticator.authenticate(command, params, session, remoteAddress, responseType, auditTrailSb, req, resp);\n                         if (session != null && session.getAttribute(ApiConstants.SESSIONKEY) != null) {\n-                            resp.addHeader(\"SET-COOKIE\", String.format(\"%s=%s;HttpOnly\", ApiConstants.SESSIONKEY, session.getAttribute(ApiConstants.SESSIONKEY)));\n+                            resp.addHeader(\"SET-COOKIE\", String.format(\"%s=%s;HttpOnly;Path=/client\", ApiConstants.SESSIONKEY, session.getAttribute(ApiConstants.SESSIONKEY)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57e3fcf4170b4cb7b147d7b35a02945a19a0f4ae"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM0MDAxMQ==", "bodyText": "@davidjumani please explore if this would work, without adding the /client path to the cookie; as I worry if this change can potentially break non-standard env (those which don't use the default context path of /client as defined in /etc/cloudstack/management/server.properties)", "url": "https://github.com/apache/cloudstack/pull/4176#discussion_r445340011", "createdAt": "2020-06-25T06:44:41Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/com/cloud/api/ApiServlet.java", "diffHunk": "@@ -213,7 +213,7 @@ void processRequestInContext(final HttpServletRequest req, final HttpServletResp\n                     try {\n                         responseString = apiAuthenticator.authenticate(command, params, session, remoteAddress, responseType, auditTrailSb, req, resp);\n                         if (session != null && session.getAttribute(ApiConstants.SESSIONKEY) != null) {\n-                            resp.addHeader(\"SET-COOKIE\", String.format(\"%s=%s;HttpOnly\", ApiConstants.SESSIONKEY, session.getAttribute(ApiConstants.SESSIONKEY)));\n+                            resp.addHeader(\"SET-COOKIE\", String.format(\"%s=%s;HttpOnly;Path=/client\", ApiConstants.SESSIONKEY, session.getAttribute(ApiConstants.SESSIONKEY)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA0MjUxNw=="}, "originalCommit": {"oid": "57e3fcf4170b4cb7b147d7b35a02945a19a0f4ae"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM1MjQxNQ==", "bodyText": "Looks like it is necessary, if not present, two sessionkeys are present\nIf non-standard implementations are the case, wouldn't JSESSIONID cause issues too?\nAlso exploring saml logins", "url": "https://github.com/apache/cloudstack/pull/4176#discussion_r445352415", "createdAt": "2020-06-25T07:14:37Z", "author": {"login": "davidjumani"}, "path": "server/src/main/java/com/cloud/api/ApiServlet.java", "diffHunk": "@@ -213,7 +213,7 @@ void processRequestInContext(final HttpServletRequest req, final HttpServletResp\n                     try {\n                         responseString = apiAuthenticator.authenticate(command, params, session, remoteAddress, responseType, auditTrailSb, req, resp);\n                         if (session != null && session.getAttribute(ApiConstants.SESSIONKEY) != null) {\n-                            resp.addHeader(\"SET-COOKIE\", String.format(\"%s=%s;HttpOnly\", ApiConstants.SESSIONKEY, session.getAttribute(ApiConstants.SESSIONKEY)));\n+                            resp.addHeader(\"SET-COOKIE\", String.format(\"%s=%s;HttpOnly;Path=/client\", ApiConstants.SESSIONKEY, session.getAttribute(ApiConstants.SESSIONKEY)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA0MjUxNw=="}, "originalCommit": {"oid": "57e3fcf4170b4cb7b147d7b35a02945a19a0f4ae"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTUwMzI0NA==", "bodyText": "@davidjumani in a deploy trillian env with this PR (or you may use the primate-qa server as well which has this PR) and both old UI and Primate, can you check side-effects when you change the context in /etc/cloudstack/management/server.properties from /client/ to say (a) /somenew-path and (b) / and restart management server and try log-in in both legacy UI and Primate (check network an Application/cookies)", "url": "https://github.com/apache/cloudstack/pull/4176#discussion_r445503244", "createdAt": "2020-06-25T11:56:30Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/com/cloud/api/ApiServlet.java", "diffHunk": "@@ -213,7 +213,7 @@ void processRequestInContext(final HttpServletRequest req, final HttpServletResp\n                     try {\n                         responseString = apiAuthenticator.authenticate(command, params, session, remoteAddress, responseType, auditTrailSb, req, resp);\n                         if (session != null && session.getAttribute(ApiConstants.SESSIONKEY) != null) {\n-                            resp.addHeader(\"SET-COOKIE\", String.format(\"%s=%s;HttpOnly\", ApiConstants.SESSIONKEY, session.getAttribute(ApiConstants.SESSIONKEY)));\n+                            resp.addHeader(\"SET-COOKIE\", String.format(\"%s=%s;HttpOnly;Path=/client\", ApiConstants.SESSIONKEY, session.getAttribute(ApiConstants.SESSIONKEY)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA0MjUxNw=="}, "originalCommit": {"oid": "57e3fcf4170b4cb7b147d7b35a02945a19a0f4ae"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYzMjU1NA==", "bodyText": "Nevermind I tested, this will break if path is restricted to /client only; ideally shoud match the webapp context path", "url": "https://github.com/apache/cloudstack/pull/4176#discussion_r445632554", "createdAt": "2020-06-25T15:10:17Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/com/cloud/api/ApiServlet.java", "diffHunk": "@@ -213,7 +213,7 @@ void processRequestInContext(final HttpServletRequest req, final HttpServletResp\n                     try {\n                         responseString = apiAuthenticator.authenticate(command, params, session, remoteAddress, responseType, auditTrailSb, req, resp);\n                         if (session != null && session.getAttribute(ApiConstants.SESSIONKEY) != null) {\n-                            resp.addHeader(\"SET-COOKIE\", String.format(\"%s=%s;HttpOnly\", ApiConstants.SESSIONKEY, session.getAttribute(ApiConstants.SESSIONKEY)));\n+                            resp.addHeader(\"SET-COOKIE\", String.format(\"%s=%s;HttpOnly;Path=/client\", ApiConstants.SESSIONKEY, session.getAttribute(ApiConstants.SESSIONKEY)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA0MjUxNw=="}, "originalCommit": {"oid": "57e3fcf4170b4cb7b147d7b35a02945a19a0f4ae"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MzIxODYzOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/com/cloud/api/ApiServlet.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxODoxMTozMVrOGodiHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxODoxMTozMVrOGodiHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4MDA5NQ==", "bodyText": "@rhtyd missing brace", "url": "https://github.com/apache/cloudstack/pull/4176#discussion_r445080095", "createdAt": "2020-06-24T18:11:31Z", "author": {"login": "shwstppr"}, "path": "server/src/main/java/com/cloud/api/ApiServlet.java", "diffHunk": "@@ -238,9 +238,14 @@ void processRequestInContext(final HttpServletRequest req, final HttpServletResp\n                             } catch (final IllegalStateException ignored) {\n                             }\n                         }\n-                        Cookie sessionKeyCookie = new Cookie(ApiConstants.SESSIONKEY, \"\");\n-                        sessionKeyCookie.setMaxAge(0);\n-                        resp.addCookie(sessionKeyCookie);\n+                        final Cookie[] cookies = req.getCookies();\n+                        if (cookies != null)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57e3fcf4170b4cb7b147d7b35a02945a19a0f4ae"}, "originalPosition": 17}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3723, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}