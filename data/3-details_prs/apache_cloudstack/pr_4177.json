{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5NTEzNTQw", "number": 4177, "title": "Prevent deploying IPv6 network if Zone has no IPv6 DNS configured", "bodyText": "Description\n\nIf an IPv6 enabled network is created but the Zone hasn't IPv6 DNS1 or DNS2 configured then dnsmasq inside the Virtual Router does not start.\nThis PRs adds validation that allows creating an IPv6 network only if the Zone has at least DNS1 or DNS2 configured.\n\n\n\n\nFixes: #4157\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)", "createdAt": "2020-06-24T21:08:39Z", "url": "https://github.com/apache/cloudstack/pull/4177", "merged": true, "mergeCommit": {"oid": "6f559d285aea82b171b902cf512541e0e9ea2ecb"}, "closed": true, "closedAt": "2020-10-30T08:07:23Z", "author": {"login": "GabrielBrascher"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuyuiagH2gAyNDM5NTEzNTQwOmNlNjU4YWMyNWJlYWQyODg3OTc3OGNlNjA0ZDFjZjkyNGVmMTVkM2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXU__CgBqjM5MzczNTQwMDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ce658ac25bead28879778ce604d1cf924ef15d3f", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/ce658ac25bead28879778ce604d1cf924ef15d3f", "committedDate": "2020-06-25T18:12:41Z", "message": "Deploy ipv6 network if zone has IPv6 DNS\n\nIf you have a IPv6 enabled network and you haven't specified the IPv6 DNS 1 and DNS 2 under the zone it causes dnsmasq inside the Virtual Router not to start"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84a02506eb7af975edc80bd5e7f1621553aef5e6", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/84a02506eb7af975edc80bd5e7f1621553aef5e6", "committedDate": "2020-06-24T17:54:22Z", "message": "Validate Zone IPv6 DNS\n\nPrevent deploying IPv6 network if zone has no IPv6 DNS configured."}, "afterCommit": {"oid": "ce658ac25bead28879778ce604d1cf924ef15d3f", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/ce658ac25bead28879778ce604d1cf924ef15d3f", "committedDate": "2020-06-25T18:12:41Z", "message": "Deploy ipv6 network if zone has IPv6 DNS\n\nIf you have a IPv6 enabled network and you haven't specified the IPv6 DNS 1 and DNS 2 under the zone it causes dnsmasq inside the Virtual Router not to start"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e060158d2c25b9865a8245ab430a3c19dd986e00", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/e060158d2c25b9865a8245ab430a3c19dd986e00", "committedDate": "2020-06-26T04:59:32Z", "message": "Add test case for networkModel.checkIp6Parameters\n\nFix logic on checkIp6Parameters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "362c064ef48d371c8cea30b2a74bf92133cbb327", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/362c064ef48d371c8cea30b2a74bf92133cbb327", "committedDate": "2020-06-26T00:29:09Z", "message": "Add test case for networkModel.checkIp6Parameters\n\nFix logic on checkIp6Parameters"}, "afterCommit": {"oid": "e060158d2c25b9865a8245ab430a3c19dd986e00", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/e060158d2c25b9865a8245ab430a3c19dd986e00", "committedDate": "2020-06-26T04:59:32Z", "message": "Add test case for networkModel.checkIp6Parameters\n\nFix logic on checkIp6Parameters"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4MjQ3NTQ3", "url": "https://github.com/apache/cloudstack/pull/4177#pullrequestreview-438247547", "createdAt": "2020-06-26T12:19:04Z", "commit": {"oid": "e060158d2c25b9865a8245ab430a3c19dd986e00"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMjoxOTowNFrOGpev-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMjoyMzoxOFrOGpe4FQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE0ODYwMg==", "bodyText": "CloudStack uses SLAAC for managing IPv6 ranges, therefore it is not necessary to have a start/end IPv6 address; on the other hand, IPv6 CIDR is mandatory for IPv6 networks.\nThat is why I changed this and other pieces of code that had start/end ipv6 address as mandatory.", "url": "https://github.com/apache/cloudstack/pull/4177#discussion_r446148602", "createdAt": "2020-06-26T12:19:04Z", "author": {"login": "GabrielBrascher"}, "path": "server/src/main/java/com/cloud/configuration/ConfigurationManagerImpl.java", "diffHunk": "@@ -3781,7 +3781,7 @@ public Vlan createVlanAndPublicIpRange(final long zoneId, final long networkId,\n             ipv4 = true;\n         }\n \n-        if (startIPv6 != null) {\n+        if (vlanIp6Cidr != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e060158d2c25b9865a8245ab430a3c19dd986e00"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE1MDE3MQ==", "bodyText": "Due to SLAAC implementation, an IPv6 network needs CIDR and Gateway. With the refactored code a network is \"marked\" as ipv6 if IPv6 CIDR and Gateway are not null.", "url": "https://github.com/apache/cloudstack/pull/4177#discussion_r446150171", "createdAt": "2020-06-26T12:22:22Z", "author": {"login": "GabrielBrascher"}, "path": "server/src/main/java/com/cloud/network/NetworkServiceImpl.java", "diffHunk": "@@ -1195,7 +1195,7 @@ public Network createGuestNetwork(CreateNetworkCmd cmd) throws InsufficientCapac\n         if (startIP != null) {\n             ipv4 = true;\n         }\n-        if (startIPv6 != null) {\n+        if (isNotBlank(ip6Cidr) && isNotBlank(ip6Gateway)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e060158d2c25b9865a8245ab430a3c19dd986e00"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE1MDY3Nw==", "bodyText": "Nowadays IPv6 networking support only /64 CIDR. Added Unit tests covering this.", "url": "https://github.com/apache/cloudstack/pull/4177#discussion_r446150677", "createdAt": "2020-06-26T12:23:18Z", "author": {"login": "GabrielBrascher"}, "path": "server/src/test/java/com/cloud/network/NetworkModelTest.java", "diffHunk": "@@ -90,6 +91,11 @@\n     private static final long PHYSICAL_NETWORK_1_ID = 1L;\n     private static final long PHYSICAL_NETWORK_2_ID = 2L;\n \n+    private static final String IPV6_CIDR = \"fd59:16ba:559b:243d::/64\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e060158d2c25b9865a8245ab430a3c19dd986e00"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1898b2fd2b2addb54e3cc3847bc597303b563c5b", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/1898b2fd2b2addb54e3cc3847bc597303b563c5b", "committedDate": "2020-09-24T08:44:27Z", "message": "Merge branch 'master' into validate-ipv6-network"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2MTc1NDIx", "url": "https://github.com/apache/cloudstack/pull/4177#pullrequestreview-496175421", "createdAt": "2020-09-25T07:31:26Z", "commit": {"oid": "1898b2fd2b2addb54e3cc3847bc597303b563c5b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwNzozMToyNlrOHX4P5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwNzozMToyNlrOHX4P5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgwMDg2OQ==", "bodyText": "can you encapsulate this in our local proxy to the StringUtils, so migration efforts will be located in a single file?", "url": "https://github.com/apache/cloudstack/pull/4177#discussion_r494800869", "createdAt": "2020-09-25T07:31:26Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/network/NetworkModelImpl.java", "diffHunk": "@@ -2207,14 +2207,8 @@ public boolean isNetworkInlineMode(Network network) {\n \n     @Override\n     public void checkIp6Parameters(String startIPv6, String endIPv6, String ip6Gateway, String ip6Cidr) throws InvalidParameterValueException {\n-        if (!NetUtils.isValidIp6(startIPv6)) {\n-            throw new InvalidParameterValueException(\"Invalid format for the startIPv6 parameter\");\n-        }\n-        if (!NetUtils.isValidIp6(endIPv6)) {\n-            throw new InvalidParameterValueException(\"Invalid format for the endIPv6 parameter\");\n-        }\n \n-        if (!(ip6Gateway != null && ip6Cidr != null)) {\n+        if (org.apache.commons.lang3.StringUtils.isBlank(ip6Gateway) || org.apache.commons.lang3.StringUtils.isBlank(ip6Cidr)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1898b2fd2b2addb54e3cc3847bc597303b563c5b"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b66843ecf26146964a17ae6023c0891ed82ff6c1", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/b66843ecf26146964a17ae6023c0891ed82ff6c1", "committedDate": "2020-09-27T21:08:21Z", "message": "Use CloudStack StringUtils instead of org.apache.commons.lang3.StringUtils"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3ODk4NjEw", "url": "https://github.com/apache/cloudstack/pull/4177#pullrequestreview-517898610", "createdAt": "2020-10-27T16:23:02Z", "commit": {"oid": "b66843ecf26146964a17ae6023c0891ed82ff6c1"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c90e1e23824eaeb2e1cf5326d717763212d2440d", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/c90e1e23824eaeb2e1cf5326d717763212d2440d", "committedDate": "2020-10-28T05:48:20Z", "message": "Consider an IPv6 network if ip6Cidr not null at createVlanAndPublicIpRange(CreateVlanIpRangeCmd)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NTEwMjU0", "url": "https://github.com/apache/cloudstack/pull/4177#pullrequestreview-518510254", "createdAt": "2020-10-28T10:18:47Z", "commit": {"oid": "c90e1e23824eaeb2e1cf5326d717763212d2440d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NTI3NzA5", "url": "https://github.com/apache/cloudstack/pull/4177#pullrequestreview-518527709", "createdAt": "2020-10-28T10:40:46Z", "commit": {"oid": "c90e1e23824eaeb2e1cf5326d717763212d2440d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NTQwNzU5", "url": "https://github.com/apache/cloudstack/pull/4177#pullrequestreview-518540759", "createdAt": "2020-10-28T10:57:47Z", "commit": {"oid": "c90e1e23824eaeb2e1cf5326d717763212d2440d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxMDo1Nzo0N1rOHpkhLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxMDo1Nzo0N1rOHpkhLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM1MTk4MA==", "bodyText": "@GabrielBrascher may be this exception msg has to be updated, as it is not sure here that startIPv6/endIPv6 are passed or not, as the checks for startIPv6/endIPv6 are moved after this.", "url": "https://github.com/apache/cloudstack/pull/4177#discussion_r513351980", "createdAt": "2020-10-28T10:57:47Z", "author": {"login": "sureshanaparti"}, "path": "server/src/main/java/com/cloud/network/NetworkModelImpl.java", "diffHunk": "@@ -2207,14 +2207,8 @@ public boolean isNetworkInlineMode(Network network) {\n \n     @Override\n     public void checkIp6Parameters(String startIPv6, String endIPv6, String ip6Gateway, String ip6Cidr) throws InvalidParameterValueException {\n-        if (!NetUtils.isValidIp6(startIPv6)) {\n-            throw new InvalidParameterValueException(\"Invalid format for the startIPv6 parameter\");\n-        }\n-        if (!NetUtils.isValidIp6(endIPv6)) {\n-            throw new InvalidParameterValueException(\"Invalid format for the endIPv6 parameter\");\n-        }\n \n-        if (!(ip6Gateway != null && ip6Cidr != null)) {\n+        if (StringUtils.isBlank(ip6Gateway) || StringUtils.isBlank(ip6Cidr)) {\n             throw new InvalidParameterValueException(\"ip6Gateway and ip6Cidr should be defined when startIPv6/endIPv6 are passed in\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c90e1e23824eaeb2e1cf5326d717763212d2440d"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c52730d5e5497664f6d5d4793e1b2dceec281eb8", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/c52730d5e5497664f6d5d4793e1b2dceec281eb8", "committedDate": "2020-10-28T15:08:51Z", "message": "Enhance log message on checkIp6Parameters"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4Nzg0ODE1", "url": "https://github.com/apache/cloudstack/pull/4177#pullrequestreview-518784815", "createdAt": "2020-10-28T15:22:41Z", "commit": {"oid": "c52730d5e5497664f6d5d4793e1b2dceec281eb8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c52730d5e5497664f6d5d4793e1b2dceec281eb8", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/c52730d5e5497664f6d5d4793e1b2dceec281eb8", "committedDate": "2020-10-28T15:08:51Z", "message": "Enhance log message on checkIp6Parameters"}, "afterCommit": {"oid": "ee923d80fd7bed7e55dfafafbf91351c1a039a26", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/ee923d80fd7bed7e55dfafafbf91351c1a039a26", "committedDate": "2020-10-28T18:35:09Z", "message": "Enhance log message on checkIp6Parameters"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ee923d80fd7bed7e55dfafafbf91351c1a039a26", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/ee923d80fd7bed7e55dfafafbf91351c1a039a26", "committedDate": "2020-10-28T18:35:09Z", "message": "Enhance log message on checkIp6Parameters"}, "afterCommit": {"oid": "c52730d5e5497664f6d5d4793e1b2dceec281eb8", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/c52730d5e5497664f6d5d4793e1b2dceec281eb8", "committedDate": "2020-10-28T15:08:51Z", "message": "Enhance log message on checkIp6Parameters"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3899, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}