{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1NTgyODA4", "number": 4255, "title": "Prevent null pointer on listPublicIpAddress cmd", "bodyText": "Description\n\nI reproduced this in a production environment that had been upgraded from 4.9 to 4.11 and then to 4.13.\nIf the environment has data centers and VLANs removed, sends an API request with the command listPublicIpAddress and allocatedOnly=false we can see this error:\n2020-07-29 08:15:16,224 ERROR [c.c.a.ApiServer] (qtp504527234-1307:ctx-d9b6eb3f ctx-a0add444) (logid:b94eb35a) unhandled exception executing api command: [Ljava.lang.String;@6177c5d4\njava.lang.NullPointerException\n\nThis occurs because ManagementService.searchForIPAddresses returns IP addresses from those deleted data centers. And then we have a Null Pointer exception when building the createIPAddressResponse.\nThis PR prevents this null pointer exception by doing an INNER_JOIN with data_center table were removed is null.\n\n\n\n\n\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?\n\n\n\nTo test this, I run the listPublicIpAddrescomand with allocatedOnly = false using cloudmonkey to make the request\nBefore the fix:\ncloudmonkey listpublicipaddresses allocatedonly=false\nError: (HTTP 530, error code 9999) <nil>\n\nAfter the fix:\ncloudmonkey listpublicipaddresses allocatedonly=false\n{\n  \"count\": 755,\n  \"publicipaddress\": [...]\n}", "createdAt": "2020-08-10T15:45:27Z", "url": "https://github.com/apache/cloudstack/pull/4255", "merged": true, "mergeCommit": {"oid": "3adee270c7bb699c4ccd5fd5486970979d8275fe"}, "closed": true, "closedAt": "2020-08-13T10:06:20Z", "author": {"login": "RodrigoDLopez"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9i5PAgH2gAyNDY1NTgyODA4OjZkYzQwZjdiMTQ2N2MyYmE1M2Y5YmFmZjBkY2FlNjliZTY4MWJiZTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-Q1-CgFqTQ2NjIyMTQ1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6dc40f7b1467c2ba53f9baff0dcae69be681bbe2", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/6dc40f7b1467c2ba53f9baff0dcae69be681bbe2", "committedDate": "2020-08-10T14:14:45Z", "message": "Prevent null pointer on listPublicIpAddress cmd\n\nInsert an inner join between data_center table and user_ip_address where data_center.removed field is null"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NTU4Mzgz", "url": "https://github.com/apache/cloudstack/pull/4255#pullrequestreview-464558383", "createdAt": "2020-08-10T20:19:03Z", "commit": {"oid": "6dc40f7b1467c2ba53f9baff0dcae69be681bbe2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0ODk0Nzk2", "url": "https://github.com/apache/cloudstack/pull/4255#pullrequestreview-464894796", "createdAt": "2020-08-11T09:22:23Z", "commit": {"oid": "6dc40f7b1467c2ba53f9baff0dcae69be681bbe2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MDkzNTYz", "url": "https://github.com/apache/cloudstack/pull/4255#pullrequestreview-466093563", "createdAt": "2020-08-12T16:45:06Z", "commit": {"oid": "6dc40f7b1467c2ba53f9baff0dcae69be681bbe2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNjo0NTowN1rOG_pwkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNjo0NTowN1rOG_pwkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM5NzY0OQ==", "bodyText": "I think that it would be better to implement this via the VLAN Search Builder instead of adding the proposed search builder. Here are a few points of why I think it would be better:\n\nAll removed zones should have its networks removed anyway, therefore VLANs of a removed zone are marked as removed as well;\nthis could also prevent issues of selecting IP addresses of removed VLANs on an existing Zone;\nand, at the end, it reduces costs of one extra join.\n\nCurrently lines 1984 - 1986:\nfinal SearchBuilder<VlanVO> vlanSearch = _vlanDao.createSearchBuilder();\nvlanSearch.and(\"vlanType\", vlanSearch.entity().getVlanType(), SearchCriteria.Op.EQ);\nsb.join(\"vlanSearch\", vlanSearch, sb.entity().getVlanId(), vlanSearch.entity().getId(), JoinBuilder.JoinType.INNER);\n\nChanging current VLAN search builder adding a verification \"WHERE removed IS NULL\":\nfinal SearchBuilder<VlanVO> vlanSearch = _vlanDao.createSearchBuilder();\nvlanSearch.and(\"vlanType\", vlanSearch.entity().getVlanType(), SearchCriteria.Op.EQ);\nvlanSearch.and(\"removed\", vlanSearch.entity().getRemoved(), SearchCriteria.Op.NULL);\nsb.join(\"vlanSearch\", vlanSearch, sb.entity().getVlanId(), vlanSearch.entity().getId(), JoinBuilder.JoinType.INNER);SearchCriteria.Op.NULL);", "url": "https://github.com/apache/cloudstack/pull/4255#discussion_r469397649", "createdAt": "2020-08-12T16:45:07Z", "author": {"login": "GabrielBrascher"}, "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -1985,6 +1985,10 @@ private boolean hasSuitablePoolsForVolume(final VolumeVO volume, final Host host\n         vlanSearch.and(\"vlanType\", vlanSearch.entity().getVlanType(), SearchCriteria.Op.EQ);\n         sb.join(\"vlanSearch\", vlanSearch, sb.entity().getVlanId(), vlanSearch.entity().getId(), JoinBuilder.JoinType.INNER);\n \n+        SearchBuilder<DataCenterVO> zoneSearchBuilder = _dcDao.createSearchBuilder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dc40f7b1467c2ba53f9baff0dcae69be681bbe2"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc8ad2110ac7f2fbdd63da1ad4923396302341a9", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/fc8ad2110ac7f2fbdd63da1ad4923396302341a9", "committedDate": "2020-08-12T17:35:39Z", "message": "Remove extra join and add a filter for VLAN removed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MjIxNDUw", "url": "https://github.com/apache/cloudstack/pull/4255#pullrequestreview-466221450", "createdAt": "2020-08-12T19:46:49Z", "commit": {"oid": "fc8ad2110ac7f2fbdd63da1ad4923396302341a9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4039, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}