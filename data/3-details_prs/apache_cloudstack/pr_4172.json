{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5MjE0ODE4", "number": 4172, "title": "[VMware] Support to attach more than 15 data disks in VMware VM", "bodyText": "Description\n\nSupport to attach more than 15 data disks in VMware VM\n\n\n\n\n\nFixes: #4102\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?\n\n\n\n\nCreate a new VM and attached 25 data disks to the VM.\n\n[cloud]> select vm.instance_name as vm_name, count(*) as volumes_count from vm_instance vm join volumes vol on vm.id = vol.instance_id where vm.id = 4 group by vol.instance_id;\n+----------+---------------+\n| vm_name  | volumes_count |\n+----------+---------------+\n| i-2-4-VM |            26 |\n+----------+---------------+\n1 row in set (0.00 sec)", "createdAt": "2020-06-24T13:39:48Z", "url": "https://github.com/apache/cloudstack/pull/4172", "merged": true, "mergeCommit": {"oid": "f0a67cca7a38ca6a6cd38f1d2c54d15137d206e2"}, "closed": true, "closedAt": "2020-07-15T10:21:56Z", "author": {"login": "sureshanaparti"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuim_3AFqTQzNzA2NzQwMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy926YgFqTQ0NDk4MDc5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MDY3NDAx", "url": "https://github.com/apache/cloudstack/pull/4172#pullrequestreview-437067401", "createdAt": "2020-06-24T23:13:17Z", "commit": {"oid": "0aad24ad5f16c10a85bfe8c886f470ff3011bce4"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMzoxMzoxOFrOGomJXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQyMzoyMjoyMVrOGomUjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIyMTIxNQ==", "bodyText": "Minor one: can you please add braces to this if statement?", "url": "https://github.com/apache/cloudstack/pull/4172#discussion_r445221215", "createdAt": "2020-06-24T23:13:18Z", "author": {"login": "nvazquez"}, "path": "plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java", "diffHunk": "@@ -2068,13 +2068,16 @@ protected StartAnswer execute(StartCommand cmd) {\n                         }\n                     }\n                 } else {\n-                    controllerKey = vmMo.getScsiDiskControllerKeyNoException(diskController);\n+                    if (VmwareHelper.isReservedScsiDeviceNumber(scsiUnitNumber))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0aad24ad5f16c10a85bfe8c886f470ff3011bce4"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIyMzI2Ng==", "bodyText": "Also minor: unnecessary parenthesis", "url": "https://github.com/apache/cloudstack/pull/4172#discussion_r445223266", "createdAt": "2020-06-24T23:19:47Z", "author": {"login": "nvazquez"}, "path": "plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java", "diffHunk": "@@ -2098,10 +2101,17 @@ protected StartAnswer execute(StartCommand cmd) {\n                     assert (volumeDsDetails != null);\n \n                     String[] diskChain = syncDiskChain(dcMo, vmMo, vmSpec, vol, matchingExistingDisk, dataStoresDetails);\n-                    if (controllerKey == scsiControllerKey && VmwareHelper.isReservedScsiDeviceNumber(scsiUnitNumber))\n+\n+                    int deviceNumber = -1;\n+                    if (controllerKey == vmMo.getIDEControllerKey(ideUnitNumber)) {\n+                        deviceNumber = (ideUnitNumber % VmwareHelper.MAX_ALLOWED_DEVICES_IDE_CONTROLLER);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0aad24ad5f16c10a85bfe8c886f470ff3011bce4"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIyNDA3Nw==", "bodyText": "Maybe also a null check for scsiDiskDevicesOnController?", "url": "https://github.com/apache/cloudstack/pull/4172#discussion_r445224077", "createdAt": "2020-06-24T23:22:21Z", "author": {"login": "nvazquez"}, "path": "vmware-base/src/main/java/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java", "diffHunk": "@@ -2412,6 +2419,23 @@ public void ensureScsiDeviceControllers(int count, int availableBusNum) throws E\n         }\n     }\n \n+    private boolean isValidScsiDiskController(VirtualSCSIController scsiDiskController) {\n+        if (scsiDiskController == null) {\n+            return false;\n+        }\n+\n+        List<Integer> scsiDiskDevicesOnController = scsiDiskController.getDevice();\n+        if (scsiDiskDevicesOnController != null && scsiDiskDevicesOnController.size() >= (VmwareHelper.MAX_SUPPORTED_DEVICES_SCSI_CONTROLLER)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0aad24ad5f16c10a85bfe8c886f470ff3011bce4"}, "originalPosition": 146}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e73ca06f75b7ae065df20403fd6851028fb052b", "author": {"user": {"login": "sureshanaparti", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/2e73ca06f75b7ae065df20403fd6851028fb052b", "committedDate": "2020-07-01T04:53:46Z", "message": "[VMware] Support to attach more than 15 data disks in VMware VM"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0aad24ad5f16c10a85bfe8c886f470ff3011bce4", "author": {"user": {"login": "sureshanaparti", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/0aad24ad5f16c10a85bfe8c886f470ff3011bce4", "committedDate": "2020-06-24T13:31:39Z", "message": "[VMware] Support to attach more than 15 data disks in VMware VM"}, "afterCommit": {"oid": "2e73ca06f75b7ae065df20403fd6851028fb052b", "author": {"user": {"login": "sureshanaparti", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/2e73ca06f75b7ae065df20403fd6851028fb052b", "committedDate": "2020-07-01T04:53:46Z", "message": "[VMware] Support to attach more than 15 data disks in VMware VM"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNjQ3ODA5", "url": "https://github.com/apache/cloudstack/pull/4172#pullrequestreview-441647809", "createdAt": "2020-07-02T12:52:50Z", "commit": {"oid": "2e73ca06f75b7ae065df20403fd6851028fb052b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNDExNDg3", "url": "https://github.com/apache/cloudstack/pull/4172#pullrequestreview-442411487", "createdAt": "2020-07-03T13:25:07Z", "commit": {"oid": "2e73ca06f75b7ae065df20403fd6851028fb052b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0OTgwNzkw", "url": "https://github.com/apache/cloudstack/pull/4172#pullrequestreview-444980790", "createdAt": "2020-07-08T17:26:30Z", "commit": {"oid": "2e73ca06f75b7ae065df20403fd6851028fb052b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3887, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}