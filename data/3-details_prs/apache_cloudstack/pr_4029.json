{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzMzYxMDU2", "number": 4029, "title": "Bring back vm.suspend during deleting VM snapshot", "bodyText": "Original commit, merged to 4.11.3, got mysteriously missing when merging branch 4.11 to 4.12 on the very same day that original PR was merged - so bringing back the same code to 4.13.1 and 4.14(master atm)\nI'm talking about the PR #3194 (the commit itself is there, but NOT the content/code - possibly a wrongly resolved merge conflicts etc)\n/cc @weizhouapache  (you approved the original PR) and @rhtyd (you also approved the original PR)\nUPDATE: the VM snapshots deletion is NOT handled via this code (this code is used in some other scenario - was missing so there it is now again)\nPausing a VM BEFORE the VM snap is deleted is handled now by #4033. Possible improvements (for 4.15) can be taken from #4032 (additional checks and such)", "createdAt": "2020-04-14T19:04:29Z", "url": "https://github.com/apache/cloudstack/pull/4029", "merged": true, "mergeCommit": {"oid": "b406e1dc4696d2b529add947fa5f81f358cf1cc5"}, "closed": true, "closedAt": "2020-04-16T13:15:23Z", "author": {"login": "andrijapanicsb"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXoQtwAH2gAyNDAzMzYxMDU2OmVmNThlNTY0NTMzZTE0ZjNmMmRkMmVkNmFhYTNiZjgwNzIwMTE4MjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYLW7kAFqTM5NDU1NzMxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ef58e564533e14f3f2dd2ed6aaa3bf8072011823", "author": {"user": {"login": "andrijapanicsb", "name": "Andrija Panic"}}, "url": "https://github.com/apache/cloudstack/commit/ef58e564533e14f3f2dd2ed6aaa3bf8072011823", "committedDate": "2020-04-14T19:00:48Z", "message": "Bring back vm.suspend during deleting VM snapshot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ae5eb572acc10778700defe35be085792100801", "author": {"user": {"login": "DaanHoogland", "name": "dahn"}}, "url": "https://github.com/apache/cloudstack/commit/6ae5eb572acc10778700defe35be085792100801", "committedDate": "2020-04-14T19:20:38Z", "message": "catch'em all"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMjI5OTQ5", "url": "https://github.com/apache/cloudstack/pull/4029#pullrequestreview-393229949", "createdAt": "2020-04-14T19:27:34Z", "commit": {"oid": "6ae5eb572acc10778700defe35be085792100801"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eeac1353b68b10f1de9d2b545af6ec3f4f769c8f", "author": {"user": {"login": "DaanHoogland", "name": "dahn"}}, "url": "https://github.com/apache/cloudstack/commit/eeac1353b68b10f1de9d2b545af6ec3f4f769c8f", "committedDate": "2020-04-15T07:24:24Z", "message": "trailing spaces"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f5e51133967bae750f089e53f7c78fa85d8a396", "author": {"user": {"login": "DaanHoogland", "name": "dahn"}}, "url": "https://github.com/apache/cloudstack/commit/0f5e51133967bae750f089e53f7c78fa85d8a396", "committedDate": "2020-04-15T15:38:56Z", "message": "logging on suspend"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NDk0ODcx", "url": "https://github.com/apache/cloudstack/pull/4029#pullrequestreview-394494871", "createdAt": "2020-04-16T10:19:01Z", "commit": {"oid": "0f5e51133967bae750f089e53f7c78fa85d8a396"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMDoxOTowMlrOGGejqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMDoxOTowMlrOGGejqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ0NTI5MA==", "bodyText": "same comment as in #4033: first we suspend unconditionaly, and than, we just assume it need resuming without checking if it was running in the first place. Are there situations we should guard against more diligently? (cc @weizhouapache @rhtyd )", "url": "https://github.com/apache/cloudstack/pull/4029#discussion_r409445290", "createdAt": "2020-04-16T10:19:02Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/KVMStorageProcessor.java", "diffHunk": "@@ -1005,6 +1005,13 @@ public Answer backupSnapshot(final CopyCommand cmd) {\n                             primaryStore.getUuid());\n                     if (state == DomainInfo.DomainState.VIR_DOMAIN_RUNNING && !primaryStorage.isExternalSnapshot()) {\n                         final DomainSnapshot snap = vm.snapshotLookupByName(snapshotName);\n+                        try {\n+                            s_logger.info(String.format(\"Suspending VM '%s' to delete snapshot,\", vm.getName()));\n+                            vm.suspend();\n+                        } catch (final LibvirtException e) {\n+                            s_logger.error(\"Failed to suspend the VM\", e);\n+                            throw e;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f5e51133967bae750f089e53f7c78fa85d8a396"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NTQ5MTEx", "url": "https://github.com/apache/cloudstack/pull/4029#pullrequestreview-394549111", "createdAt": "2020-04-16T11:41:32Z", "commit": {"oid": "0f5e51133967bae750f089e53f7c78fa85d8a396"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NTU3MzEy", "url": "https://github.com/apache/cloudstack/pull/4029#pullrequestreview-394557312", "createdAt": "2020-04-16T11:54:16Z", "commit": {"oid": "0f5e51133967bae750f089e53f7c78fa85d8a396"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4198, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}