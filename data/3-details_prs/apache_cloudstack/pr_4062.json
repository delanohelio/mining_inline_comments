{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1MDM2MjU3", "number": 4062, "title": "[VMware] Cannot migrate VM on PVLAN shared network", "bodyText": "Description\nLogs:\n2020-05-07 23:12:28,116 INFO  [c.c.v.VirtualMachineManagerImpl] (Work-Job-Executor-25:ctx-0a8703ef job-79/job-80 ctx-a3fc4a74) (logid:936f1123) Migrating VM[User|i-2-8-VM] to Dest[Zone(Id)-Pod(Id)-Cluster(Id)-Host(Id)-Storage(Volume(Id|Type-->Pool(Id))] : Dest[Zone(1)-Pod(1)-Cluster(1)-Host(2)-Storage()]\n2020-05-07 23:12:28,120 DEBUG [c.c.n.NetworkModelImpl] (Work-Job-Executor-25:ctx-0a8703ef job-79/job-80 ctx-a3fc4a74) (logid:936f1123) Service SecurityGroup is not supported in the network id=210\n2020-05-07 23:12:28,125 DEBUG [c.c.n.NetworkModelImpl] (Work-Job-Executor-25:ctx-0a8703ef job-79/job-80 ctx-a3fc4a74) (logid:936f1123) Service SecurityGroup is not supported in the network id=210\n2020-05-07 23:12:28,127 ERROR [c.c.v.VmWorkJobHandlerProxy] (Work-Job-Executor-25:ctx-0a8703ef job-79/job-80 ctx-a3fc4a74) (logid:936f1123) Invocation exception, caused by: java.lang.ClassCastException: class com.cloud.vm.VMInstanceVO$$EnhancerByCGLIB$$1786dcb5 cannot be cast to class com.cloud.vm.UserVmVO (com.cloud.vm.VMInstanceVO$$EnhancerByCGLIB$$1786dcb5 and com.cloud.vm.UserVmVO are in unnamed module of loader 'app')\n2020-05-07 23:12:28,127 INFO  [c.c.v.VmWorkJobHandlerProxy] (Work-Job-Executor-25:ctx-0a8703ef job-79/job-80 ctx-a3fc4a74) (logid:936f1123) Rethrow exception java.lang.ClassCastException: class com.cloud.vm.VMInstanceVO$$EnhancerByCGLIB$$1786dcb5 cannot be cast to class com.cloud.vm.UserVmVO (com.cloud.vm.VMInstanceVO$$EnhancerByCGLIB$$1786dcb5 and com.cloud.vm.UserVmVO are in unnamed module of loader 'app')\n2020-05-07 23:12:28,127 DEBUG [c.c.v.VmWorkJobDispatcher] (Work-Job-Executor-25:ctx-0a8703ef job-79/job-80) (logid:936f1123) Done with run of VM work job: com.cloud.vm.VmWorkMigrate for VM 8, job origin: 79\n2020-05-07 23:12:28,127 ERROR [c.c.v.VmWorkJobDispatcher] (Work-Job-Executor-25:ctx-0a8703ef job-79/job-80) (logid:936f1123) Unable to complete AsyncJobVO {id:80, userId: 2, accountId: 2, instanceType: null, instanceId: null, cmd: com.cloud.vm.VmWorkMigrate, cmdInfo: rO0ABXNyABpjb20uY2xvdWQudm0uVm1Xb3JrTWlncmF0ZRdxQXtPtzYqAgAGSgAJc3JjSG9zdElkTAAJY2x1c3RlcklkdAAQTGphdmEvbGFuZy9Mb25nO0wABmhvc3RJZHEAfgABTAAFcG9kSWRxAH4AAUwAB3N0b3JhZ2V0AA9MamF2YS91dGlsL01hcDtMAAZ6b25lSWRxAH4AAXhyABNjb20uY2xvdWQudm0uVm1Xb3Jrn5m2VvAlZ2sCAARKAAlhY2NvdW50SWRKAAZ1c2VySWRKAAR2bUlkTAALaGFuZGxlck5hbWV0ABJMamF2YS9sYW5nL1N0cmluZzt4cAAAAAAAAAACAAAAAAAAAAIAAAAAAAAACHQAGVZpcnR1YWxNYWNoaW5lTWFuYWdlckltcGwAAAAAAAAAAXNyAA5qYXZhLmxhbmcuTG9uZzuL5JDMjyPfAgABSgAFdmFsdWV4cgAQamF2YS5sYW5nLk51bWJlcoaslR0LlOCLAgAAeHAAAAAAAAAAAXNxAH4ABwAAAAAAAAACcQB-AAlwcQB-AAk, cmdVersion: 0, status: IN_PROGRESS, processStatus: 0, resultCode: 0, result: null, initMsid: 32989593536621, completeMsid: null, lastUpdated: null, lastPolled: null, created: Thu May 07 23:12:27 UTC 2020, removed: null}, job origin:79\njava.lang.ClassCastException: class com.cloud.vm.VMInstanceVO$$EnhancerByCGLIB$$1786dcb5 cannot be cast to class com.cloud.vm.UserVmVO (com.cloud.vm.VMInstanceVO$$EnhancerByCGLIB$$1786dcb5 and com.cloud.vm.UserVmVO are in unnamed module of loader 'app')\n\tat com.cloud.network.element.VirtualRouterElement.prepareMigration(VirtualRouterElement.java:1226)\n\tat org.apache.cloudstack.engine.orchestration.NetworkOrchestrator.prepareNicForMigration(NetworkOrchestrator.java:1778)\n\tat com.cloud.vm.VirtualMachineManagerImpl.migrate(VirtualMachineManagerImpl.java:2358)\n\n\nStrangely, assert check passes but casting fails:\n} else if (vm.getType() == VirtualMachine.Type.User) {\n            assert vm instanceof UserVmVO;\n            final UserVmVO userVm = (UserVmVO) vm.getVirtualMachine();\n            _userVmMgr.setupVmForPvlan(false, userVm.getHostId(), nic);\n}`\n\nFixes: #4061\nTypes of changes\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\n\nHow Has This Been Tested?\nDeploy VM on Shared network - PVLAN\nMigrate VM to another host", "createdAt": "2020-05-08T04:18:06Z", "url": "https://github.com/apache/cloudstack/pull/4062", "merged": true, "mergeCommit": {"oid": "056e6768a2a2c879a62f82ac4c2a39e8acf6bb6e"}, "closed": true, "closedAt": "2020-06-08T01:31:12Z", "author": {"login": "nvazquez"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfNIDnAFqTQwODA2ODA0OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcn0fGtAFqTQyNDA1NjMyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4MDY4MDQ5", "url": "https://github.com/apache/cloudstack/pull/4062#pullrequestreview-408068049", "createdAt": "2020-05-08T07:55:18Z", "commit": {"oid": "548bf205c3a0452cd48d324ca8f934e4f1747553"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExODUxNjUz", "url": "https://github.com/apache/cloudstack/pull/4062#pullrequestreview-411851653", "createdAt": "2020-05-14T14:18:20Z", "commit": {"oid": "548bf205c3a0452cd48d324ca8f934e4f1747553"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNDoxODoyMFrOGVegiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNDoxODoyMFrOGVegiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE3MzEzMQ==", "bodyText": "@nvazquez Have you observed similar issues with router VM using similar type casting in the if stmt above. eg: DomainRouterVO router = (DomainRouterVO) vm.getVirtualMachine();. Same casting is being used for router VM in other methods below. May be you can check and fix for router VM as well. Thanks.", "url": "https://github.com/apache/cloudstack/pull/4062#discussion_r425173131", "createdAt": "2020-05-14T14:18:20Z", "author": {"login": "sureshanaparti"}, "path": "server/src/main/java/com/cloud/network/element/VirtualRouterElement.java", "diffHunk": "@@ -1223,8 +1223,7 @@ public boolean prepareMigration(final NicProfile nic, final Network network, fin\n             }\n         } else if (vm.getType() == VirtualMachine.Type.User) {\n             assert vm instanceof UserVmVO;\n-            final UserVmVO userVm = (UserVmVO) vm.getVirtualMachine();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "548bf205c3a0452cd48d324ca8f934e4f1747553"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c72408354525321764eae14fafc466ff1b5794be", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/c72408354525321764eae14fafc466ff1b5794be", "committedDate": "2020-05-15T16:43:45Z", "message": "Cannot migrate VM on PVLAN shared network"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "548bf205c3a0452cd48d324ca8f934e4f1747553", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/548bf205c3a0452cd48d324ca8f934e4f1747553", "committedDate": "2020-05-08T04:12:05Z", "message": "[VMware] Cannot migrate VM on PVLAN shared network"}, "afterCommit": {"oid": "c72408354525321764eae14fafc466ff1b5794be", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/c72408354525321764eae14fafc466ff1b5794be", "committedDate": "2020-05-15T16:43:45Z", "message": "Cannot migrate VM on PVLAN shared network"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MDU2MzIw", "url": "https://github.com/apache/cloudstack/pull/4062#pullrequestreview-424056320", "createdAt": "2020-06-04T02:18:10Z", "commit": {"oid": "c72408354525321764eae14fafc466ff1b5794be"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4251, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}