{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3NTg0NDQy", "number": 4128, "title": "Role based users in Projects", "bodyText": "Description\nEnabling Role Based users in projects\nPrimate PR related to the FR: apache/cloudstack-primate#382\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)", "createdAt": "2020-06-04T04:41:50Z", "url": "https://github.com/apache/cloudstack/pull/4128", "merged": true, "mergeCommit": {"oid": "c578004fe5f049684830d4323422dc3953481ac7"}, "closed": true, "closedAt": "2020-08-13T10:15:40Z", "author": {"login": "Pearl1594"}, "timelineItems": {"totalCount": 54, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcmA9gRgH2gAyNDI3NTg0NDQyOmEyMDU2MzU2ZmFhYmQ1MDhlYTU4MDY3OTg5ODIwNGE2NmRiNjIzODc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc9yx9UgFqTQ2NDg2NzMyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a2056356faabd508ea580679898204a66db62387", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/a2056356faabd508ea580679898204a66db62387", "committedDate": "2020-05-29T11:42:23Z", "message": "Enable role based users in projects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fe531785b79d863226cce55b4492b6672d2a39b", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/2fe531785b79d863226cce55b4492b6672d2a39b", "committedDate": "2020-06-04T04:39:05Z", "message": "Merge branch 'master' of github.com:shapeblue/cloudstack into proj-roleBased-users"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1443602940590682e2a54de61fab3ab0e9993787", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/1443602940590682e2a54de61fab3ab0e9993787", "committedDate": "2020-06-04T04:39:35Z", "message": "Merge branch 'master' of github.com:shapeblue/cloudstack into proj-roleBased-users"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9b97460dd49f491660e8f643c120057bcd05cbc", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/c9b97460dd49f491660e8f643c120057bcd05cbc", "committedDate": "2020-06-05T13:17:25Z", "message": "Modified list responses for projectAccounts and invitations to include userid"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44aa2399ca80cf0104df00a0dbd56662f4ae98b5", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/44aa2399ca80cf0104df00a0dbd56662f4ae98b5", "committedDate": "2020-06-09T10:34:08Z", "message": "revert API parameter change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e3af3cda0c3b9b1c20a307440efda13dbaa9c17", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/6e3af3cda0c3b9b1c20a307440efda13dbaa9c17", "committedDate": "2020-06-11T04:01:30Z", "message": "changes for backward compatability"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e0a64c442a1401881655ba3f44227d4554331e8", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/7e0a64c442a1401881655ba3f44227d4554331e8", "committedDate": "2020-06-12T10:56:53Z", "message": "restrict user invitation visibility to only that specific user"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a58367d863ed2c226abc487022c4faf637395fa9", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/a58367d863ed2c226abc487022c4faf637395fa9", "committedDate": "2020-06-11T06:14:05Z", "message": "restric user invitation visibility to only that specific user"}, "afterCommit": {"oid": "7e0a64c442a1401881655ba3f44227d4554331e8", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/7e0a64c442a1401881655ba3f44227d4554331e8", "committedDate": "2020-06-12T10:56:53Z", "message": "restrict user invitation visibility to only that specific user"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2fbd310c561b3657bf346ade6dd9a78a3e40bf5", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/e2fbd310c561b3657bf346ade6dd9a78a3e40bf5", "committedDate": "2020-06-12T10:57:39Z", "message": "Merge branch 'master' of github.com:shapeblue/cloudstack into proj-roleBased-users"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2730dd5d6963da17eb82998677ce54d9332cda2", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/b2730dd5d6963da17eb82998677ce54d9332cda2", "committedDate": "2020-06-18T08:41:53Z", "message": "Added additional response params - listProjectAccounts + schema changes + Marvin tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f45d7ec03f1f09c7cb514284f8706ec7d2d045b2", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/f45d7ec03f1f09c7cb514284f8706ec7d2d045b2", "committedDate": "2020-06-18T06:57:45Z", "message": "Added additional response params - listProjectAccounts + schema changes + Marvin tests"}, "afterCommit": {"oid": "b2730dd5d6963da17eb82998677ce54d9332cda2", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/b2730dd5d6963da17eb82998677ce54d9332cda2", "committedDate": "2020-06-18T08:41:53Z", "message": "Added additional response params - listProjectAccounts + schema changes + Marvin tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f7a81bfc3319ed98cb291c56a0a2231ded129d8", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/1f7a81bfc3319ed98cb291c56a0a2231ded129d8", "committedDate": "2020-06-19T01:06:47Z", "message": "Refactored code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fcb210ad601ad52cb8fb279d904d3fc1a77a715", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/0fcb210ad601ad52cb8fb279d904d3fc1a77a715", "committedDate": "2020-06-22T05:18:29Z", "message": "Add marvin tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef93f1518d587c098fb1cc9937458a9a739e7e5b", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/ef93f1518d587c098fb1cc9937458a9a739e7e5b", "committedDate": "2020-06-22T05:09:41Z", "message": "Add marvin tests"}, "afterCommit": {"oid": "0fcb210ad601ad52cb8fb279d904d3fc1a77a715", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/0fcb210ad601ad52cb8fb279d904d3fc1a77a715", "committedDate": "2020-06-22T05:18:29Z", "message": "Add marvin tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f37e9689396a641b5ee04d2fcd6a875cc77ad6da", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/f37e9689396a641b5ee04d2fcd6a875cc77ad6da", "committedDate": "2020-06-24T12:20:27Z", "message": "Permit root admin to perform operation on/in projects they aren't part of"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96fc8776b8d506409fe9d33ceed08216c7cef307", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/96fc8776b8d506409fe9d33ceed08216c7cef307", "committedDate": "2020-06-25T11:00:15Z", "message": "Permit domain admins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab3b5a12a7a4f7e94114b369b16e4c692f149680", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/ab3b5a12a7a4f7e94114b369b16e4c692f149680", "committedDate": "2020-06-29T05:33:26Z", "message": "fix query parameter for listing project role permissions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1bf01884d12b6ba9a94fe817013707325c7b8c2", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/c1bf01884d12b6ba9a94fe817013707325c7b8c2", "committedDate": "2020-06-29T11:36:18Z", "message": "review comments (offline)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMzk2NjAx", "url": "https://github.com/apache/cloudstack/pull/4128#pullrequestreview-441396601", "createdAt": "2020-07-02T06:55:32Z", "commit": {"oid": "c1bf01884d12b6ba9a94fe817013707325c7b8c2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNjo1NTozMlrOGr_w3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNjo1NTozMlrOGr_w3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4NjY1Mg==", "bodyText": "nit - roletype is enough? unless of course we're using this with projectroletype in some API", "url": "https://github.com/apache/cloudstack/pull/4128#discussion_r448786652", "createdAt": "2020-07-02T06:55:32Z", "author": {"login": "rhtyd"}, "path": "api/src/main/java/org/apache/cloudstack/api/ApiConstants.java", "diffHunk": "@@ -472,11 +473,16 @@\n     public static final String PROJECT = \"project\";\n     public static final String ROLE = \"role\";\n     public static final String ROLE_ID = \"roleid\";\n+    public static final String ACCOUNT_ROLE_TYPE = \"accountroletype\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1bf01884d12b6ba9a94fe817013707325c7b8c2"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMzk3MzU5", "url": "https://github.com/apache/cloudstack/pull/4128#pullrequestreview-441397359", "createdAt": "2020-07-02T06:56:51Z", "commit": {"oid": "c1bf01884d12b6ba9a94fe817013707325c7b8c2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNjo1Njo1MVrOGr_zMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNjo1Njo1MVrOGr_zMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4NzI1MQ==", "bodyText": "nit - probably this means projectrolepermissionid? (yes, naming is hard, I'm trying to guess what is parameter is for)", "url": "https://github.com/apache/cloudstack/pull/4128#discussion_r448787251", "createdAt": "2020-07-02T06:56:51Z", "author": {"login": "rhtyd"}, "path": "api/src/main/java/org/apache/cloudstack/api/ApiConstants.java", "diffHunk": "@@ -472,11 +473,16 @@\n     public static final String PROJECT = \"project\";\n     public static final String ROLE = \"role\";\n     public static final String ROLE_ID = \"roleid\";\n+    public static final String ACCOUNT_ROLE_TYPE = \"accountroletype\";\n+    public static final String PROJECT_ROLE_ID = \"projectroleid\";\n+    public static final String PROJECT_ROLE_NAME = \"projectrolename\";\n+    public static final String PROJECT_ROLE_TYPE = \"projectroletype\";\n     public static final String ROLE_TYPE = \"roletype\";\n     public static final String ROLE_NAME = \"rolename\";\n     public static final String PERMISSION = \"permission\";\n     public static final String RULE = \"rule\";\n     public static final String RULE_ID = \"ruleid\";\n+    public static final String PROJECT_RULE_ID = \"projectruleid\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1bf01884d12b6ba9a94fe817013707325c7b8c2"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMzk3ODIx", "url": "https://github.com/apache/cloudstack/pull/4128#pullrequestreview-441397821", "createdAt": "2020-07-02T06:57:34Z", "commit": {"oid": "c1bf01884d12b6ba9a94fe817013707325c7b8c2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNjo1NzozNFrOGr_0lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNjo1NzozNFrOGr_0lQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4NzYwNQ==", "bodyText": "Could this cause any exception; maybe return empty array instead or null?", "url": "https://github.com/apache/cloudstack/pull/4128#discussion_r448787605", "createdAt": "2020-07-02T06:57:34Z", "author": {"login": "rhtyd"}, "path": "api/src/main/java/org/apache/cloudstack/api/BaseCmd.java", "diffHunk": "@@ -264,6 +269,10 @@ public String getActualCommandName() {\n      */\n     public abstract long getEntityOwnerId();\n \n+    public List<Long> getEntityOwnerIds() {\n+        return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1bf01884d12b6ba9a94fe817013707325c7b8c2"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMzk5NTM0", "url": "https://github.com/apache/cloudstack/pull/4128#pullrequestreview-441399534", "createdAt": "2020-07-02T07:00:29Z", "commit": {"oid": "c1bf01884d12b6ba9a94fe817013707325c7b8c2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNzowMDoyOVrOGr_5vQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNzowMDoyOVrOGr_5vQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4ODkyNQ==", "bodyText": "@Pearl1594 can you add a Strings.isNullOrEmpty here", "url": "https://github.com/apache/cloudstack/pull/4128#discussion_r448788925", "createdAt": "2020-07-02T07:00:29Z", "author": {"login": "rhtyd"}, "path": "engine/schema/src/main/java/org/apache/cloudstack/acl/dao/ProjectRoleDaoImpl.java", "diffHunk": "@@ -0,0 +1,58 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.cloudstack.acl.dao;\n+\n+import java.util.List;\n+\n+import org.apache.cloudstack.acl.ProjectRoleVO;\n+\n+import com.cloud.utils.db.GenericDaoBase;\n+import com.cloud.utils.db.SearchBuilder;\n+import com.cloud.utils.db.SearchCriteria;\n+\n+public class ProjectRoleDaoImpl extends GenericDaoBase<ProjectRoleVO, Long>  implements ProjectRoleDao{\n+    private final SearchBuilder<ProjectRoleVO>  ProjectRoleSearch;\n+\n+    public ProjectRoleDaoImpl() {\n+        super();\n+\n+        ProjectRoleSearch = createSearchBuilder();\n+        ProjectRoleSearch.and(\"name\", ProjectRoleSearch.entity().getName(), SearchCriteria.Op.LIKE);\n+        ProjectRoleSearch.and(\"project_id\", ProjectRoleSearch.entity().getProjectId(), SearchCriteria.Op.EQ);\n+        ProjectRoleSearch.done();\n+\n+    }\n+    @Override\n+    public List<ProjectRoleVO> findByName(String name, Long projectId) {\n+        SearchCriteria<ProjectRoleVO> sc = ProjectRoleSearch.create();\n+        sc.setParameters(\"name\", \"%\" + name + \"%\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1bf01884d12b6ba9a94fe817013707325c7b8c2"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d719c81efb732296eab4c641c2c33866efd47bb7", "author": {"user": {"login": "sureshanaparti", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/d719c81efb732296eab4c641c2c33866efd47bb7", "committedDate": "2020-07-02T08:39:32Z", "message": "Dynamic roles improvements. Add-on functionality below.\n\n- Create a role from any of the existing role, using new parameter roleid in createRole API\n- Import a role with its rules, using a new importRole API\n- New default roles for Read-Only and Support Admin & User\n- No modifications allowed for Default roles\n\n- Cleaned up old NetApp APIs from role_permissions table."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e73a91b35876756421087ca45db9a5109f4e847", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/3e73a91b35876756421087ca45db9a5109f4e847", "committedDate": "2020-07-03T04:48:34Z", "message": "Review comments addressed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "980de0d84b23e492a9e3a8fe180104577749cd19", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/980de0d84b23e492a9e3a8fe180104577749cd19", "committedDate": "2020-07-03T05:44:17Z", "message": "Merge branch 'cs-dynamic-roles-improvements' of github.com:shapeblue/cloudstack into proj-roleBased-users"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "497d72d5966d0fb1c8efaf35080fa1a415fddefe", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/497d72d5966d0fb1c8efaf35080fa1a415fddefe", "committedDate": "2020-07-03T10:08:42Z", "message": "Merge dynamic role feature & resolve conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a531d29f74bd33a91be03108c1db1b9621789cf", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/8a531d29f74bd33a91be03108c1db1b9621789cf", "committedDate": "2020-07-06T14:56:36Z", "message": "add user access check to projects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "984502b84b9c438c3695dc6f4ce57f3616a59922", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/984502b84b9c438c3695dc6f4ce57f3616a59922", "committedDate": "2020-07-07T08:01:46Z", "message": "Merge branch 'master' of github.com:shapeblue/cloudstack into proj-roleBased-users"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzODIzODU3", "url": "https://github.com/apache/cloudstack/pull/4128#pullrequestreview-443823857", "createdAt": "2020-07-07T12:03:58Z", "commit": {"oid": "984502b84b9c438c3695dc6f4ce57f3616a59922"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MDA3MTU2", "url": "https://github.com/apache/cloudstack/pull/4128#pullrequestreview-444007156", "createdAt": "2020-07-07T15:30:16Z", "commit": {"oid": "984502b84b9c438c3695dc6f4ce57f3616a59922"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNTozMDoxNlrOGuEDrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMjoxMjoxNlrOGuRbeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk1NDE1Nw==", "bodyText": "+1 verified", "url": "https://github.com/apache/cloudstack/pull/4128#discussion_r450954157", "createdAt": "2020-07-07T15:30:16Z", "author": {"login": "nvazquez"}, "path": "api/src/main/java/org/apache/cloudstack/api/BaseCmd.java", "diffHunk": "@@ -264,6 +269,10 @@ public String getActualCommandName() {\n      */\n     public abstract long getEntityOwnerId();\n \n+    public List<Long> getEntityOwnerIds() {\n+        return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4NzYwNQ=="}, "originalCommit": {"oid": "c1bf01884d12b6ba9a94fe817013707325c7b8c2"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk1NDg1Nw==", "bodyText": "Minor one: this can be written in one line", "url": "https://github.com/apache/cloudstack/pull/4128#discussion_r450954857", "createdAt": "2020-07-07T15:31:17Z", "author": {"login": "nvazquez"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/user/project/UpdateProjectCmd.java", "diffHunk": "@@ -68,11 +89,49 @@ public String getDisplayText() {\n         return displayText;\n     }\n \n+    public Long getUserId() {\n+        return userId;\n+    }\n+\n+    public Long getDomainId() {\n+        if (domainId != null) {\n+            return domainId;\n+        }\n+        return CallContext.current().getCallingAccount().getDomainId();\n+    }\n+\n+    public ProjectAccount.Role getRoleType(String role) {\n+        String type = role.substring(0, 1).toUpperCase() + role.substring(1).toLowerCase();\n+        if (!EnumUtils.isValidEnum(ProjectAccount.Role.class, type)) {\n+            throw new InvalidParameterValueException(\"Only Admin or Regular project role types are valid\");\n+        }\n+        return Enum.valueOf(ProjectAccount.Role.class, type);\n+    }\n+\n+    public ProjectAccount.Role getAccountRole() {\n+        if (roleType != null) {\n+            return getRoleType(roleType);\n+        }\n+        return ProjectAccount.Role.Regular;\n+    }\n+\n+    public Long getAccountId() {\n+        return accountId;\n+    }\n+\n     @Override\n     public String getCommandName() {\n         return s_name;\n     }\n \n+    public Boolean isSwapOwner() {\n+        if (swapOwner != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "984502b84b9c438c3695dc6f4ce57f3616a59922"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE1NDYyMw==", "bodyText": "May I suggest StringUtils.isNotBlank(roleType) here? It checks for null and empty cases", "url": "https://github.com/apache/cloudstack/pull/4128#discussion_r451154623", "createdAt": "2020-07-07T21:29:42Z", "author": {"login": "nvazquez"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/user/account/AddAccountToProjectCmd.java", "diffHunk": "@@ -72,6 +87,21 @@ public String getEmail() {\n         return email;\n     }\n \n+    public Long getProjectRoleId() {\n+        return projectRoleId;\n+    }\n+\n+    public ProjectAccount.Role getRoleType() {\n+        if (roleType != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "984502b84b9c438c3695dc6f4ce57f3616a59922"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE1NDkzNA==", "bodyText": "Same as above", "url": "https://github.com/apache/cloudstack/pull/4128#discussion_r451154934", "createdAt": "2020-07-07T21:30:22Z", "author": {"login": "nvazquez"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/user/account/AddUserToProjectCmd.java", "diffHunk": "@@ -0,0 +1,154 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.cloudstack.api.command.user.account;\n+\n+import org.apache.cloudstack.acl.RoleType;\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiArgValidator;\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.ApiErrorCode;\n+import org.apache.cloudstack.api.BaseAsyncCmd;\n+import org.apache.cloudstack.api.BaseCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.ServerApiException;\n+import org.apache.cloudstack.api.response.ProjectResponse;\n+import org.apache.cloudstack.api.response.ProjectRoleResponse;\n+import org.apache.cloudstack.api.response.SuccessResponse;\n+import org.apache.cloudstack.api.response.UserResponse;\n+import org.apache.cloudstack.context.CallContext;\n+import org.apache.commons.lang3.EnumUtils;\n+\n+import com.cloud.event.EventTypes;\n+import com.cloud.exception.InvalidParameterValueException;\n+import com.cloud.projects.ProjectAccount;\n+\n+@APICommand(name = AddUserToProjectCmd.APINAME, description = \"Adds user to a project\", responseObject = SuccessResponse.class, since = \"4.14\",\n+        requestHasSensitiveInfo = false, responseHasSensitiveInfo = false, authorized = {RoleType.Admin, RoleType.DomainAdmin, RoleType.ResourceAdmin, RoleType.User})\n+public class AddUserToProjectCmd extends BaseAsyncCmd {\n+    public static final String APINAME = \"addUserToProject\";\n+\n+    /////////////////////////////////////////////////////\n+    //////////////// API parameters /////////////////////\n+    /////////////////////////////////////////////////////\n+\n+    @Parameter(name = ApiConstants.PROJECT_ID,\n+            type = BaseCmd.CommandType.UUID,\n+            entityType = ProjectResponse.class,\n+            required = true,\n+            description = \"ID of the project to add the user to\")\n+    private Long projectId;\n+\n+    @Parameter(name = ApiConstants.USER_ID, type = BaseCmd.CommandType.UUID, entityType = UserResponse.class,\n+            description = \"User UUID, required for adding account from external provisioning system\")\n+    private Long userId;\n+\n+    @Parameter(name = ApiConstants.EMAIL, type = CommandType.STRING, description = \"email ID of user to which invitation to the project is going to be sent\")\n+    private String email;\n+\n+    @Parameter(name = ApiConstants.PROJECT_ROLE_ID, type = BaseCmd.CommandType.UUID, entityType = ProjectRoleResponse.class,\n+            description = \"ID of the project role\", validations = {ApiArgValidator.PositiveNumber})\n+    private Long projectRoleId;\n+\n+    @Parameter(name = ApiConstants.ROLE_TYPE, type = BaseCmd.CommandType.STRING,\n+            description = \"Project role type to be assigned to the user - Admin/Regular\")\n+    private String roleType;\n+\n+    /////////////////////////////////////////////////////\n+    /////////////////// Accessors ///////////////////////\n+    /////////////////////////////////////////////////////\n+\n+    public Long getProjectId() {\n+        return projectId;\n+    }\n+\n+    public Long getUserId() {\n+        return userId;\n+    }\n+\n+    public String getEmail() { return email; }\n+\n+    public Long getProjectRoleId() {\n+        return projectRoleId;\n+    }\n+\n+    public ProjectAccount.Role getRoleType() {\n+        if (roleType != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "984502b84b9c438c3695dc6f4ce57f3616a59922"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE1NTcxMg==", "bodyText": "Same", "url": "https://github.com/apache/cloudstack/pull/4128#discussion_r451155712", "createdAt": "2020-07-07T21:31:57Z", "author": {"login": "nvazquez"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/user/project/UpdateProjectCmd.java", "diffHunk": "@@ -68,11 +89,49 @@ public String getDisplayText() {\n         return displayText;\n     }\n \n+    public Long getUserId() {\n+        return userId;\n+    }\n+\n+    public Long getDomainId() {\n+        if (domainId != null) {\n+            return domainId;\n+        }\n+        return CallContext.current().getCallingAccount().getDomainId();\n+    }\n+\n+    public ProjectAccount.Role getRoleType(String role) {\n+        String type = role.substring(0, 1).toUpperCase() + role.substring(1).toLowerCase();\n+        if (!EnumUtils.isValidEnum(ProjectAccount.Role.class, type)) {\n+            throw new InvalidParameterValueException(\"Only Admin or Regular project role types are valid\");\n+        }\n+        return Enum.valueOf(ProjectAccount.Role.class, type);\n+    }\n+\n+    public ProjectAccount.Role getAccountRole() {\n+        if (roleType != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "984502b84b9c438c3695dc6f4ce57f3616a59922"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE1NjUzMA==", "bodyText": "If the second condition is not missing any other condition, then parenthesis can be removed", "url": "https://github.com/apache/cloudstack/pull/4128#discussion_r451156530", "createdAt": "2020-07-07T21:33:39Z", "author": {"login": "nvazquez"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/user/project/UpdateProjectCmd.java", "diffHunk": "@@ -84,14 +143,38 @@ public long getEntityOwnerId() {\n         return _projectService.getProjectOwner(id).getId();\n     }\n \n+    @Override\n+    public List<Long> getEntityOwnerIds() {\n+        return _projectService.getProjectOwners(id);\n+    }\n+\n     /////////////////////////////////////////////////////\n     /////////////// API Implementation///////////////////\n     /////////////////////////////////////////////////////\n \n     @Override\n     public void execute() throws ResourceAllocationException {\n         CallContext.current().setEventDetails(\"Project id: \" + getId());\n-        Project project = _projectService.updateProject(getId(), getDisplayText(), getAccountName());\n+        if (getAccountName() != null && (getUserId() != null)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "984502b84b9c438c3695dc6f4ce57f3616a59922"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE2NDEwMg==", "bodyText": "Please consider keeping the method's bodies on new lines", "url": "https://github.com/apache/cloudstack/pull/4128#discussion_r451164102", "createdAt": "2020-07-07T21:50:16Z", "author": {"login": "nvazquez"}, "path": "engine/schema/src/main/java/org/apache/cloudstack/acl/ProjectRolePermissionVO.java", "diffHunk": "@@ -0,0 +1,66 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.cloudstack.acl;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.Table;\n+\n+@Entity\n+@Table(name = \"project_role_permissions\")\n+public class ProjectRolePermissionVO extends RolePermissionBaseVO implements ProjectRolePermission {\n+\n+    @Column(name = \"project_id\")\n+    private long projectId;\n+\n+    @Column(name = \"project_role_id\")\n+    private long projectRoleId;\n+\n+    @Column(name = \"sort_order\")\n+    private long sortOrder = 0;\n+\n+    public ProjectRolePermissionVO() { super(); }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "984502b84b9c438c3695dc6f4ce57f3616a59922"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3MzI0MQ==", "bodyText": "Why is this required after deletion?", "url": "https://github.com/apache/cloudstack/pull/4128#discussion_r451173241", "createdAt": "2020-07-07T22:12:16Z", "author": {"login": "nvazquez"}, "path": "server/src/main/java/org/apache/cloudstack/acl/ProjectRoleManagerImpl.java", "diffHunk": "@@ -0,0 +1,308 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.cloudstack.acl;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.cloudstack.acl.dao.ProjectRoleDao;\n+import org.apache.cloudstack.acl.dao.ProjectRolePermissionsDao;\n+import org.apache.cloudstack.acl.RolePermissionEntity.Permission;\n+import org.apache.cloudstack.api.command.admin.acl.project.CreateProjectRoleCmd;\n+import org.apache.cloudstack.api.command.admin.acl.project.CreateProjectRolePermissionCmd;\n+import org.apache.cloudstack.api.command.admin.acl.project.DeleteProjectRoleCmd;\n+import org.apache.cloudstack.api.command.admin.acl.project.DeleteProjectRolePermissionCmd;\n+import org.apache.cloudstack.api.command.admin.acl.project.ListProjectRolePermissionsCmd;\n+import org.apache.cloudstack.api.command.admin.acl.project.ListProjectRolesCmd;\n+import org.apache.cloudstack.api.command.admin.acl.project.UpdateProjectRoleCmd;\n+import org.apache.cloudstack.api.command.admin.acl.project.UpdateProjectRolePermissionCmd;\n+import org.apache.cloudstack.context.CallContext;\n+import org.apache.commons.lang3.StringUtils;\n+import org.apache.log4j.Logger;\n+\n+import com.cloud.event.ActionEvent;\n+import com.cloud.event.EventTypes;\n+import com.cloud.exception.PermissionDeniedException;\n+import com.cloud.projects.Project;\n+import com.cloud.projects.ProjectAccount;\n+import com.cloud.projects.dao.ProjectAccountDao;\n+import com.cloud.projects.dao.ProjectDao;\n+import com.cloud.user.Account;\n+import com.cloud.user.User;\n+import com.cloud.user.dao.AccountDao;\n+import com.cloud.utils.ListUtils;\n+import com.cloud.utils.component.ManagerBase;\n+import com.cloud.utils.component.PluggableService;\n+import com.cloud.utils.db.Transaction;\n+import com.cloud.utils.db.TransactionCallback;\n+import com.cloud.utils.db.TransactionStatus;\n+import com.cloud.utils.exception.CloudRuntimeException;\n+import com.google.common.base.Strings;\n+\n+public class ProjectRoleManagerImpl extends ManagerBase implements ProjectRoleService, PluggableService {\n+    @Inject\n+    ProjectAccountDao projAccDao;\n+    @Inject\n+    ProjectRoleDao projRoleDao;\n+    @Inject\n+    ProjectDao projectDao;\n+    @Inject\n+    AccountDao accountDao;\n+    @Inject\n+    ProjectRolePermissionsDao projRolePermissionsDao;\n+\n+    private static final Logger LOGGER = Logger.getLogger(ProjectRoleManagerImpl.class);\n+\n+    private Project validateProjectId(Long projectId) {\n+        Project project = projectDao.findById(projectId);\n+        if (project == null) {\n+            throw new CloudRuntimeException(\"Invalid project id provided\");\n+        }\n+        return project;\n+    }\n+\n+    private void checkAccess(Long projectId) {\n+        Project project = validateProjectId(projectId);\n+        CallContext.current().setProject(project);\n+\n+        if (!isEnabled()) {\n+            throw new PermissionDeniedException(\"Dynamic api checker is not enabled, aborting role operation\");\n+        }\n+\n+        User user = getCurrentUser();\n+        Account callerAcc = accountDao.findById(user.getAccountId());\n+\n+        if (callerAcc == null || callerAcc.getRoleId() == null) {\n+            throw new PermissionDeniedException(\"Restricted API called by an invalid user account\");\n+        }\n+\n+        ProjectAccount projectAccount = projAccDao.findByProjectIdUserId(projectId, callerAcc.getAccountId(), user.getId());\n+        if (projectAccount == null) {\n+            projectAccount = projAccDao.findByProjectIdAccountId(projectId, callerAcc.getAccountId());\n+            if (projectAccount == null) {\n+                throw new PermissionDeniedException(\"User/Account not part of project\");\n+            }\n+        }\n+        if (ProjectAccount.Role.Admin != projectAccount.getAccountRole()) {\n+            throw new PermissionDeniedException(\"User unauthorized to perform operation in the project\");\n+        }\n+    }\n+\n+    @Override\n+    @ActionEvent(eventType = EventTypes.EVENT_PROJECT_ROLE_CREATE, eventDescription = \"creating Project Role\")\n+    public ProjectRole createProjectRole(Long projectId, String name, String description) {\n+        checkAccess(projectId);\n+        return Transaction.execute(new TransactionCallback<ProjectRoleVO>() {\n+            @Override\n+            public ProjectRoleVO doInTransaction(TransactionStatus status) {\n+                return projRoleDao.persist(new ProjectRoleVO(name, description, projectId));\n+            }\n+        });\n+    }\n+\n+    @Override\n+    @ActionEvent(eventType = EventTypes.EVENT_PROJECT_ROLE_UPDATE, eventDescription = \"updating Project Role\")\n+    public ProjectRole updateProjectRole(ProjectRole role, Long projectId, String name, String description) {\n+        checkAccess(projectId);\n+        ProjectRoleVO projectRoleVO = (ProjectRoleVO) role;\n+        if (!Strings.isNullOrEmpty(name)) {\n+            projectRoleVO.setName(name);\n+        }\n+        if (!Strings.isNullOrEmpty(description)) {\n+            projectRoleVO.setDescription(description);\n+        }\n+        projRoleDao.update(role.getId(), projectRoleVO);\n+        return projectRoleVO;\n+    }\n+\n+    @Override\n+    public boolean isEnabled() {\n+        return RoleService.EnableDynamicApiChecker.value();\n+    }\n+\n+    @Override\n+    public ProjectRole findProjectRole(Long roleId, Long projectId) {\n+        if (projectId == null || projectId < 1L || projectDao.findById(projectId) == null) {\n+            LOGGER.warn(\"Invalid project ID provided\");\n+            return null;\n+        }\n+\n+        if (roleId != null && roleId < 1L) {\n+            LOGGER.warn(String.format(\"Project Role ID is invalid [%s]\", roleId));\n+            return null;\n+        }\n+\n+        ProjectRoleVO role = projRoleDao.findById(roleId);\n+        if (role == null) {\n+            LOGGER.warn(String.format(\"Project Role not found [id=%s]\", roleId));\n+            return null;\n+        }\n+        if (!(role.getProjectId().equals(projectId))) {\n+            LOGGER.warn(String.format(\"Project role : %s doesn't belong to the project\" + role.getName()));\n+            return null;\n+        }\n+        return role;\n+    }\n+\n+    @Override\n+    public List<ProjectRole> findProjectRoles(Long projectId) {\n+        if (projectId == null || projectId < 1L || projectDao.findById(projectId) == null) {\n+            LOGGER.warn(\"Invalid project ID provided\");\n+            return null;\n+        }\n+        return ListUtils.toListOfInterface(projRoleDao.findAllRoles(projectId));\n+    }\n+\n+    @Override\n+    @ActionEvent(eventType = EventTypes.EVENT_PROJECT_ROLE_PERMISSION_CREATE, eventDescription = \"Creating Project Role Permission\")\n+    public ProjectRolePermission createProjectRolePermission(CreateProjectRolePermissionCmd cmd) {\n+        Long projectId = cmd.getProjectId();\n+        Long projectRoleId = cmd.getProjectRoleId();\n+        Rule rule = cmd.getRule();\n+        Permission permission = cmd.getPermission();\n+        String description = cmd.getDescription();\n+        checkAccess(projectId);\n+        return Transaction.execute(new TransactionCallback<ProjectRolePermissionVO>() {\n+            @Override\n+            public ProjectRolePermissionVO doInTransaction(TransactionStatus status) {\n+                try {\n+                    return projRolePermissionsDao.persist(new ProjectRolePermissionVO(projectId, projectRoleId, rule.toString(), permission, description));\n+                } catch (Exception e) {\n+                    throw new CloudRuntimeException(\"Project role permission for \" + rule.toString()+ \" seems to already exist.\");\n+                }\n+            }\n+        });\n+    }\n+\n+    @Override\n+    @ActionEvent(eventType = EventTypes.EVENT_PROJECT_ROLE_PERMISSION_UPDATE, eventDescription = \"updating Project Role Permission order\")\n+    public boolean updateProjectRolePermission(Long projectId, ProjectRole projectRole, List<ProjectRolePermission> rolePermissionsOrder) {\n+        checkAccess(projectId);\n+        return projectRole != null && rolePermissionsOrder != null && projRolePermissionsDao.update(projectRole, projectId, rolePermissionsOrder);\n+\n+    }\n+\n+    @Override\n+    @ActionEvent(eventType = EventTypes.EVENT_PROJECT_ROLE_PERMISSION_UPDATE, eventDescription = \"updating Project Role Permission\")\n+    public boolean updateProjectRolePermission(Long projectId, ProjectRole projectRole, ProjectRolePermission projectRolePermission, Permission newPermission) {\n+        checkAccess(projectId);\n+        return projectRole != null && projRolePermissionsDao.update(projectRole, projectRolePermission, newPermission);\n+    }\n+\n+    @Override\n+    public ProjectRolePermission findProjectRolePermission(Long projRolePermissionId) {\n+        if (projRolePermissionId == null) {\n+            return null;\n+        }\n+        return projRolePermissionsDao.findById(projRolePermissionId);\n+    }\n+\n+    @Override\n+    @ActionEvent(eventType = EventTypes.EVENT_PROJECT_ROLE_PERMISSION_DELETE, eventDescription = \"deleting Project Role Permission\")\n+    public boolean deleteProjectRolePermission(ProjectRolePermission projectRolePermission) {\n+        checkAccess(projectRolePermission.getProjectId());\n+        return projRolePermissionsDao.remove(projectRolePermission.getId());\n+    }\n+\n+    @Override\n+    public List<ProjectRolePermission> findAllProjectRolePermissions(Long projectId, Long projectRoleId) {\n+        List<? extends ProjectRolePermission> permissions = projRolePermissionsDao.findAllByRoleIdSorted(projectRoleId, projectId);\n+        if (permissions != null) {\n+            return new ArrayList<>(permissions);\n+        }\n+        return Collections.emptyList();\n+    }\n+\n+    @Override\n+    public List<ProjectRole> findProjectRolesByName(Long projectId, String roleName) {\n+        List<? extends ProjectRole> roles = null;\n+        if (StringUtils.isNotBlank(roleName)) {\n+            roles = projRoleDao.findByName(roleName, projectId);\n+        }\n+        return ListUtils.toListOfInterface(roles);\n+    }\n+\n+    @Override\n+    @ActionEvent(eventType = EventTypes.EVENT_PROJECT_ROLE_DELETE, eventDescription = \"deleting Project Role\")\n+    public boolean deleteProjectRole(ProjectRole role, Long projectId) {\n+        checkAccess(projectId);\n+        if (role == null) {\n+            return false;\n+        }\n+\n+        Long roleProjectId = role.getProjectId();\n+        if (role.getProjectId() != null && !roleProjectId.equals(projectId)) {\n+            throw new PermissionDeniedException(\"Not authorized to delete the given project role\");\n+        }\n+\n+        List<? extends ProjectAccount> users = projAccDao.listUsersOrAccountsByRole(role.getId());\n+        if (users != null && users.size() != 0) {\n+            throw new PermissionDeniedException(\"Found users that have the project role in use, cannot delete the Project Role\");\n+        }\n+        return Transaction.execute(new TransactionCallback<Boolean>() {\n+            @Override\n+            public Boolean doInTransaction(TransactionStatus status) {\n+                List<? extends ProjectRolePermission> rolePermissions = projRolePermissionsDao.findAllByRoleIdSorted(role.getId(), projectId);\n+                if (rolePermissions != null && !rolePermissions.isEmpty()) {\n+                    for (ProjectRolePermission rolePermission : rolePermissions) {\n+                        projRolePermissionsDao.remove(rolePermission.getId());\n+                    }\n+                }\n+                if (projRoleDao.remove(role.getId())) {\n+                    ProjectRoleVO projRoleVO = projRoleDao.findByIdIncludingRemoved(role.getId());\n+                    projRoleVO.setName(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "984502b84b9c438c3695dc6f4ce57f3616a59922"}, "originalPosition": 271}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c127a4655a672620d8be867b505ebe01e652e559", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/c127a4655a672620d8be867b505ebe01e652e559", "committedDate": "2020-07-08T03:09:38Z", "message": "Addressed Review comments : Null checks and code formating"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d797395d798df49ad0b88c102ed074b045ecd1b7", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/d797395d798df49ad0b88c102ed074b045ecd1b7", "committedDate": "2020-07-08T03:10:24Z", "message": "Merge branch 'master' of github.com:shapeblue/cloudstack into proj-roleBased-users"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fb52ea8d330a8728ff5159e023863907200d02b", "author": {"user": {"login": "Pearl1594", "name": "Pearl Dsilva"}}, "url": "https://github.com/apache/cloudstack/commit/5fb52ea8d330a8728ff5159e023863907200d02b", "committedDate": "2020-07-08T03:12:15Z", "message": "Merge branch 'master' into proj-roleBased-users"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea6e137c2d2327aef446079899500f903d73a422", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/ea6e137c2d2327aef446079899500f903d73a422", "committedDate": "2020-07-08T13:45:42Z", "message": "allow username to be taken as input for adding users to projects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f10982cca92c973265a0995fcb07971f61ecbc45", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/f10982cca92c973265a0995fcb07971f61ecbc45", "committedDate": "2020-07-08T16:46:12Z", "message": "Update marvin test with correct api parameters"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NjQ2ODU2", "url": "https://github.com/apache/cloudstack/pull/4128#pullrequestreview-445646856", "createdAt": "2020-07-09T14:02:25Z", "commit": {"oid": "f10982cca92c973265a0995fcb07971f61ecbc45"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5274bf72eeebac0c14c2e89849da822b94b23976", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/5274bf72eeebac0c14c2e89849da822b94b23976", "committedDate": "2020-07-09T17:06:50Z", "message": "Added additional fields to listProjects and listProjectAccounts api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48cf1cf4e513538b863fa87bee304b41d91346c3", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/48cf1cf4e513538b863fa87bee304b41d91346c3", "committedDate": "2020-07-21T15:09:09Z", "message": "Project roles to be applied to resources of a project"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41b0b5cb53bdf570d56419052cbbaabadc9b8838", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/41b0b5cb53bdf570d56419052cbbaabadc9b8838", "committedDate": "2020-07-22T15:02:25Z", "message": "restrict view of projects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "318b1c8d4f2a8aacf24c525a310d858f793383b2", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/318b1c8d4f2a8aacf24c525a310d858f793383b2", "committedDate": "2020-07-23T07:51:32Z", "message": "Handle verification of project roles when apikey is passed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1bf8c8e7b955d0d1eb6b9d15343c98f3879a1238", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/1bf8c8e7b955d0d1eb6b9d15343c98f3879a1238", "committedDate": "2020-07-23T06:31:07Z", "message": "Handle verification of project roles when apikey is passed"}, "afterCommit": {"oid": "318b1c8d4f2a8aacf24c525a310d858f793383b2", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/318b1c8d4f2a8aacf24c525a310d858f793383b2", "committedDate": "2020-07-23T07:51:32Z", "message": "Handle verification of project roles when apikey is passed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a979dd031c2883ca423c807d620ba9fbe3f48a31", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/a979dd031c2883ca423c807d620ba9fbe3f48a31", "committedDate": "2020-07-27T07:58:45Z", "message": "vague error message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "296e4bd9cff53033b161b903bfc64fb75e978818", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/296e4bd9cff53033b161b903bfc64fb75e978818", "committedDate": "2020-07-27T12:33:17Z", "message": "error message description consistency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5293c32f891b95c8ff87a2e6da1fc871f38fe9d7", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/5293c32f891b95c8ff87a2e6da1fc871f38fe9d7", "committedDate": "2020-07-28T07:47:32Z", "message": "Allow project roles with same names across projects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76fe592abc036ef49e599803e72caa78f21d43c8", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/76fe592abc036ef49e599803e72caa78f21d43c8", "committedDate": "2020-07-28T13:38:59Z", "message": "sql changes for upgrade path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0acfca1307addb9a1ce2f5172d162dc0e4f629a4", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/0acfca1307addb9a1ce2f5172d162dc0e4f629a4", "committedDate": "2020-07-30T07:03:27Z", "message": "Merge branch 'master' of https://github.com/apache/cloudstack into proj-roleBased-users"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MTY4MDM5", "url": "https://github.com/apache/cloudstack/pull/4128#pullrequestreview-458168039", "createdAt": "2020-07-30T07:56:31Z", "commit": {"oid": "0acfca1307addb9a1ce2f5172d162dc0e4f629a4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "826f2e71b424a18bea6ee5948bfc036dad3a65d1", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/826f2e71b424a18bea6ee5948bfc036dad3a65d1", "committedDate": "2020-08-10T04:05:49Z", "message": "Code refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6235d343a3a850a8a3377953e09f0525fcbee105", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/6235d343a3a850a8a3377953e09f0525fcbee105", "committedDate": "2020-08-10T04:06:11Z", "message": "Merge branch 'master' of https://github.com/apache/cloudstack into proj-roleBased-users"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MjY1NDMx", "url": "https://github.com/apache/cloudstack/pull/4128#pullrequestreview-464265431", "createdAt": "2020-08-10T14:12:48Z", "commit": {"oid": "6235d343a3a850a8a3377953e09f0525fcbee105"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDoxMjo0OFrOG-QUUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNDoxMjo0OFrOG-QUUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkzMjI0MA==", "bodyText": "this file is missing a license. either add it to the ignore list or add a license.", "url": "https://github.com/apache/cloudstack/pull/4128#discussion_r467932240", "createdAt": "2020-08-10T14:12:48Z", "author": {"login": "DaanHoogland"}, "path": "results.xml", "diffHunk": "@@ -0,0 +1,3 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?><testsuite name=\"nosetests\" tests=\"3\" errors=\"0\" failures=\"0\" skip=\"0\"><testcase classname=\"integration.smoke.test_enable_role_based_users_in_projects.TestRoleBasedUsersInProjects\" name=\"test_add_account_to_project_with_project_role\" time=\"3.046\"></testcase><testcase classname=\"integration.smoke.test_enable_role_based_users_in_projects.TestRoleBasedUsersInProjects\" name=\"test_add_multiple_admins_in_project\" time=\"6.491\"><system-out><![CDATA[pid == 3a16742f-819b-4d44-89d9-1f4122602038\n+2\n+]]></system-out></testcase><testcase classname=\"integration.smoke.test_enable_role_based_users_in_projects.TestRoleBasedUsersInProjects\" name=\"test_add_user_to_project_with_project_role\" time=\"2.713\"></testcase></testsuite>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6235d343a3a850a8a3377953e09f0525fcbee105"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95a6a4311dd59d95138bda38c5f4c98adc78f699", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/95a6a4311dd59d95138bda38c5f4c98adc78f699", "committedDate": "2020-08-10T14:19:36Z", "message": "remove results.xml file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "970acd0d09923c6d56ee8d27a9566f0504323a6b", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/970acd0d09923c6d56ee8d27a9566f0504323a6b", "committedDate": "2020-08-11T08:31:39Z", "message": "detailed description of api parameter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "581c3f2888abdc44258484acc75a3e4d869899f7", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/581c3f2888abdc44258484acc75a3e4d869899f7", "committedDate": "2020-08-11T08:29:17Z", "message": "detailed description of api parameter"}, "afterCommit": {"oid": "970acd0d09923c6d56ee8d27a9566f0504323a6b", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/970acd0d09923c6d56ee8d27a9566f0504323a6b", "committedDate": "2020-08-11T08:31:39Z", "message": "detailed description of api parameter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0ODY3MzIz", "url": "https://github.com/apache/cloudstack/pull/4128#pullrequestreview-464867323", "createdAt": "2020-08-11T08:45:17Z", "commit": {"oid": "970acd0d09923c6d56ee8d27a9566f0504323a6b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4342, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}