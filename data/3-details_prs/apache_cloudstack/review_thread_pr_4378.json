{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4MzMwNDEy", "number": 4378, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODoxNzoxMlrOEr8u1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0yN1QyMzoyMDoyNVrOGbLGdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NTE5MjU1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODoxNzoxMlrOHe_yXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxOToyMjoyMVrOHfWChQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI2NDQxMg==", "bodyText": "@ustcweizhou finding a suitable host anywhere within the zone might result in returning a host in a different pod or cluster. This might also need storage migration. Will that be an issue? Especially when VM is having data disks attached. Also, cross-cluster at present fails on VMware when storage pools are cluster scoped. #4385", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r502264412", "createdAt": "2020-10-09T08:17:12Z", "author": {"login": "shwstppr"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5627,6 +5629,50 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n \n         // check if migrating to same host\n         long srcHostId = vm.getHostId();\n+\n+        DeployDestination dest = null;\n+        if (destinationHost == null) {\n+            vm.setLastHostId(null); // Do not check last host\n+            final VirtualMachineProfile profile = new VirtualMachineProfileImpl(vm);\n+            final Host host = _hostDao.findById(srcHostId);\n+            final DataCenterDeployment plan = new DataCenterDeployment(host.getDataCenterId(), null, null, null, null, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37e570f9f10fd5e62569c69250fa18230d89c051"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjYyODk5Nw==", "bodyText": "@shwstppr you are right.\nI will refactor it.", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r502628997", "createdAt": "2020-10-09T19:22:21Z", "author": {"login": "weizhouapache"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5627,6 +5629,50 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n \n         // check if migrating to same host\n         long srcHostId = vm.getHostId();\n+\n+        DeployDestination dest = null;\n+        if (destinationHost == null) {\n+            vm.setLastHostId(null); // Do not check last host\n+            final VirtualMachineProfile profile = new VirtualMachineProfileImpl(vm);\n+            final Host host = _hostDao.findById(srcHostId);\n+            final DataCenterDeployment plan = new DataCenterDeployment(host.getDataCenterId(), null, null, null, null, null);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI2NDQxMg=="}, "originalCommit": {"oid": "37e570f9f10fd5e62569c69250fa18230d89c051"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzc1ODc1NDg3OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xNlQxMjo0MToyM1rOI3j7Lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xNlQxMjo0MToyM1rOI3j7Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTEzMTE4Mw==", "bodyText": "@weizhouapache do you need to remove this condition else either hostid or storageid must be provided", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595131183", "createdAt": "2021-03-16T12:41:23Z", "author": {"login": "shwstppr"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "diffHunk": "@@ -126,30 +126,30 @@ public void execute() {\n             throw new InvalidParameterValueException(\"Either hostId or storageId must be specified\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bdc324d860acfc074fa94707467f9131bdbc88a"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzc2Mjc3MTI0OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVMCmd.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xN1QwNjo1Njo0N1rOI4J-Kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xOFQwODo1MjoyMFrOI5BKKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc1NDUzOQ==", "bodyText": "@ustcweizhou whenever host / storage pool is not specified in the cmd, instead of directly picking a suitable dest host to migrate to, I think it is better to confirm it (from the user) through a API cmd param (something like chooseHost  / selectHost). If user is not OK to auto select host, then throw appropriate message.", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595754539", "createdAt": "2021-03-17T06:56:47Z", "author": {"login": "sureshanaparti"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVMCmd.java", "diffHunk": "@@ -169,9 +165,9 @@ public void execute() {\n \n         try {\n             VirtualMachine migratedVm = null;\n-            if (getHostId() != null) {\n+            if (getStoragePoolId() == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTgyNjMzMA==", "bodyText": "@sureshanaparti ok.\nwhat do you think if we regard hostid=-1 as autoselect ?", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595826330", "createdAt": "2021-03-17T09:01:02Z", "author": {"login": "weizhouapache"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVMCmd.java", "diffHunk": "@@ -169,9 +165,9 @@ public void execute() {\n \n         try {\n             VirtualMachine migratedVm = null;\n-            if (getHostId() != null) {\n+            if (getStoragePoolId() == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc1NDUzOQ=="}, "originalCommit": {"oid": "f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjY0NTY1NQ==", "bodyText": "@weizhouapache host id in the cmd is UUID, so i think it is better to take input from another param when host id is null. If host id is not null, ignore auto selection.", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r596645655", "createdAt": "2021-03-18T08:33:10Z", "author": {"login": "sureshanaparti"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVMCmd.java", "diffHunk": "@@ -169,9 +165,9 @@ public void execute() {\n \n         try {\n             VirtualMachine migratedVm = null;\n-            if (getHostId() != null) {\n+            if (getStoragePoolId() == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc1NDUzOQ=="}, "originalCommit": {"oid": "f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjY1ODczMA==", "bodyText": "@sureshanaparti yes, I am currently working on the coding, same as you said.\nps: cloudstack supports projectid=-1, so it is feasible to support hostid=-1 but it might have big impact on other apis.", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r596658730", "createdAt": "2021-03-18T08:52:20Z", "author": {"login": "weizhouapache"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVMCmd.java", "diffHunk": "@@ -169,9 +165,9 @@ public void execute() {\n \n         try {\n             VirtualMachine migratedVm = null;\n-            if (getHostId() != null) {\n+            if (getStoragePoolId() == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc1NDUzOQ=="}, "originalCommit": {"oid": "f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzc2Mjg3MjA5OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "isResolved": true, "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xN1QwNzoyOTo1MlrOI4K4Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xOFQwODoxMjo0MFrOI4_luw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc2OTQzNQ==", "bodyText": "@weizhouapache change added in UserVmManagerImpl to find suitable host is only for migrateVirtualMachine method while we call migrateVirtualMachineWithVolume\nCurrently we will get NPE on \n  \n    \n      cloudstack/server/src/main/java/com/cloud/vm/UserVmManagerImpl.java\n    \n    \n         Line 6289\n      in\n      f5aed32\n    \n    \n    \n    \n\n        \n          \n           if (destinationHost.getId() == srcHostId) {", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595769435", "createdAt": "2021-03-17T07:29:52Z", "author": {"login": "shwstppr"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "diffHunk": "@@ -122,34 +122,34 @@ public String getEventDescription() {\n \n     @Override\n     public void execute() {\n-        if (getHostId() == null && getStorageId() == null) {\n-            throw new InvalidParameterValueException(\"Either hostId or storageId must be specified\");\n-        }\n-\n         if (getHostId() != null && getStorageId() != null) {\n             throw new InvalidParameterValueException(\"Only one of hostId and storageId can be specified\");\n         }\n+\n         try {\n             //FIXME : Should not be calling UserVmService to migrate all types of VMs - need a generic VM layer\n             VirtualMachine migratedVm = null;\n-            if (getHostId() != null) {\n-                Host destinationHost = _resourceService.getHost(getHostId());\n-                if (destinationHost == null) {\n-                    throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n-                }\n-                if (destinationHost.getType() != Host.Type.Routing) {\n-                    throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n-                }\n-                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n-                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());\n-            } else if (getStorageId() != null) {\n+            if (getStorageId() != null) {\n                 // OfflineMigration performed when this parameter is specified\n                 StoragePool destStoragePool = _storageService.getStoragePool(getStorageId());\n                 if (destStoragePool == null) {\n                     throw new InvalidParameterValueException(\"Unable to find the storage pool to migrate the VM\");\n                 }\n                 CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to storage pool Id: \" + getStorageId());\n                 migratedVm = _userVmService.vmStorageMigration(getVirtualMachineId(), destStoragePool);\n+            } else {\n+                Host destinationHost = null;\n+                if (getHostId() != null) {\n+                    destinationHost =_resourceService.getHost(getHostId());\n+                    if (destinationHost == null) {\n+                        throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n+                    }\n+                    if (destinationHost.getType() != Host.Type.Routing) {\n+                        throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n+                    }\n+                }\n+                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n+                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTgwODQ4Mw==", "bodyText": "@shwstppr I will test it.", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595808483", "createdAt": "2021-03-17T08:36:02Z", "author": {"login": "weizhouapache"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "diffHunk": "@@ -122,34 +122,34 @@ public String getEventDescription() {\n \n     @Override\n     public void execute() {\n-        if (getHostId() == null && getStorageId() == null) {\n-            throw new InvalidParameterValueException(\"Either hostId or storageId must be specified\");\n-        }\n-\n         if (getHostId() != null && getStorageId() != null) {\n             throw new InvalidParameterValueException(\"Only one of hostId and storageId can be specified\");\n         }\n+\n         try {\n             //FIXME : Should not be calling UserVmService to migrate all types of VMs - need a generic VM layer\n             VirtualMachine migratedVm = null;\n-            if (getHostId() != null) {\n-                Host destinationHost = _resourceService.getHost(getHostId());\n-                if (destinationHost == null) {\n-                    throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n-                }\n-                if (destinationHost.getType() != Host.Type.Routing) {\n-                    throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n-                }\n-                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n-                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());\n-            } else if (getStorageId() != null) {\n+            if (getStorageId() != null) {\n                 // OfflineMigration performed when this parameter is specified\n                 StoragePool destStoragePool = _storageService.getStoragePool(getStorageId());\n                 if (destStoragePool == null) {\n                     throw new InvalidParameterValueException(\"Unable to find the storage pool to migrate the VM\");\n                 }\n                 CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to storage pool Id: \" + getStorageId());\n                 migratedVm = _userVmService.vmStorageMigration(getVirtualMachineId(), destStoragePool);\n+            } else {\n+                Host destinationHost = null;\n+                if (getHostId() != null) {\n+                    destinationHost =_resourceService.getHost(getHostId());\n+                    if (destinationHost == null) {\n+                        throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n+                    }\n+                    if (destinationHost.getType() != Host.Type.Routing) {\n+                        throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n+                    }\n+                }\n+                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n+                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc2OTQzNQ=="}, "originalCommit": {"oid": "f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTgwOTE1NA==", "bodyText": "@shwstppr I tested with 4.15. did not notice that we have some changes in master.\nhttps://github.com/apache/cloudstack/blob/4.15/api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java#L120", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595809154", "createdAt": "2021-03-17T08:37:06Z", "author": {"login": "weizhouapache"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "diffHunk": "@@ -122,34 +122,34 @@ public String getEventDescription() {\n \n     @Override\n     public void execute() {\n-        if (getHostId() == null && getStorageId() == null) {\n-            throw new InvalidParameterValueException(\"Either hostId or storageId must be specified\");\n-        }\n-\n         if (getHostId() != null && getStorageId() != null) {\n             throw new InvalidParameterValueException(\"Only one of hostId and storageId can be specified\");\n         }\n+\n         try {\n             //FIXME : Should not be calling UserVmService to migrate all types of VMs - need a generic VM layer\n             VirtualMachine migratedVm = null;\n-            if (getHostId() != null) {\n-                Host destinationHost = _resourceService.getHost(getHostId());\n-                if (destinationHost == null) {\n-                    throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n-                }\n-                if (destinationHost.getType() != Host.Type.Routing) {\n-                    throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n-                }\n-                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n-                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());\n-            } else if (getStorageId() != null) {\n+            if (getStorageId() != null) {\n                 // OfflineMigration performed when this parameter is specified\n                 StoragePool destStoragePool = _storageService.getStoragePool(getStorageId());\n                 if (destStoragePool == null) {\n                     throw new InvalidParameterValueException(\"Unable to find the storage pool to migrate the VM\");\n                 }\n                 CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to storage pool Id: \" + getStorageId());\n                 migratedVm = _userVmService.vmStorageMigration(getVirtualMachineId(), destStoragePool);\n+            } else {\n+                Host destinationHost = null;\n+                if (getHostId() != null) {\n+                    destinationHost =_resourceService.getHost(getHostId());\n+                    if (destinationHost == null) {\n+                        throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n+                    }\n+                    if (destinationHost.getType() != Host.Type.Routing) {\n+                        throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n+                    }\n+                }\n+                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n+                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc2OTQzNQ=="}, "originalCommit": {"oid": "f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTgzMDkwOA==", "bodyText": "@shwstppr I have a question to you, since you are the author of #4385.\nwhy we use different method in vm migration and systemvm migration ?\nMigrateSystemVMCmd.java: migrateVirtualMachineWithVolume and vmStorageMigration\nMigrateVMCmd.java: migrateVirtualMachine and vmStorageMigration\ncan they use same methods ?", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595830908", "createdAt": "2021-03-17T09:07:41Z", "author": {"login": "weizhouapache"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "diffHunk": "@@ -122,34 +122,34 @@ public String getEventDescription() {\n \n     @Override\n     public void execute() {\n-        if (getHostId() == null && getStorageId() == null) {\n-            throw new InvalidParameterValueException(\"Either hostId or storageId must be specified\");\n-        }\n-\n         if (getHostId() != null && getStorageId() != null) {\n             throw new InvalidParameterValueException(\"Only one of hostId and storageId can be specified\");\n         }\n+\n         try {\n             //FIXME : Should not be calling UserVmService to migrate all types of VMs - need a generic VM layer\n             VirtualMachine migratedVm = null;\n-            if (getHostId() != null) {\n-                Host destinationHost = _resourceService.getHost(getHostId());\n-                if (destinationHost == null) {\n-                    throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n-                }\n-                if (destinationHost.getType() != Host.Type.Routing) {\n-                    throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n-                }\n-                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n-                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());\n-            } else if (getStorageId() != null) {\n+            if (getStorageId() != null) {\n                 // OfflineMigration performed when this parameter is specified\n                 StoragePool destStoragePool = _storageService.getStoragePool(getStorageId());\n                 if (destStoragePool == null) {\n                     throw new InvalidParameterValueException(\"Unable to find the storage pool to migrate the VM\");\n                 }\n                 CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to storage pool Id: \" + getStorageId());\n                 migratedVm = _userVmService.vmStorageMigration(getVirtualMachineId(), destStoragePool);\n+            } else {\n+                Host destinationHost = null;\n+                if (getHostId() != null) {\n+                    destinationHost =_resourceService.getHost(getHostId());\n+                    if (destinationHost == null) {\n+                        throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n+                    }\n+                    if (destinationHost.getType() != Host.Type.Routing) {\n+                        throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n+                    }\n+                }\n+                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n+                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc2OTQzNQ=="}, "originalCommit": {"oid": "f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTg0MzAzMQ==", "bodyText": "@weizhouapache For user VMs we have two different APIs, migrateVirtualMachine and migrateVirtualMachineWithVolume. Depending on the need for storage migration requirement appropriate API can be used.\nWhile working on #4385 choice was to add a new API migrateSystemVmWithVolume or using migrateVirtualMachineWithVolume method while code making the decision if volume needs to be migrated.\nMigrateVMCmd can use the migrateVirtualMachineWithVolume method but it might need some additional checks and testing.", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595843031", "createdAt": "2021-03-17T09:24:02Z", "author": {"login": "shwstppr"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "diffHunk": "@@ -122,34 +122,34 @@ public String getEventDescription() {\n \n     @Override\n     public void execute() {\n-        if (getHostId() == null && getStorageId() == null) {\n-            throw new InvalidParameterValueException(\"Either hostId or storageId must be specified\");\n-        }\n-\n         if (getHostId() != null && getStorageId() != null) {\n             throw new InvalidParameterValueException(\"Only one of hostId and storageId can be specified\");\n         }\n+\n         try {\n             //FIXME : Should not be calling UserVmService to migrate all types of VMs - need a generic VM layer\n             VirtualMachine migratedVm = null;\n-            if (getHostId() != null) {\n-                Host destinationHost = _resourceService.getHost(getHostId());\n-                if (destinationHost == null) {\n-                    throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n-                }\n-                if (destinationHost.getType() != Host.Type.Routing) {\n-                    throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n-                }\n-                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n-                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());\n-            } else if (getStorageId() != null) {\n+            if (getStorageId() != null) {\n                 // OfflineMigration performed when this parameter is specified\n                 StoragePool destStoragePool = _storageService.getStoragePool(getStorageId());\n                 if (destStoragePool == null) {\n                     throw new InvalidParameterValueException(\"Unable to find the storage pool to migrate the VM\");\n                 }\n                 CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to storage pool Id: \" + getStorageId());\n                 migratedVm = _userVmService.vmStorageMigration(getVirtualMachineId(), destStoragePool);\n+            } else {\n+                Host destinationHost = null;\n+                if (getHostId() != null) {\n+                    destinationHost =_resourceService.getHost(getHostId());\n+                    if (destinationHost == null) {\n+                        throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n+                    }\n+                    if (destinationHost.getType() != Host.Type.Routing) {\n+                        throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n+                    }\n+                }\n+                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n+                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc2OTQzNQ=="}, "originalCommit": {"oid": "f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTkwNTY3NQ==", "bodyText": "@shwstppr we pass a empty hashmap in migrateVirtualMachineWithVolume , see below\nhttps://github.com/apache/cloudstack/blob/master/api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java#L144\nso systemvm migration actually works without volume ?\nI changed it back to 4.15, systemvm migration works\nhttps://github.com/apache/cloudstack/blob/4.15/api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java#L120", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595905675", "createdAt": "2021-03-17T10:49:30Z", "author": {"login": "weizhouapache"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "diffHunk": "@@ -122,34 +122,34 @@ public String getEventDescription() {\n \n     @Override\n     public void execute() {\n-        if (getHostId() == null && getStorageId() == null) {\n-            throw new InvalidParameterValueException(\"Either hostId or storageId must be specified\");\n-        }\n-\n         if (getHostId() != null && getStorageId() != null) {\n             throw new InvalidParameterValueException(\"Only one of hostId and storageId can be specified\");\n         }\n+\n         try {\n             //FIXME : Should not be calling UserVmService to migrate all types of VMs - need a generic VM layer\n             VirtualMachine migratedVm = null;\n-            if (getHostId() != null) {\n-                Host destinationHost = _resourceService.getHost(getHostId());\n-                if (destinationHost == null) {\n-                    throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n-                }\n-                if (destinationHost.getType() != Host.Type.Routing) {\n-                    throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n-                }\n-                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n-                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());\n-            } else if (getStorageId() != null) {\n+            if (getStorageId() != null) {\n                 // OfflineMigration performed when this parameter is specified\n                 StoragePool destStoragePool = _storageService.getStoragePool(getStorageId());\n                 if (destStoragePool == null) {\n                     throw new InvalidParameterValueException(\"Unable to find the storage pool to migrate the VM\");\n                 }\n                 CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to storage pool Id: \" + getStorageId());\n                 migratedVm = _userVmService.vmStorageMigration(getVirtualMachineId(), destStoragePool);\n+            } else {\n+                Host destinationHost = null;\n+                if (getHostId() != null) {\n+                    destinationHost =_resourceService.getHost(getHostId());\n+                    if (destinationHost == null) {\n+                        throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n+                    }\n+                    if (destinationHost.getType() != Host.Type.Routing) {\n+                        throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n+                    }\n+                }\n+                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n+                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc2OTQzNQ=="}, "originalCommit": {"oid": "f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTkxMjI1Nw==", "bodyText": "@weizhouapache yes, we do pass empty volume-pool mapping to the method but later in the code, we  generate volume-pool mapping when needed (such as inter-cluster migration with cluster-scoped pools)\nMoving back to 4.15 code will definitely allow systemvm migration with changes from this PR but inter-cluster migration of systemvms would not work.", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595912257", "createdAt": "2021-03-17T10:59:22Z", "author": {"login": "shwstppr"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "diffHunk": "@@ -122,34 +122,34 @@ public String getEventDescription() {\n \n     @Override\n     public void execute() {\n-        if (getHostId() == null && getStorageId() == null) {\n-            throw new InvalidParameterValueException(\"Either hostId or storageId must be specified\");\n-        }\n-\n         if (getHostId() != null && getStorageId() != null) {\n             throw new InvalidParameterValueException(\"Only one of hostId and storageId can be specified\");\n         }\n+\n         try {\n             //FIXME : Should not be calling UserVmService to migrate all types of VMs - need a generic VM layer\n             VirtualMachine migratedVm = null;\n-            if (getHostId() != null) {\n-                Host destinationHost = _resourceService.getHost(getHostId());\n-                if (destinationHost == null) {\n-                    throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n-                }\n-                if (destinationHost.getType() != Host.Type.Routing) {\n-                    throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n-                }\n-                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n-                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());\n-            } else if (getStorageId() != null) {\n+            if (getStorageId() != null) {\n                 // OfflineMigration performed when this parameter is specified\n                 StoragePool destStoragePool = _storageService.getStoragePool(getStorageId());\n                 if (destStoragePool == null) {\n                     throw new InvalidParameterValueException(\"Unable to find the storage pool to migrate the VM\");\n                 }\n                 CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to storage pool Id: \" + getStorageId());\n                 migratedVm = _userVmService.vmStorageMigration(getVirtualMachineId(), destStoragePool);\n+            } else {\n+                Host destinationHost = null;\n+                if (getHostId() != null) {\n+                    destinationHost =_resourceService.getHost(getHostId());\n+                    if (destinationHost == null) {\n+                        throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n+                    }\n+                    if (destinationHost.getType() != Host.Type.Routing) {\n+                        throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n+                    }\n+                }\n+                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n+                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc2OTQzNQ=="}, "originalCommit": {"oid": "f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTk5MzQ0MQ==", "bodyText": "@shwstppr I was a bit confused.\nI will change to the following behavior: if hostid is not specified, then use migratevirtualmachine instead of migratevirtualmachinewithvolume. sounds ok ?", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595993441", "createdAt": "2021-03-17T13:02:39Z", "author": {"login": "weizhouapache"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "diffHunk": "@@ -122,34 +122,34 @@ public String getEventDescription() {\n \n     @Override\n     public void execute() {\n-        if (getHostId() == null && getStorageId() == null) {\n-            throw new InvalidParameterValueException(\"Either hostId or storageId must be specified\");\n-        }\n-\n         if (getHostId() != null && getStorageId() != null) {\n             throw new InvalidParameterValueException(\"Only one of hostId and storageId can be specified\");\n         }\n+\n         try {\n             //FIXME : Should not be calling UserVmService to migrate all types of VMs - need a generic VM layer\n             VirtualMachine migratedVm = null;\n-            if (getHostId() != null) {\n-                Host destinationHost = _resourceService.getHost(getHostId());\n-                if (destinationHost == null) {\n-                    throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n-                }\n-                if (destinationHost.getType() != Host.Type.Routing) {\n-                    throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n-                }\n-                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n-                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());\n-            } else if (getStorageId() != null) {\n+            if (getStorageId() != null) {\n                 // OfflineMigration performed when this parameter is specified\n                 StoragePool destStoragePool = _storageService.getStoragePool(getStorageId());\n                 if (destStoragePool == null) {\n                     throw new InvalidParameterValueException(\"Unable to find the storage pool to migrate the VM\");\n                 }\n                 CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to storage pool Id: \" + getStorageId());\n                 migratedVm = _userVmService.vmStorageMigration(getVirtualMachineId(), destStoragePool);\n+            } else {\n+                Host destinationHost = null;\n+                if (getHostId() != null) {\n+                    destinationHost =_resourceService.getHost(getHostId());\n+                    if (destinationHost == null) {\n+                        throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n+                    }\n+                    if (destinationHost.getType() != Host.Type.Routing) {\n+                        throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n+                    }\n+                }\n+                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n+                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc2OTQzNQ=="}, "originalCommit": {"oid": "f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjYzMzAxOQ==", "bodyText": "@weizhouapache Yes, works fine in that case. Tested,\n(localcloud) SBCM5> > migrate systemvm virtualmachineid=c3737243-93b2-4369-bf60-08ac217e3465\n{\n  \"systemvm\": {\n    \"agentstate\": \"Up\",\n    \"created\": \"2021-03-16T11:22:18+0000\",\n    \"dns1\": \"10.0.32.1\",\n    \"dns2\": \"8.8.8.8\",\n    \"gateway\": \"10.0.48.1\",\n    \"hostid\": \"2e5b053f-539e-45c7-80f3-0fe3f0291c05\",\n    \"hostname\": \"10.0.33.141\",\n    \"hypervisor\": \"VMware\",\n    \"id\": \"c3737243-93b2-4369-bf60-08ac217e3465\",\n    \"linklocalmacaddress\": \"02:00:5e:cd:00:01\",\n    \"name\": \"s-1-VM\",\n    \"podid\": \"57382744-92f2-4610-a873-733de71eb142\",\n    \"podname\": \"Pod1\",\n    \"privateip\": \"10.0.36.123\",\n    \"privatemacaddress\": \"1e:00:47:00:00:17\",\n    \"privatenetmask\": \"255.255.240.0\",\n    \"publicip\": \"10.0.52.121\",\n    \"publicmacaddress\": \"1e:00:70:00:00:01\",\n    \"publicnetmask\": \"255.255.240.0\",\n    \"state\": \"Running\",\n    \"systemvmtype\": \"secondarystoragevm\",\n    \"templateid\": \"ff29ad45-6b1d-4c8e-aa6e-74f41b483134\",\n    \"templatename\": \"SystemVM Template (vSphere)\",\n    \"version\": \"4.16.0.0-SNAPSHOT\",\n    \"zoneid\": \"8f79f870-abc3-4d46-bb0e-cdb695ca45cd\",\n    \"zonename\": \"pr4378-t146-vmware-67u3\"\n  }\n}", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r596633019", "createdAt": "2021-03-18T08:12:40Z", "author": {"login": "shwstppr"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "diffHunk": "@@ -122,34 +122,34 @@ public String getEventDescription() {\n \n     @Override\n     public void execute() {\n-        if (getHostId() == null && getStorageId() == null) {\n-            throw new InvalidParameterValueException(\"Either hostId or storageId must be specified\");\n-        }\n-\n         if (getHostId() != null && getStorageId() != null) {\n             throw new InvalidParameterValueException(\"Only one of hostId and storageId can be specified\");\n         }\n+\n         try {\n             //FIXME : Should not be calling UserVmService to migrate all types of VMs - need a generic VM layer\n             VirtualMachine migratedVm = null;\n-            if (getHostId() != null) {\n-                Host destinationHost = _resourceService.getHost(getHostId());\n-                if (destinationHost == null) {\n-                    throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n-                }\n-                if (destinationHost.getType() != Host.Type.Routing) {\n-                    throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n-                }\n-                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n-                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());\n-            } else if (getStorageId() != null) {\n+            if (getStorageId() != null) {\n                 // OfflineMigration performed when this parameter is specified\n                 StoragePool destStoragePool = _storageService.getStoragePool(getStorageId());\n                 if (destStoragePool == null) {\n                     throw new InvalidParameterValueException(\"Unable to find the storage pool to migrate the VM\");\n                 }\n                 CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to storage pool Id: \" + getStorageId());\n                 migratedVm = _userVmService.vmStorageMigration(getVirtualMachineId(), destStoragePool);\n+            } else {\n+                Host destinationHost = null;\n+                if (getHostId() != null) {\n+                    destinationHost =_resourceService.getHost(getHostId());\n+                    if (destinationHost == null) {\n+                        throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n+                    }\n+                    if (destinationHost.getType() != Host.Type.Routing) {\n+                        throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n+                    }\n+                }\n+                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n+                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc2OTQzNQ=="}, "originalCommit": {"oid": "f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE2MDkwNTMxOnYy", "diffSide": "RIGHT", "path": "ui/src/views/compute/MigrateWizard.vue", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yMVQxMTozMjowNVrOJw8Lww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yMVQxMjowNzoxNVrOJw9emA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTI5NzQ3NQ==", "bodyText": "@weizhouapache do we need to add this string - autoselect in translation?", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r655297475", "createdAt": "2021-06-21T11:32:05Z", "author": {"login": "shwstppr"}, "path": "ui/src/views/compute/MigrateWizard.vue", "diffHunk": "@@ -168,6 +170,12 @@ export default {\n         this.hosts.sort((a, b) => {\n           return b.suitableformigration - a.suitableformigration\n         })\n+        for (const key in this.hosts) {\n+          if (this.hosts[key].suitableformigration && !this.hosts[key].requiresstoragemigration) {\n+            this.hosts.unshift({ id: -1, name: 'autoselect', suitableformigration: true, requiresstoragemigration: false })", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62a4886ea622773c8d7ef7d68b1cd6ab53152121"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTMxODY4MA==", "bodyText": "@shwstppr done.", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r655318680", "createdAt": "2021-06-21T12:07:15Z", "author": {"login": "weizhouapache"}, "path": "ui/src/views/compute/MigrateWizard.vue", "diffHunk": "@@ -168,6 +170,12 @@ export default {\n         this.hosts.sort((a, b) => {\n           return b.suitableformigration - a.suitableformigration\n         })\n+        for (const key in this.hosts) {\n+          if (this.hosts[key].suitableformigration && !this.hosts[key].requiresstoragemigration) {\n+            this.hosts.unshift({ id: -1, name: 'autoselect', suitableformigration: true, requiresstoragemigration: false })", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTI5NzQ3NQ=="}, "originalCommit": {"oid": "62a4886ea622773c8d7ef7d68b1cd6ab53152121"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE4MTk5NDE4OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVMCmd.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQwNzo0OTozMFrOJ0CiaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQwOToxNTo1MFrOJ0G7MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODU0NzMwNA==", "bodyText": "@weizhouapache just to check, auto select here picks the suitable host for VM migration. In the similar way, any possibility to pick suitable storage ? If so, can this API have both parameters: autoselecthost & autoselectstorage (only one of them should be true).", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r658547304", "createdAt": "2021-06-25T07:49:30Z", "author": {"login": "sureshanaparti"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVMCmd.java", "diffHunk": "@@ -155,6 +161,8 @@ public void execute() {\n                 throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n             }\n             CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n+        } else if (! isAutoSelect()) {\n+            throw new InvalidParameterValueException(\"Please specify a host or storage as destination, or pass 'autoselect=true' to automatically select a destination host which do not require storage migration\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a258544ca957d77077e0d3eb5caf54bb34d713d7"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYxOTE4NQ==", "bodyText": "@sureshanaparti\nthis pr works only if storage migraiotn is not required.\nit can be improved in a new pr.", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r658619185", "createdAt": "2021-06-25T09:15:50Z", "author": {"login": "weizhouapache"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVMCmd.java", "diffHunk": "@@ -155,6 +161,8 @@ public void execute() {\n                 throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n             }\n             CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n+        } else if (! isAutoSelect()) {\n+            throw new InvalidParameterValueException(\"Please specify a host or storage as destination, or pass 'autoselect=true' to automatically select a destination host which do not require storage migration\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODU0NzMwNA=="}, "originalCommit": {"oid": "a258544ca957d77077e0d3eb5caf54bb34d713d7"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE4Mjk2NDg0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQxMTozNjowNFrOJ0Lspw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQxMzoxODoxMVrOJ0PUPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODY5NzM4Mw==", "bodyText": "can you factor this out to a separate method, please", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r658697383", "createdAt": "2021-06-25T11:36:04Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5895,8 +5897,46 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Cannot migrate VM, host with id: \" + srcHostId + \" for VM not found\");\n         }\n \n+        DeployDestination dest = null;\n+        if (destinationHost == null) {\n+            vm.setLastHostId(null); // Last host does not have higher priority in vm migration\n+            final ServiceOfferingVO offering = _offeringDao.findById(vm.getId(), vm.getServiceOfferingId());\n+            final VirtualMachineProfile profile = new VirtualMachineProfileImpl(vm, null, offering, null, null);\n+            final Host host = _hostDao.findById(srcHostId);\n+            final DataCenterDeployment plan = new DataCenterDeployment(host.getDataCenterId(), host.getPodId(), host.getClusterId(), null, null, null);\n+            ExcludeList excludes = new ExcludeList();\n+            excludes.addHost(srcHostId);\n+            try {\n+                dest = _planningMgr.planDeployment(profile, plan, excludes, null);\n+            } catch (final AffinityConflictException e2) {\n+                s_logger.warn(\"Unable to create deployment, affinity rules associted to the VM conflict\", e2);\n+                throw new CloudRuntimeException(\"Unable to create deployment, affinity rules associted to the VM conflict\");\n+            } catch (final InsufficientServerCapacityException e3) {\n+                throw new CloudRuntimeException(\"Unable to find a server to migrate the vm to\");\n+            }\n+        } else {\n+            dest = checkVmMigrationDestination(vm, srcHost, destinationHost);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a258544ca957d77077e0d3eb5caf54bb34d713d7"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODc1NjY2OQ==", "bodyText": "@DaanHoogland done.", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r658756669", "createdAt": "2021-06-25T13:18:11Z", "author": {"login": "weizhouapache"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5895,8 +5897,46 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Cannot migrate VM, host with id: \" + srcHostId + \" for VM not found\");\n         }\n \n+        DeployDestination dest = null;\n+        if (destinationHost == null) {\n+            vm.setLastHostId(null); // Last host does not have higher priority in vm migration\n+            final ServiceOfferingVO offering = _offeringDao.findById(vm.getId(), vm.getServiceOfferingId());\n+            final VirtualMachineProfile profile = new VirtualMachineProfileImpl(vm, null, offering, null, null);\n+            final Host host = _hostDao.findById(srcHostId);\n+            final DataCenterDeployment plan = new DataCenterDeployment(host.getDataCenterId(), host.getPodId(), host.getClusterId(), null, null, null);\n+            ExcludeList excludes = new ExcludeList();\n+            excludes.addHost(srcHostId);\n+            try {\n+                dest = _planningMgr.planDeployment(profile, plan, excludes, null);\n+            } catch (final AffinityConflictException e2) {\n+                s_logger.warn(\"Unable to create deployment, affinity rules associted to the VM conflict\", e2);\n+                throw new CloudRuntimeException(\"Unable to create deployment, affinity rules associted to the VM conflict\");\n+            } catch (final InsufficientServerCapacityException e3) {\n+                throw new CloudRuntimeException(\"Unable to find a server to migrate the vm to\");\n+            }\n+        } else {\n+            dest = checkVmMigrationDestination(vm, srcHost, destinationHost);\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODY5NzM4Mw=="}, "originalCommit": {"oid": "a258544ca957d77077e0d3eb5caf54bb34d713d7"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDE4Mjk2Njg2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNi0yNVQxMTozNjozOFrOJ0Lt2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0wMlQxMDo1MToxN1rOJ4Nrew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODY5NzY4OQ==", "bodyText": "and this, please?", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r658697689", "createdAt": "2021-06-25T11:36:38Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5895,8 +5897,46 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Cannot migrate VM, host with id: \" + srcHostId + \" for VM not found\");\n         }\n \n+        DeployDestination dest = null;\n+        if (destinationHost == null) {\n+            vm.setLastHostId(null); // Last host does not have higher priority in vm migration\n+            final ServiceOfferingVO offering = _offeringDao.findById(vm.getId(), vm.getServiceOfferingId());\n+            final VirtualMachineProfile profile = new VirtualMachineProfileImpl(vm, null, offering, null, null);\n+            final Host host = _hostDao.findById(srcHostId);\n+            final DataCenterDeployment plan = new DataCenterDeployment(host.getDataCenterId(), host.getPodId(), host.getClusterId(), null, null, null);\n+            ExcludeList excludes = new ExcludeList();\n+            excludes.addHost(srcHostId);\n+            try {\n+                dest = _planningMgr.planDeployment(profile, plan, excludes, null);\n+            } catch (final AffinityConflictException e2) {\n+                s_logger.warn(\"Unable to create deployment, affinity rules associted to the VM conflict\", e2);\n+                throw new CloudRuntimeException(\"Unable to create deployment, affinity rules associted to the VM conflict\");\n+            } catch (final InsufficientServerCapacityException e3) {\n+                throw new CloudRuntimeException(\"Unable to find a server to migrate the vm to\");\n+            }\n+        } else {\n+            dest = checkVmMigrationDestination(vm, srcHost, destinationHost);\n+        }\n \n-        if (destinationHost.getId() == srcHostId) {\n+        // If no suitable destination found then throw exception\n+        if (dest == null) {\n+            throw new CloudRuntimeException(\"Unable to find suitable destination to migrate VM \" + vm.getInstanceName());\n+        }\n+\n+        UserVmVO uservm = _vmDao.findById(vmId);\n+        if (uservm != null) {\n+            collectVmDiskStatistics(uservm);\n+            collectVmNetworkStatistics(uservm);\n+        }\n+        _itMgr.migrate(vm.getUuid(), srcHostId, dest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a258544ca957d77077e0d3eb5caf54bb34d713d7"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODc1NjkxMw==", "bodyText": "@DaanHoogland\nwhich lines do you mean ?", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r658756913", "createdAt": "2021-06-25T13:18:36Z", "author": {"login": "weizhouapache"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5895,8 +5897,46 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Cannot migrate VM, host with id: \" + srcHostId + \" for VM not found\");\n         }\n \n+        DeployDestination dest = null;\n+        if (destinationHost == null) {\n+            vm.setLastHostId(null); // Last host does not have higher priority in vm migration\n+            final ServiceOfferingVO offering = _offeringDao.findById(vm.getId(), vm.getServiceOfferingId());\n+            final VirtualMachineProfile profile = new VirtualMachineProfileImpl(vm, null, offering, null, null);\n+            final Host host = _hostDao.findById(srcHostId);\n+            final DataCenterDeployment plan = new DataCenterDeployment(host.getDataCenterId(), host.getPodId(), host.getClusterId(), null, null, null);\n+            ExcludeList excludes = new ExcludeList();\n+            excludes.addHost(srcHostId);\n+            try {\n+                dest = _planningMgr.planDeployment(profile, plan, excludes, null);\n+            } catch (final AffinityConflictException e2) {\n+                s_logger.warn(\"Unable to create deployment, affinity rules associted to the VM conflict\", e2);\n+                throw new CloudRuntimeException(\"Unable to create deployment, affinity rules associted to the VM conflict\");\n+            } catch (final InsufficientServerCapacityException e3) {\n+                throw new CloudRuntimeException(\"Unable to find a server to migrate the vm to\");\n+            }\n+        } else {\n+            dest = checkVmMigrationDestination(vm, srcHost, destinationHost);\n+        }\n \n-        if (destinationHost.getId() == srcHostId) {\n+        // If no suitable destination found then throw exception\n+        if (dest == null) {\n+            throw new CloudRuntimeException(\"Unable to find suitable destination to migrate VM \" + vm.getInstanceName());\n+        }\n+\n+        UserVmVO uservm = _vmDao.findById(vmId);\n+        if (uservm != null) {\n+            collectVmDiskStatistics(uservm);\n+            collectVmNetworkStatistics(uservm);\n+        }\n+        _itMgr.migrate(vm.getUuid(), srcHostId, dest);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODY5NzY4OQ=="}, "originalCommit": {"oid": "a258544ca957d77077e0d3eb5caf54bb34d713d7"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjg2OTkwMw==", "bodyText": "sorry, this wasn't clear and also is far less interesting but you could\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    UserVmVO uservm = _vmDao.findById(vmId);\n          \n          \n            \n                    if (uservm != null) {\n          \n          \n            \n                        collectVmDiskStatistics(uservm);\n          \n          \n            \n                        collectVmNetworkStatistics(uservm);\n          \n          \n            \n                    }\n          \n          \n            \n                    _itMgr.migrate(vm.getUuid(), srcHostId, dest);\n          \n          \n            \n                private void collectStatisticsBeforeMigration(Long vmId)\n          \n          \n            \n                    UserVmVO uservm = _vmDao.findById(vmId);\n          \n          \n            \n                    if (uservm != null) {\n          \n          \n            \n                        collectVmDiskStatistics(uservm);\n          \n          \n            \n                        collectVmNetworkStatistics(uservm);\n          \n          \n            \n                    }\n          \n          \n            \n                }\n          \n      \n    \n    \n  \n\nor\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    UserVmVO uservm = _vmDao.findById(vmId);\n          \n          \n            \n                    if (uservm != null) {\n          \n          \n            \n                        collectVmDiskStatistics(uservm);\n          \n          \n            \n                        collectVmNetworkStatistics(uservm);\n          \n          \n            \n                    }\n          \n          \n            \n                    _itMgr.migrate(vm.getUuid(), srcHostId, dest);\n          \n          \n            \n                private void collectStatisticsAndMigrate(Long vmId)\n          \n          \n            \n                {\n          \n          \n            \n                    UserVmVO uservm = _vmDao.findById(vmId);\n          \n          \n            \n                    if (uservm != null) {\n          \n          \n            \n                        collectVmDiskStatistics(uservm);\n          \n          \n            \n                        collectVmNetworkStatistics(uservm);\n          \n          \n            \n                    }\n          \n          \n            \n                    _itMgr.migrate(vm.getUuid(), srcHostId, dest);\n          \n          \n            \n                }", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r662869903", "createdAt": "2021-07-02T09:19:17Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5895,8 +5897,46 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Cannot migrate VM, host with id: \" + srcHostId + \" for VM not found\");\n         }\n \n+        DeployDestination dest = null;\n+        if (destinationHost == null) {\n+            vm.setLastHostId(null); // Last host does not have higher priority in vm migration\n+            final ServiceOfferingVO offering = _offeringDao.findById(vm.getId(), vm.getServiceOfferingId());\n+            final VirtualMachineProfile profile = new VirtualMachineProfileImpl(vm, null, offering, null, null);\n+            final Host host = _hostDao.findById(srcHostId);\n+            final DataCenterDeployment plan = new DataCenterDeployment(host.getDataCenterId(), host.getPodId(), host.getClusterId(), null, null, null);\n+            ExcludeList excludes = new ExcludeList();\n+            excludes.addHost(srcHostId);\n+            try {\n+                dest = _planningMgr.planDeployment(profile, plan, excludes, null);\n+            } catch (final AffinityConflictException e2) {\n+                s_logger.warn(\"Unable to create deployment, affinity rules associted to the VM conflict\", e2);\n+                throw new CloudRuntimeException(\"Unable to create deployment, affinity rules associted to the VM conflict\");\n+            } catch (final InsufficientServerCapacityException e3) {\n+                throw new CloudRuntimeException(\"Unable to find a server to migrate the vm to\");\n+            }\n+        } else {\n+            dest = checkVmMigrationDestination(vm, srcHost, destinationHost);\n+        }\n \n-        if (destinationHost.getId() == srcHostId) {\n+        // If no suitable destination found then throw exception\n+        if (dest == null) {\n+            throw new CloudRuntimeException(\"Unable to find suitable destination to migrate VM \" + vm.getInstanceName());\n+        }\n+\n+        UserVmVO uservm = _vmDao.findById(vmId);\n+        if (uservm != null) {\n+            collectVmDiskStatistics(uservm);\n+            collectVmNetworkStatistics(uservm);\n+        }\n+        _itMgr.migrate(vm.getUuid(), srcHostId, dest);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODY5NzY4OQ=="}, "originalCommit": {"oid": "a258544ca957d77077e0d3eb5caf54bb34d713d7"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjg4OTA2Ng==", "bodyText": "@DaanHoogland clear to me now.\nI will add a new method to collect vm network/disk statistics which will be used before stopping/migrating vm.", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r662889066", "createdAt": "2021-07-02T09:49:57Z", "author": {"login": "weizhouapache"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5895,8 +5897,46 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Cannot migrate VM, host with id: \" + srcHostId + \" for VM not found\");\n         }\n \n+        DeployDestination dest = null;\n+        if (destinationHost == null) {\n+            vm.setLastHostId(null); // Last host does not have higher priority in vm migration\n+            final ServiceOfferingVO offering = _offeringDao.findById(vm.getId(), vm.getServiceOfferingId());\n+            final VirtualMachineProfile profile = new VirtualMachineProfileImpl(vm, null, offering, null, null);\n+            final Host host = _hostDao.findById(srcHostId);\n+            final DataCenterDeployment plan = new DataCenterDeployment(host.getDataCenterId(), host.getPodId(), host.getClusterId(), null, null, null);\n+            ExcludeList excludes = new ExcludeList();\n+            excludes.addHost(srcHostId);\n+            try {\n+                dest = _planningMgr.planDeployment(profile, plan, excludes, null);\n+            } catch (final AffinityConflictException e2) {\n+                s_logger.warn(\"Unable to create deployment, affinity rules associted to the VM conflict\", e2);\n+                throw new CloudRuntimeException(\"Unable to create deployment, affinity rules associted to the VM conflict\");\n+            } catch (final InsufficientServerCapacityException e3) {\n+                throw new CloudRuntimeException(\"Unable to find a server to migrate the vm to\");\n+            }\n+        } else {\n+            dest = checkVmMigrationDestination(vm, srcHost, destinationHost);\n+        }\n \n-        if (destinationHost.getId() == srcHostId) {\n+        // If no suitable destination found then throw exception\n+        if (dest == null) {\n+            throw new CloudRuntimeException(\"Unable to find suitable destination to migrate VM \" + vm.getInstanceName());\n+        }\n+\n+        UserVmVO uservm = _vmDao.findById(vmId);\n+        if (uservm != null) {\n+            collectVmDiskStatistics(uservm);\n+            collectVmNetworkStatistics(uservm);\n+        }\n+        _itMgr.migrate(vm.getUuid(), srcHostId, dest);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODY5NzY4OQ=="}, "originalCommit": {"oid": "a258544ca957d77077e0d3eb5caf54bb34d713d7"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MjkyNDE1NQ==", "bodyText": "Done. thanks for review and suggestions @DaanHoogland", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r662924155", "createdAt": "2021-07-02T10:51:17Z", "author": {"login": "weizhouapache"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5895,8 +5897,46 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Cannot migrate VM, host with id: \" + srcHostId + \" for VM not found\");\n         }\n \n+        DeployDestination dest = null;\n+        if (destinationHost == null) {\n+            vm.setLastHostId(null); // Last host does not have higher priority in vm migration\n+            final ServiceOfferingVO offering = _offeringDao.findById(vm.getId(), vm.getServiceOfferingId());\n+            final VirtualMachineProfile profile = new VirtualMachineProfileImpl(vm, null, offering, null, null);\n+            final Host host = _hostDao.findById(srcHostId);\n+            final DataCenterDeployment plan = new DataCenterDeployment(host.getDataCenterId(), host.getPodId(), host.getClusterId(), null, null, null);\n+            ExcludeList excludes = new ExcludeList();\n+            excludes.addHost(srcHostId);\n+            try {\n+                dest = _planningMgr.planDeployment(profile, plan, excludes, null);\n+            } catch (final AffinityConflictException e2) {\n+                s_logger.warn(\"Unable to create deployment, affinity rules associted to the VM conflict\", e2);\n+                throw new CloudRuntimeException(\"Unable to create deployment, affinity rules associted to the VM conflict\");\n+            } catch (final InsufficientServerCapacityException e3) {\n+                throw new CloudRuntimeException(\"Unable to find a server to migrate the vm to\");\n+            }\n+        } else {\n+            dest = checkVmMigrationDestination(vm, srcHost, destinationHost);\n+        }\n \n-        if (destinationHost.getId() == srcHostId) {\n+        // If no suitable destination found then throw exception\n+        if (dest == null) {\n+            throw new CloudRuntimeException(\"Unable to find suitable destination to migrate VM \" + vm.getInstanceName());\n+        }\n+\n+        UserVmVO uservm = _vmDao.findById(vmId);\n+        if (uservm != null) {\n+            collectVmDiskStatistics(uservm);\n+            collectVmNetworkStatistics(uservm);\n+        }\n+        _itMgr.migrate(vm.getUuid(), srcHostId, dest);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODY5NzY4OQ=="}, "originalCommit": {"oid": "a258544ca957d77077e0d3eb5caf54bb34d713d7"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDMxMTQ2MjY4OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0yN1QyMzoxOTowMFrOKGdifg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0yOFQxMDozODo0MFrOKGw-jQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3Nzg2NDA2Mg==", "bodyText": "Minor suggestion: to use BooleanUtils.toBoolean(autoSelect) here", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r677864062", "createdAt": "2021-07-27T23:19:00Z", "author": {"login": "nvazquez"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "diffHunk": "@@ -91,6 +97,10 @@ public Long getStorageId() {\n         return storageId;\n     }\n \n+    public Boolean isAutoSelect() {\n+        return autoSelect != null ? autoSelect : true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73e1c2bdad9b6cfd233e6f202ba31755f14c1251"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3ODE4MjU0MQ==", "bodyText": "@nvazquez done. thanks for suggestion.\nuse BooleanUtils.isNotFalse\nhttps://commons.apache.org/proper/commons-lang/javadocs/api-release/org/apache/commons/lang3/BooleanUtils.html#isNotFalse-java.lang.Boolean-", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r678182541", "createdAt": "2021-07-28T10:38:40Z", "author": {"login": "weizhouapache"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "diffHunk": "@@ -91,6 +97,10 @@ public Long getStorageId() {\n         return storageId;\n     }\n \n+    public Boolean isAutoSelect() {\n+        return autoSelect != null ? autoSelect : true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3Nzg2NDA2Mg=="}, "originalCommit": {"oid": "73e1c2bdad9b6cfd233e6f202ba31755f14c1251"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkNDMxMTQ2NjEyOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVMCmd.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0yN1QyMzoyMDoyNVrOKGdkhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNy0yN1QyMzoyMDoyNVrOKGdkhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3Nzg2NDU4Mw==", "bodyText": "Same here", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r677864583", "createdAt": "2021-07-27T23:20:25Z", "author": {"login": "nvazquez"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVMCmd.java", "diffHunk": "@@ -93,6 +99,10 @@ public Long getStoragePoolId() {\n         return storageId;\n     }\n \n+    public Boolean isAutoSelect() {\n+        return autoSelect != null ? autoSelect : true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73e1c2bdad9b6cfd233e6f202ba31755f14c1251"}, "originalPosition": 27}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4229, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}