{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3ODE2ODMz", "number": 3844, "title": "ISSUE-3838: Wrong SSVM behavior causes redownloading for all the templates", "bodyText": "As per discussion at #3838 and proposal by @weizhouapache this PR implements the fix.\n\n\n\n\n\n#3838\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nHow Has This Been Tested?\n\n\n\ntested manually", "createdAt": "2020-01-28T04:16:13Z", "url": "https://github.com/apache/cloudstack/pull/3844", "merged": true, "mergeCommit": {"oid": "f78cbf4efc909db0bd26eb939af4e8caf3ecc4c5"}, "closed": true, "closedAt": "2020-02-07T05:39:48Z", "author": {"login": "bwsw"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-p6odgBqjI5ODQyNjYzMDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBQM49AFqTM1MzQ5MDkxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ded48a2fee9ad3d5363d4de25652e465b04587d", "author": {"user": {"login": "bwsw", "name": "Bitworks LLC"}}, "url": "https://github.com/apache/cloudstack/commit/8ded48a2fee9ad3d5363d4de25652e465b04587d", "committedDate": "2020-01-28T04:13:58Z", "message": "Fixes #3838"}, "afterCommit": {"oid": "ab87a4d97b8b3a52c02ef366352b8cf86e26e588", "author": {"user": {"login": "bwsw", "name": "Bitworks LLC"}}, "url": "https://github.com/apache/cloudstack/commit/ab87a4d97b8b3a52c02ef366352b8cf86e26e588", "committedDate": "2020-01-28T04:47:57Z", "message": "Fixes #3838"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab87a4d97b8b3a52c02ef366352b8cf86e26e588", "author": {"user": {"login": "bwsw", "name": "Bitworks LLC"}}, "url": "https://github.com/apache/cloudstack/commit/ab87a4d97b8b3a52c02ef366352b8cf86e26e588", "committedDate": "2020-01-28T04:47:57Z", "message": "Fixes #3838"}, "afterCommit": {"oid": "b49a435cadf1828acf390062e8b1068eadad077e", "author": {"user": {"login": "bwsw", "name": "Bitworks LLC"}}, "url": "https://github.com/apache/cloudstack/commit/b49a435cadf1828acf390062e8b1068eadad077e", "committedDate": "2020-01-28T04:50:27Z", "message": "Fixes #3838"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b49a435cadf1828acf390062e8b1068eadad077e", "author": {"user": {"login": "bwsw", "name": "Bitworks LLC"}}, "url": "https://github.com/apache/cloudstack/commit/b49a435cadf1828acf390062e8b1068eadad077e", "committedDate": "2020-01-28T04:50:27Z", "message": "Fixes #3838"}, "afterCommit": {"oid": "241ecb9577e56bce95a23fa19f7c41def3477f9b", "author": {"user": {"login": "bwsw", "name": "Bitworks LLC"}}, "url": "https://github.com/apache/cloudstack/commit/241ecb9577e56bce95a23fa19f7c41def3477f9b", "committedDate": "2020-01-28T05:02:31Z", "message": "Fixes #3838"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MjQ4NDc5", "url": "https://github.com/apache/cloudstack/pull/3844#pullrequestreview-349248479", "createdAt": "2020-01-28T09:58:06Z", "commit": {"oid": "241ecb9577e56bce95a23fa19f7c41def3477f9b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNDgzMDU2", "url": "https://github.com/apache/cloudstack/pull/3844#pullrequestreview-351483056", "createdAt": "2020-01-31T12:49:08Z", "commit": {"oid": "41da80493063311920883e33b8f5baeb2b8dbbee"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxMjo0OTowOFrOFkKZbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxMjo1NToxN1rOFkKihw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ2MzQwNQ==", "bodyText": "moving away from the naming convention, (also i think it is not declared like this)", "url": "https://github.com/apache/cloudstack/pull/3844#discussion_r373463405", "createdAt": "2020-01-31T12:49:08Z", "author": {"login": "DaanHoogland"}, "path": "services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java", "diffHunk": "@@ -596,54 +594,54 @@ public String downloadPublicTemplate(long id, String url, String name, ImageForm\n             File file =\n                     ResourceType.TEMPLATE == resourceType ? _storage.getFile(tmpDir + File.separator + TemplateLocation.Filename) : _storage.getFile(tmpDir + File.separator +\n                             \"volume.properties\");\n-                    if (file.exists()) {\n-                        if(! file.delete()) {\n-                            LOGGER.warn(\"Deletion of file '\" + file.getAbsolutePath() + \"' failed.\");\n-                        }\n-                    }\n+            if (file.exists()) {\n+                if(! file.delete()) {\n+                    s_logger.warn(\"Deletion of file '\" + file.getAbsolutePath() + \"' failed.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41da80493063311920883e33b8f5baeb2b8dbbee"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ2NDYzOQ==", "bodyText": "probably due to rebase? LOGGER", "url": "https://github.com/apache/cloudstack/pull/3844#discussion_r373464639", "createdAt": "2020-01-31T12:52:25Z", "author": {"login": "DaanHoogland"}, "path": "services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java", "diffHunk": "@@ -596,54 +594,54 @@ public String downloadPublicTemplate(long id, String url, String name, ImageForm\n             File file =\n                     ResourceType.TEMPLATE == resourceType ? _storage.getFile(tmpDir + File.separator + TemplateLocation.Filename) : _storage.getFile(tmpDir + File.separator +\n                             \"volume.properties\");\n-                    if (file.exists()) {\n-                        if(! file.delete()) {\n-                            LOGGER.warn(\"Deletion of file '\" + file.getAbsolutePath() + \"' failed.\");\n-                        }\n-                    }\n+            if (file.exists()) {\n+                if(! file.delete()) {\n+                    s_logger.warn(\"Deletion of file '\" + file.getAbsolutePath() + \"' failed.\");\n+                }\n+            }\n \n-                    if (!file.createNewFile()) {\n-                        LOGGER.warn(\"Unable to create new file: \" + file.getAbsolutePath());\n-                        return \"Unable to create new file: \" + file.getAbsolutePath();\n-                    }\n+            if (!file.createNewFile()) {\n+                s_logger.warn(\"Unable to create new file: \" + file.getAbsolutePath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41da80493063311920883e33b8f5baeb2b8dbbee"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ2NTUxMA==", "bodyText": "renamed to LOGGER", "url": "https://github.com/apache/cloudstack/pull/3844#discussion_r373465510", "createdAt": "2020-01-31T12:54:40Z", "author": {"login": "DaanHoogland"}, "path": "services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java", "diffHunk": "@@ -850,10 +848,15 @@ private String getInstallPath(String jobId) {\n \n         Script script = new Script(listVolScr, LOGGER);\n         script.add(\"-r\", rootdir);\n-        ZfsPathParser zpp = new ZfsPathParser(rootdir);\n-        script.execute(zpp);\n-        result.addAll(zpp.getPaths());\n-        LOGGER.info(\"found \" + zpp.getPaths().size() + \" volumes\" + zpp.getPaths());\n+        NfsPathParser parser = new NfsPathParser(rootdir);\n+        script.execute(parser);\n+        if (script.getExitValue() != 0) {\n+            s_logger.error(\"Error while executing script \" + script.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41da80493063311920883e33b8f5baeb2b8dbbee"}, "originalPosition": 275}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ2NTU4MA==", "bodyText": "LOGGER", "url": "https://github.com/apache/cloudstack/pull/3844#discussion_r373465580", "createdAt": "2020-01-31T12:54:51Z", "author": {"login": "DaanHoogland"}, "path": "services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java", "diffHunk": "@@ -850,10 +848,15 @@ private String getInstallPath(String jobId) {\n \n         Script script = new Script(listVolScr, LOGGER);\n         script.add(\"-r\", rootdir);\n-        ZfsPathParser zpp = new ZfsPathParser(rootdir);\n-        script.execute(zpp);\n-        result.addAll(zpp.getPaths());\n-        LOGGER.info(\"found \" + zpp.getPaths().size() + \" volumes\" + zpp.getPaths());\n+        NfsPathParser parser = new NfsPathParser(rootdir);\n+        script.execute(parser);\n+        if (script.getExitValue() != 0) {\n+            s_logger.error(\"Error while executing script \" + script.toString());\n+            throw new CloudRuntimeException(\"Error while executing script \" + script.toString());\n+        }\n+        result.addAll(parser.getPaths());\n+        s_logger.info(\"found \" + parser.getPaths().size() + \" volumes\" + parser.getPaths());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41da80493063311920883e33b8f5baeb2b8dbbee"}, "originalPosition": 279}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ2NTY3Mg==", "bodyText": "sorry", "url": "https://github.com/apache/cloudstack/pull/3844#discussion_r373465672", "createdAt": "2020-01-31T12:55:05Z", "author": {"login": "DaanHoogland"}, "path": "services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java", "diffHunk": "@@ -862,10 +865,14 @@ private String getInstallPath(String jobId) {\n \n         Script script = new Script(listTmpltScr, LOGGER);\n         script.add(\"-r\", rootdir);\n-        ZfsPathParser zpp = new ZfsPathParser(rootdir);\n-        script.execute(zpp);\n-        result.addAll(zpp.getPaths());\n-        LOGGER.info(\"found \" + zpp.getPaths().size() + \" templates\" + zpp.getPaths());\n+        NfsPathParser parser = new NfsPathParser(rootdir);\n+        script.execute(parser);\n+        if (script.getExitValue() != 0) {\n+            s_logger.error(\"Error while executing script \" + script.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41da80493063311920883e33b8f5baeb2b8dbbee"}, "originalPosition": 295}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ2NTczNQ==", "bodyText": "again", "url": "https://github.com/apache/cloudstack/pull/3844#discussion_r373465735", "createdAt": "2020-01-31T12:55:17Z", "author": {"login": "DaanHoogland"}, "path": "services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/DownloadManagerImpl.java", "diffHunk": "@@ -862,10 +865,14 @@ private String getInstallPath(String jobId) {\n \n         Script script = new Script(listTmpltScr, LOGGER);\n         script.add(\"-r\", rootdir);\n-        ZfsPathParser zpp = new ZfsPathParser(rootdir);\n-        script.execute(zpp);\n-        result.addAll(zpp.getPaths());\n-        LOGGER.info(\"found \" + zpp.getPaths().size() + \" templates\" + zpp.getPaths());\n+        NfsPathParser parser = new NfsPathParser(rootdir);\n+        script.execute(parser);\n+        if (script.getExitValue() != 0) {\n+            s_logger.error(\"Error while executing script \" + script.toString());\n+            throw new CloudRuntimeException(\"Error while executing script \" + script.toString());\n+        }\n+        result.addAll(parser.getPaths());\n+        s_logger.info(\"found \" + parser.getPaths().size() + \" templates\" + parser.getPaths());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41da80493063311920883e33b8f5baeb2b8dbbee"}, "originalPosition": 299}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "949fab1095933151d4264677e995f3bf72c7d1c3", "author": {"user": {"login": "bwsw", "name": "Bitworks LLC"}}, "url": "https://github.com/apache/cloudstack/commit/949fab1095933151d4264677e995f3bf72c7d1c3", "committedDate": "2020-02-03T10:17:02Z", "message": "Resolved conflicts."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "41da80493063311920883e33b8f5baeb2b8dbbee", "author": {"user": {"login": "bwsw", "name": "Bitworks LLC"}}, "url": "https://github.com/apache/cloudstack/commit/41da80493063311920883e33b8f5baeb2b8dbbee", "committedDate": "2020-01-31T10:52:06Z", "message": "Merge branch 'master' into bugfix/3838-script-wrong-behavior"}, "afterCommit": {"oid": "949fab1095933151d4264677e995f3bf72c7d1c3", "author": {"user": {"login": "bwsw", "name": "Bitworks LLC"}}, "url": "https://github.com/apache/cloudstack/commit/949fab1095933151d4264677e995f3bf72c7d1c3", "committedDate": "2020-02-03T10:17:02Z", "message": "Resolved conflicts."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMjI1NzIx", "url": "https://github.com/apache/cloudstack/pull/3844#pullrequestreview-352225721", "createdAt": "2020-02-03T12:44:27Z", "commit": {"oid": "949fab1095933151d4264677e995f3bf72c7d1c3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNDkwOTE1", "url": "https://github.com/apache/cloudstack/pull/3844#pullrequestreview-353490915", "createdAt": "2020-02-05T06:32:35Z", "commit": {"oid": "949fab1095933151d4264677e995f3bf72c7d1c3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4570, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}