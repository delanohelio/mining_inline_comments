{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1ODM0NjYz", "number": 4359, "title": "Failed to update host password if username/password is not saved in db", "bodyText": "Description\n\nIf the entries for a host in host_details table are missing then we cant update the\npassword of the host using the cloudmonkey command\nThis can happen because host was removed earlier resulting in deletion\nof entries in the database\nThis commit fixes the issue\n(local) mgt01 > update hostpassword\nhostid=50436ac8-b73a-4eaf-bbab-7adbd9a50870 username=root\npassword=cloudstack\n{\n\"success\": true\n}\nNow the entries should be added in host_details table as well\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?\n\n\n\nUsing cloudmonkey api updateHost", "createdAt": "2020-09-30T23:01:43Z", "url": "https://github.com/apache/cloudstack/pull/4359", "merged": true, "mergeCommit": {"oid": "8b994113ff11fc08e2418f694796c68576de5975"}, "closed": true, "closedAt": "2020-10-29T08:43:05Z", "author": {"login": "ravening"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdON8HOAFqTUwMDE2NTAzNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXNP97AFqTUxOTQwMDU3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMTY1MDM0", "url": "https://github.com/apache/cloudstack/pull/4359#pullrequestreview-500165034", "createdAt": "2020-10-01T09:26:36Z", "commit": {"oid": "462453324ecfa0627cf81cdffebb97e1a60e5581"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "462453324ecfa0627cf81cdffebb97e1a60e5581", "author": {"user": {"login": "ravening", "name": "Rakesh"}}, "url": "https://github.com/apache/cloudstack/commit/462453324ecfa0627cf81cdffebb97e1a60e5581", "committedDate": "2020-09-30T14:44:28Z", "message": "Failed to update host password if username/password is not saved in Cloudstack DB\n\nIf the entries for a host in host_details table are missing then we cant update the\npassword of the host using the cloudmonkey command\nThis can happen because host was removed earlier resulting in deletion\nof entries in the database\n\nThis commit fixes the issue\n\n(local) mgt01 > update hostpassword\nhostid=50436ac8-b73a-4eaf-bbab-7adbd9a50870 username=root\npassword=cloudstack\n{\n  \"success\": true\n}\n\nNow the entries should be added in host_details table as well"}, "afterCommit": {"oid": "549dd14de57e19edeb6862e1286e673ed05033e1", "author": {"user": {"login": "ravening", "name": "Rakesh"}}, "url": "https://github.com/apache/cloudstack/commit/549dd14de57e19edeb6862e1286e673ed05033e1", "committedDate": "2020-10-12T08:31:21Z", "message": "Failed to update host password if username/password is not saved in Cloudstack DB\n\nIf the entries for a host in host_details table are missing then we cant update the\npassword of the host using the cloudmonkey command\nThis can happen because host was removed earlier resulting in deletion\nof entries in the database\n\nThis commit fixes the issue\n\n(local) mgt01 > update hostpassword\nhostid=50436ac8-b73a-4eaf-bbab-7adbd9a50870 username=root\npassword=cloudstack\n{\n  \"success\": true\n}\n\nNow the entries should be added in host_details table as well"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NzgyOTQ3", "url": "https://github.com/apache/cloudstack/pull/4359#pullrequestreview-506782947", "createdAt": "2020-10-12T17:00:10Z", "commit": {"oid": "549dd14de57e19edeb6862e1286e673ed05033e1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNzowMDoxMVrOHgGgXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNzowMDoxMVrOHgGgXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzA2OQ==", "bodyText": "username from the command object can be null or empty ?", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r503423069", "createdAt": "2020-10-12T17:00:11Z", "author": {"login": "sureshanaparti"}, "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -3938,7 +3938,12 @@ public void doInTransactionWithoutResult(final TransactionStatus status) {\n                     }\n                     // update password for this host\n                     final DetailVO nv = _detailsDao.findDetail(h.getId(), ApiConstants.USERNAME);\n-                    if (nv.getValue().equals(command.getUsername())) {\n+                    if (nv == null) {\n+                        final DetailVO nvu = new DetailVO(h.getId(), ApiConstants.USERNAME, command.getUsername());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "549dd14de57e19edeb6862e1286e673ed05033e1"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NzgzNTc3", "url": "https://github.com/apache/cloudstack/pull/4359#pullrequestreview-506783577", "createdAt": "2020-10-12T17:01:15Z", "commit": {"oid": "549dd14de57e19edeb6862e1286e673ed05033e1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNzowMToxNVrOHgGiUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNzowMToxNVrOHgGiUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQyMzU3MA==", "bodyText": "cmd.getUsername() can be null or empty here, please check.", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r503423570", "createdAt": "2020-10-12T17:01:15Z", "author": {"login": "sureshanaparti"}, "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -3994,7 +3999,12 @@ public void doInTransactionWithoutResult(final TransactionStatus status) {\n                 }\n                 // update password for this host\n                 final DetailVO nv = _detailsDao.findDetail(host.getId(), ApiConstants.USERNAME);\n-                if (nv.getValue().equals(cmd.getUsername())) {\n+                if (nv == null) {\n+                    final DetailVO nvu = new DetailVO(host.getId(), ApiConstants.USERNAME, cmd.getUsername());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "549dd14de57e19edeb6862e1286e673ed05033e1"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0NjU4ODYw", "url": "https://github.com/apache/cloudstack/pull/4359#pullrequestreview-514658860", "createdAt": "2020-10-22T12:15:38Z", "commit": {"oid": "e26bc423ef85fa3656b69cbb7ce3da823c6048d2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxMjoxNTozOVrOHmewJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxMjoxNTozOVrOHmewJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDExMTc4MA==", "bodyText": "@ravening should we use 'userNameWithoutSpaces' instead of cmd.getUserName() ?", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r510111780", "createdAt": "2020-10-22T12:15:39Z", "author": {"login": "weizhouapache"}, "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -3938,7 +3943,12 @@ public void doInTransactionWithoutResult(final TransactionStatus status) {\n                     }\n                     // update password for this host\n                     final DetailVO nv = _detailsDao.findDetail(h.getId(), ApiConstants.USERNAME);\n-                    if (nv.getValue().equals(command.getUsername())) {\n+                    if (nv == null) {\n+                        final DetailVO nvu = new DetailVO(h.getId(), ApiConstants.USERNAME, command.getUsername());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e26bc423ef85fa3656b69cbb7ce3da823c6048d2"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NTMwMzM1", "url": "https://github.com/apache/cloudstack/pull/4359#pullrequestreview-518530335", "createdAt": "2020-10-28T10:44:03Z", "commit": {"oid": "e26bc423ef85fa3656b69cbb7ce3da823c6048d2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxMDo0NDowNFrOHpkBiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxMDo0NDowNFrOHpkBiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM0Mzg4Mw==", "bodyText": "@ravening  Username null or empty fix is missing here.", "url": "https://github.com/apache/cloudstack/pull/4359#discussion_r513343883", "createdAt": "2020-10-28T10:44:04Z", "author": {"login": "sureshanaparti"}, "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -3994,7 +4004,12 @@ public void doInTransactionWithoutResult(final TransactionStatus status) {\n                 }\n                 // update password for this host\n                 final DetailVO nv = _detailsDao.findDetail(host.getId(), ApiConstants.USERNAME);\n-                if (nv.getValue().equals(cmd.getUsername())) {\n+                if (nv == null) {\n+                    final DetailVO nvu = new DetailVO(host.getId(), ApiConstants.USERNAME, cmd.getUsername());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e26bc423ef85fa3656b69cbb7ce3da823c6048d2"}, "originalPosition": 32}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e26bc423ef85fa3656b69cbb7ce3da823c6048d2", "author": {"user": {"login": "ravening", "name": "Rakesh"}}, "url": "https://github.com/apache/cloudstack/commit/e26bc423ef85fa3656b69cbb7ce3da823c6048d2", "committedDate": "2020-10-22T08:06:32Z", "message": "Ensure non empty strings"}, "afterCommit": {"oid": "c30fd82baf29dff09929dc5a101346b41550a199", "author": {"user": {"login": "ravening", "name": "Rakesh"}}, "url": "https://github.com/apache/cloudstack/commit/c30fd82baf29dff09929dc5a101346b41550a199", "committedDate": "2020-10-28T11:34:23Z", "message": "code refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33cf8103c52d87efc784d5d465974bcb64a73796", "author": {"user": {"login": "ravening", "name": "Rakesh"}}, "url": "https://github.com/apache/cloudstack/commit/33cf8103c52d87efc784d5d465974bcb64a73796", "committedDate": "2020-10-28T11:49:37Z", "message": "Failed to update host password if username/password is not saved in Cloudstack DB\n\nIf the entries for a host in host_details table are missing then we cant update the\npassword of the host using the cloudmonkey command\nThis can happen because host was removed earlier resulting in deletion\nof entries in the database\n\nThis commit fixes the issue\n\n(local) mgt01 > update hostpassword\nhostid=50436ac8-b73a-4eaf-bbab-7adbd9a50870 username=root\npassword=cloudstack\n{\n\"success\": true\n}\n\nNow the entries should be added in host_details table as well"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c30fd82baf29dff09929dc5a101346b41550a199", "author": {"user": {"login": "ravening", "name": "Rakesh"}}, "url": "https://github.com/apache/cloudstack/commit/c30fd82baf29dff09929dc5a101346b41550a199", "committedDate": "2020-10-28T11:34:23Z", "message": "code refactor"}, "afterCommit": {"oid": "33cf8103c52d87efc784d5d465974bcb64a73796", "author": {"user": {"login": "ravening", "name": "Rakesh"}}, "url": "https://github.com/apache/cloudstack/commit/33cf8103c52d87efc784d5d465974bcb64a73796", "committedDate": "2020-10-28T11:49:37Z", "message": "Failed to update host password if username/password is not saved in Cloudstack DB\n\nIf the entries for a host in host_details table are missing then we cant update the\npassword of the host using the cloudmonkey command\nThis can happen because host was removed earlier resulting in deletion\nof entries in the database\n\nThis commit fixes the issue\n\n(local) mgt01 > update hostpassword\nhostid=50436ac8-b73a-4eaf-bbab-7adbd9a50870 username=root\npassword=cloudstack\n{\n\"success\": true\n}\n\nNow the entries should be added in host_details table as well"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5NDAwNTc4", "url": "https://github.com/apache/cloudstack/pull/4359#pullrequestreview-519400578", "createdAt": "2020-10-29T07:43:42Z", "commit": {"oid": "33cf8103c52d87efc784d5d465974bcb64a73796"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4916, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}