{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5ODY0ODg5", "number": 4212, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxNTo0ODozMVrOEPMRBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwOTowNTo0NFrOE3ndNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0MzY1MDYxOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "isResolved": true, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxNTo0ODozMVrOGyxOsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxOTozMDowNlrOG8XmEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4ODU2Mw==", "bodyText": "Is this debug line still valid?", "url": "https://github.com/apache/cloudstack/pull/4212#discussion_r455888563", "createdAt": "2020-07-16T15:48:31Z", "author": {"login": "wido"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5619,7 +5619,7 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Unsupported Hypervisor Type for User VM migration, we support XenServer/VMware/KVM/Ovm/Hyperv/Ovm3 only\");\n         }\n \n-        if (isVMUsingLocalStorage(vm)) {\n+        if (isVMUsingLocalStorage(vm.getId())) {\n             if (s_logger.isDebugEnabled()) {\n                 s_logger.debug(vm + \" is using Local Storage, cannot migrate this VM.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdc9bd266f874e879eb61aa1b94be7b240b9b123"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyODA3Mg==", "bodyText": "That is a good point. It depends on the strategy configured at the ResourceManager, I will take a look at the best approaches to adapt it.", "url": "https://github.com/apache/cloudstack/pull/4212#discussion_r455928072", "createdAt": "2020-07-16T16:48:38Z", "author": {"login": "GabrielBrascher"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5619,7 +5619,7 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Unsupported Hypervisor Type for User VM migration, we support XenServer/VMware/KVM/Ovm/Hyperv/Ovm3 only\");\n         }\n \n-        if (isVMUsingLocalStorage(vm)) {\n+        if (isVMUsingLocalStorage(vm.getId())) {\n             if (s_logger.isDebugEnabled()) {\n                 s_logger.debug(vm + \" is using Local Storage, cannot migrate this VM.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4ODU2Mw=="}, "originalCommit": {"oid": "bdc9bd266f874e879eb61aa1b94be7b240b9b123"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAxMTgzNQ==", "bodyText": "@wido I did check it again and noticed that the log message as it is makes sense.\nThe migrateVirtualMachine method does not work with volume migration. When a VM with volumes, e.g. when migrating VMs with local storage, is migrated it is used migrateWithStorage method. Therefore, we need to keep it that way.", "url": "https://github.com/apache/cloudstack/pull/4212#discussion_r456011835", "createdAt": "2020-07-16T19:10:50Z", "author": {"login": "GabrielBrascher"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5619,7 +5619,7 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Unsupported Hypervisor Type for User VM migration, we support XenServer/VMware/KVM/Ovm/Hyperv/Ovm3 only\");\n         }\n \n-        if (isVMUsingLocalStorage(vm)) {\n+        if (isVMUsingLocalStorage(vm.getId())) {\n             if (s_logger.isDebugEnabled()) {\n                 s_logger.debug(vm + \" is using Local Storage, cannot migrate this VM.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4ODU2Mw=="}, "originalCommit": {"oid": "bdc9bd266f874e879eb61aa1b94be7b240b9b123"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAxNTkyNw==", "bodyText": "@wido I think that I answered the wrong question on previous comments ... Did you mention the isDebugEnabled(), or the debug message content?\nRegarding the isDebugEnabled(), personally, I would remove it. The idea behind it would be to avoid costly String operations and therefore optimize CloudStack processing. However, I think that there is a little optimization, and most of the cases CloudStack already runs in Debug mode.\nI think that I saw @DaanHoogland and @rafaelweingartner discussing it in the past.", "url": "https://github.com/apache/cloudstack/pull/4212#discussion_r456015927", "createdAt": "2020-07-16T19:18:30Z", "author": {"login": "GabrielBrascher"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5619,7 +5619,7 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Unsupported Hypervisor Type for User VM migration, we support XenServer/VMware/KVM/Ovm/Hyperv/Ovm3 only\");\n         }\n \n-        if (isVMUsingLocalStorage(vm)) {\n+        if (isVMUsingLocalStorage(vm.getId())) {\n             if (s_logger.isDebugEnabled()) {\n                 s_logger.debug(vm + \" is using Local Storage, cannot migrate this VM.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4ODU2Mw=="}, "originalCommit": {"oid": "bdc9bd266f874e879eb61aa1b94be7b240b9b123"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE3NDE2Mw==", "bodyText": "As for the message, looks like an extra check for the strategy is in order, but the flow might already guarantee it's validity.\nAs for the second interpretation of the question, as a matter of principle it is always good to check the logging level as parameters are always evaluated before passing and you never know how often the code is being executed.\nAs for the level, this is an obvious mis-use of debug. An error or at least warning or info situation is occurring here; the user might expect a migration but there is something impairing it. This is not a message for a developer, hence not a debug level message.\n\nmy \u20ac0,03 ;)", "url": "https://github.com/apache/cloudstack/pull/4212#discussion_r462174163", "createdAt": "2020-07-29T09:44:02Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5619,7 +5619,7 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Unsupported Hypervisor Type for User VM migration, we support XenServer/VMware/KVM/Ovm/Hyperv/Ovm3 only\");\n         }\n \n-        if (isVMUsingLocalStorage(vm)) {\n+        if (isVMUsingLocalStorage(vm.getId())) {\n             if (s_logger.isDebugEnabled()) {\n                 s_logger.debug(vm + \" is using Local Storage, cannot migrate this VM.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4ODU2Mw=="}, "originalCommit": {"oid": "bdc9bd266f874e879eb61aa1b94be7b240b9b123"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk1NDUwOQ==", "bodyText": "@DaanHoogland your \u20ac0,03 is very appreciated ;)\nI will change the log level from debug to error (maybe warn, but it looks more like an error).", "url": "https://github.com/apache/cloudstack/pull/4212#discussion_r462954509", "createdAt": "2020-07-30T12:17:54Z", "author": {"login": "GabrielBrascher"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5619,7 +5619,7 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Unsupported Hypervisor Type for User VM migration, we support XenServer/VMware/KVM/Ovm/Hyperv/Ovm3 only\");\n         }\n \n-        if (isVMUsingLocalStorage(vm)) {\n+        if (isVMUsingLocalStorage(vm.getId())) {\n             if (s_logger.isDebugEnabled()) {\n                 s_logger.debug(vm + \" is using Local Storage, cannot migrate this VM.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4ODU2Mw=="}, "originalCommit": {"oid": "bdc9bd266f874e879eb61aa1b94be7b240b9b123"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk1NDMyMg==", "bodyText": "@DaanHoogland I changed the log level from debug to error on those cases.", "url": "https://github.com/apache/cloudstack/pull/4212#discussion_r465954322", "createdAt": "2020-08-05T19:30:06Z", "author": {"login": "GabrielBrascher"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5619,7 +5619,7 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Unsupported Hypervisor Type for User VM migration, we support XenServer/VMware/KVM/Ovm/Hyperv/Ovm3 only\");\n         }\n \n-        if (isVMUsingLocalStorage(vm)) {\n+        if (isVMUsingLocalStorage(vm.getId())) {\n             if (s_logger.isDebugEnabled()) {\n                 s_logger.debug(vm + \" is using Local Storage, cannot migrate this VM.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4ODU2Mw=="}, "originalCommit": {"oid": "bdc9bd266f874e879eb61aa1b94be7b240b9b123"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2NzUzNTkwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwOTowNTo0NVrOHxEV2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwOTowNTo0NVrOHxEV2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTIxMzQwMw==", "bodyText": "nit picking: the target host can be specified and small spello\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        s_logger.error(vm + \" is not XenServer/VMware/KVM/Ovm/Hyperv, cannot migrate this VM form hypervisor type \" + vm.getHypervisorType());\n          \n          \n            \n                        s_logger.error(vm + \" is not XenServer/VMware/KVM/Ovm/Hyperv, cannot migrate this VM from hypervisor type \" + vm.getHypervisorType() + \" to hypervisor type \" + destinationHost.getHypervisorType());", "url": "https://github.com/apache/cloudstack/pull/4212#discussion_r521213403", "createdAt": "2020-11-11T09:05:45Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5609,9 +5609,7 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n         }\n \n         if (!isOnSupportedHypevisorForMigration(vm)) {\n-            if (s_logger.isDebugEnabled()) {\n-                s_logger.debug(vm + \" is not XenServer/VMware/KVM/Ovm/Hyperv, cannot migrate this VM form hypervisor type \" + vm.getHypervisorType());\n-            }\n+            s_logger.error(vm + \" is not XenServer/VMware/KVM/Ovm/Hyperv, cannot migrate this VM form hypervisor type \" + vm.getHypervisorType());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3324fac104dbb01926579a12f3e5efe0c95d844e"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3741, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}