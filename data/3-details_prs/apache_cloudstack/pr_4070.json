{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2MDE2NjUx", "number": 4070, "title": "Update cloud-set-guest-password.in", "bodyText": "Description\nAdaptation of the original script to be able to work with netplan, network manager and ifupdown.\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?\n\nChanges have been tested in Cloudstack V 4.13 with the following operating systems and network providers :\n\nUbuntu 16.04 with ifupdown (/etc/network/interfaces)\nUbuntu 18.04 with netplan\nUbuntu 20.04 with netplan\nDebian 10 with ifupdown (/etc/network/interfaces)\nDebian 9 with ifupdown (/etc/network/interfaces)\nCentOS 8 with network manager (/etc/sysconfig/network-scripts/ifcfg-eth0)\nCentOS 7 with network manager (/etc/sysconfig/network-scripts/ifcfg-eth0)\n\n\nCreate a new vm from template with password feature enabled and log in the vm with provided password.\nStop the vm, change the password with the feature, start the vm and log in the vm with provided password.\n\nN/A", "createdAt": "2020-05-11T10:33:45Z", "url": "https://github.com/apache/cloudstack/pull/4070", "merged": true, "mergeCommit": {"oid": "3ac819410a76eb05c645c2a01a4e86787241706d"}, "closed": true, "closedAt": "2020-06-16T04:44:12Z", "author": {"login": "dimsijul"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgMQ36gH2gAyNDE2MDE2NjUxOjViNzMzOWNjZDI1ZGFjZDQzM2FhMTIyZWU0MDM2MGRhMDlmMmU1Y2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcre4DQAFqTQzMDU1MTI3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5b7339ccd25dacd433aa122ee40360da09f2e5cf", "author": {"user": {"login": "dimsijul", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/5b7339ccd25dacd433aa122ee40360da09f2e5cf", "committedDate": "2020-05-11T09:28:57Z", "message": "Update cloud-set-guest-password.in"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MjMzMDA4", "url": "https://github.com/apache/cloudstack/pull/4070#pullrequestreview-409233008", "createdAt": "2020-05-11T14:36:02Z", "commit": {"oid": "5b7339ccd25dacd433aa122ee40360da09f2e5cf"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxNDozNjowMlrOGTfIVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxNDozODo1N1rOGTfQ3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA4NjE2NA==", "bodyText": "This is line is extremely long, can you make them 3 lines instead?", "url": "https://github.com/apache/cloudstack/pull/4070#discussion_r423086164", "createdAt": "2020-05-11T14:36:02Z", "author": {"login": "nvazquez"}, "path": "setup/bindir/cloud-set-guest-password.in", "diffHunk": "@@ -26,25 +26,56 @@\n # Modify this line to specify the user (default is root)\n user=root\n \n-# Add your DHCP lease folders here\n-DHCP_FOLDERS=\"/var/lib/dhclient/* /var/lib/dhcp3/* /var/lib/dhcp/*\"\n-PASSWORD_SERVER_PORT=8080\n-password_received=0\n-file_count=0\n-error_count=0\n-\n-for DHCP_FILE in $DHCP_FOLDERS; do\n-\tif [ -f $DHCP_FILE ]; then\n-\t\tfile_count=$((file_count+1))\n-\t\tPASSWORD_SERVER_IP=$(grep dhcp-server-identifier $DHCP_FILE | tail -1 | awk '{print $NF}' | tr -d '\\;')\n-\n-\t\tif [ -n \"$PASSWORD_SERVER_IP\" ]; then\n-\t\t\tlogger -t \"cloud\" \"Found password server IP $PASSWORD_SERVER_IP in $DHCP_FILE\"\n-                        break\n-\t\tfi\n-\tfi\n-done\n+# Add network provider variables here (default means that interface for network manager is eth0)\n+NETPLAN=/etc/netplan\n+IFUPDOWN=/etc/network/interfaces\n+NETMAN=/etc/sysconfig/network-scripts/ifcfg-eth0\n+\n+# Add dhcp variables\n+PASSWORD_SERVER_PORT=8080                                                                                                                                                                                                                    password_received=0                                                                                                                                                                                                                          error_count=0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b7339ccd25dacd433aa122ee40360da09f2e5cf"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzA4ODM0OA==", "bodyText": "Maybe moving this up outside of the if block?", "url": "https://github.com/apache/cloudstack/pull/4070#discussion_r423088348", "createdAt": "2020-05-11T14:38:57Z", "author": {"login": "nvazquez"}, "path": "setup/bindir/cloud-set-guest-password.in", "diffHunk": "@@ -26,25 +26,56 @@\n # Modify this line to specify the user (default is root)\n user=root\n \n-# Add your DHCP lease folders here\n-DHCP_FOLDERS=\"/var/lib/dhclient/* /var/lib/dhcp3/* /var/lib/dhcp/*\"\n-PASSWORD_SERVER_PORT=8080\n-password_received=0\n-file_count=0\n-error_count=0\n-\n-for DHCP_FILE in $DHCP_FOLDERS; do\n-\tif [ -f $DHCP_FILE ]; then\n-\t\tfile_count=$((file_count+1))\n-\t\tPASSWORD_SERVER_IP=$(grep dhcp-server-identifier $DHCP_FILE | tail -1 | awk '{print $NF}' | tr -d '\\;')\n-\n-\t\tif [ -n \"$PASSWORD_SERVER_IP\" ]; then\n-\t\t\tlogger -t \"cloud\" \"Found password server IP $PASSWORD_SERVER_IP in $DHCP_FILE\"\n-                        break\n-\t\tfi\n-\tfi\n-done\n+# Add network provider variables here (default means that interface for network manager is eth0)\n+NETPLAN=/etc/netplan\n+IFUPDOWN=/etc/network/interfaces\n+NETMAN=/etc/sysconfig/network-scripts/ifcfg-eth0\n+\n+# Add dhcp variables\n+PASSWORD_SERVER_PORT=8080                                                                                                                                                                                                                    password_received=0                                                                                                                                                                                                                          error_count=0\n+\n+# OS is using netplan\n+if [ -d \"$NETPLAN\" ]; then\n+        logger -t \"cloud\" \"Operating System is using netplan\"\n+\n+        PASSWORD_SERVER_IP=$(netplan ip leases eth0 | grep SERVER_ADDRESS | awk '{split($0,a,\"=\"); print a[2]}')\n+\n+        if [ -n \"$PASSWORD_SERVER_IP\" ]; then\n+                 logger -t \"cloud\" \"Found password server IP $PASSWORD_SERVER_IP in netplan config\"\n+        fi\n+fi\n+\n+# OS is using ifupdown\n+if [ -f \"$IFUPDOWN\" ]; then\n+        logger -t \"cloud\" \"Operating System is using ifupdown\"\n+\n+        DHCP_FOLDERS=\"/var/lib/dhclient/* /var/lib/dhcp3/* /var/lib/dhcp/*\"\n+        file_count=0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b7339ccd25dacd433aa122ee40360da09f2e5cf"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26295a23afabd34fda17c39df884edd410127abe", "author": {"user": {"login": "dimsijul", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/26295a23afabd34fda17c39df884edd410127abe", "committedDate": "2020-05-11T14:48:03Z", "message": "update file_count & syntax error\n\nfile_count outside of the if block\n3 lines instead of one too long (line 35)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMjc0Nzg2", "url": "https://github.com/apache/cloudstack/pull/4070#pullrequestreview-410274786", "createdAt": "2020-05-12T17:39:33Z", "commit": {"oid": "26295a23afabd34fda17c39df884edd410127abe"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNzozOTozM1rOGURwVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNzozOTozM1rOGURwVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzkxNTYwNQ==", "bodyText": "@dimsijul Hi. maybe its a good idea to change NETMAN to the directory too like NETPLAN or IFUPDOWN because eth0 can change if we dont use the naming scheme.\n\"If both systemd predictable interface naming (net.ifnames) and biosdevname naming schemes are disabled, network interfaces continue to use the unpredictable and potentially inconsistent ethX name originally given by the kernel.\"\nNETMAN=/etc/sysconfig/network-scripts", "url": "https://github.com/apache/cloudstack/pull/4070#discussion_r423915605", "createdAt": "2020-05-12T17:39:33Z", "author": {"login": "svenvogel"}, "path": "setup/bindir/cloud-set-guest-password.in", "diffHunk": "@@ -26,25 +26,58 @@\n # Modify this line to specify the user (default is root)\n user=root\n \n-# Add your DHCP lease folders here\n-DHCP_FOLDERS=\"/var/lib/dhclient/* /var/lib/dhcp3/* /var/lib/dhcp/*\"\n+# Add network provider variables here (default means that interface for network manager is eth0)\n+NETPLAN=/etc/netplan\n+IFUPDOWN=/etc/network/interfaces\n+NETMAN=/etc/sysconfig/network-scripts/ifcfg-eth0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26295a23afabd34fda17c39df884edd410127abe"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d683a8933ca1e47fd0f112553e5993857a005d4b", "author": {"user": {"login": "dimsijul", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/d683a8933ca1e47fd0f112553e5993857a005d4b", "committedDate": "2020-05-13T08:28:15Z", "message": "Detection of netman to base it on folder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNjk1MDE2", "url": "https://github.com/apache/cloudstack/pull/4070#pullrequestreview-412695016", "createdAt": "2020-05-15T14:23:52Z", "commit": {"oid": "d683a8933ca1e47fd0f112553e5993857a005d4b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNDoyMzo1MlrOGWHDPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNDoyMzo1MlrOGWHDPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgzNzM3NA==", "bodyText": "maybe a stupid solution like, if we have more than one interface and use only show and grep/regex for an ip\nnmcli -f IP4.GATEWAY device show | ...regex...", "url": "https://github.com/apache/cloudstack/pull/4070#discussion_r425837374", "createdAt": "2020-05-15T14:23:52Z", "author": {"login": "svenvogel"}, "path": "setup/bindir/cloud-set-guest-password.in", "diffHunk": "@@ -26,25 +26,58 @@\n # Modify this line to specify the user (default is root)\n user=root\n \n-# Add your DHCP lease folders here\n-DHCP_FOLDERS=\"/var/lib/dhclient/* /var/lib/dhcp3/* /var/lib/dhcp/*\"\n+# Add network provider variables here (default means that interface for network manager is eth0)\n+NETPLAN=/etc/netplan\n+IFUPDOWN=/etc/network/interfaces\n+NETMAN=/etc/sysconfig/network-scripts\n+\n+# Add dhcp variables\n PASSWORD_SERVER_PORT=8080\n password_received=0\n-file_count=0\n error_count=0\n+file_count=0\n \n-for DHCP_FILE in $DHCP_FOLDERS; do\n-\tif [ -f $DHCP_FILE ]; then\n-\t\tfile_count=$((file_count+1))\n-\t\tPASSWORD_SERVER_IP=$(grep dhcp-server-identifier $DHCP_FILE | tail -1 | awk '{print $NF}' | tr -d '\\;')\n+# OS is using netplan\n+if [ -d \"$NETPLAN\" ]; then\n+        logger -t \"cloud\" \"Operating System is using netplan\"\n \n-\t\tif [ -n \"$PASSWORD_SERVER_IP\" ]; then\n-\t\t\tlogger -t \"cloud\" \"Found password server IP $PASSWORD_SERVER_IP in $DHCP_FILE\"\n-                        break\n-\t\tfi\n-\tfi\n-done\n+        PASSWORD_SERVER_IP=$(netplan ip leases eth0 | grep SERVER_ADDRESS | awk '{split($0,a,\"=\"); print a[2]}')\n+\n+        if [ -n \"$PASSWORD_SERVER_IP\" ]; then\n+                 logger -t \"cloud\" \"Found password server IP $PASSWORD_SERVER_IP in netplan config\"\n+        fi\n+fi\n+\n+# OS is using ifupdown\n+if [ -f \"$IFUPDOWN\" ]; then\n+        logger -t \"cloud\" \"Operating System is using ifupdown\"\n+\n+        DHCP_FOLDERS=\"/var/lib/dhclient/* /var/lib/dhcp3/* /var/lib/dhcp/*\"\n+\n+        for DHCP_FILE in $DHCP_FOLDERS; do\n+                if [ -f $DHCP_FILE ]; then\n+                        file_count=$((file_count+1))\n+                        PASSWORD_SERVER_IP=$(grep dhcp-server-identifier $DHCP_FILE | tail -1 | awk '{print $NF}' | tr -d '\\;')\n+\n+                        if [ -n \"$PASSWORD_SERVER_IP\" ]; then\n+                                logger -t \"cloud\" \"Found password server IP $PASSWORD_SERVER_IP in $DHCP_FILE\"\n+                                break\n+                        fi\n+                fi\n+        done\n+fi\n+\n+# OS is using network interfaces\n+if [ -d \"$NETMAN\" ]; then\n+        logger -t \"cloud\" \"Operating System is using network manager\"\n+\n+        PASSWORD_SERVER_IP=$(nmcli -f IP4.GATEWAY device show eth0 | sed 's/ //g' | awk '{split($0,a,\":\"); print a[2]}')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d683a8933ca1e47fd0f112553e5993857a005d4b"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e577ce0f84da3e14a5d0ae5aa1b597a97b4aa85d", "author": {"user": {"login": "dimsijul", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/e577ce0f84da3e14a5d0ae5aa1b597a97b4aa85d", "committedDate": "2020-05-18T13:53:28Z", "message": "Update cloud-set-guest-password.in"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1MzQxMzMy", "url": "https://github.com/apache/cloudstack/pull/4070#pullrequestreview-415341332", "createdAt": "2020-05-20T13:36:29Z", "commit": {"oid": "e577ce0f84da3e14a5d0ae5aa1b597a97b4aa85d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NDU3Njgz", "url": "https://github.com/apache/cloudstack/pull/4070#pullrequestreview-429457683", "createdAt": "2020-06-12T04:45:05Z", "commit": {"oid": "e577ce0f84da3e14a5d0ae5aa1b597a97b4aa85d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNTUxMjc0", "url": "https://github.com/apache/cloudstack/pull/4070#pullrequestreview-430551274", "createdAt": "2020-06-15T11:23:12Z", "commit": {"oid": "e577ce0f84da3e14a5d0ae5aa1b597a97b4aa85d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4278, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}