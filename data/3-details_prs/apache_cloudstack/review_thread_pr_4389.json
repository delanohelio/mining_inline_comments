{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5MDM0NDM4", "number": 4389, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwODozNToyMlrOErEoSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwODo1NTo0N1rOErFJng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNjAwMDcyOnYy", "diffSide": "RIGHT", "path": "plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java", "isResolved": false, "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwODozNToyMlrOHdoiTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzoxOTozOVrOHd9sYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgzNDg5NA==", "bodyText": "@Spaceman1984 why to mark as VirtualMachine before destroying it ? will the destroy operation fail without it?", "url": "https://github.com/apache/cloudstack/pull/4389#discussion_r500834894", "createdAt": "2020-10-07T08:35:22Z", "author": {"login": "sureshanaparti"}, "path": "plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java", "diffHunk": "@@ -6785,6 +6785,7 @@ public Answer execute(DestroyCommand cmd) {\n                 if (s_logger.isInfoEnabled()) {\n                     s_logger.info(\"Destroy template volume \" + vol.getPath());\n                 }\n+                vmMo.markAsVirtualMachine(hyperHost.getHyperHostOwnerResourcePool(), hyperHost.getMor());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "802d3154166b3a71da80e44b7e8e6aa1ab6bc75e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg0NTgxMw==", "bodyText": "Yes, it did @sureshanaparti,", "url": "https://github.com/apache/cloudstack/pull/4389#discussion_r500845813", "createdAt": "2020-10-07T08:52:03Z", "author": {"login": "Spaceman1984"}, "path": "plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java", "diffHunk": "@@ -6785,6 +6785,7 @@ public Answer execute(DestroyCommand cmd) {\n                 if (s_logger.isInfoEnabled()) {\n                     s_logger.info(\"Destroy template volume \" + vol.getPath());\n                 }\n+                vmMo.markAsVirtualMachine(hyperHost.getHyperHostOwnerResourcePool(), hyperHost.getMor());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgzNDg5NA=="}, "originalCommit": {"oid": "802d3154166b3a71da80e44b7e8e6aa1ab6bc75e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg1OTQ1NQ==", "bodyText": "I see delete/destory operation works for VM & Template in the vCenter. so, I think destroyTask() API can be used with the template mor as well, no need to explicitly mark as VM. What are the errors seen in the logs for failed destroy task without marking as VM?", "url": "https://github.com/apache/cloudstack/pull/4389#discussion_r500859455", "createdAt": "2020-10-07T09:13:31Z", "author": {"login": "sureshanaparti"}, "path": "plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java", "diffHunk": "@@ -6785,6 +6785,7 @@ public Answer execute(DestroyCommand cmd) {\n                 if (s_logger.isInfoEnabled()) {\n                     s_logger.info(\"Destroy template volume \" + vol.getPath());\n                 }\n+                vmMo.markAsVirtualMachine(hyperHost.getHyperHostOwnerResourcePool(), hyperHost.getMor());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgzNDg5NA=="}, "originalCommit": {"oid": "802d3154166b3a71da80e44b7e8e6aa1ab6bc75e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg2MDcyMQ==", "bodyText": "If destroy() works only when marked as a VM, then the same should be ensured across the usages of vmMO destroy()", "url": "https://github.com/apache/cloudstack/pull/4389#discussion_r500860721", "createdAt": "2020-10-07T09:15:24Z", "author": {"login": "sureshanaparti"}, "path": "plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java", "diffHunk": "@@ -6785,6 +6785,7 @@ public Answer execute(DestroyCommand cmd) {\n                 if (s_logger.isInfoEnabled()) {\n                     s_logger.info(\"Destroy template volume \" + vol.getPath());\n                 }\n+                vmMo.markAsVirtualMachine(hyperHost.getHyperHostOwnerResourcePool(), hyperHost.getMor());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgzNDg5NA=="}, "originalCommit": {"oid": "802d3154166b3a71da80e44b7e8e6aa1ab6bc75e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg4MTQxMA==", "bodyText": "The error was:\nUnable to delete template with snapshots - convert the template to a Virtual Machine first.", "url": "https://github.com/apache/cloudstack/pull/4389#discussion_r500881410", "createdAt": "2020-10-07T09:48:11Z", "author": {"login": "Spaceman1984"}, "path": "plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java", "diffHunk": "@@ -6785,6 +6785,7 @@ public Answer execute(DestroyCommand cmd) {\n                 if (s_logger.isInfoEnabled()) {\n                     s_logger.info(\"Destroy template volume \" + vol.getPath());\n                 }\n+                vmMo.markAsVirtualMachine(hyperHost.getHyperHostOwnerResourcePool(), hyperHost.getMor());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgzNDg5NA=="}, "originalCommit": {"oid": "802d3154166b3a71da80e44b7e8e6aa1ab6bc75e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkyMTExNQ==", "bodyText": "@Spaceman1984 @sureshanaparti - in case of linked clones, it makes sense (the error). Do we/CloudStack check that template is not used by any of the VMs, prior to removing it. In that case it perfectly makes sense, if we don't delete the template from primary storage. Thoughts?", "url": "https://github.com/apache/cloudstack/pull/4389#discussion_r500921115", "createdAt": "2020-10-07T10:57:54Z", "author": {"login": "rhtyd"}, "path": "plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java", "diffHunk": "@@ -6785,6 +6785,7 @@ public Answer execute(DestroyCommand cmd) {\n                 if (s_logger.isInfoEnabled()) {\n                     s_logger.info(\"Destroy template volume \" + vol.getPath());\n                 }\n+                vmMo.markAsVirtualMachine(hyperHost.getHyperHostOwnerResourcePool(), hyperHost.getMor());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgzNDg5NA=="}, "originalCommit": {"oid": "802d3154166b3a71da80e44b7e8e6aa1ab6bc75e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkyMTk0OQ==", "bodyText": "Yes, in this case, better not to mark the VM as template while spooling it from the secondary storage. So, no need to mark it back to VM for deletion.", "url": "https://github.com/apache/cloudstack/pull/4389#discussion_r500921949", "createdAt": "2020-10-07T10:59:26Z", "author": {"login": "sureshanaparti"}, "path": "plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java", "diffHunk": "@@ -6785,6 +6785,7 @@ public Answer execute(DestroyCommand cmd) {\n                 if (s_logger.isInfoEnabled()) {\n                     s_logger.info(\"Destroy template volume \" + vol.getPath());\n                 }\n+                vmMo.markAsVirtualMachine(hyperHost.getHyperHostOwnerResourcePool(), hyperHost.getMor());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgzNDg5NA=="}, "originalCommit": {"oid": "802d3154166b3a71da80e44b7e8e6aa1ab6bc75e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkzMTY3OA==", "bodyText": "The error happened for all templates I tested, even systemvm. I speculate that it is referring to the internal command that vmware calls when you click on the delete button from the UI.", "url": "https://github.com/apache/cloudstack/pull/4389#discussion_r500931678", "createdAt": "2020-10-07T11:18:04Z", "author": {"login": "Spaceman1984"}, "path": "plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java", "diffHunk": "@@ -6785,6 +6785,7 @@ public Answer execute(DestroyCommand cmd) {\n                 if (s_logger.isInfoEnabled()) {\n                     s_logger.info(\"Destroy template volume \" + vol.getPath());\n                 }\n+                vmMo.markAsVirtualMachine(hyperHost.getHyperHostOwnerResourcePool(), hyperHost.getMor());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgzNDg5NA=="}, "originalCommit": {"oid": "802d3154166b3a71da80e44b7e8e6aa1ab6bc75e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDkzODI0MQ==", "bodyText": "Do we/CloudStack check that template is not used by any of the VMs, prior to removing it.\n\nYes", "url": "https://github.com/apache/cloudstack/pull/4389#discussion_r500938241", "createdAt": "2020-10-07T11:30:38Z", "author": {"login": "Spaceman1984"}, "path": "plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java", "diffHunk": "@@ -6785,6 +6785,7 @@ public Answer execute(DestroyCommand cmd) {\n                 if (s_logger.isInfoEnabled()) {\n                     s_logger.info(\"Destroy template volume \" + vol.getPath());\n                 }\n+                vmMo.markAsVirtualMachine(hyperHost.getHyperHostOwnerResourcePool(), hyperHost.getMor());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgzNDg5NA=="}, "originalCommit": {"oid": "802d3154166b3a71da80e44b7e8e6aa1ab6bc75e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE4MTUzNw==", "bodyText": "Looks good. I tried vmMo.removeAllSnapshots(); before the destroy but fails. I wonder if templates GC worked before not being marked as templates.", "url": "https://github.com/apache/cloudstack/pull/4389#discussion_r501181537", "createdAt": "2020-10-07T17:19:39Z", "author": {"login": "nvazquez"}, "path": "plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java", "diffHunk": "@@ -6785,6 +6785,7 @@ public Answer execute(DestroyCommand cmd) {\n                 if (s_logger.isInfoEnabled()) {\n                     s_logger.info(\"Destroy template volume \" + vol.getPath());\n                 }\n+                vmMo.markAsVirtualMachine(hyperHost.getHyperHostOwnerResourcePool(), hyperHost.getMor());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgzNDg5NA=="}, "originalCommit": {"oid": "802d3154166b3a71da80e44b7e8e6aa1ab6bc75e"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNjAwNTQ3OnYy", "diffSide": "RIGHT", "path": "vmware-base/src/main/java/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwODozNjozMlrOHdolKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwODozNjozMlrOHdolKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDgzNTYyNw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void markAsVirtualMachine(ManagedObjectReference pool, ManagedObjectReference host) throws Exception {\n          \n          \n            \n                public void markAsVirtualMachine(ManagedObjectReference resourcePool, ManagedObjectReference host) throws Exception {", "url": "https://github.com/apache/cloudstack/pull/4389#discussion_r500835627", "createdAt": "2020-10-07T08:36:32Z", "author": {"login": "sureshanaparti"}, "path": "vmware-base/src/main/java/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java", "diffHunk": "@@ -406,6 +406,10 @@ public void markAsTemplate() throws Exception {\n         _context.getService().markAsTemplate(_mor);\n     }\n \n+    public void markAsVirtualMachine(ManagedObjectReference pool, ManagedObjectReference host) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "802d3154166b3a71da80e44b7e8e6aa1ab6bc75e"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNjA4NjA2OnYy", "diffSide": "RIGHT", "path": "vmware-base/src/main/java/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwODo1NTo0N1rOHdpWYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwOTowMTowMFrOHdpjhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg0ODIyNw==", "bodyText": "pool => resourcePool", "url": "https://github.com/apache/cloudstack/pull/4389#discussion_r500848227", "createdAt": "2020-10-07T08:55:47Z", "author": {"login": "sureshanaparti"}, "path": "vmware-base/src/main/java/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java", "diffHunk": "@@ -406,6 +406,10 @@ public void markAsTemplate() throws Exception {\n         _context.getService().markAsTemplate(_mor);\n     }\n \n+    public void markAsVirtualMachine(ManagedObjectReference resourcePool, ManagedObjectReference host) throws Exception {\n+        _context.getService().markAsVirtualMachine(_mor, pool, host);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3d3be2593fee936b2e8b73ee307709e0dcbc998"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg1MTU5MQ==", "bodyText": "Fixed", "url": "https://github.com/apache/cloudstack/pull/4389#discussion_r500851591", "createdAt": "2020-10-07T09:01:00Z", "author": {"login": "Spaceman1984"}, "path": "vmware-base/src/main/java/com/cloud/hypervisor/vmware/mo/VirtualMachineMO.java", "diffHunk": "@@ -406,6 +406,10 @@ public void markAsTemplate() throws Exception {\n         _context.getService().markAsTemplate(_mor);\n     }\n \n+    public void markAsVirtualMachine(ManagedObjectReference resourcePool, ManagedObjectReference host) throws Exception {\n+        _context.getService().markAsVirtualMachine(_mor, pool, host);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDg0ODIyNw=="}, "originalCommit": {"oid": "d3d3be2593fee936b2e8b73ee307709e0dcbc998"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4066, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}