{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyMzA5MTIy", "number": 4551, "title": "Cleanup volume information from db when deleted", "bodyText": "Description\nThis PR aims at fixing the issue caused when:\n\ndownload a Volume (such that there is a record in the volume_store_ref table)\nmigrate the same volume from one primary store to the another\nWhen migrating between primary storage pools ACS temporarily copies the volume to the secondary store and then copies it from there to the destination primary store and then the secondary store volume directory is cleared up and the volume (volumes table) is marked as Expunged. BUT the corresponding volume's secondary store record(created when we downloaded the volume) still appears to be ready\nThis PR fixes this issue by clearing all records on the secondary store corresponding to that volume and also enhances the garbage collection logic to delete any volumes that were marked as Expunged but have entries in the volume_store_ref table.\n\nObservations made:\nEntries in volume_store_ref after downloading the volume and initiating migration:\n*************************** 2. row ***************************\n                  id: 113\n            store_id: 1\n           volume_id: 127\n             zone_id: 1\n             created: 2020-12-15 05:45:40\n        last_updated: NULL\n              job_id: NULL\n        download_pct: 100\n                size: 0\n       physical_size: 0\n      download_state: DOWNLOADED\n            checksum: NULL\n           error_str: NULL\n          local_path: NULL\n        install_path: volumes/2/127/a73cb20a-9ab3-4c4d-9605-31a3850e1fdc.qcow2\n                 url: NULL\n        download_url: http://10.1.34.20/userdata/38406061-14aa-499a-92c7-6f25978759ae.qcow2\n               state: Ready\n           destroyed: 0\n        update_count: 2\n             ref_cnt: 0\n             updated: 2020-12-15 05:45:52\ndownload_url_created: 2020-12-15 05:45:52\n*************************** 3. row ***************************\n                  id: 114\n            store_id: 1\n           volume_id: 127\n             zone_id: 0\n             created: 2020-12-15 05:46:10\n        last_updated: NULL\n              job_id: NULL\n        download_pct: 0\n                size: 0\n       physical_size: 0\n      download_state: NULL\n            checksum: NULL\n           error_str: NULL\n          local_path: NULL\n        install_path: volumes/2/127/7b5ba7e3-bc06-4c31-8eda-74cda3fab182.qcow2\n                 url: NULL\n        download_url: NULL\n               state: Copying\n           destroyed: 0\n        update_count: 3\n             ref_cnt: 0\n             updated: 2020-12-15 05:46:20\ndownload_url_created: NULL\n\nOnce migration completes, the directory is cleared up from the secondary store, the record corresponding to the migrating volume is also cleared up - but the entry for the downloaded volume is still left behind:\n*************************** 2. row ***************************\n                  id: 113\n            store_id: 1\n           volume_id: 127\n             zone_id: 1\n             created: 2020-12-15 05:45:40\n        last_updated: NULL\n              job_id: NULL\n        download_pct: 100\n                size: 0\n       physical_size: 0\n      download_state: DOWNLOADED\n            checksum: NULL\n           error_str: NULL\n          local_path: NULL\n        install_path: volumes/2/127/a73cb20a-9ab3-4c4d-9605-31a3850e1fdc.qcow2\n                 url: NULL\n        download_url: http://10.1.34.20/userdata/38406061-14aa-499a-92c7-6f25978759ae.qcow2\n               state: Ready\n           destroyed: 0\n        update_count: 2\n             ref_cnt: 0\n             updated: 2020-12-15 05:45:52\ndownload_url_created: 2020-12-15 05:45:52\n2 rows in set (0.00 sec)\n\n\nMariaDB [cloud]> select id,account_id,name,folder,path,volume_type,created,updated,removed,state from volumes where id = 127\\G\n*************************** 1. row ***************************\n         id: 127\n account_id: 2\n       name: ROOT-46\n     folder: /acs/primary/ref-trl-1977-k-M7-pearl-dsilva/ref-trl-1977-k-M7-pearl-dsilva-kvm-pri1\n       path: 87ff45f2-e466-42f2-9f75-b772fc26a4f1\nvolume_type: ROOT\n    created: 2020-12-15 05:33:09\n    updated: 2020-12-15 05:46:30\n    removed: NULL\n      state: Expunged\n1 row in set (0.00 sec)\n\n\nTypes of changes\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nFeature/Enhancement Scale or Bug Severity\nBug Severity\n\n BLOCKER\n Critical\n Major\n Minor\n Trivial\n\nHow Has This Been Tested?\nThe same steps mentioned above were repeated with the fix in place and the following are observed:\nFirstly, the garbage collector identifies any left behind volume entries and clears them\n020-12-15 06:07:14,285 DEBUG [c.c.s.StorageManagerImpl] (StorageManager-Scavenger-1:ctx-c21cc4c6) (logid:95f250bd) Secondary storage garbage collector found 1 volumes to cleanup on volume_store_ref for store: NFS://10.10.0.16/acs/secondary/ref-trl-1977-k-M7-pearl-dsilva/ref-trl-1977-k-M7-pearl-dsilva-sec1\n2020-12-15 06:07:14,286 DEBUG [c.c.s.StorageManagerImpl] (StorageManager-Scavenger-1:ctx-c21cc4c6) (logid:95f250bd) Deleting volume store DB entry: VolumeDataStore[113-127-1volumes/2/127/a73cb20a-9ab3-4c4d-9605-31a3850e1fdc.qcow2]\n\nDownloaded a volume:\nMariaDB [cloud]> select * from volume_store_ref\\G\n\u200b                  id: 134\n            store_id: 2\n           volume_id: 121\n             zone_id: 1\n             created: 2020-12-17 05:48:52\n        last_updated: NULL\n              job_id: NULL\n        download_pct: 100\n                size: 0\n       physical_size: 0\n      download_state: DOWNLOADED\n            checksum: NULL\n           error_str: NULL\n          local_path: NULL\n        install_path: volumes/2/121/afaf7b46-59d4-4e1b-b592-d1ce16d60b14.qcow2\n                 url: NULL\n        download_url: http://10.1.34.15/userdata/8f111dea-e1f7-4351-9155-6ec43487019a.qcow2\n               state: Ready\n           destroyed: 0\n        update_count: 2\n             ref_cnt: 0\n             updated: 2020-12-17 05:49:04\ndownload_url_created: 2020-12-17 05:49:04\n2 rows in set (0.00 sec)\n\nMariaDB [cloud]> select id,account_id,name,folder,path,volume_type,created,updated,removed,state from volumes where id = 121\\G\n*************************** 1. row ***************************\n         id: 121\n account_id: 2\n       name: ROOT-51\n     folder: /acs/primary/ref-trl-1977-k-M7-pearl-dsilva/ref-trl-1977-k-M7-pearl-dsilva-kvm-pri2\n       path: 2e30ed4b-9bdd-4e97-8f45-8051a1e28b16\nvolume_type: ROOT\n    created: 2020-12-14 11:54:15\n    updated: 2020-12-17 05:49:03\n    removed: NULL\n      state: Ready\n1 row in set (0.00 sec)\n\nInitiate migration - here we see another entry created for the same volume:\n*************************** 2. row ***************************\n                  id: 134\n            store_id: 2\n           volume_id: 121\n             zone_id: 1\n             created: 2020-12-17 05:48:52\n        last_updated: NULL\n              job_id: NULL\n        download_pct: 100\n                size: 0\n       physical_size: 0\n      download_state: DOWNLOADED\n            checksum: NULL\n           error_str: NULL\n          local_path: NULL\n        install_path: volumes/2/121/afaf7b46-59d4-4e1b-b592-d1ce16d60b14.qcow2\n                 url: NULL\n        download_url: http://10.1.34.15/userdata/8f111dea-e1f7-4351-9155-6ec43487019a.qcow2\n               state: Ready\n           destroyed: 0\n        update_count: 2\n             ref_cnt: 0\n             updated: 2020-12-17 05:49:04\ndownload_url_created: 2020-12-17 05:49:04\n*************************** 3. row ***************************\n                  id: 135\n            store_id: 2\n           volume_id: 121\n             zone_id: 0\n             created: 2020-12-17 05:50:10\n        last_updated: NULL\n              job_id: NULL\n        download_pct: 0\n                size: 0\n       physical_size: 0\n      download_state: NULL\n            checksum: NULL\n           error_str: NULL\n          local_path: NULL\n        install_path: volumes/2/121\n                 url: NULL\n        download_url: NULL\n               state: Creating\n           destroyed: 0\n        update_count: 1\n             ref_cnt: 0\n             updated: 2020-12-17 05:50:10\ndownload_url_created: NULL\n\nPost migration - notice there is no entry left behind for the expunged volume:\nMariaDB [cloud]> select * from volume_store_ref where volume_id = 121 \\G\nEmpty set (0.00 sec)", "createdAt": "2020-12-18T06:04:47Z", "url": "https://github.com/apache/cloudstack/pull/4551", "merged": true, "mergeCommit": {"oid": "ea7d3b34d12f636659386cb0e8a58d7272c5fa91"}, "closed": true, "closedAt": "2021-08-09T08:51:07Z", "author": {"login": "Pearl1594"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnBazoAH2gAyNTQyMzA5MTIyOjRkZWQzYTI0OGYyNjA5ZTc3NGVlZGI1MTBiNTQxYWVlZTc5MGIzOTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABeyobpSAFqTcyNTE1MTMyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4ded3a248f2609e774eedb510b541aeee790b393", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/4ded3a248f2609e774eedb510b541aeee790b393", "committedDate": "2020-12-17T10:59:28Z", "message": "Cleanup volume information from db when deleted"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MzU4MzUw", "url": "https://github.com/apache/cloudstack/pull/4551#pullrequestreview-555358350", "createdAt": "2020-12-18T10:10:39Z", "commit": {"oid": "4ded3a248f2609e774eedb510b541aeee790b393"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMDoxMDo0MFrOIIc0DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMDoxMDo0MFrOIIc0DA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTczMTU5Ng==", "bodyText": "it looks same as storeVolumeSearch", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r545731596", "createdAt": "2020-12-18T10:10:40Z", "author": {"login": "weizhouapache"}, "path": "engine/storage/src/main/java/org/apache/cloudstack/storage/image/db/VolumeDataStoreDaoImpl.java", "diffHunk": "@@ -120,6 +120,11 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n         uploadVolumeStateSearch.and(\"destroyed\", uploadVolumeStateSearch.entity().getDestroyed(), SearchCriteria.Op.EQ);\n         uploadVolumeStateSearch.done();\n \n+        allVolumesSearch = this.createSearchBuilder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ded3a248f2609e774eedb510b541aeee790b393"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "717a849e277da2ba749db1bc94cc04b6eb79395e", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/717a849e277da2ba749db1bc94cc04b6eb79395e", "committedDate": "2020-12-18T12:56:14Z", "message": "reuse search builder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjI0MDY4Mjg3", "url": "https://github.com/apache/cloudstack/pull/4551#pullrequestreview-624068287", "createdAt": "2021-03-30T09:57:02Z", "commit": {"oid": "717a849e277da2ba749db1bc94cc04b6eb79395e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0zMFQwOTo1NzowM1rOI_-c4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0zMFQwOTo1NzowM1rOI_-c4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzk1NDQwMQ==", "bodyText": "is not null enough? what if it is an object but doesn't exist? or it does but not on imageStore?", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r603954401", "createdAt": "2021-03-30T09:57:03Z", "author": {"login": "DaanHoogland"}, "path": "engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/AncientDataMotionStrategy.java", "diffHunk": "@@ -392,15 +405,16 @@ protected Answer copyVolumeBetweenPools(DataObject srcData, DataObject destData)\n                     return answer;\n                 }\n             } catch (Exception e) {\n-                if (imageStore.exists(objOnImageStore)) {\n+                if (objOnImageStore != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717a849e277da2ba749db1bc94cc04b6eb79395e"}, "originalPosition": 59}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ba974e3e6e11b2e8d9c2118d1ebd1a0540cbbfa", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/6ba974e3e6e11b2e8d9c2118d1ebd1a0540cbbfa", "committedDate": "2021-04-01T05:13:30Z", "message": "Merge branch '4.15' of https://github.com/apache/cloudstack into db-cleanup-volumes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf4d1bb01c1860584b6ce3ee6713a70e71e29ea8", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/cf4d1bb01c1860584b6ce3ee6713a70e71e29ea8", "committedDate": "2021-04-06T06:29:26Z", "message": "Merge branch '4.15' of https://github.com/apache/cloudstack into db-cleanup-volumes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc8bd638f1cdb8584a35daef1cc9d6df0d05b8ca", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/cc8bd638f1cdb8584a35daef1cc9d6df0d05b8ca", "committedDate": "2021-04-06T06:33:39Z", "message": "revert change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjI4NjIyMTU2", "url": "https://github.com/apache/cloudstack/pull/4551#pullrequestreview-628622156", "createdAt": "2021-04-06T06:44:52Z", "commit": {"oid": "717a849e277da2ba749db1bc94cc04b6eb79395e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0wNlQwNjo0NDo1MlrOJDa17g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0wNlQwNjo0NDo1MlrOJDa17g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzU2NTI5NA==", "bodyText": "if any volumes on store at this point, have to remove  them. check if you have to call deleteVolumeOnSecondaryStore() in this case as well", "url": "https://github.com/apache/cloudstack/pull/4551#discussion_r607565294", "createdAt": "2021-04-06T06:44:52Z", "author": {"login": "sureshanaparti"}, "path": "engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/AncientDataMotionStrategy.java", "diffHunk": "@@ -392,15 +405,16 @@ protected Answer copyVolumeBetweenPools(DataObject srcData, DataObject destData)\n                     return answer;\n                 }\n             } catch (Exception e) {\n-                if (imageStore.exists(objOnImageStore)) {\n+                if (objOnImageStore != null) {\n                     objOnImageStore.processEvent(Event.OperationFailed);\n                     imageStore.delete(objOnImageStore);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717a849e277da2ba749db1bc94cc04b6eb79395e"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Njg4MTU0OTIy", "url": "https://github.com/apache/cloudstack/pull/4551#pullrequestreview-688154922", "createdAt": "2021-06-21T08:22:25Z", "commit": {"oid": "cc8bd638f1cdb8584a35daef1cc9d6df0d05b8ca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzI1MTUxMzI0", "url": "https://github.com/apache/cloudstack/pull/4551#pullrequestreview-725151324", "createdAt": "2021-08-09T08:51:00Z", "commit": {"oid": "cc8bd638f1cdb8584a35daef1cc9d6df0d05b8ca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4627, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}