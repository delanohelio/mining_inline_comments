{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3OTU0OTI2", "number": 4375, "title": "Fixing count for findHostsForMigration", "bodyText": "Description\nFixes #4371\nIn the code, all servers, and their count belonging to the same zone are returned. Then they are filtered for suitability.\nThis is fine except for the point where VM volumes existing on managed storage pools or hosts on which those storage pools are not suitable. In this case it removes the hosts rather than marking them as not suitable. This messes up the count. Subtracting the non suitable hosts count does not fix this since we're paginating the response so unsuitable hosts and thier count from the current page will be removed but will not fix the total count since hosts on other pages can not be filtered.\nAnother place is that the source host is removed from the list but the count is not adjusted\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nHow Has This Been Tested?\nBefore :\n{\n  \"count\": 4,\n  \"host\": [\n    {},\n    {},\n    {}\n  ]\n}\n\n\nAfter :\n{\n  \"count\": 3,\n  \"host\": [\n    {},\n    {},\n    {}\n  ]\n}", "createdAt": "2020-10-05T15:57:02Z", "url": "https://github.com/apache/cloudstack/pull/4375", "merged": true, "mergeCommit": {"oid": "81c524e9f393157e00474d1f975d3de4d56da2f5"}, "closed": true, "closedAt": "2020-10-24T11:08:46Z", "author": {"login": "davidjumani"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPmJf6ABqjM4NDEzMDIwNTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdTJcZ3AFqTUxMDY0ODU1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "07aa366af444837b881e035a9e50326bfd06183b", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/07aa366af444837b881e035a9e50326bfd06183b", "committedDate": "2020-10-05T15:54:55Z", "message": "Fixing count for findHostsForMigration"}, "afterCommit": {"oid": "4e45fde67872104724e815c1c471ae6a3cfb6677", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/4e45fde67872104724e815c1c471ae6a3cfb6677", "committedDate": "2020-10-05T16:12:39Z", "message": "Fixing count for findHostsForMigration"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4e45fde67872104724e815c1c471ae6a3cfb6677", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/4e45fde67872104724e815c1c471ae6a3cfb6677", "committedDate": "2020-10-05T16:12:39Z", "message": "Fixing count for findHostsForMigration"}, "afterCommit": {"oid": "a32685e9c6a73403762217b1636eb7586cacf3ba", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/a32685e9c6a73403762217b1636eb7586cacf3ba", "committedDate": "2020-10-05T16:16:39Z", "message": "Fixing count for findHostsForMigration"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a32685e9c6a73403762217b1636eb7586cacf3ba", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/a32685e9c6a73403762217b1636eb7586cacf3ba", "committedDate": "2020-10-05T16:16:39Z", "message": "Fixing count for findHostsForMigration"}, "afterCommit": {"oid": "182af0d515d6325a54c8affd0b06fc9967430053", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/182af0d515d6325a54c8affd0b06fc9967430053", "committedDate": "2020-10-05T16:18:40Z", "message": "Fixing count for findHostsForMigration"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "182af0d515d6325a54c8affd0b06fc9967430053", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/182af0d515d6325a54c8affd0b06fc9967430053", "committedDate": "2020-10-05T16:18:40Z", "message": "Fixing count for findHostsForMigration"}, "afterCommit": {"oid": "3b9d373de05eb4df2b3b486c3564b9b6082a0ca3", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/3b9d373de05eb4df2b3b486c3564b9b6082a0ca3", "committedDate": "2020-10-05T18:56:55Z", "message": "Fixing count for findHostsForMigration"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3b9d373de05eb4df2b3b486c3564b9b6082a0ca3", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/3b9d373de05eb4df2b3b486c3564b9b6082a0ca3", "committedDate": "2020-10-05T18:56:55Z", "message": "Fixing count for findHostsForMigration"}, "afterCommit": {"oid": "fd4cc97ae77545f18929d5f1a8fb1709b6e12066", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/fd4cc97ae77545f18929d5f1a8fb1709b6e12066", "committedDate": "2020-10-05T18:59:47Z", "message": "Fixing count for findHostsForMigration"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd4cc97ae77545f18929d5f1a8fb1709b6e12066", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/fd4cc97ae77545f18929d5f1a8fb1709b6e12066", "committedDate": "2020-10-05T18:59:47Z", "message": "Fixing count for findHostsForMigration"}, "afterCommit": {"oid": "9668193a016dc9a97714102c2be4d10832595d7d", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/9668193a016dc9a97714102c2be4d10832595d7d", "committedDate": "2020-10-05T19:36:32Z", "message": "Fixing count for findHostsForMigration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNTkwMTg4", "url": "https://github.com/apache/cloudstack/pull/4375#pullrequestreview-502590188", "createdAt": "2020-10-06T05:20:20Z", "commit": {"oid": "9668193a016dc9a97714102c2be4d10832595d7d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwNToyMDoyMFrOHc2Rzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwNToyMDoyMFrOHc2Rzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAxMTQ3MQ==", "bodyText": "@davidjumani any reason, why unsuitable hosts are not removed from the hosts list ?", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r500011471", "createdAt": "2020-10-06T05:20:20Z", "author": {"login": "sureshanaparti"}, "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -1278,33 +1277,24 @@ private HypervisorType getHypervisorType(VMInstanceVO vm, StoragePool srcVolumeP\n         final Map<Host, Boolean> requiresStorageMotion = new HashMap<Host, Boolean>();\n         DataCenterDeployment plan = null;\n         if (canMigrateWithStorage) {\n-            allHostsPair = searchForServers(startIndex, pageSize, null, hostType, null, srcHost.getDataCenterId(), null, null, null, keyword, null, null, srcHost.getHypervisorType(),\n-                    srcHost.getHypervisorVersion());\n+            allHostsPair = searchForServers(startIndex, pageSize, null, hostType, null, srcHost.getDataCenterId(), null, null, null, keyword,\n+                null, null, srcHost.getHypervisorType(), srcHost.getHypervisorVersion(), srcHost.getId());\n             allHosts = allHostsPair.first();\n-            allHosts.remove(srcHost);\n \n             for (final VolumeVO volume : volumes) {\n                 StoragePool storagePool = _poolDao.findById(volume.getPoolId());\n                 Long volClusterId = storagePool.getClusterId();\n \n-                for (Iterator<HostVO> iterator = allHosts.iterator(); iterator.hasNext();) {\n-                    final Host host = iterator.next();\n-\n+                for (HostVO host : allHosts) {\n                     if (volClusterId != null) {\n                         if (storagePool.isLocal() || !host.getClusterId().equals(volClusterId) || usesLocal) {\n-                            if (storagePool.isManaged()) {\n-                                // At the time being, we do not support storage migration of a volume from managed storage unless the managed storage\n-                                // is at the zone level and the source and target storage pool is the same.\n-                                // If the source and target storage pool is the same and it is managed, then we still have to perform a storage migration\n-                                // because we need to create a new target volume and copy the contents of the source volume into it before deleting the\n-                                // source volume.\n-                                iterator.remove();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9668193a016dc9a97714102c2be4d10832595d7d"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MTk5MzU5", "url": "https://github.com/apache/cloudstack/pull/4375#pullrequestreview-508199359", "createdAt": "2020-10-14T10:16:24Z", "commit": {"oid": "9668193a016dc9a97714102c2be4d10832595d7d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMDoxNjoyNFrOHhMIAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMDoxNjoyNFrOHhMIAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2MzcxNA==", "bodyText": "My only concern here is that now that we're not removing hosts, what is those hosts which are not removed now as shown as suitable, would that cause any regression?", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r504563714", "createdAt": "2020-10-14T10:16:24Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -1278,33 +1277,24 @@ private HypervisorType getHypervisorType(VMInstanceVO vm, StoragePool srcVolumeP\n         final Map<Host, Boolean> requiresStorageMotion = new HashMap<Host, Boolean>();\n         DataCenterDeployment plan = null;\n         if (canMigrateWithStorage) {\n-            allHostsPair = searchForServers(startIndex, pageSize, null, hostType, null, srcHost.getDataCenterId(), null, null, null, keyword, null, null, srcHost.getHypervisorType(),\n-                    srcHost.getHypervisorVersion());\n+            allHostsPair = searchForServers(startIndex, pageSize, null, hostType, null, srcHost.getDataCenterId(), null, null, null, keyword,\n+                null, null, srcHost.getHypervisorType(), srcHost.getHypervisorVersion(), srcHost.getId());\n             allHosts = allHostsPair.first();\n-            allHosts.remove(srcHost);\n \n             for (final VolumeVO volume : volumes) {\n                 StoragePool storagePool = _poolDao.findById(volume.getPoolId());\n                 Long volClusterId = storagePool.getClusterId();\n \n-                for (Iterator<HostVO> iterator = allHosts.iterator(); iterator.hasNext();) {\n-                    final Host host = iterator.next();\n-\n+                for (HostVO host : allHosts) {\n                     if (volClusterId != null) {\n                         if (storagePool.isLocal() || !host.getClusterId().equals(volClusterId) || usesLocal) {\n-                            if (storagePool.isManaged()) {\n-                                // At the time being, we do not support storage migration of a volume from managed storage unless the managed storage\n-                                // is at the zone level and the source and target storage pool is the same.\n-                                // If the source and target storage pool is the same and it is managed, then we still have to perform a storage migration\n-                                // because we need to create a new target volume and copy the contents of the source volume into it before deleting the\n-                                // source volume.\n-                                iterator.remove();\n-                            } else {\n-                                if (hasSuitablePoolsForVolume(volume, host, vmProfile)) {\n-                                    requiresStorageMotion.put(host, true);\n-                                } else {\n-                                    iterator.remove();\n-                                }\n+                            // At the time being, we do not support storage migration of a volume from managed storage unless the managed storage", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9668193a016dc9a97714102c2be4d10832595d7d"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db90a848485e91a4295daddce96d996fc74dbb76", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/db90a848485e91a4295daddce96d996fc74dbb76", "committedDate": "2020-10-14T11:54:51Z", "message": "Fixing count for findHostsForMigration"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9668193a016dc9a97714102c2be4d10832595d7d", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/9668193a016dc9a97714102c2be4d10832595d7d", "committedDate": "2020-10-05T19:36:32Z", "message": "Fixing count for findHostsForMigration"}, "afterCommit": {"oid": "db90a848485e91a4295daddce96d996fc74dbb76", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/db90a848485e91a4295daddce96d996fc74dbb76", "committedDate": "2020-10-14T11:54:51Z", "message": "Fixing count for findHostsForMigration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5MDY2Mjgy", "url": "https://github.com/apache/cloudstack/pull/4375#pullrequestreview-509066282", "createdAt": "2020-10-15T06:51:20Z", "commit": {"oid": "db90a848485e91a4295daddce96d996fc74dbb76"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNjo1MToyMFrOHh0PJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNjo1MToyMFrOHh0PJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTIyMDkwMQ==", "bodyText": "@davidjumani do you mean hosts for migration with storage? why another list is required here?", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r505220901", "createdAt": "2020-10-15T06:51:20Z", "author": {"login": "sureshanaparti"}, "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -1275,19 +1275,20 @@ private HypervisorType getHypervisorType(VMInstanceVO vm, StoragePool srcVolumeP\n         final Type hostType = srcHost.getType();\n         Pair<List<HostVO>, Integer> allHostsPair = null;\n         List<HostVO> allHosts = null;\n+        List<HostVO> hostsWithStorageMigration = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db90a848485e91a4295daddce96d996fc74dbb76"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5MDY5NTE2", "url": "https://github.com/apache/cloudstack/pull/4375#pullrequestreview-509069516", "createdAt": "2020-10-15T06:57:03Z", "commit": {"oid": "db90a848485e91a4295daddce96d996fc74dbb76"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNjo1NzowNFrOHh0reA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNjo1NzowNFrOHh0reA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTIyODE1Mg==", "bodyText": "@davidjumani didn't see any change with respect to hosts count, does these changes fix the count issue?", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r505228152", "createdAt": "2020-10-15T06:57:04Z", "author": {"login": "sureshanaparti"}, "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -1326,10 +1327,9 @@ private HypervisorType getHypervisorType(VMInstanceVO vm, StoragePool srcVolumeP\n             if (s_logger.isDebugEnabled()) {\n                 s_logger.debug(\"Searching for all hosts in cluster \" + cluster + \" for migrating VM \" + vm);\n             }\n-            allHostsPair = searchForServers(startIndex, pageSize, null, hostType, null, null, null, cluster, null, keyword, null, null, null, null);\n-            // Filter out the current host.\n+            allHostsPair = searchForServers(startIndex, pageSize, null, hostType, null, null, null, cluster, null, keyword, null, null, null,\n+                null, srcHost.getId());\n             allHosts = allHostsPair.first();\n-            allHosts.remove(srcHost);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db90a848485e91a4295daddce96d996fc74dbb76"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5MTQxNDYy", "url": "https://github.com/apache/cloudstack/pull/4375#pullrequestreview-509141462", "createdAt": "2020-10-15T08:32:13Z", "commit": {"oid": "db90a848485e91a4295daddce96d996fc74dbb76"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwODozMjoxM1rOHh7c0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwODozMjoxM1rOHh7c0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMzOTA4OQ==", "bodyText": "@davidjumani can you check if otherHosts here is not required as there is no change in the allHosts & its count, which you can return as it is (as a List), instead of Pair (with count). You can use use the allHosts count wherever applicable.", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r505339089", "createdAt": "2020-10-15T08:32:13Z", "author": {"login": "sureshanaparti"}, "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -1326,10 +1327,9 @@ private HypervisorType getHypervisorType(VMInstanceVO vm, StoragePool srcVolumeP\n             if (s_logger.isDebugEnabled()) {\n                 s_logger.debug(\"Searching for all hosts in cluster \" + cluster + \" for migrating VM \" + vm);\n             }\n-            allHostsPair = searchForServers(startIndex, pageSize, null, hostType, null, null, null, cluster, null, keyword, null, null, null, null);\n-            // Filter out the current host.\n+            allHostsPair = searchForServers(startIndex, pageSize, null, hostType, null, null, null, cluster, null, keyword, null, null, null,\n+                null, srcHost.getId());\n             allHosts = allHostsPair.first();\n-            allHosts.remove(srcHost);\n             plan = new DataCenterDeployment(srcHost.getDataCenterId(), srcHost.getPodId(), srcHost.getClusterId(), null, null, null);\n         }\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db90a848485e91a4295daddce96d996fc74dbb76"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwMjcxMDI5", "url": "https://github.com/apache/cloudstack/pull/4375#pullrequestreview-510271029", "createdAt": "2020-10-16T08:45:28Z", "commit": {"oid": "db90a848485e91a4295daddce96d996fc74dbb76"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5fe0b30f38a6534bd901bb1d55b5ea193d55fe1", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/f5fe0b30f38a6534bd901bb1d55b5ea193d55fe1", "committedDate": "2020-10-16T16:24:51Z", "message": "Changing list name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNjQ4NTU3", "url": "https://github.com/apache/cloudstack/pull/4375#pullrequestreview-510648557", "createdAt": "2020-10-16T17:01:58Z", "commit": {"oid": "f5fe0b30f38a6534bd901bb1d55b5ea193d55fe1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4950, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}