{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyMzI3NTk4", "number": 4138, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMTowNDoxNlrOEEPx9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwNTo1NjozNFrOEMV10w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyODg4MzExOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/cloud/storage/template/HttpTemplateDownloader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMTowNDoxNlrOGhv2bQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMTozODo0N1rOGhw4Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA0MDE3Mw==", "bodyText": "errorString contains a single space initially. String.isEmpty returns (this.value.length == 0)\nso this is never happening.", "url": "https://github.com/apache/cloudstack/pull/4138#discussion_r438040173", "createdAt": "2020-06-10T11:04:16Z", "author": {"login": "DaanHoogland"}, "path": "core/src/main/java/com/cloud/storage/template/HttpTemplateDownloader.java", "diffHunk": "@@ -218,7 +218,10 @@ public long download(boolean resume, DownloadCompleteCallback callback) {\n             errorString = hte.getMessage();\n         } catch (IOException ioe) {\n             status = TemplateDownloader.Status.UNRECOVERABLE_ERROR; //probably a file write error?\n-            errorString = ioe.getMessage();\n+            // Let's not overwrite the original error message.\n+            if (errorString.isEmpty()){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dabb83e4abab516cdab522936aff584f64feb83d"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA1Njk3OQ==", "bodyText": "You are correct @DaanHoogland, I have made the change.", "url": "https://github.com/apache/cloudstack/pull/4138#discussion_r438056979", "createdAt": "2020-06-10T11:38:47Z", "author": {"login": "Spaceman1984"}, "path": "core/src/main/java/com/cloud/storage/template/HttpTemplateDownloader.java", "diffHunk": "@@ -218,7 +218,10 @@ public long download(boolean resume, DownloadCompleteCallback callback) {\n             errorString = hte.getMessage();\n         } catch (IOException ioe) {\n             status = TemplateDownloader.Status.UNRECOVERABLE_ERROR; //probably a file write error?\n-            errorString = ioe.getMessage();\n+            // Let's not overwrite the original error message.\n+            if (errorString.isEmpty()){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA0MDE3Mw=="}, "originalCommit": {"oid": "dabb83e4abab516cdab522936aff584f64feb83d"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczMjk3OTM1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/cloud/storage/template/HttpTemplateDownloader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMTowMjowOVrOGiYf4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNDoyNDo0MlrOGmWrhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcwNjE0Ng==", "bodyText": "i'd go for errorString.trim().isEmpty() to be honest (to be more defensive, but this should work as well. And it might be wise to alter the initialisation statement as well???", "url": "https://github.com/apache/cloudstack/pull/4138#discussion_r438706146", "createdAt": "2020-06-11T11:02:09Z", "author": {"login": "DaanHoogland"}, "path": "core/src/main/java/com/cloud/storage/template/HttpTemplateDownloader.java", "diffHunk": "@@ -219,7 +219,7 @@ public long download(boolean resume, DownloadCompleteCallback callback) {\n         } catch (IOException ioe) {\n             status = TemplateDownloader.Status.UNRECOVERABLE_ERROR; //probably a file write error?\n             // Let's not overwrite the original error message.\n-            if (errorString.isEmpty()){\n+            if (errorString.equals(\" \")){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db5f192c1c265b41cccf9dc66559cbda158e716"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg3MDY2Mg==", "bodyText": "@DaanHoogland What if we get rid of the check altogether and append the error message to what was there already?", "url": "https://github.com/apache/cloudstack/pull/4138#discussion_r442870662", "createdAt": "2020-06-19T14:24:42Z", "author": {"login": "Spaceman1984"}, "path": "core/src/main/java/com/cloud/storage/template/HttpTemplateDownloader.java", "diffHunk": "@@ -219,7 +219,7 @@ public long download(boolean resume, DownloadCompleteCallback callback) {\n         } catch (IOException ioe) {\n             status = TemplateDownloader.Status.UNRECOVERABLE_ERROR; //probably a file write error?\n             // Let's not overwrite the original error message.\n-            if (errorString.isEmpty()){\n+            if (errorString.equals(\" \")){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODcwNjE0Ng=="}, "originalCommit": {"oid": "4db5f192c1c265b41cccf9dc66559cbda158e716"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDM1NDc2OnYy", "diffSide": "RIGHT", "path": "engine/storage/image/src/main/java/org/apache/cloudstack/storage/image/TemplateServiceImpl.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMzowNDoyMVrOGoBXrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxMDoxMToyMVrOGoLziw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxODY2OA==", "bodyText": "@Spaceman1984 this probably needs checking, what if the templates are OK for other secondary storages within the same zone; and across zones?", "url": "https://github.com/apache/cloudstack/pull/4138#discussion_r444618668", "createdAt": "2020-06-24T03:04:21Z", "author": {"login": "rhtyd"}, "path": "engine/storage/image/src/main/java/org/apache/cloudstack/storage/image/TemplateServiceImpl.java", "diffHunk": "@@ -489,6 +489,10 @@ public void handleTemplateSync(DataStore store) {\n                                     s_logger.info(\"Removing leftover template \" + uniqueName + \" entry from template store table\");\n                                     // remove those leftover entries\n                                     _vmTemplateStoreDao.remove(tmpltStore.getId());\n+                                    // remove from zones\n+                                    _vmTemplateZoneDao.deletePrimaryRecordsForTemplate(tmplt.getId());\n+                                    // remove template\n+                                    _templateDao.remove(tmplt.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6ccb523040b90f69fdcee831f87b78f2da625b9"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwNjA4OA==", "bodyText": "I'll test with multiple secondary storages", "url": "https://github.com/apache/cloudstack/pull/4138#discussion_r444706088", "createdAt": "2020-06-24T07:44:57Z", "author": {"login": "Spaceman1984"}, "path": "engine/storage/image/src/main/java/org/apache/cloudstack/storage/image/TemplateServiceImpl.java", "diffHunk": "@@ -489,6 +489,10 @@ public void handleTemplateSync(DataStore store) {\n                                     s_logger.info(\"Removing leftover template \" + uniqueName + \" entry from template store table\");\n                                     // remove those leftover entries\n                                     _vmTemplateStoreDao.remove(tmpltStore.getId());\n+                                    // remove from zones\n+                                    _vmTemplateZoneDao.deletePrimaryRecordsForTemplate(tmplt.getId());\n+                                    // remove template\n+                                    _templateDao.remove(tmplt.getId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxODY2OA=="}, "originalCommit": {"oid": "c6ccb523040b90f69fdcee831f87b78f2da625b9"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc4OTY0Mw==", "bodyText": "You are correct @rhtyd, this code removes the template if there is an error in any of the storages. I have reverted.", "url": "https://github.com/apache/cloudstack/pull/4138#discussion_r444789643", "createdAt": "2020-06-24T10:11:21Z", "author": {"login": "Spaceman1984"}, "path": "engine/storage/image/src/main/java/org/apache/cloudstack/storage/image/TemplateServiceImpl.java", "diffHunk": "@@ -489,6 +489,10 @@ public void handleTemplateSync(DataStore store) {\n                                     s_logger.info(\"Removing leftover template \" + uniqueName + \" entry from template store table\");\n                                     // remove those leftover entries\n                                     _vmTemplateStoreDao.remove(tmpltStore.getId());\n+                                    // remove from zones\n+                                    _vmTemplateZoneDao.deletePrimaryRecordsForTemplate(tmplt.getId());\n+                                    // remove template\n+                                    _templateDao.remove(tmplt.getId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxODY2OA=="}, "originalCommit": {"oid": "c6ccb523040b90f69fdcee831f87b78f2da625b9"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4OTk0MTE5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/cloud/storage/template/HttpTemplateDownloader.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMjoxNjoxM1rOGq5kJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNDo0Njo1MVrOGrAAQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYzNjUxOQ==", "bodyText": "Why not set it if errorString is null as below?", "url": "https://github.com/apache/cloudstack/pull/4138#discussion_r447636519", "createdAt": "2020-06-30T12:16:13Z", "author": {"login": "nvazquez"}, "path": "core/src/main/java/com/cloud/storage/template/HttpTemplateDownloader.java", "diffHunk": "@@ -218,7 +219,10 @@ public long download(boolean resume, DownloadCompleteCallback callback) {\n             errorString = hte.getMessage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fdfe7e85cf4158ded47d7b7e9a2deac9ee9ec564"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc0MjAxNw==", "bodyText": "Why not set it if errorString is null as below?\n\nIt may be an easy code change, but then the scope of this issue will be greater, which will require more testing as well.", "url": "https://github.com/apache/cloudstack/pull/4138#discussion_r447742017", "createdAt": "2020-06-30T14:46:51Z", "author": {"login": "Spaceman1984"}, "path": "core/src/main/java/com/cloud/storage/template/HttpTemplateDownloader.java", "diffHunk": "@@ -218,7 +219,10 @@ public long download(boolean resume, DownloadCompleteCallback callback) {\n             errorString = hte.getMessage();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYzNjUxOQ=="}, "originalCommit": {"oid": "fdfe7e85cf4158ded47d7b7e9a2deac9ee9ec564"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4OTk1NDIxOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/cloud/storage/template/HttpTemplateDownloader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMjoxOTo0NlrOGq5sDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMjoxOTo0NlrOGq5sDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYzODU0MA==", "bodyText": "Minor format one: can you leave a space between the closing parenthesis and the opening brace?", "url": "https://github.com/apache/cloudstack/pull/4138#discussion_r447638540", "createdAt": "2020-06-30T12:19:46Z", "author": {"login": "nvazquez"}, "path": "core/src/main/java/com/cloud/storage/template/HttpTemplateDownloader.java", "diffHunk": "@@ -218,7 +219,10 @@ public long download(boolean resume, DownloadCompleteCallback callback) {\n             errorString = hte.getMessage();\n         } catch (IOException ioe) {\n             status = TemplateDownloader.Status.UNRECOVERABLE_ERROR; //probably a file write error?\n-            errorString = ioe.getMessage();\n+            // Let's not overwrite the original error message.\n+            if (errorString == null){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fdfe7e85cf4158ded47d7b7e9a2deac9ee9ec564"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMzc2MjExOnYy", "diffSide": "LEFT", "path": "core/src/main/java/com/cloud/storage/template/HttpTemplateDownloader.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwNTo1NjozNFrOGuZLnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxNToxOTo0MVrOGv7cbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwMDI1NQ==", "bodyText": "@Spaceman1984 cc @nvazquez why are we not validating format now?", "url": "https://github.com/apache/cloudstack/pull/4138#discussion_r451300255", "createdAt": "2020-07-08T05:56:34Z", "author": {"login": "rhtyd"}, "path": "core/src/main/java/com/cloud/storage/template/HttpTemplateDownloader.java", "diffHunk": "@@ -243,7 +247,6 @@ private boolean copyBytes(File file, InputStream in, RandomAccessFile out) throw\n                 offset = writeBlock(bytes, out, block, offset);\n                 if (!verifyFormat.isVerifiedFormat() && (offset >= 1048576 || offset >= remoteSize)) { //let's check format after we get 1MB or full file\n                     verifyFormat.invoke();\n-                    if (verifyFormat.isInvalid()) return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b77a929e16b69854e4948e4e5f08609236d0bf49"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMxNTE2Ng==", "bodyText": "@rhtyd If validation fails, an exception is thrown, so there is no setting of an invalid state that has to be checked. Validation happens inside verifyFormat.invoke();", "url": "https://github.com/apache/cloudstack/pull/4138#discussion_r451315166", "createdAt": "2020-07-08T06:38:23Z", "author": {"login": "Spaceman1984"}, "path": "core/src/main/java/com/cloud/storage/template/HttpTemplateDownloader.java", "diffHunk": "@@ -243,7 +247,6 @@ private boolean copyBytes(File file, InputStream in, RandomAccessFile out) throw\n                 offset = writeBlock(bytes, out, block, offset);\n                 if (!verifyFormat.isVerifiedFormat() && (offset >= 1048576 || offset >= remoteSize)) { //let's check format after we get 1MB or full file\n                     verifyFormat.invoke();\n-                    if (verifyFormat.isInvalid()) return true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwMDI1NQ=="}, "originalCommit": {"oid": "b77a929e16b69854e4948e4e5f08609236d0bf49"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkxMDE5MA==", "bodyText": "In short, prior to these changes the invoke() method only set the boolean variable retrieved in case of valid/invalid. After these changes, if it is invalid invoke() throws an exception, so no need to check isInvalid() in this line", "url": "https://github.com/apache/cloudstack/pull/4138#discussion_r452910190", "createdAt": "2020-07-10T15:19:41Z", "author": {"login": "nvazquez"}, "path": "core/src/main/java/com/cloud/storage/template/HttpTemplateDownloader.java", "diffHunk": "@@ -243,7 +247,6 @@ private boolean copyBytes(File file, InputStream in, RandomAccessFile out) throw\n                 offset = writeBlock(bytes, out, block, offset);\n                 if (!verifyFormat.isVerifiedFormat() && (offset >= 1048576 || offset >= remoteSize)) { //let's check format after we get 1MB or full file\n                     verifyFormat.invoke();\n-                    if (verifyFormat.isInvalid()) return true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMwMDI1NQ=="}, "originalCommit": {"oid": "b77a929e16b69854e4948e4e5f08609236d0bf49"}, "originalPosition": 33}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3923, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}