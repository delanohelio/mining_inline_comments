{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUzODI2OTI2", "number": 4219, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwMDo0NDowMFrOEQa8FQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNjo0NzozMlrOERIdQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NjU0MDM3OnYy", "diffSide": "RIGHT", "path": "agent/conf/agent.properties", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwMDo0NDowMFrOG0kDsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNToyMToxM1rOG1ne4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc2OTkwNA==", "bodyText": "Considering compatibility on cases where the file remains the old one and does not receive the upgraded agent.properties (system admin can choose between keeping an old file or update it during CloudStack agent upgrade), this implementation should handle null.\n\n\nAs far as I understood, the iSCSI session cleanup works only on managed storage (e.g. Solidfire). If that is the case indeed I think that the parameter details/documentation should add details regarding when it is recommended to use it and when it is risky. Additionally, following other parameters approach, this one (maybe)  could also begin commented as it should be set to false / null on most cases.", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r457769904", "createdAt": "2020-07-21T00:44:00Z", "author": {"login": "GabrielBrascher"}, "path": "agent/conf/agent.properties", "diffHunk": "@@ -258,3 +258,6 @@ hypervisor.type=kvm\n # timer.\n # For all actions refer to the libvirt documentation.\n # Recommended values are: none, reset and poweroff.\n+#\n+iscsi.session.cleanup.enabled=false", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91648e4011a87dacecb404499daf70d088e5030a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg3NDU5NQ==", "bodyText": "added a short description in the properties file.", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r458874595", "createdAt": "2020-07-22T15:21:13Z", "author": {"login": "skattoju4"}, "path": "agent/conf/agent.properties", "diffHunk": "@@ -258,3 +258,6 @@ hypervisor.type=kvm\n # timer.\n # For all actions refer to the libvirt documentation.\n # Recommended values are: none, reset and poweroff.\n+#\n+iscsi.session.cleanup.enabled=false", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc2OTkwNA=="}, "originalCommit": {"oid": "91648e4011a87dacecb404499daf70d088e5030a"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NjY2MjUyOnYy", "diffSide": "RIGHT", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwMTo1MDo1MVrOG0lL2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNToyMDozN1rOG1ndVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc4ODM3OA==", "bodyText": "To be honest, I am not 100% sure on this one, but I think that (boolean)params.get(\"config\") does not handle null parameters (e.g. when commented or removed from configurations).\nCan you please take a look and run a few tests considering those cases where the parameter is not on the configuration file?\nOne approach that I know it would work is Boolean.parseBoolean; parseBoolean handles null values (value = \"null->false\", pure = true).\nExample:\nBoolean _iscsiCleanUpEnabled = Boolean.parseBoolean((String)params.get(\"iscsi.session.cleanup.enabled\"));\n        \nif (BooleanUtils.isTrue(_iscsiCleanUpEnabled)) {", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r457788378", "createdAt": "2020-07-21T01:50:51Z", "author": {"login": "GabrielBrascher"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -1156,9 +1156,15 @@ public boolean configure(final String name, final Map<String, Object> params) th\n         storageProcessor.configure(name, params);\n         storageHandler = new StorageSubsystemCommandHandlerBase(storageProcessor);\n \n-        IscsiStorageCleanupMonitor isciCleanupMonitor = new IscsiStorageCleanupMonitor();\n-        final Thread cleanupMonitor = new Thread(isciCleanupMonitor);\n-        cleanupMonitor.start();\n+        boolean _iscsiCleanUpEnabled = (boolean)params.get(\"iscsi.session.cleanup.enabled\");\n+\n+        if (_iscsiCleanUpEnabled) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91648e4011a87dacecb404499daf70d088e5030a"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg3NDE5Ng==", "bodyText": "Thanks for pointing this out. I used your approach.", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r458874196", "createdAt": "2020-07-22T15:20:37Z", "author": {"login": "skattoju4"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -1156,9 +1156,15 @@ public boolean configure(final String name, final Map<String, Object> params) th\n         storageProcessor.configure(name, params);\n         storageHandler = new StorageSubsystemCommandHandlerBase(storageProcessor);\n \n-        IscsiStorageCleanupMonitor isciCleanupMonitor = new IscsiStorageCleanupMonitor();\n-        final Thread cleanupMonitor = new Thread(isciCleanupMonitor);\n-        cleanupMonitor.start();\n+        boolean _iscsiCleanUpEnabled = (boolean)params.get(\"iscsi.session.cleanup.enabled\");\n+\n+        if (_iscsiCleanUpEnabled) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc4ODM3OA=="}, "originalCommit": {"oid": "91648e4011a87dacecb404499daf70d088e5030a"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NzY2OTk4OnYy", "diffSide": "RIGHT", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwODo1NDoyM1rOG0ujqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNToyMzoxNFrOG1nkwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzk0MTkyOA==", "bodyText": "Can you please extract \"part\" to a constant?\nAdding some details/documentation on why it is important to have this constant checked might be a plus as well.", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r457941928", "createdAt": "2020-07-21T08:54:23Z", "author": {"login": "GabrielBrascher"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -114,7 +114,7 @@ private void updateDiskStatusMapWithInactiveIscsiSessions(Connect conn){\n \n                     //check the volume map. If an entry exists change the status to True\n                     for (final LibvirtVMDef.DiskDef disk : disks) {\n-                        if (diskStatusMap.containsKey(disk.getDiskPath())) {\n+                        if (diskStatusMap.containsKey(disk.getDiskPath())&&!disk.getDiskPath().contains(\"part\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91648e4011a87dacecb404499daf70d088e5030a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg3NjA5Nw==", "bodyText": "@svenvogel @skattoju4 The commit from PR #3819 was added on 4.13, right? This PR should then be also aimed at branch 4.13.\n\nwould you know whats the best way to rebase it to 4.13 is ?", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r458876097", "createdAt": "2020-07-22T15:23:14Z", "author": {"login": "skattoju4"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -114,7 +114,7 @@ private void updateDiskStatusMapWithInactiveIscsiSessions(Connect conn){\n \n                     //check the volume map. If an entry exists change the status to True\n                     for (final LibvirtVMDef.DiskDef disk : disks) {\n-                        if (diskStatusMap.containsKey(disk.getDiskPath())) {\n+                        if (diskStatusMap.containsKey(disk.getDiskPath())&&!disk.getDiskPath().contains(\"part\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzk0MTkyOA=="}, "originalCommit": {"oid": "91648e4011a87dacecb404499daf70d088e5030a"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1OTQwODE1OnYy", "diffSide": "RIGHT", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNjowNzo1OFrOG0_TBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNToyMTo1NlrOG1ng3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIxNjE5OQ==", "bodyText": "I believe you have forgotten the ';' on here.", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r458216199", "createdAt": "2020-07-21T16:07:58Z", "author": {"login": "RodrigoDLopez"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -1156,9 +1156,15 @@ public boolean configure(final String name, final Map<String, Object> params) th\n         storageProcessor.configure(name, params);\n         storageHandler = new StorageSubsystemCommandHandlerBase(storageProcessor);\n \n-        IscsiStorageCleanupMonitor isciCleanupMonitor = new IscsiStorageCleanupMonitor();\n-        final Thread cleanupMonitor = new Thread(isciCleanupMonitor);\n-        cleanupMonitor.start();\n+        boolean _iscsiCleanUpEnabled = (boolean)params.get(\"iscsi.session.cleanup.enabled\");\n+\n+        if (_iscsiCleanUpEnabled) {\n+            IscsiStorageCleanupMonitor isciCleanupMonitor = new IscsiStorageCleanupMonitor();\n+            final Thread cleanupMonitor = new Thread(isciCleanupMonitor);\n+            cleanupMonitor.start();\n+        } else {\n+            s_logger.info(\"iscsi session clean up is disabled\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91648e4011a87dacecb404499daf70d088e5030a"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg3NTEwMA==", "bodyText": "fixed", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r458875100", "createdAt": "2020-07-22T15:21:56Z", "author": {"login": "skattoju4"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -1156,9 +1156,15 @@ public boolean configure(final String name, final Map<String, Object> params) th\n         storageProcessor.configure(name, params);\n         storageHandler = new StorageSubsystemCommandHandlerBase(storageProcessor);\n \n-        IscsiStorageCleanupMonitor isciCleanupMonitor = new IscsiStorageCleanupMonitor();\n-        final Thread cleanupMonitor = new Thread(isciCleanupMonitor);\n-        cleanupMonitor.start();\n+        boolean _iscsiCleanUpEnabled = (boolean)params.get(\"iscsi.session.cleanup.enabled\");\n+\n+        if (_iscsiCleanUpEnabled) {\n+            IscsiStorageCleanupMonitor isciCleanupMonitor = new IscsiStorageCleanupMonitor();\n+            final Thread cleanupMonitor = new Thread(isciCleanupMonitor);\n+            cleanupMonitor.start();\n+        } else {\n+            s_logger.info(\"iscsi session clean up is disabled\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODIxNjE5OQ=="}, "originalCommit": {"oid": "91648e4011a87dacecb404499daf70d088e5030a"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2Mzk5NTczOnYy", "diffSide": "RIGHT", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNjo0Njo1M1rOG1rRNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxOTo1MjoxNVrOG2ZRxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkzNjYyOQ==", "bodyText": "Is this constant used anywhere?", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r458936629", "createdAt": "2020-07-22T16:46:53Z", "author": {"login": "mike-tutkowski"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -38,6 +38,8 @@\n     private static final String ISCSI_PATH_PREFIX = \"/dev/disk/by-path\";\n     private static final String KEYWORD_ISCSI = \"iscsi\";\n     private static final String KEYWORD_IQN = \"iqn\";\n+    private static final String KEYWORD_PART = \"part\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18ad7c7b9726ef5530733bbef00f012e67585ca0"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY5MDQzNw==", "bodyText": "removed it", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r459690437", "createdAt": "2020-07-23T19:52:15Z", "author": {"login": "skattoju4"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -38,6 +38,8 @@\n     private static final String ISCSI_PATH_PREFIX = \"/dev/disk/by-path\";\n     private static final String KEYWORD_ISCSI = \"iscsi\";\n     private static final String KEYWORD_IQN = \"iqn\";\n+    private static final String KEYWORD_PART = \"part\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkzNjYyOQ=="}, "originalCommit": {"oid": "18ad7c7b9726ef5530733bbef00f012e67585ca0"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2Mzk5ODA4OnYy", "diffSide": "RIGHT", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNjo0NzozMlrOG1rSow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNjo0NzozMlrOG1rSow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkzNjk5NQ==", "bodyText": "Perhaps we want to use KEYWORD_PART here instead of \"part\"?", "url": "https://github.com/apache/cloudstack/pull/4219#discussion_r458936995", "createdAt": "2020-07-22T16:47:32Z", "author": {"login": "mike-tutkowski"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/IscsiStorageCleanupMonitor.java", "diffHunk": "@@ -38,6 +38,8 @@\n     private static final String ISCSI_PATH_PREFIX = \"/dev/disk/by-path\";\n     private static final String KEYWORD_ISCSI = \"iscsi\";\n     private static final String KEYWORD_IQN = \"iqn\";\n+    private static final String KEYWORD_PART = \"part\";\n+    private static final String REGEX_PART = \"\\\\S+part\\\\d+$\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18ad7c7b9726ef5530733bbef00f012e67585ca0"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3754, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}