{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0NTQ1MTgx", "number": 3946, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMzo0NjozNlrODntJrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjozOTozMVrODn5l4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyOTYwODEyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/cloud/network/router/deployment/RouterDeploymentDefinition.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMzo0NjozNlrOF121yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMzo0NjozNlrOF121yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjAxNzM1NA==", "bodyText": "offeringUuid would be better than id in the log message. with that LGTM", "url": "https://github.com/apache/cloudstack/pull/3946#discussion_r392017354", "createdAt": "2020-03-13T03:46:36Z", "author": {"login": "harikrishna-patnala"}, "path": "server/src/main/java/org/cloud/network/router/deployment/RouterDeploymentDefinition.java", "diffHunk": "@@ -389,8 +390,34 @@ protected void findDefaultServiceOfferingId() {\n         serviceOfferingId = serviceOffering.getId();\n     }\n \n+    protected void findAccountServiceOfferingId(long accountId) {\n+        String accountRouterOffering = VirtualNetworkApplianceManager.VirtualRouterServiceOffering.valueIn(accountId);\n+        String globalRouterOffering = VirtualNetworkApplianceManager.VirtualRouterServiceOffering.value();\n+        if (accountRouterOffering != null) {\n+            verifyServiceOfferingByUuid(accountRouterOffering);\n+        }\n+        if (serviceOfferingId == null && globalRouterOffering != accountRouterOffering) {\n+            verifyServiceOfferingByUuid(globalRouterOffering);\n+        }\n+    }\n+\n+    private void verifyServiceOfferingByUuid(String offeringUuid) {\n+        logger.debug(\"Verifying router service offering with uuid : \" + offeringUuid);\n+        ServiceOfferingVO serviceOffering = serviceOfferingDao.findByUuid(offeringUuid);\n+        if (serviceOffering != null && serviceOffering.isSystemUse()) {\n+            boolean isLocalStorage = ConfigurationManagerImpl.SystemVMUseLocalStorage.valueIn(dest.getDataCenter().getId());\n+            if (isLocalStorage == serviceOffering.isUseLocalStorage()) {\n+                logger.debug(\"service offering \" + serviceOffering.getId() + \" will be used on virtual router\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "454f5aa260945fd5c0df2d7668fb4f33fb13b523"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMTY0NjQxOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/cloud/network/router/deployment/RouterDeploymentDefinition.java", "isResolved": false, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxNjozOTozMVrOF2KsfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQwODozODo0MlrOF2YfJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM0MjY1Mg==", "bodyText": "Wouldn't we want globalRouterOffering to take precedence over serviceOfferingId, @weizhouapache?", "url": "https://github.com/apache/cloudstack/pull/3946#discussion_r392342652", "createdAt": "2020-03-13T16:39:31Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/org/cloud/network/router/deployment/RouterDeploymentDefinition.java", "diffHunk": "@@ -389,8 +390,34 @@ protected void findDefaultServiceOfferingId() {\n         serviceOfferingId = serviceOffering.getId();\n     }\n \n+    protected void findAccountServiceOfferingId(long accountId) {\n+        String accountRouterOffering = VirtualNetworkApplianceManager.VirtualRouterServiceOffering.valueIn(accountId);\n+        String globalRouterOffering = VirtualNetworkApplianceManager.VirtualRouterServiceOffering.value();\n+        if (accountRouterOffering != null) {\n+            verifyServiceOfferingByUuid(accountRouterOffering);\n+        }\n+        if (serviceOfferingId == null && globalRouterOffering != accountRouterOffering) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3783a092a9431e64f6cf11fc7a1056b338f4f7ab"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM0NzEwMw==", "bodyText": "@DaanHoogland serviceOfferingId is the final offering which will be used on virtual router.", "url": "https://github.com/apache/cloudstack/pull/3946#discussion_r392347103", "createdAt": "2020-03-13T16:45:53Z", "author": {"login": "weizhouapache"}, "path": "server/src/main/java/org/cloud/network/router/deployment/RouterDeploymentDefinition.java", "diffHunk": "@@ -389,8 +390,34 @@ protected void findDefaultServiceOfferingId() {\n         serviceOfferingId = serviceOffering.getId();\n     }\n \n+    protected void findAccountServiceOfferingId(long accountId) {\n+        String accountRouterOffering = VirtualNetworkApplianceManager.VirtualRouterServiceOffering.valueIn(accountId);\n+        String globalRouterOffering = VirtualNetworkApplianceManager.VirtualRouterServiceOffering.value();\n+        if (accountRouterOffering != null) {\n+            verifyServiceOfferingByUuid(accountRouterOffering);\n+        }\n+        if (serviceOfferingId == null && globalRouterOffering != accountRouterOffering) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM0MjY1Mg=="}, "originalCommit": {"oid": "3783a092a9431e64f6cf11fc7a1056b338f4f7ab"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM1MTUwNg==", "bodyText": "yes, but if we configured a global router offering wouldn't we prefer that even if serviceOfferingId is not null?", "url": "https://github.com/apache/cloudstack/pull/3946#discussion_r392351506", "createdAt": "2020-03-13T16:53:25Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/org/cloud/network/router/deployment/RouterDeploymentDefinition.java", "diffHunk": "@@ -389,8 +390,34 @@ protected void findDefaultServiceOfferingId() {\n         serviceOfferingId = serviceOffering.getId();\n     }\n \n+    protected void findAccountServiceOfferingId(long accountId) {\n+        String accountRouterOffering = VirtualNetworkApplianceManager.VirtualRouterServiceOffering.valueIn(accountId);\n+        String globalRouterOffering = VirtualNetworkApplianceManager.VirtualRouterServiceOffering.value();\n+        if (accountRouterOffering != null) {\n+            verifyServiceOfferingByUuid(accountRouterOffering);\n+        }\n+        if (serviceOfferingId == null && globalRouterOffering != accountRouterOffering) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM0MjY1Mg=="}, "originalCommit": {"oid": "3783a092a9431e64f6cf11fc7a1056b338f4f7ab"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ3NjE5OA==", "bodyText": "@DaanHoogland correct. it checks following offerings\n\nRouter service Offering of network/vpc offering\nAccount route service offering\nGlobal route service offering\nDefault route offering\n\nIf 1 or 2 is set and validated, global setting will not be used.", "url": "https://github.com/apache/cloudstack/pull/3946#discussion_r392476198", "createdAt": "2020-03-13T21:05:43Z", "author": {"login": "weizhouapache"}, "path": "server/src/main/java/org/cloud/network/router/deployment/RouterDeploymentDefinition.java", "diffHunk": "@@ -389,8 +390,34 @@ protected void findDefaultServiceOfferingId() {\n         serviceOfferingId = serviceOffering.getId();\n     }\n \n+    protected void findAccountServiceOfferingId(long accountId) {\n+        String accountRouterOffering = VirtualNetworkApplianceManager.VirtualRouterServiceOffering.valueIn(accountId);\n+        String globalRouterOffering = VirtualNetworkApplianceManager.VirtualRouterServiceOffering.value();\n+        if (accountRouterOffering != null) {\n+            verifyServiceOfferingByUuid(accountRouterOffering);\n+        }\n+        if (serviceOfferingId == null && globalRouterOffering != accountRouterOffering) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM0MjY1Mg=="}, "originalCommit": {"oid": "3783a092a9431e64f6cf11fc7a1056b338f4f7ab"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUwODMwMA==", "bodyText": "@weizhouapache if (serviceOffering != null), which should be always, globalRouterOffering will not be checked, whether or not globalRouterOffering == accountRouterOffering.\nso I don't think your 3 and 4 are correct but this condition will never be met and verifyServiceOfferingByUuid(globalRouterOffering) will never be executed.\nSo, why check for serviceOfferingId before globalRouterOffering when it is the last resort and is only relevant after globalRouterOffering?", "url": "https://github.com/apache/cloudstack/pull/3946#discussion_r392508300", "createdAt": "2020-03-13T22:09:31Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/org/cloud/network/router/deployment/RouterDeploymentDefinition.java", "diffHunk": "@@ -389,8 +390,34 @@ protected void findDefaultServiceOfferingId() {\n         serviceOfferingId = serviceOffering.getId();\n     }\n \n+    protected void findAccountServiceOfferingId(long accountId) {\n+        String accountRouterOffering = VirtualNetworkApplianceManager.VirtualRouterServiceOffering.valueIn(accountId);\n+        String globalRouterOffering = VirtualNetworkApplianceManager.VirtualRouterServiceOffering.value();\n+        if (accountRouterOffering != null) {\n+            verifyServiceOfferingByUuid(accountRouterOffering);\n+        }\n+        if (serviceOfferingId == null && globalRouterOffering != accountRouterOffering) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM0MjY1Mg=="}, "originalCommit": {"oid": "3783a092a9431e64f6cf11fc7a1056b338f4f7ab"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU2Mzc0Nw==", "bodyText": "@weizhouapache if (serviceOffering != null), which should be always, globalRouterOffering will not be checked, whether or not globalRouterOffering == accountRouterOffering.\nso I don't think your 3 and 4 are correct but this condition will never be met and verifyServiceOfferingByUuid(globalRouterOffering) will never be executed.\nSo, why check for serviceOfferingId before globalRouterOffering when it is the last resort and is only relevant after globalRouterOffering?\n\n@DaanHoogland it is serviceOfferingId , not serviceOffering.\n\n  \n    \n      cloudstack/server/src/main/java/org/cloud/network/router/deployment/RouterDeploymentDefinition.java\n    \n    \n         Line 109\n      in\n      3783a09\n    \n    \n    \n    \n\n        \n          \n           protected Long serviceOfferingId; \n        \n    \n  \n\n\nthe check procedure\n\n  \n    \n      cloudstack/server/src/main/java/org/cloud/network/router/deployment/RouterDeploymentDefinition.java\n    \n    \n        Lines 416 to 424\n      in\n      3783a09\n    \n    \n    \n    \n\n        \n          \n           protected void findServiceOfferingId() { \n        \n\n        \n          \n               serviceOfferingId = networkOfferingDao.findById(guestNetwork.getNetworkOfferingId()).getServiceOfferingId(); \n        \n\n        \n          \n               if (serviceOfferingId == null) { \n        \n\n        \n          \n                   findAccountServiceOfferingId(guestNetwork.getAccountId()); \n        \n\n        \n          \n               } \n        \n\n        \n          \n               if (serviceOfferingId == null) { \n        \n\n        \n          \n                   findDefaultServiceOfferingId(); \n        \n\n        \n          \n               } \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nin the account part, considering the uuid might be invalid, so check account setting at first, then global setting if account setting is invalid. (if account setting is not set, accountRouterOffering is actually the global setting, so skip the check if accountRouterOffering equals to globalRouterOffering )\n\n  \n    \n      cloudstack/server/src/main/java/org/cloud/network/router/deployment/RouterDeploymentDefinition.java\n    \n    \n        Lines 393 to 414\n      in\n      3783a09\n    \n    \n    \n    \n\n        \n          \n           protected void findAccountServiceOfferingId(long accountId) { \n        \n\n        \n          \n               String accountRouterOffering = VirtualNetworkApplianceManager.VirtualRouterServiceOffering.valueIn(accountId); \n        \n\n        \n          \n               String globalRouterOffering = VirtualNetworkApplianceManager.VirtualRouterServiceOffering.value(); \n        \n\n        \n          \n               if (accountRouterOffering != null) { \n        \n\n        \n          \n                   verifyServiceOfferingByUuid(accountRouterOffering); \n        \n\n        \n          \n               } \n        \n\n        \n          \n               if (serviceOfferingId == null && globalRouterOffering != accountRouterOffering) { \n        \n\n        \n          \n                   verifyServiceOfferingByUuid(globalRouterOffering); \n        \n\n        \n          \n               } \n        \n\n        \n          \n           } \n        \n\n        \n          \n            \n        \n\n        \n          \n           private void verifyServiceOfferingByUuid(String offeringUuid) { \n        \n\n        \n          \n               logger.debug(\"Verifying router service offering with uuid : \" + offeringUuid); \n        \n\n        \n          \n               ServiceOfferingVO serviceOffering = serviceOfferingDao.findByUuid(offeringUuid); \n        \n\n        \n          \n               if (serviceOffering != null && serviceOffering.isSystemUse()) { \n        \n\n        \n          \n                   boolean isLocalStorage = ConfigurationManagerImpl.SystemVMUseLocalStorage.valueIn(dest.getDataCenter().getId()); \n        \n\n        \n          \n                   if (isLocalStorage == serviceOffering.isUseLocalStorage()) { \n        \n\n        \n          \n                       logger.debug(String.format(\"Service offering %s (uuid: %s) will be used on virtual router\", serviceOffering.getName(), serviceOffering.getUuid())); \n        \n\n        \n          \n                       serviceOfferingId = serviceOffering.getId(); \n        \n\n        \n          \n                   } \n        \n\n        \n          \n               } \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nhope it helps you understanding all changes in PR.", "url": "https://github.com/apache/cloudstack/pull/3946#discussion_r392563747", "createdAt": "2020-03-14T07:06:02Z", "author": {"login": "weizhouapache"}, "path": "server/src/main/java/org/cloud/network/router/deployment/RouterDeploymentDefinition.java", "diffHunk": "@@ -389,8 +390,34 @@ protected void findDefaultServiceOfferingId() {\n         serviceOfferingId = serviceOffering.getId();\n     }\n \n+    protected void findAccountServiceOfferingId(long accountId) {\n+        String accountRouterOffering = VirtualNetworkApplianceManager.VirtualRouterServiceOffering.valueIn(accountId);\n+        String globalRouterOffering = VirtualNetworkApplianceManager.VirtualRouterServiceOffering.value();\n+        if (accountRouterOffering != null) {\n+            verifyServiceOfferingByUuid(accountRouterOffering);\n+        }\n+        if (serviceOfferingId == null && globalRouterOffering != accountRouterOffering) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM0MjY1Mg=="}, "originalCommit": {"oid": "3783a092a9431e64f6cf11fc7a1056b338f4f7ab"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU2ODYxNQ==", "bodyText": "ah, i missed the side effect of verifyServiceOfferingByUuid(), where the id is set, thanks.\nMaybe to make this more obvious for stupid people like me we can make verifyServiceOfferingByUuid() return a uuid or null and set it in the findAccountServiceOfferingId()?", "url": "https://github.com/apache/cloudstack/pull/3946#discussion_r392568615", "createdAt": "2020-03-14T08:38:42Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/org/cloud/network/router/deployment/RouterDeploymentDefinition.java", "diffHunk": "@@ -389,8 +390,34 @@ protected void findDefaultServiceOfferingId() {\n         serviceOfferingId = serviceOffering.getId();\n     }\n \n+    protected void findAccountServiceOfferingId(long accountId) {\n+        String accountRouterOffering = VirtualNetworkApplianceManager.VirtualRouterServiceOffering.valueIn(accountId);\n+        String globalRouterOffering = VirtualNetworkApplianceManager.VirtualRouterServiceOffering.value();\n+        if (accountRouterOffering != null) {\n+            verifyServiceOfferingByUuid(accountRouterOffering);\n+        }\n+        if (serviceOfferingId == null && globalRouterOffering != accountRouterOffering) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjM0MjY1Mg=="}, "originalCommit": {"oid": "3783a092a9431e64f6cf11fc7a1056b338f4f7ab"}, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3965, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}