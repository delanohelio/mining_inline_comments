{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3OTgwODg3", "number": 4228, "title": "Dont add host back after agent service restart", "bodyText": "Description\n\nFixes #4218\nIf a host is removed from cloudstack, it will be\nadded back if we restart the agent service on\nthe host. It should not be added back if manualy\nremoved.\nProvide a global setting \"add.host.on.service.restart\" with\ndefault value of true. If set to false, the zoneid,\nclusterid and podid in agent.properties will be set to\nnull so that when service is restarted, the agent is not\nadded back\nIf true these values will not be set to null so that it\ncan be still added back on service restart\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?\n\nAdd a host from ui. It will be successfully added\nNow remove the host\nSet the global setting add.host.on.service.restart to false\nssh to host and restart cloudstack-agent service\nThe host is not added back\nTry to add host from ui again. It will be added", "createdAt": "2020-07-28T18:35:32Z", "url": "https://github.com/apache/cloudstack/pull/4228", "merged": true, "mergeCommit": {"oid": "6c88e9afb39f5a9aee131ddaaa0b7b74e5ee80fb"}, "closed": true, "closedAt": "2020-10-14T16:49:40Z", "author": {"login": "ravening"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5u-DxgFqTQ1Nzc1MDg3OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSclZuAFqTUwODMwNTU1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NzUwODc4", "url": "https://github.com/apache/cloudstack/pull/4228#pullrequestreview-457750878", "createdAt": "2020-07-29T17:46:01Z", "commit": {"oid": "87c2cb621e59794f1bdee19690aeca73629f6005"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNzo0NjowMlrOG5DWqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNzo1NDoyMVrOG5DqVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ3Njk3MQ==", "bodyText": "this is not really saying it. what did we fail at for what reason with (and this part is there) what message.", "url": "https://github.com/apache/cloudstack/pull/4228#discussion_r462476971", "createdAt": "2020-07-29T17:46:02Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/hypervisor/kvm/discoverer/LibvirtServerDiscoverer.java", "diffHunk": "@@ -348,11 +362,19 @@ private void setupAgentSecurity(final Connection sshConnection, final String age\n             _hostDao.saveDetails(connectedHost);\n             return resources;\n         } catch (DiscoveredWithErrorException e) {\n+            s_logger.error(\"Exception: \"+ e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87c2cb621e59794f1bdee19690aeca73629f6005"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ4MjAwNg==", "bodyText": "is this comment correct? initialGuid might have a value other than null.", "url": "https://github.com/apache/cloudstack/pull/4228#discussion_r462482006", "createdAt": "2020-07-29T17:54:21Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/hypervisor/kvm/discoverer/LibvirtServerDiscoverer.java", "diffHunk": "@@ -348,11 +362,19 @@ private void setupAgentSecurity(final Connection sshConnection, final String age\n             _hostDao.saveDetails(connectedHost);\n             return resources;\n         } catch (DiscoveredWithErrorException e) {\n+            s_logger.error(\"Exception: \"+ e.getMessage());\n             throw e;\n         } catch (Exception e) {\n             String msg = \" can't setup agent, due to \" + e.toString() + \" - \" + e.getMessage();\n             s_logger.warn(msg);\n         } finally {\n+            // set guid to null once host is added", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87c2cb621e59794f1bdee19690aeca73629f6005"}, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87c2cb621e59794f1bdee19690aeca73629f6005", "author": {"user": {"login": "ravening", "name": "Rakesh"}}, "url": "https://github.com/apache/cloudstack/commit/87c2cb621e59794f1bdee19690aeca73629f6005", "committedDate": "2020-07-28T18:29:57Z", "message": "Dont add host back after service restart\n\nIf a host is removed from cloudstack, it will be\nadded back if we restart the agent service on\nthe host. It should not be added back if manualy\nremoved.\n\nSo when host is removed, guid is set to null.\nWhen service is restarted, check if guid is null\nfor the host it send to mgt server. If guid is\nnull then dont add it back.\n\nWhen we are adding host, temporarily set guid to\nnon null value so that when agent sends startuprouting command\nit knows that the host is getting explicitly added.\nOnce host is added, set it back to null"}, "afterCommit": {"oid": "a714b996a396001126a71aefaee6b9460a249b98", "author": {"user": {"login": "ravening", "name": "Rakesh"}}, "url": "https://github.com/apache/cloudstack/commit/a714b996a396001126a71aefaee6b9460a249b98", "committedDate": "2020-08-05T11:24:03Z", "message": "Dont add host back after cloudstack-agent service restart\n\nIf a host is removed from cloudstack, it will be\nadded back if we restart the agent service on\nthe host. It should not be added back if manualy\nremoved.\n\nAdd a global setting \"add.host.on.service.restart\" with\ndefault value of true. If set to false, the zoneid,\nclusterid and podid in agent.properties will be set to\nnull so that when service is restarted, the agent is not\nadded back\n\nIf true these values will not be set to null so that it\ncan be still added back on service restart"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNTg2NjQ5", "url": "https://github.com/apache/cloudstack/pull/4228#pullrequestreview-461586649", "createdAt": "2020-08-05T11:45:07Z", "commit": {"oid": "a714b996a396001126a71aefaee6b9460a249b98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMTo0NTowN1rOG8GF4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMTo0NTowN1rOG8GF4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY2NzU1NA==", "bodyText": "general jist looks good, i'd rather have the tristate operator in the parameter passing then the whole contructor invocation ? note the ?)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        ShutdownCommand cmd = AddHostOnServiceRestart.value() ? new ShutdownCommand(ShutdownCommand.DeleteHost, null, false) :\n          \n          \n            \n                                new ShutdownCommand(ShutdownCommand.DeleteHost, \"Cleaning up zone/pod/cluster details for host\", true);\n          \n          \n            \n                        ShutdownCommand cmd = new ShutdownCommand(ShutdownCommand.DeleteHost, null, AddHostOnServiceRestart.value() ? false : true);", "url": "https://github.com/apache/cloudstack/pull/4228#discussion_r465667554", "createdAt": "2020-08-05T11:45:07Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/hypervisor/kvm/discoverer/LibvirtServerDiscoverer.java", "diffHunk": "@@ -474,7 +477,8 @@ public DeleteHostAnswer deleteHost(HostVO host, boolean isForced, boolean isForc\n \n         _resourceMgr.deleteRoutingHost(host, isForced, isForceDeleteStorage);\n         try {\n-            ShutdownCommand cmd = new ShutdownCommand(ShutdownCommand.DeleteHost, null);\n+            ShutdownCommand cmd = AddHostOnServiceRestart.value() ? new ShutdownCommand(ShutdownCommand.DeleteHost, null, false) :\n+                    new ShutdownCommand(ShutdownCommand.DeleteHost, \"Cleaning up zone/pod/cluster details for host\", true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a714b996a396001126a71aefaee6b9460a249b98"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0Nzc0MDU5", "url": "https://github.com/apache/cloudstack/pull/4228#pullrequestreview-464774059", "createdAt": "2020-08-11T06:12:19Z", "commit": {"oid": "f06a04f21564d00c8cd6953fec74ef1e2aa10e0f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNjoxMjoxOVrOG-ptiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNjoxNTo0NFrOG-px_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM0ODI5OQ==", "bodyText": "Considering that this is defined as a static final, I would recommend keeping the code convention such as described on Oracle Java Naming Conventions.\nIn this case AddHostOnServiceRestart should be changed to something as ADD_HOST_ON_SERVICE_RESTART.", "url": "https://github.com/apache/cloudstack/pull/4228#discussion_r468348299", "createdAt": "2020-08-11T06:12:19Z", "author": {"login": "GabrielBrascher"}, "path": "server/src/main/java/com/cloud/configuration/ConfigurationManagerImpl.java", "diffHunk": "@@ -410,6 +410,10 @@\n     public final static ConfigKey<Long> IOPS_MAX_WRITE_LENGTH = new ConfigKey<Long>(Long.class, \"vm.disk.iops.maximum.write.length\", \"Advanced\", \"0\",\n             \"Maximum IOPS write burst duration (seconds). If '0' (zero) then does not check for maximum burst length.\", true, ConfigKey.Scope.Global, null);\n \n+    public static final ConfigKey<Boolean> AddHostOnServiceRestart = new ConfigKey<Boolean>(Boolean.class, \"add.host.on.service.restart\", \"Advanced\", \"true\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f06a04f21564d00c8cd6953fec74ef1e2aa10e0f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODM0OTQzOA==", "bodyText": "These commented lines could be a nice Javadoc for the method; what do you think of moving them to a Javadoc block?", "url": "https://github.com/apache/cloudstack/pull/4228#discussion_r468349438", "createdAt": "2020-08-11T06:15:44Z", "author": {"login": "GabrielBrascher"}, "path": "agent/src/main/java/com/cloud/agent/Agent.java", "diffHunk": "@@ -419,6 +419,15 @@ protected void cancelTasks() {\n         }\n     }\n \n+    protected void cleanupAgentZoneProperties() {\n+        // Unset zone, cluster and pod values so that host is not added back\n+        // when service is restarted. This will be set to proper values\n+        // when host is added back", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f06a04f21564d00c8cd6953fec74ef1e2aa10e0f"}, "originalPosition": 7}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f06a04f21564d00c8cd6953fec74ef1e2aa10e0f", "author": {"user": {"login": "ravening", "name": "Rakesh"}}, "url": "https://github.com/apache/cloudstack/commit/f06a04f21564d00c8cd6953fec74ef1e2aa10e0f", "committedDate": "2020-08-05T13:28:37Z", "message": "Simplify ternary operator"}, "afterCommit": {"oid": "bad37509e0c9cd7ec9ead0f644ded4db6a523665", "author": {"user": {"login": "ravening", "name": "Rakesh"}}, "url": "https://github.com/apache/cloudstack/commit/bad37509e0c9cd7ec9ead0f644ded4db6a523665", "committedDate": "2020-08-11T08:24:02Z", "message": "Javadoc, naming convention"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NTI3MTk2", "url": "https://github.com/apache/cloudstack/pull/4228#pullrequestreview-479527196", "createdAt": "2020-09-01T08:46:53Z", "commit": {"oid": "bad37509e0c9cd7ec9ead0f644ded4db6a523665"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwODo0Njo1M1rOHKsY5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwODo0Njo1M1rOHKsY5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk3NTA3OQ==", "bodyText": "If this is KVM specific can we add kvm in the global setting name @ravening ?", "url": "https://github.com/apache/cloudstack/pull/4228#discussion_r480975079", "createdAt": "2020-09-01T08:46:53Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/com/cloud/configuration/ConfigurationManagerImpl.java", "diffHunk": "@@ -410,6 +410,10 @@\n     public final static ConfigKey<Long> IOPS_MAX_WRITE_LENGTH = new ConfigKey<Long>(Long.class, \"vm.disk.iops.maximum.write.length\", \"Advanced\", \"0\",\n             \"Maximum IOPS write burst duration (seconds). If '0' (zero) then does not check for maximum burst length.\", true, ConfigKey.Scope.Global, null);\n \n+    public static final ConfigKey<Boolean> ADD_HOST_ON_SERVICE_RESTART = new ConfigKey<Boolean>(Boolean.class, \"add.host.on.service.restart\", \"Advanced\", \"true\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bad37509e0c9cd7ec9ead0f644ded4db6a523665"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5f2b5276f0519b846a9070b23dbdfafa3f3f770", "author": {"user": {"login": "ravening", "name": "Rakesh"}}, "url": "https://github.com/apache/cloudstack/commit/f5f2b5276f0519b846a9070b23dbdfafa3f3f770", "committedDate": "2020-09-02T12:31:21Z", "message": "Dont add host back after cloudstack-agent service restart\n\nIf a host is removed from cloudstack, it will be\nadded back if we restart the agent service on\nthe host. It should not be added back if manualy\nremoved.\n\nAdd a global setting \"add.host.on.service.restart\" with\ndefault value of true. If set to false, the zoneid,\nclusterid and podid in agent.properties will be set to\nnull so that when service is restarted, the agent is not\nadded back\n\nIf true these values will not be set to null so that it\ncan be still added back on service restart"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d00a6a3d809d286f0fba180d13b0a6abee3b8a0", "author": {"user": {"login": "ravening", "name": "Rakesh"}}, "url": "https://github.com/apache/cloudstack/commit/9d00a6a3d809d286f0fba180d13b0a6abee3b8a0", "committedDate": "2020-09-02T12:31:21Z", "message": "Simplify ternary operator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6eeb0b06b6bbe1bbc47983435057f53d5630a19", "author": {"user": {"login": "ravening", "name": "Rakesh"}}, "url": "https://github.com/apache/cloudstack/commit/e6eeb0b06b6bbe1bbc47983435057f53d5630a19", "committedDate": "2020-09-02T12:31:21Z", "message": "Javadoc, naming convention"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33e636d65675a0f99684cbf5d6caa67503be68ec", "author": {"user": {"login": "ravening", "name": "Rakesh"}}, "url": "https://github.com/apache/cloudstack/commit/33e636d65675a0f99684cbf5d6caa67503be68ec", "committedDate": "2020-09-02T12:34:13Z", "message": "Make the setting kvm specific"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bad37509e0c9cd7ec9ead0f644ded4db6a523665", "author": {"user": {"login": "ravening", "name": "Rakesh"}}, "url": "https://github.com/apache/cloudstack/commit/bad37509e0c9cd7ec9ead0f644ded4db6a523665", "committedDate": "2020-08-11T08:24:02Z", "message": "Javadoc, naming convention"}, "afterCommit": {"oid": "33e636d65675a0f99684cbf5d6caa67503be68ec", "author": {"user": {"login": "ravening", "name": "Rakesh"}}, "url": "https://github.com/apache/cloudstack/commit/33e636d65675a0f99684cbf5d6caa67503be68ec", "committedDate": "2020-09-02T12:34:13Z", "message": "Make the setting kvm specific"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MjY5NDE0", "url": "https://github.com/apache/cloudstack/pull/4228#pullrequestreview-495269414", "createdAt": "2020-09-24T06:56:44Z", "commit": {"oid": "33e636d65675a0f99684cbf5d6caa67503be68ec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MzA1NTUy", "url": "https://github.com/apache/cloudstack/pull/4228#pullrequestreview-508305552", "createdAt": "2020-10-14T12:46:04Z", "commit": {"oid": "33e636d65675a0f99684cbf5d6caa67503be68ec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3973, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}