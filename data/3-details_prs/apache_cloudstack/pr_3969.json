{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5MjMxNjgw", "number": 3969, "title": "Snapshot deletion issues", "bodyText": "Description\n\ncopy of PR #3649 on a joint account for easier cooperation.\nTested both cases:\n\nSnapshot backed up on Secondary - manual and scheduled\nSnapshot stored only on primary storage (works with KVM + Ceph only)\n\nNote: @GabrielBrascher changed the name of the strategy from XenserverSnapshotStrategy to DefaultSnapshotStrategy due to the fact that the \"Xenserver\" strategy handles also Ceph, KVM, and do return StrategyPriority.DEFAULT in any case except REVERT.\n    @Override\n    public StrategyPriority canHandle(Snapshot snapshot, SnapshotOperation op) {\n        if (SnapshotOperation.REVERT.equals(op)) {\n            long volumeId = snapshot.getVolumeId();\n            VolumeVO volumeVO = volumeDao.findById(volumeId);\n\n            if (volumeVO != null && ImageFormat.QCOW2.equals(volumeVO.getFormat())) {\n                return StrategyPriority.DEFAULT;\n            }\n            return StrategyPriority.CANT_HANDLE;\n        }\n        return StrategyPriority.DEFAULT;\n    }\n\nFixes: #3646\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nWHAT HAS BEEN FIXED / WORKs FINE:\n\nVMware, KVM - no garbage on Secondary/Primary store (snapshot.backup.to.secondary=TRUE)\ud83d\udc4d\n-- snapshot.backup.to.secondary=FALSE - works (by design) only with KVM+Ceph - no garbage on Secondary/Primary storage \ud83d\udc4d\n---  snapshot.backup.to.secondary=FALSE  does NOT work (by design) with other hypervisors/storage combo - so don't bother trying \ud83d\ude04\nad-hoc single XenServer volume snapshot (i.e.NOT consecutive snaps/scheduled snaps \ud83d\udc4e )\n\nWHAT HAS NOT BEEN FIXED (tracked via #4018 ):\n\nMajor: XenServer consecutive/scheduled volume snapshots, since having parent/child relation (vs. VMware and KVM where consecutive/scheduled snaps are NOT chained (no parent/child relation)) - continues to be broken - i.e. one can continue to create/use XS volume snaps, but they are not removed properly on Primary and Secondary storage and thus leave garbage all over the place - eventually, there might happen the \"Snapshot chain too long\" error from Xen (see #4018 for the possible workaround/fix and a bit more explanation on how it works atm) \ud83d\udc4e \ud83d\udc4e \ud83d\udc4e\nMinor: VMware and KVM PRIMARY references (role_type=primary) are NOT removed from the snapshot_store_ref table - minor garbage, but to be fixed eventually \ud83d\udc4e", "createdAt": "2020-03-16T13:22:14Z", "url": "https://github.com/apache/cloudstack/pull/3969", "merged": true, "mergeCommit": {"oid": "f18fe5e1da1b0c7a2eb88a93301f3ea6df4ba3ad"}, "closed": true, "closedAt": "2020-04-11T14:40:28Z", "author": {"login": "DaanHoogland"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcONf2zgH2gAyMzg5MjMxNjgwOmFmZDA2MGI1NGY0ODc0NGNhZjQ4MzZlNGE2MzM0ZGMxNzExYjJiMTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWlSv_gFqTM5MTc2NDM3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "afd060b54f48744caf4836e4a6334dc1711b2b17", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/afd060b54f48744caf4836e4a6334dc1711b2b17", "committedDate": "2020-03-16T12:44:35Z", "message": "Fixes snapshot deletion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8191b4da4815af8a3a13adcdd9f4692faf24d284", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/8191b4da4815af8a3a13adcdd9f4692faf24d284", "committedDate": "2020-03-16T12:44:35Z", "message": "Remove legacy '@Component', it is not necessary in this bean/class."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc9387fb91918e02cc1296a3c82f563795bf89ea", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/bc9387fb91918e02cc1296a3c82f563795bf89ea", "committedDate": "2020-03-16T12:44:35Z", "message": "Fix log message missing %d and remove snapshot on DB"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e109949e3a9e386b810c28132de6de420f5d6a03", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/e109949e3a9e386b810c28132de6de420f5d6a03", "committedDate": "2020-03-16T12:44:35Z", "message": "Remove \"dummy\" boolean return statement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d31ecb8cfccf13096f8d6013e804b598cbfe0b38", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/d31ecb8cfccf13096f8d6013e804b598cbfe0b38", "committedDate": "2020-03-16T12:44:35Z", "message": "Manage snapshot deletion for KVM + NFS (primary storage)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "814af6a1829b5835e240cc2b50aa9bde20ce2637", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/814af6a1829b5835e240cc2b50aa9bde20ce2637", "committedDate": "2020-03-16T12:44:35Z", "message": "checkstyle trailing spaces"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0bc85ba97549bc72bf9faf843238b7e4ac5a40d", "author": {"user": {"login": "DaanHoogland", "name": "dahn"}}, "url": "https://github.com/apache/cloudstack/commit/a0bc85ba97549bc72bf9faf843238b7e4ac5a40d", "committedDate": "2020-03-16T14:38:21Z", "message": "rename options strings to *_OPTION"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NTY2MTI2", "url": "https://github.com/apache/cloudstack/pull/3969#pullrequestreview-375566126", "createdAt": "2020-03-16T20:40:35Z", "commit": {"oid": "a0bc85ba97549bc72bf9faf843238b7e4ac5a40d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMDo0MDozNVrOF3E8vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQyMDo0MDozNVrOF3E8vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI5NzA4Nw==", "bodyText": "going to fix the \"secundary\" typo", "url": "https://github.com/apache/cloudstack/pull/3969#discussion_r393297087", "createdAt": "2020-03-16T20:40:35Z", "author": {"login": "GabrielBrascher"}, "path": "engine/storage/snapshot/src/main/java/org/apache/cloudstack/storage/snapshot/DefaultSnapshotStrategy.java", "diffHunk": "@@ -269,63 +262,87 @@ public boolean deleteSnapshot(Long snapshotId) {\n             throw new InvalidParameterValueException(\"Can't delete snapshotshot \" + snapshotId + \" due to it is in \" + snapshotVO.getState() + \" Status\");\n         }\n \n-        // first mark the snapshot as destroyed, so that ui can't see it, but we\n-        // may not destroy the snapshot on the storage, as other snapshots may\n-        // depend on it.\n         SnapshotInfo snapshotOnImage = snapshotDataFactory.getSnapshot(snapshotId, DataStoreRole.Image);\n-        if (snapshotOnImage == null) {\n-            s_logger.debug(\"Can't find snapshot on backup storage, delete it in db\");\n-            snapshotDao.remove(snapshotId);\n-            return true;\n-        }\n-\n-        SnapshotObject obj = (SnapshotObject)snapshotOnImage;\n-        try {\n-            obj.processEvent(Snapshot.Event.DestroyRequested);\n-            List<VolumeDetailVO> volumesFromSnapshot;\n-            volumesFromSnapshot = _volumeDetailsDaoImpl.findDetails(\"SNAPSHOT_ID\", String.valueOf(snapshotId), null);\n \n-            if (volumesFromSnapshot.size() > 0) {\n-                try {\n-                    obj.processEvent(Snapshot.Event.OperationFailed);\n-                } catch (NoTransitionException e1) {\n-                    s_logger.debug(\"Failed to change snapshot state: \" + e1.toString());\n+        boolean deletedOnSecondary = false;\n+        if (snapshotOnImage == null) {\n+            s_logger.debug(String.format(\"Can't find snapshot [snapshot id: %d] on backup storage\", snapshotId));\n+        } else {\n+            SnapshotObject obj = (SnapshotObject)snapshotOnImage;\n+            try {\n+                deletedOnSecondary = deleteSnapshotOnSecundaryStorage(snapshotId, snapshotOnImage, obj);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0bc85ba97549bc72bf9faf843238b7e4ac5a40d"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7121967892d5b0bb3ae9a68b41ad4505eadd49c2", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/7121967892d5b0bb3ae9a68b41ad4505eadd49c2", "committedDate": "2020-03-17T13:43:30Z", "message": "Fix typo on deleteSnapshotOnSecondaryStorage and enhance log message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NTc4ODQz", "url": "https://github.com/apache/cloudstack/pull/3969#pullrequestreview-384578843", "createdAt": "2020-03-31T09:57:37Z", "commit": {"oid": "7121967892d5b0bb3ae9a68b41ad4505eadd49c2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwOTo1NzozN1rOF-OJGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwOTo1NzozN1rOF-OJGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc4NzczNg==", "bodyText": "Perhaps this is leading to the record having a removed date on the snapshots table which later on causes issues during GC ?", "url": "https://github.com/apache/cloudstack/pull/3969#discussion_r400787736", "createdAt": "2020-03-31T09:57:37Z", "author": {"login": "davidjumani"}, "path": "engine/storage/snapshot/src/main/java/org/apache/cloudstack/storage/snapshot/DefaultSnapshotStrategy.java", "diffHunk": "@@ -269,63 +262,87 @@ public boolean deleteSnapshot(Long snapshotId) {\n             throw new InvalidParameterValueException(\"Can't delete snapshotshot \" + snapshotId + \" due to it is in \" + snapshotVO.getState() + \" Status\");\n         }\n \n-        // first mark the snapshot as destroyed, so that ui can't see it, but we\n-        // may not destroy the snapshot on the storage, as other snapshots may\n-        // depend on it.\n         SnapshotInfo snapshotOnImage = snapshotDataFactory.getSnapshot(snapshotId, DataStoreRole.Image);\n-        if (snapshotOnImage == null) {\n-            s_logger.debug(\"Can't find snapshot on backup storage, delete it in db\");\n-            snapshotDao.remove(snapshotId);\n-            return true;\n-        }\n-\n-        SnapshotObject obj = (SnapshotObject)snapshotOnImage;\n-        try {\n-            obj.processEvent(Snapshot.Event.DestroyRequested);\n-            List<VolumeDetailVO> volumesFromSnapshot;\n-            volumesFromSnapshot = _volumeDetailsDaoImpl.findDetails(\"SNAPSHOT_ID\", String.valueOf(snapshotId), null);\n \n-            if (volumesFromSnapshot.size() > 0) {\n-                try {\n-                    obj.processEvent(Snapshot.Event.OperationFailed);\n-                } catch (NoTransitionException e1) {\n-                    s_logger.debug(\"Failed to change snapshot state: \" + e1.toString());\n+        boolean deletedOnSecondary = false;\n+        if (snapshotOnImage == null) {\n+            s_logger.debug(String.format(\"Can't find snapshot [snapshot id: %d] on backup storage\", snapshotId));\n+        } else {\n+            SnapshotObject obj = (SnapshotObject)snapshotOnImage;\n+            try {\n+                deletedOnSecondary = deleteSnapshotOnSecondaryStorage(snapshotId, snapshotOnImage, obj);\n+                if (!deletedOnSecondary) {\n+                    s_logger.debug(\n+                            String.format(\"Failed to find/delete snapshot (id: %d) on secondary storage. Still necessary to check and delete snapshot on primary storage.\",\n+                                    snapshotId));\n+                } else {\n+                    s_logger.debug(String.format(\"Snapshot (id: %d) has been deleted on secondary storage.\", snapshotId));\n                 }\n-                throw new InvalidParameterValueException(\"Unable to perform delete operation, Snapshot with id: \" + snapshotId + \" is in use  \");\n+            } catch (NoTransitionException e) {\n+                s_logger.debug(\"Failed to set the state to destroying: \", e);\n+                return false;\n             }\n-        } catch (NoTransitionException e) {\n-            s_logger.debug(\"Failed to set the state to destroying: \", e);\n-            return false;\n         }\n \n-        try {\n-            boolean result = deleteSnapshotChain(snapshotOnImage);\n-            obj.processEvent(Snapshot.Event.OperationSucceeded);\n-            if (result) {\n-                //snapshot is deleted on backup storage, need to delete it on primary storage\n-                SnapshotDataStoreVO snapshotOnPrimary = snapshotStoreDao.findBySnapshot(snapshotId, DataStoreRole.Primary);\n-                if (snapshotOnPrimary != null) {\n-                    SnapshotInfo snapshotOnPrimaryInfo = snapshotDataFactory.getSnapshot(snapshotId, DataStoreRole.Primary);\n-                    long volumeId = snapshotOnPrimary.getVolumeId();\n-                    VolumeVO volumeVO = volumeDao.findById(volumeId);\n-                    if (((PrimaryDataStoreImpl)snapshotOnPrimaryInfo.getDataStore()).getPoolType() == StoragePoolType.RBD && volumeVO != null) {\n-                        snapshotSvr.deleteSnapshot(snapshotOnPrimaryInfo);\n-                    }\n-                    snapshotOnPrimary.setState(State.Destroyed);\n-                    snapshotStoreDao.update(snapshotOnPrimary.getId(), snapshotOnPrimary);\n-                }\n-            }\n-        } catch (Exception e) {\n-            s_logger.debug(\"Failed to delete snapshot: \", e);\n+        boolean deletedOnPrimary = deleteSnapshotOnPrimary(snapshotId);\n+        if (deletedOnPrimary) {\n+            s_logger.debug(String.format(\"Successfully deleted snapshot (id: %d) on primary storage.\", snapshotId));\n+        } else if (deletedOnSecondary) {\n+            s_logger.debug(String.format(\"The snapshot was deleted on secondary storage. Could not find/delete snapshot (id: %d) on primary storage.\", snapshotId));\n+        }\n+        return deletedOnSecondary || deletedOnPrimary;\n+    }\n+\n+    /**\n+     * Deletes the snapshot on secondary storage.\n+     * It can return false when the snapshot was stored on primary storage and not backed up on secondary; therefore, the snapshot should also be deleted on primary storage even when this method returns false.\n+     */\n+    private boolean deleteSnapshotOnSecondaryStorage(Long snapshotId, SnapshotInfo snapshotOnImage, SnapshotObject obj) throws NoTransitionException {\n+        obj.processEvent(Snapshot.Event.DestroyRequested);\n+        List<VolumeDetailVO> volumesFromSnapshot;\n+        volumesFromSnapshot = _volumeDetailsDaoImpl.findDetails(\"SNAPSHOT_ID\", String.valueOf(snapshotId), null);\n+\n+        if (volumesFromSnapshot.size() > 0) {\n             try {\n                 obj.processEvent(Snapshot.Event.OperationFailed);\n             } catch (NoTransitionException e1) {\n-                s_logger.debug(\"Failed to change snapshot state: \" + e.toString());\n+                s_logger.debug(\"Failed to change snapshot state: \" + e1.toString());\n             }\n-            return false;\n+            throw new InvalidParameterValueException(\"Unable to perform delete operation, Snapshot with id: \" + snapshotId + \" is in use  \");\n         }\n \n-        return true;\n+        boolean result = deleteSnapshotChain(snapshotOnImage);\n+        obj.processEvent(Snapshot.Event.OperationSucceeded);\n+        return result;\n+    }\n+\n+    /**\n+     * Deletes the snapshot on primary storage. It can return false when the snapshot was not stored on primary storage; however this does not means that it failed to delete the snapshot. </br>\n+     * In case of failure, it will throw one of the following exceptions: CloudRuntimeException, InterruptedException, or ExecutionException. </br>\n+     */\n+    private boolean deleteSnapshotOnPrimary(Long snapshotId) {\n+        SnapshotDataStoreVO snapshotOnPrimary = snapshotStoreDao.findBySnapshot(snapshotId, DataStoreRole.Primary);\n+        SnapshotInfo snapshotOnPrimaryInfo = snapshotDataFactory.getSnapshot(snapshotId, DataStoreRole.Primary);\n+        if (isSnapshotOnPrimaryStorage(snapshotId) && snapshotSvr.deleteSnapshot(snapshotOnPrimaryInfo)) {\n+            snapshotOnPrimary.setState(State.Destroyed);\n+            snapshotStoreDao.update(snapshotOnPrimary.getId(), snapshotOnPrimary);\n+            snapshotDao.remove(snapshotId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7121967892d5b0bb3ae9a68b41ad4505eadd49c2"}, "originalPosition": 154}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0Njk1MjEw", "url": "https://github.com/apache/cloudstack/pull/3969#pullrequestreview-384695210", "createdAt": "2020-03-31T12:46:17Z", "commit": {"oid": "7121967892d5b0bb3ae9a68b41ad4505eadd49c2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMjo0NjoxN1rOF-T_-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMjo0NjoxN1rOF-T_-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg4MzcwNg==", "bodyText": "Can remove the snapshot entry here instead ?", "url": "https://github.com/apache/cloudstack/pull/3969#discussion_r400883706", "createdAt": "2020-03-31T12:46:17Z", "author": {"login": "davidjumani"}, "path": "engine/storage/snapshot/src/main/java/org/apache/cloudstack/storage/snapshot/DefaultSnapshotStrategy.java", "diffHunk": "@@ -269,63 +262,87 @@ public boolean deleteSnapshot(Long snapshotId) {\n             throw new InvalidParameterValueException(\"Can't delete snapshotshot \" + snapshotId + \" due to it is in \" + snapshotVO.getState() + \" Status\");\n         }\n \n-        // first mark the snapshot as destroyed, so that ui can't see it, but we\n-        // may not destroy the snapshot on the storage, as other snapshots may\n-        // depend on it.\n         SnapshotInfo snapshotOnImage = snapshotDataFactory.getSnapshot(snapshotId, DataStoreRole.Image);\n-        if (snapshotOnImage == null) {\n-            s_logger.debug(\"Can't find snapshot on backup storage, delete it in db\");\n-            snapshotDao.remove(snapshotId);\n-            return true;\n-        }\n-\n-        SnapshotObject obj = (SnapshotObject)snapshotOnImage;\n-        try {\n-            obj.processEvent(Snapshot.Event.DestroyRequested);\n-            List<VolumeDetailVO> volumesFromSnapshot;\n-            volumesFromSnapshot = _volumeDetailsDaoImpl.findDetails(\"SNAPSHOT_ID\", String.valueOf(snapshotId), null);\n \n-            if (volumesFromSnapshot.size() > 0) {\n-                try {\n-                    obj.processEvent(Snapshot.Event.OperationFailed);\n-                } catch (NoTransitionException e1) {\n-                    s_logger.debug(\"Failed to change snapshot state: \" + e1.toString());\n+        boolean deletedOnSecondary = false;\n+        if (snapshotOnImage == null) {\n+            s_logger.debug(String.format(\"Can't find snapshot [snapshot id: %d] on backup storage\", snapshotId));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7121967892d5b0bb3ae9a68b41ad4505eadd49c2"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3eafab4221543496dd905de643bab67494b248e9", "author": {"user": {"login": "andrijapanicsb", "name": "Andrija Panic"}}, "url": "https://github.com/apache/cloudstack/commit/3eafab4221543496dd905de643bab67494b248e9", "committedDate": "2020-04-01T12:27:27Z", "message": "Move the snapshotDao.remove(snapshotId); (#4006)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NjY5MDE1", "url": "https://github.com/apache/cloudstack/pull/3969#pullrequestreview-385669015", "createdAt": "2020-04-01T14:57:14Z", "commit": {"oid": "7121967892d5b0bb3ae9a68b41ad4505eadd49c2"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNDo1NzoxNFrOF_EqZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNToxNTozM1rOF_FhYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY4MDk5Ng==", "bodyText": "@davidjumani @harikrishna-patnala it might work placing snapshotDao.remove(snapshotId) here, indeed.\nHowever, I see a potential problem in the case thre is no snapshot backed up on secondary and deletion fails at the primary storage. In such a case it would remove the snapshot entry before removing the snapshot on primary storage. Not sure if this could lead to a snapshot garbage issue on primary storage (instead of on secondary).\nWhat do you think? Does this observation make sense?", "url": "https://github.com/apache/cloudstack/pull/3969#discussion_r401680996", "createdAt": "2020-04-01T14:57:14Z", "author": {"login": "GabrielBrascher"}, "path": "engine/storage/snapshot/src/main/java/org/apache/cloudstack/storage/snapshot/DefaultSnapshotStrategy.java", "diffHunk": "@@ -269,63 +262,87 @@ public boolean deleteSnapshot(Long snapshotId) {\n             throw new InvalidParameterValueException(\"Can't delete snapshotshot \" + snapshotId + \" due to it is in \" + snapshotVO.getState() + \" Status\");\n         }\n \n-        // first mark the snapshot as destroyed, so that ui can't see it, but we\n-        // may not destroy the snapshot on the storage, as other snapshots may\n-        // depend on it.\n         SnapshotInfo snapshotOnImage = snapshotDataFactory.getSnapshot(snapshotId, DataStoreRole.Image);\n-        if (snapshotOnImage == null) {\n-            s_logger.debug(\"Can't find snapshot on backup storage, delete it in db\");\n-            snapshotDao.remove(snapshotId);\n-            return true;\n-        }\n-\n-        SnapshotObject obj = (SnapshotObject)snapshotOnImage;\n-        try {\n-            obj.processEvent(Snapshot.Event.DestroyRequested);\n-            List<VolumeDetailVO> volumesFromSnapshot;\n-            volumesFromSnapshot = _volumeDetailsDaoImpl.findDetails(\"SNAPSHOT_ID\", String.valueOf(snapshotId), null);\n \n-            if (volumesFromSnapshot.size() > 0) {\n-                try {\n-                    obj.processEvent(Snapshot.Event.OperationFailed);\n-                } catch (NoTransitionException e1) {\n-                    s_logger.debug(\"Failed to change snapshot state: \" + e1.toString());\n+        boolean deletedOnSecondary = false;\n+        if (snapshotOnImage == null) {\n+            s_logger.debug(String.format(\"Can't find snapshot [snapshot id: %d] on backup storage\", snapshotId));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg4MzcwNg=="}, "originalCommit": {"oid": "7121967892d5b0bb3ae9a68b41ad4505eadd49c2"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY5NTA3Mg==", "bodyText": "That looks like the issue indeed, I will take a second look at this.", "url": "https://github.com/apache/cloudstack/pull/3969#discussion_r401695072", "createdAt": "2020-04-01T15:15:33Z", "author": {"login": "GabrielBrascher"}, "path": "engine/storage/snapshot/src/main/java/org/apache/cloudstack/storage/snapshot/DefaultSnapshotStrategy.java", "diffHunk": "@@ -269,63 +262,87 @@ public boolean deleteSnapshot(Long snapshotId) {\n             throw new InvalidParameterValueException(\"Can't delete snapshotshot \" + snapshotId + \" due to it is in \" + snapshotVO.getState() + \" Status\");\n         }\n \n-        // first mark the snapshot as destroyed, so that ui can't see it, but we\n-        // may not destroy the snapshot on the storage, as other snapshots may\n-        // depend on it.\n         SnapshotInfo snapshotOnImage = snapshotDataFactory.getSnapshot(snapshotId, DataStoreRole.Image);\n-        if (snapshotOnImage == null) {\n-            s_logger.debug(\"Can't find snapshot on backup storage, delete it in db\");\n-            snapshotDao.remove(snapshotId);\n-            return true;\n-        }\n-\n-        SnapshotObject obj = (SnapshotObject)snapshotOnImage;\n-        try {\n-            obj.processEvent(Snapshot.Event.DestroyRequested);\n-            List<VolumeDetailVO> volumesFromSnapshot;\n-            volumesFromSnapshot = _volumeDetailsDaoImpl.findDetails(\"SNAPSHOT_ID\", String.valueOf(snapshotId), null);\n \n-            if (volumesFromSnapshot.size() > 0) {\n-                try {\n-                    obj.processEvent(Snapshot.Event.OperationFailed);\n-                } catch (NoTransitionException e1) {\n-                    s_logger.debug(\"Failed to change snapshot state: \" + e1.toString());\n+        boolean deletedOnSecondary = false;\n+        if (snapshotOnImage == null) {\n+            s_logger.debug(String.format(\"Can't find snapshot [snapshot id: %d] on backup storage\", snapshotId));\n+        } else {\n+            SnapshotObject obj = (SnapshotObject)snapshotOnImage;\n+            try {\n+                deletedOnSecondary = deleteSnapshotOnSecondaryStorage(snapshotId, snapshotOnImage, obj);\n+                if (!deletedOnSecondary) {\n+                    s_logger.debug(\n+                            String.format(\"Failed to find/delete snapshot (id: %d) on secondary storage. Still necessary to check and delete snapshot on primary storage.\",\n+                                    snapshotId));\n+                } else {\n+                    s_logger.debug(String.format(\"Snapshot (id: %d) has been deleted on secondary storage.\", snapshotId));\n                 }\n-                throw new InvalidParameterValueException(\"Unable to perform delete operation, Snapshot with id: \" + snapshotId + \" is in use  \");\n+            } catch (NoTransitionException e) {\n+                s_logger.debug(\"Failed to set the state to destroying: \", e);\n+                return false;\n             }\n-        } catch (NoTransitionException e) {\n-            s_logger.debug(\"Failed to set the state to destroying: \", e);\n-            return false;\n         }\n \n-        try {\n-            boolean result = deleteSnapshotChain(snapshotOnImage);\n-            obj.processEvent(Snapshot.Event.OperationSucceeded);\n-            if (result) {\n-                //snapshot is deleted on backup storage, need to delete it on primary storage\n-                SnapshotDataStoreVO snapshotOnPrimary = snapshotStoreDao.findBySnapshot(snapshotId, DataStoreRole.Primary);\n-                if (snapshotOnPrimary != null) {\n-                    SnapshotInfo snapshotOnPrimaryInfo = snapshotDataFactory.getSnapshot(snapshotId, DataStoreRole.Primary);\n-                    long volumeId = snapshotOnPrimary.getVolumeId();\n-                    VolumeVO volumeVO = volumeDao.findById(volumeId);\n-                    if (((PrimaryDataStoreImpl)snapshotOnPrimaryInfo.getDataStore()).getPoolType() == StoragePoolType.RBD && volumeVO != null) {\n-                        snapshotSvr.deleteSnapshot(snapshotOnPrimaryInfo);\n-                    }\n-                    snapshotOnPrimary.setState(State.Destroyed);\n-                    snapshotStoreDao.update(snapshotOnPrimary.getId(), snapshotOnPrimary);\n-                }\n-            }\n-        } catch (Exception e) {\n-            s_logger.debug(\"Failed to delete snapshot: \", e);\n+        boolean deletedOnPrimary = deleteSnapshotOnPrimary(snapshotId);\n+        if (deletedOnPrimary) {\n+            s_logger.debug(String.format(\"Successfully deleted snapshot (id: %d) on primary storage.\", snapshotId));\n+        } else if (deletedOnSecondary) {\n+            s_logger.debug(String.format(\"The snapshot was deleted on secondary storage. Could not find/delete snapshot (id: %d) on primary storage.\", snapshotId));\n+        }\n+        return deletedOnSecondary || deletedOnPrimary;\n+    }\n+\n+    /**\n+     * Deletes the snapshot on secondary storage.\n+     * It can return false when the snapshot was stored on primary storage and not backed up on secondary; therefore, the snapshot should also be deleted on primary storage even when this method returns false.\n+     */\n+    private boolean deleteSnapshotOnSecondaryStorage(Long snapshotId, SnapshotInfo snapshotOnImage, SnapshotObject obj) throws NoTransitionException {\n+        obj.processEvent(Snapshot.Event.DestroyRequested);\n+        List<VolumeDetailVO> volumesFromSnapshot;\n+        volumesFromSnapshot = _volumeDetailsDaoImpl.findDetails(\"SNAPSHOT_ID\", String.valueOf(snapshotId), null);\n+\n+        if (volumesFromSnapshot.size() > 0) {\n             try {\n                 obj.processEvent(Snapshot.Event.OperationFailed);\n             } catch (NoTransitionException e1) {\n-                s_logger.debug(\"Failed to change snapshot state: \" + e.toString());\n+                s_logger.debug(\"Failed to change snapshot state: \" + e1.toString());\n             }\n-            return false;\n+            throw new InvalidParameterValueException(\"Unable to perform delete operation, Snapshot with id: \" + snapshotId + \" is in use  \");\n         }\n \n-        return true;\n+        boolean result = deleteSnapshotChain(snapshotOnImage);\n+        obj.processEvent(Snapshot.Event.OperationSucceeded);\n+        return result;\n+    }\n+\n+    /**\n+     * Deletes the snapshot on primary storage. It can return false when the snapshot was not stored on primary storage; however this does not means that it failed to delete the snapshot. </br>\n+     * In case of failure, it will throw one of the following exceptions: CloudRuntimeException, InterruptedException, or ExecutionException. </br>\n+     */\n+    private boolean deleteSnapshotOnPrimary(Long snapshotId) {\n+        SnapshotDataStoreVO snapshotOnPrimary = snapshotStoreDao.findBySnapshot(snapshotId, DataStoreRole.Primary);\n+        SnapshotInfo snapshotOnPrimaryInfo = snapshotDataFactory.getSnapshot(snapshotId, DataStoreRole.Primary);\n+        if (isSnapshotOnPrimaryStorage(snapshotId) && snapshotSvr.deleteSnapshot(snapshotOnPrimaryInfo)) {\n+            snapshotOnPrimary.setState(State.Destroyed);\n+            snapshotStoreDao.update(snapshotOnPrimary.getId(), snapshotOnPrimary);\n+            snapshotDao.remove(snapshotId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc4NzczNg=="}, "originalCommit": {"oid": "7121967892d5b0bb3ae9a68b41ad4505eadd49c2"}, "originalPosition": 154}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9847b841049154ee9124dbbed5354eadcaca301d", "author": {"user": {"login": "harikrishna-patnala", "name": "Harikrishna"}}, "url": "https://github.com/apache/cloudstack/commit/9847b841049154ee9124dbbed5354eadcaca301d", "committedDate": "2020-04-04T14:21:57Z", "message": "Fix deletesnapshot worflow to handle both snapshots created in primary storage and snapshots backed up to secondary storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4bef7b6434cd35b52ec0fb12a8729397465054a", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/e4bef7b6434cd35b52ec0fb12a8729397465054a", "committedDate": "2020-04-04T14:38:12Z", "message": "Fix extra space"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4MDM1NDg5", "url": "https://github.com/apache/cloudstack/pull/3969#pullrequestreview-388035489", "createdAt": "2020-04-06T08:31:16Z", "commit": {"oid": "9847b841049154ee9124dbbed5354eadcaca301d"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQwODozMToxNlrOGBNDyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQwODozNTowOFrOGBNM0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkxNTcyMA==", "bodyText": "@harikrishna-patnala can you factor this bit out, please?", "url": "https://github.com/apache/cloudstack/pull/3969#discussion_r403915720", "createdAt": "2020-04-06T08:31:16Z", "author": {"login": "DaanHoogland"}, "path": "engine/storage/snapshot/src/main/java/org/apache/cloudstack/storage/snapshot/DefaultSnapshotStrategy.java", "diffHunk": "@@ -285,7 +284,27 @@ public boolean deleteSnapshot(Long snapshotId) {\n             }\n         }\n \n-        boolean deletedOnPrimary = deleteSnapshotOnPrimary(snapshotId);\n+        boolean deletedOnPrimary = false;\n+        snapshotVO = snapshotDao.findById(snapshotId);\n+        SnapshotInfo snapshotOnPrimaryInfo = snapshotDataFactory.getSnapshot(snapshotId, DataStoreRole.Primary);\n+        if (snapshotVO != null && snapshotVO.getState() == Snapshot.State.Destroyed) {\n+            deletedOnPrimary = deleteSnapshotOnPrimary(snapshotId, snapshotOnPrimaryInfo);\n+        } else {\n+            // This is to handle snapshots which are created only on primary when snapshot.backup.to.secondary is set to false. \n+            SnapshotObject obj = (SnapshotObject) snapshotOnPrimaryInfo;\n+            try {\n+                obj.processEvent(Snapshot.Event.DestroyRequested);\n+                deletedOnPrimary = deleteSnapshotOnPrimary(snapshotId, snapshotOnPrimaryInfo);\n+                if (!deletedOnPrimary) {\n+                    obj.processEvent(Snapshot.Event.OperationFailed);\n+                } else {\n+                    obj.processEvent(Snapshot.Event.OperationSucceeded);\n+                }\n+            } catch (NoTransitionException e) {\n+            s_logger.debug(\"Failed to set the state to destroying: \", e);\n+            return false;\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9847b841049154ee9124dbbed5354eadcaca301d"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkxNTc2NA==", "bodyText": "and than factor this bit out again?", "url": "https://github.com/apache/cloudstack/pull/3969#discussion_r403915764", "createdAt": "2020-04-06T08:31:22Z", "author": {"login": "DaanHoogland"}, "path": "engine/storage/snapshot/src/main/java/org/apache/cloudstack/storage/snapshot/DefaultSnapshotStrategy.java", "diffHunk": "@@ -285,7 +284,27 @@ public boolean deleteSnapshot(Long snapshotId) {\n             }\n         }\n \n-        boolean deletedOnPrimary = deleteSnapshotOnPrimary(snapshotId);\n+        boolean deletedOnPrimary = false;\n+        snapshotVO = snapshotDao.findById(snapshotId);\n+        SnapshotInfo snapshotOnPrimaryInfo = snapshotDataFactory.getSnapshot(snapshotId, DataStoreRole.Primary);\n+        if (snapshotVO != null && snapshotVO.getState() == Snapshot.State.Destroyed) {\n+            deletedOnPrimary = deleteSnapshotOnPrimary(snapshotId, snapshotOnPrimaryInfo);\n+        } else {\n+            // This is to handle snapshots which are created only on primary when snapshot.backup.to.secondary is set to false. \n+            SnapshotObject obj = (SnapshotObject) snapshotOnPrimaryInfo;\n+            try {\n+                obj.processEvent(Snapshot.Event.DestroyRequested);\n+                deletedOnPrimary = deleteSnapshotOnPrimary(snapshotId, snapshotOnPrimaryInfo);\n+                if (!deletedOnPrimary) {\n+                    obj.processEvent(Snapshot.Event.OperationFailed);\n+                } else {\n+                    obj.processEvent(Snapshot.Event.OperationSucceeded);\n+                }\n+            } catch (NoTransitionException e) {\n+            s_logger.debug(\"Failed to set the state to destroying: \", e);\n+            return false;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9847b841049154ee9124dbbed5354eadcaca301d"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkxNzU4NQ==", "bodyText": "this comment does not seem to be in alignment with the code. How do we conclude that we are at this point in code because of the global setting 'snapshot.backup.to.secondary'?", "url": "https://github.com/apache/cloudstack/pull/3969#discussion_r403917585", "createdAt": "2020-04-06T08:34:22Z", "author": {"login": "DaanHoogland"}, "path": "engine/storage/snapshot/src/main/java/org/apache/cloudstack/storage/snapshot/DefaultSnapshotStrategy.java", "diffHunk": "@@ -285,7 +284,27 @@ public boolean deleteSnapshot(Long snapshotId) {\n             }\n         }\n \n-        boolean deletedOnPrimary = deleteSnapshotOnPrimary(snapshotId);\n+        boolean deletedOnPrimary = false;\n+        snapshotVO = snapshotDao.findById(snapshotId);\n+        SnapshotInfo snapshotOnPrimaryInfo = snapshotDataFactory.getSnapshot(snapshotId, DataStoreRole.Primary);\n+        if (snapshotVO != null && snapshotVO.getState() == Snapshot.State.Destroyed) {\n+            deletedOnPrimary = deleteSnapshotOnPrimary(snapshotId, snapshotOnPrimaryInfo);\n+        } else {\n+            // This is to handle snapshots which are created only on primary when snapshot.backup.to.secondary is set to false. ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9847b841049154ee9124dbbed5354eadcaca301d"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkxODAzNA==", "bodyText": "indent?", "url": "https://github.com/apache/cloudstack/pull/3969#discussion_r403918034", "createdAt": "2020-04-06T08:35:08Z", "author": {"login": "DaanHoogland"}, "path": "engine/storage/snapshot/src/main/java/org/apache/cloudstack/storage/snapshot/DefaultSnapshotStrategy.java", "diffHunk": "@@ -285,7 +284,27 @@ public boolean deleteSnapshot(Long snapshotId) {\n             }\n         }\n \n-        boolean deletedOnPrimary = deleteSnapshotOnPrimary(snapshotId);\n+        boolean deletedOnPrimary = false;\n+        snapshotVO = snapshotDao.findById(snapshotId);\n+        SnapshotInfo snapshotOnPrimaryInfo = snapshotDataFactory.getSnapshot(snapshotId, DataStoreRole.Primary);\n+        if (snapshotVO != null && snapshotVO.getState() == Snapshot.State.Destroyed) {\n+            deletedOnPrimary = deleteSnapshotOnPrimary(snapshotId, snapshotOnPrimaryInfo);\n+        } else {\n+            // This is to handle snapshots which are created only on primary when snapshot.backup.to.secondary is set to false. \n+            SnapshotObject obj = (SnapshotObject) snapshotOnPrimaryInfo;\n+            try {\n+                obj.processEvent(Snapshot.Event.DestroyRequested);\n+                deletedOnPrimary = deleteSnapshotOnPrimary(snapshotId, snapshotOnPrimaryInfo);\n+                if (!deletedOnPrimary) {\n+                    obj.processEvent(Snapshot.Event.OperationFailed);\n+                } else {\n+                    obj.processEvent(Snapshot.Event.OperationSucceeded);\n+                }\n+            } catch (NoTransitionException e) {\n+            s_logger.debug(\"Failed to set the state to destroying: \", e);\n+            return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9847b841049154ee9124dbbed5354eadcaca301d"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad26c8fa3bda01d906dda1ce331cfd82eb506995", "author": {"user": {"login": "DaanHoogland", "name": "dahn"}}, "url": "https://github.com/apache/cloudstack/commit/ad26c8fa3bda01d906dda1ce331cfd82eb506995", "committedDate": "2020-04-06T10:50:14Z", "message": "refactor out separate handling methods for secondary and primary (reducing returns)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1be6b999f2339a0b5665f4ff1dfc14265a156c30", "author": {"user": {"login": "DaanHoogland", "name": "dahn"}}, "url": "https://github.com/apache/cloudstack/commit/1be6b999f2339a0b5665f4ff1dfc14265a156c30", "committedDate": "2020-04-06T18:29:01Z", "message": "return false on unexpected error or log when expected"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NTMyNzg2", "url": "https://github.com/apache/cloudstack/pull/3969#pullrequestreview-388532786", "createdAt": "2020-04-06T18:59:39Z", "commit": {"oid": "1be6b999f2339a0b5665f4ff1dfc14265a156c30"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxODo1OTo0MFrOGBlrag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxODo1OTo0MFrOGBlrag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMxOTA4Mg==", "bodyText": "I guess that instead of null == deletedOnSecondary && deletedOnSecondary the it should be null == deletedOnPrimary && deletedOnSecondary, right? Or deletedOnSecondary != null && deletedOnSecondary.", "url": "https://github.com/apache/cloudstack/pull/3969#discussion_r404319082", "createdAt": "2020-04-06T18:59:40Z", "author": {"login": "GabrielBrascher"}, "path": "engine/storage/snapshot/src/main/java/org/apache/cloudstack/storage/snapshot/DefaultSnapshotStrategy.java", "diffHunk": "@@ -257,21 +257,23 @@ public boolean deleteSnapshot(Long snapshotId) {\n             return true;\n         }\n \n-        if (!Snapshot.State.BackedUp.equals(snapshotVO.getState()) && !Snapshot.State.Error.equals(snapshotVO.getState()) &&\n+        if (!Snapshot.State.BackedUp.equals(snapshotVO.getState()) &&\n                 !Snapshot.State.Destroying.equals(snapshotVO.getState())) {\n             throw new InvalidParameterValueException(\"Can't delete snapshotshot \" + snapshotId + \" due to it is in \" + snapshotVO.getState() + \" Status\");\n         }\n \n-        boolean deletedOnSecondary = deleteOnSecondaryIfNeeded(snapshotId);\n+        Boolean deletedOnSecondary = deleteOnSecondaryIfNeeded(snapshotId);\n         boolean deletedOnPrimary = deleteOnPrimaryIfNeeded(snapshotId);\n \n         if (deletedOnPrimary) {\n             s_logger.debug(String.format(\"Successfully deleted snapshot (id: %d) on primary storage.\", snapshotId));\n-        } else if (deletedOnSecondary) {\n-            s_logger.debug(String.format(\"The snapshot was deleted on secondary storage. Could not find/delete snapshot (id: %d) on primary storage.\", snapshotId));\n+        } else {\n+            s_logger.debug(String.format(\"The snapshot (id: %d) could not be found/deleted on primary storage.\", snapshotId));\n         }\n-\n-        return deletedOnSecondary || deletedOnPrimary;\n+        if (null == deletedOnSecondary && deletedOnSecondary) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1be6b999f2339a0b5665f4ff1dfc14265a156c30"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20cb0b23b2b818a7b7e6117fdb538f3a40b26a35", "author": {"user": {"login": "DaanHoogland", "name": "dahn"}}, "url": "https://github.com/apache/cloudstack/commit/20cb0b23b2b818a7b7e6117fdb538f3a40b26a35", "committedDate": "2020-04-06T19:44:57Z", "message": "!= instead of =="}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0aa1190990d851deb15b9863d38d3d35f7fb8c6b", "author": {"user": {"login": "andrijapanicsb", "name": "Andrija Panic"}}, "url": "https://github.com/apache/cloudstack/commit/0aa1190990d851deb15b9863d38d3d35f7fb8c6b", "committedDate": "2020-04-06T20:28:03Z", "message": "secondary instead of backup storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae1dad5a1f66e3ee8bc42cbd67713fafadfd37ff", "author": {"user": {"login": "DaanHoogland", "name": "dahn"}}, "url": "https://github.com/apache/cloudstack/commit/ae1dad5a1f66e3ee8bc42cbd67713fafadfd37ff", "committedDate": "2020-04-07T07:23:40Z", "message": "init to null"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MDM1OTUw", "url": "https://github.com/apache/cloudstack/pull/3969#pullrequestreview-389035950", "createdAt": "2020-04-07T11:45:42Z", "commit": {"oid": "ae1dad5a1f66e3ee8bc42cbd67713fafadfd37ff"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d62b54b7cafd7e2c399843a4245bff475a00504b", "author": {"user": {"login": "harikrishna-patnala", "name": "Harikrishna"}}, "url": "https://github.com/apache/cloudstack/commit/d62b54b7cafd7e2c399843a4245bff475a00504b", "committedDate": "2020-04-09T08:23:33Z", "message": "Handle snapshot deletion on primary storage. When primary store ref not found for snapshot do not fail the operation."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNjA2OTMz", "url": "https://github.com/apache/cloudstack/pull/3969#pullrequestreview-390606933", "createdAt": "2020-04-09T08:51:13Z", "commit": {"oid": "d62b54b7cafd7e2c399843a4245bff475a00504b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwODo1MToxM1rOGDPk3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwODo1MToxM1rOGDPk3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA1NDEwOQ==", "bodyText": "no extra return please; this means deletedOnPrimary = true and we fall through?", "url": "https://github.com/apache/cloudstack/pull/3969#discussion_r406054109", "createdAt": "2020-04-09T08:51:13Z", "author": {"login": "DaanHoogland"}, "path": "engine/storage/snapshot/src/main/java/org/apache/cloudstack/storage/snapshot/DefaultSnapshotStrategy.java", "diffHunk": "@@ -287,18 +287,25 @@ private boolean deleteOnPrimaryIfNeeded(Long snapshotId) {\n             // Here we handle snapshots which are to be deleted but are not marked as destroyed yet.\n             // This may occur for instance when they are created only on primary because\n             // snapshot.backup.to.secondary was set to false.\n-            SnapshotObject obj = (SnapshotObject) snapshotOnPrimaryInfo;\n-            try {\n-                obj.processEvent(Snapshot.Event.DestroyRequested);\n-                deletedOnPrimary = deleteSnapshotOnPrimary(snapshotId, snapshotOnPrimaryInfo);\n-                if (!deletedOnPrimary) {\n-                    obj.processEvent(Snapshot.Event.OperationFailed);\n-                } else {\n-                    obj.processEvent(Snapshot.Event.OperationSucceeded);\n+            if (snapshotOnPrimaryInfo == null) {\n+                s_logger.debug(\"Snapshot id:\" + snapshotId + \" not found on primary storage, skipping snapshot deletion on primary and marking it destroyed\");\n+                snapshotVO.setState(Snapshot.State.Destroyed);\n+                snapshotDao.update(snapshotId, snapshotVO);\n+                return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d62b54b7cafd7e2c399843a4245bff475a00504b"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNjEwMDcw", "url": "https://github.com/apache/cloudstack/pull/3969#pullrequestreview-390610070", "createdAt": "2020-04-09T08:55:36Z", "commit": {"oid": "d62b54b7cafd7e2c399843a4245bff475a00504b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwODo1NTozNlrOGDPu4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwODo1NTozNlrOGDPu4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA1NjY3Mw==", "bodyText": "can you surround debug statements that include string manupulation in teh paramater list with if (LOG.isDebugEnables()) {} please", "url": "https://github.com/apache/cloudstack/pull/3969#discussion_r406056673", "createdAt": "2020-04-09T08:55:36Z", "author": {"login": "DaanHoogland"}, "path": "engine/storage/snapshot/src/main/java/org/apache/cloudstack/storage/snapshot/DefaultSnapshotStrategy.java", "diffHunk": "@@ -352,14 +359,21 @@ private boolean deleteSnapshotOnSecondaryStorage(Long snapshotId, SnapshotInfo s\n     }\n \n     /**\n-     * Deletes the snapshot on primary storage. It can return false when the snapshot was not stored on primary storage; however this does not means that it failed to delete the snapshot. </br>\n-     * In case of failure, it will throw one of the following exceptions: CloudRuntimeException, InterruptedException, or ExecutionException. </br>\n+     * Deletes the snapshot on primary storage. It returns true when the snapshot was not found on primary storage; </br>\n+     * In case of failure while deleting the snapshot, it will throw one of the following exceptions: CloudRuntimeException, InterruptedException, or ExecutionException. </br>\n      */\n     private boolean deleteSnapshotOnPrimary(Long snapshotId, SnapshotInfo snapshotOnPrimaryInfo) {\n         SnapshotDataStoreVO snapshotOnPrimary = snapshotStoreDao.findBySnapshot(snapshotId, DataStoreRole.Primary);\n-        if (isSnapshotOnPrimaryStorage(snapshotId) && snapshotSvr.deleteSnapshot(snapshotOnPrimaryInfo)) {\n-            snapshotOnPrimary.setState(State.Destroyed);\n-            snapshotStoreDao.update(snapshotOnPrimary.getId(), snapshotOnPrimary);\n+        if (isSnapshotOnPrimaryStorage(snapshotId)) {\n+            s_logger.debug(\"Snapshot reference is found on primary storage for snapshot id:\" + snapshotId + \", performing snapshot deletion on primary\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d62b54b7cafd7e2c399843a4245bff475a00504b"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNjEwOTMy", "url": "https://github.com/apache/cloudstack/pull/3969#pullrequestreview-390610932", "createdAt": "2020-04-09T08:56:48Z", "commit": {"oid": "d62b54b7cafd7e2c399843a4245bff475a00504b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca94242a91276decda0ccb1f81dd621288d9c385", "author": {"user": {"login": "harikrishna-patnala", "name": "Harikrishna"}}, "url": "https://github.com/apache/cloudstack/commit/ca94242a91276decda0ccb1f81dd621288d9c385", "committedDate": "2020-04-09T09:17:22Z", "message": "Fix debug levels on log messages"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNzY0Mzc1", "url": "https://github.com/apache/cloudstack/pull/3969#pullrequestreview-391764375", "createdAt": "2020-04-11T12:59:23Z", "commit": {"oid": "ca94242a91276decda0ccb1f81dd621288d9c385"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4484, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}