{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyNjYzMjUw", "number": 4193, "title": "Fix usage record count", "bodyText": "Description\nlistUsageRecords returns the count equal to the number of objects returned in the page, rather than the total count\nAddresses: #4191\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)", "createdAt": "2020-07-01T12:21:19Z", "url": "https://github.com/apache/cloudstack/pull/4193", "merged": true, "mergeCommit": {"oid": "963d603ede6a76a37d4195f3771ba254b3c680b3"}, "closed": true, "closedAt": "2020-10-21T17:15:34Z", "author": {"login": "Pearl1594"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwpSLygH2gAyNDQyNjYzMjUwOjViNWEyZTU0ZGQyMDE2NDgxMzg1ZDNiODU1OGYyMzI4MGQ1MDQ3ZDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJr_7hAFqTQ5MDMyMTQ0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5b5a2e54dd2016481385d3b8558f23280d5047d1", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/5b5a2e54dd2016481385d3b8558f23280d5047d1", "committedDate": "2020-07-01T12:20:25Z", "message": "Fix usage record count fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwODE4ODMw", "url": "https://github.com/apache/cloudstack/pull/4193#pullrequestreview-440818830", "createdAt": "2020-07-01T12:23:32Z", "commit": {"oid": "5b5a2e54dd2016481385d3b8558f23280d5047d1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMjc2NDA3", "url": "https://github.com/apache/cloudstack/pull/4193#pullrequestreview-442276407", "createdAt": "2020-07-03T09:23:17Z", "commit": {"oid": "69eeac38a7c9263988da73ccb444dac988f67032"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwOToyMzoxN1rOGsqAhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwOToyMzoxN1rOGsqAhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ3ODc4OQ==", "bodyText": "As this code is in a test if (usageId != null), it will remove IP address usage only if the API command listUsageRecords was called with a specific usageId parameter.\nFor API calls like command=listUsageRecords&startdate=xxx&enddate=xxx, it will include all usage records, including for IP addresses on networks with \"Hide usage\".", "url": "https://github.com/apache/cloudstack/pull/4193#discussion_r449478789", "createdAt": "2020-07-03T09:23:17Z", "author": {"login": "olivierlemasle"}, "path": "server/src/main/java/com/cloud/usage/UsageServiceImpl.java", "diffHunk": "@@ -328,9 +333,20 @@ public boolean generateUsageRecords(GenerateUsageRecordsCmd cmd) {\n                     break;\n                 case UsageTypes.IP_ADDRESS:\n                     IPAddressVO ip = _ipDao.findByUuidIncludingRemoved(usageId);\n-                    if (ip != null) {\n-                        usageDbId = ip.getId();\n+                    if (ip == null) {\n+                        break;\n+                    }\n+                    Long networkId = ip.getAssociatedWithNetworkId();\n+                    if (networkId == null) {\n+                        networkId = ip.getSourceNetworkId();\n+                    }\n+                    NetworkDetailVO networkDetail = _networkDetailsDao.findDetail(networkId, Network.hideIpAddressUsage);\n+                    if (networkDetail != null && networkDetail.getValue() != null && networkDetail.getValue().equals(\"true\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69eeac38a7c9263988da73ccb444dac988f67032"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyOTE1NTg0", "url": "https://github.com/apache/cloudstack/pull/4193#pullrequestreview-442915584", "createdAt": "2020-07-06T09:26:39Z", "commit": {"oid": "6e4a6dc8bbccf286dc0991d844ce0174a7d49649"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyOTQzNTE5", "url": "https://github.com/apache/cloudstack/pull/4193#pullrequestreview-442943519", "createdAt": "2020-07-06T10:05:52Z", "commit": {"oid": "6e4a6dc8bbccf286dc0991d844ce0174a7d49649"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMjY0MDQ3", "url": "https://github.com/apache/cloudstack/pull/4193#pullrequestreview-443264047", "createdAt": "2020-07-06T17:12:01Z", "commit": {"oid": "6e4a6dc8bbccf286dc0991d844ce0174a7d49649"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNTY4OTAw", "url": "https://github.com/apache/cloudstack/pull/4193#pullrequestreview-443568900", "createdAt": "2020-07-07T05:19:29Z", "commit": {"oid": "6e4a6dc8bbccf286dc0991d844ce0174a7d49649"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNTY1OTQ1", "url": "https://github.com/apache/cloudstack/pull/4193#pullrequestreview-452565945", "createdAt": "2020-07-21T15:18:35Z", "commit": {"oid": "6e4a6dc8bbccf286dc0991d844ce0174a7d49649"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5dd55c334e5319b33d5c1803c3df4ccf104185b", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/f5dd55c334e5319b33d5c1803c3df4ccf104185b", "committedDate": "2020-09-17T04:15:59Z", "message": "fix usage record"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2be830e18e9c39fea706b34187901df74f926d1a", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/2be830e18e9c39fea706b34187901df74f926d1a", "committedDate": "2020-09-17T04:16:12Z", "message": "Merge branch '4.13' of https://github.com/apache/cloudstack into usage_record_cnt_fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6e4a6dc8bbccf286dc0991d844ce0174a7d49649", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/6e4a6dc8bbccf286dc0991d844ce0174a7d49649", "committedDate": "2020-07-03T12:57:47Z", "message": "handle count mismatch for hidden records"}, "afterCommit": {"oid": "2be830e18e9c39fea706b34187901df74f926d1a", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/2be830e18e9c39fea706b34187901df74f926d1a", "committedDate": "2020-09-17T04:16:12Z", "message": "Merge branch '4.13' of https://github.com/apache/cloudstack into usage_record_cnt_fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMzIxNDQy", "url": "https://github.com/apache/cloudstack/pull/4193#pullrequestreview-490321442", "createdAt": "2020-09-17T07:38:19Z", "commit": {"oid": "2be830e18e9c39fea706b34187901df74f926d1a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3916, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}