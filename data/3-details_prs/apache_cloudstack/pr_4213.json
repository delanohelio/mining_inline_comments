{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwNzc1MTA4", "number": 4213, "title": "Search vm snapshots using tags", "bodyText": "Description\nSearch VM snapshots using tags\nCurrently, search of VM snapshots doesn't comply with tags passed as input\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nHow Has This Been Tested?\ntested via CLI (cmk) and UI", "createdAt": "2020-07-17T04:56:00Z", "url": "https://github.com/apache/cloudstack/pull/4213", "merged": true, "mergeCommit": {"oid": "b68be664b779096e3cb0f9b04cba4109a670d8b5"}, "closed": true, "closedAt": "2020-08-13T10:09:09Z", "author": {"login": "Pearl1594"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc27JvjAFqTQ1MTg5NzM2NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-dK5QAFqTQ2NjYyMzc4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxODk3MzY1", "url": "https://github.com/apache/cloudstack/pull/4213#pullrequestreview-451897365", "createdAt": "2020-07-20T19:30:16Z", "commit": {"oid": "2a5b5332ff9e2ba0114c7da694aa0c08853356aa"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxOTozMDoxNlrOG0cRhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwMDozMDo1MVrOG0j1IA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY0MjM3Mg==", "bodyText": "Can you please use MapUtils.isNotEmpty(tags);?\nMapUtils.isNotEmpty is a null-safe check that verifies if the specified map is not empty.", "url": "https://github.com/apache/cloudstack/pull/4213#discussion_r457642372", "createdAt": "2020-07-20T19:30:16Z", "author": {"login": "GabrielBrascher"}, "path": "server/src/main/java/com/cloud/vm/snapshot/VMSnapshotManagerImpl.java", "diffHunk": "@@ -229,11 +236,32 @@ public boolean stop() {\n         sb.and(\"idIN\", sb.entity().getId(), SearchCriteria.Op.IN);\n         sb.and(\"display_name\", sb.entity().getDisplayName(), SearchCriteria.Op.EQ);\n         sb.and(\"account_id\", sb.entity().getAccountId(), SearchCriteria.Op.EQ);\n-        sb.done();\n+\n+        if (tags != null && !tags.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a5b5332ff9e2ba0114c7da694aa0c08853356aa"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc2NTgwMQ==", "bodyText": "MapUtils.isNotEmpty would fit nicely here", "url": "https://github.com/apache/cloudstack/pull/4213#discussion_r457765801", "createdAt": "2020-07-21T00:29:24Z", "author": {"login": "GabrielBrascher"}, "path": "server/src/main/java/com/cloud/vm/snapshot/VMSnapshotManagerImpl.java", "diffHunk": "@@ -229,11 +236,32 @@ public boolean stop() {\n         sb.and(\"idIN\", sb.entity().getId(), SearchCriteria.Op.IN);\n         sb.and(\"display_name\", sb.entity().getDisplayName(), SearchCriteria.Op.EQ);\n         sb.and(\"account_id\", sb.entity().getAccountId(), SearchCriteria.Op.EQ);\n-        sb.done();\n+\n+        if (tags != null && !tags.isEmpty()) {\n+            SearchBuilder<ResourceTagVO> tagSearch = _resourceTagDao.createSearchBuilder();\n+            for (int count = 0; count < tags.size(); count++) {\n+                tagSearch.or().op(\"key\" + String.valueOf(count), tagSearch.entity().getKey(), SearchCriteria.Op.EQ);\n+                tagSearch.and(\"value\" + String.valueOf(count), tagSearch.entity().getValue(), SearchCriteria.Op.EQ);\n+                tagSearch.cp();\n+            }\n+            tagSearch.and(\"resourceType\", tagSearch.entity().getResourceType(), SearchCriteria.Op.EQ);\n+            sb.groupBy(sb.entity().getId());\n+            sb.join(\"tagSearch\", tagSearch, sb.entity().getId(), tagSearch.entity().getResourceId(), JoinBuilder.JoinType.INNER);\n+        }\n \n         SearchCriteria<VMSnapshotVO> sc = sb.create();\n         _accountMgr.buildACLSearchCriteria(sc, domainId, isRecursive, permittedAccounts, listProjectResourcesCriteria);\n \n+        if (tags != null && !tags.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a5b5332ff9e2ba0114c7da694aa0c08853356aa"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzc2NjE3Ng==", "bodyText": "A few values can be extracted to constants, especially considering that they are being used more than once, for instance \"key\".", "url": "https://github.com/apache/cloudstack/pull/4213#discussion_r457766176", "createdAt": "2020-07-21T00:30:51Z", "author": {"login": "GabrielBrascher"}, "path": "server/src/main/java/com/cloud/vm/snapshot/VMSnapshotManagerImpl.java", "diffHunk": "@@ -229,11 +236,32 @@ public boolean stop() {\n         sb.and(\"idIN\", sb.entity().getId(), SearchCriteria.Op.IN);\n         sb.and(\"display_name\", sb.entity().getDisplayName(), SearchCriteria.Op.EQ);\n         sb.and(\"account_id\", sb.entity().getAccountId(), SearchCriteria.Op.EQ);\n-        sb.done();\n+\n+        if (tags != null && !tags.isEmpty()) {\n+            SearchBuilder<ResourceTagVO> tagSearch = _resourceTagDao.createSearchBuilder();\n+            for (int count = 0; count < tags.size(); count++) {\n+                tagSearch.or().op(\"key\" + String.valueOf(count), tagSearch.entity().getKey(), SearchCriteria.Op.EQ);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a5b5332ff9e2ba0114c7da694aa0c08853356aa"}, "originalPosition": 51}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2a5b5332ff9e2ba0114c7da694aa0c08853356aa", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/2a5b5332ff9e2ba0114c7da694aa0c08853356aa", "committedDate": "2020-07-17T04:52:15Z", "message": "search vm snapshots with tags"}, "afterCommit": {"oid": "f79dc4e4139595edabb3090ed737ff2b3d911c38", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/f79dc4e4139595edabb3090ed737ff2b3d911c38", "committedDate": "2020-07-27T13:12:53Z", "message": "Review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a2d235f7660f81214acdefb19d9369d26d4fba3", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/9a2d235f7660f81214acdefb19d9369d26d4fba3", "committedDate": "2020-07-27T13:17:33Z", "message": "search vm snapshots with tags"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f01c8bb5681c2c9800227092e7bd04e51d01e39", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/2f01c8bb5681c2c9800227092e7bd04e51d01e39", "committedDate": "2020-07-27T13:17:52Z", "message": "Review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f79dc4e4139595edabb3090ed737ff2b3d911c38", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/f79dc4e4139595edabb3090ed737ff2b3d911c38", "committedDate": "2020-07-27T13:12:53Z", "message": "Review comments"}, "afterCommit": {"oid": "2f01c8bb5681c2c9800227092e7bd04e51d01e39", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/2f01c8bb5681c2c9800227092e7bd04e51d01e39", "committedDate": "2020-07-27T13:17:52Z", "message": "Review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1Nzk2NzU2", "url": "https://github.com/apache/cloudstack/pull/4213#pullrequestreview-455796756", "createdAt": "2020-07-27T13:47:19Z", "commit": {"oid": "2f01c8bb5681c2c9800227092e7bd04e51d01e39"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2OTYwMjA2", "url": "https://github.com/apache/cloudstack/pull/4213#pullrequestreview-456960206", "createdAt": "2020-07-28T19:52:26Z", "commit": {"oid": "2f01c8bb5681c2c9800227092e7bd04e51d01e39"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxOTo1MjoyNlrOG4cUGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxOTo1MzozMlrOG4cWfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgzNzMzNw==", "bodyText": "Could you please extract this to a method, add documentation to what this method do and why.\nAlso can you please create unit tests to cover those method", "url": "https://github.com/apache/cloudstack/pull/4213#discussion_r461837337", "createdAt": "2020-07-28T19:52:26Z", "author": {"login": "RodrigoDLopez"}, "path": "server/src/main/java/com/cloud/vm/snapshot/VMSnapshotManagerImpl.java", "diffHunk": "@@ -229,11 +238,32 @@ public boolean stop() {\n         sb.and(\"idIN\", sb.entity().getId(), SearchCriteria.Op.IN);\n         sb.and(\"display_name\", sb.entity().getDisplayName(), SearchCriteria.Op.EQ);\n         sb.and(\"account_id\", sb.entity().getAccountId(), SearchCriteria.Op.EQ);\n-        sb.done();\n+\n+        if (MapUtils.isNotEmpty(tags)) {\n+            SearchBuilder<ResourceTagVO> tagSearch = _resourceTagDao.createSearchBuilder();\n+            for (int count = 0; count < tags.size(); count++) {\n+                tagSearch.or().op(ApiConstants.KEY + String.valueOf(count), tagSearch.entity().getKey(), SearchCriteria.Op.EQ);\n+                tagSearch.and(ApiConstants.VALUE + String.valueOf(count), tagSearch.entity().getValue(), SearchCriteria.Op.EQ);\n+                tagSearch.cp();\n+            }\n+            tagSearch.and(ApiConstants.RESOURCE_TYPE, tagSearch.entity().getResourceType(), SearchCriteria.Op.EQ);\n+            sb.groupBy(sb.entity().getId());\n+            sb.join(\"tagSearch\", tagSearch, sb.entity().getId(), tagSearch.entity().getResourceId(), JoinBuilder.JoinType.INNER);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f01c8bb5681c2c9800227092e7bd04e51d01e39"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgzNzk0OA==", "bodyText": "cloud you do the same here please,\nextract to a new method, add documentation and unit tests.", "url": "https://github.com/apache/cloudstack/pull/4213#discussion_r461837948", "createdAt": "2020-07-28T19:53:32Z", "author": {"login": "RodrigoDLopez"}, "path": "server/src/main/java/com/cloud/vm/snapshot/VMSnapshotManagerImpl.java", "diffHunk": "@@ -229,11 +238,32 @@ public boolean stop() {\n         sb.and(\"idIN\", sb.entity().getId(), SearchCriteria.Op.IN);\n         sb.and(\"display_name\", sb.entity().getDisplayName(), SearchCriteria.Op.EQ);\n         sb.and(\"account_id\", sb.entity().getAccountId(), SearchCriteria.Op.EQ);\n-        sb.done();\n+\n+        if (MapUtils.isNotEmpty(tags)) {\n+            SearchBuilder<ResourceTagVO> tagSearch = _resourceTagDao.createSearchBuilder();\n+            for (int count = 0; count < tags.size(); count++) {\n+                tagSearch.or().op(ApiConstants.KEY + String.valueOf(count), tagSearch.entity().getKey(), SearchCriteria.Op.EQ);\n+                tagSearch.and(ApiConstants.VALUE + String.valueOf(count), tagSearch.entity().getValue(), SearchCriteria.Op.EQ);\n+                tagSearch.cp();\n+            }\n+            tagSearch.and(ApiConstants.RESOURCE_TYPE, tagSearch.entity().getResourceType(), SearchCriteria.Op.EQ);\n+            sb.groupBy(sb.entity().getId());\n+            sb.join(\"tagSearch\", tagSearch, sb.entity().getId(), tagSearch.entity().getResourceId(), JoinBuilder.JoinType.INNER);\n+        }\n \n         SearchCriteria<VMSnapshotVO> sc = sb.create();\n         _accountMgr.buildACLSearchCriteria(sc, domainId, isRecursive, permittedAccounts, listProjectResourcesCriteria);\n \n+        if (MapUtils.isNotEmpty(tags)) {\n+            int count = 0;\n+            sc.setJoinParameters(\"tagSearch\", ApiConstants.RESOURCE_TYPE, ResourceTag.ResourceObjectType.VMSnapshot.toString());\n+            for (String key : tags.keySet()) {\n+                sc.setJoinParameters(\"tagSearch\", ApiConstants.KEY + String.valueOf(count), key);\n+                sc.setJoinParameters(\"tagSearch\", ApiConstants.VALUE + String.valueOf(count), tags.get(key));\n+                count++;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f01c8bb5681c2c9800227092e7bd04e51d01e39"}, "originalPosition": 79}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NjIzNzg2", "url": "https://github.com/apache/cloudstack/pull/4213#pullrequestreview-466623786", "createdAt": "2020-08-13T10:08:32Z", "commit": {"oid": "2f01c8bb5681c2c9800227092e7bd04e51d01e39"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3949, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}