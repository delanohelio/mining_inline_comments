{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzNTM3NzA3", "number": 4103, "title": "[VMware] Enable unmanaging guest VMs", "bodyText": "Description\nThis feature allows administrators to unmanage guest virtual machines from CloudStack. Once unmanaged, CloudStack can no longer monitor, control or administer the provisioning and orchestration related operations on a virtual machine.\nA new API method has been added: unmanageVirtualMachine, accepting the virtual machine UUID as parameter The execution of this API method performs the unmanaging of a guest virtual machine. It has the following pre-conditions:\n\nThe virtual machine must not be destroyed\nThe virtual machine state must be 'Running\u2019 or \u2018Stopped\u2019\nThe virtual machine must be a VMware virtual machine\n\nAssuming these pre-conditions are met, the API execution will perform the following pre-checks, failing if they are not met:\n\nThere are no volume snapshots associated with any of the virtual machine volumes\nThere is no ISO attached to the virtual machine\n\nAn additional check is performed prior to unmanaging the virtual machine from CloudStack: the hypervisor returns checks that the virtual machine exists, searching the virtual machine by its instance name. If it is not found, then the operation fails.\nGlobal setting\nA new boolean zone setting has been added: unmanage.vm.preserve.nics, with default value = \u2018false\u2019. If set to true, the virtual machine NICs (and their MAC addresses) are preserved when unmanaging it. Otherwise, NICs are removed and MAC addresses can be reassigned.\nUnmanaging virtual machine actions:\n\nClean up virtual machine NICs and deallocate network resources used such as IP addresses and DHCP entries on virtual routers.\n\nIf \u2018unmanage.vm.preserve.nics\u2019 = \u2018false\u2019 then the NICs are deallocated and removed from CloudStack\nIf \u2018unmanage.vm.preserve.nics\u2019 = \u2018true\u2019 then the NICs remain allocated and are not removed from the database. The NIC\u2019s MAC addresses remain preserved and therefore cannot be assigned to any new NIC.\n\n\nClean up virtual machine volumes in the CloudStack database\nClean up virtual machine snapshots in the CloudStack database (if any) \u00b7 Revoke host access to any managed volumes attached to the VM\nClean up the virtual machine from the following:\n\nRemove the virtual machine from security groups (if any)\nRemove the virtual machine from instance groups (if any)\nRemove firewall rules for the virtual machine (if any)\nRemove forwarding rules for the virtual machine (if any)\nRemove load balancing rules for the virtual machine (if any)\nDisable static NAT (if the virtual machine is assigned to it)\nRemove the virtual machine from affinity groups (if any)\n\n\nSet VM details as removed in the CloudStack database\nDecrement the account resources count for volumes and virtual machines\nGenerate usage events:\n\nFor volumes destroyed, with type: \u2018VOLUME.DELETE\u2019\nFor virtual machine snapshots destroyed (if any), with type: \u2018VMSNAPSHOT.DELETE\u2019\nFor virtual machine NICs destroyed: with type: \u2018NETWORK.OFFERING.REMOVE\u2019\nFor the virtual machine being unmanaged: stopped and destroyed usage events (similar as the generated usage events when expunging a virtual machine), with types: \u2018VM.STOP\u2019 and \u2018VM.DESTROY\n\n\n\nChanges on the VM import functionality\nA new parameter has been added to the importUnmanagedInstances API:\n\nforced: booolean (false by default): If true, a VM is imported despite some of its NIC's MAC addresses being already present. The forced parameter is false by default and prevents importing a VM which has a NIC containing a MAC address that has been previously assigned by CloudStack. If it is set to true, the NICs with MAC addresses which already exist in the CloudStack database have the existing MAC addresses reassigned to its NICs.\n\nThe usage events generated when importing unmanaged instances have been refactored:\n\nThe usage event with type: \u2018VM.IMPORT\u2019 has been replaced by the usage event with type: \u2018VM.CREATE\u2019.\nIf the imported VM is powered on, then the VM import feture generates the usage event with type: \u2018VM.START\u2019\n\nTypes of changes\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?", "createdAt": "2020-05-27T00:42:47Z", "url": "https://github.com/apache/cloudstack/pull/4103", "merged": true, "mergeCommit": {"oid": "8c1d749360657a4909c558c3df5dec57ca66c977"}, "closed": true, "closedAt": "2020-06-26T11:31:44Z", "author": {"login": "nvazquez"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnN2LIABqjMzOTU4OTI1NTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcu_rIsAFqTQzODE0Mjc5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4554b98060bd813d565d018dd69db99e64006205", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/4554b98060bd813d565d018dd69db99e64006205", "committedDate": "2020-05-27T04:26:07Z", "message": "Fix duplicate import"}, "afterCommit": {"oid": "91ab3f23eb88e9a2d0c8b2b247f187cb13ba5f76", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/91ab3f23eb88e9a2d0c8b2b247f187cb13ba5f76", "committedDate": "2020-06-02T05:16:48Z", "message": "Refactors and fixes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91ab3f23eb88e9a2d0c8b2b247f187cb13ba5f76", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/91ab3f23eb88e9a2d0c8b2b247f187cb13ba5f76", "committedDate": "2020-06-02T05:16:48Z", "message": "Refactors and fixes"}, "afterCommit": {"oid": "a7582d69010bc346704375b53ed7256c8b2d8567", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/a7582d69010bc346704375b53ed7256c8b2d8567", "committedDate": "2020-06-08T12:56:41Z", "message": "Improvements and fixes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7582d69010bc346704375b53ed7256c8b2d8567", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/a7582d69010bc346704375b53ed7256c8b2d8567", "committedDate": "2020-06-08T12:56:41Z", "message": "Improvements and fixes"}, "afterCommit": {"oid": "a0c88ae02369403d17f821d436ba155cb801fd8d", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/a0c88ae02369403d17f821d436ba155cb801fd8d", "committedDate": "2020-06-08T12:59:44Z", "message": "Improvements and fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4NjQ0NjA1", "url": "https://github.com/apache/cloudstack/pull/4103#pullrequestreview-428644605", "createdAt": "2020-06-11T07:06:49Z", "commit": {"oid": "bb54dd53bb1cd7790069783aa19ab5faac55bf1d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bb54dd53bb1cd7790069783aa19ab5faac55bf1d", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/bb54dd53bb1cd7790069783aa19ab5faac55bf1d", "committedDate": "2020-06-09T14:46:46Z", "message": "Fix VM and nics states after unmanaging"}, "afterCommit": {"oid": "fbcdd9b11aa03b2b7220bf7b2564354cf16e5205", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/fbcdd9b11aa03b2b7220bf7b2564354cf16e5205", "committedDate": "2020-06-15T04:17:15Z", "message": "Fix VM and nics states after unmanaging"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fbcdd9b11aa03b2b7220bf7b2564354cf16e5205", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/fbcdd9b11aa03b2b7220bf7b2564354cf16e5205", "committedDate": "2020-06-15T04:17:15Z", "message": "Fix VM and nics states after unmanaging"}, "afterCommit": {"oid": "a709a86541db86467eb1be199a949176d908e443", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/a709a86541db86467eb1be199a949176d908e443", "committedDate": "2020-06-15T18:07:56Z", "message": "Enable unmanaging guest VMs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3289af44caabb43367cc0aecdc12a5041fb38f5f", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/3289af44caabb43367cc0aecdc12a5041fb38f5f", "committedDate": "2020-06-16T11:26:23Z", "message": "Enable unmanaging guest VMs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57080b1a310440b887c8fe200184e728444530d3", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/57080b1a310440b887c8fe200184e728444530d3", "committedDate": "2020-06-16T11:26:24Z", "message": "Minor fixes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "51196c58491218f28ebc0a506100f4f021c718c1", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/51196c58491218f28ebc0a506100f4f021c718c1", "committedDate": "2020-06-16T11:21:37Z", "message": "Merge branch 'master' into unmanageinstances"}, "afterCommit": {"oid": "57080b1a310440b887c8fe200184e728444530d3", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/57080b1a310440b887c8fe200184e728444530d3", "committedDate": "2020-06-16T11:26:24Z", "message": "Minor fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fac6616ff2d6e6c46f149dfe369d41625a146634", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/fac6616ff2d6e6c46f149dfe369d41625a146634", "committedDate": "2020-06-16T11:53:28Z", "message": "Fix stop usage event only if VM is not stopped when unmanaging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNDM2OTE5", "url": "https://github.com/apache/cloudstack/pull/4103#pullrequestreview-431436919", "createdAt": "2020-06-16T12:09:24Z", "commit": {"oid": "fac6616ff2d6e6c46f149dfe369d41625a146634"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMjowOToyNFrOGkYUHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMjowOToyNFrOGkYUHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgwMDI4Nw==", "bodyText": "this should be called unmanage*d*VMsManager, it does more than just unmanage", "url": "https://github.com/apache/cloudstack/pull/4103#discussion_r440800287", "createdAt": "2020-06-16T12:09:24Z", "author": {"login": "DaanHoogland"}, "path": "api/src/main/java/org/apache/cloudstack/vm/UnmanageVMManager.java", "diffHunk": "@@ -0,0 +1,29 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.cloudstack.vm;\n+\n+import com.cloud.utils.component.PluggableService;\n+import org.apache.cloudstack.framework.config.ConfigKey;\n+import org.apache.cloudstack.framework.config.Configurable;\n+\n+public interface UnmanageVMManager extends VmImportService, UnmanageVMService, PluggableService, Configurable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fac6616ff2d6e6c46f149dfe369d41625a146634"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "597b5080fead03fdd20f24be453a5e9083455ff8", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/597b5080fead03fdd20f24be453a5e9083455ff8", "committedDate": "2020-06-16T12:10:43Z", "message": "Rename unmanaged VMs manager"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c49b1ac491a78b884c94081c8023b54e2408a3d", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/1c49b1ac491a78b884c94081c8023b54e2408a3d", "committedDate": "2020-06-16T12:53:02Z", "message": "Generate netofferingremove usage event if VM is not stopped"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad672c3280162ced801cd9bf951833097379a088", "author": {"user": {"login": "nvazquez", "name": "Nicolas Vazquez"}}, "url": "https://github.com/apache/cloudstack/commit/ad672c3280162ced801cd9bf951833097379a088", "committedDate": "2020-06-16T14:24:41Z", "message": "Generate usage event VM snapshot primary off when unmanaging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4MDI3NDA1", "url": "https://github.com/apache/cloudstack/pull/4103#pullrequestreview-438027405", "createdAt": "2020-06-26T05:45:53Z", "commit": {"oid": "ad672c3280162ced801cd9bf951833097379a088"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4MTQyNzk4", "url": "https://github.com/apache/cloudstack/pull/4103#pullrequestreview-438142798", "createdAt": "2020-06-26T09:17:44Z", "commit": {"oid": "ad672c3280162ced801cd9bf951833097379a088"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4317, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}