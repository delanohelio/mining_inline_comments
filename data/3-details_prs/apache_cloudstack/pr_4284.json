{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczMjcwNzI1", "number": 4284, "title": "Fixed delayed power state update after vm shutdown", "bodyText": "Description\n\nAfter a vm is shutdown, the power state isn't updated immediately. This prevents changing the service offering.\nThis PR updates the power state immediately after the vm is confirmed to be shutdown.\n\n\n\n\n\nFixes: #3159\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?\n\n\n\nThis has been tested by starting a vm, waiting for the power state in the db to be updated to powerOn, then shutting down the vm and as soon as the vm is down, checking the power state in the db. Can also be verified by changing the service offering after stopping the vm.", "createdAt": "2020-08-25T15:04:30Z", "url": "https://github.com/apache/cloudstack/pull/4284", "merged": true, "mergeCommit": {"oid": "cb717741fc26662551458f9aa5ceb459884b7a6f"}, "closed": true, "closedAt": "2020-09-01T10:23:53Z", "author": {"login": "Spaceman1984"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCYeZAAH2gAyNDczMjcwNzI1OmEyZDJmYTBlZGZlMDIzYTk4NDdmMDVkOTg1ZTBmNzUzZDI5MzFlODA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEkvNmgFqTQ3OTYwMzcxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a2d2fa0edfe023a9847f05d985e0f753d2931e80", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/a2d2fa0edfe023a9847f05d985e0f753d2931e80", "committedDate": "2020-08-25T14:56:00Z", "message": "Fixed delayed power state update after vm shutdown"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1MTk5NDYx", "url": "https://github.com/apache/cloudstack/pull/4284#pullrequestreview-475199461", "createdAt": "2020-08-26T06:53:36Z", "commit": {"oid": "a2d2fa0edfe023a9847f05d985e0f753d2931e80"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwNjo1MzozN1rOHG-RsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwNjo1MzozN1rOHG-RsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA3Mzg0MA==", "bodyText": "@Spaceman1984 should we update the power state after guru finalises the stop? What is there is an exception then the power state will be off while VM may actually be running?", "url": "https://github.com/apache/cloudstack/pull/4284#discussion_r477073840", "createdAt": "2020-08-26T06:53:37Z", "author": {"login": "rhtyd"}, "path": "engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java", "diffHunk": "@@ -1657,6 +1657,10 @@ protected boolean sendStop(final VirtualMachineGuru guru, final VirtualMachinePr\n                     return false;\n                 }\n \n+                final UserVmVO userVm = _userVmDao.findById(vm.getId());\n+                userVm.setPowerState(PowerState.PowerOff);\n+                _userVmDao.update(userVm.getId(), userVm);\n+\n                 guru.finalizeStop(profile, answer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2d2fa0edfe023a9847f05d985e0f753d2931e80"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6725b5688b7df023ce12d868863b7fff9f56f022", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/6725b5688b7df023ce12d868863b7fff9f56f022", "committedDate": "2020-08-26T10:36:41Z", "message": "Moved db update to after guru finalize stop method call"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NTgyMjEy", "url": "https://github.com/apache/cloudstack/pull/4284#pullrequestreview-477582212", "createdAt": "2020-08-28T09:27:14Z", "commit": {"oid": "6725b5688b7df023ce12d868863b7fff9f56f022"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NjAzNzEy", "url": "https://github.com/apache/cloudstack/pull/4284#pullrequestreview-479603712", "createdAt": "2020-09-01T10:21:05Z", "commit": {"oid": "6725b5688b7df023ce12d868863b7fff9f56f022"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4085, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}