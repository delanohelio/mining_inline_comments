{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzOTM5MzA2", "number": 4032, "title": "Suspending the VM prior to deleting snapshots to avoid corruption, th\u2026", "bodyText": "\u2026en resuming\nDescription\n\nThese changes are related to PR #3194, but include suspending/resuming the VM when doing a VM snapshot as well, when deleting a VM snapshot, as it is performing the same operations via Libvirt. Also, there was an issue with the UI/localization changes in the prior PR, as that PR was altering the Volume snapshot behavior, but was altering the VM snapshot wording. Both have been altered in this PR.\nIssuing this in response to the work happening in PR #4029.\n\n\n\n\n\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?", "createdAt": "2020-04-15T19:12:18Z", "url": "https://github.com/apache/cloudstack/pull/4032", "merged": true, "mergeCommit": {"oid": "af0f6422ec512a5c0c8d570e14f11327e82efd96"}, "closed": true, "closedAt": "2021-02-25T16:41:00Z", "author": {"login": "ggoodrich-ipp"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcX86AQAH2gAyNDAzOTM5MzA2OmVhYWI5YWUxNjAzMGQ5YWY2NmMxMGU5ZGYwNDE5MmZmMDZhYWQzZjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABd81eBTgFqTU5NjAwNjE2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "eaab9ae16030d9af66c10e9df04192ff06aad3f5", "author": {"user": {"login": "ggoodrich-ipp", "name": "Greg Goodrich"}}, "url": "https://github.com/apache/cloudstack/commit/eaab9ae16030d9af66c10e9df04192ff06aad3f5", "committedDate": "2020-04-15T19:04:00Z", "message": "Suspending the VM prior to deleting snapshots to avoid corruption, then resuming"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NTQ1MjY4", "url": "https://github.com/apache/cloudstack/pull/4032#pullrequestreview-394545268", "createdAt": "2020-04-16T11:35:15Z", "commit": {"oid": "eaab9ae16030d9af66c10e9df04192ff06aad3f5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NTUwMDk1", "url": "https://github.com/apache/cloudstack/pull/4032#pullrequestreview-394550095", "createdAt": "2020-04-16T11:43:09Z", "commit": {"oid": "eaab9ae16030d9af66c10e9df04192ff06aad3f5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMTo0MzowOVrOGGhU_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMTo0MzowOVrOGGhU_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5MDY4Nw==", "bodyText": "Should we check if VM is running? (i.e. not in any other states)", "url": "https://github.com/apache/cloudstack/pull/4032#discussion_r409490687", "createdAt": "2020-04-16T11:43:09Z", "author": {"login": "rhtyd"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtDeleteVMSnapshotCommandWrapper.java", "diffHunk": "@@ -51,14 +52,28 @@ public Answer execute(final DeleteVMSnapshotCommand cmd, final LibvirtComputingR\n         final KVMStoragePoolManager storagePoolMgr = libvirtComputingResource.getStoragePoolMgr();\n         Domain dm = null;\n         DomainSnapshot snapshot = null;\n+        DomainInfo.DomainState state = null;\n+        boolean didDelete = false;\n+        Connect conn = null;\n         try {\n             final LibvirtUtilitiesHelper libvirtUtilitiesHelper = libvirtComputingResource.getLibvirtUtilitiesHelper();\n-            Connect conn = libvirtUtilitiesHelper.getConnection();\n+            conn = libvirtUtilitiesHelper.getConnection();\n             dm = libvirtComputingResource.getDomain(conn, vmName);\n \n             snapshot = dm.snapshotLookupByName(cmd.getTarget().getSnapshotName());\n \n+            // Suspend the VM prior to deleting the snapshot to guard against corruption\n+            dm.suspend();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaab9ae16030d9af66c10e9df04192ff06aad3f5"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NTUxODQ2", "url": "https://github.com/apache/cloudstack/pull/4032#pullrequestreview-394551846", "createdAt": "2020-04-16T11:45:49Z", "commit": {"oid": "eaab9ae16030d9af66c10e9df04192ff06aad3f5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMTo0NTo0OVrOGGhaeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMTo0NTo0OVrOGGhaeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5MjA4OA==", "bodyText": "dm is already not null, why overwrite it again?", "url": "https://github.com/apache/cloudstack/pull/4032#discussion_r409492088", "createdAt": "2020-04-16T11:45:49Z", "author": {"login": "rhtyd"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtDeleteVMSnapshotCommandWrapper.java", "diffHunk": "@@ -93,12 +108,26 @@ public Answer execute(final DeleteVMSnapshotCommand cmd, final LibvirtComputingR\n             } else if (snapshot == null) {\n                 s_logger.debug(\"Can not find vm snapshot \" + cmd.getTarget().getSnapshotName() + \" on vm: \" + vmName + \", return true\");\n                 return new DeleteVMSnapshotAnswer(cmd, cmd.getVolumeTOs());\n+            } else if (didDelete) {\n+                s_logger.error(\"Failed to resume vm after delete snapshot \" + cmd.getTarget().getSnapshotName() + \" on vm: \" + vmName + \" return true : \" + e);\n+                return new DeleteVMSnapshotAnswer(cmd, cmd.getVolumeTOs());\n             }\n \n             s_logger.warn(msg, e);\n             return new DeleteVMSnapshotAnswer(cmd, false, msg);\n         } finally {\n             if (dm != null) {\n+                // Make sure if the VM is paused, then resume it, in case we got an exception during our delete() and didn't have the chance before\n+                try {\n+                    dm = libvirtComputingResource.getDomain(conn, vmName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaab9ae16030d9af66c10e9df04192ff06aad3f5"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NTUyMjY3", "url": "https://github.com/apache/cloudstack/pull/4032#pullrequestreview-394552267", "createdAt": "2020-04-16T11:46:27Z", "commit": {"oid": "eaab9ae16030d9af66c10e9df04192ff06aad3f5"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30bd160c90e514342f31154f0aed7640ed4a6233", "author": {"user": {"login": "ggoodrich-ipp", "name": "Greg Goodrich"}}, "url": "https://github.com/apache/cloudstack/commit/30bd160c90e514342f31154f0aed7640ed4a6233", "committedDate": "2020-06-11T13:55:16Z", "message": "Merge branch 'master' into gjg-snapshot-pause-vm"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2Mzc3ODEx", "url": "https://github.com/apache/cloudstack/pull/4032#pullrequestreview-456377811", "createdAt": "2020-07-28T07:40:00Z", "commit": {"oid": "30bd160c90e514342f31154f0aed7640ed4a6233"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNzo0MDowMVrOG4AcRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNzo0Nzo1MlrOG4AtZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4MDY3OA==", "bodyText": "can you extract this in a separate method please?", "url": "https://github.com/apache/cloudstack/pull/4032#discussion_r461380678", "createdAt": "2020-07-28T07:40:01Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtDeleteVMSnapshotCommandWrapper.java", "diffHunk": "@@ -97,12 +108,26 @@ public Answer execute(final DeleteVMSnapshotCommand cmd, final LibvirtComputingR\n             } else if (snapshot == null) {\n                 s_logger.debug(\"Can not find vm snapshot \" + cmd.getTarget().getSnapshotName() + \" on vm: \" + vmName + \", return true\");\n                 return new DeleteVMSnapshotAnswer(cmd, cmd.getVolumeTOs());\n+            } else if (didDelete) {\n+                s_logger.error(\"Failed to resume vm after delete snapshot \" + cmd.getTarget().getSnapshotName() + \" on vm: \" + vmName + \" return true : \" + e);\n+                return new DeleteVMSnapshotAnswer(cmd, cmd.getVolumeTOs());\n             }\n \n             s_logger.warn(msg, e);\n             return new DeleteVMSnapshotAnswer(cmd, false, msg);\n         } finally {\n             if (dm != null) {\n+                // Make sure if the VM is paused, then resume it, in case we got an exception during our delete() and didn't have the chance before\n+                try {\n+                    dm = libvirtComputingResource.getDomain(conn, vmName);\n+                    state = dm.getInfo().state;\n+                    if (state == DomainInfo.DomainState.VIR_DOMAIN_PAUSED) {\n+                        dm.resume();\n+                    }\n+                } catch (LibvirtException e) {\n+                    s_logger.error(\"Failed to resume vm after delete snapshot \" + cmd.getTarget().getSnapshotName() + \" on vm: \" + vmName + \" return true : \" + e);\n+                }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30bd160c90e514342f31154f0aed7640ed4a6233"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4Mjk4Mg==", "bodyText": "resume action leads to an implicit assumption which must be guarded during maintenance by future generations: failing resume is concluded by examining a var named didDelete. dangerous assumption even with the current logic computing. see below.", "url": "https://github.com/apache/cloudstack/pull/4032#discussion_r461382982", "createdAt": "2020-07-28T07:44:11Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtDeleteVMSnapshotCommandWrapper.java", "diffHunk": "@@ -63,6 +66,14 @@ public Answer execute(final DeleteVMSnapshotCommand cmd, final LibvirtComputingR\n             dm.suspend(); // suspend the vm to avoid image corruption\n \n             snapshot.delete(0); // only remove this snapshot, not children\n+            didDelete = true;\n+\n+            // Resume the VM\n+            dm = libvirtComputingResource.getDomain(conn, vmName);\n+            state = dm.getInfo().state;\n+            if (state == DomainInfo.DomainState.VIR_DOMAIN_PAUSED) {\n+                dm.resume();\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30bd160c90e514342f31154f0aed7640ed4a6233"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4NDIzOQ==", "bodyText": "here a var didDelete leads us to conclude that the current exception thrown is caused by dm.resume(). this boolean should be named some thing like tryingResume instead. better would be to investigate the nature of the exception.", "url": "https://github.com/apache/cloudstack/pull/4032#discussion_r461384239", "createdAt": "2020-07-28T07:46:19Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtDeleteVMSnapshotCommandWrapper.java", "diffHunk": "@@ -97,12 +108,26 @@ public Answer execute(final DeleteVMSnapshotCommand cmd, final LibvirtComputingR\n             } else if (snapshot == null) {\n                 s_logger.debug(\"Can not find vm snapshot \" + cmd.getTarget().getSnapshotName() + \" on vm: \" + vmName + \", return true\");\n                 return new DeleteVMSnapshotAnswer(cmd, cmd.getVolumeTOs());\n+            } else if (didDelete) {\n+                s_logger.error(\"Failed to resume vm after delete snapshot \" + cmd.getTarget().getSnapshotName() + \" on vm: \" + vmName + \" return true : \" + e);\n+                return new DeleteVMSnapshotAnswer(cmd, cmd.getVolumeTOs());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30bd160c90e514342f31154f0aed7640ed4a6233"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4NTA2Mw==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/apache/cloudstack/pull/4032#discussion_r461385063", "createdAt": "2020-07-28T07:47:52Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/KVMStorageProcessor.java", "diffHunk": "@@ -1029,7 +1029,7 @@ public Answer backupSnapshot(final CopyCommand cmd) {\n                         }\n                     }\n                 } catch (final Exception ex) {\n-                    s_logger.debug(\"Failed to delete snapshots on primary\", ex);\n+                    s_logger.error(\"Failed to delete snapshots on primary\", ex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30bd160c90e514342f31154f0aed7640ed4a6233"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43f1c87b9a898288322aa75ecfab435635b36043", "author": {"user": {"login": "ggoodrich-ipp", "name": "Greg Goodrich"}}, "url": "https://github.com/apache/cloudstack/commit/43f1c87b9a898288322aa75ecfab435635b36043", "committedDate": "2021-01-07T22:17:39Z", "message": "Making some adjustments based upon review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "214baede2d85b773c2207df6db2a821cdd86dac2", "author": {"user": {"login": "ggoodrich-ipp", "name": "Greg Goodrich"}}, "url": "https://github.com/apache/cloudstack/commit/214baede2d85b773c2207df6db2a821cdd86dac2", "committedDate": "2021-01-07T22:20:00Z", "message": "Merge branch 'master' into gjg-snapshot-pause-vm"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc5NjMyNDU3", "url": "https://github.com/apache/cloudstack/pull/4032#pullrequestreview-579632457", "createdAt": "2021-01-29T21:31:03Z", "commit": {"oid": "214baede2d85b773c2207df6db2a821cdd86dac2"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQyMTozMTowM1rOIc1VZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQyMTozMTowM1rOIc1VZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzEwNDg2OA==", "bodyText": "@ggoodrich-ipp\nshould it be \"DomainState\" instead of \"DomainInfo.DomainState\" ?", "url": "https://github.com/apache/cloudstack/pull/4032#discussion_r567104868", "createdAt": "2021-01-29T21:31:03Z", "author": {"login": "weizhouapache"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtDeleteVMSnapshotCommandWrapper.java", "diffHunk": "@@ -52,18 +52,33 @@ public Answer execute(final DeleteVMSnapshotCommand cmd, final LibvirtComputingR\n         final KVMStoragePoolManager storagePoolMgr = libvirtComputingResource.getStoragePoolMgr();\n         Domain dm = null;\n         DomainSnapshot snapshot = null;\n+        DomainInfo.DomainState oldState = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "214baede2d85b773c2207df6db2a821cdd86dac2"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "633438fdba7c80517e150596b683347f97986dec", "author": {"user": {"login": "ggoodrich-ipp", "name": "Greg Goodrich"}}, "url": "https://github.com/apache/cloudstack/commit/633438fdba7c80517e150596b683347f97986dec", "committedDate": "2021-02-01T15:14:09Z", "message": "Fixing import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTk2MDA2MTY4", "url": "https://github.com/apache/cloudstack/pull/4032#pullrequestreview-596006168", "createdAt": "2021-02-23T05:30:27Z", "commit": {"oid": "633438fdba7c80517e150596b683347f97986dec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4208, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}