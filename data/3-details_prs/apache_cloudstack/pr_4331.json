{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4NTkyMzk3", "number": 4331, "title": "change upgrade path to 4.14 (from 4.13) and intensify check", "bodyText": "Description\nChange upgrade path for image store table\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nTest Output:\nBefore migrate:\nMariaDB [cloud]> select * from volume_store_ref\\G\n*************************** 1. row ***************************\n                  id: 8\n            store_id: 2\n           volume_id: 3\n             zone_id: 0\n             created: 2020-09-17 10:49:23\n        last_updated: NULL\n              job_id: NULL\n        download_pct: 0\n                size: 52428800\n       physical_size: 0\n      download_state: NULL\n            checksum: NULL\n           error_str: NULL\n          local_path: NULL\n        install_path: volumes/2/3/365df8ed-b414-4311-af46-82043ee056af.qcow2\n                 url: NULL\n        download_url: NULL\n               state: Ready\n...\n*************************** 5. row ***************************\n                  id: 22\n            store_id: 2\n         template_id: 202\n             created: 2020-09-17 10:49:26\n        last_updated: NULL\n              job_id: NULL\n        download_pct: 100\n                size: 52428800\n          store_role: Image\n       physical_size: 43646976\n      download_state: DOWNLOADED\n           error_str: NULL\n          local_path: NULL\n        install_path: template/tmpl/2/202/6c3ec8aa-77fb-3cac-a74e-70f715361895.qcow2\n                 url: NULL\n               state: Ready\n....\nMariaDB [cloud]> select * from snapshot_store_ref\\G\n************************** 2. row ***************************\n                id: 8\n          store_id: 2\n       snapshot_id: 1\n           created: 2020-09-17 10:49:23\n      last_updated: NULL\n            job_id: NULL\n        store_role: Image\n              size: 52428800\n     physical_size: 43646976\nparent_snapshot_id: 0\n      install_path: snapshots/2/3/1fae4aa3-270e-490a-9592-3fc3cc40b35a\n             state: Ready\n      update_count: 2\n           ref_cnt: 0\n           updated: 2020-09-17 10:49:29\n         volume_id: 3\n\n\nAfter migration:\nMariaDB [cloud]> select * from volume_store_ref\\G\n*************************** 1. row ***************************\n                  id: 9\n            store_id: 1\n           volume_id: 3\n             zone_id: 0\n             created: 2020-09-17 10:53:44\n        last_updated: NULL\n              job_id: NULL\n        download_pct: 0\n                size: 52428800\n       physical_size: 0\n      download_state: NULL\n            checksum: NULL\n           error_str: NULL\n          local_path: NULL\n        install_path: volumes/2/3/365df8ed-b414-4311-af46-82043ee056af.qcow2\n                 url: NULL\n        download_url: NULL\n               state: Ready\n\nMariaDB [cloud]> select * from template_store_ref\\G\n*************************** 6. row ***************************\n                  id: 25\n            store_id: 1\n         template_id: 202\n             created: 2020-09-17 10:53:51\n        last_updated: NULL\n              job_id: NULL\n        download_pct: 100\n                size: 52428800\n          store_role: Image\n       physical_size: 43646976\n      download_state: DOWNLOADED\n           error_str: NULL\n          local_path: NULL\n        install_path: template/tmpl/2/202/6c3ec8aa-77fb-3cac-a74e-70f715361895.qcow2\n                 url: NULL\n               state: Ready\n\nMariaDB [cloud]> select * from snapshot_store_ref\\G\n*************************** 2. row ***************************\n                id: 9\n          store_id: 1\n       snapshot_id: 1\n           created: 2020-09-17 10:53:44\n      last_updated: NULL\n            job_id: NULL\n        store_role: Image\n              size: 52428800\n     physical_size: 43646976\nparent_snapshot_id: 0\n      install_path: snapshots/2/3/1fae4aa3-270e-490a-9592-3fc3cc40b35a\n             state: Ready\n      update_count: 2\n           ref_cnt: 0\n           updated: 2020-09-17 10:53:51\n         volume_id: 3", "createdAt": "2020-09-17T11:14:49Z", "url": "https://github.com/apache/cloudstack/pull/4331", "merged": true, "mergeCommit": {"oid": "cfbb4ff3dd5a53f55040d3345b96bc7e97964eb2"}, "closed": true, "closedAt": "2020-09-22T04:10:52Z", "author": {"login": "Pearl1594"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJu_TkAH2gAyNDg4NTkyMzk3OjVkOGQ2OWM3MDE0NjQ0MGIyZDlkYzM1ODVjZmUzOGVlODE4YzFjMmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLPqsugFqTQ5MzExMDM4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5d8d69c70146440b2d9dc3585cfe38ee818c1c2d", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/5d8d69c70146440b2d9dc3585cfe38ee818c1c2d", "committedDate": "2020-09-17T11:07:20Z", "message": "change upgrade path to 4.14 (from 4.13) and intensify check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwNTAyMzc1", "url": "https://github.com/apache/cloudstack/pull/4331#pullrequestreview-490502375", "createdAt": "2020-09-17T11:38:41Z", "commit": {"oid": "5d8d69c70146440b2d9dc3585cfe38ee818c1c2d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMjE4NTI2", "url": "https://github.com/apache/cloudstack/pull/4331#pullrequestreview-491218526", "createdAt": "2020-09-18T07:33:55Z", "commit": {"oid": "5d8d69c70146440b2d9dc3585cfe38ee818c1c2d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMjI1MTQ2", "url": "https://github.com/apache/cloudstack/pull/4331#pullrequestreview-491225146", "createdAt": "2020-09-18T07:44:22Z", "commit": {"oid": "5d8d69c70146440b2d9dc3585cfe38ee818c1c2d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMjIzMzI3", "url": "https://github.com/apache/cloudstack/pull/4331#pullrequestreview-491223327", "createdAt": "2020-09-18T07:41:31Z", "commit": {"oid": "5d8d69c70146440b2d9dc3585cfe38ee818c1c2d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNzo0MTozMlrOHUBsew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNzo0MzoxOFrOHUBv0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc2MTMzOQ==", "bodyText": "why is this moved to another upgrade script? it makes it harder to compare and would imply it will not be needed/used in propriatory 4.13 releases anymore", "url": "https://github.com/apache/cloudstack/pull/4331#discussion_r490761339", "createdAt": "2020-09-18T07:41:32Z", "author": {"login": "DaanHoogland"}, "path": "engine/schema/src/main/resources/META-INF/db/schema-41310to41400.sql", "diffHunk": "@@ -53,33 +53,6 @@ ALTER TABLE `cloud`.`vm_instance` ADD COLUMN `backup_offering_id` bigint unsigne\n ALTER TABLE `cloud`.`vm_instance` ADD COLUMN `backup_external_id` varchar(255) DEFAULT NULL COMMENT 'ID of external backup job or container if any';\n ALTER TABLE `cloud`.`vm_instance` ADD COLUMN `backup_volumes` text DEFAULT NULL COMMENT 'details of backedup volumes';\n \n-ALTER TABLE `cloud`.`image_store` ADD COLUMN `readonly` boolean DEFAULT false COMMENT 'defines status of image store';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d8d69c70146440b2d9dc3585cfe38ee818c1c2d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc2MjE5Mg==", "bodyText": "please put this condition in a boolean method with a good descriptive name.", "url": "https://github.com/apache/cloudstack/pull/4331#discussion_r490762192", "createdAt": "2020-09-18T07:43:18Z", "author": {"login": "DaanHoogland"}, "path": "services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/resource/NfsSecondaryStorageResource.java", "diffHunk": "@@ -1049,8 +1049,11 @@ protected Answer execute(CopyCommand cmd) {\n         DataTO destData = cmd.getDestTO();\n         DataStoreTO srcDataStore = srcData.getDataStore();\n         DataStoreTO destDataStore = destData.getDataStore();\n-\n-        if (DataStoreRole.Image == srcDataStore.getRole()  && DataStoreRole.Image == destDataStore.getRole()) {\n+        if (DataStoreRole.Image == srcDataStore.getRole() && DataStoreRole.Image == destDataStore.getRole() &&\n+            srcDataStore instanceof NfsTO && destDataStore instanceof NfsTO &&\n+            ((srcData.getObjectType() == DataObjectType.TEMPLATE && destData.getObjectType() == DataObjectType.TEMPLATE) ||\n+                    (srcData.getObjectType() == DataObjectType.SNAPSHOT && destData.getObjectType() == DataObjectType.SNAPSHOT) ||\n+                    (srcData.getObjectType() == DataObjectType.VOLUME && destData.getObjectType() == DataObjectType.VOLUME))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d8d69c70146440b2d9dc3585cfe38ee818c1c2d"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMjMxMTgx", "url": "https://github.com/apache/cloudstack/pull/4331#pullrequestreview-491231181", "createdAt": "2020-09-18T07:53:17Z", "commit": {"oid": "5d8d69c70146440b2d9dc3585cfe38ee818c1c2d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37398376e9e2e19ba6df61362073ee0a01171d21", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/37398376e9e2e19ba6df61362073ee0a01171d21", "committedDate": "2020-09-18T08:16:59Z", "message": "extracted check"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ff5858922eba3d0a8694b4c72dee97ed6d8781d", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/0ff5858922eba3d0a8694b4c72dee97ed6d8781d", "committedDate": "2020-09-18T08:08:57Z", "message": "extracted check"}, "afterCommit": {"oid": "37398376e9e2e19ba6df61362073ee0a01171d21", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/37398376e9e2e19ba6df61362073ee0a01171d21", "committedDate": "2020-09-18T08:16:59Z", "message": "extracted check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMzQ1NzY0", "url": "https://github.com/apache/cloudstack/pull/4331#pullrequestreview-491345764", "createdAt": "2020-09-18T10:35:43Z", "commit": {"oid": "37398376e9e2e19ba6df61362073ee0a01171d21"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMTEwMzgw", "url": "https://github.com/apache/cloudstack/pull/4331#pullrequestreview-493110380", "createdAt": "2020-09-22T03:45:37Z", "commit": {"oid": "37398376e9e2e19ba6df61362073ee0a01171d21"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4893, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}