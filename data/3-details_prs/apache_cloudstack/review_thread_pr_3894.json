{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2NjEwMTI0", "number": 3894, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDoyMzoyOFrODgtn5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQxNTozMjoyOVrODiFxlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NjI4NTE4OnYy", "diffSide": "RIGHT", "path": "plugins/metrics/src/main/java/org/apache/cloudstack/metrics/MetricsServiceImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDoyMzoyOFrOFrENdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDoyMzoyOFrOFrENdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcwMjA3MQ==", "bodyText": "@Pearl1594 calling listAll() i.e. getting all the rows will make the APIs slow in a large env; this is fine but can you explore a way to simply get the count (instead of the rows).", "url": "https://github.com/apache/cloudstack/pull/3894#discussion_r380702071", "createdAt": "2020-02-18T14:23:28Z", "author": {"login": "rhtyd"}, "path": "plugins/metrics/src/main/java/org/apache/cloudstack/metrics/MetricsServiceImpl.java", "diffHunk": "@@ -140,7 +145,9 @@ public InfrastructureResponse listInfrastructure() {\n         response.setStoragePools(storagePoolDao.listAll().size());\n         response.setImageStores(imageStoreDao.listImageStores().size());\n         response.setSystemvms(vmInstanceDao.listByTypes(VirtualMachine.Type.ConsoleProxy, VirtualMachine.Type.SecondaryStorageVm).size());\n-        response.setRouters(domainRouterDao.listAll().size());\n+        response.setRouters(domainRouterDao.listByRole(VirtualRouter.Role.VIRTUAL_ROUTER).size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b33e8904c373e6ad7916c37997a5063789a5d689"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NjI4Njk5OnYy", "diffSide": "RIGHT", "path": "plugins/metrics/src/main/java/org/apache/cloudstack/metrics/MetricsServiceImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDoyMzo1MVrOFrEOfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDoyMzo1MVrOFrEOfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcwMjMzMw==", "bodyText": "Same as above ^^ if it may be done quickly.", "url": "https://github.com/apache/cloudstack/pull/3894#discussion_r380702333", "createdAt": "2020-02-18T14:23:51Z", "author": {"login": "rhtyd"}, "path": "plugins/metrics/src/main/java/org/apache/cloudstack/metrics/MetricsServiceImpl.java", "diffHunk": "@@ -140,7 +145,9 @@ public InfrastructureResponse listInfrastructure() {\n         response.setStoragePools(storagePoolDao.listAll().size());\n         response.setImageStores(imageStoreDao.listImageStores().size());\n         response.setSystemvms(vmInstanceDao.listByTypes(VirtualMachine.Type.ConsoleProxy, VirtualMachine.Type.SecondaryStorageVm).size());\n-        response.setRouters(domainRouterDao.listAll().size());\n+        response.setRouters(domainRouterDao.listByRole(VirtualRouter.Role.VIRTUAL_ROUTER).size());\n+        response.setInternalLbs(domainRouterDao.listByRole(VirtualRouter.Role.INTERNAL_LB_VM).size());\n+        response.setAlerts(alertDao.listAll().size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b33e8904c373e6ad7916c37997a5063789a5d689"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NjM4NjE5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDo0Nzo1N1rOFrFK9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNTowMTozN1rOFrFu6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcxNzgxMg==", "bodyText": "@Pearl1594 can you share why you add the method searchForServersExcluding ?\nsource host is removed in line\nallHosts.remove(srcHost);", "url": "https://github.com/apache/cloudstack/pull/3894#discussion_r380717812", "createdAt": "2020-02-18T14:47:57Z", "author": {"login": "weizhouapache"}, "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -1248,7 +1248,7 @@ private HypervisorType getHypervisorType(VMInstanceVO vm, StoragePool srcVolumeP\n         final Map<Host, Boolean> requiresStorageMotion = new HashMap<Host, Boolean>();\n         DataCenterDeployment plan = null;\n         if (canMigrateWithStorage) {\n-            allHostsPair = searchForServers(startIndex, pageSize, null, hostType, null, srcHost.getDataCenterId(), null, null, null, keyword, null, null, srcHost.getHypervisorType(),\n+            allHostsPair = searchForServersExcluding(startIndex, pageSize, null, hostType, null, srcHost.getDataCenterId(), null, null, srcHostId, keyword, null, null, srcHost.getHypervisorType(),\n                     srcHost.getHypervisorVersion());\n             allHosts = allHostsPair.first();\n             allHosts.remove(srcHost);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b26d94a88bf736c93233562f7149ed15d3d8c2d"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcyNzAxOQ==", "bodyText": "@weizhouapache True, however, it was noticed that, say if there were 15 hosts, with a default pagesize of 10, the 1st page (considering it contained the src host) will have 9 objects returned and the 2nd page will have the remaining 5, as opposed to the ideal behavior of the 1st page containing 10 items and the remaining 4 being listed on page 2.", "url": "https://github.com/apache/cloudstack/pull/3894#discussion_r380727019", "createdAt": "2020-02-18T15:01:37Z", "author": {"login": "Pearl1594"}, "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -1248,7 +1248,7 @@ private HypervisorType getHypervisorType(VMInstanceVO vm, StoragePool srcVolumeP\n         final Map<Host, Boolean> requiresStorageMotion = new HashMap<Host, Boolean>();\n         DataCenterDeployment plan = null;\n         if (canMigrateWithStorage) {\n-            allHostsPair = searchForServers(startIndex, pageSize, null, hostType, null, srcHost.getDataCenterId(), null, null, null, keyword, null, null, srcHost.getHypervisorType(),\n+            allHostsPair = searchForServersExcluding(startIndex, pageSize, null, hostType, null, srcHost.getDataCenterId(), null, null, srcHostId, keyword, null, null, srcHost.getHypervisorType(),\n                     srcHost.getHypervisorVersion());\n             allHosts = allHostsPair.first();\n             allHosts.remove(srcHost);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcxNzgxMg=="}, "originalCommit": {"oid": "7b26d94a88bf736c93233562f7149ed15d3d8c2d"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1Njc4NTQ3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNjoxOTo0NFrOFrJA5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNjoxOTo0NFrOFrJA5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc4MDc3NQ==", "bodyText": "@Pearl1594 curb adding newlines", "url": "https://github.com/apache/cloudstack/pull/3894#discussion_r380780775", "createdAt": "2020-02-18T16:19:44Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -1515,6 +1515,89 @@ private boolean hasSuitablePoolsForVolume(final VolumeVO volume, final Host host\n         return suitablePools;\n     }\n \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b26d94a88bf736c93233562f7149ed15d3d8c2d"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2NzMxNTMzOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/com/cloud/user/AccountManagerImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNDo1NDoxN1rOFsrqRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNDo1NDoxN1rOFsrqRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5Njk5Nw==", "bodyText": "@Pearl1594 can you add a check here that listall is true and the user is an admin (not a domain admin, not a user but an admin)", "url": "https://github.com/apache/cloudstack/pull/3894#discussion_r382396997", "createdAt": "2020-02-21T04:54:17Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/com/cloud/user/AccountManagerImpl.java", "diffHunk": "@@ -2680,6 +2680,9 @@ public void buildACLSearchParameters(Account caller, Long id, String accountName\n                         }\n                     } else {\n                         domainIdRecursiveListProject.third(Project.ListProjectResourcesCriteria.ListProjectResourcesOnly);\n+                        if (listAll) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d52234517894cc40f29d11abdca98bc0b27b853"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MDcyNzg5OnYy", "diffSide": "RIGHT", "path": "engine/components-api/src/main/java/com/cloud/agent/AgentManager.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQxNTozMjozMFrOFtLnJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQxNTo0NzowM1rOFtLq-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkyMDQ4Nw==", "bodyText": "@Pearl1594 did you merge master? There are additional changes.", "url": "https://github.com/apache/cloudstack/pull/3894#discussion_r382920487", "createdAt": "2020-02-22T15:32:30Z", "author": {"login": "rhtyd"}, "path": "engine/components-api/src/main/java/com/cloud/agent/AgentManager.java", "diffHunk": "@@ -152,4 +152,6 @@\n     void notifyMonitorsOfHostAboutToBeRemoved(long hostId);\n \n     void notifyMonitorsOfRemovedHost(long hostId, long clusterId);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0538d184e678fbdcb3f7ddfc49c9644e26b6cda1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkyMDgwNQ==", "bodyText": "@rhtyd I haven't merged master", "url": "https://github.com/apache/cloudstack/pull/3894#discussion_r382920805", "createdAt": "2020-02-22T15:37:38Z", "author": {"login": "Pearl1594"}, "path": "engine/components-api/src/main/java/com/cloud/agent/AgentManager.java", "diffHunk": "@@ -152,4 +152,6 @@\n     void notifyMonitorsOfHostAboutToBeRemoved(long hostId);\n \n     void notifyMonitorsOfRemovedHost(long hostId, long clusterId);\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkyMDQ4Nw=="}, "originalCommit": {"oid": "0538d184e678fbdcb3f7ddfc49c9644e26b6cda1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkyMTQ2Ng==", "bodyText": "Can you check the diff, do we need changes around agent propagation?", "url": "https://github.com/apache/cloudstack/pull/3894#discussion_r382921466", "createdAt": "2020-02-22T15:47:03Z", "author": {"login": "rhtyd"}, "path": "engine/components-api/src/main/java/com/cloud/agent/AgentManager.java", "diffHunk": "@@ -152,4 +152,6 @@\n     void notifyMonitorsOfHostAboutToBeRemoved(long hostId);\n \n     void notifyMonitorsOfRemovedHost(long hostId, long clusterId);\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkyMDQ4Nw=="}, "originalCommit": {"oid": "0538d184e678fbdcb3f7ddfc49c9644e26b6cda1"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3940, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}