{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4NTU3MDE1", "number": 3851, "title": "vpc: set traffic type of private gateway IP to Public to fix keepalived misconfiguration", "bodyText": "Description\n\nIn VPC, the private gateway has traffic type as Guest not Public.\nThis leads to keepalived misconfiguration in VPC with redundant VRs.\nThere are some commits (eg 65cb222 and f4f9b3a) for this issue, however the issue still exists in 4.13 and 4.14.\nSimply setting the traffic type of ip address (of private gateway) to Public fixes the issue.\nFixes: #3402\n\n\n\n\n\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?\n\n\n\nBefore change,\nIn VPC master VR (redundant), IP of private gateway is added in keepalived, and gateway of private gateway is also added to ethX which is obviously wrong.\nnw_type of ethX is 'guest' in /etc/cloudstack/ips.json\nroot@r-181-VM:~# grep virtual_ipaddress /etc/keepalived/keepalived.conf -A5\n    virtual_ipaddress {\n        10.11.112.254/24 brd 10.11.112.255 dev eth6\n        192.168.0.2/27 brd 192.168.0.31 dev eth5\n        192.168.0.129/26 brd 192.168.0.191 dev eth4\n        192.168.0.65/26 brd 192.168.0.127 dev eth3\n    }\n\n8: eth6: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 1e:00:65:00:01:ef brd ff:ff:ff:ff:ff:ff\n    inet 10.11.112.10/24 brd 10.11.112.255 scope global eth6\n       valid_lft forever preferred_lft forever\n    inet 10.11.112.254/24 brd 10.11.112.255 scope global secondary eth6\n       valid_lft forever preferred_lft forever\n\n  \"eth6\": [\n    {\n      \"add\": true,\n      \"broadcast\": \"10.11.112.255\",\n      \"cidr\": \"10.11.112.10/24\",\n      \"device\": \"eth6\",\n      \"first_i_p\": false,\n      \"gateway\": \"10.11.112.254\",\n      \"netmask\": \"255.255.255.0\",\n      \"network\": \"10.11.112.0/24\",\n      \"new_nic\": false,\n      \"nic_dev_id\": 6,\n      \"nw_type\": \"guest\",\n      \"one_to_one_nat\": false,\n      \"public_ip\": \"10.11.112.10\",\n      \"size\": \"24\",\n      \"source_nat\": false,\n      \"vif_mac_address\": \"1e:00:65:00:01:ef\"\n    }\n  ],\n\nAfter change, private gateway IP is not added in keepalived, gateway is not added to ethX.\nnw_type of ethX is 'public' in /etc/cloudstack/ips.json\nroot@r-187-VM:~# grep virtual_ipaddress /etc/keepalived/keepalived.conf -A5\n    virtual_ipaddress {\n        192.168.0.2/27 brd 192.168.0.31 dev eth5\n        192.168.0.129/26 brd 192.168.0.191 dev eth4\n        192.168.0.65/26 brd 192.168.0.127 dev eth3\n    }\n\n\n8: eth6: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000\n    link/ether 1e:00:f2:00:01:ef brd ff:ff:ff:ff:ff:ff\n    inet 10.11.112.10/24 brd 10.11.112.255 scope global eth6\n       valid_lft forever preferred_lft forever\n\n\n  \"eth6\": [\n    {\n      \"add\": true,\n      \"broadcast\": \"10.11.112.255\",\n      \"cidr\": \"10.11.112.10/24\",\n      \"device\": \"eth6\",\n      \"first_i_p\": false,\n      \"gateway\": \"10.11.112.254\",\n      \"netmask\": \"255.255.255.0\",\n      \"network\": \"10.11.112.0/24\",\n      \"new_nic\": false,\n      \"nic_dev_id\": 6,\n      \"nw_type\": \"public\",\n      \"one_to_one_nat\": false,\n      \"public_ip\": \"10.11.112.10\",\n      \"size\": \"24\",\n      \"source_nat\": false,\n      \"vif_mac_address\": \"1e:00:f2:00:01:ef\"\n    }\n  ],", "createdAt": "2020-01-29T13:29:15Z", "url": "https://github.com/apache/cloudstack/pull/3851", "merged": true, "mergeCommit": {"oid": "a9a1737dd9be92a62e8a03775f54089285a99d56"}, "closed": true, "closedAt": "2020-02-06T19:22:09Z", "author": {"login": "ustcweizhou"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_F9IHgH2gAyMzY4NTU3MDE1OmE3YzljNTIxMmI2ZTQyNTU3ZDg4Y2MxOGY3NTUyNjdjNTVhNmM2OTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBkfJ0gFqTM1NDIxODYxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a7c9c5212b6e42557d88cc18f755267c55a6c699", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/a7c9c5212b6e42557d88cc18f755267c55a6c699", "committedDate": "2020-01-29T13:28:27Z", "message": "vpc: set traffic type of private gateway IP to Public to fix keepalived misconfiguration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMDQ2ODk1", "url": "https://github.com/apache/cloudstack/pull/3851#pullrequestreview-351046895", "createdAt": "2020-01-30T18:31:26Z", "commit": {"oid": "a7c9c5212b6e42557d88cc18f755267c55a6c699"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxODozMToyNlrOFj1Yng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxODozMToyNlrOFj1Yng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzExOTEzNA==", "bodyText": "@ustcweizhou what do you think of adding also the network name? Sometimes it annoys me to see a lot of IDs on the log and then go after a few selects to understand what is really going on.\nHaving the network ID and name would be great for debugging :-)", "url": "https://github.com/apache/cloudstack/pull/3851#discussion_r373119134", "createdAt": "2020-01-30T18:31:26Z", "author": {"login": "GabrielBrascher"}, "path": "server/src/main/java/com/cloud/network/router/CommandSetupHelper.java", "diffHunk": "@@ -1101,4 +1105,14 @@ protected String getGuestDhcpRange(final NicProfile guestNic, final Network gues\n         }\n         return dhcpRange;\n     }\n+\n+    private TrafficType getNetworkTrafficType(Network network) {\n+        final VpcGatewayVO gateway = _vpcGatewayDao.getVpcGatewayByNetworkId(network.getId());\n+        if (gateway != null) {\n+            s_logger.debug(\"network \" + network.getId() + \" is a vpc private gateway, set traffic type to Public\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7c9c5212b6e42557d88cc18f755267c55a6c699"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15ed0d94a9274ef0143f6b93950d39ed0e671c59", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/15ed0d94a9274ef0143f6b93950d39ed0e671c59", "committedDate": "2020-01-30T19:48:37Z", "message": "Add network name in debugging log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMjIzODQw", "url": "https://github.com/apache/cloudstack/pull/3851#pullrequestreview-352223840", "createdAt": "2020-02-03T12:40:49Z", "commit": {"oid": "15ed0d94a9274ef0143f6b93950d39ed0e671c59"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMjA4MTE1", "url": "https://github.com/apache/cloudstack/pull/3851#pullrequestreview-353208115", "createdAt": "2020-02-04T18:37:15Z", "commit": {"oid": "15ed0d94a9274ef0143f6b93950d39ed0e671c59"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MjE4NjEw", "url": "https://github.com/apache/cloudstack/pull/3851#pullrequestreview-354218610", "createdAt": "2020-02-06T06:10:37Z", "commit": {"oid": "15ed0d94a9274ef0143f6b93950d39ed0e671c59"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4580, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}