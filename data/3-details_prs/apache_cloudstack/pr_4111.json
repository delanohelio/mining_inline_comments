{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MzI0NTE5", "number": 4111, "title": "API-call to declare host as Degraded", "bodyText": "Description\n\nSometimes a host is down (admins know) but CS keeps VMs in the 'Running' state to avoid data corruption. An example of that is when a KVM host using Ceph halts. CloudStack cannot check if VM still writing on disk, therefore it leaves it in the \"Running\" state and HA will not be triggered for those VMs.\nWith that in mind, this PR proposes an API-call to declare a Host as \"Degraded\". All \"Running\"  VMs on that Host should then be set to 'Stopped' so HA can kick in.\n\nCommand name: declareHostAsDegraded; parameters: id (id of the host); description: Declare host as 'Degraded'. The host must be on 'Disconnected' or 'Alert' state.\nCommand name: cancelHostAsDegraded; parameters: id (id of the host); description: Cancel host status from 'Degraded'. The host will transit back to status 'Enabled'.\n\nNote:\nAdmin MUST check if there are VMs running on the problematic host and call such API command just if he/she is 100% sure that can deploy the Running VMs on another host.\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nExample of how host Resource State is shown on UI when a host is declared 'Degraded' (taken when this PR was using state \"Dead\"):\n\nHow Has This Been Tested?\n\n\n\nNote: tests were performed on two KVM hosts with HA enabled: Host01 and Host02.\nTest 01: declareHostAsDegraded\nha.force = false\n\nDeploy VMs on host Host01\n\n\ndeploy 2 VMs shared storage, HA enabled (VM01, VM02)\ndeploy 1 VM shared storage, HA disabled (VM03)\ndeploy 1 VM local storage, HA disabled (VM04)\n\n\nStop cloudstack-agent.service on Host1\nRun Virsh command to shutdown/destroy all VMs in Host10\nAll VMs are in \"Running\" state, the host is in \"Disconnected\"\ncall API command declareHostsAsDegraded\n\n\nHost state migrated to \"Degraded\"\nVMs with HA + Shared started on Host02 (transit from Running to Stopped, Stopped -> Starting, Starting -> Running)\nVMs with no HA were marked as Stopped (transit from Running to Stopped, restart Scheduler ignores non-HA VMs)\n\nha.force=true\n\nSteps 1, 2, 3, 4, and 5 executed again.\nVMs VM01, VM02, and VM03 got re-started by HA\nVM04 did not start due to its local storage (this is the correct behavior).\n\nTest conclusion: all working as expected.\nTest 02:  cancelHostAsDegraded:\n\nStart cloudstack-agent.service on Host01\nCall API command cancelHostAsDegraded\nAssert that VMs can be deployed/migrated on Host01\nTest conclusion: all working as expected.", "createdAt": "2020-05-28T08:16:16Z", "url": "https://github.com/apache/cloudstack/pull/4111", "merged": true, "mergeCommit": {"oid": "43c8da2d0e8466a45b9de31221c17748003d6a0c"}, "closed": true, "closedAt": "2021-08-08T19:38:06Z", "author": {"login": "GabrielBrascher"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcn2VmsABqjM0MDQ5ODg2MDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABexHsIcgFqTcyMjQ3NTM1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "79e229708bab1793965355a6e9cec2276e3a9d52", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/79e229708bab1793965355a6e9cec2276e3a9d52", "committedDate": "2020-05-28T13:30:53Z", "message": "Stop VMs on Dead Host\n- Enhance code"}, "afterCommit": {"oid": "07fa9d46b118bc9f7b09fda78e170b35e21acdba", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/07fa9d46b118bc9f7b09fda78e170b35e21acdba", "committedDate": "2020-06-04T03:41:09Z", "message": "Stop VMs on Dead Host\n- Enhance code"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "07fa9d46b118bc9f7b09fda78e170b35e21acdba", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/07fa9d46b118bc9f7b09fda78e170b35e21acdba", "committedDate": "2020-06-04T03:41:09Z", "message": "Stop VMs on Dead Host\n- Enhance code"}, "afterCommit": {"oid": "208a203f426bb2630496e986b1fdbf589c4c4551", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/208a203f426bb2630496e986b1fdbf589c4c4551", "committedDate": "2020-06-12T00:48:36Z", "message": "Stop VMs on Dead Host\n- Enhance code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "478e639bbf308e5a109410a215220ef25be8a932", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/478e639bbf308e5a109410a215220ef25be8a932", "committedDate": "2020-06-19T12:47:46Z", "message": "Declare host as dead"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17dea066d763087736d2ff91321cfafbbc73a74d", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/17dea066d763087736d2ff91321cfafbbc73a74d", "committedDate": "2020-06-19T12:48:04Z", "message": "Enhance DeclareHostAsDeadCmd and add CancelHostAsDeadCmd"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4cef0d3c4e0042b4cfc16c1b1685c64309afcaf", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/f4cef0d3c4e0042b4cfc16c1b1685c64309afcaf", "committedDate": "2020-06-19T12:48:14Z", "message": "Stop VMs on Dead Host\n- Enhance code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9681ebdfc3bb28c2fa88ceab7740afdb78a7478f", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/9681ebdfc3bb28c2fa88ceab7740afdb78a7478f", "committedDate": "2020-06-19T18:32:49Z", "message": "Add \"since\" on API, enhance description; change API cmds response handling"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "208a203f426bb2630496e986b1fdbf589c4c4551", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/208a203f426bb2630496e986b1fdbf589c4c4551", "committedDate": "2020-06-12T00:48:36Z", "message": "Stop VMs on Dead Host\n- Enhance code"}, "afterCommit": {"oid": "9681ebdfc3bb28c2fa88ceab7740afdb78a7478f", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/9681ebdfc3bb28c2fa88ceab7740afdb78a7478f", "committedDate": "2020-06-19T18:32:49Z", "message": "Add \"since\" on API, enhance description; change API cmds response handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "111b98719c286971c524f10e6764286a2e40f31b", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/111b98719c286971c524f10e6764286a2e40f31b", "committedDate": "2020-08-05T21:40:39Z", "message": "Replace the ResourceState and command names from 'Dead' to 'Degraded'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "488da4cdd7f0602ff8b7bad48475c6be367351ca", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/488da4cdd7f0602ff8b7bad48475c6be367351ca", "committedDate": "2020-08-06T21:02:58Z", "message": "Replace missing 'Dead' word to 'Degraded'"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNDgyNzE3", "url": "https://github.com/apache/cloudstack/pull/4111#pullrequestreview-491482717", "createdAt": "2020-09-18T13:49:51Z", "commit": {"oid": "488da4cdd7f0602ff8b7bad48475c6be367351ca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjQwNjgzODIw", "url": "https://github.com/apache/cloudstack/pull/4111#pullrequestreview-640683820", "createdAt": "2021-04-21T06:51:23Z", "commit": {"oid": "488da4cdd7f0602ff8b7bad48475c6be367351ca"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0yMVQwNjo1MToyM1rOJMpw9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0yMVQwNjo1Mzo1NlrOJMp2Hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzI0Njk2Nw==", "bodyText": "change this to 4.16?", "url": "https://github.com/apache/cloudstack/pull/4111#discussion_r617246967", "createdAt": "2021-04-21T06:51:23Z", "author": {"login": "ravening"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/host/CancelHostAsDegradedCmd.java", "diffHunk": "@@ -0,0 +1,113 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.api.command.admin.host;\n+\n+import com.cloud.event.EventTypes;\n+import com.cloud.host.Host;\n+import com.cloud.utils.fsm.NoTransitionException;\n+import org.apache.cloudstack.acl.RoleType;\n+import org.apache.cloudstack.api.ApiArgValidator;\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiCommandJobType;\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.ApiErrorCode;\n+import org.apache.cloudstack.api.BaseCmd;\n+import org.apache.cloudstack.api.BaseAsyncCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.ServerApiException;\n+import org.apache.cloudstack.api.response.HostResponse;\n+import org.apache.cloudstack.context.CallContext;\n+\n+@APICommand(name = \"cancelHostAsDegraded\",\n+        description = \"Cancel host status from 'Degraded'. Host will transit back to status 'Enabled'.\",\n+        since = \"4.15.0.0\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "488da4cdd7f0602ff8b7bad48475c6be367351ca"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzI0NzExMA==", "bodyText": "same here as well", "url": "https://github.com/apache/cloudstack/pull/4111#discussion_r617247110", "createdAt": "2021-04-21T06:51:41Z", "author": {"login": "ravening"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/host/DeclareHostAsDegradedCmd.java", "diffHunk": "@@ -0,0 +1,113 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+package org.apache.cloudstack.api.command.admin.host;\n+\n+import com.cloud.event.EventTypes;\n+import com.cloud.host.Host;\n+import com.cloud.utils.fsm.NoTransitionException;\n+import org.apache.cloudstack.acl.RoleType;\n+import org.apache.cloudstack.api.ApiArgValidator;\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiCommandJobType;\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.ApiErrorCode;\n+import org.apache.cloudstack.api.BaseCmd;\n+import org.apache.cloudstack.api.BaseAsyncCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.ServerApiException;\n+import org.apache.cloudstack.api.response.HostResponse;\n+import org.apache.cloudstack.context.CallContext;\n+\n+@APICommand(name = \"declareHostAsDegraded\",\n+        description = \"Declare host as 'Degraded'. Host must be on 'Disconnected' or 'Alert' state. The ADMIN must be sure that there are no VMs running on the respective host otherwise this command might corrupted VMs that were running on the 'Degraded' host.\",\n+        since = \"4.15.0.0\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "488da4cdd7f0602ff8b7bad48475c6be367351ca"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzI0ODI4Nw==", "bodyText": "Better to display hostname instead of id?", "url": "https://github.com/apache/cloudstack/pull/4111#discussion_r617248287", "createdAt": "2021-04-21T06:53:56Z", "author": {"login": "ravening"}, "path": "server/src/main/java/com/cloud/resource/ResourceManagerImpl.java", "diffHunk": "@@ -1321,6 +1332,87 @@ public Host maintain(final PrepareForMaintenanceCmd cmd) {\n         }\n     }\n \n+    /**\n+     * Declares host as Degraded. This method is used in critical situations; e.g. if it is not possible to start host, not even via out-of-band.\n+     */\n+    @Override\n+    public Host declareHostAsDegraded(final DeclareHostAsDegradedCmd cmd) throws NoTransitionException {\n+        Long hostId = cmd.getId();\n+        HostVO host = _hostDao.findById(hostId);\n+\n+        if (host == null || host.getRemoved() != null) {\n+            throw new InvalidParameterValueException(String.format(\"Host [id:%s] does not exist\", host.getId()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "488da4cdd7f0602ff8b7bad48475c6be367351ca"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a28a6bd68cdac2c1ac3ee310f219a45ac0b8243", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/7a28a6bd68cdac2c1ac3ee310f219a45ac0b8243", "committedDate": "2021-04-23T14:13:31Z", "message": "Update API version for 4.16.0.0"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzIyNDc1MzU2", "url": "https://github.com/apache/cloudstack/pull/4111#pullrequestreview-722475356", "createdAt": "2021-08-04T16:08:13Z", "commit": {"oid": "7a28a6bd68cdac2c1ac3ee310f219a45ac0b8243"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4321, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}