{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4Mzk3MzY4", "number": 4385, "title": "vmware: vm migration improvements", "bodyText": "Description\n\nFixes inter-cluster migration of VMs\nAllows migration of stopped VM with disks attached to different and suitable pools\nImproves inter-cluster detached volume migration\nAllows inter-cluster migration (clusters of same Pod) for system VMs, VRs on VMware\nAllows storage migration for stopped system VMs, VRs on VMware within same Pod if StoragePool cluster scopetype\n\nLinked Primate PR: apache/cloudstack-primate#789 [Changes merged in this PR after new UI merge]\nDocumentation PR: apache/cloudstack-documentation#170\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?\n\n\n\nUI and cmk", "createdAt": "2020-10-06T09:26:20Z", "url": "https://github.com/apache/cloudstack/pull/4385", "merged": true, "mergeCommit": {"oid": "d6e8b53736d92363d0f8689997259769356122de"}, "closed": true, "closedAt": "2021-02-12T07:11:42Z", "author": {"login": "shwstppr"}, "timelineItems": {"totalCount": 46, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOYGQmAH2gAyNDk4Mzk3MzY4OmNlYjE2YzIwZGZhMjIxNTMzMjU4Yzc1NDJlMjc3NmRmYzY4NDViYmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABd5UUQsgFqTU4OTIxMzM2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ceb16c20dfa221533258c7542e2776dfc6845bba", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/ceb16c20dfa221533258c7542e2776dfc6845bba", "committedDate": "2020-10-01T21:16:44Z", "message": "vmware: migration improvements\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fa0c79750038673a72b1c75e0d67b72f10b5847", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/1fa0c79750038673a72b1c75e0d67b72f10b5847", "committedDate": "2020-10-05T08:21:39Z", "message": "ui changes\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c41d5fba6a0e6c0bfda77ebf0465445a4cb86986", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/c41d5fba6a0e6c0bfda77ebf0465445a4cb86986", "committedDate": "2020-10-05T10:08:26Z", "message": "null hypervisor check\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "003af0e77d26be14e1571fd8dd3e145073ed3da4", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/003af0e77d26be14e1571fd8dd3e145073ed3da4", "committedDate": "2020-10-06T07:15:28Z", "message": "review changes\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6aad7a7600c8264d61a623ef5f4f5d68818131ba", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/6aad7a7600c8264d61a623ef5f4f5d68818131ba", "committedDate": "2020-10-06T09:14:53Z", "message": "review changes\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "341a69fe389e5925fcd2d23dbf73c175d5502a1c", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/341a69fe389e5925fcd2d23dbf73c175d5502a1c", "committedDate": "2020-10-06T11:22:36Z", "message": "fix\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "503ae44e18fca578d4733bdbc50a9db789fa15e3", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/503ae44e18fca578d4733bdbc50a9db789fa15e3", "committedDate": "2020-10-07T12:38:27Z", "message": "fixes\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2a2ec53cddcd132e038d2a762d9441a7bd74efc", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/d2a2ec53cddcd132e038d2a762d9441a7bd74efc", "committedDate": "2020-11-03T09:02:33Z", "message": "Merge branch 'master' into vmware-migration-improvements\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MDcxMzQx", "url": "https://github.com/apache/cloudstack/pull/4385#pullrequestreview-527071341", "createdAt": "2020-11-10T10:40:36Z", "commit": {"oid": "d2a2ec53cddcd132e038d2a762d9441a7bd74efc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMDo0MDozN1rOHwWdgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxMDo0MDozN1rOHwWdgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ2MTY5Nw==", "bodyText": "check that split has two length", "url": "https://github.com/apache/cloudstack/pull/4385#discussion_r520461697", "createdAt": "2020-11-10T10:40:37Z", "author": {"login": "rhtyd"}, "path": "vmware-base/src/main/java/com/cloud/hypervisor/vmware/util/VmwareHelper.java", "diffHunk": "@@ -744,4 +744,18 @@ public static XMLGregorianCalendar getXMLGregorianCalendar(final Date date, fina\n         return DatatypeFactory.newInstance().newXMLGregorianCalendar(gregorianCalendar);\n     }\n \n+    public static HostMO getHostMOFromHostName(final VmwareContext context, final String hostName) {\n+        HostMO host = null;\n+        if (com.cloud.utils.StringUtils.isNotBlank(hostName) && hostName.contains(\"@\")) {\n+            String hostMorInfo = hostName.split(\"@\")[0];\n+            if (hostMorInfo.contains(\":\")) {\n+                ManagedObjectReference morHost = new ManagedObjectReference();\n+                morHost.setType(hostMorInfo.split(\":\")[0]);\n+                morHost.setValue(hostMorInfo.split(\":\")[1]);\n+                host = new HostMO(context, morHost);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2a2ec53cddcd132e038d2a762d9441a7bd74efc"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MDcxNTI5", "url": "https://github.com/apache/cloudstack/pull/4385#pullrequestreview-527071529", "createdAt": "2020-11-10T10:40:48Z", "commit": {"oid": "d2a2ec53cddcd132e038d2a762d9441a7bd74efc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45ad746bdc749ea508a970893a5ee965ad659773", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/45ad746bdc749ea508a970893a5ee965ad659773", "committedDate": "2020-11-13T09:34:38Z", "message": "fix volume migration\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39683d8998c106a8b640d64021ec2a47cfdfe7d5", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/39683d8998c106a8b640d64021ec2a47cfdfe7d5", "committedDate": "2020-11-13T09:35:47Z", "message": "fix\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74f85ba25e7daf1803fee090b3b73aa8ed203732", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/74f85ba25e7daf1803fee090b3b73aa8ed203732", "committedDate": "2020-11-13T11:45:02Z", "message": "fix datastore type getter\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b1e0f67bd5e6de1ef424c924378c9a18cdff0e6", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/9b1e0f67bd5e6de1ef424c924378c9a18cdff0e6", "committedDate": "2020-11-17T06:27:05Z", "message": "fix\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d409b3b97f5a97f185da2b10d3db792b4a0f7a40", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/d409b3b97f5a97f185da2b10d3db792b4a0f7a40", "committedDate": "2020-11-18T09:24:02Z", "message": "log\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2039b5589c25766f702212ed290bf12536a73a46", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/2039b5589c25766f702212ed290bf12536a73a46", "committedDate": "2020-11-18T10:54:04Z", "message": "get host hardware version\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aee302b79b9e2c96c0f4dfbdf309eb4b2d569e3f", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/aee302b79b9e2c96c0f4dfbdf309eb4b2d569e3f", "committedDate": "2020-11-18T12:20:41Z", "message": "add newer version\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98246835a7dd03ba11d03974548ed75b85ffef8a", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/98246835a7dd03ba11d03974548ed75b85ffef8a", "committedDate": "2020-11-18T14:50:09Z", "message": "retrieve hardwareVersion from sdk\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4419ce6758a2fcd35aa38e4c654520a9070f8dbd", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/4419ce6758a2fcd35aa38e4c654520a9070f8dbd", "committedDate": "2020-11-19T04:51:58Z", "message": "revert to hardwareversion mapping\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4085a14b8c2417e4ad2494e9ff92088ec9cb53af", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/4085a14b8c2417e4ad2494e9ff92088ec9cb53af", "committedDate": "2020-11-19T07:30:32Z", "message": "fix ui\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd7825f2a7765ab308f7c900f134124259b7b7c5", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/dd7825f2a7765ab308f7c900f134124259b7b7c5", "committedDate": "2020-11-19T07:46:06Z", "message": "fix\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ca75f04c6164bbdde05a7712e6c4933a456e683", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/9ca75f04c6164bbdde05a7712e6c4933a456e683", "committedDate": "2020-11-20T05:07:46Z", "message": "changes for system vm\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "919c5dd8f25db8ba510115386a790298301b95b0", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/919c5dd8f25db8ba510115386a790298301b95b0", "committedDate": "2020-11-20T05:22:09Z", "message": "fix\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f6b1d16b4b44336cfe70d0eb6979742fb314172", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/8f6b1d16b4b44336cfe70d0eb6979742fb314172", "committedDate": "2020-11-20T10:42:04Z", "message": "fix npe on defaultnic\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MzQ5MDYx", "url": "https://github.com/apache/cloudstack/pull/4385#pullrequestreview-535349061", "createdAt": "2020-11-20T11:30:34Z", "commit": {"oid": "8f6b1d16b4b44336cfe70d0eb6979742fb314172"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMTozMDozNVrOH3MBFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMTozMDozNVrOH3MBFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYzMDYxNQ==", "bodyText": "@nvazquez @rhtyd @sureshanaparti can you please comment if this is okay. As per our interactions, I tried to get host harwdwareVersion using SDK but it still returns null. By default, VMware is creating VM with highest available hardwareVersion which creates an issue while migrating detached disks across cluster", "url": "https://github.com/apache/cloudstack/pull/4385#discussion_r527630615", "createdAt": "2020-11-20T11:30:35Z", "author": {"login": "shwstppr"}, "path": "vmware-base/src/main/java/com/cloud/hypervisor/vmware/mo/HypervisorHostHelper.java", "diffHunk": "@@ -2207,4 +2208,44 @@ public static void createBaseFolderInDatastore(DatastoreMO dsMo, VmwareHyperviso\n             dsMo.makeDirectory(hiddenFolderPath, hyperHost.getHyperHostDatacenter());\n         }\n     }\n+\n+    public static Integer getHostHardwareVersion(VmwareHypervisorHost host) {\n+        Integer version = null;\n+        HostMO hostMo = new HostMO(host.getContext(), host.getMor());\n+        ComputeResourceConfigInfo info = null;\n+        try {\n+            info = hostMo.getHostConfigInfo();\n+        } catch (Exception ignored) {}\n+        if (info != null) {\n+            version = Integer.valueOf(info.getDefaultHardwareVersionKey());\n+        } else {\n+            String hostApiVersion = \"\";\n+            try {\n+                hostApiVersion = hostMo.getHostAboutInfo().getApiVersion();\n+            } catch (Exception ignored) {}\n+            if (hostApiVersion == null) {\n+                hostApiVersion = \"\";\n+            }\n+            if (hostApiVersion.equalsIgnoreCase(\"7.0\")) {\n+                version = 17;\n+            } else if (hostApiVersion.equalsIgnoreCase(\"6.7\")) {\n+                version = 14;\n+            } else if (hostApiVersion.equalsIgnoreCase(\"6.5\")) {\n+                version = 13;\n+            } else if (hostApiVersion.equalsIgnoreCase(\"6.0\")) {\n+                version = 11;\n+            } else if (hostApiVersion.equalsIgnoreCase(\"5.5\")) {\n+                version = 10;\n+            } else if (hostApiVersion.equalsIgnoreCase(\"5.1\")) {\n+                version = 9;\n+            } else if (hostApiVersion.equalsIgnoreCase(\"5.0\")) {\n+                version = 8;\n+            } else if (hostApiVersion.startsWith(\"4.\")) {\n+                version = 7;\n+            } else if (hostApiVersion.equalsIgnoreCase(\"3.5\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f6b1d16b4b44336cfe70d0eb6979742fb314172"}, "originalPosition": 156}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c765b87556bd8c8fd4f25ee5b66d6a325d74ca65", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/c765b87556bd8c8fd4f25ee5b66d6a325d74ca65", "committedDate": "2020-11-20T12:55:42Z", "message": "revert SDK configurationEx property changes\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d50e3acd4b854d7f52244eeb64c43588ee5ef2be", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/d50e3acd4b854d7f52244eeb64c43588ee5ef2be", "committedDate": "2020-11-20T13:22:23Z", "message": "Merge branch 'master' into vmware-migration-improvements\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NzA3OTY2", "url": "https://github.com/apache/cloudstack/pull/4385#pullrequestreview-536707966", "createdAt": "2020-11-23T17:44:21Z", "commit": {"oid": "d50e3acd4b854d7f52244eeb64c43588ee5ef2be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxNzo0NDoyMVrOH4YoDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxNzo0NDoyMVrOH4YoDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg4NTc3NQ==", "bodyText": "@shwstppr is it possible move this to a static map with hypervisor version & its hardware version, in this helper class ? so that it will be easy to maintain and access these versions across the VMware resource.", "url": "https://github.com/apache/cloudstack/pull/4385#discussion_r528885775", "createdAt": "2020-11-23T17:44:21Z", "author": {"login": "sureshanaparti"}, "path": "vmware-base/src/main/java/com/cloud/hypervisor/vmware/mo/HypervisorHostHelper.java", "diffHunk": "@@ -2207,4 +2207,36 @@ public static void createBaseFolderInDatastore(DatastoreMO dsMo, VmwareHyperviso\n             dsMo.makeDirectory(hiddenFolderPath, hyperHost.getHyperHostDatacenter());\n         }\n     }\n+\n+    public static Integer getHostHardwareVersion(VmwareHypervisorHost host) {\n+        Integer version = null;\n+        HostMO hostMo = new HostMO(host.getContext(), host.getMor());\n+        String hostApiVersion = \"\";\n+        try {\n+            hostApiVersion = hostMo.getHostAboutInfo().getApiVersion();\n+        } catch (Exception ignored) {}\n+        if (hostApiVersion == null) {\n+            hostApiVersion = \"\";\n+        }\n+        if (hostApiVersion.equalsIgnoreCase(\"7.0\")) {\n+            version = 17;\n+        } else if (hostApiVersion.equalsIgnoreCase(\"6.7\")) {\n+            version = 14;\n+        } else if (hostApiVersion.equalsIgnoreCase(\"6.5\")) {\n+            version = 13;\n+        } else if (hostApiVersion.equalsIgnoreCase(\"6.0\")) {\n+            version = 11;\n+        } else if (hostApiVersion.equalsIgnoreCase(\"5.5\")) {\n+            version = 10;\n+        } else if (hostApiVersion.equalsIgnoreCase(\"5.1\")) {\n+            version = 9;\n+        } else if (hostApiVersion.equalsIgnoreCase(\"5.0\")) {\n+            version = 8;\n+        } else if (hostApiVersion.startsWith(\"4.\")) {\n+            version = 7;\n+        } else if (hostApiVersion.equalsIgnoreCase(\"3.5\")) {\n+            version = 4;\n+        }\n+        return version;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d50e3acd4b854d7f52244eeb64c43588ee5ef2be"}, "originalPosition": 151}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa661f3e5fcbc127a700b663a84b774d134f2af1", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/fa661f3e5fcbc127a700b663a84b774d134f2af1", "committedDate": "2020-12-07T11:54:13Z", "message": "use static mapping for api version to hardware version\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e07ff2d4a80146a133f92794040068c71c7fc9e", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/0e07ff2d4a80146a133f92794040068c71c7fc9e", "committedDate": "2020-12-07T12:02:38Z", "message": "Merge branch 'master' into vmware-migration-improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a67382f3ebe0a5be8b55bccdb3ed678563e68827", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/a67382f3ebe0a5be8b55bccdb3ed678563e68827", "committedDate": "2020-12-29T06:49:44Z", "message": "Merge branch 'master' into vmware-migration-improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "131b5e06a7886b045d3089b20189742aa5a710c1", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/131b5e06a7886b045d3089b20189742aa5a710c1", "committedDate": "2020-12-29T07:00:01Z", "message": "fix systemvm migration with volume on zone-wide store\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "102ceea0f47be25e04ad3492fed3906c1d0b92a0", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/102ceea0f47be25e04ad3492fed3906c1d0b92a0", "committedDate": "2020-12-29T07:53:44Z", "message": "fix\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "892cdeb7857670f8e0c5357572fbc59f4c37b998", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/892cdeb7857670f8e0c5357572fbc59f4c37b998", "committedDate": "2021-01-04T10:54:42Z", "message": "fixes\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "391fcf27a240b97ab7d3ee2110a15e9f5e584cb1", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/391fcf27a240b97ab7d3ee2110a15e9f5e584cb1", "committedDate": "2021-01-12T10:45:27Z", "message": "Merge branch 'master' into vmware-migration-improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da7de1fe93a695e5e1ffb08431e7a15d82a3ea90", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/da7de1fe93a695e5e1ffb08431e7a15d82a3ea90", "committedDate": "2021-01-12T10:52:39Z", "message": "fix post hypervisor storage migration cleanup\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcwMjI0MDcz", "url": "https://github.com/apache/cloudstack/pull/4385#pullrequestreview-570224073", "createdAt": "2021-01-18T07:27:51Z", "commit": {"oid": "da7de1fe93a695e5e1ffb08431e7a15d82a3ea90"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6220a60cdc9a6aec2a7609e15eacbf173660faac", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/6220a60cdc9a6aec2a7609e15eacbf173660faac", "committedDate": "2021-01-22T10:27:48Z", "message": "Merge branch 'master' into vmware-migration-improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "099d170d6c4202211ab55dcf8b091e8bb50973c2", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/099d170d6c4202211ab55dcf8b091e8bb50973c2", "committedDate": "2021-01-22T10:42:49Z", "message": "ui: moved over new ui changes from old repo\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc2Mjg5Mzk1", "url": "https://github.com/apache/cloudstack/pull/4385#pullrequestreview-576289395", "createdAt": "2021-01-26T12:13:07Z", "commit": {"oid": "099d170d6c4202211ab55dcf8b091e8bb50973c2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNlQxMjoxMzowN1rOIaUMfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNlQxMjoxMzowN1rOIaUMfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDQ2NDc2Nw==", "bodyText": "@shwstppr possible to optimise multiple checks for getHostId() and getStorageId() not null here ?", "url": "https://github.com/apache/cloudstack/pull/4385#discussion_r564464767", "createdAt": "2021-01-26T12:13:07Z", "author": {"login": "sureshanaparti"}, "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "diffHunk": "@@ -109,15 +122,43 @@ public String getEventDescription() {\n \n     @Override\n     public void execute() {\n+        if (getHostId() == null && getStorageId() == null) {\n+            throw new InvalidParameterValueException(\"Either hostId or storageId must be specified\");\n+        }\n \n-        Host destinationHost = _resourceService.getHost(getHostId());\n-        if (destinationHost == null) {\n-            throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n+        if (getHostId() != null && getStorageId() != null) {\n+            throw new InvalidParameterValueException(\"Only one of hostId and storageId can be specified\");\n+        }\n+\n+        Host destinationHost = null;\n+        if (getHostId() != null) {\n+            destinationHost = _resourceService.getHost(getHostId());\n+            if (destinationHost == null) {\n+                throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n+            }\n+            if (destinationHost.getType() != Host.Type.Routing) {\n+                throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n+            }\n+            CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n+        }\n+\n+        // OfflineMigration performed when this parameter is specified\n+        StoragePool destStoragePool = null;\n+        if (getStorageId() != null) {\n+            destStoragePool = _storageService.getStoragePool(getStorageId());\n+            if (destStoragePool == null) {\n+                throw new InvalidParameterValueException(\"Unable to find the storage pool to migrate the VM\");\n+            }\n+            CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to storage pool Id: \" + getStorageId());\n         }\n         try {\n-            CallContext.current().setEventDetails(\"VM Id: \" + this._uuidMgr.getUuid(VirtualMachine.class, getVirtualMachineId()) + \" to host Id: \" + this._uuidMgr.getUuid(Host.class, getHostId()));\n             //FIXME : Should not be calling UserVmService to migrate all types of VMs - need a generic VM layer\n-            VirtualMachine migratedVm = _userVmService.migrateVirtualMachine(getVirtualMachineId(), destinationHost);\n+            VirtualMachine migratedVm = null;\n+            if (getHostId() != null) {\n+                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());\n+            } else if (getStorageId() != null) {\n+                migratedVm = _userVmService.vmStorageMigration(getVirtualMachineId(), destStoragePool);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "099d170d6c4202211ab55dcf8b091e8bb50973c2"}, "originalPosition": 105}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a204e31f8947ecfa45ca4435a697deccee31f350", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/a204e31f8947ecfa45ca4435a697deccee31f350", "committedDate": "2021-01-27T12:33:50Z", "message": " refactor\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a03a7cac91779a325ad64b1f16a38dfbfdd74be", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/6a03a7cac91779a325ad64b1f16a38dfbfdd74be", "committedDate": "2021-02-01T07:12:51Z", "message": "add missing file\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f4fc907675549f1bdb95f886cb155937e80131a", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/9f4fc907675549f1bdb95f886cb155937e80131a", "committedDate": "2021-02-03T06:09:36Z", "message": "Merge branch 'master' into vmware-migration-improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e73fa081464beefa2cf967bc60ecb6c519774e5d", "author": {"user": {"login": "shwstppr", "name": "Abhishek Kumar"}}, "url": "https://github.com/apache/cloudstack/commit/e73fa081464beefa2cf967bc60ecb6c519774e5d", "committedDate": "2021-02-03T06:12:24Z", "message": "remove tag matching for user provided mappings\n\nThis is inline with master branch behaviour where tag matching is not done for volumes's disk offering and storage pool tags.\n\nSigned-off-by: Abhishek Kumar <abhishek.mrt22@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTg2NDczOTUw", "url": "https://github.com/apache/cloudstack/pull/4385#pullrequestreview-586473950", "createdAt": "2021-02-09T12:05:53Z", "commit": {"oid": "e73fa081464beefa2cf967bc60ecb6c519774e5d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTg5MjEzMzYz", "url": "https://github.com/apache/cloudstack/pull/4385#pullrequestreview-589213363", "createdAt": "2021-02-12T07:11:09Z", "commit": {"oid": "e73fa081464beefa2cf967bc60ecb6c519774e5d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4653, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}