{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0MzYxOTU2", "number": 4522, "title": "template: Ensuring template is cross zone if type changed to system", "bodyText": "Description\nThis PR enhances #3945 by ensuring that all to-be System templates are cross zone\nTypes of changes\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nHow Has This Been Tested?", "createdAt": "2020-12-08T10:47:24Z", "url": "https://github.com/apache/cloudstack/pull/4522", "merged": true, "mergeCommit": {"oid": "2f78b8867fe4167a5ce562afb6485054abab29c1"}, "closed": true, "closedAt": "2020-12-14T08:59:41Z", "author": {"login": "davidjumani"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkJMcngFqTU0NzE4MTkwOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmBa0EgFqTU1MTEzNDA0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MTgxOTA4", "url": "https://github.com/apache/cloudstack/pull/4522#pullrequestreview-547181908", "createdAt": "2020-12-08T12:21:14Z", "commit": {"oid": "665e951af007023537436ca53354371de9489fb0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMjoyMToxNVrOIBXi_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxMjoyMToxNVrOIBXi_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMwNTI3OQ==", "bodyText": "is a good check but i'd like to see it in a separate method.", "url": "https://github.com/apache/cloudstack/pull/4522#discussion_r538305279", "createdAt": "2020-12-08T12:21:15Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/template/TemplateManagerImpl.java", "diffHunk": "@@ -2198,6 +2202,21 @@ private VMTemplateVO updateTemplateOrIso(BaseUpdateTemplateOrIsoCmd cmd) {\n             template.setDynamicallyScalable(isDynamicallyScalable);\n         }\n \n+        if (templateType != null && templateType == TemplateType.SYSTEM) {\n+            s_logger.info(\"Copying template to all zones since it will be a system template\");\n+            List<DataCenterVO> zones = _dcDao.listEnabledZones();\n+            if (zones != null) {\n+                List<Long> zoneIds = zones.stream().map(zone -> zone.getId()).collect(Collectors.toList());\n+                try {\n+                    copyTemplate(id, null, zoneIds);\n+                } catch (StorageUnavailableException e) {\n+                    throw new CloudRuntimeException(\"Unable to copy template to other zones : \", e);\n+                } catch (ResourceAllocationException e) {\n+                    throw new CloudRuntimeException(\"Unable to copy template to other zones : \", e);\n+                }\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "665e951af007023537436ca53354371de9489fb0"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MTg3OTMy", "url": "https://github.com/apache/cloudstack/pull/4522#pullrequestreview-547187932", "createdAt": "2020-12-08T12:30:09Z", "commit": {"oid": "665e951af007023537436ca53354371de9489fb0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "665e951af007023537436ca53354371de9489fb0", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/665e951af007023537436ca53354371de9489fb0", "committedDate": "2020-12-08T10:46:07Z", "message": "template: Copying templates to all zones if type changed to system"}, "afterCommit": {"oid": "c59d0c82137f2294c67d4dd77dd1f4a69b2edb09", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/c59d0c82137f2294c67d4dd77dd1f4a69b2edb09", "committedDate": "2020-12-08T13:21:07Z", "message": "template: Copying templates to all zones if type changed to system"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MzA3OTMy", "url": "https://github.com/apache/cloudstack/pull/4522#pullrequestreview-547307932", "createdAt": "2020-12-08T14:51:18Z", "commit": {"oid": "c59d0c82137f2294c67d4dd77dd1f4a69b2edb09"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNDo1MToxOFrOIBg1_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNDo1MToxOFrOIBg1_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQ1NzU5OA==", "bodyText": "Should we skip the zone on which the template is already in?", "url": "https://github.com/apache/cloudstack/pull/4522#discussion_r538457598", "createdAt": "2020-12-08T14:51:18Z", "author": {"login": "ravening"}, "path": "server/src/main/java/com/cloud/template/TemplateManagerImpl.java", "diffHunk": "@@ -2224,6 +2232,21 @@ else if (details != null && !details.isEmpty()) {\n         return _tmpltDao.findById(id);\n     }\n \n+    private void copyTemplateToAllZones(Long id) {\n+        s_logger.info(\"Copying template to all zones since it will be a system template\");\n+        List<DataCenterVO> zones = _dcDao.listEnabledZones();\n+        if (zones != null) {\n+            List<Long> zoneIds = zones.stream().map(zone -> zone.getId()).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c59d0c82137f2294c67d4dd77dd1f4a69b2edb09"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MzA4MTM3", "url": "https://github.com/apache/cloudstack/pull/4522#pullrequestreview-547308137", "createdAt": "2020-12-08T14:51:32Z", "commit": {"oid": "c59d0c82137f2294c67d4dd77dd1f4a69b2edb09"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNDo1MTozMlrOIBg27w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNDo1MTozMlrOIBg27w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQ1NzgzOQ==", "bodyText": "Better to display the template name?", "url": "https://github.com/apache/cloudstack/pull/4522#discussion_r538457839", "createdAt": "2020-12-08T14:51:32Z", "author": {"login": "ravening"}, "path": "server/src/main/java/com/cloud/template/TemplateManagerImpl.java", "diffHunk": "@@ -2224,6 +2232,21 @@ else if (details != null && !details.isEmpty()) {\n         return _tmpltDao.findById(id);\n     }\n \n+    private void copyTemplateToAllZones(Long id) {\n+        s_logger.info(\"Copying template to all zones since it will be a system template\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c59d0c82137f2294c67d4dd77dd1f4a69b2edb09"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MzA5MTgx", "url": "https://github.com/apache/cloudstack/pull/4522#pullrequestreview-547309181", "createdAt": "2020-12-08T14:52:34Z", "commit": {"oid": "c59d0c82137f2294c67d4dd77dd1f4a69b2edb09"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNDo1MjozNFrOIBg7Wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNDo1MjozNFrOIBg7Wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQ1ODk3MA==", "bodyText": "Extract the message to string?", "url": "https://github.com/apache/cloudstack/pull/4522#discussion_r538458970", "createdAt": "2020-12-08T14:52:34Z", "author": {"login": "ravening"}, "path": "server/src/main/java/com/cloud/template/TemplateManagerImpl.java", "diffHunk": "@@ -2224,6 +2232,21 @@ else if (details != null && !details.isEmpty()) {\n         return _tmpltDao.findById(id);\n     }\n \n+    private void copyTemplateToAllZones(Long id) {\n+        s_logger.info(\"Copying template to all zones since it will be a system template\");\n+        List<DataCenterVO> zones = _dcDao.listEnabledZones();\n+        if (zones != null) {\n+            List<Long> zoneIds = zones.stream().map(zone -> zone.getId()).collect(Collectors.toList());\n+            try {\n+                copyTemplate(id, null, zoneIds);\n+            } catch (StorageUnavailableException e) {\n+                throw new CloudRuntimeException(\"Unable to copy template to other zones : \", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c59d0c82137f2294c67d4dd77dd1f4a69b2edb09"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MzY0Mzg1", "url": "https://github.com/apache/cloudstack/pull/4522#pullrequestreview-547364385", "createdAt": "2020-12-08T15:47:10Z", "commit": {"oid": "c59d0c82137f2294c67d4dd77dd1f4a69b2edb09"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNTo0NzoxMFrOIBkpYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNTo0NzoxMFrOIBkpYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODUxOTkwNA==", "bodyText": "@davidjumani should the template be changed to cross-zone when it is done ?", "url": "https://github.com/apache/cloudstack/pull/4522#discussion_r538519904", "createdAt": "2020-12-08T15:47:10Z", "author": {"login": "weizhouapache"}, "path": "server/src/main/java/com/cloud/template/TemplateManagerImpl.java", "diffHunk": "@@ -2198,6 +2202,10 @@ private VMTemplateVO updateTemplateOrIso(BaseUpdateTemplateOrIsoCmd cmd) {\n             template.setDynamicallyScalable(isDynamicallyScalable);\n         }\n \n+        if (templateType != null && templateType == TemplateType.SYSTEM) {\n+            copyTemplateToAllZones(id);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c59d0c82137f2294c67d4dd77dd1f4a69b2edb09"}, "originalPosition": 36}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b2f14fbc5bb2d1231ccfd1d61512e4ca504807a0", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/b2f14fbc5bb2d1231ccfd1d61512e4ca504807a0", "committedDate": "2020-12-09T05:57:39Z", "message": "Adding crosszone check for system templates"}, "afterCommit": {"oid": "23f16da6caf8b2d4183a6d3044928ee6061e8bf9", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/23f16da6caf8b2d4183a6d3044928ee6061e8bf9", "committedDate": "2020-12-09T06:00:04Z", "message": "Adding crosszone check for system templates"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "23f16da6caf8b2d4183a6d3044928ee6061e8bf9", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/23f16da6caf8b2d4183a6d3044928ee6061e8bf9", "committedDate": "2020-12-09T06:00:04Z", "message": "Adding crosszone check for system templates"}, "afterCommit": {"oid": "022a47608c14c8bdb583e0a2754a2408e802f56b", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/022a47608c14c8bdb583e0a2754a2408e802f56b", "committedDate": "2020-12-09T06:04:32Z", "message": "template: Ensuring template is cross zone if type changed to system"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "022a47608c14c8bdb583e0a2754a2408e802f56b", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/022a47608c14c8bdb583e0a2754a2408e802f56b", "committedDate": "2020-12-09T06:04:32Z", "message": "template: Ensuring template is cross zone if type changed to system"}, "afterCommit": {"oid": "ab2f68cfb909cf8f605b3fc494131bdcb85495ec", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/ab2f68cfb909cf8f605b3fc494131bdcb85495ec", "committedDate": "2020-12-09T06:30:54Z", "message": "template: Ensuring template is cross zone if type changed to system"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3OTc1NTE4", "url": "https://github.com/apache/cloudstack/pull/4522#pullrequestreview-547975518", "createdAt": "2020-12-09T09:11:37Z", "commit": {"oid": "ab2f68cfb909cf8f605b3fc494131bdcb85495ec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwMjIyOTEy", "url": "https://github.com/apache/cloudstack/pull/4522#pullrequestreview-550222912", "createdAt": "2020-12-11T15:55:54Z", "commit": {"oid": "ab2f68cfb909cf8f605b3fc494131bdcb85495ec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNjk4NTU5", "url": "https://github.com/apache/cloudstack/pull/4522#pullrequestreview-550698559", "createdAt": "2020-12-12T07:24:49Z", "commit": {"oid": "ab2f68cfb909cf8f605b3fc494131bdcb85495ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwNzoyNDo0OVrOIEb8HQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwNzoyNDo0OVrOIEb8HQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTUyMjk3Mw==", "bodyText": "why is this changed?", "url": "https://github.com/apache/cloudstack/pull/4522#discussion_r541522973", "createdAt": "2020-12-12T07:24:49Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/com/cloud/template/TemplateManagerImpl.java", "diffHunk": "@@ -2130,7 +2129,7 @@ private VMTemplateVO updateTemplateOrIso(BaseUpdateTemplateOrIsoCmd cmd) {\n             return template;\n         }\n \n-        template = _tmpltDao.createForUpdate(id);\n+        template = _tmpltDao.findById(id);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2f68cfb909cf8f605b3fc494131bdcb85495ec"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNjk4NTcy", "url": "https://github.com/apache/cloudstack/pull/4522#pullrequestreview-550698572", "createdAt": "2020-12-12T07:25:09Z", "commit": {"oid": "ab2f68cfb909cf8f605b3fc494131bdcb85495ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwNzoyNTowOVrOIEb8Pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwNzoyNTowOVrOIEb8Pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTUyMzAwNg==", "bodyText": "Here too?", "url": "https://github.com/apache/cloudstack/pull/4522#discussion_r541523006", "createdAt": "2020-12-12T07:25:09Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/com/cloud/template/TemplateManagerImpl.java", "diffHunk": "@@ -2219,7 +2222,7 @@ else if (details != null && !details.isEmpty()) {\n             _tmpltDao.saveDetails(template);\n         }\n \n-        _tmpltDao.update(id, template);\n+        _tmpltDao.persist(template);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab2f68cfb909cf8f605b3fc494131bdcb85495ec"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bec4e0bf253ba6884a6efde0b4ca03cc25f6b286", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/bec4e0bf253ba6884a6efde0b4ca03cc25f6b286", "committedDate": "2020-12-14T07:00:18Z", "message": "template: Ensuring template is cross zone if type changed to system"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab2f68cfb909cf8f605b3fc494131bdcb85495ec", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/ab2f68cfb909cf8f605b3fc494131bdcb85495ec", "committedDate": "2020-12-09T06:30:54Z", "message": "template: Ensuring template is cross zone if type changed to system"}, "afterCommit": {"oid": "bec4e0bf253ba6884a6efde0b4ca03cc25f6b286", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/bec4e0bf253ba6884a6efde0b4ca03cc25f6b286", "committedDate": "2020-12-14T07:00:18Z", "message": "template: Ensuring template is cross zone if type changed to system"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMTM0MDQy", "url": "https://github.com/apache/cloudstack/pull/4522#pullrequestreview-551134042", "createdAt": "2020-12-14T08:25:33Z", "commit": {"oid": "bec4e0bf253ba6884a6efde0b4ca03cc25f6b286"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4857, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}