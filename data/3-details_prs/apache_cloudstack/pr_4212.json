{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5ODY0ODg5", "number": 4212, "title": "Migrate/Stop VMs with local storage when preparing host for maintenance", "bodyText": "Description\n\nThis PR adds a global settings parameter that configures the strategy for handling VMs in local storage when putting a host in maintenance.\nGlobal settings name:  host.maintenance.local.storage.strategy\nDescription: Defines the strategy towards VMs with volumes on local storage when putting a host in maintenance. The default strategy is 'Error', preventing maintenance in such a case. To migrate away VMs running on local storage choose 'Migrating' strategy. To stop VMs, choose 'Stopping' strategy.\n\n\n\n\n\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nHow Has This Been Tested?\n\n\n\n\nStrategy Error:\n\n\nput a host into maintenance\nMaintenance fails and the host gets into ErrorInMaintenance state\n\n\nStrategy Stopping:\n\n\nput a host into maintenance\nVMs with volumes on shared storage are migrated, VMs in local storage are stopped, the host gets into Maintenance\n\n\nStrategy Migrating:\n\n\nput a host into maintenance\nVMs with volumes on shared and on local storage are migrated, the host gets into Maintenance", "createdAt": "2020-07-16T03:14:37Z", "url": "https://github.com/apache/cloudstack/pull/4212", "merged": true, "mergeCommit": {"oid": "de557663ec2a16a5372f608f01793b83bedfd6f3"}, "closed": true, "closedAt": "2021-04-19T07:41:43Z", "author": {"login": "GabrielBrascher"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1hQHIAFqTQ0OTk4MTMwMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABd_5XY6AH2gAyNDQ5ODY0ODg5OmM0Y2Q2NDQxYmU5YWE5YWMyZmNjYzRlMDNmNDQ0OTZhNDg2MTY3MmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5OTgxMzAz", "url": "https://github.com/apache/cloudstack/pull/4212#pullrequestreview-449981303", "createdAt": "2020-07-16T15:48:31Z", "commit": {"oid": "bdc9bd266f874e879eb61aa1b94be7b240b9b123"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxNTo0ODozMVrOGyxOsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxNTo0ODozMVrOGyxOsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4ODU2Mw==", "bodyText": "Is this debug line still valid?", "url": "https://github.com/apache/cloudstack/pull/4212#discussion_r455888563", "createdAt": "2020-07-16T15:48:31Z", "author": {"login": "wido"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5619,7 +5619,7 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Unsupported Hypervisor Type for User VM migration, we support XenServer/VMware/KVM/Ovm/Hyperv/Ovm3 only\");\n         }\n \n-        if (isVMUsingLocalStorage(vm)) {\n+        if (isVMUsingLocalStorage(vm.getId())) {\n             if (s_logger.isDebugEnabled()) {\n                 s_logger.debug(vm + \" is using Local Storage, cannot migrate this VM.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdc9bd266f874e879eb61aa1b94be7b240b9b123"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MzYxNzk2", "url": "https://github.com/apache/cloudstack/pull/4212#pullrequestreview-457361796", "createdAt": "2020-07-29T09:44:01Z", "commit": {"oid": "bdc9bd266f874e879eb61aa1b94be7b240b9b123"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwOTo0NDowMlrOG4w30w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwOTo0NDowMlrOG4w30w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE3NDE2Mw==", "bodyText": "As for the message, looks like an extra check for the strategy is in order, but the flow might already guarantee it's validity.\nAs for the second interpretation of the question, as a matter of principle it is always good to check the logging level as parameters are always evaluated before passing and you never know how often the code is being executed.\nAs for the level, this is an obvious mis-use of debug. An error or at least warning or info situation is occurring here; the user might expect a migration but there is something impairing it. This is not a message for a developer, hence not a debug level message.\n\nmy \u20ac0,03 ;)", "url": "https://github.com/apache/cloudstack/pull/4212#discussion_r462174163", "createdAt": "2020-07-29T09:44:02Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5619,7 +5619,7 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Unsupported Hypervisor Type for User VM migration, we support XenServer/VMware/KVM/Ovm/Hyperv/Ovm3 only\");\n         }\n \n-        if (isVMUsingLocalStorage(vm)) {\n+        if (isVMUsingLocalStorage(vm.getId())) {\n             if (s_logger.isDebugEnabled()) {\n                 s_logger.debug(vm + \" is using Local Storage, cannot migrate this VM.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4ODU2Mw=="}, "originalCommit": {"oid": "bdc9bd266f874e879eb61aa1b94be7b240b9b123"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NTkyMTgw", "url": "https://github.com/apache/cloudstack/pull/4212#pullrequestreview-498592180", "createdAt": "2020-09-29T15:12:09Z", "commit": {"oid": "3324fac104dbb01926579a12f3e5efe0c95d844e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3OTg0OTg0", "url": "https://github.com/apache/cloudstack/pull/4212#pullrequestreview-527984984", "createdAt": "2020-11-11T09:05:44Z", "commit": {"oid": "3324fac104dbb01926579a12f3e5efe0c95d844e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwOTowNTo0NVrOHxEV2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwOTowNTo0NVrOHxEV2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTIxMzQwMw==", "bodyText": "nit picking: the target host can be specified and small spello\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        s_logger.error(vm + \" is not XenServer/VMware/KVM/Ovm/Hyperv, cannot migrate this VM form hypervisor type \" + vm.getHypervisorType());\n          \n          \n            \n                        s_logger.error(vm + \" is not XenServer/VMware/KVM/Ovm/Hyperv, cannot migrate this VM from hypervisor type \" + vm.getHypervisorType() + \" to hypervisor type \" + destinationHost.getHypervisorType());", "url": "https://github.com/apache/cloudstack/pull/4212#discussion_r521213403", "createdAt": "2020-11-11T09:05:45Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5609,9 +5609,7 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n         }\n \n         if (!isOnSupportedHypevisorForMigration(vm)) {\n-            if (s_logger.isDebugEnabled()) {\n-                s_logger.debug(vm + \" is not XenServer/VMware/KVM/Ovm/Hyperv, cannot migrate this VM form hypervisor type \" + vm.getHypervisorType());\n-            }\n+            s_logger.error(vm + \" is not XenServer/VMware/KVM/Ovm/Hyperv, cannot migrate this VM form hypervisor type \" + vm.getHypervisorType());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3324fac104dbb01926579a12f3e5efe0c95d844e"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3OTg1NzU5", "url": "https://github.com/apache/cloudstack/pull/4212#pullrequestreview-527985759", "createdAt": "2020-11-11T09:06:51Z", "commit": {"oid": "3324fac104dbb01926579a12f3e5efe0c95d844e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "65c876b566f3ebf3fe495082d24effb53b49174a", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/65c876b566f3ebf3fe495082d24effb53b49174a", "committedDate": "2020-11-11T13:48:02Z", "message": "Merge branch 'master' into migrate-local-vms-on-maint"}, "afterCommit": {"oid": "d016a017eda9e9bedc1e97bb1e504f0098564a08", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/d016a017eda9e9bedc1e97bb1e504f0098564a08", "committedDate": "2021-01-18T18:19:07Z", "message": "Code enhancements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcwNzczNzM0", "url": "https://github.com/apache/cloudstack/pull/4212#pullrequestreview-570773734", "createdAt": "2021-01-18T20:56:51Z", "commit": {"oid": "d016a017eda9e9bedc1e97bb1e504f0098564a08"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "072efd85ab5a379692a608b359797ec9139409b7", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/072efd85ab5a379692a608b359797ec9139409b7", "committedDate": "2021-02-22T12:53:45Z", "message": "Add strategy for stopping or migrating VMs with local storage when putting a host in maintenance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6cafb44286a844f1a7861a9f2022806787a12cf", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/f6cafb44286a844f1a7861a9f2022806787a12cf", "committedDate": "2021-02-22T12:53:45Z", "message": "Change log level from debug to error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f98ec6df4ec74062e015bff117fe77e6b920c39e", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/f98ec6df4ec74062e015bff117fe77e6b920c39e", "committedDate": "2021-02-22T12:53:45Z", "message": "Code enhancements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d91473fc251764cfe0d7092d8e97648fa019931a", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/d91473fc251764cfe0d7092d8e97648fa019931a", "committedDate": "2021-02-22T15:32:29Z", "message": "Merge master branch and fix conflicts"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d016a017eda9e9bedc1e97bb1e504f0098564a08", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/d016a017eda9e9bedc1e97bb1e504f0098564a08", "committedDate": "2021-01-18T18:19:07Z", "message": "Code enhancements"}, "afterCommit": {"oid": "d91473fc251764cfe0d7092d8e97648fa019931a", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/d91473fc251764cfe0d7092d8e97648fa019931a", "committedDate": "2021-02-22T15:32:29Z", "message": "Merge master branch and fix conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d12df67aaf7521d05dc8fa5e22366fbd0299fb01", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/d12df67aaf7521d05dc8fa5e22366fbd0299fb01", "committedDate": "2021-02-22T15:37:09Z", "message": "Change from ForceStop to Stop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a5d894489c71dca6da3fab08806c92c90783156", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/7a5d894489c71dca6da3fab08806c92c90783156", "committedDate": "2021-03-01T21:20:32Z", "message": "Add stop vs force-sto options for host.maintenance.local.storage.strategy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d4c802bef677d99860093bd04252f8d27a7b985", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/7d4c802bef677d99860093bd04252f8d27a7b985", "committedDate": "2021-03-03T13:05:44Z", "message": "Stop VM on Host must be of WokType ForceStop, due to host already on PrepareForMaintenance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d644d0f91be4175dcc4b20bca9b64db932062499", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/d644d0f91be4175dcc4b20bca9b64db932062499", "committedDate": "2021-03-03T14:47:35Z", "message": "Enhance log in case of User chooses a non-existing strategy."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45c6d4237ce72c037ebb5f04d10f470e4bbb446c", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/45c6d4237ce72c037ebb5f04d10f470e4bbb446c", "committedDate": "2021-03-03T17:41:37Z", "message": "Set log level to warn if strategy does not exist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f909a54872751f572b47d86ec489a3d3b4fdc337", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/f909a54872751f572b47d86ec489a3d3b4fdc337", "committedDate": "2021-03-04T17:42:31Z", "message": "Set log level to warn if strategy does not exist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4cd6441be9aa9ac2fccc4e03f44496a4861672b", "author": {"user": {"login": "GabrielBrascher", "name": "Gabriel Beims Br\u00e4scher"}}, "url": "https://github.com/apache/cloudstack/commit/c4cd6441be9aa9ac2fccc4e03f44496a4861672b", "committedDate": "2021-03-04T17:44:36Z", "message": "Set log level to error and throw exception if strategy does not exist"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3945, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}