{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3OTE3MzUw", "number": 4374, "title": "Fixing searchAndCount searchAndDistinctCount when sc is null", "bodyText": "Description\nFixes #4372\nEnsures that the count returned by searchAndCount searchAndDistinctCount do not include removed items\nBefore, it would return the count of removed items  as well when the search criteria is null (since sc is created and modified in search which doesn't reflect when it tires to get the count)\nAlso refactored a bit to make life easieer for the next person who comes along\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nHow Has This Been Tested?\nBefore :\n(localcloud) SBCM5> > list roles filter=\n{\n  \"count\": 11,\n  \"role\": [\n    {},\n    {},\n    {},\n    {},\n    {},\n    {},\n    {},\n    {},\n    {}\n  ]\n}\n\nAfter :\n(localcloud) SBCM5> > list roles filter=\n{\n  \"count\": 9,\n  \"role\": [\n    {},\n    {},\n    {},\n    {},\n    {},\n    {},\n    {},\n    {},\n    {}\n  ]\n}", "createdAt": "2020-10-05T14:59:24Z", "url": "https://github.com/apache/cloudstack/pull/4374", "merged": true, "mergeCommit": {"oid": "aab8df09aa9e1e30bb86cc14112d2cb7f715b5e7"}, "closed": true, "closedAt": "2020-10-13T09:30:05Z", "author": {"login": "davidjumani"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPlrl2ABqjM4NDExNDQ4OTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPz-T1gFqTUwMjY5MjkzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b4de2a4b026cfb64ae368bbea6377993df606856", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/b4de2a4b026cfb64ae368bbea6377993df606856", "committedDate": "2020-10-05T14:57:44Z", "message": "Fixing searchAndCount searchAndDistinctCount when sc is null"}, "afterCommit": {"oid": "a430bf6627418f1ded322efb704eab968c276502", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/a430bf6627418f1ded322efb704eab968c276502", "committedDate": "2020-10-05T15:40:00Z", "message": "Fixing searchAndCount searchAndDistinctCount when sc is null"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "120ee250364a4333fe77dad6dedb8297ee12b669", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/120ee250364a4333fe77dad6dedb8297ee12b669", "committedDate": "2020-10-05T15:42:01Z", "message": "Fixing searchAndCount searchAndDistinctCount when sc is null"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a430bf6627418f1ded322efb704eab968c276502", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/a430bf6627418f1ded322efb704eab968c276502", "committedDate": "2020-10-05T15:40:00Z", "message": "Fixing searchAndCount searchAndDistinctCount when sc is null"}, "afterCommit": {"oid": "120ee250364a4333fe77dad6dedb8297ee12b669", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/120ee250364a4333fe77dad6dedb8297ee12b669", "committedDate": "2020-10-05T15:42:01Z", "message": "Fixing searchAndCount searchAndDistinctCount when sc is null"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNjM3NTA2", "url": "https://github.com/apache/cloudstack/pull/4374#pullrequestreview-502637506", "createdAt": "2020-10-06T07:04:26Z", "commit": {"oid": "120ee250364a4333fe77dad6dedb8297ee12b669"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNjQxNzAw", "url": "https://github.com/apache/cloudstack/pull/4374#pullrequestreview-502641700", "createdAt": "2020-10-06T07:11:05Z", "commit": {"oid": "120ee250364a4333fe77dad6dedb8297ee12b669"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwNzoxMTowNVrOHc4vkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwNzoxMTowNVrOHc4vkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1MTg1Nw==", "bodyText": "can use checkAndSetRemovedIsNull() here ?", "url": "https://github.com/apache/cloudstack/pull/4374#discussion_r500051857", "createdAt": "2020-10-06T07:11:05Z", "author": {"login": "sureshanaparti"}, "path": "framework/db/src/main/java/com/cloud/utils/db/GenericDaoBase.java", "diffHunk": "@@ -519,7 +509,6 @@ public T lockOneRandomRow(final SearchCriteria<T> sc, final boolean exclusive) {\n         if (_removed != null) {\n             sc.addAnd(_removed.second().field.getName(), SearchCriteria.Op.NULL);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "120ee250364a4333fe77dad6dedb8297ee12b669"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNjQ4NjU0", "url": "https://github.com/apache/cloudstack/pull/4374#pullrequestreview-502648654", "createdAt": "2020-10-06T07:21:19Z", "commit": {"oid": "120ee250364a4333fe77dad6dedb8297ee12b669"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwNzoyMToyMFrOHc5D0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwNzoyMToyMFrOHc5D0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1NzA0Mw==", "bodyText": "removed & _removed seems to be redundant here & wherever used in similar way, can you directly set / unset _removed as per its usage ? If the purpose is to include / exclude removed records, you can use methods with naming *IncludingRemovedBy() [for ex: getDistinctCountIncludingRemovedBy()] to be in sync with the other methods.", "url": "https://github.com/apache/cloudstack/pull/4374#discussion_r500057043", "createdAt": "2020-10-06T07:21:20Z", "author": {"login": "sureshanaparti"}, "path": "framework/db/src/main/java/com/cloud/utils/db/GenericDaoBase.java", "diffHunk": "@@ -1935,6 +1918,23 @@ public boolean configure(final String name, final Map<String, Object> params) th\n         return builder.create();\n     }\n \n+    private SearchCriteria<T> checkAndSetRemovedIsNull(SearchCriteria<T> sc) {\n+        if (_removed != null) {\n+            if (sc == null) {\n+                sc = createSearchCriteria();\n+            }\n+            sc.addAnd(_removed.second().field.getName(), SearchCriteria.Op.NULL);\n+        }\n+        return sc;\n+    }\n+\n+    public Integer getDistinctCount(SearchCriteria<T> sc, boolean removed) {\n+        if (!removed) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "120ee250364a4333fe77dad6dedb8297ee12b669"}, "originalPosition": 109}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a7be557449cde600067a64a930237d410aab0ce", "author": {"user": {"login": "davidjumani", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/9a7be557449cde600067a64a930237d410aab0ce", "committedDate": "2020-10-06T07:46:56Z", "message": "Adding getCountIncludingRemoved and getDistinctCountIncludingRemoved"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNjkyOTM0", "url": "https://github.com/apache/cloudstack/pull/4374#pullrequestreview-502692934", "createdAt": "2020-10-06T08:19:19Z", "commit": {"oid": "9a7be557449cde600067a64a930237d410aab0ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4943, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}