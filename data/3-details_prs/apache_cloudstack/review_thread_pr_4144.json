{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzMjM4MTc5", "number": 4144, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMDo0OTo0NVrOEJ01Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwOTozNjo1MFrOEfX7gA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NzM4MjY3OnYy", "diffSide": "RIGHT", "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQyMDo0OTo0NVrOGqhsSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxODo1Mjo0MVrOG7tNMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI0NTM4Ng==", "bodyText": "Should we add a more meaningful message here so its more clear?", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r447245386", "createdAt": "2020-06-29T20:49:45Z", "author": {"login": "ravening"}, "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "diffHunk": "@@ -275,7 +277,14 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n             s_logger.error(\"Unhandled exception configuring UsageManger\", e);\n             throw new ConfigurationException(\"Unhandled exception configuring UsageManager \" + e.toString());\n         }\n-        _pid = Integer.parseInt(System.getProperty(\"pid\"));\n+\n+        try {\n+            String processName = ManagementFactory.getRuntimeMXBean().getName();\n+            _pid = Integer.parseInt(processName.split(\"@\")[0]);\n+        } catch (Exception e) {\n+            s_logger.error(\"Unable to get process pid \", e);\n+            throw new ConfigurationException(\"Unable to get process pid \" + e.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3573cbc615ab445d60fb06a0f2d02569f97eafb"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI1OTgyNg==", "bodyText": "I'm all for clarity @ravening . what do you suggest?", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r465259826", "createdAt": "2020-08-04T18:52:41Z", "author": {"login": "DaanHoogland"}, "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "diffHunk": "@@ -275,7 +277,14 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n             s_logger.error(\"Unhandled exception configuring UsageManger\", e);\n             throw new ConfigurationException(\"Unhandled exception configuring UsageManager \" + e.toString());\n         }\n-        _pid = Integer.parseInt(System.getProperty(\"pid\"));\n+\n+        try {\n+            String processName = ManagementFactory.getRuntimeMXBean().getName();\n+            _pid = Integer.parseInt(processName.split(\"@\")[0]);\n+        } catch (Exception e) {\n+            s_logger.error(\"Unable to get process pid \", e);\n+            throw new ConfigurationException(\"Unable to get process pid \" + e.toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI0NTM4Ng=="}, "originalCommit": {"oid": "c3573cbc615ab445d60fb06a0f2d02569f97eafb"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MTk2ODQ2OnYy", "diffSide": "RIGHT", "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDo0MToyM1rOG4QCDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNDo0MToyM1rOG4QCDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYzNjExMA==", "bodyText": "twice the same message should be in a string constand\nrethrown should not abandon the stack trace for the original problem\n\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    try {\n          \n          \n            \n                        String processName = ManagementFactory.getRuntimeMXBean().getName();\n          \n          \n            \n                        _pid = Integer.parseInt(processName.split(\"@\")[0]);\n          \n          \n            \n                    } catch (Exception e) {\n          \n          \n            \n                        s_logger.error(\"Unable to get process pid \", e);\n          \n          \n            \n                        throw new ConfigurationException(\"Unable to get process pid \" + e.toString());\n          \n          \n            \n                    }\n          \n          \n            \n                    String processName;\n          \n          \n            \n                    try {\n          \n          \n            \n                        processName = ManagementFactory.getRuntimeMXBean().getName();\n          \n          \n            \n                        _pid = Integer.parseInt(processName.split(\"@\")[0]);\n          \n          \n            \n                    } catch (Exception e) {\n          \n          \n            \n                        String msg = String.format(\"Unable to get process Id for %s!\", processName);\n          \n          \n            \n                        s_logger.error(msg);\n          \n          \n            \n                        throw new ConfigurationException(msg, e);\n          \n          \n            \n                    }\n          \n      \n    \n    \n  \n\nor\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    try {\n          \n          \n            \n                        String processName = ManagementFactory.getRuntimeMXBean().getName();\n          \n          \n            \n                        _pid = Integer.parseInt(processName.split(\"@\")[0]);\n          \n          \n            \n                    } catch (Exception e) {\n          \n          \n            \n                        s_logger.error(\"Unable to get process pid \", e);\n          \n          \n            \n                        throw new ConfigurationException(\"Unable to get process pid \" + e.toString());\n          \n          \n            \n                    }\n          \n          \n            \n                    String processName;\n          \n          \n            \n                    try {\n          \n          \n            \n                        processName = ManagementFactory.getRuntimeMXBean().getName();\n          \n          \n            \n                        _pid = Integer.parseInt(processName.split(\"@\")[0]);\n          \n          \n            \n                    } catch (Exception e) {\n          \n          \n            \n                        String msg = String.format(\"Unable to get process Id for %s!\", processName);\n          \n          \n            \n                        s_logger.debug(msg , e);\n          \n          \n            \n                        throw new ConfigurationException(msg, e);\n          \n          \n            \n                    }", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r461636110", "createdAt": "2020-07-28T14:41:23Z", "author": {"login": "DaanHoogland"}, "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "diffHunk": "@@ -275,7 +277,14 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n             s_logger.error(\"Unhandled exception configuring UsageManger\", e);\n             throw new ConfigurationException(\"Unhandled exception configuring UsageManager \" + e.toString());\n         }\n-        _pid = Integer.parseInt(System.getProperty(\"pid\"));\n+\n+        try {\n+            String processName = ManagementFactory.getRuntimeMXBean().getName();\n+            _pid = Integer.parseInt(processName.split(\"@\")[0]);\n+        } catch (Exception e) {\n+            s_logger.error(\"Unable to get process pid \", e);\n+            throw new ConfigurationException(\"Unable to get process pid \" + e.toString());\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3573cbc615ab445d60fb06a0f2d02569f97eafb"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwNzA1MTQ4OnYy", "diffSide": "RIGHT", "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwMjo1MDo1M1rOG74Q7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNzoyMDo0N1rOG79Wgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ0MTAwNg==", "bodyText": "@DaanHoogland @div8cn What do you think of using e.printStackTrace() to add the stack on the log/ConfigurationException?\nWith toString (or simply s_logger.debug(msg , e)) it logs only the exception name and the error message (if there is any message). On the other hand, printStackTrace() presents the whole stack trace of an exception, which is very helpful for debugging.", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r465441006", "createdAt": "2020-08-05T02:50:53Z", "author": {"login": "GabrielBrascher"}, "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "diffHunk": "@@ -275,7 +277,16 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n             s_logger.error(\"Unhandled exception configuring UsageManger\", e);\n             throw new ConfigurationException(\"Unhandled exception configuring UsageManager \" + e.toString());\n         }\n-        _pid = Integer.parseInt(System.getProperty(\"pid\"));\n+\n+        String processName = null;\n+        try {\n+            processName = ManagementFactory.getRuntimeMXBean().getName();\n+            _pid = Integer.parseInt(processName.split(\"@\")[0]);\n+        } catch (Exception e) {\n+            String msg = String.format(\"Unable to get process Id for %s!\", processName);\n+            s_logger.debug(msg , e);\n+            throw new ConfigurationException(msg + \" \" + e.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1383d18bc90d7941bc3a534021620764e6082675"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyNDM1NQ==", "bodyText": "logger.debug(msg, e) should log the entire stacktrace @GabrielBrascher . and it gives the user to filter or direct the output to a certain stream/file. e.printStacktrace() only logs to stdout (or stderr, i forgot). in short i think not too much of it. I agree toString does not seem the best, but we have alreadyt output the stacktrace by then. A change from toString() to getLocalizedMessage() maybe, @div8cn? Of course we can add the entire exception again i.e. throw new ConfigurationException(msg, e), that's fine as well.", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r465524355", "createdAt": "2020-08-05T07:20:47Z", "author": {"login": "DaanHoogland"}, "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "diffHunk": "@@ -275,7 +277,16 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n             s_logger.error(\"Unhandled exception configuring UsageManger\", e);\n             throw new ConfigurationException(\"Unhandled exception configuring UsageManager \" + e.toString());\n         }\n-        _pid = Integer.parseInt(System.getProperty(\"pid\"));\n+\n+        String processName = null;\n+        try {\n+            processName = ManagementFactory.getRuntimeMXBean().getName();\n+            _pid = Integer.parseInt(processName.split(\"@\")[0]);\n+        } catch (Exception e) {\n+            String msg = String.format(\"Unable to get process Id for %s!\", processName);\n+            s_logger.debug(msg , e);\n+            throw new ConfigurationException(msg + \" \" + e.toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ0MTAwNg=="}, "originalCommit": {"oid": "1383d18bc90d7941bc3a534021620764e6082675"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAwNzI0NzUzOnYy", "diffSide": "RIGHT", "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwODoxOTozOVrOHKrXrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwODoxOTozOVrOHKrXrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk1ODM4MQ==", "bodyText": "@div8cn master is on java 11 now, can you use ProcessHandle.current().pid()? I did a quick test:\n> jshell \n|  Welcome to JShell -- Version 11.0.7\n|  For an introduction type: /help intro\n\njshell> ProcessHandle.current().pid()\n$1 ==> 20380", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r480958381", "createdAt": "2020-09-01T08:19:39Z", "author": {"login": "rhtyd"}, "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "diffHunk": "@@ -275,7 +277,16 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n             s_logger.error(\"Unhandled exception configuring UsageManger\", e);\n             throw new ConfigurationException(\"Unhandled exception configuring UsageManager \" + e.toString());\n         }\n-        _pid = Integer.parseInt(System.getProperty(\"pid\"));\n+\n+        String processName = null;\n+        try {\n+            processName = ManagementFactory.getRuntimeMXBean().getName();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1383d18bc90d7941bc3a534021620764e6082675"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMzEyNzUxOnYy", "diffSide": "RIGHT", "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODo1MTozNVrOHLlGxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODo1MTozNVrOHLlGxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwNDMyNg==", "bodyText": "processName is always null .", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r481904326", "createdAt": "2020-09-02T08:51:35Z", "author": {"login": "weizhouapache"}, "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "diffHunk": "@@ -280,8 +278,7 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n \n         String processName = null;\n         try {\n-            processName = ManagementFactory.getRuntimeMXBean().getName();\n-            _pid = Integer.parseInt(processName.split(\"@\")[0]);\n+            _pid = (int) ProcessHandle.current().pid();\n         } catch (Exception e) {\n             String msg = String.format(\"Unable to get process Id for %s!\", processName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469652aaccc55cc165bb50a5eaffef446183be70"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMzMzMzc2OnYy", "diffSide": "RIGHT", "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwOTozNjo1MFrOHLnIWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwOTozNjo1MFrOHLnIWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkzNzQ5OA==", "bodyText": "processName is not used and can be removed @div8cn", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r481937498", "createdAt": "2020-09-02T09:36:50Z", "author": {"login": "rhtyd"}, "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "diffHunk": "@@ -275,7 +275,15 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n             s_logger.error(\"Unhandled exception configuring UsageManger\", e);\n             throw new ConfigurationException(\"Unhandled exception configuring UsageManager \" + e.toString());\n         }\n-        _pid = Integer.parseInt(System.getProperty(\"pid\"));\n+\n+        String processName = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "469652aaccc55cc165bb50a5eaffef446183be70"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3930, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}