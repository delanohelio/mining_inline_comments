{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1Nzk4Mjgy", "number": 4497, "title": "kvm: FIX cpucorespersocket is not working on KVM", "bodyText": "Description\nThis PR fixes the issue that cpu.corespersocket in vm details is not working on kvm.\n\n\n\n\n\n\n\n\n\n\nTypes of changes\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nFeature/Enhancement Scale or Bug Severity\nFeature/Enhancement Scale\n\n Major\n Minor\n\nBug Severity\n\n BLOCKER\n Critical\n Major\n Minor\n Trivial\n\nScreenshots (if appropriate):\nHow Has This Been Tested?", "createdAt": "2020-11-23T15:11:50Z", "url": "https://github.com/apache/cloudstack/pull/4497", "merged": true, "mergeCommit": {"oid": "93f3d352071be326ab3b810e23da7c27a948aedd"}, "closed": true, "closedAt": "2020-12-09T14:07:52Z", "author": {"login": "ustcweizhou"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfWoPQgH2gAyNTI1Nzk4MjgyOjFjNmM0NzQ2MDgzODQzMzNkYTQxZjAzZTBmYjEyN2Y1Y2IwZDgzYjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkdTHTAFqTU0ODEwMjE1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1c6c474608384333da41f03e0fb127f5cb0d83b5", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/1c6c474608384333da41f03e0fb127f5cb0d83b5", "committedDate": "2020-11-23T15:10:45Z", "message": "kvm: FIX cpucorespersocket is not working on KVM"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2009802b1c58b979f0374479cde9806aa6f4db9", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/f2009802b1c58b979f0374479cde9806aa6f4db9", "committedDate": "2020-11-23T15:25:17Z", "message": "Add method setCpuTopology"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5Mjg5Mzg2", "url": "https://github.com/apache/cloudstack/pull/4497#pullrequestreview-539289386", "createdAt": "2020-11-26T12:53:46Z", "commit": {"oid": "f2009802b1c58b979f0374479cde9806aa6f4db9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMjo1Mzo0NlrOH6aPsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMjo1Mzo0NlrOH6aPsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAwOTQ1OA==", "bodyText": "when vcpus are 8, it is considered as 4 cores per socket here, instead 8 cores.", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r531009458", "createdAt": "2020-11-26T12:53:46Z", "author": {"login": "sureshanaparti"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -4230,4 +4223,26 @@ public boolean isSecureMode(String bootMode) {\n \n         return false;\n     }\n+\n+    private void setCpuTopology(CpuModeDef cmd, int vcpus, Map<String, String> details) {\n+        // multi cores per socket, for larger core configs\n+        int numCoresPerSocket = -1;\n+        if (details != null) {\n+            final String coresPerSocket = details.get(VmDetailConstants.CPU_CORE_PER_SOCKET);\n+            final int intCoresPerSocket = NumbersUtil.parseInt(coresPerSocket, numCoresPerSocket);\n+            if (intCoresPerSocket > 0 && vcpus % intCoresPerSocket == 0) {\n+                numCoresPerSocket = intCoresPerSocket;\n+            }\n+        }\n+        if (numCoresPerSocket <= 0) {\n+            if (vcpus % 6 == 0) {\n+                numCoresPerSocket = 6;\n+            } else if (vcpus % 4 == 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2009802b1c58b979f0374479cde9806aa6f4db9"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2ODY5NzM1", "url": "https://github.com/apache/cloudstack/pull/4497#pullrequestreview-546869735", "createdAt": "2020-12-08T08:48:20Z", "commit": {"oid": "f2009802b1c58b979f0374479cde9806aa6f4db9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3ODk3NTY4", "url": "https://github.com/apache/cloudstack/pull/4497#pullrequestreview-547897568", "createdAt": "2020-12-09T07:18:56Z", "commit": {"oid": "f2009802b1c58b979f0374479cde9806aa6f4db9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwNzoxODo1NlrOICF3qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwNzoxODo1NlrOICF3qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA2NDIzNQ==", "bodyText": "@ustcweizhou possible to pass coresPerSocket here, instead complete VM details here ?", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r539064235", "createdAt": "2020-12-09T07:18:56Z", "author": {"login": "sureshanaparti"}, "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -4230,4 +4223,26 @@ public boolean isSecureMode(String bootMode) {\n \n         return false;\n     }\n+\n+    private void setCpuTopology(CpuModeDef cmd, int vcpus, Map<String, String> details) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2009802b1c58b979f0374479cde9806aa6f4db9"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MTAyMTU2", "url": "https://github.com/apache/cloudstack/pull/4497#pullrequestreview-548102156", "createdAt": "2020-12-09T11:46:38Z", "commit": {"oid": "f2009802b1c58b979f0374479cde9806aa6f4db9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4833, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}