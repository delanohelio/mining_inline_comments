{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2NjEwMTI0", "number": 3894, "title": "api: Fix count and item issues returned by list APIs", "bodyText": "Description\nThe count value returned in the APIs responses is incorrect\nAllow listing of all resources for non-user accounts when listall=true and projectid=-1\nlistInfrastructure API to return count of internal LBs and Alerts in addition to the existing details returned\nAddresses: #3890\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)", "createdAt": "2020-02-18T13:12:42Z", "url": "https://github.com/apache/cloudstack/pull/3894", "merged": true, "mergeCommit": {"oid": "4d8a2da133b74f2de9ecc599eebafdfc68e6fa60"}, "closed": true, "closedAt": "2020-02-26T15:14:23Z", "author": {"login": "Pearl1594"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFiusugFqTM2MDM3NjgzMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHukf1gH2gAyMzc2NjEwMTI0OmUzOGIwODdmZjBiMWNhOGQ0YTNiOGE0ZTkyYjM0Y2JkMGQwNWQ2YWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMzc2ODMz", "url": "https://github.com/apache/cloudstack/pull/3894#pullrequestreview-360376833", "createdAt": "2020-02-18T14:23:28Z", "commit": {"oid": "b33e8904c373e6ad7916c37997a5063789a5d689"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDoyMzoyOFrOFrENdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDoyMzoyOFrOFrENdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcwMjA3MQ==", "bodyText": "@Pearl1594 calling listAll() i.e. getting all the rows will make the APIs slow in a large env; this is fine but can you explore a way to simply get the count (instead of the rows).", "url": "https://github.com/apache/cloudstack/pull/3894#discussion_r380702071", "createdAt": "2020-02-18T14:23:28Z", "author": {"login": "rhtyd"}, "path": "plugins/metrics/src/main/java/org/apache/cloudstack/metrics/MetricsServiceImpl.java", "diffHunk": "@@ -140,7 +145,9 @@ public InfrastructureResponse listInfrastructure() {\n         response.setStoragePools(storagePoolDao.listAll().size());\n         response.setImageStores(imageStoreDao.listImageStores().size());\n         response.setSystemvms(vmInstanceDao.listByTypes(VirtualMachine.Type.ConsoleProxy, VirtualMachine.Type.SecondaryStorageVm).size());\n-        response.setRouters(domainRouterDao.listAll().size());\n+        response.setRouters(domainRouterDao.listByRole(VirtualRouter.Role.VIRTUAL_ROUTER).size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b33e8904c373e6ad7916c37997a5063789a5d689"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMzc3MTQ1", "url": "https://github.com/apache/cloudstack/pull/3894#pullrequestreview-360377145", "createdAt": "2020-02-18T14:23:51Z", "commit": {"oid": "b33e8904c373e6ad7916c37997a5063789a5d689"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDoyMzo1MVrOFrEOfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDoyMzo1MVrOFrEOfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcwMjMzMw==", "bodyText": "Same as above ^^ if it may be done quickly.", "url": "https://github.com/apache/cloudstack/pull/3894#discussion_r380702333", "createdAt": "2020-02-18T14:23:51Z", "author": {"login": "rhtyd"}, "path": "plugins/metrics/src/main/java/org/apache/cloudstack/metrics/MetricsServiceImpl.java", "diffHunk": "@@ -140,7 +145,9 @@ public InfrastructureResponse listInfrastructure() {\n         response.setStoragePools(storagePoolDao.listAll().size());\n         response.setImageStores(imageStoreDao.listImageStores().size());\n         response.setSystemvms(vmInstanceDao.listByTypes(VirtualMachine.Type.ConsoleProxy, VirtualMachine.Type.SecondaryStorageVm).size());\n-        response.setRouters(domainRouterDao.listAll().size());\n+        response.setRouters(domainRouterDao.listByRole(VirtualRouter.Role.VIRTUAL_ROUTER).size());\n+        response.setInternalLbs(domainRouterDao.listByRole(VirtualRouter.Role.INTERNAL_LB_VM).size());\n+        response.setAlerts(alertDao.listAll().size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b33e8904c373e6ad7916c37997a5063789a5d689"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMzc5ODQ1", "url": "https://github.com/apache/cloudstack/pull/3894#pullrequestreview-360379845", "createdAt": "2020-02-18T14:27:03Z", "commit": {"oid": "7b26d94a88bf736c93233562f7149ed15d3d8c2d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMzk3MzQ0", "url": "https://github.com/apache/cloudstack/pull/3894#pullrequestreview-360397344", "createdAt": "2020-02-18T14:47:57Z", "commit": {"oid": "7b26d94a88bf736c93233562f7149ed15d3d8c2d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDo0Nzo1N1rOFrFK9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDo0Nzo1N1rOFrFK9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcxNzgxMg==", "bodyText": "@Pearl1594 can you share why you add the method searchForServersExcluding ?\nsource host is removed in line\nallHosts.remove(srcHost);", "url": "https://github.com/apache/cloudstack/pull/3894#discussion_r380717812", "createdAt": "2020-02-18T14:47:57Z", "author": {"login": "weizhouapache"}, "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -1248,7 +1248,7 @@ private HypervisorType getHypervisorType(VMInstanceVO vm, StoragePool srcVolumeP\n         final Map<Host, Boolean> requiresStorageMotion = new HashMap<Host, Boolean>();\n         DataCenterDeployment plan = null;\n         if (canMigrateWithStorage) {\n-            allHostsPair = searchForServers(startIndex, pageSize, null, hostType, null, srcHost.getDataCenterId(), null, null, null, keyword, null, null, srcHost.getHypervisorType(),\n+            allHostsPair = searchForServersExcluding(startIndex, pageSize, null, hostType, null, srcHost.getDataCenterId(), null, null, srcHostId, keyword, null, null, srcHost.getHypervisorType(),\n                     srcHost.getHypervisorVersion());\n             allHosts = allHostsPair.first();\n             allHosts.remove(srcHost);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b26d94a88bf736c93233562f7149ed15d3d8c2d"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNDc4MTA4", "url": "https://github.com/apache/cloudstack/pull/3894#pullrequestreview-360478108", "createdAt": "2020-02-18T16:19:44Z", "commit": {"oid": "7b26d94a88bf736c93233562f7149ed15d3d8c2d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNjoxOTo0NFrOFrJA5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNjoxOTo0NFrOFrJA5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc4MDc3NQ==", "bodyText": "@Pearl1594 curb adding newlines", "url": "https://github.com/apache/cloudstack/pull/3894#discussion_r380780775", "createdAt": "2020-02-18T16:19:44Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -1515,6 +1515,89 @@ private boolean hasSuitablePoolsForVolume(final VolumeVO volume, final Host host\n         return suitablePools;\n     }\n \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b26d94a88bf736c93233562f7149ed15d3d8c2d"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNTMxMDE0", "url": "https://github.com/apache/cloudstack/pull/3894#pullrequestreview-360531014", "createdAt": "2020-02-18T17:27:26Z", "commit": {"oid": "8dae31cd73b0c414e30bff567e8504aac8d8287b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwOTI2NTQ2", "url": "https://github.com/apache/cloudstack/pull/3894#pullrequestreview-360926546", "createdAt": "2020-02-19T08:44:42Z", "commit": {"oid": "9d52234517894cc40f29d11abdca98bc0b27b853"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzk4OTQ3", "url": "https://github.com/apache/cloudstack/pull/3894#pullrequestreview-362398947", "createdAt": "2020-02-21T04:54:17Z", "commit": {"oid": "9d52234517894cc40f29d11abdca98bc0b27b853"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNDo1NDoxN1rOFsrqRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNDo1NDoxN1rOFsrqRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM5Njk5Nw==", "bodyText": "@Pearl1594 can you add a check here that listall is true and the user is an admin (not a domain admin, not a user but an admin)", "url": "https://github.com/apache/cloudstack/pull/3894#discussion_r382396997", "createdAt": "2020-02-21T04:54:17Z", "author": {"login": "rhtyd"}, "path": "server/src/main/java/com/cloud/user/AccountManagerImpl.java", "diffHunk": "@@ -2680,6 +2680,9 @@ public void buildACLSearchParameters(Account caller, Long id, String accountName\n                         }\n                     } else {\n                         domainIdRecursiveListProject.third(Project.ListProjectResourcesCriteria.ListProjectResourcesOnly);\n+                        if (listAll) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d52234517894cc40f29d11abdca98bc0b27b853"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDM0NjI3", "url": "https://github.com/apache/cloudstack/pull/3894#pullrequestreview-363034627", "createdAt": "2020-02-22T15:32:29Z", "commit": {"oid": "0538d184e678fbdcb3f7ddfc49c9644e26b6cda1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQxNTozMjozMFrOFtLnJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMlQxNTozMjozMFrOFtLnJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjkyMDQ4Nw==", "bodyText": "@Pearl1594 did you merge master? There are additional changes.", "url": "https://github.com/apache/cloudstack/pull/3894#discussion_r382920487", "createdAt": "2020-02-22T15:32:30Z", "author": {"login": "rhtyd"}, "path": "engine/components-api/src/main/java/com/cloud/agent/AgentManager.java", "diffHunk": "@@ -152,4 +152,6 @@\n     void notifyMonitorsOfHostAboutToBeRemoved(long hostId);\n \n     void notifyMonitorsOfRemovedHost(long hostId, long clusterId);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0538d184e678fbdcb3f7ddfc49c9644e26b6cda1"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f68965b94944fadfc9219181dc2ef7fc3903fd0", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/3f68965b94944fadfc9219181dc2ef7fc3903fd0", "committedDate": "2020-02-23T08:01:12Z", "message": "Fixed count value in the list apis"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54d269a4ccf20b7967823b35896d660e07bb7125", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/54d269a4ccf20b7967823b35896d660e07bb7125", "committedDate": "2020-02-23T08:01:12Z", "message": "Update InfrastructureResponse.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4135bb7b376829220328d8d15043950caaa187ee", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/4135bb7b376829220328d8d15043950caaa187ee", "committedDate": "2020-02-23T08:01:12Z", "message": "partial revert hosts for migration code to exclude srcHost\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec9fbd92fc52cc5d1528e13370f9636303f32fed", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/ec9fbd92fc52cc5d1528e13370f9636303f32fed", "committedDate": "2020-02-23T08:01:12Z", "message": "wip: make get count from db efficient, no need to get all rows; simply get the total count\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c983177d26eb449eaa242a61c53338d4d49c3fe", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/0c983177d26eb449eaa242a61c53338d4d49c3fe", "committedDate": "2020-02-23T08:01:12Z", "message": "fix build\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a73ff27b777a3d9cf720424d777cb2558346aa97", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/a73ff27b777a3d9cf720424d777cb2558346aa97", "committedDate": "2020-02-23T08:01:12Z", "message": "patch to allow listing of all resources including project when projectid=-1 and listall=true for non-user accounts\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c6be1513190e98a0a00e0adcc3373d5c1a46049", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/6c6be1513190e98a0a00e0adcc3373d5c1a46049", "committedDate": "2020-02-23T08:01:12Z", "message": "ui: don't pass both listall=true and projectid=-1\n\nPassing both would return all the resources including those from all projects\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdc0be4d1b31d2cc8456c5b1e83d6ca070167e38", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/fdc0be4d1b31d2cc8456c5b1e83d6ca070167e38", "committedDate": "2020-02-23T08:16:33Z", "message": "return all items only for the root admin\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0538d184e678fbdcb3f7ddfc49c9644e26b6cda1", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/0538d184e678fbdcb3f7ddfc49c9644e26b6cda1", "committedDate": "2020-02-21T18:36:42Z", "message": "handle listAll=true and projectid=-1 to list all networks - project and non-project"}, "afterCommit": {"oid": "2e538b0d83ff83502c6a98a27ea7b0e83ef535af", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/2e538b0d83ff83502c6a98a27ea7b0e83ef535af", "committedDate": "2020-02-23T08:19:32Z", "message": "allow root admin to list all networks\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e538b0d83ff83502c6a98a27ea7b0e83ef535af", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/2e538b0d83ff83502c6a98a27ea7b0e83ef535af", "committedDate": "2020-02-23T08:19:32Z", "message": "allow root admin to list all networks\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>"}, "afterCommit": {"oid": "fdc0be4d1b31d2cc8456c5b1e83d6ca070167e38", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/fdc0be4d1b31d2cc8456c5b1e83d6ca070167e38", "committedDate": "2020-02-23T08:16:33Z", "message": "return all items only for the root admin\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMDg2OTIx", "url": "https://github.com/apache/cloudstack/pull/3894#pullrequestreview-363086921", "createdAt": "2020-02-23T11:08:04Z", "commit": {"oid": "fdc0be4d1b31d2cc8456c5b1e83d6ca070167e38"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e38b087ff0b1ca8d4a3b8a4e92b34cbd0d05d6ad", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/e38b087ff0b1ca8d4a3b8a4e92b34cbd0d05d6ad", "committedDate": "2020-02-25T09:19:03Z", "message": "server: list project resources listing for non-root-admin accounts\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4411, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}