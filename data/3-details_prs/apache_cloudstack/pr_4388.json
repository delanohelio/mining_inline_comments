{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4OTkxNjIw", "number": 4388, "title": "fix NPE in volumes statistics", "bodyText": "Description\nIf volume is migrated between storage pools and \"volume.stats.interval\"\nis set to more frequent interval for example 30 sec.\nNullPointerException is thrown, because the hypervisor is looking for\nvolume on storage pool from which the volume was migrated.\nThe statistics did not work right - before this fix only one cluster is\nlists if we have more clusters from the same type (eg. KVM), and only\none host will return volume stats. Also all volumes are sent to that\nhost, but they could be on another host. And the logic does not work\ncorrectly.\nAlso the response was not working correctly for QCOW2 images, because\nit's looking for volume's UUID, but in the statistics CS keeps the path\n(because of the migrated volumes which UUIDs are changed).\nWe have discussed the NPE with @Spaceman1984 in PR https://github.com/apache/cloudstack/pull/3949\n\nWith this change all clusters will be listed even those with the same type. Host will receive only the active volumes which are on it. And in the logs we will receive a proper information about the volumes\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n[X ] Bug fix (non-breaking change which fixes an issue)\n[ X] Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nHow Has This Been Tested?\nCS versions - 4.14 and master\n2 clusters each having 2 hosts\nhypervisors KVM\n2 NFS primary storages with scope Zone", "createdAt": "2020-10-07T05:36:31Z", "url": "https://github.com/apache/cloudstack/pull/4388", "merged": true, "mergeCommit": {"oid": "8afb451c1c60ec106aeecedafdfb491e3ae16cc8"}, "closed": true, "closedAt": "2020-10-30T15:53:05Z", "author": {"login": "slavkap"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQgvg4gFqTUwNDcyODgxMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXfRsygFqTUyMDM3MzU1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NzI4ODEy", "url": "https://github.com/apache/cloudstack/pull/4388#pullrequestreview-504728812", "createdAt": "2020-10-08T12:28:52Z", "commit": {"oid": "55f084dee293d0899ee0f145d3ccf57acc05e69e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMjoyODo1M1rOHecJeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMjoyODo1M1rOHecJeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4MDUwNg==", "bodyText": "@slavkap what is the impact on volume stats for managed / local storage pool ? can this cause regression?", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r501680506", "createdAt": "2020-10-08T12:28:53Z", "author": {"login": "sureshanaparti"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -1930,18 +1931,13 @@ private boolean upgradeRunningVirtualMachine(Long vmId, Long newServiceOfferingI\n     public HashMap<String, VolumeStatsEntry> getVolumeStatistics(long clusterId, String poolUuid, StoragePoolType poolType, List<String> volumeLocators, int timeout) {\n         List<HostVO> neighbors = _resourceMgr.listHostsInClusterByStatus(clusterId, Status.Up);\n         StoragePoolVO storagePool = _storagePoolDao.findPoolByUUID(poolUuid);\n-        for (HostVO neighbor : neighbors) {\n-            // apply filters:\n-            // - managed storage\n-            // - local storage\n-            if (storagePool.isManaged() || storagePool.isLocal()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55f084dee293d0899ee0f145d3ccf57acc05e69e"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NzI5NzM5", "url": "https://github.com/apache/cloudstack/pull/4388#pullrequestreview-504729739", "createdAt": "2020-10-08T12:29:58Z", "commit": {"oid": "55f084dee293d0899ee0f145d3ccf57acc05e69e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMjoyOTo1OFrOHecMdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMjoyOTo1OFrOHecMdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4MTI3MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (vr.getFormat() == ImageFormat.VHD || vr.getFormat() == ImageFormat.QCOW2){\n          \n          \n            \n                        if (vr.getFormat() == ImageFormat.VHD || vr.getFormat() == ImageFormat.QCOW2) {", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r501681271", "createdAt": "2020-10-08T12:29:58Z", "author": {"login": "sureshanaparti"}, "path": "server/src/main/java/com/cloud/api/query/ViewResponseHelper.java", "diffHunk": "@@ -287,10 +287,7 @@\n             vrDataList.put(vr.getId(), vrData);\n \n             VolumeStats vs = null;\n-            if (vr.getFormat() == ImageFormat.QCOW2) {\n-                vs = ApiDBUtils.getVolumeStatistics(vrData.getId());\n-            }\n-            else if (vr.getFormat() == ImageFormat.VHD){\n+            if (vr.getFormat() == ImageFormat.VHD || vr.getFormat() == ImageFormat.QCOW2){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55f084dee293d0899ee0f145d3ccf57acc05e69e"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NzQ2OTUw", "url": "https://github.com/apache/cloudstack/pull/4388#pullrequestreview-504746950", "createdAt": "2020-10-08T12:51:02Z", "commit": {"oid": "55f084dee293d0899ee0f145d3ccf57acc05e69e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMjo1MTowMlrOHec_gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMjo1MTowMlrOHec_gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY5NDMzOQ==", "bodyText": "@slavkap check if this can cause regression, for listing hypervisors for zone.", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r501694339", "createdAt": "2020-10-08T12:51:02Z", "author": {"login": "sureshanaparti"}, "path": "engine/schema/src/main/java/com/cloud/dc/dao/ClusterDaoImpl.java", "diffHunk": "@@ -81,7 +81,6 @@ public ClusterDaoImpl() {\n \n         ZoneSearch = createSearchBuilder();\n         ZoneSearch.and(\"dataCenterId\", ZoneSearch.entity().getDataCenterId(), SearchCriteria.Op.EQ);\n-        ZoneSearch.groupBy(ZoneSearch.entity().getHypervisorType());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55f084dee293d0899ee0f145d3ccf57acc05e69e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NzU3MTc2", "url": "https://github.com/apache/cloudstack/pull/4388#pullrequestreview-504757176", "createdAt": "2020-10-08T13:02:32Z", "commit": {"oid": "55f084dee293d0899ee0f145d3ccf57acc05e69e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzowMjozMlrOHedcmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzowMjozMlrOHedcmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcwMTc4Ng==", "bodyText": "@slavkap volume path is not the locator for OVA format, update with chain info ?", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r501701786", "createdAt": "2020-10-08T13:02:32Z", "author": {"login": "sureshanaparti"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -1956,16 +1952,16 @@ private boolean upgradeRunningVirtualMachine(Long vmId, Long newServiceOfferingI\n \n             if (answer instanceof GetVolumeStatsAnswer){\n                 GetVolumeStatsAnswer volstats = (GetVolumeStatsAnswer)answer;\n-                return volstats.getVolumeStats();\n+                volumeStatsByUuid.putAll(volstats.getVolumeStats());\n             }\n         }\n-        return null;\n+        return volumeStatsByUuid.size() > 0 ? volumeStatsByUuid : null;\n     }\n \n     private List<String> getVolumesByHost(HostVO host, StoragePool pool){\n-        List<UserVmVO> vmsPerHost = _vmDao.listByHostId(host.getId());\n+        List<VMInstanceVO> vmsPerHost = _vmInstanceDao.listByHostId(host.getId());\n         return vmsPerHost.stream()\n-                .flatMap(vm -> _volsDao.findByInstanceIdAndPoolId(vm.getId(),pool.getId()).stream().map(vol -> vol.getPath()))\n+                .flatMap(vm -> _volsDao.findByInstanceIdAndPoolId(vm.getId(),pool.getId()).stream().map(vol -> vol.getState() == Volume.State.Ready ? vol.getPath() : null).filter(Objects::nonNull))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55f084dee293d0899ee0f145d3ccf57acc05e69e"}, "originalPosition": 91}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "55f084dee293d0899ee0f145d3ccf57acc05e69e", "author": {"user": {"login": "slavkap", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/55f084dee293d0899ee0f145d3ccf57acc05e69e", "committedDate": "2020-10-07T06:14:45Z", "message": "list all virtual machines by host id"}, "afterCommit": {"oid": "e4cb5d697e6c2e800f498a0e56815c8a56f5ae25", "author": {"user": {"login": "slavkap", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/e4cb5d697e6c2e800f498a0e56815c8a56f5ae25", "committedDate": "2020-10-13T10:40:51Z", "message": "Formating the brackets"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e4cb5d697e6c2e800f498a0e56815c8a56f5ae25", "author": {"user": {"login": "slavkap", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/e4cb5d697e6c2e800f498a0e56815c8a56f5ae25", "committedDate": "2020-10-13T10:40:51Z", "message": "Formating the brackets"}, "afterCommit": {"oid": "4fa9f6374cab948217392eec9bbfaecde05ff573", "author": {"user": {"login": "slavkap", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/4fa9f6374cab948217392eec9bbfaecde05ff573", "committedDate": "2020-10-28T12:05:23Z", "message": "Formating the brackets"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5NDEyODA0", "url": "https://github.com/apache/cloudstack/pull/4388#pullrequestreview-519412804", "createdAt": "2020-10-29T08:04:44Z", "commit": {"oid": "4fa9f6374cab948217392eec9bbfaecde05ff573"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwODowNDo0NFrOHqQOmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwODowNDo0NFrOHqQOmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA2ODEyMg==", "bodyText": "@slavkap move this condition check (ScopeType.ZONE.equals(storagePool.getScope()) && storagePool.getHypervisor() != neighbor.getHypervisorType() before getting volume locators.\nand use CollectionUtils for volumeLocators\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if ((ScopeType.ZONE.equals(storagePool.getScope()) && storagePool.getHypervisor() != neighbor.getHypervisorType()) || (volumeLocators == null || volumeLocators.size() == 0)) {\n          \n          \n            \n                        if (CollectionUtils.isEmpty(volumeLocators)) {", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r514068122", "createdAt": "2020-10-29T08:04:44Z", "author": {"login": "sureshanaparti"}, "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -1954,21 +1955,16 @@ private boolean upgradeRunningVirtualMachine(Long vmId, Long newServiceOfferingI\n     }\n \n     @Override\n-    public HashMap<String, VolumeStatsEntry> getVolumeStatistics(long clusterId, String poolUuid, StoragePoolType poolType, List<String> volumeLocators, int timeout) {\n+    public HashMap<String, VolumeStatsEntry> getVolumeStatistics(long clusterId, String poolUuid, StoragePoolType poolType,  int timeout) {\n         List<HostVO> neighbors = _resourceMgr.listHostsInClusterByStatus(clusterId, Status.Up);\n         StoragePoolVO storagePool = _storagePoolDao.findPoolByUUID(poolUuid);\n-        for (HostVO neighbor : neighbors) {\n-            // apply filters:\n-            // - managed storage\n-            // - local storage\n-            if (storagePool.isManaged() || storagePool.isLocal()) {\n+        HashMap<String, VolumeStatsEntry> volumeStatsByUuid = new HashMap<>();\n \n-                volumeLocators = getVolumesByHost(neighbor, storagePool);\n-\n-            }\n+        for (HostVO neighbor : neighbors) {\n+            List<String> volumeLocators = getVolumesByHost(neighbor, storagePool);\n \n             // - zone wide storage for specific hypervisortypes\n-            if (ScopeType.ZONE.equals(storagePool.getScope()) && storagePool.getHypervisor() != neighbor.getHypervisorType()) {\n+            if ((ScopeType.ZONE.equals(storagePool.getScope()) && storagePool.getHypervisor() != neighbor.getHypervisorType()) || (volumeLocators == null || volumeLocators.size() == 0)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fa9f6374cab948217392eec9bbfaecde05ff573"}, "originalPosition": 49}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4fa9f6374cab948217392eec9bbfaecde05ff573", "author": {"user": {"login": "slavkap", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/4fa9f6374cab948217392eec9bbfaecde05ff573", "committedDate": "2020-10-28T12:05:23Z", "message": "Formating the brackets"}, "afterCommit": {"oid": "a77d518b9ec37d46d295506f87aaad073b984dad", "author": {"user": {"login": "slavkap", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/a77d518b9ec37d46d295506f87aaad073b984dad", "committedDate": "2020-10-29T10:26:34Z", "message": "Won't get volumes if the hypervisor type is not the same of the store"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cff272af56d1f1eeeea7023b41f545ddb8e8c497", "author": {"user": {"login": "slavkap", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/cff272af56d1f1eeeea7023b41f545ddb8e8c497", "committedDate": "2020-10-29T12:39:25Z", "message": "fix NPE in volumes statistics\n\nIf volume is migrated between storage pools and \"volume.stats.interval\"\nis set to more frequent interval for exmaple 30 sec.\nNullPointerException is thrown, because the hypervisor is looking for\nvolume on storage pool from which the volume was migrated.\nThe statistics did not work right - before this fix only one cluster is\nlists if we have more clusters from the same type (eg. KVM), and only\none host will return volume stats. Also all volumes are sent to that\nhost, but they could be on another host. And the logic does not work\ncorrectly.\nAlso the response was not working correctly for QCOW2 images, because\nit's looking for volume's uuid, but in the statistics CS keeps the path\n(because of the migrated volumes which UUIDs are changed)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f445dfc0db1dd634f8f9aab7caa6fc0f6f106d4", "author": {"user": {"login": "slavkap", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/2f445dfc0db1dd634f8f9aab7caa6fc0f6f106d4", "committedDate": "2020-10-29T12:39:29Z", "message": "list all virtual machines by host id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03a783734be2f36c24dbb717debfa0fb1a49e772", "author": {"user": {"login": "slavkap", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/03a783734be2f36c24dbb717debfa0fb1a49e772", "committedDate": "2020-10-29T12:39:29Z", "message": "Return groupBy hypervisor type when listing clusters by zone id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a82f4e3705d16fe47c63f2294101d3a007bf360c", "author": {"user": {"login": "slavkap", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/a82f4e3705d16fe47c63f2294101d3a007bf360c", "committedDate": "2020-10-29T12:39:29Z", "message": "Replace listByZoneId in VolumeStatsTask with listClustersByDcId"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c5f5f4dbe3320ab0d5fc72f89b80563e8ac2462", "author": {"user": {"login": "slavkap", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/5c5f5f4dbe3320ab0d5fc72f89b80563e8ac2462", "committedDate": "2020-10-29T12:39:29Z", "message": "Removed unused arg and condition if format is OVA when listing volumes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcb9979f06f412d75f258d6d9d76b1ec8cf711e5", "author": {"user": {"login": "slavkap", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/fcb9979f06f412d75f258d6d9d76b1ec8cf711e5", "committedDate": "2020-10-29T12:39:29Z", "message": "Formating the brackets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5008846187b7ab0bc81b228ee99e1344afa4b7fe", "author": {"user": {"login": "slavkap", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/5008846187b7ab0bc81b228ee99e1344afa4b7fe", "committedDate": "2020-10-29T12:39:29Z", "message": "Won't get volumes if the hypervisor type is not the same of the store"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a77d518b9ec37d46d295506f87aaad073b984dad", "author": {"user": {"login": "slavkap", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/a77d518b9ec37d46d295506f87aaad073b984dad", "committedDate": "2020-10-29T10:26:34Z", "message": "Won't get volumes if the hypervisor type is not the same of the store"}, "afterCommit": {"oid": "5008846187b7ab0bc81b228ee99e1344afa4b7fe", "author": {"user": {"login": "slavkap", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/5008846187b7ab0bc81b228ee99e1344afa4b7fe", "committedDate": "2020-10-29T12:39:29Z", "message": "Won't get volumes if the hypervisor type is not the same of the store"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93214ffe2b83f97601c910c54821d7fda1c985a8", "author": {"user": {"login": "slavkap", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/93214ffe2b83f97601c910c54821d7fda1c985a8", "committedDate": "2020-10-29T19:32:26Z", "message": "Add import for CollectionUtils"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMzczNTUx", "url": "https://github.com/apache/cloudstack/pull/4388#pullrequestreview-520373551", "createdAt": "2020-10-30T04:43:53Z", "commit": {"oid": "93214ffe2b83f97601c910c54821d7fda1c985a8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4666, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}