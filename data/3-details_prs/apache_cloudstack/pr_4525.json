{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0OTg5OTg0", "number": 4525, "title": "xenserver: check and eject patch vbd for systemvms", "bodyText": "This failed to destroy systemvms patch VBDs that attaches systemvm.iso\non host setup (ready). This will ensure for upgrades old systemvm.iso\nfiles are not cached/used.\nXenServer has an file descriptor/tapdisk iso-caching issue where new systemvm.iso are not recognised and inside the VR/ssvm/cpvm file IO error is seen. This was only reproducible with XS7.1, the fix was to check and eject the systemvm.iso (old/stale/cached), then insert the new systemvm.iso and then eject it \ud83e\udd26\n\nTypes of changes\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nFeature/Enhancement Scale or Bug Severity\nFeature/Enhancement Scale\n\n Major\n Minor\n\nBug Severity\n\n BLOCKER\n Critical\n Major\n Minor\n Trivial", "createdAt": "2020-12-09T08:02:55Z", "url": "https://github.com/apache/cloudstack/pull/4525", "merged": true, "mergeCommit": {"oid": "e0242d5793bb901bf7042627be7d8fdc6790b89d"}, "closed": true, "closedAt": "2020-12-09T19:12:42Z", "author": {"login": "rhtyd"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkaEAagH2gAyNTM0OTg5OTg0OmQ5NjJlNTY5NTg5ZDg1MjI4ZWM0YTU5MWUwMTUxNzNjMGFlMjI3ODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkggiwgFqTU0ODMwNTEwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d962e569589d85228ec4a591e015173c0ae22784", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/d962e569589d85228ec4a591e015173c0ae22784", "committedDate": "2020-12-09T08:00:25Z", "message": "xenserver: check and eject patch vbd for systemvms\n\nThis failed to destroy systemvms patch VBDs that attaches systemvm.iso\non host setup (ready). This will ensure for upgrades old systemvm.iso\nfiles are not cached/used.\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cb9b300ad19408be9d6a50f96d86b864f9880a1", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/6cb9b300ad19408be9d6a50f96d86b864f9880a1", "committedDate": "2020-12-09T08:11:41Z", "message": "try to unplug before destroying\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3OTQwNzYz", "url": "https://github.com/apache/cloudstack/pull/4525#pullrequestreview-547940763", "createdAt": "2020-12-09T08:26:55Z", "commit": {"oid": "6cb9b300ad19408be9d6a50f96d86b864f9880a1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwODoyNjo1NVrOICINFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwODoyNjo1NVrOICINFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEwMjQ4Nw==", "bodyText": "@rhtyd Makes sense to eject only when ISO is inserted. Verified that this is being handled in all cases before ejecting vdb, except here.", "url": "https://github.com/apache/cloudstack/pull/4525#discussion_r539102487", "createdAt": "2020-12-09T08:26:55Z", "author": {"login": "sureshanaparti"}, "path": "plugins/hypervisors/xenserver/src/main/java/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java", "diffHunk": "@@ -1499,7 +1499,10 @@ public void destroyPatchVbd(final Connection conn, final String vmName) throws X\n                 final Set<VBD> vbds = vm.getVBDs(conn);\n                 for (final VBD vbd : vbds) {\n                     if (vbd.getType(conn) == Types.VbdType.CD) {\n-                        vbd.eject(conn);\n+                        if (!vbd.getEmpty(conn)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cb9b300ad19408be9d6a50f96d86b864f9880a1"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3OTQwOTM1", "url": "https://github.com/apache/cloudstack/pull/4525#pullrequestreview-547940935", "createdAt": "2020-12-09T08:27:09Z", "commit": {"oid": "6cb9b300ad19408be9d6a50f96d86b864f9880a1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f8615f8fdd9fa3926cd0f051bc37e6ae9942103", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/8f8615f8fdd9fa3926cd0f051bc37e6ae9942103", "committedDate": "2020-12-09T10:21:58Z", "message": "fix\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2e23fe90f83e9b3eb47568001bb712d967c792a", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/a2e23fe90f83e9b3eb47568001bb712d967c792a", "committedDate": "2020-12-09T11:10:14Z", "message": "workaround fix\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fe57cf25bde54c1793aafee80f2647d78301077", "author": {"user": {"login": "rhtyd", "name": "Rohit Yadav"}}, "url": "https://github.com/apache/cloudstack/commit/7fe57cf25bde54c1793aafee80f2647d78301077", "committedDate": "2020-12-09T11:12:24Z", "message": "add defensive checks\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MDk1NTkz", "url": "https://github.com/apache/cloudstack/pull/4525#pullrequestreview-548095593", "createdAt": "2020-12-09T11:37:27Z", "commit": {"oid": "7fe57cf25bde54c1793aafee80f2647d78301077"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMTozNzoyN1rOICQNdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMTozNzoyN1rOICQNdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzMzY1Mg==", "bodyText": "@sureshanaparti @DaanHoogland @vladimirpetrov this confirms that this is a XS issue, the fix was to eject and then insert the new systemvm.iso and then eject is again \ud83e\udd26", "url": "https://github.com/apache/cloudstack/pull/4525#discussion_r539233652", "createdAt": "2020-12-09T11:37:27Z", "author": {"login": "rhtyd"}, "path": "plugins/hypervisors/xenserver/src/main/java/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java", "diffHunk": "@@ -1489,24 +1502,33 @@ protected String deleteSnapshotBackup(final Connection conn, final Long dcId, fi\n         return result;\n     }\n \n-    public void destroyPatchVbd(final Connection conn, final String vmName) throws XmlRpcException, XenAPIException {\n-        try {\n-            if (!vmName.startsWith(\"r-\") && !vmName.startsWith(\"s-\") && !vmName.startsWith(\"v-\")) {\n-                return;\n-            }\n-            final Set<VM> vms = VM.getByNameLabel(conn, vmName);\n-            for (final VM vm : vms) {\n+    public void destroyPatchVbd(final Connection conn, final Set<VM> vms) throws XmlRpcException, XenAPIException {\n+        final SR sr = findPatchIsoSR(conn);\n+        final VDI patchVDI = findPatchIsoVDI(conn, sr);\n+        for (final VM vm : vms) {\n+            final String vmName = vm.getNameLabel(conn);\n+            try {\n+                if (!vmName.startsWith(\"r-\") && !vmName.startsWith(\"s-\") && !vmName.startsWith(\"v-\")) {\n+                    return;\n+                }\n                 final Set<VBD> vbds = vm.getVBDs(conn);\n                 for (final VBD vbd : vbds) {\n-                    if (vbd.getType(conn) == Types.VbdType.CD) {\n-                        vbd.eject(conn);\n+                    if (Types.VbdType.CD.equals(vbd.getType(conn))) {\n+                        if (!vbd.getEmpty(conn)) {\n+                            vbd.eject(conn);\n+                        }\n+                        // Workaround for any file descriptor caching issue\n+                        if (patchVDI != null) {\n+                            vbd.insert(conn, patchVDI);\n+                            vbd.eject(conn);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fe57cf25bde54c1793aafee80f2647d78301077"}, "originalPosition": 100}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MTYxMTky", "url": "https://github.com/apache/cloudstack/pull/4525#pullrequestreview-548161192", "createdAt": "2020-12-09T13:04:42Z", "commit": {"oid": "8f8615f8fdd9fa3926cd0f051bc37e6ae9942103"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMzowNDo0MlrOICTmZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMzowNDo0MlrOICTmZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI4OTE5MA==", "bodyText": "is thsi a bedug message or maybe error or warn?", "url": "https://github.com/apache/cloudstack/pull/4525#discussion_r539289190", "createdAt": "2020-12-09T13:04:42Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/xenserver/src/main/java/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java", "diffHunk": "@@ -1489,27 +1489,31 @@ protected String deleteSnapshotBackup(final Connection conn, final Long dcId, fi\n         return result;\n     }\n \n-    public void destroyPatchVbd(final Connection conn, final String vmName) throws XmlRpcException, XenAPIException {\n+    public void ejectPatchVbd(final Connection conn, final Host host) {\n+        try {\n+            final Set<VM> vms = host.getResidentVMs(conn);\n+            for (final VM vm : vms) {\n+                destroyPatchVbd(conn, vm);\n+            }\n+        } catch (XenAPIException | XmlRpcException ignored) {}\n+    }\n+\n+    public void destroyPatchVbd(final Connection conn, final VM vm) throws XmlRpcException, XenAPIException {\n+        final String vmName = vm.getNameLabel(conn);\n         try {\n             if (!vmName.startsWith(\"r-\") && !vmName.startsWith(\"s-\") && !vmName.startsWith(\"v-\")) {\n                 return;\n             }\n-            final Set<VM> vms = VM.getByNameLabel(conn, vmName);\n-            for (final VM vm : vms) {\n-                final Set<VBD> vbds = vm.getVBDs(conn);\n-                for (final VBD vbd : vbds) {\n-                    if (vbd.getType(conn) == Types.VbdType.CD) {\n-                        if (!vbd.getEmpty(conn)) {\n-                            vbd.eject(conn);\n-                        }\n-                        vbd.unplug(conn);\n-                        vbd.destroy(conn);\n-                        break;\n-                    }\n+            final Set<VBD> vbds = vm.getVBDs(conn);\n+            for (final VBD vbd : vbds) {\n+                if (Types.VbdType.CD.equals(vbd.getType(conn))) {\n+                    vbd.eject(conn);\n+                    vbd.destroy(conn);\n+                    break;\n                 }\n             }\n         } catch (final Exception e) {\n-            s_logger.debug(\"Cannot destory CD-ROM device for VM \" + vmName + \" due to \" + e.toString(), e);\n+            s_logger.debug(\"Cannot destroy CD-ROM device for VM \" + vmName + \" due to \" + e.toString(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f8615f8fdd9fa3926cd0f051bc37e6ae9942103"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MTYxOTMz", "url": "https://github.com/apache/cloudstack/pull/4525#pullrequestreview-548161933", "createdAt": "2020-12-09T13:05:35Z", "commit": {"oid": "8f8615f8fdd9fa3926cd0f051bc37e6ae9942103"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMzowNTozNVrOICTovg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMzowNTozNVrOICTovg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI4OTc5MA==", "bodyText": "can we ignore this completely (without at least diagnostic debug message)?", "url": "https://github.com/apache/cloudstack/pull/4525#discussion_r539289790", "createdAt": "2020-12-09T13:05:35Z", "author": {"login": "DaanHoogland"}, "path": "plugins/hypervisors/xenserver/src/main/java/com/cloud/hypervisor/xenserver/resource/CitrixResourceBase.java", "diffHunk": "@@ -1489,27 +1489,31 @@ protected String deleteSnapshotBackup(final Connection conn, final Long dcId, fi\n         return result;\n     }\n \n-    public void destroyPatchVbd(final Connection conn, final String vmName) throws XmlRpcException, XenAPIException {\n+    public void ejectPatchVbd(final Connection conn, final Host host) {\n+        try {\n+            final Set<VM> vms = host.getResidentVMs(conn);\n+            for (final VM vm : vms) {\n+                destroyPatchVbd(conn, vm);\n+            }\n+        } catch (XenAPIException | XmlRpcException ignored) {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f8615f8fdd9fa3926cd0f051bc37e6ae9942103"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4Mjc5OTQ3", "url": "https://github.com/apache/cloudstack/pull/4525#pullrequestreview-548279947", "createdAt": "2020-12-09T15:08:18Z", "commit": {"oid": "7fe57cf25bde54c1793aafee80f2647d78301077"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MzA1MTA2", "url": "https://github.com/apache/cloudstack/pull/4525#pullrequestreview-548305106", "createdAt": "2020-12-09T15:31:01Z", "commit": {"oid": "7fe57cf25bde54c1793aafee80f2647d78301077"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4602, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}