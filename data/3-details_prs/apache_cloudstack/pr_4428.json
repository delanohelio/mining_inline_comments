{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwNjUwNTUx", "number": 4428, "title": "Moved dedicated hosts to the end of the resultset when selecting an e\u2026", "bodyText": "\u2026ndpoint\nDescription\n\nWhen Cloudstack selects an endpoint to do various storage-related tasks,  a dedicated host will be lower in priority.\n\n\n\n\n\nFixes: #3392\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?\n\n\n\nDedicate a host to an account and then call the prepareTemplate API - depending on your setup - if you have 2 hosts and the 1 is dedicated, the dedicated host should not do the seeding of the template.\nIf there is only 1 host, then it will do the seeding.", "createdAt": "2020-10-27T10:40:22Z", "url": "https://github.com/apache/cloudstack/pull/4428", "merged": true, "mergeCommit": {"oid": "acee15a530cc9f3dc8710de108b36e61a75c75c9"}, "closed": true, "closedAt": "2020-11-18T12:07:15Z", "author": {"login": "Spaceman1984"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWmYMJgH2gAyNTEwNjUwNTUxOjJjNDE3MTMxMTU0Yjg3M2VkZGYwYWM4OWVkNWQ2MjY0MDc2Y2Q0NzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddqdengFqTUzMzIzNTU5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2c417131154b873eddf0ac89ed5d6264076cd476", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/2c417131154b873eddf0ac89ed5d6264076cd476", "committedDate": "2020-10-27T10:26:23Z", "message": "Moved dedicated hosts to the end of the resultset when selecting an endpoint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NjQ2MjM2", "url": "https://github.com/apache/cloudstack/pull/4428#pullrequestreview-517646236", "createdAt": "2020-10-27T12:26:30Z", "commit": {"oid": "2c417131154b873eddf0ac89ed5d6264076cd476"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMjoyNjozMFrOHo5qMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxMjoyNjozMFrOHo5qMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY0OTc3OA==", "bodyText": "if we randomise and limit to one result, what does it matter what the ordering of the set is?", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r512649778", "createdAt": "2020-10-27T12:26:30Z", "author": {"login": "DaanHoogland"}, "path": "engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java", "diffHunk": "@@ -128,9 +131,15 @@ protected EndPoint findEndPointInScope(Scope scope, String sqlBase, Long poolId)\n             }\n         }\n \n+        List<Long> dedicatedHosts = dedicatedResourceDao.listAllHosts();\n+\n         // TODO: order by rand() is slow if there are lot of hosts\n         sbuilder.append(\") t where t.value<>'true' or t.value is null\");    //Added for exclude cluster's subquery\n-        sbuilder.append(\" ORDER by rand() limit 1\");\n+        sbuilder.append(\" ORDER by \");\n+        for (Long hostId: dedicatedHosts){ // put dedicated hosts at the end of the result set\n+            sbuilder.append(\"field(t.id, '\" + hostId +\"'),\" );\n+        }\n+        sbuilder.append(\" rand() limit 1\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c417131154b873eddf0ac89ed5d6264076cd476"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfd956745ca7ab9b4892fc07966d9f983f97c2f6", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/dfd956745ca7ab9b4892fc07966d9f983f97c2f6", "committedDate": "2020-10-28T09:05:30Z", "message": "Reduced calling the field method to 1 call and randomized dedicated hosts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5NDQ0NDA5", "url": "https://github.com/apache/cloudstack/pull/4428#pullrequestreview-519444409", "createdAt": "2020-10-29T08:49:48Z", "commit": {"oid": "dfd956745ca7ab9b4892fc07966d9f983f97c2f6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwODo0OTo0OFrOHqRwNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwODo0OTo0OFrOHqRwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA5MzExMQ==", "bodyText": "can this be a separate method (i.e. moveDedicatedHostsToBackForExclusion(sbuilder,dedicatedHosts);) ?", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r514093111", "createdAt": "2020-10-29T08:49:48Z", "author": {"login": "DaanHoogland"}, "path": "engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java", "diffHunk": "@@ -128,9 +132,24 @@ protected EndPoint findEndPointInScope(Scope scope, String sqlBase, Long poolId)\n             }\n         }\n \n+        List<Long> dedicatedHosts = dedicatedResourceDao.listAllHosts();\n+\n         // TODO: order by rand() is slow if there are lot of hosts\n         sbuilder.append(\") t where t.value<>'true' or t.value is null\");    //Added for exclude cluster's subquery\n-        sbuilder.append(\" ORDER by rand() limit 1\");\n+        sbuilder.append(\" ORDER by \");\n+        if (dedicatedHosts.size() > 0) {\n+            Collections.shuffle(dedicatedHosts); // Randomize dedicated hosts as well.\n+            sbuilder.append(\"field(t.id, \");\n+            Iterator<Long> hostIt = dedicatedHosts.iterator();\n+            while (hostIt.hasNext()) { // put dedicated hosts at the end of the result set\n+                sbuilder.append(\"'\" + hostIt.next() + \"'\");\n+                if (hostIt.hasNext()) {\n+                    sbuilder.append(\",\");\n+                }\n+            }\n+            sbuilder.append(\"),\" );\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfd956745ca7ab9b4892fc07966d9f983f97c2f6"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNDIxMjg5", "url": "https://github.com/apache/cloudstack/pull/4428#pullrequestreview-521421289", "createdAt": "2020-11-02T08:37:38Z", "commit": {"oid": "dfd956745ca7ab9b4892fc07966d9f983f97c2f6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1OTU1NTY4", "url": "https://github.com/apache/cloudstack/pull/4428#pullrequestreview-525955568", "createdAt": "2020-11-09T06:35:55Z", "commit": {"oid": "dfd956745ca7ab9b4892fc07966d9f983f97c2f6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwNjozNTo1NVrOHvgicw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwNjozNTo1NVrOHvgicw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU3ODIyNw==", "bodyText": "@Spaceman1984 get the dedicated hosts list based on the scope here, instead all hosts. not required to iterate through all hosts for the given scope.", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r519578227", "createdAt": "2020-11-09T06:35:55Z", "author": {"login": "sureshanaparti"}, "path": "engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java", "diffHunk": "@@ -128,9 +132,24 @@ protected EndPoint findEndPointInScope(Scope scope, String sqlBase, Long poolId)\n             }\n         }\n \n+        List<Long> dedicatedHosts = dedicatedResourceDao.listAllHosts();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfd956745ca7ab9b4892fc07966d9f983f97c2f6"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1OTU4MjIw", "url": "https://github.com/apache/cloudstack/pull/4428#pullrequestreview-525958220", "createdAt": "2020-11-09T06:43:08Z", "commit": {"oid": "dfd956745ca7ab9b4892fc07966d9f983f97c2f6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwNjo0MzowOFrOHvgqow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwNjo0MzowOFrOHvgqow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTU4MDMyMw==", "bodyText": "@Spaceman1984 the ordering based on the dedicated host ids here would put them on the top, can you confirm the result here?", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r519580323", "createdAt": "2020-11-09T06:43:08Z", "author": {"login": "sureshanaparti"}, "path": "engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java", "diffHunk": "@@ -128,9 +132,24 @@ protected EndPoint findEndPointInScope(Scope scope, String sqlBase, Long poolId)\n             }\n         }\n \n+        List<Long> dedicatedHosts = dedicatedResourceDao.listAllHosts();\n+\n         // TODO: order by rand() is slow if there are lot of hosts\n         sbuilder.append(\") t where t.value<>'true' or t.value is null\");    //Added for exclude cluster's subquery\n-        sbuilder.append(\" ORDER by rand() limit 1\");\n+        sbuilder.append(\" ORDER by \");\n+        if (dedicatedHosts.size() > 0) {\n+            Collections.shuffle(dedicatedHosts); // Randomize dedicated hosts as well.\n+            sbuilder.append(\"field(t.id, \");\n+            Iterator<Long> hostIt = dedicatedHosts.iterator();\n+            while (hostIt.hasNext()) { // put dedicated hosts at the end of the result set", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfd956745ca7ab9b4892fc07966d9f983f97c2f6"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d85bcdfdd7f46c25acf8d60141a478b7784c427c", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/d85bcdfdd7f46c25acf8d60141a478b7784c427c", "committedDate": "2020-11-09T08:42:09Z", "message": "Moved logic to function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "033c66bef4a711808fca22a347b27c4fcb64e498", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/033c66bef4a711808fca22a347b27c4fcb64e498", "committedDate": "2020-11-13T10:57:57Z", "message": "Checking for dedicated hosts by scope and excluding dedicated hosts belonging to calling account from lower priority list."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNTY1NTI1", "url": "https://github.com/apache/cloudstack/pull/4428#pullrequestreview-530565525", "createdAt": "2020-11-14T09:13:41Z", "commit": {"oid": "033c66bef4a711808fca22a347b27c4fcb64e498"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMDk3OTU2", "url": "https://github.com/apache/cloudstack/pull/4428#pullrequestreview-531097956", "createdAt": "2020-11-16T08:39:58Z", "commit": {"oid": "033c66bef4a711808fca22a347b27c4fcb64e498"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwODozOTo1OFrOHzszbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwODozOTo1OFrOHzszbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk3MzQ4Ng==", "bodyText": "@Spaceman1984 scope id in this case is zone id, and the hosts are found using cluster id method, please check.", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r523973486", "createdAt": "2020-11-16T08:39:58Z", "author": {"login": "sureshanaparti"}, "path": "engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java", "diffHunk": "@@ -115,22 +123,46 @@ protected EndPoint findEndPointInScope(Scope scope, String sqlBase, Long poolId)\n         StringBuilder sbuilder = new StringBuilder();\n         sbuilder.append(sqlBase);\n \n+        List<Long> dedicatedHosts = new ArrayList<Long>();\n+\n         if (scope != null) {\n             if (scope.getScopeType() == ScopeType.HOST) {\n                 sbuilder.append(\" and h.id = \");\n                 sbuilder.append(scope.getScopeId());\n             } else if (scope.getScopeType() == ScopeType.CLUSTER) {\n                 sbuilder.append(\" and h.cluster_id = \");\n                 sbuilder.append(scope.getScopeId());\n+                DedicatedResourceVO dedicatedHost = dedicatedResourceDao.findByClusterId(scope.getScopeId());\n+                if (dedicatedHost != null){\n+                    List<HostVO> clusterHosts = hostDao.findByClusterId(scope.getScopeId());\n+                    for (HostVO hostVO: clusterHosts){\n+                        dedicatedHosts.add(hostVO.getId());\n+                    }\n+                }\n             } else if (scope.getScopeType() == ScopeType.ZONE) {\n                 sbuilder.append(\" and h.data_center_id = \");\n                 sbuilder.append(scope.getScopeId());\n+                DedicatedResourceVO dedicatedHost = dedicatedResourceDao.findByZoneId(scope.getScopeId());\n+                if (dedicatedHost != null){\n+                    List<HostVO> zoneHosts = hostDao.findByClusterId(scope.getScopeId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "033c66bef4a711808fca22a347b27c4fcb64e498"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0103724a9b71a37afa283da516720bff750572d9", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/0103724a9b71a37afa283da516720bff750572d9", "committedDate": "2020-11-16T08:51:47Z", "message": "Fixed cluster/zone issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMTIwMDI4", "url": "https://github.com/apache/cloudstack/pull/4428#pullrequestreview-531120028", "createdAt": "2020-11-16T08:54:42Z", "commit": {"oid": "033c66bef4a711808fca22a347b27c4fcb64e498"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwODo1NDo0MlrOHztcTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwODo1NDo0MlrOHztcTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk4Mzk0OA==", "bodyText": "@Spaceman1984 what if cluster is not dedicated, but some hosts in that cluster are dedicated?", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r523983948", "createdAt": "2020-11-16T08:54:42Z", "author": {"login": "sureshanaparti"}, "path": "engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java", "diffHunk": "@@ -115,22 +123,46 @@ protected EndPoint findEndPointInScope(Scope scope, String sqlBase, Long poolId)\n         StringBuilder sbuilder = new StringBuilder();\n         sbuilder.append(sqlBase);\n \n+        List<Long> dedicatedHosts = new ArrayList<Long>();\n+\n         if (scope != null) {\n             if (scope.getScopeType() == ScopeType.HOST) {\n                 sbuilder.append(\" and h.id = \");\n                 sbuilder.append(scope.getScopeId());\n             } else if (scope.getScopeType() == ScopeType.CLUSTER) {\n                 sbuilder.append(\" and h.cluster_id = \");\n                 sbuilder.append(scope.getScopeId());\n+                DedicatedResourceVO dedicatedHost = dedicatedResourceDao.findByClusterId(scope.getScopeId());\n+                if (dedicatedHost != null){\n+                    List<HostVO> clusterHosts = hostDao.findByClusterId(scope.getScopeId());\n+                    for (HostVO hostVO: clusterHosts){\n+                        dedicatedHosts.add(hostVO.getId());\n+                    }\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "033c66bef4a711808fca22a347b27c4fcb64e498"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMTI1OTg0", "url": "https://github.com/apache/cloudstack/pull/4428#pullrequestreview-531125984", "createdAt": "2020-11-16T09:02:43Z", "commit": {"oid": "0103724a9b71a37afa283da516720bff750572d9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwOTowMjo0M1rOHzt-fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwOTowMjo0M1rOHzt-fA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk5MjcwMA==", "bodyText": "@Spaceman1984  the scope is not considered here, this returns all the dedicated hosts same as the earlier case.\nIf the cluster is not dedicated and some hosts in that cluster are dedicated, then get the dedicated hosts in that cluster only, which you can move to the end of the result set. Got me? Didn't see any dao method for this?", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r523992700", "createdAt": "2020-11-16T09:02:43Z", "author": {"login": "sureshanaparti"}, "path": "engine/storage/src/main/java/org/apache/cloudstack/storage/endpoint/DefaultEndPointSelector.java", "diffHunk": "@@ -115,22 +123,46 @@ protected EndPoint findEndPointInScope(Scope scope, String sqlBase, Long poolId)\n         StringBuilder sbuilder = new StringBuilder();\n         sbuilder.append(sqlBase);\n \n+        List<Long> dedicatedHosts = new ArrayList<Long>();\n+\n         if (scope != null) {\n             if (scope.getScopeType() == ScopeType.HOST) {\n                 sbuilder.append(\" and h.id = \");\n                 sbuilder.append(scope.getScopeId());\n             } else if (scope.getScopeType() == ScopeType.CLUSTER) {\n                 sbuilder.append(\" and h.cluster_id = \");\n                 sbuilder.append(scope.getScopeId());\n+                DedicatedResourceVO dedicatedHost = dedicatedResourceDao.findByClusterId(scope.getScopeId());\n+                if (dedicatedHost != null){\n+                    List<HostVO> clusterHosts = hostDao.findByClusterId(scope.getScopeId());\n+                    for (HostVO hostVO: clusterHosts){\n+                        dedicatedHosts.add(hostVO.getId());\n+                    }\n+                }\n             } else if (scope.getScopeType() == ScopeType.ZONE) {\n                 sbuilder.append(\" and h.data_center_id = \");\n                 sbuilder.append(scope.getScopeId());\n+                DedicatedResourceVO dedicatedHost = dedicatedResourceDao.findByZoneId(scope.getScopeId());\n+                if (dedicatedHost != null){\n+                    List<HostVO> zoneHosts = hostDao.findByDataCenterId(scope.getScopeId());\n+                    for (HostVO hostVO: zoneHosts){\n+                        dedicatedHosts.add(hostVO.getId());\n+                    }\n+                }\n             }\n         }\n+        // We didn't find any hosts specifically dedicated to a zone or cluster\n+        if (dedicatedHosts.size() == 0) {\n+            dedicatedHosts = dedicatedResourceDao.listAllHosts();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0103724a9b71a37afa283da516720bff750572d9"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b21b734efb5383bc697d2b190d4465cc4bbe7f01", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/b21b734efb5383bc697d2b190d4465cc4bbe7f01", "committedDate": "2020-11-17T10:17:00Z", "message": "Fetching dedidcated hosts by zone and cluster id and changed logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a334c7c0f743011b00971859a5da02534d532de", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/9a334c7c0f743011b00971859a5da02534d532de", "committedDate": "2020-11-17T11:11:23Z", "message": "Merge branch 'master' into dedicated_hosts_priority"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e9d86caeacf882d4fe9e9c02bd102a046a8171a", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/0e9d86caeacf882d4fe9e9c02bd102a046a8171a", "committedDate": "2020-11-17T11:55:25Z", "message": "Fixed bad merge"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMjE5NDUw", "url": "https://github.com/apache/cloudstack/pull/4428#pullrequestreview-533219450", "createdAt": "2020-11-18T08:49:25Z", "commit": {"oid": "0e9d86caeacf882d4fe9e9c02bd102a046a8171a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwODo0OToyNVrOH1jACg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwODo0OToyNVrOH1jACg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkxMDAyNg==", "bodyText": "@Spaceman1984 these changes are part of your fix?", "url": "https://github.com/apache/cloudstack/pull/4428#discussion_r525910026", "createdAt": "2020-11-18T08:49:25Z", "author": {"login": "sureshanaparti"}, "path": "engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java", "diffHunk": "@@ -1672,10 +1672,13 @@ protected boolean sendStop(final VirtualMachineGuru guru, final VirtualMachinePr\n                 }\n \n                 guru.finalizeStop(profile, answer);\n+\n+                final UserVmVO userVm = _userVmDao.findById(vm.getId());\n                 if (vm.getType() == VirtualMachine.Type.User) {\n-                    final UserVmVO userVm = _userVmDao.findById(vm.getId());\n-                    userVm.setPowerState(PowerState.PowerOff);\n-                    _userVmDao.update(userVm.getId(), userVm);\n+                    if (userVm != null){\n+                        userVm.setPowerState(PowerState.PowerOff);\n+                        _userVmDao.update(userVm.getId(), userVm);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e9d86caeacf882d4fe9e9c02bd102a046a8171a"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMjM1NTk0", "url": "https://github.com/apache/cloudstack/pull/4428#pullrequestreview-533235594", "createdAt": "2020-11-18T09:09:15Z", "commit": {"oid": "0e9d86caeacf882d4fe9e9c02bd102a046a8171a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4741, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}