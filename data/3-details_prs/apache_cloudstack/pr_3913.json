{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4OTQxMTI5", "number": 3913, "title": "Fix dhcp infinite lease time", "bodyText": "The previous setup of many hours would not work, due to some internal dnsmasq issues - lease was set correclty, but dnsmasq was setting the dhcp-renew-time (and rebind time) to less than 2 years from the date the lease was issued.\nUsing \"infinite\" as the value (instead of the number) works as expected - and (atm) the renew date is set to year 2088, etc..\nDescription\n\n\n\n\n\n\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nConfirmation inside user VM of correct renew/rebind/expire time\n\nConfiguration inside VRs\n\nDifferent one:\n\nHow Has This Been Tested?\n\n\n\nSee screenshot above", "createdAt": "2020-02-24T11:29:16Z", "url": "https://github.com/apache/cloudstack/pull/3913", "merged": true, "mergeCommit": {"oid": "e8d418c0917875d304cd68a0bff3f5efb49c16da"}, "closed": true, "closedAt": "2020-02-28T08:57:10Z", "author": {"login": "andrijapanicsb"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHb1HGAH2gAyMzc4OTQxMTI5Ojc4MWQyYWIwOGEyNWI2MmQ1M2Y4MGI4ZWYzN2QwZjgxYWQwNDgxYTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIsCp-AFqTM2NjI0MTY4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "781d2ab08a25b62d53f80b8ef37d0f81ad0481a5", "author": {"user": {"login": "andrijapanicsb", "name": "Andrija Panic"}}, "url": "https://github.com/apache/cloudstack/commit/781d2ab08a25b62d53f80b8ef37d0f81ad0481a5", "committedDate": "2020-02-24T11:29:00Z", "message": "Fix dhcp infinite lease time\n\nThe previous setup of many hours would not work, due to some internal dnsmasq issues - lease was set correctly, but dnsmasq was setting the dhcp-renew-time (and rebind time) to less than 2 years from the date the lease was issued.\r\n\r\nUsing \"infinite\" as the value (instead of the number) works as expected - and (atm) the renew date is set to year 2088, etc."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMzQzMDA5", "url": "https://github.com/apache/cloudstack/pull/3913#pullrequestreview-363343009", "createdAt": "2020-02-24T12:07:00Z", "commit": {"oid": "781d2ab08a25b62d53f80b8ef37d0f81ad0481a5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NDAyNDc5", "url": "https://github.com/apache/cloudstack/pull/3913#pullrequestreview-364402479", "createdAt": "2020-02-25T19:51:02Z", "commit": {"oid": "781d2ab08a25b62d53f80b8ef37d0f81ad0481a5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0OTc1MjI0", "url": "https://github.com/apache/cloudstack/pull/3913#pullrequestreview-364975224", "createdAt": "2020-02-26T15:06:21Z", "commit": {"oid": "781d2ab08a25b62d53f80b8ef37d0f81ad0481a5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNTowNjoyMlrOFuvK-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNTowNzoxMVrOFuvNKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU1MTY3NA==", "bodyText": "pylint is not accepting this, @andrijapanicsb", "url": "https://github.com/apache/cloudstack/pull/3913#discussion_r384551674", "createdAt": "2020-02-26T15:06:22Z", "author": {"login": "DaanHoogland"}, "path": "systemvm/debian/opt/cloud/bin/cs/CsDhcp.py", "diffHunk": "@@ -174,18 +174,15 @@ def write_hosts(self):\n \n     def add(self, entry):\n         self.add_host(entry['ipv4_address'], entry['host_name'])\n-        # Lease time set to effectively infinite (36000+ days) since we properly control all DHCP/DNS config via CloudStack.\n+        # Lease time set to \"infinite\" since we properly control all DHCP/DNS config via CloudStack.\n         # Infinite time helps avoid some edge cases which could cause DHCPNAK being sent to VMs since\n         # (RHEL) system lose routes when they receive DHCPNAK.\n         # When VM is expunged, its active lease and DHCP/DNS config is properly removed from related files in VR,\n         # so the infinite duration of lease does not cause any issues or garbage.\n-        # There will be soon a PR which also regenerates the /var/lib/misc/dnsmasq.leases (active lease DB file)\n-        # in the new VR (when restarting network with cleanup), which will help around RHEL edge cases (described above)\n-        # for the VMs who are already running in productions systems with 30d lease time.\n-        lease = randint(870000, 870010)\n+        lease = 'infinite'\n \n         if entry['default_entry']:\n-            self.cloud.add(\"%s,%s,%s,%sh\" % (entry['mac_address'],\n+            self.cloud.add(\"%s,%s,%s,%s\" % (entry['mac_address'],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "781d2ab08a25b62d53f80b8ef37d0f81ad0481a5"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU1MjIzMw==", "bodyText": "you need to unindent by one space as you made the base statement one char shorter as well. :P", "url": "https://github.com/apache/cloudstack/pull/3913#discussion_r384552233", "createdAt": "2020-02-26T15:07:11Z", "author": {"login": "DaanHoogland"}, "path": "systemvm/debian/opt/cloud/bin/cs/CsDhcp.py", "diffHunk": "@@ -174,18 +174,15 @@ def write_hosts(self):\n \n     def add(self, entry):\n         self.add_host(entry['ipv4_address'], entry['host_name'])\n-        # Lease time set to effectively infinite (36000+ days) since we properly control all DHCP/DNS config via CloudStack.\n+        # Lease time set to \"infinite\" since we properly control all DHCP/DNS config via CloudStack.\n         # Infinite time helps avoid some edge cases which could cause DHCPNAK being sent to VMs since\n         # (RHEL) system lose routes when they receive DHCPNAK.\n         # When VM is expunged, its active lease and DHCP/DNS config is properly removed from related files in VR,\n         # so the infinite duration of lease does not cause any issues or garbage.\n-        # There will be soon a PR which also regenerates the /var/lib/misc/dnsmasq.leases (active lease DB file)\n-        # in the new VR (when restarting network with cleanup), which will help around RHEL edge cases (described above)\n-        # for the VMs who are already running in productions systems with 30d lease time.\n-        lease = randint(870000, 870010)\n+        lease = 'infinite'\n \n         if entry['default_entry']:\n-            self.cloud.add(\"%s,%s,%s,%sh\" % (entry['mac_address'],\n+            self.cloud.add(\"%s,%s,%s,%s\" % (entry['mac_address'],\n                                              entry['ipv4_address'],\n                                              entry['host_name'],\n                                              lease))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "781d2ab08a25b62d53f80b8ef37d0f81ad0481a5"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "940b0c2a5cc684857e8d6309c860bac1f4fd4494", "author": {"user": {"login": "DaanHoogland", "name": "dahn"}}, "url": "https://github.com/apache/cloudstack/commit/940b0c2a5cc684857e8d6309c860bac1f4fd4494", "committedDate": "2020-02-26T15:38:10Z", "message": "indent"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MjQxNjgz", "url": "https://github.com/apache/cloudstack/pull/3913#pullrequestreview-366241683", "createdAt": "2020-02-28T08:56:12Z", "commit": {"oid": "940b0c2a5cc684857e8d6309c860bac1f4fd4494"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4443, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}