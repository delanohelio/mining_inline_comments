{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5ODQ1NTQx", "number": 4425, "title": "Setting snapshot removed on timeout", "bodyText": "Description\n\nWhen creating a snapshot times-out on the management server, the record in snapshot_store_ref table is deleted.\nBy setting the snapshot to \"removed\" on timeout, the record is not deleted.\n\n\n\n\n\nFixes: #3559\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?\n\n\n\n\nSet the global variable: backup.snapshot.wait to 2 seconds.\nCreate a volume snapshot.\nCheck the snapshots table for a snapshot record and check for a corresponding record in snapshot_store_ref table.", "createdAt": "2020-10-26T07:51:33Z", "url": "https://github.com/apache/cloudstack/pull/4425", "merged": true, "mergeCommit": {"oid": "dfa09fc856c544e6edf001c66867472463d7ef96"}, "closed": true, "closedAt": "2020-11-20T20:50:17Z", "author": {"login": "Spaceman1984"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWPdLegH2gAyNTA5ODQ1NTQxOjFhMDczNGYwN2E2MzcwZGQ2YzVhOGE3MmU3MzZlMzQ3MjE4NGRmNTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeX7wbgFqTUzNTQ1NjYyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1a0734f07a6370dd6c5a8a72e736e3472184df56", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/1a0734f07a6370dd6c5a8a72e736e3472184df56", "committedDate": "2020-10-26T07:44:01Z", "message": "Setting snapshot state to error on timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MDQ2NTgz", "url": "https://github.com/apache/cloudstack/pull/4425#pullrequestreview-517046583", "createdAt": "2020-10-26T18:05:56Z", "commit": {"oid": "1a0734f07a6370dd6c5a8a72e736e3472184df56"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MzQ2Njgx", "url": "https://github.com/apache/cloudstack/pull/4425#pullrequestreview-517346681", "createdAt": "2020-10-27T04:51:08Z", "commit": {"oid": "1a0734f07a6370dd6c5a8a72e736e3472184df56"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NTc1MTUy", "url": "https://github.com/apache/cloudstack/pull/4425#pullrequestreview-517575152", "createdAt": "2020-10-27T10:55:40Z", "commit": {"oid": "1a0734f07a6370dd6c5a8a72e736e3472184df56"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9650051a295e1e3b383eda56bca27851a4644bcf", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/9650051a295e1e3b383eda56bca27851a4644bcf", "committedDate": "2020-11-06T10:36:24Z", "message": "Setting removed field so snapshot record is ignored by garbage collection"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MzE3MTk0", "url": "https://github.com/apache/cloudstack/pull/4425#pullrequestreview-526317194", "createdAt": "2020-11-09T14:36:31Z", "commit": {"oid": "9650051a295e1e3b383eda56bca27851a4644bcf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNDozNjozMVrOHvxuRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNDozNjozMVrOHvxuRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg1OTc4MQ==", "bodyText": "should this be in a transaction to be sure?", "url": "https://github.com/apache/cloudstack/pull/4425#discussion_r519859781", "createdAt": "2020-11-09T14:36:31Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/storage/snapshot/SnapshotManagerImpl.java", "diffHunk": "@@ -553,6 +553,25 @@ private void postCreateRecurringSnapshotForPolicy(long userId, long volumeId, lo\n         }\n     }\n \n+    public void markFailedSnapshot(long snapshotId) {\n+        Account caller = CallContext.current().getCallingAccount();\n+\n+        // Verify parameters\n+        SnapshotVO snapshotCheck = _snapshotDao.findById(snapshotId);\n+\n+        if (snapshotCheck == null) {\n+            throw new InvalidParameterValueException(\"unable to find a snapshot with id \" + snapshotId);\n+        }\n+\n+        _accountMgr.checkAccess(caller, null, true, snapshotCheck);\n+\n+        snapshotCheck.setState(Snapshot.State.Error);\n+        _snapshotDao.update(snapshotId, snapshotCheck);\n+        // Setting removed to prevent record from being deleted by garbage collection.\n+        _snapshotDao.remove(snapshotId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9650051a295e1e3b383eda56bca27851a4644bcf"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3ODkzNjY3", "url": "https://github.com/apache/cloudstack/pull/4425#pullrequestreview-527893667", "createdAt": "2020-11-11T06:30:05Z", "commit": {"oid": "9650051a295e1e3b383eda56bca27851a4644bcf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwNjozMDowNlrOHw_1PQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwNjozMDowNlrOHw_1PQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTEzOTUxNw==", "bodyText": "@Spaceman1984 the copy callback should mark the snapshot state accordingly, based on the operation result (success / fail). Not required to set the state explicitly.", "url": "https://github.com/apache/cloudstack/pull/4425#discussion_r521139517", "createdAt": "2020-11-11T06:30:06Z", "author": {"login": "sureshanaparti"}, "path": "engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/AncientDataMotionStrategy.java", "diffHunk": "@@ -587,6 +590,7 @@ protected Answer copySnapshot(DataObject srcData, DataObject destData) {\n             if (cacheData != null) {\n                 cacheMgr.deleteCacheObject(cacheData);\n             }\n+            _snapshotService.markFailedSnapshot(destData.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9650051a295e1e3b383eda56bca27851a4644bcf"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3ODk1MDM3", "url": "https://github.com/apache/cloudstack/pull/4425#pullrequestreview-527895037", "createdAt": "2020-11-11T06:33:30Z", "commit": {"oid": "9650051a295e1e3b383eda56bca27851a4644bcf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwNjozMzozMFrOHw_5kQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwNjozMzozMFrOHw_5kQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTE0MDYyNQ==", "bodyText": "@Spaceman1984 can you handle this in the copy callback, and pass the proper event to set the snapshot state?", "url": "https://github.com/apache/cloudstack/pull/4425#discussion_r521140625", "createdAt": "2020-11-11T06:33:30Z", "author": {"login": "sureshanaparti"}, "path": "server/src/main/java/com/cloud/storage/snapshot/SnapshotManagerImpl.java", "diffHunk": "@@ -553,6 +553,25 @@ private void postCreateRecurringSnapshotForPolicy(long userId, long volumeId, lo\n         }\n     }\n \n+    public void markFailedSnapshot(long snapshotId) {\n+        Account caller = CallContext.current().getCallingAccount();\n+\n+        // Verify parameters\n+        SnapshotVO snapshotCheck = _snapshotDao.findById(snapshotId);\n+\n+        if (snapshotCheck == null) {\n+            throw new InvalidParameterValueException(\"unable to find a snapshot with id \" + snapshotId);\n+        }\n+\n+        _accountMgr.checkAccess(caller, null, true, snapshotCheck);\n+\n+        snapshotCheck.setState(Snapshot.State.Error);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9650051a295e1e3b383eda56bca27851a4644bcf"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd8955e6c8faad04693e64996e36c751f3e0aee9", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/cd8955e6c8faad04693e64996e36c751f3e0aee9", "committedDate": "2020-11-17T13:47:47Z", "message": "Removed explicitly setting error status, renamed method from markFailed to markRemoved"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNDI5MTQw", "url": "https://github.com/apache/cloudstack/pull/4425#pullrequestreview-532429140", "createdAt": "2020-11-17T14:40:14Z", "commit": {"oid": "cd8955e6c8faad04693e64996e36c751f3e0aee9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNTEwNTk3", "url": "https://github.com/apache/cloudstack/pull/4425#pullrequestreview-532510597", "createdAt": "2020-11-17T15:47:45Z", "commit": {"oid": "cd8955e6c8faad04693e64996e36c751f3e0aee9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMjA5Nzgz", "url": "https://github.com/apache/cloudstack/pull/4425#pullrequestreview-533209783", "createdAt": "2020-11-18T08:37:01Z", "commit": {"oid": "cd8955e6c8faad04693e64996e36c751f3e0aee9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwODozNzowMVrOH1iiaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwODozNzowMVrOH1iiaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkwMjQ0MA==", "bodyText": "markRemovedSnapshot indicates the snapshot is already removed. I think removeSnapshot (or markSnapshotAsRemoved) is ok.", "url": "https://github.com/apache/cloudstack/pull/4425#discussion_r525902440", "createdAt": "2020-11-18T08:37:01Z", "author": {"login": "sureshanaparti"}, "path": "server/src/main/java/com/cloud/storage/snapshot/SnapshotManagerImpl.java", "diffHunk": "@@ -553,6 +553,22 @@ private void postCreateRecurringSnapshotForPolicy(long userId, long volumeId, lo\n         }\n     }\n \n+    public void markRemovedSnapshot(long snapshotId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd8955e6c8faad04693e64996e36c751f3e0aee9"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMjExMDA4", "url": "https://github.com/apache/cloudstack/pull/4425#pullrequestreview-533211008", "createdAt": "2020-11-18T08:38:40Z", "commit": {"oid": "cd8955e6c8faad04693e64996e36c751f3e0aee9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwODozODo0MFrOH1imdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwODozODo0MFrOH1imdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkwMzQ3Nw==", "bodyText": "move caller here.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    _accountMgr.checkAccess(caller, null, true, snapshotCheck);\n          \n          \n            \n                    Account caller = CallContext.current().getCallingAccount();\n          \n          \n            \n                    _accountMgr.checkAccess(caller, null, true, snapshotCheck);", "url": "https://github.com/apache/cloudstack/pull/4425#discussion_r525903477", "createdAt": "2020-11-18T08:38:40Z", "author": {"login": "sureshanaparti"}, "path": "server/src/main/java/com/cloud/storage/snapshot/SnapshotManagerImpl.java", "diffHunk": "@@ -553,6 +553,22 @@ private void postCreateRecurringSnapshotForPolicy(long userId, long volumeId, lo\n         }\n     }\n \n+    public void markRemovedSnapshot(long snapshotId) {\n+        Account caller = CallContext.current().getCallingAccount();\n+\n+        // Verify parameters\n+        SnapshotVO snapshotCheck = _snapshotDao.findById(snapshotId);\n+\n+        if (snapshotCheck == null) {\n+            throw new InvalidParameterValueException(\"unable to find a snapshot with id \" + snapshotId);\n+        }\n+\n+        _accountMgr.checkAccess(caller, null, true, snapshotCheck);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd8955e6c8faad04693e64996e36c751f3e0aee9"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMjE1ODg2", "url": "https://github.com/apache/cloudstack/pull/4425#pullrequestreview-533215886", "createdAt": "2020-11-18T08:45:05Z", "commit": {"oid": "cd8955e6c8faad04693e64996e36c751f3e0aee9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwODo0NTowNlrOH1i1mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwODo0NTowNlrOH1i1mA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkwNzM1Mg==", "bodyText": "Can you check for OperationTimedoutException (if thrown for timeout?), set removed accordingly. Note that, the snapshot here is not in Error state as the copy callback is not yet to be called, which takes the action based on the operation failure.", "url": "https://github.com/apache/cloudstack/pull/4425#discussion_r525907352", "createdAt": "2020-11-18T08:45:06Z", "author": {"login": "sureshanaparti"}, "path": "engine/storage/datamotion/src/main/java/org/apache/cloudstack/storage/motion/AncientDataMotionStrategy.java", "diffHunk": "@@ -587,6 +590,7 @@ protected Answer copySnapshot(DataObject srcData, DataObject destData) {\n             if (cacheData != null) {\n                 cacheMgr.deleteCacheObject(cacheData);\n             }\n+            _snapshotService.markRemovedSnapshot(destData.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd8955e6c8faad04693e64996e36c751f3e0aee9"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7574ba3323268eaede28df804bd24874cd79b6e", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/a7574ba3323268eaede28df804bd24874cd79b6e", "committedDate": "2020-11-18T14:05:58Z", "message": "Renamed method, moved code a few lines down"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49d6ff065bbc6cfe853d32332aafaf81d4455839", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/49d6ff065bbc6cfe853d32332aafaf81d4455839", "committedDate": "2020-11-19T09:01:31Z", "message": "Moved remove logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24033b0fa9460ac9c91f559a9c31a5e7316832b7", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/24033b0fa9460ac9c91f559a9c31a5e7316832b7", "committedDate": "2020-11-19T09:12:40Z", "message": "Removed unused service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b168eabe76db3aa13061d3c158a49ea0cbec5a8", "author": {"user": {"login": "Spaceman1984", "name": null}}, "url": "https://github.com/apache/cloudstack/commit/0b168eabe76db3aa13061d3c158a49ea0cbec5a8", "committedDate": "2020-11-19T10:28:57Z", "message": "Moved removed logic - last time, promise"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MzUxODg3", "url": "https://github.com/apache/cloudstack/pull/4425#pullrequestreview-534351887", "createdAt": "2020-11-19T11:56:32Z", "commit": {"oid": "0b168eabe76db3aa13061d3c158a49ea0cbec5a8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NDU2NjI5", "url": "https://github.com/apache/cloudstack/pull/4425#pullrequestreview-535456629", "createdAt": "2020-11-20T14:08:03Z", "commit": {"oid": "0b168eabe76db3aa13061d3c158a49ea0cbec5a8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4736, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}