{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3NjQxMjY3", "number": 3898, "title": "vrouter: reload keepalived instead of restart and fix password server issues when add/remove vpc tier", "bodyText": "Description\n\nThis fixes few issues below\n(1) when add/remove a vpc tier, the keepalived is restarted on both master and backup VRs, which causes some seconds donwtime of vpc.\n(2) when remove a vpc tier, the password server is not stopped.\n(3) vpc tier is shutdown because no vm is running for 20 minutes, if we start a vm in the vpc tier, it will be implemented. however the guest ip in VPC VRs will be changed , and password server is still running with old guest ip in VRs.\n\n\n\n\n\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?", "createdAt": "2020-02-20T09:23:58Z", "url": "https://github.com/apache/cloudstack/pull/3898", "merged": true, "mergeCommit": {"oid": "3f8b2c369dc894696bb06768f6bd355b3a2e6eda"}, "closed": true, "closedAt": "2020-02-28T16:15:52Z", "author": {"login": "ustcweizhou"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGIAjEAFqTM2MTc2MjMxNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIsl6zgFqTM2NjI2NDQ0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNzYyMzE1", "url": "https://github.com/apache/cloudstack/pull/3898#pullrequestreview-361762315", "createdAt": "2020-02-20T09:49:27Z", "commit": {"oid": "3d04b4bce595b4b6760796ea4bc3b3a74c693470"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwOTo0OToyOFrOFsMulw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwOTo0OToyOFrOFsMulw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg5MDE5OQ==", "bodyText": "should there be a value/size check > 0?", "url": "https://github.com/apache/cloudstack/pull/3898#discussion_r381890199", "createdAt": "2020-02-20T09:49:28Z", "author": {"login": "rhtyd"}, "path": "engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java", "diffHunk": "@@ -423,6 +427,12 @@ public void allocate(final String vmInstanceName, final VirtualMachineTemplate t\n \n         final VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmFinal, template, serviceOffering, null, null);\n \n+        Long rootDiskSize = rootDiskOfferingInfo.getSize();\n+        if (vm.getType().isUsedBySystem() && SystemVmRootDiskSize.value() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d04b4bce595b4b6760796ea4bc3b3a74c693470"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNzYyNzA1", "url": "https://github.com/apache/cloudstack/pull/3898#pullrequestreview-361762705", "createdAt": "2020-02-20T09:49:59Z", "commit": {"oid": "3d04b4bce595b4b6760796ea4bc3b3a74c693470"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwOTo0OTo1OVrOFsMvvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwOTo0OTo1OVrOFsMvvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg5MDQ5NA==", "bodyText": "Maybe set the default to 0, update description to say greater than 0 has an effect.", "url": "https://github.com/apache/cloudstack/pull/3898#discussion_r381890494", "createdAt": "2020-02-20T09:49:59Z", "author": {"login": "rhtyd"}, "path": "engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java", "diffHunk": "@@ -377,6 +377,10 @@\n     static final ConfigKey<Boolean> HaVmRestartHostUp = new ConfigKey<Boolean>(\"Advanced\", Boolean.class, \"ha.vm.restart.hostup\", \"true\",\n             \"If an out-of-band stop of a VM is detected and its host is up, then power on the VM\", true);\n \n+    static final ConfigKey<Long> SystemVmRootDiskSize = new ConfigKey<Long>(\"Advanced\",\n+            Long.class, \"systemvm.root.disk.size\", \"-1\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d04b4bce595b4b6760796ea4bc3b3a74c693470"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3d04b4bce595b4b6760796ea4bc3b3a74c693470", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/3d04b4bce595b4b6760796ea4bc3b3a74c693470", "committedDate": "2020-02-20T09:19:01Z", "message": "vrouter: reload keepalived instead of restart and fix password server issues when add/remove vpc tier\n\nThis fixes few issues below\n(1) when add/remove a vpc tier, the keepalived is restarted on both master and backup VRs, which causes some seconds donwtime of vpc.\n(2) when remove a vpc tier, the password server is not stopped.\n(3) vpc tier is shutdown because no vm is running for 20 minutes, if we start a vm in the vpc tier, it will be implemented. however the guest ip in VPC VRs will be changed , and password server is still running with old guest ip in VRs."}, "afterCommit": {"oid": "ba5e03410018d8f848b81de184805b1380704d72", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/ba5e03410018d8f848b81de184805b1380704d72", "committedDate": "2020-02-20T09:53:32Z", "message": "vrouter: reload keepalived instead of restart and fix password server issues when add/remove vpc tier\n\nThis fixes few issues below\n(1) when add/remove a vpc tier, the keepalived is restarted on both master and backup VRs, which causes some seconds donwtime of vpc.\n(2) when remove a vpc tier, the password server is not stopped.\n(3) vpc tier is shutdown because no vm is running for 20 minutes, if we start a vm in the vpc tier, it will be implemented. however the guest ip in VPC VRs will be changed , and password server is still running with old guest ip in VRs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "225eb0ee4fdd866ef6e38ed135237c5c9f9db09e", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/225eb0ee4fdd866ef6e38ed135237c5c9f9db09e", "committedDate": "2020-02-20T09:55:11Z", "message": "vrouter: reload keepalived instead of restart and fix password server issues when add/remove vpc tier\n\nThis fixes few issues below\n(1) when add/remove a vpc tier, the keepalived is restarted on both master and backup VRs, which causes some seconds donwtime of vpc.\n(2) when remove a vpc tier, the password server is not stopped.\n(3) vpc tier is shutdown because no vm is running for 20 minutes, if we start a vm in the vpc tier, it will be implemented. however the guest ip in VPC VRs will be changed , and password server is still running with old guest ip in VRs."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ba5e03410018d8f848b81de184805b1380704d72", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/ba5e03410018d8f848b81de184805b1380704d72", "committedDate": "2020-02-20T09:53:32Z", "message": "vrouter: reload keepalived instead of restart and fix password server issues when add/remove vpc tier\n\nThis fixes few issues below\n(1) when add/remove a vpc tier, the keepalived is restarted on both master and backup VRs, which causes some seconds donwtime of vpc.\n(2) when remove a vpc tier, the password server is not stopped.\n(3) vpc tier is shutdown because no vm is running for 20 minutes, if we start a vm in the vpc tier, it will be implemented. however the guest ip in VPC VRs will be changed , and password server is still running with old guest ip in VRs."}, "afterCommit": {"oid": "225eb0ee4fdd866ef6e38ed135237c5c9f9db09e", "author": {"user": {"login": "ustcweizhou", "name": "Wei Zhou"}}, "url": "https://github.com/apache/cloudstack/commit/225eb0ee4fdd866ef6e38ed135237c5c9f9db09e", "committedDate": "2020-02-20T09:55:11Z", "message": "vrouter: reload keepalived instead of restart and fix password server issues when add/remove vpc tier\n\nThis fixes few issues below\n(1) when add/remove a vpc tier, the keepalived is restarted on both master and backup VRs, which causes some seconds donwtime of vpc.\n(2) when remove a vpc tier, the password server is not stopped.\n(3) vpc tier is shutdown because no vm is running for 20 minutes, if we start a vm in the vpc tier, it will be implemented. however the guest ip in VPC VRs will be changed , and password server is still running with old guest ip in VRs."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MTgyNDUy", "url": "https://github.com/apache/cloudstack/pull/3898#pullrequestreview-366182452", "createdAt": "2020-02-28T06:28:13Z", "commit": {"oid": "225eb0ee4fdd866ef6e38ed135237c5c9f9db09e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MjY0NDQz", "url": "https://github.com/apache/cloudstack/pull/3898#pullrequestreview-366264443", "createdAt": "2020-02-28T09:34:43Z", "commit": {"oid": "225eb0ee4fdd866ef6e38ed135237c5c9f9db09e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4417, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}