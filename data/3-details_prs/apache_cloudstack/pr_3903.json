{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3NzQ5ODIx", "number": 3903, "title": "VR: Send VM password to all Running VRs in network/vpc", "bodyText": "Description\n\nCurrently, the cloudstack sends VM password only to the first\nrouter in the network even if its the backup and return the result.\nIn some cases the first router will be back up and the second will be master.\nSince password server is not running in backup, when the user resets the password,\nit is sent to the first router which can be backup.\nIn that case, the new password is not stored in the password server and users cant log in with a new password.\nThis change ensures that we send the password to both the routers instead\nof the first router so that a new password is stored in the master router.\n\n\n\n\n\nTypes of changes\n\n\n Breaking change (fix or feature that would cause existing functionality to change)\n New feature (non-breaking change which adds functionality)\n Bug fix (non-breaking change which fixes an issue)\n Enhancement (improves an existing feature and functionality)\n Cleanup (Code refactoring and cleanup, that may add test cases)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?\n\n\n\n1 . Create and isolated network with redundant VR and a VM in it.\n2 . Note down the password of the newly created and try to ssh to it from VR\n3 . Ssh works with the existing password.\n4 . Now reboot the master VR so that it will become BACKUP and the BACKUP will become MASTER\n5 . Now stop the VM and reset it's password.\n6 . Try to login to VM using the new password\nExpected Result:\nSsh should work with new password\nActual result:\nSsh wont work", "createdAt": "2020-02-20T13:17:23Z", "url": "https://github.com/apache/cloudstack/pull/3903", "merged": true, "mergeCommit": {"oid": "abb39a25affbbc6144a1becce252f1a836af0434"}, "closed": true, "closedAt": "2020-02-28T06:30:17Z", "author": {"login": "ravening"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGM2f-gFqTM2MTk5NjE0MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIp7_zgFqTM2NjE4MjcwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxOTk2MTQw", "url": "https://github.com/apache/cloudstack/pull/3903#pullrequestreview-361996140", "createdAt": "2020-02-20T15:28:01Z", "commit": {"oid": "116e7e94e9d1663f29f5ed562a7f201272d6d3d7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMTY2ODkw", "url": "https://github.com/apache/cloudstack/pull/3903#pullrequestreview-362166890", "createdAt": "2020-02-20T19:19:34Z", "commit": {"oid": "116e7e94e9d1663f29f5ed562a7f201272d6d3d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxOToxOTozNVrOFsf_dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxOToxOTozNVrOFsf_dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIwNTgxNA==", "bodyText": "@ravening can you please make both variables private?", "url": "https://github.com/apache/cloudstack/pull/3903#discussion_r382205814", "createdAt": "2020-02-20T19:19:35Z", "author": {"login": "GabrielBrascher"}, "path": "server/src/main/java/com/cloud/network/element/VirtualRouterElement.java", "diffHunk": "@@ -702,18 +702,27 @@ public boolean savePassword(final Network network, final NicProfile nic, final V\n \n         // If any router is running then send save password command otherwise\n         // save the password in DB\n+        boolean savePasswordResult = true;\n+        boolean isVrRunning = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "116e7e94e9d1663f29f5ed562a7f201272d6d3d7"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMjI5NTEz", "url": "https://github.com/apache/cloudstack/pull/3903#pullrequestreview-362229513", "createdAt": "2020-02-20T20:58:33Z", "commit": {"oid": "116e7e94e9d1663f29f5ed562a7f201272d6d3d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMDo1ODozM1rOFsi9ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMDo1ODozM1rOFsi9ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI1NDQ1OQ==", "bodyText": "is ok, but a former colleague scorned me for this once; why the bitwise and (single &), accidental?", "url": "https://github.com/apache/cloudstack/pull/3903#discussion_r382254459", "createdAt": "2020-02-20T20:58:33Z", "author": {"login": "DaanHoogland"}, "path": "server/src/main/java/com/cloud/network/element/VirtualRouterElement.java", "diffHunk": "@@ -702,18 +702,27 @@ public boolean savePassword(final Network network, final NicProfile nic, final V\n \n         // If any router is running then send save password command otherwise\n         // save the password in DB\n+        boolean savePasswordResult = true;\n+        boolean isVrRunning = false;\n         for (final VirtualRouter router : routers) {\n             if (router.getState() == State.Running) {\n                 final boolean result = networkTopology.savePasswordToRouter(network, nic, uservm, router);\n-                if (result) {\n-                    // Explicit password reset, while VM hasn't generated a password yet.\n-                    final UserVmVO userVmVO = _userVmDao.findById(vm.getId());\n-                    userVmVO.setUpdateParameters(false);\n-                    _userVmDao.update(userVmVO.getId(), userVmVO);\n-                }\n-                return result;\n+                isVrRunning = true;\n+                savePasswordResult = savePasswordResult & result;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "116e7e94e9d1663f29f5ed562a7f201272d6d3d7"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd06e689fd11dd0467bea28e5db14965daa15e7f", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/bd06e689fd11dd0467bea28e5db14965daa15e7f", "committedDate": "2020-02-21T10:36:51Z", "message": "Minor change"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "116e7e94e9d1663f29f5ed562a7f201272d6d3d7", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/116e7e94e9d1663f29f5ed562a7f201272d6d3d7", "committedDate": "2020-02-20T13:11:15Z", "message": "Send VM password to MASTER VR in case its the second vr in network\n\nCurrently the cloudstack sends VM password only to the first\nrouter in the network even if its the backup and return the result.\nSince password server is not running in backup, when user resets the password,\nit is sent to first router which can be backup in some case.\nIn that case the new password is not stored and users cant login.\n\nThis change ensures that we send passwrod to both the routers instead\nof the first router so that new password in stored in the master router."}, "afterCommit": {"oid": "bd06e689fd11dd0467bea28e5db14965daa15e7f", "author": {"user": null}, "url": "https://github.com/apache/cloudstack/commit/bd06e689fd11dd0467bea28e5db14965daa15e7f", "committedDate": "2020-02-21T10:36:51Z", "message": "Minor change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMTIyMjk2", "url": "https://github.com/apache/cloudstack/pull/3903#pullrequestreview-363122296", "createdAt": "2020-02-23T21:06:07Z", "commit": {"oid": "bd06e689fd11dd0467bea28e5db14965daa15e7f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMzQzOTkx", "url": "https://github.com/apache/cloudstack/pull/3903#pullrequestreview-363343991", "createdAt": "2020-02-24T12:09:04Z", "commit": {"oid": "bd06e689fd11dd0467bea28e5db14965daa15e7f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "308b214386b77fcfcee356052171f37d82745e42", "author": {"user": {"login": "ravening", "name": "Rakesh"}}, "url": "https://github.com/apache/cloudstack/commit/308b214386b77fcfcee356052171f37d82745e42", "committedDate": "2020-02-26T09:15:32Z", "message": "Return result on failure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NDg2ODIx", "url": "https://github.com/apache/cloudstack/pull/3903#pullrequestreview-365486821", "createdAt": "2020-02-27T08:25:01Z", "commit": {"oid": "308b214386b77fcfcee356052171f37d82745e42"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwODoyNTowMVrOFvI6ZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwODoyNTowMVrOFvI6ZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk3MzQxMw==", "bodyText": "@ravening it seems savePasswordResult  is not needed any more, because it is always true.", "url": "https://github.com/apache/cloudstack/pull/3903#discussion_r384973413", "createdAt": "2020-02-27T08:25:01Z", "author": {"login": "weizhouapache"}, "path": "server/src/main/java/com/cloud/network/element/VirtualRouterElement.java", "diffHunk": "@@ -702,18 +702,32 @@ public boolean savePassword(final Network network, final NicProfile nic, final V\n \n         // If any router is running then send save password command otherwise\n         // save the password in DB\n+        boolean savePasswordResult = true;\n+        boolean isVrRunning = false;\n         for (final VirtualRouter router : routers) {\n             if (router.getState() == State.Running) {\n                 final boolean result = networkTopology.savePasswordToRouter(network, nic, uservm, router);\n-                if (result) {\n-                    // Explicit password reset, while VM hasn't generated a password yet.\n-                    final UserVmVO userVmVO = _userVmDao.findById(vm.getId());\n-                    userVmVO.setUpdateParameters(false);\n-                    _userVmDao.update(userVmVO.getId(), userVmVO);\n+                if (!result) {\n+                    s_logger.error(\"Unable to save password for VM \" + vm.getInstanceName() +\n+                            \" on router \" + router.getInstanceName());\n+                    return false;\n                 }\n-                return result;\n+                isVrRunning = true;\n+                savePasswordResult = savePasswordResult && result;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "308b214386b77fcfcee356052171f37d82745e42"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MTgyNzA2", "url": "https://github.com/apache/cloudstack/pull/3903#pullrequestreview-366182706", "createdAt": "2020-02-28T06:29:07Z", "commit": {"oid": "308b214386b77fcfcee356052171f37d82745e42"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4431, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}