{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1MDEzODc0", "number": 4220, "title": "Fix cpuallocated value in findHostsForMIgration api", "bodyText": "Description\nFixes #4221\nThe findHostsForMigration api displays 0% always for\ncpuallocated field which is wrong\n\n\n\n\n\nTypes of changes\n\n\n Bug fix (non-breaking change which fixes an issue)\n\nScreenshots (if appropriate):\nHow Has This Been Tested?\n\n\n\nTested from cloudmonkey api\nBefore the fix\nlocal) > find hostsformigration virtualmachineid=01f155-fffc-493f-95b8-85a76414 filter=cpuallocated,suitableformigration\n{\n  \"count\": 221,\n  \"host\": [\n    {\n      \"cpuallocated\": \"0%\",\n      \"suitableformigration\": true\n    },\n    {\n      \"cpuallocated\": \"0%\",\n      \"suitableformigration\": true\n    },\n    {\n      \"cpuallocated\": \"0%\",\n      \"suitableformigration\": true\n    },\n\nAfter the fix\n(local) mgt01 > list hosts  virtualmachineid=95b4270f-1354-4703-99cb-a769400b2d30 filter=cpuallocated,suitableformigration,name\n{\n  \"count\": 3,\n  \"host\": [\n    {\n      \"cpuallocated\": \"2.27%\",\n      \"name\": \"node32\",\n      \"suitableformigration\": true\n    },\n    {\n      \"cpuallocated\": \"1.14%\",\n      \"name\": \"node33\",\n      \"suitableformigration\": true\n    }\n  ]\n}", "createdAt": "2020-07-22T10:04:21Z", "url": "https://github.com/apache/cloudstack/pull/4220", "merged": true, "mergeCommit": {"oid": "a529470b16642b77a39a42da6bbc827a3bf08951"}, "closed": true, "closedAt": "2020-08-05T08:32:10Z", "author": {"login": "ravening"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3X2VigH2gAyNDU1MDEzODc0Ojk1MDBkZmE2MjdiZThlZmVhMGFiOTZiZjY2OTE4MDFjOGE1NmIyZTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7gT19gFqTQ2MDUxODg3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9500dfa627be8efea0ab96bf6691801c8a56b2e4", "author": {"user": {"login": "ravening", "name": "Rakesh"}}, "url": "https://github.com/apache/cloudstack/commit/9500dfa627be8efea0ab96bf6691801c8a56b2e4", "committedDate": "2020-07-22T09:59:05Z", "message": "Fix cpuallocated value in findHostsForMIgration api\n\nThe findHostsForMigration api displays 0% always for\ncpuallocated field which is wrong"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMzYyNTYx", "url": "https://github.com/apache/cloudstack/pull/4220#pullrequestreview-453362561", "createdAt": "2020-07-22T14:17:20Z", "commit": {"oid": "9500dfa627be8efea0ab96bf6691801c8a56b2e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNDoxNzoyMVrOG1kjSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNDoxNzoyMVrOG1kjSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgyNjU3MQ==", "bodyText": "I see 100f a couple of times on the code, there is also 100.0f.\nWhat do you think of extracting these magic 100f/100.0f into a constant?\nAnother approach that would be even nicer would be to have these pieces extracted to a method like calculateResourceAllocatedPercentage, and add a few unit test case methods.\npublic String calculateResourceAllocatedPercentage(float resource, float resourceWithOverprovisioning) {\n\t    return decimalFormat.format(((float)resource / resourceWithOverprovisioning * 100f)) + **\"%\"**\n}", "url": "https://github.com/apache/cloudstack/pull/4220#discussion_r458826571", "createdAt": "2020-07-22T14:17:21Z", "author": {"login": "GabrielBrascher"}, "path": "server/src/main/java/com/cloud/api/query/dao/HostJoinDaoImpl.java", "diffHunk": "@@ -330,10 +330,10 @@ public HostForMigrationResponse newHostForMigrationResponse(HostJoinVO host, Enu\n \n                 hostResponse.setHypervisorVersion(host.getHypervisorVersion());\n \n-                Float cpuWithOverprovisioning = new Float(host.getCpus() * host.getSpeed() * ApiDBUtils.getCpuOverprovisioningFactor(host.getClusterId()));\n-                String cpuAlloc = decimalFormat.format(((float)cpu / cpuWithOverprovisioning * 100f)).toString() + \"%\";\n+                float cpuWithOverprovisioning = new Float(host.getCpus() * host.getSpeed() * ApiDBUtils.getCpuOverprovisioningFactor(host.getClusterId()));\n+                String cpuAlloc = decimalFormat.format(((float)cpu / cpuWithOverprovisioning * 100f)) + \"%\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9500dfa627be8efea0ab96bf6691801c8a56b2e4"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7febf17aa8c8ba6403deeb160a4af5f6dda5111c", "author": {"user": {"login": "ravening", "name": "Rakesh"}}, "url": "https://github.com/apache/cloudstack/commit/7febf17aa8c8ba6403deeb160a4af5f6dda5111c", "committedDate": "2020-07-23T08:19:31Z", "message": "Extract to function"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNTE4ODcx", "url": "https://github.com/apache/cloudstack/pull/4220#pullrequestreview-460518871", "createdAt": "2020-08-04T06:06:15Z", "commit": {"oid": "7febf17aa8c8ba6403deeb160a4af5f6dda5111c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3967, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}