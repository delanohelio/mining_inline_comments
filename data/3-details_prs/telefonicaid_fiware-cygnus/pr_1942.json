{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1NDAzMzc3", "number": 1942, "title": "Task/insert upsert transaction", "bodyText": "This PR creates a transaction to upsert-insert data.\nAlso, changes the statement of the insert to build a prepared statement. Notice that the new insert is only performed with the upsert transaction. If the last_data function is disabled, then the isert is performed as usual.", "createdAt": "2020-09-30T10:16:41Z", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1942", "merged": true, "mergeCommit": {"oid": "98fd2f4cc8a4dcac17ebeeba88ffca90584cb673"}, "closed": true, "closedAt": "2020-09-30T14:55:24Z", "author": {"login": "IvanHdzC"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNlJvvgH2gAyNDk1NDAzMzc3OmE2MTk1MDk1Njk4NTZjMDUyY2IyYjQyODI5ZjAzOWMyOTdjZTBiOTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdN-CWgAFqTQ5OTUyMDkwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a619509569856c052cb2b42829f039c297ce0b99", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/a619509569856c052cb2b42829f039c297ce0b99", "committedDate": "2020-09-29T09:55:23Z", "message": "refactor sql utils class to build upsert transaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11ba0e3db64ce1ac873f8fc3370f87b4b3172829", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/11ba0e3db64ce1ac873f8fc3370f87b4b3172829", "committedDate": "2020-09-29T11:10:15Z", "message": "create insert query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66d6fce6f2e0b5923d94acd1ffd6e4cf55e5457e", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/66d6fce6f2e0b5923d94acd1ffd6e4cf55e5457e", "committedDate": "2020-09-30T09:50:53Z", "message": "create upsert transaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ac4a98495fe411117a815b8564337a168224dba", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/7ac4a98495fe411117a815b8564337a168224dba", "committedDate": "2020-09-30T09:51:34Z", "message": "update sinks to use upsert transaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bb60e7e9f523de257bf33a89af36fa0e8df76a0", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/8bb60e7e9f523de257bf33a89af36fa0e8df76a0", "committedDate": "2020-09-30T10:01:52Z", "message": "update insert query log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adc18b9168078a5418a6f3c9b4f144c95c5f8e91", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/adc18b9168078a5418a6f3c9b4f144c95c5f8e91", "committedDate": "2020-09-30T10:03:55Z", "message": "add CNR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69ac81959b1eb458f81c66a956e7affabcdcd843", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/69ac81959b1eb458f81c66a956e7affabcdcd843", "committedDate": "2020-09-30T10:12:10Z", "message": "update docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5MzA5NjEx", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1942#pullrequestreview-499309611", "createdAt": "2020-09-30T10:54:42Z", "commit": {"oid": "69ac81959b1eb458f81c66a956e7affabcdcd843"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMDo1NDo0MlrOHaYCXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMDo1NDo0MlrOHaYCXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQxODg0Ng==", "bodyText": "upsertQuery should be printed, not only  connection", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1942#discussion_r497418846", "createdAt": "2020-09-30T10:54:42Z", "author": {"login": "AlvaroVega"}, "path": "cygnus-common/src/main/java/com/telefonica/iot/cygnus/backends/sql/SQLBackendImpl.java", "diffHunk": "@@ -516,38 +541,91 @@ public void createErrorTable(String destination)\n     } // createErrorTable\n \n     /**\n-     * Gets an SQL connection from the driver\n+     * Upsert transaction.\n      *\n-     * @param destination the destination\n-     * @return the sql connection\n+     * @param aggregation     the aggregation\n+     * @param lastData        the last data\n+     * @param destination     the destination\n+     * @param tableName       the table name\n+     * @param tableSuffix     the table suffix\n+     * @param uniqueKey       the unique key\n+     * @param timestampKey    the timestamp key\n+     * @param timestampFormat the timestamp format\n+     * @param attrNativeTypes the attr native types\n      * @throws CygnusPersistenceError the cygnus persistence error\n+     * @throws CygnusBadContextData   the cygnus bad context data\n      * @throws CygnusRuntimeError     the cygnus runtime error\n-     */\n-\n-    public Connection getSQLConnection (String destination) throws CygnusPersistenceError, CygnusRuntimeError {\n-        return driver.getConnection(destination);\n-    }\n-\n-    /**\n-     * Execute prepared statement.\n-     *\n-     * @param preparedStatement the prepared statement\n-     * @throws SQLException           the sql exception\n      * @throws CygnusPersistenceError the cygnus persistence error\n-     * @throws CygnusRuntimeError     the cygnus runtime error\n-     * @throws CygnusBadContextData   the cygnus bad context data\n      */\n+    public void upsertTransaction (LinkedHashMap<String, ArrayList<JsonElement>> aggregation,\n+                                   LinkedHashMap<String, ArrayList<JsonElement>> lastData,\n+                                   String destination,\n+                                   String tableName,\n+                                   String tableSuffix,\n+                                   String uniqueKey,\n+                                   String timestampKey,\n+                                   String timestampFormat,\n+                                   boolean attrNativeTypes) throws CygnusPersistenceError, CygnusBadContextData, CygnusRuntimeError,  CygnusPersistenceError{\n+\n+        Connection connection = null;\n+        PreparedStatement upsertPreparedStatement = null;\n+        PreparedStatement insertPreparedStatement = null;\n+\n+        int insertedRows[];\n \n-    public void executePreparedStatement (PreparedStatement preparedStatement) throws SQLException, CygnusPersistenceError, CygnusRuntimeError, CygnusBadContextData {\n         try {\n-            preparedStatement.executeBatch();\n+\n+            connection = driver.getConnection(destination);\n+            connection.setAutoCommit(false);\n+\n+            String insertQuery = SQLQueryUtils.sqlInsertQuery(aggregation,\n+                    tableName,\n+                    sqlInstance,\n+                    destination).toString();\n+\n+            PreparedStatement insertStatement = null;\n+            insertStatement = connection.prepareStatement(insertQuery);\n+            insertPreparedStatement = SQLQueryUtils.addJsonValues(insertStatement, aggregation, attrNativeTypes);\n+            insertedRows = insertPreparedStatement.executeBatch();\n+\n+            String upsertQuery = SQLQueryUtils.sqlUpsertQuery(aggregation,\n+                    lastData,\n+                    tableName,\n+                    tableSuffix,\n+                    uniqueKey,\n+                    timestampKey,\n+                    timestampFormat,\n+                    sqlInstance,\n+                    destination).toString();\n+\n+            PreparedStatement upsertStatement = null;\n+            upsertStatement = connection.prepareStatement(upsertQuery);\n+            upsertPreparedStatement = SQLQueryUtils.addJsonValues(upsertStatement, lastData, attrNativeTypes);\n+            upsertPreparedStatement.executeBatch();\n+\n+            connection.commit();\n+            LOGGER.info(\"Finished transaction: \\n\" + upsertPreparedStatement + \"\\n Inserted ROWS: \" + insertedRows.length + \" \" + upsertQuery);\n+\n         } catch (SQLTimeoutException e) {\n-            throw new CygnusPersistenceError(sqlInstance.toUpperCase() + \" Data insertion error. Query: `\" + preparedStatement, \"SQLTimeoutException\", e.getMessage());\n+            cygnusSQLRollback(connection);\n+            throw new CygnusPersistenceError(sqlInstance.toUpperCase() + \" \" + e.getNextException() + \" Data insertion error. Query: `\" + connection, \"SQLTimeoutException\", e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69ac81959b1eb458f81c66a956e7affabcdcd843"}, "originalPosition": 161}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5MzEwMTIw", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1942#pullrequestreview-499310120", "createdAt": "2020-09-30T10:55:25Z", "commit": {"oid": "69ac81959b1eb458f81c66a956e7affabcdcd843"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMDo1NToyNlrOHaYD5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMDo1NToyNlrOHaYD5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQxOTIzNw==", "bodyText": "the same upper comment: upsertQuery should be printed, not only connection", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1942#discussion_r497419237", "createdAt": "2020-09-30T10:55:26Z", "author": {"login": "AlvaroVega"}, "path": "cygnus-common/src/main/java/com/telefonica/iot/cygnus/backends/sql/SQLBackendImpl.java", "diffHunk": "@@ -516,38 +541,91 @@ public void createErrorTable(String destination)\n     } // createErrorTable\n \n     /**\n-     * Gets an SQL connection from the driver\n+     * Upsert transaction.\n      *\n-     * @param destination the destination\n-     * @return the sql connection\n+     * @param aggregation     the aggregation\n+     * @param lastData        the last data\n+     * @param destination     the destination\n+     * @param tableName       the table name\n+     * @param tableSuffix     the table suffix\n+     * @param uniqueKey       the unique key\n+     * @param timestampKey    the timestamp key\n+     * @param timestampFormat the timestamp format\n+     * @param attrNativeTypes the attr native types\n      * @throws CygnusPersistenceError the cygnus persistence error\n+     * @throws CygnusBadContextData   the cygnus bad context data\n      * @throws CygnusRuntimeError     the cygnus runtime error\n-     */\n-\n-    public Connection getSQLConnection (String destination) throws CygnusPersistenceError, CygnusRuntimeError {\n-        return driver.getConnection(destination);\n-    }\n-\n-    /**\n-     * Execute prepared statement.\n-     *\n-     * @param preparedStatement the prepared statement\n-     * @throws SQLException           the sql exception\n      * @throws CygnusPersistenceError the cygnus persistence error\n-     * @throws CygnusRuntimeError     the cygnus runtime error\n-     * @throws CygnusBadContextData   the cygnus bad context data\n      */\n+    public void upsertTransaction (LinkedHashMap<String, ArrayList<JsonElement>> aggregation,\n+                                   LinkedHashMap<String, ArrayList<JsonElement>> lastData,\n+                                   String destination,\n+                                   String tableName,\n+                                   String tableSuffix,\n+                                   String uniqueKey,\n+                                   String timestampKey,\n+                                   String timestampFormat,\n+                                   boolean attrNativeTypes) throws CygnusPersistenceError, CygnusBadContextData, CygnusRuntimeError,  CygnusPersistenceError{\n+\n+        Connection connection = null;\n+        PreparedStatement upsertPreparedStatement = null;\n+        PreparedStatement insertPreparedStatement = null;\n+\n+        int insertedRows[];\n \n-    public void executePreparedStatement (PreparedStatement preparedStatement) throws SQLException, CygnusPersistenceError, CygnusRuntimeError, CygnusBadContextData {\n         try {\n-            preparedStatement.executeBatch();\n+\n+            connection = driver.getConnection(destination);\n+            connection.setAutoCommit(false);\n+\n+            String insertQuery = SQLQueryUtils.sqlInsertQuery(aggregation,\n+                    tableName,\n+                    sqlInstance,\n+                    destination).toString();\n+\n+            PreparedStatement insertStatement = null;\n+            insertStatement = connection.prepareStatement(insertQuery);\n+            insertPreparedStatement = SQLQueryUtils.addJsonValues(insertStatement, aggregation, attrNativeTypes);\n+            insertedRows = insertPreparedStatement.executeBatch();\n+\n+            String upsertQuery = SQLQueryUtils.sqlUpsertQuery(aggregation,\n+                    lastData,\n+                    tableName,\n+                    tableSuffix,\n+                    uniqueKey,\n+                    timestampKey,\n+                    timestampFormat,\n+                    sqlInstance,\n+                    destination).toString();\n+\n+            PreparedStatement upsertStatement = null;\n+            upsertStatement = connection.prepareStatement(upsertQuery);\n+            upsertPreparedStatement = SQLQueryUtils.addJsonValues(upsertStatement, lastData, attrNativeTypes);\n+            upsertPreparedStatement.executeBatch();\n+\n+            connection.commit();\n+            LOGGER.info(\"Finished transaction: \\n\" + upsertPreparedStatement + \"\\n Inserted ROWS: \" + insertedRows.length + \" \" + upsertQuery);\n+\n         } catch (SQLTimeoutException e) {\n-            throw new CygnusPersistenceError(sqlInstance.toUpperCase() + \" Data insertion error. Query: `\" + preparedStatement, \"SQLTimeoutException\", e.getMessage());\n+            cygnusSQLRollback(connection);\n+            throw new CygnusPersistenceError(sqlInstance.toUpperCase() + \" \" + e.getNextException() + \" Data insertion error. Query: `\" + connection, \"SQLTimeoutException\", e.getMessage());\n         } catch (SQLException e) {\n-            throw new CygnusBadContextData(sqlInstance.toUpperCase() + \" Data insertion error. Query: `\" + preparedStatement, \"SQLException\", e.getMessage());\n+            cygnusSQLRollback(connection);\n+            throw new CygnusBadContextData(sqlInstance.toUpperCase() + \" \" + e.getNextException() + \" Data insertion error. Query: `\" + connection, \"SQLException\", e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69ac81959b1eb458f81c66a956e7affabcdcd843"}, "originalPosition": 165}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5bbc3a25e64b6975861582cfa295ce1690fc069", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/c5bbc3a25e64b6975861582cfa295ce1690fc069", "committedDate": "2020-09-30T11:37:09Z", "message": "update insert query log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NTA5MzU1", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1942#pullrequestreview-499509355", "createdAt": "2020-09-30T14:44:00Z", "commit": {"oid": "c5bbc3a25e64b6975861582cfa295ce1690fc069"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NTIwOTAz", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1942#pullrequestreview-499520903", "createdAt": "2020-09-30T14:54:56Z", "commit": {"oid": "c5bbc3a25e64b6975861582cfa295ce1690fc069"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3845, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}