{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3ODYwNDY5", "number": 1944, "title": "Task/insert upsert transaction", "bodyText": "This PR solves issues #1806 and  #1936 for MySQL sink.", "createdAt": "2020-10-05T13:36:30Z", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1944", "merged": true, "mergeCommit": {"oid": "29e1d95fe483e748ada52656f1b2783460c609f5"}, "closed": true, "closedAt": "2020-10-06T09:03:49Z", "author": {"login": "IvanHdzC"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdONxlZAH2gAyNDk3ODYwNDY5OjBjZjljNjViMmQ4ODlmNTRiNDFkMzUzNWEzNGI2ZmEwZDdhY2YxZDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPna28AFqTUwMjI3OTkyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0cf9c65b2d889f54b41d3535a34b6fa0d7acf1d4", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/0cf9c65b2d889f54b41d3535a34b6fa0d7acf1d4", "committedDate": "2020-10-01T09:15:06Z", "message": "code cleanning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4006a1f2dc1eaf1a6a91dc7ac8d8df40b153c3d", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/b4006a1f2dc1eaf1a6a91dc7ac8d8df40b153c3d", "committedDate": "2020-10-01T09:15:30Z", "message": "Merge branch 'master' into task/insert_upsert_transaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a99f7ee20c34275b220e49e204a325d919cd899", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/2a99f7ee20c34275b220e49e204a325d919cd899", "committedDate": "2020-10-01T11:37:44Z", "message": "add insert statement for mysql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed5afc75b52a0e3deceb08f041c6bb6e2d37450d", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/ed5afc75b52a0e3deceb08f041c6bb6e2d37450d", "committedDate": "2020-10-02T09:53:24Z", "message": "add upsert function and mysql upsert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c39dfe037866667673f52a6935285671722e818", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/3c39dfe037866667673f52a6935285671722e818", "committedDate": "2020-10-02T09:55:21Z", "message": "update sink to use upsert transaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "869147360d88020fce306568730a16aec99f1027", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/869147360d88020fce306568730a16aec99f1027", "committedDate": "2020-10-02T11:47:07Z", "message": "update mysql upsert query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43c94d10e636aeac0020d6ddf1b8f72e5c62570c", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/43c94d10e636aeac0020d6ddf1b8f72e5c62570c", "committedDate": "2020-10-02T11:47:20Z", "message": "update insert query log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c4d43656a720abb93fbee588f7badb5d4b30dc7", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/2c4d43656a720abb93fbee588f7badb5d4b30dc7", "committedDate": "2020-10-05T08:20:10Z", "message": "update tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80c443fe6321d0f14bf706cf40186a9c30b7d28a", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/80c443fe6321d0f14bf706cf40186a9c30b7d28a", "committedDate": "2020-10-05T09:55:33Z", "message": "add CNR entry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8923a472d4a9f011e9fa4bd764276056b035ecb0", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/8923a472d4a9f011e9fa4bd764276056b035ecb0", "committedDate": "2020-10-05T13:33:56Z", "message": "update docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMDY3MzI4", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1944#pullrequestreview-502067328", "createdAt": "2020-10-05T13:41:09Z", "commit": {"oid": "8923a472d4a9f011e9fa4bd764276056b035ecb0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMzo0MTowOVrOHcdl1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMzo0MTowOVrOHcdl1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYwNjk5Ng==", "bodyText": "Maybe both lines could be joined:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            [cygnus-ngsi, cygnus-common][MySQLSQLSink] Use of the upsert transaction (#1806, #1936)\n          \n          \n            \n            [cygnus-ngsi, cygnus-common][PosgtgreSQLSink, PostgisSink] Create upsert transaction (#1806, #1936)\n          \n          \n            \n            [cygnus-ngsi, cygnus-common][PosgtgreSQLSink, PostgisSink, MySQLSQLSink] Create upsert transaction (#1806, #1936)", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1944#discussion_r499606996", "createdAt": "2020-10-05T13:41:09Z", "author": {"login": "fgalan"}, "path": "CHANGES_NEXT_RELEASE", "diffHunk": "@@ -1,3 +1,4 @@\n+[cygnus-ngsi, cygnus-common][MySQLSQLSink] Use of the upsert transaction (#1806, #1936)\n [cygnus-ngsi, cygnus-common][PosgtgreSQLSink, PostgisSink] Create upsert transaction (#1806, #1936)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8923a472d4a9f011e9fa4bd764276056b035ecb0"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "803356bc6288c2273ffb39529151d556fb54ba58", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/803356bc6288c2273ffb39529151d556fb54ba58", "committedDate": "2020-10-05T13:45:23Z", "message": "Update CHANGES_NEXT_RELEASE\n\nCo-authored-by: Ferm\u00edn Gal\u00e1n M\u00e1rquez <fgalan@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMDcyOTE0", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1944#pullrequestreview-502072914", "createdAt": "2020-10-05T13:46:52Z", "commit": {"oid": "803356bc6288c2273ffb39529151d556fb54ba58"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMzo0Njo1MlrOHcd1EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMzo0Njo1MlrOHcd1EA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYxMDg5Ng==", "bodyText": "Should last_data_function.md linked from mysql sink documentation (as Postgresql/PostGIS sink doc I think do)?", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1944#discussion_r499610896", "createdAt": "2020-10-05T13:46:52Z", "author": {"login": "fgalan"}, "path": "doc/cygnus-ngsi/flume_extensions_catalogue/last_data_function.md", "diffHunk": "@@ -97,8 +97,12 @@ All this process happens per each NGSIEvent aggregated.\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "803356bc6288c2273ffb39529151d556fb54ba58"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a6ef257335bcb2c419b38e841d7a683dfeabe76", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/3a6ef257335bcb2c419b38e841d7a683dfeabe76", "committedDate": "2020-10-05T14:02:07Z", "message": "update sink docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMDkwODk5", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1944#pullrequestreview-502090899", "createdAt": "2020-10-05T14:05:10Z", "commit": {"oid": "803356bc6288c2273ffb39529151d556fb54ba58"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDowNToxMFrOHceoGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDowNToxMFrOHceoGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYyMzk2Mw==", "bodyText": "not sure if indentation is fine.", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1944#discussion_r499623963", "createdAt": "2020-10-05T14:05:10Z", "author": {"login": "AlvaroVega"}, "path": "cygnus-common/src/main/java/com/telefonica/iot/cygnus/backends/sql/SQLQueryUtils.java", "diffHunk": "@@ -52,52 +52,44 @@\n      * @param timestampFormat the timestamp format\n      * @param sqlInstance     the sql instance\n      * @param destination     the destination\n-     * @param connection      the connection\n-     * @param attrNativeTypes the attr native types\n-     * @return the prepared statement\n-     * @throws SQLException the sql exception\n+     * @return the string buffer\n      */\n-    public static PreparedStatement upsertStatement (LinkedHashMap<String, ArrayList<JsonElement>> aggregation,\n-                                            LinkedHashMap<String, ArrayList<JsonElement>> lastData,\n-                                            String tableName,\n-                                            String tableSuffix,\n-                                            String uniqueKey,\n-                                            String timestampKey,\n-                                            String timestampFormat,\n-                                            String sqlInstance,\n-                                            String destination,\n-                                            Connection connection,\n-                                            boolean attrNativeTypes) throws SQLException {\n-\n-\n-        String query = sqlUpsertQuery(aggregation,\n-                lastData,\n-                tableName,\n-                tableSuffix,\n-                uniqueKey,\n-                timestampKey,\n-                timestampFormat,\n-                sqlInstance,\n-                destination).toString();\n+    protected static StringBuffer sqlUpsertQuery(LinkedHashMap<String, ArrayList<JsonElement>> aggregation,\n+                                                        LinkedHashMap<String, ArrayList<JsonElement>> lastData,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "803356bc6288c2273ffb39529151d556fb54ba58"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMDkyMjM1", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1944#pullrequestreview-502092235", "createdAt": "2020-10-05T14:06:33Z", "commit": {"oid": "803356bc6288c2273ffb39529151d556fb54ba58"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDowNjozM1rOHcerxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDowNjozM1rOHcerxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYyNDkwMg==", "bodyText": "Not sure if indentation is right", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1944#discussion_r499624902", "createdAt": "2020-10-05T14:06:33Z", "author": {"login": "AlvaroVega"}, "path": "cygnus-common/src/main/java/com/telefonica/iot/cygnus/backends/sql/SQLQueryUtils.java", "diffHunk": "@@ -140,19 +132,114 @@ protected static StringBuffer sqlUpsertQuery(LinkedHashMap<String, ArrayList<Jso\n                 sqlInstance,\n                 destination);\n \n-        if (sqlInstance.equals(\"postgresql\")) {\n-            query.append(insertQuery).\n-                    append(\"ON CONFLICT \").append(\"(\").append(uniqueKey).append(\") \").\n-                    append(\"DO \").\n-                    append(\"UPDATE SET \").append(updateSet).append(\" \").\n-                    append(\"WHERE \").append(postgisDestination).append(\".\").append(uniqueKey).append(\"=\").append(postgisTempReference).append(\".\").append(uniqueKey).append(\" \").\n-                    append(\"AND \").append(\"to_timestamp(\").append(postgisDestination).append(\".\").append(timestampKey).append(\", '\").append(timestampFormat).append(\"') \").\n-                    append(\"< \").append(\"to_timestamp(\").append(postgisTempReference).append(\".\").append(timestampKey).append(\", '\").append(timestampFormat).append(\"')\");\n+        query.append(insertQuery).\n+                append(\"ON CONFLICT \").append(\"(\").append(uniqueKey).append(\") \").\n+                append(\"DO \").\n+                append(\"UPDATE SET \").append(updateSet).append(\" \").\n+                append(\"WHERE \").append(postgisDestination).append(\".\").append(uniqueKey).append(\"=\").append(postgisTempReference).append(\".\").append(uniqueKey).append(\" \").\n+                append(\"AND \").append(\"to_timestamp(\").append(postgisDestination).append(\".\").append(timestampKey).append(\", '\").append(timestampFormat).append(\"') \").\n+                append(\"< \").append(\"to_timestamp(\").append(postgisTempReference).append(\".\").append(timestampKey).append(\", '\").append(timestampFormat).append(\"')\");\n+\n+        LOGGER.debug(\"[NGSISQLUtils.sqlUpsertQuery] Preparing Upsert query: \" + query.toString());\n+        return query;\n+    }\n+\n+    /**\n+     * Sql upsert query for MySQL string buffer.\n+     *\n+     * @param aggregation     the aggregation\n+     * @param lastData        the last data\n+     * @param tableName       the table name\n+     * @param tableSuffix     the table suffix\n+     * @param uniqueKey       the unique key\n+     * @param timestampKey    the timestamp key\n+     * @param timestampFormat the timestamp format\n+     * @param sqlInstance     the sql instance\n+     * @param destination     the destination\n+     * @return the string buffer\n+     */\n+    protected static StringBuffer mySqlUpsertQuery(LinkedHashMap<String, ArrayList<JsonElement>> aggregation,\n+                                                        LinkedHashMap<String, ArrayList<JsonElement>> lastData,\n+                                                        String tableName,\n+                                                        String tableSuffix,\n+                                                        String uniqueKey,\n+                                                        String timestampKey,\n+                                                        String timestampFormat,\n+                                                        String sqlInstance,\n+                                                        String destination) {\n+\n+        StringBuffer updateSet = new StringBuffer();\n+        StringBuffer query = new StringBuffer();\n+        StringBuffer dateKeyUpdate = new StringBuffer();\n+        boolean first = true;\n+\n+        for (String key : lastData.keySet()) {\n+            if (!key.equals(timestampKey)) {\n+                if (!key.equals(uniqueKey) && first) {\n+                    first = false;\n+                } else if (!key.equals(uniqueKey)) {\n+                    updateSet.append(\", \");\n+                }\n+                if (!key.equals(uniqueKey)) {\n+                    updateSet.append(mySQLUpdateRecordQuery(key, uniqueKey, timestampKey, timestampFormat));\n+                }\n+            } else {\n+                dateKeyUpdate.append(mySQLUpdateRecordQuery(key, uniqueKey, timestampKey, timestampFormat));\n+            }\n+        }\n+        // The key that corresponds to the timestampKey must be updated at the end, if it is updated before any other key.\n+        // The subsecuent timestamp validations will be allways false, because the date would already be updated.\n+        if (first) {\n+            updateSet.append(dateKeyUpdate);\n+        } else {\n+            updateSet.append(\", \").append(dateKeyUpdate);\n         }\n+\n+        StringBuffer insertQuery = sqlInsertQuery(lastData,\n+                tableName.concat(tableSuffix),\n+                sqlInstance,\n+                destination);\n+\n+        query.append(insertQuery).\n+                append(\"ON DUPLICATE KEY \").\n+                append(\"UPDATE \").append(updateSet);\n+\n         LOGGER.debug(\"[NGSISQLUtils.sqlUpsertQuery] Preparing Upsert query: \" + query.toString());\n         return query;\n     }\n \n+    /**\n+     * Creates a update statement for an upsert query\n+     *\n+     * @param key     the table suffix\n+     * @param uniqueKey       the unique key\n+     * @param timestampKey    the timestamp key\n+     * @param timestampFormat the timestamp format\n+     * @return the string buffer like the following one\n+     * recvTime=IF((entityId=VALUES(entityId)) AND (STR_TO_DATE(recvTime, '%Y-%m-%d %H:%i:%s.%f') < (STR_TO_DATE(VALUES(recvTime), '%Y-%m-%d %H:%i:%s.%f'))), VALUES(recvTime), recvTime)\n+     */\n+\n+    protected static StringBuffer mySQLUpdateRecordQuery(String key,\n+                                                       String uniqueKey,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "803356bc6288c2273ffb39529151d556fb54ba58"}, "originalPosition": 223}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMDkzNzA0", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1944#pullrequestreview-502093704", "createdAt": "2020-10-05T14:08:04Z", "commit": {"oid": "3a6ef257335bcb2c419b38e841d7a683dfeabe76"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDowODowNFrOHcevvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDowODowNFrOHcevvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTYyNTkxOA==", "bodyText": "Should this new dependence be added to pom.xml ?", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1944#discussion_r499625918", "createdAt": "2020-10-05T14:08:04Z", "author": {"login": "AlvaroVega"}, "path": "cygnus-common/src/test/java/com/telefonica/iot/cygnus/backends/sql/SQLQueryUtilsTest.java", "diffHunk": "@@ -18,9 +18,9 @@\n \n package com.telefonica.iot.cygnus.backends.sql;\n \n+import com.amazonaws.services.dynamodbv2.xspec.L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a6ef257335bcb2c419b38e841d7a683dfeabe76"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0aa8847b5596ace1a4bf45340f279f7aa8e90e0", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/e0aa8847b5596ace1a4bf45340f279f7aa8e90e0", "committedDate": "2020-10-05T14:23:04Z", "message": "indentation fixes and remove unused dependencies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1fc9bf8fa00baec03b7aaba267b440468a6ce71", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/e1fc9bf8fa00baec03b7aaba267b440468a6ce71", "committedDate": "2020-10-05T14:23:38Z", "message": "update readme docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMTEzMDQz", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1944#pullrequestreview-502113043", "createdAt": "2020-10-05T14:27:13Z", "commit": {"oid": "e1fc9bf8fa00baec03b7aaba267b440468a6ce71"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMjc5OTI4", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1944#pullrequestreview-502279928", "createdAt": "2020-10-05T17:41:44Z", "commit": {"oid": "e1fc9bf8fa00baec03b7aaba267b440468a6ce71"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3791, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}