{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyNDMyNzky", "number": 1934, "title": "Task/sql upsert (for postgis)", "bodyText": "This PR is related to issue #1806.\nThis solution applies to PostgreSQL.", "createdAt": "2020-09-24T13:05:33Z", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934", "merged": true, "mergeCommit": {"oid": "2e783f6a62a20308994001cc1ddba4987e7d8d51"}, "closed": true, "closedAt": "2020-09-28T14:54:50Z", "author": {"login": "IvanHdzC"}, "timelineItems": {"totalCount": 37, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLWoNbAH2gAyNDkyNDMyNzkyOjdhNzIzY2FlN2Y3OTkwNmY1MmYyMzYwYTQxYTY3NjNmZTMxZjBlMzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNUTBqAH2gAyNDkyNDMyNzkyOjg0ZWNkODExMzNlMzY5YzYyYWE2ZDhlYjI5YThkYTVmNzNiNjVkNDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7a723cae7f79906f52f2360a41a6763fe31f0e30", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/7a723cae7f79906f52f2360a41a6763fe31f0e30", "committedDate": "2020-09-22T11:52:14Z", "message": "squash! add flag to enable last value"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bfa57726613e97ae83ac694dff665dcc9d79c4b", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/0bfa57726613e97ae83ac694dff665dcc9d79c4b", "committedDate": "2020-09-22T11:52:50Z", "message": "disassemble date parser function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67198a6da54b5bc8a12e33cb36671dc7cfd9f9f4", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/67198a6da54b5bc8a12e33cb36671dc7cfd9f9f4", "committedDate": "2020-09-22T11:53:20Z", "message": "process last data collection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76fc9a95d5f9dad36725984dccedf3ea36cf5957", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/76fc9a95d5f9dad36725984dccedf3ea36cf5957", "committedDate": "2020-09-22T14:46:39Z", "message": "update last value algorithm"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d64b96a997de16bf7c9d32c8ef3a57d8434f7238", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/d64b96a997de16bf7c9d32c8ef3a57d8434f7238", "committedDate": "2020-09-23T10:21:39Z", "message": "rename last data function flag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "479cea3a80cb2438f789fec89a1078b2c38b65de", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/479cea3a80cb2438f789fec89a1078b2c38b65de", "committedDate": "2020-09-23T10:21:59Z", "message": "update javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0b5320342ff6be31ba6011b0fe8fe046b4ea4f2", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/f0b5320342ff6be31ba6011b0fe8fe046b4ea4f2", "committedDate": "2020-09-23T10:22:25Z", "message": "add getconnection function for SQL driver"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1412e9173fd3da5bab1e0e5e846fdedfb7fb1c75", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/1412e9173fd3da5bab1e0e5e846fdedfb7fb1c75", "committedDate": "2020-09-23T10:23:29Z", "message": "add sql utils class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80428cfe78d9d3aec529e799d128d774569ab4a8", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/80428cfe78d9d3aec529e799d128d774569ab4a8", "committedDate": "2020-09-23T10:50:58Z", "message": "String optimization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d50d6ffc5438e1bdee232e8a15e5d52d3c80cf14", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/d50d6ffc5438e1bdee232e8a15e5d52d3c80cf14", "committedDate": "2020-09-23T11:09:47Z", "message": "create upsertStatement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44269f9f2546ad1602e4b0851afdf6e1dc3e59c6", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/44269f9f2546ad1602e4b0851afdf6e1dc3e59c6", "committedDate": "2020-09-23T11:21:18Z", "message": "create execute statement method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72c66a8304a6cdca887af805dddaf1f338015a85", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/72c66a8304a6cdca887af805dddaf1f338015a85", "committedDate": "2020-09-23T15:33:32Z", "message": "query fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c40e6d12bae880f967c9c58c8e56a47e34edbc20", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/c40e6d12bae880f967c9c58c8e56a47e34edbc20", "committedDate": "2020-09-23T15:34:59Z", "message": "add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c80d1d812ee8d5294f203f7b29d16c78c403fc7", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/4c80d1d812ee8d5294f203f7b29d16c78c403fc7", "committedDate": "2020-09-24T08:01:26Z", "message": "logging and cleanning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f6293bd25e42429ab6a99262c5025893366ea7f", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/0f6293bd25e42429ab6a99262c5025893366ea7f", "committedDate": "2020-09-24T08:02:04Z", "message": "execute upsert when enabled and not row aggregation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "691d45132813b3d6080424ca0e9de20296dc43b8", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/691d45132813b3d6080424ca0e9de20296dc43b8", "committedDate": "2020-09-24T08:25:50Z", "message": "add validations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50a66f87dddba0860d9b624e49ab77dc39752deb", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/50a66f87dddba0860d9b624e49ab77dc39752deb", "committedDate": "2020-09-24T09:13:15Z", "message": "timestamp formating optimization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e43ba0bf01cfa34781631878c43878b8b05382a2", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/e43ba0bf01cfa34781631878c43878b8b05382a2", "committedDate": "2020-09-24T09:23:19Z", "message": "add last data function to postgresql sink"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dda112ae28d07d8b489c723c8a5b30a8a3ec8f9", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/2dda112ae28d07d8b489c723c8a5b30a8a3ec8f9", "committedDate": "2020-09-24T11:29:01Z", "message": "add last data documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4663202c589d60f06723e968c8e35d6718a2375b", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/4663202c589d60f06723e968c8e35d6718a2375b", "committedDate": "2020-09-24T11:46:57Z", "message": "add last data test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4ad42552ed94ceb38bf060aba4eae2a7942d9bb", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/c4ad42552ed94ceb38bf060aba4eae2a7942d9bb", "committedDate": "2020-09-24T13:01:47Z", "message": "update docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c74ba93bbe93515cd3c65e2bbcd971e0316c7bf", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/6c74ba93bbe93515cd3c65e2bbcd971e0316c7bf", "committedDate": "2020-09-24T13:06:58Z", "message": "add java doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "714d1b454687b6b096b1dd83fe6837ecdf9e43b8", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/714d1b454687b6b096b1dd83fe6837ecdf9e43b8", "committedDate": "2020-09-24T13:07:55Z", "message": "Merge branch 'master' into task/sql_upsert"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NjEyMDAx", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#pullrequestreview-495612001", "createdAt": "2020-09-24T14:07:26Z", "commit": {"oid": "714d1b454687b6b096b1dd83fe6837ecdf9e43b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNDowNzoyNlrOHXcsww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNDowNzoyNlrOHXcsww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM0OTUwNw==", "bodyText": "CNR entry corresponding to this PR should be added.", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#discussion_r494349507", "createdAt": "2020-09-24T14:07:26Z", "author": {"login": "fgalan"}, "path": "cygnus-common/src/main/java/com/telefonica/iot/cygnus/backends/sql/SQLBackendImpl.java", "diffHunk": "@@ -38,6 +38,9 @@\n import java.util.Date;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "714d1b454687b6b096b1dd83fe6837ecdf9e43b8"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NjEzNjkw", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#pullrequestreview-495613690", "createdAt": "2020-09-24T14:09:04Z", "commit": {"oid": "714d1b454687b6b096b1dd83fe6837ecdf9e43b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNDowOTowNFrOHXcxKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNDowOTowNFrOHXcxKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM1MDYzMg==", "bodyText": "Maybe an explicit list of which sinks supporting this feature should be included.", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#discussion_r494350632", "createdAt": "2020-09-24T14:09:04Z", "author": {"login": "fgalan"}, "path": "doc/cygnus-ngsi/flume_extensions_catalogue/last_data_function.md", "diffHunk": "@@ -0,0 +1,161 @@\n+# Last Data functionality.\n+\n+Cygnus is capable to perform an `upsert` operation on given SQL Sinks.  This Operation doesn't overrides the usual inserts on the usual way.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "714d1b454687b6b096b1dd83fe6837ecdf9e43b8"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NjE1NTQ4", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#pullrequestreview-495615548", "createdAt": "2020-09-24T14:10:52Z", "commit": {"oid": "714d1b454687b6b096b1dd83fe6837ecdf9e43b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNDoxMDo1MlrOHXc2mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNDoxMDo1MlrOHXc2mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM1MjAyNg==", "bodyText": "Nice and comprehensive description of the functionality :)\nHowever, let's try to avoid having a \"orphan\" documention. In particular:\n\nInclude a link to it in the corresponding .md indexes files\nInclude it in mkdocs.yml", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#discussion_r494352026", "createdAt": "2020-09-24T14:10:52Z", "author": {"login": "fgalan"}, "path": "doc/cygnus-ngsi/flume_extensions_catalogue/last_data_function.md", "diffHunk": "@@ -0,0 +1,161 @@\n+# Last Data functionality.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "714d1b454687b6b096b1dd83fe6837ecdf9e43b8"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "236b96219af56ca45195def0feafa4f411677677", "author": {"user": {"login": "AlvaroVega", "name": "Alvaro Vega"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/236b96219af56ca45195def0feafa4f411677677", "committedDate": "2020-09-24T14:56:14Z", "message": "Update NGSIGenericColumnAggregator.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "155a1ab4d2f52093e588f85d399ec32690ad4402", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/155a1ab4d2f52093e588f85d399ec32690ad4402", "committedDate": "2020-09-24T15:00:37Z", "message": "add CNR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5dcf5bfdd5c0bc07ba58850025f4902c32acc756", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/5dcf5bfdd5c0bc07ba58850025f4902c32acc756", "committedDate": "2020-09-24T15:00:47Z", "message": "Merge branch 'task/sql_upsert' of https://github.com/telefonicaid/fiware-cygnus into task/sql_upsert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3be56543ed106087a647eac3cb71c863780a03fb", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/3be56543ed106087a647eac3cb71c863780a03fb", "committedDate": "2020-09-24T15:02:43Z", "message": "list sinks where upsert function is available"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a1e3ddd765e6fc1e1b7e85efd5d80d98ea10cea", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/5a1e3ddd765e6fc1e1b7e85efd5d80d98ea10cea", "committedDate": "2020-09-24T15:06:35Z", "message": "update mkdocs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NjkyMjQ5", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#pullrequestreview-495692249", "createdAt": "2020-09-24T15:26:04Z", "commit": {"oid": "5a1e3ddd765e6fc1e1b7e85efd5d80d98ea10cea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNToyNjowNFrOHXgX3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNToyNjowNFrOHXgX3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQwOTY5NQ==", "bodyText": "License header missing", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#discussion_r494409695", "createdAt": "2020-09-24T15:26:04Z", "author": {"login": "fgalan"}, "path": "cygnus-ngsi/src/main/java/com/telefonica/iot/cygnus/utils/NGSISQLUtils.java", "diffHunk": "@@ -0,0 +1,268 @@\n+package com.telefonica.iot.cygnus.utils;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1e3ddd765e6fc1e1b7e85efd5d80d98ea10cea"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NjkyNjk1", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#pullrequestreview-495692695", "createdAt": "2020-09-24T15:26:32Z", "commit": {"oid": "5a1e3ddd765e6fc1e1b7e85efd5d80d98ea10cea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNToyNjozMlrOHXgZSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNToyNjozMlrOHXgZSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQxMDA1Ng==", "bodyText": "License header missing", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#discussion_r494410056", "createdAt": "2020-09-24T15:26:32Z", "author": {"login": "fgalan"}, "path": "cygnus-ngsi/src/test/java/com/telefonica/iot/cygnus/utils/NGSISQLUtilsTest.java", "diffHunk": "@@ -0,0 +1,379 @@\n+package com.telefonica.iot.cygnus.utils;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a1e3ddd765e6fc1e1b7e85efd5d80d98ea10cea"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "527c45fe9eb4d2a49441ed9532fa068876872000", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/527c45fe9eb4d2a49441ed9532fa068876872000", "committedDate": "2020-09-24T15:30:16Z", "message": "add license header"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NzAxNTQ4", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#pullrequestreview-495701548", "createdAt": "2020-09-24T15:35:31Z", "commit": {"oid": "527c45fe9eb4d2a49441ed9532fa068876872000"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NTU0NjY4", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#pullrequestreview-495554668", "createdAt": "2020-09-24T13:12:45Z", "commit": {"oid": "714d1b454687b6b096b1dd83fe6837ecdf9e43b8"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxMzoxMjo0NVrOHXZ_MA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwNzozODo0M1rOHX4eXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDMwNTA3Mg==", "bodyText": "Maybe add a comment with the link doc/cygnus-ngsi/flume_extensions_catalogue/last_data_function.md ?", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#discussion_r494305072", "createdAt": "2020-09-24T13:12:45Z", "author": {"login": "AlvaroVega"}, "path": "cygnus-ngsi/src/main/java/com/telefonica/iot/cygnus/aggregation/NGSIGenericColumnAggregator.java", "diffHunk": "@@ -149,6 +150,35 @@ public void aggregate(NGSIEvent event) {\n             } // if\n         } // for\n         setAggregation(aggregation);\n+        if (isEnableLastData()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "714d1b454687b6b096b1dd83fe6837ecdf9e43b8"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM5NTM2Ng==", "bodyText": "Including both (postgresql and postgis) ?", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#discussion_r494395366", "createdAt": "2020-09-24T15:06:49Z", "author": {"login": "AlvaroVega"}, "path": "cygnus-ngsi/src/main/java/com/telefonica/iot/cygnus/utils/NGSISQLUtils.java", "diffHunk": "@@ -0,0 +1,268 @@\n+package com.telefonica.iot.cygnus.utils;\n+\n+import com.google.gson.JsonElement;\n+import com.telefonica.iot.cygnus.log.CygnusLogger;\n+\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.Iterator;\n+import java.util.LinkedHashMap;\n+import java.util.Set;\n+\n+/**\n+ * The type Ngsisql utils.\n+ */\n+public class NGSISQLUtils {\n+\n+    private static final CygnusLogger LOGGER = new CygnusLogger(NGSISQLUtils.class);\n+\n+    private static final String POSTGRES_FIELDS_MARK = \"\";\n+    private static final String MYSQL_FIELDS_MARK = \"'\";\n+    private static final String SEPARATION_MARK = \",\";\n+\n+    /**\n+     * Upsert statement prepared statement.\n+     *\n+     * @param aggregation     the aggregation\n+     * @param lastData        the last data\n+     * @param tableName       the table name\n+     * @param tableSuffix     the table suffix\n+     * @param uniqueKey       the unique key\n+     * @param timestampKey    the timestamp key\n+     * @param timestampFormat the timestamp format\n+     * @param sqlInstance     the sql instance\n+     * @param destination     the destination\n+     * @param connection      the connection\n+     * @param attrNativeTypes the attr native types\n+     * @return the prepared statement\n+     * @throws SQLException the sql exception\n+     */\n+    public static PreparedStatement upsertStatement (LinkedHashMap<String, ArrayList<JsonElement>> aggregation,\n+                                            LinkedHashMap<String, ArrayList<JsonElement>> lastData,\n+                                            String tableName,\n+                                            String tableSuffix,\n+                                            String uniqueKey,\n+                                            String timestampKey,\n+                                            String timestampFormat,\n+                                            String sqlInstance,\n+                                            String destination,\n+                                            Connection connection,\n+                                            boolean attrNativeTypes) throws SQLException {\n+\n+\n+        String query = sqlUpsertQuery(aggregation,\n+                lastData,\n+                tableName,\n+                tableSuffix,\n+                uniqueKey,\n+                timestampKey,\n+                timestampFormat,\n+                sqlInstance,\n+                destination).toString();\n+\n+        PreparedStatement previousStatement = connection.prepareStatement(query);\n+        PreparedStatement preparedStatement = null;\n+        try {\n+            preparedStatement = addJsonValues(previousStatement,\n+                    lastData,\n+                    attrNativeTypes);\n+        } catch (SQLException e) {\n+            LOGGER.error(sqlInstance + \" SQLEXCEPTION Error creating upsert statement \" + e);\n+        } catch (Exception e) {\n+            LOGGER.error(sqlInstance + \" GENERICEXCEPTION Error creating upsert statement \" + e);\n+        }\n+        LOGGER.info(\"[NGSISQLUtils.upsertStatement] PreparedStatement for upsert created successfully, all batches added. \" + query);\n+        return preparedStatement;\n+\n+    }\n+\n+    /**\n+     * Sql upsert query string buffer.\n+     *\n+     * @param aggregation     the aggregation\n+     * @param lastData        the last data\n+     * @param tableName       the table name\n+     * @param tableSuffix     the table suffix\n+     * @param uniqueKey       the unique key\n+     * @param timestampKey    the timestamp key\n+     * @param timestampFormat the timestamp format\n+     * @param sqlInstance     the sql instance\n+     * @param destination     the destination\n+     * @return the string buffer\n+     */\n+    protected static StringBuffer sqlUpsertQuery(LinkedHashMap<String, ArrayList<JsonElement>> aggregation,\n+                                              LinkedHashMap<String, ArrayList<JsonElement>> lastData,\n+                                              String tableName,\n+                                              String tableSuffix,\n+                                              String uniqueKey,\n+                                              String timestampKey,\n+                                              String timestampFormat,\n+                                              String sqlInstance,\n+                                              String destination) {\n+\n+        StringBuffer fieldsForInsert;\n+        StringBuffer valuesForInsert = sqlQuestionValues(lastData.keySet());\n+        StringBuffer updateSet = new StringBuffer();\n+        StringBuffer postgisTempReference = new StringBuffer(\"EXCLUDED\");\n+        StringBuffer postgisDestination = new StringBuffer(destination).append(\".\").append(tableName).append(tableSuffix);\n+        StringBuffer query = new StringBuffer();\n+        boolean first = true;\n+\n+        for (String key : lastData.keySet()) {\n+            if (!key.equals(uniqueKey) && first) {\n+                updateSet.append(key).append(\"=\").append(postgisTempReference).append(\".\").append(key);\n+                first = false;\n+            } else if (!key.equals(uniqueKey)) {\n+                updateSet.append(\", \").append(key).append(\"=\").append(postgisTempReference).append(\".\").append(key);\n+            }\n+        }\n+\n+        if (sqlInstance.equals(\"postgresql\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3be56543ed106087a647eac3cb71c863780a03fb"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDgwNDU3NA==", "bodyText": "some few comments are welcome", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1934#discussion_r494804574", "createdAt": "2020-09-25T07:38:43Z", "author": {"login": "AlvaroVega"}, "path": "cygnus-ngsi/src/main/java/com/telefonica/iot/cygnus/aggregation/NGSIGenericColumnAggregator.java", "diffHunk": "@@ -149,6 +150,35 @@ public void aggregate(NGSIEvent event) {\n             } // if\n         } // for\n         setAggregation(aggregation);\n+        if (isEnableLastData()) { // More detail in doc/cygnus-ngsi/flume_extensions_catalogue/last_data_function.md\n+            boolean updateLastData = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "527c45fe9eb4d2a49441ed9532fa068876872000"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84ecd81133e369c62aa6d8eb29a8da5f73b65d42", "author": {"user": {"login": "AlvaroVega", "name": "Alvaro Vega"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/84ecd81133e369c62aa6d8eb29a8da5f73b65d42", "committedDate": "2020-09-28T14:17:08Z", "message": "Merge branch 'master' into task/sql_upsert"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3844, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}