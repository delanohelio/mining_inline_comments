{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzMTMxMjA2", "number": 1876, "title": "Task/new postgresql datamodels", "bodyText": "This PR overwrite PR #1874 adding new Data Models (DMBYENTITYDATABASE, DMBYENTITYDATABASESCHEMA) to PostgreSQL sink, also. All documentation regarding this data models to postgis sink doc has been removed and it is inherited by postgresql sink doc.", "createdAt": "2020-05-26T10:52:40Z", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876", "merged": true, "mergeCommit": {"oid": "294f7206258594d1fb09fe4387ac24470406c50a"}, "closed": true, "closedAt": "2020-05-29T12:18:11Z", "author": {"login": "IvanHdzC"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclBUL5AH2gAyNDIzMTMxMjA2OmE1Y2U1ZjdhY2IxNTVkYWZkZmQ1ZWFiZmJhYjFmZmU1ZjhiZjNmODE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcmA8shAFqTQyMDg3NjM1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a5ce5f7acb155dafdfd5eabfbab1ffe5f8bf3f81", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/a5ce5f7acb155dafdfd5eabfbab1ffe5f8bf3f81", "committedDate": "2020-05-26T09:33:14Z", "message": "add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "509fcc35b283e8d7567ab42218143472c4f5adc1", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/509fcc35b283e8d7567ab42218143472c4f5adc1", "committedDate": "2020-05-26T09:33:35Z", "message": "add new datamodels to postgresql sink"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcab20d12127e6f11407364f2295f7de0f5f6df4", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/dcab20d12127e6f11407364f2295f7de0f5f6df4", "committedDate": "2020-05-26T09:34:00Z", "message": "code clean for postgis sink"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1", "committedDate": "2020-05-26T09:58:30Z", "message": "remove postgis documentation to refer to new postgresql docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODgxOTg1", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#pullrequestreview-419881985", "createdAt": "2020-05-28T08:20:59Z", "commit": {"oid": "d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODoyMTowMFrOGbqoFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODoyMTowMFrOGbqoFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY2MzEyNw==", "bodyText": "I guess the following entry in CNR\n\n[cygnus-ngsi][PostgisSQLSink] Add dm-by-entity-database and dm-by-entity-database-schema\n\nshould be modiffied to\n\n[cygnus-ngsi][PostgresqlSink][PostgisSQLSink] Add dm-by-entity-database and dm-by-entity-database-schema", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#discussion_r431663127", "createdAt": "2020-05-28T08:21:00Z", "author": {"login": "fgalan"}, "path": "cygnus-ngsi/src/main/java/com/telefonica/iot/cygnus/sinks/NGSIPostgisSink.java", "diffHunk": "@@ -314,7 +314,6 @@ void persistBatch(NGSIBatch batch)\n             aggregator.setEntityForNaming(events.get(0).getEntityForNaming(enableGrouping, enableNameMappings, enableEncoding));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODkxNjEx", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#pullrequestreview-419891611", "createdAt": "2020-05-28T08:33:39Z", "commit": {"oid": "d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODozMzo0MFrOGbrGIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODozMzo0MFrOGbrGIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY3MDgxNg==", "bodyText": "Both bullets seems to be the same... is that correct?", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#discussion_r431670816", "createdAt": "2020-05-28T08:33:40Z", "author": {"login": "fgalan"}, "path": "doc/cygnus-ngsi/flume_extensions_catalogue/ngsi_postgresql_sink.md", "diffHunk": "@@ -57,22 +57,37 @@ It must be said [PostgreSQL only accepts](https://www.postgresql.org/docs/curren\n \n PostgreSQL [databases name length](http://www.postgresql.org/docs/current/static/sql-syntax-lexical.html#SQL-SYNTAX-IDENTIFIERS) is limited to 63 characters.\n \n+Since version 2.2.0 It's added a new capability for Cygnus to create the schema name on runtime, this is possible trough enabling a specific Data Model on agent properties. That works the following way.\n+\n+* Data model by entity database (`data_model=dm-by-entity-database`). For this datamodel the name of the database will be auto generated by the sink, this name will be the `fiware-service` found on the headers of the first request incoming to the sink.\n+* Data model by entity database schema (`data_model=dm-by-entity-database-schema`). For this datamodel the name of the database will be auto generated by the sink, this name will be the `fiware-service` found on the headers of the first request incoming to the sink.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODkyNDE3", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#pullrequestreview-419892417", "createdAt": "2020-05-28T08:34:42Z", "commit": {"oid": "d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODozNDo0MlrOGbrIkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODozNDo0MlrOGbrIkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY3MTQ0Mg==", "bodyText": "It seems to be duplicated in lines L70-71. Maybe L70-71 should be removed?", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#discussion_r431671442", "createdAt": "2020-05-28T08:34:42Z", "author": {"login": "fgalan"}, "path": "doc/cygnus-ngsi/flume_extensions_catalogue/ngsi_postgresql_sink.md", "diffHunk": "@@ -57,22 +57,37 @@ It must be said [PostgreSQL only accepts](https://www.postgresql.org/docs/curren\n \n PostgreSQL [databases name length](http://www.postgresql.org/docs/current/static/sql-syntax-lexical.html#SQL-SYNTAX-IDENTIFIERS) is limited to 63 characters.\n \n+Since version 2.2.0 It's added a new capability for Cygnus to create the schema name on runtime, this is possible trough enabling a specific Data Model on agent properties. That works the following way.\n+\n+* Data model by entity database (`data_model=dm-by-entity-database`). For this datamodel the name of the database will be auto generated by the sink, this name will be the `fiware-service` found on the headers of the first request incoming to the sink.\n+* Data model by entity database schema (`data_model=dm-by-entity-database-schema`). For this datamodel the name of the database will be auto generated by the sink, this name will be the `fiware-service` found on the headers of the first request incoming to the sink.\n+\n [Top](#top)\n \n #### <a name=\"section1.2.2\"></a>PostgreSQL schemas naming conventions\n A schema named as the notified `fiware-service` header value (or, in absence of such a header, the defaulted value for the FIWARE service) is created (if not existing yet).\n \n+* Data model by entity database schema (`data_model=dm-by-entity-database-schema`). For this datamodel the name of the schema will be auto generated by the sink, this name will be the `fiware-servicePath` found on the headers of the first request to store.\n+\n It must be said [PostgreSQL only accepts](https://www.postgresql.org/docs/current/static/sql-syntax-lexical.html#SQL-SYNTAX-IDENTIFIERS) alphanumeric characters and the underscore (`_`). This leads to  certain [encoding](#section2.3.4) is applied depending on the `enable_encoding` configuration parameter.\n \n PostgreSQL [schemas name length](http://www.postgresql.org/docs/current/static/sql-syntax-lexical.html#SQL-SYNTAX-IDENTIFIERS) is limited to 63 characters.\n \n+Since version 2.2.0 Cygnus creates the name of the schema name on runtime according to the selected DataModel for the sink.\n+\n+* Data model by entity database schema (`data_model=dm-by-entity-database-schema`). For this datamodel the name of the schema will be auto generated by the sink, this name will be the `fiware-servicePath` found on the headers of the first request to store.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODk0MDQ3", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#pullrequestreview-419894047", "createdAt": "2020-05-28T08:36:42Z", "commit": {"oid": "d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODozNjo0MlrOGbrNRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODozNjo0MlrOGbrNRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY3MjY0Ng==", "bodyText": "The data_model= maybe should be removed?", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#discussion_r431672646", "createdAt": "2020-05-28T08:36:42Z", "author": {"login": "fgalan"}, "path": "doc/cygnus-ngsi/flume_extensions_catalogue/ngsi_postgresql_sink.md", "diffHunk": "@@ -81,14 +96,14 @@ PostgreSQL [tables name length](http://www.postgresql.org/docs/current/static/sq\n \n The following table summarizes the table name composition (old encoding):\n \n-| FIWARE service path | `dm-by-service-path` | `dm-by-entity` | `dm-by-entity-type` |\n+| FIWARE service path | `dm-by-service-path` | `dm-by-entity`, `data_model=dm-by-entity-database-schema`, `data_model=dm-by-entity-database` | `dm-by-entity-type` |\n |---|---|---|---|\n | `/` | N/A | `<entityId>_<entityType>` | `<entityType>` |\n | `/<svcPath>` | `<svcPath>` | `<svcPath>_<entityId>_<entityType>` | `<svcPath>_<entityType>` |\n \n Using the new encoding:\n \n-| FIWARE service path | `dm-by-service-path` | `dm-by-entity` | `dm-by-entity-type` |\n+| FIWARE service path | `dm-by-service-path` | `dm-by-entity`, `data_model=dm-by-entity-database-schema`, `data_model=dm-by-entity-database` | `dm-by-entity-type` |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODk0MzQx", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#pullrequestreview-419894341", "createdAt": "2020-05-28T08:37:04Z", "commit": {"oid": "d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODozNzowNVrOGbrOMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODozNzowNVrOGbrOMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY3Mjg4MQ==", "bodyText": "The data_model= maybe should be removed?", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#discussion_r431672881", "createdAt": "2020-05-28T08:37:05Z", "author": {"login": "fgalan"}, "path": "doc/cygnus-ngsi/flume_extensions_catalogue/ngsi_postgresql_sink.md", "diffHunk": "@@ -81,14 +96,14 @@ PostgreSQL [tables name length](http://www.postgresql.org/docs/current/static/sq\n \n The following table summarizes the table name composition (old encoding):\n \n-| FIWARE service path | `dm-by-service-path` | `dm-by-entity` | `dm-by-entity-type` |\n+| FIWARE service path | `dm-by-service-path` | `dm-by-entity`, `data_model=dm-by-entity-database-schema`, `data_model=dm-by-entity-database` | `dm-by-entity-type` |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5OTA5NTY1", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#pullrequestreview-419909565", "createdAt": "2020-05-28T08:56:27Z", "commit": {"oid": "d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODo1NjoyN1rOGbr7uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODo1NjoyN1rOGbr7uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY4NDUzOQ==", "bodyText": "I would expect a else case with a warn log about dbname is null, make sense?", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#discussion_r431684539", "createdAt": "2020-05-28T08:56:27Z", "author": {"login": "AlvaroVega"}, "path": "cygnus-ngsi/src/main/java/com/telefonica/iot/cygnus/sinks/NGSIPostgreSQLSink.java", "diffHunk": "@@ -254,7 +254,9 @@ public void configure(Context context) {\n     @Override\n     public void start() {\n         try {\n-            createPersistenceBackend(postgresqlHost, postgresqlPort, postgresqlUsername, postgresqlPassword, maxPoolSize, postgresqlDatabase, postgresqlOptions);\n+            if (buildDBName(null) != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d65a9dde13ab9f9bcd8a8409e88c0480710fe7b1"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7cf20a4544987e1d98ea28c2147c7c0630df9a7", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/d7cf20a4544987e1d98ea28c2147c7c0630df9a7", "committedDate": "2020-05-28T14:26:43Z", "message": "update CNR entry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bcedc4805e6b3e4e48b7e5a357e18931cd62a0a", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/9bcedc4805e6b3e4e48b7e5a357e18931cd62a0a", "committedDate": "2020-05-28T14:30:38Z", "message": "update docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84e286ec4d742ba729bf510e7711ecc58e8b2f24", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/84e286ec4d742ba729bf510e7711ecc58e8b2f24", "committedDate": "2020-05-28T14:34:31Z", "message": "add log in case the sql backend object is not created on startup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf2b4499ddeb68f94956e643ae097aaf293238f9", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/bf2b4499ddeb68f94956e643ae097aaf293238f9", "committedDate": "2020-05-28T14:41:52Z", "message": "Merge branch 'master' into task/new_postgresql_datamodels"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwODQyMjIy", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#pullrequestreview-420842222", "createdAt": "2020-05-29T10:41:33Z", "commit": {"oid": "bf2b4499ddeb68f94956e643ae097aaf293238f9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8be42b1177c57550a0650546035f4b28c0133974", "author": {"user": {"login": "fgalan", "name": "Ferm\u00edn Gal\u00e1n M\u00e1rquez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/8be42b1177c57550a0650546035f4b28c0133974", "committedDate": "2020-05-29T10:47:27Z", "message": "Merge branch 'master' into task/new_postgresql_datamodels"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b2cd22b9b464b6997be34f028af7d7b832ba327", "author": {"user": {"login": "IvanHdzC", "name": "Ivan Hernandez"}}, "url": "https://github.com/telefonicaid/fiware-cygnus/commit/8b2cd22b9b464b6997be34f028af7d7b832ba327", "committedDate": "2020-05-29T11:30:13Z", "message": "update docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwODc2MzUx", "url": "https://github.com/telefonicaid/fiware-cygnus/pull/1876#pullrequestreview-420876351", "createdAt": "2020-05-29T11:41:30Z", "commit": {"oid": "8b2cd22b9b464b6997be34f028af7d7b832ba327"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3831, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}