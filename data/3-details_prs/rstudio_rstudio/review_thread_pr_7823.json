{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4OTA0NTk3", "number": 7823, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMToxMDoxOFrOEkujEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjoxNDoxMlrOEoKTMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2OTQ2ODM0OnYy", "diffSide": "RIGHT", "path": "src/cpp/core/FileSerializer.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMToxMDoxOFrOHT1p3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMToxNjo1MVrOHT11wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU2NDA2Mw==", "bodyText": "It looks like this loop doesn't update opened below?", "url": "https://github.com/rstudio/rstudio/pull/7823#discussion_r490564063", "createdAt": "2020-09-17T21:10:18Z", "author": {"login": "kevinushey"}, "path": "src/cpp/core/FileSerializer.cpp", "diffHunk": "@@ -24,13 +24,63 @@\n #include <boost/algorithm/string/trim.hpp>\n #include <boost/algorithm/string/predicate.hpp>\n #include <boost/iostreams/copy.hpp>\n+#include <boost/thread.hpp>\n \n #include <shared_core/FilePath.hpp>\n+#include <core/DateTime.hpp>\n #include <core/StringUtils.hpp>\n \n namespace rstudio {\n namespace core {\n \n+namespace {\n+\n+bool isFileLockedError(const Error& error)\n+{\n+   // exclusive file access is only present on Windows\n+#ifndef _WIN32\n+   return false;\n+#endif\n+   return (error && error.getCode() == ERROR_SHARING_VIOLATION);\n+}\n+\n+Error openFileForWritingWithRetry(const FilePath& filePath,\n+                                  bool truncate,\n+                                  int maxOpenRetrySeconds,\n+                                  std::shared_ptr<std::ostream>* pOfs)\n+{\n+   using namespace boost::posix_time;\n+\n+   bool opened = false;\n+   ptime startTime = second_clock::universal_time();\n+   Error lastError;\n+\n+   // do not allow negative values - regular signed int was chosen here for\n+   // easier integration with other parts of the codebase\n+   if (maxOpenRetrySeconds < 0)\n+      maxOpenRetrySeconds = 0;\n+\n+   while (!opened)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "371297c527c9d73118e8129fd8b1b169960f460a"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU2NzEwNQ==", "bodyText": "Thanks for that - this was some leftovers from my prior impl that was using do{}while();. Changed this to just be a while(true) since it either exits the loop via return or a break when the time has elapsed.", "url": "https://github.com/rstudio/rstudio/pull/7823#discussion_r490567105", "createdAt": "2020-09-17T21:16:51Z", "author": {"login": "kfeinauer"}, "path": "src/cpp/core/FileSerializer.cpp", "diffHunk": "@@ -24,13 +24,63 @@\n #include <boost/algorithm/string/trim.hpp>\n #include <boost/algorithm/string/predicate.hpp>\n #include <boost/iostreams/copy.hpp>\n+#include <boost/thread.hpp>\n \n #include <shared_core/FilePath.hpp>\n+#include <core/DateTime.hpp>\n #include <core/StringUtils.hpp>\n \n namespace rstudio {\n namespace core {\n \n+namespace {\n+\n+bool isFileLockedError(const Error& error)\n+{\n+   // exclusive file access is only present on Windows\n+#ifndef _WIN32\n+   return false;\n+#endif\n+   return (error && error.getCode() == ERROR_SHARING_VIOLATION);\n+}\n+\n+Error openFileForWritingWithRetry(const FilePath& filePath,\n+                                  bool truncate,\n+                                  int maxOpenRetrySeconds,\n+                                  std::shared_ptr<std::ostream>* pOfs)\n+{\n+   using namespace boost::posix_time;\n+\n+   bool opened = false;\n+   ptime startTime = second_clock::universal_time();\n+   Error lastError;\n+\n+   // do not allow negative values - regular signed int was chosen here for\n+   // easier integration with other parts of the codebase\n+   if (maxOpenRetrySeconds < 0)\n+      maxOpenRetrySeconds = 0;\n+\n+   while (!opened)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU2NDA2Mw=="}, "originalCommit": {"oid": "371297c527c9d73118e8129fd8b1b169960f460a"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2OTUwMTczOnYy", "diffSide": "RIGHT", "path": "src/cpp/core/FileSerializer.cpp", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMToyMTozNFrOHT198g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QyMjo1MToyNlrOHT4Juw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU2OTIwMg==", "bodyText": "Does this actually pause the whole RPC thread? I'm a little concerned that if (a) we auto backup changes every 500ms (the default), and (b) every (other) attempt to write backups pauses the RPC thread for 500+ms as we wait for GDrive (etc) to release the lock, the RPC thread is going to spend a pathologically large time locked.", "url": "https://github.com/rstudio/rstudio/pull/7823#discussion_r490569202", "createdAt": "2020-09-17T21:21:34Z", "author": {"login": "jmcphers"}, "path": "src/cpp/core/FileSerializer.cpp", "diffHunk": "@@ -24,13 +24,62 @@\n #include <boost/algorithm/string/trim.hpp>\n #include <boost/algorithm/string/predicate.hpp>\n #include <boost/iostreams/copy.hpp>\n+#include <boost/thread.hpp>\n \n #include <shared_core/FilePath.hpp>\n+#include <core/DateTime.hpp>\n #include <core/StringUtils.hpp>\n \n namespace rstudio {\n namespace core {\n \n+namespace {\n+\n+bool isFileLockedError(const Error& error)\n+{\n+   // exclusive file access is only present on Windows\n+#ifndef _WIN32\n+   return false;\n+#endif\n+   return (error && error.getCode() == ERROR_SHARING_VIOLATION);\n+}\n+\n+Error openFileForWritingWithRetry(const FilePath& filePath,\n+                                  bool truncate,\n+                                  int maxOpenRetrySeconds,\n+                                  std::shared_ptr<std::ostream>* pOfs)\n+{\n+   using namespace boost::posix_time;\n+\n+   ptime startTime = second_clock::universal_time();\n+   Error lastError;\n+\n+   // do not allow negative values - regular signed int was chosen here for\n+   // easier integration with other parts of the codebase\n+   if (maxOpenRetrySeconds < 0)\n+      maxOpenRetrySeconds = 0;\n+\n+   while (true)\n+   {\n+      lastError = filePath.openForWrite(*pOfs, truncate);\n+\n+      // if the error is a non file lock error, then we should just return it\n+      if (!isFileLockedError(lastError))\n+         return lastError;\n+\n+      // stop retrying if we've spent more than the requested amount of time\n+      if ((second_clock::universal_time() - startTime) >= seconds(maxOpenRetrySeconds))\n+         break;\n+\n+      // wait a moment before retrying\n+      boost::this_thread::sleep(milliseconds(500));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d967772c85371c727c4e919b953d951e51b6b1c5"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU3Mzk0NA==", "bodyText": "It does since it is sleeping. I did my testing with auto save on 500 ms and the performance seemed good. The vast majority of saves are non conflicting - I'd say one in every 15-20 saves produced a stall waiting for the file to become available in my testing. I didn't notice any ill effects from a UX perspective.\nThis also reduces a bunch of complexity as opposed to retrying the operations in the front end and having to re-queue operations.", "url": "https://github.com/rstudio/rstudio/pull/7823#discussion_r490573944", "createdAt": "2020-09-17T21:31:45Z", "author": {"login": "kfeinauer"}, "path": "src/cpp/core/FileSerializer.cpp", "diffHunk": "@@ -24,13 +24,62 @@\n #include <boost/algorithm/string/trim.hpp>\n #include <boost/algorithm/string/predicate.hpp>\n #include <boost/iostreams/copy.hpp>\n+#include <boost/thread.hpp>\n \n #include <shared_core/FilePath.hpp>\n+#include <core/DateTime.hpp>\n #include <core/StringUtils.hpp>\n \n namespace rstudio {\n namespace core {\n \n+namespace {\n+\n+bool isFileLockedError(const Error& error)\n+{\n+   // exclusive file access is only present on Windows\n+#ifndef _WIN32\n+   return false;\n+#endif\n+   return (error && error.getCode() == ERROR_SHARING_VIOLATION);\n+}\n+\n+Error openFileForWritingWithRetry(const FilePath& filePath,\n+                                  bool truncate,\n+                                  int maxOpenRetrySeconds,\n+                                  std::shared_ptr<std::ostream>* pOfs)\n+{\n+   using namespace boost::posix_time;\n+\n+   ptime startTime = second_clock::universal_time();\n+   Error lastError;\n+\n+   // do not allow negative values - regular signed int was chosen here for\n+   // easier integration with other parts of the codebase\n+   if (maxOpenRetrySeconds < 0)\n+      maxOpenRetrySeconds = 0;\n+\n+   while (true)\n+   {\n+      lastError = filePath.openForWrite(*pOfs, truncate);\n+\n+      // if the error is a non file lock error, then we should just return it\n+      if (!isFileLockedError(lastError))\n+         return lastError;\n+\n+      // stop retrying if we've spent more than the requested amount of time\n+      if ((second_clock::universal_time() - startTime) >= seconds(maxOpenRetrySeconds))\n+         break;\n+\n+      // wait a moment before retrying\n+      boost::this_thread::sleep(milliseconds(500));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU2OTIwMg=="}, "originalCommit": {"oid": "d967772c85371c727c4e919b953d951e51b6b1c5"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU5NTYwOA==", "bodyText": "Was your testing on a system with a fast SSD and internet connection? I think that GDrive and friends can have an exclusive lock for much longer on some environments, leading to more save conflicts.\nI think we need to give up faster on autosaves. The user generally has another chance to save the file (and will get warned if they try to exit with changes that have never been backed up); it feels wrong that there's a possibility of blocking the entire RPC thread for 15 seconds for an operation the user didn't initiate.\n15s isn't unreasonable for a change that must succeed, so I'd suggest a second pref for autosave (auto_save_retry_timeout?) as both a shorter fuse and an escape hatch; it could give up after a second or two, and setting it to 0 would result in a best-effort autosave that just attempts to write the file if it can (the front end could read this value and avoid popping up \"file is in use\" errors).", "url": "https://github.com/rstudio/rstudio/pull/7823#discussion_r490595608", "createdAt": "2020-09-17T22:25:22Z", "author": {"login": "jmcphers"}, "path": "src/cpp/core/FileSerializer.cpp", "diffHunk": "@@ -24,13 +24,62 @@\n #include <boost/algorithm/string/trim.hpp>\n #include <boost/algorithm/string/predicate.hpp>\n #include <boost/iostreams/copy.hpp>\n+#include <boost/thread.hpp>\n \n #include <shared_core/FilePath.hpp>\n+#include <core/DateTime.hpp>\n #include <core/StringUtils.hpp>\n \n namespace rstudio {\n namespace core {\n \n+namespace {\n+\n+bool isFileLockedError(const Error& error)\n+{\n+   // exclusive file access is only present on Windows\n+#ifndef _WIN32\n+   return false;\n+#endif\n+   return (error && error.getCode() == ERROR_SHARING_VIOLATION);\n+}\n+\n+Error openFileForWritingWithRetry(const FilePath& filePath,\n+                                  bool truncate,\n+                                  int maxOpenRetrySeconds,\n+                                  std::shared_ptr<std::ostream>* pOfs)\n+{\n+   using namespace boost::posix_time;\n+\n+   ptime startTime = second_clock::universal_time();\n+   Error lastError;\n+\n+   // do not allow negative values - regular signed int was chosen here for\n+   // easier integration with other parts of the codebase\n+   if (maxOpenRetrySeconds < 0)\n+      maxOpenRetrySeconds = 0;\n+\n+   while (true)\n+   {\n+      lastError = filePath.openForWrite(*pOfs, truncate);\n+\n+      // if the error is a non file lock error, then we should just return it\n+      if (!isFileLockedError(lastError))\n+         return lastError;\n+\n+      // stop retrying if we've spent more than the requested amount of time\n+      if ((second_clock::universal_time() - startTime) >= seconds(maxOpenRetrySeconds))\n+         break;\n+\n+      // wait a moment before retrying\n+      boost::this_thread::sleep(milliseconds(500));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU2OTIwMg=="}, "originalCommit": {"oid": "d967772c85371c727c4e919b953d951e51b6b1c5"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYwNDk4Nw==", "bodyText": "What about not retrying for autosaves period? The whole point of autosaves is that it saves continuously and periodically. Since most operations are successful, we could simply ignore this particular failure for autosaves entirely, with the knowledge that future autosaves will almost assuredly work (since the exclusive file lock will be given up as soon as syncing is done).\nWe can keep everything as is currently for manual saves, since they are a user initiated action.", "url": "https://github.com/rstudio/rstudio/pull/7823#discussion_r490604987", "createdAt": "2020-09-17T22:51:26Z", "author": {"login": "kfeinauer"}, "path": "src/cpp/core/FileSerializer.cpp", "diffHunk": "@@ -24,13 +24,62 @@\n #include <boost/algorithm/string/trim.hpp>\n #include <boost/algorithm/string/predicate.hpp>\n #include <boost/iostreams/copy.hpp>\n+#include <boost/thread.hpp>\n \n #include <shared_core/FilePath.hpp>\n+#include <core/DateTime.hpp>\n #include <core/StringUtils.hpp>\n \n namespace rstudio {\n namespace core {\n \n+namespace {\n+\n+bool isFileLockedError(const Error& error)\n+{\n+   // exclusive file access is only present on Windows\n+#ifndef _WIN32\n+   return false;\n+#endif\n+   return (error && error.getCode() == ERROR_SHARING_VIOLATION);\n+}\n+\n+Error openFileForWritingWithRetry(const FilePath& filePath,\n+                                  bool truncate,\n+                                  int maxOpenRetrySeconds,\n+                                  std::shared_ptr<std::ostream>* pOfs)\n+{\n+   using namespace boost::posix_time;\n+\n+   ptime startTime = second_clock::universal_time();\n+   Error lastError;\n+\n+   // do not allow negative values - regular signed int was chosen here for\n+   // easier integration with other parts of the codebase\n+   if (maxOpenRetrySeconds < 0)\n+      maxOpenRetrySeconds = 0;\n+\n+   while (true)\n+   {\n+      lastError = filePath.openForWrite(*pOfs, truncate);\n+\n+      // if the error is a non file lock error, then we should just return it\n+      if (!isFileLockedError(lastError))\n+         return lastError;\n+\n+      // stop retrying if we've spent more than the requested amount of time\n+      if ((second_clock::universal_time() - startTime) >= seconds(maxOpenRetrySeconds))\n+         break;\n+\n+      // wait a moment before retrying\n+      boost::this_thread::sleep(milliseconds(500));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU2OTIwMg=="}, "originalCommit": {"oid": "d967772c85371c727c4e919b953d951e51b6b1c5"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NTk1ODAyOnYy", "diffSide": "RIGHT", "path": "src/cpp/core/include/core/FileSerializer.hpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMzoyODoyNVrOHXv7vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMzoyODoyNVrOHXv7vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY2NDYzOQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            // note: this only has an affect on Windows\n          \n          \n            \n            // note: this only has an effect on Windows", "url": "https://github.com/rstudio/rstudio/pull/7823#discussion_r494664639", "createdAt": "2020-09-24T23:28:25Z", "author": {"login": "jmcphers"}, "path": "src/cpp/core/include/core/FileSerializer.hpp", "diffHunk": "@@ -291,10 +291,16 @@ Error readStringVectorFromFile(const core::FilePath& filePath,\n                                bool trimAndIgnoreBlankLines=true);\n \n // lineEnding is the type of line ending you want to end up on disk\n+//\n+// maxOpenRetrySeconds indicates whether or not we should retry attempts to open the file\n+// when it is in use by another process (common when using backup software), and if so\n+// how many seconds of elapsed time should we wait for the file to become available\n+// note: this only has an affect on Windows", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11ce679c326f04d8907c70f97418ae0830e7f5f8"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NTk1OTMwOnYy", "diffSide": "RIGHT", "path": "src/cpp/session/SessionSourceDatabase.cpp", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMzoyOTowNVrOHXv8iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQyMDozNjowMFrOHYRv5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY2NDg0Mw==", "bodyText": "Does this need to be a threadsafe map?", "url": "https://github.com/rstudio/rstudio/pull/7823#discussion_r494664843", "createdAt": "2020-09-24T23:29:05Z", "author": {"login": "jmcphers"}, "path": "src/cpp/session/SessionSourceDatabase.cpp", "diffHunk": "@@ -71,13 +74,30 @@ namespace {\n // lookup)\n std::map<std::string, std::string> s_idToPath;\n \n+// cached mapping of document last write times\n+std::map<std::string, std::time_t> s_lastWriteTimes;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11ce679c326f04d8907c70f97418ae0830e7f5f8"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIxODY2Mw==", "bodyText": "No - all of these routines execute only on the main thread (thread 0)", "url": "https://github.com/rstudio/rstudio/pull/7823#discussion_r495218663", "createdAt": "2020-09-25T20:36:00Z", "author": {"login": "kfeinauer"}, "path": "src/cpp/session/SessionSourceDatabase.cpp", "diffHunk": "@@ -71,13 +74,30 @@ namespace {\n // lookup)\n std::map<std::string, std::string> s_idToPath;\n \n+// cached mapping of document last write times\n+std::map<std::string, std::time_t> s_lastWriteTimes;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY2NDg0Mw=="}, "originalCommit": {"oid": "11ce679c326f04d8907c70f97418ae0830e7f5f8"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NTk4MjQ5OnYy", "diffSide": "RIGHT", "path": "src/cpp/core/FileSerializer.cpp", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMzo0MDozNlrOHXwJqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMzo0MDozNlrOHXwJqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY2ODIwMw==", "bodyText": "Can we amend the primary error object here with a property that indicates that we timed out (and possibly how many tries/attempts we made)? I also think this error would be worth logging and returning since a save failure can cause data loss.", "url": "https://github.com/rstudio/rstudio/pull/7823#discussion_r494668203", "createdAt": "2020-09-24T23:40:36Z", "author": {"login": "jmcphers"}, "path": "src/cpp/core/FileSerializer.cpp", "diffHunk": "@@ -24,13 +24,62 @@\n #include <boost/algorithm/string/trim.hpp>\n #include <boost/algorithm/string/predicate.hpp>\n #include <boost/iostreams/copy.hpp>\n+#include <boost/thread.hpp>\n \n #include <shared_core/FilePath.hpp>\n+#include <core/DateTime.hpp>\n #include <core/StringUtils.hpp>\n \n namespace rstudio {\n namespace core {\n \n+namespace {\n+\n+bool isFileLockedError(const Error& error)\n+{\n+   // exclusive file access is only present on Windows\n+#ifndef _WIN32\n+   return false;\n+#endif\n+   return (error && error.getCode() == ERROR_SHARING_VIOLATION);\n+}\n+\n+Error openFileForWritingWithRetry(const FilePath& filePath,\n+                                  bool truncate,\n+                                  int maxOpenRetrySeconds,\n+                                  std::shared_ptr<std::ostream>* pOfs)\n+{\n+   using namespace boost::posix_time;\n+\n+   ptime startTime = second_clock::universal_time();\n+   Error lastError;\n+\n+   // do not allow negative values - regular signed int was chosen here for\n+   // easier integration with other parts of the codebase\n+   if (maxOpenRetrySeconds < 0)\n+      maxOpenRetrySeconds = 0;\n+\n+   while (true)\n+   {\n+      lastError = filePath.openForWrite(*pOfs, truncate);\n+\n+      // if the error is a non file lock error, then we should just return it\n+      if (!isFileLockedError(lastError))\n+         return lastError;\n+\n+      // stop retrying if we've spent more than the requested amount of time\n+      if ((second_clock::universal_time() - startTime) >= seconds(maxOpenRetrySeconds))\n+         break;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11ce679c326f04d8907c70f97418ae0830e7f5f8"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwNTQ2Nzk5OnYy", "diffSide": "RIGHT", "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjoxMzowNVrOHZFw6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjoyMzo1M1rOHZGMbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3MDg4OA==", "bodyText": "Checking this based on the message rather than an error property or code seems fragile. Would it be feasible for us to send a proper error object (e.g. with an error code) that we could check here or something similar?", "url": "https://github.com/rstudio/rstudio/pull/7823#discussion_r496070888", "createdAt": "2020-09-28T16:13:05Z", "author": {"login": "kevinushey"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java", "diffHunk": "@@ -376,8 +391,17 @@ public void onError(final String message)\n             @Override\n             public void execute()\n             {\n-               globalDisplay_.showErrorMessage(\"Error Saving File\",\n-                                               message);\n+               // do not show the error if it is a transient autosave related issue - this can occur fairly frequently\n+               // when attempting to save files that are being backed up by external software\n+               if (message.contains(\"The process cannot access the file because it is being used by another process\") && suppressFileLockError_)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "011eb11501950dd1c245656585880cef43b764e3"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3NzkzNA==", "bodyText": "I decided against that because we are using the ProgressIndicator interface here which is tied to error messages and is a very fundamental interface in the code. I didn't think extending this interface was worth it to propagate this one error code here as this would affect a sizable portion of the code base.", "url": "https://github.com/rstudio/rstudio/pull/7823#discussion_r496077934", "createdAt": "2020-09-28T16:23:53Z", "author": {"login": "kfeinauer"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java", "diffHunk": "@@ -376,8 +391,17 @@ public void onError(final String message)\n             @Override\n             public void execute()\n             {\n-               globalDisplay_.showErrorMessage(\"Error Saving File\",\n-                                               message);\n+               // do not show the error if it is a transient autosave related issue - this can occur fairly frequently\n+               // when attempting to save files that are being backed up by external software\n+               if (message.contains(\"The process cannot access the file because it is being used by another process\") && suppressFileLockError_)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3MDg4OA=="}, "originalCommit": {"oid": "011eb11501950dd1c245656585880cef43b764e3"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwNTQ3MjUwOnYy", "diffSide": "RIGHT", "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjoxNDoxMlrOHZFzqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNjoxNDoxMlrOHZFzqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3MTU5NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  new SaveProgressIndicator(path, type, false,null).onCompleted();\n          \n          \n            \n                  new SaveProgressIndicator(path, type, false, null).onCompleted();", "url": "https://github.com/rstudio/rstudio/pull/7823#discussion_r496071595", "createdAt": "2020-09-28T16:14:12Z", "author": {"login": "kevinushey"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/TextEditingTarget.java", "diffHunk": "@@ -7708,7 +7760,7 @@ public void setPath(FileSystemItem path)\n       TextFileType type = fileTypeRegistry_.getTextTypeForFile(path);\n \n       // Simulate a completed save of the new path\n-      new SaveProgressIndicator(path, type, null).onCompleted();\n+      new SaveProgressIndicator(path, type, false,null).onCompleted();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "011eb11501950dd1c245656585880cef43b764e3"}, "originalPosition": 356}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4203, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}