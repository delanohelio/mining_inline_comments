{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4MTUxMjY2", "number": 6720, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDoxMjo1N1rOD1dMDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDoyNTowNVrOD1detA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3Mzc5MzQzOnYy", "diffSide": "RIGHT", "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDoxMjo1N1rOGK6MPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDo1MDo1MVrOGK7kFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5MjM1MA==", "bodyText": "I'd just move this to before the for-loop begins.", "url": "https://github.com/rstudio/rstudio/pull/6720#discussion_r414092350", "createdAt": "2020-04-23T20:12:57Z", "author": {"login": "jcheng5"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java", "diffHunk": "@@ -1118,6 +1121,84 @@ public void insertCode(String code, boolean blockMode)\n    {\n       widget_.getEditor().insert(StringUtil.normalizeNewLines(code));\n    }\n+   \n+   public void applyCodeChanges(JsdiffChange[] changes)\n+   {\n+      // alias apis\n+      AceEditorNative editor = widget_.getEditor();\n+      EditSession session = editor.getSession();\n+      Selection selection = session.getSelection();\n+      AceCommandManager commandManager = editor.getCommandManager();\n+      \n+      // function to advance the selection\n+      Consumer<Integer> advanceSelection = (Integer charsLeft) -> {\n+         \n+         // start from current line/row\n+         Position startPos = selection.getCursor();\n+         \n+         // iterate through rows until we've consumed all the chars\n+         int row;\n+         int col = startPos.getColumn();\n+         for (row = startPos.getRow(); row < session.getLength(); row++) {\n+            \n+            // how many chars left in the current column?\n+            String line = session.getLine(row);\n+            int charsLeftInLine = line.length() - col;\n+            \n+            // is the number of chars we still need to consume lte\n+            // the number of charsLeft?\n+            if (charsLeft <= charsLeftInLine) \n+            {\n+               col = col + charsLeft;\n+               break;\n+            }\n+            else\n+            {\n+               charsLeft -= (charsLeftInLine+1); // add 1 for newline\n+               col = 0;\n+            }\n+         }\n+         \n+         // move the selection\n+         selection.moveCursorTo(row, col, false);\n+      };\n+      \n+      \n+      // process changes\n+      for (int i = 0; i<changes.length; i++) \n+      {\n+         // get change\n+         JsdiffChange change = changes[i];\n+         \n+         // if it's the first change then set the cursor location to the beginning of the file\n+         if (i == 0)\n+            selection.moveCursorTo(0, 0, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2d1e2e2a5880416a67604e0a97c2c7456cddb91"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEwMDM4MQ==", "bodyText": "Unless you didn't want to check for changes.length == 0 I guess...", "url": "https://github.com/rstudio/rstudio/pull/6720#discussion_r414100381", "createdAt": "2020-04-23T20:26:29Z", "author": {"login": "jcheng5"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java", "diffHunk": "@@ -1118,6 +1121,84 @@ public void insertCode(String code, boolean blockMode)\n    {\n       widget_.getEditor().insert(StringUtil.normalizeNewLines(code));\n    }\n+   \n+   public void applyCodeChanges(JsdiffChange[] changes)\n+   {\n+      // alias apis\n+      AceEditorNative editor = widget_.getEditor();\n+      EditSession session = editor.getSession();\n+      Selection selection = session.getSelection();\n+      AceCommandManager commandManager = editor.getCommandManager();\n+      \n+      // function to advance the selection\n+      Consumer<Integer> advanceSelection = (Integer charsLeft) -> {\n+         \n+         // start from current line/row\n+         Position startPos = selection.getCursor();\n+         \n+         // iterate through rows until we've consumed all the chars\n+         int row;\n+         int col = startPos.getColumn();\n+         for (row = startPos.getRow(); row < session.getLength(); row++) {\n+            \n+            // how many chars left in the current column?\n+            String line = session.getLine(row);\n+            int charsLeftInLine = line.length() - col;\n+            \n+            // is the number of chars we still need to consume lte\n+            // the number of charsLeft?\n+            if (charsLeft <= charsLeftInLine) \n+            {\n+               col = col + charsLeft;\n+               break;\n+            }\n+            else\n+            {\n+               charsLeft -= (charsLeftInLine+1); // add 1 for newline\n+               col = 0;\n+            }\n+         }\n+         \n+         // move the selection\n+         selection.moveCursorTo(row, col, false);\n+      };\n+      \n+      \n+      // process changes\n+      for (int i = 0; i<changes.length; i++) \n+      {\n+         // get change\n+         JsdiffChange change = changes[i];\n+         \n+         // if it's the first change then set the cursor location to the beginning of the file\n+         if (i == 0)\n+            selection.moveCursorTo(0, 0, false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5MjM1MA=="}, "originalCommit": {"oid": "d2d1e2e2a5880416a67604e0a97c2c7456cddb91"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDExNDgzNg==", "bodyText": "Yeah, I need to check for changes.length and not do anything to the cursor in that case. I agree though it would be more clear outside the loop.", "url": "https://github.com/rstudio/rstudio/pull/6720#discussion_r414114836", "createdAt": "2020-04-23T20:50:51Z", "author": {"login": "jjallaire"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java", "diffHunk": "@@ -1118,6 +1121,84 @@ public void insertCode(String code, boolean blockMode)\n    {\n       widget_.getEditor().insert(StringUtil.normalizeNewLines(code));\n    }\n+   \n+   public void applyCodeChanges(JsdiffChange[] changes)\n+   {\n+      // alias apis\n+      AceEditorNative editor = widget_.getEditor();\n+      EditSession session = editor.getSession();\n+      Selection selection = session.getSelection();\n+      AceCommandManager commandManager = editor.getCommandManager();\n+      \n+      // function to advance the selection\n+      Consumer<Integer> advanceSelection = (Integer charsLeft) -> {\n+         \n+         // start from current line/row\n+         Position startPos = selection.getCursor();\n+         \n+         // iterate through rows until we've consumed all the chars\n+         int row;\n+         int col = startPos.getColumn();\n+         for (row = startPos.getRow(); row < session.getLength(); row++) {\n+            \n+            // how many chars left in the current column?\n+            String line = session.getLine(row);\n+            int charsLeftInLine = line.length() - col;\n+            \n+            // is the number of chars we still need to consume lte\n+            // the number of charsLeft?\n+            if (charsLeft <= charsLeftInLine) \n+            {\n+               col = col + charsLeft;\n+               break;\n+            }\n+            else\n+            {\n+               charsLeft -= (charsLeftInLine+1); // add 1 for newline\n+               col = 0;\n+            }\n+         }\n+         \n+         // move the selection\n+         selection.moveCursorTo(row, col, false);\n+      };\n+      \n+      \n+      // process changes\n+      for (int i = 0; i<changes.length; i++) \n+      {\n+         // get change\n+         JsdiffChange change = changes[i];\n+         \n+         // if it's the first change then set the cursor location to the beginning of the file\n+         if (i == 0)\n+            selection.moveCursorTo(0, 0, false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5MjM1MA=="}, "originalCommit": {"oid": "d2d1e2e2a5880416a67604e0a97c2c7456cddb91"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3Mzg0MTE2OnYy", "diffSide": "RIGHT", "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDoyNTowNVrOGK6oKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwMTowNTo1MlrOGLCLXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5OTQ5OQ==", "bodyText": "The logic looks correct to me. I had to focus hard to make sure that a) charsLeft can never become less than 0, and b) that the row will never be advanced accidentally.\nThis suggestion is (supposed to be) equivalent but a little easier for my brain. I changed the for-loop to while, incrementing row manually; and moved the newline \"+1\" from the end of the loop body to the beginning, which I find makes the if/else easier to reason about.\n(If you find your version easier to understand, I'm fine with you leaving it that way.)\n         int row = startPos.getRow();\n         int col = startPos.getColumn();\n         while (row < session.getLength()) {\n\n            // how many chars left in the current column?\n            String line = session.getLine(row);\n            // the +1 is for newline\n            int charsLeftInLine = line.length() + 1 - col;\n\n            // is the number of chars we still need to consume lte\n            // the number of charsLeft?\n            if (charsLeft < charsLeftInLine) \n            {\n               col += charsLeft;\n               break;\n            }\n            else\n            {\n               charsLeft -= charsLeftInLine;\n               col = 0;\n               row++;\n            }\n         }", "url": "https://github.com/rstudio/rstudio/pull/6720#discussion_r414099499", "createdAt": "2020-04-23T20:25:05Z", "author": {"login": "jcheng5"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java", "diffHunk": "@@ -1118,6 +1121,84 @@ public void insertCode(String code, boolean blockMode)\n    {\n       widget_.getEditor().insert(StringUtil.normalizeNewLines(code));\n    }\n+   \n+   public void applyCodeChanges(JsdiffChange[] changes)\n+   {\n+      // alias apis\n+      AceEditorNative editor = widget_.getEditor();\n+      EditSession session = editor.getSession();\n+      Selection selection = session.getSelection();\n+      AceCommandManager commandManager = editor.getCommandManager();\n+      \n+      // function to advance the selection\n+      Consumer<Integer> advanceSelection = (Integer charsLeft) -> {\n+         \n+         // start from current line/row\n+         Position startPos = selection.getCursor();\n+         \n+         // iterate through rows until we've consumed all the chars\n+         int row;\n+         int col = startPos.getColumn();\n+         for (row = startPos.getRow(); row < session.getLength(); row++) {\n+            \n+            // how many chars left in the current column?\n+            String line = session.getLine(row);\n+            int charsLeftInLine = line.length() - col;\n+            \n+            // is the number of chars we still need to consume lte\n+            // the number of charsLeft?\n+            if (charsLeft <= charsLeftInLine) \n+            {\n+               col = col + charsLeft;\n+               break;\n+            }\n+            else\n+            {\n+               charsLeft -= (charsLeftInLine+1); // add 1 for newline\n+               col = 0;\n+            }\n+         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2d1e2e2a5880416a67604e0a97c2c7456cddb91"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDIyMzE5Nw==", "bodyText": "Yes, your version reach much nicer. Made that change. Thanks very much for the review, this is not a bit of code I'd ever want to get wrong!", "url": "https://github.com/rstudio/rstudio/pull/6720#discussion_r414223197", "createdAt": "2020-04-24T01:05:52Z", "author": {"login": "jjallaire"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java", "diffHunk": "@@ -1118,6 +1121,84 @@ public void insertCode(String code, boolean blockMode)\n    {\n       widget_.getEditor().insert(StringUtil.normalizeNewLines(code));\n    }\n+   \n+   public void applyCodeChanges(JsdiffChange[] changes)\n+   {\n+      // alias apis\n+      AceEditorNative editor = widget_.getEditor();\n+      EditSession session = editor.getSession();\n+      Selection selection = session.getSelection();\n+      AceCommandManager commandManager = editor.getCommandManager();\n+      \n+      // function to advance the selection\n+      Consumer<Integer> advanceSelection = (Integer charsLeft) -> {\n+         \n+         // start from current line/row\n+         Position startPos = selection.getCursor();\n+         \n+         // iterate through rows until we've consumed all the chars\n+         int row;\n+         int col = startPos.getColumn();\n+         for (row = startPos.getRow(); row < session.getLength(); row++) {\n+            \n+            // how many chars left in the current column?\n+            String line = session.getLine(row);\n+            int charsLeftInLine = line.length() - col;\n+            \n+            // is the number of chars we still need to consume lte\n+            // the number of charsLeft?\n+            if (charsLeft <= charsLeftInLine) \n+            {\n+               col = col + charsLeft;\n+               break;\n+            }\n+            else\n+            {\n+               charsLeft -= (charsLeftInLine+1); // add 1 for newline\n+               col = 0;\n+            }\n+         }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5OTQ5OQ=="}, "originalCommit": {"oid": "d2d1e2e2a5880416a67604e0a97c2c7456cddb91"}, "originalPosition": 57}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3922, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}