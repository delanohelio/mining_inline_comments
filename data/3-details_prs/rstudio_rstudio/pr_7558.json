{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1MjI1NDEz", "number": 7558, "title": "Fix issues with Console handling of inverted color mode", "bodyText": "Fixes #7250\nFixes #7557\n\nFix Details\nLooks like I had not completed the implementation of handling ANSI \"invert\" back when I added console ANSI support in RStudio 1.1.\nSpecifically, when invert is active, setting foreground or background colors and resetting foreground or background colors were not being inverted (e.g. setting foreground should actually set background and so on).\nQA Notes\nWe have pretty extensive unit testing of this code, and I wrote several new tests to cover this. To exercise it, recommend using the Crayon package and trying examples like the one in the issues themselves and/or issuing escape sequences directly.\nReference: https://en.wikipedia.org/wiki/ANSI_escape_code", "createdAt": "2020-08-10T00:30:29Z", "url": "https://github.com/rstudio/rstudio/pull/7558", "merged": true, "mergeCommit": {"oid": "7fd509f7de9eaec242510a46856258ec3b8c3a48"}, "closed": true, "closedAt": "2020-08-11T03:56:02Z", "author": {"login": "gtritchie"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9WkHGgH2gAyNDY1MjI1NDEzOjk1ZTJkZDliYTEwMGMyMjExYjAzMzZkY2I2NTAzMjNlNmNjOGFmNDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc9uaO-gFqTQ2NDcyNjc4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "95e2dd9ba100c2211b0336dcb650323e6cc8af40", "author": {"user": {"login": "gtritchie", "name": "Gary"}}, "url": "https://github.com/rstudio/rstudio/commit/95e2dd9ba100c2211b0336dcb650323e6cc8af40", "committedDate": "2020-08-09T23:52:49Z", "message": "Fix issues with Console handling of invert sequences\n\n- Fixes #7250"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c156281381c1edfe674ad356bbdaae6856aa2c66", "author": {"user": {"login": "gtritchie", "name": "Gary"}}, "url": "https://github.com/rstudio/rstudio/commit/c156281381c1edfe674ad356bbdaae6856aa2c66", "committedDate": "2020-08-10T17:33:48Z", "message": "Fix issues with inverting using 256-color mode\n\n- Fixes #7557"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NzI2Nzgx", "url": "https://github.com/rstudio/rstudio/pull/7558#pullrequestreview-464726781", "createdAt": "2020-08-11T03:39:14Z", "commit": {"oid": "c156281381c1edfe674ad356bbdaae6856aa2c66"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwMzozOToxNFrOG-nPFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwMzozOToxNFrOG-nPFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMwNzczNA==", "bodyText": "Totally up to you but I find these statements easier to read without the negation (i.e. if (inverted_) { ... )", "url": "https://github.com/rstudio/rstudio/pull/7558#discussion_r468307734", "createdAt": "2020-08-11T03:39:14Z", "author": {"login": "jmcphers"}, "path": "src/gwt/src/org/rstudio/core/client/AnsiCode.java", "diffHunk": "@@ -421,25 +467,45 @@ else if (codeVal == STRIKETHROUGH_OFF)\n          }\n          else if (Color.isFgColorCode(codeVal))\n          {\n-            currentColor_.setCode(codeVal);\n-            resetForeground();\n-            clazzes_.add(clazzForColor(codeVal));\n+            if (!inverted_)\n+               setForegroundColor(codeVal);\n+            else\n+               setBackgroundColor(Color.fgToBgColor(codeVal));\n          }\n          else if (Color.isBgColorCode(codeVal))\n          {\n-            currentBgColor_ = new Color(false, codeVal);\n-            resetBackground();\n-            clazzes_.add(clazzForBgColor(codeVal));\n+            if (!inverted_)\n+               setBackgroundColor(codeVal);\n+            else\n+               setForegroundColor(Color.bgToFgColor(codeVal));\n          }\n          else if (codeVal == RESET_FOREGROUND)\n          {\n-            currentColor_.reset();\n-            resetForeground();\n+            if (!inverted_)\n+            {\n+               currentColor_.reset();\n+               resetForeground();\n+            }\n+            else\n+            {\n+               currentBgColor_.reset();\n+               resetBackground();\n+               clazzes_.add(INVERSE_BG_STYLE);\n+            }\n          }\n          else if (codeVal == RESET_BACKGROUND)\n          {\n-            currentBgColor_.reset();\n-            resetBackground();\n+            if (!inverted_)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c156281381c1edfe674ad356bbdaae6856aa2c66"}, "originalPosition": 309}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 50, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}