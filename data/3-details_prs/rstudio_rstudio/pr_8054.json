{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyODM5NDI4", "number": 8054, "title": "avoid serializing cpp11 preserve env", "bodyText": "Intent\nWhen the cpp11 package is loaded, it places an environment on the search path that causes a segfault when one attempts to serialize it.\nApproach\nDon't serialize it.\nQA Notes\nTest via notes in rstudio/rstudio-pro#2052.\nCloses rstudio/rstudio-pro#2052. Note that ultimately I believe this needs to be fixed in cpp11 somehow, but this is at least an interim solution.", "createdAt": "2020-10-13T21:03:36Z", "url": "https://github.com/rstudio/rstudio/pull/8054", "merged": true, "mergeCommit": {"oid": "b9ab550db64ebf0cf761fd6a82b0914a1d556849"}, "closed": true, "closedAt": "2020-10-13T22:48:20Z", "author": {"login": "kevinushey"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSPJMAgH2gAyNTAyODM5NDI4OjljMjI2ZjlkNTQyMWE5MDkzMTU2Y2VmZTk4NDI1NmNkNDU2MWE5NTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSP9zMgFqTUwNzg2MTA3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9c226f9d5421a9093156cefe984256cd4561a951", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/9c226f9d5421a9093156cefe984256cd4561a951", "committedDate": "2020-10-13T21:06:29Z", "message": "avoid serializing cpp11 preserve env"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c13cd7abc676269212decab899fc3aa3160ce841", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/c13cd7abc676269212decab899fc3aa3160ce841", "committedDate": "2020-10-13T21:01:48Z", "message": "avoid serializing cpp11 preserve env"}, "afterCommit": {"oid": "9c226f9d5421a9093156cefe984256cd4561a951", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/9c226f9d5421a9093156cefe984256cd4561a951", "committedDate": "2020-10-13T21:06:29Z", "message": "avoid serializing cpp11 preserve env"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "196f6cdd22e791c5c74afd9970912072a491f044", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/196f6cdd22e791c5c74afd9970912072a491f044", "committedDate": "2020-10-13T21:07:45Z", "message": "tweaks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3ODM1OTc2", "url": "https://github.com/rstudio/rstudio/pull/8054#pullrequestreview-507835976", "createdAt": "2020-10-13T21:18:10Z", "commit": {"oid": "196f6cdd22e791c5c74afd9970912072a491f044"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QyMToxODoxMFrOHg52Cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QyMToxODo1NFrOHg53Tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI2NDIwMg==", "bodyText": "Maybe we should add a comment here about why and link to this issue? (so future maintainers can decide whether this workaround is safe to remove)", "url": "https://github.com/rstudio/rstudio/pull/8054#discussion_r504264202", "createdAt": "2020-10-13T21:18:10Z", "author": {"login": "jmcphers"}, "path": "src/cpp/r/R/Tools.R", "diffHunk": "@@ -170,28 +170,45 @@ environment(.rs.Env[[\".rs.addFunction\"]]) <- .rs.Env\n })\n \n # save current state of options() to file\n-.rs.addFunction( \"saveOptions\", function(filename)\n+.rs.addFunction(\"saveOptions\", function(filename)\n {\n-   opt = options();\n-   suppressWarnings(save(opt, file=filename))\n+   # get reference to current options\n+   opt <- options()\n+   \n+   # don't attempt to serialize cpp11 preserve env", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "196f6cdd22e791c5c74afd9970912072a491f044"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI2NDUyNg==", "bodyText": "What happens if this fails?", "url": "https://github.com/rstudio/rstudio/pull/8054#discussion_r504264526", "createdAt": "2020-10-13T21:18:54Z", "author": {"login": "jmcphers"}, "path": "src/cpp/r/R/Tools.R", "diffHunk": "@@ -170,28 +170,45 @@ environment(.rs.Env[[\".rs.addFunction\"]]) <- .rs.Env\n })\n \n # save current state of options() to file\n-.rs.addFunction( \"saveOptions\", function(filename)\n+.rs.addFunction(\"saveOptions\", function(filename)\n {\n-   opt = options();\n-   suppressWarnings(save(opt, file=filename))\n+   # get reference to current options\n+   opt <- options()\n+   \n+   # don't attempt to serialize cpp11 preserve env\n+   opt$cpp11_preserve_env <- NULL\n+   \n+   # first write to sidecar file, and then rename that file\n+   # (don't let failed serialization leave behind broken workspace)\n+   sidecarFile <- paste(filename, \"incomplete\", sep = \".\")\n+   \n+   # remove an old sidecar file if any -- these would be leftover from\n+   # a previously-failed attempt to save the session\n+   unlink(sidecarFile)\n+   \n+   # now, attempt to save\n+   suppressWarnings(save(opt, file = sidecarFile))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "196f6cdd22e791c5c74afd9970912072a491f044"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5aa97581bdcf5225ed87958106e4aeffc156cac", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/a5aa97581bdcf5225ed87958106e4aeffc156cac", "committedDate": "2020-10-13T22:01:03Z", "message": "add comment; try to catch save errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3ODYxMDc5", "url": "https://github.com/rstudio/rstudio/pull/8054#pullrequestreview-507861079", "createdAt": "2020-10-13T22:03:57Z", "commit": {"oid": "a5aa97581bdcf5225ed87958106e4aeffc156cac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4927, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}