{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2NDExNzQz", "number": 6443, "title": "tutorial pane bugfixes", "bodyText": "This PR fixes a number of issues with the Tutorial pane.\n\n\nTutorials can now be stopped after a browser refresh, regardless of whether RStudio Server is proxying URLs or not. This is accomplished by tagging running tutorials with both the underlying Shiny URL, as well as the proxied URL. This also allows us to avoid maintaining any extra state client-side -- as long as we have the tutorial URL, we can find the underlying running tutorial.\n\n\nPopped-out tutorials now have their underlying tutorial stopped when the associated window is closed.\n\n\nIf a user pops out a tutorial, leaves that window open, and later tries to restart that tutorial, we will bring that popped-out window to the front rather than attempt to launch a second instance of that tutorial.", "createdAt": "2020-03-10T23:28:22Z", "url": "https://github.com/rstudio/rstudio/pull/6443", "merged": true, "mergeCommit": {"oid": "22285ffa8a379e610e3c7ac22c9313b2f49f3016"}, "closed": true, "closedAt": "2020-03-11T18:49:10Z", "author": {"login": "kevinushey"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMZ8JnAH2gAyMzg2NDExNzQzOjQyYTUzMjZlYzg5OTg1ODA1MjMwMDJiNTZiZWRkOTFlYjFlMWYxNzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMroSpAH2gAyMzg2NDExNzQzOjFhNGY0YWFjYzdiY2ZhYzVmOTI0YTkwOTE4YmUyMzA3MDAzOTg1OTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "42a5326ec8998580523002b56bedd91eb1e1f174", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/42a5326ec8998580523002b56bedd91eb1e1f174", "committedDate": "2020-03-10T22:06:30Z", "message": "improve handling of tutorial URLs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7302d52236e3aa226e565f7c930f65a8d25656b", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/b7302d52236e3aa226e565f7c930f65a8d25656b", "committedDate": "2020-03-10T22:43:58Z", "message": "monitor popped out tutorial windows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef059e0e6688a8274830816e004d952922db23f0", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/ef059e0e6688a8274830816e004d952922db23f0", "committedDate": "2020-03-10T23:23:25Z", "message": "improve handling of popped-out tutorial windows"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMzg5MzI1", "url": "https://github.com/rstudio/rstudio/pull/6443#pullrequestreview-372389325", "createdAt": "2020-03-10T23:30:52Z", "commit": {"oid": "ef059e0e6688a8274830816e004d952922db23f0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMzozMDo1MlrOF0klKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMzozMDo1MlrOF0klKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY2OTYwOQ==", "bodyText": "This feels pretty ugly, but I couldn't find a better way to get notified of a closed child window that worked both in server and desktop sessions.", "url": "https://github.com/rstudio/rstudio/pull/6443#discussion_r390669609", "createdAt": "2020-03-10T23:30:52Z", "author": {"login": "kevinushey"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/tutorial/TutorialPane.java", "diffHunk": "@@ -409,6 +447,74 @@ private final native void initTutorialJsCallbacks()\n       \n    }-*/;\n    \n+   private final native void initExternalWindowJsCallbacks(WindowEx window,\n+                                                           String tutorialUrl,\n+                                                           String tutorialName,\n+                                                           String tutorialPackage)\n+   /*-{\n+      \n+      // register this window\n+      $wnd.tutorialWindows = $wnd.tutorialWindows || {};\n+      $wnd.tutorialWindows[tutorialUrl] = {\n+         \"package\": tutorialPackage,\n+         \"name\": tutorialName,\n+         \"window\": window\n+      };\n+      \n+      // start polling for window closure", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef059e0e6688a8274830816e004d952922db23f0"}, "originalPosition": 137}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMzkzNzA2", "url": "https://github.com/rstudio/rstudio/pull/6443#pullrequestreview-372393706", "createdAt": "2020-03-10T23:43:52Z", "commit": {"oid": "ef059e0e6688a8274830816e004d952922db23f0"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMzo0Mzo1MlrOF0kz5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMzo0NDoxMFrOF0k0RA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY3MzM4Mw==", "bodyText": "This is fine, but could be made more responsive (and avoid polling) by having the tutorial window notify us when it's closed. Is that feasible here? (IIRC we usually do this with something like ShinyDisconnectNotifier, but not sure if that's practical here since we don't wrap the tutorial in a frame we control)", "url": "https://github.com/rstudio/rstudio/pull/6443#discussion_r390673383", "createdAt": "2020-03-10T23:43:52Z", "author": {"login": "jmcphers"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/tutorial/TutorialPane.java", "diffHunk": "@@ -409,6 +447,74 @@ private final native void initTutorialJsCallbacks()\n       \n    }-*/;\n    \n+   private final native void initExternalWindowJsCallbacks(WindowEx window,\n+                                                           String tutorialUrl,\n+                                                           String tutorialName,\n+                                                           String tutorialPackage)\n+   /*-{\n+      \n+      // register this window\n+      $wnd.tutorialWindows = $wnd.tutorialWindows || {};\n+      $wnd.tutorialWindows[tutorialUrl] = {\n+         \"package\": tutorialPackage,\n+         \"name\": tutorialName,\n+         \"window\": window\n+      };\n+      \n+      // start polling for window closure\n+      var self = this;\n+      $wnd.tutorialWindowsCallback = $wnd.tutorialWindowsCallback || setInterval(function() {\n+         \n+         // stop any tutorials whose associated window was closed\n+         for (var url in $wnd.tutorialWindows)\n+         {\n+            var entry = $wnd.tutorialWindows[url];\n+            \n+            var window = entry[\"window\"];\n+            if (window.closed)\n+            {\n+               self.@org.rstudio.studio.client.workbench.views.tutorial.TutorialPane::stopTutorial(*)(url);\n+               delete $wnd.tutorialWindows[url];\n+            }\n+         }\n+         \n+         // stop polling if we have no more child windows\n+         var keys = Object.keys($wnd.tutorialWindows);\n+         if (keys.length === 0)\n+         {\n+            clearInterval($wnd.tutorialWindowsCallback);\n+            $wnd.tutorialWindowsCallback = null;\n+         }\n+         \n+      }, 500);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef059e0e6688a8274830816e004d952922db23f0"}, "originalPosition": 162}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY3MzQ3Ng==", "bodyText": "Meant to be ===?", "url": "https://github.com/rstudio/rstudio/pull/6443#discussion_r390673476", "createdAt": "2020-03-10T23:44:10Z", "author": {"login": "jmcphers"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/tutorial/TutorialPane.java", "diffHunk": "@@ -409,6 +447,74 @@ private final native void initTutorialJsCallbacks()\n       \n    }-*/;\n    \n+   private final native void initExternalWindowJsCallbacks(WindowEx window,\n+                                                           String tutorialUrl,\n+                                                           String tutorialName,\n+                                                           String tutorialPackage)\n+   /*-{\n+      \n+      // register this window\n+      $wnd.tutorialWindows = $wnd.tutorialWindows || {};\n+      $wnd.tutorialWindows[tutorialUrl] = {\n+         \"package\": tutorialPackage,\n+         \"name\": tutorialName,\n+         \"window\": window\n+      };\n+      \n+      // start polling for window closure\n+      var self = this;\n+      $wnd.tutorialWindowsCallback = $wnd.tutorialWindowsCallback || setInterval(function() {\n+         \n+         // stop any tutorials whose associated window was closed\n+         for (var url in $wnd.tutorialWindows)\n+         {\n+            var entry = $wnd.tutorialWindows[url];\n+            \n+            var window = entry[\"window\"];\n+            if (window.closed)\n+            {\n+               self.@org.rstudio.studio.client.workbench.views.tutorial.TutorialPane::stopTutorial(*)(url);\n+               delete $wnd.tutorialWindows[url];\n+            }\n+         }\n+         \n+         // stop polling if we have no more child windows\n+         var keys = Object.keys($wnd.tutorialWindows);\n+         if (keys.length === 0)\n+         {\n+            clearInterval($wnd.tutorialWindowsCallback);\n+            $wnd.tutorialWindowsCallback = null;\n+         }\n+         \n+      }, 500);\n+      \n+   }-*/;\n+   \n+   private final native boolean focusExistingTutorialWindow(String tutorialName,\n+                                                            String tutorialPackage)\n+   /*-{\n+   \n+      var windows = $wnd.tutorialWindows || {};\n+      for (var url in windows)\n+      {\n+         var entry = $wnd.tutorialWindows[url];\n+         \n+         var match =\n+            entry[\"name\"] === tutorialName &&\n+            entry[\"package\"] == tutorialPackage;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef059e0e6688a8274830816e004d952922db23f0"}, "originalPosition": 177}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3733de8cf49a628c6d3d3de8d0ba049b0af003b5", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/3733de8cf49a628c6d3d3de8d0ba049b0af003b5", "committedDate": "2020-03-11T18:35:29Z", "message": "use desktop APIs for activating window on desktop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a4f4aacc7bcfac5f924a90918be230700398591", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/1a4f4aacc7bcfac5f924a90918be230700398591", "committedDate": "2020-03-11T18:43:06Z", "message": "fix '==='"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 289, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}