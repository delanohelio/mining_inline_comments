{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNTUyNzkx", "number": 6610, "title": "use shebang to infer filetype when appropriate", "bodyText": "For files which have an unknown / \"text\" file type, attempt to infer an appropriate source filetype based on the shebang in the file (if any).\nCloses #5643.", "createdAt": "2020-04-07T23:35:43Z", "url": "https://github.com/rstudio/rstudio/pull/6610", "merged": true, "mergeCommit": {"oid": "a92a3370036f4cdee577e81f07ede3cc5876a85f"}, "closed": true, "closedAt": "2020-04-24T22:47:11Z", "author": {"login": "kevinushey"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVb2keAH2gAyNDAwNTUyNzkxOjY1YzE0ODE0OWNiNGE4MDM1MWI1MTg3OTQ1ZDc2YTcyNzk3NzgzNzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABca5fO6gH2gAyNDAwNTUyNzkxOjQwY2NjZGVhMjAyMDA1ZWFmNDJhYWJjZTA3OWFiYTkyODE3NTRmNTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "65c148149cb4a80351b5187945d76a7279778374", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/65c148149cb4a80351b5187945d76a7279778374", "committedDate": "2020-04-07T23:25:32Z", "message": "detect document type from shebang"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60bf1532b35651177545fbec44276aa5bb5a6ee6", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/60bf1532b35651177545fbec44276aa5bb5a6ee6", "committedDate": "2020-04-07T23:31:48Z", "message": "remove debug logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba97e30bf4058ecdc7932fe3e3b1b4febc6f1f08", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/ba97e30bf4058ecdc7932fe3e3b1b4febc6f1f08", "committedDate": "2020-04-07T23:32:53Z", "message": "support littler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ce0b9f852bf469a0c3042d0a61c85c31db294bf", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/5ce0b9f852bf469a0c3042d0a61c85c31db294bf", "committedDate": "2020-04-07T23:33:56Z", "message": "explicitly close ifs after read"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMTg3OTcx", "url": "https://github.com/rstudio/rstudio/pull/6610#pullrequestreview-390187971", "createdAt": "2020-04-08T17:35:15Z", "commit": {"oid": "5ce0b9f852bf469a0c3042d0a61c85c31db294bf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNDEzMDU0", "url": "https://github.com/rstudio/rstudio/pull/6610#pullrequestreview-390413054", "createdAt": "2020-04-09T00:11:52Z", "commit": {"oid": "5ce0b9f852bf469a0c3042d0a61c85c31db294bf"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMDoxMTo1MlrOGDFSsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwMDoxMzoxMlrOGDFUIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg4NTYxOQ==", "bodyText": "If memory serves this isn't exception-safe. Maybe use FilePath::openForRead?", "url": "https://github.com/rstudio/rstudio/pull/6610#discussion_r405885619", "createdAt": "2020-04-09T00:11:52Z", "author": {"login": "jmcphers"}, "path": "src/cpp/session/modules/SessionSource.cpp", "diffHunk": "@@ -69,6 +71,52 @@ namespace {\n module_context::WaitForMethodFunction s_waitForRequestDocumentSave;\n module_context::WaitForMethodFunction s_waitForRequestDocumentClose;\n \n+std::string inferDocumentType(const FilePath& documentPath,\n+                              const std::string& defaultType)\n+{\n+   // read first line in document\n+   std::ifstream ifs(documentPath.getAbsolutePath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ce0b9f852bf469a0c3042d0a61c85c31db294bf"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg4NTk4NA==", "bodyText": "I think csh and ksh are pretty common, too.", "url": "https://github.com/rstudio/rstudio/pull/6610#discussion_r405885984", "createdAt": "2020-04-09T00:13:12Z", "author": {"login": "jmcphers"}, "path": "src/cpp/session/modules/SessionSource.cpp", "diffHunk": "@@ -69,6 +71,52 @@ namespace {\n module_context::WaitForMethodFunction s_waitForRequestDocumentSave;\n module_context::WaitForMethodFunction s_waitForRequestDocumentClose;\n \n+std::string inferDocumentType(const FilePath& documentPath,\n+                              const std::string& defaultType)\n+{\n+   // read first line in document\n+   std::ifstream ifs(documentPath.getAbsolutePath());\n+   if (!ifs.is_open())\n+      return defaultType;\n+ \n+   // try to read the first line\n+   std::string line;\n+   std::getline(ifs, line);\n+   ifs.close();\n+   \n+   // check for a shebang line\n+   if (!boost::algorithm::starts_with(line, \"#!\"))\n+      return defaultType;\n+   \n+   // use heuristics to guess the file type\n+   boost::regex pattern(\"(?:\\\\s|/)([^\\\\s/]+)(?=\\\\s|$)\");\n+   boost::sregex_token_iterator it(line.begin(), line.end(), pattern, 1);\n+   boost::sregex_token_iterator end;\n+   for (; it != end; ++it)\n+   {\n+      // skip things that look like flags\n+      if (boost::algorithm::starts_with(*it, \"-\"))\n+         continue;\n+      \n+      // check for common shells\n+      for (auto&& shell : {\"sh\", \"bash\", \"fish\", \"zsh\"})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ce0b9f852bf469a0c3042d0a61c85c31db294bf"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40cccdea202005eaf42aabce079aba9281754f56", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/40cccdea202005eaf42aabce079aba9281754f56", "committedDate": "2020-04-24T22:46:49Z", "message": "check for 'csh', 'ksh'"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 326, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}