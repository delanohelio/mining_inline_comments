{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3NzcxMTYw", "number": 6101, "title": "Check for write permissions before performing a global replace", "bodyText": "Fixes #6048\nGlobal replace functionality works by copying the contents of the initial file to a temporary file while replacing every occurrence of the specified value - it then overrides the original file with the new file by performing a move. This caused the replace to work even when RStudio didn't have write permissions for that file.\nThis PR tests if the original file can be written to before starting the replace process and immediately before performing the move. This will prevent the process from going forward with replace logic when it fails on the first check, and ensure the permissions were not changed by an outside process immediately before the move.\nThis PR also fixes a, possibly impossible with the current UI, bug that was discovered while writing R unit tests where the grep command would have invalid syntax if a blank space was passed for the include or exclude tags.", "createdAt": "2020-01-28T00:27:16Z", "url": "https://github.com/rstudio/rstudio/pull/6101", "merged": true, "mergeCommit": {"oid": "242ac8d16268c56c6b5a1aed2ef200ef23b9d889"}, "closed": true, "closedAt": "2020-02-04T22:18:48Z", "author": {"login": "melissa-barca"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9TzVzgH2gAyMzY3NzcxMTYwOjM2YjYxNjhmNTk4ZTFjN2E4MDdiMTc0NTkwNmUxM2JmNDNhN2M2OTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBJAZRgFqTM1MzMzNzc5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "36b6168f598e1c7a807b1745906e13bf43a7c693", "author": {"user": {"login": "melissa-barca", "name": "Melissa Barca"}}, "url": "https://github.com/rstudio/rstudio/commit/36b6168f598e1c7a807b1745906e13bf43a7c693", "committedDate": "2020-01-24T00:28:35Z", "message": "check for write permissions before performing a replace\nfix rare bug where --include broke the grep command"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MDcyNzYw", "url": "https://github.com/rstudio/rstudio/pull/6101#pullrequestreview-349072760", "createdAt": "2020-01-28T00:46:15Z", "commit": {"oid": "36b6168f598e1c7a807b1745906e13bf43a7c693"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwMDo0NjoxNVrOFiWT9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwMDo0NjoxNVrOFiWT9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTU2MTQ2Mg==", "bodyText": "I'm not sure if there's a general use case for a test like this. If there is it would be good to have such a function in FilePath.hpp/cpp. What do you think @jmcphers?", "url": "https://github.com/rstudio/rstudio/pull/6101#discussion_r371561462", "createdAt": "2020-01-28T00:46:15Z", "author": {"login": "MariaSemple"}, "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -470,6 +470,12 @@ class GrepOperation : public boost::enable_shared_from_this<GrepOperation>\n       }\n    }\n \n+   Error testWritePermissions(const FilePath& filePath)\n+   {\n+      std::shared_ptr<std::ostream> testStream;\n+      return filePath.openForWrite(testStream, /*in_truncate*/ false);\n+   }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36b6168f598e1c7a807b1745906e13bf43a7c693"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MDcyODE3", "url": "https://github.com/rstudio/rstudio/pull/6101#pullrequestreview-349072817", "createdAt": "2020-01-28T00:46:27Z", "commit": {"oid": "36b6168f598e1c7a807b1745906e13bf43a7c693"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "987b8997146d0e89190aa21f27bb42f922a0b55c", "author": {"user": {"login": "melissa-barca", "name": "Melissa Barca"}}, "url": "https://github.com/rstudio/rstudio/commit/987b8997146d0e89190aa21f27bb42f922a0b55c", "committedDate": "2020-01-29T20:05:06Z", "message": "Merge branch 'bugfix/replace-respect-permissions' of https://github.com/rstudio/rstudio into bugfix/replace-respect-permissions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5718f2de34bd15d80ac0ddc61ee48e7b88e82977", "author": {"user": {"login": "melissa-barca", "name": "Melissa Barca"}}, "url": "https://github.com/rstudio/rstudio/commit/5718f2de34bd15d80ac0ddc61ee48e7b88e82977", "committedDate": "2020-02-03T18:09:50Z", "message": "Move testWritePermissions to FilePath.*\nFix bug where detailed error message was being overwritten"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "31f9db6b2cee9965e48e0d22117033f0d7d70f2b", "author": {"user": {"login": "melissa-barca", "name": "Melissa Barca"}}, "url": "https://github.com/rstudio/rstudio/commit/31f9db6b2cee9965e48e0d22117033f0d7d70f2b", "committedDate": "2020-02-03T17:57:22Z", "message": "Move testWritePermissions to FilePath.*\nFix bug where detailed error message was being overwritten"}, "afterCommit": {"oid": "5718f2de34bd15d80ac0ddc61ee48e7b88e82977", "author": {"user": {"login": "melissa-barca", "name": "Melissa Barca"}}, "url": "https://github.com/rstudio/rstudio/commit/5718f2de34bd15d80ac0ddc61ee48e7b88e82977", "committedDate": "2020-02-03T18:09:50Z", "message": "Move testWritePermissions to FilePath.*\nFix bug where detailed error message was being overwritten"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNTA1OTAy", "url": "https://github.com/rstudio/rstudio/pull/6101#pullrequestreview-352505902", "createdAt": "2020-02-03T19:31:51Z", "commit": {"oid": "5718f2de34bd15d80ac0ddc61ee48e7b88e82977"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxOTozMTo1MlrOFk9P9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxOTozMzoxMlrOFk9SiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI5NjU2Nw==", "bodyText": "Nit: methods in shared_core files are alphabetical. Could you move this just before the private: section? Also in the CPP file.", "url": "https://github.com/rstudio/rstudio/pull/6101#discussion_r374296567", "createdAt": "2020-02-03T19:31:52Z", "author": {"login": "MariaSemple"}, "path": "src/cpp/shared_core/include/shared_core/FilePath.hpp", "diffHunk": "@@ -573,6 +573,14 @@ class FilePath\n     */\n    Error openForWrite(std::shared_ptr<std::ostream>& out_stream, bool in_truncate = true) const;\n \n+   /*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5718f2de34bd15d80ac0ddc61ee48e7b88e82977"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI5NzIyNA==", "bodyText": "Nit: periods at the ends of the sentences and a blank comment line between the @brief and long descriptions.", "url": "https://github.com/rstudio/rstudio/pull/6101#discussion_r374297224", "createdAt": "2020-02-03T19:33:12Z", "author": {"login": "MariaSemple"}, "path": "src/cpp/shared_core/include/shared_core/FilePath.hpp", "diffHunk": "@@ -573,6 +573,14 @@ class FilePath\n     */\n    Error openForWrite(std::shared_ptr<std::ostream>& out_stream, bool in_truncate = true) const;\n \n+   /*\n+    * @brief Checks if a file can be written to by opening the file", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5718f2de34bd15d80ac0ddc61ee48e7b88e82977"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b49b150ec91bff6db2994cfa9f234f5f99e4c811", "author": {"user": {"login": "melissa-barca", "name": "Melissa Barca"}}, "url": "https://github.com/rstudio/rstudio/commit/b49b150ec91bff6db2994cfa9f234f5f99e4c811", "committedDate": "2020-02-03T20:02:56Z", "message": "clean up testWritePermissions placement and comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNTI2NjU5", "url": "https://github.com/rstudio/rstudio/pull/6101#pullrequestreview-352526659", "createdAt": "2020-02-03T20:05:05Z", "commit": {"oid": "b49b150ec91bff6db2994cfa9f234f5f99e4c811"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMDowNTowNVrOFk-Pwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMDowNTowNVrOFk-Pwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDMxMjg5OA==", "bodyText": "Do you know if this could create an empty file on disk if the file doesn't exist? I'm not sure.", "url": "https://github.com/rstudio/rstudio/pull/6101#discussion_r374312898", "createdAt": "2020-02-03T20:05:05Z", "author": {"login": "MariaSemple"}, "path": "src/cpp/shared_core/FilePath.cpp", "diffHunk": "@@ -1295,6 +1289,12 @@ void FilePath::setLastWriteTime(std::time_t in_time) const\n    }\n }\n \n+Error FilePath::testWritePermissions() const\n+{\n+   std::shared_ptr<std::ostream> testStream;\n+   return openForWrite(testStream, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b49b150ec91bff6db2994cfa9f234f5f99e4c811"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f65e568ca2787d96b49d78d1fc508825e09f2aed", "author": {"user": {"login": "melissa-barca", "name": "Melissa Barca"}}, "url": "https://github.com/rstudio/rstudio/commit/f65e568ca2787d96b49d78d1fc508825e09f2aed", "committedDate": "2020-02-03T21:33:24Z", "message": "update testWritePermissions so it will not create the specified file if it doesn't exist"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNTgxNTQx", "url": "https://github.com/rstudio/rstudio/pull/6101#pullrequestreview-352581541", "createdAt": "2020-02-03T21:38:51Z", "commit": {"oid": "f65e568ca2787d96b49d78d1fc508825e09f2aed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMTozODo1MVrOFlA3sA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QyMTozODo1MVrOFlA3sA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDM1NTg4OA==", "bodyText": "Right now the ostream will be leaked if the function completes successfully. In openForWrite, the ownership is transferred to a smart pointer before the function exits. I think we should delete it before returning Success.\nThis also opens another question (which applies to the existing implementation of openForWrite) - is it possible for pResult to be initialized when an exception is thrown? In that case, the ostream would be leaked in that case as well. We could avoid this in both places by declaring the pResult outside of the try and deleting it in the catch if it's not null.", "url": "https://github.com/rstudio/rstudio/pull/6101#discussion_r374355888", "createdAt": "2020-02-03T21:38:51Z", "author": {"login": "MariaSemple"}, "path": "src/cpp/shared_core/FilePath.cpp", "diffHunk": "@@ -1291,8 +1291,52 @@ void FilePath::setLastWriteTime(std::time_t in_time) const\n \n Error FilePath::testWritePermissions() const\n {\n-   std::shared_ptr<std::ostream> testStream;\n-   return openForWrite(testStream, false);\n+   try\n+   {\n+      std::ostream* pResult = nullptr;\n+#ifdef _WIN32\n+      using namespace boost::iostreams;\n+      HANDLE hFile = ::CreateFileW(m_impl->Path.wstring().c_str(),\n+                                   FILE_APPEND_DATA,\n+                                   0, // exclusive access\n+                                   nullptr,\n+                                   OPEN_EXISTING,\n+                                   0,\n+                                   nullptr);\n+      if (hFile == INVALID_HANDLE_VALUE)\n+      {\n+         Error error = LAST_SYSTEM_ERROR();\n+         error.addProperty(\"path\", getAbsolutePath());\n+         return error;\n+      }\n+      file_descriptor_sink fd;\n+      fd.open(hFile, close_handle);\n+      pResult = new boost::iostreams::stream<file_descriptor_sink>(fd);\n+#else\n+      using std::ios_base;\n+      ios_base::openmode flags = ios_base::in | ios_base::out | ios_base::binary;\n+      pResult = new std::ofstream(getAbsolutePath().c_str(), flags);\n+#endif\n+\n+      if (!(*pResult))\n+      {\n+         delete pResult;\n+\n+         Error error = systemError(boost::system::errc::no_such_file_or_directory, ERROR_LOCATION);\n+         error.addProperty(\"path\", getAbsolutePath());\n+         return error;\n+      }\n+   }\n+   catch(const std::exception& e)\n+   {\n+      Error error = systemError(boost::system::errc::io_error,\n+                                ERROR_LOCATION);\n+      error.addProperty(\"what\", e.what());\n+      error.addProperty(\"path\", getAbsolutePath());\n+      return error;\n+   }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f65e568ca2787d96b49d78d1fc508825e09f2aed"}, "originalPosition": 50}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c9f84514411dba97885d12f0b2a92bab41c635b", "author": {"user": {"login": "melissa-barca", "name": "Melissa Barca"}}, "url": "https://github.com/rstudio/rstudio/commit/2c9f84514411dba97885d12f0b2a92bab41c635b", "committedDate": "2020-02-04T01:32:17Z", "message": "modify FilePath functions to prevent leaks"}, "afterCommit": {"oid": "43da417dad06915de7faa7b63b41746d0b63fb91", "author": {"user": {"login": "melissa-barca", "name": "Melissa Barca"}}, "url": "https://github.com/rstudio/rstudio/commit/43da417dad06915de7faa7b63b41746d0b63fb91", "committedDate": "2020-02-04T01:42:32Z", "message": "modify FilePath functions to prevent leaks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNjk2NzIy", "url": "https://github.com/rstudio/rstudio/pull/6101#pullrequestreview-352696722", "createdAt": "2020-02-04T02:52:46Z", "commit": {"oid": "2c9f84514411dba97885d12f0b2a92bab41c635b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "43da417dad06915de7faa7b63b41746d0b63fb91", "author": {"user": {"login": "melissa-barca", "name": "Melissa Barca"}}, "url": "https://github.com/rstudio/rstudio/commit/43da417dad06915de7faa7b63b41746d0b63fb91", "committedDate": "2020-02-04T01:42:32Z", "message": "modify FilePath functions to prevent leaks"}, "afterCommit": {"oid": "7a52b167af893d0056947cbc41eae0cf16dd919e", "author": {"user": {"login": "melissa-barca", "name": "Melissa Barca"}}, "url": "https://github.com/rstudio/rstudio/commit/7a52b167af893d0056947cbc41eae0cf16dd919e", "committedDate": "2020-02-04T17:34:13Z", "message": "modify FilePath functions to prevent leaks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "566a218ab54e9fe57504d76a0243fe15039fca3b", "author": {"user": {"login": "melissa-barca", "name": "Melissa Barca"}}, "url": "https://github.com/rstudio/rstudio/commit/566a218ab54e9fe57504d76a0243fe15039fca3b", "committedDate": "2020-02-04T17:35:24Z", "message": "modify FilePath functions to prevent leaks"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7a52b167af893d0056947cbc41eae0cf16dd919e", "author": {"user": {"login": "melissa-barca", "name": "Melissa Barca"}}, "url": "https://github.com/rstudio/rstudio/commit/7a52b167af893d0056947cbc41eae0cf16dd919e", "committedDate": "2020-02-04T17:34:13Z", "message": "modify FilePath functions to prevent leaks"}, "afterCommit": {"oid": "566a218ab54e9fe57504d76a0243fe15039fca3b", "author": {"user": {"login": "melissa-barca", "name": "Melissa Barca"}}, "url": "https://github.com/rstudio/rstudio/commit/566a218ab54e9fe57504d76a0243fe15039fca3b", "committedDate": "2020-02-04T17:35:24Z", "message": "modify FilePath functions to prevent leaks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMzM3Nzky", "url": "https://github.com/rstudio/rstudio/pull/6101#pullrequestreview-353337792", "createdAt": "2020-02-04T22:09:35Z", "commit": {"oid": "566a218ab54e9fe57504d76a0243fe15039fca3b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 333, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}