{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4MDA5ODIw", "number": 7468, "title": "Delay rendering of Ace instances in visual mode", "bodyText": "This is a second attempt at improving the performance of Ace editors in visual mode by deferring the editor rendering until after visual mode has started up.\nThe first attempt was very intrusive to Ace internal state; this one tries to largely leave Ace alone. Instead of creating the editors and leaving them in an un-drawn state, it defers the creation of the editor entirely, instead showing a placeholder <pre> tag until the editor can be created and rendered in a single step.\nEditor rendering happens in a render queue prioritized by the viewport position; though it can take some time to render all of the editors in a large document, scrolling or navigation will cause the queue to get re-prioritized, such that the visible editors should get rendered quickly if you manage to scroll to them before they are rendered.", "createdAt": "2020-07-28T19:35:28Z", "url": "https://github.com/rstudio/rstudio/pull/7468", "merged": true, "mergeCommit": {"oid": "4cb573da9f85372735a49525cb1d93488dc1baa0"}, "closed": true, "closedAt": "2020-07-29T10:31:27Z", "author": {"login": "jmcphers"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5LBxBgH2gAyNDU4MDA5ODIwOjY0NmViYjRlN2QwNWU2M2ViZmE1ZTk1ODI5ODRhYmY5NzYxNmU2OWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5oZmmAFqTQ1NzM4NTU3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "646ebb4e7d05e63ebfa5e9582984abf97616e69e", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/646ebb4e7d05e63ebfa5e9582984abf97616e69e", "committedDate": "2020-07-28T00:10:39Z", "message": "delay rendering of embedded Ace widgets (WIP)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48a7b79b4627fc13090b902f939676dfb5a476d6", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/48a7b79b4627fc13090b902f939676dfb5a476d6", "committedDate": "2020-07-28T18:03:04Z", "message": "Merge remote-tracking branch 'origin/master' into feature/ace-visual-perf-v2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65bae8bca3a98ba65a827f6a76a0efe7ae426a44", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/65bae8bca3a98ba65a827f6a76a0efe7ae426a44", "committedDate": "2020-07-28T19:02:41Z", "message": "improve fidelity of preview; destroy queue when done"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2OTU2NDky", "url": "https://github.com/rstudio/rstudio/pull/7468#pullrequestreview-456956492", "createdAt": "2020-07-28T19:46:49Z", "commit": {"oid": "65bae8bca3a98ba65a827f6a76a0efe7ae426a44"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxOTo0Njo0OVrOG4cDKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxOTo0ODozMVrOG4cIQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgzMzAwMA==", "bodyText": "IIUC, querying offsetHeight can trigger reflow, so this might be expensive to do in a scroll handler. Not sure if this is an issue in practice for us but wonder if this is worth looking at?", "url": "https://github.com/rstudio/rstudio/pull/7468#discussion_r461833000", "createdAt": "2020-07-28T19:46:49Z", "author": {"login": "kevinushey"}, "path": "src/gwt/panmirror/src/editor/src/optional/ace/render_queue.ts", "diffHunk": "@@ -0,0 +1,215 @@\n+/*\n+ * render_queue.ts\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+\n+import { CodeBlockNodeView } from './ace';\n+\n+/**\n+ * Represents a queue of Ace editor instances that are rendered asynchronously.\n+ */\n+export class AceRenderQueue {\n+  private readonly renderQueue: CodeBlockNodeView[] = [];\n+\n+  private renderCompleted: boolean = false;\n+  private renderTimer: number = 0;\n+  private container?: HTMLElement;\n+  private needsSort: boolean = true;\n+  private bypass: number = 5;\n+  private observer?: IntersectionObserver;\n+  private visible: boolean = true;\n+\n+  /**\n+   * Sets (or replaces) the scroll container hosting the render queue. The\n+   * scroll container is used to prioritize the queue (i.e. objects in the\n+   * viewport or close to it are to be given more priority).\n+   * \n+   * @param container The HTML element of the scroll container\n+   */\n+  public setContainer(container: HTMLElement) {\n+\n+    // Handler for scroll events in the container\n+    const handleScroll = (evt: Event) => {\n+      // Whenever a scroll event occurs, we need to re-sort the queue so that\n+      // objects in or closest to the viewport are given priority.\n+      this.needsSort = true;\n+\n+      // If we don't think we're visible but we're scrolling and have height,\n+      // then we are in fact visible. (This catches a case where the\n+      // intsersection observer created below doesn't fire for visiblity\n+      // changes.)\n+      if (!this.visible && this.container && this.container.offsetHeight > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65bae8bca3a98ba65a827f6a76a0efe7ae426a44"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgzMzYwMg==", "bodyText": "Do we need to support IE11?", "url": "https://github.com/rstudio/rstudio/pull/7468#discussion_r461833602", "createdAt": "2020-07-28T19:47:35Z", "author": {"login": "kevinushey"}, "path": "src/gwt/panmirror/src/editor/src/optional/ace/render_queue.ts", "diffHunk": "@@ -0,0 +1,215 @@\n+/*\n+ * render_queue.ts\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+\n+import { CodeBlockNodeView } from './ace';\n+\n+/**\n+ * Represents a queue of Ace editor instances that are rendered asynchronously.\n+ */\n+export class AceRenderQueue {\n+  private readonly renderQueue: CodeBlockNodeView[] = [];\n+\n+  private renderCompleted: boolean = false;\n+  private renderTimer: number = 0;\n+  private container?: HTMLElement;\n+  private needsSort: boolean = true;\n+  private bypass: number = 5;\n+  private observer?: IntersectionObserver;\n+  private visible: boolean = true;\n+\n+  /**\n+   * Sets (or replaces) the scroll container hosting the render queue. The\n+   * scroll container is used to prioritize the queue (i.e. objects in the\n+   * viewport or close to it are to be given more priority).\n+   * \n+   * @param container The HTML element of the scroll container\n+   */\n+  public setContainer(container: HTMLElement) {\n+\n+    // Handler for scroll events in the container\n+    const handleScroll = (evt: Event) => {\n+      // Whenever a scroll event occurs, we need to re-sort the queue so that\n+      // objects in or closest to the viewport are given priority.\n+      this.needsSort = true;\n+\n+      // If we don't think we're visible but we're scrolling and have height,\n+      // then we are in fact visible. (This catches a case where the\n+      // intsersection observer created below doesn't fire for visiblity\n+      // changes.)\n+      if (!this.visible && this.container && this.container.offsetHeight > 0) {\n+        this.visible = true;\n+        this.processRenderQueue();\n+      }\n+    };\n+\n+    // Skip if we're already looking at this container\n+    if (this.container === container) {\n+      return;\n+    }\n+\n+    // Clean up handlers on any previous container\n+    if (this.container) {\n+      this.container.removeEventListener(\"scroll\", handleScroll);\n+    }\n+    if (this.observer) {\n+      this.observer.disconnect();\n+    }\n+\n+    this.container = container;\n+\n+    // Create intersection observer to ensure that we don't needlessly churn\n+    // through renders while offscreen.\n+    this.observer = new IntersectionObserver((entries: IntersectionObserverEntry[]) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65bae8bca3a98ba65a827f6a76a0efe7ae426a44"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgzNDMwNQ==", "bodyText": "Should this.renderTimer be reset to 0 here?", "url": "https://github.com/rstudio/rstudio/pull/7468#discussion_r461834305", "createdAt": "2020-07-28T19:48:31Z", "author": {"login": "kevinushey"}, "path": "src/gwt/panmirror/src/editor/src/optional/ace/render_queue.ts", "diffHunk": "@@ -0,0 +1,215 @@\n+/*\n+ * render_queue.ts\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+\n+import { CodeBlockNodeView } from './ace';\n+\n+/**\n+ * Represents a queue of Ace editor instances that are rendered asynchronously.\n+ */\n+export class AceRenderQueue {\n+  private readonly renderQueue: CodeBlockNodeView[] = [];\n+\n+  private renderCompleted: boolean = false;\n+  private renderTimer: number = 0;\n+  private container?: HTMLElement;\n+  private needsSort: boolean = true;\n+  private bypass: number = 5;\n+  private observer?: IntersectionObserver;\n+  private visible: boolean = true;\n+\n+  /**\n+   * Sets (or replaces) the scroll container hosting the render queue. The\n+   * scroll container is used to prioritize the queue (i.e. objects in the\n+   * viewport or close to it are to be given more priority).\n+   * \n+   * @param container The HTML element of the scroll container\n+   */\n+  public setContainer(container: HTMLElement) {\n+\n+    // Handler for scroll events in the container\n+    const handleScroll = (evt: Event) => {\n+      // Whenever a scroll event occurs, we need to re-sort the queue so that\n+      // objects in or closest to the viewport are given priority.\n+      this.needsSort = true;\n+\n+      // If we don't think we're visible but we're scrolling and have height,\n+      // then we are in fact visible. (This catches a case where the\n+      // intsersection observer created below doesn't fire for visiblity\n+      // changes.)\n+      if (!this.visible && this.container && this.container.offsetHeight > 0) {\n+        this.visible = true;\n+        this.processRenderQueue();\n+      }\n+    };\n+\n+    // Skip if we're already looking at this container\n+    if (this.container === container) {\n+      return;\n+    }\n+\n+    // Clean up handlers on any previous container\n+    if (this.container) {\n+      this.container.removeEventListener(\"scroll\", handleScroll);\n+    }\n+    if (this.observer) {\n+      this.observer.disconnect();\n+    }\n+\n+    this.container = container;\n+\n+    // Create intersection observer to ensure that we don't needlessly churn\n+    // through renders while offscreen.\n+    this.observer = new IntersectionObserver((entries: IntersectionObserverEntry[]) => {\n+      for (const entry of entries) {\n+        if (entry.isIntersecting && !this.visible) {\n+          // We just became visible; process the render queue now.\n+          this.visible = true;\n+          this.processRenderQueue();\n+        }\n+        if (!entry.isIntersecting && this.visible) {\n+          // We just lost visibility; end processing of the render queue. (Note\n+          // that we only do this when connected to the DOM as another reason\n+          // the element can become invisible is ProseMirror swapping it out\n+          // internally.)\n+          if (this.container?.parentElement) {\n+            this.visible = false;\n+            if (this.renderTimer > 0) {\n+              window.clearTimeout(this.renderTimer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65bae8bca3a98ba65a827f6a76a0efe7ae426a44"}, "originalPosition": 89}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41f66205b9d1aac10dc50a1fb2c27b26d02abdea", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/41f66205b9d1aac10dc50a1fb2c27b26d02abdea", "committedDate": "2020-07-28T20:37:37Z", "message": "clear render timer consistently"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39211cf622d6d7b197d217f1057fcb96aa034fe2", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/39211cf622d6d7b197d217f1057fcb96aa034fe2", "committedDate": "2020-07-28T20:43:11Z", "message": "Merge remote-tracking branch 'origin/master' into feature/ace-visual-perf-v2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3Mzg1NTc5", "url": "https://github.com/rstudio/rstudio/pull/7468#pullrequestreview-457385579", "createdAt": "2020-07-29T10:16:48Z", "commit": {"oid": "39211cf622d6d7b197d217f1057fcb96aa034fe2"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMDoxNjo0OFrOG4yBEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMDoxNjo0OFrOG4yBEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE5MjkxMg==", "bodyText": "When the underlying Ace editor is actually created, do we need to forward the selection in the case that the user has managed to logically get the selection there before it has been rendered?", "url": "https://github.com/rstudio/rstudio/pull/7468#discussion_r462192912", "createdAt": "2020-07-29T10:16:48Z", "author": {"login": "jjallaire"}, "path": "src/gwt/panmirror/src/editor/src/optional/ace/ace.ts", "diffHunk": "@@ -367,6 +252,9 @@ class CodeBlockNodeView implements NodeView {\n   }\n \n   public setSelection(anchor: number, head: number) {\n+    if (!this.aceEditor || !this.editSession) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39211cf622d6d7b197d217f1057fcb96aa034fe2"}, "originalPosition": 313}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 30, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}