{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4NzI4ODEw", "number": 7817, "title": "remove grep color encodings when contents is not encoded", "bodyText": "Intent\nFixes #7736\nIf a user was outside of a project and didn't specify an encoding via Global Options, global replace would update files to include pieces of the color encodings from the grep command. used to find the pattern.\nApproach\nSome pieces of code were written under the impression that if no encoding was provided, there wasn't a need to decode the line. Decoding is not just for encodings different from UTF8, but is also used to parse the grep command.\nQA Notes\nThis specific issue occurred when the Default text encoding option was set to [Ask], but making changes to this code has a chance of affecting behavior on different operating systems. The changes here shouldn't affect the way global find/replace works for different encodings but it may be worth testing some anyways.\nNote there is an existing issue for issues with Windows and regexes that has been around since 1.2 (maybe 1.1) being tracked here: #7012", "createdAt": "2020-09-17T14:53:17Z", "url": "https://github.com/rstudio/rstudio/pull/7817", "merged": true, "mergeCommit": {"oid": "f3dea4b56030cd3627210dbaf01da9178289ff61"}, "closed": true, "closedAt": "2020-09-17T18:00:42Z", "author": {"login": "melissa-barca"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJx8f9gH2gAyNDg4NzI4ODEwOjU5YjNhMTVkYjgwMzJiZDE4NmIzOGMwOTdlMjRlMjI3YmYwMTc5NWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJ02cWgFqTQ5MDg1MjQ4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "59b3a15db8032bd186b38c097e24e227bf01795b", "author": {"user": {"login": "melissa-barca", "name": "Melissa Barca"}}, "url": "https://github.com/rstudio/rstudio/commit/59b3a15db8032bd186b38c097e24e227bf01795b", "committedDate": "2020-09-17T14:33:59Z", "message": "remove grep color encodings when contents is not encoded"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwNzc4MjYx", "url": "https://github.com/rstudio/rstudio/pull/7817#pullrequestreview-490778261", "createdAt": "2020-09-17T16:22:55Z", "commit": {"oid": "59b3a15db8032bd186b38c097e24e227bf01795b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNjoyMjo1NVrOHTrH1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNjoyMzozOFrOHTrLfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDM5MTUwOA==", "bodyText": "Is this assumption valid on Windows?", "url": "https://github.com/rstudio/rstudio/pull/7817#discussion_r490391508", "createdAt": "2020-09-17T16:22:55Z", "author": {"login": "jmcphers"}, "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -1363,6 +1351,8 @@ core::Error runGrepOperation(const GrepOptions& grepOptions, const ReplaceOption\n    std::string encoding = projects::projectContext().hasProject() ?\n                           projects::projectContext().defaultEncoding() :\n                           prefs::userPrefs().defaultEncoding();\n+   if (encoding.empty())\n+      encoding = \"UTF-8\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59b3a15db8032bd186b38c097e24e227bf01795b"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDM5MjQ0NA==", "bodyText": "Do we need to run iconvstr if the target encoding is UTF-8? (seems like asking it to convert UTF-8 to UTF-8 would be a noop)", "url": "https://github.com/rstudio/rstudio/pull/7817#discussion_r490392444", "createdAt": "2020-09-17T16:23:38Z", "author": {"login": "jmcphers"}, "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -1363,6 +1351,8 @@ core::Error runGrepOperation(const GrepOptions& grepOptions, const ReplaceOption\n    std::string encoding = projects::projectContext().hasProject() ?\n                           projects::projectContext().defaultEncoding() :\n                           prefs::userPrefs().defaultEncoding();\n+   if (encoding.empty())\n+      encoding = \"UTF-8\";\n    std::string encodedString;\n    error = r::util::iconvstr(grepOptions.searchPattern(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59b3a15db8032bd186b38c097e24e227bf01795b"}, "originalPosition": 90}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwODE4MTM2", "url": "https://github.com/rstudio/rstudio/pull/7817#pullrequestreview-490818136", "createdAt": "2020-09-17T17:13:00Z", "commit": {"oid": "d98ae0c348da0666cc55071891db6a0c0c809fbb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNzoxMzowMFrOHTtNBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNzoxMzowMFrOHTtNBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQyNTYwNA==", "bodyText": "Even if we believe this change needs to be made, it dramatically increases the surface area of this patch since we call iconvstr all over the place. As this is a last-minute change before shipping, let's limit the changes to the find and replace codepath so that we can feel 100% confident we haven't broken or changed any other behavior.", "url": "https://github.com/rstudio/rstudio/pull/7817#discussion_r490425604", "createdAt": "2020-09-17T17:13:00Z", "author": {"login": "jmcphers"}, "path": "src/cpp/r/RUtil.cpp", "diffHunk": "@@ -147,11 +147,7 @@ core::Error iconvstr(const std::string& value,\n                      std::string* pResult)\n {\n    std::string effectiveFrom = from;\n-   if (effectiveFrom.empty())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d98ae0c348da0666cc55071891db6a0c0c809fbb"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21af50e3eabb833e61b5c8a97d178547f83c69c5", "author": {"user": {"login": "melissa-barca", "name": "Melissa Barca"}}, "url": "https://github.com/rstudio/rstudio/commit/21af50e3eabb833e61b5c8a97d178547f83c69c5", "committedDate": "2020-09-17T17:16:37Z", "message": "remove assumtion that empty encoding is UTF 8 for Find in Files"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d98ae0c348da0666cc55071891db6a0c0c809fbb", "author": {"user": {"login": "melissa-barca", "name": "Melissa Barca"}}, "url": "https://github.com/rstudio/rstudio/commit/d98ae0c348da0666cc55071891db6a0c0c809fbb", "committedDate": "2020-09-17T17:07:29Z", "message": "remove incorrect assumption that a blank encoding is UTF-8. (not true for Windows)"}, "afterCommit": {"oid": "21af50e3eabb833e61b5c8a97d178547f83c69c5", "author": {"user": {"login": "melissa-barca", "name": "Melissa Barca"}}, "url": "https://github.com/rstudio/rstudio/commit/21af50e3eabb833e61b5c8a97d178547f83c69c5", "committedDate": "2020-09-17T17:16:37Z", "message": "remove assumtion that empty encoding is UTF 8 for Find in Files"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwODI0NDMw", "url": "https://github.com/rstudio/rstudio/pull/7817#pullrequestreview-490824430", "createdAt": "2020-09-17T17:21:19Z", "commit": {"oid": "21af50e3eabb833e61b5c8a97d178547f83c69c5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwODUyNDgy", "url": "https://github.com/rstudio/rstudio/pull/7817#pullrequestreview-490852482", "createdAt": "2020-09-17T17:57:05Z", "commit": {"oid": "21af50e3eabb833e61b5c8a97d178547f83c69c5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4982, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}