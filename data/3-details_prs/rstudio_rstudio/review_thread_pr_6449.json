{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2NzkyMTg0", "number": 6449, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNjo0MTo1NVrODnKCtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMzowNDoyMVrODnSGSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyMzg1NTg5OnYy", "diffSide": "RIGHT", "path": "src/cpp/session/modules/SessionFind.cpp", "isResolved": true, "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNjo0MTo1NVrOF0_cOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMjo1NToyMVrOF1MCbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEwOTY4OQ==", "bodyText": "When constructing a boost::filesystem::path from a std::string, some extra work is needed on Windows; see: \n  \n    \n      rstudio/src/cpp/shared_core/FilePath.cpp\n    \n    \n        Lines 224 to 246\n      in\n      6a45dc8\n    \n    \n    \n    \n\n        \n          \n           #ifdef _WIN32 \n        \n\n        \n          \n            \n        \n\n        \n          \n           // For Windows only, we need to use the wide character versions of the file \n        \n\n        \n          \n           // APIs in order to deal properly with characters that cannot be represented \n        \n\n        \n          \n           // in the default system encoding. (It would be preferable if UTF-8 were the \n        \n\n        \n          \n           // system encoding, but Windows doesn't support that.) However, we can't give \n        \n\n        \n          \n           // FilePath a wide character API because Mac needs to use narrow characters \n        \n\n        \n          \n           // (see note below). So we use wstring internally, and translate to/from UTF-8 \n        \n\n        \n          \n           // narrow strings that are used in the API. \n        \n\n        \n          \n            \n        \n\n        \n          \n           typedef std::wstring internal_string; \n        \n\n        \n          \n            \n        \n\n        \n          \n           std::string toString(const internal_string& value) \n        \n\n        \n          \n           { \n        \n\n        \n          \n              return string_utils::wideToUtf8(value); \n        \n\n        \n          \n           } \n        \n\n        \n          \n            \n        \n\n        \n          \n           internal_string fromString(const std::string& value) \n        \n\n        \n          \n           { \n        \n\n        \n          \n              return string_utils::utf8ToWide(value); \n        \n\n        \n          \n           } \n        \n\n        \n          \n            \n        \n\n        \n          \n           #else \n        \n    \n  \n\n\nThis is one reason that we almost never use raw boost::filesystem::path objects and instead always use our FilePath wrapper. You might consider making these set/get permissions methods part of the FilePath object itself (which stores a boost filesystem path internally).", "url": "https://github.com/rstudio/rstudio/pull/6449#discussion_r391109689", "createdAt": "2020-03-11T16:41:55Z", "author": {"login": "jmcphers"}, "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -487,6 +489,42 @@ class GrepOperation : public boost::enable_shared_from_this<GrepOperation>\n       }\n    }\n \n+   Error setPermissions(const std::string& filePath, boost::filesystem::perms permissions)\n+   {\n+      boost::filesystem::path path(filePath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f2941f7fcca290e1b705493cff3c1ebd0cd32d1"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTExNzY0Ng==", "bodyText": "At first I did have this as part of FilePath, but I felt weird having our wrapper functions directly pass and return boost::filesystem::perms without its own wrapper and implementing that seems like more work will little payoff. What are your thoughts on this?", "url": "https://github.com/rstudio/rstudio/pull/6449#discussion_r391117646", "createdAt": "2020-03-11T16:53:41Z", "author": {"login": "melissa-barca"}, "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -487,6 +489,42 @@ class GrepOperation : public boost::enable_shared_from_this<GrepOperation>\n       }\n    }\n \n+   Error setPermissions(const std::string& filePath, boost::filesystem::perms permissions)\n+   {\n+      boost::filesystem::path path(filePath);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEwOTY4OQ=="}, "originalCommit": {"oid": "4f2941f7fcca290e1b705493cff3c1ebd0cd32d1"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEyMjUxNQ==", "bodyText": "That's a good instinct; FilePath should abstract boost::filesystem completely so we shouldn't return filesystem internals like perms.\nI think we could greatly simplify this by skipping all permissions-related code on Windows. The only permission supported by boost::filesystem::perms on Windows is write permission... which is a tautology here since we just wrote to the file! https://www.boost.org/doc/libs/1_66_0/libs/filesystem/doc/reference.html#Enum-perms\nWe could also simplify it further by using ::stat and ::chmod directly instead of using the Boost wrappers around them (which would remove the need to handle exceptions and path wrappers); but I'll leave that up to your discretion.", "url": "https://github.com/rstudio/rstudio/pull/6449#discussion_r391122515", "createdAt": "2020-03-11T17:00:58Z", "author": {"login": "jmcphers"}, "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -487,6 +489,42 @@ class GrepOperation : public boost::enable_shared_from_this<GrepOperation>\n       }\n    }\n \n+   Error setPermissions(const std::string& filePath, boost::filesystem::perms permissions)\n+   {\n+      boost::filesystem::path path(filePath);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEwOTY4OQ=="}, "originalCommit": {"oid": "4f2941f7fcca290e1b705493cff3c1ebd0cd32d1"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIyNDIwOQ==", "bodyText": "Hi Jonathan, at this point I can't think of a strong argument to use ::stat and ::chmod over the boost permissions. I updated the code so these functions are not declared or called in Windows. Thanks!", "url": "https://github.com/rstudio/rstudio/pull/6449#discussion_r391224209", "createdAt": "2020-03-11T19:54:06Z", "author": {"login": "melissa-barca"}, "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -487,6 +489,42 @@ class GrepOperation : public boost::enable_shared_from_this<GrepOperation>\n       }\n    }\n \n+   Error setPermissions(const std::string& filePath, boost::filesystem::perms permissions)\n+   {\n+      boost::filesystem::path path(filePath);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEwOTY4OQ=="}, "originalCommit": {"oid": "4f2941f7fcca290e1b705493cff3c1ebd0cd32d1"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI0MjcyNA==", "bodyText": "Could we add an update/set permissions method on FilePath to resolve this?", "url": "https://github.com/rstudio/rstudio/pull/6449#discussion_r391242724", "createdAt": "2020-03-11T20:15:22Z", "author": {"login": "MariaSemple"}, "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -487,6 +489,42 @@ class GrepOperation : public boost::enable_shared_from_this<GrepOperation>\n       }\n    }\n \n+   Error setPermissions(const std::string& filePath, boost::filesystem::perms permissions)\n+   {\n+      boost::filesystem::path path(filePath);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEwOTY4OQ=="}, "originalCommit": {"oid": "4f2941f7fcca290e1b705493cff3c1ebd0cd32d1"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI1MDQ5MA==", "bodyText": "Maria pointed out that FileMode already has functions I can use so expect another update later today :)", "url": "https://github.com/rstudio/rstudio/pull/6449#discussion_r391250490", "createdAt": "2020-03-11T20:30:24Z", "author": {"login": "melissa-barca"}, "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -487,6 +489,42 @@ class GrepOperation : public boost::enable_shared_from_this<GrepOperation>\n       }\n    }\n \n+   Error setPermissions(const std::string& filePath, boost::filesystem::perms permissions)\n+   {\n+      boost::filesystem::path path(filePath);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEwOTY4OQ=="}, "originalCommit": {"oid": "4f2941f7fcca290e1b705493cff3c1ebd0cd32d1"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI2NjgwOA==", "bodyText": "IIRC the FileMode enums do not cover all the possible permissions, so I don't think you can use them in this case.", "url": "https://github.com/rstudio/rstudio/pull/6449#discussion_r391266808", "createdAt": "2020-03-11T21:03:59Z", "author": {"login": "jmcphers"}, "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -487,6 +489,42 @@ class GrepOperation : public boost::enable_shared_from_this<GrepOperation>\n       }\n    }\n \n+   Error setPermissions(const std::string& filePath, boost::filesystem::perms permissions)\n+   {\n+      boost::filesystem::path path(filePath);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEwOTY4OQ=="}, "originalCommit": {"oid": "4f2941f7fcca290e1b705493cff3c1ebd0cd32d1"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxNjA3OA==", "bodyText": "Ah you are correct. In that case, I'll leave the code alone and this is ready for review again.", "url": "https://github.com/rstudio/rstudio/pull/6449#discussion_r391316078", "createdAt": "2020-03-11T22:55:21Z", "author": {"login": "melissa-barca"}, "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -487,6 +489,42 @@ class GrepOperation : public boost::enable_shared_from_this<GrepOperation>\n       }\n    }\n \n+   Error setPermissions(const std::string& filePath, boost::filesystem::perms permissions)\n+   {\n+      boost::filesystem::path path(filePath);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEwOTY4OQ=="}, "originalCommit": {"oid": "4f2941f7fcca290e1b705493cff3c1ebd0cd32d1"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNDY4NTkyOnYy", "diffSide": "RIGHT", "path": "src/cpp/session/modules/SessionFind.cpp", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMDoxMzozOVrOF1HekQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMjo1NDo0MlrOF1MBXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI0MTM2MQ==", "bodyText": "What do you mean by the above check? Does this mean flushing the output stream should happen first? Why is it for efficiency?", "url": "https://github.com/rstudio/rstudio/pull/6449#discussion_r391241361", "createdAt": "2020-03-11T20:13:39Z", "author": {"login": "MariaSemple"}, "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -586,7 +586,14 @@ class GrepOperation : public boost::enable_shared_from_this<GrepOperation>\n             outputStream_->flush();\n             inputStream_.reset();\n             outputStream_.reset();\n+\n+            // Unneccesary on Windows because this only sets write permissions which we\n+            // already know are correct if we are writing.\n+            // For efficiency, this should not be combined with the above check as flushing\n+            // outputStream could change the file permissions", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1239d411954bfb3a22f0ea5242a6ee73c62631f"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxNTgwNw==", "bodyText": "To be honest, I'm not sure. I updated the comment to be more clear.", "url": "https://github.com/rstudio/rstudio/pull/6449#discussion_r391315807", "createdAt": "2020-03-11T22:54:42Z", "author": {"login": "melissa-barca"}, "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -586,7 +586,14 @@ class GrepOperation : public boost::enable_shared_from_this<GrepOperation>\n             outputStream_->flush();\n             inputStream_.reset();\n             outputStream_.reset();\n+\n+            // Unneccesary on Windows because this only sets write permissions which we\n+            // already know are correct if we are writing.\n+            // For efficiency, this should not be combined with the above check as flushing\n+            // outputStream could change the file permissions", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI0MTM2MQ=="}, "originalCommit": {"oid": "b1239d411954bfb3a22f0ea5242a6ee73c62631f"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNTE3NTc5OnYy", "diffSide": "RIGHT", "path": "src/cpp/session/modules/SessionFind.cpp", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMzowNDoyMVrOF1MOVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQyMzoxMzowOFrOF1MZFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxOTEyNw==", "bodyText": "Nit: I think this return should be outside the try block for clarity (as it is in the function above)", "url": "https://github.com/rstudio/rstudio/pull/6449#discussion_r391319127", "createdAt": "2020-03-11T23:04:21Z", "author": {"login": "jmcphers"}, "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -487,6 +489,45 @@ class GrepOperation : public boost::enable_shared_from_this<GrepOperation>\n       }\n    }\n \n+// permissions getter/setter (only applicable to Unix platforms)\n+#ifndef _WIN32\n+   Error setPermissions(const std::string& filePath, boost::filesystem::perms permissions)\n+   {\n+      boost::filesystem::path path(filePath);\n+      try\n+      {\n+         boost::filesystem::permissions(path, permissions);\n+      }\n+      catch (const boost::filesystem::filesystem_error& e)\n+      {\n+         return Error(e.code(), ERROR_LOCATION);\n+      }\n+\n+      return Success();\n+   }\n+\n+   Error getPermissions(const std::string& filePath, boost::filesystem::perms* pPerms)\n+   {\n+      *pPerms = boost::filesystem::no_perms;\n+\n+      boost::filesystem::path path(filePath);\n+      try\n+      {\n+         boost::filesystem::file_status fileStatus = status(path);\n+         *pPerms = fileStatus.permissions();\n+         return Success();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63e3e243ff0fb4942bbbe6354d466decebaba89c"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMyMTg3OA==", "bodyText": "Done!", "url": "https://github.com/rstudio/rstudio/pull/6449#discussion_r391321878", "createdAt": "2020-03-11T23:13:08Z", "author": {"login": "melissa-barca"}, "path": "src/cpp/session/modules/SessionFind.cpp", "diffHunk": "@@ -487,6 +489,45 @@ class GrepOperation : public boost::enable_shared_from_this<GrepOperation>\n       }\n    }\n \n+// permissions getter/setter (only applicable to Unix platforms)\n+#ifndef _WIN32\n+   Error setPermissions(const std::string& filePath, boost::filesystem::perms permissions)\n+   {\n+      boost::filesystem::path path(filePath);\n+      try\n+      {\n+         boost::filesystem::permissions(path, permissions);\n+      }\n+      catch (const boost::filesystem::filesystem_error& e)\n+      {\n+         return Error(e.code(), ERROR_LOCATION);\n+      }\n+\n+      return Success();\n+   }\n+\n+   Error getPermissions(const std::string& filePath, boost::filesystem::perms* pPerms)\n+   {\n+      *pPerms = boost::filesystem::no_perms;\n+\n+      boost::filesystem::path path(filePath);\n+      try\n+      {\n+         boost::filesystem::file_status fileStatus = status(path);\n+         *pPerms = fileStatus.permissions();\n+         return Success();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxOTEyNw=="}, "originalCommit": {"oid": "63e3e243ff0fb4942bbbe6354d466decebaba89c"}, "originalPosition": 48}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3989, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}