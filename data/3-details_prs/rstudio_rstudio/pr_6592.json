{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4NDYxNDQ1", "number": 6592, "title": "Implement custom fonts for RStudio Server", "bodyText": "This change makes it possible to use custom editor fonts with RStudio Server.\nRStudio Server previously used a hardcoded list of fonts. This is still the default behavior, but it's now possible to choose your own fonts instead.\n\nThe list of fonts available is combined from two sources:\n\nFonts installed in your browser. This list is obtained by checking a long list of popular programming fonts to see if they're supported.\nFonts installed on RStudio Server. It is possible to copy arbitrary web font files to a user-specific or system-wide folder. These fonts have the advantage of working regardless of the fonts installed on the browser (they are downloaded using @font-face).\n\nThe README file for the system-wide folder has more detail about how to add support for these font files.\nCloses #2534.", "createdAt": "2020-04-04T03:34:04Z", "url": "https://github.com/rstudio/rstudio/pull/6592", "merged": true, "mergeCommit": {"oid": "aa266ded96123f654e5f3163cde39697744eee89"}, "closed": true, "closedAt": "2020-04-06T22:31:26Z", "author": {"login": "jmcphers"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcT1TEBAH2gAyMzk4NDYxNDQ1OmU4M2ViMGI5MTIyNWE0ZWUwMTNlMTcyMmQzZjNiNWE0ZmFkMGQ5YTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVGdy6AH2gAyMzk4NDYxNDQ1OjY2ZWRhYmU0ODFiMTJlNmE2MTk4N2ViNDBiNDczNDNlNzk3MjZhZGM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e83eb0b91225a4ee013e1722d3f3b5a4fad0d9a1", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/e83eb0b91225a4ee013e1722d3f3b5a4fad0d9a1", "committedDate": "2020-04-02T23:56:26Z", "message": "implement scanning for installed fonts and CSS gen"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d47e46ab8db52736d3698cde674c92e5c9eb61f7", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/d47e46ab8db52736d3698cde674c92e5c9eb61f7", "committedDate": "2020-04-03T00:49:54Z", "message": "get installed fonts via RPC"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2048ae94ea20bfc8f1f1611528bff709e640a399", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/2048ae94ea20bfc8f1f1611528bff709e640a399", "committedDate": "2020-04-03T18:59:56Z", "message": "add pref for server font"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e2feda0c2ec881be03550adaad43bfcedd7b556", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/9e2feda0c2ec881be03550adaad43bfcedd7b556", "committedDate": "2020-04-03T19:00:21Z", "message": "implement font preview in prefs pane"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48fb19ae1441d19dc7b190957c43dfcf9756aa8e", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/48fb19ae1441d19dc7b190957c43dfcf9756aa8e", "committedDate": "2020-04-03T20:04:06Z", "message": "add font loading element to document root"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e931c6e4d7eaa55b834decfd37d820a337e2550a", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/e931c6e4d7eaa55b834decfd37d820a337e2550a", "committedDate": "2020-04-03T22:36:13Z", "message": "load auxiliary styles in font CSS"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cadae8ad97fa39fc4ea0ab7d85ed7e3f9cccacd8", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/cadae8ad97fa39fc4ea0ab7d85ed7e3f9cccacd8", "committedDate": "2020-04-03T23:49:35Z", "message": "allow for fonts defined by the browser"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "397c74340081357f381504e5a42e9ba441ad24d6", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/397c74340081357f381504e5a42e9ba441ad24d6", "committedDate": "2020-04-03T23:57:31Z", "message": "add some more choices for browser fonts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81255eab3b0244e9bc4a68e241f859176dbbcbaf", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/81255eab3b0244e9bc4a68e241f859176dbbcbaf", "committedDate": "2020-04-04T00:04:41Z", "message": "set web font in initial preview"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b41647c2e847271a1d3d866c6deffb7b79a89599", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/b41647c2e847271a1d3d866c6deffb7b79a89599", "committedDate": "2020-04-04T02:37:21Z", "message": "install a README"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4916c8d0438e41c7ed0457689eee88b6295ece0", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/a4916c8d0438e41c7ed0457689eee88b6295ece0", "committedDate": "2020-04-04T03:04:17Z", "message": "allow fallback to previous behavior"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30015d99ca812c698d1cf9c4a045c9da56dff22f", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/30015d99ca812c698d1cf9c4a045c9da56dff22f", "committedDate": "2020-04-04T03:18:25Z", "message": "clean up comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "908763be85065ed01a28c9de9b0b17e235422ab2", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/908763be85065ed01a28c9de9b0b17e235422ab2", "committedDate": "2020-04-06T16:54:45Z", "message": "add OS-specific fallback fonts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78f7ad07c72be4eb64610ff94300d76ec9be6768", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/78f7ad07c72be4eb64610ff94300d76ec9be6768", "committedDate": "2020-04-06T17:30:01Z", "message": "update NEWS"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f30c294e4e083e2ced06934272e84c107fd8db5e", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/f30c294e4e083e2ced06934272e84c107fd8db5e", "committedDate": "2020-04-06T18:31:12Z", "message": "Merge remote-tracking branch 'origin/master' into feature/server-web-fonts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NjI4MjAy", "url": "https://github.com/rstudio/rstudio/pull/6592#pullrequestreview-388628202", "createdAt": "2020-04-06T21:24:00Z", "commit": {"oid": "f30c294e4e083e2ced06934272e84c107fd8db5e"}, "state": "APPROVED", "comments": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMToyNDowMFrOGBqdBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMTo1Nzo0NlrOGBrcSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM5NzMxNg==", "bodyText": "nit, update copyright year in header", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404397316", "createdAt": "2020-04-06T21:24:00Z", "author": {"login": "gtritchie"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java", "diffHunk": "@@ -28,6 +28,7 @@\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f30c294e4e083e2ced06934272e84c107fd8db5e"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM5ODI3NA==", "bodyText": "Might as well move this down to line 89 where it is first used (and only used inside that block as far as I can see).", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404398274", "createdAt": "2020-04-06T21:25:54Z", "author": {"login": "gtritchie"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java", "diffHunk": "@@ -74,6 +78,33 @@ private void applyTheme(Document document, final AceTheme theme)\n       currentStyleEl.setRel(\"stylesheet\");\n       currentStyleEl.setId(linkId_);\n       currentStyleEl.setHref(themeUrl.toString());\n+      \n+      // In server mode, augment the theme with a font if we have one\n+      LinkElement fontEl = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f30c294e4e083e2ced06934272e84c107fd8db5e"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM5OTM4OQ==", "bodyText": "fontId_ (and, actually, linkId_) could be local variables inside applyTheme().", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404399389", "createdAt": "2020-04-06T21:28:08Z", "author": {"login": "gtritchie"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/themes/AceThemes.java", "diffHunk": "@@ -249,6 +280,8 @@ public void onError(ServerError error)\n    private ThemeServerOperations themeServerOperations_;\n    private final EventBus events_;\n    private final Provider<UserState> state_;\n+   private final Provider<UserPrefs> prefs_;\n    private final String linkId_ = \"rstudio-acethemes-linkelement\";\n+   private final String fontId_ = \"rstudio-fontelement\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f30c294e4e083e2ced06934272e84c107fd8db5e"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQwMDA4Ng==", "bodyText": "Don't think this is used.", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404400086", "createdAt": "2020-04-06T21:29:28Z", "author": {"login": "gtritchie"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java", "diffHunk": "@@ -40,13 +43,19 @@\n import org.rstudio.studio.client.common.FileDialogs;\n import org.rstudio.studio.client.common.GlobalDisplay;\n import org.rstudio.studio.client.common.dependencies.DependencyManager;\n+import org.rstudio.studio.client.server.ServerError;\n+import org.rstudio.studio.client.server.ServerRequestCallback;\n import org.rstudio.studio.client.workbench.WorkbenchContext;\n import org.rstudio.studio.client.workbench.prefs.model.UserPrefs;\n import org.rstudio.studio.client.workbench.prefs.model.UserState;\n import org.rstudio.studio.client.workbench.views.source.editors.text.themes.AceTheme;\n import org.rstudio.studio.client.workbench.views.source.editors.text.themes.AceThemes;\n+import org.rstudio.studio.client.workbench.views.source.editors.text.themes.model.ThemeServerOperations;\n \n+import java.util.ArrayList;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f30c294e4e083e2ced06934272e84c107fd8db5e"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQwMTUwNg==", "bodyText": "Can leave out String  in new, i.e. new TreeSet<>();", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404401506", "createdAt": "2020-04-06T21:32:30Z", "author": {"login": "gtritchie"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AppearancePreferencesPane.java", "diffHunk": "@@ -617,16 +672,77 @@ public boolean execute()\n                return true;\n          \n             String[] fontList = fonts.split(\"\\\\n\");\n-            String value = fontFace_.getValue();\n-            value = value.replaceAll(\"\\\\\\\"\", \"\");\n-            fontFace_.setLabel(\"Editor font:\");\n-            fontFace_.setChoices(fontList, fontList);\n-            fontFace_.setValue(value);\n+            populateFontList(fontList);\n             return false;\n          }\n          \n       }, 100);\n    }\n+   \n+   private void getInstalledFontList()\n+   {\n+      // Search for installed fixed-width fonts on this web browser.\n+      final Set<String> browserFonts = new TreeSet<String>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f30c294e4e083e2ced06934272e84c107fd8db5e"}, "originalPosition": 223}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQwMjI0OA==", "bodyText": "nit, update copyright in header", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404402248", "createdAt": "2020-04-06T21:33:43Z", "author": {"login": "gtritchie"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/AceEditorPreview.java", "diffHunk": "@@ -26,6 +26,7 @@\n import org.rstudio.core.client.theme.ThemeFonts;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f30c294e4e083e2ced06934272e84c107fd8db5e"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQwNDA4MA==", "bodyText": "nit, copyright year in header", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404404080", "createdAt": "2020-04-06T21:37:36Z", "author": {"login": "gtritchie"}, "path": "src/gwt/src/org/rstudio/studio/client/server/remote/RemoteServer.java", "diffHunk": "@@ -6154,6 +6154,12 @@ public void pandocListExtensions(String format, ServerRequestCallback<String> ca\n       sendRequest(RPC_SCOPE, PANDOC_LIST_EXTENSIONS, format, callback);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f30c294e4e083e2ced06934272e84c107fd8db5e"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQwNDQyMQ==", "bodyText": "nit, copyright year in header", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404404421", "createdAt": "2020-04-06T21:38:21Z", "author": {"login": "gtritchie"}, "path": "src/gwt/src/org/rstudio/studio/client/common/sourcemarkers/SourceMarkerItemCodec.java", "diffHunk": "@@ -19,6 +19,7 @@\n import org.rstudio.core.client.CodeNavigationTarget;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f30c294e4e083e2ced06934272e84c107fd8db5e"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQwNjk2Mg==", "bodyText": "ultrai-nit: Most new files use Copyright (c) 2020 by RStudio, PBC. and leave out the 2009-", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404406962", "createdAt": "2020-04-06T21:43:44Z", "author": {"login": "gtritchie"}, "path": "src/cpp/session/modules/SessionFonts.hpp", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * SessionFonts.hpp\n+ *\n+ * Copyright (C) 2009-20 by RStudio, PBC", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f30c294e4e083e2ced06934272e84c107fd8db5e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxMTAxNw==", "bodyText": "Could use: for (const auto& fontExtension : s_fontExtensions) here and if (ext == fontExtension) below.", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404411017", "createdAt": "2020-04-06T21:52:42Z", "author": {"login": "gtritchie"}, "path": "src/cpp/session/modules/SessionFonts.cpp", "diffHunk": "@@ -0,0 +1,338 @@\n+/*\n+ * SessionFonts.cpp\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+\n+#include \"SessionFonts.hpp\"\n+\n+#include <core/http/Request.hpp>\n+#include <core/http/Response.hpp>\n+#include <core/Exec.hpp>\n+#include <core/text/TemplateFilter.hpp>\n+\n+#include <core/system/Xdg.hpp>\n+\n+#include <shared_core/FilePath.hpp>\n+#include <shared_core/SafeConvert.hpp>\n+\n+#include <session/SessionModuleContext.hpp>\n+\n+#include <array>\n+\n+using namespace rstudio::core;\n+\n+#define kFontFolder    \"fonts\"\n+#define kFontsLocation \"fonts/\"\n+#define kFontFiles     kFontsLocation \"files/\"\n+#define kFontCss       kFontsLocation \"css/\"\n+\n+namespace rstudio {\n+namespace session {\n+namespace modules {\n+namespace fonts {\n+\n+namespace {\n+\n+// File extensions that we recognize as font files\n+std::array<std::string, 5> s_fontExtensions = {\n+   \".eot\",\n+   \".ttf\",\n+   \".otf\",\n+   \".woff\",\n+   \".woff2\"\n+};\n+\n+// Indicates whether the file is a font file (i.e. has a known font file extension)\n+bool isFontFile(const FilePath& file)\n+{\n+   // Test the file extension against known font formats\n+   std::string ext = file.getExtensionLowerCase();\n+   for (size_t i = 0; i < s_fontExtensions.size(); i++)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f30c294e4e083e2ced06934272e84c107fd8db5e"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxMTI1OA==", "bodyText": "don't need this return", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404411258", "createdAt": "2020-04-06T21:53:14Z", "author": {"login": "gtritchie"}, "path": "src/cpp/session/modules/SessionFonts.cpp", "diffHunk": "@@ -0,0 +1,338 @@\n+/*\n+ * SessionFonts.cpp\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+\n+#include \"SessionFonts.hpp\"\n+\n+#include <core/http/Request.hpp>\n+#include <core/http/Response.hpp>\n+#include <core/Exec.hpp>\n+#include <core/text/TemplateFilter.hpp>\n+\n+#include <core/system/Xdg.hpp>\n+\n+#include <shared_core/FilePath.hpp>\n+#include <shared_core/SafeConvert.hpp>\n+\n+#include <session/SessionModuleContext.hpp>\n+\n+#include <array>\n+\n+using namespace rstudio::core;\n+\n+#define kFontFolder    \"fonts\"\n+#define kFontsLocation \"fonts/\"\n+#define kFontFiles     kFontsLocation \"files/\"\n+#define kFontCss       kFontsLocation \"css/\"\n+\n+namespace rstudio {\n+namespace session {\n+namespace modules {\n+namespace fonts {\n+\n+namespace {\n+\n+// File extensions that we recognize as font files\n+std::array<std::string, 5> s_fontExtensions = {\n+   \".eot\",\n+   \".ttf\",\n+   \".otf\",\n+   \".woff\",\n+   \".woff2\"\n+};\n+\n+// Indicates whether the file is a font file (i.e. has a known font file extension)\n+bool isFontFile(const FilePath& file)\n+{\n+   // Test the file extension against known font formats\n+   std::string ext = file.getExtensionLowerCase();\n+   for (size_t i = 0; i < s_fontExtensions.size(); i++)\n+   {\n+      if (ext == s_fontExtensions.at(i))\n+         return true;\n+   }\n+\n+   // No extensions match\n+   return false;\n+}\n+\n+// The path to the user-specific font folder\n+core::FilePath userFontFolder()\n+{\n+   return core::system::xdg::userConfigDir().completeChildPath(kFontFolder);\n+}\n+\n+// The path to the system-wide font folder\n+core::FilePath systemFontFolder()\n+{\n+   return core::system::xdg::systemConfigDir().completeChildPath(kFontFolder);\n+}\n+\n+// Generates a CSS snippet from a font file.\n+Error generateCssFromFile(const FilePath& file,\n+                          const std::string& fontName,\n+                          const std::vector<std::string>& parents,\n+                          std::string *pCss)\n+{\n+   pCss->append(\"@font-face {\\n\"\n+                \"  font-family: \\\"\" + fontName + \"\\\";\\n\"\n+                \"  src: url('../files/\");\n+\n+   // Build URL to font file from parent folders. \n+   for (const auto& parent: parents)\n+   {\n+      pCss->append(parent + \"/\");\n+   }\n+   pCss->append(file.getFilename() + \"');\\n\");\n+\n+   // Convert each parent folder\n+   for (const auto& parent: parents)\n+   {\n+      // Check to see whether this directory looks like a font weight\n+      // font style.\n+      auto weight = safe_convert::stringTo<int>(parent);\n+      if (weight)\n+      {\n+         // Looks like a number, so generate a weight rule and recurse.\n+         pCss->append(\"  font-weight: \" + parent + \";\\n\");\n+      }\n+      else if (parent == \"oblique\" || parent == \"italic\")\n+      {\n+         // It's a style\n+         pCss->append(\"  font-style: \" + parent + \";\\n\");\n+      }\n+   }\n+\n+   pCss->append(\"}\\n\\n\");\n+   return Success();\n+}\n+\n+// Generates CSS from a directory representing a number of variants of a single font face. The\n+// directory structure is used to provide font metadata. For instance, a font with regular (400) and\n+// bold (700) weights might be stored as follows:\n+//\n+// + Victor Mono/\n+// |\n+// +--+ 400/\n+// |  |\n+// |  +-- Victor Mono Regular.woff\n+// |  \n+// +--+ 700/\n+//    |\n+//    +-- Victor Mono Bold.woff\n+//\n+Error generateCssFromDir(const FilePath& dir,\n+                         const std::string& fontName,\n+                         const std::vector<std::string>& parents,\n+                         std::string *pCss)\n+{\n+   std::vector<FilePath> files;\n+   Error error = dir.getChildren(files);\n+   if (error)\n+   {\n+      return error;\n+   }\n+   \n+   for (const auto& file: files)\n+   {\n+      std::string name = file.getFilename();\n+      if (file.isDirectory())\n+      {\n+         // This is a directory, probably representing a font weight or style\n+         std::vector<std::string> newParents(parents);\n+         newParents.push_back(name);\n+         error = generateCssFromDir(file, fontName, newParents, pCss);\n+      }\n+      else if (isFontFile(file))\n+      {\n+         // This is an ordinary font file\n+         error = generateCssFromFile(file, fontName, parents, pCss);\n+      }\n+\n+      if (error)\n+      {\n+         // Log and clear any errors encountered while processing this font\n+         LOG_ERROR(error);\n+         error = Success();\n+      }\n+   }\n+\n+   return error;\n+}\n+\n+// Handles an HTTP request for a specific font file.\n+void handleFontFileRequest(const http::Request& request,\n+                           http::Response* pResponse)\n+{\n+   std::string prefix = \"/\" kFontFiles;\n+   std::string fileName = http::util::pathAfterPrefix(request, prefix);\n+   \n+   // Check user font folder first\n+   FilePath fontFile = userFontFolder().completeChildPath(fileName);\n+   if (!fontFile.exists())\n+   {\n+      // Not found in user fonts; fall back to system\n+      fontFile = systemFontFolder().completeChildPath(fileName);\n+   }\n+\n+   pResponse->setCacheableFile(fontFile, request);\n+   return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f30c294e4e083e2ced06934272e84c107fd8db5e"}, "originalPosition": 190}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxMTgzOQ==", "bodyText": "Like earlier could use range-for loop here.", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404411839", "createdAt": "2020-04-06T21:54:25Z", "author": {"login": "gtritchie"}, "path": "src/cpp/session/modules/SessionFonts.cpp", "diffHunk": "@@ -0,0 +1,338 @@\n+/*\n+ * SessionFonts.cpp\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+\n+#include \"SessionFonts.hpp\"\n+\n+#include <core/http/Request.hpp>\n+#include <core/http/Response.hpp>\n+#include <core/Exec.hpp>\n+#include <core/text/TemplateFilter.hpp>\n+\n+#include <core/system/Xdg.hpp>\n+\n+#include <shared_core/FilePath.hpp>\n+#include <shared_core/SafeConvert.hpp>\n+\n+#include <session/SessionModuleContext.hpp>\n+\n+#include <array>\n+\n+using namespace rstudio::core;\n+\n+#define kFontFolder    \"fonts\"\n+#define kFontsLocation \"fonts/\"\n+#define kFontFiles     kFontsLocation \"files/\"\n+#define kFontCss       kFontsLocation \"css/\"\n+\n+namespace rstudio {\n+namespace session {\n+namespace modules {\n+namespace fonts {\n+\n+namespace {\n+\n+// File extensions that we recognize as font files\n+std::array<std::string, 5> s_fontExtensions = {\n+   \".eot\",\n+   \".ttf\",\n+   \".otf\",\n+   \".woff\",\n+   \".woff2\"\n+};\n+\n+// Indicates whether the file is a font file (i.e. has a known font file extension)\n+bool isFontFile(const FilePath& file)\n+{\n+   // Test the file extension against known font formats\n+   std::string ext = file.getExtensionLowerCase();\n+   for (size_t i = 0; i < s_fontExtensions.size(); i++)\n+   {\n+      if (ext == s_fontExtensions.at(i))\n+         return true;\n+   }\n+\n+   // No extensions match\n+   return false;\n+}\n+\n+// The path to the user-specific font folder\n+core::FilePath userFontFolder()\n+{\n+   return core::system::xdg::userConfigDir().completeChildPath(kFontFolder);\n+}\n+\n+// The path to the system-wide font folder\n+core::FilePath systemFontFolder()\n+{\n+   return core::system::xdg::systemConfigDir().completeChildPath(kFontFolder);\n+}\n+\n+// Generates a CSS snippet from a font file.\n+Error generateCssFromFile(const FilePath& file,\n+                          const std::string& fontName,\n+                          const std::vector<std::string>& parents,\n+                          std::string *pCss)\n+{\n+   pCss->append(\"@font-face {\\n\"\n+                \"  font-family: \\\"\" + fontName + \"\\\";\\n\"\n+                \"  src: url('../files/\");\n+\n+   // Build URL to font file from parent folders. \n+   for (const auto& parent: parents)\n+   {\n+      pCss->append(parent + \"/\");\n+   }\n+   pCss->append(file.getFilename() + \"');\\n\");\n+\n+   // Convert each parent folder\n+   for (const auto& parent: parents)\n+   {\n+      // Check to see whether this directory looks like a font weight\n+      // font style.\n+      auto weight = safe_convert::stringTo<int>(parent);\n+      if (weight)\n+      {\n+         // Looks like a number, so generate a weight rule and recurse.\n+         pCss->append(\"  font-weight: \" + parent + \";\\n\");\n+      }\n+      else if (parent == \"oblique\" || parent == \"italic\")\n+      {\n+         // It's a style\n+         pCss->append(\"  font-style: \" + parent + \";\\n\");\n+      }\n+   }\n+\n+   pCss->append(\"}\\n\\n\");\n+   return Success();\n+}\n+\n+// Generates CSS from a directory representing a number of variants of a single font face. The\n+// directory structure is used to provide font metadata. For instance, a font with regular (400) and\n+// bold (700) weights might be stored as follows:\n+//\n+// + Victor Mono/\n+// |\n+// +--+ 400/\n+// |  |\n+// |  +-- Victor Mono Regular.woff\n+// |  \n+// +--+ 700/\n+//    |\n+//    +-- Victor Mono Bold.woff\n+//\n+Error generateCssFromDir(const FilePath& dir,\n+                         const std::string& fontName,\n+                         const std::vector<std::string>& parents,\n+                         std::string *pCss)\n+{\n+   std::vector<FilePath> files;\n+   Error error = dir.getChildren(files);\n+   if (error)\n+   {\n+      return error;\n+   }\n+   \n+   for (const auto& file: files)\n+   {\n+      std::string name = file.getFilename();\n+      if (file.isDirectory())\n+      {\n+         // This is a directory, probably representing a font weight or style\n+         std::vector<std::string> newParents(parents);\n+         newParents.push_back(name);\n+         error = generateCssFromDir(file, fontName, newParents, pCss);\n+      }\n+      else if (isFontFile(file))\n+      {\n+         // This is an ordinary font file\n+         error = generateCssFromFile(file, fontName, parents, pCss);\n+      }\n+\n+      if (error)\n+      {\n+         // Log and clear any errors encountered while processing this font\n+         LOG_ERROR(error);\n+         error = Success();\n+      }\n+   }\n+\n+   return error;\n+}\n+\n+// Handles an HTTP request for a specific font file.\n+void handleFontFileRequest(const http::Request& request,\n+                           http::Response* pResponse)\n+{\n+   std::string prefix = \"/\" kFontFiles;\n+   std::string fileName = http::util::pathAfterPrefix(request, prefix);\n+   \n+   // Check user font folder first\n+   FilePath fontFile = userFontFolder().completeChildPath(fileName);\n+   if (!fontFile.exists())\n+   {\n+      // Not found in user fonts; fall back to system\n+      fontFile = systemFontFolder().completeChildPath(fileName);\n+   }\n+\n+   pResponse->setCacheableFile(fontFile, request);\n+   return;\n+}\n+\n+// Handles an HTTP request for font CSS. This will typically look something like:\n+//\n+// GET /fonts/css/Victor Mono.css\n+//\n+// The request is fulfilled by automatically generating the appropriate CSS @font-face rule(s) for\n+// the font and returning them in the body of the request.\n+void handleFontCssRequest(const http::Request& request,\n+                          http::Response* pResponse)\n+{\n+   Error error;\n+   std::string css;\n+   std::string prefix = \"/\"  kFontCss;\n+   std::string fileName = http::util::pathAfterPrefix(request, prefix);\n+\n+   // Strip off \".css\" to get name of font\n+   size_t idx = fileName.find(\".css\");\n+   if (idx != std::string::npos)\n+   {\n+      fileName = fileName.substr(0, idx);\n+   }\n+   \n+   // Enumerate user and system font directories\n+   std::vector<FilePath> dirs;\n+   dirs.push_back(userFontFolder());\n+   dirs.push_back(systemFontFolder());\n+\n+   for (const auto& dir: dirs)\n+   {\n+      FilePath subDir = dir.completeChildPath(fileName);\n+      if (subDir.exists() && subDir.isDirectory())\n+      {\n+         // Folder full of font files\n+         std::vector<std::string> parents;\n+         parents.push_back(fileName);\n+         error = generateCssFromDir(subDir, fileName, parents, &css);\n+      }\n+      else\n+      {\n+         // An individual font file; determine extension\n+         for (size_t i = 0; i < s_fontExtensions.size(); i++)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f30c294e4e083e2ced06934272e84c107fd8db5e"}, "originalPosition": 232}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxMjExMg==", "bodyText": "don't need this return", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404412112", "createdAt": "2020-04-06T21:55:00Z", "author": {"login": "gtritchie"}, "path": "src/cpp/session/modules/SessionFonts.cpp", "diffHunk": "@@ -0,0 +1,338 @@\n+/*\n+ * SessionFonts.cpp\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+\n+#include \"SessionFonts.hpp\"\n+\n+#include <core/http/Request.hpp>\n+#include <core/http/Response.hpp>\n+#include <core/Exec.hpp>\n+#include <core/text/TemplateFilter.hpp>\n+\n+#include <core/system/Xdg.hpp>\n+\n+#include <shared_core/FilePath.hpp>\n+#include <shared_core/SafeConvert.hpp>\n+\n+#include <session/SessionModuleContext.hpp>\n+\n+#include <array>\n+\n+using namespace rstudio::core;\n+\n+#define kFontFolder    \"fonts\"\n+#define kFontsLocation \"fonts/\"\n+#define kFontFiles     kFontsLocation \"files/\"\n+#define kFontCss       kFontsLocation \"css/\"\n+\n+namespace rstudio {\n+namespace session {\n+namespace modules {\n+namespace fonts {\n+\n+namespace {\n+\n+// File extensions that we recognize as font files\n+std::array<std::string, 5> s_fontExtensions = {\n+   \".eot\",\n+   \".ttf\",\n+   \".otf\",\n+   \".woff\",\n+   \".woff2\"\n+};\n+\n+// Indicates whether the file is a font file (i.e. has a known font file extension)\n+bool isFontFile(const FilePath& file)\n+{\n+   // Test the file extension against known font formats\n+   std::string ext = file.getExtensionLowerCase();\n+   for (size_t i = 0; i < s_fontExtensions.size(); i++)\n+   {\n+      if (ext == s_fontExtensions.at(i))\n+         return true;\n+   }\n+\n+   // No extensions match\n+   return false;\n+}\n+\n+// The path to the user-specific font folder\n+core::FilePath userFontFolder()\n+{\n+   return core::system::xdg::userConfigDir().completeChildPath(kFontFolder);\n+}\n+\n+// The path to the system-wide font folder\n+core::FilePath systemFontFolder()\n+{\n+   return core::system::xdg::systemConfigDir().completeChildPath(kFontFolder);\n+}\n+\n+// Generates a CSS snippet from a font file.\n+Error generateCssFromFile(const FilePath& file,\n+                          const std::string& fontName,\n+                          const std::vector<std::string>& parents,\n+                          std::string *pCss)\n+{\n+   pCss->append(\"@font-face {\\n\"\n+                \"  font-family: \\\"\" + fontName + \"\\\";\\n\"\n+                \"  src: url('../files/\");\n+\n+   // Build URL to font file from parent folders. \n+   for (const auto& parent: parents)\n+   {\n+      pCss->append(parent + \"/\");\n+   }\n+   pCss->append(file.getFilename() + \"');\\n\");\n+\n+   // Convert each parent folder\n+   for (const auto& parent: parents)\n+   {\n+      // Check to see whether this directory looks like a font weight\n+      // font style.\n+      auto weight = safe_convert::stringTo<int>(parent);\n+      if (weight)\n+      {\n+         // Looks like a number, so generate a weight rule and recurse.\n+         pCss->append(\"  font-weight: \" + parent + \";\\n\");\n+      }\n+      else if (parent == \"oblique\" || parent == \"italic\")\n+      {\n+         // It's a style\n+         pCss->append(\"  font-style: \" + parent + \";\\n\");\n+      }\n+   }\n+\n+   pCss->append(\"}\\n\\n\");\n+   return Success();\n+}\n+\n+// Generates CSS from a directory representing a number of variants of a single font face. The\n+// directory structure is used to provide font metadata. For instance, a font with regular (400) and\n+// bold (700) weights might be stored as follows:\n+//\n+// + Victor Mono/\n+// |\n+// +--+ 400/\n+// |  |\n+// |  +-- Victor Mono Regular.woff\n+// |  \n+// +--+ 700/\n+//    |\n+//    +-- Victor Mono Bold.woff\n+//\n+Error generateCssFromDir(const FilePath& dir,\n+                         const std::string& fontName,\n+                         const std::vector<std::string>& parents,\n+                         std::string *pCss)\n+{\n+   std::vector<FilePath> files;\n+   Error error = dir.getChildren(files);\n+   if (error)\n+   {\n+      return error;\n+   }\n+   \n+   for (const auto& file: files)\n+   {\n+      std::string name = file.getFilename();\n+      if (file.isDirectory())\n+      {\n+         // This is a directory, probably representing a font weight or style\n+         std::vector<std::string> newParents(parents);\n+         newParents.push_back(name);\n+         error = generateCssFromDir(file, fontName, newParents, pCss);\n+      }\n+      else if (isFontFile(file))\n+      {\n+         // This is an ordinary font file\n+         error = generateCssFromFile(file, fontName, parents, pCss);\n+      }\n+\n+      if (error)\n+      {\n+         // Log and clear any errors encountered while processing this font\n+         LOG_ERROR(error);\n+         error = Success();\n+      }\n+   }\n+\n+   return error;\n+}\n+\n+// Handles an HTTP request for a specific font file.\n+void handleFontFileRequest(const http::Request& request,\n+                           http::Response* pResponse)\n+{\n+   std::string prefix = \"/\" kFontFiles;\n+   std::string fileName = http::util::pathAfterPrefix(request, prefix);\n+   \n+   // Check user font folder first\n+   FilePath fontFile = userFontFolder().completeChildPath(fileName);\n+   if (!fontFile.exists())\n+   {\n+      // Not found in user fonts; fall back to system\n+      fontFile = systemFontFolder().completeChildPath(fileName);\n+   }\n+\n+   pResponse->setCacheableFile(fontFile, request);\n+   return;\n+}\n+\n+// Handles an HTTP request for font CSS. This will typically look something like:\n+//\n+// GET /fonts/css/Victor Mono.css\n+//\n+// The request is fulfilled by automatically generating the appropriate CSS @font-face rule(s) for\n+// the font and returning them in the body of the request.\n+void handleFontCssRequest(const http::Request& request,\n+                          http::Response* pResponse)\n+{\n+   Error error;\n+   std::string css;\n+   std::string prefix = \"/\"  kFontCss;\n+   std::string fileName = http::util::pathAfterPrefix(request, prefix);\n+\n+   // Strip off \".css\" to get name of font\n+   size_t idx = fileName.find(\".css\");\n+   if (idx != std::string::npos)\n+   {\n+      fileName = fileName.substr(0, idx);\n+   }\n+   \n+   // Enumerate user and system font directories\n+   std::vector<FilePath> dirs;\n+   dirs.push_back(userFontFolder());\n+   dirs.push_back(systemFontFolder());\n+\n+   for (const auto& dir: dirs)\n+   {\n+      FilePath subDir = dir.completeChildPath(fileName);\n+      if (subDir.exists() && subDir.isDirectory())\n+      {\n+         // Folder full of font files\n+         std::vector<std::string> parents;\n+         parents.push_back(fileName);\n+         error = generateCssFromDir(subDir, fileName, parents, &css);\n+      }\n+      else\n+      {\n+         // An individual font file; determine extension\n+         for (size_t i = 0; i < s_fontExtensions.size(); i++)\n+         {\n+            FilePath fontFile = dir.completeChildPath(\n+                  fileName + s_fontExtensions[i]);\n+            if (fontFile.exists())\n+            {\n+               // Generate CSS for the font file\n+               error = generateCssFromFile(fontFile, fileName, std::vector<std::string>(), &css);\n+               if (error)\n+               {\n+                  LOG_ERROR(error);\n+               }\n+\n+               // We found a matching font; bail here\n+               break;\n+            }\n+         }\n+      }\n+   }\n+\n+   // It's okay if there was no matching font found at this point, since on RStudio Server the font\n+   // can be provided by the browser instead of the server. We will still generate a font-specific\n+   // stylesheet below.\n+   //\n+   // Append override rules for basic fixed-width elements. This stylesheet overrides a few key\n+   // styles in themeStyles.css with the specified font.\n+   //\n+   std::map<std::string,std::string> vars;\n+   vars[\"font\"] = fileName;\n+   std::ostringstream oss;\n+   error = core::text::renderTemplate(\n+      session::options().rResourcesPath().completeChildPath(\"themes/css/fonts.css\"), vars, oss);\n+   if (error)\n+   {\n+      LOG_ERROR(error);\n+   }\n+   else\n+   {\n+      css.append(oss.str());\n+   }\n+\n+   // Return the accumulated stylesheet\n+   pResponse->setContentType(\"text/css\");\n+   pResponse->setBody(css);\n+\n+   return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f30c294e4e083e2ced06934272e84c107fd8db5e"}, "originalPosition": 277}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxMjgzMw==", "bodyText": "Should you log this error or do something else with it, otherwise it's unused.", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404412833", "createdAt": "2020-04-06T21:56:16Z", "author": {"login": "gtritchie"}, "path": "src/cpp/session/modules/SessionFonts.cpp", "diffHunk": "@@ -0,0 +1,338 @@\n+/*\n+ * SessionFonts.cpp\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+\n+#include \"SessionFonts.hpp\"\n+\n+#include <core/http/Request.hpp>\n+#include <core/http/Response.hpp>\n+#include <core/Exec.hpp>\n+#include <core/text/TemplateFilter.hpp>\n+\n+#include <core/system/Xdg.hpp>\n+\n+#include <shared_core/FilePath.hpp>\n+#include <shared_core/SafeConvert.hpp>\n+\n+#include <session/SessionModuleContext.hpp>\n+\n+#include <array>\n+\n+using namespace rstudio::core;\n+\n+#define kFontFolder    \"fonts\"\n+#define kFontsLocation \"fonts/\"\n+#define kFontFiles     kFontsLocation \"files/\"\n+#define kFontCss       kFontsLocation \"css/\"\n+\n+namespace rstudio {\n+namespace session {\n+namespace modules {\n+namespace fonts {\n+\n+namespace {\n+\n+// File extensions that we recognize as font files\n+std::array<std::string, 5> s_fontExtensions = {\n+   \".eot\",\n+   \".ttf\",\n+   \".otf\",\n+   \".woff\",\n+   \".woff2\"\n+};\n+\n+// Indicates whether the file is a font file (i.e. has a known font file extension)\n+bool isFontFile(const FilePath& file)\n+{\n+   // Test the file extension against known font formats\n+   std::string ext = file.getExtensionLowerCase();\n+   for (size_t i = 0; i < s_fontExtensions.size(); i++)\n+   {\n+      if (ext == s_fontExtensions.at(i))\n+         return true;\n+   }\n+\n+   // No extensions match\n+   return false;\n+}\n+\n+// The path to the user-specific font folder\n+core::FilePath userFontFolder()\n+{\n+   return core::system::xdg::userConfigDir().completeChildPath(kFontFolder);\n+}\n+\n+// The path to the system-wide font folder\n+core::FilePath systemFontFolder()\n+{\n+   return core::system::xdg::systemConfigDir().completeChildPath(kFontFolder);\n+}\n+\n+// Generates a CSS snippet from a font file.\n+Error generateCssFromFile(const FilePath& file,\n+                          const std::string& fontName,\n+                          const std::vector<std::string>& parents,\n+                          std::string *pCss)\n+{\n+   pCss->append(\"@font-face {\\n\"\n+                \"  font-family: \\\"\" + fontName + \"\\\";\\n\"\n+                \"  src: url('../files/\");\n+\n+   // Build URL to font file from parent folders. \n+   for (const auto& parent: parents)\n+   {\n+      pCss->append(parent + \"/\");\n+   }\n+   pCss->append(file.getFilename() + \"');\\n\");\n+\n+   // Convert each parent folder\n+   for (const auto& parent: parents)\n+   {\n+      // Check to see whether this directory looks like a font weight\n+      // font style.\n+      auto weight = safe_convert::stringTo<int>(parent);\n+      if (weight)\n+      {\n+         // Looks like a number, so generate a weight rule and recurse.\n+         pCss->append(\"  font-weight: \" + parent + \";\\n\");\n+      }\n+      else if (parent == \"oblique\" || parent == \"italic\")\n+      {\n+         // It's a style\n+         pCss->append(\"  font-style: \" + parent + \";\\n\");\n+      }\n+   }\n+\n+   pCss->append(\"}\\n\\n\");\n+   return Success();\n+}\n+\n+// Generates CSS from a directory representing a number of variants of a single font face. The\n+// directory structure is used to provide font metadata. For instance, a font with regular (400) and\n+// bold (700) weights might be stored as follows:\n+//\n+// + Victor Mono/\n+// |\n+// +--+ 400/\n+// |  |\n+// |  +-- Victor Mono Regular.woff\n+// |  \n+// +--+ 700/\n+//    |\n+//    +-- Victor Mono Bold.woff\n+//\n+Error generateCssFromDir(const FilePath& dir,\n+                         const std::string& fontName,\n+                         const std::vector<std::string>& parents,\n+                         std::string *pCss)\n+{\n+   std::vector<FilePath> files;\n+   Error error = dir.getChildren(files);\n+   if (error)\n+   {\n+      return error;\n+   }\n+   \n+   for (const auto& file: files)\n+   {\n+      std::string name = file.getFilename();\n+      if (file.isDirectory())\n+      {\n+         // This is a directory, probably representing a font weight or style\n+         std::vector<std::string> newParents(parents);\n+         newParents.push_back(name);\n+         error = generateCssFromDir(file, fontName, newParents, pCss);\n+      }\n+      else if (isFontFile(file))\n+      {\n+         // This is an ordinary font file\n+         error = generateCssFromFile(file, fontName, parents, pCss);\n+      }\n+\n+      if (error)\n+      {\n+         // Log and clear any errors encountered while processing this font\n+         LOG_ERROR(error);\n+         error = Success();\n+      }\n+   }\n+\n+   return error;\n+}\n+\n+// Handles an HTTP request for a specific font file.\n+void handleFontFileRequest(const http::Request& request,\n+                           http::Response* pResponse)\n+{\n+   std::string prefix = \"/\" kFontFiles;\n+   std::string fileName = http::util::pathAfterPrefix(request, prefix);\n+   \n+   // Check user font folder first\n+   FilePath fontFile = userFontFolder().completeChildPath(fileName);\n+   if (!fontFile.exists())\n+   {\n+      // Not found in user fonts; fall back to system\n+      fontFile = systemFontFolder().completeChildPath(fileName);\n+   }\n+\n+   pResponse->setCacheableFile(fontFile, request);\n+   return;\n+}\n+\n+// Handles an HTTP request for font CSS. This will typically look something like:\n+//\n+// GET /fonts/css/Victor Mono.css\n+//\n+// The request is fulfilled by automatically generating the appropriate CSS @font-face rule(s) for\n+// the font and returning them in the body of the request.\n+void handleFontCssRequest(const http::Request& request,\n+                          http::Response* pResponse)\n+{\n+   Error error;\n+   std::string css;\n+   std::string prefix = \"/\"  kFontCss;\n+   std::string fileName = http::util::pathAfterPrefix(request, prefix);\n+\n+   // Strip off \".css\" to get name of font\n+   size_t idx = fileName.find(\".css\");\n+   if (idx != std::string::npos)\n+   {\n+      fileName = fileName.substr(0, idx);\n+   }\n+   \n+   // Enumerate user and system font directories\n+   std::vector<FilePath> dirs;\n+   dirs.push_back(userFontFolder());\n+   dirs.push_back(systemFontFolder());\n+\n+   for (const auto& dir: dirs)\n+   {\n+      FilePath subDir = dir.completeChildPath(fileName);\n+      if (subDir.exists() && subDir.isDirectory())\n+      {\n+         // Folder full of font files\n+         std::vector<std::string> parents;\n+         parents.push_back(fileName);\n+         error = generateCssFromDir(subDir, fileName, parents, &css);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f30c294e4e083e2ced06934272e84c107fd8db5e"}, "originalPosition": 227}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQxMzUxMg==", "bodyText": "nit, copyright header year update", "url": "https://github.com/rstudio/rstudio/pull/6592#discussion_r404413512", "createdAt": "2020-04-06T21:57:46Z", "author": {"login": "gtritchie"}, "path": "src/cpp/server/ServerMain.cpp", "diffHunk": "@@ -231,6 +231,7 @@ void httpServerAddHandlers()\n    uri_handlers::add(\"/mathjax\", secureAsyncHttpHandler(proxyContentRequest));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f30c294e4e083e2ced06934272e84c107fd8db5e"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66edabe481b12e6a61987eb40b47343e79726adc", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/66edabe481b12e6a61987eb40b47343e79726adc", "committedDate": "2020-04-06T22:30:28Z", "message": "code review feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 317, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}