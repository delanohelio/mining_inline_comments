{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwMjU3NDU0", "number": 6759, "title": "Read old RStudio 1.3 state file if it exists", "bodyText": "We recently moved to separate state files for desktop and server (see #6742). However, they were both new files, which means that if you used an older version of the 1.3 preview you'll lose your context ID and therefore your open tabs.\nThis change fixes that issue by migrating the old state file if it exists.\n(note: user preferences tag is because this is closely related to the preference system)\nWill be backported to 1.3.", "createdAt": "2020-04-28T17:27:02Z", "url": "https://github.com/rstudio/rstudio/pull/6759", "merged": true, "mergeCommit": {"oid": "8fc59b3b6e8cc4a3b0871b7acd4bd30ae6aee422"}, "closed": true, "closedAt": "2020-04-28T18:05:27Z", "author": {"login": "jmcphers"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccHTfPgH2gAyNDEwMjU3NDU0OmRkNTU2MDQ1MTQxZjhjNDk4ZjI2ODU1MDFlYzQzM2ZmY2FmYjQ2NGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccHvs6AFqTQwMjA3OTUwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dd556045141f8c498f2685501ec433ffcafb464d", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/dd556045141f8c498f2685501ec433ffcafb464d", "committedDate": "2020-04-28T17:26:35Z", "message": "read old RStudio 1.3 state file if it exists"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMDYzMTIy", "url": "https://github.com/rstudio/rstudio/pull/6759#pullrequestreview-402063122", "createdAt": "2020-04-28T17:35:31Z", "commit": {"oid": "dd556045141f8c498f2685501ec433ffcafb464d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNzozNTozMVrOGNfXCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNzozNTozMVrOGNfXCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc5ODQ3NQ==", "bodyText": "One worry: If I understand correctly, some users might lose their old tabs if they had been working with both RStudio Desktop + RStudio Server on the same machine (since previously they \"shared\" the same set of tabs). Is this something worth guarding against?", "url": "https://github.com/rstudio/rstudio/pull/6759#discussion_r416798475", "createdAt": "2020-04-28T17:35:31Z", "author": {"login": "kevinushey"}, "path": "src/cpp/session/prefs/UserStateLayer.cpp", "diffHunk": "@@ -33,18 +33,34 @@ UserStateLayer::UserStateLayer():\n \n core::Error UserStateLayer::readPrefs()\n {\n-   prefsFile_ = core::system::xdg::userDataDir().completePath(\n+   FilePath schemaFile = options().rResourcesPath().completePath(\"schema\").completePath(kUserStateSchemaFile);\n+\n+   // desktop and server versions of RStudio use separate state files so that mixing desktop and server\n+   // on the same machine is possible w/o side effects like sharing a source database\n+   stateFile_ = core::system::xdg::userDataDir().completePath(\n          options().programMode() == kSessionProgramModeDesktop ? \n             kUserStateFileDesktop : \n             kUserStateFileServer);\n \n-   return loadPrefsFromFile(prefsFile_,\n-      options().rResourcesPath().completePath(\"schema\").completePath(kUserStateSchemaFile));\n+   if (!stateFile_.exists())\n+   {\n+      // if there's no state file yet, check for a state file left by an older version of RStudio 1.3\n+      FilePath oldStateFile = core::system::xdg::userDataDir().completePath(\"rstudio-state.json\");\n+      if (oldStateFile.exists())\n+      {\n+          // found an old file; attempt to migrate it\n+          Error error = oldStateFile.move(stateFile_);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd556045141f8c498f2685501ec433ffcafb464d"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMDY0MDM1", "url": "https://github.com/rstudio/rstudio/pull/6759#pullrequestreview-402064035", "createdAt": "2020-04-28T17:36:41Z", "commit": {"oid": "dd556045141f8c498f2685501ec433ffcafb464d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNzozNjo0MVrOGNfaXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNzozNjo0MVrOGNfaXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc5OTMyNg==", "bodyText": "So in pathological case where (for example) user was last using RStudio Server 1.3 (prior to the separation of desktop vs server state files), then installs updated RStudio Desktop and Server 1.3 and runs desktop, it will take over that previous state, and next time they run Server that state is gone? Maybe nothing can be done about this. What if you, on first time encountering this scenario where the new state filename is missing, copy the legacy state file over both to desktop and server then delete the old one? Maybe that would be worse, I'm not sure of the implications or if would be worth the complexity.", "url": "https://github.com/rstudio/rstudio/pull/6759#discussion_r416799326", "createdAt": "2020-04-28T17:36:41Z", "author": {"login": "gtritchie"}, "path": "src/cpp/session/prefs/UserStateLayer.cpp", "diffHunk": "@@ -33,18 +33,34 @@ UserStateLayer::UserStateLayer():\n \n core::Error UserStateLayer::readPrefs()\n {\n-   prefsFile_ = core::system::xdg::userDataDir().completePath(\n+   FilePath schemaFile = options().rResourcesPath().completePath(\"schema\").completePath(kUserStateSchemaFile);\n+\n+   // desktop and server versions of RStudio use separate state files so that mixing desktop and server\n+   // on the same machine is possible w/o side effects like sharing a source database\n+   stateFile_ = core::system::xdg::userDataDir().completePath(\n          options().programMode() == kSessionProgramModeDesktop ? \n             kUserStateFileDesktop : \n             kUserStateFileServer);\n \n-   return loadPrefsFromFile(prefsFile_,\n-      options().rResourcesPath().completePath(\"schema\").completePath(kUserStateSchemaFile));\n+   if (!stateFile_.exists())\n+   {\n+      // if there's no state file yet, check for a state file left by an older version of RStudio 1.3\n+      FilePath oldStateFile = core::system::xdg::userDataDir().completePath(\"rstudio-state.json\");\n+      if (oldStateFile.exists())\n+      {\n+          // found an old file; attempt to migrate it\n+          Error error = oldStateFile.move(stateFile_);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd556045141f8c498f2685501ec433ffcafb464d"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMDc0OTQy", "url": "https://github.com/rstudio/rstudio/pull/6759#pullrequestreview-402074942", "createdAt": "2020-04-28T17:51:19Z", "commit": {"oid": "dd556045141f8c498f2685501ec433ffcafb464d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMDc5NTAw", "url": "https://github.com/rstudio/rstudio/pull/6759#pullrequestreview-402079500", "createdAt": "2020-04-28T17:57:24Z", "commit": {"oid": "dd556045141f8c498f2685501ec433ffcafb464d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 230, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}