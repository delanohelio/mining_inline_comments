{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwNDA3NDQ4", "number": 8199, "title": "allow Qt 5.15.x redirects", "bodyText": "Intent\nQt 5.14 added a new type of navigation, NavigationTypeRedirect, which we were disallowing in requests to acceptNavigationRequest(). This PR allows us to accept redirects.\nIn addition, prior releases of RStudio needed to work around a Qt bug in acceptNavigationRequest(), which basically required us to infer the navigation type in a roundabout way. That workaround is no longer required.\nNOTE: We should consider whether we want to always allow redirects. If a host is considered \"safe\", do we also want to consider their redirects (even to a separate host / origin) as safe? Or is the right fix here to just disallow the marketo redirect altogether? Or do we whitelist marketo but disallow other redirects?\nApproach\nStraightforward removal of old workaround + handling of new navigation type.\nQA Notes\nCloses #8187. Test via notes in #8187.", "createdAt": "2020-10-27T01:44:49Z", "url": "https://github.com/rstudio/rstudio/pull/8199", "merged": true, "mergeCommit": {"oid": "ec6156694ede34862da94920e2bcf6e184123b2f"}, "closed": true, "closedAt": "2020-10-27T18:03:14Z", "author": {"login": "kevinushey"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWrweVAFqTUxNzkwNDkxMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWs6BXABqjM5MjczNzA5NTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTA0OTEy", "url": "https://github.com/rstudio/rstudio/pull/8199#pullrequestreview-517904912", "createdAt": "2020-10-27T16:29:10Z", "commit": {"oid": "b5bb57ae88236a75f8bd82b36990dc40cd0e6fd8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjoyOToxMFrOHpFewA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjozNTo1OFrOHpFzEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0MzQ1Ng==", "bodyText": "Given where we're at in 1.4, I wouldn't make such a big change now; use of this map predates the workarounds made for the specific Qt issue, so worry there are other side effects/reasons we might be missing here.\nPlus we've never tested reliability of NavigationType in the context of Qt 5.12.8, which this code will still be using in everything but Mac desktop, so hate to open up that can of worms.\nMaybe open a separate tracking issue to revisit cleaning this up in juliet-rose when we have a bit more time to validate?", "url": "https://github.com/rstudio/rstudio/pull/8199#discussion_r512843456", "createdAt": "2020-10-27T16:29:10Z", "author": {"login": "gtritchie"}, "path": "src/cpp/desktop/DesktopWebPage.cpp", "diffHunk": "@@ -46,13 +46,6 @@ namespace {\n WindowTracker s_windowTracker;\n std::mutex s_mutex;\n \n-// NOTE: This variable is static and hence shared by all of the web pages\n-// created by RStudio. This is intentional as it's possible that the\n-// request interceptor from one page will handle a request, and a _different_\n-// page will handle the new navigation attempt -- so both pages will need\n-// access to the same data.\n-std::map<QUrl, int> s_subframes;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5bb57ae88236a75f8bd82b36990dc40cd0e6fd8"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0MzY3Ng==", "bodyText": "This should be removed.", "url": "https://github.com/rstudio/rstudio/pull/8199#discussion_r512843676", "createdAt": "2020-10-27T16:29:25Z", "author": {"login": "gtritchie"}, "path": "src/cpp/desktop/DesktopWebPage.cpp", "diffHunk": "@@ -382,15 +370,12 @@ bool isSafeHost(const std::string& host)\n \n } // end anonymous namespace\n \n-// NOTE: NavigationType is unreliable, as per:\n-//\n-//    https://bugreports.qt.io/browse/QTBUG-56805\n-//\n-// so we avoid querying it here.\n bool WebPage::acceptNavigationRequest(const QUrl &url,\n-                                      NavigationType /* navType*/,\n+                                      NavigationType navType,\n                                       bool isMainFrame)\n {\n+   qDebug() << url << \"[\" << navType << \"]\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5bb57ae88236a75f8bd82b36990dc40cd0e6fd8"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0NDU4OQ==", "bodyText": "Should this be doing return isSafeHost(host); instead of just return true?", "url": "https://github.com/rstudio/rstudio/pull/8199#discussion_r512844589", "createdAt": "2020-10-27T16:30:26Z", "author": {"login": "gtritchie"}, "path": "src/cpp/desktop/DesktopWebPage.cpp", "diffHunk": "@@ -466,7 +443,13 @@ bool WebPage::acceptNavigationRequest(const QUrl &url,\n       {\n          return true;\n       }\n-      else\n+#if QT_VERSION >= QT_VERSION_CHECK(5, 15, 0)\n+      else if (navType == NavigationTypeRedirect)\n+      {\n+         return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5bb57ae88236a75f8bd82b36990dc40cd0e6fd8"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0NTUwNg==", "bodyText": "Nervous about relying on navType in Qt 5.12.8, just because it introduces the need to retest this on all platforms. How about this just stays as \"else\", thus wrapping all use of navType in the QT_VERSION >= 5.15 and making this change a no-op for anything but Mac w/5.15?", "url": "https://github.com/rstudio/rstudio/pull/8199#discussion_r512845506", "createdAt": "2020-10-27T16:31:42Z", "author": {"login": "gtritchie"}, "path": "src/cpp/desktop/DesktopWebPage.cpp", "diffHunk": "@@ -466,7 +443,13 @@ bool WebPage::acceptNavigationRequest(const QUrl &url,\n       {\n          return true;\n       }\n-      else\n+#if QT_VERSION >= QT_VERSION_CHECK(5, 15, 0)\n+      else if (navType == NavigationTypeRedirect)\n+      {\n+         return true;\n+      }\n+#endif\n+      else if (navType == NavigationTypeLinkClicked)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5bb57ae88236a75f8bd82b36990dc40cd0e6fd8"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0NjYxOQ==", "bodyText": "Don't think we need to add this to safe hosts; the issue wasn't that this wasn't being allowed (which is also the case in RStudio 1.2 and 1.3 and didn't seem to be a concern) but that we are now opening it in system browser.", "url": "https://github.com/rstudio/rstudio/pull/8199#discussion_r512846619", "createdAt": "2020-10-27T16:33:18Z", "author": {"login": "gtritchie"}, "path": "src/cpp/desktop/DesktopWebPage.cpp", "diffHunk": "@@ -358,7 +346,8 @@ void initSafeHosts()\n    safeHosts_ = {\n       \".youtube.com\",\n       \".vimeo.com\",\n-      \".c9.ms\"\n+      \".c9.ms\",\n+      \".marketo.com\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5bb57ae88236a75f8bd82b36990dc40cd0e6fd8"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0NzEyNA==", "bodyText": "I'd leave this in (per earlier comment about minimizing the change).", "url": "https://github.com/rstudio/rstudio/pull/8199#discussion_r512847124", "createdAt": "2020-10-27T16:34:02Z", "author": {"login": "gtritchie"}, "path": "src/cpp/desktop/DesktopWebPage.cpp", "diffHunk": "@@ -330,11 +323,6 @@ void WebPage::closeRequested()\n \n void WebPage::onUrlIntercepted(const QUrl& url, int type)\n {\n-   if (type == QWebEngineUrlRequestInfo::ResourceTypeSubFrame &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5bb57ae88236a75f8bd82b36990dc40cd0e6fd8"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0ODY1Nw==", "bodyText": "Would leave this as-is.", "url": "https://github.com/rstudio/rstudio/pull/8199#discussion_r512848657", "createdAt": "2020-10-27T16:35:58Z", "author": {"login": "gtritchie"}, "path": "src/cpp/desktop/DesktopWebPage.cpp", "diffHunk": "@@ -418,14 +403,6 @@ bool WebPage::acceptNavigationRequest(const QUrl &url,\n       return true;\n #endif\n    \n-   // if this appears to be an attempt to load an external page within\n-   // an iframe, check it's from a safe host\n-   if (!isLocal && s_subframes.count(url))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5bb57ae88236a75f8bd82b36990dc40cd0e6fd8"}, "originalPosition": 71}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b5bb57ae88236a75f8bd82b36990dc40cd0e6fd8", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/b5bb57ae88236a75f8bd82b36990dc40cd0e6fd8", "committedDate": "2020-10-27T01:40:05Z", "message": "allow redirects; treat marketo as safe host"}, "afterCommit": {"oid": "e4fa3da9f412691d9d457ac7b8fbc89901a93986", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/e4fa3da9f412691d9d457ac7b8fbc89901a93986", "committedDate": "2020-10-27T17:16:00Z", "message": "handle redirects with Qt 5.15.x"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTg1MDk3", "url": "https://github.com/rstudio/rstudio/pull/8199#pullrequestreview-517985097", "createdAt": "2020-10-27T17:47:10Z", "commit": {"oid": "07457406cdbc489924e97e028026c58d7ad87497"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48d950aaedd80eda9bc405e054951042bc376a80", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/48d950aaedd80eda9bc405e054951042bc376a80", "committedDate": "2020-10-27T18:02:37Z", "message": "handle redirects with Qt 5.15.x"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "07457406cdbc489924e97e028026c58d7ad87497", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/07457406cdbc489924e97e028026c58d7ad87497", "committedDate": "2020-10-27T17:17:30Z", "message": "allow internal redirects"}, "afterCommit": {"oid": "48d950aaedd80eda9bc405e054951042bc376a80", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/48d950aaedd80eda9bc405e054951042bc376a80", "committedDate": "2020-10-27T18:02:37Z", "message": "handle redirects with Qt 5.15.x"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4949, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}