{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgwMjA3NDAz", "number": 7738, "title": "implement simple selection-based transformations for visual mode", "bodyText": "Intent\nCurrently, most APIs in rstudioapi expect a traditional text-based document, and so provide information suitable for that format. Unfortunately, such APIs don't map well to the abstractions used with the visual editor, and so many of these APIs are no longer appropriate.\nThis PR implements a set of simple selection-based APIs that allow R packages (via addins) to receive and transform the current selection, and work both in visual mode and source mode.\nApproach\nThe PR is a bit long, but straightforward: we implement two API functions .rs.api.selectionGet() and .rs.api.selectionSet(), and wire those up to \"do the right thing\" regardless of whether the editor is in visual mode or source mode.\nQA Notes\nI'll need to put together some example addins to make it easier (possible?) for QA to properly test this.\n\n\nNotes\nRight now, .rs.api.selectionGet() just returns an R list with value set to the current selection; e.g.\n> print(.rs.api.selectionGet())\n$value\n[1] \"  styled <- styler::style_text(selection$value)\\n\"\n\nIs there anything else we should include on this object?", "createdAt": "2020-09-04T22:27:02Z", "url": "https://github.com/rstudio/rstudio/pull/7738", "merged": true, "mergeCommit": {"oid": "784d7718d3ae20d73fd2058d1dc482ea9dbfa34c"}, "closed": true, "closedAt": "2020-09-09T17:20:53Z", "author": {"login": "kevinushey"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFY7aEAH2gAyNDgwMjA3NDAzOmU1ZWM0OGVkNGRiMWQzZDEwZmNjYmZjNTBmNDEwMDk2MjFiMDk1NmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdG8-whAH2gAyNDgwMjA3NDAzOjZmNjgxYTUwNzFhZTc4ZTAxMmJhZDYzYzliNTI1MWQxOWMzZjk5YTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e5ec48ed4db1d3d10fccbfc50f41009621b0956f", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/e5ec48ed4db1d3d10fccbfc50f41009621b0956f", "committedDate": "2020-09-03T23:09:28Z", "message": "scaffolding for rstudio api requests / responses"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2182d81a9a0b4e56d7d3522ad1e5bb7dda5dcad3", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/2182d81a9a0b4e56d7d3522ad1e5bb7dda5dcad3", "committedDate": "2020-09-04T00:27:22Z", "message": "wired through API for getting selection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3a6b44b3564a52caf1ae1f3bec7d503a9c676d0", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/a3a6b44b3564a52caf1ae1f3bec7d503a9c676d0", "committedDate": "2020-09-04T21:29:02Z", "message": "implement selection setter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f64fdb592bc24eafe3f7cf03e98661c7c9913420", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/f64fdb592bc24eafe3f7cf03e98661c7c9913420", "committedDate": "2020-09-04T21:55:38Z", "message": "preserve previous selection if any"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab95e44a2ac617b2ab8b0c48c94bc76f31086388", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/ab95e44a2ac617b2ab8b0c48c94bc76f31086388", "committedDate": "2020-09-04T21:57:40Z", "message": "tweaks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f94e96361410de5251fd6bffaa3ead5ff1f1d96", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/4f94e96361410de5251fd6bffaa3ead5ff1f1d96", "committedDate": "2020-09-04T22:01:18Z", "message": "allow 'insertText' API to work as-is when no range set"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa844f5b8c4855fecd73d726ef972690a2cba2d6", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/aa844f5b8c4855fecd73d726ef972690a2cba2d6", "committedDate": "2020-09-04T22:26:48Z", "message": "wire through document id in APIs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f21f621d83233184052d6c6aa56ba4e743af1bc", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/2f21f621d83233184052d6c6aa56ba4e743af1bc", "committedDate": "2020-09-04T22:31:11Z", "message": "ensure session always receives response"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMDYwOTM5", "url": "https://github.com/rstudio/rstudio/pull/7738#pullrequestreview-483060939", "createdAt": "2020-09-05T15:13:26Z", "commit": {"oid": "2f21f621d83233184052d6c6aa56ba4e743af1bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQxNToxMzoyNlrOHNijRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQxNToxMzoyNlrOHNijRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk1OTYyMw==", "bodyText": "In order to preserve the selection's marks here you want to do this:\nconst tr = this.view.state.tr;\nconst selectionMarks = tr.selection.$from.marks();\ntr.replaceSelectionWith(state.schema.text(value, selectionMarks), false);\nthis.view.dispatch(tr);", "url": "https://github.com/rstudio/rstudio/pull/7738#discussion_r483959623", "createdAt": "2020-09-05T15:13:26Z", "author": {"login": "jjallaire"}, "path": "src/gwt/panmirror/src/editor/src/editor/editor.ts", "diffHunk": "@@ -627,6 +627,33 @@ export class Editor {\n     return this.getMarkdownCode(tr, options);\n   }\n \n+  public getSelectedText(): string {\n+    \n+    return this.state.doc.textBetween(\n+      this.state.selection.from,\n+      this.state.selection.to\n+    );\n+\n+  }\n+\n+  public replaceSelection(value: string): void {\n+\n+    // retrieve properties we need from selection\n+    let {from, empty} = this.view.state.selection;\n+\n+    // insert text", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f21f621d83233184052d6c6aa56ba4e743af1bc"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c1e248bdf8303629f8248fa22cfc88b7dd374bb", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/2c1e248bdf8303629f8248fa22cfc88b7dd374bb", "committedDate": "2020-09-07T15:46:06Z", "message": "tidying up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbba1c0556a51cdd16b66149a137b782bd51a5a9", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/cbba1c0556a51cdd16b66149a137b782bd51a5a9", "committedDate": "2020-09-08T16:49:20Z", "message": "preserve marks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f681a5071ae78e012bad63c9b5251d19c3f99a8", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/6f681a5071ae78e012bad63c9b5251d19c3f99a8", "committedDate": "2020-09-08T19:43:38Z", "message": "Merge branch 'master' into feature/visual-mode-rstudioapi-selection-apis"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4965, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}