{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyOTQ1NjAx", "number": 8056, "title": "Forward scrolling from chunk callback to editor", "bodyText": "Intent\nFixes #8008\nPrior to this fix scrolling over chunk callback output would do nothing and interrupt scrolling occuring on the editor. Now the iframe will forward mousewheel or wheel events to the editor so it can handle the scrolling.\nApproach\nSince the iframe was not triggering the scroll event, the iframe forwards wheel events to the editor -- ace editor was coded to trigger scroll events from these. Due to browsers handling the wheel events differently, we need to check which event is supported to set the listener. I ran into an issue with Chrome where if listeners were set for wheel or wheel and mousewheel the scroll wasn't triggered so mousewheel is used as the preferred event.\nA similar approach can be used to fix #2202 but since that would require some additional logic I didn't implement it with this PR.\nI also included a fix to set the height of the output to 0 whenever the output is mutated. Without this the frame was not resized if its content shrunk.\nQA Notes\nWe need to make sure this is working for all supported browsers.", "createdAt": "2020-10-13T22:52:45Z", "url": "https://github.com/rstudio/rstudio/pull/8056", "merged": true, "mergeCommit": {"oid": "d44248de37a002cef22dd84080cafbad137d0e95"}, "closed": true, "closedAt": "2020-10-15T22:39:08Z", "author": {"login": "melissa-barca"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSKyEugH2gAyNTAyOTQ1NjAxOjM0ZWNhOGVmOGM4NzlhZDM5MzljMTE1ZmUyZGM1Y2U4Y2FkNTk0MWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdS5c67gFqTUwOTg1MDE3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "34eca8ef8c879ad3939c115fe2dc5ce8cad5941a", "author": {"user": {"login": "melissa-barca", "name": "Melissa Barca"}}, "url": "https://github.com/rstudio/rstudio/commit/34eca8ef8c879ad3939c115fe2dc5ce8cad5941a", "committedDate": "2020-10-13T16:01:37Z", "message": "fix issues with callback height not adjusting as desired"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e9ad2ffcf3cb2eb70f601d5a0bddce2bec89a44", "author": {"user": {"login": "melissa-barca", "name": "Melissa Barca"}}, "url": "https://github.com/rstudio/rstudio/commit/0e9ad2ffcf3cb2eb70f601d5a0bddce2bec89a44", "committedDate": "2020-10-13T22:07:18Z", "message": "forward wheel events from chunk callback output to ace editor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3ODg4OTU5", "url": "https://github.com/rstudio/rstudio/pull/8056#pullrequestreview-507888959", "createdAt": "2020-10-13T23:06:12Z", "commit": {"oid": "0e9ad2ffcf3cb2eb70f601d5a0bddce2bec89a44"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QyMzowNjoxMlrOHg8hqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QyMzowNjoxMlrOHg8hqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMwODEzOQ==", "bodyText": "This could very well be happening over a WAN or slow connection so 50ms may not be enough time for everything to load (such that we are guaranteed to have the final height). Maybe we should wait for the frame's load event?", "url": "https://github.com/rstudio/rstudio/pull/8056#discussion_r504308139", "createdAt": "2020-10-13T23:06:12Z", "author": {"login": "jmcphers"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/ChunkOutputStream.java", "diffHunk": "@@ -447,15 +451,29 @@ public void showCallbackHtml(String htmlOutput)\n          public void execute()\n          {\n             DomUtils.fillIFrame(frame.getIFrame(), htmlOutput);\n+            DomUtils.forwardWheelEvent(frame.getIFrame().getContentDocument(), parentElement);\n+            \n+            Document anotherDoc = frame.getWindow().getDocument().getOwnerDocument();\n             int contentHeight = frame.getWindow().getDocument().getDocumentElement().getOffsetHeight();\n             frame.getElement().getStyle().setHeight(contentHeight, Unit.PX);\n             frame.getElement().getStyle().setWidth(100, Unit.PCT);\n             onHeightChanged();\n \n             Command handler = () -> {\n-               int newHeight = frame.getWindow().getDocument().getDocumentElement().getOffsetHeight();\n-               frame.getElement().getStyle().setHeight(newHeight, Unit.PX);\n-               onHeightChanged();\n+               // reset height so we can shrink it if necessary\n+               frame.getElement().getStyle().setHeight(0, Unit.PX);\n+  \n+               // delay calculating the height so any images can load\n+               new Timer()\n+               {\n+                  @Override\n+                  public void run()\n+                  {\n+                     int newHeight = frame.getWindow().getDocument().getDocumentElement().getOffsetHeight();\n+                     frame.getElement().getStyle().setHeight(newHeight, Unit.PX);\n+                     onHeightChanged();\n+                  }\n+               }.schedule(50);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e9ad2ffcf3cb2eb70f601d5a0bddce2bec89a44"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a98b313dd30151223e213f36f9c53b8814330dc", "author": {"user": {"login": "melissa-barca", "name": "Melissa Barca"}}, "url": "https://github.com/rstudio/rstudio/commit/4a98b313dd30151223e213f36f9c53b8814330dc", "committedDate": "2020-10-14T15:40:00Z", "message": "remove unneeded code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5ODM0MzQ2", "url": "https://github.com/rstudio/rstudio/pull/8056#pullrequestreview-509834346", "createdAt": "2020-10-15T21:50:49Z", "commit": {"oid": "4a98b313dd30151223e213f36f9c53b8814330dc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5ODUwMTc0", "url": "https://github.com/rstudio/rstudio/pull/8056#pullrequestreview-509850174", "createdAt": "2020-10-15T22:24:03Z", "commit": {"oid": "4a98b313dd30151223e213f36f9c53b8814330dc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4929, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}