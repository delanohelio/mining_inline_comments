{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4MTUxMjY2", "number": 6720, "title": "patch visual mode changes into source editor", "bodyText": "", "createdAt": "2020-04-23T19:47:19Z", "url": "https://github.com/rstudio/rstudio/pull/6720", "merged": true, "mergeCommit": {"oid": "4a1c7db2c304eb7705e05850d6e185b4410e7d5c"}, "closed": true, "closedAt": "2020-04-24T01:07:16Z", "author": {"login": "jjallaire"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcafLEyAH2gAyNDA4MTUxMjY2OjlkOGE2NmZhNzVlNzQ2NDBkYzRiMDE0MjJlYjVkYzdjMzI0OThmMzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcam4wfAH2gAyNDA4MTUxMjY2OmQ3YWExMjQ1OGU2ZjYwMGRlNTcxNjM2MzE3ODBiMTU0ODNmNTJiNmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9d8a66fa75e74640dc4b01422eb5dc7c32498f31", "author": {"user": {"login": "jjallaire", "name": "J.J. Allaire"}}, "url": "https://github.com/rstudio/rstudio/commit/9d8a66fa75e74640dc4b01422eb5dc7c32498f31", "committedDate": "2020-04-23T16:07:16Z", "message": "wip on jsdiff for source changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75b7e0fb8bd38f56b36018d96d4b894b6861eb2a", "author": {"user": {"login": "jjallaire", "name": "J.J. Allaire"}}, "url": "https://github.com/rstudio/rstudio/commit/75b7e0fb8bd38f56b36018d96d4b894b6861eb2a", "committedDate": "2020-04-23T16:09:16Z", "message": "ability to hook ace history operations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12e35b1996e39c8838115b6967081b2aad465e6e", "author": {"user": {"login": "jjallaire", "name": "J.J. Allaire"}}, "url": "https://github.com/rstudio/rstudio/commit/12e35b1996e39c8838115b6967081b2aad465e6e", "committedDate": "2020-04-23T16:09:37Z", "message": "Revert \"ability to hook ace history operations\"\n\nThis reverts commit 75b7e0fb8bd38f56b36018d96d4b894b6861eb2a."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e36d3d4bacfd4c7665429d568604bdeaa3b6c11d", "author": {"user": {"login": "jjallaire", "name": "J.J. Allaire"}}, "url": "https://github.com/rstudio/rstudio/commit/e36d3d4bacfd4c7665429d568604bdeaa3b6c11d", "committedDate": "2020-04-23T16:15:02Z", "message": "notes on other commands"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "854db708f8f352fcf0aa801ce252dbc8a682acda", "author": {"user": {"login": "jjallaire", "name": "J.J. Allaire"}}, "url": "https://github.com/rstudio/rstudio/commit/854db708f8f352fcf0aa801ce252dbc8a682acda", "committedDate": "2020-04-23T19:43:18Z", "message": "apply diffs to source editor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2d1e2e2a5880416a67604e0a97c2c7456cddb91", "author": {"user": {"login": "jjallaire", "name": "J.J. Allaire"}}, "url": "https://github.com/rstudio/rstudio/commit/d2d1e2e2a5880416a67604e0a97c2c7456cddb91", "committedDate": "2020-04-23T19:44:39Z", "message": "remove unused imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NDQwOTAw", "url": "https://github.com/rstudio/rstudio/pull/6720#pullrequestreview-399440900", "createdAt": "2020-04-23T20:12:57Z", "commit": {"oid": "d2d1e2e2a5880416a67604e0a97c2c7456cddb91"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDoxMjo1N1rOGK6MPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDoxMjo1N1rOGK6MPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5MjM1MA==", "bodyText": "I'd just move this to before the for-loop begins.", "url": "https://github.com/rstudio/rstudio/pull/6720#discussion_r414092350", "createdAt": "2020-04-23T20:12:57Z", "author": {"login": "jcheng5"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java", "diffHunk": "@@ -1118,6 +1121,84 @@ public void insertCode(String code, boolean blockMode)\n    {\n       widget_.getEditor().insert(StringUtil.normalizeNewLines(code));\n    }\n+   \n+   public void applyCodeChanges(JsdiffChange[] changes)\n+   {\n+      // alias apis\n+      AceEditorNative editor = widget_.getEditor();\n+      EditSession session = editor.getSession();\n+      Selection selection = session.getSelection();\n+      AceCommandManager commandManager = editor.getCommandManager();\n+      \n+      // function to advance the selection\n+      Consumer<Integer> advanceSelection = (Integer charsLeft) -> {\n+         \n+         // start from current line/row\n+         Position startPos = selection.getCursor();\n+         \n+         // iterate through rows until we've consumed all the chars\n+         int row;\n+         int col = startPos.getColumn();\n+         for (row = startPos.getRow(); row < session.getLength(); row++) {\n+            \n+            // how many chars left in the current column?\n+            String line = session.getLine(row);\n+            int charsLeftInLine = line.length() - col;\n+            \n+            // is the number of chars we still need to consume lte\n+            // the number of charsLeft?\n+            if (charsLeft <= charsLeftInLine) \n+            {\n+               col = col + charsLeft;\n+               break;\n+            }\n+            else\n+            {\n+               charsLeft -= (charsLeftInLine+1); // add 1 for newline\n+               col = 0;\n+            }\n+         }\n+         \n+         // move the selection\n+         selection.moveCursorTo(row, col, false);\n+      };\n+      \n+      \n+      // process changes\n+      for (int i = 0; i<changes.length; i++) \n+      {\n+         // get change\n+         JsdiffChange change = changes[i];\n+         \n+         // if it's the first change then set the cursor location to the beginning of the file\n+         if (i == 0)\n+            selection.moveCursorTo(0, 0, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2d1e2e2a5880416a67604e0a97c2c7456cddb91"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NDQ4ODcz", "url": "https://github.com/rstudio/rstudio/pull/6720#pullrequestreview-399448873", "createdAt": "2020-04-23T20:25:05Z", "commit": {"oid": "d2d1e2e2a5880416a67604e0a97c2c7456cddb91"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDoyNTowNVrOGK6oKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMDoyNTowNVrOGK6oKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5OTQ5OQ==", "bodyText": "The logic looks correct to me. I had to focus hard to make sure that a) charsLeft can never become less than 0, and b) that the row will never be advanced accidentally.\nThis suggestion is (supposed to be) equivalent but a little easier for my brain. I changed the for-loop to while, incrementing row manually; and moved the newline \"+1\" from the end of the loop body to the beginning, which I find makes the if/else easier to reason about.\n(If you find your version easier to understand, I'm fine with you leaving it that way.)\n         int row = startPos.getRow();\n         int col = startPos.getColumn();\n         while (row < session.getLength()) {\n\n            // how many chars left in the current column?\n            String line = session.getLine(row);\n            // the +1 is for newline\n            int charsLeftInLine = line.length() + 1 - col;\n\n            // is the number of chars we still need to consume lte\n            // the number of charsLeft?\n            if (charsLeft < charsLeftInLine) \n            {\n               col += charsLeft;\n               break;\n            }\n            else\n            {\n               charsLeft -= charsLeftInLine;\n               col = 0;\n               row++;\n            }\n         }", "url": "https://github.com/rstudio/rstudio/pull/6720#discussion_r414099499", "createdAt": "2020-04-23T20:25:05Z", "author": {"login": "jcheng5"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/source/editors/text/AceEditor.java", "diffHunk": "@@ -1118,6 +1121,84 @@ public void insertCode(String code, boolean blockMode)\n    {\n       widget_.getEditor().insert(StringUtil.normalizeNewLines(code));\n    }\n+   \n+   public void applyCodeChanges(JsdiffChange[] changes)\n+   {\n+      // alias apis\n+      AceEditorNative editor = widget_.getEditor();\n+      EditSession session = editor.getSession();\n+      Selection selection = session.getSelection();\n+      AceCommandManager commandManager = editor.getCommandManager();\n+      \n+      // function to advance the selection\n+      Consumer<Integer> advanceSelection = (Integer charsLeft) -> {\n+         \n+         // start from current line/row\n+         Position startPos = selection.getCursor();\n+         \n+         // iterate through rows until we've consumed all the chars\n+         int row;\n+         int col = startPos.getColumn();\n+         for (row = startPos.getRow(); row < session.getLength(); row++) {\n+            \n+            // how many chars left in the current column?\n+            String line = session.getLine(row);\n+            int charsLeftInLine = line.length() - col;\n+            \n+            // is the number of chars we still need to consume lte\n+            // the number of charsLeft?\n+            if (charsLeft <= charsLeftInLine) \n+            {\n+               col = col + charsLeft;\n+               break;\n+            }\n+            else\n+            {\n+               charsLeft -= (charsLeftInLine+1); // add 1 for newline\n+               col = 0;\n+            }\n+         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2d1e2e2a5880416a67604e0a97c2c7456cddb91"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61b09b3e087f6fd112ca577ae45537c8a905f1f8", "author": {"user": {"login": "jjallaire", "name": "J.J. Allaire"}}, "url": "https://github.com/rstudio/rstudio/commit/61b09b3e087f6fd112ca577ae45537c8a905f1f8", "committedDate": "2020-04-23T22:45:35Z", "message": "update todo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a085c1b2081c07e871afeb5fd6ec5c41933c20d", "author": {"user": {"login": "jjallaire", "name": "J.J. Allaire"}}, "url": "https://github.com/rstudio/rstudio/commit/0a085c1b2081c07e871afeb5fd6ec5c41933c20d", "committedDate": "2020-04-24T00:53:17Z", "message": "move cursor to start before applying changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7600f9be0e2e8c54e3faccf85b2662ea5ea06a13", "author": {"user": {"login": "jjallaire", "name": "J.J. Allaire"}}, "url": "https://github.com/rstudio/rstudio/commit/7600f9be0e2e8c54e3faccf85b2662ea5ea06a13", "committedDate": "2020-04-24T01:05:02Z", "message": "changes to patch loop as per jcheng5"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7aa12458e6f600de57163631780b15483f52b6e", "author": {"user": {"login": "jjallaire", "name": "J.J. Allaire"}}, "url": "https://github.com/rstudio/rstudio/commit/d7aa12458e6f600de57163631780b15483f52b6e", "committedDate": "2020-04-24T01:06:30Z", "message": "update todo"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 223, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}