{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzODM5Nzgz", "number": 6401, "title": "share web profile across different pages", "bodyText": "Candidate fix for #6201.\nNote: merely sharing the web profile across different pages (RStudio windows) was surprisingly not sufficient; I was still able to reproduce cache load failures when opening multiple satellite windows at the same time. It looks like forcing HTTP resources to be cached in-memory helps avoid this issue, at least as far as I can see in testing.", "createdAt": "2020-03-04T20:05:20Z", "url": "https://github.com/rstudio/rstudio/pull/6401", "merged": true, "mergeCommit": {"oid": "c1385c0f2caa015ed38306fce9633632c87c3819"}, "closed": true, "closedAt": "2020-03-06T19:16:47Z", "author": {"login": "kevinushey"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKesj8gFqTM2OTE3MjE3OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcLFHRXgFqTM3MDU2NDU3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MTcyMTc5", "url": "https://github.com/rstudio/rstudio/pull/6401#pullrequestreview-369172179", "createdAt": "2020-03-04T22:29:59Z", "commit": {"oid": "1d1c1fe13ce7b31be1ffde30dc155c67df57ff2e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjoyOTo1OVrOFyACIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQyMjozMTowMVrOFyAD7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3MzY2Nw==", "bodyText": "Don't we need to ensure that a different WebProfile object is constructed for different base urls to ensure the interceptor code (for setting the shared secret header) works properly? This seems like that would break that.", "url": "https://github.com/rstudio/rstudio/pull/6401#discussion_r387973667", "createdAt": "2020-03-04T22:29:59Z", "author": {"login": "kfeinauer"}, "path": "src/cpp/desktop/DesktopWebProfile.cpp", "diffHunk": "@@ -66,9 +66,23 @@ class Interceptor : public QWebEngineUrlRequestInterceptor\n \n } // end anonymous namespace\n \n-WebProfile::WebProfile(const QUrl& baseUrl, QObject* parent)\n-   : QWebEngineProfile(QString::fromUtf8(\"rstudio-desktop\"), parent)\n+WebProfile* WebProfile::getInstance(const QUrl &baseUrl)\n {\n+   static WebProfile* instance = new WebProfile(baseUrl);\n+   return instance;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d1c1fe13ce7b31be1ffde30dc155c67df57ff2e"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk3NDEyNg==", "bodyText": "Given this code here, can we live without the static one-per-process WebProfile?", "url": "https://github.com/rstudio/rstudio/pull/6401#discussion_r387974126", "createdAt": "2020-03-04T22:31:01Z", "author": {"login": "kfeinauer"}, "path": "src/cpp/desktop/DesktopWebProfile.cpp", "diffHunk": "@@ -66,9 +66,23 @@ class Interceptor : public QWebEngineUrlRequestInterceptor\n \n } // end anonymous namespace\n \n-WebProfile::WebProfile(const QUrl& baseUrl, QObject* parent)\n-   : QWebEngineProfile(QString::fromUtf8(\"rstudio-desktop\"), parent)\n+WebProfile* WebProfile::getInstance(const QUrl &baseUrl)\n {\n+   static WebProfile* instance = new WebProfile(baseUrl);\n+   return instance;\n+}\n+\n+WebProfile::WebProfile(const QUrl& baseUrl)\n+   : QWebEngineProfile(QStringLiteral(\"rstudio\"))\n+{\n+   // force an in-memory cache of web resources\n+   // otherwise, multiple windows / pages attempting to access\n+   // or mutate the disk cache at the same time can cause\n+   // data corruption to occur\n+   //\n+   // https://github.com/rstudio/rstudio/issues/6201\n+   setHttpCacheType(QWebEngineProfile::MemoryHttpCache);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d1c1fe13ce7b31be1ffde30dc155c67df57ff2e"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98d6811d92673a4ecddfaa6db0abcad1cf438be2", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/98d6811d92673a4ecddfaa6db0abcad1cf438be2", "committedDate": "2020-03-04T22:52:36Z", "message": "use in-memory cache of web resources"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1d1c1fe13ce7b31be1ffde30dc155c67df57ff2e", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/1d1c1fe13ce7b31be1ffde30dc155c67df57ff2e", "committedDate": "2020-03-04T20:04:32Z", "message": "share web profile across different pages"}, "afterCommit": {"oid": "98d6811d92673a4ecddfaa6db0abcad1cf438be2", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/98d6811d92673a4ecddfaa6db0abcad1cf438be2", "committedDate": "2020-03-04T22:52:36Z", "message": "use in-memory cache of web resources"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NjI5MDM2", "url": "https://github.com/rstudio/rstudio/pull/6401#pullrequestreview-369629036", "createdAt": "2020-03-05T14:47:36Z", "commit": {"oid": "98d6811d92673a4ecddfaa6db0abcad1cf438be2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNTY0NTcx", "url": "https://github.com/rstudio/rstudio/pull/6401#pullrequestreview-370564571", "createdAt": "2020-03-06T19:16:43Z", "commit": {"oid": "98d6811d92673a4ecddfaa6db0abcad1cf438be2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 281, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}