{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5MzE2MDcx", "number": 7489, "title": "Load SSL certs from Apple Keychain", "bodyText": "Load certificates from Apple Keychain in addition to OpenSSL certs before doing SSL certificate verification on OSX.\nCloses rstudio/rstudio-pro#1828", "createdAt": "2020-07-30T15:37:51Z", "url": "https://github.com/rstudio/rstudio/pull/7489", "merged": true, "mergeCommit": {"oid": "91efe64b0d884f27933d38044cff790746886630"}, "closed": true, "closedAt": "2020-07-31T21:57:56Z", "author": {"login": "kfeinauer"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6Bdm2AH2gAyNDU5MzE2MDcxOjlkOGEyOWQ4ODNiNDA2NjUwZDY3MGI4MDIzMTY3NzJjNDQyMzk0MzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6bhWMgH2gAyNDU5MzE2MDcxOmI2OTI4ZjlkODI1MWIzNGQyMTVlOWNlYzc3NDFiZDI3NWVjZmU5MDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9d8a29d883b406650d670b802316772c44239431", "author": {"user": {"login": "kfeinauer", "name": "Karl Feinauer"}}, "url": "https://github.com/rstudio/rstudio/commit/9d8a29d883b406650d670b802316772c44239431", "committedDate": "2020-07-30T15:35:56Z", "message": "Load certificates from keychain in addition to OpenSSL certs before doing SSL certificate verification on OSX.\n\nCloses https://github.com/rstudio/rstudio-pro/issues/1828"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NTk2NzMw", "url": "https://github.com/rstudio/rstudio/pull/7489#pullrequestreview-458596730", "createdAt": "2020-07-30T17:09:02Z", "commit": {"oid": "9d8a29d883b406650d670b802316772c44239431"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNzowOTowMlrOG5sLVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNzoxNjoxOVrOG5sa_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0NTgxNQ==", "bodyText": "Does a null result here indicate an error we need to log? Or is this expected in the normal course of operations?", "url": "https://github.com/rstudio/rstudio/pull/7489#discussion_r463145815", "createdAt": "2020-07-30T17:09:02Z", "author": {"login": "jmcphers"}, "path": "src/cpp/core/include/core/http/TcpIpAsyncClientSsl.hpp", "diffHunk": "@@ -238,14 +278,43 @@ class TcpIpAsyncClientSsl\n    }\n #endif\n \n-private:\n-   boost::asio::ssl::context sslContext_;\n-   boost::scoped_ptr<boost::asio::ssl::stream<boost::asio::ip::tcp::socket> > ptrSslStream_;\n-   std::string address_;\n-   std::string port_;\n-   bool verify_;\n-   std::string certificateAuthority_;\n-   boost::posix_time::time_duration connectionTimeout_;\n+#ifdef __APPLE__\n+   class Keychain : public ICertStore\n+   {\n+   public:\n+      Keychain()\n+      {\n+         // load all certs from the keychain\n+         std::vector<KeychainCertificateData> certs = getKeychainCertificates();\n+         for (const auto& cert : certs)\n+         {\n+            // convert the raw bytes from the keychain into a format that OpenSSL can understand\n+            const unsigned char* bytePtr = cert.data.get();\n+            X509* x509 = d2i_X509(nullptr, &bytePtr, cert.size);\n+            if (x509)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d8a29d883b406650d670b802316772c44239431"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0ODkxMg==", "bodyText": "Nit: Idiomatically it's more common for us to use a vector of shared pointers to immutable data structures (and using e.g., std::vector<unsigned char> inside the data structure to create a managed buffer). This reduces copying somewhat but isn't a big deal here so up to you whether you want to change it.", "url": "https://github.com/rstudio/rstudio/pull/7489#discussion_r463148912", "createdAt": "2020-07-30T17:14:41Z", "author": {"login": "jmcphers"}, "path": "src/cpp/core/include/core/http/Keychain.hpp", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Keychain.hpp\n+ *\n+ * Copyright (C) 2020 by RStudio, PBC\n+ *\n+ * Unless you have received this program directly from RStudio pursuant\n+ * to the terms of a commercial license agreement with RStudio, then\n+ * this program is licensed to you under the terms of version 3 of the\n+ * GNU Affero General Public License. This program is distributed WITHOUT\n+ * ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,\n+ * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the\n+ * AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.\n+ *\n+ */\n+\n+#ifndef CORE_HTTP_KEYCHAIN_HPP\n+#define CORE_HTTP_KEYCHAIN_HPP\n+\n+#include <vector>\n+\n+#include <boost/shared_ptr.hpp>\n+\n+namespace rstudio {\n+namespace core {\n+namespace http {\n+\n+struct KeychainCertificateData\n+{\n+   long size;\n+   boost::shared_ptr<unsigned char> data;\n+};\n+\n+std::vector<KeychainCertificateData> getKeychainCertificates();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d8a29d883b406650d670b802316772c44239431"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE0OTgyMA==", "bodyText": "Let's add a comment here making it extra clear that the caller should not free the pointers as they're owned by the cert store.", "url": "https://github.com/rstudio/rstudio/pull/7489#discussion_r463149820", "createdAt": "2020-07-30T17:16:19Z", "author": {"login": "jmcphers"}, "path": "src/cpp/core/include/core/http/TcpIpAsyncClientSsl.hpp", "diffHunk": "@@ -224,12 +258,18 @@ class TcpIpAsyncClientSsl\n          }\n       }\n \n+      std::vector<X509*> getCertificates() const", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d8a29d883b406650d670b802316772c44239431"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6a6a8f60ac5dac527378f4816e485e4fe9f08a2", "author": {"user": {"login": "kfeinauer", "name": "Karl Feinauer"}}, "url": "https://github.com/rstudio/rstudio/commit/c6a6a8f60ac5dac527378f4816e485e4fe9f08a2", "committedDate": "2020-07-30T17:41:43Z", "message": "Code review feedback - log inability to parse X509 certificate (as debug to prevent potential spam), and notate that returned certificates should not be freed."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NjIxOTcz", "url": "https://github.com/rstudio/rstudio/pull/7489#pullrequestreview-458621973", "createdAt": "2020-07-30T17:44:27Z", "commit": {"oid": "c6a6a8f60ac5dac527378f4816e485e4fe9f08a2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9c1f1dd5efd47e1457cfe754eee8b8dc155e013", "author": {"user": {"login": "kfeinauer", "name": "Karl Feinauer"}}, "url": "https://github.com/rstudio/rstudio/commit/d9c1f1dd5efd47e1457cfe754eee8b8dc155e013", "committedDate": "2020-07-30T17:49:36Z", "message": "Remove Windows specific verbiage in shared OSX/Windows code path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c85f8e4e01155a7052322ab0c9f3dca612af223", "author": {"user": {"login": "kfeinauer", "name": "Karl Feinauer"}}, "url": "https://github.com/rstudio/rstudio/commit/0c85f8e4e01155a7052322ab0c9f3dca612af223", "committedDate": "2020-07-31T21:57:02Z", "message": "Update NEWS"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6928f9d8251b34d215e9cec7741bd275ecfe907", "author": {"user": {"login": "kfeinauer", "name": "Karl Feinauer"}}, "url": "https://github.com/rstudio/rstudio/commit/b6928f9d8251b34d215e9cec7741bd275ecfe907", "committedDate": "2020-07-31T21:57:33Z", "message": "Merge branch 'master' into feature/apple-keychain-ssl-certs"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 36, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}