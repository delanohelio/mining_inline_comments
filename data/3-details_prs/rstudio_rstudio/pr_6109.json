{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MzQ2NjIw", "number": 6109, "title": "Blacklist for Typo.js unsupported dictionaries", "bodyText": "Reported in issue #6041 there are some dictionaries that Typo.js has severe issues loading. In fact, due to the size of these dictionaries in memory for most tested spellchecking libraries (6GB for Lithuanian in a tested Python package), some serious problem solving will have to go into this issue at some point.\nThe discussed stopgap to implement was to add a blacklist for the known incompatible dictionaries and not allow them to be loaded for real time spellchecking. Due to how preferences are saved and handled there was a fair amount of funny business making sure that [hopefully] all weird edge cases would be caught to prevent the user from getting into a bad state.\nOn the plus side I found and fixed a bug with turning real time spellchecking off and then on again.", "createdAt": "2020-01-29T02:59:09Z", "url": "https://github.com/rstudio/rstudio/pull/6109", "merged": true, "mergeCommit": {"oid": "efc1e665038c0d21d85d843d9ec26e3a47a28d29"}, "closed": true, "closedAt": "2020-01-29T21:52:12Z", "author": {"login": "adamconroy"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-83-wgH2gAyMzY4MzQ2NjIwOmI0N2RlZGUwZTk1NGUzZWQ2MTg1ZjE2NGI1YmM0ZTQwN2YxYjUzMTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_MRoygFqTM1MDQxNDcyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b47dede0e954e3ed6185f164b5bc4e407f1b5313", "author": {"user": {"login": "adamconroy", "name": null}}, "url": "https://github.com/rstudio/rstudio/commit/b47dede0e954e3ed6185f164b5bc4e407f1b5313", "committedDate": "2020-01-29T02:53:41Z", "message": "add blacklist for typo.js unsupported dictionaries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5ODM3ODIz", "url": "https://github.com/rstudio/rstudio/pull/6109#pullrequestreview-349837823", "createdAt": "2020-01-29T03:02:27Z", "commit": {"oid": "b47dede0e954e3ed6185f164b5bc4e407f1b5313"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMzowMjoyOFrOFi7V0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMzowMjoyOFrOFi7V0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2ODE0NA==", "bodyText": "If the app had started up with real time turned off, turning it on without restarting the app wouldn't then call loadDictionary() to ensure that Typo.js was loaded.", "url": "https://github.com/rstudio/rstudio/pull/6109#discussion_r372168144", "createdAt": "2020-01-29T03:02:28Z", "author": {"login": "adamconroy"}, "path": "src/gwt/src/org/rstudio/studio/client/common/spelling/TypoSpellChecker.java", "diffHunk": "@@ -183,11 +183,12 @@ public TypoSpellChecker(Context context)\n \n       // subscribe to spelling prefs changes (invalidateAll on changes)\n       ValueChangeHandler<Boolean> prefChangedHandler = (event) -> context_.invalidateAllWords();\n+      ValueChangeHandler<Boolean> realtimeChangedHandler = (event) -> loadDictionary();\n       ValueChangeHandler<String> dictChangedHandler = (event) -> loadDictionary();\n-      userPrefs_.realTimeSpellchecking().addValueChangeHandler(prefChangedHandler);\n       userPrefs_.ignoreUppercaseWords().addValueChangeHandler(prefChangedHandler);\n       userPrefs_.ignoreWordsWithNumbers().addValueChangeHandler(prefChangedHandler);\n       userPrefs_.spellingDictionaryLanguage().addValueChangeHandler(dictChangedHandler);\n+      userPrefs_.realTimeSpellchecking().addValueChangeHandler(realtimeChangedHandler);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b47dede0e954e3ed6185f164b5bc4e407f1b5313"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5ODM4NjQ4", "url": "https://github.com/rstudio/rstudio/pull/6109#pullrequestreview-349838648", "createdAt": "2020-01-29T03:05:29Z", "commit": {"oid": "b47dede0e954e3ed6185f164b5bc4e407f1b5313"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMzowNToyOVrOFi7Y5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwMzowNToyOVrOFi7Y5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE2ODkzNA==", "bodyText": "I spot checked a few other dictionaries and they seemed ok, these are the ones listed in the bug. Adding more to this list will be easy and the intention is to not have this problem for too long. If we decide to not spend more time working on this issue, which could be reasonable considering all the variables, I'd move this to a more permanent external home.\nBy removing canRealtimeSpellcheckDict we can easily be pointed to and clear out all of the subsequent cruft that uses it.", "url": "https://github.com/rstudio/rstudio/pull/6109#discussion_r372168934", "createdAt": "2020-01-29T03:05:29Z", "author": {"login": "adamconroy"}, "path": "src/gwt/src/org/rstudio/studio/client/common/spelling/TypoSpellChecker.java", "diffHunk": "@@ -398,6 +409,26 @@ public boolean shouldCheckSpelling(DocDisplay dd, Range r)\n       return true;\n    }\n \n+   /*\n+      Stop gap function to prevent loading dictionaries that Typo.js has\n+      severe issues with. This is being tracked to be fixed in issue #6041 as\n+      soon as possible so this can then be removed.\n+    */\n+   private static String[] realtimeDictBlacklist = {\"cs_CZ\", \"de_DE_neu\", \"lt_LT\", \"pt_BR\"};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b47dede0e954e3ed6185f164b5bc4e407f1b5313"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMjAxMjg3", "url": "https://github.com/rstudio/rstudio/pull/6109#pullrequestreview-350201287", "createdAt": "2020-01-29T15:35:02Z", "commit": {"oid": "b47dede0e954e3ed6185f164b5bc4e407f1b5313"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNTozNTowMlrOFjM6tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNTo0MjowMVrOFjNMqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQ1NjExOQ==", "bodyText": "Is the dictionary load idempotent? (seems like if it isn't we'd want to make sure it isn't loaded and avoid loading when the pref changes to false)", "url": "https://github.com/rstudio/rstudio/pull/6109#discussion_r372456119", "createdAt": "2020-01-29T15:35:02Z", "author": {"login": "jmcphers"}, "path": "src/gwt/src/org/rstudio/studio/client/common/spelling/TypoSpellChecker.java", "diffHunk": "@@ -183,11 +183,12 @@ public TypoSpellChecker(Context context)\n \n       // subscribe to spelling prefs changes (invalidateAll on changes)\n       ValueChangeHandler<Boolean> prefChangedHandler = (event) -> context_.invalidateAllWords();\n+      ValueChangeHandler<Boolean> realtimeChangedHandler = (event) -> loadDictionary();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b47dede0e954e3ed6185f164b5bc4e407f1b5313"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQ1ODg1NA==", "bodyText": "There are a number of RStudio themes in the wild which attempt to dark-theme the dialogs. This is not technically supported but this will break them. What do you think about using opacity instead?", "url": "https://github.com/rstudio/rstudio/pull/6109#discussion_r372458854", "createdAt": "2020-01-29T15:39:10Z", "author": {"login": "jmcphers"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/prefs/views/SpellingPreferencesPane.java", "diffHunk": "@@ -54,12 +57,28 @@ public SpellingPreferencesPane(GlobalDisplay globalDisplay,\n       spaced(customDictsWidget_);\n       nudgeRight(customDictsWidget_);\n       add(customDictsWidget_);\n-            \n+\n       add(checkboxPref(\"Ignore words in UPPERCASE\", prefs.ignoreUppercaseWords()));\n-      \n       add(checkboxPref(\"Ignore words with numbers\", prefs.ignoreWordsWithNumbers()));\n \n-      add(checkboxPref(\"Use real time spellchecking\", prefs.realTimeSpellchecking()));\n+      boolean canRealtime = TypoSpellChecker.canRealtimeSpellcheckDict(prefs.spellingDictionaryLanguage().getValue());\n+      realtimeSpellcheckingCheckbox_ = checkboxPref(\"Use real time spellchecking\", prefs.realTimeSpellchecking());\n+      realtimeSpellcheckingCheckbox_.getElement().getStyle().setColor(canRealtime ? \"black\" : \"darkgrey\");\n+      add(realtimeSpellcheckingCheckbox_);\n+\n+      blacklistWarning_ = new Label(\"Real time spellchecking currently unavailable for this dictionary\");\n+      blacklistWarning_.getElement().getStyle().setColor(\"red\");\n+      blacklistWarning_.setVisible(!canRealtime);\n+\n+      add(blacklistWarning_);\n+\n+      languageWidget_.addChangeHandler((event) -> {\n+         boolean canRealtimeCheck = TypoSpellChecker.canRealtimeSpellcheckDict(languageWidget_.getSelectedLanguage());\n+         blacklistWarning_.setVisible(!canRealtimeCheck);\n+         realtimeSpellcheckingCheckbox_.setValue(realtimeSpellcheckingCheckbox_.getValue() && canRealtimeCheck);\n+         realtimeSpellcheckingCheckbox_.setEnabled(canRealtimeCheck);\n+         realtimeSpellcheckingCheckbox_.getElement().getStyle().setColor(canRealtimeCheck ? \"black\" : \"darkgrey\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b47dede0e954e3ed6185f164b5bc4e407f1b5313"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQ2MDcxNA==", "bodyText": "I think we should avoid committing a pref change here as it's extremely implicit -- prefs should generally only change due to a user gesture that indicates intent since users can now diff their prefs. Would just bailing from the check do the job here?", "url": "https://github.com/rstudio/rstudio/pull/6109#discussion_r372460714", "createdAt": "2020-01-29T15:42:01Z", "author": {"login": "jmcphers"}, "path": "src/gwt/src/org/rstudio/studio/client/common/spelling/TypoSpellChecker.java", "diffHunk": "@@ -335,18 +336,28 @@ private void updateIgnoredWordsIndex()\n \n    private void loadDictionary()\n    {\n-      // don't load the same dictionary again\n       final String language = userPrefs_.spellingDictionaryLanguage().getValue();\n-      if (typoLoaded_ && loadedDict_ == language)\n+\n+      if (!userPrefs_.realTimeSpellchecking().getValue() || typoLoaded_ && loadedDict_.equals(language))\n          return;\n-      \n+\n+      // See canRealtimeSpellcheckDict comment, temporary stop gap\n+      // Disable real time spellchecking if this dictionary is incompatible\n+      // with Typo.js. Final invariant check to ensure that we never try to\n+      // load a blacklisted dictionary.\n+      if (!canRealtimeSpellcheckDict(language))\n+      {\n+         userPrefs_.realTimeSpellchecking().setGlobalValue(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b47dede0e954e3ed6185f164b5bc4e407f1b5313"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b01ae9e6cdb250f17a07f38aedeef4cc9cbc7613", "author": {"user": {"login": "adamconroy", "name": null}}, "url": "https://github.com/rstudio/rstudio/commit/b01ae9e6cdb250f17a07f38aedeef4cc9cbc7613", "committedDate": "2020-01-29T18:33:33Z", "message": "realtime spellchecking blacklist PR feedback tweaks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNDE0NzI0", "url": "https://github.com/rstudio/rstudio/pull/6109#pullrequestreview-350414724", "createdAt": "2020-01-29T20:50:17Z", "commit": {"oid": "b01ae9e6cdb250f17a07f38aedeef4cc9cbc7613"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 336, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}