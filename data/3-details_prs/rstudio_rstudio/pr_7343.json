{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4Njc1MzU4", "number": 7343, "title": "fix issue with file monitor taking long time to shut down", "bodyText": "When RStudio is initialized with a project, it registers a file monitor for that project. This entails scanning the files used within that project recursively, which can be slow for projects with many files (e.g. RStudio itself).\nWhen we try to stop the file monitor, we were previously forced to wait for an in-flight registration to complete (or for 3 seconds, after which we just detached the thread and continued trying to exit).\nThis PR instead allows us to eagerly clean up and delete the context when a stop is requested. In case any completion requests are made after the context has been removed, we just check to see if the operation was aborted before attempting to access the associated context.\nIt seems like a lot of care was put into making sure the completion handler is the one to clean up the completion context struct, but I don't think this is necessary -- ultimately, the completion routine is just run on the same thread at an appropriate time, e.g. in response to ::SleepEx(..., TRUE) as is done in the main thread's loop. We just need to check whether the completion routine was cancelled before attempting to run it.\nCloses #7117.", "createdAt": "2020-07-14T06:27:12Z", "url": "https://github.com/rstudio/rstudio/pull/7343", "merged": true, "mergeCommit": {"oid": "9f25a5b7389b1999e388ef4f86b1e01e234c44d2"}, "closed": true, "closedAt": "2020-07-15T21:21:19Z", "author": {"login": "kevinushey"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc06EUGgH2gAyNDQ4Njc1MzU4OjQ1YzczNzhkYzUwMzg2ZWJmYTljYmExZTM4NzFhMDYxM2FjNDIwYTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1NCk_gFqTQ0OTEwODc5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "45c7378dc50386ebfa9cba1e3871a0613ac420a6", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/45c7378dc50386ebfa9cba1e3871a0613ac420a6", "committedDate": "2020-07-14T18:09:21Z", "message": "fix issue with file monitor taking long time to shut down"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f361438793b93c263d13bc5cd52f0cce3aa89d3", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/1f361438793b93c263d13bc5cd52f0cce3aa89d3", "committedDate": "2020-07-14T18:09:31Z", "message": "avoid throwing exception (easier to reason about)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73b1e98c3095142aeadf03832fa21f538d9119e1", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/73b1e98c3095142aeadf03832fa21f538d9119e1", "committedDate": "2020-07-14T18:09:41Z", "message": "tweaks"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b5a80989785a9d41d8dc707758a5d2b5e17676bf", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/b5a80989785a9d41d8dc707758a5d2b5e17676bf", "committedDate": "2020-07-14T06:34:12Z", "message": "tweaks"}, "afterCommit": {"oid": "73b1e98c3095142aeadf03832fa21f538d9119e1", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/73b1e98c3095142aeadf03832fa21f538d9119e1", "committedDate": "2020-07-14T18:09:41Z", "message": "tweaks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MzU4NjA3", "url": "https://github.com/rstudio/rstudio/pull/7343#pullrequestreview-448358607", "createdAt": "2020-07-14T18:26:50Z", "commit": {"oid": "b5a80989785a9d41d8dc707758a5d2b5e17676bf"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxODoyODo0NlrOGxgEvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxODozNzo1MVrOGxgZTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU1ODkxMA==", "bodyText": "Why the change from LOG_ERROR to direct logging call? I generally support reducing pre-proc macro usage as a Good Thing, but is there any other reason here?", "url": "https://github.com/rstudio/rstudio/pull/7343#discussion_r454558910", "createdAt": "2020-07-14T18:28:46Z", "author": {"login": "gtritchie"}, "path": "src/cpp/core/system/file_monitor/Win32FileMonitor.cpp", "diffHunk": "@@ -91,7 +93,8 @@ void safeCloseHandle(HANDLE hObject, const ErrorLocation& location)\n    {\n       if (!::CloseHandle(hObject))\n       {\n-         LOG_ERROR(LAST_SYSTEM_ERROR());\n+         auto error = LAST_SYSTEM_ERROR();\n+         core::log::logError(error, location);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73b1e98c3095142aeadf03832fa21f538d9119e1"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDU2NDE3NQ==", "bodyText": "What are the expected consequences of this change for the non-Windows cases? Given this delay issue was Windows-specific, would it be safer to leave this part as-is and leave this change (potentially) for 1.4/master?\nThinking specifically of the QA test matrix; if code changes are definitively Windows-only, then (presumably) we can tell them to worry specifically only about Windows desktop with this change, but modifying this here seems to bring testing of Mac and Linux desktops into scope?", "url": "https://github.com/rstudio/rstudio/pull/7343#discussion_r454564175", "createdAt": "2020-07-14T18:37:51Z", "author": {"login": "gtritchie"}, "path": "src/cpp/core/system/PosixFileScanner.cpp", "diffHunk": "@@ -124,6 +124,10 @@ Error scanFiles(const tree<FileInfo>::iterator_base& fromNode,\n    // iterate over the names\n    for (const std::string& name : names)\n    {\n+      // check for interrupt\n+      if (boost::this_thread::interruption_requested())\n+         return core::systemError(boost::system::errc::interrupted, ERROR_LOCATION);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73b1e98c3095142aeadf03832fa21f538d9119e1"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NTM1MDI4", "url": "https://github.com/rstudio/rstudio/pull/7343#pullrequestreview-448535028", "createdAt": "2020-07-14T23:34:57Z", "commit": {"oid": "73b1e98c3095142aeadf03832fa21f538d9119e1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQyMzozNDo1N1rOGxo9ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQyMzozNDo1N1rOGxo9ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDcwNDQ5MA==", "bodyText": "Do accesses to this registry require mutexes? (noticed they're all bare; haven't looked too closely but I know file monitors run on a thread)", "url": "https://github.com/rstudio/rstudio/pull/7343#discussion_r454704490", "createdAt": "2020-07-14T23:34:57Z", "author": {"login": "jmcphers"}, "path": "src/cpp/core/system/file_monitor/Win32FileMonitor.cpp", "diffHunk": "@@ -41,13 +42,15 @@ namespace {\n // buffer size for notifications (cannot be > 64kb for network drives)\n const std::size_t kBuffSize = 32768;\n \n+// handle registry\n+std::set<Handle> s_handleRegistry;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73b1e98c3095142aeadf03832fa21f538d9119e1"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4dd202e0cc7421e0a15b8b07beca3ddb606cf5d7", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/4dd202e0cc7421e0a15b8b07beca3ddb606cf5d7", "committedDate": "2020-07-15T04:39:04Z", "message": "guard access to registry via mutex"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "025c94542cdd16d9f1c3ebb4efadb84b72bb0749", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/025c94542cdd16d9f1c3ebb4efadb84b72bb0749", "committedDate": "2020-07-15T04:42:04Z", "message": "guard usage on cleanup, just in case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MTA4Nzk1", "url": "https://github.com/rstudio/rstudio/pull/7343#pullrequestreview-449108795", "createdAt": "2020-07-15T16:15:39Z", "commit": {"oid": "025c94542cdd16d9f1c3ebb4efadb84b72bb0749"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 117, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}