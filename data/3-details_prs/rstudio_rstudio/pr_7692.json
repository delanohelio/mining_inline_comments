{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2NTU4Njcx", "number": 7692, "title": "use 'save::save.image()' if 'save.image()' is masked", "bodyText": "Intent\nPackages and user code might mask the save.image() function, which interferes with the Save action in the Environments pane.\nApproach\nDetect this state, and emit base::save.image() when masked, and save.image() otherwise.\nQA Notes\nTry running the following code:\nsave.image <- function(...) { stop(\"oh no\") }\n\nThen using the Save icon in the Environment pane to save the global environment. You should see an error; e.g.\n\nCloses #7073.\n\nThis PR also adds in the helper classes ErrorLoggingServerRequestCallback and QuietServerRequestCallback, capturing some of the more common ServerRequestCallback implementations. It also makes onResponseReceived() from ServerRequestCallback abstract, so that IDE autocompletion will automatically fill in the method name when creating new methods (since you almost always want to implement that anyhow; if you didn't you'd be using one of the other helper classes)", "createdAt": "2020-08-31T21:47:29Z", "url": "https://github.com/rstudio/rstudio/pull/7692", "merged": true, "mergeCommit": {"oid": "9bff3d53cd1c48af0edb7b1187e64c5e38353f65"}, "closed": true, "closedAt": "2020-09-02T16:19:12Z", "author": {"login": "kevinushey"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEZeYygH2gAyNDc2NTU4NjcxOjI1MGYxN2Y5Y2JjYTNlMGViZjYwYWJkZTgxMjg5MzQyMWYzNGEwNjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdE-dIeAH2gAyNDc2NTU4NjcxOmI3NmE3ZmNhODVhMDhjNzQ2NTZhN2M3MTJmMjViNTliMzhmNjJlODU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "250f17f9cbca3e0ebf60abde812893421f34a069", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/250f17f9cbca3e0ebf60abde812893421f34a069", "committedDate": "2020-08-31T21:13:45Z", "message": "add helper for detecting masked functions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6ceeb9d0e1c33378f4381f178a16fe93e084297", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/d6ceeb9d0e1c33378f4381f178a16fe93e084297", "committedDate": "2020-08-31T21:23:47Z", "message": "consolidate commonly-used request handlers into own classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dbef1ecc5e8efe0d3191bda82a8cc7fb0b69041", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/1dbef1ecc5e8efe0d3191bda82a8cc7fb0b69041", "committedDate": "2020-08-31T21:42:50Z", "message": "use 'base::save.image' if masked"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwMDgxMjgx", "url": "https://github.com/rstudio/rstudio/pull/7692#pullrequestreview-480081281", "createdAt": "2020-09-01T20:13:39Z", "commit": {"oid": "1dbef1ecc5e8efe0d3191bda82a8cc7fb0b69041"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMDoxMzozOVrOHLGkbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMDoxMzozOVrOHLGkbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwNDAxNQ==", "bodyText": "It seems like the behavior on error here is that we don't save the workspace at all, which seems wrong. Could we use the previous behavior (save.image) if we can't determine whether or not the function is masked?", "url": "https://github.com/rstudio/rstudio/pull/7692#discussion_r481404015", "createdAt": "2020-09-01T20:13:39Z", "author": {"login": "jmcphers"}, "path": "src/gwt/src/org/rstudio/studio/client/workbench/views/environment/EnvironmentPresenter.java", "diffHunk": "@@ -443,10 +439,24 @@ void onSaveWorkspace()\n    {\n       view_.bringToFront();\n \n-      consoleDispatcher_.saveFileAsThenExecuteCommand(\"Save Workspace As\",\n-                                                      \".RData\",\n-                                                      true,\n-                                                      \"save.image\");\n+      server_.isFunctionMasked(\n+            \"save.image\",\n+            \"base\",\n+            new ErrorLoggingServerRequestCallback<Boolean>()\n+            {\n+               public void onResponseReceived(Boolean isMasked)\n+               {\n+                  String code = isMasked\n+                        ? \"base::save.image\"\n+                        : \"save.image\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1dbef1ecc5e8efe0d3191bda82a8cc7fb0b69041"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2f7dc38a29ac8f015412c9afa3e412453ec2aa3", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/b2f7dc38a29ac8f015412c9afa3e412453ec2aa3", "committedDate": "2020-09-02T16:16:02Z", "message": "ensure we invoke 'save.image' even on RPC failure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b76a7fca85a08c74656a7c712f25b59b38f62e85", "author": {"user": {"login": "kevinushey", "name": "Kevin Ushey"}}, "url": "https://github.com/rstudio/rstudio/commit/b76a7fca85a08c74656a7c712f25b59b38f62e85", "committedDate": "2020-09-02T16:18:52Z", "message": "preserve comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 69, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}