{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyNjE5MjMy", "number": 8635, "title": "Always report startup configuration related errors to stderr, even if not connected to a terminal", "bodyText": "Intent\nWhen installing on CentOS, configuration related error messages do not display during the installation. This is because stderr (where we log this information) is not connected to a terminal, so it is only logged to syslog. However, if we force write these to stderr, they will properly show up.\nApproach\nFor these startup related errors, forcefully log them to both stderr and syslog even if stderr is not connected to a terminal. This ensures that the output can be seen by a user when starting the process via the installation.\nFor other code paths that report errors after startup (or daemonization), do not forcefully log to stderr - we want to make sure we aren't writing to a buffer that is never going to be read from (which could cause a hang).\n(Also includes some code that should have been merged back to OS but was forgotten - the ostream and operator changes in ProgramOptions).\nFixes rstudio/rstudio-pro#2214\nQA Notes\nSee rstudio/rstudio-pro#2214", "createdAt": "2020-12-18T15:34:50Z", "url": "https://github.com/rstudio/rstudio/pull/8635", "merged": true, "mergeCommit": {"oid": "a4ca0e3e3401f394d17cced58fd8dc1a6bd82d83"}, "closed": true, "closedAt": "2020-12-22T00:17:25Z", "author": {"login": "kfeinauer"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnZ3TjgH2gAyNTQyNjE5MjMyOjQ4MjQzZDk2ZjM5MTcxNmQ5MzFlYWFiMGU5NjhhMWRjYjlhMzUxMzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdofOFlgFqTU1Njc0MTcxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "48243d96f391716d931eaab0e968a1dcb9a35130", "author": {"user": {"login": "kfeinauer", "name": "Karl Feinauer"}}, "url": "https://github.com/rstudio/rstudio/commit/48243d96f391716d931eaab0e968a1dcb9a35130", "committedDate": "2020-12-18T15:28:19Z", "message": "Always report startup configuration related errors to stderr, even if\nnot connected to a terminal.\n\nThis is done because when installing on CentOS, we want to see these error\nmessages. However, due to how that process works, the terminal is not actually\nconnected to the installing rserver process. Any errors encountered will be logged\nto syslog, but they will not directly be shown to the user. Forcing these writes\nto stderr ensures they show up.\n\nFixes https://github.com/rstudio/rstudio-pro/issues/2214."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NTQzMjE5", "url": "https://github.com/rstudio/rstudio/pull/8635#pullrequestreview-556543219", "createdAt": "2020-12-21T17:25:23Z", "commit": {"oid": "48243d96f391716d931eaab0e968a1dcb9a35130"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxNzoyNToyM1rOIJgBTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxNzoyNToyM1rOIJgBTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjgzMjcxNg==", "bodyText": "Prior to this change, reportError would always log the error -- now many errors won't be logged if stderr is a terminal. Is that intentional?", "url": "https://github.com/rstudio/rstudio/pull/8635#discussion_r546832716", "createdAt": "2020-12-21T17:25:23Z", "author": {"login": "jmcphers"}, "path": "src/cpp/core/ProgramOptions.cpp", "diffHunk": "@@ -54,21 +54,42 @@ bool validateOptionsProvided(const variables_map& vm,\n \n }\n \n-void reportError(const Error& error, const ErrorLocation& location)\n+void reportError(const Error& error, const ErrorLocation& location, bool forceStderr)\n {\n    std::string description = error.getProperty(\"description\");\n    if (core::system::stderrIsTerminal() && !description.empty())\n+   {\n       std::cerr << description << std::endl;\n+   }\n+   else\n+   {\n+      // in some cases, we may need to force stderr to be written\n+      // for example, during installation on RedHat systems, stderr\n+      // is not properly hooked up to a terminal when checking configuration during post install scripts\n+      // which would cause error output to go only to syslog and be hidden from view during install\n+      if (forceStderr && !description.empty())\n+         std::cerr << description << std::endl;\n+\n+      core::log::logError(error, location);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48243d96f391716d931eaab0e968a1dcb9a35130"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f54f85170c024ebf0521a4ffd0e8e292e4e05d88", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/f54f85170c024ebf0521a4ffd0e8e292e4e05d88", "committedDate": "2020-12-22T00:10:47Z", "message": "always log to syslog, too"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37a5402708736b45c18a97ea0782da44db43aed6", "author": {"user": {"login": "jmcphers", "name": "Jonathan"}}, "url": "https://github.com/rstudio/rstudio/commit/37a5402708736b45c18a97ea0782da44db43aed6", "committedDate": "2020-12-22T00:12:33Z", "message": "update NEWS"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NzQxNzEw", "url": "https://github.com/rstudio/rstudio/pull/8635#pullrequestreview-556741710", "createdAt": "2020-12-22T00:16:39Z", "commit": {"oid": "37a5402708736b45c18a97ea0782da44db43aed6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4892, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}