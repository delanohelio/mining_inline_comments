{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExNzE5NDcx", "number": 8214, "title": "Do not attempt to continue logging session output dp fd writes if the read end of the pipe closes", "bodyText": "Intent\nWhenever the read end of the dup fd pipe closes, we continuously try to write to the pipe, but it will never succeed again. We should stop attempting to write in this case, and only log an error once.\nIt is currently unknown how this situation can occur, but it is happening for a user of Slurm sessions: see Zendesk ticket 53571.\nApproach\nIf a pipe error (or FD is closed), stop trying to write to it. Only log the error once and explain that output will no longer be redirected.\nFixes #8082\nQA Notes\nWe are unable to reproduce this as of yet. We should ask the customer in the Zendesk ticket to verify the fix.", "createdAt": "2020-10-28T17:31:13Z", "url": "https://github.com/rstudio/rstudio/pull/8214", "merged": true, "mergeCommit": {"oid": "189c1a488c04960624b6cc159b9873bb3ceb939d"}, "closed": true, "closedAt": "2020-10-29T19:02:52Z", "author": {"login": "kfeinauer"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXA_WGgH2gAyNTExNzE5NDcxOjJjNGU5MGE4MTZkY2JhOTU2NGNjNDczM2QwYjk1YjIyN2VhYmVlZGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXW8yWAH2gAyNTExNzE5NDcxOmU1NDIxYTc1OWVlOGVkZTU0M2I1ZjdlM2E0MGY0NmFmMGZhNzM1MzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2c4e90a816dcba9564cc4733d0b95b227eabeedc", "author": {"user": {"login": "kfeinauer", "name": "Karl Feinauer"}}, "url": "https://github.com/rstudio/rstudio/commit/2c4e90a816dcba9564cc4733d0b95b227eabeedc", "committedDate": "2020-10-28T17:26:41Z", "message": "Do not attempt to continue logging session output dp fd writes if the read end of the pipe closes.\n\nFixes #8082"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5OTQ2MDcw", "url": "https://github.com/rstudio/rstudio/pull/8214#pullrequestreview-519946070", "createdAt": "2020-10-29T18:11:54Z", "commit": {"oid": "2c4e90a816dcba9564cc4733d0b95b227eabeedc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODoxMTo1NFrOHqomjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxODoxMTo1NFrOHqomjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ2NzQ3MQ==", "bodyText": "Nit: this can be set in the systemError constructor more succinctly", "url": "https://github.com/rstudio/rstudio/pull/8214#discussion_r514467471", "createdAt": "2020-10-29T18:11:54Z", "author": {"login": "jmcphers"}, "path": "src/cpp/core/system/PosixOutputCapture.cpp", "diffHunk": "@@ -71,21 +72,48 @@ void standardStreamCaptureThread(\n    auto wrapHandler =\n     [=](const boost::function<void(const std::string&)>& handler,\n         int dupFd,\n+        const std::string& descriptorType,\n+        boost::shared_ptr<bool> pSkipWrite,\n         const std::string& output)\n     {\n        handler(output);\n-       if (::write(dupFd, output.c_str(), output.size()) == -1)\n+\n+       if (!*pSkipWrite)\n        {\n-          if (errno != EAGAIN && errno != EINTR)\n-             LOG_ERROR(systemError(errno, ERROR_LOCATION));\n+          if (::write(dupFd, output.c_str(), output.size()) == -1)\n+          {\n+             if (errno == EPIPE || errno == EBADF)\n+             {\n+                // the std stream was closed somehow, meaning this write call will never succeed again\n+                // mark that we should skip the write, and only log this error once\n+                *pSkipWrite = true;\n+\n+                Error error = systemError(errno, ERROR_LOCATION);\n+                std::string cause = errno == EBADF ? \" closed\" : \"'s pipe read end closed\";\n+                std::string description =\n+                      descriptorType + \" descriptor \" + core::safe_convert::numberToString(dupFd) +\n+                      cause + \". Output will no longer be redirected.\";\n+                error.addProperty(\"description\", description);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c4e90a816dcba9564cc4733d0b95b227eabeedc"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5OTQ3ODYw", "url": "https://github.com/rstudio/rstudio/pull/8214#pullrequestreview-519947860", "createdAt": "2020-10-29T18:14:04Z", "commit": {"oid": "2c4e90a816dcba9564cc4733d0b95b227eabeedc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5421a759ee8ede543b5f7e3a40f46af0fa73531", "author": {"user": {"login": "kfeinauer", "name": "Karl Feinauer"}}, "url": "https://github.com/rstudio/rstudio/commit/e5421a759ee8ede543b5f7e3a40f46af0fa73531", "committedDate": "2020-10-29T19:01:48Z", "message": "Code review feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4951, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}