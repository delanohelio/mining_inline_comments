{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxNjY3ODY4", "number": 409, "title": "KOGITO-3156 fix integration tests broken for Quarkus", "bodyText": "https://issues.redhat.com/browse/KOGITO-3156\nThe Quarkus integration test was broken because of the lifecycle order the test resources are stated, the KogitoServiceRandomPortQuarkusTestResource should be started before the JobServiceQuarkusTestResource because the         Testcontainers.exposeHostPorts(httpPort); is called there and it is necessary to be called before starting the jobs-service container.\nMany thanks for submitting your Pull Request \u2764\ufe0f!\nPlease make sure that your PR meets the following requirements:\n\n You have read the contributors guide\n Pull Request title is properly formatted: KOGITO-XYZ Subject\n Pull Request title contains the target branch if not targeting master: [0.9.x] KOGITO-XYZ Subject\n Pull Request contains link to the JIRA issue\n Pull Request contains link to any dependent or related Pull Request\n Pull Request contains description of the issue\n Pull Request does not include fixes for issues other than the main ticket", "createdAt": "2020-08-21T14:28:44Z", "url": "https://github.com/kiegroup/kogito-apps/pull/409", "merged": true, "mergeCommit": {"oid": "35edab9e78921f8e55ca6ed385f575a87c9472f0"}, "closed": true, "closedAt": "2020-08-26T12:23:13Z", "author": {"login": "tiagodolphine"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBFw-rgFqTQ3MjU0Mjc3OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCbTRLABqjM2OTEzNTI4ODQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNTQyNzc5", "url": "https://github.com/kiegroup/kogito-apps/pull/409#pullrequestreview-472542779", "createdAt": "2020-08-21T14:34:11Z", "commit": {"oid": "3b4a165411d266fe838f27d6f87d18d5fd5ea524"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMTQ0Mzgw", "url": "https://github.com/kiegroup/kogito-apps/pull/409#pullrequestreview-473144380", "createdAt": "2020-08-24T06:13:51Z", "commit": {"oid": "3b4a165411d266fe838f27d6f87d18d5fd5ea524"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwNjoxMzo1MVrOHFV4xQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwNjoxNToyN1rOHFV7Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2MzUyNQ==", "bodyText": "Is this part of the fix? It seems unrelated.", "url": "https://github.com/kiegroup/kogito-apps/pull/409#discussion_r475363525", "createdAt": "2020-08-24T06:13:51Z", "author": {"login": "Sgitario"}, "path": "integration-tests/integration-tests-common/src/main/java/org/kie/kogito/testcontainers/JobServiceContainer.java", "diffHunk": "@@ -36,11 +36,13 @@\n     public static final String IMAGE = \"container.image.\" + NAME;\n     private static final Logger LOGGER = LoggerFactory.getLogger(JobServiceContainer.class);\n \n-    public JobServiceContainer() {\n+    @Override\n+    public void start() {\n         addExposedPort(PORT);\n         withLogConsumer(new Slf4jLogConsumer(LOGGER));\n         waitingFor(Wait.forLogMessage(\".*Listening on:.*\", 1));\n         setDockerImageName(getImageName());\n+        super.start();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b4a165411d266fe838f27d6f87d18d5fd5ea524"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2NDE0Mw==", "bodyText": "What about we want to integrate jobs service with data index or infinispan? I think we should think a value here where we can still configure all the containers accordingly.\nAlso, we can do this once we need it.", "url": "https://github.com/kiegroup/kogito-apps/pull/409#discussion_r475364143", "createdAt": "2020-08-24T06:15:27Z", "author": {"login": "Sgitario"}, "path": "integration-tests/integration-tests-quarkus/src/test/java/org/kie/kogito/resources/KogitoServiceRandomPortQuarkusTestResource.java", "diffHunk": "@@ -25,6 +25,13 @@ public KogitoServiceRandomPortQuarkusTestResource() {\n         super(new KogitoServiceRandomPortTestResource());\n     }\n \n+    @Override\n+    public int order() {\n+        //Guarantee it will be executed before other test resources that depends on this to set the\n+        //Testcontainers.exposeHostPorts(httpPort), see KogitoServiceRandomPortTestResource.start()\n+        return Integer.MIN_VALUE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b4a165411d266fe838f27d6f87d18d5fd5ea524"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NDE1ODIz", "url": "https://github.com/kiegroup/kogito-apps/pull/409#pullrequestreview-474415823", "createdAt": "2020-08-25T12:10:14Z", "commit": {"oid": "ba3c4360e1c0b0d86ceb8f3f4c88b1fa436f6303"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMjoxMDoxNFrOHGVEMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMjoxMDoxNFrOHGVEMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM5ODY0MQ==", "bodyText": "If we want to prevent super.start() execution, what about a comment here to mention the reason?", "url": "https://github.com/kiegroup/kogito-apps/pull/409#discussion_r476398641", "createdAt": "2020-08-25T12:10:14Z", "author": {"login": "danielezonca"}, "path": "integration-tests/integration-tests-common/src/main/java/org/kie/kogito/it/KogitoServiceRandomPortTestResource.java", "diffHunk": "@@ -32,17 +32,25 @@ public String getResourceName() {\n         return NAME;\n     }\n \n-    @Override\n-    public void start() {\n+    public KogitoServiceRandomPortTestResource() {\n+        initialize();\n+    }\n+\n+    //The port should be set and Testcontainers.exposeHostPorts should be called before the this.start() method, in\n+    // this way the container is able to resolve hostname for the host (running the test) otherwise it won't work.\n+    private void initialize() {\n         httpPort = SocketUtils.findAvailablePort();\n-        //Container should have access the host port where the test is running\n-        //It should be called be fore the container is instantiated\n         Testcontainers.exposeHostPorts(httpPort);\n         //the hostname for the container to access the host is \"host.testcontainers.internal\"\n         //https://www.testcontainers.org/features/networking/#exposing-host-ports-to-the-container\n         System.setProperty(KOGITO_SERVICE_URL, \"http://host.testcontainers.internal:\" + httpPort);\n     }\n \n+    @Override\n+    public void start() {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba3c4360e1c0b0d86ceb8f3f4c88b1fa436f6303"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63b74dda197f3c72d086c8a9a0e8e0d6f6252d62", "author": {"user": {"login": "tiagodolphine", "name": "Tiago Dolphine"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/63b74dda197f3c72d086c8a9a0e8e0d6f6252d62", "committedDate": "2020-08-25T13:56:11Z", "message": "KOGITO-3156 fix integration tests broken for Quarkus"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8910608c91b41a7257a2f13eb0dcbd41454eec2", "author": {"user": {"login": "tiagodolphine", "name": "Tiago Dolphine"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/f8910608c91b41a7257a2f13eb0dcbd41454eec2", "committedDate": "2020-08-25T13:56:12Z", "message": "Fix the  Testcontainers.exposeHostPorts(httpPort) call, to be in the constructor instead start() in this way the Container is resolving properly the hostname"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "869edde1fd848c35f27b591e4037e863932339a8", "author": {"user": {"login": "tiagodolphine", "name": "Tiago Dolphine"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/869edde1fd848c35f27b591e4037e863932339a8", "committedDate": "2020-08-25T18:12:49Z", "message": "Copy process resources into src/main/resources on quarkus integration-tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ba3c4360e1c0b0d86ceb8f3f4c88b1fa436f6303", "author": {"user": {"login": "tiagodolphine", "name": "Tiago Dolphine"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/ba3c4360e1c0b0d86ceb8f3f4c88b1fa436f6303", "committedDate": "2020-08-25T11:52:01Z", "message": "Fix the  Testcontainers.exposeHostPorts(httpPort) call, to be in the constructor instead start() in this way the Container is resolving properly the hostname"}, "afterCommit": {"oid": "869edde1fd848c35f27b591e4037e863932339a8", "author": {"user": {"login": "tiagodolphine", "name": "Tiago Dolphine"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/869edde1fd848c35f27b591e4037e863932339a8", "committedDate": "2020-08-25T18:12:49Z", "message": "Copy process resources into src/main/resources on quarkus integration-tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4710, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}