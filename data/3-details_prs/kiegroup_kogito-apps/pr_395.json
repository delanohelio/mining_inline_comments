{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4ODIyNTEx", "number": 395, "title": "KOGITO-3102 - refactored type handling in explainability-core", "bodyText": "Type handling in explainability-core has been improved and simplified by moving all relevant Type dependent functions  inside Type itself.\nEvery new Type will have to implement drop, perturb and encode functions.\nSee https://issues.redhat.com/browse/KOGITO-3102\nMany thanks for submitting your Pull Request \u2764\ufe0f!\nPlease make sure that your PR meets the following requirements:\n\n You have read the contributors guide\n Pull Request title is properly formatted: KOGITO-XYZ Subject\n Pull Request title contains the target branch if not targeting master: [0.9.x] KOGITO-XYZ Subject\n Pull Request contains link to the JIRA issue\n Pull Request contains link to any dependent or related Pull Request\n Pull Request contains description of the issue\n Pull Request does not include fixes for issues other than the main ticket", "createdAt": "2020-08-17T13:10:59Z", "url": "https://github.com/kiegroup/kogito-apps/pull/395", "merged": true, "mergeCommit": {"oid": "726941c0cbdbf6a283b723d0baffdd702a84562a"}, "closed": true, "closedAt": "2020-08-19T12:30:32Z", "author": {"login": "tteofili"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_yI4gAH2gAyNDY4ODIyNTExOjMwNGQ1YzQyOWQzNDBiZDhmNDc4YzJiY2U1ZDE1ZGUyYzA2MGQ0ZTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAay40gFqTQ3MDQwNzQ0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "304d5c429d340bd8f478c2bce5d15de2c060d4e8", "author": {"user": {"login": "tteofili", "name": "Tommaso Teofili"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/304d5c429d340bd8f478c2bce5d15de2c060d4e8", "committedDate": "2020-08-17T13:08:16Z", "message": "KOGITO-3102 - refactored type handling in explainability-core"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1609987306c2e93380849ae63fdbb936bcca630b", "author": {"user": {"login": "tteofili", "name": "Tommaso Teofili"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/1609987306c2e93380849ae63fdbb936bcca630b", "committedDate": "2020-08-17T14:45:53Z", "message": "KOGITO-3102 - minor fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "109c868bc42b2fc92598f6b751bf3830bec63d95", "author": {"user": {"login": "tteofili", "name": "Tommaso Teofili"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/109c868bc42b2fc92598f6b751bf3830bec63d95", "committedDate": "2020-08-17T15:35:00Z", "message": "KOGITO-3102 - restored wrongly suppressed numeric encoding, Sonar suggested fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "645df85fa389f297713db894e38e90aa9b2fb041", "author": {"user": {"login": "tteofili", "name": "Tommaso Teofili"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/645df85fa389f297713db894e38e90aa9b2fb041", "committedDate": "2020-08-17T15:42:21Z", "message": "KOGITO-3102 - Sonar suggested fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94876bf761ba6007d9e199ace9605fd6d47207df", "author": {"user": {"login": "tteofili", "name": "Tommaso Teofili"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/94876bf761ba6007d9e199ace9605fd6d47207df", "committedDate": "2020-08-18T07:23:00Z", "message": "Merge branch 'master' of github.com:kiegroup/kogito-apps into KOGITO-3102"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ceb79a8e905f8da8ba9029f27d118304164af192", "author": {"user": {"login": "tteofili", "name": "Tommaso Teofili"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/ceb79a8e905f8da8ba9029f27d118304164af192", "committedDate": "2020-08-18T08:24:48Z", "message": "KOGITO-3102 - better test coverage, minor fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NjQzNTAx", "url": "https://github.com/kiegroup/kogito-apps/pull/395#pullrequestreview-468643501", "createdAt": "2020-08-17T16:55:22Z", "commit": {"oid": "645df85fa389f297713db894e38e90aa9b2fb041"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNjo1NToyMlrOHBw5Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxMjoyMTo0M1rOHCQ3ZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYxMTcwNg==", "bodyText": "Please split this line, it is hard to read :)", "url": "https://github.com/kiegroup/kogito-apps/pull/395#discussion_r471611706", "createdAt": "2020-08-17T16:55:22Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/local/lime/DatasetEncoder.java", "diffHunk": "@@ -93,99 +97,15 @@\n         return trainingSet;\n     }\n \n-    private List<List<Double>> getColumnData(List<PredictionInput> perturbedInputs) {\n-        List<List<Double>> columnData = new LinkedList<>();\n+    private List<List<double[]>> getColumnData(List<PredictionInput> perturbedInputs) {\n+        List<List<double[]>> columnData = new LinkedList<>();\n \n         for (int t = 0; t < targetInput.getFeatures().size(); t++) {\n             Feature originalFeature = targetInput.getFeatures().get(t);\n-            switch (originalFeature.getType()) {\n-                case NUMBER:\n-                    encodeNumbers(perturbedInputs, targetInput, columnData, t);\n-                    break;\n-                case TEXT:\n-                    encodeText(perturbedInputs, columnData, originalFeature);\n-                    break;\n-                case CATEGORICAL:\n-                case BINARY:\n-                case TIME:\n-                case URI:\n-                case DURATION:\n-                case VECTOR:\n-                case CURRENCY:\n-                case UNDEFINED:\n-                    encodeEquals(perturbedInputs, columnData, t, originalFeature);\n-                    break;\n-                case BOOLEAN:\n-                    // boolean are automatically encoded as 1s or 0s\n-                    List<Double> featureValues = new LinkedList<>();\n-                    for (PredictionInput pi : perturbedInputs) {\n-                        featureValues.add(pi.getFeatures().get(t).getValue().asNumber());\n-                    }\n-                    columnData.add(featureValues);\n-                    break;\n-                default:\n-                    throw new LocalExplanationException(\"could not encoded features of type \" + originalFeature.getType());\n-            }\n+            int finalT = t;\n+            List<double[]> encode = originalFeature.getType().encode(originalFeature.getValue(), perturbedInputs.stream().map(predictionInput -> predictionInput.getFeatures().get(finalT).getValue()).toArray(Value<?>[]::new));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "645df85fa389f297713db894e38e90aa9b2fb041"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYxMzU1MQ==", "bodyText": "Can you please add an explicit if( instanceof) to improve readability?", "url": "https://github.com/kiegroup/kogito-apps/pull/395#discussion_r471613551", "createdAt": "2020-08-17T16:58:31Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/Value.java", "diffHunk": "@@ -34,6 +36,11 @@ public Value(S underlyingObject) {\n     }\n \n     public String asString() {\n+        try {\n+            List<Feature> composite = (List<Feature>) underlyingObject;\n+            return composite.stream().map(f -> f.getValue().asString()).collect(Collectors.joining(\" \"));\n+        } catch (ClassCastException ignored) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "645df85fa389f297713db894e38e90aa9b2fb041"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYyMTc0OQ==", "bodyText": "javadoc?", "url": "https://github.com/kiegroup/kogito-apps/pull/395#discussion_r471621749", "createdAt": "2020-08-17T17:07:52Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/Type.java", "diffHunk": "@@ -55,4 +374,9 @@ public String toString() {\n         return String.valueOf(value);\n     }\n \n+    public abstract Value<?> drop(Value<?> value);\n+\n+    public abstract Value<?> perturb(Value<?> value, PerturbationContext perturbationContext);\n+\n+    public abstract List<double[]> encode(Value<?> target, Value<?>... values);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "645df85fa389f297713db894e38e90aa9b2fb041"}, "originalPosition": 374}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjEzNTUyNA==", "bodyText": "Can you please clarify this change?\nThe logic seems to be quite different so I do not understand if it was broken before or what :)", "url": "https://github.com/kiegroup/kogito-apps/pull/395#discussion_r472135524", "createdAt": "2020-08-18T12:21:43Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/utils/ExplainabilityMetrics.java", "diffHunk": "@@ -70,14 +72,42 @@ public static double quantifyExplainability(int inputCognitiveChunks, int output\n      * @return the saliency impact\n      */\n     public static double impactScore(PredictionProvider model, Prediction prediction, List<FeatureImportance> topFeatures) {\n-        List<String> importantFeatureNames = topFeatures.stream().map(f -> f.getFeature().getName()).collect(Collectors.toList());\n \n-        List<Feature> newFeatures = new LinkedList<>();\n-        for (Feature feature : prediction.getInput().getFeatures()) {\n-            Feature newFeature = DataUtils.dropFeature(feature, importantFeatureNames);\n-            newFeatures.add(newFeature);\n+        List<Feature> copy = List.copyOf(prediction.getInput().getFeatures());\n+\n+        for (FeatureImportance featureImportance : topFeatures) {\n+            Feature topFeature = featureImportance.getFeature();\n+            String name = topFeature.getName();\n+            Value<?> value = topFeature.getValue();\n+            Feature droppedFeature = null;\n+            for (Feature feature : copy) {\n+                if (name.equals(feature.getName())) {\n+                    if (value.equals(feature.getValue())) {\n+                        droppedFeature = FeatureFactory.copyOf(feature, feature.getType().drop(value));\n+                    } else {\n+                        List<Feature> linearizedFeatures = DataUtils.getLinearizedFeatures(List.of(feature));\n+                        int i = 0;\n+                        for (Feature linearizedFeature : linearizedFeatures) {\n+                            if (value.equals(linearizedFeature.getValue())) {\n+                                Feature e = linearizedFeatures.get(i);\n+                                linearizedFeatures.set(i, FeatureFactory.copyOf(e, e.getType().drop(value)));\n+                                droppedFeature = FeatureFactory.newCompositeFeature(name, linearizedFeatures);\n+                                break;\n+                            } else {\n+                                i++;\n+                            }\n+                        }\n+                    }\n+                    break;\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ceb79a8e905f8da8ba9029f27d118304164af192"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ac6412b845c9939eea50961ea8041e2f02d6dd3", "author": {"user": {"login": "tteofili", "name": "Tommaso Teofili"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/5ac6412b845c9939eea50961ea8041e2f02d6dd3", "committedDate": "2020-08-18T15:07:46Z", "message": "KOGITO-3102 - resolved review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NTU3NTA2", "url": "https://github.com/kiegroup/kogito-apps/pull/395#pullrequestreview-469557506", "createdAt": "2020-08-18T15:14:43Z", "commit": {"oid": "5ac6412b845c9939eea50961ea8041e2f02d6dd3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNToxNDo0M1rOHCZXIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNToxNDo0M1rOHCZXIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI3NDcyMw==", "bodyText": "Why this? The whole repo is already configured to use jdk 11 ( see here )", "url": "https://github.com/kiegroup/kogito-apps/pull/395#discussion_r472274723", "createdAt": "2020-08-18T15:14:43Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-core/pom.xml", "diffHunk": "@@ -10,6 +10,18 @@\n \n   <artifactId>explainability-core</artifactId>\n   <name>Kogito :: Explainability Core</name>\n+  <build>\n+    <plugins>\n+      <plugin>\n+        <groupId>org.apache.maven.plugins</groupId>\n+        <artifactId>maven-compiler-plugin</artifactId>\n+        <configuration>\n+          <source>10</source>\n+          <target>10</target>\n+        </configuration>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ac6412b845c9939eea50961ea8041e2f02d6dd3"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b0c036c5a90263b5d0d5f12f8732484b249df92", "author": {"user": {"login": "tteofili", "name": "Tommaso Teofili"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/4b0c036c5a90263b5d0d5f12f8732484b249df92", "committedDate": "2020-08-18T15:19:51Z", "message": "KOGITO-3102 - resolved review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10ddd9347b9da380acf0b625c27df0b57ea817f3", "author": {"user": {"login": "danielezonca", "name": "Daniele Zonca"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/10ddd9347b9da380acf0b625c27df0b57ea817f3", "committedDate": "2020-08-18T20:30:36Z", "message": "Update pom.xml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0e60c00d5bd3a892622e7357160c92f9f3b1b15", "author": {"user": {"login": "danielezonca", "name": "Daniele Zonca"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/d0e60c00d5bd3a892622e7357160c92f9f3b1b15", "committedDate": "2020-08-19T07:09:20Z", "message": "Update DataUtils.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9eb45d2a907649eb4d36d64f7959520b40e0c18", "author": {"user": {"login": "danielezonca", "name": "Daniele Zonca"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/b9eb45d2a907649eb4d36d64f7959520b40e0c18", "committedDate": "2020-08-19T07:10:15Z", "message": "Update ExplainabilityMetrics.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNDA3NDQw", "url": "https://github.com/kiegroup/kogito-apps/pull/395#pullrequestreview-470407440", "createdAt": "2020-08-19T12:30:21Z", "commit": {"oid": "b9eb45d2a907649eb4d36d64f7959520b40e0c18"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4695, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}