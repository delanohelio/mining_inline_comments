{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3NjYwMTg4", "number": 433, "title": "KOGITO-3194 - add list feature type to support collections in expl-service", "bodyText": "In order to allow TypedValues of type collection in explainability-service, Type.LIST is introduced in explainability-core.\nsee https://issues.redhat.com/browse/KOGITO-3194\nMany thanks for submitting your Pull Request \u2764\ufe0f!\nPlease make sure that your PR meets the following requirements:\n\n You have read the contributors guide\n Pull Request title is properly formatted: KOGITO-XYZ Subject\n Pull Request title contains the target branch if not targeting master: [0.9.x] KOGITO-XYZ Subject\n Pull Request contains link to the JIRA issue\n Pull Request contains link to any dependent or related Pull Request\n Pull Request contains description of the issue\n Pull Request does not include fixes for issues other than the main ticket", "createdAt": "2020-09-02T08:30:28Z", "url": "https://github.com/kiegroup/kogito-apps/pull/433", "merged": true, "mergeCommit": {"oid": "abae7aee39aca02e0001daee31c62dbc94699620"}, "closed": true, "closedAt": "2020-09-09T15:38:04Z", "author": {"login": "tteofili"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdE3uCoAH2gAyNDc3NjYwMTg4OjIwNDJhNmJjNTE4ZTdjOTZjYWI5ZjRjMTc0YjFlODIxOGU4ZGE2MDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGzSJxAH2gAyNDc3NjYwMTg4Ojg3OWM5NDQwOWRhZjIxODg4ODY0ZGE0YjQ4MWUwOTcxMDc2MTJmNzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2042a6bc518e7c96cab9f4c174b1e8218e8da600", "author": {"user": {"login": "tteofili", "name": "Tommaso Teofili"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/2042a6bc518e7c96cab9f4c174b1e8218e8da600", "committedDate": "2020-09-02T08:28:00Z", "message": "KOGITO-3194 - add list feature type to support collections in expl-service"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNjk4NjEy", "url": "https://github.com/kiegroup/kogito-apps/pull/433#pullrequestreview-480698612", "createdAt": "2020-09-02T10:45:37Z", "commit": {"oid": "2042a6bc518e7c96cab9f4c174b1e8218e8da600"}, "state": "COMMENTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxMDo0NTozN1rOHLpbwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxMToyMjowOVrOHLqkww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk3NTIzMw==", "bodyText": "Why this double wrapping? new ArrayList<>(list) should be enough", "url": "https://github.com/kiegroup/kogito-apps/pull/433#discussion_r481975233", "createdAt": "2020-09-02T10:45:37Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/Type.java", "diffHunk": "@@ -363,6 +364,35 @@\n             return new Value<>(Currency.getInstance(Locale.getDefault()));\n         }\n \n+        @Override\n+        public List<double[]> encode(Value<?> target, Value<?>... values) {\n+            return encodeEquals(target, values);\n+        }\n+    },\n+\n+    LIST(\"list\") {\n+        @Override\n+        public Value<?> drop(Value<?> value) {\n+            return new Value<>(Collections.emptyList());\n+        }\n+\n+        @Override\n+        public Value<?> perturb(Value<?> value, PerturbationContext perturbationContext) {\n+            List<?> copy;\n+            if (value.getUnderlyingObject() instanceof List) {\n+                List<?> list = (List<?>) value.getUnderlyingObject();\n+                copy = new ArrayList<>(List.copyOf(list));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2042a6bc518e7c96cab9f4c174b1e8218e8da600"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk3NjY5MA==", "bodyText": "I think it makes more sense to raise an exception if user tries to perturb a list but the value is not a list. Wdyt?", "url": "https://github.com/kiegroup/kogito-apps/pull/433#discussion_r481976690", "createdAt": "2020-09-02T10:48:10Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/Type.java", "diffHunk": "@@ -363,6 +364,35 @@\n             return new Value<>(Currency.getInstance(Locale.getDefault()));\n         }\n \n+        @Override\n+        public List<double[]> encode(Value<?> target, Value<?>... values) {\n+            return encodeEquals(target, values);\n+        }\n+    },\n+\n+    LIST(\"list\") {\n+        @Override\n+        public Value<?> drop(Value<?> value) {\n+            return new Value<>(Collections.emptyList());\n+        }\n+\n+        @Override\n+        public Value<?> perturb(Value<?> value, PerturbationContext perturbationContext) {\n+            List<?> copy;\n+            if (value.getUnderlyingObject() instanceof List) {\n+                List<?> list = (List<?>) value.getUnderlyingObject();\n+                copy = new ArrayList<>(List.copyOf(list));\n+                int[] indexesToBePerturbed = perturbationContext.getRandom().ints(0, copy.size()).distinct()\n+                        .limit(perturbationContext.getNoOfPerturbations()).toArray();\n+                for (int index : indexesToBePerturbed) {\n+                    copy.remove(index);\n+                }\n+            } else {\n+                copy = Collections.emptyList();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2042a6bc518e7c96cab9f4c174b1e8218e8da600"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk3NzY1MA==", "bodyText": "Now that we handle all the types I think it could make sense to throw an exception here (actually this should never happen). Wdyt?", "url": "https://github.com/kiegroup/kogito-apps/pull/433#discussion_r481977650", "createdAt": "2020-09-02T10:49:55Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-service/src/main/java/org/kie/kogito/explainability/ConversionUtils.java", "diffHunk": "@@ -41,26 +47,51 @@ private ConversionUtils() {\n \n     protected static Feature toFeature(String name, Object value) {\n         if (value instanceof JsonObject) {\n-            return new Feature(name, Type.COMPOSITE, new Value<>(toFeatureList((JsonObject) value)));\n+            return FeatureFactory.newCompositeFeature(name, toFeatureList((JsonObject) value));\n         }\n         return toTypeValuePair(value)\n                 .map(p -> new Feature(name, p.getLeft(), p.getRight()))\n                 .orElse(null);\n     }\n \n     public static Feature toFeature(String name, TypedValue value) {\n-        // TODO: handle COLLECTION values https://issues.redhat.com/browse/KOGITO-3194\n         if (value.isUnit()) {\n             return toTypeValuePair(value.toUnit().getValue())\n                     .map(p -> new Feature(name, p.getLeft(), p.getRight()))\n                     .orElse(null);\n         }\n         if (value.isStructure()) {\n-            return new Feature(name, Type.COMPOSITE, new Value<>(toFeatureList(value.toStructure().getValue())));\n+            return FeatureFactory.newCompositeFeature(name, toFeatureList(value.toStructure().getValue()));\n+        }\n+        if (value.isCollection()) {\n+            return FeatureFactory.newListFeature(name, toList(value.toCollection()));\n         }\n         return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2042a6bc518e7c96cab9f4c174b1e8218e8da600"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk3ODkxNQ==", "bodyText": "protected", "url": "https://github.com/kiegroup/kogito-apps/pull/433#discussion_r481978915", "createdAt": "2020-09-02T10:52:14Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-service/src/main/java/org/kie/kogito/explainability/ConversionUtils.java", "diffHunk": "@@ -41,26 +47,51 @@ private ConversionUtils() {\n \n     protected static Feature toFeature(String name, Object value) {\n         if (value instanceof JsonObject) {\n-            return new Feature(name, Type.COMPOSITE, new Value<>(toFeatureList((JsonObject) value)));\n+            return FeatureFactory.newCompositeFeature(name, toFeatureList((JsonObject) value));\n         }\n         return toTypeValuePair(value)\n                 .map(p -> new Feature(name, p.getLeft(), p.getRight()))\n                 .orElse(null);\n     }\n \n     public static Feature toFeature(String name, TypedValue value) {\n-        // TODO: handle COLLECTION values https://issues.redhat.com/browse/KOGITO-3194\n         if (value.isUnit()) {\n             return toTypeValuePair(value.toUnit().getValue())\n                     .map(p -> new Feature(name, p.getLeft(), p.getRight()))\n                     .orElse(null);\n         }\n         if (value.isStructure()) {\n-            return new Feature(name, Type.COMPOSITE, new Value<>(toFeatureList(value.toStructure().getValue())));\n+            return FeatureFactory.newCompositeFeature(name, toFeatureList(value.toStructure().getValue()));\n+        }\n+        if (value.isCollection()) {\n+            return FeatureFactory.newListFeature(name, toList(value.toCollection()));\n         }\n         return null;\n     }\n \n+    private static List<Object> toList(CollectionValue collectionValue) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2042a6bc518e7c96cab9f4c174b1e8218e8da600"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk4NDQ2OQ==", "bodyText": "Now that we handle all the types I think it could make sense to throw an exception here (actually this should never happen). Wdyt?", "url": "https://github.com/kiegroup/kogito-apps/pull/433#discussion_r481984469", "createdAt": "2020-09-02T11:03:14Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-service/src/main/java/org/kie/kogito/explainability/ConversionUtils.java", "diffHunk": "@@ -99,14 +130,14 @@ protected static Output toOutput(String name, Object value) {\n     }\n \n     public static Output toOutput(String name, TypedValue value) {\n-        // TODO: handle COLLECTION values https://issues.redhat.com/browse/KOGITO-3194\n         if (value.isUnit()) {\n             return toTypeValuePair(value.toUnit().getValue())\n                     .map(p -> new Output(name, p.getLeft(), p.getRight(), 1d))\n                     .orElse(null);\n-        }\n-        if (value.isStructure()) {\n+        } else if (value.isStructure()) {\n             return new Output(name, Type.COMPOSITE, new Value<>(toFeatureList(value.toStructure().getValue())), 1d);\n+        } else if (value.isCollection()) {\n+            return new Output(name, Type.LIST, new Value<>(toList(value.toCollection())), 1d);\n         }\n         return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2042a6bc518e7c96cab9f4c174b1e8218e8da600"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk4ODQxMg==", "bodyText": "Can you please add some tests with List of Structure and List of List?\nCan you also improve this last assertion? For example you can verify that the internal object type is correct in addition", "url": "https://github.com/kiegroup/kogito-apps/pull/433#discussion_r481988412", "createdAt": "2020-09-02T11:11:26Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-core/src/test/java/org/kie/kogito/explainability/model/TypeTest.java", "diffHunk": "@@ -143,6 +144,21 @@ void testPerturbCompositeFeature() {\n         assertNotEquals(value, perturbedValue);\n     }\n \n+    @Test\n+    void testPerturbListFeature() {\n+        PerturbationContext perturbationContext = new PerturbationContext(new Random(), 2);\n+        List<Double> list = new LinkedList<>();\n+        list.add(1d);\n+        list.add(2d);\n+        list.add(3d);\n+        list.add(4d);\n+        Feature feature = FeatureFactory.newListFeature(\"name\", list);\n+        Value<?> value = feature.getValue();\n+        Value<?> perturbedValue = feature.getType().perturb(value, perturbationContext);\n+        assertNotNull(perturbedValue);\n+        assertNotEquals(value, perturbedValue);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2042a6bc518e7c96cab9f4c174b1e8218e8da600"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MDY3MQ==", "bodyText": "Can you please clarify the scope of this perturb method? As far as I can see it generates a list of random numbers and then it uses them as index to remove elements.\nIn other words if it generates all the index the result will be an empty list etc but the values are not changed.\nI was expecting more a method that alter the values inside the list and not only the number of elements", "url": "https://github.com/kiegroup/kogito-apps/pull/433#discussion_r481990671", "createdAt": "2020-09-02T11:16:02Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/Type.java", "diffHunk": "@@ -363,6 +364,35 @@\n             return new Value<>(Currency.getInstance(Locale.getDefault()));\n         }\n \n+        @Override\n+        public List<double[]> encode(Value<?> target, Value<?>... values) {\n+            return encodeEquals(target, values);\n+        }\n+    },\n+\n+    LIST(\"list\") {\n+        @Override\n+        public Value<?> drop(Value<?> value) {\n+            return new Value<>(Collections.emptyList());\n+        }\n+\n+        @Override\n+        public Value<?> perturb(Value<?> value, PerturbationContext perturbationContext) {\n+            List<?> copy;\n+            if (value.getUnderlyingObject() instanceof List) {\n+                List<?> list = (List<?>) value.getUnderlyingObject();\n+                copy = new ArrayList<>(List.copyOf(list));\n+                int[] indexesToBePerturbed = perturbationContext.getRandom().ints(0, copy.size()).distinct()\n+                        .limit(perturbationContext.getNoOfPerturbations()).toArray();\n+                for (int index : indexesToBePerturbed) {\n+                    copy.remove(index);\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2042a6bc518e7c96cab9f4c174b1e8218e8da600"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5Mjg2NQ==", "bodyText": "Can you explain this block of code?\nI don't understand why we will have a completely different content for the list based on the type: if it is a unit it will be a list of JsonNode, if it is a structure we will have a list of list of Feature while if it is a collection we will nest another list.\nIs this expected?", "url": "https://github.com/kiegroup/kogito-apps/pull/433#discussion_r481992865", "createdAt": "2020-09-02T11:20:17Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-service/src/main/java/org/kie/kogito/explainability/ConversionUtils.java", "diffHunk": "@@ -41,26 +47,51 @@ private ConversionUtils() {\n \n     protected static Feature toFeature(String name, Object value) {\n         if (value instanceof JsonObject) {\n-            return new Feature(name, Type.COMPOSITE, new Value<>(toFeatureList((JsonObject) value)));\n+            return FeatureFactory.newCompositeFeature(name, toFeatureList((JsonObject) value));\n         }\n         return toTypeValuePair(value)\n                 .map(p -> new Feature(name, p.getLeft(), p.getRight()))\n                 .orElse(null);\n     }\n \n     public static Feature toFeature(String name, TypedValue value) {\n-        // TODO: handle COLLECTION values https://issues.redhat.com/browse/KOGITO-3194\n         if (value.isUnit()) {\n             return toTypeValuePair(value.toUnit().getValue())\n                     .map(p -> new Feature(name, p.getLeft(), p.getRight()))\n                     .orElse(null);\n         }\n         if (value.isStructure()) {\n-            return new Feature(name, Type.COMPOSITE, new Value<>(toFeatureList(value.toStructure().getValue())));\n+            return FeatureFactory.newCompositeFeature(name, toFeatureList(value.toStructure().getValue()));\n+        }\n+        if (value.isCollection()) {\n+            return FeatureFactory.newListFeature(name, toList(value.toCollection()));\n         }\n         return null;\n     }\n \n+    private static List<Object> toList(CollectionValue collectionValue) {\n+        Collection<TypedValue> values = collectionValue.getValue();\n+        List<Object> list = new LinkedList<>();\n+        for (TypedValue typedValue : values) {\n+            if (typedValue.isUnit()) {\n+                UnitValue unitValue = typedValue.toUnit();\n+                JsonNode jsonNode = unitValue.getValue();\n+                list.add(jsonNode);\n+            } else if (typedValue.isStructure()) {\n+                StructureValue structureValue = typedValue.toStructure();\n+                Map<String, TypedValue> map = structureValue.getValue();\n+                List<Feature> features = toFeatureList(map);\n+                list.add(features);\n+            } else if (typedValue.isCollection()) {\n+                CollectionValue nestedCollectionValue = typedValue.toCollection();\n+                List<Object> nested = toList(nestedCollectionValue);\n+                list.add(nested);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2042a6bc518e7c96cab9f4c174b1e8218e8da600"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MzE5Ng==", "bodyText": "Can you please add a test with List of Structure and List of List?", "url": "https://github.com/kiegroup/kogito-apps/pull/433#discussion_r481993196", "createdAt": "2020-09-02T11:20:49Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-service/src/test/java/org/kie/kogito/explainability/ConversionUtilsTest.java", "diffHunk": "@@ -85,8 +85,17 @@ void toFeatureTypedValue() {\n         assertEquals(Type.TEXT, features.get(0).getType());\n         assertEquals(\"stringValue\", features.get(0).getValue().getUnderlyingObject());\n \n-        // TODO add collection support https://issues.redhat.com/browse/KOGITO-3194\n-        assertNull(ConversionUtils.toFeature(\"name\", new CollectionValue(\"list\")));\n+        List<TypedValue> values = List.of(new UnitValue(\"number\", new DoubleNode(0d)),\n+                                          new UnitValue(\"number\", new DoubleNode(1d)));\n+        Feature collectionFeature = ConversionUtils.toFeature(\"name\", new CollectionValue(\"list\", values));\n+        assertNotNull(collectionFeature);\n+        assertEquals(\"name\", collectionFeature.getName());\n+        assertEquals(Type.LIST, collectionFeature.getType());\n+        assertTrue(collectionFeature.getValue().getUnderlyingObject() instanceof List);\n+        @SuppressWarnings(\"unchecked\")\n+        List<Double> objects = (List<Double>) collectionFeature.getValue().getUnderlyingObject();\n+        assertEquals(2, objects.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2042a6bc518e7c96cab9f4c174b1e8218e8da600"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk5MzkyMw==", "bodyText": "Can you please add a test with List of Structure and List of List?\nPlease improve the assertions too to verify the content too", "url": "https://github.com/kiegroup/kogito-apps/pull/433#discussion_r481993923", "createdAt": "2020-09-02T11:22:09Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-service/src/test/java/org/kie/kogito/explainability/ConversionUtilsTest.java", "diffHunk": "@@ -133,8 +142,9 @@ void toOutputTypedValue() {\n         assertEquals(Type.TEXT, features.get(0).getType());\n         assertEquals(\"stringValue\", features.get(0).getValue().getUnderlyingObject());\n \n-        // TODO add collection support https://issues.redhat.com/browse/KOGITO-3194\n-        assertNull(ConversionUtils.toOutput(\"name\", new CollectionValue(\"list\")));\n+        List<TypedValue> values = List.of(new UnitValue(\"number\", new DoubleNode(0d)),\n+                                          new UnitValue(\"number\", new DoubleNode(1d)));\n+        assertNotNull(ConversionUtils.toOutput(\"name\", new CollectionValue(\"list\", values)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2042a6bc518e7c96cab9f4c174b1e8218e8da600"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6dfa665d02a20270f01bd08efd66798344f368b", "author": {"user": {"login": "tteofili", "name": "Tommaso Teofili"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/d6dfa665d02a20270f01bd08efd66798344f368b", "committedDate": "2020-09-03T09:37:34Z", "message": "KOGITO-3194 - dropped Type.LIST, switched to Type.COMPOSITE for CollectionValue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNzQxOTgy", "url": "https://github.com/kiegroup/kogito-apps/pull/433#pullrequestreview-481741982", "createdAt": "2020-09-03T11:22:25Z", "commit": {"oid": "d6dfa665d02a20270f01bd08efd66798344f368b"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMToyMjoyNVrOHMiGNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMToyMzozNFrOHMiIOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkwMzYwNw==", "bodyText": "Unused import?", "url": "https://github.com/kiegroup/kogito-apps/pull/433#discussion_r482903607", "createdAt": "2020-09-03T11:22:25Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/model/Type.java", "diffHunk": "@@ -22,6 +22,7 @@\n import java.time.temporal.ChronoUnit;\n import java.util.ArrayList;\n import java.util.Arrays;\n+import java.util.Collections;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6dfa665d02a20270f01bd08efd66798344f368b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkwMzczMQ==", "bodyText": "Unused import?", "url": "https://github.com/kiegroup/kogito-apps/pull/433#discussion_r482903731", "createdAt": "2020-09-03T11:22:41Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-core/src/test/java/org/kie/kogito/explainability/model/TypeTest.java", "diffHunk": "@@ -14,6 +14,7 @@\n import org.junit.jupiter.params.provider.EnumSource;\n \n import static org.junit.jupiter.api.Assertions.assertNotEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6dfa665d02a20270f01bd08efd66798344f368b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkwNDEyMQ==", "bodyText": "It is not resolved yet :)", "url": "https://github.com/kiegroup/kogito-apps/pull/433#discussion_r482904121", "createdAt": "2020-09-03T11:23:34Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-service/src/main/java/org/kie/kogito/explainability/ConversionUtils.java", "diffHunk": "@@ -99,14 +130,14 @@ protected static Output toOutput(String name, Object value) {\n     }\n \n     public static Output toOutput(String name, TypedValue value) {\n-        // TODO: handle COLLECTION values https://issues.redhat.com/browse/KOGITO-3194\n         if (value.isUnit()) {\n             return toTypeValuePair(value.toUnit().getValue())\n                     .map(p -> new Output(name, p.getLeft(), p.getRight(), 1d))\n                     .orElse(null);\n-        }\n-        if (value.isStructure()) {\n+        } else if (value.isStructure()) {\n             return new Output(name, Type.COMPOSITE, new Value<>(toFeatureList(value.toStructure().getValue())), 1d);\n+        } else if (value.isCollection()) {\n+            return new Output(name, Type.LIST, new Value<>(toList(value.toCollection())), 1d);\n         }\n         return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk4NDQ2OQ=="}, "originalCommit": {"oid": "2042a6bc518e7c96cab9f4c174b1e8218e8da600"}, "originalPosition": 96}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4c90cc006d1cd7ddfebedbc895c52519b6d4552", "author": {"user": {"login": "tteofili", "name": "Tommaso Teofili"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/c4c90cc006d1cd7ddfebedbc895c52519b6d4552", "committedDate": "2020-09-03T11:45:17Z", "message": "KOGITO-3194 - removed unused imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNDU4MTM2", "url": "https://github.com/kiegroup/kogito-apps/pull/433#pullrequestreview-483458136", "createdAt": "2020-09-07T10:48:30Z", "commit": {"oid": "c4c90cc006d1cd7ddfebedbc895c52519b6d4552"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzODcyOTQ4", "url": "https://github.com/kiegroup/kogito-apps/pull/433#pullrequestreview-483872948", "createdAt": "2020-09-08T07:40:47Z", "commit": {"oid": "c4c90cc006d1cd7ddfebedbc895c52519b6d4552"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNzo0MDo0OFrOHOQo3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNzo0MjowOFrOHOQrqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcxNDcxNg==", "bodyText": "why linkedlist?", "url": "https://github.com/kiegroup/kogito-apps/pull/433#discussion_r484714716", "createdAt": "2020-09-08T07:40:48Z", "author": {"login": "r00ta"}, "path": "explainability/explainability-service/src/main/java/org/kie/kogito/explainability/ConversionUtils.java", "diffHunk": "@@ -41,24 +47,36 @@ private ConversionUtils() {\n \n     protected static Feature toFeature(String name, Object value) {\n         if (value instanceof JsonObject) {\n-            return new Feature(name, Type.COMPOSITE, new Value<>(toFeatureList((JsonObject) value)));\n+            return FeatureFactory.newCompositeFeature(name, toFeatureList((JsonObject) value));\n         }\n         return toTypeValuePair(value)\n                 .map(p -> new Feature(name, p.getLeft(), p.getRight()))\n                 .orElse(null);\n     }\n \n     public static Feature toFeature(String name, TypedValue value) {\n-        // TODO: handle COLLECTION values https://issues.redhat.com/browse/KOGITO-3194\n         if (value.isUnit()) {\n             return toTypeValuePair(value.toUnit().getValue())\n                     .map(p -> new Feature(name, p.getLeft(), p.getRight()))\n                     .orElse(null);\n+        } else if (value.isStructure()) {\n+            return FeatureFactory.newCompositeFeature(name, toFeatureList(value.toStructure().getValue()));\n+        } else if (value.isCollection()) {\n+            return FeatureFactory.newCompositeFeature(name, toFeatureList(name, value.toCollection()));\n+        } else {\n+            throw new RuntimeException(String.format(\"unexpected value kind %s\", value.getKind()));\n         }\n-        if (value.isStructure()) {\n-            return new Feature(name, Type.COMPOSITE, new Value<>(toFeatureList(value.toStructure().getValue())));\n+    }\n+\n+    protected static List<Feature> toFeatureList(String name, CollectionValue collectionValue) {\n+        Collection<TypedValue> values = collectionValue.getValue();\n+        List<Feature> list = new LinkedList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4c90cc006d1cd7ddfebedbc895c52519b6d4552"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcxNTQzMg==", "bodyText": "any alternative to the name objects that is too much generic?", "url": "https://github.com/kiegroup/kogito-apps/pull/433#discussion_r484715432", "createdAt": "2020-09-08T07:42:08Z", "author": {"login": "r00ta"}, "path": "explainability/explainability-service/src/test/java/org/kie/kogito/explainability/ConversionUtilsTest.java", "diffHunk": "@@ -85,8 +87,81 @@ void toFeatureTypedValue() {\n         assertEquals(Type.TEXT, features.get(0).getType());\n         assertEquals(\"stringValue\", features.get(0).getValue().getUnderlyingObject());\n \n-        // TODO add collection support https://issues.redhat.com/browse/KOGITO-3194\n-        assertNull(ConversionUtils.toFeature(\"name\", new CollectionValue(\"list\")));\n+        List<TypedValue> values = List.of(new UnitValue(\"number\", new DoubleNode(0d)),\n+                                          new UnitValue(\"number\", new DoubleNode(1d)));\n+        Feature collectionFeature = ConversionUtils.toFeature(\"name\", new CollectionValue(\"list\", values));\n+        assertNotNull(collectionFeature);\n+        assertEquals(\"name\", collectionFeature.getName());\n+        assertEquals(Type.COMPOSITE, collectionFeature.getType());\n+        assertTrue(collectionFeature.getValue().getUnderlyingObject() instanceof List);\n+        @SuppressWarnings(\"unchecked\")\n+        List<Feature> objects = (List<Feature>) collectionFeature.getValue().getUnderlyingObject();\n+        assertEquals(2, objects.size());\n+        for (Feature f : objects) {\n+            assertNotNull(f);\n+            assertNotNull(f.getName());\n+            assertNotNull(f.getType());\n+            assertEquals(Type.NUMBER, f.getType());\n+            assertNotNull(f.getValue());\n+        }\n+    }\n+\n+    @Test\n+    void testNestedCollection() {\n+        Collection<TypedValue> depthTwoOne = new ArrayList<>(2);\n+        depthTwoOne.add(new StructureValue(\"complex\", singletonMap(\n+                \"key\",\n+                new UnitValue(\"string1\", new TextNode(\"value one\")))));\n+        depthTwoOne.add(new StructureValue(\"complex\", singletonMap(\n+                \"key\",\n+                new UnitValue(\"string1\", new TextNode(\"value two\")))));\n+\n+        Collection<TypedValue> depthTwoTwo = new ArrayList<>(2);\n+        depthTwoTwo.add(new StructureValue(\"complex\", singletonMap(\n+                \"key\",\n+                new UnitValue(\"string1\", new TextNode(\"value three\")))));\n+        depthTwoTwo.add(new StructureValue(\"complex\", singletonMap(\n+                \"key\",\n+                new UnitValue(\"string1\", new TextNode(\"value four\")))));\n+\n+        CollectionValue depthOneLeft = new CollectionValue(\"list\", depthTwoOne);\n+        CollectionValue depthOneRight = new CollectionValue(\"list\", depthTwoTwo);\n+        Collection<TypedValue> depthOne = new ArrayList<>(2);\n+        depthOne.add(depthOneLeft);\n+        depthOne.add(depthOneRight);\n+        CollectionValue value = new CollectionValue(\"list\", depthOne);\n+        Feature collectionFeature = ConversionUtils.toFeature(\"name\", value);\n+        assertNotNull(collectionFeature);\n+        assertEquals(\"name\", collectionFeature.getName());\n+        assertEquals(Type.COMPOSITE, collectionFeature.getType());\n+        assertTrue(collectionFeature.getValue().getUnderlyingObject() instanceof List);\n+        @SuppressWarnings(\"unchecked\")\n+        List<Feature> objects = (List<Feature>) collectionFeature.getValue().getUnderlyingObject();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4c90cc006d1cd7ddfebedbc895c52519b6d4552"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "879c94409daf21888864da4b481e097107612f79", "author": {"user": {"login": "tteofili", "name": "Tommaso Teofili"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/879c94409daf21888864da4b481e097107612f79", "committedDate": "2020-09-08T08:25:46Z", "message": "KOGITO-3194 - review based improvements"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4748, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}