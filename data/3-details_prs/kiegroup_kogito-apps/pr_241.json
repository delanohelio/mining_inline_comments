{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2MDgxMjE4", "number": 241, "title": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)", "bodyText": "jira related .. https://issues.redhat.com/browse/KOGITO-536\n\nAdds oidc keycloak configuration to allow data-index work as an service (working with bearer token) and as a webapp to serve the graphiql  redirecting to keycloak login page for authentication.", "createdAt": "2020-06-01T16:17:06Z", "url": "https://github.com/kiegroup/kogito-apps/pull/241", "merged": true, "mergeCommit": {"oid": "02b6138e89635a5bec6b67753bf8bc5ed738e4f6"}, "closed": true, "closedAt": "2020-06-30T10:59:49Z", "author": {"login": "nmirasch"}, "timelineItems": {"totalCount": 31, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnEABDAFqTQyMTk5NTM4OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwTN_6AFqTQzOTg4OTU5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxOTk1Mzg4", "url": "https://github.com/kiegroup/kogito-apps/pull/241#pullrequestreview-421995388", "createdAt": "2020-06-01T16:26:37Z", "commit": {"oid": "f19843236009e0554d187eaeb530c2a62936c547"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNjoyNjozN1rOGdRZSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNzo0NjoyMFrOGdT_WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM0Njg4OQ==", "bodyText": "Keycloack -> Keycloak", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r433346889", "createdAt": "2020-06-01T16:26:37Z", "author": {"login": "jstastny-cz"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -66,27 +70,38 @@ public void testNoTokenProvided() {\n     @Test\n     public void testAuthorizedUserProvided() {\n         //jdoe has role:user and confidential, resource served\n-        given().auth().oauth2(getAccessToken(\"jdoe\"))\n-                .when().get(\"/graphiql/\")\n-                .then()\n-                .statusCode(404);\n-\n         given().auth().oauth2(getAccessToken(\"jdoe\"))\n                 .contentType(ContentType.JSON)\n                 .body(\"{ \\\"query\\\" : \\\"{ProcessInstances{ id } }\\\" }\")\n                 .when().post(\"/graphql\")\n                 .then().log().ifValidationFails().statusCode(200);\n     }\n \n+    @Test\n+    public void graphiqlLoginOnKeycloackServedTest(){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f19843236009e0554d187eaeb530c2a62936c547"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM0Njk3OA==", "bodyText": "why moving this from application.properties to here?", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r433346978", "createdAt": "2020-06-01T16:26:43Z", "author": {"login": "jstastny-cz"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -32,18 +33,25 @@\n @QuarkusTestResource(InfinispanServerTestResource.class)\n public class KeycloakIntegrationIndexingServiceIT {\n \n-    private static final String KEYCLOAK_SERVER_URL = System.getProperty(\"keycloak.url\", \"http://localhost:8281/auth\");\n-    private static final String KEYCLOAK_REALM = \"kogito\";\n-    private static final String KEYCLOAK_CLIENT_ID = \"kogito-data-index-service\";\n+    private static final String KEYCLOAK_SERVER_URL = System.getProperty(\"quarkus.oidc.auth-server-url\", \"http://localhost:8281/auth/realms/kogito\");\n+    private static final String KEYCLOAK_CLIENT_ID = System.getProperty(\"quarkus.oidc.client-id\", \"kogito-data-index-service\");\n+    private static final String KEYCLOAK_CLIENT_SECRET = System.getProperty(\"quarkus.oidc.credentials.secret\", \"secret\");\n+\n+    @BeforeAll\n+    public static void setup() {\n+        System.setProperty(\"quarkus.http.auth.policy.role-policy1.roles-allowed\", \"confidential\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f19843236009e0554d187eaeb530c2a62936c547"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM0ODUxNA==", "bodyText": "Is the status code under our control? Some sites use 302 code to signal that the page is there, but something still needs to be done to access it.", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r433348514", "createdAt": "2020-06-01T16:29:35Z", "author": {"login": "jstastny-cz"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -66,27 +70,38 @@ public void testNoTokenProvided() {\n     @Test\n     public void testAuthorizedUserProvided() {\n         //jdoe has role:user and confidential, resource served\n-        given().auth().oauth2(getAccessToken(\"jdoe\"))\n-                .when().get(\"/graphiql/\")\n-                .then()\n-                .statusCode(404);\n-\n         given().auth().oauth2(getAccessToken(\"jdoe\"))\n                 .contentType(ContentType.JSON)\n                 .body(\"{ \\\"query\\\" : \\\"{ProcessInstances{ id } }\\\" }\")\n                 .when().post(\"/graphql\")\n                 .then().log().ifValidationFails().statusCode(200);\n     }\n \n+    @Test\n+    public void graphiqlLoginOnKeycloackServedTest(){\n+        // Returning keycloak login page\n+        given().when().get(\"/graphiql/\")\n+                .then()\n+                .statusCode(200);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f19843236009e0554d187eaeb530c2a62936c547"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM1Mzc4MQ==", "bodyText": "wondering why these two are not in the test properties?", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r433353781", "createdAt": "2020-06-01T16:39:12Z", "author": {"login": "jstastny-cz"}, "path": "data-index/data-index-service/src/main/resources/application.properties", "diffHunk": "@@ -74,6 +74,13 @@ quarkus.oidc.auth-server-url=none\n %keycloak.quarkus.oidc.auth-server-url=http://localhost:8280/auth/realms/kogito\n %keycloak.quarkus.oidc.client-id=kogito-data-index-service\n %keycloak.quarkus.oidc.credentials.secret=secret\n-%keycloak.quarkus.http.auth.policy.role-policy1.roles-allowed=confidential\n-%keycloak.quarkus.http.auth.permission.roles1.paths=/graphql\n-%keycloak.quarkus.http.auth.permission.roles1.policy=role-policy1\n+%keycloak.quarkus.oidc.application-type=service\n+\n+%keycloak.quarkus.oidc.web-app-tenant.auth-server-url=http://localhost:8280/auth/realms/kogito\n+%keycloak.quarkus.oidc.web-app-tenant.client-id=kogito-data-index-service\n+%keycloak.quarkus.oidc.web-app-tenant.credentials.secret=secret\n+%keycloak.quarkus.oidc.web-app-tenant.application-type=web-app\n+\n+# HTTP Security Configuration\n+%keycloak.quarkus.http.auth.permission.authenticated.paths=/*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f19843236009e0554d187eaeb530c2a62936c547"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM4OTQwMA==", "bodyText": "so this decides which tenant is accessing the app based on the context, right. graphiql is a UI, thus web-app-tenant should be used, otherwise it will resort to the default config, is that correct?", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r433389400", "createdAt": "2020-06-01T17:46:20Z", "author": {"login": "jstastny-cz"}, "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/auth/MultiTenantResolver.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.auth;\n+\n+import javax.enterprise.context.ApplicationScoped;\n+\n+import io.quarkus.oidc.TenantResolver;\n+import io.vertx.ext.web.RoutingContext;\n+\n+@ApplicationScoped\n+public class MultiTenantResolver implements TenantResolver {\n+\n+    @Override\n+    public String resolve(RoutingContext context) {\n+        if (context.request().path().startsWith(\"/graphiql\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f19843236009e0554d187eaeb530c2a62936c547"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f19843236009e0554d187eaeb530c2a62936c547", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/f19843236009e0554d187eaeb530c2a62936c547", "committedDate": "2020-06-01T16:08:15Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}, "afterCommit": {"oid": "e54775d4f203377ca959a464f1f7d0a9b419a0c1", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/e54775d4f203377ca959a464f1f7d0a9b419a0c1", "committedDate": "2020-06-03T10:51:14Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e54775d4f203377ca959a464f1f7d0a9b419a0c1", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/e54775d4f203377ca959a464f1f7d0a9b419a0c1", "committedDate": "2020-06-03T10:51:14Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}, "afterCommit": {"oid": "9c94276237755eb4f2c55f2f09ee82a811aee743", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/9c94276237755eb4f2c55f2f09ee82a811aee743", "committedDate": "2020-06-03T11:06:21Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MTMzMDky", "url": "https://github.com/kiegroup/kogito-apps/pull/241#pullrequestreview-424133092", "createdAt": "2020-06-04T06:22:35Z", "commit": {"oid": "9c94276237755eb4f2c55f2f09ee82a811aee743"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwNjoyMjozNVrOGe3WkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwODoyODoxMVrOGe7P8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAxNzM2MQ==", "bodyText": "At the moment, I see these hard-coded values:\n\n\"graphiql\": before this PR, this value was only used in VertxRouterSetup, but now it's used also in MultiTenantResolved and KeycloakIntegrationIndexingServiceIT.\n\"web-app-tenant\": it's used here and in the properties to configure the oidc properties.\n\nWhat about to add a property to define the \"graphiql\" property:\n\u00b4\u00b4\u00b4\ndataindex.vertx-graphql.ui.path=/graphiql\n\u00b4\u00b4\u00b4\n| Note that the name property is in sync with the default vertx property called \"quarkus.vertx-graphql.ui.path\" (more in here)\nAnd also define the tenants for each path in the properties:\ndataindex.paths.\"/graphiql\".tenant=web-app-tenant\n\nThis way we can configure the tenants and configuration entirely driven by properties:\n%keycloak.quarkus.oidc.web-app-tenant.auth-server-url=http://localhost:8280/auth/realms/kogito\n%keycloak.quarkus.oidc.web-app-tenant.client-id=kogito-data-index-service\n%keycloak.quarkus.oidc.web-app-tenant.credentials.secret=secret\n%keycloak.quarkus.oidc.web-app-tenant.application-type=web-app\n\nAnd we can even define more custom tenants for different paths:\ndataindex.paths.\"/custom\".tenant=custom-app-tenant\n%keycloak.quarkus.oidc.custom-app-tenant.auth-server-url=http://localhost:8280/auth/realms/kogitocustom\n\nThis is specially interesting to define different roles by paths.\nWhat do you think?", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435017361", "createdAt": "2020-06-04T06:22:35Z", "author": {"login": "Sgitario"}, "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/auth/MultiTenantResolver.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.auth;\n+\n+import javax.enterprise.context.ApplicationScoped;\n+\n+import io.quarkus.oidc.TenantResolver;\n+import io.vertx.ext.web.RoutingContext;\n+\n+@ApplicationScoped\n+public class MultiTenantResolver implements TenantResolver {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c94276237755eb4f2c55f2f09ee82a811aee743"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAxODIxOQ==", "bodyText": "I know this was not changed as part of this PR, but what is the difference between the graphiql and graphql? As far I can see in here, the graphql is only available when running the data index in dev mode?\nCan we remove the \"/graphql\" path and use the property \"quarkus.vertx-graphql.ui.path\" instead? So if in the future, we change this property, we don't need to change this class.", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435018219", "createdAt": "2020-06-04T06:24:51Z", "author": {"login": "Sgitario"}, "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -43,14 +48,37 @@\n     GraphQL graphQL;\n \n     void setupRouter(@Observes Router router) {\n-        if (Boolean.FALSE.equals(authEnabled)) {\n-            router.route(\"/graphiql/*\").handler(GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true)));\n-            router.route().handler(LoggerHandler.create());\n-            router.route().handler(StaticHandler.create());\n-            router.route().handler(FaviconHandler.create());\n-            router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n+        GraphiQLHandler graphiQLHandler = GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true));\n+        if (Boolean.TRUE.equals(authEnabled)) {\n+            graphiQLHandler.graphiQLRequestHeaders(rc -> {\n+                MultiMap multiMap = MultiMap.caseInsensitiveMultiMap();\n+                String token = getCurrentAccessToken(rc);\n+                if (token.isEmpty()) {\n+                    token = rc.request().getHeader(HttpHeaders.AUTHORIZATION);\n+                }\n+                multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_ORIGIN, \"*\");\n+                multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS, \"true\");\n+                multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_HEADERS, \"Authorization, Content-Type, Accept\");\n+                multiMap.add(\"Bearer-token\", \"Bearer \" + token);\n+                rc.request().headers().addAll(multiMap);\n+                return multiMap.add(HttpHeaders.AUTHORIZATION, \"Bearer \" + token);\n+            });\n         }\n+        router.route(\"/graphiql/*\").handler(graphiQLHandler);\n+        router.route().handler(LoggerHandler.create());\n+        router.route().handler(StaticHandler.create());\n+        router.route().handler(FaviconHandler.create());\n+        router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n         router.route(\"/graphql\").handler(ApolloWSHandler.create(graphQL));\n         router.route(\"/graphql\").handler(GraphQLHandler.create(graphQL, new GraphQLHandlerOptions()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c94276237755eb4f2c55f2f09ee82a811aee743"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAyMDMyNw==", "bodyText": "Suggestion, what about using stream and optionals here?\nprivate String getCurrentAccessToken(RoutingContext routingContext) {\n        return Optional.ofNullable(routingContext.user())\n                .map(user -> ((QuarkusHttpUser) user).getSecurityIdentity())\n                .map(identity -> identity.getCredential(AccessTokenCredential.class))\n                .map(AccessTokenCredential::getToken)\n                .orElse(StringUtils.EMPTY);\n    }\n\nI read this code better like this, what do you think?", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435020327", "createdAt": "2020-06-04T06:30:27Z", "author": {"login": "Sgitario"}, "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -43,14 +48,37 @@\n     GraphQL graphQL;\n \n     void setupRouter(@Observes Router router) {\n-        if (Boolean.FALSE.equals(authEnabled)) {\n-            router.route(\"/graphiql/*\").handler(GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true)));\n-            router.route().handler(LoggerHandler.create());\n-            router.route().handler(StaticHandler.create());\n-            router.route().handler(FaviconHandler.create());\n-            router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n+        GraphiQLHandler graphiQLHandler = GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true));\n+        if (Boolean.TRUE.equals(authEnabled)) {\n+            graphiQLHandler.graphiQLRequestHeaders(rc -> {\n+                MultiMap multiMap = MultiMap.caseInsensitiveMultiMap();\n+                String token = getCurrentAccessToken(rc);\n+                if (token.isEmpty()) {\n+                    token = rc.request().getHeader(HttpHeaders.AUTHORIZATION);\n+                }\n+                multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_ORIGIN, \"*\");\n+                multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS, \"true\");\n+                multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_HEADERS, \"Authorization, Content-Type, Accept\");\n+                multiMap.add(\"Bearer-token\", \"Bearer \" + token);\n+                rc.request().headers().addAll(multiMap);\n+                return multiMap.add(HttpHeaders.AUTHORIZATION, \"Bearer \" + token);\n+            });\n         }\n+        router.route(\"/graphiql/*\").handler(graphiQLHandler);\n+        router.route().handler(LoggerHandler.create());\n+        router.route().handler(StaticHandler.create());\n+        router.route().handler(FaviconHandler.create());\n+        router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n         router.route(\"/graphql\").handler(ApolloWSHandler.create(graphQL));\n         router.route(\"/graphql\").handler(GraphQLHandler.create(graphQL, new GraphQLHandlerOptions()));\n     }\n+\n+    private String getCurrentAccessToken(RoutingContext routingContext) {\n+        if ((routingContext.user() != null) &&\n+                ((QuarkusHttpUser) routingContext.user()).getSecurityIdentity() != null &&\n+                ((QuarkusHttpUser) routingContext.user()).getSecurityIdentity().getCredential(AccessTokenCredential.class) != null) {\n+            return ((QuarkusHttpUser) routingContext.user()).getSecurityIdentity().getCredential(AccessTokenCredential.class).getToken();\n+        }\n+        return \"\";\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c94276237755eb4f2c55f2f09ee82a811aee743"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzMjk2OA==", "bodyText": "Does it make sense to set the default image properties for infinispan and keycloak?\nI'm using this one for Infinispan:\nprivate static final String INFINISPAN_IMAGE = System.getProperty(\"container.image.infinispan\", \"jboss/infinispan-server:10.1.8.Final\");\n\nAnd this one for keycloak:\nprivate static final String KEYCLOAK_IMAGE = System.getProperty(\"container.image.keycloak\", \"jboss/keycloak:10.0.2\");\n\nSo we can run the tests directly from the IDE with further configuration.", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435032968", "createdAt": "2020-06-04T06:59:45Z", "author": {"login": "Sgitario"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -32,18 +32,18 @@\n @QuarkusTestResource(InfinispanServerTestResource.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c94276237755eb4f2c55f2f09ee82a811aee743"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzODczNQ==", "bodyText": "There is an extra space here at the beginning.", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435038735", "createdAt": "2020-06-04T07:11:48Z", "author": {"login": "Sgitario"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -66,27 +62,38 @@ public void testNoTokenProvided() {\n     @Test\n     public void testAuthorizedUserProvided() {\n         //jdoe has role:user and confidential, resource served\n-        given().auth().oauth2(getAccessToken(\"jdoe\"))\n-                .when().get(\"/graphiql/\")\n-                .then()\n-                .statusCode(404);\n-\n         given().auth().oauth2(getAccessToken(\"jdoe\"))\n                 .contentType(ContentType.JSON)\n                 .body(\"{ \\\"query\\\" : \\\"{ProcessInstances{ id } }\\\" }\")\n                 .when().post(\"/graphql\")\n                 .then().log().ifValidationFails().statusCode(200);\n     }\n \n+    @Test\n+    public void graphiqlLoginOnKeycloakServedTest(){\n+        // Returning keycloak login page\n+        given().when().get(\"/graphiql/\")\n+                .then()\n+                .statusCode(200);\n+        // Returning keycloak login page\n+        given().auth().oauth2(getAccessToken(\"jdoe\"))\n+                .when().get(\"/graphiql/\")\n+                .then()\n+                .statusCode(200);\n+         given().when().get(\"/other/\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c94276237755eb4f2c55f2f09ee82a811aee743"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA0MTUzOQ==", "bodyText": "I added this new assertion:\ngiven().auth().oauth2(\"any-wrong-token\")\n        .when().get(\"/graphiql/\")\n        .then().statusCode(401);\n\nAnd it's failing because it retuns 200 OK code. Is this expected? Maybe it's redirecting to a Keycloak page when this is not valid?", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435041539", "createdAt": "2020-06-04T07:17:38Z", "author": {"login": "Sgitario"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -66,27 +62,38 @@ public void testNoTokenProvided() {\n     @Test\n     public void testAuthorizedUserProvided() {\n         //jdoe has role:user and confidential, resource served\n-        given().auth().oauth2(getAccessToken(\"jdoe\"))\n-                .when().get(\"/graphiql/\")\n-                .then()\n-                .statusCode(404);\n-\n         given().auth().oauth2(getAccessToken(\"jdoe\"))\n                 .contentType(ContentType.JSON)\n                 .body(\"{ \\\"query\\\" : \\\"{ProcessInstances{ id } }\\\" }\")\n                 .when().post(\"/graphql\")\n                 .then().log().ifValidationFails().statusCode(200);\n     }\n \n+    @Test\n+    public void graphiqlLoginOnKeycloakServedTest(){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c94276237755eb4f2c55f2f09ee82a811aee743"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA4MTIwMA==", "bodyText": "I'm confused about the tests that cover the \"/graphql\" path.\nI ran the tests using \"mvn clean verify\" and I'm aware of these tests are working fine, but as far I can see in the VertxRouterSetup, we are not doing anything new about this path, right?\nAlso, this path does not allow the GET method, but POST method... so no idea why is working. What am I missing?", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r435081200", "createdAt": "2020-06-04T08:28:11Z", "author": {"login": "Sgitario"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -32,18 +32,18 @@\n @QuarkusTestResource(InfinispanServerTestResource.class)\n public class KeycloakIntegrationIndexingServiceIT {\n \n-    private static final String KEYCLOAK_SERVER_URL = System.getProperty(\"keycloak.url\", \"http://localhost:8281/auth\");\n-    private static final String KEYCLOAK_REALM = \"kogito\";\n-    private static final String KEYCLOAK_CLIENT_ID = \"kogito-data-index-service\";\n+    private static final String KEYCLOAK_SERVER_URL = System.getProperty(\"quarkus.oidc.auth-server-url\", \"http://localhost:8281/auth/realms/kogito\");\n+    private static final String KEYCLOAK_CLIENT_ID = System.getProperty(\"quarkus.oidc.client-id\", \"kogito-data-index-service\");\n+    private static final String KEYCLOAK_CLIENT_SECRET = System.getProperty(\"quarkus.oidc.credentials.secret\", \"secret\");\n \n     @Test\n     public void testUnauthorizedUserAccess() {\n         //alice only have role User, resource is forbidden\n-        given().auth().oauth2(getAccessToken(\"alice\"))\n-                .when().get(\"/graphiql/\")\n+        given().contentType(ContentType.JSON).body(\"{ \\\"query\\\" : \\\"{ProcessInstances{ id } }\\\" }\")\n+                .auth().oauth2(getAccessToken(\"alice\"))\n+                .when().get(\"/graphql\")\n                 .then()\n-                .statusCode(404);\n-\n+                .statusCode(403);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c94276237755eb4f2c55f2f09ee82a811aee743"}, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c94276237755eb4f2c55f2f09ee82a811aee743", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/9c94276237755eb4f2c55f2f09ee82a811aee743", "committedDate": "2020-06-03T11:06:21Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}, "afterCommit": {"oid": "15bbf07928ed39c63e8571adab174481de035407", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/15bbf07928ed39c63e8571adab174481de035407", "committedDate": "2020-06-04T16:35:16Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "15bbf07928ed39c63e8571adab174481de035407", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/15bbf07928ed39c63e8571adab174481de035407", "committedDate": "2020-06-04T16:35:16Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}, "afterCommit": {"oid": "7e11ecc44e8a19c818c8d5e3833124b04530d5d2", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/7e11ecc44e8a19c818c8d5e3833124b04530d5d2", "committedDate": "2020-06-09T10:29:45Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7e11ecc44e8a19c818c8d5e3833124b04530d5d2", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/7e11ecc44e8a19c818c8d5e3833124b04530d5d2", "committedDate": "2020-06-09T10:29:45Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}, "afterCommit": {"oid": "32f468f63fbbc7d7436d1b422300716826129e5e", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/32f468f63fbbc7d7436d1b422300716826129e5e", "committedDate": "2020-06-11T05:41:47Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "32f468f63fbbc7d7436d1b422300716826129e5e", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/32f468f63fbbc7d7436d1b422300716826129e5e", "committedDate": "2020-06-11T05:41:47Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}, "afterCommit": {"oid": "530722473d09f381acd45280813b0a40460d1a7c", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/530722473d09f381acd45280813b0a40460d1a7c", "committedDate": "2020-06-15T08:35:58Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNTA4NjYy", "url": "https://github.com/kiegroup/kogito-apps/pull/241#pullrequestreview-430508662", "createdAt": "2020-06-15T10:17:22Z", "commit": {"oid": "530722473d09f381acd45280813b0a40460d1a7c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMDoxNzoyM1rOGjsBgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMTo0ODoyOVrOGjuu6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3NDYyNw==", "bodyText": "I see there is an existing property for data index component called \"kogito.data-index.storage.type=infinispan\". Maybe we should continue this name convention and rename this property to \"kogito.data-index.vertx-graphql.ui.path\".\nThis also applies to \"kogito.data-index.vertx-graphql.ui.tenant\"", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r440074627", "createdAt": "2020-06-15T10:17:23Z", "author": {"login": "Sgitario"}, "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -39,18 +47,44 @@\n     @ConfigProperty(name = \"quarkus.oidc.enabled\", defaultValue = \"false\")\n     Boolean authEnabled;\n \n+    @Inject\n+    @ConfigProperty(name = \"kogito.dataindex.vertx-graphql.ui.path\", defaultValue = \"/graphiql\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "530722473d09f381acd45280813b0a40460d1a7c"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEwNTM3Ng==", "bodyText": "This assertion should be:\nassertThat(multiTenantResolver.resolve(routingContextMock)).isEqualTo(GRAPH_UI_TENANT);", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r440105376", "createdAt": "2020-06-15T11:19:44Z", "author": {"login": "Sgitario"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/auth/MultiTenantResolverTest.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.auth;\n+\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.RoutingContext;\n+import org.junit.Before;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.lenient;\n+\n+\n+@ExtendWith(MockitoExtension.class)\n+class MultiTenantResolverTest {\n+\n+    private static final String GRAPH_UI_PATH = System.getProperty(\"kogito.dataindex.vertx-graphql.ui.path\", \"/graphiql\");\n+    private static final String GRAPH_UI_TENANT = System.getProperty(\"kogito.dataindex.vertx-graphql.ui.tenant\", \"web-app-tenant\");\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    HttpServerRequest requestMock;\n+\n+    @InjectMocks\n+    MultiTenantResolver multiTenantResolver;\n+\n+    @Before\n+    public void setup(){\n+        lenient().when(routingContextMock.request()).thenReturn(requestMock);\n+    }\n+\n+    @Test\n+    void resolveGraphiqlTenantTest() {\n+        lenient().when(requestMock.path()).thenReturn(GRAPH_UI_PATH);\n+        assertThat(GRAPH_UI_TENANT.equals(multiTenantResolver.resolve(routingContextMock)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "530722473d09f381acd45280813b0a40460d1a7c"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExODI0OA==", "bodyText": "This is wrong. It should use \"BeforeEach\" annotation as this is running on JUnit 5.", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r440118248", "createdAt": "2020-06-15T11:46:52Z", "author": {"login": "Sgitario"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/auth/MultiTenantResolverTest.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.auth;\n+\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.RoutingContext;\n+import org.junit.Before;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.lenient;\n+\n+\n+@ExtendWith(MockitoExtension.class)\n+class MultiTenantResolverTest {\n+\n+    private static final String GRAPH_UI_PATH = System.getProperty(\"kogito.dataindex.vertx-graphql.ui.path\", \"/graphiql\");\n+    private static final String GRAPH_UI_TENANT = System.getProperty(\"kogito.dataindex.vertx-graphql.ui.tenant\", \"web-app-tenant\");\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    HttpServerRequest requestMock;\n+\n+    @InjectMocks\n+    MultiTenantResolver multiTenantResolver;\n+\n+    @Before", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "530722473d09f381acd45280813b0a40460d1a7c"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDExOTAxOA==", "bodyText": "I think this test relies on some properties being injected from a maven profile.\nIn order to make it isolated, what do you think of creating a givenTenantConfigured where:\nprivate void givenTentantIsConfigured() {\n        multiTenantResolver.graphUITenantId = GRAPH_UI_TENANT;\n        multiTenantResolver.graphUIPath = GRAPH_UI_PATH;\n    }", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r440119018", "createdAt": "2020-06-15T11:48:29Z", "author": {"login": "Sgitario"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/auth/MultiTenantResolverTest.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.auth;\n+\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.RoutingContext;\n+import org.junit.Before;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.lenient;\n+\n+\n+@ExtendWith(MockitoExtension.class)\n+class MultiTenantResolverTest {\n+\n+    private static final String GRAPH_UI_PATH = System.getProperty(\"kogito.dataindex.vertx-graphql.ui.path\", \"/graphiql\");\n+    private static final String GRAPH_UI_TENANT = System.getProperty(\"kogito.dataindex.vertx-graphql.ui.tenant\", \"web-app-tenant\");\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    HttpServerRequest requestMock;\n+\n+    @InjectMocks\n+    MultiTenantResolver multiTenantResolver;\n+\n+    @Before\n+    public void setup(){\n+        lenient().when(routingContextMock.request()).thenReturn(requestMock);\n+    }\n+\n+    @Test\n+    void resolveGraphiqlTenantTest() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "530722473d09f381acd45280813b0a40460d1a7c"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNTkwMDMy", "url": "https://github.com/kiegroup/kogito-apps/pull/241#pullrequestreview-430590032", "createdAt": "2020-06-15T12:21:45Z", "commit": {"oid": "530722473d09f381acd45280813b0a40460d1a7c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMjoyMTo0NVrOGjvyVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMjoyMTo0NVrOGjvyVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDEzNjI3Nw==", "bodyText": "Should we cover these changes in VertxRouterSetup in an unit test?", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r440136277", "createdAt": "2020-06-15T12:21:45Z", "author": {"login": "Sgitario"}, "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -39,18 +47,44 @@\n     @ConfigProperty(name = \"quarkus.oidc.enabled\", defaultValue = \"false\")\n     Boolean authEnabled;\n \n+    @Inject\n+    @ConfigProperty(name = \"kogito.dataindex.vertx-graphql.ui.path\", defaultValue = \"/graphiql\")\n+    String graphUIPath;\n+\n     @Inject\n     GraphQL graphQL;\n \n     void setupRouter(@Observes Router router) {\n-        if (Boolean.FALSE.equals(authEnabled)) {\n-            router.route(\"/graphiql/*\").handler(GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true)));\n-            router.route().handler(LoggerHandler.create());\n-            router.route().handler(StaticHandler.create());\n-            router.route().handler(FaviconHandler.create());\n-            router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n+        GraphiQLHandler graphiQLHandler = GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true));\n+        if (Boolean.TRUE.equals(authEnabled)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "530722473d09f381acd45280813b0a40460d1a7c"}, "originalPosition": 47}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "530722473d09f381acd45280813b0a40460d1a7c", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/530722473d09f381acd45280813b0a40460d1a7c", "committedDate": "2020-06-15T08:35:58Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}, "afterCommit": {"oid": "d236f2b7bf3012cd8993e7de3ccba0fdc1f94a04", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/d236f2b7bf3012cd8993e7de3ccba0fdc1f94a04", "committedDate": "2020-06-16T09:56:33Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNDMwNzA5", "url": "https://github.com/kiegroup/kogito-apps/pull/241#pullrequestreview-431430709", "createdAt": "2020-06-16T12:00:27Z", "commit": {"oid": "d236f2b7bf3012cd8993e7de3ccba0fdc1f94a04"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMjowMDoyOFrOGkYBYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMjowMDoyOFrOGkYBYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc5NTQ4OQ==", "bodyText": "I think private methods should go at the bottom after public and protected methods.", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r440795489", "createdAt": "2020-06-16T12:00:28Z", "author": {"login": "Sgitario"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/auth/MultiTenantResolverTest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.auth;\n+\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.RoutingContext;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.lenient;\n+\n+\n+@ExtendWith(MockitoExtension.class)\n+class MultiTenantResolverTest {\n+\n+    private static final String GRAPH_UI_PATH = System.getProperty(\"kogito.data-index.vertx-graphql.ui.path\", \"/graphiql\");\n+    private static final String GRAPH_UI_TENANT = System.getProperty(\"kogito.data-index.vertx-graphql.ui.tenant\", \"web-app-tenant\");\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    HttpServerRequest requestMock;\n+\n+    @InjectMocks\n+    MultiTenantResolver multiTenantResolver;\n+\n+    @BeforeEach\n+    public void setup(){\n+        lenient().when(routingContextMock.request()).thenReturn(requestMock);\n+        givenTenantIsConfigured();\n+    }\n+\n+    private void givenTenantIsConfigured() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d236f2b7bf3012cd8993e7de3ccba0fdc1f94a04"}, "originalPosition": 54}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d236f2b7bf3012cd8993e7de3ccba0fdc1f94a04", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/d236f2b7bf3012cd8993e7de3ccba0fdc1f94a04", "committedDate": "2020-06-16T09:56:33Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}, "afterCommit": {"oid": "b7a2c116ed849b1955ddf858cc5776093a6036b0", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/b7a2c116ed849b1955ddf858cc5776093a6036b0", "committedDate": "2020-06-17T05:53:31Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMjU4NTM2", "url": "https://github.com/kiegroup/kogito-apps/pull/241#pullrequestreview-432258536", "createdAt": "2020-06-17T10:14:55Z", "commit": {"oid": "b7a2c116ed849b1955ddf858cc5776093a6036b0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b7a2c116ed849b1955ddf858cc5776093a6036b0", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/b7a2c116ed849b1955ddf858cc5776093a6036b0", "committedDate": "2020-06-17T05:53:31Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}, "afterCommit": {"oid": "b2c4fe3c6be531ba443623087bb624d3f04796ec", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/b2c4fe3c6be531ba443623087bb624d3f04796ec", "committedDate": "2020-06-19T06:00:09Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b2c4fe3c6be531ba443623087bb624d3f04796ec", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/b2c4fe3c6be531ba443623087bb624d3f04796ec", "committedDate": "2020-06-19T06:00:09Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}, "afterCommit": {"oid": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/6b86fd67f7c5448e92ad57a7d3cf974c79f2592f", "committedDate": "2020-06-22T11:38:24Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MzA2MDM2", "url": "https://github.com/kiegroup/kogito-apps/pull/241#pullrequestreview-436306036", "createdAt": "2020-06-24T03:52:20Z", "commit": {"oid": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f"}, "state": "COMMENTED", "comments": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMzo1MjoyMFrOGoCB6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNDoyNjo0MFrOGoCf-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYyOTQ4Mw==", "bodyText": "wouldnt be best to not set .orElse(StringUtils.EMPTY); then simply do token.isPresent() as an Optional ?", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444629483", "createdAt": "2020-06-24T03:52:20Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -43,14 +48,37 @@\n     GraphQL graphQL;\n \n     void setupRouter(@Observes Router router) {\n-        if (Boolean.FALSE.equals(authEnabled)) {\n-            router.route(\"/graphiql/*\").handler(GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true)));\n-            router.route().handler(LoggerHandler.create());\n-            router.route().handler(StaticHandler.create());\n-            router.route().handler(FaviconHandler.create());\n-            router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n+        GraphiQLHandler graphiQLHandler = GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true));\n+        if (Boolean.TRUE.equals(authEnabled)) {\n+            graphiQLHandler.graphiQLRequestHeaders(rc -> {\n+                MultiMap multiMap = MultiMap.caseInsensitiveMultiMap();\n+                String token = getCurrentAccessToken(rc);\n+                if (token.isEmpty()) {\n+                    token = rc.request().getHeader(HttpHeaders.AUTHORIZATION);\n+                }\n+                multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_ORIGIN, \"*\");\n+                multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS, \"true\");\n+                multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_HEADERS, \"Authorization, Content-Type, Accept\");\n+                multiMap.add(\"Bearer-token\", \"Bearer \" + token);\n+                rc.request().headers().addAll(multiMap);\n+                return multiMap.add(HttpHeaders.AUTHORIZATION, \"Bearer \" + token);\n+            });\n         }\n+        router.route(\"/graphiql/*\").handler(graphiQLHandler);\n+        router.route().handler(LoggerHandler.create());\n+        router.route().handler(StaticHandler.create());\n+        router.route().handler(FaviconHandler.create());\n+        router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n         router.route(\"/graphql\").handler(ApolloWSHandler.create(graphQL));\n         router.route(\"/graphql\").handler(GraphQLHandler.create(graphQL, new GraphQLHandlerOptions()));\n     }\n+\n+    private String getCurrentAccessToken(RoutingContext routingContext) {\n+        if ((routingContext.user() != null) &&\n+                ((QuarkusHttpUser) routingContext.user()).getSecurityIdentity() != null &&\n+                ((QuarkusHttpUser) routingContext.user()).getSecurityIdentity().getCredential(AccessTokenCredential.class) != null) {\n+            return ((QuarkusHttpUser) routingContext.user()).getSecurityIdentity().getCredential(AccessTokenCredential.class).getToken();\n+        }\n+        return \"\";\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAyMDMyNw=="}, "originalCommit": {"oid": "9c94276237755eb4f2c55f2f09ee82a811aee743"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzMDEzNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    router.route(graphUIPath +\"*\").handler(graphiQLHandler);\n          \n          \n            \n                    router.route(graphUIPath + \"*\").handler(graphiQLHandler);", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444630136", "createdAt": "2020-06-24T03:55:21Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -39,18 +47,47 @@\n     @ConfigProperty(name = \"quarkus.oidc.enabled\", defaultValue = \"false\")\n     Boolean authEnabled;\n \n+    @Inject\n+    @ConfigProperty(name = \"kogito.data-index.vertx-graphql.ui.path\", defaultValue = \"/graphiql\")\n+    String graphUIPath;\n+\n     @Inject\n     GraphQL graphQL;\n \n     void setupRouter(@Observes Router router) {\n-        if (Boolean.FALSE.equals(authEnabled)) {\n-            router.route(\"/graphiql/*\").handler(GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true)));\n-            router.route().handler(LoggerHandler.create());\n-            router.route().handler(StaticHandler.create());\n-            router.route().handler(FaviconHandler.create());\n-            router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n+        GraphiQLHandler graphiQLHandler = GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true));\n+        if (Boolean.TRUE.equals(authEnabled)) {\n+            addGraphiqlRequestHeader(graphiQLHandler);\n         }\n+        router.route(graphUIPath +\"*\").handler(graphiQLHandler);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzMTE2MQ==", "bodyText": "@nmirasch I think you don't need to set the headers manually, simply return the multimap that vertx will add it automatically?", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444631161", "createdAt": "2020-06-24T03:59:35Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -39,18 +47,47 @@\n     @ConfigProperty(name = \"quarkus.oidc.enabled\", defaultValue = \"false\")\n     Boolean authEnabled;\n \n+    @Inject\n+    @ConfigProperty(name = \"kogito.data-index.vertx-graphql.ui.path\", defaultValue = \"/graphiql\")\n+    String graphUIPath;\n+\n     @Inject\n     GraphQL graphQL;\n \n     void setupRouter(@Observes Router router) {\n-        if (Boolean.FALSE.equals(authEnabled)) {\n-            router.route(\"/graphiql/*\").handler(GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true)));\n-            router.route().handler(LoggerHandler.create());\n-            router.route().handler(StaticHandler.create());\n-            router.route().handler(FaviconHandler.create());\n-            router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n+        GraphiQLHandler graphiQLHandler = GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true));\n+        if (Boolean.TRUE.equals(authEnabled)) {\n+            addGraphiqlRequestHeader(graphiQLHandler);\n         }\n+        router.route(graphUIPath +\"*\").handler(graphiQLHandler);\n+        router.route().handler(LoggerHandler.create());\n+        router.route().handler(StaticHandler.create());\n+        router.route().handler(FaviconHandler.create());\n+        router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", graphUIPath).setStatusCode(302).end());\n         router.route(\"/graphql\").handler(ApolloWSHandler.create(graphQL));\n         router.route(\"/graphql\").handler(GraphQLHandler.create(graphQL, new GraphQLHandlerOptions()));\n     }\n+\n+    protected void addGraphiqlRequestHeader(GraphiQLHandler graphiQLHandler ){\n+        graphiQLHandler.graphiQLRequestHeaders(rc -> {\n+            MultiMap multiMap = MultiMap.caseInsensitiveMultiMap();\n+            String token = getCurrentAccessToken(rc);\n+            if (token.isEmpty()) {\n+                token = rc.request().getHeader(HttpHeaders.AUTHORIZATION);\n+            }\n+            multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_ORIGIN, \"*\");\n+            multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS, \"true\");\n+            multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_HEADERS, \"Authorization, Content-Type, Accept\");\n+            multiMap.add(\"Bearer-token\", \"Bearer \" + token);\n+            rc.request().headers().addAll(multiMap);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzMjEzMg==", "bodyText": "Do we also need this one, isnt just the AUTHORIZATION header the one used to authenticate?", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444632132", "createdAt": "2020-06-24T04:03:53Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -39,18 +47,47 @@\n     @ConfigProperty(name = \"quarkus.oidc.enabled\", defaultValue = \"false\")\n     Boolean authEnabled;\n \n+    @Inject\n+    @ConfigProperty(name = \"kogito.data-index.vertx-graphql.ui.path\", defaultValue = \"/graphiql\")\n+    String graphUIPath;\n+\n     @Inject\n     GraphQL graphQL;\n \n     void setupRouter(@Observes Router router) {\n-        if (Boolean.FALSE.equals(authEnabled)) {\n-            router.route(\"/graphiql/*\").handler(GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true)));\n-            router.route().handler(LoggerHandler.create());\n-            router.route().handler(StaticHandler.create());\n-            router.route().handler(FaviconHandler.create());\n-            router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n+        GraphiQLHandler graphiQLHandler = GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true));\n+        if (Boolean.TRUE.equals(authEnabled)) {\n+            addGraphiqlRequestHeader(graphiQLHandler);\n         }\n+        router.route(graphUIPath +\"*\").handler(graphiQLHandler);\n+        router.route().handler(LoggerHandler.create());\n+        router.route().handler(StaticHandler.create());\n+        router.route().handler(FaviconHandler.create());\n+        router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", graphUIPath).setStatusCode(302).end());\n         router.route(\"/graphql\").handler(ApolloWSHandler.create(graphQL));\n         router.route(\"/graphql\").handler(GraphQLHandler.create(graphQL, new GraphQLHandlerOptions()));\n     }\n+\n+    protected void addGraphiqlRequestHeader(GraphiQLHandler graphiQLHandler ){\n+        graphiQLHandler.graphiQLRequestHeaders(rc -> {\n+            MultiMap multiMap = MultiMap.caseInsensitiveMultiMap();\n+            String token = getCurrentAccessToken(rc);\n+            if (token.isEmpty()) {\n+                token = rc.request().getHeader(HttpHeaders.AUTHORIZATION);\n+            }\n+            multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_ORIGIN, \"*\");\n+            multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_CREDENTIALS, \"true\");\n+            multiMap.add(HttpHeaders.ACCESS_CONTROL_ALLOW_HEADERS, \"Authorization, Content-Type, Accept\");\n+            multiMap.add(\"Bearer-token\", \"Bearer \" + token);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzMjM3NQ==", "bodyText": "@nmirasch when you get token like this wouldnt it contain the starting string \"Bearer \" ?", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444632375", "createdAt": "2020-06-24T04:04:57Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -39,18 +47,47 @@\n     @ConfigProperty(name = \"quarkus.oidc.enabled\", defaultValue = \"false\")\n     Boolean authEnabled;\n \n+    @Inject\n+    @ConfigProperty(name = \"kogito.data-index.vertx-graphql.ui.path\", defaultValue = \"/graphiql\")\n+    String graphUIPath;\n+\n     @Inject\n     GraphQL graphQL;\n \n     void setupRouter(@Observes Router router) {\n-        if (Boolean.FALSE.equals(authEnabled)) {\n-            router.route(\"/graphiql/*\").handler(GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true)));\n-            router.route().handler(LoggerHandler.create());\n-            router.route().handler(StaticHandler.create());\n-            router.route().handler(FaviconHandler.create());\n-            router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n+        GraphiQLHandler graphiQLHandler = GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true));\n+        if (Boolean.TRUE.equals(authEnabled)) {\n+            addGraphiqlRequestHeader(graphiQLHandler);\n         }\n+        router.route(graphUIPath +\"*\").handler(graphiQLHandler);\n+        router.route().handler(LoggerHandler.create());\n+        router.route().handler(StaticHandler.create());\n+        router.route().handler(FaviconHandler.create());\n+        router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", graphUIPath).setStatusCode(302).end());\n         router.route(\"/graphql\").handler(ApolloWSHandler.create(graphQL));\n         router.route(\"/graphql\").handler(GraphQLHandler.create(graphQL, new GraphQLHandlerOptions()));\n     }\n+\n+    protected void addGraphiqlRequestHeader(GraphiQLHandler graphiQLHandler ){\n+        graphiQLHandler.graphiQLRequestHeaders(rc -> {\n+            MultiMap multiMap = MultiMap.caseInsensitiveMultiMap();\n+            String token = getCurrentAccessToken(rc);\n+            if (token.isEmpty()) {\n+                token = rc.request().getHeader(HttpHeaders.AUTHORIZATION);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzMzEwMQ==", "bodyText": "@nmirasch just curious why do we need to use lenient in these tests?", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444633101", "createdAt": "2020-06-24T04:08:07Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/auth/MultiTenantResolverTest.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.auth;\n+\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.RoutingContext;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.lenient;\n+\n+\n+@ExtendWith(MockitoExtension.class)\n+class MultiTenantResolverTest {\n+\n+    private static final String GRAPH_UI_PATH = System.getProperty(\"kogito.data-index.vertx-graphql.ui.path\", \"/graphiql\");\n+    private static final String GRAPH_UI_TENANT = System.getProperty(\"kogito.data-index.vertx-graphql.ui.tenant\", \"web-app-tenant\");\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    HttpServerRequest requestMock;\n+\n+    @InjectMocks\n+    MultiTenantResolver multiTenantResolver;\n+\n+    @BeforeEach\n+    public void setup(){\n+        lenient().when(routingContextMock.request()).thenReturn(requestMock);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzMzg5Nw==", "bodyText": "@nmirasch I got confused here, are we just running the same get request twice?", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444633897", "createdAt": "2020-06-24T04:11:44Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -31,18 +31,18 @@\n @QuarkusTestResource(DataIndexInfinispanServerTestResource.class)\n public class KeycloakIntegrationIndexingServiceIT {\n \n-    private static final String KEYCLOAK_SERVER_URL = System.getProperty(\"keycloak.url\", \"http://localhost:8281/auth\");\n-    private static final String KEYCLOAK_REALM = \"kogito\";\n-    private static final String KEYCLOAK_CLIENT_ID = \"kogito-data-index-service\";\n+    private static final String KEYCLOAK_SERVER_URL = System.getProperty(\"quarkus.oidc.auth-server-url\", \"http://localhost:8281/auth/realms/kogito\");\n+    private static final String KEYCLOAK_CLIENT_ID = System.getProperty(\"quarkus.oidc.client-id\", \"kogito-data-index-service\");\n+    private static final String KEYCLOAK_CLIENT_SECRET = System.getProperty(\"quarkus.oidc.credentials.secret\", \"secret\");\n \n     @Test\n     public void testUnauthorizedUserAccess() {\n         //alice only have role User, resource is forbidden\n-        given().auth().oauth2(getAccessToken(\"alice\"))\n-                .when().get(\"/graphiql/\")\n+        given().contentType(ContentType.JSON).body(\"{ \\\"query\\\" : \\\"{ProcessInstances{ id } }\\\" }\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNDQ2NQ==", "bodyText": "@nmirasch can we perhaps validate something in the body of the response that it actually redirected to Keycloack login page?", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444634465", "createdAt": "2020-06-24T04:14:00Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -66,27 +70,38 @@ public void testNoTokenProvided() {\n     @Test\n     public void testAuthorizedUserProvided() {\n         //jdoe has role:user and confidential, resource served\n-        given().auth().oauth2(getAccessToken(\"jdoe\"))\n-                .when().get(\"/graphiql/\")\n-                .then()\n-                .statusCode(404);\n-\n         given().auth().oauth2(getAccessToken(\"jdoe\"))\n                 .contentType(ContentType.JSON)\n                 .body(\"{ \\\"query\\\" : \\\"{ProcessInstances{ id } }\\\" }\")\n                 .when().post(\"/graphql\")\n                 .then().log().ifValidationFails().statusCode(200);\n     }\n \n+    @Test\n+    public void graphiqlLoginOnKeycloackServedTest(){\n+        // Returning keycloak login page\n+        given().when().get(\"/graphiql/\")\n+                .then()\n+                .statusCode(200);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM0ODUxNA=="}, "originalCommit": {"oid": "f19843236009e0554d187eaeb530c2a62936c547"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNDcwOQ==", "bodyText": "not sure I get the point to check this endpoint as it will always return 404, with or without security :)", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444634709", "createdAt": "2020-06-24T04:14:58Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -65,27 +61,38 @@ public void testNoTokenProvided() {\n     @Test\n     public void testAuthorizedUserProvided() {\n         //jdoe has role:user and confidential, resource served\n-        given().auth().oauth2(getAccessToken(\"jdoe\"))\n-                .when().get(\"/graphiql/\")\n-                .then()\n-                .statusCode(404);\n-\n         given().auth().oauth2(getAccessToken(\"jdoe\"))\n                 .contentType(ContentType.JSON)\n                 .body(\"{ \\\"query\\\" : \\\"{ProcessInstances{ id } }\\\" }\")\n                 .when().post(\"/graphql\")\n                 .then().log().ifValidationFails().statusCode(200);\n     }\n \n+    @Test\n+    public void graphiqlLoginOnKeycloakServedTest() {\n+        // Returning keycloak login page\n+        given().when().get(\"/graphiql/\")\n+                .then()\n+                .statusCode(200);\n+        // Returning keycloak login page\n+        given().auth().oauth2(getAccessToken(\"jdoe\"))\n+                .when().get(\"/graphiql/\")\n+                .then()\n+                .statusCode(200);\n+        given().when().get(\"/other/\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNDk0NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    vertxRouterSetup.graphUIPath=\"/graphiql\";\n          \n          \n            \n                    vertxRouterSetup.graphUIPath = \"/graphiql\";", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444634944", "createdAt": "2020-06-24T04:15:57Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/vertx/VertxRouterSetupTest.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.vertx;\n+\n+\n+import java.util.function.Function;\n+\n+import graphql.GraphQL;\n+\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.Route;\n+import io.vertx.ext.web.Router;\n+\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.graphql.GraphiQLHandler;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+\n+import static org.mockito.Mockito.lenient;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class VertxRouterSetupTest {\n+    @Mock\n+    Router routerMock;\n+\n+    @Mock\n+    Route routeMock;\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    GraphQL graphQLMock;\n+\n+    @InjectMocks\n+    @Spy\n+    VertxRouterSetup vertxRouterSetup;\n+\n+    @BeforeEach\n+    public void setup(){\n+        lenient().when(routerMock.route()).thenReturn(routeMock);\n+        lenient().when(routerMock.route(anyString())).thenReturn(routeMock);\n+    }\n+\n+    @Test\n+    public void testAuthEnabledTrue() {\n+        vertxRouterSetup.authEnabled = true;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNTAyNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    vertxRouterSetup.graphUIPath=\"/graphiql\";\n          \n          \n            \n                    vertxRouterSetup.graphUIPath = \"/graphiql\";", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444635025", "createdAt": "2020-06-24T04:16:20Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/vertx/VertxRouterSetupTest.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.vertx;\n+\n+\n+import java.util.function.Function;\n+\n+import graphql.GraphQL;\n+\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.Route;\n+import io.vertx.ext.web.Router;\n+\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.graphql.GraphiQLHandler;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+\n+import static org.mockito.Mockito.lenient;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class VertxRouterSetupTest {\n+    @Mock\n+    Router routerMock;\n+\n+    @Mock\n+    Route routeMock;\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    GraphQL graphQLMock;\n+\n+    @InjectMocks\n+    @Spy\n+    VertxRouterSetup vertxRouterSetup;\n+\n+    @BeforeEach\n+    public void setup(){\n+        lenient().when(routerMock.route()).thenReturn(routeMock);\n+        lenient().when(routerMock.route(anyString())).thenReturn(routeMock);\n+    }\n+\n+    @Test\n+    public void testAuthEnabledTrue() {\n+        vertxRouterSetup.authEnabled = true;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup).addGraphiqlRequestHeader(any());\n+    }\n+\n+    @Test\n+    public void testAuthEnabledFalse() {\n+        vertxRouterSetup.authEnabled = false;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNTA2Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    verify(vertxRouterSetup,never()).addGraphiqlRequestHeader(any());\n          \n          \n            \n                    verify(vertxRouterSetup, never()).addGraphiqlRequestHeader(any());", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444635066", "createdAt": "2020-06-24T04:16:31Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/vertx/VertxRouterSetupTest.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.vertx;\n+\n+\n+import java.util.function.Function;\n+\n+import graphql.GraphQL;\n+\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.Route;\n+import io.vertx.ext.web.Router;\n+\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.graphql.GraphiQLHandler;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+\n+import static org.mockito.Mockito.lenient;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class VertxRouterSetupTest {\n+    @Mock\n+    Router routerMock;\n+\n+    @Mock\n+    Route routeMock;\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    GraphQL graphQLMock;\n+\n+    @InjectMocks\n+    @Spy\n+    VertxRouterSetup vertxRouterSetup;\n+\n+    @BeforeEach\n+    public void setup(){\n+        lenient().when(routerMock.route()).thenReturn(routeMock);\n+        lenient().when(routerMock.route(anyString())).thenReturn(routeMock);\n+    }\n+\n+    @Test\n+    public void testAuthEnabledTrue() {\n+        vertxRouterSetup.authEnabled = true;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup).addGraphiqlRequestHeader(any());\n+    }\n+\n+    @Test\n+    public void testAuthEnabledFalse() {\n+        vertxRouterSetup.authEnabled = false;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup,never()).addGraphiqlRequestHeader(any());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNTE5Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ArgumentCaptor<MultiMap> multimapCaptor =ArgumentCaptor.forClass(MultiMap.class);\n          \n          \n            \n                    ArgumentCaptor<MultiMap> multimapCaptor = ArgumentCaptor.forClass(MultiMap.class);", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444635196", "createdAt": "2020-06-24T04:17:10Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/vertx/VertxRouterSetupTest.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.vertx;\n+\n+\n+import java.util.function.Function;\n+\n+import graphql.GraphQL;\n+\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.Route;\n+import io.vertx.ext.web.Router;\n+\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.graphql.GraphiQLHandler;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+\n+import static org.mockito.Mockito.lenient;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class VertxRouterSetupTest {\n+    @Mock\n+    Router routerMock;\n+\n+    @Mock\n+    Route routeMock;\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    GraphQL graphQLMock;\n+\n+    @InjectMocks\n+    @Spy\n+    VertxRouterSetup vertxRouterSetup;\n+\n+    @BeforeEach\n+    public void setup(){\n+        lenient().when(routerMock.route()).thenReturn(routeMock);\n+        lenient().when(routerMock.route(anyString())).thenReturn(routeMock);\n+    }\n+\n+    @Test\n+    public void testAuthEnabledTrue() {\n+        vertxRouterSetup.authEnabled = true;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup).addGraphiqlRequestHeader(any());\n+    }\n+\n+    @Test\n+    public void testAuthEnabledFalse() {\n+        vertxRouterSetup.authEnabled = false;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup,never()).addGraphiqlRequestHeader(any());\n+    }\n+\n+    @Test\n+    public void testAddGraphiqlRequestHeader() {\n+        GraphiQLHandler graphiQLHandlerMock = mock(GraphiQLHandler.class);\n+        HttpServerRequest requestMock = mock(HttpServerRequest.class);\n+        MultiMap multiMapMock = mock(MultiMap.class);\n+        String token = \"TEST_TOKEN\";\n+        when(routingContextMock.request()).thenReturn(requestMock);\n+        when(requestMock.getHeader(HttpHeaders.AUTHORIZATION)).thenReturn(token);\n+        when(requestMock.headers()).thenReturn(multiMapMock);\n+\n+        vertxRouterSetup.addGraphiqlRequestHeader(graphiQLHandlerMock);\n+\n+        ArgumentCaptor<Function<RoutingContext, MultiMap>> functionCaptor =ArgumentCaptor.forClass(Function.class);\n+        verify(graphiQLHandlerMock).graphiQLRequestHeaders(functionCaptor.capture());\n+        functionCaptor.getValue().apply(routingContextMock);\n+\n+        ArgumentCaptor<MultiMap> multimapCaptor =ArgumentCaptor.forClass(MultiMap.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNTIxOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ArgumentCaptor<Function<RoutingContext, MultiMap>> functionCaptor =ArgumentCaptor.forClass(Function.class);\n          \n          \n            \n                    ArgumentCaptor<Function<RoutingContext, MultiMap>> functionCaptor = ArgumentCaptor.forClass(Function.class);", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444635219", "createdAt": "2020-06-24T04:17:17Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/vertx/VertxRouterSetupTest.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.vertx;\n+\n+\n+import java.util.function.Function;\n+\n+import graphql.GraphQL;\n+\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.Route;\n+import io.vertx.ext.web.Router;\n+\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.graphql.GraphiQLHandler;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+\n+import static org.mockito.Mockito.lenient;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class VertxRouterSetupTest {\n+    @Mock\n+    Router routerMock;\n+\n+    @Mock\n+    Route routeMock;\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    GraphQL graphQLMock;\n+\n+    @InjectMocks\n+    @Spy\n+    VertxRouterSetup vertxRouterSetup;\n+\n+    @BeforeEach\n+    public void setup(){\n+        lenient().when(routerMock.route()).thenReturn(routeMock);\n+        lenient().when(routerMock.route(anyString())).thenReturn(routeMock);\n+    }\n+\n+    @Test\n+    public void testAuthEnabledTrue() {\n+        vertxRouterSetup.authEnabled = true;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup).addGraphiqlRequestHeader(any());\n+    }\n+\n+    @Test\n+    public void testAuthEnabledFalse() {\n+        vertxRouterSetup.authEnabled = false;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup,never()).addGraphiqlRequestHeader(any());\n+    }\n+\n+    @Test\n+    public void testAddGraphiqlRequestHeader() {\n+        GraphiQLHandler graphiQLHandlerMock = mock(GraphiQLHandler.class);\n+        HttpServerRequest requestMock = mock(HttpServerRequest.class);\n+        MultiMap multiMapMock = mock(MultiMap.class);\n+        String token = \"TEST_TOKEN\";\n+        when(routingContextMock.request()).thenReturn(requestMock);\n+        when(requestMock.getHeader(HttpHeaders.AUTHORIZATION)).thenReturn(token);\n+        when(requestMock.headers()).thenReturn(multiMapMock);\n+\n+        vertxRouterSetup.addGraphiqlRequestHeader(graphiQLHandlerMock);\n+\n+        ArgumentCaptor<Function<RoutingContext, MultiMap>> functionCaptor =ArgumentCaptor.forClass(Function.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNTg4Mg==", "bodyText": "@nmirasch I think it makes sense to also test when the token is provided by the request headers. perhaps a new test method?", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444635882", "createdAt": "2020-06-24T04:20:25Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/vertx/VertxRouterSetupTest.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.vertx;\n+\n+\n+import java.util.function.Function;\n+\n+import graphql.GraphQL;\n+\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.Route;\n+import io.vertx.ext.web.Router;\n+\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.graphql.GraphiQLHandler;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+\n+import static org.mockito.Mockito.lenient;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class VertxRouterSetupTest {\n+    @Mock\n+    Router routerMock;\n+\n+    @Mock\n+    Route routeMock;\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    GraphQL graphQLMock;\n+\n+    @InjectMocks\n+    @Spy\n+    VertxRouterSetup vertxRouterSetup;\n+\n+    @BeforeEach\n+    public void setup(){\n+        lenient().when(routerMock.route()).thenReturn(routeMock);\n+        lenient().when(routerMock.route(anyString())).thenReturn(routeMock);\n+    }\n+\n+    @Test\n+    public void testAuthEnabledTrue() {\n+        vertxRouterSetup.authEnabled = true;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup).addGraphiqlRequestHeader(any());\n+    }\n+\n+    @Test\n+    public void testAuthEnabledFalse() {\n+        vertxRouterSetup.authEnabled = false;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup,never()).addGraphiqlRequestHeader(any());\n+    }\n+\n+    @Test\n+    public void testAddGraphiqlRequestHeader() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNjEzNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertThat(multimapCaptor.getValue().get(HttpHeaders.AUTHORIZATION).equals(\"Bearer \" + token));\n          \n          \n            \n                    assertThat(multimapCaptor.getValue().get(HttpHeaders.AUTHORIZATION)).isEqualTo(\"Bearer \" + token);", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444636136", "createdAt": "2020-06-24T04:21:30Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/vertx/VertxRouterSetupTest.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.vertx;\n+\n+\n+import java.util.function.Function;\n+\n+import graphql.GraphQL;\n+\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpHeaders;\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.Route;\n+import io.vertx.ext.web.Router;\n+\n+import io.vertx.ext.web.RoutingContext;\n+import io.vertx.ext.web.handler.graphql.GraphiQLHandler;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.Spy;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+\n+import static org.mockito.Mockito.lenient;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(MockitoExtension.class)\n+public class VertxRouterSetupTest {\n+    @Mock\n+    Router routerMock;\n+\n+    @Mock\n+    Route routeMock;\n+\n+    @Mock\n+    RoutingContext routingContextMock;\n+\n+    @Mock\n+    GraphQL graphQLMock;\n+\n+    @InjectMocks\n+    @Spy\n+    VertxRouterSetup vertxRouterSetup;\n+\n+    @BeforeEach\n+    public void setup(){\n+        lenient().when(routerMock.route()).thenReturn(routeMock);\n+        lenient().when(routerMock.route(anyString())).thenReturn(routeMock);\n+    }\n+\n+    @Test\n+    public void testAuthEnabledTrue() {\n+        vertxRouterSetup.authEnabled = true;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup).addGraphiqlRequestHeader(any());\n+    }\n+\n+    @Test\n+    public void testAuthEnabledFalse() {\n+        vertxRouterSetup.authEnabled = false;\n+        vertxRouterSetup.graphUIPath=\"/graphiql\";\n+        vertxRouterSetup.setupRouter(routerMock);\n+\n+        verify(vertxRouterSetup,never()).addGraphiqlRequestHeader(any());\n+    }\n+\n+    @Test\n+    public void testAddGraphiqlRequestHeader() {\n+        GraphiQLHandler graphiQLHandlerMock = mock(GraphiQLHandler.class);\n+        HttpServerRequest requestMock = mock(HttpServerRequest.class);\n+        MultiMap multiMapMock = mock(MultiMap.class);\n+        String token = \"TEST_TOKEN\";\n+        when(routingContextMock.request()).thenReturn(requestMock);\n+        when(requestMock.getHeader(HttpHeaders.AUTHORIZATION)).thenReturn(token);\n+        when(requestMock.headers()).thenReturn(multiMapMock);\n+\n+        vertxRouterSetup.addGraphiqlRequestHeader(graphiQLHandlerMock);\n+\n+        ArgumentCaptor<Function<RoutingContext, MultiMap>> functionCaptor =ArgumentCaptor.forClass(Function.class);\n+        verify(graphiQLHandlerMock).graphiQLRequestHeaders(functionCaptor.capture());\n+        functionCaptor.getValue().apply(routingContextMock);\n+\n+        ArgumentCaptor<MultiMap> multimapCaptor =ArgumentCaptor.forClass(MultiMap.class);\n+        verify(multiMapMock).addAll(multimapCaptor.capture());\n+\n+        assertThat(multimapCaptor.getValue().get(HttpHeaders.AUTHORIZATION).equals(\"Bearer \" + token));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzNzE3OA==", "bodyText": "do we actually need or is there a situation where the user could get to the GraphiQL UI and not be logged in or have access to it via a token in the authorization header? Perhaps we can simply send the current access token all the time?", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r444637178", "createdAt": "2020-06-24T04:26:40Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -39,18 +47,47 @@\n     @ConfigProperty(name = \"quarkus.oidc.enabled\", defaultValue = \"false\")\n     Boolean authEnabled;\n \n+    @Inject\n+    @ConfigProperty(name = \"kogito.data-index.vertx-graphql.ui.path\", defaultValue = \"/graphiql\")\n+    String graphUIPath;\n+\n     @Inject\n     GraphQL graphQL;\n \n     void setupRouter(@Observes Router router) {\n-        if (Boolean.FALSE.equals(authEnabled)) {\n-            router.route(\"/graphiql/*\").handler(GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true)));\n-            router.route().handler(LoggerHandler.create());\n-            router.route().handler(StaticHandler.create());\n-            router.route().handler(FaviconHandler.create());\n-            router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n+        GraphiQLHandler graphiQLHandler = GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true));\n+        if (Boolean.TRUE.equals(authEnabled)) {\n+            addGraphiqlRequestHeader(graphiQLHandler);\n         }\n+        router.route(graphUIPath +\"*\").handler(graphiQLHandler);\n+        router.route().handler(LoggerHandler.create());\n+        router.route().handler(StaticHandler.create());\n+        router.route().handler(FaviconHandler.create());\n+        router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", graphUIPath).setStatusCode(302).end());\n         router.route(\"/graphql\").handler(ApolloWSHandler.create(graphQL));\n         router.route(\"/graphql\").handler(GraphQLHandler.create(graphQL, new GraphQLHandlerOptions()));\n     }\n+\n+    protected void addGraphiqlRequestHeader(GraphiQLHandler graphiQLHandler ){\n+        graphiQLHandler.graphiQLRequestHeaders(rc -> {\n+            MultiMap multiMap = MultiMap.caseInsensitiveMultiMap();\n+            String token = getCurrentAccessToken(rc);\n+            if (token.isEmpty()) {\n+                token = rc.request().getHeader(HttpHeaders.AUTHORIZATION);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzMjM3NQ=="}, "originalCommit": {"oid": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f"}, "originalPosition": 64}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6b86fd67f7c5448e92ad57a7d3cf974c79f2592f", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/6b86fd67f7c5448e92ad57a7d3cf974c79f2592f", "committedDate": "2020-06-22T11:38:24Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}, "afterCommit": {"oid": "13723fe87a6015be833315f2d972490c32ad857a", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/13723fe87a6015be833315f2d972490c32ad857a", "committedDate": "2020-06-25T08:00:23Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "13723fe87a6015be833315f2d972490c32ad857a", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/13723fe87a6015be833315f2d972490c32ad857a", "committedDate": "2020-06-25T08:00:23Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)."}, "afterCommit": {"oid": "521228264d4da58c0af6b75cc44046deedc98ba3", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/521228264d4da58c0af6b75cc44046deedc98ba3", "committedDate": "2020-06-25T08:36:12Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "521228264d4da58c0af6b75cc44046deedc98ba3", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/521228264d4da58c0af6b75cc44046deedc98ba3", "committedDate": "2020-06-25T08:36:12Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)."}, "afterCommit": {"oid": "40dbe4135ad6bdea4d8d883c517d5804ef3c381a", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/40dbe4135ad6bdea4d8d883c517d5804ef3c381a", "committedDate": "2020-06-29T11:23:46Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MDYxMzI5", "url": "https://github.com/kiegroup/kogito-apps/pull/241#pullrequestreview-439061329", "createdAt": "2020-06-29T11:50:11Z", "commit": {"oid": "40dbe4135ad6bdea4d8d883c517d5804ef3c381a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMTo1MDoxMVrOGqNNuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMTo1MDoxMVrOGqNNuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkwOTg4MQ==", "bodyText": "@nmirasch Can this be a reusable utils function instead of duplicating it?", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r446909881", "createdAt": "2020-06-29T11:50:11Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -39,18 +47,46 @@\n     @ConfigProperty(name = \"quarkus.oidc.enabled\", defaultValue = \"false\")\n     Boolean authEnabled;\n \n+    @Inject\n+    @ConfigProperty(name = \"kogito.data-index.vertx-graphql.ui.path\", defaultValue = \"/graphiql\")\n+    String graphUIPath;\n+\n     @Inject\n     GraphQL graphQL;\n \n     void setupRouter(@Observes Router router) {\n-        if (Boolean.FALSE.equals(authEnabled)) {\n-            router.route(\"/graphiql/*\").handler(GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true)));\n-            router.route().handler(LoggerHandler.create());\n-            router.route().handler(StaticHandler.create());\n-            router.route().handler(FaviconHandler.create());\n-            router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n+        GraphiQLHandler graphiQLHandler = GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true));\n+        if (Boolean.TRUE.equals(authEnabled)) {\n+            addGraphiqlRequestHeader(graphiQLHandler);\n         }\n+        router.route(graphUIPath + \"*\").handler(graphiQLHandler);\n+        router.route().handler(LoggerHandler.create());\n+        router.route().handler(StaticHandler.create());\n+        router.route().handler(FaviconHandler.create());\n+        router.route(getGraphUIAllowedPath()).handler(ctx -> ctx.response().putHeader(\"location\", graphUIPath).setStatusCode(302).end());\n+        router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", graphUIPath).setStatusCode(302).end());\n         router.route(\"/graphql\").handler(ApolloWSHandler.create(graphQL));\n         router.route(\"/graphql\").handler(GraphQLHandler.create(graphQL, new GraphQLHandlerOptions()));\n     }\n+\n+    protected void addGraphiqlRequestHeader(GraphiQLHandler graphiQLHandler) {\n+        graphiQLHandler.graphiQLRequestHeaders(rc ->\n+                                                       MultiMap.caseInsensitiveMultiMap().add(HttpHeaders.AUTHORIZATION, \"Bearer \" + getCurrentAccessToken(rc))\n+        );\n+    }\n+\n+    private String getCurrentAccessToken(RoutingContext routingContext) {\n+        return Optional.ofNullable(routingContext.user())\n+                .map(user -> ((QuarkusHttpUser) user).getSecurityIdentity())\n+                .map(identity -> identity.getCredential(AccessTokenCredential.class))\n+                .map(AccessTokenCredential::getToken)\n+                .orElse(StringUtils.EMPTY);\n+    }\n+\n+    private String getGraphUIAllowedPath() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40dbe4135ad6bdea4d8d883c517d5804ef3c381a"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MDY5NzY2", "url": "https://github.com/kiegroup/kogito-apps/pull/241#pullrequestreview-439069766", "createdAt": "2020-06-29T12:01:07Z", "commit": {"oid": "40dbe4135ad6bdea4d8d883c517d5804ef3c381a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMjowMTowN1rOGqNlHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMjowMTowN1rOGqNlHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkxNTg3MQ==", "bodyText": "should the default be just /graphiql ?", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r446915871", "createdAt": "2020-06-29T12:01:07Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/auth/MultiTenantResolver.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.auth;\n+\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.inject.Inject;\n+\n+import io.quarkus.oidc.TenantResolver;\n+import io.vertx.ext.web.RoutingContext;\n+import org.eclipse.microprofile.config.inject.ConfigProperty;\n+\n+@ApplicationScoped\n+public class MultiTenantResolver implements TenantResolver {\n+\n+    @Inject\n+    @ConfigProperty(name = \"kogito.data-index.vertx-graphql.ui.path\", defaultValue = \"/graphiql/\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40dbe4135ad6bdea4d8d883c517d5804ef3c381a"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MDU3NzEz", "url": "https://github.com/kiegroup/kogito-apps/pull/241#pullrequestreview-439057713", "createdAt": "2020-06-29T11:45:26Z", "commit": {"oid": "40dbe4135ad6bdea4d8d883c517d5804ef3c381a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMTo0NToyN1rOGqNDhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMjowMzoxM1rOGqNp4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkwNzI2OA==", "bodyText": "If we provide the default values above, the graphUIPath and graphUITentantId will never be null.", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r446907268", "createdAt": "2020-06-29T11:45:27Z", "author": {"login": "Sgitario"}, "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/auth/MultiTenantResolver.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.auth;\n+\n+import javax.enterprise.context.ApplicationScoped;\n+import javax.inject.Inject;\n+\n+import io.quarkus.oidc.TenantResolver;\n+import io.vertx.ext.web.RoutingContext;\n+import org.eclipse.microprofile.config.inject.ConfigProperty;\n+\n+@ApplicationScoped\n+public class MultiTenantResolver implements TenantResolver {\n+\n+    @Inject\n+    @ConfigProperty(name = \"kogito.data-index.vertx-graphql.ui.path\", defaultValue = \"/graphiql/\")\n+    String graphUIPath;\n+\n+    @Inject\n+    @ConfigProperty(name = \"kogito.data-index.vertx-graphql.ui.tenant\", defaultValue = \"web-app-tenant\")\n+    String graphUITenantId;\n+\n+    @Override\n+    public String resolve(RoutingContext context) {\n+        if (graphUIPath != null\n+                && graphUITenantId != null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40dbe4135ad6bdea4d8d883c517d5804ef3c381a"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkxNzA5MA==", "bodyText": "In order to avoid duplicate code here, does it make sense to have something like:\nrouter.route(graphUIPath + \"*\").handler(setRootLocation());\nrouter.route(\"/\").handler(setRootLocation());\n// ...\n\nprotected Handler<RoutingContext> setRootLocation() {\n     return ctx -> ctx.response().putHeader(\"location\", graphUIPath).setStatusCode(302).end();\n}", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r446917090", "createdAt": "2020-06-29T12:03:13Z", "author": {"login": "Sgitario"}, "path": "data-index/data-index-service/src/main/java/org/kie/kogito/index/vertx/VertxRouterSetup.java", "diffHunk": "@@ -39,18 +47,46 @@\n     @ConfigProperty(name = \"quarkus.oidc.enabled\", defaultValue = \"false\")\n     Boolean authEnabled;\n \n+    @Inject\n+    @ConfigProperty(name = \"kogito.data-index.vertx-graphql.ui.path\", defaultValue = \"/graphiql\")\n+    String graphUIPath;\n+\n     @Inject\n     GraphQL graphQL;\n \n     void setupRouter(@Observes Router router) {\n-        if (Boolean.FALSE.equals(authEnabled)) {\n-            router.route(\"/graphiql/*\").handler(GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true)));\n-            router.route().handler(LoggerHandler.create());\n-            router.route().handler(StaticHandler.create());\n-            router.route().handler(FaviconHandler.create());\n-            router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", \"/graphiql/\").setStatusCode(302).end());\n+        GraphiQLHandler graphiQLHandler = GraphiQLHandler.create(new GraphiQLHandlerOptions().setEnabled(true));\n+        if (Boolean.TRUE.equals(authEnabled)) {\n+            addGraphiqlRequestHeader(graphiQLHandler);\n         }\n+        router.route(graphUIPath + \"*\").handler(graphiQLHandler);\n+        router.route().handler(LoggerHandler.create());\n+        router.route().handler(StaticHandler.create());\n+        router.route().handler(FaviconHandler.create());\n+        router.route(getGraphUIAllowedPath()).handler(ctx -> ctx.response().putHeader(\"location\", graphUIPath).setStatusCode(302).end());\n+        router.route(\"/\").handler(ctx -> ctx.response().putHeader(\"location\", graphUIPath).setStatusCode(302).end());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40dbe4135ad6bdea4d8d883c517d5804ef3c381a"}, "originalPosition": 55}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "40dbe4135ad6bdea4d8d883c517d5804ef3c381a", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/40dbe4135ad6bdea4d8d883c517d5804ef3c381a", "committedDate": "2020-06-29T11:23:46Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}, "afterCommit": {"oid": "0f9f281e2a387266e3cc778d4ca55532c9e0171b", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/0f9f281e2a387266e3cc778d4ca55532c9e0171b", "committedDate": "2020-06-29T16:20:00Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0f9f281e2a387266e3cc778d4ca55532c9e0171b", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/0f9f281e2a387266e3cc778d4ca55532c9e0171b", "committedDate": "2020-06-29T16:20:00Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}, "afterCommit": {"oid": "1de19d5bd9ae5285b7554e54f78a8499e754a68b", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/1de19d5bd9ae5285b7554e54f78a8499e754a68b", "committedDate": "2020-06-29T21:16:01Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5Njc3Mjcy", "url": "https://github.com/kiegroup/kogito-apps/pull/241#pullrequestreview-439677272", "createdAt": "2020-06-30T05:20:10Z", "commit": {"oid": "1de19d5bd9ae5285b7554e54f78a8499e754a68b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNToyMDoxMFrOGqsGUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNToyMDo0N1rOGqsHAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQxNTg4OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final String GRAPH_UI_PATH = System.getProperty(\"kogito.data-index.vertx-graphql.ui.path\", \"/graphiql/\");\n          \n          \n            \n                private static final String GRAPH_UI_PATH = System.getProperty(\"kogito.data-index.vertx-graphql.ui.path\", \"/graphiql\");", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r447415888", "createdAt": "2020-06-30T05:20:10Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/auth/MultiTenantResolverTest.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.index.auth;\n+\n+import io.vertx.core.http.HttpServerRequest;\n+import io.vertx.ext.web.RoutingContext;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import org.mockito.InjectMocks;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.when;\n+\n+@ExtendWith(MockitoExtension.class)\n+class MultiTenantResolverTest {\n+\n+    private static final String GRAPH_UI_PATH = System.getProperty(\"kogito.data-index.vertx-graphql.ui.path\", \"/graphiql/\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1de19d5bd9ae5285b7554e54f78a8499e754a68b"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQxNjA2NQ==", "bodyText": "@nmirasch ^", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r447416065", "createdAt": "2020-06-30T05:20:47Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -66,27 +70,38 @@ public void testNoTokenProvided() {\n     @Test\n     public void testAuthorizedUserProvided() {\n         //jdoe has role:user and confidential, resource served\n-        given().auth().oauth2(getAccessToken(\"jdoe\"))\n-                .when().get(\"/graphiql/\")\n-                .then()\n-                .statusCode(404);\n-\n         given().auth().oauth2(getAccessToken(\"jdoe\"))\n                 .contentType(ContentType.JSON)\n                 .body(\"{ \\\"query\\\" : \\\"{ProcessInstances{ id } }\\\" }\")\n                 .when().post(\"/graphql\")\n                 .then().log().ifValidationFails().statusCode(200);\n     }\n \n+    @Test\n+    public void graphiqlLoginOnKeycloackServedTest(){\n+        // Returning keycloak login page\n+        given().when().get(\"/graphiql/\")\n+                .then()\n+                .statusCode(200);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM0ODUxNA=="}, "originalCommit": {"oid": "f19843236009e0554d187eaeb530c2a62936c547"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5Njc3ODgx", "url": "https://github.com/kiegroup/kogito-apps/pull/241#pullrequestreview-439677881", "createdAt": "2020-06-30T05:22:03Z", "commit": {"oid": "1de19d5bd9ae5285b7554e54f78a8499e754a68b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNToyMjowM1rOGqsIUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNToyMjowM1rOGqsIUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQxNjQwMQ==", "bodyText": "@nmirasch I think just this one needs some improvement. A 200 could also be returned if the auth is disabled right? Anything that checks that it actually reached the login page.", "url": "https://github.com/kiegroup/kogito-apps/pull/241#discussion_r447416401", "createdAt": "2020-06-30T05:22:03Z", "author": {"login": "cristianonicolai"}, "path": "data-index/data-index-service/src/test/java/org/kie/kogito/index/service/KeycloakIntegrationIndexingServiceIT.java", "diffHunk": "@@ -65,27 +56,43 @@ public void testNoTokenProvided() {\n     @Test\n     public void testAuthorizedUserProvided() {\n         //jdoe has role:user and confidential, resource served\n-        given().auth().oauth2(getAccessToken(\"jdoe\"))\n-                .when().get(\"/graphiql/\")\n-                .then()\n-                .statusCode(404);\n-\n         given().auth().oauth2(getAccessToken(\"jdoe\"))\n                 .contentType(ContentType.JSON)\n                 .body(\"{ \\\"query\\\" : \\\"{ProcessInstances{ id } }\\\" }\")\n                 .when().post(\"/graphql\")\n                 .then().log().ifValidationFails().statusCode(200);\n     }\n \n+    @Test\n+    public void graphiqlLoginOnKeycloakServedTest() {\n+        // Returning keycloak login page\n+        given().when().get(\"/graphiql/\")\n+                .then()\n+                .statusCode(200);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1de19d5bd9ae5285b7554e54f78a8499e754a68b"}, "originalPosition": 54}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1de19d5bd9ae5285b7554e54f78a8499e754a68b", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/1de19d5bd9ae5285b7554e54f78a8499e754a68b", "committedDate": "2020-06-29T21:16:01Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}, "afterCommit": {"oid": "69938b3bcee827779b54dd712e56381834a24a0e", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/69938b3bcee827779b54dd712e56381834a24a0e", "committedDate": "2020-06-30T09:15:20Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "646b063f89cefe51ad73395d5d494c503c2f6917", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/646b063f89cefe51ad73395d5d494c503c2f6917", "committedDate": "2020-06-30T09:17:56Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "69938b3bcee827779b54dd712e56381834a24a0e", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/69938b3bcee827779b54dd712e56381834a24a0e", "committedDate": "2020-06-30T09:15:20Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}, "afterCommit": {"oid": "646b063f89cefe51ad73395d5d494c503c2f6917", "author": {"user": {"login": "nmirasch", "name": null}}, "url": "https://github.com/kiegroup/kogito-apps/commit/646b063f89cefe51ad73395d5d494c503c2f6917", "committedDate": "2020-06-30T09:17:56Z", "message": "KOGITO-536: Data-index-service Keycloak integration: GraphiQL (UI)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5ODg5NTkw", "url": "https://github.com/kiegroup/kogito-apps/pull/241#pullrequestreview-439889590", "createdAt": "2020-06-30T10:37:56Z", "commit": {"oid": "646b063f89cefe51ad73395d5d494c503c2f6917"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 75, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}