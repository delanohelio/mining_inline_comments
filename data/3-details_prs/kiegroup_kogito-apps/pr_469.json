{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2NTE1Nzc5", "number": 469, "title": "[Jobs Service] reschedule operarion on patch API + attributes restriction", "bodyText": "Changes required by the management-console for job management.\n\nreschedule on patch\nrestrict attributes to be updated to only job timer triggers\nallow CORS on all http methods\n\nMany thanks for submitting your Pull Request \u2764\ufe0f!\nPlease make sure that your PR meets the following requirements:\n\n You have read the contributors guide\n Pull Request title is properly formatted: KOGITO-XYZ Subject\n Pull Request title contains the target branch if not targeting master: [0.9.x] KOGITO-XYZ Subject\n Pull Request contains link to the JIRA issue\n Pull Request contains link to any dependent or related Pull Request\n Pull Request contains description of the issue\n Pull Request does not include fixes for issues other than the main ticket", "createdAt": "2020-10-01T20:04:39Z", "url": "https://github.com/kiegroup/kogito-apps/pull/469", "merged": true, "mergeCommit": {"oid": "d02f7700cf3924377e601207a504e1be29c25318"}, "closed": true, "closedAt": "2020-10-06T14:39:19Z", "author": {"login": "tiagodolphine"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdObgVoAFqTUwMDgxMTA0OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPl5oSABqjM4NDEyMTg1NTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwODExMDQ4", "url": "https://github.com/kiegroup/kogito-apps/pull/469#pullrequestreview-500811048", "createdAt": "2020-10-02T01:14:56Z", "commit": {"oid": "37d3f63239cc7aa0c042616a0fa179f4287ffcf0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwOTA3OTEx", "url": "https://github.com/kiegroup/kogito-apps/pull/469#pullrequestreview-500907911", "createdAt": "2020-10-02T07:21:12Z", "commit": {"oid": "37d3f63239cc7aa0c042616a0fa179f4287ffcf0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzoyMToxMlrOHbjZkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzoyMToxMlrOHbjZkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY1MzU4NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new IllegalArgumentException(\"Patch an only be applied to the Job scheduling trigger attributes\");\n          \n          \n            \n                        throw new IllegalArgumentException(\"Patch can only be applied to the Job scheduling trigger attributes\");", "url": "https://github.com/kiegroup/kogito-apps/pull/469#discussion_r498653584", "createdAt": "2020-10-02T07:21:12Z", "author": {"login": "sutaakar"}, "path": "jobs-service/src/main/java/org/kie/kogito/jobs/service/resource/JobResource.java", "diffHunk": "@@ -73,13 +76,28 @@\n     @Path(\"/{id}\")\n     @Produces(MediaType.APPLICATION_JSON)\n     @Consumes(MediaType.APPLICATION_JSON)\n-    public CompletionStage<ScheduledJob> patch(@PathParam(\"id\") String id, @RequestBody Job job) {\n+    public CompletionStage<ScheduledJob> patch(@PathParam(\"id\") String id, @RequestBody Job job) throws Exception {\n         LOGGER.debug(\"REST patch update {}\", job);\n-        return jobRepository.merge(id, ScheduledJobAdapter.to(ScheduledJobBuilder.from(job)))\n-                .thenApply(result -> Optional\n-                        .ofNullable(result)\n-                        .map(ScheduledJobAdapter::of)\n-                        .orElseThrow(() -> new NotFoundException(\"Job not found \" + job)));\n+        JobDetails jobToBeMerged = ScheduledJobAdapter.to(ScheduledJobBuilder.from(job));\n+        //validating allowed patch attributes\n+        if (Objects.nonNull(jobToBeMerged.getPayload())\n+                || StringUtils.isNotEmpty(jobToBeMerged.getId())\n+                || StringUtils.isNotEmpty(jobToBeMerged.getScheduledId())\n+                || StringUtils.isNotEmpty(jobToBeMerged.getCorrelationId())\n+                || (Objects.nonNull(jobToBeMerged.getExecutionCounter()) && jobToBeMerged.getExecutionCounter() > 0)\n+                || Objects.nonNull(jobToBeMerged.getPriority())\n+                || (Objects.nonNull(jobToBeMerged.getRetries()) && jobToBeMerged.getRetries() > 0)\n+                || Objects.nonNull(jobToBeMerged.getRecipient())\n+                || Objects.nonNull(jobToBeMerged.getStatus())\n+        ) {\n+            throw new IllegalArgumentException(\"Patch an only be applied to the Job scheduling trigger attributes\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37d3f63239cc7aa0c042616a0fa179f4287ffcf0"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwOTE0MzAy", "url": "https://github.com/kiegroup/kogito-apps/pull/469#pullrequestreview-500914302", "createdAt": "2020-10-02T07:32:35Z", "commit": {"oid": "37d3f63239cc7aa0c042616a0fa179f4287ffcf0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzozMjozNVrOHbjrQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzozMjozNVrOHbjrQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY1ODExMg==", "bodyText": "Wouldn't it have more sense to pass directly Trigger as a request body? That way you can skip these checks.", "url": "https://github.com/kiegroup/kogito-apps/pull/469#discussion_r498658112", "createdAt": "2020-10-02T07:32:35Z", "author": {"login": "sutaakar"}, "path": "jobs-service/src/main/java/org/kie/kogito/jobs/service/resource/JobResource.java", "diffHunk": "@@ -73,13 +76,28 @@\n     @Path(\"/{id}\")\n     @Produces(MediaType.APPLICATION_JSON)\n     @Consumes(MediaType.APPLICATION_JSON)\n-    public CompletionStage<ScheduledJob> patch(@PathParam(\"id\") String id, @RequestBody Job job) {\n+    public CompletionStage<ScheduledJob> patch(@PathParam(\"id\") String id, @RequestBody Job job) throws Exception {\n         LOGGER.debug(\"REST patch update {}\", job);\n-        return jobRepository.merge(id, ScheduledJobAdapter.to(ScheduledJobBuilder.from(job)))\n-                .thenApply(result -> Optional\n-                        .ofNullable(result)\n-                        .map(ScheduledJobAdapter::of)\n-                        .orElseThrow(() -> new NotFoundException(\"Job not found \" + job)));\n+        JobDetails jobToBeMerged = ScheduledJobAdapter.to(ScheduledJobBuilder.from(job));\n+        //validating allowed patch attributes", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37d3f63239cc7aa0c042616a0fa179f4287ffcf0"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMTI3MzI5", "url": "https://github.com/kiegroup/kogito-apps/pull/469#pullrequestreview-501127329", "createdAt": "2020-10-02T13:19:26Z", "commit": {"oid": "6bf6126f8f7b21da383eb1329c894439c96b02a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMTM1NzY2", "url": "https://github.com/kiegroup/kogito-apps/pull/469#pullrequestreview-501135766", "createdAt": "2020-10-02T13:30:10Z", "commit": {"oid": "6bf6126f8f7b21da383eb1329c894439c96b02a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6bf6126f8f7b21da383eb1329c894439c96b02a7", "author": {"user": {"login": "tiagodolphine", "name": "Tiago Dolphine"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/6bf6126f8f7b21da383eb1329c894439c96b02a7", "committedDate": "2020-10-02T10:50:18Z", "message": "Update jobs-service/src/main/java/org/kie/kogito/jobs/service/resource/JobResource.java\n\nCo-authored-by: Karel Suta <krlsuta@gmail.com>"}, "afterCommit": {"oid": "8ad31ae799d019b635b2d8f976ed36d559f35524", "author": {"user": {"login": "tiagodolphine", "name": "Tiago Dolphine"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/8ad31ae799d019b635b2d8f976ed36d559f35524", "committedDate": "2020-10-02T17:07:58Z", "message": "Adding missing config files for infinispan on docker-compose, for testing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ad31ae799d019b635b2d8f976ed36d559f35524", "author": {"user": {"login": "tiagodolphine", "name": "Tiago Dolphine"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/8ad31ae799d019b635b2d8f976ed36d559f35524", "committedDate": "2020-10-02T17:07:58Z", "message": "Adding missing config files for infinispan on docker-compose, for testing"}, "afterCommit": {"oid": "548158ffe7be1ec53876f30b979e4d8d93ac5576", "author": {"user": {"login": "tiagodolphine", "name": "Tiago Dolphine"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/548158ffe7be1ec53876f30b979e4d8d93ac5576", "committedDate": "2020-10-02T17:30:33Z", "message": "Adding missing config files for infinispan on docker-compose, for testing\n\nadjusting docker-compose file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNTIyMTgx", "url": "https://github.com/kiegroup/kogito-apps/pull/469#pullrequestreview-501522181", "createdAt": "2020-10-03T05:22:18Z", "commit": {"oid": "70cec2c89cdd59dfd857842179fcf5f0b135c0a6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c9b13d8ef5736dda426db2134d419cdb96e4d8f", "author": {"user": {"login": "tiagodolphine", "name": "Tiago Dolphine"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/4c9b13d8ef5736dda426db2134d419cdb96e4d8f", "committedDate": "2020-10-05T13:14:50Z", "message": "[Jobs Service] reschedule operarion on patch API + attributes restriction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e21e85c71461afcadc358af657992deacb9c18f8", "author": {"user": {"login": "tiagodolphine", "name": "Tiago Dolphine"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/e21e85c71461afcadc358af657992deacb9c18f8", "committedDate": "2020-10-05T13:14:51Z", "message": "Adding missing config files for infinispan on docker-compose, for testing\n\nadjusting docker-compose file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63aa2f4d1103f5f4c13f07186c9b4135dcabdfe6", "author": {"user": {"login": "tiagodolphine", "name": "Tiago Dolphine"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/63aa2f4d1103f5f4c13f07186c9b4135dcabdfe6", "committedDate": "2020-10-05T13:14:51Z", "message": "fix sonar smells"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "70cec2c89cdd59dfd857842179fcf5f0b135c0a6", "author": {"user": {"login": "tiagodolphine", "name": "Tiago Dolphine"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/70cec2c89cdd59dfd857842179fcf5f0b135c0a6", "committedDate": "2020-10-02T19:12:50Z", "message": "fix sonar smells"}, "afterCommit": {"oid": "63aa2f4d1103f5f4c13f07186c9b4135dcabdfe6", "author": {"user": {"login": "tiagodolphine", "name": "Tiago Dolphine"}}, "url": "https://github.com/kiegroup/kogito-apps/commit/63aa2f4d1103f5f4c13f07186c9b4135dcabdfe6", "committedDate": "2020-10-05T13:14:51Z", "message": "fix sonar smells"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4805, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}