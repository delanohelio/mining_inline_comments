{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxODE3NzE0", "number": 561, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQyMjoxMjoyNFrOFRGkdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQxMDoyNzoyMlrOFUcwog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUzNDc3NzQ4OnYy", "diffSide": "RIGHT", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/global/pdp/PartialDependencePlotExplainer.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQyMjoxMjoyNFrOIXVjEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yN1QyMDo0NzoxMFrOIba13A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTM0MTIwMA==", "bodyText": "Please use explicit import", "url": "https://github.com/kiegroup/kogito-apps/pull/561#discussion_r561341200", "createdAt": "2021-01-20T22:12:24Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/global/pdp/PartialDependencePlotExplainer.java", "diffHunk": "@@ -15,35 +15,20 @@\n  */\n package org.kie.kogito.explainability.global.pdp;\n \n-import java.util.ArrayList;\n-import java.util.Collection;\n-import java.util.List;\n-import java.util.concurrent.ExecutionException;\n-import java.util.concurrent.TimeoutException;\n-import java.util.stream.Collectors;\n-\n import org.kie.kogito.explainability.Config;\n import org.kie.kogito.explainability.global.GlobalExplainer;\n-import org.kie.kogito.explainability.model.DataDistribution;\n-import org.kie.kogito.explainability.model.Feature;\n-import org.kie.kogito.explainability.model.FeatureDistribution;\n-import org.kie.kogito.explainability.model.FeatureFactory;\n-import org.kie.kogito.explainability.model.Output;\n-import org.kie.kogito.explainability.model.PartialDependenceGraph;\n-import org.kie.kogito.explainability.model.Prediction;\n-import org.kie.kogito.explainability.model.PredictionInput;\n-import org.kie.kogito.explainability.model.PredictionInputsDataDistribution;\n-import org.kie.kogito.explainability.model.PredictionOutput;\n-import org.kie.kogito.explainability.model.PredictionProvider;\n-import org.kie.kogito.explainability.model.PredictionProviderMetadata;\n-import org.kie.kogito.explainability.model.Value;\n-import org.kie.kogito.explainability.utils.DataUtils;\n+import org.kie.kogito.explainability.model.*;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import java.util.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05581d3b0df5cf569c55c7dade8e0a35ba7650ba"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTY1NTU1Mg==", "bodyText": "ok", "url": "https://github.com/kiegroup/kogito-apps/pull/561#discussion_r561655552", "createdAt": "2021-01-21T07:35:02Z", "author": {"login": "tteofili"}, "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/global/pdp/PartialDependencePlotExplainer.java", "diffHunk": "@@ -15,35 +15,20 @@\n  */\n package org.kie.kogito.explainability.global.pdp;\n \n-import java.util.ArrayList;\n-import java.util.Collection;\n-import java.util.List;\n-import java.util.concurrent.ExecutionException;\n-import java.util.concurrent.TimeoutException;\n-import java.util.stream.Collectors;\n-\n import org.kie.kogito.explainability.Config;\n import org.kie.kogito.explainability.global.GlobalExplainer;\n-import org.kie.kogito.explainability.model.DataDistribution;\n-import org.kie.kogito.explainability.model.Feature;\n-import org.kie.kogito.explainability.model.FeatureDistribution;\n-import org.kie.kogito.explainability.model.FeatureFactory;\n-import org.kie.kogito.explainability.model.Output;\n-import org.kie.kogito.explainability.model.PartialDependenceGraph;\n-import org.kie.kogito.explainability.model.Prediction;\n-import org.kie.kogito.explainability.model.PredictionInput;\n-import org.kie.kogito.explainability.model.PredictionInputsDataDistribution;\n-import org.kie.kogito.explainability.model.PredictionOutput;\n-import org.kie.kogito.explainability.model.PredictionProvider;\n-import org.kie.kogito.explainability.model.PredictionProviderMetadata;\n-import org.kie.kogito.explainability.model.Value;\n-import org.kie.kogito.explainability.utils.DataUtils;\n+import org.kie.kogito.explainability.model.*;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import java.util.*;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTM0MTIwMA=="}, "originalCommit": {"oid": "05581d3b0df5cf569c55c7dade8e0a35ba7650ba"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTYyMjIzNg==", "bodyText": "Please review because it is not solved", "url": "https://github.com/kiegroup/kogito-apps/pull/561#discussion_r565622236", "createdAt": "2021-01-27T20:47:10Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/global/pdp/PartialDependencePlotExplainer.java", "diffHunk": "@@ -15,35 +15,20 @@\n  */\n package org.kie.kogito.explainability.global.pdp;\n \n-import java.util.ArrayList;\n-import java.util.Collection;\n-import java.util.List;\n-import java.util.concurrent.ExecutionException;\n-import java.util.concurrent.TimeoutException;\n-import java.util.stream.Collectors;\n-\n import org.kie.kogito.explainability.Config;\n import org.kie.kogito.explainability.global.GlobalExplainer;\n-import org.kie.kogito.explainability.model.DataDistribution;\n-import org.kie.kogito.explainability.model.Feature;\n-import org.kie.kogito.explainability.model.FeatureDistribution;\n-import org.kie.kogito.explainability.model.FeatureFactory;\n-import org.kie.kogito.explainability.model.Output;\n-import org.kie.kogito.explainability.model.PartialDependenceGraph;\n-import org.kie.kogito.explainability.model.Prediction;\n-import org.kie.kogito.explainability.model.PredictionInput;\n-import org.kie.kogito.explainability.model.PredictionInputsDataDistribution;\n-import org.kie.kogito.explainability.model.PredictionOutput;\n-import org.kie.kogito.explainability.model.PredictionProvider;\n-import org.kie.kogito.explainability.model.PredictionProviderMetadata;\n-import org.kie.kogito.explainability.model.Value;\n-import org.kie.kogito.explainability.utils.DataUtils;\n+import org.kie.kogito.explainability.model.*;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n+import java.util.*;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTM0MTIwMA=="}, "originalCommit": {"oid": "05581d3b0df5cf569c55c7dade8e0a35ba7650ba"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUzNDc4MjI4OnYy", "diffSide": "RIGHT", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/global/pdp/PartialDependencePlotExplainer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQyMjoxMzo0OVrOIXVl5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMVQwNzozMzoxN1rOIXosOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTM0MTkyNw==", "bodyText": "Please log error (don't use jboss logmanager! :P )", "url": "https://github.com/kiegroup/kogito-apps/pull/561#discussion_r561341927", "createdAt": "2021-01-20T22:13:49Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/global/pdp/PartialDependencePlotExplainer.java", "diffHunk": "@@ -136,6 +109,67 @@ public PartialDependencePlotExplainer() {\n         return pdps;\n     }\n \n+    private PartialDependenceGraph getPartialDependenceGraph(PredictionProvider model,\n+                                                             List<PredictionInput> trainingData,\n+                                                             List<Value<?>> xsValues,\n+                                                             List<Feature> featureXSvalues, int outputIndex)\n+            throws InterruptedException, ExecutionException, TimeoutException {\n+        Output outputDecision = null;\n+        Feature feature = null;\n+        // each feature value of the feature under analysis should have a corresponding output value (composed by the marginal impacts of the other features)\n+        List<Value<?>> marginalImpacts = new ArrayList<>(featureXSvalues.size());\n+        for (int i = 0; i < featureXSvalues.size(); i++) {\n+            // initialize an empty feature to use in the generated PDP\n+            if (feature == null) {\n+                feature = FeatureFactory.copyOf(featureXSvalues.get(i), new Value<>(null));\n+            }\n+            List<PredictionInput> predictionInputs = prepareInputs(featureXSvalues.get(i), trainingData);\n+            List<PredictionOutput> predictionOutputs = getOutputs(model, predictionInputs);\n+            // prediction requests are batched per value of feature 'Xs' under analysis\n+            for (PredictionOutput predictionOutput : predictionOutputs) {\n+                Output output = predictionOutput.getOutputs().get(outputIndex);\n+                if (outputDecision == null) {\n+                    outputDecision = new Output(output.getName(), output.getType());\n+                }\n+                // update marginal impacts\n+                updateMarginalImpact(marginalImpacts, i, output);\n+            }\n+        }\n+        // collapse impacts ?\n+        return new PartialDependenceGraph(feature, outputDecision, xsValues, marginalImpacts);\n+    }\n+\n+    private void updateMarginalImpact(List<Value<?>> marginalImpacts, int i, Output output) {\n+        if (Type.NUMBER.equals(output.getType())) {\n+            double v = output.getValue().asNumber();\n+            if (marginalImpacts.size() > i) {\n+                marginalImpacts.set(i, new Value<>(marginalImpacts.get(i).asNumber() + v / (double) seriesLength));\n+            } else {\n+                marginalImpacts.add(i, new Value<>(v / (double) seriesLength));\n+            }\n+        } else {\n+            String categoricalOutput = output.getValue().asString();\n+            if (marginalImpacts.size() <= i) {\n+                Map<String, Long> classCount = new HashMap<>();\n+                classCount.put(categoricalOutput, 1L);\n+                marginalImpacts.add(new Value<>(classCount));\n+            } else {\n+                Value<?> value = marginalImpacts.get(i);\n+                try {\n+                    Map<String, Long> classCount = (Map<String, Long>) value.getUnderlyingObject();\n+                    if (classCount.containsKey(categoricalOutput)) {\n+                        classCount.put(categoricalOutput, classCount.get(categoricalOutput) + 1);\n+                    } else {\n+                        classCount.put(categoricalOutput, 1L);\n+                    }\n+                    marginalImpacts.set(i, new Value<>(classCount));\n+                } catch (ClassCastException cce) {\n+                    // ignore malformed output", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05581d3b0df5cf569c55c7dade8e0a35ba7650ba"}, "originalPosition": 158}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTY1NDg0MA==", "bodyText": "ok :)", "url": "https://github.com/kiegroup/kogito-apps/pull/561#discussion_r561654840", "createdAt": "2021-01-21T07:33:17Z", "author": {"login": "tteofili"}, "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/global/pdp/PartialDependencePlotExplainer.java", "diffHunk": "@@ -136,6 +109,67 @@ public PartialDependencePlotExplainer() {\n         return pdps;\n     }\n \n+    private PartialDependenceGraph getPartialDependenceGraph(PredictionProvider model,\n+                                                             List<PredictionInput> trainingData,\n+                                                             List<Value<?>> xsValues,\n+                                                             List<Feature> featureXSvalues, int outputIndex)\n+            throws InterruptedException, ExecutionException, TimeoutException {\n+        Output outputDecision = null;\n+        Feature feature = null;\n+        // each feature value of the feature under analysis should have a corresponding output value (composed by the marginal impacts of the other features)\n+        List<Value<?>> marginalImpacts = new ArrayList<>(featureXSvalues.size());\n+        for (int i = 0; i < featureXSvalues.size(); i++) {\n+            // initialize an empty feature to use in the generated PDP\n+            if (feature == null) {\n+                feature = FeatureFactory.copyOf(featureXSvalues.get(i), new Value<>(null));\n+            }\n+            List<PredictionInput> predictionInputs = prepareInputs(featureXSvalues.get(i), trainingData);\n+            List<PredictionOutput> predictionOutputs = getOutputs(model, predictionInputs);\n+            // prediction requests are batched per value of feature 'Xs' under analysis\n+            for (PredictionOutput predictionOutput : predictionOutputs) {\n+                Output output = predictionOutput.getOutputs().get(outputIndex);\n+                if (outputDecision == null) {\n+                    outputDecision = new Output(output.getName(), output.getType());\n+                }\n+                // update marginal impacts\n+                updateMarginalImpact(marginalImpacts, i, output);\n+            }\n+        }\n+        // collapse impacts ?\n+        return new PartialDependenceGraph(feature, outputDecision, xsValues, marginalImpacts);\n+    }\n+\n+    private void updateMarginalImpact(List<Value<?>> marginalImpacts, int i, Output output) {\n+        if (Type.NUMBER.equals(output.getType())) {\n+            double v = output.getValue().asNumber();\n+            if (marginalImpacts.size() > i) {\n+                marginalImpacts.set(i, new Value<>(marginalImpacts.get(i).asNumber() + v / (double) seriesLength));\n+            } else {\n+                marginalImpacts.add(i, new Value<>(v / (double) seriesLength));\n+            }\n+        } else {\n+            String categoricalOutput = output.getValue().asString();\n+            if (marginalImpacts.size() <= i) {\n+                Map<String, Long> classCount = new HashMap<>();\n+                classCount.put(categoricalOutput, 1L);\n+                marginalImpacts.add(new Value<>(classCount));\n+            } else {\n+                Value<?> value = marginalImpacts.get(i);\n+                try {\n+                    Map<String, Long> classCount = (Map<String, Long>) value.getUnderlyingObject();\n+                    if (classCount.containsKey(categoricalOutput)) {\n+                        classCount.put(categoricalOutput, classCount.get(categoricalOutput) + 1);\n+                    } else {\n+                        classCount.put(categoricalOutput, 1L);\n+                    }\n+                    marginalImpacts.set(i, new Value<>(classCount));\n+                } catch (ClassCastException cce) {\n+                    // ignore malformed output", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTM0MTkyNw=="}, "originalCommit": {"oid": "05581d3b0df5cf569c55c7dade8e0a35ba7650ba"}, "originalPosition": 158}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUzNDc5MTk1OnYy", "diffSide": "RIGHT", "path": "explainability/explainability-integrationtests/explainability-integrationtests-opennlp/src/test/java/org/kie/kogito/explainability/explainability/integrationtests/opennlp/OpenNLPPDPExplainerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQyMjoxNjozOVrOIXVrdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMVQwNzozNDo1M1rOIXouyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTM0MzM1MA==", "bodyText": "Explicit imports", "url": "https://github.com/kiegroup/kogito-apps/pull/561#discussion_r561343350", "createdAt": "2021-01-20T22:16:39Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-integrationtests/explainability-integrationtests-opennlp/src/test/java/org/kie/kogito/explainability/explainability/integrationtests/opennlp/OpenNLPPDPExplainerTest.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.explainability.integrationtests.opennlp;\n+\n+import opennlp.tools.langdetect.Language;\n+import opennlp.tools.langdetect.LanguageDetector;\n+import opennlp.tools.langdetect.LanguageDetectorME;\n+import opennlp.tools.langdetect.LanguageDetectorModel;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.explainability.Config;\n+import org.kie.kogito.explainability.global.pdp.PartialDependencePlotExplainer;\n+import org.kie.kogito.explainability.local.lime.LimeConfig;\n+import org.kie.kogito.explainability.local.lime.LimeExplainer;\n+import org.kie.kogito.explainability.model.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05581d3b0df5cf569c55c7dade8e0a35ba7650ba"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTY1NTQ5Ng==", "bodyText": "ok", "url": "https://github.com/kiegroup/kogito-apps/pull/561#discussion_r561655496", "createdAt": "2021-01-21T07:34:53Z", "author": {"login": "tteofili"}, "path": "explainability/explainability-integrationtests/explainability-integrationtests-opennlp/src/test/java/org/kie/kogito/explainability/explainability/integrationtests/opennlp/OpenNLPPDPExplainerTest.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.explainability.integrationtests.opennlp;\n+\n+import opennlp.tools.langdetect.Language;\n+import opennlp.tools.langdetect.LanguageDetector;\n+import opennlp.tools.langdetect.LanguageDetectorME;\n+import opennlp.tools.langdetect.LanguageDetectorModel;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.explainability.Config;\n+import org.kie.kogito.explainability.global.pdp.PartialDependencePlotExplainer;\n+import org.kie.kogito.explainability.local.lime.LimeConfig;\n+import org.kie.kogito.explainability.local.lime.LimeExplainer;\n+import org.kie.kogito.explainability.model.*;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTM0MzM1MA=="}, "originalCommit": {"oid": "05581d3b0df5cf569c55c7dade8e0a35ba7650ba"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUzNDc5NDY3OnYy", "diffSide": "RIGHT", "path": "explainability/explainability-integrationtests/explainability-integrationtests-dmn/src/test/java/org/kie/kogito/explainability/explainability/integrationtests/dmn/DecisionModelWrapper.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQyMjoxNzoyOFrOIXVtEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMVQxMzozOTo0M1rOIX22wA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTM0Mzc2Mg==", "bodyText": "Why this check? What about other types?", "url": "https://github.com/kiegroup/kogito-apps/pull/561#discussion_r561343762", "createdAt": "2021-01-20T22:17:28Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-integrationtests/explainability-integrationtests-dmn/src/test/java/org/kie/kogito/explainability/explainability/integrationtests/dmn/DecisionModelWrapper.java", "diffHunk": "@@ -56,7 +56,14 @@\n             DMNResult dmnResult = decisionModel.evaluateAll(context);\n             List<Output> outputs = new LinkedList<>();\n             for (DMNDecisionResult decisionResult : dmnResult.getDecisionResults()) {\n-                Output output = new Output(decisionResult.getDecisionName(), Type.TEXT, new Value<>(decisionResult.getResult()), 1d);\n+                Value<Object> value = new Value<>(decisionResult.getResult());\n+                Type type;\n+                if (Double.isNaN(value.asNumber())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05581d3b0df5cf569c55c7dade8e0a35ba7650ba"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTY1NDc1MA==", "bodyText": "this is just to differentiate between numeric outputs and all other types in the tests.\nThe reason why it's there is that the PDPExplainer differentiates between numeric and non-numeric outputs.\nIn practice, actual DMN models returning the correct Type would be a responsibility of the explainability-service or eventually of the explainability-core correctly parsing the output value; DecisionModelWrapper is just used for testing purposes so I had thought checking all Types wasn't needed.\nI can anyway delegate the validation responsibility to the PDPExplainer too, to make sure that Types and Values are parsed/handled correctly.", "url": "https://github.com/kiegroup/kogito-apps/pull/561#discussion_r561654750", "createdAt": "2021-01-21T07:33:02Z", "author": {"login": "tteofili"}, "path": "explainability/explainability-integrationtests/explainability-integrationtests-dmn/src/test/java/org/kie/kogito/explainability/explainability/integrationtests/dmn/DecisionModelWrapper.java", "diffHunk": "@@ -56,7 +56,14 @@\n             DMNResult dmnResult = decisionModel.evaluateAll(context);\n             List<Output> outputs = new LinkedList<>();\n             for (DMNDecisionResult decisionResult : dmnResult.getDecisionResults()) {\n-                Output output = new Output(decisionResult.getDecisionName(), Type.TEXT, new Value<>(decisionResult.getResult()), 1d);\n+                Value<Object> value = new Value<>(decisionResult.getResult());\n+                Type type;\n+                if (Double.isNaN(value.asNumber())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTM0Mzc2Mg=="}, "originalCommit": {"oid": "05581d3b0df5cf569c55c7dade8e0a35ba7650ba"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTg0NzY5OA==", "bodyText": "Well if this is a corner case we can add a log message too \ud83e\udd14", "url": "https://github.com/kiegroup/kogito-apps/pull/561#discussion_r561847698", "createdAt": "2021-01-21T12:38:43Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-integrationtests/explainability-integrationtests-dmn/src/test/java/org/kie/kogito/explainability/explainability/integrationtests/dmn/DecisionModelWrapper.java", "diffHunk": "@@ -56,7 +56,14 @@\n             DMNResult dmnResult = decisionModel.evaluateAll(context);\n             List<Output> outputs = new LinkedList<>();\n             for (DMNDecisionResult decisionResult : dmnResult.getDecisionResults()) {\n-                Output output = new Output(decisionResult.getDecisionName(), Type.TEXT, new Value<>(decisionResult.getResult()), 1d);\n+                Value<Object> value = new Value<>(decisionResult.getResult());\n+                Type type;\n+                if (Double.isNaN(value.asNumber())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTM0Mzc2Mg=="}, "originalCommit": {"oid": "05581d3b0df5cf569c55c7dade8e0a35ba7650ba"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTg4NjkxMg==", "bodyText": "correct, will do it", "url": "https://github.com/kiegroup/kogito-apps/pull/561#discussion_r561886912", "createdAt": "2021-01-21T13:39:43Z", "author": {"login": "tteofili"}, "path": "explainability/explainability-integrationtests/explainability-integrationtests-dmn/src/test/java/org/kie/kogito/explainability/explainability/integrationtests/dmn/DecisionModelWrapper.java", "diffHunk": "@@ -56,7 +56,14 @@\n             DMNResult dmnResult = decisionModel.evaluateAll(context);\n             List<Output> outputs = new LinkedList<>();\n             for (DMNDecisionResult decisionResult : dmnResult.getDecisionResults()) {\n-                Output output = new Output(decisionResult.getDecisionName(), Type.TEXT, new Value<>(decisionResult.getResult()), 1d);\n+                Value<Object> value = new Value<>(decisionResult.getResult());\n+                Type type;\n+                if (Double.isNaN(value.asNumber())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTM0Mzc2Mg=="}, "originalCommit": {"oid": "05581d3b0df5cf569c55c7dade8e0a35ba7650ba"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU2MjcxMzk5OnYy", "diffSide": "RIGHT", "path": "explainability/explainability-integrationtests/explainability-integrationtests-opennlp/src/test/java/org/kie/kogito/explainability/explainability/integrationtests/opennlp/OpenNLPPDPExplainerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yN1QyMDo0NjoyN1rOIba0Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOFQwNjo0OToyMFrOIbpFoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTYyMTg1MQ==", "bodyText": "Import to fix", "url": "https://github.com/kiegroup/kogito-apps/pull/561#discussion_r565621851", "createdAt": "2021-01-27T20:46:27Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-integrationtests/explainability-integrationtests-opennlp/src/test/java/org/kie/kogito/explainability/explainability/integrationtests/opennlp/OpenNLPPDPExplainerTest.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.explainability.integrationtests.opennlp;\n+\n+import opennlp.tools.langdetect.Language;\n+import opennlp.tools.langdetect.LanguageDetector;\n+import opennlp.tools.langdetect.LanguageDetectorME;\n+import opennlp.tools.langdetect.LanguageDetectorModel;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.explainability.Config;\n+import org.kie.kogito.explainability.global.pdp.PartialDependencePlotExplainer;\n+import org.kie.kogito.explainability.model.Feature;\n+import org.kie.kogito.explainability.model.FeatureFactory;\n+import org.kie.kogito.explainability.model.Output;\n+import org.kie.kogito.explainability.model.PartialDependenceGraph;\n+import org.kie.kogito.explainability.model.Prediction;\n+import org.kie.kogito.explainability.model.PredictionInput;\n+import org.kie.kogito.explainability.model.PredictionOutput;\n+import org.kie.kogito.explainability.model.PredictionProvider;\n+import org.kie.kogito.explainability.model.Type;\n+import org.kie.kogito.explainability.model.Value;\n+\n+import java.io.InputStream;\n+import java.util.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e38727817aa871272743586fc58d6fd7c7917b2"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTg1NTY0OA==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/kiegroup/kogito-apps/pull/561#discussion_r565855648", "createdAt": "2021-01-28T06:49:20Z", "author": {"login": "tteofili"}, "path": "explainability/explainability-integrationtests/explainability-integrationtests-opennlp/src/test/java/org/kie/kogito/explainability/explainability/integrationtests/opennlp/OpenNLPPDPExplainerTest.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.kie.kogito.explainability.explainability.integrationtests.opennlp;\n+\n+import opennlp.tools.langdetect.Language;\n+import opennlp.tools.langdetect.LanguageDetector;\n+import opennlp.tools.langdetect.LanguageDetectorME;\n+import opennlp.tools.langdetect.LanguageDetectorModel;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.explainability.Config;\n+import org.kie.kogito.explainability.global.pdp.PartialDependencePlotExplainer;\n+import org.kie.kogito.explainability.model.Feature;\n+import org.kie.kogito.explainability.model.FeatureFactory;\n+import org.kie.kogito.explainability.model.Output;\n+import org.kie.kogito.explainability.model.PartialDependenceGraph;\n+import org.kie.kogito.explainability.model.Prediction;\n+import org.kie.kogito.explainability.model.PredictionInput;\n+import org.kie.kogito.explainability.model.PredictionOutput;\n+import org.kie.kogito.explainability.model.PredictionProvider;\n+import org.kie.kogito.explainability.model.Type;\n+import org.kie.kogito.explainability.model.Value;\n+\n+import java.io.InputStream;\n+import java.util.*;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTYyMTg1MQ=="}, "originalCommit": {"oid": "1e38727817aa871272743586fc58d6fd7c7917b2"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU2OTg2NjAxOnYy", "diffSide": "RIGHT", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/global/pdp/PartialDependencePlotExplainer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQxMDoyNjoxMVrOIcd_og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQxMDoyNjoxMVrOIcd_og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjcyMjQ2Ng==", "bodyText": "Please use a different variable name instead of i :)", "url": "https://github.com/kiegroup/kogito-apps/pull/561#discussion_r566722466", "createdAt": "2021-01-29T10:26:11Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/global/pdp/PartialDependencePlotExplainer.java", "diffHunk": "@@ -136,6 +126,90 @@ public PartialDependencePlotExplainer() {\n         return pdps;\n     }\n \n+    private PartialDependenceGraph getPartialDependenceGraph(PredictionProvider model,\n+                                                             List<PredictionInput> trainingData,\n+                                                             List<Value<?>> xsValues,\n+                                                             List<Feature> featureXSvalues, int outputIndex)\n+            throws InterruptedException, ExecutionException, TimeoutException {\n+        Output outputDecision = null;\n+        Feature feature = null;\n+        // each feature value of the feature under analysis should have a corresponding output value (composed by the marginal impacts of the other features)\n+        List<Map<Value<?>, Long>> valueCounts = new ArrayList<>(featureXSvalues.size());\n+        for (int i = 0; i < featureXSvalues.size(); i++) {\n+            // initialize an empty feature to use in the generated PDP\n+            if (feature == null) {\n+                feature = FeatureFactory.copyOf(featureXSvalues.get(i), new Value<>(null));\n+            }\n+            List<PredictionInput> predictionInputs = prepareInputs(featureXSvalues.get(i), trainingData);\n+            List<PredictionOutput> predictionOutputs = getOutputs(model, predictionInputs);\n+            // prediction requests are batched per value of feature 'Xs' under analysis\n+            for (PredictionOutput predictionOutput : predictionOutputs) {\n+                Output output = predictionOutput.getOutputs().get(outputIndex);\n+                if (outputDecision == null) {\n+                    outputDecision = new Output(output.getName(), output.getType());\n+                }\n+                // update output value counts\n+                updateValueCounts(valueCounts, i, output);\n+            }\n+        }\n+\n+        if (outputDecision != null) {\n+            List<Value<?>> yValues = collapseMarginalImpacts(valueCounts, outputDecision.getType());\n+            return new PartialDependenceGraph(feature, outputDecision, xsValues, yValues);\n+        } else {\n+            throw new RuntimeException(\"cannot produce PDP for null decision\");\n+        }\n+    }\n+\n+    /**\n+     * Collapse value counts into marginal impacts.\n+     * For numbers ({@code Type.NUMBER.equals(type))} this is just the average of each value at each feature value.\n+     * For all other types the final {@link Value} is just the most frequent.\n+     *\n+     * @param valueCounts the frequency of each value at each position\n+     * @param type        the type of the output\n+     * @return the marginal impacts\n+     */\n+    private List<Value<?>> collapseMarginalImpacts(List<Map<Value<?>, Long>> valueCounts, Type type) {\n+        List<Value<?>> yValues = new ArrayList<>();\n+        if (Type.NUMBER.equals(type)) {\n+            List<Double> doubles = valueCounts.stream()\n+                    .map(v -> v.entrySet().stream()\n+                            .map(e -> e.getKey().asNumber() * e.getValue() / config.getSeriesLength()).mapToDouble(d -> d).sum()).collect(Collectors.toList());\n+            yValues = doubles.stream().map(Value::new).collect(Collectors.toList());\n+        } else {\n+            for (Map<Value<?>, Long> item : valueCounts) {\n+                long max = 0;\n+                String output = null;\n+                for (Map.Entry<Value<?>, Long> entry : item.entrySet()) {\n+                    if (entry.getValue() > max) {\n+                        max = entry.getValue();\n+                        output = entry.getKey().asString();\n+                    }\n+                }\n+                yValues.add(new Value<>(output));\n+            }\n+        }\n+        return yValues;\n+    }\n+\n+    private void updateValueCounts(List<Map<Value<?>, Long>> valueCounts, int i, Output output) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b0f74fe293122b59011450519610cdf05d4fd9b"}, "originalPosition": 199}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzU2OTg3MDQyOnYy", "diffSide": "RIGHT", "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/utils/DataUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQxMDoyNzoyMlrOIceCeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQxMzo0ODo1M1rOIckx5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjcyMzE5NA==", "bodyText": "What about use apache-commons-csv?", "url": "https://github.com/kiegroup/kogito-apps/pull/561#discussion_r566723194", "createdAt": "2021-01-29T10:27:22Z", "author": {"login": "danielezonca"}, "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/utils/DataUtils.java", "diffHunk": "@@ -433,4 +439,24 @@ private static void linearizeFeature(List<Feature> flattenedFeatures, Feature f)\n                     .collect(Collectors.toList());\n         }\n     }\n+\n+    /**\n+     * Persist a {@link PartialDependenceGraph} into a CSV file.\n+     * @param partialDependenceGraph the PDP to persist\n+     * @param path the path to the CSV file to be created\n+     * @throws IOException whether any IO error occurs while writing the CSV\n+     */\n+    public static void toCSV(PartialDependenceGraph partialDependenceGraph, Path path) throws IOException {\n+        try (OutputStream outputStream = Files.newOutputStream(path)) {\n+            List<Value<?>> xAxis = partialDependenceGraph.getX();\n+            List<Value<?>> yAxis = partialDependenceGraph.getY();\n+            outputStream.write(\"feature,output\\n\".getBytes(StandardCharsets.UTF_8));\n+            for (int i = 0; i < xAxis.size(); i++) {\n+                String line = xAxis.get(i).asString().replaceAll(\",\", \"\") + ',' +\n+                        yAxis.get(i).asString().replaceAll(\",\", \"\") + '\\n';\n+                outputStream.write(line.getBytes(StandardCharsets.UTF_8));\n+            }\n+            outputStream.flush();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b0f74fe293122b59011450519610cdf05d4fd9b"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjgzMzYzNw==", "bodyText": "I've created https://issues.redhat.com/browse/FAI-383 to follow up on this (it'd require updating / changing the kogito-bom in a separate PR so I think it's better to do that in a separate issue / PR).", "url": "https://github.com/kiegroup/kogito-apps/pull/561#discussion_r566833637", "createdAt": "2021-01-29T13:48:53Z", "author": {"login": "tteofili"}, "path": "explainability/explainability-core/src/main/java/org/kie/kogito/explainability/utils/DataUtils.java", "diffHunk": "@@ -433,4 +439,24 @@ private static void linearizeFeature(List<Feature> flattenedFeatures, Feature f)\n                     .collect(Collectors.toList());\n         }\n     }\n+\n+    /**\n+     * Persist a {@link PartialDependenceGraph} into a CSV file.\n+     * @param partialDependenceGraph the PDP to persist\n+     * @param path the path to the CSV file to be created\n+     * @throws IOException whether any IO error occurs while writing the CSV\n+     */\n+    public static void toCSV(PartialDependenceGraph partialDependenceGraph, Path path) throws IOException {\n+        try (OutputStream outputStream = Files.newOutputStream(path)) {\n+            List<Value<?>> xAxis = partialDependenceGraph.getX();\n+            List<Value<?>> yAxis = partialDependenceGraph.getY();\n+            outputStream.write(\"feature,output\\n\".getBytes(StandardCharsets.UTF_8));\n+            for (int i = 0; i < xAxis.size(); i++) {\n+                String line = xAxis.get(i).asString().replaceAll(\",\", \"\") + ',' +\n+                        yAxis.get(i).asString().replaceAll(\",\", \"\") + '\\n';\n+                outputStream.write(line.getBytes(StandardCharsets.UTF_8));\n+            }\n+            outputStream.flush();\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjcyMzE5NA=="}, "originalCommit": {"oid": "7b0f74fe293122b59011450519610cdf05d4fd9b"}, "originalPosition": 42}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1113, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}