{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyMzQyNzY5", "number": 2671, "title": "Fix race in MetricsContext", "bodyText": "Turns out the failures observed in issue #2572 are caused by an exception thrown in MetricsContext. It's a NPE caused by non-thread safe data being accessed from multiple threads (one is the thread executing the tasklet, another is the thread doing dynamic metrics collection). This PR attempts to fix the problem.\nFixes #2572\nChecklist:\n\n Labels and Milestone set", "createdAt": "2020-11-17T11:36:26Z", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2671", "merged": true, "mergeCommit": {"oid": "fed7724559fdcb1e96e7c1398b0cd569e5c103d2"}, "closed": true, "closedAt": "2020-11-18T11:59:26Z", "author": {"login": "jbartok"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddX52zgH2gAyNTIyMzQyNzY5OmQzOGYyNGU3ZTdhYTNmZWU5MzU2N2NhMzVjZjgxMDYzMzBjY2Q0OGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddsE21AFqTUzMzMzMTYyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d38f24e7e7aa3fee93567ca35cf8106330ccd48a", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/d38f24e7e7aa3fee93567ca35cf8106330ccd48a", "committedDate": "2020-11-17T11:32:03Z", "message": "Fix race in MetricsContext"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMzIxOTIx", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2671#pullrequestreview-532321921", "createdAt": "2020-11-17T12:42:22Z", "commit": {"oid": "d38f24e7e7aa3fee93567ca35cf8106330ccd48a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMjo0MjoyMlrOH0zDdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxMjo0MjoyMlrOH0zDdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTEyNDQ3MQ==", "bodyText": "threadSafeStore.forEach(consumer); ?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2671#discussion_r525124471", "createdAt": "2020-11-17T12:42:22Z", "author": {"login": "gurbuzali"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/metrics/MetricsContext.java", "diffHunk": "@@ -209,4 +177,42 @@ protected long get() {\n         }\n     }\n \n+    /**\n+     * Map for storing metrics on a per name basis. Meant to offer fast,\n+     * single-threaded access, but also a loosely consistent, thread safe\n+     * way to iterate over the content.\n+     */\n+    private static class MetricsStore {\n+\n+        private Map<String, AbstractMetric> threadLocalStore;\n+        private volatile ConcurrentMap<String, AbstractMetric> threadSafeStore;\n+\n+        /**\n+         * Always called on the same thread, the one executing the Tasklet this context belongs to.\n+         */\n+        Metric localGet(String name, Unit unit, BiFunction<String, Unit, AbstractMetric> metricSupplier) {\n+            if (threadLocalStore == null) { //first metric being stored\n+                threadLocalStore = new HashMap<>();\n+                threadSafeStore = new ConcurrentHashMap<>();\n+            }\n+\n+            AbstractMetric metric = threadLocalStore.get(name);\n+            if (metric != null) {\n+                return metric;\n+            }\n+\n+            metric = metricSupplier.apply(name, unit);\n+            threadLocalStore.put(name, metric);\n+            threadSafeStore.put(name, metric);\n+\n+            return metric;\n+        }\n+\n+        void threadSafeForEach(BiConsumer<? super String, ? super AbstractMetric> consumer) {\n+            if (threadSafeStore != null) {\n+                threadLocalStore.forEach(consumer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d38f24e7e7aa3fee93567ca35cf8106330ccd48a"}, "originalPosition": 113}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36f0e3ec968615c0a33d86c0c981533ab24606bb", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/36f0e3ec968615c0a33d86c0c981533ab24606bb", "committedDate": "2020-11-17T13:02:10Z", "message": "Fix copy-paste mistake"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMTU2Mjk2", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2671#pullrequestreview-533156296", "createdAt": "2020-11-18T07:14:31Z", "commit": {"oid": "36f0e3ec968615c0a33d86c0c981533ab24606bb"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwNzoxNDozMVrOH1f3dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwNzoyODozMlrOH1gNtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg1ODY3Ng==", "bodyText": "addUserTag(tagger) is not necessary any more", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2671#discussion_r525858676", "createdAt": "2020-11-18T07:14:31Z", "author": {"login": "gurbuzali"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/metrics/MetricsContext.java", "diffHunk": "@@ -50,47 +50,15 @@ Metric threadSafeMetric(String name, Unit unit) {\n     }\n \n     private Metric metric(String name, Unit unit, BiFunction<String, Unit, AbstractMetric> metricSupplier) {\n-        if (metrics == null) { //at most one already defined metric\n-            if (onlyMetric == null) { //no already defined metrics\n-                onlyMetric = metricSupplier.apply(name, unit);\n-                onlyName = name;\n-                return onlyMetric;\n-            } else { //one single already defined metric\n-                if (name.equals(onlyName)) { //single already defined metric same as the requested one\n-                    return onlyMetric;\n-                } else { //single already defined metric different from the requested one\n-                    metrics = new HashMap<>();\n-                    metrics.put(onlyName, onlyMetric);\n-\n-                    onlyMetric = null;\n-                    onlyName = null;\n-\n-                    AbstractMetric metric = metricSupplier.apply(name, unit);\n-                    metrics.put(name, metric);\n-                    return metric;\n-                }\n-            }\n-        } else { //multiple metrics already defined\n-            AbstractMetric metric = metrics.get(name);\n-            if (metric == null) { //requested metric not yet defined\n-                metric = metricSupplier.apply(name, unit);\n-                metrics.put(name, metric);\n-            }\n-            return metric;\n-        }\n+        return store.localGet(name, unit, metricSupplier);\n     }\n \n     @Override\n     public void provideDynamicMetrics(MetricDescriptor tagger, MetricsCollectionContext context) {\n-        if (onlyMetric != null) {\n-            context.collect(\n-                    addUserTag(tagger), onlyName, ProbeLevel.INFO, toProbeUnit(onlyMetric.unit()), onlyMetric.get()\n-            );\n-        } else if (metrics != null) {\n-            MetricDescriptor withUserTag = addUserTag(tagger);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36f0e3ec968615c0a33d86c0c981533ab24606bb"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg2NDM3Mw==", "bodyText": "we are doubling the memory footprint and complicating the implementation to provide a fast local get. Is this really necessary? does it affect the performance that much to use a single ConcurrentHashMap ?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2671#discussion_r525864373", "createdAt": "2020-11-18T07:28:32Z", "author": {"login": "gurbuzali"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/metrics/MetricsContext.java", "diffHunk": "@@ -209,4 +177,42 @@ protected long get() {\n         }\n     }\n \n+    /**\n+     * Map for storing metrics on a per name basis. Meant to offer fast,\n+     * single-threaded access, but also a loosely consistent, thread safe\n+     * way to iterate over the content.\n+     */\n+    private static class MetricsStore {\n+\n+        private Map<String, AbstractMetric> threadLocalStore;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36f0e3ec968615c0a33d86c0c981533ab24606bb"}, "originalPosition": 87}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMTk4NzIz", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2671#pullrequestreview-533198723", "createdAt": "2020-11-18T08:22:09Z", "commit": {"oid": "36f0e3ec968615c0a33d86c0c981533ab24606bb"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwODoyMjowOVrOH1h_NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwODoyMjowOVrOH1h_NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg5MzQyOA==", "bodyText": "I was curious and suspected that a non-contended read-only CHM might be very similar to plain HM because non-contended volatile read on x86 is as fast as a non-volatile read:\nBenchmark     Mode  Cnt   Score   Error  Units\nChmBench.chm  avgt   10  21,687 \u00b1 0,122  ns/op\nChmBench.hm   avgt   10  22,610 \u00b1 0,163  ns/op\n\nsource:\n@BenchmarkMode(Mode.AverageTime)\n@OutputTimeUnit(TimeUnit.NANOSECONDS)\n@State(Scope.Thread)\n@Fork(value = 1, warmups = 1)\n@Warmup(iterations = 10)\n@Measurement(iterations = 10)\npublic class ChmBench {\n\n    private final Map<String, Integer> chm = new ConcurrentHashMap<>();\n    private final Map<String, Integer> hm = new HashMap<>();\n\n    {\n        chm.put(\"1\", 1);\n        chm.put(\"2\", 2);\n        chm.put(\"3\", 3);\n\n        hm.putAll(chm);\n    }\n\n    @Benchmark\n    public void chm() {\n        chm.get(\"3\");\n        chm.get(\"1\");\n        chm.get(\"2\");\n    }\n\n    @Benchmark\n    public void hm() {\n        hm.get(\"3\");\n        hm.get(\"1\");\n        hm.get(\"2\");\n    }\n}\nMaybe another CPU will be different, I don't know. I used JDK 1.8.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2671#discussion_r525893428", "createdAt": "2020-11-18T08:22:09Z", "author": {"login": "viliam-durina"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/metrics/MetricsContext.java", "diffHunk": "@@ -209,4 +177,42 @@ protected long get() {\n         }\n     }\n \n+    /**\n+     * Map for storing metrics on a per name basis. Meant to offer fast,\n+     * single-threaded access, but also a loosely consistent, thread safe\n+     * way to iterate over the content.\n+     */\n+    private static class MetricsStore {\n+\n+        private Map<String, AbstractMetric> threadLocalStore;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg2NDM3Mw=="}, "originalCommit": {"oid": "36f0e3ec968615c0a33d86c0c981533ab24606bb"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b3d10fff75cd8bb7feed21635cafc3ef658f214", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/4b3d10fff75cd8bb7feed21635cafc3ef658f214", "committedDate": "2020-11-18T10:39:18Z", "message": "Removed duplicate thread-local map"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMzMxNjI0", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2671#pullrequestreview-533331624", "createdAt": "2020-11-18T11:02:10Z", "commit": {"oid": "4b3d10fff75cd8bb7feed21635cafc3ef658f214"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3538, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}