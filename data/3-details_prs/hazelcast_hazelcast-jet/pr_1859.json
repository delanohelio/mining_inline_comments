{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0NzE2ODQ3", "number": 1859, "title": "Make TestSourceTest more tolerant to hiccups", "bodyText": "Fixes issue #1855\nChecklist\n\n Tags Set\n Milestone Set", "createdAt": "2020-01-20T08:53:43Z", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1859", "merged": true, "mergeCommit": {"oid": "6a6e09214e8fa05db0453837fb5d109edb847aa7"}, "closed": true, "closedAt": "2020-01-20T17:59:05Z", "author": {"login": "jbartok"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8J_U5AFqTM0NTIxMTU3NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8OO12AFqTM0NTM4MTc4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MjExNTc0", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1859#pullrequestreview-345211574", "createdAt": "2020-01-20T10:28:42Z", "commit": {"oid": "14b5395bfa75ea9c477470cab616454fe35ee950"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxMDoyODo0MlrOFfZ0WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxMDoyODo0MlrOFfZ0WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ3MzE3Ng==", "bodyText": "I'd prefer not to depend on Guava for tests, you can rewrite this easily using IntStream.range(). Also it's not clear why you're asserting itemsPerSecond - 1 or itemsPerSecond + 1, maybe the test should be rewritten completely in a more deterministic way.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1859#discussion_r368473176", "createdAt": "2020-01-20T10:28:42Z", "author": {"login": "cangencer"}, "path": "hazelcast-jet-core/src/test/java/com/hazelcast/jet/pipeline/test/TestSourcesTest.java", "diffHunk": "@@ -75,9 +76,11 @@ public void test_itemStream_withWindowing() throws Throwable {\n          .window(WindowDefinition.tumbling(1000))\n          .aggregate(AggregateOperations.counting())\n          .apply(assertCollectedEventually(10, windowResults -> {\n-             // find any window that has 10 items, some may be incomplete due to hiccups\n-             boolean matched = windowResults.stream().anyMatch(r -> r.result() == itemsPerSecond);\n-             assertTrue(\"Did not find any window with 10 items: \" + windowResults, matched);\n+             Range<Integer> range = Range.closed(itemsPerSecond - 1, itemsPerSecond + 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14b5395bfa75ea9c477470cab616454fe35ee950"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd80a58bfcb599c9d090983bf5d206a4da81b05a", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/dd80a58bfcb599c9d090983bf5d206a4da81b05a", "committedDate": "2020-01-20T11:14:08Z", "message": "Make test more tolerant to hick-ups"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d5aee782adeca3306e00b60c827900e171c614e", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/4d5aee782adeca3306e00b60c827900e171c614e", "committedDate": "2020-01-20T11:14:08Z", "message": "Improve test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "09d2f5f863551dd61a8f1302d15f2a7916f537a2", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/09d2f5f863551dd61a8f1302d15f2a7916f537a2", "committedDate": "2020-01-20T11:05:56Z", "message": "Improve test"}, "afterCommit": {"oid": "4d5aee782adeca3306e00b60c827900e171c614e", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/4d5aee782adeca3306e00b60c827900e171c614e", "committedDate": "2020-01-20T11:14:08Z", "message": "Improve test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1Mjk0MjE1", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1859#pullrequestreview-345294215", "createdAt": "2020-01-20T13:06:04Z", "commit": {"oid": "4d5aee782adeca3306e00b60c827900e171c614e"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1Mjk1ODg2", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1859#pullrequestreview-345295886", "createdAt": "2020-01-20T13:09:07Z", "commit": {"oid": "4d5aee782adeca3306e00b60c827900e171c614e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxMzowOToyOVrOFfd0pQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxMzowOToyOVrOFfd0pQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUzODc4OQ==", "bodyText": "this will throw IllegalArgumentException because you can get a negative number here", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1859#discussion_r368538789", "createdAt": "2020-01-20T13:09:29Z", "author": {"login": "cangencer"}, "path": "hazelcast-jet-core/src/test/java/com/hazelcast/jet/pipeline/test/TestSourcesTest.java", "diffHunk": "@@ -74,10 +74,24 @@ public void test_itemStream_withWindowing() throws Throwable {\n          .withNativeTimestamps(0)\n          .window(WindowDefinition.tumbling(1000))\n          .aggregate(AggregateOperations.counting())\n-         .apply(assertCollectedEventually(10, windowResults -> {\n-             // find any window that has 10 items, some may be incomplete due to hiccups\n-             boolean matched = windowResults.stream().anyMatch(r -> r.result() == itemsPerSecond);\n-             assertTrue(\"Did not find any window with 10 items: \" + windowResults, matched);\n+         .apply(assertCollectedEventually(60, windowResults -> {\n+             //look at last 5 windows at most\n+             int windowsToConsider = Math.min(5, windowResults.size());\n+\n+             //count the total no. of items emitted in those windows\n+             int totalItems = windowResults.stream()\n+                     .skip(windowResults.size() - windowsToConsider)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d5aee782adeca3306e00b60c827900e171c614e"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1Mjk3NzY0", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1859#pullrequestreview-345297764", "createdAt": "2020-01-20T13:12:41Z", "commit": {"oid": "4d5aee782adeca3306e00b60c827900e171c614e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxMzoxMjo0MVrOFfd5sA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxMzoxMjo0MVrOFfd5sA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU0MDA4MA==", "bodyText": "now if there is just 1 window and it has 9 items, the test will pass. That's not a very strong assertion.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1859#discussion_r368540080", "createdAt": "2020-01-20T13:12:41Z", "author": {"login": "cangencer"}, "path": "hazelcast-jet-core/src/test/java/com/hazelcast/jet/pipeline/test/TestSourcesTest.java", "diffHunk": "@@ -74,10 +74,24 @@ public void test_itemStream_withWindowing() throws Throwable {\n          .withNativeTimestamps(0)\n          .window(WindowDefinition.tumbling(1000))\n          .aggregate(AggregateOperations.counting())\n-         .apply(assertCollectedEventually(10, windowResults -> {\n-             // find any window that has 10 items, some may be incomplete due to hiccups\n-             boolean matched = windowResults.stream().anyMatch(r -> r.result() == itemsPerSecond);\n-             assertTrue(\"Did not find any window with 10 items: \" + windowResults, matched);\n+         .apply(assertCollectedEventually(60, windowResults -> {\n+             //look at last 5 windows at most\n+             int windowsToConsider = Math.min(5, windowResults.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d5aee782adeca3306e00b60c827900e171c614e"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0e7623194262c99086ac1a78e85a2843b40cb17", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/c0e7623194262c99086ac1a78e85a2843b40cb17", "committedDate": "2020-01-20T15:06:38Z", "message": "Improve test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MzgxNzg4", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1859#pullrequestreview-345381788", "createdAt": "2020-01-20T15:25:16Z", "commit": {"oid": "c0e7623194262c99086ac1a78e85a2843b40cb17"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2919, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}