{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2NzI4OTM5", "number": 1883, "title": "Fix outbox blocking in snapshot phase 2", "bodyText": "This happened:\n\n\nin ProcessorTasklet.processInbox we discovered that a new phase-2 begun\n\n\nthere was an unfinished item in the outbox, so we blocked the outbox and\ndidn't begin the phase-2 in order to ensure that the unfinished item is finished\n\n\nhowever before that, the processor had returned from process() with an\nempty inbox and an unfinished item. Therefore the process went to fillInbox\nand found a WM there. So the state proceeded to PROCESS_WATERMARK, but the\noutbox was still blocked.\n\n\ntryProcessWatermark tried to emit the currentTraverser first, but\ncouldn't because the outbox was blocked. And there it remained stuck, trying\nthat forever.\n\n\nReturning true from tryProcess() or returning an empty inbox and having an\nunfinished item in the outbox is allowed. So we changed the contract of\nsnapshotCommitFinish that it must not add items to outbox and if there's a\nphase-2, we just execute that method and return to where we left.\nFixes #1881\nChecklist\n\n Tags Set\n Milestone Set\n Any breaking changes are documented\n New public APIs have @Nonnull/@Nullable annotations\n New public APIs have @since tags in Javadoc\n For code samples, code sample main readme is updated", "createdAt": "2020-01-24T08:31:53Z", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1883", "merged": true, "mergeCommit": {"oid": "44aedfa9e41b297968dea52181b6c11b6036da1c"}, "closed": true, "closedAt": "2020-01-30T07:43:29Z", "author": {"login": "viliam-durina"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9ast2gH2gAyMzY2NzI4OTM5OmFmMWZjOTM4MTZjNGU0YTIwYTkzZmFlMWExY2U1MTUyMTA1Y2Q0MDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_VeZdAFqTM1MDYyMzk2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "af1fc93816c4e4a20a93fae1a1ce5152105cd404", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/af1fc93816c4e4a20a93fae1a1ce5152105cd404", "committedDate": "2020-01-24T08:30:41Z", "message": "Fix outbox blocking in snapshot phase 2\n\nThis happened:\n\n- in `ProcessorTasklet.processInbox` we discovered that a new phase-2 begun\n\n- there was an unfinished item in the outbox, so we blocked the outbox and\ndidn't begin the phase-2 in order to ensure that the unfinished item is finished\n\n- however before that, the processor had returned from `process()` with an\nempty inbox and an unfinished item. Therefore the process went to `fillInbox`\nand found a WM there. So the state proceeded to PROCESS_WATERMARK, but the\noutbox was still blocked.\n\n- `tryProcessWatermark` tried to emit the `currentTraverser` first, but\ncouldn't because the outbox was blocked. And there it remained stuck, trying\nthat forever.\n\nReturning `true` from `tryProcess()` or returning an empty inbox and having an\nunfinished item in the outbox is allowed. So we changed the contract of\n`snapshotCommitFinish` that it must not add items to outbox and if there's a\nphase-2, we just execute that method and return to where we left.\n\nFixes #1881"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56a2d81e12eca53b03b89c15de26f33fa7961a28", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/56a2d81e12eca53b03b89c15de26f33fa7961a28", "committedDate": "2020-01-27T12:53:21Z", "message": "Merge branch 'master' into blocked-outbox-fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5025f40202bdc48a5bd9dcdc05d01df44ef80605", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/5025f40202bdc48a5bd9dcdc05d01df44ef80605", "committedDate": "2020-01-27T13:07:13Z", "message": "Fix grammar"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMDI2Mjg0", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1883#pullrequestreview-350026284", "createdAt": "2020-01-29T11:09:00Z", "commit": {"oid": "5025f40202bdc48a5bd9dcdc05d01df44ef80605"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMTowOTowMFrOFjEqPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMTowOTowMFrOFjEqPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMyMDgyOA==", "bodyText": "is the double underscore intentional here? looks a little strange", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1883#discussion_r372320828", "createdAt": "2020-01-29T11:09:00Z", "author": {"login": "cangencer"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/execution/ProcessorState.java", "diffHunk": "@@ -73,23 +73,32 @@\n \n     /**\n      * Making calls to {@link Processor#snapshotCommitFinish(boolean)} until it\n-     * returns {@code true}.\n+     * returns {@code true} and then return to {@link #PROCESS_INBOX}. Used\n+     * when phase-2 was initiated while in {@link #PROCESS_INBOX}.\n      */\n-    ON_SNAPSHOT_COMPLETED,\n+    SNAPSHOT_COMMIT_FINISH__PROCESS,\n \n     /**\n-     * Processor completed after a phase 1 of a snapshot and is not doing\n-     * anything, but it cannot be done until a phase 2 is done - this state is\n-     * waiting for a phase 2.\n+     * Making calls to {@link Processor#snapshotCommitFinish(boolean)} until it\n+     * returns {@code true} and then return to {@link #COMPLETE}. Used when\n+     * phase-2 was initiated while in {@link #COMPLETE}.\n      */\n-    WAITING_FOR_SNAPSHOT_COMPLETED,\n+    SNAPSHOT_COMMIT_FINISH__COMPLETE,\n+\n+    /**\n+     * Making calls to {@link Processor#snapshotCommitFinish(boolean)} until it\n+     * returns {@code true} and then proceed to {@link #EMIT_DONE_ITEM}. Used\n+     * when phase-2 was initiated after {@code Processor.complete()} returned\n+     * true.\n+     */\n+    SNAPSHOT_COMMIT_FINISH__FINAL,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5025f40202bdc48a5bd9dcdc05d01df44ef80605"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNjIzOTYz", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1883#pullrequestreview-350623963", "createdAt": "2020-01-30T07:33:22Z", "commit": {"oid": "5025f40202bdc48a5bd9dcdc05d01df44ef80605"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2942, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}