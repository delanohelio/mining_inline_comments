{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwODExMjcw", "number": 2545, "title": "Fix CDC network related test timeouts (issue #2531)", "bodyText": "The CDC Network tests are not entirely deterministic. For example when we want to test some behaviour during snapshotting mode we rely on timeouts to do a certain action hopefully in that time period, which succeeds most of the time, but not always. This is ok (or better than no tests at all), but we need to make sure to not trigger false positive failures, when we are not in the targeted test state.\nCurrent pull request addresses a situation where the MySQL connector's internal reconnect mechanism kicks in and tries to reconnect endlessly, instead of our own reconnect mechanism which would throw an error instead.\nFixes #2531", "createdAt": "2020-09-22T09:34:03Z", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2545", "merged": true, "mergeCommit": {"oid": "a3440fd3df1d0824092c8d5bc8f601e19646d696"}, "closed": true, "closedAt": "2020-09-23T08:16:16Z", "author": {"login": "jbartok"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLTswWgH2gAyNDkwODExMjcwOmE4YTE2ZjMxN2U0MTkzMTE2ZWNlNmFmZGUzOGQ2MGVmOTkxOGIzY2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLn5U9gFqTQ5NDM5NzA1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a8a16f317e4193116ece6afde38d60ef9918b3cd", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/a8a16f317e4193116ece6afde38d60ef9918b3cd", "committedDate": "2020-09-22T08:27:29Z", "message": "Accomodate tests not being deterministic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe9700933b19a9d4c7b19908a1cec8e3a85ab0f5", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/fe9700933b19a9d4c7b19908a1cec8e3a85ab0f5", "committedDate": "2020-09-22T09:35:45Z", "message": "Revert most changes to the Postgres tests, failure is not possible there"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0MjczMTAx", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2545#pullrequestreview-494273101", "createdAt": "2020-09-23T06:46:15Z", "commit": {"oid": "fe9700933b19a9d4c7b19908a1cec8e3a85ab0f5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNjo0NjoxNVrOHWYqeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNjo0NjoxNVrOHWYqeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIzNDgxMA==", "bodyText": "Better to use\nhttps://joel-costigliola.github.io/assertj/core/api/org/assertj/core/api/AbstractThrowableAssert.html#hasRootCauseInstanceOf(java.lang.Class)\nthan a shaded package org.testcontainers.shaded.com.google.common.base.Throwables from testcontainers", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2545#discussion_r493234810", "createdAt": "2020-09-23T06:46:15Z", "author": {"login": "frant-hartm"}, "path": "extensions/cdc-mysql/src/test/java/com/hazelcast/jet/cdc/mysql/MySqlCdcNetworkIntegrationTest.java", "diffHunk": "@@ -407,4 +404,27 @@ private static int findRandomOpenPortInRange(int fromInclusive, int toExclusive)\n         throw new IOException(\"No free port in range [\" + fromInclusive + \", \" +  toExclusive + \")\");\n     }\n \n+    @SuppressWarnings(\"StatementWithEmptyBody\")\n+    private static void assertJobFailsWithConnectException(Job job, boolean lenient) throws InterruptedException {\n+        try {\n+            //wait for job to finish w/ timeout\n+            job.getFuture().get(5, SECONDS);\n+        } catch (TimeoutException te) {\n+            //explicitly cancelling the job because it has not completed so far\n+            job.cancel();\n+\n+            if (lenient) {\n+                //ignore the timeout; not all tests are deterministic, sometimes we don't end up in the state\n+                //we actually want to test\n+            } else {\n+                fail(\"Connection failure not thrown\");\n+            }\n+        } catch (ExecutionException ee) {\n+            //job completed exceptionally, as expected, we check the details of it\n+            Throwable rootCause = Throwables.getRootCause(ee);\n+            assertEquals(JetException.class, rootCause.getClass());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe9700933b19a9d4c7b19908a1cec8e3a85ab0f5"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef0ec2d7850dc30ca914dd3399f31aaddac0711c", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/ef0ec2d7850dc30ca914dd3399f31aaddac0711c", "committedDate": "2020-09-23T07:48:28Z", "message": "Use cleaner assertion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0Mzk3MDU1", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2545#pullrequestreview-494397055", "createdAt": "2020-09-23T07:59:19Z", "commit": {"oid": "ef0ec2d7850dc30ca914dd3399f31aaddac0711c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3628, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}