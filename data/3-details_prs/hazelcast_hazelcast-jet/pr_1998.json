{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3NjMwOTQ3", "number": 1998, "title": "Handle non-serializable exceptions in AsyncOperation", "bodyText": "Sometimes the processors may fail with a non-serializable exception.\nConvert the exception to a String and fail with a generic exception in\nthis case.\nChecklist\n\n Tags Set\n Milestone Set\n\nLinks to issues fixed (if any):\nFixes #1995", "createdAt": "2020-02-20T09:01:34Z", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1998", "merged": true, "mergeCommit": {"oid": "a1e06d387e68710c2d392055ef3d4a114c4a0e7a"}, "closed": true, "closedAt": "2020-02-21T07:25:42Z", "author": {"login": "cangencer"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGHmq0ABqjMwNTQ5OTY4OTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGN8lVAH2gAyMzc3NjMwOTQ3OjYzOGFmNzMxNGQxMGM0Mzc5Yjg1NWNhYTkzNDQ4YjE4ZDk1MTdkZGM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "12e5fec4b860aa95afb36dcab5451b183b4d208a", "author": {"user": {"login": "cangencer", "name": "Can Gencer"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/12e5fec4b860aa95afb36dcab5451b183b4d208a", "committedDate": "2020-02-20T09:00:57Z", "message": "Handle non-serializable exceptions in AsyncOperation\n\nSometimes the processors may fail with a non-serializable exception.\nConvert the exception to a String and fail with a generic exception in\nthis case."}, "afterCommit": {"oid": "44ae6a1d0bf2ea5d39efc509a64993c1f1709a41", "author": {"user": {"login": "cangencer", "name": "Can Gencer"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/44ae6a1d0bf2ea5d39efc509a64993c1f1709a41", "committedDate": "2020-02-20T09:21:31Z", "message": "Handle non-serializable exceptions in AsyncOperation\n\nSometimes the processors may fail with a non-serializable exception.\nConvert the exception to a String and fail with a generic exception in\nthis case."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "44ae6a1d0bf2ea5d39efc509a64993c1f1709a41", "author": {"user": {"login": "cangencer", "name": "Can Gencer"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/44ae6a1d0bf2ea5d39efc509a64993c1f1709a41", "committedDate": "2020-02-20T09:21:31Z", "message": "Handle non-serializable exceptions in AsyncOperation\n\nSometimes the processors may fail with a non-serializable exception.\nConvert the exception to a String and fail with a generic exception in\nthis case."}, "afterCommit": {"oid": "bc0ac02c899822182d7c1194d0aad5ea5d2aa42d", "author": {"user": {"login": "cangencer", "name": "Can Gencer"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/bc0ac02c899822182d7c1194d0aad5ea5d2aa42d", "committedDate": "2020-02-20T10:21:03Z", "message": "Handle non-serializable exceptions in AsyncOperation\n\nSometimes the processors may fail with a non-serializable exception.\nConvert the exception to a String and fail with a generic exception in\nthis case."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc0ac02c899822182d7c1194d0aad5ea5d2aa42d", "author": {"user": {"login": "cangencer", "name": "Can Gencer"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/bc0ac02c899822182d7c1194d0aad5ea5d2aa42d", "committedDate": "2020-02-20T10:21:03Z", "message": "Handle non-serializable exceptions in AsyncOperation\n\nSometimes the processors may fail with a non-serializable exception.\nConvert the exception to a String and fail with a generic exception in\nthis case."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0617a5218280d67bd0830efa6a3887dd37f26f0", "author": {"user": {"login": "cangencer", "name": "Can Gencer"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/d0617a5218280d67bd0830efa6a3887dd37f26f0", "committedDate": "2020-02-20T12:44:36Z", "message": "handle Status & StatusRuntimeException explicitly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "088012553b84963dd8994c89b260b056af5f226d", "author": {"user": {"login": "olukas", "name": "Ondrej Lukas"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/088012553b84963dd8994c89b260b056af5f226d", "committedDate": "2020-02-20T13:24:51Z", "message": "Add test for Exception in Python code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed5b754a20a88b3df949886147c1a96d828f8440", "author": {"user": {"login": "cangencer", "name": "Can Gencer"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/ed5b754a20a88b3df949886147c1a96d828f8440", "committedDate": "2020-02-20T13:29:03Z", "message": "Merge pull request #2 from olukas/response-exc-handling\n\nAdd test for Exception in Python code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxOTI0NzIx", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1998#pullrequestreview-361924721", "createdAt": "2020-02-20T14:04:28Z", "commit": {"oid": "ed5b754a20a88b3df949886147c1a96d828f8440"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxOTc5MTgy", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1998#pullrequestreview-361979182", "createdAt": "2020-02-20T15:08:56Z", "commit": {"oid": "ed5b754a20a88b3df949886147c1a96d828f8440"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNTowODo1NlrOFsXEAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNToxNDozNlrOFsXTng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1OTUyMw==", "bodyText": "Bad indentation", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1998#discussion_r382059523", "createdAt": "2020-02-20T15:08:56Z", "author": {"login": "viliam-durina"}, "path": "extensions/python/src/test/java/com/hazelcast/jet/python/PythonServiceTest.java", "diffHunk": "@@ -49,7 +49,12 @@\n     private static final int ITEM_COUNT = 10_000;\n     private static final String ECHO_HANDLER_FUNCTION =\n             \"def handle(input_list):\\n\" +\n-            \"    return ['echo-%s' % i for i in input_list]\\n\";\n+ \"    return ['echo-%s' % i for i in input_list]\\n\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed5b754a20a88b3df949886147c1a96d828f8440"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1OTYyOQ==", "bodyText": "serializable", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1998#discussion_r382059629", "createdAt": "2020-02-20T15:09:07Z", "author": {"login": "viliam-durina"}, "path": "extensions/python/src/main/java/com/hazelcast/jet/python/PythonService.java", "diffHunk": "@@ -128,6 +131,11 @@ public void onNext(OutputMessage outputItem) {\n         @Override\n         public void onError(Throwable e) {\n             try {\n+                if (e instanceof StatusException || e instanceof StatusRuntimeException) {\n+                    // not seriazliable exceptions", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed5b754a20a88b3df949886147c1a96d828f8440"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA2MjY0NQ==", "bodyText": "I would expand this comment, something like:\n\nSometimes exceptions are not serializable. For example #1995. When sending exception as a response and the serialization fails, the response will not be sent and the operation will hang. If it happened, replace it with another exception that can be serialized.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1998#discussion_r382062645", "createdAt": "2020-02-20T15:13:26Z", "author": {"login": "viliam-durina"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/operation/AsyncOperation.java", "diffHunk": "@@ -73,7 +76,17 @@ private void doSendResponse(Object value) {\n             final JetService service = getService();\n             service.getLiveOperationRegistry().deregister(this);\n         } finally {\n-            sendResponse(value);\n+            try {\n+                sendResponse(value);\n+            } catch (Exception e) {\n+                Throwable ex = peel(e);\n+                if (value instanceof Throwable && ex instanceof HazelcastSerializationException) {\n+                    // we got a non-serializable exception here", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed5b754a20a88b3df949886147c1a96d828f8440"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA2MzUxOA==", "bodyText": "This line probably isn't necessary. Also can't assertions be turned off as in java?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1998#discussion_r382063518", "createdAt": "2020-02-20T15:14:36Z", "author": {"login": "viliam-durina"}, "path": "extensions/python/src/test/java/com/hazelcast/jet/python/PythonServiceTest.java", "diffHunk": "@@ -49,7 +49,12 @@\n     private static final int ITEM_COUNT = 10_000;\n     private static final String ECHO_HANDLER_FUNCTION =\n             \"def handle(input_list):\\n\" +\n-            \"    return ['echo-%s' % i for i in input_list]\\n\";\n+ \"    return ['echo-%s' % i for i in input_list]\\n\";\n+\n+    private static final String FAILING_FUNCTION\n+            = \"def handle(input_list):\\n\"\n+            + \"    assert 1 == 2\\n\"\n+            + \"    return ['echo-%s' % i for i in input_list]\\n\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed5b754a20a88b3df949886147c1a96d828f8440"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxOTg0NTM0", "url": "https://github.com/hazelcast/hazelcast-jet/pull/1998#pullrequestreview-361984534", "createdAt": "2020-02-20T15:14:58Z", "commit": {"oid": "ed5b754a20a88b3df949886147c1a96d828f8440"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "638af7314d10c4379b855caa93448b18d9517ddc", "author": {"user": {"login": "cangencer", "name": "Can Gencer"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/638af7314d10c4379b855caa93448b18d9517ddc", "committedDate": "2020-02-20T16:44:34Z", "message": "address review"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2870, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}