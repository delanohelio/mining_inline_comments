{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5NTE5NzU5", "number": 2218, "title": "[011] Json File Source", "bodyText": "add jackson-jr-all as a shaded library\nadd option to create FileSource for json files with object mapping\nAdd description here\nChecklist\n\n Tags Set\n Milestone Set\n Any breaking changes are documented\n New public APIs have @Nonnull/@Nullable annotations\n New public APIs have @since tags in Javadoc\n For code samples, code sample main readme is updated\n\nLinks to issues fixed (if any):\nFixes #NNNN\nList of breaking changes:\n\n..", "createdAt": "2020-04-27T13:57:39Z", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2218", "merged": true, "mergeCommit": {"oid": "e9ee9cbd3b69055be5ada0533e31d68ececc89d7"}, "closed": true, "closedAt": "2020-05-06T12:14:42Z", "author": {"login": "gurbuzali"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccpKISABqjMyODgyNTUzMzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcemLYXAH2gAyNDA5NTE5NzU5OjVmNzI4MmMxMWRjY2EyMGYwMTU1ZTYwMmQ4Y2MxNTJjYzk0OGI3N2Q=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0887ef3af0f05f6db284fd64b1171456725eaa3b", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/0887ef3af0f05f6db284fd64b1171456725eaa3b", "committedDate": "2020-04-30T08:50:39Z", "message": "resolve conflict"}, "afterCommit": {"oid": "1b13e85b60fd06ddb65eea7ffe5aacf8af1a9511", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/1b13e85b60fd06ddb65eea7ffe5aacf8af1a9511", "committedDate": "2020-04-30T08:52:52Z", "message": "resolve conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3b3d6c8f9bcc7143f1ca040c7f481dcdb660441", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/a3b3d6c8f9bcc7143f1ca040c7f481dcdb660441", "committedDate": "2020-04-30T08:54:14Z", "message": "add jackson-jr-all as a shaded library\nadd option to create FileSource for json files with object mapping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aef4efefeb94ee4af6f7b50b8c6804b09064a56a", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/aef4efefeb94ee4af6f7b50b8c6804b09064a56a", "committedDate": "2020-04-30T08:54:15Z", "message": "add Nonnull tag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c76e9562eb2393b583b0a220f76b4b4779cb9b9", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/3c76e9562eb2393b583b0a220f76b4b4779cb9b9", "committedDate": "2020-04-30T08:55:43Z", "message": "remove StreamJsonParser use ValueIterator instead"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23ddc88a126fb40172db16e441fa97b998ffc868", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/23ddc88a126fb40172db16e441fa97b998ffc868", "committedDate": "2020-04-30T08:57:28Z", "message": "add parseToMap option to JsonUtil"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1b13e85b60fd06ddb65eea7ffe5aacf8af1a9511", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/1b13e85b60fd06ddb65eea7ffe5aacf8af1a9511", "committedDate": "2020-04-30T08:52:52Z", "message": "resolve conflicts"}, "afterCommit": {"oid": "23ddc88a126fb40172db16e441fa97b998ffc868", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/23ddc88a126fb40172db16e441fa97b998ffc868", "committedDate": "2020-04-30T08:57:28Z", "message": "add parseToMap option to JsonUtil"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55b86ada6a0c88660cebe4724c19dc97ec979490", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/55b86ada6a0c88660cebe4724c19dc97ec979490", "committedDate": "2020-04-30T09:01:51Z", "message": "add jackson-jr to NOTICE"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMjgwNDQw", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2218#pullrequestreview-403280440", "createdAt": "2020-04-30T07:49:06Z", "commit": {"oid": "7b2759ec3c4be6242e52671363399c96c98deef2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwNzo0OTowN1rOGOdu8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwOTo1MjoxNVrOGOiE7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgyMDQwMA==", "bodyText": "This is problematic, because it will re-parse the JSON string every time you fetch one key-value pair from it. Now that I have used Jackson jr a bit too, I think that we don't actually need these methods (I mean all methods that return primitives, arrays, lists, sub-maps), it's would be enough to keep the one that returns the full map. Sorry for having lead you in the wrong direction initially.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2218#discussion_r417820400", "createdAt": "2020-04-30T07:49:07Z", "author": {"login": "jbartok"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/json/JsonUtil.java", "diffHunk": "@@ -28,14 +32,67 @@ private JsonUtil() {\n     /**\n      * Converts a JSON string to a object of given type.\n      */\n-    public static <T> T map(Class<T> type, String jsonString) {\n+    public static <T> T parse(Class<T> type, String jsonString) {\n         return uncheckCall(() -> JSON.std.beanFrom(type, jsonString));\n     }\n \n+    /**\n+     * Converts a JSON string to a {@link Map}.\n+     */\n+    public static Map<String, Object> parse(String jsonString) {\n+        return uncheckCall(() -> JSON.std.with(Feature.READ_ONLY).mapFrom(jsonString));\n+    }\n+\n+    /**\n+     * Extracts a string value from given JSON string.\n+     */\n+    public static String getString(String jsonString, String key) {\n+        return (String) parse(jsonString).get(key);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b2759ec3c4be6242e52671363399c96c98deef2"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgyMzUxOA==", "bodyText": "One problem I've come across when using Jackson jr is that I needed annotation support for renaming fields (for example had first_name in JSON and wanted a mapping class field name like firstName so I needed to use @JsonProperty to translate it). To use annotation support I had to use a JSON like JSON.builder().register(JacksonAnnotationExtension.std).build() as opposed to JSON.std to do the mapping. I would not be able to do the same thing with the methods provided by this utility class, as it stands right now.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2218#discussion_r417823518", "createdAt": "2020-04-30T07:54:51Z", "author": {"login": "jbartok"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/json/JsonUtil.java", "diffHunk": "@@ -28,14 +32,67 @@ private JsonUtil() {\n     /**\n      * Converts a JSON string to a object of given type.\n      */\n-    public static <T> T map(Class<T> type, String jsonString) {\n+    public static <T> T parse(Class<T> type, String jsonString) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b2759ec3c4be6242e52671363399c96c98deef2"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg5MDcyNw==", "bodyText": "Maybe a JSON manipulation should be inside the JsonUtil class and Jackson jr not be exposed anywhere else?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2218#discussion_r417890727", "createdAt": "2020-04-30T09:50:44Z", "author": {"login": "jbartok"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/pipeline/FileSourceBuilder.java", "diffHunk": "@@ -161,6 +168,31 @@ public FileSourceBuilder charset(@Nonnull Charset charset) {\n                 SourceProcessors.readFilesP(directory, glob, sharedFileSystem, readFileFn));\n     }\n \n+    /**\n+     * Builds a JSON file {@link BatchSource} with supplied components. The\n+     * source expects a stream of JSON objects as the content of the file.\n+     <p>\n+     * The source does not save any state to snapshot. If the job is restarted,\n+     * it will re-emit all entries.\n+     * <p>\n+     * Any {@code IOException} will cause the job to fail. The files must not\n+     * change while being read; if they do, the behavior is unspecified.\n+     * <p>\n+     * The default local parallelism for this processor is 2 (or 1 if just 1\n+     * CPU is available).\n+     *\n+     */\n+    public <T> BatchSource<T> buildJson(@Nonnull Class<T> type) {\n+        String charsetName = charset.name();\n+        return build(path -> {\n+            InputStreamReader reader = new InputStreamReader(new FileInputStream(path.toFile()), charsetName);\n+            ValueIterator<T> valueIterator = JSON.std.beanSequenceFrom(type, reader);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55b86ada6a0c88660cebe4724c19dc97ec979490"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg5MTU2Ng==", "bodyText": "Maybe use Jackson jr annotation support to get rid of all those getters & setters?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2218#discussion_r417891566", "createdAt": "2020-04-30T09:52:15Z", "author": {"login": "jbartok"}, "path": "hazelcast-jet-core/src/test/java/com/hazelcast/jet/impl/connector/ReadFilesPTest.java", "diffHunk": "@@ -121,10 +148,78 @@ private Pipeline buildDag(String glob) {\n         return p;\n     }\n \n-    private void finishDirectory(File ... files) {\n+    private Pipeline pipelineJson() {\n+        Pipeline p = Pipeline.create();\n+        p.readFrom(Sources.filesBuilder(directory.getPath())\n+                          .buildJson(TestPerson.class))\n+         .writeTo(Sinks.list(listJson));\n+\n+        return p;\n+    }\n+\n+    private void finishDirectory(File... files) {\n         for (File file : files) {\n             assertTrue(file.delete());\n         }\n         assertTrue(directory.delete());\n     }\n+\n+    public static class TestPerson implements Serializable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55b86ada6a0c88660cebe4724c19dc97ec979490"}, "originalPosition": 118}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a55a8dc933ac7026ca3022aee36090ee5f695a56", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/a55a8dc933ac7026ca3022aee36090ee5f695a56", "committedDate": "2020-05-05T13:28:24Z", "message": "re-shade jackson-core, address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "540b61cd9ced24bcfcc8365e57c91faf62ab7525", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/540b61cd9ced24bcfcc8365e57c91faf62ab7525", "committedDate": "2020-05-05T13:51:41Z", "message": "check availability of jackson-annotations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2NDE1Njg5", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2218#pullrequestreview-406415689", "createdAt": "2020-05-06T08:49:39Z", "commit": {"oid": "540b61cd9ced24bcfcc8365e57c91faf62ab7525"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f7282c11dcca20f0155e602d8cc152cc948b77d", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/5f7282c11dcca20f0155e602d8cc152cc948b77d", "committedDate": "2020-05-06T10:32:38Z", "message": "fix test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3758, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}