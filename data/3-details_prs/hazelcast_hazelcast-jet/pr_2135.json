{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3NTY2MDEw", "number": 2135, "title": "Fix race asserting RUNNING status and restarting", "bodyText": "Fixes #2132", "createdAt": "2020-04-02T13:05:30Z", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2135", "merged": true, "mergeCommit": {"oid": "3b34d366995907b13e52b2291e159d4d94694498"}, "closed": true, "closedAt": "2020-04-03T13:49:54Z", "author": {"login": "viliam-durina"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTr-OwAH2gAyMzk3NTY2MDEwOmNlYTQyYjcyOTY5NzRlNTNlYTU1YTZmMmNiM2Y0YTM4YTk1NmQ5Zjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcUATVQgFqTM4NzIyMTY1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cea42b7296974e53ea55a6f2cb3f4a38a956d9f8", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/cea42b7296974e53ea55a6f2cb3f4a38a956d9f8", "committedDate": "2020-04-02T13:04:32Z", "message": "Fix race asserting RUNNING status and restarting\n\nFixes #2132"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2OTYxNjAx", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2135#pullrequestreview-386961601", "createdAt": "2020-04-03T06:19:20Z", "commit": {"oid": "cea42b7296974e53ea55a6f2cb3f4a38a956d9f8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNjoxOToyMVrOGAGcfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNjoxOToyMVrOGAGcfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc1ODc4MA==", "bodyText": "Can we rename this method please? It does not assert whether job is running but whether job was restarted (and running).\nIf this method is called independently on job.restart(); it will never return. Should not be rather job.restart(); called inside this method to have it more clear and robust?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2135#discussion_r402758780", "createdAt": "2020-04-03T06:19:21Z", "author": {"login": "olukas"}, "path": "hazelcast-jet-core/src/test/java/com/hazelcast/jet/core/JetTestSupport.java", "diffHunk": "@@ -146,6 +148,44 @@ public static void assertJobStatusEventually(Job job, JobStatus expected) {\n         assertJobStatusEventually(job, expected, ASSERT_TRUE_EVENTUALLY_TIMEOUT);\n     }\n \n+    /**\n+     * Asserts that a job status is eventually RUNNING. When it's running,\n+     * checks that the execution ID is different from the given {@code\n+     * ignoredExecutionId}, if not, tries again.\n+     * <p>\n+     * This is useful when checking that the job is running after a restart:\n+     * <pre>{@code\n+     *     job.restart();\n+     *     // This is racy, we might see the previous execution running.\n+     *     // Subsequent steps can fail because the job is restarting.\n+     *     assertJobStatusEventually(job, RUNNING);\n+     * }</pre>\n+     *\n+     * This method allows an equivalent code:\n+     * <pre>{@code\n+     *     long oldExecutionId = assertJobRunningEventually(instance, job, null);\n+     *     // now we're sure the job is safe to restart - restart fails if the job isn't running\n+     *     job.restart();\n+     *     assertJobRunningEventually(instance, job, oldExecutionId);\n+     *     // now we're sure that a new execution is running\n+     * }</pre>\n+     *\n+     * @param ignoredExecutionId If job is running and has this execution ID,\n+     *      wait longer. If null, no execution ID is ignored.\n+     * @return the execution ID of the new execution\n+     */\n+    public static long assertJobRunningEventually(JetInstance instance, Job job, Long ignoredExecutionId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cea42b7296974e53ea55a6f2cb3f4a38a956d9f8"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3MjIxNjU5", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2135#pullrequestreview-387221659", "createdAt": "2020-04-03T12:45:41Z", "commit": {"oid": "cea42b7296974e53ea55a6f2cb3f4a38a956d9f8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2766, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}