{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzMTQ5MTY5", "number": 2566, "title": "Define package of the class before defining the class in JetClassLoader", "bodyText": "Currently JetClassLoader loads the configured classes but does not define their\npackages. According to the javadoc of ClassLoader#definePackage it should\nbe defined prior to definig the class:\n     * Defines a package by name in this <tt>ClassLoader</tt>.  This allows\n     * class loaders to define the packages for their classes. Packages must\n     * be created before the class is defined, and package names must be\n     * unique within a class loader and cannot be redefined or changed once\n     * created.\n\nNot defining the package results in issues for the avro, the implementation\nrelies on that the package of the class while creating the schema.\nChecklist\n\n Labels and Milestone set\n[NA] Breaking changes documented\n[NA] New public APIs have @Nonnull/@Nullable annotations\n[NA] New public APIs have @since tags in Javadoc\n[NA] For code samples, code sample main readme is updated", "createdAt": "2020-09-25T15:27:53Z", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2566", "merged": true, "mergeCommit": {"oid": "f08a75d1bd501a47a0c9f3f61fc554e6635d10a1"}, "closed": true, "closedAt": "2020-10-01T10:03:23Z", "author": {"login": "gurbuzali"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMXZjLgH2gAyNDkzMTQ5MTY5OjllNzQ5MjlhNWI2MDk0OGU5NDRjZGY2NWMwOTdhMjYzODMzY2Y4M2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdN3o5bAFqTQ5OTE1MjE2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9e74929a5b60948e944cdf65c097a263833cf83f", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/9e74929a5b60948e944cdf65c097a263833cf83f", "committedDate": "2020-09-25T15:20:03Z", "message": "define package of the class before defining the class in JetClassLoader"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MjgyOTE3", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2566#pullrequestreview-497282917", "createdAt": "2020-09-28T08:16:06Z", "commit": {"oid": "9e74929a5b60948e944cdf65c097a263833cf83f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQwODoxNjowNlrOHYzDVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQwODoyMjozM1rOHYzRAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTc2NDMwOQ==", "bodyText": "This method was deprecated in java9. I've read a bit why, but am not sure how to fix it in java8. But it's only an issue if multiple class loaders define the same packages, but I'd say it's not common. The purpose of defining the package is to make package annotations available, and if one uses package annotations, he doesn't use a package name that's likely to be used in some other library...\nSo consider this comment just a thinking aloud, we can live with this code for a while :)", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2566#discussion_r495764309", "createdAt": "2020-09-28T08:16:06Z", "author": {"login": "viliam-durina"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/deployment/JetClassLoader.java", "diffHunk": "@@ -80,9 +80,37 @@ public JetClassLoader(\n                     + \" or start all members with it on classpath\");\n         }\n         byte[] classBytes = uncheckCall(() -> IOUtil.toByteArray(classBytesStream));\n+        definePackage(name);\n         return defineClass(name, classBytes, 0, classBytes.length);\n     }\n \n+    /**\n+     * Defines the package if it is not already defined for the given class\n+     * name.\n+     *\n+     * @param className the class name\n+     */\n+    private void definePackage(String className) {\n+        if (isEmpty(className)) {\n+            return;\n+        }\n+        int lastDotIndex = className.lastIndexOf('.');\n+        if (lastDotIndex == -1) {\n+            return;\n+        }\n+        String packageName = className.substring(0, lastDotIndex);\n+        if (getPackage(packageName) != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e74929a5b60948e944cdf65c097a263833cf83f"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTc2NzgwOA==", "bodyText": "This is certainly not correct. I'm not sure but i think that the values need to be loaded from the manifest file, or rather we can just pass in nulls, as I saw in several examples on the web. We certainly should not pass jet's meta informations to user's packages.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2566#discussion_r495767808", "createdAt": "2020-09-28T08:22:33Z", "author": {"login": "viliam-durina"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/deployment/JetClassLoader.java", "diffHunk": "@@ -80,9 +80,37 @@ public JetClassLoader(\n                     + \" or start all members with it on classpath\");\n         }\n         byte[] classBytes = uncheckCall(() -> IOUtil.toByteArray(classBytesStream));\n+        definePackage(name);\n         return defineClass(name, classBytes, 0, classBytes.length);\n     }\n \n+    /**\n+     * Defines the package if it is not already defined for the given class\n+     * name.\n+     *\n+     * @param className the class name\n+     */\n+    private void definePackage(String className) {\n+        if (isEmpty(className)) {\n+            return;\n+        }\n+        int lastDotIndex = className.lastIndexOf('.');\n+        if (lastDotIndex == -1) {\n+            return;\n+        }\n+        String packageName = className.substring(0, lastDotIndex);\n+        if (getPackage(packageName) != null) {\n+            return;\n+        }\n+        Package clPackage = JetClassLoader.class.getPackage();\n+        try {\n+            definePackage(packageName, clPackage.getSpecificationTitle(), clPackage.getSpecificationVersion(),\n+                    clPackage.getSpecificationVendor(), clPackage.getImplementationTitle(),\n+                    clPackage.getImplementationVersion(), clPackage.getImplementationVendor(), null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e74929a5b60948e944cdf65c097a263833cf83f"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c93aa3b58c0b5c45b15236a15e0daf0e5197fb22", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/c93aa3b58c0b5c45b15236a15e0daf0e5197fb22", "committedDate": "2020-09-30T05:53:18Z", "message": "pass null while defining package instead of our metadata"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ec8860c4e50569dc28086ade9486cb9f675a043", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/9ec8860c4e50569dc28086ade9486cb9f675a043", "committedDate": "2020-09-30T06:07:24Z", "message": "checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5MTUyMTYy", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2566#pullrequestreview-499152162", "createdAt": "2020-09-30T07:27:42Z", "commit": {"oid": "9ec8860c4e50569dc28086ade9486cb9f675a043"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3449, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}