{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3NzMzMDc3", "number": 2061, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMDo0MDowNVrODoRj3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMDo0MDowNVrODoRj3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNTU3MzQzOnYy", "diffSide": "RIGHT", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/serialization/DelegatingSerializationService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMDo0MDowNVrOF2uQiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMToyMzo0NFrOF2vpYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjkyNTMyMA==", "bodyText": "We should not depend on the exact text from the superclass. We also lose the stack trace of the original exc.\nI'd rather just wrap the caught exception, use the original message and append a text to it.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            throw handle(typeId, hse);\n          \n          \n            \n                            throw new HazelcastSerializationException(hse.getMessage() + \". You can register a job-specific serializer using JobConfig.registerSerializer()\", hse);\n          \n      \n    \n    \n  \n\nIf we also dispose the delegate (which we should), we wouldn't have to handle the inactive case: the delegate will throw HazelcastInstanceNotActiveException directly.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2061#discussion_r392925320", "createdAt": "2020-03-16T10:40:05Z", "author": {"login": "viliam-durina"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/serialization/DelegatingSerializationService.java", "diffHunk": "@@ -108,33 +108,57 @@ public PortableContext getPortableContext() {\n \n     @Override\n     public SerializerAdapter serializerFor(Object object) {\n-        Class<?> clazz = object.getClass();\n-        SerializerAdapter serializer = serializersByClass.get(clazz);\n+        Class<?> clazz = object == null ? null : object.getClass();\n+\n+        SerializerAdapter serializer = null;\n+        if (clazz != null) {\n+            serializer = serializersByClass.get(clazz);\n+        }\n         if (serializer == null) {\n-            serializer = delegate.serializerFor(object);\n-            if (serializer == null) {\n-                throw active ?\n-                        new HazelcastSerializationException(\"There is no suitable serializer for \" + clazz) :\n-                        new HazelcastInstanceNotActiveException();\n+            try {\n+                serializer = delegate.serializerFor(object);\n+            } catch (HazelcastSerializationException hse) {\n+                throw handle(clazz, hse);\n             }\n         }\n+        if (serializer == null) {\n+            throw active ? new MissingSerializer(clazz) : new HazelcastInstanceNotActiveException();\n+        }\n         return serializer;\n     }\n \n+    private RuntimeException handle(Class<?> clazz, HazelcastSerializationException e) {\n+        String message = e.getMessage();\n+        if (message != null && message.startsWith(\"There is no suitable serializer for\")) {\n+            return new MissingSerializer(clazz);\n+        }\n+        return e;\n+    }\n+\n     @Override\n     public SerializerAdapter serializerFor(int typeId) {\n         SerializerAdapter serializer = serializersById.get(typeId);\n         if (serializer == null) {\n-            serializer = delegate.serializerFor(typeId);\n-            if (serializer == null) {\n-                throw active ?\n-                        newHazelcastSerializationException(typeId) :\n-                        new HazelcastInstanceNotActiveException();\n+            try {\n+                serializer = delegate.serializerFor(typeId);\n+            } catch (HazelcastSerializationException hse) {\n+                throw handle(typeId, hse);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d70a9c39bba5b44476af3ad75dec618ff9170c04"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0ODA2NQ==", "bodyText": "We should not dispose() delegate as it's a global serializer. I have addressed the remaining comment.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2061#discussion_r392948065", "createdAt": "2020-03-16T11:23:44Z", "author": {"login": "gierlachg"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/serialization/DelegatingSerializationService.java", "diffHunk": "@@ -108,33 +108,57 @@ public PortableContext getPortableContext() {\n \n     @Override\n     public SerializerAdapter serializerFor(Object object) {\n-        Class<?> clazz = object.getClass();\n-        SerializerAdapter serializer = serializersByClass.get(clazz);\n+        Class<?> clazz = object == null ? null : object.getClass();\n+\n+        SerializerAdapter serializer = null;\n+        if (clazz != null) {\n+            serializer = serializersByClass.get(clazz);\n+        }\n         if (serializer == null) {\n-            serializer = delegate.serializerFor(object);\n-            if (serializer == null) {\n-                throw active ?\n-                        new HazelcastSerializationException(\"There is no suitable serializer for \" + clazz) :\n-                        new HazelcastInstanceNotActiveException();\n+            try {\n+                serializer = delegate.serializerFor(object);\n+            } catch (HazelcastSerializationException hse) {\n+                throw handle(clazz, hse);\n             }\n         }\n+        if (serializer == null) {\n+            throw active ? new MissingSerializer(clazz) : new HazelcastInstanceNotActiveException();\n+        }\n         return serializer;\n     }\n \n+    private RuntimeException handle(Class<?> clazz, HazelcastSerializationException e) {\n+        String message = e.getMessage();\n+        if (message != null && message.startsWith(\"There is no suitable serializer for\")) {\n+            return new MissingSerializer(clazz);\n+        }\n+        return e;\n+    }\n+\n     @Override\n     public SerializerAdapter serializerFor(int typeId) {\n         SerializerAdapter serializer = serializersById.get(typeId);\n         if (serializer == null) {\n-            serializer = delegate.serializerFor(typeId);\n-            if (serializer == null) {\n-                throw active ?\n-                        newHazelcastSerializationException(typeId) :\n-                        new HazelcastInstanceNotActiveException();\n+            try {\n+                serializer = delegate.serializerFor(typeId);\n+            } catch (HazelcastSerializationException hse) {\n+                throw handle(typeId, hse);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjkyNTMyMA=="}, "originalCommit": {"oid": "d70a9c39bba5b44476af3ad75dec618ff9170c04"}, "originalPosition": 50}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4900, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}