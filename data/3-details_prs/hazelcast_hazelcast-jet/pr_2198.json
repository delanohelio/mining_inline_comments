{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1ODg0MjAw", "number": 2198, "title": "Add toKeyFn/toValueFn to WriteMapP", "bodyText": "Add toKeyFn/toValueFn to WriteMapP\nAdd convenience for HazelcastJsonValue\nChecklist\n\n Tags Set\n Milestone Set\n Any breaking changes are documented\n New public APIs have @Nonnull/@Nullable annotations\n New public APIs have @since tags in Javadoc\n[NA] For code samples, code sample main readme is updated\n\nLinks to issues fixed (if any):\nFixes #NNNN\nList of breaking changes:\n\n..", "createdAt": "2020-04-20T07:40:45Z", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2198", "merged": true, "mergeCommit": {"oid": "1f24b3f0cdfde5e9b3e5db85185903755404175b"}, "closed": true, "closedAt": "2020-04-30T08:39:02Z", "author": {"login": "gurbuzali"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZaFu9gH2gAyNDA1ODg0MjAwOjI3ZDhlOTg1MDQyNGY5M2RmNGRjNzBiY2UzYzJiOGY1NDBjYzJiMTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccn2b1gFqTQwMzI2MjcxNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "27d8e9850424f93df4dc70bce3c2b8f540cc2b18", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/27d8e9850424f93df4dc70bce3c2b8f540cc2b18", "committedDate": "2020-04-20T07:37:59Z", "message": "Add toKeyFn/toValueFn to WriteMapP, add convenience for HazelcastJsonValue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2663a3c6ff61add530ec5ce06fa5ef8004cdd4a", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/d2663a3c6ff61add530ec5ce06fa5ef8004cdd4a", "committedDate": "2020-04-20T07:42:35Z", "message": "add since tag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9e423f638b4d2775662282abe7b8ecf00814771", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/a9e423f638b4d2775662282abe7b8ecf00814771", "committedDate": "2020-04-20T08:47:49Z", "message": "fix default writeMapP"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NDg4NTU0", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2198#pullrequestreview-396488554", "createdAt": "2020-04-20T14:08:49Z", "commit": {"oid": "a9e423f638b4d2775662282abe7b8ecf00814771"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNDowODo0OVrOGIWXxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNDoxNTozNFrOGIWtBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQwODMyNQ==", "bodyText": "I don't think this overload adds much, and is a bit confusing. It should be enough to provide the function reference ? i.e. JsonUtil::asJson or something so I would just remove this variant and mention it in javadoc", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2198#discussion_r411408325", "createdAt": "2020-04-20T14:08:49Z", "author": {"login": "cangencer"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/pipeline/Sinks.java", "diffHunk": "@@ -109,7 +111,52 @@ private Sinks() {\n      */\n     @Nonnull\n     public static <K, V> Sink<Entry<K, V>> map(@Nonnull String mapName) {\n-        return new SinkImpl<>(\"mapSink(\" + mapName + ')', writeMapP(mapName), false, entryKey());\n+        return map(mapName, Entry::getKey, Entry::getValue);\n+    }\n+\n+    /**\n+     * Returns a sink that converts the key and value of {@code Map.Entry}s it\n+     * receives to {@link HazelcastJsonValue} and put them into a Hazelcast\n+     * {@code IMap} with the specified name.\n+     * <p>\n+     * This sink provides the exactly-once guarantee thanks to <i>idempotent\n+     * updates</i>. It means that the value with the same key is not appended,\n+     * but overwritten. After the job is restarted from snapshot, duplicate\n+     * items will not change the state in the target map.\n+     * <p>\n+     * The default local parallelism for this sink is 1.\n+     *\n+     * @since 4.1\n+     */\n+    @Nonnull\n+    public static <K, V> Sink<Entry<K, V>> map(@Nonnull String mapName, boolean jsonKey, boolean jsonValue) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9e423f638b4d2775662282abe7b8ecf00814771"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQxMTkyNw==", "bodyText": "should also be called item", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2198#discussion_r411411927", "createdAt": "2020-04-20T14:13:19Z", "author": {"login": "cangencer"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/connector/WriteMapP.java", "diffHunk": "@@ -62,23 +70,31 @@ public void init(@Nonnull Outbox outbox, @Nonnull Context context) {\n \n         if (map instanceof MapProxyImpl) {\n             PartitioningStrategy<?> partitionStrategy = ((MapProxyImpl<K, V>) map).getPartitionStrategy();\n-            addToBuffer = entry -> {\n-                Data key = serializationService.toData(entry.getKey(), partitionStrategy);\n-                Data value = serializationService.toData(entry.getValue());\n+            addToBuffer = item -> {\n+                Data key = serializationService.toData(key(item), partitionStrategy);\n+                Data value = serializationService.toData(value(item));\n                 buffer.add(new SimpleEntry<>(key, value));\n             };\n         } else if (map instanceof ClientMapProxy) {\n             // TODO: add strategy/unify after https://github.com/hazelcast/hazelcast/issues/13950 is fixed\n             addToBuffer = entry -> {\n-                Data key = serializationService.toData(entry.getKey());\n-                Data value = serializationService.toData(entry.getValue());\n+                Data key = serializationService.toData(key(entry));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9e423f638b4d2775662282abe7b8ecf00814771"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQxMzY5NQ==", "bodyText": "missing overload for map(IMap<K,V>)..", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2198#discussion_r411413695", "createdAt": "2020-04-20T14:15:28Z", "author": {"login": "cangencer"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/pipeline/Sinks.java", "diffHunk": "@@ -109,7 +111,52 @@ private Sinks() {\n      */\n     @Nonnull\n     public static <K, V> Sink<Entry<K, V>> map(@Nonnull String mapName) {\n-        return new SinkImpl<>(\"mapSink(\" + mapName + ')', writeMapP(mapName), false, entryKey());\n+        return map(mapName, Entry::getKey, Entry::getValue);\n+    }\n+\n+    /**\n+     * Returns a sink that converts the key and value of {@code Map.Entry}s it\n+     * receives to {@link HazelcastJsonValue} and put them into a Hazelcast\n+     * {@code IMap} with the specified name.\n+     * <p>\n+     * This sink provides the exactly-once guarantee thanks to <i>idempotent\n+     * updates</i>. It means that the value with the same key is not appended,\n+     * but overwritten. After the job is restarted from snapshot, duplicate\n+     * items will not change the state in the target map.\n+     * <p>\n+     * The default local parallelism for this sink is 1.\n+     *\n+     * @since 4.1\n+     */\n+    @Nonnull\n+    public static <K, V> Sink<Entry<K, V>> map(@Nonnull String mapName, boolean jsonKey, boolean jsonValue) {\n+        return map(mapName,\n+                e -> jsonKey ? JsonUtil.hazelcastJsonValue(e.getKey()) : e.getKey(),\n+                e -> jsonValue ? JsonUtil.hazelcastJsonValue(e.getValue()) : e.getValue());\n+    }\n+\n+    /**\n+     * Returns a sink that uses the supplied functions to extract the key\n+     * and value with which to put to a Hazelcast {@code IMap}.\n+     * <p>\n+     * This sink provides the exactly-once guarantee thanks to <i>idempotent\n+     * updates</i>. It means that the value with the same key is not appended,\n+     * but overwritten. After the job is restarted from snapshot, duplicate\n+     * items will not change the state in the target map.\n+     * <p>\n+     * The default local parallelism for this sink is 1.\n+     *\n+     * @since 4.1\n+     */\n+    @Nonnull\n+    public static <T, K, V> Sink<T> map(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9e423f638b4d2775662282abe7b8ecf00814771"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTQxMzc2Ng==", "bodyText": "should be 4.2", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2198#discussion_r411413766", "createdAt": "2020-04-20T14:15:34Z", "author": {"login": "cangencer"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/pipeline/Sinks.java", "diffHunk": "@@ -109,7 +111,52 @@ private Sinks() {\n      */\n     @Nonnull\n     public static <K, V> Sink<Entry<K, V>> map(@Nonnull String mapName) {\n-        return new SinkImpl<>(\"mapSink(\" + mapName + ')', writeMapP(mapName), false, entryKey());\n+        return map(mapName, Entry::getKey, Entry::getValue);\n+    }\n+\n+    /**\n+     * Returns a sink that converts the key and value of {@code Map.Entry}s it\n+     * receives to {@link HazelcastJsonValue} and put them into a Hazelcast\n+     * {@code IMap} with the specified name.\n+     * <p>\n+     * This sink provides the exactly-once guarantee thanks to <i>idempotent\n+     * updates</i>. It means that the value with the same key is not appended,\n+     * but overwritten. After the job is restarted from snapshot, duplicate\n+     * items will not change the state in the target map.\n+     * <p>\n+     * The default local parallelism for this sink is 1.\n+     *\n+     * @since 4.1\n+     */\n+    @Nonnull\n+    public static <K, V> Sink<Entry<K, V>> map(@Nonnull String mapName, boolean jsonKey, boolean jsonValue) {\n+        return map(mapName,\n+                e -> jsonKey ? JsonUtil.hazelcastJsonValue(e.getKey()) : e.getKey(),\n+                e -> jsonValue ? JsonUtil.hazelcastJsonValue(e.getValue()) : e.getValue());\n+    }\n+\n+    /**\n+     * Returns a sink that uses the supplied functions to extract the key\n+     * and value with which to put to a Hazelcast {@code IMap}.\n+     * <p>\n+     * This sink provides the exactly-once guarantee thanks to <i>idempotent\n+     * updates</i>. It means that the value with the same key is not appended,\n+     * but overwritten. After the job is restarted from snapshot, duplicate\n+     * items will not change the state in the target map.\n+     * <p>\n+     * The default local parallelism for this sink is 1.\n+     *\n+     * @since 4.1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9e423f638b4d2775662282abe7b8ecf00814771"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82ce1eaf78cdddf0c5a75eae859055d2688fa102", "author": {"user": null}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/82ce1eaf78cdddf0c5a75eae859055d2688fa102", "committedDate": "2020-04-27T07:57:03Z", "message": "address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMjYyNzE0", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2198#pullrequestreview-403262714", "createdAt": "2020-04-30T07:21:43Z", "commit": {"oid": "82ce1eaf78cdddf0c5a75eae859055d2688fa102"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2828, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}