{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMzkwMjAx", "number": 2075, "title": "Enable job-level serializer for IMDG Maps & Caches", "bodyText": "Allowed job-level serializers to be used with IMDG Mapss & Caches.\nChecklist\n\n Tags Set\n Milestone Set", "createdAt": "2020-03-20T07:33:12Z", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2075", "merged": true, "mergeCommit": {"oid": "0567914b7a385bea22a06e7872a00565c871d6c3"}, "closed": true, "closedAt": "2020-03-24T09:57:39Z", "author": {"login": "gierlachg"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPbWCLgH2gAyMzkxMzkwMjAxOjU1ZjFlYzEyOTNiZTY1M2YyYTk1YmNkOWY5M2NmMWY0NTRmMTRhMGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQvnGbgH2gAyMzkxMzkwMjAxOmZlNDJiMGRlMzU1ZjdlMGUwNTM3NzZmNjc3NjExMmNlNjA1N2EzNDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "55f1ec1293be653f2a95bcd9f93cf1f454f14a0e", "author": {"user": {"login": "gierlachg", "name": "Grzegorz Gierlach"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/55f1ec1293be653f2a95bcd9f93cf1f454f14a0e", "committedDate": "2020-03-20T07:26:27Z", "message": "Enable job-level serializer for IMDG Maps & Caches"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a1ec51acff6f314238e15d85d153c7af7fed9d3", "author": {"user": {"login": "gierlachg", "name": "Grzegorz Gierlach"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/9a1ec51acff6f314238e15d85d153c7af7fed9d3", "committedDate": "2020-03-20T07:31:54Z", "message": "Enable job-level serializer for IMDG Maps & Caches"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7659dcbcf7a6ed55fd5cb6b35962f82e9150c154", "author": {"user": {"login": "gierlachg", "name": "Grzegorz Gierlach"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/7659dcbcf7a6ed55fd5cb6b35962f82e9150c154", "committedDate": "2020-03-20T09:21:38Z", "message": "Enable job-level serializer for IMDG Maps & Caches"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7686f59b3e5a25ee0f273be9d8b4872be1977ef0", "author": {"user": {"login": "gierlachg", "name": "Grzegorz Gierlach"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/7686f59b3e5a25ee0f273be9d8b4872be1977ef0", "committedDate": "2020-03-20T09:33:33Z", "message": "Enable job-level serializer for IMDG Maps & Caches"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "defd23156d7b8a5f1410327619be415f78d4f796", "author": {"user": {"login": "gierlachg", "name": "Grzegorz Gierlach"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/defd23156d7b8a5f1410327619be415f78d4f796", "committedDate": "2020-03-23T07:19:10Z", "message": "Merge branch 'master' into job_map_cache\n\n# Conflicts:\n#\thazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/connector/WriteMapP.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MjMzNzgw", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2075#pullrequestreview-379233780", "createdAt": "2020-03-23T08:58:11Z", "commit": {"oid": "defd23156d7b8a5f1410327619be415f78d4f796"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwODo1ODoxMlrOF578Ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwODo1ODoxMlrOF578Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI5NTE3MA==", "bodyText": "It would be better to have the cache instance in the context. This is an unnecessary access to multiple concurrent maps.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2075#discussion_r396295170", "createdAt": "2020-03-23T08:58:12Z", "author": {"login": "viliam-durina"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/connector/HazelcastWriters.java", "diffHunk": "@@ -182,27 +178,36 @@ static RuntimeException handleInstanceNotActive(HazelcastInstanceNotActiveExcept\n         return isLocal ? new RestartableException(e) : e;\n     }\n \n-    /**\n-     * Wrapper class needed to conceal the JCache API while\n-     * serializing/deserializing other lambdas\n-     */\n-    private static class CacheFlush {\n+    private static class WriteCachePSupplier<K, V> extends AbstractHazelcastConnectorSupplier {\n \n-        static <K, V> FunctionEx<HazelcastInstance, ConsumerEx<ArrayMap<K, V>>> flushToCache(\n-                String name,\n-                boolean isLocal\n-        ) {\n-            return instance -> {\n-                ICache<K, V> cache = instance.getCacheManager().getCache(name);\n-                return buffer -> {\n-                    try {\n-                        cache.putAll(buffer);\n-                    } catch (HazelcastInstanceNotActiveException e) {\n-                        throw handleInstanceNotActive(e, isLocal);\n-                    }\n-                    buffer.clear();\n-                };\n+        static final long serialVersionUID = 1L;\n+\n+        private final String name;\n+\n+        WriteCachePSupplier(@Nullable ClientConfig clientConfig, @Nonnull String name) {\n+            super(asXmlString(clientConfig));\n+            this.name = name;\n+        }\n+\n+        @Override\n+        protected Processor createProcessor(HazelcastInstance instance, SerializationService serializationService) {\n+            FunctionEx<Context, ArrayMap<Data, Data>> bufferCreator = context -> new ArrayMap<>();\n+            BiConsumerEx<ArrayMap<Data, Data>, Entry<K, V>> entryReceiver = (buffer, entry) -> {\n+                Data key = serializationService.toData(entry.getKey());\n+                Data value = serializationService.toData(entry.getValue());\n+                buffer.add(new SimpleEntry<>(key, value));\n+            };\n+            ConsumerEx<ArrayMap<Data, Data>> bufferFlusher = buffer -> {\n+                ICache<Data, Data> cache = instance.getCacheManager().getCache(name);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "defd23156d7b8a5f1410327619be415f78d4f796"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c15a64f142fd5f559e8b58f45f692428258f10ee", "author": {"user": {"login": "gierlachg", "name": "Grzegorz Gierlach"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/c15a64f142fd5f559e8b58f45f692428258f10ee", "committedDate": "2020-03-23T09:03:34Z", "message": "Fetch reference to the cache once and store it in the context"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NDEwODQz", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2075#pullrequestreview-379410843", "createdAt": "2020-03-23T13:08:55Z", "commit": {"oid": "c15a64f142fd5f559e8b58f45f692428258f10ee"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMzowODo1NlrOF6ElTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMzowODo1NlrOF6ElTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQzNjgxNQ==", "bodyText": "This was done on purpose due to https://bugs.openjdk.java.net/browse/JDK-8154236", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2075#discussion_r396436815", "createdAt": "2020-03-23T13:08:56Z", "author": {"login": "viliam-durina"}, "path": "hazelcast-jet-core/src/test/java/com/hazelcast/jet/pipeline/SinksTest.java", "diffHunk": "@@ -244,7 +246,7 @@ public void mapWithMerging_byName() {\n                 srcName,\n                 Entry::getKey,\n                 Entry::getValue,\n-                (oldValue, newValue) -> oldValue + newValue);\n+                Integer::sum);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c15a64f142fd5f559e8b58f45f692428258f10ee"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NDExNDg4", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2075#pullrequestreview-379411488", "createdAt": "2020-03-23T13:09:46Z", "commit": {"oid": "c15a64f142fd5f559e8b58f45f692428258f10ee"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7fa4827c36cd58c865d14c408bce331e7bacc88", "author": {"user": {"login": "gierlachg", "name": "Grzegorz Gierlach"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/b7fa4827c36cd58c865d14c408bce331e7bacc88", "committedDate": "2020-03-23T13:54:31Z", "message": "Use job serializers just for local maps/caches"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe42b0de355f7e0e053776f6776112ce6057a349", "author": {"user": {"login": "gierlachg", "name": "Grzegorz Gierlach"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/fe42b0de355f7e0e053776f6776112ce6057a349", "committedDate": "2020-03-24T09:37:07Z", "message": "Merge branch 'master' into job_map_cache\n\n# Conflicts:\n#\thazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/connector/WriteObservableP.java"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3812, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}