{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3NzMzMDc3", "number": 2061, "title": "Improve serialization exceptions", "bodyText": "Improved the way how serialization exceptions are handled - giving a hint to the user about JobConfig.registerSerializer()\nChecklist\n\n Tags Set\n Milestone Set\n\nFixes hazelcast/hazelcast-jet-enterprise#109", "createdAt": "2020-03-13T11:41:29Z", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2061", "merged": true, "mergeCommit": {"oid": "251f9cda02efcd7640dff57b931c05942a8328cf"}, "closed": true, "closedAt": "2020-03-16T13:08:20Z", "author": {"login": "gierlachg"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNOqERgH2gAyMzg3NzMzMDc3OjgxN2E2YTkyZTEzMmIwYmExZTVjM2ZkMmIwMjJlZmExNDJmMThiMGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcON0YSAFqTM3NTE5NDcwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "817a6a92e132b0ba1e5c3fd2b022efa142f18b0c", "author": {"user": {"login": "gierlachg", "name": "Grzegorz Gierlach"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/817a6a92e132b0ba1e5c3fd2b022efa142f18b0c", "committedDate": "2020-03-13T11:31:43Z", "message": "Refactor DelegatingSerializationService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcf8b154f73a6c51ba7f9e92367faa1dfcfdaf99", "author": {"user": {"login": "gierlachg", "name": "Grzegorz Gierlach"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/fcf8b154f73a6c51ba7f9e92367faa1dfcfdaf99", "committedDate": "2020-03-13T12:05:08Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f2da481b8b6bfc0c54118a82ed40ef76b249c8f", "author": {"user": {"login": "gierlachg", "name": "Grzegorz Gierlach"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/3f2da481b8b6bfc0c54118a82ed40ef76b249c8f", "committedDate": "2020-03-13T12:13:16Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d70a9c39bba5b44476af3ad75dec618ff9170c04", "author": {"user": {"login": "gierlachg", "name": "Grzegorz Gierlach"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/d70a9c39bba5b44476af3ad75dec618ff9170c04", "committedDate": "2020-03-14T15:40:37Z", "message": "Handle null object"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MDkyNjcy", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2061#pullrequestreview-375092672", "createdAt": "2020-03-16T10:40:05Z", "commit": {"oid": "d70a9c39bba5b44476af3ad75dec618ff9170c04"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMDo0MDowNVrOF2uQiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMDo0MDowNVrOF2uQiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjkyNTMyMA==", "bodyText": "We should not depend on the exact text from the superclass. We also lose the stack trace of the original exc.\nI'd rather just wrap the caught exception, use the original message and append a text to it.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            throw handle(typeId, hse);\n          \n          \n            \n                            throw new HazelcastSerializationException(hse.getMessage() + \". You can register a job-specific serializer using JobConfig.registerSerializer()\", hse);\n          \n      \n    \n    \n  \n\nIf we also dispose the delegate (which we should), we wouldn't have to handle the inactive case: the delegate will throw HazelcastInstanceNotActiveException directly.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2061#discussion_r392925320", "createdAt": "2020-03-16T10:40:05Z", "author": {"login": "viliam-durina"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/serialization/DelegatingSerializationService.java", "diffHunk": "@@ -108,33 +108,57 @@ public PortableContext getPortableContext() {\n \n     @Override\n     public SerializerAdapter serializerFor(Object object) {\n-        Class<?> clazz = object.getClass();\n-        SerializerAdapter serializer = serializersByClass.get(clazz);\n+        Class<?> clazz = object == null ? null : object.getClass();\n+\n+        SerializerAdapter serializer = null;\n+        if (clazz != null) {\n+            serializer = serializersByClass.get(clazz);\n+        }\n         if (serializer == null) {\n-            serializer = delegate.serializerFor(object);\n-            if (serializer == null) {\n-                throw active ?\n-                        new HazelcastSerializationException(\"There is no suitable serializer for \" + clazz) :\n-                        new HazelcastInstanceNotActiveException();\n+            try {\n+                serializer = delegate.serializerFor(object);\n+            } catch (HazelcastSerializationException hse) {\n+                throw handle(clazz, hse);\n             }\n         }\n+        if (serializer == null) {\n+            throw active ? new MissingSerializer(clazz) : new HazelcastInstanceNotActiveException();\n+        }\n         return serializer;\n     }\n \n+    private RuntimeException handle(Class<?> clazz, HazelcastSerializationException e) {\n+        String message = e.getMessage();\n+        if (message != null && message.startsWith(\"There is no suitable serializer for\")) {\n+            return new MissingSerializer(clazz);\n+        }\n+        return e;\n+    }\n+\n     @Override\n     public SerializerAdapter serializerFor(int typeId) {\n         SerializerAdapter serializer = serializersById.get(typeId);\n         if (serializer == null) {\n-            serializer = delegate.serializerFor(typeId);\n-            if (serializer == null) {\n-                throw active ?\n-                        newHazelcastSerializationException(typeId) :\n-                        new HazelcastInstanceNotActiveException();\n+            try {\n+                serializer = delegate.serializerFor(typeId);\n+            } catch (HazelcastSerializationException hse) {\n+                throw handle(typeId, hse);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d70a9c39bba5b44476af3ad75dec618ff9170c04"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41c1a5b76a111db96b18e515dbf47c6e37de5aae", "author": {"user": {"login": "gierlachg", "name": "Grzegorz Gierlach"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/41c1a5b76a111db96b18e515dbf47c6e37de5aae", "committedDate": "2020-03-16T11:22:21Z", "message": "Simplify exception handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "005afd15d73219e24629943b3ae50695fcfd6fa7", "author": {"user": {"login": "gierlachg", "name": "Grzegorz Gierlach"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/005afd15d73219e24629943b3ae50695fcfd6fa7", "committedDate": "2020-03-16T11:24:18Z", "message": "Simplify exception handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69bc4e5c715455fb053d2a7506f6397314d4849a", "author": {"user": {"login": "gierlachg", "name": "Grzegorz Gierlach"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/69bc4e5c715455fb053d2a7506f6397314d4849a", "committedDate": "2020-03-16T12:30:44Z", "message": "Simplify exception handling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MTk0NzAy", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2061#pullrequestreview-375194702", "createdAt": "2020-03-16T13:07:00Z", "commit": {"oid": "69bc4e5c715455fb053d2a7506f6397314d4849a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2897, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}