{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5MzQ0NDk4", "number": 2532, "title": "Fix job hanging due to lost DONE_ITEM", "bodyText": "The failure scenario was this:\n\n\nSenderTasklet reaches EOS in tryFillInbox(), writes DONE_ITEM\n\n\nWe try to send the last packet in the call method, Connection.write()\nreturns true\n\n\nThe connection is broken and the packet is never sent. The connection\nis transparently reestablished, but the packet isn't sent again.\n\n\nJet doesn't use this connection anymore in SenderTasklet as EOS has\nbeen reached, so the failure goes unnoticed\n\n\nRemote member never receives the packet, the ReceiverTasklet will keep\nwaiting for the DONE_ITEM\n\n\nThe solution is that when the ReceiverTasklet creates data for the flow\ncontrol packet, it compares that the Connection object it was crated\nwith is the same.\nWe send the flow control packet regularly so any transparent\nreconnection will cause the job to fail. Currently it would fail only if\nsome SenderTasklet tried to send something.\nFixes #2158", "createdAt": "2020-09-18T14:14:13Z", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2532", "merged": true, "mergeCommit": {"oid": "424e109af3709ad860d65230ef7f92ef7c73964a"}, "closed": true, "closedAt": "2020-09-21T12:36:33Z", "author": {"login": "viliam-durina"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKGP3JAH2gAyNDg5MzQ0NDk4OjMyYTdkMzA3NGNjMjJjNDNmNTVmZWU0MWU3MzhjZGY4ODQ3MDQ0Yjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLCeedAFqTQ5MjU0MTU4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "32a7d3074cc22c43f55fee41e738cdf8847044b8", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/32a7d3074cc22c43f55fee41e738cdf8847044b8", "committedDate": "2020-09-18T14:13:14Z", "message": "Fix job hanging due to lost DONE_ITEM\n\nThe failure scenario was this:\n\n- SenderTasklet reaches EOS in tryFillInbox(), writes DONE_ITEM\n\n- We try to send the last packet in the call method, Connection.write()\nreturns true\n\n- The connection is broken and the packet is never sent. The connection\nis transparently reestablished, but the packet isn't sent again.\n\n- Jet doesn't use this connection anymore in SenderTasklet as EOS has\nbeen reached, so the failure goes unnoticed\n\n- Remote member never receives the packet, the ReceiverTasklet will keep\nwaiting for the DONE_ITEM\n\nThe solution is that when the ReceiverTasklet creates data for the flow\ncontrol packet, it compares that the Connection object it was crated\nwith is the same.\n\nWe send the flow control packet regularly so any transparent\nreconnection will cause the job to fail. Currently it would fail only if\nsome SenderTasklet tried to send something.\n\nFixes #2158"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8af7ea9088e01c98a71ef0279d52acef35f0887", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/f8af7ea9088e01c98a71ef0279d52acef35f0887", "committedDate": "2020-09-18T14:22:00Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b223b6030887a697fdc6f4ada94f16f76f5716c3", "author": {"user": {"login": "viliam-durina", "name": "Viliam Durina"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/b223b6030887a697fdc6f4ada94f16f76f5716c3", "committedDate": "2020-09-18T14:49:50Z", "message": "Use unique name for real-network clusters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "112e78192a14f1a2788d121bfdd505beabc8b1aa", "author": {"user": {"login": "mtopolnik", "name": "Marko Topolnik"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/112e78192a14f1a2788d121bfdd505beabc8b1aa", "committedDate": "2020-09-21T11:25:07Z", "message": "Update Javadoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNTAzMDU1", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2532#pullrequestreview-492503055", "createdAt": "2020-09-21T11:31:14Z", "commit": {"oid": "112e78192a14f1a2788d121bfdd505beabc8b1aa"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMTozMToxNFrOHVLe7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMTozNjoxOVrOHVLoNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk3MDI4NQ==", "bodyText": "Is this change mostly about \"FP delete\"? The new code has explicit types on everything, but with the types being Integer, Map etc., their true meaning is not known, and previously there were lambda parameters with descriptive names. I don't see a win here.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2532#discussion_r491970285", "createdAt": "2020-09-21T11:31:14Z", "author": {"login": "mtopolnik"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/Networking.java", "diffHunk": "@@ -129,23 +131,26 @@ private void broadcastFlowControlPacket() {\n         }\n     }\n \n-    private byte[] createFlowControlPacket(Address member) throws IOException {\n+    private byte[] createFlowControlPacket(Address member, Connection expectedConnection) throws IOException {\n         try (BufferObjectDataOutput output = createObjectDataOutput(nodeEngine, lastFlowPacketSize)) {\n-            final boolean[] hasData = {false};\n+            boolean hasData = false;\n             Map<Long, ExecutionContext> executionContexts = jobExecutionService.getExecutionContextsFor(member);\n             output.writeInt(executionContexts.size());\n-            executionContexts.forEach((execId, exeCtx) -> uncheckRun(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "112e78192a14f1a2788d121bfdd505beabc8b1aa"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk3MjY2MA==", "bodyText": "Does this just make a problem less likely? Since the read and write of this variable are concurrent to each other?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2532#discussion_r491972660", "createdAt": "2020-09-21T11:36:19Z", "author": {"login": "mtopolnik"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/execution/ReceiverTasklet.java", "diffHunk": "@@ -208,9 +217,14 @@ public int updateAndGetSendSeqLimitCompressed() {\n      *\n      * @param timestampNow value of the timestamp at the time the method is called. The timestamp\n      *                     must be obtained from {@code System.nanoTime()}.\n+     * @param expectedConnection The connection to which the result will be sent. We use it\n+     *                           to check that it's the same connection the tasklet was crated with.\n      */\n     // Invoked sequentially by a task scheduler\n-    int updateAndGetSendSeqLimitCompressed(long timestampNow) {\n+    int updateAndGetSendSeqLimitCompressed(long timestampNow, Connection expectedConnection) {\n+        if (!Objects.equals(expectedConnection, memberConnection)) {\n+            connectionChanged = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "112e78192a14f1a2788d121bfdd505beabc8b1aa"}, "originalPosition": 144}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7353206c7aee417b4edcfbcaaf4da7e84f81760e", "author": {"user": {"login": "mtopolnik", "name": "Marko Topolnik"}}, "url": "https://github.com/hazelcast/hazelcast-jet/commit/7353206c7aee417b4edcfbcaaf4da7e84f81760e", "committedDate": "2020-09-21T12:22:11Z", "message": "Improve readability"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNTQxNTgw", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2532#pullrequestreview-492541580", "createdAt": "2020-09-21T12:23:30Z", "commit": {"oid": "7353206c7aee417b4edcfbcaaf4da7e84f81760e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3617, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}