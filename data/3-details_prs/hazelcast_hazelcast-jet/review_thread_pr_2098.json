{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MDM1MzA5", "number": 2098, "reviewThreads": {"totalCount": 92, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMjoyMTo0M1rODuI9jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwOTozNjowOFrOEAbuoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NzA3OTE4OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elasticsearch/LocalElasticsearchSinkTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMjoyMTo0M1rOF_-k6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxMjo0MjozOVrOGBV3Qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYyOTg2Ng==", "bodyText": "we can move this as a utility method to ElasticSupport", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r402629866", "createdAt": "2020-04-02T22:21:43Z", "author": {"login": "gurbuzali"}, "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elasticsearch/LocalElasticsearchSinkTest.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elasticsearch;\n+\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.JetTestInstanceFactory;\n+import com.hazelcast.jet.config.JetConfig;\n+import org.apache.http.HttpHost;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.junit.After;\n+\n+/**\n+ * Test running single Jet member locally and Elastic in docker\n+ */\n+public class LocalElasticsearchSinkTest extends CommonElasticsearchSinksTest {\n+\n+    private JetTestInstanceFactory factory = new JetTestInstanceFactory();\n+\n+    @After\n+    public void tearDown() throws Exception {\n+        factory.terminateAll();\n+    }\n+\n+    protected SupplierEx<RestHighLevelClient> elasticClientSupplier() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb1b593a7773237a2ef4546e36f2eab6596f9911"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA1OTk3MQ==", "bodyText": "Moved the code to create the client. Though the method elasticClientSupplier() in BaseElasticsearchTest stays as it is used to return client for particular environment (e.g. in AuthElasticsearchSourcesTest the docker image and client are configured differently).", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404059971", "createdAt": "2020-04-06T12:42:39Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elasticsearch/LocalElasticsearchSinkTest.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elasticsearch;\n+\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.JetTestInstanceFactory;\n+import com.hazelcast.jet.config.JetConfig;\n+import org.apache.http.HttpHost;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.junit.After;\n+\n+/**\n+ * Test running single Jet member locally and Elastic in docker\n+ */\n+public class LocalElasticsearchSinkTest extends CommonElasticsearchSinksTest {\n+\n+    private JetTestInstanceFactory factory = new JetTestInstanceFactory();\n+\n+    @After\n+    public void tearDown() throws Exception {\n+        factory.terminateAll();\n+    }\n+\n+    protected SupplierEx<RestHighLevelClient> elasticClientSupplier() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYyOTg2Ng=="}, "originalCommit": {"oid": "fb1b593a7773237a2ef4546e36f2eab6596f9911"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NzE0OTM2OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/ElasticsearchSinkBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMjo1MDoyMVrOF__PTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMjo1MDoyMVrOF__PTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY0MDcxOA==", "bodyText": "how about changing this to SupplierEx<? extends RestClientBuilder> clientBuilderSupport. This will simplify the client creation for user and remove the necessity for a destroyFn", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r402640718", "createdAt": "2020-04-02T22:50:21Z", "author": {"login": "gurbuzali"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/ElasticsearchSinkBuilder.java", "diffHunk": "@@ -0,0 +1,212 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elasticsearch;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import com.hazelcast.jet.pipeline.SinkBuilder;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch Sink\n+ *\n+ * Requires {@link #clientSupplier(SupplierEx)} and {@link #mapItemFn(FunctionEx)}.\n+ *\n+ * @param <T>\n+ *\n+ * @since 4.1\n+ */\n+public class ElasticsearchSinkBuilder<T> implements Serializable {\n+\n+    private String name = \"elastic\";\n+    private SupplierEx<? extends RestHighLevelClient> clientSupplier;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb1b593a7773237a2ef4546e36f2eab6596f9911"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NzIwMjk2OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/ElasticsearchSourceBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMzoxNDoxN1rOF__vvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMzoxNDoxN1rOF__vvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY0OTAyMQ==", "bodyText": "typo resuls -> results", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r402649021", "createdAt": "2020-04-02T23:14:17Z", "author": {"login": "gurbuzali"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/ElasticsearchSourceBuilder.java", "diffHunk": "@@ -0,0 +1,232 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elasticsearch;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.elasticsearch.impl.ElasticProcessorMetaSupplier;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Sources;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch source which reads data from Elasticsearch and\n+ * converts SearchHits using provided {@code mapHitFn}\n+ *\n+ * @param <T> type of the mapping function from {@link SearchHit} -> T\n+ *           TODO not sure about the type parameter name - T as the usual default, or R for Result\n+ *           also we could accept the function in the build() method, same as the original source did it\n+ * @since 4.1\n+ */\n+public class ElasticsearchSourceBuilder<T> implements Serializable {\n+\n+    private static final long serialVersionUID = 1L;\n+\n+    private String name = \"elastic\";\n+    private SupplierEx<? extends RestHighLevelClient> clientSupplier;\n+    private ConsumerEx<? super RestHighLevelClient> destroyFn = RestHighLevelClient::close;\n+    private SupplierEx<SearchRequest> searchRequestSupplier;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = request -> RequestOptions.DEFAULT;\n+    private FunctionEx<? super SearchHit, T> mapHitFn;\n+    private boolean slicing;\n+    private boolean coLocatedReading;\n+    private String scrollKeepAlive = \"1m\"; // Using String because it needs to be Serializable\n+\n+    /**\n+     * Build Elasticsearch {@link BatchSource} with supplied parameters\n+     *\n+     * @return configured source which is to be used in the pipeline\n+     */\n+    @Nonnull\n+    public BatchSource<T> build() {\n+        requireNonNull(clientSupplier, \"clientSupplier must be set\");\n+        requireNonNull(searchRequestSupplier, \"searchRequestSupplier must be set\");\n+        requireNonNull(mapHitFn, \"mapHitFn must be set\");\n+\n+        ElasticProcessorMetaSupplier<T> metaSupplier = new ElasticProcessorMetaSupplier<>(this);\n+        return Sources.batchFromProcessor(name, metaSupplier);\n+    }\n+\n+    /**\n+     * Set the user-friendly source name for this source\n+     *\n+     * @param sourceName user-friendly source name\n+     */\n+    @Nonnull\n+    public ElasticsearchSourceBuilder<T> name(String sourceName) {\n+        this.name = sourceName;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public String name() {\n+        return name;\n+    }\n+\n+    /**\n+     * Set the client supplier\n+     *\n+     * @param clientSupplier supplier for configure Elasticsearch REST client\n+     */\n+    @Nonnull\n+    public ElasticsearchSourceBuilder<T> clientSupplier(SupplierEx<? extends RestHighLevelClient> clientSupplier) {\n+        checkSerializable(clientSupplier, \"clientSupplier\");\n+        this.clientSupplier = clientSupplier;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public SupplierEx<? extends RestHighLevelClient> clientSupplier() {\n+        return clientSupplier;\n+    }\n+\n+    /**\n+     * Set the destroy function called on completion, defaults to {@link RestHighLevelClient#close()}\n+     *\n+     * @param destroyFn destroy function\n+     */\n+    @Nonnull\n+    public ElasticsearchSourceBuilder<T> destroyFn(ConsumerEx<? super RestHighLevelClient> destroyFn) {\n+        checkSerializable(destroyFn, \"destroyFn\");\n+        this.destroyFn = destroyFn;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public ConsumerEx<? super RestHighLevelClient> destroyFn() {\n+        return destroyFn;\n+    }\n+\n+    /**\n+     * Set the search request supplier\n+     *\n+     * @param searchRequestSupplier search request supplier\n+     */\n+    @Nonnull\n+    public ElasticsearchSourceBuilder<T> searchRequestSupplier(SupplierEx<SearchRequest> searchRequestSupplier) {\n+        checkSerializable(searchRequestSupplier, \"searchRequestSupplier\");\n+        this.searchRequestSupplier = searchRequestSupplier;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public SupplierEx<SearchRequest> searchRequestSupplier() {\n+        return searchRequestSupplier;\n+    }\n+\n+    /**\n+     * Set the function to map SearchHit to custom result\n+     *\n+     * @param mapHitFn maps search hits to output items\n+     */\n+    @Nonnull\n+    public ElasticsearchSourceBuilder<T> mapHitFn(FunctionEx<? super SearchHit, T> mapHitFn) {\n+        checkSerializable(mapHitFn, \"mapHitFn\");\n+        this.mapHitFn = mapHitFn;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public FunctionEx<? super SearchHit, T> mapHitFn() {\n+        return mapHitFn;\n+    }\n+\n+    /**\n+     * Set the function that provides {@link RequestOptions} based on given request\n+     *\n+     * @param optionsFn function that provides {@link RequestOptions}\n+     */\n+    @Nonnull\n+    public ElasticsearchSourceBuilder<T> optionsFn(FunctionEx<? super ActionRequest, RequestOptions> optionsFn) {\n+        checkSerializable(optionsFn, \"optionsFn\");\n+        this.optionsFn = optionsFn;\n+        return this;\n+    }\n+\n+    public FunctionEx<? super ActionRequest, RequestOptions> optionsFn() {\n+        return optionsFn;\n+    }\n+\n+    /**\n+     * Set to true to enable slicing\n+     * <p>\n+     * Number of slices is equal to globalParallelism (localParallelism * numberOfNodes)\n+     * <p>\n+     * Use this option to read from multiple shards in parallel.\n+     *\n+     * @param enabled {@code true} to enable slicing, default value {@code false}\n+     * @see\n+     * <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-body.html#sliced-scroll\">\n+     *     Sliced Scroll</a>\n+     */\n+    @Nonnull\n+    public ElasticsearchSourceBuilder<T> slicing(boolean enabled) {\n+        this.slicing = enabled;\n+        return this;\n+    }\n+\n+    public boolean slicing() {\n+        return slicing;\n+    }\n+\n+    /**\n+     * Turns on co-located reading\n+     *\n+     * Jet cluster member must run exactly on the same nodes as Elastic cluster.\n+     *\n+     * @param coLocatedRead {@code true} to enable co-located reading, default value {@code false}\n+     */\n+    @Nonnull\n+    public ElasticsearchSourceBuilder<T> coLocatedReading(boolean coLocatedRead) {\n+        this.coLocatedReading = coLocatedRead;\n+        return this;\n+    }\n+\n+    public boolean coLocatedReading() {\n+        return coLocatedReading;\n+    }\n+\n+    /**\n+     * Set the keepAlive for Elastic search scroll\n+     * <p>\n+     * See {@link SearchRequest#scroll(String)}\n+     *\n+     * @param scrollKeepAlive keepAlive value, this must be high enough to process all resuls from a single scroll,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb1b593a7773237a2ef4546e36f2eab6596f9911"}, "originalPosition": 219}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NzIxNDU0OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/ElasticsearchSources.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMzoxOTo0NVrOF__2ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMzoxOTo0NVrOF__2ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1MDc4Nw==", "bodyText": "+1 to use Elastic instead of Elasticsearch where applicable. even for the extension-name maybe ?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r402650787", "createdAt": "2020-04-02T23:19:45Z", "author": {"login": "gurbuzali"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/ElasticsearchSources.java", "diffHunk": "@@ -0,0 +1,213 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elasticsearch;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import org.apache.http.HttpHost;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sources.\n+ * Alternatively you can use {@link ElasticsearchSourceBuilder}\n+ * <p>\n+ * TODO maybe rename to ElasticSources - Elastic is the company name, but is also used interchangeably for elasticsearch", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb1b593a7773237a2ef4546e36f2eab6596f9911"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NzIyMjE2OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/ElasticsearchSources.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMzoyMzozMVrOF__7LA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwNzo0ODowNlrOGAIvVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1MTk0OA==", "bodyText": "I think these deprecated methods are not necessary, wdyt @eminn, @cangencer ?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r402651948", "createdAt": "2020-04-02T23:23:31Z", "author": {"login": "gurbuzali"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/ElasticsearchSources.java", "diffHunk": "@@ -0,0 +1,213 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elasticsearch;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import org.apache.http.HttpHost;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sources.\n+ * Alternatively you can use {@link ElasticsearchSourceBuilder}\n+ * <p>\n+ * TODO maybe rename to ElasticSources - Elastic is the company name, but is also used interchangeably for elasticsearch\n+ * it would make the API bit nicer to use, shorter in places etc.. same for {@link #elasticsearch()} methods\n+ *\n+ * @since 4.1\n+ */\n+public final class ElasticsearchSources {\n+\n+    private static final String DEFAULT_SCROLL_TIMEOUT = \"60s\";\n+    private static final int DEFAULT_PORT = 9200;\n+\n+    private ElasticsearchSources() {\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * <p>\n+     * Useful for quick prototyping. See other methods {@link #elasticsearch(String, SupplierEx, SupplierEx)}\n+     * and {@link #builder()}\n+     */\n+    public static BatchSource<String> elasticsearch() {\n+        return elasticsearch(() -> new RestHighLevelClient(\n+                RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+        ));\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Queries all indexes for all documents.\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static BatchSource<String> elasticsearch(@Nonnull SupplierEx<RestHighLevelClient> clientSupplier) {\n+        return elasticsearch(clientSupplier, SearchHit::getSourceAsString);\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static <T> BatchSource<T> elasticsearch(@Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elasticsearch(() -> new RestHighLevelClient(\n+                        RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+                ),\n+                mapHitFn\n+        );\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Uses provided mapHitFn to map results.\n+     * Queries all indexes for all documents.\n+     *\n+     * @param clientSupplier RestHighLevelClient supplier\n+     * @param mapHitFn       supplier of a function mapping the result from SearchHit to a result type\n+     * @param <T>            result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elasticsearch(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elasticsearch(clientSupplier, SearchRequest::new, mapHitFn);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     *\n+     * @param clientSupplier        RestHighLevelClient supplier\n+     * @param searchRequestSupplier supplier of a SearchRequest used to query for documents\n+     * @param mapHitFn              supplier of a function mapping the result from SearchHit to a target type\n+     * @param <T>                   result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elasticsearch(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull SupplierEx<SearchRequest> searchRequestSupplier,\n+            @Nonnull FunctionEx<? super SearchHit, T> mapHitFn\n+    ) {\n+        return ElasticsearchSources.<T>builder()\n+                .clientSupplier(clientSupplier)\n+                .searchRequestSupplier(searchRequestSupplier)\n+                .mapHitFn(mapHitFn)\n+                .build();\n+    }\n+\n+    /**\n+     * Returns {@link ElasticsearchSourceBuilder}\n+     *\n+     * @param <T> result type returned by the map function\n+     */\n+    public static <T> ElasticsearchSourceBuilder<T> builder() {\n+        return new ElasticsearchSourceBuilder<>();\n+    }\n+\n+    /**\n+     * Creates a source which queries objects using the specified Elasticsearch\n+     * client and the specified request supplier using scrolling method.\n+     *\n+     * @param name                  name of the source\n+     * @param clientSupplier        Elasticsearch REST client supplier\n+     * @param searchRequestSupplier search request supplier\n+     * @param scrollTimeout         scroll keep alive time\n+     * @param mapHitFn              maps search hits to output items\n+     * @param optionsFn             obtains {@link RequestOptions} for each request\n+     * @param destroyFn             called upon completion to release any resource\n+     * @param <T>                   type of items emitted downstream\n+     */\n+    @Deprecated // TODO keep this for backward compatibility?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb1b593a7773237a2ef4546e36f2eab6596f9911"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjc5NjM3NQ==", "bodyText": "That's not even the same module anymore. Let's delete them.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r402796375", "createdAt": "2020-04-03T07:48:06Z", "author": {"login": "eminn"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/ElasticsearchSources.java", "diffHunk": "@@ -0,0 +1,213 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elasticsearch;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import org.apache.http.HttpHost;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sources.\n+ * Alternatively you can use {@link ElasticsearchSourceBuilder}\n+ * <p>\n+ * TODO maybe rename to ElasticSources - Elastic is the company name, but is also used interchangeably for elasticsearch\n+ * it would make the API bit nicer to use, shorter in places etc.. same for {@link #elasticsearch()} methods\n+ *\n+ * @since 4.1\n+ */\n+public final class ElasticsearchSources {\n+\n+    private static final String DEFAULT_SCROLL_TIMEOUT = \"60s\";\n+    private static final int DEFAULT_PORT = 9200;\n+\n+    private ElasticsearchSources() {\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * <p>\n+     * Useful for quick prototyping. See other methods {@link #elasticsearch(String, SupplierEx, SupplierEx)}\n+     * and {@link #builder()}\n+     */\n+    public static BatchSource<String> elasticsearch() {\n+        return elasticsearch(() -> new RestHighLevelClient(\n+                RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+        ));\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Queries all indexes for all documents.\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static BatchSource<String> elasticsearch(@Nonnull SupplierEx<RestHighLevelClient> clientSupplier) {\n+        return elasticsearch(clientSupplier, SearchHit::getSourceAsString);\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static <T> BatchSource<T> elasticsearch(@Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elasticsearch(() -> new RestHighLevelClient(\n+                        RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+                ),\n+                mapHitFn\n+        );\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Uses provided mapHitFn to map results.\n+     * Queries all indexes for all documents.\n+     *\n+     * @param clientSupplier RestHighLevelClient supplier\n+     * @param mapHitFn       supplier of a function mapping the result from SearchHit to a result type\n+     * @param <T>            result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elasticsearch(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elasticsearch(clientSupplier, SearchRequest::new, mapHitFn);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     *\n+     * @param clientSupplier        RestHighLevelClient supplier\n+     * @param searchRequestSupplier supplier of a SearchRequest used to query for documents\n+     * @param mapHitFn              supplier of a function mapping the result from SearchHit to a target type\n+     * @param <T>                   result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elasticsearch(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull SupplierEx<SearchRequest> searchRequestSupplier,\n+            @Nonnull FunctionEx<? super SearchHit, T> mapHitFn\n+    ) {\n+        return ElasticsearchSources.<T>builder()\n+                .clientSupplier(clientSupplier)\n+                .searchRequestSupplier(searchRequestSupplier)\n+                .mapHitFn(mapHitFn)\n+                .build();\n+    }\n+\n+    /**\n+     * Returns {@link ElasticsearchSourceBuilder}\n+     *\n+     * @param <T> result type returned by the map function\n+     */\n+    public static <T> ElasticsearchSourceBuilder<T> builder() {\n+        return new ElasticsearchSourceBuilder<>();\n+    }\n+\n+    /**\n+     * Creates a source which queries objects using the specified Elasticsearch\n+     * client and the specified request supplier using scrolling method.\n+     *\n+     * @param name                  name of the source\n+     * @param clientSupplier        Elasticsearch REST client supplier\n+     * @param searchRequestSupplier search request supplier\n+     * @param scrollTimeout         scroll keep alive time\n+     * @param mapHitFn              maps search hits to output items\n+     * @param optionsFn             obtains {@link RequestOptions} for each request\n+     * @param destroyFn             called upon completion to release any resource\n+     * @param <T>                   type of items emitted downstream\n+     */\n+    @Deprecated // TODO keep this for backward compatibility?", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1MTk0OA=="}, "originalCommit": {"oid": "fb1b593a7773237a2ef4546e36f2eab6596f9911"}, "originalPosition": 141}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NzIyNDEwOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/impl/ElasticProcessorMetaSupplier.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMzoyNDoyNFrOF__8QQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMzoyNDoyNFrOF__8QQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY1MjIyNQ==", "bodyText": "we can remove this, same as default implementation", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r402652225", "createdAt": "2020-04-02T23:24:24Z", "author": {"login": "gurbuzali"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/impl/ElasticProcessorMetaSupplier.java", "diffHunk": "@@ -0,0 +1,210 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elasticsearch.impl;\n+\n+import com.hazelcast.cluster.Address;\n+import com.hazelcast.internal.json.Json;\n+import com.hazelcast.internal.json.JsonArray;\n+import com.hazelcast.internal.json.JsonObject;\n+import com.hazelcast.internal.json.JsonValue;\n+import com.hazelcast.jet.JetException;\n+import com.hazelcast.jet.elasticsearch.ElasticsearchSourceBuilder;\n+import com.hazelcast.jet.elasticsearch.impl.Shard.Prirep;\n+import com.hazelcast.jet.core.ProcessorMetaSupplier;\n+import com.hazelcast.jet.core.ProcessorSupplier;\n+import com.hazelcast.jet.core.Vertex;\n+import com.hazelcast.jet.core.processor.Processors;\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.partition.strategy.StringPartitioningStrategy;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static com.hazelcast.jet.impl.util.Util.uncheckCall;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.nCopies;\n+import static java.util.Optional.empty;\n+import static java.util.logging.Level.FINER;\n+import static java.util.stream.Collectors.groupingBy;\n+import static java.util.stream.Collectors.toList;\n+\n+public class ElasticProcessorMetaSupplier<T> implements ProcessorMetaSupplier {\n+\n+    private static final long serialVersionUID = 1L;\n+\n+    private transient ILogger logger;\n+\n+    @Nonnull\n+    private final ElasticsearchSourceBuilder<T> builder;\n+\n+    private Map<String, List<Shard>> assignedShards;\n+    private transient Address ownerAddress;\n+\n+    public ElasticProcessorMetaSupplier(@Nonnull ElasticsearchSourceBuilder<T> builder) {\n+        this.builder = builder;\n+    }\n+\n+    @Nonnull\n+    @Override\n+    public Map<String, String> getTags() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb1b593a7773237a2ef4546e36f2eab6596f9911"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NzI4MTk3OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/impl/ElasticProcessorMetaSupplier.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMzo1Mzo1NVrOGAAfKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMjo0Nzo0OVrOGBssNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2MTE2Mg==", "bodyText": "StringPartitioningStrategy is unnecessary here, we can directly use context.jobId() here even without converting to String", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r402661162", "createdAt": "2020-04-02T23:53:55Z", "author": {"login": "gurbuzali"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/impl/ElasticProcessorMetaSupplier.java", "diffHunk": "@@ -0,0 +1,210 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elasticsearch.impl;\n+\n+import com.hazelcast.cluster.Address;\n+import com.hazelcast.internal.json.Json;\n+import com.hazelcast.internal.json.JsonArray;\n+import com.hazelcast.internal.json.JsonObject;\n+import com.hazelcast.internal.json.JsonValue;\n+import com.hazelcast.jet.JetException;\n+import com.hazelcast.jet.elasticsearch.ElasticsearchSourceBuilder;\n+import com.hazelcast.jet.elasticsearch.impl.Shard.Prirep;\n+import com.hazelcast.jet.core.ProcessorMetaSupplier;\n+import com.hazelcast.jet.core.ProcessorSupplier;\n+import com.hazelcast.jet.core.Vertex;\n+import com.hazelcast.jet.core.processor.Processors;\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.partition.strategy.StringPartitioningStrategy;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static com.hazelcast.jet.impl.util.Util.uncheckCall;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.nCopies;\n+import static java.util.Optional.empty;\n+import static java.util.logging.Level.FINER;\n+import static java.util.stream.Collectors.groupingBy;\n+import static java.util.stream.Collectors.toList;\n+\n+public class ElasticProcessorMetaSupplier<T> implements ProcessorMetaSupplier {\n+\n+    private static final long serialVersionUID = 1L;\n+\n+    private transient ILogger logger;\n+\n+    @Nonnull\n+    private final ElasticsearchSourceBuilder<T> builder;\n+\n+    private Map<String, List<Shard>> assignedShards;\n+    private transient Address ownerAddress;\n+\n+    public ElasticProcessorMetaSupplier(@Nonnull ElasticsearchSourceBuilder<T> builder) {\n+        this.builder = builder;\n+    }\n+\n+    @Nonnull\n+    @Override\n+    public Map<String, String> getTags() {\n+        return emptyMap();\n+    }\n+\n+    @Override\n+    public int preferredLocalParallelism() {\n+        if (builder.slicing() || builder.coLocatedReading()) {\n+            return Vertex.LOCAL_PARALLELISM_USE_DEFAULT;\n+        } else {\n+            return 1;\n+        }\n+    }\n+\n+\n+    @Override\n+    public void init(@Nonnull Context context) throws Exception {\n+        logger = context.logger();\n+\n+        List<Shard> shards = readShards();\n+        if (builder.coLocatedReading()) {\n+            List<String> addresses = context\n+                    .jetInstance().getCluster().getMembers().stream()\n+                    .map(m -> uncheckCall((() -> m.getAddress().getInetAddress().getHostAddress())))\n+                    .collect(toList());\n+            this.assignedShards = assignShards(shards, addresses);\n+        } else {\n+            String key = StringPartitioningStrategy.getPartitionKey(String.valueOf(context.jobId()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb1b593a7773237a2ef4546e36f2eab6596f9911"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQzMzk3Mw==", "bodyText": "Done.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404433973", "createdAt": "2020-04-06T22:47:49Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/impl/ElasticProcessorMetaSupplier.java", "diffHunk": "@@ -0,0 +1,210 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elasticsearch.impl;\n+\n+import com.hazelcast.cluster.Address;\n+import com.hazelcast.internal.json.Json;\n+import com.hazelcast.internal.json.JsonArray;\n+import com.hazelcast.internal.json.JsonObject;\n+import com.hazelcast.internal.json.JsonValue;\n+import com.hazelcast.jet.JetException;\n+import com.hazelcast.jet.elasticsearch.ElasticsearchSourceBuilder;\n+import com.hazelcast.jet.elasticsearch.impl.Shard.Prirep;\n+import com.hazelcast.jet.core.ProcessorMetaSupplier;\n+import com.hazelcast.jet.core.ProcessorSupplier;\n+import com.hazelcast.jet.core.Vertex;\n+import com.hazelcast.jet.core.processor.Processors;\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.partition.strategy.StringPartitioningStrategy;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static com.hazelcast.jet.impl.util.Util.uncheckCall;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.nCopies;\n+import static java.util.Optional.empty;\n+import static java.util.logging.Level.FINER;\n+import static java.util.stream.Collectors.groupingBy;\n+import static java.util.stream.Collectors.toList;\n+\n+public class ElasticProcessorMetaSupplier<T> implements ProcessorMetaSupplier {\n+\n+    private static final long serialVersionUID = 1L;\n+\n+    private transient ILogger logger;\n+\n+    @Nonnull\n+    private final ElasticsearchSourceBuilder<T> builder;\n+\n+    private Map<String, List<Shard>> assignedShards;\n+    private transient Address ownerAddress;\n+\n+    public ElasticProcessorMetaSupplier(@Nonnull ElasticsearchSourceBuilder<T> builder) {\n+        this.builder = builder;\n+    }\n+\n+    @Nonnull\n+    @Override\n+    public Map<String, String> getTags() {\n+        return emptyMap();\n+    }\n+\n+    @Override\n+    public int preferredLocalParallelism() {\n+        if (builder.slicing() || builder.coLocatedReading()) {\n+            return Vertex.LOCAL_PARALLELISM_USE_DEFAULT;\n+        } else {\n+            return 1;\n+        }\n+    }\n+\n+\n+    @Override\n+    public void init(@Nonnull Context context) throws Exception {\n+        logger = context.logger();\n+\n+        List<Shard> shards = readShards();\n+        if (builder.coLocatedReading()) {\n+            List<String> addresses = context\n+                    .jetInstance().getCluster().getMembers().stream()\n+                    .map(m -> uncheckCall((() -> m.getAddress().getInetAddress().getHostAddress())))\n+                    .collect(toList());\n+            this.assignedShards = assignShards(shards, addresses);\n+        } else {\n+            String key = StringPartitioningStrategy.getPartitionKey(String.valueOf(context.jobId()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2MTE2Mg=="}, "originalCommit": {"oid": "fb1b593a7773237a2ef4546e36f2eab6596f9911"}, "originalPosition": 105}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NzI5ODU0OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/impl/ElasticProcessorMetaSupplier.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwMDowMjoxN1rOGAAo5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwMDowMjoxN1rOGAAo5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2MzY1NA==", "bodyText": "by using toSet() here we can remove new HashSet<>(addresses) in assignShards method", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r402663654", "createdAt": "2020-04-03T00:02:17Z", "author": {"login": "gurbuzali"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/impl/ElasticProcessorMetaSupplier.java", "diffHunk": "@@ -0,0 +1,210 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elasticsearch.impl;\n+\n+import com.hazelcast.cluster.Address;\n+import com.hazelcast.internal.json.Json;\n+import com.hazelcast.internal.json.JsonArray;\n+import com.hazelcast.internal.json.JsonObject;\n+import com.hazelcast.internal.json.JsonValue;\n+import com.hazelcast.jet.JetException;\n+import com.hazelcast.jet.elasticsearch.ElasticsearchSourceBuilder;\n+import com.hazelcast.jet.elasticsearch.impl.Shard.Prirep;\n+import com.hazelcast.jet.core.ProcessorMetaSupplier;\n+import com.hazelcast.jet.core.ProcessorSupplier;\n+import com.hazelcast.jet.core.Vertex;\n+import com.hazelcast.jet.core.processor.Processors;\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.partition.strategy.StringPartitioningStrategy;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static com.hazelcast.jet.impl.util.Util.uncheckCall;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.nCopies;\n+import static java.util.Optional.empty;\n+import static java.util.logging.Level.FINER;\n+import static java.util.stream.Collectors.groupingBy;\n+import static java.util.stream.Collectors.toList;\n+\n+public class ElasticProcessorMetaSupplier<T> implements ProcessorMetaSupplier {\n+\n+    private static final long serialVersionUID = 1L;\n+\n+    private transient ILogger logger;\n+\n+    @Nonnull\n+    private final ElasticsearchSourceBuilder<T> builder;\n+\n+    private Map<String, List<Shard>> assignedShards;\n+    private transient Address ownerAddress;\n+\n+    public ElasticProcessorMetaSupplier(@Nonnull ElasticsearchSourceBuilder<T> builder) {\n+        this.builder = builder;\n+    }\n+\n+    @Nonnull\n+    @Override\n+    public Map<String, String> getTags() {\n+        return emptyMap();\n+    }\n+\n+    @Override\n+    public int preferredLocalParallelism() {\n+        if (builder.slicing() || builder.coLocatedReading()) {\n+            return Vertex.LOCAL_PARALLELISM_USE_DEFAULT;\n+        } else {\n+            return 1;\n+        }\n+    }\n+\n+\n+    @Override\n+    public void init(@Nonnull Context context) throws Exception {\n+        logger = context.logger();\n+\n+        List<Shard> shards = readShards();\n+        if (builder.coLocatedReading()) {\n+            List<String> addresses = context\n+                    .jetInstance().getCluster().getMembers().stream()\n+                    .map(m -> uncheckCall((() -> m.getAddress().getInetAddress().getHostAddress())))\n+                    .collect(toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb1b593a7773237a2ef4546e36f2eab6596f9911"}, "originalPosition": 102}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NzM0ODU4OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/impl/ElasticProcessorMetaSupplier.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwMDoyODowOVrOGABFWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMjoyMToyMFrOGBsEQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY3MDkzNg==", "bodyText": "What happens if builder has slicing=true and coLocatedReading=true ?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r402670936", "createdAt": "2020-04-03T00:28:09Z", "author": {"login": "gurbuzali"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/impl/ElasticProcessorMetaSupplier.java", "diffHunk": "@@ -0,0 +1,210 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elasticsearch.impl;\n+\n+import com.hazelcast.cluster.Address;\n+import com.hazelcast.internal.json.Json;\n+import com.hazelcast.internal.json.JsonArray;\n+import com.hazelcast.internal.json.JsonObject;\n+import com.hazelcast.internal.json.JsonValue;\n+import com.hazelcast.jet.JetException;\n+import com.hazelcast.jet.elasticsearch.ElasticsearchSourceBuilder;\n+import com.hazelcast.jet.elasticsearch.impl.Shard.Prirep;\n+import com.hazelcast.jet.core.ProcessorMetaSupplier;\n+import com.hazelcast.jet.core.ProcessorSupplier;\n+import com.hazelcast.jet.core.Vertex;\n+import com.hazelcast.jet.core.processor.Processors;\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.partition.strategy.StringPartitioningStrategy;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static com.hazelcast.jet.impl.util.Util.uncheckCall;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.nCopies;\n+import static java.util.Optional.empty;\n+import static java.util.logging.Level.FINER;\n+import static java.util.stream.Collectors.groupingBy;\n+import static java.util.stream.Collectors.toList;\n+\n+public class ElasticProcessorMetaSupplier<T> implements ProcessorMetaSupplier {\n+\n+    private static final long serialVersionUID = 1L;\n+\n+    private transient ILogger logger;\n+\n+    @Nonnull\n+    private final ElasticsearchSourceBuilder<T> builder;\n+\n+    private Map<String, List<Shard>> assignedShards;\n+    private transient Address ownerAddress;\n+\n+    public ElasticProcessorMetaSupplier(@Nonnull ElasticsearchSourceBuilder<T> builder) {\n+        this.builder = builder;\n+    }\n+\n+    @Nonnull\n+    @Override\n+    public Map<String, String> getTags() {\n+        return emptyMap();\n+    }\n+\n+    @Override\n+    public int preferredLocalParallelism() {\n+        if (builder.slicing() || builder.coLocatedReading()) {\n+            return Vertex.LOCAL_PARALLELISM_USE_DEFAULT;\n+        } else {\n+            return 1;\n+        }\n+    }\n+\n+\n+    @Override\n+    public void init(@Nonnull Context context) throws Exception {\n+        logger = context.logger();\n+\n+        List<Shard> shards = readShards();\n+        if (builder.coLocatedReading()) {\n+            List<String> addresses = context\n+                    .jetInstance().getCluster().getMembers().stream()\n+                    .map(m -> uncheckCall((() -> m.getAddress().getInetAddress().getHostAddress())))\n+                    .collect(toList());\n+            this.assignedShards = assignShards(shards, addresses);\n+        } else {\n+            String key = StringPartitioningStrategy.getPartitionKey(String.valueOf(context.jobId()));\n+            ownerAddress = context.jetInstance().getHazelcastInstance().getPartitionService()\n+                                  .getPartition(key).getOwner().getAddress();\n+        }\n+\n+    }\n+\n+    static Map<String, List<Shard>> assignShards(List<Shard> shards, List<String> addresses) {\n+        Map<String, List<Shard>> nodeCandidates = shards.stream().collect(groupingBy(Shard::getIp));\n+        Map<String, List<Shard>> nodeAssigned = new HashMap<>();\n+\n+        if (!nodeCandidates.keySet().equals(new HashSet<>(addresses))) {\n+            throw new JetException(\"Shard locations are not equal to Jet nodes locations, \" +\n+                    \"shards=\" + nodeCandidates.keySet() +\n+                    \", Jet nodes=\" + addresses);\n+        }\n+\n+        int uniqueShards = (int) shards.stream().map(Shard::indexShard).distinct().count();\n+        Set<String> assignedShards = new HashSet<>();\n+\n+        for (int i = 0; i < (uniqueShards / addresses.size()); i++) {\n+            for (String address : addresses) {\n+                List<Shard> thisNodeCandidates = nodeCandidates.getOrDefault(address, emptyList());\n+                if (thisNodeCandidates.isEmpty()) {\n+                    continue;\n+                }\n+                Shard shard = thisNodeCandidates.remove(0);\n+\n+                List<Shard> nodeShards = nodeAssigned.computeIfAbsent(address, (key) -> new ArrayList<>());\n+                nodeShards.add(shard);\n+\n+                nodeCandidates.values().forEach(candidates ->\n+                        candidates.removeIf(next -> next.indexShard().equals(shard.indexShard())));\n+\n+                assignedShards.add(shard.indexShard());\n+            }\n+        }\n+        if (assignedShards.size() != uniqueShards) {\n+            throw new JetException(\"Not all shards have been assigned assigned\");\n+        }\n+        return nodeAssigned;\n+    }\n+\n+\n+    @SuppressFBWarnings(\"RCN_REDUNDANT_NULLCHECK_WOULD_HAVE_BEEN_A_NPE\")\n+    private List<Shard> readShards() throws IOException {\n+        try (RestHighLevelClient client = builder.clientSupplier().get()) {\n+            SearchRequest sr = builder.searchRequestSupplier().get();\n+            Request r = new Request(\"GET\", \"/_cat/shards/\" + String.join(\",\", sr.indices()));\n+            r.addParameter(\"format\", \"json\");\n+            Response res = client.getLowLevelClient().performRequest(r);\n+\n+            try (InputStreamReader reader = new InputStreamReader(res.getEntity().getContent(), UTF_8)) {\n+                JsonArray array = Json.parse(reader).asArray();\n+                List<Shard> shards = new ArrayList<>(array.size());\n+                for (JsonValue value : array) {\n+                    Optional<Shard> shard = convertToShard(value);\n+                    shard.ifPresent(shards::add);\n+                }\n+\n+                if (logger.isFineEnabled()) {\n+                    logger.log(FINER, \"Shards \" + shards);\n+                }\n+                return shards;\n+            }\n+        }\n+    }\n+\n+    private Optional<Shard> convertToShard(JsonValue value) {\n+        JsonObject object = value.asObject();\n+        // TODO IndexShardState.STARTED but this is deeply inside elastic, should we mirror the enum?\n+        if (\"STARTED\".equals(object.get(\"state\").asString())) {\n+            Shard shard = new Shard(\n+                    object.get(\"index\").asString(),\n+                    Integer.parseInt(object.get(\"shard\").asString()),\n+                    Prirep.valueOf(object.get(\"prirep\").asString()),\n+                    Integer.parseInt(object.get(\"docs\").asString()),\n+                    object.get(\"state\").asString(),\n+                    object.get(\"ip\").asString(),\n+                    object.get(\"node\").asString()\n+            );\n+            return Optional.of(shard);\n+        } else {\n+            return empty();\n+        }\n+    }\n+\n+    @Nonnull\n+    @Override\n+    public Function<? super Address, ? extends ProcessorSupplier> get(@Nonnull List<Address> addresses) {\n+        if (builder.slicing()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb1b593a7773237a2ef4546e36f2eab6596f9911"}, "originalPosition": 195}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQyMzc0Ng==", "bodyText": "Wanted to ignore / forbid this combination originally, but it might make sense in certain situations.\nSee the updates.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404423746", "createdAt": "2020-04-06T22:21:20Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/impl/ElasticProcessorMetaSupplier.java", "diffHunk": "@@ -0,0 +1,210 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elasticsearch.impl;\n+\n+import com.hazelcast.cluster.Address;\n+import com.hazelcast.internal.json.Json;\n+import com.hazelcast.internal.json.JsonArray;\n+import com.hazelcast.internal.json.JsonObject;\n+import com.hazelcast.internal.json.JsonValue;\n+import com.hazelcast.jet.JetException;\n+import com.hazelcast.jet.elasticsearch.ElasticsearchSourceBuilder;\n+import com.hazelcast.jet.elasticsearch.impl.Shard.Prirep;\n+import com.hazelcast.jet.core.ProcessorMetaSupplier;\n+import com.hazelcast.jet.core.ProcessorSupplier;\n+import com.hazelcast.jet.core.Vertex;\n+import com.hazelcast.jet.core.processor.Processors;\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.partition.strategy.StringPartitioningStrategy;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static com.hazelcast.jet.impl.util.Util.uncheckCall;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.nCopies;\n+import static java.util.Optional.empty;\n+import static java.util.logging.Level.FINER;\n+import static java.util.stream.Collectors.groupingBy;\n+import static java.util.stream.Collectors.toList;\n+\n+public class ElasticProcessorMetaSupplier<T> implements ProcessorMetaSupplier {\n+\n+    private static final long serialVersionUID = 1L;\n+\n+    private transient ILogger logger;\n+\n+    @Nonnull\n+    private final ElasticsearchSourceBuilder<T> builder;\n+\n+    private Map<String, List<Shard>> assignedShards;\n+    private transient Address ownerAddress;\n+\n+    public ElasticProcessorMetaSupplier(@Nonnull ElasticsearchSourceBuilder<T> builder) {\n+        this.builder = builder;\n+    }\n+\n+    @Nonnull\n+    @Override\n+    public Map<String, String> getTags() {\n+        return emptyMap();\n+    }\n+\n+    @Override\n+    public int preferredLocalParallelism() {\n+        if (builder.slicing() || builder.coLocatedReading()) {\n+            return Vertex.LOCAL_PARALLELISM_USE_DEFAULT;\n+        } else {\n+            return 1;\n+        }\n+    }\n+\n+\n+    @Override\n+    public void init(@Nonnull Context context) throws Exception {\n+        logger = context.logger();\n+\n+        List<Shard> shards = readShards();\n+        if (builder.coLocatedReading()) {\n+            List<String> addresses = context\n+                    .jetInstance().getCluster().getMembers().stream()\n+                    .map(m -> uncheckCall((() -> m.getAddress().getInetAddress().getHostAddress())))\n+                    .collect(toList());\n+            this.assignedShards = assignShards(shards, addresses);\n+        } else {\n+            String key = StringPartitioningStrategy.getPartitionKey(String.valueOf(context.jobId()));\n+            ownerAddress = context.jetInstance().getHazelcastInstance().getPartitionService()\n+                                  .getPartition(key).getOwner().getAddress();\n+        }\n+\n+    }\n+\n+    static Map<String, List<Shard>> assignShards(List<Shard> shards, List<String> addresses) {\n+        Map<String, List<Shard>> nodeCandidates = shards.stream().collect(groupingBy(Shard::getIp));\n+        Map<String, List<Shard>> nodeAssigned = new HashMap<>();\n+\n+        if (!nodeCandidates.keySet().equals(new HashSet<>(addresses))) {\n+            throw new JetException(\"Shard locations are not equal to Jet nodes locations, \" +\n+                    \"shards=\" + nodeCandidates.keySet() +\n+                    \", Jet nodes=\" + addresses);\n+        }\n+\n+        int uniqueShards = (int) shards.stream().map(Shard::indexShard).distinct().count();\n+        Set<String> assignedShards = new HashSet<>();\n+\n+        for (int i = 0; i < (uniqueShards / addresses.size()); i++) {\n+            for (String address : addresses) {\n+                List<Shard> thisNodeCandidates = nodeCandidates.getOrDefault(address, emptyList());\n+                if (thisNodeCandidates.isEmpty()) {\n+                    continue;\n+                }\n+                Shard shard = thisNodeCandidates.remove(0);\n+\n+                List<Shard> nodeShards = nodeAssigned.computeIfAbsent(address, (key) -> new ArrayList<>());\n+                nodeShards.add(shard);\n+\n+                nodeCandidates.values().forEach(candidates ->\n+                        candidates.removeIf(next -> next.indexShard().equals(shard.indexShard())));\n+\n+                assignedShards.add(shard.indexShard());\n+            }\n+        }\n+        if (assignedShards.size() != uniqueShards) {\n+            throw new JetException(\"Not all shards have been assigned assigned\");\n+        }\n+        return nodeAssigned;\n+    }\n+\n+\n+    @SuppressFBWarnings(\"RCN_REDUNDANT_NULLCHECK_WOULD_HAVE_BEEN_A_NPE\")\n+    private List<Shard> readShards() throws IOException {\n+        try (RestHighLevelClient client = builder.clientSupplier().get()) {\n+            SearchRequest sr = builder.searchRequestSupplier().get();\n+            Request r = new Request(\"GET\", \"/_cat/shards/\" + String.join(\",\", sr.indices()));\n+            r.addParameter(\"format\", \"json\");\n+            Response res = client.getLowLevelClient().performRequest(r);\n+\n+            try (InputStreamReader reader = new InputStreamReader(res.getEntity().getContent(), UTF_8)) {\n+                JsonArray array = Json.parse(reader).asArray();\n+                List<Shard> shards = new ArrayList<>(array.size());\n+                for (JsonValue value : array) {\n+                    Optional<Shard> shard = convertToShard(value);\n+                    shard.ifPresent(shards::add);\n+                }\n+\n+                if (logger.isFineEnabled()) {\n+                    logger.log(FINER, \"Shards \" + shards);\n+                }\n+                return shards;\n+            }\n+        }\n+    }\n+\n+    private Optional<Shard> convertToShard(JsonValue value) {\n+        JsonObject object = value.asObject();\n+        // TODO IndexShardState.STARTED but this is deeply inside elastic, should we mirror the enum?\n+        if (\"STARTED\".equals(object.get(\"state\").asString())) {\n+            Shard shard = new Shard(\n+                    object.get(\"index\").asString(),\n+                    Integer.parseInt(object.get(\"shard\").asString()),\n+                    Prirep.valueOf(object.get(\"prirep\").asString()),\n+                    Integer.parseInt(object.get(\"docs\").asString()),\n+                    object.get(\"state\").asString(),\n+                    object.get(\"ip\").asString(),\n+                    object.get(\"node\").asString()\n+            );\n+            return Optional.of(shard);\n+        } else {\n+            return empty();\n+        }\n+    }\n+\n+    @Nonnull\n+    @Override\n+    public Function<? super Address, ? extends ProcessorSupplier> get(@Nonnull List<Address> addresses) {\n+        if (builder.slicing()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY3MDkzNg=="}, "originalCommit": {"oid": "fb1b593a7773237a2ef4546e36f2eab6596f9911"}, "originalPosition": 195}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NzM1NDI2OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/impl/Shard.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwMDozMTowOVrOGABIwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMjoyMTozNFrOGBsEnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY3MTgwOA==", "bodyText": "do we need all of these fields ? looks like some of them are not used, we keep them for debug purposes ?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r402671808", "createdAt": "2020-04-03T00:31:09Z", "author": {"login": "gurbuzali"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/impl/Shard.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elasticsearch.impl;\n+\n+import javax.annotation.Nonnull;\n+import java.io.Serializable;\n+\n+class Shard implements Serializable {\n+\n+    private static final long serialVersionUID = 1L;\n+\n+    private final String index;\n+    private final int shard;\n+    private final Prirep prirep;\n+    private final int docs;\n+    private final String state;\n+    private final String ip;\n+    private final String node;\n+\n+    Shard(@Nonnull String index, int shard, @Nonnull Prirep prirep, int docs,\n+                 @Nonnull String state, @Nonnull String ip, @Nonnull String node) {\n+        this.index = index;\n+        this.shard = shard;\n+        this.prirep = prirep;\n+        this.docs = docs;\n+        this.state = state;\n+        this.ip = ip;\n+        this.node = node;\n+    }\n+\n+    public String indexShard() {\n+        return index + \"-\" + shard;\n+    }\n+    public String getIndex() {\n+        return index;\n+    }\n+\n+    public int getShard() {\n+        return shard;\n+    }\n+\n+    public Prirep getPrirep() {\n+        return prirep;\n+    }\n+\n+    public int getDocs() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb1b593a7773237a2ef4546e36f2eab6596f9911"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQyMzgzOQ==", "bodyText": "Yes, they are useful for debugging.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404423839", "createdAt": "2020-04-06T22:21:34Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elasticsearch/impl/Shard.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elasticsearch.impl;\n+\n+import javax.annotation.Nonnull;\n+import java.io.Serializable;\n+\n+class Shard implements Serializable {\n+\n+    private static final long serialVersionUID = 1L;\n+\n+    private final String index;\n+    private final int shard;\n+    private final Prirep prirep;\n+    private final int docs;\n+    private final String state;\n+    private final String ip;\n+    private final String node;\n+\n+    Shard(@Nonnull String index, int shard, @Nonnull Prirep prirep, int docs,\n+                 @Nonnull String state, @Nonnull String ip, @Nonnull String node) {\n+        this.index = index;\n+        this.shard = shard;\n+        this.prirep = prirep;\n+        this.docs = docs;\n+        this.state = state;\n+        this.ip = ip;\n+        this.node = node;\n+    }\n+\n+    public String indexShard() {\n+        return index + \"-\" + shard;\n+    }\n+    public String getIndex() {\n+        return index;\n+    }\n+\n+    public int getShard() {\n+        return shard;\n+    }\n+\n+    public Prirep getPrirep() {\n+        return prirep;\n+    }\n+\n+    public int getDocs() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY3MTgwOA=="}, "originalCommit": {"oid": "fb1b593a7773237a2ef4546e36f2eab6596f9911"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTcwNzYyOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-5/README.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjoyMTo1MFrOGCA4Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjoyMTo1MFrOGCA4Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2NDcwMg==", "bodyText": "refers to contrib module (not repeating for other ES versions)", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404764702", "createdAt": "2020-04-07T12:21:50Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-5/README.md", "diffHunk": "@@ -0,0 +1,90 @@\n+# Elasticsearch Connector\n+\n+A Hazelcast Jet connector for Elasticsearch (v5.6.x) for querying/indexing objects\n+from/to Elasticsearch.\n+\n+## Getting Started\n+\n+### Installing\n+\n+The Elasticsearch Connector artifacts are published in the Maven repositories.\n+\n+Add the following lines to your pom.xml to include it as a dependency to your project:\n+\n+```\n+<dependency>\n+    <groupId>com.hazelcast.jet.contrib</groupId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTcwOTcyOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-5/README.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjoyMjoyN1rOGCA5dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjoyMjoyN1rOGCA5dA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2NTA0NA==", "bodyText": "would be good to review the readme since it uses the old API I think", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404765044", "createdAt": "2020-04-07T12:22:27Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-5/README.md", "diffHunk": "@@ -0,0 +1,90 @@\n+# Elasticsearch Connector\n+\n+A Hazelcast Jet connector for Elasticsearch (v5.6.x) for querying/indexing objects\n+from/to Elasticsearch.\n+\n+## Getting Started\n+\n+### Installing\n+\n+The Elasticsearch Connector artifacts are published in the Maven repositories.\n+\n+Add the following lines to your pom.xml to include it as a dependency to your project:\n+\n+```\n+<dependency>\n+    <groupId>com.hazelcast.jet.contrib</groupId>\n+    <artifactId>elasticsearch-5</artifactId>\n+    <version>${version}</version>\n+</dependency>\n+```\n+\n+or if you are using Gradle: \n+```\n+compile group: 'com.hazelcast.jet.contrib', name: 'elasticsearch-5', version: ${version}\n+```\n+\n+### Usage\n+\n+#### As a Source\n+\n+Elasticsearch batch source (`ElasticsearchSources.elasticsearch()`) executes\n+the query and retrieves the results using `scrolling`.\n+\n+Following is an example pipeline which queries Elasticsearch and logs the\n+results:\n+\n+```java\n+Pipeline p = Pipeline.create();\n+\n+p.readFrom(ElasticsearchSources.elasticsearch(\"sourceName\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTcxMTg2OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-5/src/main/java/com/hazelcast/jet/contrib/elasticsearch/ElasticsearchSinks.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjoyMzowM1rOGCA6tQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjoyMzowM1rOGCA6tQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2NTM2NQ==", "bodyText": "package name shouldn't be in contrib", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404765365", "createdAt": "2020-04-07T12:23:03Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-5/src/main/java/com/hazelcast/jet/contrib/elasticsearch/ElasticsearchSinks.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.contrib.elasticsearch;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTcxNTUzOnYy", "diffSide": "RIGHT", "path": "extensions/pom.xml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjoyMzo1N1rOGCA82A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjoyMzo1N1rOGCA82A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2NTkxMg==", "bodyText": "why are these commented out?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404765912", "createdAt": "2020-04-07T12:23:57Z", "author": {"login": "cangencer"}, "path": "extensions/pom.xml", "diffHunk": "@@ -34,6 +34,11 @@\n \n     <modules>\n         <module>avro</module>\n+<!--\n+        <module>elasticsearch/elasticsearch-5</module>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTczMDg2OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjoyODowM1rOGCBGPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNDo1Njo0NVrOGRXKqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2ODMxOA==", "bodyText": "SearchRequest is Writable so it could be serialized, rather than requiring a supplier.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404768318", "createdAt": "2020-04-07T12:28:03Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import org.apache.http.HttpHost;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sources.\n+ * Alternatively you can use {@link ElasticSourceBuilder}\n+ *\n+ * @since 4.1\n+ */\n+public final class ElasticSources {\n+\n+    private static final int DEFAULT_PORT = 9200;\n+\n+    private ElasticSources() {\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * <p>\n+     * Useful for quick prototyping. See other methods {@link #elastic(SupplierEx, SupplierEx, FunctionEx)}\n+     * and {@link #builder()}\n+     */\n+    public static BatchSource<String> elastic() {\n+        return elastic(() -> new RestHighLevelClient(\n+                RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+        ));\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Queries all indexes for all documents.\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static BatchSource<String> elastic(@Nonnull SupplierEx<RestHighLevelClient> clientSupplier) {\n+        return elastic(clientSupplier, SearchHit::getSourceAsString);\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static <T> BatchSource<T> elastic(@Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(() -> new RestHighLevelClient(\n+                        RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+                ),\n+                mapHitFn\n+        );\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Uses provided mapHitFn to map results.\n+     * Queries all indexes for all documents.\n+     *\n+     * @param clientSupplier RestHighLevelClient supplier\n+     * @param mapHitFn       supplier of a function mapping the result from SearchHit to a result type\n+     * @param <T>            result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(clientSupplier, SearchRequest::new, mapHitFn);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     *\n+     * @param clientSupplier        RestHighLevelClient supplier\n+     * @param searchRequestSupplier supplier of a SearchRequest used to query for documents\n+     * @param mapHitFn              supplier of a function mapping the result from SearchHit to a target type\n+     * @param <T>                   result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull SupplierEx<SearchRequest> searchRequestSupplier,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTI5OTA0MA==", "bodyText": "We would need to create some adapter for org.elasticsearch.common.io.stream.Writeable and the user would need to register it to Jet, right?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r405299040", "createdAt": "2020-04-08T06:59:16Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import org.apache.http.HttpHost;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sources.\n+ * Alternatively you can use {@link ElasticSourceBuilder}\n+ *\n+ * @since 4.1\n+ */\n+public final class ElasticSources {\n+\n+    private static final int DEFAULT_PORT = 9200;\n+\n+    private ElasticSources() {\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * <p>\n+     * Useful for quick prototyping. See other methods {@link #elastic(SupplierEx, SupplierEx, FunctionEx)}\n+     * and {@link #builder()}\n+     */\n+    public static BatchSource<String> elastic() {\n+        return elastic(() -> new RestHighLevelClient(\n+                RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+        ));\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Queries all indexes for all documents.\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static BatchSource<String> elastic(@Nonnull SupplierEx<RestHighLevelClient> clientSupplier) {\n+        return elastic(clientSupplier, SearchHit::getSourceAsString);\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static <T> BatchSource<T> elastic(@Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(() -> new RestHighLevelClient(\n+                        RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+                ),\n+                mapHitFn\n+        );\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Uses provided mapHitFn to map results.\n+     * Queries all indexes for all documents.\n+     *\n+     * @param clientSupplier RestHighLevelClient supplier\n+     * @param mapHitFn       supplier of a function mapping the result from SearchHit to a result type\n+     * @param <T>            result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(clientSupplier, SearchRequest::new, mapHitFn);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     *\n+     * @param clientSupplier        RestHighLevelClient supplier\n+     * @param searchRequestSupplier supplier of a SearchRequest used to query for documents\n+     * @param mapHitFn              supplier of a function mapping the result from SearchHit to a target type\n+     * @param <T>                   result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull SupplierEx<SearchRequest> searchRequestSupplier,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2ODMxOA=="}, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTMwNTYxNw==", "bodyText": "Yes something like that (there's something similar done in hadoop module) but when supplying it as a parameter, I think you'll need to serialize/deserialize by hand (because parent class is only Serializable)", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r405305617", "createdAt": "2020-04-08T07:13:28Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import org.apache.http.HttpHost;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sources.\n+ * Alternatively you can use {@link ElasticSourceBuilder}\n+ *\n+ * @since 4.1\n+ */\n+public final class ElasticSources {\n+\n+    private static final int DEFAULT_PORT = 9200;\n+\n+    private ElasticSources() {\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * <p>\n+     * Useful for quick prototyping. See other methods {@link #elastic(SupplierEx, SupplierEx, FunctionEx)}\n+     * and {@link #builder()}\n+     */\n+    public static BatchSource<String> elastic() {\n+        return elastic(() -> new RestHighLevelClient(\n+                RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+        ));\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Queries all indexes for all documents.\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static BatchSource<String> elastic(@Nonnull SupplierEx<RestHighLevelClient> clientSupplier) {\n+        return elastic(clientSupplier, SearchHit::getSourceAsString);\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static <T> BatchSource<T> elastic(@Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(() -> new RestHighLevelClient(\n+                        RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+                ),\n+                mapHitFn\n+        );\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Uses provided mapHitFn to map results.\n+     * Queries all indexes for all documents.\n+     *\n+     * @param clientSupplier RestHighLevelClient supplier\n+     * @param mapHitFn       supplier of a function mapping the result from SearchHit to a result type\n+     * @param <T>            result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(clientSupplier, SearchRequest::new, mapHitFn);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     *\n+     * @param clientSupplier        RestHighLevelClient supplier\n+     * @param searchRequestSupplier supplier of a SearchRequest used to query for documents\n+     * @param mapHitFn              supplier of a function mapping the result from SearchHit to a target type\n+     * @param <T>                   result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull SupplierEx<SearchRequest> searchRequestSupplier,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2ODMxOA=="}, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg1ODUzNw==", "bodyText": "So the request can be easily serialized to byte[] in following way:\nByteArrayOutputStream baos = new ByteArrayOutputStream();\nOutputStreamStreamOutput osso = new OutputStreamStreamOutput(baos);\nsearchRequest.writeTo(osso);\nbaos.toByteArray();\n\nbut the deserialization isn't that easy:\nByteArrayInputStream bais = new ByteArrayInputStream(searchRequest);\nInputStreamStreamInput input = new InputStreamStreamInput(bais);\nreturn new SearchRequest(input);\n\nThis works for a simple SearchRequest, but if some parameters of the SearchRequest are set (e.g. SearchRequest#source) it fails to deserialize, requiring  NamedWriteableAwareStreamInput as input, which needs NamedWriteableRegistry - this is an internal elastic class, initialized e.g. here https://github.com/elastic/elasticsearch/blob/master/server/src/main/java/org/elasticsearch/node/Node.java#L397\nAlso this part of API is different between elastic 5, 6 and 7.\nWith all this I think it's better to keep the supplier.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r420858537", "createdAt": "2020-05-06T14:56:45Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import org.apache.http.HttpHost;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sources.\n+ * Alternatively you can use {@link ElasticSourceBuilder}\n+ *\n+ * @since 4.1\n+ */\n+public final class ElasticSources {\n+\n+    private static final int DEFAULT_PORT = 9200;\n+\n+    private ElasticSources() {\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * <p>\n+     * Useful for quick prototyping. See other methods {@link #elastic(SupplierEx, SupplierEx, FunctionEx)}\n+     * and {@link #builder()}\n+     */\n+    public static BatchSource<String> elastic() {\n+        return elastic(() -> new RestHighLevelClient(\n+                RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+        ));\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Queries all indexes for all documents.\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static BatchSource<String> elastic(@Nonnull SupplierEx<RestHighLevelClient> clientSupplier) {\n+        return elastic(clientSupplier, SearchHit::getSourceAsString);\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static <T> BatchSource<T> elastic(@Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(() -> new RestHighLevelClient(\n+                        RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+                ),\n+                mapHitFn\n+        );\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Uses provided mapHitFn to map results.\n+     * Queries all indexes for all documents.\n+     *\n+     * @param clientSupplier RestHighLevelClient supplier\n+     * @param mapHitFn       supplier of a function mapping the result from SearchHit to a result type\n+     * @param <T>            result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(clientSupplier, SearchRequest::new, mapHitFn);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     *\n+     * @param clientSupplier        RestHighLevelClient supplier\n+     * @param searchRequestSupplier supplier of a SearchRequest used to query for documents\n+     * @param mapHitFn              supplier of a function mapping the result from SearchHit to a target type\n+     * @param <T>                   result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull SupplierEx<SearchRequest> searchRequestSupplier,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2ODMxOA=="}, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 102}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTczNTg4OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjoyOToxMFrOGCBJEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODozMDozN1rOGTSEog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2OTA0Mg==", "bodyText": "instead of client we should take the RestClientBuilder", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404769042", "createdAt": "2020-04-07T12:29:10Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import org.apache.http.HttpHost;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sources.\n+ * Alternatively you can use {@link ElasticSourceBuilder}\n+ *\n+ * @since 4.1\n+ */\n+public final class ElasticSources {\n+\n+    private static final int DEFAULT_PORT = 9200;\n+\n+    private ElasticSources() {\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * <p>\n+     * Useful for quick prototyping. See other methods {@link #elastic(SupplierEx, SupplierEx, FunctionEx)}\n+     * and {@link #builder()}\n+     */\n+    public static BatchSource<String> elastic() {\n+        return elastic(() -> new RestHighLevelClient(\n+                RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+        ));\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Queries all indexes for all documents.\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static BatchSource<String> elastic(@Nonnull SupplierEx<RestHighLevelClient> clientSupplier) {\n+        return elastic(clientSupplier, SearchHit::getSourceAsString);\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static <T> BatchSource<T> elastic(@Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(() -> new RestHighLevelClient(\n+                        RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+                ),\n+                mapHitFn\n+        );\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Uses provided mapHitFn to map results.\n+     * Queries all indexes for all documents.\n+     *\n+     * @param clientSupplier RestHighLevelClient supplier\n+     * @param mapHitFn       supplier of a function mapping the result from SearchHit to a result type\n+     * @param <T>            result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(clientSupplier, SearchRequest::new, mapHitFn);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     *\n+     * @param clientSupplier        RestHighLevelClient supplier\n+     * @param searchRequestSupplier supplier of a SearchRequest used to query for documents\n+     * @param mapHitFn              supplier of a function mapping the result from SearchHit to a target type\n+     * @param <T>                   result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTMxMzE2OQ==", "bodyText": "In our examples and tests we just pass the RestClientBuilder to RestHighLevelClient, but the user might have own subclass of RestHighLevelClient.\nI didn't investigate whether there is a use case where it would actually make sense to use a custom client. Will check and change it if not.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r405313169", "createdAt": "2020-04-08T07:28:15Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import org.apache.http.HttpHost;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sources.\n+ * Alternatively you can use {@link ElasticSourceBuilder}\n+ *\n+ * @since 4.1\n+ */\n+public final class ElasticSources {\n+\n+    private static final int DEFAULT_PORT = 9200;\n+\n+    private ElasticSources() {\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * <p>\n+     * Useful for quick prototyping. See other methods {@link #elastic(SupplierEx, SupplierEx, FunctionEx)}\n+     * and {@link #builder()}\n+     */\n+    public static BatchSource<String> elastic() {\n+        return elastic(() -> new RestHighLevelClient(\n+                RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+        ));\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Queries all indexes for all documents.\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static BatchSource<String> elastic(@Nonnull SupplierEx<RestHighLevelClient> clientSupplier) {\n+        return elastic(clientSupplier, SearchHit::getSourceAsString);\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static <T> BatchSource<T> elastic(@Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(() -> new RestHighLevelClient(\n+                        RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+                ),\n+                mapHitFn\n+        );\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Uses provided mapHitFn to map results.\n+     * Queries all indexes for all documents.\n+     *\n+     * @param clientSupplier RestHighLevelClient supplier\n+     * @param mapHitFn       supplier of a function mapping the result from SearchHit to a result type\n+     * @param <T>            result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(clientSupplier, SearchRequest::new, mapHitFn);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     *\n+     * @param clientSupplier        RestHighLevelClient supplier\n+     * @param searchRequestSupplier supplier of a SearchRequest used to query for documents\n+     * @param mapHitFn              supplier of a function mapping the result from SearchHit to a target type\n+     * @param <T>                   result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2OTA0Mg=="}, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTMxNDU0OQ==", "bodyText": "Why would they subclass the client? I think the intention is to have the user write as little code as possible.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r405314549", "createdAt": "2020-04-08T07:30:50Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import org.apache.http.HttpHost;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sources.\n+ * Alternatively you can use {@link ElasticSourceBuilder}\n+ *\n+ * @since 4.1\n+ */\n+public final class ElasticSources {\n+\n+    private static final int DEFAULT_PORT = 9200;\n+\n+    private ElasticSources() {\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * <p>\n+     * Useful for quick prototyping. See other methods {@link #elastic(SupplierEx, SupplierEx, FunctionEx)}\n+     * and {@link #builder()}\n+     */\n+    public static BatchSource<String> elastic() {\n+        return elastic(() -> new RestHighLevelClient(\n+                RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+        ));\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Queries all indexes for all documents.\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static BatchSource<String> elastic(@Nonnull SupplierEx<RestHighLevelClient> clientSupplier) {\n+        return elastic(clientSupplier, SearchHit::getSourceAsString);\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static <T> BatchSource<T> elastic(@Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(() -> new RestHighLevelClient(\n+                        RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+                ),\n+                mapHitFn\n+        );\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Uses provided mapHitFn to map results.\n+     * Queries all indexes for all documents.\n+     *\n+     * @param clientSupplier RestHighLevelClient supplier\n+     * @param mapHitFn       supplier of a function mapping the result from SearchHit to a result type\n+     * @param <T>            result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(clientSupplier, SearchRequest::new, mapHitFn);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     *\n+     * @param clientSupplier        RestHighLevelClient supplier\n+     * @param searchRequestSupplier supplier of a SearchRequest used to query for documents\n+     * @param mapHitFn              supplier of a function mapping the result from SearchHit to a target type\n+     * @param <T>                   result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2OTA0Mg=="}, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk5Mzc0Nw==", "bodyText": "Yeah, it probably doesn't make sense in our case.\nGenerally when you create a plugin to Elasticsearch and want to support it in the client you just subclass the client and add methods for your plugin. But the connector wouldn't use any of this so we are fine with the regular client.\nOnly thing might be authentication, but that's done either via the optionsFn or via the low level RestClient.\nI will check if it can be replaced easily, there are some tests with the client mocked.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r405993747", "createdAt": "2020-04-09T06:57:27Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import org.apache.http.HttpHost;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sources.\n+ * Alternatively you can use {@link ElasticSourceBuilder}\n+ *\n+ * @since 4.1\n+ */\n+public final class ElasticSources {\n+\n+    private static final int DEFAULT_PORT = 9200;\n+\n+    private ElasticSources() {\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * <p>\n+     * Useful for quick prototyping. See other methods {@link #elastic(SupplierEx, SupplierEx, FunctionEx)}\n+     * and {@link #builder()}\n+     */\n+    public static BatchSource<String> elastic() {\n+        return elastic(() -> new RestHighLevelClient(\n+                RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+        ));\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Queries all indexes for all documents.\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static BatchSource<String> elastic(@Nonnull SupplierEx<RestHighLevelClient> clientSupplier) {\n+        return elastic(clientSupplier, SearchHit::getSourceAsString);\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static <T> BatchSource<T> elastic(@Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(() -> new RestHighLevelClient(\n+                        RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+                ),\n+                mapHitFn\n+        );\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Uses provided mapHitFn to map results.\n+     * Queries all indexes for all documents.\n+     *\n+     * @param clientSupplier RestHighLevelClient supplier\n+     * @param mapHitFn       supplier of a function mapping the result from SearchHit to a result type\n+     * @param <T>            result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(clientSupplier, SearchRequest::new, mapHitFn);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     *\n+     * @param clientSupplier        RestHighLevelClient supplier\n+     * @param searchRequestSupplier supplier of a SearchRequest used to query for documents\n+     * @param mapHitFn              supplier of a function mapping the result from SearchHit to a target type\n+     * @param <T>                   result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2OTA0Mg=="}, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg3MjIyNg==", "bodyText": "this should use the builder, this hasn't been resolved.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422872226", "createdAt": "2020-05-11T08:30:37Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import org.apache.http.HttpHost;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sources.\n+ * Alternatively you can use {@link ElasticSourceBuilder}\n+ *\n+ * @since 4.1\n+ */\n+public final class ElasticSources {\n+\n+    private static final int DEFAULT_PORT = 9200;\n+\n+    private ElasticSources() {\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * <p>\n+     * Useful for quick prototyping. See other methods {@link #elastic(SupplierEx, SupplierEx, FunctionEx)}\n+     * and {@link #builder()}\n+     */\n+    public static BatchSource<String> elastic() {\n+        return elastic(() -> new RestHighLevelClient(\n+                RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+        ));\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Queries all indexes for all documents.\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static BatchSource<String> elastic(@Nonnull SupplierEx<RestHighLevelClient> clientSupplier) {\n+        return elastic(clientSupplier, SearchHit::getSourceAsString);\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    public static <T> BatchSource<T> elastic(@Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(() -> new RestHighLevelClient(\n+                        RestClient.builder(new HttpHost(\"localhost\", DEFAULT_PORT))\n+                ),\n+                mapHitFn\n+        );\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Uses provided mapHitFn to map results.\n+     * Queries all indexes for all documents.\n+     *\n+     * @param clientSupplier RestHighLevelClient supplier\n+     * @param mapHitFn       supplier of a function mapping the result from SearchHit to a result type\n+     * @param <T>            result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(clientSupplier, SearchRequest::new, mapHitFn);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     *\n+     * @param clientSupplier        RestHighLevelClient supplier\n+     * @param searchRequestSupplier supplier of a SearchRequest used to query for documents\n+     * @param mapHitFn              supplier of a function mapping the result from SearchHit to a target type\n+     * @param <T>                   result type returned by the map function\n+     */\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2OTA0Mg=="}, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 101}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTc0ODAzOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/ElasticProcessor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjozMjoyNlrOGCBQ0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzowOTozMlrOGDMODg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3MTAyNQ==", "bodyText": "what is the reason here we need a custom processor rather than using the source builder? We also use a different naming convention for processors. (look at StreamKafkaP etc)", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404771025", "createdAt": "2020-04-07T12:32:26Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/ElasticProcessor.java", "diffHunk": "@@ -0,0 +1,232 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic.impl;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.jet.JetException;\n+import com.hazelcast.jet.Traverser;\n+import com.hazelcast.jet.Traversers;\n+import com.hazelcast.jet.core.AbstractProcessor;\n+import com.hazelcast.jet.elastic.ElasticSourceBuilder;\n+import com.hazelcast.logging.ILogger;\n+import org.apache.http.HttpHost;\n+import org.apache.lucene.search.TotalHits;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.ClearScrollRequest;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.action.search.SearchScrollRequest;\n+import org.elasticsearch.client.Node;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.SearchHits;\n+import org.elasticsearch.search.slice.SliceBuilder;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.util.List;\n+\n+import static java.util.Collections.singleton;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.stream.Collectors.joining;\n+import static java.util.stream.Collectors.toList;\n+\n+final class ElasticProcessor<T> extends AbstractProcessor {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTk5OTExOA==", "bodyText": "In the ElasticProcessorMetaSupplier the list of shards is loaded and assigned to nodes.\nThe shards can't be loaded when the source is created, the host from which you submit may not have direct network access to elastic (the cluster).\nWe could load the shards during initialization of the context of each processor in the builder, but there is a small chance that different processors would get different view of the shards (some might start relocating, disconnect etc..).\nI also followed the structure of the hadoop connector.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r405999118", "createdAt": "2020-04-09T07:09:32Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/ElasticProcessor.java", "diffHunk": "@@ -0,0 +1,232 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic.impl;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.jet.JetException;\n+import com.hazelcast.jet.Traverser;\n+import com.hazelcast.jet.Traversers;\n+import com.hazelcast.jet.core.AbstractProcessor;\n+import com.hazelcast.jet.elastic.ElasticSourceBuilder;\n+import com.hazelcast.logging.ILogger;\n+import org.apache.http.HttpHost;\n+import org.apache.lucene.search.TotalHits;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.ClearScrollRequest;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.action.search.SearchScrollRequest;\n+import org.elasticsearch.client.Node;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.SearchHits;\n+import org.elasticsearch.search.slice.SliceBuilder;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.util.List;\n+\n+import static java.util.Collections.singleton;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.stream.Collectors.joining;\n+import static java.util.stream.Collectors.toList;\n+\n+final class ElasticProcessor<T> extends AbstractProcessor {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3MTAyNQ=="}, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTc1ODM3OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjozNTowM1rOGCBXOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwNjowNjoxM1rOGTNt3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3MjY2NQ==", "bodyText": "Builders shouldn't be serializable. We don't want it capturing anything extra by accident. It makes the seperation between what's part of source params and what's not (i.e. parallelism) unclear.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404772665", "createdAt": "2020-04-07T12:35:03Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "diffHunk": "@@ -0,0 +1,249 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.core.Vertex;\n+import com.hazelcast.jet.elastic.impl.ElasticProcessorMetaSupplier;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Sources;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch source which reads data from Elasticsearch and\n+ * converts SearchHits using provided {@code mapHitFn}\n+ *\n+ * @param <T> type of the mapping function from {@link SearchHit} -> T\n+ *           TODO not sure about the type parameter name - T as the usual default, or R for Result\n+ *           also we could accept the function in the build() method, same as the original source did it\n+ * @since 4.1\n+ */\n+public class ElasticSourceBuilder<T> implements Serializable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjgwMDg2Mw==", "bodyText": "Moved the configuration to Serializable config class.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422800863", "createdAt": "2020-05-11T06:06:13Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "diffHunk": "@@ -0,0 +1,249 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.core.Vertex;\n+import com.hazelcast.jet.elastic.impl.ElasticProcessorMetaSupplier;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Sources;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch source which reads data from Elasticsearch and\n+ * converts SearchHits using provided {@code mapHitFn}\n+ *\n+ * @param <T> type of the mapping function from {@link SearchHit} -> T\n+ *           TODO not sure about the type parameter name - T as the usual default, or R for Result\n+ *           also we could accept the function in the build() method, same as the original source did it\n+ * @since 4.1\n+ */\n+public class ElasticSourceBuilder<T> implements Serializable {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3MjY2NQ=="}, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTc3MjYyOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/ElasticProcessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjozODo0N1rOGCBgBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzoxOTozNFrOGDMgag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3NDkxOQ==", "bodyText": "you can use Traverser.map() where this traverser is called.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404774919", "createdAt": "2020-04-07T12:38:47Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/ElasticProcessor.java", "diffHunk": "@@ -0,0 +1,232 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic.impl;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.jet.JetException;\n+import com.hazelcast.jet.Traverser;\n+import com.hazelcast.jet.Traversers;\n+import com.hazelcast.jet.core.AbstractProcessor;\n+import com.hazelcast.jet.elastic.ElasticSourceBuilder;\n+import com.hazelcast.logging.ILogger;\n+import org.apache.http.HttpHost;\n+import org.apache.lucene.search.TotalHits;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.ClearScrollRequest;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.action.search.SearchScrollRequest;\n+import org.elasticsearch.client.Node;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.SearchHits;\n+import org.elasticsearch.search.slice.SliceBuilder;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.util.List;\n+\n+import static java.util.Collections.singleton;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.stream.Collectors.joining;\n+import static java.util.stream.Collectors.toList;\n+\n+final class ElasticProcessor<T> extends AbstractProcessor {\n+\n+    private ElasticSourceBuilder<T> builder;\n+    private final List<Shard> shards;\n+    private Traverser<T> traverser;\n+\n+    ElasticProcessor(ElasticSourceBuilder<T> builder, List<Shard> shards) {\n+        this.builder = builder;\n+        this.shards = shards;\n+    }\n+\n+    @Override\n+    protected void init(@Nonnull Context context) throws Exception {\n+        super.init(context);\n+\n+        ILogger logger = context.logger();\n+        logger.fine(\"init\");\n+\n+        RestHighLevelClient client = builder.clientSupplier().get();\n+        SearchRequest sr = builder.searchRequestSupplier().get();\n+        sr.scroll(builder.scrollKeepAlive());\n+\n+        if (builder.slicing()) {\n+            if (builder.coLocatedReading()) {\n+                int sliceId = context.localProcessorIndex();\n+                int totalSlices = context.localParallelism();\n+                if (totalSlices > 1) {\n+                    logger.fine(\"Slice id=\" + sliceId + \", max=\" + totalSlices);\n+                    sr.source().slice(new SliceBuilder(sliceId, totalSlices));\n+                }\n+            } else {\n+                int sliceId = context.globalProcessorIndex();\n+                int totalSlices = context.totalParallelism();\n+                if (totalSlices > 1) {\n+                    logger.fine(\"Slice id=\" + sliceId + \", max=\" + totalSlices);\n+                    sr.source().slice(new SliceBuilder(sliceId, totalSlices));\n+                }\n+            }\n+        }\n+\n+        if (builder.coLocatedReading()) {\n+            logger.fine(\"Assigned shards: \" + shards);\n+            if (shards.isEmpty()) {\n+                traverser = Traversers.empty();\n+                return;\n+            }\n+\n+            Node node = createLocalElasticNode();\n+            client.getLowLevelClient().setNodes(singleton(node));\n+            String preference =\n+                    \"_shards:\" + shards.stream().map(shard -> String.valueOf(shard.getShard())).collect(joining(\",\"))\n+                            + \"|_only_local\";\n+            sr.preference(preference);\n+        }\n+\n+        traverser = new ElasticScrollTraverser<>(builder, client, sr, logger);\n+    }\n+\n+    private Node createLocalElasticNode() {\n+        List<String> ips = shards.stream().map(Shard::getHttpAddress).distinct().collect(toList());\n+        if (ips.size() != 1) {\n+            throw new JetException(\"Should receive shards from single local node, got: \" + ips);\n+        }\n+        String localIp = ips.get(0);\n+        return new Node(HttpHost.create(localIp));\n+    }\n+\n+    @Override\n+    public boolean isCooperative() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean complete() {\n+        return emitFromTraverser(traverser);\n+    }\n+\n+    @Override\n+    public void close() throws Exception {\n+        if (traverser instanceof ElasticProcessor.ElasticScrollTraverser) {\n+            ElasticScrollTraverser<T> scrollTraverser = (ElasticScrollTraverser<T>) traverser;\n+            scrollTraverser.close();\n+        }\n+    }\n+\n+    static class ElasticScrollTraverser<R> implements Traverser<R> {\n+\n+        private final ILogger logger;\n+\n+        private final RestHighLevelClient client;\n+        private final FunctionEx<? super ActionRequest, RequestOptions> optionsFn;\n+        private final FunctionEx<? super SearchHit, R> mapHitFn;\n+        private final String scrollKeepAlive;\n+        private final ConsumerEx<? super RestHighLevelClient> destroyFn;\n+\n+        private SearchHits hits;\n+        private int nextHit;\n+        private String scrollId;\n+\n+        ElasticScrollTraverser(ElasticSourceBuilder<R> builder, RestHighLevelClient client, SearchRequest sr,\n+                               ILogger logger) {\n+            this.client = client;\n+            this.optionsFn = builder.optionsFn();\n+            this.mapHitFn = builder.mapHitFn();\n+            this.destroyFn = builder.destroyFn();\n+            this.scrollKeepAlive = builder.scrollKeepAlive();\n+            this.logger = logger;\n+\n+            try {\n+                RequestOptions options = optionsFn.apply(sr);\n+                SearchResponse response = this.client.search(sr, options);\n+\n+                // These should be always present, even when there are no results\n+                hits = requireNonNull(response.getHits(), \"null hits in the response\");\n+                scrollId = requireNonNull(response.getScrollId(), \"null scrollId in the response\");\n+\n+                TotalHits totalHits = hits.getTotalHits();\n+                logger.fine(\"Initialized scroll with scrollId \" + scrollId + \", total results \" +\n+                        totalHits.relation + \", \" + totalHits.value);\n+            } catch (IOException e) {\n+                throw new JetException(\"Could not execute SearchRequest to Elastic\", e);\n+            }\n+        }\n+\n+        @Override\n+        public R next() {\n+            if (hits.getHits().length == 0) {\n+                scrollId = null;\n+                return null;\n+            }\n+\n+            if (nextHit >= hits.getHits().length) {\n+                try {\n+                    SearchScrollRequest ssr = new SearchScrollRequest(scrollId);\n+                    ssr.scroll(scrollKeepAlive);\n+\n+                    SearchResponse searchResponse = client.scroll(ssr, optionsFn.apply(ssr));\n+                    hits = searchResponse.getHits();\n+                    if (hits.getHits().length == 0) {\n+                        return null;\n+                    }\n+                    nextHit = 0;\n+                } catch (IOException e) {\n+                    throw new JetException(\"Could not execute SearchScrollRequest to Elastic\", e);\n+                }\n+            }\n+\n+            return mapHitFn.apply(hits.getAt(nextHit++));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 198}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAwMzgxOA==", "bodyText": "Done.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r406003818", "createdAt": "2020-04-09T07:19:34Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/ElasticProcessor.java", "diffHunk": "@@ -0,0 +1,232 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic.impl;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.jet.JetException;\n+import com.hazelcast.jet.Traverser;\n+import com.hazelcast.jet.Traversers;\n+import com.hazelcast.jet.core.AbstractProcessor;\n+import com.hazelcast.jet.elastic.ElasticSourceBuilder;\n+import com.hazelcast.logging.ILogger;\n+import org.apache.http.HttpHost;\n+import org.apache.lucene.search.TotalHits;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.ClearScrollRequest;\n+import org.elasticsearch.action.search.ClearScrollResponse;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.action.search.SearchScrollRequest;\n+import org.elasticsearch.client.Node;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.SearchHits;\n+import org.elasticsearch.search.slice.SliceBuilder;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.util.List;\n+\n+import static java.util.Collections.singleton;\n+import static java.util.Objects.requireNonNull;\n+import static java.util.stream.Collectors.joining;\n+import static java.util.stream.Collectors.toList;\n+\n+final class ElasticProcessor<T> extends AbstractProcessor {\n+\n+    private ElasticSourceBuilder<T> builder;\n+    private final List<Shard> shards;\n+    private Traverser<T> traverser;\n+\n+    ElasticProcessor(ElasticSourceBuilder<T> builder, List<Shard> shards) {\n+        this.builder = builder;\n+        this.shards = shards;\n+    }\n+\n+    @Override\n+    protected void init(@Nonnull Context context) throws Exception {\n+        super.init(context);\n+\n+        ILogger logger = context.logger();\n+        logger.fine(\"init\");\n+\n+        RestHighLevelClient client = builder.clientSupplier().get();\n+        SearchRequest sr = builder.searchRequestSupplier().get();\n+        sr.scroll(builder.scrollKeepAlive());\n+\n+        if (builder.slicing()) {\n+            if (builder.coLocatedReading()) {\n+                int sliceId = context.localProcessorIndex();\n+                int totalSlices = context.localParallelism();\n+                if (totalSlices > 1) {\n+                    logger.fine(\"Slice id=\" + sliceId + \", max=\" + totalSlices);\n+                    sr.source().slice(new SliceBuilder(sliceId, totalSlices));\n+                }\n+            } else {\n+                int sliceId = context.globalProcessorIndex();\n+                int totalSlices = context.totalParallelism();\n+                if (totalSlices > 1) {\n+                    logger.fine(\"Slice id=\" + sliceId + \", max=\" + totalSlices);\n+                    sr.source().slice(new SliceBuilder(sliceId, totalSlices));\n+                }\n+            }\n+        }\n+\n+        if (builder.coLocatedReading()) {\n+            logger.fine(\"Assigned shards: \" + shards);\n+            if (shards.isEmpty()) {\n+                traverser = Traversers.empty();\n+                return;\n+            }\n+\n+            Node node = createLocalElasticNode();\n+            client.getLowLevelClient().setNodes(singleton(node));\n+            String preference =\n+                    \"_shards:\" + shards.stream().map(shard -> String.valueOf(shard.getShard())).collect(joining(\",\"))\n+                            + \"|_only_local\";\n+            sr.preference(preference);\n+        }\n+\n+        traverser = new ElasticScrollTraverser<>(builder, client, sr, logger);\n+    }\n+\n+    private Node createLocalElasticNode() {\n+        List<String> ips = shards.stream().map(Shard::getHttpAddress).distinct().collect(toList());\n+        if (ips.size() != 1) {\n+            throw new JetException(\"Should receive shards from single local node, got: \" + ips);\n+        }\n+        String localIp = ips.get(0);\n+        return new Node(HttpHost.create(localIp));\n+    }\n+\n+    @Override\n+    public boolean isCooperative() {\n+        return false;\n+    }\n+\n+    @Override\n+    public boolean complete() {\n+        return emitFromTraverser(traverser);\n+    }\n+\n+    @Override\n+    public void close() throws Exception {\n+        if (traverser instanceof ElasticProcessor.ElasticScrollTraverser) {\n+            ElasticScrollTraverser<T> scrollTraverser = (ElasticScrollTraverser<T>) traverser;\n+            scrollTraverser.close();\n+        }\n+    }\n+\n+    static class ElasticScrollTraverser<R> implements Traverser<R> {\n+\n+        private final ILogger logger;\n+\n+        private final RestHighLevelClient client;\n+        private final FunctionEx<? super ActionRequest, RequestOptions> optionsFn;\n+        private final FunctionEx<? super SearchHit, R> mapHitFn;\n+        private final String scrollKeepAlive;\n+        private final ConsumerEx<? super RestHighLevelClient> destroyFn;\n+\n+        private SearchHits hits;\n+        private int nextHit;\n+        private String scrollId;\n+\n+        ElasticScrollTraverser(ElasticSourceBuilder<R> builder, RestHighLevelClient client, SearchRequest sr,\n+                               ILogger logger) {\n+            this.client = client;\n+            this.optionsFn = builder.optionsFn();\n+            this.mapHitFn = builder.mapHitFn();\n+            this.destroyFn = builder.destroyFn();\n+            this.scrollKeepAlive = builder.scrollKeepAlive();\n+            this.logger = logger;\n+\n+            try {\n+                RequestOptions options = optionsFn.apply(sr);\n+                SearchResponse response = this.client.search(sr, options);\n+\n+                // These should be always present, even when there are no results\n+                hits = requireNonNull(response.getHits(), \"null hits in the response\");\n+                scrollId = requireNonNull(response.getScrollId(), \"null scrollId in the response\");\n+\n+                TotalHits totalHits = hits.getTotalHits();\n+                logger.fine(\"Initialized scroll with scrollId \" + scrollId + \", total results \" +\n+                        totalHits.relation + \", \" + totalHits.value);\n+            } catch (IOException e) {\n+                throw new JetException(\"Could not execute SearchRequest to Elastic\", e);\n+            }\n+        }\n+\n+        @Override\n+        public R next() {\n+            if (hits.getHits().length == 0) {\n+                scrollId = null;\n+                return null;\n+            }\n+\n+            if (nextHit >= hits.getHits().length) {\n+                try {\n+                    SearchScrollRequest ssr = new SearchScrollRequest(scrollId);\n+                    ssr.scroll(scrollKeepAlive);\n+\n+                    SearchResponse searchResponse = client.scroll(ssr, optionsFn.apply(ssr));\n+                    hits = searchResponse.getHits();\n+                    if (hits.getHits().length == 0) {\n+                        return null;\n+                    }\n+                    nextHit = 0;\n+                } catch (IOException e) {\n+                    throw new JetException(\"Could not execute SearchScrollRequest to Elastic\", e);\n+                }\n+            }\n+\n+            return mapHitFn.apply(hits.getAt(nextHit++));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3NDkxOQ=="}, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 198}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTc3ODk0OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo0MDoyMlrOGCBkBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNzo0Nzo0NlrOGCi_tA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3NTk0Mw==", "bodyText": "this seems something very low level, we shouldn't expose it.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404775943", "createdAt": "2020-04-07T12:40:22Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "diffHunk": "@@ -0,0 +1,234 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import com.hazelcast.jet.pipeline.SinkBuilder;\n+import com.hazelcast.logging.ILogger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch Sink\n+ *\n+ * Requires {@link #clientSupplier(SupplierEx)} and {@link #mapItemFn(FunctionEx)}.\n+ *\n+ * @param <T>\n+ *\n+ * @since 4.1\n+ */\n+public class ElasticSinkBuilder<T> implements Serializable {\n+\n+    private String name = \"elastic\";\n+    private SupplierEx<? extends RestHighLevelClient> clientSupplier;\n+    private ConsumerEx<? super RestHighLevelClient> destroyFn = RestHighLevelClient::close;\n+    private SupplierEx<BulkRequest> bulkRequestSupplier = BulkRequest::new;\n+    private FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = (request) -> RequestOptions.DEFAULT;\n+    private int preferredLocalParallelism = 2;\n+\n+    /**\n+     * Set the user-friendly source name for this sink\n+     *\n+     * @param sinkName user-friendly sink name\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> name(@Nonnull String sinkName) {\n+        this.name = requireNonNull(sinkName, \"sinkName\");\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public String name() {\n+        return name;\n+    }\n+\n+    /**\n+     * Set the client supplier\n+     *\n+     * @param clientSupplier supplier for configure Elasticsearch REST client\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> clientSupplier(SupplierEx<? extends RestHighLevelClient> clientSupplier) {\n+        checkSerializable(clientSupplier, \"clientSupplier\");\n+        this.clientSupplier = clientSupplier;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public SupplierEx<? extends RestHighLevelClient> clientSupplier() {\n+        return clientSupplier;\n+    }\n+\n+    /**\n+     * Set the destroy function called on completion, defaults to {@link RestHighLevelClient#close()}\n+     *\n+     * @param destroyFn destroy function\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> destroyFn(ConsumerEx<? super RestHighLevelClient> destroyFn) {\n+        checkSerializable(destroyFn, \"destroyFn\");\n+        this.destroyFn = destroyFn;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public ConsumerEx<? super RestHighLevelClient> destroyFn() {\n+        return destroyFn;\n+    }\n+\n+    /**\n+     * Set the bulkRequestSupplier, defaults to new {@link BulkRequest#BulkRequest()}\n+     *\n+     * @param bulkRequestSupplier supplier for the bulk request\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> bulkRequestSupplier(SupplierEx<BulkRequest> bulkRequestSupplier) {\n+        checkSerializable(bulkRequestSupplier, \"clientSupplier\");\n+        this.bulkRequestSupplier = bulkRequestSupplier;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public SupplierEx<BulkRequest> bulkRequestSupplier() {\n+        return bulkRequestSupplier;\n+    }\n+\n+    /**\n+     * Set the mapItemFn\n+     *\n+     * @param mapItemFn maps an item from the stream to an {@link org.elasticsearch.action.index.IndexRequest},\n+     *                  {@link org.elasticsearch.action.update.UpdateRequest} or\n+     *                  {@link org.elasticsearch.action.delete.DeleteRequest}\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> mapItemFn(FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn) {\n+        checkSerializable(mapItemFn, \"mapItemFn\");\n+        this.mapItemFn = mapItemFn;\n+        return this;\n+    }\n+\n+    public FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn() {\n+        return mapItemFn;\n+    }\n+\n+    /**\n+     * Set the function that provides {@link RequestOptions} based on given request\n+     *\n+     * @param optionsFn function that provides {@link RequestOptions}\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> optionsFn(FunctionEx<? super ActionRequest, RequestOptions> optionsFn) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 150}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTMyMzcwMA==", "bodyText": "The org.elasticsearch.client.RequestOptions#DEFAULT may not always work. Users may need to provide custom headers etc..\nSee\nhttps://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-low-usage-requests.html#java-rest-low-usage-request-options", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r405323700", "createdAt": "2020-04-08T07:47:46Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "diffHunk": "@@ -0,0 +1,234 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import com.hazelcast.jet.pipeline.SinkBuilder;\n+import com.hazelcast.logging.ILogger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch Sink\n+ *\n+ * Requires {@link #clientSupplier(SupplierEx)} and {@link #mapItemFn(FunctionEx)}.\n+ *\n+ * @param <T>\n+ *\n+ * @since 4.1\n+ */\n+public class ElasticSinkBuilder<T> implements Serializable {\n+\n+    private String name = \"elastic\";\n+    private SupplierEx<? extends RestHighLevelClient> clientSupplier;\n+    private ConsumerEx<? super RestHighLevelClient> destroyFn = RestHighLevelClient::close;\n+    private SupplierEx<BulkRequest> bulkRequestSupplier = BulkRequest::new;\n+    private FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = (request) -> RequestOptions.DEFAULT;\n+    private int preferredLocalParallelism = 2;\n+\n+    /**\n+     * Set the user-friendly source name for this sink\n+     *\n+     * @param sinkName user-friendly sink name\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> name(@Nonnull String sinkName) {\n+        this.name = requireNonNull(sinkName, \"sinkName\");\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public String name() {\n+        return name;\n+    }\n+\n+    /**\n+     * Set the client supplier\n+     *\n+     * @param clientSupplier supplier for configure Elasticsearch REST client\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> clientSupplier(SupplierEx<? extends RestHighLevelClient> clientSupplier) {\n+        checkSerializable(clientSupplier, \"clientSupplier\");\n+        this.clientSupplier = clientSupplier;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public SupplierEx<? extends RestHighLevelClient> clientSupplier() {\n+        return clientSupplier;\n+    }\n+\n+    /**\n+     * Set the destroy function called on completion, defaults to {@link RestHighLevelClient#close()}\n+     *\n+     * @param destroyFn destroy function\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> destroyFn(ConsumerEx<? super RestHighLevelClient> destroyFn) {\n+        checkSerializable(destroyFn, \"destroyFn\");\n+        this.destroyFn = destroyFn;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public ConsumerEx<? super RestHighLevelClient> destroyFn() {\n+        return destroyFn;\n+    }\n+\n+    /**\n+     * Set the bulkRequestSupplier, defaults to new {@link BulkRequest#BulkRequest()}\n+     *\n+     * @param bulkRequestSupplier supplier for the bulk request\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> bulkRequestSupplier(SupplierEx<BulkRequest> bulkRequestSupplier) {\n+        checkSerializable(bulkRequestSupplier, \"clientSupplier\");\n+        this.bulkRequestSupplier = bulkRequestSupplier;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public SupplierEx<BulkRequest> bulkRequestSupplier() {\n+        return bulkRequestSupplier;\n+    }\n+\n+    /**\n+     * Set the mapItemFn\n+     *\n+     * @param mapItemFn maps an item from the stream to an {@link org.elasticsearch.action.index.IndexRequest},\n+     *                  {@link org.elasticsearch.action.update.UpdateRequest} or\n+     *                  {@link org.elasticsearch.action.delete.DeleteRequest}\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> mapItemFn(FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn) {\n+        checkSerializable(mapItemFn, \"mapItemFn\");\n+        this.mapItemFn = mapItemFn;\n+        return this;\n+    }\n+\n+    public FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn() {\n+        return mapItemFn;\n+    }\n+\n+    /**\n+     * Set the function that provides {@link RequestOptions} based on given request\n+     *\n+     * @param optionsFn function that provides {@link RequestOptions}\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> optionsFn(FunctionEx<? super ActionRequest, RequestOptions> optionsFn) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3NTk0Mw=="}, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 150}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTc4MTQ5OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo0MTowMVrOGCBlqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNzo0NTowNlrOGCi5zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3NjM2MA==", "bodyText": "no need for this either, another low level concern", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404776360", "createdAt": "2020-04-07T12:41:01Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "diffHunk": "@@ -0,0 +1,234 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import com.hazelcast.jet.pipeline.SinkBuilder;\n+import com.hazelcast.logging.ILogger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch Sink\n+ *\n+ * Requires {@link #clientSupplier(SupplierEx)} and {@link #mapItemFn(FunctionEx)}.\n+ *\n+ * @param <T>\n+ *\n+ * @since 4.1\n+ */\n+public class ElasticSinkBuilder<T> implements Serializable {\n+\n+    private String name = \"elastic\";\n+    private SupplierEx<? extends RestHighLevelClient> clientSupplier;\n+    private ConsumerEx<? super RestHighLevelClient> destroyFn = RestHighLevelClient::close;\n+    private SupplierEx<BulkRequest> bulkRequestSupplier = BulkRequest::new;\n+    private FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = (request) -> RequestOptions.DEFAULT;\n+    private int preferredLocalParallelism = 2;\n+\n+    /**\n+     * Set the user-friendly source name for this sink\n+     *\n+     * @param sinkName user-friendly sink name\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> name(@Nonnull String sinkName) {\n+        this.name = requireNonNull(sinkName, \"sinkName\");\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public String name() {\n+        return name;\n+    }\n+\n+    /**\n+     * Set the client supplier\n+     *\n+     * @param clientSupplier supplier for configure Elasticsearch REST client\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> clientSupplier(SupplierEx<? extends RestHighLevelClient> clientSupplier) {\n+        checkSerializable(clientSupplier, \"clientSupplier\");\n+        this.clientSupplier = clientSupplier;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public SupplierEx<? extends RestHighLevelClient> clientSupplier() {\n+        return clientSupplier;\n+    }\n+\n+    /**\n+     * Set the destroy function called on completion, defaults to {@link RestHighLevelClient#close()}\n+     *\n+     * @param destroyFn destroy function\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> destroyFn(ConsumerEx<? super RestHighLevelClient> destroyFn) {\n+        checkSerializable(destroyFn, \"destroyFn\");\n+        this.destroyFn = destroyFn;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public ConsumerEx<? super RestHighLevelClient> destroyFn() {\n+        return destroyFn;\n+    }\n+\n+    /**\n+     * Set the bulkRequestSupplier, defaults to new {@link BulkRequest#BulkRequest()}\n+     *\n+     * @param bulkRequestSupplier supplier for the bulk request\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> bulkRequestSupplier(SupplierEx<BulkRequest> bulkRequestSupplier) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTMyMjE5MA==", "bodyText": "There are quite few fields on the BulkRequest, we would need to expose those parameters somehow. We provide a default, so the user doesn't have to set it (but may if needs to).", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r405322190", "createdAt": "2020-04-08T07:45:06Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "diffHunk": "@@ -0,0 +1,234 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import com.hazelcast.jet.pipeline.SinkBuilder;\n+import com.hazelcast.logging.ILogger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch Sink\n+ *\n+ * Requires {@link #clientSupplier(SupplierEx)} and {@link #mapItemFn(FunctionEx)}.\n+ *\n+ * @param <T>\n+ *\n+ * @since 4.1\n+ */\n+public class ElasticSinkBuilder<T> implements Serializable {\n+\n+    private String name = \"elastic\";\n+    private SupplierEx<? extends RestHighLevelClient> clientSupplier;\n+    private ConsumerEx<? super RestHighLevelClient> destroyFn = RestHighLevelClient::close;\n+    private SupplierEx<BulkRequest> bulkRequestSupplier = BulkRequest::new;\n+    private FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = (request) -> RequestOptions.DEFAULT;\n+    private int preferredLocalParallelism = 2;\n+\n+    /**\n+     * Set the user-friendly source name for this sink\n+     *\n+     * @param sinkName user-friendly sink name\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> name(@Nonnull String sinkName) {\n+        this.name = requireNonNull(sinkName, \"sinkName\");\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public String name() {\n+        return name;\n+    }\n+\n+    /**\n+     * Set the client supplier\n+     *\n+     * @param clientSupplier supplier for configure Elasticsearch REST client\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> clientSupplier(SupplierEx<? extends RestHighLevelClient> clientSupplier) {\n+        checkSerializable(clientSupplier, \"clientSupplier\");\n+        this.clientSupplier = clientSupplier;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public SupplierEx<? extends RestHighLevelClient> clientSupplier() {\n+        return clientSupplier;\n+    }\n+\n+    /**\n+     * Set the destroy function called on completion, defaults to {@link RestHighLevelClient#close()}\n+     *\n+     * @param destroyFn destroy function\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> destroyFn(ConsumerEx<? super RestHighLevelClient> destroyFn) {\n+        checkSerializable(destroyFn, \"destroyFn\");\n+        this.destroyFn = destroyFn;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public ConsumerEx<? super RestHighLevelClient> destroyFn() {\n+        return destroyFn;\n+    }\n+\n+    /**\n+     * Set the bulkRequestSupplier, defaults to new {@link BulkRequest#BulkRequest()}\n+     *\n+     * @param bulkRequestSupplier supplier for the bulk request\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> bulkRequestSupplier(SupplierEx<BulkRequest> bulkRequestSupplier) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3NjM2MA=="}, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 115}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTc4MzkzOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo0MTo0MFrOGCBnGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzozNDoyMlrOGDM8ZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3NjcyOQ==", "bodyText": "no need for this, sink names can be configured on a per stage basis already", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404776729", "createdAt": "2020-04-07T12:41:40Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "diffHunk": "@@ -0,0 +1,234 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import com.hazelcast.jet.pipeline.SinkBuilder;\n+import com.hazelcast.logging.ILogger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch Sink\n+ *\n+ * Requires {@link #clientSupplier(SupplierEx)} and {@link #mapItemFn(FunctionEx)}.\n+ *\n+ * @param <T>\n+ *\n+ * @since 4.1\n+ */\n+public class ElasticSinkBuilder<T> implements Serializable {\n+\n+    private String name = \"elastic\";\n+    private SupplierEx<? extends RestHighLevelClient> clientSupplier;\n+    private ConsumerEx<? super RestHighLevelClient> destroyFn = RestHighLevelClient::close;\n+    private SupplierEx<BulkRequest> bulkRequestSupplier = BulkRequest::new;\n+    private FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = (request) -> RequestOptions.DEFAULT;\n+    private int preferredLocalParallelism = 2;\n+\n+    /**\n+     * Set the user-friendly source name for this sink\n+     *\n+     * @param sinkName user-friendly sink name\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> name(@Nonnull String sinkName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAxMDk4MA==", "bodyText": "Removed.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r406010980", "createdAt": "2020-04-09T07:34:22Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "diffHunk": "@@ -0,0 +1,234 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import com.hazelcast.jet.pipeline.SinkBuilder;\n+import com.hazelcast.logging.ILogger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch Sink\n+ *\n+ * Requires {@link #clientSupplier(SupplierEx)} and {@link #mapItemFn(FunctionEx)}.\n+ *\n+ * @param <T>\n+ *\n+ * @since 4.1\n+ */\n+public class ElasticSinkBuilder<T> implements Serializable {\n+\n+    private String name = \"elastic\";\n+    private SupplierEx<? extends RestHighLevelClient> clientSupplier;\n+    private ConsumerEx<? super RestHighLevelClient> destroyFn = RestHighLevelClient::close;\n+    private SupplierEx<BulkRequest> bulkRequestSupplier = BulkRequest::new;\n+    private FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = (request) -> RequestOptions.DEFAULT;\n+    private int preferredLocalParallelism = 2;\n+\n+    /**\n+     * Set the user-friendly source name for this sink\n+     *\n+     * @param sinkName user-friendly sink name\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> name(@Nonnull String sinkName) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3NjcyOQ=="}, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTc4NTcxOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinks.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo0MjowMlrOGCBoMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDoyODoxMFrOGDbPTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3NzAwOQ==", "bodyText": "missing annotations. Also this method doesn't provide source/sink, should be moved somewhere else.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404777009", "createdAt": "2020-04-07T12:42:02Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinks.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import org.apache.http.HttpHost;\n+import org.apache.http.auth.UsernamePasswordCredentials;\n+import org.apache.http.client.CredentialsProvider;\n+import org.apache.http.impl.client.BasicCredentialsProvider;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+\n+import static org.apache.http.auth.AuthScope.ANY;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sinks.\n+ * Alternatively you can use {@link ElasticSinkBuilder}\n+ *\n+ * @since 4.1\n+ */\n+public final class ElasticSinks {\n+\n+    private static final int PORT = 9200;\n+\n+    private ElasticSinks() {\n+    }\n+\n+    /**\n+     * Creates an Elasticsearch sink, uses a local instance of Elasticsearch\n+     *\n+     * @param mapItemFn function that maps items from a stream to an indexing request\n+     */\n+    public static <T> Sink<T> elastic(@Nonnull FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn) {\n+        return elastic(() -> client(\"localhost\", PORT), mapItemFn);\n+    }\n+\n+    /**\n+     * Creates an Elasticsearch sink, uses provided clientSupplier and mapItemFn\n+     *\n+     * @param clientSupplier client supplier\n+     * @param mapItemFn      function that maps items from a stream to an indexing request\n+     * @param <T>            type of incoming items\n+     */\n+    public static <T> Sink<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn\n+    ) {\n+        return new ElasticSinkBuilder<T>()\n+                .clientSupplier(clientSupplier)\n+                .mapItemFn(mapItemFn)\n+                .build();\n+    }\n+\n+    /**\n+     * Returns {@link ElasticSinkBuilder}\n+     *\n+     * @param <T> type of the items in the pipeline\n+     */\n+    public static <T> ElasticSinkBuilder<T> builder() {\n+        return new ElasticSinkBuilder<T>();\n+    }\n+\n+    static RestHighLevelClient client(String hostname, int port) {\n+        return new RestHighLevelClient(\n+                RestClient.builder(new HttpHost(hostname, port))\n+        );\n+    }\n+\n+    /**\n+     * Convenience method to create {@link RestHighLevelClient} with basic authentication and given hostname and port\n+     * <p>\n+     * Usage:\n+     * <pre>\n+     *   BatchSource<SearchHit> source = elasticsearch(() -> client(\"user\", \"password\", \"host\", 9200));\n+     * </pre>\n+     */\n+    public static RestHighLevelClient client(String username, String password, String hostname, int port) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0NTE5OQ==", "bodyText": "fixed", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r406245199", "createdAt": "2020-04-09T14:28:10Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinks.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import org.apache.http.HttpHost;\n+import org.apache.http.auth.UsernamePasswordCredentials;\n+import org.apache.http.client.CredentialsProvider;\n+import org.apache.http.impl.client.BasicCredentialsProvider;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+\n+import static org.apache.http.auth.AuthScope.ANY;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sinks.\n+ * Alternatively you can use {@link ElasticSinkBuilder}\n+ *\n+ * @since 4.1\n+ */\n+public final class ElasticSinks {\n+\n+    private static final int PORT = 9200;\n+\n+    private ElasticSinks() {\n+    }\n+\n+    /**\n+     * Creates an Elasticsearch sink, uses a local instance of Elasticsearch\n+     *\n+     * @param mapItemFn function that maps items from a stream to an indexing request\n+     */\n+    public static <T> Sink<T> elastic(@Nonnull FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn) {\n+        return elastic(() -> client(\"localhost\", PORT), mapItemFn);\n+    }\n+\n+    /**\n+     * Creates an Elasticsearch sink, uses provided clientSupplier and mapItemFn\n+     *\n+     * @param clientSupplier client supplier\n+     * @param mapItemFn      function that maps items from a stream to an indexing request\n+     * @param <T>            type of incoming items\n+     */\n+    public static <T> Sink<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn\n+    ) {\n+        return new ElasticSinkBuilder<T>()\n+                .clientSupplier(clientSupplier)\n+                .mapItemFn(mapItemFn)\n+                .build();\n+    }\n+\n+    /**\n+     * Returns {@link ElasticSinkBuilder}\n+     *\n+     * @param <T> type of the items in the pipeline\n+     */\n+    public static <T> ElasticSinkBuilder<T> builder() {\n+        return new ElasticSinkBuilder<T>();\n+    }\n+\n+    static RestHighLevelClient client(String hostname, int port) {\n+        return new RestHighLevelClient(\n+                RestClient.builder(new HttpHost(hostname, port))\n+        );\n+    }\n+\n+    /**\n+     * Convenience method to create {@link RestHighLevelClient} with basic authentication and given hostname and port\n+     * <p>\n+     * Usage:\n+     * <pre>\n+     *   BatchSource<SearchHit> source = elasticsearch(() -> client(\"user\", \"password\", \"host\", 9200));\n+     * </pre>\n+     */\n+    public static RestHighLevelClient client(String username, String password, String hostname, int port) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3NzAwOQ=="}, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 96}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTc4ODg3OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo0Mjo0N1rOGCBqKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo0Mjo0N1rOGCBqKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3NzUxMg==", "bodyText": "see with sink - not necessary.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404777512", "createdAt": "2020-04-07T12:42:47Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "diffHunk": "@@ -0,0 +1,249 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.core.Vertex;\n+import com.hazelcast.jet.elastic.impl.ElasticProcessorMetaSupplier;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Sources;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch source which reads data from Elasticsearch and\n+ * converts SearchHits using provided {@code mapHitFn}\n+ *\n+ * @param <T> type of the mapping function from {@link SearchHit} -> T\n+ *           TODO not sure about the type parameter name - T as the usual default, or R for Result\n+ *           also we could accept the function in the build() method, same as the original source did it\n+ * @since 4.1\n+ */\n+public class ElasticSourceBuilder<T> implements Serializable {\n+\n+    private static final long serialVersionUID = 1L;\n+\n+    private String name = \"elastic\";\n+    private SupplierEx<? extends RestHighLevelClient> clientSupplier;\n+    private ConsumerEx<? super RestHighLevelClient> destroyFn = RestHighLevelClient::close;\n+    private SupplierEx<SearchRequest> searchRequestSupplier;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = request -> RequestOptions.DEFAULT;\n+    private FunctionEx<? super SearchHit, T> mapHitFn;\n+    private boolean slicing;\n+    private boolean coLocatedReading;\n+    private String scrollKeepAlive = \"1m\"; // Using String because it needs to be Serializable\n+    private int preferredLocalParallelism = Vertex.LOCAL_PARALLELISM_USE_DEFAULT;\n+\n+    /**\n+     * Build Elasticsearch {@link BatchSource} with supplied parameters\n+     *\n+     * @return configured source which is to be used in the pipeline\n+     */\n+    @Nonnull\n+    public BatchSource<T> build() {\n+        requireNonNull(clientSupplier, \"clientSupplier must be set\");\n+        requireNonNull(searchRequestSupplier, \"searchRequestSupplier must be set\");\n+        requireNonNull(mapHitFn, \"mapHitFn must be set\");\n+\n+        ElasticProcessorMetaSupplier<T> metaSupplier = new ElasticProcessorMetaSupplier<>(this);\n+        return Sources.batchFromProcessor(name, metaSupplier);\n+    }\n+\n+    /**\n+     * Set the user-friendly source name for this source\n+     *\n+     * @param sourceName user-friendly source name\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> name(String sourceName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTc4OTcxOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo0MzowMlrOGCBqsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo0MzowMlrOGCBqsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3NzY0OQ==", "bodyText": "see similar comment for Sink", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404777649", "createdAt": "2020-04-07T12:43:02Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "diffHunk": "@@ -0,0 +1,249 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.core.Vertex;\n+import com.hazelcast.jet.elastic.impl.ElasticProcessorMetaSupplier;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Sources;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch source which reads data from Elasticsearch and\n+ * converts SearchHits using provided {@code mapHitFn}\n+ *\n+ * @param <T> type of the mapping function from {@link SearchHit} -> T\n+ *           TODO not sure about the type parameter name - T as the usual default, or R for Result\n+ *           also we could accept the function in the build() method, same as the original source did it\n+ * @since 4.1\n+ */\n+public class ElasticSourceBuilder<T> implements Serializable {\n+\n+    private static final long serialVersionUID = 1L;\n+\n+    private String name = \"elastic\";\n+    private SupplierEx<? extends RestHighLevelClient> clientSupplier;\n+    private ConsumerEx<? super RestHighLevelClient> destroyFn = RestHighLevelClient::close;\n+    private SupplierEx<SearchRequest> searchRequestSupplier;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = request -> RequestOptions.DEFAULT;\n+    private FunctionEx<? super SearchHit, T> mapHitFn;\n+    private boolean slicing;\n+    private boolean coLocatedReading;\n+    private String scrollKeepAlive = \"1m\"; // Using String because it needs to be Serializable\n+    private int preferredLocalParallelism = Vertex.LOCAL_PARALLELISM_USE_DEFAULT;\n+\n+    /**\n+     * Build Elasticsearch {@link BatchSource} with supplied parameters\n+     *\n+     * @return configured source which is to be used in the pipeline\n+     */\n+    @Nonnull\n+    public BatchSource<T> build() {\n+        requireNonNull(clientSupplier, \"clientSupplier must be set\");\n+        requireNonNull(searchRequestSupplier, \"searchRequestSupplier must be set\");\n+        requireNonNull(mapHitFn, \"mapHitFn must be set\");\n+\n+        ElasticProcessorMetaSupplier<T> metaSupplier = new ElasticProcessorMetaSupplier<>(this);\n+        return Sources.batchFromProcessor(name, metaSupplier);\n+    }\n+\n+    /**\n+     * Set the user-friendly source name for this source\n+     *\n+     * @param sourceName user-friendly source name\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> name(String sourceName) {\n+        this.name = sourceName;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public String name() {\n+        return name;\n+    }\n+\n+    /**\n+     * Set the client supplier\n+     *\n+     * @param clientSupplier supplier for configure Elasticsearch REST client\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> clientSupplier(SupplierEx<? extends RestHighLevelClient> clientSupplier) {\n+        checkSerializable(clientSupplier, \"clientSupplier\");\n+        this.clientSupplier = clientSupplier;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public SupplierEx<? extends RestHighLevelClient> clientSupplier() {\n+        return clientSupplier;\n+    }\n+\n+    /**\n+     * Set the destroy function called on completion, defaults to {@link RestHighLevelClient#close()}\n+     *\n+     * @param destroyFn destroy function\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> destroyFn(ConsumerEx<? super RestHighLevelClient> destroyFn) {\n+        checkSerializable(destroyFn, \"destroyFn\");\n+        this.destroyFn = destroyFn;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public ConsumerEx<? super RestHighLevelClient> destroyFn() {\n+        return destroyFn;\n+    }\n+\n+    /**\n+     * Set the search request supplier\n+     *\n+     * @param searchRequestSupplier search request supplier\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> searchRequestSupplier(SupplierEx<SearchRequest> searchRequestSupplier) {\n+        checkSerializable(searchRequestSupplier, \"searchRequestSupplier\");\n+        this.searchRequestSupplier = searchRequestSupplier;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public SupplierEx<SearchRequest> searchRequestSupplier() {\n+        return searchRequestSupplier;\n+    }\n+\n+    /**\n+     * Set the function to map SearchHit to custom result\n+     *\n+     * @param mapHitFn maps search hits to output items\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> mapHitFn(FunctionEx<? super SearchHit, T> mapHitFn) {\n+        checkSerializable(mapHitFn, \"mapHitFn\");\n+        this.mapHitFn = mapHitFn;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public FunctionEx<? super SearchHit, T> mapHitFn() {\n+        return mapHitFn;\n+    }\n+\n+    /**\n+     * Set the function that provides {@link RequestOptions} based on given request\n+     *\n+     * @param optionsFn function that provides {@link RequestOptions}\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> optionsFn(FunctionEx<? super ActionRequest, RequestOptions> optionsFn) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 167}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTc5MDU3OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo0MzoxNVrOGCBrMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo0MzoxNVrOGCBrMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3Nzc3OA==", "bodyText": "should be called enableSlicing without a boolean", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404777778", "createdAt": "2020-04-07T12:43:15Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "diffHunk": "@@ -0,0 +1,249 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.core.Vertex;\n+import com.hazelcast.jet.elastic.impl.ElasticProcessorMetaSupplier;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Sources;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch source which reads data from Elasticsearch and\n+ * converts SearchHits using provided {@code mapHitFn}\n+ *\n+ * @param <T> type of the mapping function from {@link SearchHit} -> T\n+ *           TODO not sure about the type parameter name - T as the usual default, or R for Result\n+ *           also we could accept the function in the build() method, same as the original source did it\n+ * @since 4.1\n+ */\n+public class ElasticSourceBuilder<T> implements Serializable {\n+\n+    private static final long serialVersionUID = 1L;\n+\n+    private String name = \"elastic\";\n+    private SupplierEx<? extends RestHighLevelClient> clientSupplier;\n+    private ConsumerEx<? super RestHighLevelClient> destroyFn = RestHighLevelClient::close;\n+    private SupplierEx<SearchRequest> searchRequestSupplier;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = request -> RequestOptions.DEFAULT;\n+    private FunctionEx<? super SearchHit, T> mapHitFn;\n+    private boolean slicing;\n+    private boolean coLocatedReading;\n+    private String scrollKeepAlive = \"1m\"; // Using String because it needs to be Serializable\n+    private int preferredLocalParallelism = Vertex.LOCAL_PARALLELISM_USE_DEFAULT;\n+\n+    /**\n+     * Build Elasticsearch {@link BatchSource} with supplied parameters\n+     *\n+     * @return configured source which is to be used in the pipeline\n+     */\n+    @Nonnull\n+    public BatchSource<T> build() {\n+        requireNonNull(clientSupplier, \"clientSupplier must be set\");\n+        requireNonNull(searchRequestSupplier, \"searchRequestSupplier must be set\");\n+        requireNonNull(mapHitFn, \"mapHitFn must be set\");\n+\n+        ElasticProcessorMetaSupplier<T> metaSupplier = new ElasticProcessorMetaSupplier<>(this);\n+        return Sources.batchFromProcessor(name, metaSupplier);\n+    }\n+\n+    /**\n+     * Set the user-friendly source name for this source\n+     *\n+     * @param sourceName user-friendly source name\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> name(String sourceName) {\n+        this.name = sourceName;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public String name() {\n+        return name;\n+    }\n+\n+    /**\n+     * Set the client supplier\n+     *\n+     * @param clientSupplier supplier for configure Elasticsearch REST client\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> clientSupplier(SupplierEx<? extends RestHighLevelClient> clientSupplier) {\n+        checkSerializable(clientSupplier, \"clientSupplier\");\n+        this.clientSupplier = clientSupplier;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public SupplierEx<? extends RestHighLevelClient> clientSupplier() {\n+        return clientSupplier;\n+    }\n+\n+    /**\n+     * Set the destroy function called on completion, defaults to {@link RestHighLevelClient#close()}\n+     *\n+     * @param destroyFn destroy function\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> destroyFn(ConsumerEx<? super RestHighLevelClient> destroyFn) {\n+        checkSerializable(destroyFn, \"destroyFn\");\n+        this.destroyFn = destroyFn;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public ConsumerEx<? super RestHighLevelClient> destroyFn() {\n+        return destroyFn;\n+    }\n+\n+    /**\n+     * Set the search request supplier\n+     *\n+     * @param searchRequestSupplier search request supplier\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> searchRequestSupplier(SupplierEx<SearchRequest> searchRequestSupplier) {\n+        checkSerializable(searchRequestSupplier, \"searchRequestSupplier\");\n+        this.searchRequestSupplier = searchRequestSupplier;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public SupplierEx<SearchRequest> searchRequestSupplier() {\n+        return searchRequestSupplier;\n+    }\n+\n+    /**\n+     * Set the function to map SearchHit to custom result\n+     *\n+     * @param mapHitFn maps search hits to output items\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> mapHitFn(FunctionEx<? super SearchHit, T> mapHitFn) {\n+        checkSerializable(mapHitFn, \"mapHitFn\");\n+        this.mapHitFn = mapHitFn;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public FunctionEx<? super SearchHit, T> mapHitFn() {\n+        return mapHitFn;\n+    }\n+\n+    /**\n+     * Set the function that provides {@link RequestOptions} based on given request\n+     *\n+     * @param optionsFn function that provides {@link RequestOptions}\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> optionsFn(FunctionEx<? super ActionRequest, RequestOptions> optionsFn) {\n+        checkSerializable(optionsFn, \"optionsFn\");\n+        this.optionsFn = optionsFn;\n+        return this;\n+    }\n+\n+    public FunctionEx<? super ActionRequest, RequestOptions> optionsFn() {\n+        return optionsFn;\n+    }\n+\n+    /**\n+     * Set to true to enable slicing\n+     * <p>\n+     * Number of slices is equal to globalParallelism (localParallelism * numberOfNodes)\n+     * <p>\n+     * Use this option to read from multiple shards in parallel.\n+     *\n+     * @param enabled {@code true} to enable slicing, default value {@code false}\n+     * @see\n+     * <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-body.html#sliced-scroll\">\n+     *     Sliced Scroll</a>\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> slicing(boolean enabled) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 190}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTc5MjQ3OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo0Mzo0MFrOGCBsRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo0Mzo0MFrOGCBsRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3ODA1Mw==", "bodyText": "should be enableCoLocatedReading()", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404778053", "createdAt": "2020-04-07T12:43:40Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "diffHunk": "@@ -0,0 +1,249 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.core.Vertex;\n+import com.hazelcast.jet.elastic.impl.ElasticProcessorMetaSupplier;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Sources;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch source which reads data from Elasticsearch and\n+ * converts SearchHits using provided {@code mapHitFn}\n+ *\n+ * @param <T> type of the mapping function from {@link SearchHit} -> T\n+ *           TODO not sure about the type parameter name - T as the usual default, or R for Result\n+ *           also we could accept the function in the build() method, same as the original source did it\n+ * @since 4.1\n+ */\n+public class ElasticSourceBuilder<T> implements Serializable {\n+\n+    private static final long serialVersionUID = 1L;\n+\n+    private String name = \"elastic\";\n+    private SupplierEx<? extends RestHighLevelClient> clientSupplier;\n+    private ConsumerEx<? super RestHighLevelClient> destroyFn = RestHighLevelClient::close;\n+    private SupplierEx<SearchRequest> searchRequestSupplier;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = request -> RequestOptions.DEFAULT;\n+    private FunctionEx<? super SearchHit, T> mapHitFn;\n+    private boolean slicing;\n+    private boolean coLocatedReading;\n+    private String scrollKeepAlive = \"1m\"; // Using String because it needs to be Serializable\n+    private int preferredLocalParallelism = Vertex.LOCAL_PARALLELISM_USE_DEFAULT;\n+\n+    /**\n+     * Build Elasticsearch {@link BatchSource} with supplied parameters\n+     *\n+     * @return configured source which is to be used in the pipeline\n+     */\n+    @Nonnull\n+    public BatchSource<T> build() {\n+        requireNonNull(clientSupplier, \"clientSupplier must be set\");\n+        requireNonNull(searchRequestSupplier, \"searchRequestSupplier must be set\");\n+        requireNonNull(mapHitFn, \"mapHitFn must be set\");\n+\n+        ElasticProcessorMetaSupplier<T> metaSupplier = new ElasticProcessorMetaSupplier<>(this);\n+        return Sources.batchFromProcessor(name, metaSupplier);\n+    }\n+\n+    /**\n+     * Set the user-friendly source name for this source\n+     *\n+     * @param sourceName user-friendly source name\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> name(String sourceName) {\n+        this.name = sourceName;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public String name() {\n+        return name;\n+    }\n+\n+    /**\n+     * Set the client supplier\n+     *\n+     * @param clientSupplier supplier for configure Elasticsearch REST client\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> clientSupplier(SupplierEx<? extends RestHighLevelClient> clientSupplier) {\n+        checkSerializable(clientSupplier, \"clientSupplier\");\n+        this.clientSupplier = clientSupplier;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public SupplierEx<? extends RestHighLevelClient> clientSupplier() {\n+        return clientSupplier;\n+    }\n+\n+    /**\n+     * Set the destroy function called on completion, defaults to {@link RestHighLevelClient#close()}\n+     *\n+     * @param destroyFn destroy function\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> destroyFn(ConsumerEx<? super RestHighLevelClient> destroyFn) {\n+        checkSerializable(destroyFn, \"destroyFn\");\n+        this.destroyFn = destroyFn;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public ConsumerEx<? super RestHighLevelClient> destroyFn() {\n+        return destroyFn;\n+    }\n+\n+    /**\n+     * Set the search request supplier\n+     *\n+     * @param searchRequestSupplier search request supplier\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> searchRequestSupplier(SupplierEx<SearchRequest> searchRequestSupplier) {\n+        checkSerializable(searchRequestSupplier, \"searchRequestSupplier\");\n+        this.searchRequestSupplier = searchRequestSupplier;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public SupplierEx<SearchRequest> searchRequestSupplier() {\n+        return searchRequestSupplier;\n+    }\n+\n+    /**\n+     * Set the function to map SearchHit to custom result\n+     *\n+     * @param mapHitFn maps search hits to output items\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> mapHitFn(FunctionEx<? super SearchHit, T> mapHitFn) {\n+        checkSerializable(mapHitFn, \"mapHitFn\");\n+        this.mapHitFn = mapHitFn;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public FunctionEx<? super SearchHit, T> mapHitFn() {\n+        return mapHitFn;\n+    }\n+\n+    /**\n+     * Set the function that provides {@link RequestOptions} based on given request\n+     *\n+     * @param optionsFn function that provides {@link RequestOptions}\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> optionsFn(FunctionEx<? super ActionRequest, RequestOptions> optionsFn) {\n+        checkSerializable(optionsFn, \"optionsFn\");\n+        this.optionsFn = optionsFn;\n+        return this;\n+    }\n+\n+    public FunctionEx<? super ActionRequest, RequestOptions> optionsFn() {\n+        return optionsFn;\n+    }\n+\n+    /**\n+     * Set to true to enable slicing\n+     * <p>\n+     * Number of slices is equal to globalParallelism (localParallelism * numberOfNodes)\n+     * <p>\n+     * Use this option to read from multiple shards in parallel.\n+     *\n+     * @param enabled {@code true} to enable slicing, default value {@code false}\n+     * @see\n+     * <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-body.html#sliced-scroll\">\n+     *     Sliced Scroll</a>\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> slicing(boolean enabled) {\n+        this.slicing = enabled;\n+        return this;\n+    }\n+\n+    public boolean slicing() {\n+        return slicing;\n+    }\n+\n+    /**\n+     * Turns on co-located reading\n+     *\n+     * Jet cluster member must run exactly on the same nodes as Elastic cluster.\n+     *\n+     * @param coLocatedRead {@code true} to enable co-located reading, default value {@code false}\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> coLocatedReading(boolean coLocatedRead) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 207}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTc5NTM4OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo0NDoyMFrOGCBuBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo0NDoyMFrOGCBuBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3ODUwMA==", "bodyText": "should be an example here how to use the builder", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404778500", "createdAt": "2020-04-07T12:44:20Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "diffHunk": "@@ -0,0 +1,249 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.core.Vertex;\n+import com.hazelcast.jet.elastic.impl.ElasticProcessorMetaSupplier;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Sources;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch source which reads data from Elasticsearch and\n+ * converts SearchHits using provided {@code mapHitFn}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTgxMDA3OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/ElasticProcessorSupplier.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo0ODoxMFrOGCB3UQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNzoxMzo1NFrOGCh6Fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc4MDg4MQ==", "bodyText": "technically this is the same. Util.distributeObjects will assign one per processor", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404780881", "createdAt": "2020-04-07T12:48:10Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/ElasticProcessorSupplier.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic.impl;\n+\n+import com.hazelcast.jet.core.Processor;\n+import com.hazelcast.jet.core.ProcessorSupplier;\n+import com.hazelcast.jet.elastic.ElasticSourceBuilder;\n+import com.hazelcast.jet.impl.util.Util;\n+\n+import javax.annotation.Nonnull;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Objects.requireNonNull;\n+\n+class ElasticProcessorSupplier<R> implements ProcessorSupplier {\n+\n+    private final ElasticSourceBuilder<R> builder;\n+\n+    private final List<Shard> shards;\n+    private Map<Integer, List<Shard>> shardsByProcessor;\n+\n+    ElasticProcessorSupplier(@Nonnull ElasticSourceBuilder<R> builder,\n+                             @Nonnull List<Shard> shards) {\n+        this.builder = requireNonNull(builder);\n+        this.shards = requireNonNull(shards);\n+    }\n+\n+\n+    @Override\n+    public void init(@Nonnull Context context) {\n+        if (builder.coLocatedReading()) {\n+            if (builder.slicing()) {\n+                shardsByProcessor = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTMwMDg4Nw==", "bodyText": "It is different - shardsByProcessor.put(i, shards); all processors get all shards in the first branch.\nWhen colocated reading & slicing is enabled at the same time each processor queries all shards, but different slice of it.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r405300887", "createdAt": "2020-04-08T07:03:31Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/ElasticProcessorSupplier.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic.impl;\n+\n+import com.hazelcast.jet.core.Processor;\n+import com.hazelcast.jet.core.ProcessorSupplier;\n+import com.hazelcast.jet.elastic.ElasticSourceBuilder;\n+import com.hazelcast.jet.impl.util.Util;\n+\n+import javax.annotation.Nonnull;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Objects.requireNonNull;\n+\n+class ElasticProcessorSupplier<R> implements ProcessorSupplier {\n+\n+    private final ElasticSourceBuilder<R> builder;\n+\n+    private final List<Shard> shards;\n+    private Map<Integer, List<Shard>> shardsByProcessor;\n+\n+    ElasticProcessorSupplier(@Nonnull ElasticSourceBuilder<R> builder,\n+                             @Nonnull List<Shard> shards) {\n+        this.builder = requireNonNull(builder);\n+        this.shards = requireNonNull(shards);\n+    }\n+\n+\n+    @Override\n+    public void init(@Nonnull Context context) {\n+        if (builder.coLocatedReading()) {\n+            if (builder.slicing()) {\n+                shardsByProcessor = new HashMap<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc4MDg4MQ=="}, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTMwNTg3OA==", "bodyText": "ok, right, I misunderstood I think.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r405305878", "createdAt": "2020-04-08T07:13:54Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/ElasticProcessorSupplier.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic.impl;\n+\n+import com.hazelcast.jet.core.Processor;\n+import com.hazelcast.jet.core.ProcessorSupplier;\n+import com.hazelcast.jet.elastic.ElasticSourceBuilder;\n+import com.hazelcast.jet.impl.util.Util;\n+\n+import javax.annotation.Nonnull;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Objects.requireNonNull;\n+\n+class ElasticProcessorSupplier<R> implements ProcessorSupplier {\n+\n+    private final ElasticSourceBuilder<R> builder;\n+\n+    private final List<Shard> shards;\n+    private Map<Integer, List<Shard>> shardsByProcessor;\n+\n+    ElasticProcessorSupplier(@Nonnull ElasticSourceBuilder<R> builder,\n+                             @Nonnull List<Shard> shards) {\n+        this.builder = requireNonNull(builder);\n+        this.shards = requireNonNull(shards);\n+    }\n+\n+\n+    @Override\n+    public void init(@Nonnull Context context) {\n+        if (builder.coLocatedReading()) {\n+            if (builder.slicing()) {\n+                shardsByProcessor = new HashMap<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc4MDg4MQ=="}, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTgxNjcxOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/ElasticProcessorSupplier.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo0OTo0MVrOGCB7Zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo0OTo0MVrOGCB7Zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc4MTkyNg==", "bodyText": "you can simplify the logic above:\nIntStream.range(0, count).mapToObj(i -> builder.coLocatedReading() ? .. ).collect()", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404781926", "createdAt": "2020-04-07T12:49:41Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/ElasticProcessorSupplier.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic.impl;\n+\n+import com.hazelcast.jet.core.Processor;\n+import com.hazelcast.jet.core.ProcessorSupplier;\n+import com.hazelcast.jet.elastic.ElasticSourceBuilder;\n+import com.hazelcast.jet.impl.util.Util;\n+\n+import javax.annotation.Nonnull;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Objects.requireNonNull;\n+\n+class ElasticProcessorSupplier<R> implements ProcessorSupplier {\n+\n+    private final ElasticSourceBuilder<R> builder;\n+\n+    private final List<Shard> shards;\n+    private Map<Integer, List<Shard>> shardsByProcessor;\n+\n+    ElasticProcessorSupplier(@Nonnull ElasticSourceBuilder<R> builder,\n+                             @Nonnull List<Shard> shards) {\n+        this.builder = requireNonNull(builder);\n+        this.shards = requireNonNull(shards);\n+    }\n+\n+\n+    @Override\n+    public void init(@Nonnull Context context) {\n+        if (builder.coLocatedReading()) {\n+            if (builder.slicing()) {\n+                shardsByProcessor = new HashMap<>();\n+                for (int i = 0; i < context.localParallelism(); i++) {\n+                    shardsByProcessor.put(i, shards);\n+                }\n+            } else {\n+                shardsByProcessor = Util.distributeObjects(context.localParallelism(), shards);\n+            }\n+        }\n+    }\n+\n+    @Nonnull\n+    @Override\n+    public Collection<? extends Processor> get(int count) {\n+        List<Processor> processors = new ArrayList<>();\n+        for (int i = 0; i < count; i++) {\n+            if (builder.coLocatedReading()) {\n+                processors.add(new ElasticProcessor<>(builder, shardsByProcessor.get(i)));\n+            } else {\n+                processors.add(new ElasticProcessor<>(builder, emptyList()));\n+            }\n+        }\n+        return processors;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTgxODI4OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo1MDowM1rOGCB8UA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo1MDowM1rOGCB8UA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc4MjE2MA==", "bodyText": "should be isCoLocatedReadingEnabled()", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404782160", "createdAt": "2020-04-07T12:50:03Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "diffHunk": "@@ -0,0 +1,249 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.core.Vertex;\n+import com.hazelcast.jet.elastic.impl.ElasticProcessorMetaSupplier;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Sources;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch source which reads data from Elasticsearch and\n+ * converts SearchHits using provided {@code mapHitFn}\n+ *\n+ * @param <T> type of the mapping function from {@link SearchHit} -> T\n+ *           TODO not sure about the type parameter name - T as the usual default, or R for Result\n+ *           also we could accept the function in the build() method, same as the original source did it\n+ * @since 4.1\n+ */\n+public class ElasticSourceBuilder<T> implements Serializable {\n+\n+    private static final long serialVersionUID = 1L;\n+\n+    private String name = \"elastic\";\n+    private SupplierEx<? extends RestHighLevelClient> clientSupplier;\n+    private ConsumerEx<? super RestHighLevelClient> destroyFn = RestHighLevelClient::close;\n+    private SupplierEx<SearchRequest> searchRequestSupplier;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = request -> RequestOptions.DEFAULT;\n+    private FunctionEx<? super SearchHit, T> mapHitFn;\n+    private boolean slicing;\n+    private boolean coLocatedReading;\n+    private String scrollKeepAlive = \"1m\"; // Using String because it needs to be Serializable\n+    private int preferredLocalParallelism = Vertex.LOCAL_PARALLELISM_USE_DEFAULT;\n+\n+    /**\n+     * Build Elasticsearch {@link BatchSource} with supplied parameters\n+     *\n+     * @return configured source which is to be used in the pipeline\n+     */\n+    @Nonnull\n+    public BatchSource<T> build() {\n+        requireNonNull(clientSupplier, \"clientSupplier must be set\");\n+        requireNonNull(searchRequestSupplier, \"searchRequestSupplier must be set\");\n+        requireNonNull(mapHitFn, \"mapHitFn must be set\");\n+\n+        ElasticProcessorMetaSupplier<T> metaSupplier = new ElasticProcessorMetaSupplier<>(this);\n+        return Sources.batchFromProcessor(name, metaSupplier);\n+    }\n+\n+    /**\n+     * Set the user-friendly source name for this source\n+     *\n+     * @param sourceName user-friendly source name\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> name(String sourceName) {\n+        this.name = sourceName;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public String name() {\n+        return name;\n+    }\n+\n+    /**\n+     * Set the client supplier\n+     *\n+     * @param clientSupplier supplier for configure Elasticsearch REST client\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> clientSupplier(SupplierEx<? extends RestHighLevelClient> clientSupplier) {\n+        checkSerializable(clientSupplier, \"clientSupplier\");\n+        this.clientSupplier = clientSupplier;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public SupplierEx<? extends RestHighLevelClient> clientSupplier() {\n+        return clientSupplier;\n+    }\n+\n+    /**\n+     * Set the destroy function called on completion, defaults to {@link RestHighLevelClient#close()}\n+     *\n+     * @param destroyFn destroy function\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> destroyFn(ConsumerEx<? super RestHighLevelClient> destroyFn) {\n+        checkSerializable(destroyFn, \"destroyFn\");\n+        this.destroyFn = destroyFn;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public ConsumerEx<? super RestHighLevelClient> destroyFn() {\n+        return destroyFn;\n+    }\n+\n+    /**\n+     * Set the search request supplier\n+     *\n+     * @param searchRequestSupplier search request supplier\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> searchRequestSupplier(SupplierEx<SearchRequest> searchRequestSupplier) {\n+        checkSerializable(searchRequestSupplier, \"searchRequestSupplier\");\n+        this.searchRequestSupplier = searchRequestSupplier;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public SupplierEx<SearchRequest> searchRequestSupplier() {\n+        return searchRequestSupplier;\n+    }\n+\n+    /**\n+     * Set the function to map SearchHit to custom result\n+     *\n+     * @param mapHitFn maps search hits to output items\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> mapHitFn(FunctionEx<? super SearchHit, T> mapHitFn) {\n+        checkSerializable(mapHitFn, \"mapHitFn\");\n+        this.mapHitFn = mapHitFn;\n+        return this;\n+    }\n+\n+    @Nonnull\n+    public FunctionEx<? super SearchHit, T> mapHitFn() {\n+        return mapHitFn;\n+    }\n+\n+    /**\n+     * Set the function that provides {@link RequestOptions} based on given request\n+     *\n+     * @param optionsFn function that provides {@link RequestOptions}\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> optionsFn(FunctionEx<? super ActionRequest, RequestOptions> optionsFn) {\n+        checkSerializable(optionsFn, \"optionsFn\");\n+        this.optionsFn = optionsFn;\n+        return this;\n+    }\n+\n+    public FunctionEx<? super ActionRequest, RequestOptions> optionsFn() {\n+        return optionsFn;\n+    }\n+\n+    /**\n+     * Set to true to enable slicing\n+     * <p>\n+     * Number of slices is equal to globalParallelism (localParallelism * numberOfNodes)\n+     * <p>\n+     * Use this option to read from multiple shards in parallel.\n+     *\n+     * @param enabled {@code true} to enable slicing, default value {@code false}\n+     * @see\n+     * <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-body.html#sliced-scroll\">\n+     *     Sliced Scroll</a>\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> slicing(boolean enabled) {\n+        this.slicing = enabled;\n+        return this;\n+    }\n+\n+    public boolean slicing() {\n+        return slicing;\n+    }\n+\n+    /**\n+     * Turns on co-located reading\n+     *\n+     * Jet cluster member must run exactly on the same nodes as Elastic cluster.\n+     *\n+     * @param coLocatedRead {@code true} to enable co-located reading, default value {@code false}\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> coLocatedReading(boolean coLocatedRead) {\n+        this.coLocatedReading = coLocatedRead;\n+        return this;\n+    }\n+\n+    public boolean coLocatedReading() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 212}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTgyNDUzOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/impl/ElasticProcessorTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo1MTozOFrOGCCACQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjo1MTozOFrOGCCACQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc4MzExMw==", "bodyText": "you should use TestSupport for testing the processor. Otherwise it's easy to get cooperative emission errors. This will test the processor with outbox of size \"1\"", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404783113", "createdAt": "2020-04-07T12:51:38Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/impl/ElasticProcessorTest.java", "diffHunk": "@@ -0,0 +1,357 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic.impl;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.jet.core.test.TestOutbox;\n+import com.hazelcast.jet.core.test.TestProcessorContext;\n+import com.hazelcast.jet.elastic.ElasticSourceBuilder;\n+import com.hazelcast.jet.elastic.impl.Shard.Prirep;\n+import org.apache.lucene.search.TotalHits;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.action.search.SearchScrollRequest;\n+import org.elasticsearch.client.Node;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RequestOptions.Builder;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestClientBuilder;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.common.bytes.BytesArray;\n+import org.elasticsearch.common.text.Text;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.SearchHits;\n+import org.elasticsearch.search.slice.SliceBuilder;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.ArgumentCaptor;\n+\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.emptyMap;\n+import static org.apache.lucene.search.TotalHits.Relation.EQUAL_TO;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static org.assertj.core.util.Lists.newArrayList;\n+import static org.mockito.ArgumentCaptor.forClass;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.RETURNS_DEEP_STUBS;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+\n+public class ElasticProcessorTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMTkxNDQwOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/Shard.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzoxMzoyNlrOGCC4Zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwNzowNDo1MlrOGChpOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc5NzU0Mg==", "bodyText": "what's Prirep?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r404797542", "createdAt": "2020-04-07T13:13:26Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/Shard.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic.impl;\n+\n+import javax.annotation.Nonnull;\n+import java.io.Serializable;\n+\n+class Shard implements Serializable {\n+\n+    private static final long serialVersionUID = 1L;\n+\n+    private final String index;\n+    private final int shard;\n+    private final Prirep prirep;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTMwMTU2MQ==", "bodyText": "Primary/replica, values are p and r", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r405301561", "createdAt": "2020-04-08T07:04:52Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/Shard.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic.impl;\n+\n+import javax.annotation.Nonnull;\n+import java.io.Serializable;\n+\n+class Shard implements Serializable {\n+\n+    private static final long serialVersionUID = 1L;\n+\n+    private final String index;\n+    private final int shard;\n+    private final Prirep prirep;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc5NzU0Mg=="}, "originalCommit": {"oid": "fe0bc203db238bb2a8fa1d383de923a55cc7d007"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNTUxNTg2OnYy", "diffSide": "RIGHT", "path": "examples/elastic/pom.xml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwODo1NzoyMlrOGCllng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwODo1NzoyMlrOGCllng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM2NjE3NA==", "bodyText": "should remove commented out code", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r405366174", "createdAt": "2020-04-08T08:57:22Z", "author": {"login": "cangencer"}, "path": "examples/elastic/pom.xml", "diffHunk": "@@ -0,0 +1,45 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+  ~\n+  ~ Licensed under the Apache License, Version 2.0 (the \"License\");\n+  ~ you may not use this file except in compliance with the License.\n+  ~ You may obtain a copy of the License at\n+  ~\n+  ~ http://www.apache.org/licenses/LICENSE-2.0\n+  ~\n+  ~ Unless required by applicable law or agreed to in writing, software\n+  ~ distributed under the License is distributed on an \"AS IS\" BASIS,\n+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  ~ See the License for the specific language governing permissions and\n+  ~ limitations under the License.\n+  -->\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <artifactId>hazelcast-jet-examples-elastic</artifactId>\n+\n+    <parent>\n+        <groupId>com.hazelcast.jet.examples</groupId>\n+        <artifactId>hazelcast-jet-examples</artifactId>\n+        <version>4.1-SNAPSHOT</version>\n+    </parent>\n+\n+    <dependencies>\n+        <dependency>\n+            <groupId>com.hazelcast.jet</groupId>\n+            <artifactId>hazelcast-jet-elasticsearch-7</artifactId>\n+            <version>4.1-SNAPSHOT</version>\n+        </dependency>\n+\n+        <dependency>\n+            <groupId>com.fasterxml.jackson.core</groupId>\n+            <artifactId>jackson-databind</artifactId>\n+            <version>2.10.3</version>\n+<!--            <scope>test</scope>-->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d69ab5099428186ae4adb54f5f254a98f23401f"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNTUxODUyOnYy", "diffSide": "RIGHT", "path": "examples/elastic/src/main/java/com/hazelcast/jet/examples/elastic/ElasticSinkExample.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwODo1ODowMVrOGClnRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMjoxNjoyOFrOGQmn4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM2NjU5Ng==", "bodyText": "is ObjectMapper thread-safe? wouldn't it be better to use mapUsingService?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r405366596", "createdAt": "2020-04-08T08:58:01Z", "author": {"login": "cangencer"}, "path": "examples/elastic/src/main/java/com/hazelcast/jet/examples/elastic/ElasticSinkExample.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.examples.elastic;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.hazelcast.jet.Jet;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.core.processor.SourceProcessors;\n+import com.hazelcast.jet.elastic.ElasticSinks;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import org.elasticsearch.action.index.IndexRequest;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.util.Map;\n+import java.util.stream.Stream;\n+\n+import static com.hazelcast.jet.pipeline.Pipeline.create;\n+import static com.hazelcast.jet.pipeline.Sources.batchFromProcessor;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+public class ElasticSinkExample {\n+\n+    public static void main(String[] args) {\n+        try {\n+            ObjectMapper mapper = new ObjectMapper();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d69ab5099428186ae4adb54f5f254a98f23401f"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA2MzIwMw==", "bodyText": "Yes, it is thread-safe (with the exception that all ObjectMapper's configuration must be done before first use, but there the defaults are used).\nI am not sure. ObjectMapper is serializable, so it can be used with map:\nObjectMapper mapper = new ObjectMapper();\n...\n .map(json -> mapper.readValue(json, new TypeReference<Map<String, Object>>() {})\n\nvs\nServiceFactory<?, ObjectMapper> service = ServiceFactories.sharedService((context) -> new ObjectMapper());\n...\n.mapUsingService(service, (mapper, json) -> mapper.readValue(json, new TypeReference<Map<String, Object>>() {}))\n\nThe one bit I don't like here is the new TypeReference<Map<String, Object>>() {}), which we could cache inside a service. But then the service wouldn't be just the ObjectMapper, which would complicate the example", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r420063203", "createdAt": "2020-05-05T12:16:28Z", "author": {"login": "frant-hartm"}, "path": "examples/elastic/src/main/java/com/hazelcast/jet/examples/elastic/ElasticSinkExample.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.examples.elastic;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.hazelcast.jet.Jet;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.core.processor.SourceProcessors;\n+import com.hazelcast.jet.elastic.ElasticSinks;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import org.elasticsearch.action.index.IndexRequest;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.util.Map;\n+import java.util.stream.Stream;\n+\n+import static com.hazelcast.jet.pipeline.Pipeline.create;\n+import static com.hazelcast.jet.pipeline.Sources.batchFromProcessor;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+public class ElasticSinkExample {\n+\n+    public static void main(String[] args) {\n+        try {\n+            ObjectMapper mapper = new ObjectMapper();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM2NjU5Ng=="}, "originalCommit": {"oid": "5d69ab5099428186ae4adb54f5f254a98f23401f"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMjIyOTczOnYy", "diffSide": "RIGHT", "path": "site/docs/api/sources-sinks.md", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNjowMDoxMVrOGE_WgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNjowMDoxMVrOGE_WgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg4NTQ0MA==", "bodyText": "are you using some auto-reflow here? seems sometimes lines are too short", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r407885440", "createdAt": "2020-04-14T06:00:11Z", "author": {"login": "cangencer"}, "path": "site/docs/api/sources-sinks.md", "diffHunk": "@@ -948,6 +948,99 @@ tests](https://github.com/hazelcast/hazelcast-jet-contrib/tree/master/xa-test)\n to get more information. This only applies to the JDBC sink, the source\n doesn't use XA transactions.\n \n+### Elasticsearch\n+\n+Elasticsearch is a popular fulltext search engine.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc30adba50939a955a94c3f2617040b333448295"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMjIzMTA2OnYy", "diffSide": "RIGHT", "path": "site/docs/api/sources-sinks.md", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNjowMDo1OVrOGE_XRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNjowMDo1OVrOGE_XRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg4NTYzOQ==", "bodyText": "you need line breaks if it's intended to be another paragraph, otherwise you can merge it with previous line.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r407885639", "createdAt": "2020-04-14T06:00:59Z", "author": {"login": "cangencer"}, "path": "site/docs/api/sources-sinks.md", "diffHunk": "@@ -948,6 +948,99 @@ tests](https://github.com/hazelcast/hazelcast-jet-contrib/tree/master/xa-test)\n to get more information. This only applies to the JDBC sink, the source\n doesn't use XA transactions.\n \n+### Elasticsearch\n+\n+Elasticsearch is a popular fulltext search engine.\n+Hazelcast Jet can use it both as a source and a sink.\n+\n+#### Source\n+\n+The Elasticsearch connector source provides a builder and several \n+convenience factory methods.\n+Most commonly on needs to provide\n+- a client supplier, which returns a configured instance of\n+RestHighLevelClient (see\n+[Elasticsearch documentation](https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high.html)), \n+- a search request supplier specifying a query to Elasticsearch,\n+- a mapping function from `SearchHit` to a desired type.\n+\n+Example using a factory method:\n+\n+```java\n+BatchSource<String> source = ElasticsearchSources.elasticsearch(\n+    () -> client(\"user\", \"password\", \"host\", 9200),\n+    () -> new SearchRequest(\"my-index\"),\n+    hit -> (String) hit.getSourceAsMap().get(\"name\")\n+);\n+```\n+\n+For all configuration options use the builder:\n+\n+```java\n+BatchSource<String> elasticsearch = new ElasticsearchSourceBuilder<String>()\n+        .name(\"elastic-source\")\n+        .clientSupplier(() -> new RestHighLevelClient(RestClient.builder(new HttpHost(\n+                \"localhost\", 9200\n+        ))))\n+        .destroyFn(RestHighLevelClient::close)\n+        .searchRequestSupplier(() -> new SearchRequest(\"my-index\"))\n+        .optionsFn(request -> RequestOptions.DEFAULT)\n+        .mapHitFn(hit -> hit.getSourceAsString())\n+        .slicing(true)\n+        .build();\n+```\n+\n+By default the connector uses a single scroll to read data from \n+Elasticsearch - there is only a single reader on a single node in whole \n+cluster.\n+\n+Slicing can be used to parallelize reading from an index with more\n+shards. Number of slices equals to globalParallelism.\n+\n+If Hazelcast Jet nodes and Elasticsearch nodes are located on the same\n+machines then the connector will use co-located reading, avoiding the\n+overhead of physical network.\n+\n+#### Sink\n+\n+The Elasticsearch connector sink provides a builder and several \n+convenience factory methods.\n+Most commonly you need to provide", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc30adba50939a955a94c3f2617040b333448295"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMjIzMjkyOnYy", "diffSide": "RIGHT", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/util/Util.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNjowMTo1N1rOGE_YZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNjowMTo1N1rOGE_YZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg4NTkyNA==", "bodyText": "could we add @nullable annotations here?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r407885924", "createdAt": "2020-04-14T06:01:57Z", "author": {"login": "cangencer"}, "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/util/Util.java", "diffHunk": "@@ -163,11 +163,12 @@ private static boolean diffHadOverflow(long a, long b, long diff) {\n      *\n      * @param object     object to check\n      * @param objectName object description for the exception\n+     * @return given object\n      * @throws IllegalArgumentException if {@code object} is not serializable\n      */\n-    public static void checkSerializable(Object object, String objectName) {\n+    public static <T> T checkSerializable(T object, String objectName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc30adba50939a955a94c3f2617040b333448295"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMjI0MTI1OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/test/resources/log4j.properties", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNjowNToyMFrOGE_dOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNjowNToyMFrOGE_dOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg4NzE2MA==", "bodyText": "this file shouldn't be necessary, we don't have it in other modules", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r407887160", "createdAt": "2020-04-14T06:05:20Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/test/resources/log4j.properties", "diffHunk": "@@ -0,0 +1,10 @@\n+log4j.appender.stdout=org.apache.log4j.ConsoleAppender", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc30adba50939a955a94c3f2617040b333448295"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMjI0MjgwOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/impl/ElasticProcessorTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNjowNjowOFrOGE_eLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNjowNjowOFrOGE_eLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg4NzQwNQ==", "bodyText": "can you use the naming convention we use? when_NN_then_MM", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r407887405", "createdAt": "2020-04-14T06:06:08Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/impl/ElasticProcessorTest.java", "diffHunk": "@@ -0,0 +1,357 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic.impl;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.jet.core.test.TestOutbox;\n+import com.hazelcast.jet.core.test.TestProcessorContext;\n+import com.hazelcast.jet.elastic.ElasticSourceBuilder;\n+import com.hazelcast.jet.elastic.impl.Shard.Prirep;\n+import org.apache.lucene.search.TotalHits;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.action.search.SearchScrollRequest;\n+import org.elasticsearch.client.Node;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RequestOptions.Builder;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestClientBuilder;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.common.bytes.BytesArray;\n+import org.elasticsearch.common.text.Text;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.SearchHits;\n+import org.elasticsearch.search.slice.SliceBuilder;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.ArgumentCaptor;\n+\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.emptyMap;\n+import static org.apache.lucene.search.TotalHits.Relation.EQUAL_TO;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static org.assertj.core.util.Lists.newArrayList;\n+import static org.mockito.ArgumentCaptor.forClass;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.RETURNS_DEEP_STUBS;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+\n+public class ElasticProcessorTest {\n+\n+    public static final String HIT_SOURCE = \"{\\\"name\\\": \\\"Frantisek\\\"}\";\n+    public static final String HIT_SOURCE2 = \"{\\\"name\\\": \\\"Vladimir\\\"}\";\n+    public static final String SCROLL_ID = \"random-scroll-id\";\n+    public static final int OUTBOX_CAPACITY = 1000;\n+\n+    private static final String KEEP_ALIVE = \"42m\";\n+\n+    private ElasticProcessor<String> processor;\n+    private SerializableRestClient mockClient;\n+    private SearchResponse response;\n+    private TestOutbox outbox;\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        mockClient = SerializableRestClient.instanceHolder = mock(SerializableRestClient.class, RETURNS_DEEP_STUBS);\n+        // Mocks returning mocks is not generally recommended, but the setup of empty SearchResponse is even uglier\n+        // See org.elasticsearch.action.search.SearchResponse#empty\n+        response = mock(SearchResponse.class);\n+        when(response.getScrollId()).thenReturn(SCROLL_ID);\n+        when(mockClient.search(any(), any())).thenReturn(response);\n+    }\n+\n+    private void createProcessor() throws Exception {\n+        createProcessor(request -> RequestOptions.DEFAULT, emptyList(), false, false);\n+    }\n+\n+    private void createProcessor(FunctionEx<ActionRequest, RequestOptions> optionsFn) throws Exception {\n+        createProcessor(optionsFn, emptyList(), false, false);\n+    }\n+\n+    private void createProcessor(List<Shard> shards) throws Exception {\n+        createProcessor(request -> RequestOptions.DEFAULT, shards, false, true);\n+    }\n+\n+    private void createProcessor(FunctionEx<ActionRequest, RequestOptions> optionsFn, List<Shard> shards,\n+                                 boolean slicing, boolean coLocatedReading)\n+            throws Exception {\n+        createProcessor(optionsFn, shards, slicing, coLocatedReading, new TestProcessorContext());\n+    }\n+\n+    private void createProcessor(FunctionEx<ActionRequest, RequestOptions> optionsFn, List<Shard> shards,\n+                                 boolean slicing, boolean coLocatedReading, TestProcessorContext context)\n+            throws Exception {\n+\n+        RestHighLevelClient client = mockClient;\n+        ElasticSourceBuilder<String> builder = new ElasticSourceBuilder<String>()\n+                .clientSupplier(() -> client)\n+                .searchRequestSupplier(() -> new SearchRequest(\"*\"))\n+                .optionsFn(optionsFn)\n+                .mapHitFn(SearchHit::getSourceAsString)\n+                .scrollKeepAlive(KEEP_ALIVE)\n+                .slicing(slicing)\n+                .coLocatedReading(coLocatedReading);\n+\n+        // This constructor calls the client so it has to be called after specific mock setup in each test method\n+        // rather than in setUp()\n+        processor = new ElasticProcessor<>(builder, shards);\n+        outbox = new TestOutbox(OUTBOX_CAPACITY);\n+        processor.init(outbox, context);\n+\n+    }\n+\n+    @Test\n+    public void shouldUseScrollSearch() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc30adba50939a955a94c3f2617040b333448295"}, "originalPosition": 129}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMjI0NDk1OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/ElasticSourceBuilderTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNjowNzoyMFrOGE_ffw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNjowNzoyMFrOGE_ffw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg4Nzc0Mw==", "bodyText": "if you want it serial you should use HazelcastSerialClassRunner, but I don't see anything in the test that needs to be serialized. It's typically used when you can have multiple tests interfere with each other.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r407887743", "createdAt": "2020-04-14T06:07:20Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/ElasticSourceBuilderTest.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.test.SerialTest;\n+import org.apache.http.HttpHost;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.jetbrains.annotations.NotNull;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+@Category(SerialTest.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc30adba50939a955a94c3f2617040b333448295"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMjI1MDE2OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/LocalElasticSinkTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNjowOTowOVrOGE_iew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNjowOTowOVrOGE_iew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg4ODUwNw==", "bodyText": "should use HazelcastSerialClassRunner", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r407888507", "createdAt": "2020-04-14T06:09:09Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/LocalElasticSinkTest.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.JetTestInstanceFactory;\n+import com.hazelcast.jet.config.JetConfig;\n+import com.hazelcast.jet.test.SerialTest;\n+import org.junit.After;\n+import org.junit.experimental.categories.Category;\n+\n+/**\n+ * Test running single Jet member locally and Elastic in docker\n+ */\n+@Category(SerialTest.class)\n+public class LocalElasticSinkTest extends CommonElasticSinksTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc30adba50939a955a94c3f2617040b333448295"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMjI1MTQyOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/BaseElasticTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNjowOTo0NlrOGE_jSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMTo1NzoxNlrOGQmAxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg4ODcxMg==", "bodyText": "should extend JetTestSupport", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r407888712", "createdAt": "2020-04-14T06:09:46Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/BaseElasticTest.java", "diffHunk": "@@ -0,0 +1,205 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.collection.IList;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.Job;\n+import com.hazelcast.jet.config.JobConfig;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import org.elasticsearch.action.admin.indices.delete.DeleteIndexRequest;\n+import org.elasticsearch.action.bulk.BulkItemResponse;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.WriteRequest.RefreshPolicy;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.client.indices.CreateIndexRequest;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.index.reindex.DeleteByQueryRequest;\n+import org.junit.Before;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import static com.google.common.collect.ImmutableMap.of;\n+import static org.assertj.core.util.Lists.newArrayList;\n+import static org.elasticsearch.client.RequestOptions.DEFAULT;\n+import static org.elasticsearch.index.query.QueryBuilders.matchAllQuery;\n+\n+/**\n+ * Base class for running Elasticsearch connector tests\n+ *\n+ * To use implement:\n+ * - {@link #elasticClientSupplier()}\n+ * - {@link #createJetInstance()}\n+ * Subclasses are free to cache\n+ */\n+public abstract class BaseElasticTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc30adba50939a955a94c3f2617040b333448295"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA1MzE5MA==", "bodyText": "Some of the subclasses use single jet instance, some use in process cluster and some use docker cluster, so can't really use that.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r420053190", "createdAt": "2020-05-05T11:57:16Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/BaseElasticTest.java", "diffHunk": "@@ -0,0 +1,205 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.collection.IList;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.Job;\n+import com.hazelcast.jet.config.JobConfig;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import org.elasticsearch.action.admin.indices.delete.DeleteIndexRequest;\n+import org.elasticsearch.action.bulk.BulkItemResponse;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.WriteRequest.RefreshPolicy;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.client.indices.CreateIndexRequest;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.index.reindex.DeleteByQueryRequest;\n+import org.junit.Before;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import static com.google.common.collect.ImmutableMap.of;\n+import static org.assertj.core.util.Lists.newArrayList;\n+import static org.elasticsearch.client.RequestOptions.DEFAULT;\n+import static org.elasticsearch.index.query.QueryBuilders.matchAllQuery;\n+\n+/**\n+ * Base class for running Elasticsearch connector tests\n+ *\n+ * To use implement:\n+ * - {@link #elasticClientSupplier()}\n+ * - {@link #createJetInstance()}\n+ * Subclasses are free to cache\n+ */\n+public abstract class BaseElasticTest {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg4ODcxMg=="}, "originalCommit": {"oid": "cc30adba50939a955a94c3f2617040b333448295"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMjI1MzU5OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/LocalClusterElasticSourcesTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNjoxMDo0MFrOGE_knQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMTo1Nzo1NFrOGQmCLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg4OTA1Mw==", "bodyText": "we shouldn't do our own cluster management, JetTestSupport already provides this. Also see TestInClusterSupport", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r407889053", "createdAt": "2020-04-14T06:10:40Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/LocalClusterElasticSourcesTest.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.JetTestInstanceFactory;\n+import com.hazelcast.jet.config.JetConfig;\n+import com.hazelcast.jet.impl.util.Util;\n+import com.hazelcast.jet.test.SerialTest;\n+import org.junit.experimental.categories.Category;\n+\n+import java.util.function.Supplier;\n+\n+/**\n+ * Test running 3 local Jet members in a cluster and Elastic in docker\n+ */\n+@Category(SerialTest.class)\n+public class LocalClusterElasticSourcesTest extends CommonElasticSourcesTest {\n+\n+    // Cluster startup takes >1s, reusing the cluster between tests\n+    private static Supplier<JetInstance> jet = Util.memoize(() -> {\n+        JetTestInstanceFactory factory = new JetTestInstanceFactory();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc30adba50939a955a94c3f2617040b333448295"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA1MzU0OQ==", "bodyText": "Already extending CommonElasticSourcesTest, which has subclasses not using cluster.\nIdeally the functionality of TestInClusterSupport should be provided as JUnit @Class rule.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r420053549", "createdAt": "2020-05-05T11:57:54Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/LocalClusterElasticSourcesTest.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.JetTestInstanceFactory;\n+import com.hazelcast.jet.config.JetConfig;\n+import com.hazelcast.jet.impl.util.Util;\n+import com.hazelcast.jet.test.SerialTest;\n+import org.junit.experimental.categories.Category;\n+\n+import java.util.function.Supplier;\n+\n+/**\n+ * Test running 3 local Jet members in a cluster and Elastic in docker\n+ */\n+@Category(SerialTest.class)\n+public class LocalClusterElasticSourcesTest extends CommonElasticSourcesTest {\n+\n+    // Cluster startup takes >1s, reusing the cluster between tests\n+    private static Supplier<JetInstance> jet = Util.memoize(() -> {\n+        JetTestInstanceFactory factory = new JetTestInstanceFactory();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg4OTA1Mw=="}, "originalCommit": {"oid": "cc30adba50939a955a94c3f2617040b333448295"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMjI1OTU3OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNjoxMzoyM1rOGE_oHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNjoxMzoyM1rOGE_oHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg4OTk1MQ==", "bodyText": "it's not type of function, but type of the output?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r407889951", "createdAt": "2020-04-14T06:13:23Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "diffHunk": "@@ -0,0 +1,226 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.elastic.impl.ElasticProcessorMetaSupplier;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Sources;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkNonNullAndSerializable;\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch source which reads data from Elasticsearch and\n+ * converts SearchHits using provided {@code mapHitFn}\n+ *\n+ * @param <T> type of the mapping function from {@link SearchHit} -> T", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc30adba50939a955a94c3f2617040b333448295"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUzMjI2MDY0OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/ElasticProcessorSupplier.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNjoxMzo0N1rOGE_ouQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNjoxMzo0N1rOGE_ouQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg5MDEwNQ==", "bodyText": "what's <R>? I Think <T> is used everywhere else?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r407890105", "createdAt": "2020-04-14T06:13:47Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/ElasticProcessorSupplier.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic.impl;\n+\n+import com.hazelcast.jet.core.Processor;\n+import com.hazelcast.jet.core.ProcessorSupplier;\n+import com.hazelcast.jet.elastic.ElasticSourceBuilder;\n+import com.hazelcast.jet.impl.util.Util;\n+\n+import javax.annotation.Nonnull;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Objects.requireNonNull;\n+\n+class ElasticProcessorSupplier<R> implements ProcessorSupplier {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc30adba50939a955a94c3f2617040b333448295"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDY4OTQ4OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/ElasticBaseTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMToxMzowMlrOGQksTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMTo1MToyM1rOGQl0-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAzMTU2Nw==", "bodyText": "There is ElasticBaseTest and BaseElasticTest. This naming is really confusing.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r420031567", "createdAt": "2020-05-05T11:13:02Z", "author": {"login": "olukas"}, "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/ElasticBaseTest.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.collection.IList;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.core.JetTestSupport;\n+import org.apache.http.HttpHost;\n+import org.elasticsearch.action.get.MultiGetItemResponse;\n+import org.elasticsearch.action.get.MultiGetRequest;\n+import org.elasticsearch.action.get.MultiGetResponse;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.testcontainers.containers.Network;\n+import org.testcontainers.elasticsearch.ElasticsearchContainer;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertTrue;\n+\n+public abstract class ElasticBaseTest extends JetTestSupport {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc30adba50939a955a94c3f2617040b333448295"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA1MDE2OA==", "bodyText": "Removed ElasticBaseTest and associated ElasticSinkTest. The same is covered in CommonElasticSinksTest", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r420050168", "createdAt": "2020-05-05T11:51:23Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/ElasticBaseTest.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.collection.IList;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.core.JetTestSupport;\n+import org.apache.http.HttpHost;\n+import org.elasticsearch.action.get.MultiGetItemResponse;\n+import org.elasticsearch.action.get.MultiGetRequest;\n+import org.elasticsearch.action.get.MultiGetResponse;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.testcontainers.containers.Network;\n+import org.testcontainers.elasticsearch.ElasticsearchContainer;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertTrue;\n+\n+public abstract class ElasticBaseTest extends JetTestSupport {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAzMTU2Nw=="}, "originalCommit": {"oid": "cc30adba50939a955a94c3f2617040b333448295"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzMzMjIyOnYy", "diffSide": "RIGHT", "path": "examples/elastic/pom.xml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoxOToyMFrOGTRpsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoxOToyMFrOGTRpsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg2NTMyOQ==", "bodyText": "should be 4.2, could you merge master into the branch?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422865329", "createdAt": "2020-05-11T08:19:20Z", "author": {"login": "cangencer"}, "path": "examples/elastic/pom.xml", "diffHunk": "@@ -0,0 +1,44 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+  ~\n+  ~ Licensed under the Apache License, Version 2.0 (the \"License\");\n+  ~ you may not use this file except in compliance with the License.\n+  ~ You may obtain a copy of the License at\n+  ~\n+  ~ http://www.apache.org/licenses/LICENSE-2.0\n+  ~\n+  ~ Unless required by applicable law or agreed to in writing, software\n+  ~ distributed under the License is distributed on an \"AS IS\" BASIS,\n+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  ~ See the License for the specific language governing permissions and\n+  ~ limitations under the License.\n+  -->\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <artifactId>hazelcast-jet-examples-elastic</artifactId>\n+\n+    <parent>\n+        <groupId>com.hazelcast.jet.examples</groupId>\n+        <artifactId>hazelcast-jet-examples</artifactId>\n+        <version>4.1-SNAPSHOT</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzMzMzA5OnYy", "diffSide": "RIGHT", "path": "examples/elastic/pom.xml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoxOTozM1rOGTRqMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoxOTozM1rOGTRqMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg2NTQ1Nw==", "bodyText": "do we still need this, given jackson jr is merged now into master?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422865457", "createdAt": "2020-05-11T08:19:33Z", "author": {"login": "cangencer"}, "path": "examples/elastic/pom.xml", "diffHunk": "@@ -0,0 +1,44 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+  ~\n+  ~ Licensed under the Apache License, Version 2.0 (the \"License\");\n+  ~ you may not use this file except in compliance with the License.\n+  ~ You may obtain a copy of the License at\n+  ~\n+  ~ http://www.apache.org/licenses/LICENSE-2.0\n+  ~\n+  ~ Unless required by applicable law or agreed to in writing, software\n+  ~ distributed under the License is distributed on an \"AS IS\" BASIS,\n+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  ~ See the License for the specific language governing permissions and\n+  ~ limitations under the License.\n+  -->\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+    <modelVersion>4.0.0</modelVersion>\n+\n+    <artifactId>hazelcast-jet-examples-elastic</artifactId>\n+\n+    <parent>\n+        <groupId>com.hazelcast.jet.examples</groupId>\n+        <artifactId>hazelcast-jet-examples</artifactId>\n+        <version>4.1-SNAPSHOT</version>\n+    </parent>\n+\n+    <dependencies>\n+        <dependency>\n+            <groupId>com.hazelcast.jet</groupId>\n+            <artifactId>hazelcast-jet-elasticsearch-7</artifactId>\n+            <version>4.1-SNAPSHOT</version>\n+        </dependency>\n+\n+        <dependency>\n+            <groupId>com.fasterxml.jackson.core</groupId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzM1MDQ0OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyNDoxMFrOGTR0_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyNDoxMFrOGTR0_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg2ODIyMw==", "bodyText": "you can make the javadoc a bit nicer here, for example you can have the main description in the top and then the param can be short, maybe showing an example. We should avoid javadoc like set X, and you can show some example code as well.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422868223", "createdAt": "2020-05-11T08:24:10Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "diffHunk": "@@ -0,0 +1,202 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import com.hazelcast.jet.pipeline.SinkBuilder;\n+import com.hazelcast.logging.ILogger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkNonNullAndSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch Sink\n+ * <p>\n+ * The Sink first maps items from the pipeline using the provided\n+ * {@link #mapItemFn(FunctionEx)} and then using {@link BulkRequest}.\n+ * <p>\n+ * {@link BulkRequest#BulkRequest()} is used by default, it can be\n+ * modified by providing custom {@link #bulkRequestSupplier(SupplierEx)}\n+ *\n+ * <p>\n+ * Usage:\n+ * <pre>{@code\n+ * Sink<Map<String, ?>> elasticSink = new ElasticSinkBuilder<Map<String, ?>>()\n+ *   .clientSupplier(() -> ElasticClients.client(host, port))\n+ *   .mapItemFn(item -> new IndexRequest(\"my-index\").source(item))\n+ *   .build();\n+ * }</pre>\n+ * <p>\n+ * Requires {@link #clientSupplier(SupplierEx)} and {@link #mapItemFn(FunctionEx)}.\n+ *\n+ * @param <T>\n+ * @since 4.1\n+ */\n+public class ElasticSinkBuilder<T> implements Serializable {\n+\n+    private static final String DEFAULT_NAME = \"elastic\";\n+\n+    private SupplierEx<? extends RestHighLevelClient> clientSupplier;\n+    private ConsumerEx<? super RestHighLevelClient> destroyFn = RestHighLevelClient::close;\n+    private SupplierEx<BulkRequest> bulkRequestSupplier = BulkRequest::new;\n+    private FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = (request) -> RequestOptions.DEFAULT;\n+    private int preferredLocalParallelism = 2;\n+\n+    /**\n+     * Set the client supplier\n+     *\n+     * @param clientSupplier supplier for configure Elasticsearch REST client\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> clientSupplier(@Nonnull SupplierEx<? extends RestHighLevelClient> clientSupplier) {\n+        this.clientSupplier = checkNonNullAndSerializable(clientSupplier, \"clientSupplier\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the destroy function called on completion, defaults to {@link RestHighLevelClient#close()}\n+     *\n+     * @param destroyFn destroy function\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> destroyFn(@Nonnull ConsumerEx<? super RestHighLevelClient> destroyFn) {\n+        this.destroyFn = checkNonNullAndSerializable(destroyFn, \"destroyFn\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the bulkRequestSupplier, defaults to new {@link BulkRequest#BulkRequest()}\n+     *\n+     * @param bulkRequestSupplier supplier for the bulk request\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> bulkRequestSupplier(@Nonnull SupplierEx<BulkRequest> bulkRequestSupplier) {\n+        this.bulkRequestSupplier = checkNonNullAndSerializable(bulkRequestSupplier, \"clientSupplier\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the mapItemFn", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 108}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzM1MTQxOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyNDoyNFrOGTR1lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyNDoyNFrOGTR1lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg2ODM3NQ==", "bodyText": "a more descriptive name would mapToRequestFn", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422868375", "createdAt": "2020-05-11T08:24:24Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "diffHunk": "@@ -0,0 +1,202 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import com.hazelcast.jet.pipeline.SinkBuilder;\n+import com.hazelcast.logging.ILogger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkNonNullAndSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch Sink\n+ * <p>\n+ * The Sink first maps items from the pipeline using the provided\n+ * {@link #mapItemFn(FunctionEx)} and then using {@link BulkRequest}.\n+ * <p>\n+ * {@link BulkRequest#BulkRequest()} is used by default, it can be\n+ * modified by providing custom {@link #bulkRequestSupplier(SupplierEx)}\n+ *\n+ * <p>\n+ * Usage:\n+ * <pre>{@code\n+ * Sink<Map<String, ?>> elasticSink = new ElasticSinkBuilder<Map<String, ?>>()\n+ *   .clientSupplier(() -> ElasticClients.client(host, port))\n+ *   .mapItemFn(item -> new IndexRequest(\"my-index\").source(item))\n+ *   .build();\n+ * }</pre>\n+ * <p>\n+ * Requires {@link #clientSupplier(SupplierEx)} and {@link #mapItemFn(FunctionEx)}.\n+ *\n+ * @param <T>\n+ * @since 4.1\n+ */\n+public class ElasticSinkBuilder<T> implements Serializable {\n+\n+    private static final String DEFAULT_NAME = \"elastic\";\n+\n+    private SupplierEx<? extends RestHighLevelClient> clientSupplier;\n+    private ConsumerEx<? super RestHighLevelClient> destroyFn = RestHighLevelClient::close;\n+    private SupplierEx<BulkRequest> bulkRequestSupplier = BulkRequest::new;\n+    private FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = (request) -> RequestOptions.DEFAULT;\n+    private int preferredLocalParallelism = 2;\n+\n+    /**\n+     * Set the client supplier\n+     *\n+     * @param clientSupplier supplier for configure Elasticsearch REST client\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> clientSupplier(@Nonnull SupplierEx<? extends RestHighLevelClient> clientSupplier) {\n+        this.clientSupplier = checkNonNullAndSerializable(clientSupplier, \"clientSupplier\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the destroy function called on completion, defaults to {@link RestHighLevelClient#close()}\n+     *\n+     * @param destroyFn destroy function\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> destroyFn(@Nonnull ConsumerEx<? super RestHighLevelClient> destroyFn) {\n+        this.destroyFn = checkNonNullAndSerializable(destroyFn, \"destroyFn\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the bulkRequestSupplier, defaults to new {@link BulkRequest#BulkRequest()}\n+     *\n+     * @param bulkRequestSupplier supplier for the bulk request\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> bulkRequestSupplier(@Nonnull SupplierEx<BulkRequest> bulkRequestSupplier) {\n+        this.bulkRequestSupplier = checkNonNullAndSerializable(bulkRequestSupplier, \"clientSupplier\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the mapItemFn\n+     *\n+     * @param mapItemFn maps an item from the stream to an {@link org.elasticsearch.action.index.IndexRequest},\n+     *                  {@link org.elasticsearch.action.update.UpdateRequest} or\n+     *                  {@link org.elasticsearch.action.delete.DeleteRequest}\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> mapItemFn(@Nonnull FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 115}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzM1Mjk1OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyNDo0OFrOGTR2gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyNDo0OFrOGTR2gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg2ODYxMA==", "bodyText": "javadoc is lacking, what does it do?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422868610", "createdAt": "2020-05-11T08:24:48Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "diffHunk": "@@ -0,0 +1,202 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import com.hazelcast.jet.pipeline.SinkBuilder;\n+import com.hazelcast.logging.ILogger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkNonNullAndSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch Sink\n+ * <p>\n+ * The Sink first maps items from the pipeline using the provided\n+ * {@link #mapItemFn(FunctionEx)} and then using {@link BulkRequest}.\n+ * <p>\n+ * {@link BulkRequest#BulkRequest()} is used by default, it can be\n+ * modified by providing custom {@link #bulkRequestSupplier(SupplierEx)}\n+ *\n+ * <p>\n+ * Usage:\n+ * <pre>{@code\n+ * Sink<Map<String, ?>> elasticSink = new ElasticSinkBuilder<Map<String, ?>>()\n+ *   .clientSupplier(() -> ElasticClients.client(host, port))\n+ *   .mapItemFn(item -> new IndexRequest(\"my-index\").source(item))\n+ *   .build();\n+ * }</pre>\n+ * <p>\n+ * Requires {@link #clientSupplier(SupplierEx)} and {@link #mapItemFn(FunctionEx)}.\n+ *\n+ * @param <T>\n+ * @since 4.1\n+ */\n+public class ElasticSinkBuilder<T> implements Serializable {\n+\n+    private static final String DEFAULT_NAME = \"elastic\";\n+\n+    private SupplierEx<? extends RestHighLevelClient> clientSupplier;\n+    private ConsumerEx<? super RestHighLevelClient> destroyFn = RestHighLevelClient::close;\n+    private SupplierEx<BulkRequest> bulkRequestSupplier = BulkRequest::new;\n+    private FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = (request) -> RequestOptions.DEFAULT;\n+    private int preferredLocalParallelism = 2;\n+\n+    /**\n+     * Set the client supplier\n+     *\n+     * @param clientSupplier supplier for configure Elasticsearch REST client\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> clientSupplier(@Nonnull SupplierEx<? extends RestHighLevelClient> clientSupplier) {\n+        this.clientSupplier = checkNonNullAndSerializable(clientSupplier, \"clientSupplier\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the destroy function called on completion, defaults to {@link RestHighLevelClient#close()}\n+     *\n+     * @param destroyFn destroy function\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> destroyFn(@Nonnull ConsumerEx<? super RestHighLevelClient> destroyFn) {\n+        this.destroyFn = checkNonNullAndSerializable(destroyFn, \"destroyFn\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the bulkRequestSupplier, defaults to new {@link BulkRequest#BulkRequest()}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 97}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzM1NjE5OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyNTozNFrOGTR4bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyNTozNFrOGTR4bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg2OTEwMw==", "bodyText": "we use the convention bulkRequestFn typically for all functional interfaces", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422869103", "createdAt": "2020-05-11T08:25:34Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "diffHunk": "@@ -0,0 +1,202 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import com.hazelcast.jet.pipeline.SinkBuilder;\n+import com.hazelcast.logging.ILogger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkNonNullAndSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch Sink\n+ * <p>\n+ * The Sink first maps items from the pipeline using the provided\n+ * {@link #mapItemFn(FunctionEx)} and then using {@link BulkRequest}.\n+ * <p>\n+ * {@link BulkRequest#BulkRequest()} is used by default, it can be\n+ * modified by providing custom {@link #bulkRequestSupplier(SupplierEx)}\n+ *\n+ * <p>\n+ * Usage:\n+ * <pre>{@code\n+ * Sink<Map<String, ?>> elasticSink = new ElasticSinkBuilder<Map<String, ?>>()\n+ *   .clientSupplier(() -> ElasticClients.client(host, port))\n+ *   .mapItemFn(item -> new IndexRequest(\"my-index\").source(item))\n+ *   .build();\n+ * }</pre>\n+ * <p>\n+ * Requires {@link #clientSupplier(SupplierEx)} and {@link #mapItemFn(FunctionEx)}.\n+ *\n+ * @param <T>\n+ * @since 4.1\n+ */\n+public class ElasticSinkBuilder<T> implements Serializable {\n+\n+    private static final String DEFAULT_NAME = \"elastic\";\n+\n+    private SupplierEx<? extends RestHighLevelClient> clientSupplier;\n+    private ConsumerEx<? super RestHighLevelClient> destroyFn = RestHighLevelClient::close;\n+    private SupplierEx<BulkRequest> bulkRequestSupplier = BulkRequest::new;\n+    private FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = (request) -> RequestOptions.DEFAULT;\n+    private int preferredLocalParallelism = 2;\n+\n+    /**\n+     * Set the client supplier\n+     *\n+     * @param clientSupplier supplier for configure Elasticsearch REST client\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> clientSupplier(@Nonnull SupplierEx<? extends RestHighLevelClient> clientSupplier) {\n+        this.clientSupplier = checkNonNullAndSerializable(clientSupplier, \"clientSupplier\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the destroy function called on completion, defaults to {@link RestHighLevelClient#close()}\n+     *\n+     * @param destroyFn destroy function\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> destroyFn(@Nonnull ConsumerEx<? super RestHighLevelClient> destroyFn) {\n+        this.destroyFn = checkNonNullAndSerializable(destroyFn, \"destroyFn\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the bulkRequestSupplier, defaults to new {@link BulkRequest#BulkRequest()}\n+     *\n+     * @param bulkRequestSupplier supplier for the bulk request\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> bulkRequestSupplier(@Nonnull SupplierEx<BulkRequest> bulkRequestSupplier) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 102}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzM1NzMyOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyNTo1MFrOGTR5EQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyNTo1MFrOGTR5EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg2OTI2NQ==", "bodyText": "clientFn. See other comments regarding javadoc", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422869265", "createdAt": "2020-05-11T08:25:50Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "diffHunk": "@@ -0,0 +1,202 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import com.hazelcast.jet.pipeline.SinkBuilder;\n+import com.hazelcast.logging.ILogger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkNonNullAndSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch Sink\n+ * <p>\n+ * The Sink first maps items from the pipeline using the provided\n+ * {@link #mapItemFn(FunctionEx)} and then using {@link BulkRequest}.\n+ * <p>\n+ * {@link BulkRequest#BulkRequest()} is used by default, it can be\n+ * modified by providing custom {@link #bulkRequestSupplier(SupplierEx)}\n+ *\n+ * <p>\n+ * Usage:\n+ * <pre>{@code\n+ * Sink<Map<String, ?>> elasticSink = new ElasticSinkBuilder<Map<String, ?>>()\n+ *   .clientSupplier(() -> ElasticClients.client(host, port))\n+ *   .mapItemFn(item -> new IndexRequest(\"my-index\").source(item))\n+ *   .build();\n+ * }</pre>\n+ * <p>\n+ * Requires {@link #clientSupplier(SupplierEx)} and {@link #mapItemFn(FunctionEx)}.\n+ *\n+ * @param <T>\n+ * @since 4.1\n+ */\n+public class ElasticSinkBuilder<T> implements Serializable {\n+\n+    private static final String DEFAULT_NAME = \"elastic\";\n+\n+    private SupplierEx<? extends RestHighLevelClient> clientSupplier;\n+    private ConsumerEx<? super RestHighLevelClient> destroyFn = RestHighLevelClient::close;\n+    private SupplierEx<BulkRequest> bulkRequestSupplier = BulkRequest::new;\n+    private FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = (request) -> RequestOptions.DEFAULT;\n+    private int preferredLocalParallelism = 2;\n+\n+    /**\n+     * Set the client supplier\n+     *\n+     * @param clientSupplier supplier for configure Elasticsearch REST client\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> clientSupplier(@Nonnull SupplierEx<? extends RestHighLevelClient> clientSupplier) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzM1OTgyOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticClients.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyNjoyOVrOGTR6nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyNjoyOVrOGTR6nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg2OTY2Mw==", "bodyText": "missing javadoc", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422869663", "createdAt": "2020-05-11T08:26:29Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticClients.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import org.apache.http.HttpHost;\n+import org.apache.http.auth.UsernamePasswordCredentials;\n+import org.apache.http.client.CredentialsProvider;\n+import org.apache.http.impl.client.BasicCredentialsProvider;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+\n+import static org.apache.http.auth.AuthScope.ANY;\n+\n+public final class ElasticClients {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzM2MDM3OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticClients.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyNjozOVrOGTR69g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyNjozOVrOGTR69g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg2OTc1MA==", "bodyText": "missing javadoc", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422869750", "createdAt": "2020-05-11T08:26:39Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticClients.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import org.apache.http.HttpHost;\n+import org.apache.http.auth.UsernamePasswordCredentials;\n+import org.apache.http.client.CredentialsProvider;\n+import org.apache.http.impl.client.BasicCredentialsProvider;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+\n+import static org.apache.http.auth.AuthScope.ANY;\n+\n+public final class ElasticClients {\n+\n+    private static final int DEFAULT_PORT = 9200;\n+\n+    private ElasticClients() {\n+    }\n+\n+    @Nonnull\n+    public static RestHighLevelClient client() {\n+        return client(\"localhost\", DEFAULT_PORT);\n+    }\n+\n+    @Nonnull\n+    public static RestHighLevelClient client(@Nonnull String hostname, int port) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzM2MDYyOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticClients.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyNjo0NFrOGTR7IA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyNjo0NFrOGTR7IA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg2OTc5Mg==", "bodyText": "missing javadoc", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422869792", "createdAt": "2020-05-11T08:26:44Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticClients.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import org.apache.http.HttpHost;\n+import org.apache.http.auth.UsernamePasswordCredentials;\n+import org.apache.http.client.CredentialsProvider;\n+import org.apache.http.impl.client.BasicCredentialsProvider;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+\n+import static org.apache.http.auth.AuthScope.ANY;\n+\n+public final class ElasticClients {\n+\n+    private static final int DEFAULT_PORT = 9200;\n+\n+    private ElasticClients() {\n+    }\n+\n+    @Nonnull\n+    public static RestHighLevelClient client() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzM2MjA1OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/package-info.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyNzowNFrOGTR8AA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyNzowNFrOGTR8AA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg3MDAxNg==", "bodyText": "elasticsearch 7", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422870016", "createdAt": "2020-05-11T08:27:04Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/package-info.java", "diffHunk": "@@ -0,0 +1,20 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/**\n+ * Contains sources and sinks for Elasticsearch", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzM2NTcwOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyODowMFrOGTR-Sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyODowMFrOGTR-Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg3MDYwMg==", "bodyText": "4.2", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422870602", "createdAt": "2020-05-11T08:28:00Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sources.\n+ * Alternatively you can use {@link ElasticSourceBuilder}\n+ *\n+ * @since 4.1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzM2OTkwOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODoyOToxNFrOGTSA9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMTo0NzoyNlrOGUaJSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg3MTI4Ng==", "bodyText": "this requires you declare T upfront. normally we start with Void and then map it when map function is defined", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422871286", "createdAt": "2020-05-11T08:29:14Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sources.\n+ * Alternatively you can use {@link ElasticSourceBuilder}\n+ *\n+ * @since 4.1\n+ */\n+public final class ElasticSources {\n+\n+    private ElasticSources() {\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * <p>\n+     * Useful for quick prototyping. See other methods {@link #elastic(SupplierEx, SupplierEx, FunctionEx)}\n+     * and {@link #builder()}\n+     */\n+    @Nonnull\n+    public static BatchSource<String> elastic() {\n+        return elastic(ElasticClients::client);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Queries all indexes for all documents.\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    @Nonnull\n+    public static BatchSource<String> elastic(@Nonnull SupplierEx<RestHighLevelClient> clientSupplier) {\n+        return elastic(clientSupplier, SearchHit::getSourceAsString);\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    @Nonnull\n+    public static <T> BatchSource<T> elastic(@Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(ElasticClients::client, mapHitFn);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Uses provided mapHitFn to map results.\n+     * Queries all indexes for all documents.\n+     *\n+     * @param clientSupplier RestHighLevelClient supplier\n+     * @param mapHitFn       supplier of a function mapping the result from SearchHit to a result type\n+     * @param <T>            result type returned by the map function\n+     */\n+    @Nonnull\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(clientSupplier, SearchRequest::new, mapHitFn);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     *\n+     * @param clientSupplier        RestHighLevelClient supplier\n+     * @param searchRequestSupplier supplier of a SearchRequest used to query for documents\n+     * @param mapHitFn              supplier of a function mapping the result from SearchHit to a target type\n+     * @param <T>                   result type returned by the map function\n+     */\n+    @Nonnull\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull SupplierEx<SearchRequest> searchRequestSupplier,\n+            @Nonnull FunctionEx<? super SearchHit, T> mapHitFn\n+    ) {\n+        return ElasticSources.<T>builder()\n+                .clientSupplier(clientSupplier)\n+                .searchRequestSupplier(searchRequestSupplier)\n+                .mapHitFn(mapHitFn)\n+                .build();\n+    }\n+\n+    /**\n+     * Returns {@link ElasticSourceBuilder}\n+     *\n+     * @param <T> result type returned by the map function\n+     */\n+    @Nonnull\n+    public static <T> ElasticSourceBuilder<T> builder() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDA1MzA2Ng==", "bodyText": "I tried to mimic what's in SourceBuilder, could you please check this is what you had in mind? (I did the same for ElasticSinkBuilder as well).", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r424053066", "createdAt": "2020-05-12T21:47:26Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sources.\n+ * Alternatively you can use {@link ElasticSourceBuilder}\n+ *\n+ * @since 4.1\n+ */\n+public final class ElasticSources {\n+\n+    private ElasticSources() {\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * <p>\n+     * Useful for quick prototyping. See other methods {@link #elastic(SupplierEx, SupplierEx, FunctionEx)}\n+     * and {@link #builder()}\n+     */\n+    @Nonnull\n+    public static BatchSource<String> elastic() {\n+        return elastic(ElasticClients::client);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Queries all indexes for all documents.\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    @Nonnull\n+    public static BatchSource<String> elastic(@Nonnull SupplierEx<RestHighLevelClient> clientSupplier) {\n+        return elastic(clientSupplier, SearchHit::getSourceAsString);\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    @Nonnull\n+    public static <T> BatchSource<T> elastic(@Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(ElasticClients::client, mapHitFn);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Uses provided mapHitFn to map results.\n+     * Queries all indexes for all documents.\n+     *\n+     * @param clientSupplier RestHighLevelClient supplier\n+     * @param mapHitFn       supplier of a function mapping the result from SearchHit to a result type\n+     * @param <T>            result type returned by the map function\n+     */\n+    @Nonnull\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(clientSupplier, SearchRequest::new, mapHitFn);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     *\n+     * @param clientSupplier        RestHighLevelClient supplier\n+     * @param searchRequestSupplier supplier of a SearchRequest used to query for documents\n+     * @param mapHitFn              supplier of a function mapping the result from SearchHit to a target type\n+     * @param <T>                   result type returned by the map function\n+     */\n+    @Nonnull\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull SupplierEx<SearchRequest> searchRequestSupplier,\n+            @Nonnull FunctionEx<? super SearchHit, T> mapHitFn\n+    ) {\n+        return ElasticSources.<T>builder()\n+                .clientSupplier(clientSupplier)\n+                .searchRequestSupplier(searchRequestSupplier)\n+                .mapHitFn(mapHitFn)\n+                .build();\n+    }\n+\n+    /**\n+     * Returns {@link ElasticSourceBuilder}\n+     *\n+     * @param <T> result type returned by the map function\n+     */\n+    @Nonnull\n+    public static <T> ElasticSourceBuilder<T> builder() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg3MTI4Ng=="}, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 112}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzM3NzA1OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODozMDo0OVrOGTSFNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODozMDo0OVrOGTSFNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg3MjM3Mw==", "bodyText": "should use builder. and naming should be consistent with other sources, clientFn", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422872373", "createdAt": "2020-05-11T08:30:49Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sources.\n+ * Alternatively you can use {@link ElasticSourceBuilder}\n+ *\n+ * @since 4.1\n+ */\n+public final class ElasticSources {\n+\n+    private ElasticSources() {\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * <p>\n+     * Useful for quick prototyping. See other methods {@link #elastic(SupplierEx, SupplierEx, FunctionEx)}\n+     * and {@link #builder()}\n+     */\n+    @Nonnull\n+    public static BatchSource<String> elastic() {\n+        return elastic(ElasticClients::client);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Queries all indexes for all documents.\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    @Nonnull\n+    public static BatchSource<String> elastic(@Nonnull SupplierEx<RestHighLevelClient> clientSupplier) {\n+        return elastic(clientSupplier, SearchHit::getSourceAsString);\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    @Nonnull\n+    public static <T> BatchSource<T> elastic(@Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(ElasticClients::client, mapHitFn);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Uses provided mapHitFn to map results.\n+     * Queries all indexes for all documents.\n+     *\n+     * @param clientSupplier RestHighLevelClient supplier\n+     * @param mapHitFn       supplier of a function mapping the result from SearchHit to a result type\n+     * @param <T>            result type returned by the map function\n+     */\n+    @Nonnull\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzM3ODg5OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODozMToxNVrOGTSGWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODozMToxNVrOGTSGWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg3MjY2Nw==", "bodyText": "mapToItemFn", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422872667", "createdAt": "2020-05-11T08:31:15Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sources.\n+ * Alternatively you can use {@link ElasticSourceBuilder}\n+ *\n+ * @since 4.1\n+ */\n+public final class ElasticSources {\n+\n+    private ElasticSources() {\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * <p>\n+     * Useful for quick prototyping. See other methods {@link #elastic(SupplierEx, SupplierEx, FunctionEx)}\n+     * and {@link #builder()}\n+     */\n+    @Nonnull\n+    public static BatchSource<String> elastic() {\n+        return elastic(ElasticClients::client);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Queries all indexes for all documents.\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    @Nonnull\n+    public static BatchSource<String> elastic(@Nonnull SupplierEx<RestHighLevelClient> clientSupplier) {\n+        return elastic(clientSupplier, SearchHit::getSourceAsString);\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    @Nonnull\n+    public static <T> BatchSource<T> elastic(@Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzM3OTg5OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODozMTozMVrOGTSG-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODozMTozMVrOGTSG-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg3MjgyNw==", "bodyText": "mapToItemFn", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422872827", "createdAt": "2020-05-11T08:31:31Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSources.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sources.\n+ * Alternatively you can use {@link ElasticSourceBuilder}\n+ *\n+ * @since 4.1\n+ */\n+public final class ElasticSources {\n+\n+    private ElasticSources() {\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * <p>\n+     * Useful for quick prototyping. See other methods {@link #elastic(SupplierEx, SupplierEx, FunctionEx)}\n+     * and {@link #builder()}\n+     */\n+    @Nonnull\n+    public static BatchSource<String> elastic() {\n+        return elastic(ElasticClients::client);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Queries all indexes for all documents.\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    @Nonnull\n+    public static BatchSource<String> elastic(@Nonnull SupplierEx<RestHighLevelClient> clientSupplier) {\n+        return elastic(clientSupplier, SearchHit::getSourceAsString);\n+    }\n+\n+    /**\n+     * Creates a source which queries local instance of Elasticsearch for all documents\n+     * Uses {@link SearchHit#getSourceAsString()} as mapping function\n+     */\n+    @Nonnull\n+    public static <T> BatchSource<T> elastic(@Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {\n+        return elastic(ElasticClients::client, mapHitFn);\n+    }\n+\n+    /**\n+     * Creates a source which queries Elasticsearch using client obtained from {@link RestHighLevelClient} supplier.\n+     * Uses provided mapHitFn to map results.\n+     * Queries all indexes for all documents.\n+     *\n+     * @param clientSupplier RestHighLevelClient supplier\n+     * @param mapHitFn       supplier of a function mapping the result from SearchHit to a result type\n+     * @param <T>            result type returned by the map function\n+     */\n+    @Nonnull\n+    public static <T> BatchSource<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull FunctionEx<? super SearchHit, T> mapHitFn) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzM4MTExOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinks.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODozMTo1NFrOGTSHwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODozMTo1NFrOGTSHwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg3MzAyNA==", "bodyText": "mapToRequestFn", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422873024", "createdAt": "2020-05-11T08:31:54Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinks.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sinks.\n+ * Alternatively you can use {@link ElasticSinkBuilder}\n+ *\n+ * @since 4.1\n+ */\n+public final class ElasticSinks {\n+\n+    private ElasticSinks() {\n+    }\n+\n+    /**\n+     * Creates an Elasticsearch sink, uses a local instance of Elasticsearch\n+     *\n+     * @param mapItemFn function that maps items from a stream to an indexing request\n+     */\n+    @Nonnull\n+    public static <T> Sink<T> elastic(@Nonnull FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn) {\n+        return elastic(ElasticClients::client, mapItemFn);\n+    }\n+\n+    /**\n+     * Creates an Elasticsearch sink, uses provided clientSupplier and mapItemFn\n+     *\n+     * @param clientSupplier client supplier\n+     * @param mapItemFn      function that maps items from a stream to an indexing request\n+     * @param <T>            type of incoming items\n+     */\n+    @Nonnull\n+    public static <T> Sink<T> elastic(\n+            @Nonnull SupplierEx<RestHighLevelClient> clientSupplier,\n+            @Nonnull FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzM4MTg4OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinks.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODozMjowMlrOGTSIJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODozMjowMlrOGTSIJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg3MzEyNA==", "bodyText": "mapToRequestFn", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422873124", "createdAt": "2020-05-11T08:32:02Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinks.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sinks.\n+ * Alternatively you can use {@link ElasticSinkBuilder}\n+ *\n+ * @since 4.1\n+ */\n+public final class ElasticSinks {\n+\n+    private ElasticSinks() {\n+    }\n+\n+    /**\n+     * Creates an Elasticsearch sink, uses a local instance of Elasticsearch\n+     *\n+     * @param mapItemFn function that maps items from a stream to an indexing request\n+     */\n+    @Nonnull\n+    public static <T> Sink<T> elastic(@Nonnull FunctionEx<? super T, ? extends DocWriteRequest<?>> mapItemFn) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzM4MjY2OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinks.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODozMjoxOFrOGTSItA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODozMjoxOFrOGTSItA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg3MzI2OA==", "bodyText": "4.2", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422873268", "createdAt": "2020-05-11T08:32:18Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinks.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Provides factory methods for Elasticsearch sinks.\n+ * Alternatively you can use {@link ElasticSinkBuilder}\n+ *\n+ * @since 4.1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMzM4NTU4OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODozMjo1NVrOGTSKWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODozMjo1NVrOGTSKWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg3MzY4OA==", "bodyText": "4.2", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r422873688", "createdAt": "2020-05-11T08:32:55Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.elastic.impl.ElasticSourcePMetaSupplier;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Sources;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkNonNullAndSerializable;\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch source which reads data from Elasticsearch and\n+ * converts SearchHits using provided {@code mapHitFn}\n+ *\n+ * Usage:\n+ * <pre>{@code\n+ * BatchSource<String> source = new ElasticSourceBuilder<String>()\n+ *   .clientSupplier(() -> client(host, port))\n+ *   .searchRequestSupplier(() -> new SearchRequest(\"my-index\"))\n+ *   .mapHitFn(SearchHit::getSourceAsString)\n+ *   .build();\n+ *\n+ * BatchStage<String> stage = p.readFrom(source);\n+ * }</pre>\n+ * @param <T> type of the output of the mapping function from {@link SearchHit} -> T\n+ * @since 4.1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNzk2NjkxOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/impl/ElasticSourcePTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwOTo0OToyNVrOGT-7dQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwOTo0OToyNVrOGT-7dQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYwNzE1Nw==", "bodyText": "Please update current naming in documentation and javadoc. ElasticsearchSourceBuilder -> ElasticSourceBuilder, ElasticsearchSinks -> ElasticSinks etc.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r423607157", "createdAt": "2020-05-12T09:49:25Z", "author": {"login": "olukas"}, "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/impl/ElasticSourcePTest.java", "diffHunk": "@@ -0,0 +1,336 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic.impl;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.jet.core.test.TestOutbox;\n+import com.hazelcast.jet.core.test.TestSupport;\n+import com.hazelcast.jet.elastic.ElasticSourceConfiguration;\n+import com.hazelcast.jet.elastic.impl.Shard.Prirep;\n+import org.apache.lucene.search.TotalHits;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.action.search.SearchScrollRequest;\n+import org.elasticsearch.client.Node;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RequestOptions.Builder;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestClientBuilder;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.common.bytes.BytesArray;\n+import org.elasticsearch.common.text.Text;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.SearchHits;\n+import org.elasticsearch.search.slice.SliceBuilder;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.ArgumentCaptor;\n+\n+import java.io.Serializable;\n+import java.util.Collection;\n+import java.util.List;\n+\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.emptyMap;\n+import static org.apache.lucene.search.TotalHits.Relation.EQUAL_TO;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.tuple;\n+import static org.assertj.core.util.Lists.newArrayList;\n+import static org.mockito.ArgumentCaptor.forClass;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.Mockito.RETURNS_DEEP_STUBS;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+\n+public class ElasticSourcePTest {\n+\n+    public static final String HIT_SOURCE = \"{\\\"name\\\": \\\"Frantisek\\\"}\";\n+    public static final String HIT_SOURCE2 = \"{\\\"name\\\": \\\"Vladimir\\\"}\";\n+    public static final String SCROLL_ID = \"random-scroll-id\";\n+\n+    private static final String KEEP_ALIVE = \"42m\";\n+\n+    private ElasticSourceP<String> processor;\n+    private SerializableRestClient mockClient;\n+    private SearchResponse response;\n+    private TestOutbox outbox;\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        mockClient = SerializableRestClient.instanceHolder = mock(SerializableRestClient.class, RETURNS_DEEP_STUBS);\n+        // Mocks returning mocks is not generally recommended, but the setup of empty SearchResponse is even uglier\n+        // See org.elasticsearch.action.search.SearchResponse#empty\n+        response = mock(SearchResponse.class);\n+        when(response.getScrollId()).thenReturn(SCROLL_ID);\n+        when(mockClient.search(any(), any())).thenReturn(response);\n+    }\n+\n+    private TestSupport runProcessor() throws Exception {\n+        return runProcessor(request -> RequestOptions.DEFAULT, emptyList(), false, false);\n+    }\n+\n+    private TestSupport runProcessor(FunctionEx<ActionRequest, RequestOptions> optionsFn) throws Exception {\n+        return runProcessor(optionsFn, emptyList(), false, false);\n+    }\n+\n+    private TestSupport runProcessorWithCoLocation(List<Shard> shards) throws Exception {\n+        return runProcessor(request -> RequestOptions.DEFAULT, shards, false, true);\n+    }\n+\n+    private TestSupport runProcessor(FunctionEx<ActionRequest, RequestOptions> optionsFn, List<Shard> shards,\n+                                     boolean slicing, boolean coLocatedReading)\n+            throws Exception {\n+\n+        RestHighLevelClient client = mockClient;\n+        ElasticSourceConfiguration<String> configuration = new ElasticSourceConfiguration<String>(\n+                () -> client,\n+                RestHighLevelClient::close,\n+                () -> new SearchRequest(\"*\"),\n+                optionsFn,\n+                SearchHit::getSourceAsString,\n+                slicing,\n+                coLocatedReading,\n+                KEEP_ALIVE,\n+                2\n+        );\n+\n+        // This constructor calls the client so it has to be called after specific mock setup in each test method\n+        // rather than in setUp()\n+        processor = new ElasticSourceP<>(configuration, shards);\n+\n+        return TestSupport.verifyProcessor(() -> processor)\n+                .disableSnapshots();\n+    }\n+\n+    @Test\n+    public void when_runProcessor_then_executeSearchRequestWithScroll() throws Exception {\n+        when(response.getHits()).thenReturn(new SearchHits(new SearchHit[]{}, new TotalHits(0, EQUAL_TO), Float.NaN));\n+\n+        TestSupport support = runProcessor();\n+\n+        support.expectOutput(emptyList());\n+\n+        ArgumentCaptor<SearchRequest> captor = forClass(SearchRequest.class);\n+        verify(mockClient).search(captor.capture(), any());\n+\n+        SearchRequest request = captor.getValue();\n+        assertThat(request.scroll().keepAlive().getStringRep()).isEqualTo(KEEP_ALIVE);\n+    }\n+\n+    @Test\n+    public void when_runProcessorWithOptionsFn_then_shouldUseOptionsFnForSearchRequest() throws Exception {\n+        when(response.getHits()).thenReturn(new SearchHits(new SearchHit[]{}, new TotalHits(0, EQUAL_TO), Float.NaN));\n+\n+        // get different instance than default\n+        TestSupport testSupport = runProcessor(request -> {\n+            Builder builder = RequestOptions.DEFAULT.toBuilder();\n+            builder.addHeader(\"TestHeader\", \"value\");\n+            return builder.build();\n+        });\n+\n+        testSupport.expectOutput(emptyList());\n+\n+        ArgumentCaptor<RequestOptions> captor = forClass(RequestOptions.class);\n+        verify(mockClient).search(any(), captor.capture());\n+\n+        RequestOptions capturedOptions = captor.getValue();\n+        assertThat(capturedOptions.getHeaders())\n+                .extracting(h -> tuple(h.getName(), h.getValue()))\n+                .containsExactly(tuple(\"TestHeader\", \"value\"));\n+    }\n+\n+    @Test\n+    public void given_singleHit_when_runProcessor_then_produceSingleHit() throws Exception {\n+        SearchHit hit = new SearchHit(0, \"id-0\", new Text(\"ignored\"), emptyMap());\n+        hit.sourceRef(new BytesArray(HIT_SOURCE));\n+        when(response.getHits()).thenReturn(new SearchHits(new SearchHit[]{hit}, new TotalHits(1, EQUAL_TO), Float.NaN));\n+\n+        SearchResponse response2 = mock(SearchResponse.class);\n+        when(response2.getHits()).thenReturn(new SearchHits(new SearchHit[]{}, new TotalHits(1, EQUAL_TO), Float.NaN));\n+        when(mockClient.scroll(any(), any())).thenReturn(response2);\n+\n+        TestSupport testSupport = runProcessor();\n+\n+        testSupport.expectOutput(newArrayList(HIT_SOURCE));\n+    }\n+\n+    @Test\n+    public void givenMultipleResults_when_runProcessor_then_useScrollIdInFollowupScrollRequest() throws Exception {\n+        SearchHit hit = new SearchHit(0, \"id-0\", new Text(\"ignored\"), emptyMap());\n+        hit.sourceRef(new BytesArray(HIT_SOURCE));\n+        when(response.getHits()).thenReturn(new SearchHits(new SearchHit[]{hit}, new TotalHits(3, EQUAL_TO), Float.NaN));\n+\n+        SearchResponse response2 = mock(SearchResponse.class);\n+        SearchHit hit2 = new SearchHit(1, \"id-1\", new Text(\"ignored\"), emptyMap());\n+        hit2.sourceRef(new BytesArray(HIT_SOURCE2));\n+        when(response2.getHits()).thenReturn(new SearchHits(new SearchHit[]{hit2}, new TotalHits(3, EQUAL_TO), Float.NaN));\n+\n+        SearchResponse response3 = mock(SearchResponse.class);\n+        when(response3.getHits()).thenReturn(new SearchHits(new SearchHit[]{}, new TotalHits(3, EQUAL_TO), Float.NaN));\n+        when(mockClient.scroll(any(), any())).thenReturn(response2, response3);\n+\n+        TestSupport testSupport = runProcessor();\n+\n+        testSupport.expectOutput(newArrayList(HIT_SOURCE, HIT_SOURCE2));\n+\n+        ArgumentCaptor<SearchScrollRequest> captor = forClass(SearchScrollRequest.class);\n+\n+        verify(mockClient, times(2)).scroll(captor.capture(), any());\n+        SearchScrollRequest request = captor.getValue();\n+        assertThat(request.scrollId()).isEqualTo(SCROLL_ID);\n+        assertThat(request.scroll().keepAlive().getStringRep()).isEqualTo(KEEP_ALIVE);\n+    }\n+\n+    @Test\n+    public void when_runProcessorWithOptionsFn_then_shouldUseOptionsFnForScrollRequest() throws Exception {\n+        SearchHit hit = new SearchHit(0, \"id-0\", new Text(\"ignored\"), emptyMap());\n+        hit.sourceRef(new BytesArray(HIT_SOURCE));\n+        when(response.getHits()).thenReturn(new SearchHits(new SearchHit[]{hit}, new TotalHits(1, EQUAL_TO), Float.NaN));\n+\n+        SearchResponse response2 = mock(SearchResponse.class);\n+        when(response2.getHits()).thenReturn(new SearchHits(new SearchHit[]{}, new TotalHits(1, EQUAL_TO), Float.NaN));\n+        when(mockClient.scroll(any(), any())).thenReturn(response2);\n+\n+        // get different instance than default\n+        TestSupport testSupport = runProcessor(request -> {\n+            Builder builder = RequestOptions.DEFAULT.toBuilder();\n+            builder.addHeader(\"TestHeader\", \"value\");\n+            return builder.build();\n+        });\n+\n+        testSupport.expectOutput(newArrayList(HIT_SOURCE));\n+\n+        ArgumentCaptor<RequestOptions> captor = forClass(RequestOptions.class);\n+        verify(mockClient).scroll(any(), captor.capture());\n+\n+        RequestOptions capturedOptions = captor.getValue();\n+        assertThat(capturedOptions.getHeaders())\n+                .extracting(h -> tuple(h.getName(), h.getValue()))\n+                .containsExactly(tuple(\"TestHeader\", \"value\"));\n+    }\n+\n+    @Test\n+    public void when_runProcessorWithCoLocation_then_useLocalNodeOnly() throws Exception {\n+        RestClient lowClient = mock(RestClient.class);\n+        when(mockClient.getLowLevelClient()).thenReturn(lowClient);\n+        when(response.getHits()).thenReturn(new SearchHits(new SearchHit[]{}, new TotalHits(0, EQUAL_TO), Float.NaN));\n+\n+        TestSupport testSupport = runProcessorWithCoLocation(newArrayList(\n+                new Shard(\"my-index\", 0, Prirep.p, 42, \"STARTED\", \"10.0.0.1\", \"10.0.0.1:9200\", \"es1\")\n+        ));\n+        testSupport.expectOutput(emptyList());\n+\n+        ArgumentCaptor<Collection<Node>> nodesCaptor = ArgumentCaptor.forClass(Collection.class);\n+\n+        verify(lowClient).setNodes(nodesCaptor.capture());\n+\n+        Collection<Node> nodes = nodesCaptor.getValue();\n+        assertThat(nodes).hasSize(1);\n+\n+        Node node = nodes.iterator().next();\n+        assertThat(node.getHost().toHostString()).isEqualTo(\"10.0.0.1:9200\");\n+    }\n+\n+    @Test\n+    public void when_runProcessorWithCoLocation_thenSearchShardsWithPreference() throws Exception {\n+        when(response.getHits()).thenReturn(new SearchHits(new SearchHit[]{}, new TotalHits(0, EQUAL_TO), Float.NaN));\n+\n+        TestSupport processor = runProcessorWithCoLocation(newArrayList(\n+                new Shard(\"my-index\", 0, Prirep.p, 42, \"STARTED\", \"10.0.0.1\", \"10.0.0.1:9200\", \"es1\"),\n+                new Shard(\"my-index\", 1, Prirep.p, 42, \"STARTED\", \"10.0.0.1\", \"10.0.0.1:9200\", \"es1\"),\n+                new Shard(\"my-index\", 2, Prirep.p, 42, \"STARTED\", \"10.0.0.1\", \"10.0.0.1:9200\", \"es1\")\n+        ));\n+        processor.expectOutput(emptyList());\n+\n+        ArgumentCaptor<SearchRequest> captor = forClass(SearchRequest.class);\n+        verify(mockClient).search(captor.capture(), any());\n+\n+        SearchRequest request = captor.getValue();\n+        assertThat(request.preference()).isEqualTo(\"_shards:0,1,2|_only_local\");\n+    }\n+\n+    @Test\n+    public void when_runProcessorWithParallelism_thenUseSlicingBasedOnGlobalValues() throws Exception {\n+        when(response.getHits()).thenReturn(new SearchHits(new SearchHit[]{}, new TotalHits(0, EQUAL_TO), Float.NaN));\n+\n+        TestSupport testSupport = runProcessor((r) -> RequestOptions.DEFAULT, emptyList(), true, false);\n+        testSupport.localProcessorIndex(1);\n+        testSupport.localParallelism(2);\n+        testSupport.globalProcessorIndex(4);\n+        testSupport.totalParallelism(6);\n+        testSupport.expectOutput(emptyList());\n+\n+        ArgumentCaptor<SearchRequest> captor = forClass(SearchRequest.class);\n+        verify(mockClient).search(captor.capture(), any());\n+\n+        SearchRequest request = captor.getValue();\n+        SliceBuilder slice = request.source().slice();\n+\n+        // Slicing across all, should use global index / total parallelism\n+        assertThat(slice.getId()).isEqualTo(4);\n+        assertThat(slice.getMax()).isEqualTo(6);\n+    }\n+\n+    @Test\n+    public void when_runProcessorWithCoLocationAndSlicing_thenUseSlicingBasedOnLocalValues() throws Exception {\n+        when(response.getHits()).thenReturn(new SearchHits(new SearchHit[]{}, new TotalHits(0, EQUAL_TO), Float.NaN));\n+\n+        TestSupport testSupport = runProcessor((r) -> RequestOptions.DEFAULT,\n+                newArrayList(\n+                        new Shard(\"my-index\", 0, Prirep.p, 42, \"STARTED\", \"10.0.0.1\", \"10.0.0.1:9200\", \"es1\"),\n+                        new Shard(\"my-index\", 1, Prirep.p, 42, \"STARTED\", \"10.0.0.1\", \"10.0.0.1:9200\", \"es1\"),\n+                        new Shard(\"my-index\", 2, Prirep.p, 42, \"STARTED\", \"10.0.0.1\", \"10.0.0.1:9200\", \"es1\")\n+                ),\n+                true, true);\n+        testSupport.localProcessorIndex(1);\n+        testSupport.localParallelism(2);\n+        testSupport.globalProcessorIndex(4);\n+        testSupport.totalParallelism(6);\n+        testSupport.expectOutput(emptyList());\n+\n+        ArgumentCaptor<SearchRequest> captor = forClass(SearchRequest.class);\n+        verify(mockClient).search(captor.capture(), any());\n+\n+        SearchRequest request = captor.getValue();\n+        SliceBuilder slice = request.source().slice();\n+\n+        // Slicing across single node, should use local values\n+        assertThat(slice.getId()).isEqualTo(1);\n+        assertThat(slice.getMax()).isEqualTo(2);\n+    }\n+\n+    /*\n+     * Need to pass a Serializable Supplier into\n+     * ElasticsearchSourceBuilder.clientSupplier(...)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 322}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNzk3NDkyOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwOTo1MToyMlrOGT_AYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwOTo1MToyMlrOGT_AYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYwODQxOQ==", "bodyText": "We should document which builder's methods are required", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r423608419", "createdAt": "2020-05-12T09:51:22Z", "author": {"login": "olukas"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.elastic.impl.ElasticSourcePMetaSupplier;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Sources;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkNonNullAndSerializable;\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch source which reads data from Elasticsearch and\n+ * converts SearchHits using provided {@code mapHitFn}\n+ *\n+ * Usage:\n+ * <pre>{@code\n+ * BatchSource<String> source = new ElasticSourceBuilder<String>()\n+ *   .clientSupplier(() -> client(host, port))\n+ *   .searchRequestSupplier(() -> new SearchRequest(\"my-index\"))\n+ *   .mapHitFn(SearchHit::getSourceAsString)\n+ *   .build();\n+ *\n+ * BatchStage<String> stage = p.readFrom(source);\n+ * }</pre>\n+ * @param <T> type of the output of the mapping function from {@link SearchHit} -> T\n+ * @since 4.1\n+ */\n+public class ElasticSourceBuilder<T> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNzk4MzQ4OnYy", "diffSide": "RIGHT", "path": "site/docs/api/sources-sinks.md", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwOTo1Mzo1NFrOGT_F7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwOTo1Mzo1NFrOGT_F7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYwOTgzOA==", "bodyText": "* is missing for items to have them displayed as list of items.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r423609838", "createdAt": "2020-05-12T09:53:54Z", "author": {"login": "olukas"}, "path": "site/docs/api/sources-sinks.md", "diffHunk": "@@ -949,6 +949,99 @@ tests](https://github.com/hazelcast/hazelcast-jet-contrib/tree/master/xa-test)\n to get more information. This only applies to the JDBC sink, the source\n doesn't use XA transactions.\n \n+### Elasticsearch\n+\n+Elasticsearch is a popular fulltext search engine. Hazelcast Jet can\n+use it both as a source and a sink.\n+\n+#### Source\n+\n+The Elasticsearch connector source provides a builder and several\n+convenience factory methods. Most commonly one needs to provide:\n+\n+* A client supplier, which returns a configured instance of\n+ RestHighLevelClient (see [Elasticsearch documentation](https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high.html)),\n+* A search request supplier specifying a query to Elasticsearch,\n+* A mapping function from `SearchHit` to a desired type.\n+\n+Example using a factory method:\n+\n+```java\n+BatchSource<String> source = ElasticsearchSources.elasticsearch(\n+    () -> client(\"user\", \"password\", \"host\", 9200),\n+    () -> new SearchRequest(\"my-index\"),\n+    hit -> (String) hit.getSourceAsMap().get(\"name\")\n+);\n+```\n+\n+For all configuration options use the builder:\n+\n+```java\n+BatchSource<String> elasticsearch = new ElasticsearchSourceBuilder<String>()\n+        .name(\"elastic-source\")\n+        .clientSupplier(() -> new RestHighLevelClient(RestClient.builder(new HttpHost(\n+                \"localhost\", 9200\n+        ))))\n+        .destroyFn(RestHighLevelClient::close)\n+        .searchRequestSupplier(() -> new SearchRequest(\"my-index\"))\n+        .optionsFn(request -> RequestOptions.DEFAULT)\n+        .mapHitFn(hit -> hit.getSourceAsString())\n+        .slicing(true)\n+        .build();\n+```\n+\n+By default, the connector uses a single scroll to read data from\n+Elasticsearch - there is only a single reader on a single node in the\n+whole cluster.\n+\n+Slicing can be used to parallelize reading from an index with more\n+shards. Number of slices equals to globalParallelism.\n+\n+If Hazelcast Jet nodes and Elasticsearch nodes are located on the same\n+machines then the connector will use co-located reading, avoiding the\n+overhead of physical network.\n+\n+#### Sink\n+\n+The Elasticsearch connector sink provides a builder and several\n+convenience factory methods. Most commonly you need to provide:\n+\n+A client supplier, which returns a configured instance of", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNzk4NTk3OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/BaseElasticTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwOTo1NDozN1rOGT_Hkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwOTo1NDozN1rOGT_Hkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxMDI1OA==", "bodyText": "leftover?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r423610258", "createdAt": "2020-05-12T09:54:37Z", "author": {"login": "olukas"}, "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/BaseElasticTest.java", "diffHunk": "@@ -0,0 +1,208 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.collection.IList;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.Job;\n+import com.hazelcast.jet.config.JobConfig;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.test.HazelcastSerialClassRunner;\n+import org.elasticsearch.action.admin.indices.delete.DeleteIndexRequest;\n+import org.elasticsearch.action.bulk.BulkItemResponse;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.WriteRequest.RefreshPolicy;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.client.indices.CreateIndexRequest;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.index.reindex.DeleteByQueryRequest;\n+import org.junit.Before;\n+import org.junit.runner.RunWith;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import static com.google.common.collect.ImmutableMap.of;\n+import static org.assertj.core.util.Lists.newArrayList;\n+import static org.elasticsearch.client.RequestOptions.DEFAULT;\n+import static org.elasticsearch.index.query.QueryBuilders.matchAllQuery;\n+\n+/**\n+ * Base class for running Elasticsearch connector tests\n+ *\n+ * To use implement:\n+ * - {@link #elasticClientSupplier()}\n+ * - {@link #createJetInstance()}\n+ * Subclasses are free to cache\n+ */\n+@RunWith(HazelcastSerialClassRunner.class)\n+public abstract class BaseElasticTest {\n+\n+    protected static final int BATCH_SIZE = 42;\n+\n+    protected RestHighLevelClient elasticClient;\n+    protected JetInstance jet;\n+    protected IList<String> results;\n+\n+    @Before\n+    public void setUpBase() {\n+        if (elasticClient == null) {\n+            elasticClient = elasticClientSupplier().get();\n+        }\n+        cleanElasticData();\n+\n+        if (jet == null) {\n+            jet = createJetInstance();\n+        }\n+        results = jet.getList(\"results\");\n+        results.clear();\n+    }\n+\n+    /**\n+     * RestHighLevelClient supplier, it is used to\n+     * - create a client before each test for use by all methods from this class interacting with elastic\n+     * - may be used as as a parameter of {@link ElasticSourceBuilder#clientSupplier(SupplierEx)}\n+     */\n+    protected SupplierEx<RestHighLevelClient> elasticClientSupplier() {\n+        return ElasticSupport.elasticClientSupplier();\n+    };\n+\n+    protected abstract JetInstance createJetInstance();\n+\n+    /**\n+     * Creates an index with given name with 3 shards\n+     */\n+    protected void initShardedIndex(String index) throws IOException {\n+        createShardedIndex(index, 3, 0);\n+        indexBatchOfDocuments(index);\n+    }\n+\n+    /**\n+     * Creates an index with given name with 3 shards\n+     */\n+    protected void createShardedIndex(String index, int shards, int replicas) throws IOException {\n+        CreateIndexRequest indexRequest = new CreateIndexRequest(index);\n+        indexRequest.settings(Settings.builder()\n+                                      .put(\"index.unassigned.node_left.delayed_timeout\", \"1s\")\n+                                      .put(\"index.number_of_shards\", shards)\n+                                      .put(\"index.number_of_replicas\", replicas)\n+        );\n+\n+        elasticClient.indices().create(indexRequest, RequestOptions.DEFAULT);\n+    }\n+\n+    /**\n+     * Deletes all documents in all indexes and drops all indexes\n+     */\n+    protected void cleanElasticData() {\n+        try {\n+//            deleteDocuments();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 121}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNzk4Njg2OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/CommonElasticSourcesTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwOTo1NDo1MVrOGT_IIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMjo1Mjo0OFrOGUFEOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxMDQwMQ==", "bodyText": "leftover?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r423610401", "createdAt": "2020-05-12T09:54:51Z", "author": {"login": "olukas"}, "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/CommonElasticSourcesTest.java", "diffHunk": "@@ -0,0 +1,261 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.jet.pipeline.Sinks;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.index.query.QueryBuilders;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+\n+import static com.google.common.collect.ImmutableMap.of;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.elasticsearch.index.query.QueryBuilders.matchAllQuery;\n+\n+/**\n+ * Base class for Elasticsearch source tests\n+ * <p>\n+ * This class is to be extended for each type of environment to run on, e.g.\n+ * - simple 1 node Jet & Elastic instances\n+ * - co-located clusters of Jet and Elastic\n+ * - non co-located clusters of Jet and Elastic\n+ * <p>\n+ * Subclasses may add tests specific for particular type of environment.\n+ * <p>\n+ * RestHighLevelClient is used to create data in Elastic to isolate possible Source and Sink issues.\n+ */\n+public abstract class CommonElasticSourcesTest extends BaseElasticTest {\n+\n+    @Test\n+    public void given_emptyIndex_when_readFromElasticSource_then_finishWithNoResults() throws IOException {\n+        // elasticClient.indices().create(new CreateIndexRequest(\"my-index\"), DEFAULT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzcwNzcwNA==", "bodyText": "No, this is what should be done, but there is some weirdness, explained below - moving a comment above to be more clear.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r423707704", "createdAt": "2020-05-12T12:52:48Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/CommonElasticSourcesTest.java", "diffHunk": "@@ -0,0 +1,261 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.jet.pipeline.Sinks;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.index.query.QueryBuilders;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.junit.Test;\n+\n+import java.io.IOException;\n+\n+import static com.google.common.collect.ImmutableMap.of;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.elasticsearch.index.query.QueryBuilders.matchAllQuery;\n+\n+/**\n+ * Base class for Elasticsearch source tests\n+ * <p>\n+ * This class is to be extended for each type of environment to run on, e.g.\n+ * - simple 1 node Jet & Elastic instances\n+ * - co-located clusters of Jet and Elastic\n+ * - non co-located clusters of Jet and Elastic\n+ * <p>\n+ * Subclasses may add tests specific for particular type of environment.\n+ * <p>\n+ * RestHighLevelClient is used to create data in Elastic to isolate possible Source and Sink issues.\n+ */\n+public abstract class CommonElasticSourcesTest extends BaseElasticTest {\n+\n+    @Test\n+    public void given_emptyIndex_when_readFromElasticSource_then_finishWithNoResults() throws IOException {\n+        // elasticClient.indices().create(new CreateIndexRequest(\"my-index\"), DEFAULT);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxMDQwMQ=="}, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNzk5MjY4OnYy", "diffSide": "RIGHT", "path": "examples/elastic/src/main/java/com/hazelcast/jet/examples/elastic/ElasticSinkExample.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwOTo1NjozNFrOGT_L7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwOTo1NjozNFrOGT_L7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxMTM3Mw==", "bodyText": "I suggest to use factory method with all possible parameters - i.e. also with client supplier.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r423611373", "createdAt": "2020-05-12T09:56:34Z", "author": {"login": "olukas"}, "path": "examples/elastic/src/main/java/com/hazelcast/jet/examples/elastic/ElasticSinkExample.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.examples.elastic;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.hazelcast.jet.Jet;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.core.processor.SourceProcessors;\n+import com.hazelcast.jet.elastic.ElasticSinks;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.jet.pipeline.ServiceFactories;\n+import com.hazelcast.jet.pipeline.ServiceFactory;\n+import org.elasticsearch.action.index.IndexRequest;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.util.Map;\n+import java.util.stream.Stream;\n+\n+import static com.hazelcast.jet.pipeline.Pipeline.create;\n+import static com.hazelcast.jet.pipeline.Sources.batchFromProcessor;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+public class ElasticSinkExample {\n+\n+    public static void main(String[] args) {\n+        try {\n+            ServiceFactory<?, ObjectMapper> service = ServiceFactories.sharedService((context) -> new ObjectMapper());\n+\n+            Pipeline p = create();\n+            p.readFrom(files(\"src/main/resources/documents\"))\n+             .mapUsingService(service, (mapper, json) -> mapper.readValue(json, new TypeReference<Map<String, Object>>() {\n+             }))\n+             .writeTo(ElasticSinks.elastic(map ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzODAwMjg5OnYy", "diffSide": "RIGHT", "path": "examples/elastic/src/main/java/com/hazelcast/jet/examples/elastic/ElasticSinkExample.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwOTo1OToyM1rOGT_SVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNzowMzoyMFrOGUQZRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxMzAxNA==", "bodyText": "Why we do not rather use something from Jet? e.g. Sources.files", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r423613014", "createdAt": "2020-05-12T09:59:23Z", "author": {"login": "olukas"}, "path": "examples/elastic/src/main/java/com/hazelcast/jet/examples/elastic/ElasticSinkExample.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.examples.elastic;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.hazelcast.jet.Jet;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.core.processor.SourceProcessors;\n+import com.hazelcast.jet.elastic.ElasticSinks;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.jet.pipeline.ServiceFactories;\n+import com.hazelcast.jet.pipeline.ServiceFactory;\n+import org.elasticsearch.action.index.IndexRequest;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.util.Map;\n+import java.util.stream.Stream;\n+\n+import static com.hazelcast.jet.pipeline.Pipeline.create;\n+import static com.hazelcast.jet.pipeline.Sources.batchFromProcessor;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+public class ElasticSinkExample {\n+\n+    public static void main(String[] args) {\n+        try {\n+            ServiceFactory<?, ObjectMapper> service = ServiceFactories.sharedService((context) -> new ObjectMapper());\n+\n+            Pipeline p = create();\n+            p.readFrom(files(\"src/main/resources/documents\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzcxMTUyMA==", "bodyText": "Sources.files reads files as lines, this reads a whole file (= json document) as one item.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r423711520", "createdAt": "2020-05-12T12:58:38Z", "author": {"login": "frant-hartm"}, "path": "examples/elastic/src/main/java/com/hazelcast/jet/examples/elastic/ElasticSinkExample.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.examples.elastic;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.hazelcast.jet.Jet;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.core.processor.SourceProcessors;\n+import com.hazelcast.jet.elastic.ElasticSinks;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.jet.pipeline.ServiceFactories;\n+import com.hazelcast.jet.pipeline.ServiceFactory;\n+import org.elasticsearch.action.index.IndexRequest;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.util.Map;\n+import java.util.stream.Stream;\n+\n+import static com.hazelcast.jet.pipeline.Pipeline.create;\n+import static com.hazelcast.jet.pipeline.Sources.batchFromProcessor;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+public class ElasticSinkExample {\n+\n+    public static void main(String[] args) {\n+        try {\n+            ServiceFactory<?, ObjectMapper> service = ServiceFactories.sharedService((context) -> new ObjectMapper());\n+\n+            Pipeline p = create();\n+            p.readFrom(files(\"src/main/resources/documents\"))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxMzAxNA=="}, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzg5MzMxOQ==", "bodyText": "you can now read json files with Sources.json, as you've said it is treating each line as a json string. For json strings spanning multiple lines we've added an option too, you can use filesBuilder and JsonUtil.asMultilineJson to create the source. But it is trying to map the json to an object type. we can add an overload which parses json strings to Map<String, Object> maybe", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r423893319", "createdAt": "2020-05-12T17:03:20Z", "author": {"login": "gurbuzali"}, "path": "examples/elastic/src/main/java/com/hazelcast/jet/examples/elastic/ElasticSinkExample.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.examples.elastic;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.hazelcast.jet.Jet;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.core.processor.SourceProcessors;\n+import com.hazelcast.jet.elastic.ElasticSinks;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.jet.pipeline.ServiceFactories;\n+import com.hazelcast.jet.pipeline.ServiceFactory;\n+import org.elasticsearch.action.index.IndexRequest;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.util.Map;\n+import java.util.stream.Stream;\n+\n+import static com.hazelcast.jet.pipeline.Pipeline.create;\n+import static com.hazelcast.jet.pipeline.Sources.batchFromProcessor;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+public class ElasticSinkExample {\n+\n+    public static void main(String[] args) {\n+        try {\n+            ServiceFactory<?, ObjectMapper> service = ServiceFactories.sharedService((context) -> new ObjectMapper());\n+\n+            Pipeline p = create();\n+            p.readFrom(files(\"src/main/resources/documents\"))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxMzAxNA=="}, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzODAwNzgwOnYy", "diffSide": "RIGHT", "path": "examples/elastic/src/main/java/com/hazelcast/jet/examples/elastic/ElasticSourceExample.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMDowMDo0MFrOGT_VZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMDowMDo0MFrOGT_VZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxMzc5Nw==", "bodyText": "please remove one of two empty lines", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r423613797", "createdAt": "2020-05-12T10:00:40Z", "author": {"login": "olukas"}, "path": "examples/elastic/src/main/java/com/hazelcast/jet/examples/elastic/ElasticSourceExample.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzODAxMTYyOnYy", "diffSide": "RIGHT", "path": "examples/elastic/src/main/java/com/hazelcast/jet/examples/elastic/ElasticSourceExample.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMDowMTo0NlrOGT_X2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMDowMTo0NlrOGT_X2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxNDQyNA==", "bodyText": "I suggest to use factory method with all possible parameters - i.e. also with client supplier and search request supplier.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r423614424", "createdAt": "2020-05-12T10:01:46Z", "author": {"login": "olukas"}, "path": "examples/elastic/src/main/java/com/hazelcast/jet/examples/elastic/ElasticSourceExample.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+\n+package com.hazelcast.jet.examples.elastic;\n+\n+import com.hazelcast.jet.Jet;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.Observable;\n+import com.hazelcast.jet.datamodel.Tuple2;\n+import com.hazelcast.jet.elastic.ElasticSources;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.jet.pipeline.Sinks;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+\n+import static com.hazelcast.jet.aggregate.AggregateOperations.mapping;\n+import static com.hazelcast.jet.aggregate.AggregateOperations.toList;\n+import static com.hazelcast.jet.datamodel.Tuple2.tuple2;\n+import static com.hazelcast.jet.pipeline.Pipeline.create;\n+\n+public class ElasticSourceExample {\n+\n+    private static final String ROLES_OBSERVABLE = \"roles\";\n+\n+    public static void main(String[] args) {\n+        try {\n+            Pipeline p = create();\n+            BatchSource<Tuple2<String, String>> elasticsearch = ElasticSources.elastic(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzODAyOTc1OnYy", "diffSide": "RIGHT", "path": "examples/elastic/src/main/java/com/hazelcast/jet/examples/elastic/ElasticSourceExample.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMDowNzowOFrOGT_jsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNjowMDoyM1rOGUigqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxNzQ1Nw==", "bodyText": "I suggest to prepare (and document) elastic code samples in form:\n\nrun empty elasticsearch\nrun ElasticSinkExample - it will store data to elastic\nrun ElasticSourceExample - it will read previously provided data from elastic and show them to user (through Observable or Sinks.logger)", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r423617457", "createdAt": "2020-05-12T10:07:08Z", "author": {"login": "olukas"}, "path": "examples/elastic/src/main/java/com/hazelcast/jet/examples/elastic/ElasticSourceExample.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+\n+package com.hazelcast.jet.examples.elastic;\n+\n+import com.hazelcast.jet.Jet;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.Observable;\n+import com.hazelcast.jet.datamodel.Tuple2;\n+import com.hazelcast.jet.elastic.ElasticSources;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.jet.pipeline.Sinks;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+\n+import static com.hazelcast.jet.aggregate.AggregateOperations.mapping;\n+import static com.hazelcast.jet.aggregate.AggregateOperations.toList;\n+import static com.hazelcast.jet.datamodel.Tuple2.tuple2;\n+import static com.hazelcast.jet.pipeline.Pipeline.create;\n+\n+public class ElasticSourceExample {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAzODc3Mw==", "bodyText": "Yeah, good idea. this is how I run the demo. Do you mean somewhere in the example module (as readme) or as how to guide on the website?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r424038773", "createdAt": "2020-05-12T21:16:39Z", "author": {"login": "frant-hartm"}, "path": "examples/elastic/src/main/java/com/hazelcast/jet/examples/elastic/ElasticSourceExample.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+\n+package com.hazelcast.jet.examples.elastic;\n+\n+import com.hazelcast.jet.Jet;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.Observable;\n+import com.hazelcast.jet.datamodel.Tuple2;\n+import com.hazelcast.jet.elastic.ElasticSources;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.jet.pipeline.Sinks;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+\n+import static com.hazelcast.jet.aggregate.AggregateOperations.mapping;\n+import static com.hazelcast.jet.aggregate.AggregateOperations.toList;\n+import static com.hazelcast.jet.datamodel.Tuple2.tuple2;\n+import static com.hazelcast.jet.pipeline.Pipeline.create;\n+\n+public class ElasticSourceExample {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxNzQ1Nw=="}, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE5MDEyMA==", "bodyText": "Originally I thought it should be in javadoc for both example classes but it can be added to readme or website as well.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r424190120", "createdAt": "2020-05-13T06:00:23Z", "author": {"login": "olukas"}, "path": "examples/elastic/src/main/java/com/hazelcast/jet/examples/elastic/ElasticSourceExample.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+\n+package com.hazelcast.jet.examples.elastic;\n+\n+import com.hazelcast.jet.Jet;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.Observable;\n+import com.hazelcast.jet.datamodel.Tuple2;\n+import com.hazelcast.jet.elastic.ElasticSources;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.jet.pipeline.Sinks;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+\n+import static com.hazelcast.jet.aggregate.AggregateOperations.mapping;\n+import static com.hazelcast.jet.aggregate.AggregateOperations.toList;\n+import static com.hazelcast.jet.datamodel.Tuple2.tuple2;\n+import static com.hazelcast.jet.pipeline.Pipeline.create;\n+\n+public class ElasticSourceExample {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxNzQ1Nw=="}, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzODA0MzQ0OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMDoxMTowMVrOGT_sTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMDoxMTowMVrOGT_sTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYxOTY2MA==", "bodyText": "4.2", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r423619660", "createdAt": "2020-05-12T10:11:01Z", "author": {"login": "olukas"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "diffHunk": "@@ -0,0 +1,202 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import com.hazelcast.jet.pipeline.SinkBuilder;\n+import com.hazelcast.logging.ILogger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkNonNullAndSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch Sink\n+ * <p>\n+ * The Sink first maps items from the pipeline using the provided\n+ * {@link #mapItemFn(FunctionEx)} and then using {@link BulkRequest}.\n+ * <p>\n+ * {@link BulkRequest#BulkRequest()} is used by default, it can be\n+ * modified by providing custom {@link #bulkRequestSupplier(SupplierEx)}\n+ *\n+ * <p>\n+ * Usage:\n+ * <pre>{@code\n+ * Sink<Map<String, ?>> elasticSink = new ElasticSinkBuilder<Map<String, ?>>()\n+ *   .clientSupplier(() -> ElasticClients.client(host, port))\n+ *   .mapItemFn(item -> new IndexRequest(\"my-index\").source(item))\n+ *   .build();\n+ * }</pre>\n+ * <p>\n+ * Requires {@link #clientSupplier(SupplierEx)} and {@link #mapItemFn(FunctionEx)}.\n+ *\n+ * @param <T>\n+ * @since 4.1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzODA1MzE4OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMDoxMzo1M1rOGT_yrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMDoxMzo1M1rOGT_yrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYyMTI5Mg==", "bodyText": "should not it be rather elasticSink (and then elasticSource for ElasticSourceBuilder) to have different default values for them?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r423621292", "createdAt": "2020-05-12T10:13:53Z", "author": {"login": "olukas"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "diffHunk": "@@ -0,0 +1,202 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import com.hazelcast.jet.pipeline.SinkBuilder;\n+import com.hazelcast.logging.ILogger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkNonNullAndSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch Sink\n+ * <p>\n+ * The Sink first maps items from the pipeline using the provided\n+ * {@link #mapItemFn(FunctionEx)} and then using {@link BulkRequest}.\n+ * <p>\n+ * {@link BulkRequest#BulkRequest()} is used by default, it can be\n+ * modified by providing custom {@link #bulkRequestSupplier(SupplierEx)}\n+ *\n+ * <p>\n+ * Usage:\n+ * <pre>{@code\n+ * Sink<Map<String, ?>> elasticSink = new ElasticSinkBuilder<Map<String, ?>>()\n+ *   .clientSupplier(() -> ElasticClients.client(host, port))\n+ *   .mapItemFn(item -> new IndexRequest(\"my-index\").source(item))\n+ *   .build();\n+ * }</pre>\n+ * <p>\n+ * Requires {@link #clientSupplier(SupplierEx)} and {@link #mapItemFn(FunctionEx)}.\n+ *\n+ * @param <T>\n+ * @since 4.1\n+ */\n+public class ElasticSinkBuilder<T> implements Serializable {\n+\n+    private static final String DEFAULT_NAME = \"elastic\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzODA4NDg1OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceConfiguration.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMDoyMzozM1rOGUAGng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMzowMjoyNFrOGUFdLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYyNjM5OA==", "bodyText": "Is this part of public API? Javadoc is missing in the whole file.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r423626398", "createdAt": "2020-05-12T10:23:33Z", "author": {"login": "olukas"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceConfiguration.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import java.io.Serializable;\n+\n+public class ElasticSourceConfiguration<T> implements Serializable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzcxNDA5NQ==", "bodyText": "No it's not, moved to impl package.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r423714095", "createdAt": "2020-05-12T13:02:24Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceConfiguration.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.ConsumerEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+import java.io.Serializable;\n+\n+public class ElasticSourceConfiguration<T> implements Serializable {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYyNjM5OA=="}, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzODExNzc5OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/ElasticCatClient.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMDozMzowOFrOGUAbDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMDozMzowOFrOGUAbDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYzMTYzMQ==", "bodyText": "A lot of empty lines", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r423631631", "createdAt": "2020-05-12T10:33:08Z", "author": {"login": "olukas"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/ElasticCatClient.java", "diffHunk": "@@ -0,0 +1,262 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic.impl;\n+\n+import com.hazelcast.internal.json.Json;\n+import com.hazelcast.internal.json.JsonArray;\n+import com.hazelcast.internal.json.JsonObject;\n+import com.hazelcast.internal.json.JsonValue;\n+import com.hazelcast.jet.JetException;\n+import com.hazelcast.jet.elastic.impl.Shard.Prirep;\n+import com.hazelcast.logging.ILogger;\n+import com.hazelcast.logging.Logger;\n+import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.Response;\n+import org.elasticsearch.client.RestClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.Optional.empty;\n+import static java.util.Optional.of;\n+import static java.util.logging.Level.FINE;\n+import static java.util.stream.Collectors.toMap;\n+\n+/**\n+ * Wrapper around {@link RestClient} access for /_cat/* endpoints\n+ */\n+public class ElasticCatClient {\n+\n+    private static final ILogger LOG = Logger.getLogger(ElasticCatClient.class);\n+\n+    private final RestClient client;\n+\n+    public ElasticCatClient(RestClient client) {\n+        this.client = client;\n+    }\n+\n+    /**\n+     * Returns current master of the ES cluster\n+     */\n+    public Master master() {\n+        try {\n+            Request r = new Request(\"GET\", \"/_cat/master\");\n+            r.addParameter(\"format\", \"json\");\n+            Response res = client.performRequest(r);\n+\n+            try (InputStreamReader reader = new InputStreamReader(res.getEntity().getContent(), UTF_8)) {\n+                JsonArray array = Json.parse(reader).asArray();\n+                JsonObject object = array.get(0).asObject();\n+                return new Master(\n+                        object.get(\"host\").asString(),\n+                        object.get(\"id\").asString(),\n+                        object.get(\"ip\").asString(),\n+                        object.get(\"node\").asString()\n+                );\n+            }\n+        } catch (IOException e) {\n+            throw new JetException(\"Could not get ES cluster master\", e);\n+        }\n+    }\n+\n+    /**\n+     * Returns list of nodes currently in ES cluster\n+     */\n+    public List<Node> nodes() {\n+        try {\n+            Request r = new Request(\"GET\", \"/_cat/nodes\");\n+            r.addParameter(\"format\", \"json\");\n+            r.addParameter(\"h\", \"ip,name,http_address,master\");\n+            Response res = client.performRequest(r);\n+\n+            try (InputStreamReader reader = new InputStreamReader(res.getEntity().getContent(), UTF_8)) {\n+                JsonArray array = Json.parse(reader).asArray();\n+                List<Node> nodes = new ArrayList<>(array.size());\n+                for (JsonValue value : array) {\n+                    Optional<Node> shard = convertToNode(value);\n+                    shard.ifPresent(nodes::add);\n+                }\n+\n+                LOG.fine(\"Nodes: \" + nodes);\n+                return nodes;\n+            }\n+        } catch (IOException e) {\n+            throw new JetException(\"Could not get ES cluster nodes\", e);\n+        }\n+    }\n+\n+    private Optional<Node> convertToNode(JsonValue value) {\n+        JsonObject object = value.asObject();\n+        return of(new Node(\n+                object.get(\"ip\").asString(),\n+                object.get(\"name\").asString(),\n+                object.get(\"http_address\").asString(),\n+                object.get(\"master\").asString()\n+        ));\n+    }\n+\n+    /**\n+     * Returns list of shards for given indexes\n+     *\n+     * Only STARTED shards are returned.\n+     *\n+     * @param indices indexes to return shards for (wildcard format accepted)\n+     */\n+    @SuppressFBWarnings(\"RCN_REDUNDANT_NULLCHECK_WOULD_HAVE_BEEN_A_NPE\")\n+    public List<Shard> shards(String... indices) {\n+        Map<String, String> ipToAddress = nodes().stream().collect(toMap(Node::getIp, Node::getHttpAddress));\n+\n+        try {\n+            Request r = new Request(\"GET\", \"/_cat/shards/\" + String.join(\",\", indices));\n+            r.addParameter(\"format\", \"json\");\n+            Response res = client.performRequest(r);\n+\n+            try (InputStreamReader reader = new InputStreamReader(res.getEntity().getContent(), UTF_8)) {\n+                JsonArray array = Json.parse(reader).asArray();\n+                List<Shard> shards = new ArrayList<>(array.size());\n+                for (JsonValue value : array) {\n+                    Optional<Shard> shard = convertToShard(value, ipToAddress);\n+                    shard.ifPresent(shards::add);\n+                }\n+\n+                LOG.log(FINE, \"Shards \" + shards);\n+                return shards;\n+            }\n+        } catch (IOException e) {\n+            throw new JetException(\"Could not get ES shards\", e);\n+        }\n+    }\n+\n+    private Optional<Shard> convertToShard(JsonValue value, Map<String, String> ipToAddress) {\n+        JsonObject object = value.asObject();\n+        // TODO IndexShardState.STARTED but this is deeply inside elastic, should we mirror the enum?\n+        if (\"STARTED\".equals(object.get(\"state\").asString())) {\n+            String ip = object.get(\"ip\").asString();\n+            Shard shard = new Shard(\n+                    object.get(\"index\").asString(),\n+                    Integer.parseInt(object.get(\"shard\").asString()),\n+                    Prirep.valueOf(object.get(\"prirep\").asString()),\n+                    Integer.parseInt(object.get(\"docs\").asString()),\n+                    object.get(\"state\").asString(),\n+                    ip,\n+                    ipToAddress.get(ip),\n+                    object.get(\"node\").asString()\n+            );\n+            return of(shard);\n+        } else {\n+            return empty();\n+        }\n+    }\n+\n+    public static class Master {\n+\n+        private final String host;\n+\n+        private final String id;\n+        private final String ip;\n+        private final String node;\n+\n+        public Master(String host, String id, String ip, String node) {\n+            this.host = host;\n+            this.id = id;\n+            this.ip = ip;\n+            this.node = node;\n+        }\n+\n+        public String getHost() {\n+            return host;\n+        }\n+\n+        public String getId() {\n+            return id;\n+        }\n+\n+        public String getIp() {\n+            return ip;\n+        }\n+\n+        public String getNode() {\n+            return node;\n+        }\n+\n+        @Override public String toString() {\n+            return \"Master{\" +\n+                    \"host='\" + host + '\\'' +\n+                    \", id='\" + id + '\\'' +\n+                    \", ip='\" + ip + '\\'' +\n+                    \", node='\" + node + '\\'' +\n+                    '}';\n+        }\n+\n+    }\n+\n+    public static class Node {\n+\n+        private final String ip;\n+        private final String name;\n+        private final String httpAddress;\n+        private final String master;\n+\n+        public Node(@Nonnull String ip, @Nonnull String name, @Nonnull String httpAddress, @Nonnull String master) {\n+            this.ip = ip;\n+            this.name = name;\n+            this.httpAddress = httpAddress;\n+            this.master = master;\n+        }\n+\n+        public String getIp() {\n+            return ip;\n+        }\n+\n+        public String getName() {\n+            return name;\n+        }\n+\n+        public String getHttpAddress() {\n+            return httpAddress;\n+        }\n+\n+        public String getMaster() {\n+            return master;\n+        }\n+\n+        @Override public String toString() {\n+            return \"Node{\" +\n+                    \"ip='\" + ip + '\\'' +\n+                    \", name='\" + name + '\\'' +\n+                    \", httpAddress='\" + httpAddress + '\\'' +\n+                    \", master='\" + master + '\\'' +\n+                    '}';\n+        }\n+    }\n+\n+}\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 255}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzODE1MzI1OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/AuthElasticSourcesTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMDo0Mzo0OFrOGUAxcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMDo0Mzo0OFrOGUAxcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYzNzM2Mg==", "bodyText": "Please add also test when we try to access elastic by client without username and password (just to be sure it will fail and not get stuck)", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r423637362", "createdAt": "2020-05-12T10:43:48Z", "author": {"login": "olukas"}, "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/AuthElasticSourcesTest.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.google.common.collect.ImmutableMap;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.JetTestInstanceFactory;\n+import com.hazelcast.jet.config.JetConfig;\n+import com.hazelcast.jet.impl.util.Util;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.jet.pipeline.Sinks;\n+import org.elasticsearch.client.ResponseException;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.junit.After;\n+import org.junit.Test;\n+import org.testcontainers.elasticsearch.ElasticsearchContainer;\n+\n+import java.util.function.Supplier;\n+\n+import static com.hazelcast.jet.elastic.ElasticClients.client;\n+import static com.hazelcast.jet.elastic.ElasticSupport.ELASTICSEARCH_IMAGE;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+public class AuthElasticSourcesTest extends BaseElasticTest {\n+\n+    /**\n+     * Using elastic container configured with security enabled\n+     */\n+    public static Supplier<ElasticsearchContainer> elastic = Util.memoize(() -> {\n+        ElasticsearchContainer elastic = new ElasticsearchContainer(ELASTICSEARCH_IMAGE)\n+                .withEnv(\"ELASTIC_USERNAME\", \"elastic\")\n+                .withEnv(\"ELASTIC_PASSWORD\", \"SuperSecret\")\n+                .withEnv(\"xpack.security.enabled\", \"true\");\n+\n+        elastic.start();\n+        Runtime.getRuntime().addShutdownHook(new Thread(elastic::stop));\n+        return elastic;\n+    });\n+    public static final int PORT = 9200;\n+\n+    private final JetTestInstanceFactory factory = new JetTestInstanceFactory();\n+\n+    @After\n+    public void afterClass() throws Exception {\n+        factory.terminateAll();\n+    }\n+\n+    @Override\n+    protected SupplierEx<RestHighLevelClient> elasticClientSupplier() {\n+        ElasticsearchContainer container = elastic.get();\n+        String containerIp = container.getContainerIpAddress();\n+        Integer port = container.getMappedPort(PORT);\n+\n+        return () -> client(\"elastic\", \"SuperSecret\", containerIp, port);\n+    }\n+\n+    @Override\n+    protected JetInstance createJetInstance() {\n+        return factory.newMember(new JetConfig());\n+    }\n+\n+    @Test\n+    public void given_authenticatedClient_whenReadFromElasticSource_thenFinishSuccessfully() {\n+        indexDocument(\"my-index\", ImmutableMap.of(\"name\", \"Frantisek\"));\n+\n+        Pipeline p = Pipeline.create();\n+        p.readFrom(ElasticSources.elastic(elasticClientSupplier()))\n+         .writeTo(Sinks.list(results));\n+\n+        submitJob(p);\n+    }\n+\n+    @Test\n+    public void given_clientWithWrongPassword_whenReadFromElasticSource_thenFailWithAuthenticationException() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0cbdf82d211e0d4c6e4058870360c02971521771"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NDM2OTIyOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/ElasticSourcePMetaSupplier.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwNzozNzo0M1rOGX-7YQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwNzozNzo0M1rOGX-7YQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzgwMTQ0MQ==", "bodyText": "uncheckCall is not necessary here", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r427801441", "createdAt": "2020-05-20T07:37:43Z", "author": {"login": "gurbuzali"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/ElasticSourcePMetaSupplier.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic.impl;\n+\n+import com.hazelcast.cluster.Address;\n+import com.hazelcast.jet.JetException;\n+import com.hazelcast.jet.core.ProcessorMetaSupplier;\n+import com.hazelcast.jet.core.ProcessorSupplier;\n+import com.hazelcast.jet.core.processor.Processors;\n+\n+import javax.annotation.Nonnull;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static com.hazelcast.jet.impl.util.Util.uncheckCall;\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.nCopies;\n+import static java.util.stream.Collectors.groupingBy;\n+import static java.util.stream.Collectors.toSet;\n+\n+public class ElasticSourcePMetaSupplier<T> implements ProcessorMetaSupplier {\n+\n+    private static final long serialVersionUID = 1L;\n+\n+    @Nonnull\n+    private final ElasticSourceConfiguration<T> configuration;\n+\n+    private transient Map<Address, List<Shard>> assignedShards;\n+    private transient Address ownerAddress;\n+\n+    public ElasticSourcePMetaSupplier(@Nonnull ElasticSourceConfiguration<T> configuration) {\n+        this.configuration = configuration;\n+    }\n+\n+    @Override\n+    public int preferredLocalParallelism() {\n+        if (configuration.isCoLocatedReadingEnabled() || configuration.isSlicingEnabled()) {\n+            return configuration.preferredLocalParallelism();\n+        } else {\n+            return 1;\n+        }\n+    }\n+\n+\n+    @Override\n+    public void init(@Nonnull Context context) throws Exception {\n+        try (ElasticCatClient catClient = new ElasticCatClient(configuration.clientFn().get().getLowLevelClient())) {\n+            List<Shard> shards = catClient.shards(configuration.searchRequestFn().get().indices());\n+\n+            if (configuration.isCoLocatedReadingEnabled()) {\n+                Set<Address> addresses = context\n+                        .jetInstance().getCluster().getMembers().stream()\n+                        .map(m -> uncheckCall((m::getAddress)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "973fbe2be92554c3904000523c35799bb0804c0c"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NDM4ODY3OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/ElasticSourcePMetaSupplier.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwNzo0MzoyMVrOGX_Hvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwNzo0MzoyMVrOGX_Hvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzgwNDYwNw==", "bodyText": "no need to create a keySet to get the size", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r427804607", "createdAt": "2020-05-20T07:43:21Z", "author": {"login": "gurbuzali"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/impl/ElasticSourcePMetaSupplier.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic.impl;\n+\n+import com.hazelcast.cluster.Address;\n+import com.hazelcast.jet.JetException;\n+import com.hazelcast.jet.core.ProcessorMetaSupplier;\n+import com.hazelcast.jet.core.ProcessorSupplier;\n+import com.hazelcast.jet.core.processor.Processors;\n+\n+import javax.annotation.Nonnull;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.Function;\n+\n+import static com.hazelcast.jet.impl.util.Util.uncheckCall;\n+import static java.util.Collections.emptyList;\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.nCopies;\n+import static java.util.stream.Collectors.groupingBy;\n+import static java.util.stream.Collectors.toSet;\n+\n+public class ElasticSourcePMetaSupplier<T> implements ProcessorMetaSupplier {\n+\n+    private static final long serialVersionUID = 1L;\n+\n+    @Nonnull\n+    private final ElasticSourceConfiguration<T> configuration;\n+\n+    private transient Map<Address, List<Shard>> assignedShards;\n+    private transient Address ownerAddress;\n+\n+    public ElasticSourcePMetaSupplier(@Nonnull ElasticSourceConfiguration<T> configuration) {\n+        this.configuration = configuration;\n+    }\n+\n+    @Override\n+    public int preferredLocalParallelism() {\n+        if (configuration.isCoLocatedReadingEnabled() || configuration.isSlicingEnabled()) {\n+            return configuration.preferredLocalParallelism();\n+        } else {\n+            return 1;\n+        }\n+    }\n+\n+\n+    @Override\n+    public void init(@Nonnull Context context) throws Exception {\n+        try (ElasticCatClient catClient = new ElasticCatClient(configuration.clientFn().get().getLowLevelClient())) {\n+            List<Shard> shards = catClient.shards(configuration.searchRequestFn().get().indices());\n+\n+            if (configuration.isCoLocatedReadingEnabled()) {\n+                Set<Address> addresses = context\n+                        .jetInstance().getCluster().getMembers().stream()\n+                        .map(m -> uncheckCall((m::getAddress)))\n+                        .collect(toSet());\n+                assignedShards = assignShards(shards, addresses);\n+            } else {\n+                ownerAddress = context.jetInstance().getHazelcastInstance().getPartitionService()\n+                                      .getPartition(context.jobId()).getOwner().getAddress();\n+                assignedShards = emptyMap();\n+            }\n+        }\n+    }\n+\n+    static Map<Address, List<Shard>> assignShards(Collection<Shard> shards, Collection<Address> addresses) {\n+        Map<String, List<Shard>> nodeCandidates = shards.stream()\n+                                                        .collect(groupingBy(Shard::getIp));\n+        Map<Address, List<Shard>> nodeAssigned = new HashMap<>();\n+\n+        if (!addresses.stream().map(Address::getHost).collect(toSet())\n+                      .containsAll(nodeCandidates.keySet())) {\n+            throw new JetException(\"Shard locations are not equal to Jet nodes locations, \" +\n+                    \"shards=\" + nodeCandidates.keySet() + \", Jet nodes=\" + addresses);\n+        }\n+\n+        int uniqueShards = (int) shards.stream().map(Shard::indexShard).distinct().count();\n+        Set<String> assignedShards = new HashSet<>();\n+\n+        int candidatesSize = nodeCandidates.keySet().size();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "973fbe2be92554c3904000523c35799bb0804c0c"}, "originalPosition": 99}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NDk1ODgyOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMDoxNToyNVrOGYE0Kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMDoxNToyNVrOGYE0Kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg5Nzg5OQ==", "bodyText": "I think we should enhance the JavaDoc here since slicing can be done on a single shard too.\nAdditionally, when slicing is used with co-located reading I guess the number of slices change ?", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r427897899", "createdAt": "2020-05-20T10:15:25Z", "author": {"login": "gurbuzali"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "diffHunk": "@@ -0,0 +1,236 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.elastic.impl.ElasticSourceConfiguration;\n+import com.hazelcast.jet.elastic.impl.ElasticSourcePMetaSupplier;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Sources;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestClientBuilder;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkNonNullAndSerializable;\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch source which reads data from Elasticsearch and\n+ * converts SearchHits using provided {@code mapToItemFn}\n+ * <p>\n+ * Usage:\n+ * <pre>{@code\n+ * BatchSource<String> source = new ElasticSourceBuilder<String>()\n+ *   .clientFn(() -> client(host, port))\n+ *   .searchRequestFn(() -> new SearchRequest(\"my-index\"))\n+ *   .mapToItemFn(SearchHit::getSourceAsString)\n+ *   .build();\n+ *\n+ * BatchStage<String> stage = p.readFrom(source);\n+ * }</pre>\n+ *\n+ * Requires {@link #clientFn(SupplierEx)}, {@link #searchRequestFn(SupplierEx)} and {@link #mapToItemFn(FunctionEx)}.\n+ *\n+ * @param <T> type of the output of the mapping function from {@link SearchHit} -> T\n+ * @since 4.2\n+ */\n+public class ElasticSourceBuilder<T> {\n+\n+    private static final String DEFAULT_NAME = \"elasticSource\";\n+\n+    private SupplierEx<RestClientBuilder> clientFn;\n+    private SupplierEx<SearchRequest> searchRequestFn;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = request -> RequestOptions.DEFAULT;\n+    private FunctionEx<? super SearchHit, T> mapToItemFn;\n+    private boolean slicing;\n+    private boolean coLocatedReading;\n+    private String scrollKeepAlive = \"1m\"; // Using String because it needs to be Serializable\n+    private int preferredLocalParallelism = 2;\n+\n+    /**\n+     * Build Elasticsearch {@link BatchSource} with supplied parameters\n+     *\n+     * @return configured source which is to be used in the pipeline\n+     */\n+    @Nonnull\n+    public BatchSource<T> build() {\n+        requireNonNull(clientFn, \"clientFn must be set\");\n+        requireNonNull(searchRequestFn, \"searchRequestFn must be set\");\n+        requireNonNull(mapToItemFn, \"mapToItemFn must be set\");\n+\n+        ElasticSourceConfiguration<T> configuration = new ElasticSourceConfiguration<>(\n+                restHighLevelClientFn(clientFn),\n+                searchRequestFn, optionsFn, mapToItemFn, slicing, coLocatedReading,\n+                scrollKeepAlive, preferredLocalParallelism\n+        );\n+        ElasticSourcePMetaSupplier<T> metaSupplier = new ElasticSourcePMetaSupplier<>(configuration);\n+        return Sources.batchFromProcessor(DEFAULT_NAME, metaSupplier);\n+    }\n+\n+    // Don't inline - it would capture this.clientFn and would need to serialize whole builder instance\n+    private SupplierEx<RestHighLevelClient> restHighLevelClientFn(SupplierEx<RestClientBuilder> clientFn) {\n+        return () -> new RestHighLevelClient(clientFn.get());\n+    }\n+\n+    /**\n+     * Set the client supplier function\n+     * <p>\n+     * The connector uses the returned instance to access Elasticsearch. Also see {@link ElasticClients} for convenience\n+     * factory methods.\n+     * <p>\n+     * For example, to provide an authenticated client:\n+     * <pre>{@code\n+     * builder.clientFn(() -> client(host, port, username, password))\n+     * }</pre>\n+     *\n+     * This parameter is required.\n+     *\n+     * @param clientFn supplier function returning configured Elasticsearch REST client\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> clientFn(@Nonnull SupplierEx<RestClientBuilder> clientFn) {\n+        this.clientFn = checkNonNullAndSerializable(clientFn, \"clientFn\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the search request supplier function\n+     * <p>\n+     * The connector executes this search request to retrieve documents from Elasticsearch.\n+     * <p>\n+     * For example, to create SearchRequest limited to an index `logs`:\n+     * <pre>{@code\n+     * builder.searchRequestFn(() -> new SearchRequest(\"logs\"))\n+     * }</pre>\n+     *\n+     * This parameter is required.\n+     *\n+     * @param searchRequestFn search request supplier function\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> searchRequestFn(@Nonnull SupplierEx<SearchRequest> searchRequestFn) {\n+        this.searchRequestFn = checkSerializable(searchRequestFn, \"searchRequestFn\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the function to map SearchHit to a pipeline item\n+     * <p>\n+     * For example, to map a SearchHit to a value of a field `productId`:\n+     * <pre>{@code\n+     * builder.mapToItemFn(hit -> (String) hit.getSourceAsMap().get(\"productId\"))\n+     * }</pre>\n+     *\n+     * This parameter is required.\n+     *\n+     * @param mapToItemFn maps search hits to output items\n+     */\n+    @Nonnull\n+    @SuppressWarnings(\"unchecked\")\n+    public <T_NEW> ElasticSourceBuilder<T_NEW> mapToItemFn(@Nonnull FunctionEx<? super SearchHit, T_NEW> mapToItemFn) {\n+        ElasticSourceBuilder<T_NEW> newThis = (ElasticSourceBuilder<T_NEW>) this;\n+        newThis.mapToItemFn = checkSerializable(mapToItemFn, \"mapToItemFn\");\n+        return newThis;\n+    }\n+\n+    /**\n+     * Set the function that provides {@link RequestOptions}\n+     * <p>\n+     * It can either return a constant value or a value based on provided request.\n+     * <p>\n+     * For example, use this to provide a custom authentication header:\n+     * <pre>{@code\n+     * sourceBuilder.optionsFn((request) -> {\n+     *     RequestOptions.Builder builder = RequestOptions.DEFAULT.toBuilder();\n+     *     builder.addHeader(\"Authorization\", \"Bearer \" + TOKEN);\n+     *     return builder.build();\n+     * })\n+     * }</pre>\n+     *\n+     * @param optionsFn function that provides {@link RequestOptions}\n+     * @see <a\n+     * href=\"https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-low-usage-requests.html\">\n+     * RequestOptions in Elastic documentation</a>\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> optionsFn(@Nonnull FunctionEx<? super ActionRequest, RequestOptions> optionsFn) {\n+        this.optionsFn = checkSerializable(optionsFn, \"optionsFn\");\n+        return this;\n+    }\n+\n+    /**\n+     * Enable slicing\n+     * <p>\n+     * Number of slices is equal to globalParallelism (localParallelism * numberOfNodes)\n+     * <p>\n+     * Use this option to read from multiple shards in parallel.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "973fbe2be92554c3904000523c35799bb0804c0c"}, "originalPosition": 187}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NDk2Nzg0OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMDoxODoxMlrOGYE5-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNjoyNzo0NFrOGa7GDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg5OTM4Ng==", "bodyText": "looks like this is not covered in the tests, also preferredLocalParallelism", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r427899386", "createdAt": "2020-05-20T10:18:12Z", "author": {"login": "gurbuzali"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "diffHunk": "@@ -0,0 +1,239 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import com.hazelcast.jet.pipeline.SinkBuilder;\n+import com.hazelcast.logging.ILogger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestClientBuilder;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkNonNullAndSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch Sink\n+ * <p>\n+ * The Sink first maps items from the pipeline using the provided\n+ * {@link #mapToRequestFn(FunctionEx)} and then using {@link BulkRequest}.\n+ * <p>\n+ * {@link BulkRequest#BulkRequest()} is used by default, it can be\n+ * modified by providing custom {@link #bulkRequestFn(SupplierEx)}\n+ *\n+ * <p>\n+ * Usage:\n+ * <pre>{@code\n+ * Sink<Map<String, ?>> elasticSink = new ElasticSinkBuilder<Map<String, ?>>()\n+ *   .clientFn(() -> ElasticClients.client(host, port))\n+ *   .mapToRequestFn(item -> new IndexRequest(\"my-index\").source(item))\n+ *   .build();\n+ * }</pre>\n+ * <p>\n+ * Requires {@link #clientFn(SupplierEx)} and {@link #mapToRequestFn(FunctionEx)}.\n+ *\n+ * @param <T>\n+ * @since 4.2\n+ */\n+public class ElasticSinkBuilder<T> implements Serializable {\n+\n+    private static final String DEFAULT_NAME = \"elasticSink\";\n+\n+    private SupplierEx<RestClientBuilder> clientFn;\n+    private SupplierEx<BulkRequest> bulkRequestFn = BulkRequest::new;\n+    private FunctionEx<? super T, ? extends DocWriteRequest<?>> mapToRequestFn;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = (request) -> RequestOptions.DEFAULT;\n+    private int preferredLocalParallelism = 2;\n+\n+    /**\n+     * Set the client supplier function\n+     * <p>\n+     * The connector uses the returned instance to access Elasticsearch. Also see {@link ElasticClients} for convenience\n+     * factory methods.\n+     * <p>\n+     * For example, to provide an authenticated client:\n+     * <pre>{@code\n+     * builder.clientFn(() -> client(host, port, username, password))\n+     * }</pre>\n+     *\n+     * This parameter is required.\n+     *\n+     * @param clientFn supplier function returning configured Elasticsearch REST client\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> clientFn(@Nonnull SupplierEx<RestClientBuilder> clientFn) {\n+        this.clientFn = checkNonNullAndSerializable(clientFn, \"clientFn\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the supplier function for BulkRequest, defaults to new {@link BulkRequest#BulkRequest()}\n+     * <p>\n+     * For example, to modify the BulkRequest used to index documents:\n+     * <pre>{@code\n+     * builder.bulkRequestFn(() -> new BulkRequest().setRefreshPolicy(IMMEDIATE))\n+     * }</pre>\n+     *\n+     * @param bulkRequestFn supplier function for the bulk request\n+     * @see <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-update-settings.html#bulk\">\n+     * Bulk indexing usage in Elastic documentation</a>\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> bulkRequestFn(@Nonnull SupplierEx<BulkRequest> bulkRequestFn) {\n+        this.bulkRequestFn = checkNonNullAndSerializable(bulkRequestFn, \"bulkRequestFn\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the function mapping the item from a pipeline item to an index request\n+     * <p>\n+     * For example, to create an IndexRequest for a versioned document:\n+     * <pre>{@code\n+     * builder.mapToRequestFn((mapItem) ->\n+     *                      new IndexRequest(\"my-index\")\n+     *                              .source(map)\n+     *                              .version((Long) map.get(\"version\"))\n+     * }</pre>\n+     *\n+     * This parameter is required.\n+     *\n+     * @param mapToRequestFn maps an item from the stream to an {@link org.elasticsearch.action.index.IndexRequest},\n+     *                       {@link org.elasticsearch.action.update.UpdateRequest} or\n+     *                       {@link org.elasticsearch.action.delete.DeleteRequest}\n+     * @param <T_NEW> type of the items from the pipeline\n+     */\n+    @Nonnull\n+    @SuppressWarnings(\"unchecked\")\n+    public <T_NEW> ElasticSinkBuilder<T_NEW> mapToRequestFn(\n+            @Nonnull FunctionEx<? super T_NEW, ? extends DocWriteRequest<?>> mapToRequestFn\n+    ) {\n+        ElasticSinkBuilder<T_NEW> newThis = (ElasticSinkBuilder<T_NEW>) this;\n+        newThis.mapToRequestFn = checkNonNullAndSerializable(mapToRequestFn, \"mapToRequestFn\");\n+        return newThis;\n+    }\n+\n+    /**\n+     * Set the function that provides {@link RequestOptions}\n+     * <p>\n+     * It can either return a constant value or a value based on provided request.\n+     * <p>\n+     * For example, to provide a custom authentication header:\n+     * <pre>{@code\n+     * sinkBuilder.optionsFn((request) -> {\n+     *     RequestOptions.Builder builder = RequestOptions.DEFAULT.toBuilder();\n+     *     builder.addHeader(\"Authorization\", \"Bearer \" + TOKEN);\n+     *     return builder.build();\n+     * })\n+     * }</pre>\n+     *\n+     * @param optionsFn function that provides {@link RequestOptions}\n+     * @see <a\n+     * href=\"https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-low-usage-requests.html\">\n+     * RequestOptions in Elastic documentation</a>\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> optionsFn(@Nonnull FunctionEx<? super ActionRequest, RequestOptions> optionsFn) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "973fbe2be92554c3904000523c35799bb0804c0c"}, "originalPosition": 160}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg4NDM2NQ==", "bodyText": "ElasticSourcePTest tests that it is used (also for scroll keepAlive).", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r430884365", "createdAt": "2020-05-27T06:27:44Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "diffHunk": "@@ -0,0 +1,239 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import com.hazelcast.jet.pipeline.SinkBuilder;\n+import com.hazelcast.logging.ILogger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestClientBuilder;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkNonNullAndSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch Sink\n+ * <p>\n+ * The Sink first maps items from the pipeline using the provided\n+ * {@link #mapToRequestFn(FunctionEx)} and then using {@link BulkRequest}.\n+ * <p>\n+ * {@link BulkRequest#BulkRequest()} is used by default, it can be\n+ * modified by providing custom {@link #bulkRequestFn(SupplierEx)}\n+ *\n+ * <p>\n+ * Usage:\n+ * <pre>{@code\n+ * Sink<Map<String, ?>> elasticSink = new ElasticSinkBuilder<Map<String, ?>>()\n+ *   .clientFn(() -> ElasticClients.client(host, port))\n+ *   .mapToRequestFn(item -> new IndexRequest(\"my-index\").source(item))\n+ *   .build();\n+ * }</pre>\n+ * <p>\n+ * Requires {@link #clientFn(SupplierEx)} and {@link #mapToRequestFn(FunctionEx)}.\n+ *\n+ * @param <T>\n+ * @since 4.2\n+ */\n+public class ElasticSinkBuilder<T> implements Serializable {\n+\n+    private static final String DEFAULT_NAME = \"elasticSink\";\n+\n+    private SupplierEx<RestClientBuilder> clientFn;\n+    private SupplierEx<BulkRequest> bulkRequestFn = BulkRequest::new;\n+    private FunctionEx<? super T, ? extends DocWriteRequest<?>> mapToRequestFn;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = (request) -> RequestOptions.DEFAULT;\n+    private int preferredLocalParallelism = 2;\n+\n+    /**\n+     * Set the client supplier function\n+     * <p>\n+     * The connector uses the returned instance to access Elasticsearch. Also see {@link ElasticClients} for convenience\n+     * factory methods.\n+     * <p>\n+     * For example, to provide an authenticated client:\n+     * <pre>{@code\n+     * builder.clientFn(() -> client(host, port, username, password))\n+     * }</pre>\n+     *\n+     * This parameter is required.\n+     *\n+     * @param clientFn supplier function returning configured Elasticsearch REST client\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> clientFn(@Nonnull SupplierEx<RestClientBuilder> clientFn) {\n+        this.clientFn = checkNonNullAndSerializable(clientFn, \"clientFn\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the supplier function for BulkRequest, defaults to new {@link BulkRequest#BulkRequest()}\n+     * <p>\n+     * For example, to modify the BulkRequest used to index documents:\n+     * <pre>{@code\n+     * builder.bulkRequestFn(() -> new BulkRequest().setRefreshPolicy(IMMEDIATE))\n+     * }</pre>\n+     *\n+     * @param bulkRequestFn supplier function for the bulk request\n+     * @see <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-update-settings.html#bulk\">\n+     * Bulk indexing usage in Elastic documentation</a>\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> bulkRequestFn(@Nonnull SupplierEx<BulkRequest> bulkRequestFn) {\n+        this.bulkRequestFn = checkNonNullAndSerializable(bulkRequestFn, \"bulkRequestFn\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the function mapping the item from a pipeline item to an index request\n+     * <p>\n+     * For example, to create an IndexRequest for a versioned document:\n+     * <pre>{@code\n+     * builder.mapToRequestFn((mapItem) ->\n+     *                      new IndexRequest(\"my-index\")\n+     *                              .source(map)\n+     *                              .version((Long) map.get(\"version\"))\n+     * }</pre>\n+     *\n+     * This parameter is required.\n+     *\n+     * @param mapToRequestFn maps an item from the stream to an {@link org.elasticsearch.action.index.IndexRequest},\n+     *                       {@link org.elasticsearch.action.update.UpdateRequest} or\n+     *                       {@link org.elasticsearch.action.delete.DeleteRequest}\n+     * @param <T_NEW> type of the items from the pipeline\n+     */\n+    @Nonnull\n+    @SuppressWarnings(\"unchecked\")\n+    public <T_NEW> ElasticSinkBuilder<T_NEW> mapToRequestFn(\n+            @Nonnull FunctionEx<? super T_NEW, ? extends DocWriteRequest<?>> mapToRequestFn\n+    ) {\n+        ElasticSinkBuilder<T_NEW> newThis = (ElasticSinkBuilder<T_NEW>) this;\n+        newThis.mapToRequestFn = checkNonNullAndSerializable(mapToRequestFn, \"mapToRequestFn\");\n+        return newThis;\n+    }\n+\n+    /**\n+     * Set the function that provides {@link RequestOptions}\n+     * <p>\n+     * It can either return a constant value or a value based on provided request.\n+     * <p>\n+     * For example, to provide a custom authentication header:\n+     * <pre>{@code\n+     * sinkBuilder.optionsFn((request) -> {\n+     *     RequestOptions.Builder builder = RequestOptions.DEFAULT.toBuilder();\n+     *     builder.addHeader(\"Authorization\", \"Bearer \" + TOKEN);\n+     *     return builder.build();\n+     * })\n+     * }</pre>\n+     *\n+     * @param optionsFn function that provides {@link RequestOptions}\n+     * @see <a\n+     * href=\"https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-low-usage-requests.html\">\n+     * RequestOptions in Elastic documentation</a>\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> optionsFn(@Nonnull FunctionEx<? super ActionRequest, RequestOptions> optionsFn) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzg5OTM4Ng=="}, "originalCommit": {"oid": "973fbe2be92554c3904000523c35799bb0804c0c"}, "originalPosition": 160}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NDk3NTE3OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMDoyMDoyN1rOGYE-wA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMDoyMDoyN1rOGYE-wA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzkwMDYwOA==", "bodyText": "not covered in the tests, also preferredLocalParallelism and scrollKeepAlive", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r427900608", "createdAt": "2020-05-20T10:20:27Z", "author": {"login": "gurbuzali"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "diffHunk": "@@ -0,0 +1,236 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.elastic.impl.ElasticSourceConfiguration;\n+import com.hazelcast.jet.elastic.impl.ElasticSourcePMetaSupplier;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Sources;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestClientBuilder;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkNonNullAndSerializable;\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch source which reads data from Elasticsearch and\n+ * converts SearchHits using provided {@code mapToItemFn}\n+ * <p>\n+ * Usage:\n+ * <pre>{@code\n+ * BatchSource<String> source = new ElasticSourceBuilder<String>()\n+ *   .clientFn(() -> client(host, port))\n+ *   .searchRequestFn(() -> new SearchRequest(\"my-index\"))\n+ *   .mapToItemFn(SearchHit::getSourceAsString)\n+ *   .build();\n+ *\n+ * BatchStage<String> stage = p.readFrom(source);\n+ * }</pre>\n+ *\n+ * Requires {@link #clientFn(SupplierEx)}, {@link #searchRequestFn(SupplierEx)} and {@link #mapToItemFn(FunctionEx)}.\n+ *\n+ * @param <T> type of the output of the mapping function from {@link SearchHit} -> T\n+ * @since 4.2\n+ */\n+public class ElasticSourceBuilder<T> {\n+\n+    private static final String DEFAULT_NAME = \"elasticSource\";\n+\n+    private SupplierEx<RestClientBuilder> clientFn;\n+    private SupplierEx<SearchRequest> searchRequestFn;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = request -> RequestOptions.DEFAULT;\n+    private FunctionEx<? super SearchHit, T> mapToItemFn;\n+    private boolean slicing;\n+    private boolean coLocatedReading;\n+    private String scrollKeepAlive = \"1m\"; // Using String because it needs to be Serializable\n+    private int preferredLocalParallelism = 2;\n+\n+    /**\n+     * Build Elasticsearch {@link BatchSource} with supplied parameters\n+     *\n+     * @return configured source which is to be used in the pipeline\n+     */\n+    @Nonnull\n+    public BatchSource<T> build() {\n+        requireNonNull(clientFn, \"clientFn must be set\");\n+        requireNonNull(searchRequestFn, \"searchRequestFn must be set\");\n+        requireNonNull(mapToItemFn, \"mapToItemFn must be set\");\n+\n+        ElasticSourceConfiguration<T> configuration = new ElasticSourceConfiguration<>(\n+                restHighLevelClientFn(clientFn),\n+                searchRequestFn, optionsFn, mapToItemFn, slicing, coLocatedReading,\n+                scrollKeepAlive, preferredLocalParallelism\n+        );\n+        ElasticSourcePMetaSupplier<T> metaSupplier = new ElasticSourcePMetaSupplier<>(configuration);\n+        return Sources.batchFromProcessor(DEFAULT_NAME, metaSupplier);\n+    }\n+\n+    // Don't inline - it would capture this.clientFn and would need to serialize whole builder instance\n+    private SupplierEx<RestHighLevelClient> restHighLevelClientFn(SupplierEx<RestClientBuilder> clientFn) {\n+        return () -> new RestHighLevelClient(clientFn.get());\n+    }\n+\n+    /**\n+     * Set the client supplier function\n+     * <p>\n+     * The connector uses the returned instance to access Elasticsearch. Also see {@link ElasticClients} for convenience\n+     * factory methods.\n+     * <p>\n+     * For example, to provide an authenticated client:\n+     * <pre>{@code\n+     * builder.clientFn(() -> client(host, port, username, password))\n+     * }</pre>\n+     *\n+     * This parameter is required.\n+     *\n+     * @param clientFn supplier function returning configured Elasticsearch REST client\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> clientFn(@Nonnull SupplierEx<RestClientBuilder> clientFn) {\n+        this.clientFn = checkNonNullAndSerializable(clientFn, \"clientFn\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the search request supplier function\n+     * <p>\n+     * The connector executes this search request to retrieve documents from Elasticsearch.\n+     * <p>\n+     * For example, to create SearchRequest limited to an index `logs`:\n+     * <pre>{@code\n+     * builder.searchRequestFn(() -> new SearchRequest(\"logs\"))\n+     * }</pre>\n+     *\n+     * This parameter is required.\n+     *\n+     * @param searchRequestFn search request supplier function\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> searchRequestFn(@Nonnull SupplierEx<SearchRequest> searchRequestFn) {\n+        this.searchRequestFn = checkSerializable(searchRequestFn, \"searchRequestFn\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the function to map SearchHit to a pipeline item\n+     * <p>\n+     * For example, to map a SearchHit to a value of a field `productId`:\n+     * <pre>{@code\n+     * builder.mapToItemFn(hit -> (String) hit.getSourceAsMap().get(\"productId\"))\n+     * }</pre>\n+     *\n+     * This parameter is required.\n+     *\n+     * @param mapToItemFn maps search hits to output items\n+     */\n+    @Nonnull\n+    @SuppressWarnings(\"unchecked\")\n+    public <T_NEW> ElasticSourceBuilder<T_NEW> mapToItemFn(@Nonnull FunctionEx<? super SearchHit, T_NEW> mapToItemFn) {\n+        ElasticSourceBuilder<T_NEW> newThis = (ElasticSourceBuilder<T_NEW>) this;\n+        newThis.mapToItemFn = checkSerializable(mapToItemFn, \"mapToItemFn\");\n+        return newThis;\n+    }\n+\n+    /**\n+     * Set the function that provides {@link RequestOptions}\n+     * <p>\n+     * It can either return a constant value or a value based on provided request.\n+     * <p>\n+     * For example, use this to provide a custom authentication header:\n+     * <pre>{@code\n+     * sourceBuilder.optionsFn((request) -> {\n+     *     RequestOptions.Builder builder = RequestOptions.DEFAULT.toBuilder();\n+     *     builder.addHeader(\"Authorization\", \"Bearer \" + TOKEN);\n+     *     return builder.build();\n+     * })\n+     * }</pre>\n+     *\n+     * @param optionsFn function that provides {@link RequestOptions}\n+     * @see <a\n+     * href=\"https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-low-usage-requests.html\">\n+     * RequestOptions in Elastic documentation</a>\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> optionsFn(@Nonnull FunctionEx<? super ActionRequest, RequestOptions> optionsFn) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "973fbe2be92554c3904000523c35799bb0804c0c"}, "originalPosition": 177}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NDk5NzE0OnYy", "diffSide": "RIGHT", "path": "examples/elastic/src/main/java/com/hazelcast/jet/examples/elastic/ElasticSinkExample.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMDoyNzoxMFrOGYFNQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMDoyNzoxMFrOGYFNQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzkwNDMyMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return batchFromProcessor(\"filesSource(\" + new File(directory) + ')',\n          \n          \n            \n                            SourceProcessors.readFilesP(directory, \"*\", false,\n          \n          \n            \n                                    path -> Stream.of(new String(Files.readAllBytes(path), UTF_8))));\n          \n          \n            \n                    return Sources.filesBuilder(directory)\n          \n          \n            \n                           .build(path -> Stream.of(new String(Files.readAllBytes(path), UTF_8)));", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r427904321", "createdAt": "2020-05-20T10:27:10Z", "author": {"login": "gurbuzali"}, "path": "examples/elastic/src/main/java/com/hazelcast/jet/examples/elastic/ElasticSinkExample.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.examples.elastic;\n+\n+import com.hazelcast.jet.Jet;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.core.processor.SourceProcessors;\n+import com.hazelcast.jet.elastic.ElasticClients;\n+import com.hazelcast.jet.elastic.ElasticSinks;\n+import com.hazelcast.jet.json.JsonUtil;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import org.elasticsearch.action.index.IndexRequest;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.util.stream.Stream;\n+\n+import static com.hazelcast.jet.pipeline.Pipeline.create;\n+import static com.hazelcast.jet.pipeline.Sources.batchFromProcessor;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+public class ElasticSinkExample {\n+\n+    public static void main(String[] args) {\n+        try {\n+            Pipeline p = create();\n+            p.readFrom(files(\"src/main/resources/documents\"))\n+             .map(JsonUtil::mapFrom)\n+             .writeTo(ElasticSinks.elastic(\n+                     () -> ElasticClients.client(\"localhost\", 9200),\n+                     map -> new IndexRequest(\"my-index\").source(map)\n+             ));\n+\n+            JetInstance jet = Jet.newJetInstance();\n+            jet.newJob(p).join();\n+        } catch (Exception e) {\n+            Jet.shutdownAll();\n+        }\n+    }\n+\n+    public static BatchSource<String> files(String directory) {\n+        return batchFromProcessor(\"filesSource(\" + new File(directory) + ')',\n+                SourceProcessors.readFilesP(directory, \"*\", false,\n+                        path -> Stream.of(new String(Files.readAllBytes(path), UTF_8))));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "973fbe2be92554c3904000523c35799bb0804c0c"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NTAwNDAwOnYy", "diffSide": "RIGHT", "path": "examples/elastic/src/main/java/com/hazelcast/jet/examples/elastic/ElasticSinkExample.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMDoyOToxN1rOGYFSQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMDoyOToxN1rOGYFSQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzkwNTYwMA==", "bodyText": "can we have a few lines of javadoc describes what the example does\nalso source example", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r427905600", "createdAt": "2020-05-20T10:29:17Z", "author": {"login": "gurbuzali"}, "path": "examples/elastic/src/main/java/com/hazelcast/jet/examples/elastic/ElasticSinkExample.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.examples.elastic;\n+\n+import com.hazelcast.jet.Jet;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.core.processor.SourceProcessors;\n+import com.hazelcast.jet.elastic.ElasticClients;\n+import com.hazelcast.jet.elastic.ElasticSinks;\n+import com.hazelcast.jet.json.JsonUtil;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import org.elasticsearch.action.index.IndexRequest;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.util.stream.Stream;\n+\n+import static com.hazelcast.jet.pipeline.Pipeline.create;\n+import static com.hazelcast.jet.pipeline.Sources.batchFromProcessor;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n+public class ElasticSinkExample {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "973fbe2be92554c3904000523c35799bb0804c0c"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3OTUwNzQ2OnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwNjoyODo0OVrOGaQPuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwNjoyODo0OVrOGaQPuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE4MjMyOQ==", "bodyText": "This should not be an option for the sink, it's not offered for any other sink. We just set a reasonable default.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r430182329", "createdAt": "2020-05-26T06:28:49Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSinkBuilder.java", "diffHunk": "@@ -0,0 +1,239 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.pipeline.Sink;\n+import com.hazelcast.jet.pipeline.SinkBuilder;\n+import com.hazelcast.logging.ILogger;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestClientBuilder;\n+import org.elasticsearch.client.RestHighLevelClient;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.io.Serializable;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkNonNullAndSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch Sink\n+ * <p>\n+ * The Sink first maps items from the pipeline using the provided\n+ * {@link #mapToRequestFn(FunctionEx)} and then using {@link BulkRequest}.\n+ * <p>\n+ * {@link BulkRequest#BulkRequest()} is used by default, it can be\n+ * modified by providing custom {@link #bulkRequestFn(SupplierEx)}\n+ *\n+ * <p>\n+ * Usage:\n+ * <pre>{@code\n+ * Sink<Map<String, ?>> elasticSink = new ElasticSinkBuilder<Map<String, ?>>()\n+ *   .clientFn(() -> ElasticClients.client(host, port))\n+ *   .mapToRequestFn(item -> new IndexRequest(\"my-index\").source(item))\n+ *   .build();\n+ * }</pre>\n+ * <p>\n+ * Requires {@link #clientFn(SupplierEx)} and {@link #mapToRequestFn(FunctionEx)}.\n+ *\n+ * @param <T>\n+ * @since 4.2\n+ */\n+public final class ElasticSinkBuilder<T> implements Serializable {\n+\n+    private static final String DEFAULT_NAME = \"elasticSink\";\n+\n+    private SupplierEx<RestClientBuilder> clientFn;\n+    private SupplierEx<BulkRequest> bulkRequestFn = BulkRequest::new;\n+    private FunctionEx<? super T, ? extends DocWriteRequest<?>> mapToRequestFn;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = (request) -> RequestOptions.DEFAULT;\n+    private int preferredLocalParallelism = 2;\n+\n+    /**\n+     * Set the client supplier function\n+     * <p>\n+     * The connector uses the returned instance to access Elasticsearch. Also see {@link ElasticClients} for convenience\n+     * factory methods.\n+     * <p>\n+     * For example, to provide an authenticated client:\n+     * <pre>{@code\n+     * builder.clientFn(() -> client(host, port, username, password))\n+     * }</pre>\n+     *\n+     * This parameter is required.\n+     *\n+     * @param clientFn supplier function returning configured Elasticsearch REST client\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> clientFn(@Nonnull SupplierEx<RestClientBuilder> clientFn) {\n+        this.clientFn = checkNonNullAndSerializable(clientFn, \"clientFn\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the supplier function for BulkRequest, defaults to new {@link BulkRequest#BulkRequest()}\n+     * <p>\n+     * For example, to modify the BulkRequest used to index documents:\n+     * <pre>{@code\n+     * builder.bulkRequestFn(() -> new BulkRequest().setRefreshPolicy(IMMEDIATE))\n+     * }</pre>\n+     *\n+     * @param bulkRequestFn supplier function for the bulk request\n+     * @see <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-update-settings.html#bulk\">\n+     * Bulk indexing usage in Elastic documentation</a>\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> bulkRequestFn(@Nonnull SupplierEx<BulkRequest> bulkRequestFn) {\n+        this.bulkRequestFn = checkNonNullAndSerializable(bulkRequestFn, \"bulkRequestFn\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the function mapping the item from a pipeline item to an index request\n+     * <p>\n+     * For example, to create an IndexRequest for a versioned document:\n+     * <pre>{@code\n+     * builder.mapToRequestFn((mapItem) ->\n+     *                      new IndexRequest(\"my-index\")\n+     *                              .source(map)\n+     *                              .version((Long) map.get(\"version\"))\n+     * }</pre>\n+     *\n+     * This parameter is required.\n+     *\n+     * @param mapToRequestFn maps an item from the stream to an {@link org.elasticsearch.action.index.IndexRequest},\n+     *                       {@link org.elasticsearch.action.update.UpdateRequest} or\n+     *                       {@link org.elasticsearch.action.delete.DeleteRequest}\n+     * @param <T_NEW> type of the items from the pipeline\n+     */\n+    @Nonnull\n+    @SuppressWarnings(\"unchecked\")\n+    public <T_NEW> ElasticSinkBuilder<T_NEW> mapToRequestFn(\n+            @Nonnull FunctionEx<? super T_NEW, ? extends DocWriteRequest<?>> mapToRequestFn\n+    ) {\n+        ElasticSinkBuilder<T_NEW> newThis = (ElasticSinkBuilder<T_NEW>) this;\n+        newThis.mapToRequestFn = checkNonNullAndSerializable(mapToRequestFn, \"mapToRequestFn\");\n+        return newThis;\n+    }\n+\n+    /**\n+     * Set the function that provides {@link RequestOptions}\n+     * <p>\n+     * It can either return a constant value or a value based on provided request.\n+     * <p>\n+     * For example, to provide a custom authentication header:\n+     * <pre>{@code\n+     * sinkBuilder.optionsFn((request) -> {\n+     *     RequestOptions.Builder builder = RequestOptions.DEFAULT.toBuilder();\n+     *     builder.addHeader(\"Authorization\", \"Bearer \" + TOKEN);\n+     *     return builder.build();\n+     * })\n+     * }</pre>\n+     *\n+     * @param optionsFn function that provides {@link RequestOptions}\n+     * @see <a\n+     * href=\"https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-low-usage-requests.html\">\n+     * RequestOptions in Elastic documentation</a>\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> optionsFn(@Nonnull FunctionEx<? super ActionRequest, RequestOptions> optionsFn) {\n+        this.optionsFn = checkNonNullAndSerializable(optionsFn, \"optionsFn\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the local parallelism of this sink. See {@link SinkBuilder#preferredLocalParallelism(int)}.\n+     */\n+    @Nonnull\n+    public ElasticSinkBuilder<T> preferredLocalParallelism(int preferredLocalParallelism) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f11a25723a1fef7f1d22d7450943ad6d0e0b5ca"}, "originalPosition": 169}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3OTUxMDYxOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwNjozMDowNlrOGaQR1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwNjozMDowNlrOGaQR1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE4Mjg2OQ==", "bodyText": "this should not be an option here. The user can set their own and then when slicing is enabled we should set it to reasonable default. Sinks themselves don't have a parallelism option, it's something you add when you add it to the pipeline.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r430182869", "createdAt": "2020-05-26T06:30:06Z", "author": {"login": "cangencer"}, "path": "extensions/elasticsearch/elasticsearch-7/src/main/java/com/hazelcast/jet/elastic/ElasticSourceBuilder.java", "diffHunk": "@@ -0,0 +1,238 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.elastic.impl.ElasticSourceConfiguration;\n+import com.hazelcast.jet.elastic.impl.ElasticSourcePMetaSupplier;\n+import com.hazelcast.jet.pipeline.BatchSource;\n+import com.hazelcast.jet.pipeline.Sources;\n+import org.elasticsearch.action.ActionRequest;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestClientBuilder;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.search.SearchHit;\n+\n+import javax.annotation.Nonnull;\n+\n+import static com.hazelcast.jet.impl.util.Util.checkNonNullAndSerializable;\n+import static com.hazelcast.jet.impl.util.Util.checkSerializable;\n+import static java.util.Objects.requireNonNull;\n+\n+/**\n+ * Builder for Elasticsearch source which reads data from Elasticsearch and\n+ * converts SearchHits using provided {@code mapToItemFn}\n+ * <p>\n+ * Usage:\n+ * <pre>{@code\n+ * BatchSource<String> source = new ElasticSourceBuilder<String>()\n+ *   .clientFn(() -> client(host, port))\n+ *   .searchRequestFn(() -> new SearchRequest(\"my-index\"))\n+ *   .mapToItemFn(SearchHit::getSourceAsString)\n+ *   .build();\n+ *\n+ * BatchStage<String> stage = p.readFrom(source);\n+ * }</pre>\n+ *\n+ * Requires {@link #clientFn(SupplierEx)},\n+ * {@link #searchRequestFn(SupplierEx)} and {@link #mapToItemFn(FunctionEx)}.\n+ *\n+ * @param <T> type of the output of the mapping function from {@link SearchHit} -> T\n+ * @since 4.2\n+ */\n+public final class ElasticSourceBuilder<T> {\n+\n+    private static final String DEFAULT_NAME = \"elasticSource\";\n+\n+    private SupplierEx<RestClientBuilder> clientFn;\n+    private SupplierEx<SearchRequest> searchRequestFn;\n+    private FunctionEx<? super ActionRequest, RequestOptions> optionsFn = request -> RequestOptions.DEFAULT;\n+    private FunctionEx<? super SearchHit, T> mapToItemFn;\n+    private boolean slicing;\n+    private boolean coLocatedReading;\n+    private String scrollKeepAlive = \"1m\"; // Using String because it needs to be Serializable\n+    private int preferredLocalParallelism = 2;\n+\n+    /**\n+     * Build Elasticsearch {@link BatchSource} with supplied parameters\n+     *\n+     * @return configured source which is to be used in the pipeline\n+     */\n+    @Nonnull\n+    public BatchSource<T> build() {\n+        requireNonNull(clientFn, \"clientFn must be set\");\n+        requireNonNull(searchRequestFn, \"searchRequestFn must be set\");\n+        requireNonNull(mapToItemFn, \"mapToItemFn must be set\");\n+\n+        ElasticSourceConfiguration<T> configuration = new ElasticSourceConfiguration<>(\n+                restHighLevelClientFn(clientFn),\n+                searchRequestFn, optionsFn, mapToItemFn, slicing, coLocatedReading,\n+                scrollKeepAlive, preferredLocalParallelism\n+        );\n+        ElasticSourcePMetaSupplier<T> metaSupplier = new ElasticSourcePMetaSupplier<>(configuration);\n+        return Sources.batchFromProcessor(DEFAULT_NAME, metaSupplier);\n+    }\n+\n+    // Don't inline - it would capture this.clientFn and would need to serialize whole builder instance\n+    private SupplierEx<RestHighLevelClient> restHighLevelClientFn(SupplierEx<RestClientBuilder> clientFn) {\n+        return () -> new RestHighLevelClient(clientFn.get());\n+    }\n+\n+    /**\n+     * Set the client supplier function\n+     * <p>\n+     * The connector uses the returned instance to access Elasticsearch.\n+     * Also see {@link ElasticClients} for convenience\n+     * factory methods.\n+     * <p>\n+     * For example, to provide an authenticated client:\n+     * <pre>{@code\n+     * builder.clientFn(() -> client(host, port, username, password))\n+     * }</pre>\n+     *\n+     * This parameter is required.\n+     *\n+     * @param clientFn supplier function returning configured Elasticsearch REST client\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> clientFn(@Nonnull SupplierEx<RestClientBuilder> clientFn) {\n+        this.clientFn = checkNonNullAndSerializable(clientFn, \"clientFn\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the search request supplier function\n+     * <p>\n+     * The connector executes this search request to retrieve documents from Elasticsearch.\n+     * <p>\n+     * For example, to create SearchRequest limited to an index `logs`:\n+     * <pre>{@code\n+     * builder.searchRequestFn(() -> new SearchRequest(\"logs\"))\n+     * }</pre>\n+     *\n+     * This parameter is required.\n+     *\n+     * @param searchRequestFn search request supplier function\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> searchRequestFn(@Nonnull SupplierEx<SearchRequest> searchRequestFn) {\n+        this.searchRequestFn = checkSerializable(searchRequestFn, \"searchRequestFn\");\n+        return this;\n+    }\n+\n+    /**\n+     * Set the function to map SearchHit to a pipeline item\n+     * <p>\n+     * For example, to map a SearchHit to a value of a field `productId`:\n+     * <pre>{@code\n+     * builder.mapToItemFn(hit -> (String) hit.getSourceAsMap().get(\"productId\"))\n+     * }</pre>\n+     *\n+     * This parameter is required.\n+     *\n+     * @param mapToItemFn maps search hits to output items\n+     */\n+    @Nonnull\n+    @SuppressWarnings(\"unchecked\")\n+    public <T_NEW> ElasticSourceBuilder<T_NEW> mapToItemFn(@Nonnull FunctionEx<? super SearchHit, T_NEW> mapToItemFn) {\n+        ElasticSourceBuilder<T_NEW> newThis = (ElasticSourceBuilder<T_NEW>) this;\n+        newThis.mapToItemFn = checkSerializable(mapToItemFn, \"mapToItemFn\");\n+        return newThis;\n+    }\n+\n+    /**\n+     * Set the function that provides {@link RequestOptions}\n+     * <p>\n+     * It can either return a constant value or a value based on provided request.\n+     * <p>\n+     * For example, use this to provide a custom authentication header:\n+     * <pre>{@code\n+     * sourceBuilder.optionsFn((request) -> {\n+     *     RequestOptions.Builder builder = RequestOptions.DEFAULT.toBuilder();\n+     *     builder.addHeader(\"Authorization\", \"Bearer \" + TOKEN);\n+     *     return builder.build();\n+     * })\n+     * }</pre>\n+     *\n+     * @param optionsFn function that provides {@link RequestOptions}\n+     * @see <a\n+     * href=\"https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-low-usage-requests.html\">\n+     * RequestOptions in Elastic documentation</a>\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> optionsFn(@Nonnull FunctionEx<? super ActionRequest, RequestOptions> optionsFn) {\n+        this.optionsFn = checkSerializable(optionsFn, \"optionsFn\");\n+        return this;\n+    }\n+\n+    /**\n+     * Enable slicing\n+     * <p>\n+     * Number of slices is equal to globalParallelism (localParallelism * numberOfNodes)\n+     * <p>\n+     * Use this option to read from multiple shards in parallel.\n+     *\n+     * @see\n+     * <a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-body.html#sliced-scroll\">\n+     *     Sliced Scroll</a>\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> enableSlicing() {\n+        this.slicing = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Enable co-located reading\n+     *\n+     * Jet cluster member must run exactly on the same nodes as Elastic cluster.\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> enableCoLocatedReading() {\n+        this.coLocatedReading = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Set the keepAlive for Elastic search scroll\n+     * <p>\n+     * See {@link SearchRequest#scroll(String)}\n+     *\n+     * @param scrollKeepAlive keepAlive value, this must be high enough to process all results from a single scroll,\n+     *                        default value 1m\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> scrollKeepAlive(@Nonnull String scrollKeepAlive) {\n+        this.scrollKeepAlive = requireNonNull(scrollKeepAlive, scrollKeepAlive);\n+        return this;\n+    }\n+\n+    /**\n+     * Set the local parallelism of this source.\n+     *\n+     * Note this has an effect only when {@link #enableCoLocatedReading()} or {@link #enableSlicing()} is enabled,\n+     * otherwise the data is read only from 1 processor in whole Jet cluster.\n+     */\n+    @Nonnull\n+    public ElasticSourceBuilder<T> preferredLocalParallelism(int preferredLocalParallelism) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f11a25723a1fef7f1d22d7450943ad6d0e0b5ca"}, "originalPosition": 233}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4ODg5NzYwOnYy", "diffSide": "RIGHT", "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/AuthElasticSinksTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwOTozNjowOFrOGbtVYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMjozNDo1NlrOGbzBeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcwNzQ4OQ==", "bodyText": "Why don't we create the container at @BeforeClass phase and stop it at @AfterClass ?\nCurrently we wait for all the test suite to complete and then stop the container via shutdown hook.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r431707489", "createdAt": "2020-05-28T09:36:08Z", "author": {"login": "gurbuzali"}, "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/AuthElasticSinksTest.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.JetTestInstanceFactory;\n+import com.hazelcast.jet.config.JetConfig;\n+import com.hazelcast.jet.elastic.CommonElasticSinksTest.TestItem;\n+import com.hazelcast.jet.impl.util.Util;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.jet.pipeline.Sink;\n+import com.hazelcast.jet.pipeline.test.TestSources;\n+import org.elasticsearch.ElasticsearchStatusException;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.WriteRequest.RefreshPolicy;\n+import org.elasticsearch.client.RestClientBuilder;\n+import org.junit.After;\n+import org.junit.Test;\n+import org.testcontainers.elasticsearch.ElasticsearchContainer;\n+\n+import java.io.IOException;\n+import java.util.function.Supplier;\n+\n+import static com.hazelcast.jet.elastic.ElasticClients.client;\n+import static com.hazelcast.jet.elastic.ElasticSupport.ELASTICSEARCH_IMAGE;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+public class AuthElasticSinksTest extends BaseElasticTest {\n+\n+    /**\n+     * Using elastic container configured with security enabled\n+     */\n+    public static Supplier<ElasticsearchContainer> elastic = Util.memoize(() -> {\n+        ElasticsearchContainer elastic = new ElasticsearchContainer(ELASTICSEARCH_IMAGE)\n+                .withEnv(\"ELASTIC_USERNAME\", \"elastic\")\n+                .withEnv(\"ELASTIC_PASSWORD\", \"SuperSecret\")\n+                .withEnv(\"xpack.security.enabled\", \"true\");\n+\n+        elastic.start();\n+        Runtime.getRuntime().addShutdownHook(new Thread(elastic::stop));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b468d088bc37f58643c774eb3e2d60626b949ff4"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTgwMDY5Ng==", "bodyText": "This is to avoid starting the container multiple times for different classes.\nThere were separate secured instances in AuthElasticSinksTest and AuthElasticSourcesTest, moved this to ElasticSupport.", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2098#discussion_r431800696", "createdAt": "2020-05-28T12:34:56Z", "author": {"login": "frant-hartm"}, "path": "extensions/elasticsearch/elasticsearch-7/src/test/java/com/hazelcast/jet/elastic/AuthElasticSinksTest.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.elastic;\n+\n+import com.hazelcast.function.SupplierEx;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.JetTestInstanceFactory;\n+import com.hazelcast.jet.config.JetConfig;\n+import com.hazelcast.jet.elastic.CommonElasticSinksTest.TestItem;\n+import com.hazelcast.jet.impl.util.Util;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.jet.pipeline.Sink;\n+import com.hazelcast.jet.pipeline.test.TestSources;\n+import org.elasticsearch.ElasticsearchStatusException;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.WriteRequest.RefreshPolicy;\n+import org.elasticsearch.client.RestClientBuilder;\n+import org.junit.After;\n+import org.junit.Test;\n+import org.testcontainers.elasticsearch.ElasticsearchContainer;\n+\n+import java.io.IOException;\n+import java.util.function.Supplier;\n+\n+import static com.hazelcast.jet.elastic.ElasticClients.client;\n+import static com.hazelcast.jet.elastic.ElasticSupport.ELASTICSEARCH_IMAGE;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+public class AuthElasticSinksTest extends BaseElasticTest {\n+\n+    /**\n+     * Using elastic container configured with security enabled\n+     */\n+    public static Supplier<ElasticsearchContainer> elastic = Util.memoize(() -> {\n+        ElasticsearchContainer elastic = new ElasticsearchContainer(ELASTICSEARCH_IMAGE)\n+                .withEnv(\"ELASTIC_USERNAME\", \"elastic\")\n+                .withEnv(\"ELASTIC_PASSWORD\", \"SuperSecret\")\n+                .withEnv(\"xpack.security.enabled\", \"true\");\n+\n+        elastic.start();\n+        Runtime.getRuntime().addShutdownHook(new Thread(elastic::stop));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcwNzQ4OQ=="}, "originalCommit": {"oid": "b468d088bc37f58643c774eb3e2d60626b949ff4"}, "originalPosition": 56}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4764, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}