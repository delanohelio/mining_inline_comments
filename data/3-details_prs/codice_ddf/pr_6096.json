{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyMTM3OTkw", "number": 6096, "title": "[2.20.x-perf] DDF-6097 Update PreFederatedQueryPlugin logic to maintain context", "bodyText": "What does this PR do?\nBackend\n\nPass a synchronized hashmap for properties to the QueryResponse that accumulates results in the OffsetResultHandler so that they are not thrown away.\nAllow PostFederatedQueryPlugins that were ran after a Source Error occured to still return an updated QueryResponse.\nMove the calculation/aggregation of hits per source, properties, and processing details to after any PostFederatedQueryPlugins are ran so that even those ran after a Source Error are included.\nPass ProcessingDetails from the SourceResponse to each invocation of a PreFederatedQueryPlugin.\nRemove where the ProcessingDetails from the SourceResponse were being copied into the final QueryResponse. This is done so that if you have a PostFederatedQueryPlugin that wants to mutate/remove any of these errors, they are not still copied into the final set of ProcessingDetails.\nRemove the source.isAvailable() check in QueryOperations so that you can still end up in a PostFederatedQueryPlugin even if the source was unavailable.\nAdded a new warning field on Status.java that adds all non-exception ProcessingDetails. (Unsure if this is safe).\n\nFrontend\n\nAdded correct calculations for start indexes by summing the startIndexes of each source before making a multi-source query.\nFixed pagination in that the total hits count wasn't being calculated correctly and it looked like you had more pages to go through when you actually were at the last page.\nAdded a new warning triangle in yellow to indicate if the Status for a query had any warnings.\n\n\n\nImproved spacing on the selected sources list (the source names were too close to the icons)\n\n\nChanged Bundles\ncatalog/ui/catalog-ui-search\ncatalog/core/catalog-core-standardframework\nWho is reviewing it?\n\n@rzwiefel\n@derekwilhelm\nSelect relevant component teams:\n@codice/core-apis\n@codice/security\n@codice/solr\n@codice/ui\nAsk 2 committers to review/merge the PR and tag them here.\n@pklinef\n@jlcsmith\nHow should this be tested?\n\nAny background context you want to provide?\nWhat are the relevant tickets?\nFixes: #6097\nScreenshots\n\nChecklist:\n\n Documentation Updated\n Update / Add Threat Dragon models\n Update / Add Unit Tests\n Update / Add Integration Tests\n\nNotes on Review Process\nPlease see Notes on Review Process for further guidance on requirements for merging and abbreviated reviews.\nReview Comment Legend:\n\n\u270f\ufe0f (Pencil) This comment is a nitpick or style suggestion, no action required for approval. This comment should provide a suggestion either as an in line code snippet or a gist.\n\u2753 (Question Mark) This comment is to gain a clearer understanding of design or code choices, clarification is required but action may not be necessary for approval.\n\u2757 (Exclamation Mark) This comment is critical and requires clarification or action before approval.", "createdAt": "2020-05-22T21:06:47Z", "url": "https://github.com/codice/ddf/pull/6096", "merged": true, "mergeCommit": {"oid": "87b0f770fdc22740b973b0330db73593b0aaa6aa"}, "closed": true, "closedAt": "2020-05-27T21:55:50Z", "author": {"login": "Bdthomson"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcj5ANdgFqTQxNzE4NzMxMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABclgYnqABqjMzODAxOTc4NTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MTg3MzEx", "url": "https://github.com/codice/ddf/pull/6096#pullrequestreview-417187311", "createdAt": "2020-05-22T21:18:15Z", "commit": {"oid": "b19884e64702c69671d257c02faf15fb26eeb951"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMToxODoxNVrOGZj2Ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMToxODoxNVrOGZj2Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ1NDg1MA==", "bodyText": "This does lead to a bit of log pollution, at least for the source I was using (CSW Specification Profile Federated Source). As the query fails (which it should if the source is unavailable), the logs show Caused by: javax.xml.bind.UnmarshalException on each failed query.", "url": "https://github.com/codice/ddf/pull/6096#discussion_r429454850", "createdAt": "2020-05-22T21:18:15Z", "author": {"login": "Bdthomson"}, "path": "catalog/core/catalog-core-standardframework/src/main/java/ddf/catalog/impl/operations/QueryOperations.java", "diffHunk": "@@ -828,7 +828,7 @@ QuerySources initializeSources(\n               if (!canAccessSource) {\n                 notPermittedSources.add(source.getId());\n               }\n-              if (source.isAvailable() && canAccessSource) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b19884e64702c69671d257c02faf15fb26eeb951"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MTg3NjMx", "url": "https://github.com/codice/ddf/pull/6096#pullrequestreview-417187631", "createdAt": "2020-05-22T21:19:03Z", "commit": {"oid": "b19884e64702c69671d257c02faf15fb26eeb951"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMToxOTowM1rOGZj29g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMToxOTowM1rOGZj29g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ1NTA5NA==", "bodyText": "Is this a potential security risk? Depending on what is placed on ProcessingDetails?", "url": "https://github.com/codice/ddf/pull/6096#discussion_r429455094", "createdAt": "2020-05-22T21:19:03Z", "author": {"login": "Bdthomson"}, "path": "catalog/ui/catalog-ui-search/src/main/java/org/codice/ddf/catalog/ui/query/cql/Status.java", "diffHunk": "@@ -29,13 +32,16 @@\n \n   private final boolean successful;\n \n+  private List<String> warnings = new ArrayList<>();\n+\n   public Status(QueryResponse response, String source, long elapsedTime) {\n     elapsed = elapsedTime;\n     id = source;\n \n     count = response.getResults().size();\n     hits = response.getHits();\n     successful = isSuccessful(response.getProcessingDetails());\n+    warnings = getWarnings(response.getProcessingDetails());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b19884e64702c69671d257c02faf15fb26eeb951"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MTg4MDcy", "url": "https://github.com/codice/ddf/pull/6096#pullrequestreview-417188072", "createdAt": "2020-05-22T21:20:23Z", "commit": {"oid": "b19884e64702c69671d257c02faf15fb26eeb951"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMToyMDoyM1rOGZj4Uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQyMToyMDoyM1rOGZj4Uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ1NTQ0Mw==", "bodyText": "This was a question for @andrewkfiedler. Nothing seems to be broken, but the key was changed from status to statusBySource on the CqlQueryResponse, this might be fine because we map that to just a list of status in the UI.", "url": "https://github.com/codice/ddf/pull/6096#discussion_r429455443", "createdAt": "2020-05-22T21:20:23Z", "author": {"login": "Bdthomson"}, "path": "ui/packages/catalog-ui-search/src/main/webapp/js/model/Query.js", "diffHunk": "@@ -478,6 +485,7 @@ Query.Model = PartialAssociatedModel.extend({\n               })\n             }\n \n+            // TODO: Need to do something here?\n             const srcStatus = result.get('status').get(search.src)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b19884e64702c69671d257c02faf15fb26eeb951"}, "originalPosition": 97}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NDgxOTYx", "url": "https://github.com/codice/ddf/pull/6096#pullrequestreview-419481961", "createdAt": "2020-05-27T18:04:55Z", "commit": {"oid": "b19884e64702c69671d257c02faf15fb26eeb951"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3337f6477143730c992ae94f09edfeca5637e64a", "author": {"user": null}, "url": "https://github.com/codice/ddf/commit/3337f6477143730c992ae94f09edfeca5637e64a", "committedDate": "2020-05-26T21:06:01Z", "message": "Merge remote-tracking branch 'origin/2.20.x-perf' into 2.20.x-perf-plugin-edition"}, "afterCommit": {"oid": "bbde3e1c138b22dd0a341171a5dd4f895f30954f", "author": {"user": null}, "url": "https://github.com/codice/ddf/commit/bbde3e1c138b22dd0a341171a5dd4f895f30954f", "committedDate": "2020-05-27T20:13:35Z", "message": "Update unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3190a4650d68f1b85a1090359a56799e35ad0008", "author": {"user": null}, "url": "https://github.com/codice/ddf/commit/3190a4650d68f1b85a1090359a56799e35ad0008", "committedDate": "2020-05-27T21:40:02Z", "message": "Calculate startindex from statusBySource"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e5d8852e0468c9b5c2b30d93000dc9f2c77fb32", "author": {"user": null}, "url": "https://github.com/codice/ddf/commit/4e5d8852e0468c9b5c2b30d93000dc9f2c77fb32", "committedDate": "2020-05-27T21:40:02Z", "message": "Allow PostFederatedQueryPlugins to return query responses\n\n- Allow PostFederatedQueryPlugins to be ran on sources that are \"unavailable\"\nFix issues with post federated\n\n\na\n\n\na"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e84c66073be9852e369450431956b981e2b9cfce", "author": {"user": null}, "url": "https://github.com/codice/ddf/commit/e84c66073be9852e369450431956b981e2b9cfce", "committedDate": "2020-05-27T21:40:02Z", "message": "Fix spacing on source list"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36abaf29cf1bc5db4b8cff4d8c2594b1eb3061ca", "author": {"user": null}, "url": "https://github.com/codice/ddf/commit/36abaf29cf1bc5db4b8cff4d8c2594b1eb3061ca", "committedDate": "2020-05-27T21:40:02Z", "message": "Remove console log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b48d7ce07afa6ecbb22ca2184d1f98a5db1b8446", "author": {"user": null}, "url": "https://github.com/codice/ddf/commit/b48d7ce07afa6ecbb22ca2184d1f98a5db1b8446", "committedDate": "2020-05-27T21:40:02Z", "message": "Update unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "868ae93186f858033b53ced13a56a36bc08f1727", "author": {"user": null}, "url": "https://github.com/codice/ddf/commit/868ae93186f858033b53ced13a56a36bc08f1727", "committedDate": "2020-05-27T21:40:02Z", "message": "Update another test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c2286f027fc17f3fa3402646afc8bea6184e31b", "author": {"user": null}, "url": "https://github.com/codice/ddf/commit/1c2286f027fc17f3fa3402646afc8bea6184e31b", "committedDate": "2020-05-27T21:40:02Z", "message": "Fix unit tests and core logic"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5687e6fbabd30d79f3dabb2206f05900147a1357", "author": {"user": null}, "url": "https://github.com/codice/ddf/commit/5687e6fbabd30d79f3dabb2206f05900147a1357", "committedDate": "2020-05-27T20:19:29Z", "message": "Update another test"}, "afterCommit": {"oid": "1c2286f027fc17f3fa3402646afc8bea6184e31b", "author": {"user": null}, "url": "https://github.com/codice/ddf/commit/1c2286f027fc17f3fa3402646afc8bea6184e31b", "committedDate": "2020-05-27T21:40:02Z", "message": "Fix unit tests and core logic"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 931, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}