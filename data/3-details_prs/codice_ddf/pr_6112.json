{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2ODQxNTU1", "number": 6112, "title": "DDF-6111 Changes the CSRF filter from being a servlet filter to a security filter to prevent future race condition", "bodyText": "What does this PR do?\nChanges the CSRF filter from being a servlet filter to a security filter to prevent future race condition\nWho is reviewing it?\n@bakejeyner\n@garrettfreibott\n@SmithJosh\n@stustison\nSelect relevant component teams:\n@codice/security\nHow should this be tested?\n\n Verify that browser protection works:\n\nShould get a 403 when hitting jolokia endpoints and the system doesn't change because of that request\nHitting endpoints under /search/catalog/internal from non-browser user-agents will be forbidden unless specific headers are present or are whitelisted contexts\n\n\n Verify system protection works\n\nHitting endpoints under /services from the browser will be forbidden unless they are whitelisted\n\n\n Verify that turning the CSRF filter through the custom.system.properties works\n\nWhat are the relevant tickets?\nFixes: #6111\nChecklist:\n\n Documentation Updated\n Update / Add Threat Dragon models\n Update / Add Unit Tests\n Update / Add Integration Tests\n\nNotes on Review Process\nPlease see Notes on Review Process for further guidance on requirements for merging and abbreviated reviews.\nReview Comment Legend:\n\n\u270f\ufe0f (Pencil) This comment is a nitpick or style suggestion, no action required for approval. This comment should provide a suggestion either as an in line code snippet or a gist.\n\u2753 (Question Mark) This comment is to gain a clearer understanding of design or code choices, clarification is required but action may not be necessary for approval.\n\u2757 (Exclamation Mark) This comment is critical and requires clarification or action before approval.", "createdAt": "2020-06-02T21:33:51Z", "url": "https://github.com/codice/ddf/pull/6112", "merged": true, "mergeCommit": {"oid": "dfec936f56c3f5ca5f890e7dd42695cb7c6acc98"}, "closed": true, "closedAt": "2020-06-09T15:38:34Z", "author": {"login": "blen-desta"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcncHBAAFqTQyMzA4NDM1OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpaQOjAH2gAyNDI2ODQxNTU1OjliNzgzNzFkNGEzOWFiNmFmOWM4ZThhMGRmZWY0MWJmYzdhN2NmNjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMDg0MzU5", "url": "https://github.com/codice/ddf/pull/6112#pullrequestreview-423084359", "createdAt": "2020-06-02T21:54:08Z", "commit": {"oid": "83012cd46d2943c4e7baa11d8f72f9197fb15726"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMTI1NDAz", "url": "https://github.com/codice/ddf/pull/6112#pullrequestreview-423125403", "createdAt": "2020-06-02T23:34:34Z", "commit": {"oid": "83012cd46d2943c4e7baa11d8f72f9197fb15726"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMzozNDozNVrOGeHWQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQyMzozOTo0N1rOGeHcDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIzMDg0OQ==", "bodyText": "\u2753 Where does this place the CSRF filter in the order? Before the auth filters?", "url": "https://github.com/codice/ddf/pull/6112#discussion_r434230849", "createdAt": "2020-06-02T23:34:35Z", "author": {"login": "SmithJosh"}, "path": "platform/security/filter/security-filter-csrf/src/main/resources/OSGI-INF/blueprint/blueprint.xml", "diffHunk": "@@ -0,0 +1,49 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!-- /**\n+ * Copyright (c) Codice Foundation\n+ *\n+ * This is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser General Public License as published by the Free Software Foundation, either\n+ * version 3 of the License, or any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n+ * See the GNU Lesser General Public License for more details. A copy of the GNU Lesser General Public License is distributed along with this program and can be found at\n+ * <http://www.gnu.org/licenses/lgpl.html>.\n+ *\n+ **/ -->\n+<blueprint xmlns=\"http://www.osgi.org/xmlns/blueprint/v1.0.0\">\n+\n+  <reference id=\"securityLogger\" interface=\"ddf.security.audit.SecurityLogger\" availability=\"optional\"/>\n+\n+  <bean id=\"filter\" class=\"org.codice.ddf.security.filter.csrf.CsrfFilter\">\n+    <argument ref=\"securityLogger\"/>\n+    <property name=\"whiteListContexts\">\n+      <array value-type=\"java.lang.String\">\n+        <value>/services[/]?$=GET</value>\n+        <value>/services/admin/config[/]?$=GET</value>\n+        <value>/services/content[/]?$=GET</value>\n+        <value>/services/catalog/query[/]?$=GET</value> <!-- Simple Search -->\n+        <value>/services/catalog/sources.*=GET</value> <!-- REST Action providers -->\n+        <value>/services/internal/catalog/download/cache.*=GET</value>\n+        <value>/services/internal/session.*=GET</value>\n+        <value>/services/internal/metrics.*=GET</value>\n+        <value>/services/logout/actions[/]?$=GET</value>\n+        <value>/services/logout/local[/]?$=GET</value>\n+        <value>/services/platform/config/ui[/]?$=GET</value>\n+        <value>/services/saml/logout[/]?$=GET</value>\n+        <value>/services/saml/logout/request[/]?$=GET</value>\n+        <value>/services/saml/sso[/]?$=POST</value>\n+        <value>/services/saml/sso/metadata[/]?$=GET</value>\n+        <value>/services/store/config[/]?$=GET</value>\n+        <value>/services/internal/registries.*=GET</value>\n+        <value>/services/oidc/logout.*=GET</value>\n+      </array>\n+    </property>\n+  </bean>\n+\n+  <service ref=\"filter\" interface=\"org.codice.ddf.platform.filter.SecurityFilter\" ranking=\"101\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83012cd46d2943c4e7baa11d8f72f9197fb15726"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDIzMjMzMw==", "bodyText": "\u270f\ufe0f Just a minor thing, but an \"authorization failure\" would be more fitting imo", "url": "https://github.com/codice/ddf/pull/6112#discussion_r434232333", "createdAt": "2020-06-02T23:39:47Z", "author": {"login": "SmithJosh"}, "path": "platform/security/filter/security-filter-csrf/src/main/java/org/codice/ddf/security/filter/csrf/CsrfFilter.java", "diffHunk": "@@ -174,14 +176,14 @@ public void doFilter(ServletRequest request, ServletResponse response, FilterCha\n       if (protectedContexts.stream().anyMatch(targetContextPath::startsWith)\n           && doBrowserProtectionFilter(\n               httpRequest, httpResponse, targetContextPath, requestMethod)) {\n-        return;\n+        throw new AuthenticationFailureException();\n       }\n \n       // Execute CSRF check if user is accessing /services\n       if (targetContextPath.startsWith(SERVICE_CONTEXT)\n           && doSystemProtectionFilter(\n               httpRequest, httpResponse, targetContextPath, requestMethod, userAgentHeader)) {\n-        return;\n+        throw new AuthenticationFailureException();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83012cd46d2943c4e7baa11d8f72f9197fb15726"}, "originalPosition": 95}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba2281800f7334b5d589f76100cb1878b39688a3", "author": {"user": {"login": "blen-desta", "name": "Blen Desta"}}, "url": "https://github.com/codice/ddf/commit/ba2281800f7334b5d589f76100cb1878b39688a3", "committedDate": "2020-06-03T16:30:33Z", "message": "DDF-6111 Changes the CSRF filter from being a servlet filter to a security filter to prevent future race condition"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83012cd46d2943c4e7baa11d8f72f9197fb15726", "author": {"user": {"login": "blen-desta", "name": "Blen Desta"}}, "url": "https://github.com/codice/ddf/commit/83012cd46d2943c4e7baa11d8f72f9197fb15726", "committedDate": "2020-06-02T21:06:22Z", "message": "DDF-6111 Changes the CSRF filter from being a servlet filter to a security filter to prevent future race condition"}, "afterCommit": {"oid": "ba2281800f7334b5d589f76100cb1878b39688a3", "author": {"user": {"login": "blen-desta", "name": "Blen Desta"}}, "url": "https://github.com/codice/ddf/commit/ba2281800f7334b5d589f76100cb1878b39688a3", "committedDate": "2020-06-03T16:30:33Z", "message": "DDF-6111 Changes the CSRF filter from being a servlet filter to a security filter to prevent future race condition"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzODQwMDgy", "url": "https://github.com/codice/ddf/pull/6112#pullrequestreview-423840082", "createdAt": "2020-06-03T18:55:46Z", "commit": {"oid": "ba2281800f7334b5d589f76100cb1878b39688a3"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxODo1NTo0N1rOGepMBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxODo1NTo0N1rOGepMBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc4NTI4Ng==", "bodyText": "\u2753 Can't seem to figure out where the CSRF filter reads from custom.system.properties.", "url": "https://github.com/codice/ddf/pull/6112#discussion_r434785286", "createdAt": "2020-06-03T18:55:47Z", "author": {"login": "bakejeyner"}, "path": "distribution/ddf-common/src/main/resources/security/default.policy", "diffHunk": "@@ -307,6 +307,10 @@ grant codeBase \"file:/admin-core-jolokia/javax.servlet-api/org.apache.shiro.core\n     permission java.security.SecurityPermission \"insertProvider\";\n }\n \n+grant codeBase \"file:/security-filter-csrf\" {\n+    permission java.io.FilePermission \"${ddf.home.perm}etc${/}custom.system.properties\", \"read\";\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba2281800f7334b5d589f76100cb1878b39688a3"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NjI3Mzc4", "url": "https://github.com/codice/ddf/pull/6112#pullrequestreview-426627378", "createdAt": "2020-06-08T21:16:09Z", "commit": {"oid": "ba2281800f7334b5d589f76100cb1878b39688a3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8202e985f21f03d2c73ac82313f8367a55893b8", "author": {"user": {"login": "blen-desta", "name": "Blen Desta"}}, "url": "https://github.com/codice/ddf/commit/e8202e985f21f03d2c73ac82313f8367a55893b8", "committedDate": "2020-06-08T21:40:24Z", "message": "Reordered the filters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b78371d4a39ab6af9c8e8a0dfef41bfc7a7cf61", "author": {"user": {"login": "blen-desta", "name": "Blen Desta"}}, "url": "https://github.com/codice/ddf/commit/9b78371d4a39ab6af9c8e8a0dfef41bfc7a7cf61", "committedDate": "2020-06-09T00:52:14Z", "message": "Fixed unit test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 939, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}