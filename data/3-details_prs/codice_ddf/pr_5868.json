{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyNjIyNTQy", "number": 5868, "title": "[2.19.x] DDF-5867 fix table export Visible", "bodyText": "What does this PR do?\nExport Visible always exports the first page of results, this updates table export to use the correct starting index for visible\nWho is reviewing it?\n@hayleynorton @cassandrabailey293 @zta6 @willwill96\nAsk 2 committers to review/merge the PR and tag them here.\n@bdeining\n@Bdthomson\nHow should this be tested?\n\nbuild / install / run\ningest data and search for it\nexport results via the table\nexport Visible results on multiple different pages and verify correct results are present\nhide a result and verify it is not present when exporting visible results\nverify no other regression in exporting\n\nAny background context you want to provide?\nWhat are the relevant tickets?\nFixes: #5867\nScreenshots\n\nChecklist:\n\n Documentation Updated\n Update / Add Threat Dragon models\n Update / Add Unit Tests\n Update / Add Integration Tests\n\nNotes on Review Process\nPlease see Notes on Review Process for further guidance on requirements for merging and abbreviated reviews.\nReview Comment Legend:\n\n\u270f\ufe0f (Pencil) This comment is a nitpick or style suggestion, no action required for approval. This comment should provide a suggestion either as an in line code snippet or a gist.\n\u2753 (Question Mark) This comment is to gain a clearer understanding of design or code choices, clarification is required but action may not be necessary for approval.\n\u2757 (Exclamation Mark) This comment is critical and requires clarification or action before approval.", "createdAt": "2020-03-02T21:40:40Z", "url": "https://github.com/codice/ddf/pull/5868", "merged": true, "mergeCommit": {"oid": "4be57b1a7851995cf8a111fbfb9adf2d91c81142"}, "closed": true, "closedAt": "2020-03-26T17:49:46Z", "author": {"login": "andrewzimmer"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJ0murAH2gAyMzgyNjIyNTQyOjdkZjEwY2QwNmQ4NjlkMjU4NmQ2YzA3Y2I2ZTQ3ZWExNjdlOGM4NmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRf2NoAFqTM4MjI1OTczMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7df10cd06d869d2586d6c07cb6e47ea167e8c86d", "author": {"user": {"login": "andrewzimmer", "name": null}}, "url": "https://github.com/codice/ddf/commit/7df10cd06d869d2586d6c07cb6e47ea167e8c86d", "committedDate": "2020-03-02T21:28:46Z", "message": "DDF-5867 fix table export Visible"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MTI3NTU4", "url": "https://github.com/codice/ddf/pull/5868#pullrequestreview-368127558", "createdAt": "2020-03-03T16:25:04Z", "commit": {"oid": "7df10cd06d869d2586d6c07cb6e47ea167e8c86d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNjoyNTowNFrOFxNA_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNjoyNTowNFrOFxNA_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzEzNzc5MA==", "bodyText": "so this results is a subset fo the total results, if the results exceeded the size of the request, right? I guess there's no way to only get the number that we want, i.e. cqlTransformRequest.getCount() number of results", "url": "https://github.com/codice/ddf/pull/5868#discussion_r387137790", "createdAt": "2020-03-03T16:25:04Z", "author": {"login": "cassandrabailey293"}, "path": "catalog/ui/catalog-ui-search/src/main/java/org/codice/ddf/catalog/ui/query/handlers/CqlTransformHandler.java", "diffHunk": "@@ -158,7 +234,48 @@ public Object handle(Request request, Response response) throws Exception {\n       return ImmutableMap.of(\"message\", \"Service not found\");\n     }\n \n-    CqlQueryResponse cqlQueryResponse = cqlQueryUtil.executeCqlQuery(cqlRequest);\n+    List<Result> results =\n+        cqlRequests\n+            .stream()\n+            .map(\n+                cqlRequest -> {\n+                  CqlQueryResponse cqlQueryResponse = null;\n+                  try {\n+                    cqlQueryResponse = cqlQueryUtil.executeCqlQuery(cqlRequest);\n+                  } catch (Exception e) {\n+                    LOGGER.debug(\"Error fetching cql request for {}\", cqlRequest.getSrc());\n+                    return null;\n+                  }\n+                  return cqlQueryResponse.getQueryResponse().getResults();\n+                })\n+            .filter(cqlResults -> CollectionUtils.isNotEmpty(cqlResults))\n+            .flatMap(cqlResults -> cqlResults.stream())\n+            .collect(Collectors.toList());\n+\n+    results.sort(getResultComparators(cqlTransformRequest.getSorts()));\n+\n+    results =\n+        results.size() > cqlTransformRequest.getCount()\n+            ? results.subList(0, cqlTransformRequest.getCount())\n+            : results;\n+\n+    results =\n+        CollectionUtils.isEmpty(cqlTransformRequest.getHiddenResults())\n+            ? results\n+            : results\n+                .stream()\n+                .filter(\n+                    result ->\n+                        !cqlTransformRequest\n+                            .getHiddenResults()\n+                            .contains(result.getMetacard().getId()))\n+                .collect(Collectors.toList());\n+\n+    QueryResponse combinedResponse =\n+        new QueryResponseImpl(\n+            new QueryRequestImpl(new QueryImpl(ECQL.toFilter(cqlRequests.get(0).getCql()))),\n+            results,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7df10cd06d869d2586d6c07cb6e47ea167e8c86d"}, "originalPosition": 177}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MTMxODM1", "url": "https://github.com/codice/ddf/pull/5868#pullrequestreview-368131835", "createdAt": "2020-03-03T16:29:35Z", "commit": {"oid": "7df10cd06d869d2586d6c07cb6e47ea167e8c86d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNjoyOTozNVrOFxNObA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNjoyOTozNVrOFxNObA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE0MTIyOA==", "bodyText": "\u2753 what's the hidden results for?", "url": "https://github.com/codice/ddf/pull/5868#discussion_r387141228", "createdAt": "2020-03-03T16:29:35Z", "author": {"login": "cassandrabailey293"}, "path": "ui/packages/catalog-ui-search/src/main/webapp/extension-points/table-export/table-export.tsx", "diffHunk": "@@ -165,19 +156,30 @@ export const getDownloadBody = (downloadInfo: DownloadInfo) => {\n     getExportCount({ exportSize, selectionInterface, customExportCount }),\n     properties.exportResultLimit\n   )\n-  const cql = getCqlForSize(exportSize, count, selectionInterface)\n+  const cql = selectionInterface.getCurrentQuery().get('cql')\n   const srcs = getSrcs(selectionInterface)\n   const sorts = getSorts(selectionInterface)\n+  const hiddenResults = getHiddenResults(exportSize)\n   const args = {\n     hiddenFields: hiddenFields.length > 0 ? hiddenFields : [],\n     columnOrder: columnOrder.length > 0 ? columnOrder : {},\n     columnAliasMap: properties.attributeAliases,\n   }\n+\n+  const searches = srcs.map((src: string) => {\n+    const start = getStartIndex(src, exportSize, selectionInterface)\n+    return {\n+      src,\n+      cql,\n+      start,\n+    }\n+  })\n+\n   return {\n-    cql,\n-    srcs,\n+    searches,\n     count,\n     sorts,\n+    hiddenResults,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7df10cd06d869d2586d6c07cb6e47ea167e8c86d"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95204536546b2a9a106dce047a74ef55ab2ac55f", "author": {"user": {"login": "andrewzimmer", "name": null}}, "url": "https://github.com/codice/ddf/commit/95204536546b2a9a106dce047a74ef55ab2ac55f", "committedDate": "2020-03-03T17:02:25Z", "message": "DDF-5867 combine srcs for export all/exact"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MjA2NjIw", "url": "https://github.com/codice/ddf/pull/5868#pullrequestreview-368206620", "createdAt": "2020-03-03T18:08:50Z", "commit": {"oid": "95204536546b2a9a106dce047a74ef55ab2ac55f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MjExNzY1", "url": "https://github.com/codice/ddf/pull/5868#pullrequestreview-368211765", "createdAt": "2020-03-03T18:16:37Z", "commit": {"oid": "7df10cd06d869d2586d6c07cb6e47ea167e8c86d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c43593d1d487eacad775ce2ed6d7ae6f299d1763", "author": {"user": {"login": "andrewzimmer", "name": null}}, "url": "https://github.com/codice/ddf/commit/c43593d1d487eacad775ce2ed6d7ae6f299d1763", "committedDate": "2020-03-04T18:33:31Z", "message": "DDF-5867 add individual source count"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5MDQ2ODA1", "url": "https://github.com/codice/ddf/pull/5868#pullrequestreview-369046805", "createdAt": "2020-03-04T19:10:23Z", "commit": {"oid": "c43593d1d487eacad775ce2ed6d7ae6f299d1763"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMzA0Njkz", "url": "https://github.com/codice/ddf/pull/5868#pullrequestreview-372304693", "createdAt": "2020-03-10T20:40:15Z", "commit": {"oid": "c43593d1d487eacad775ce2ed6d7ae6f299d1763"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57b8ef7fbc6b4f370cb00d422bd089203173f544", "author": {"user": {"login": "andrewzimmer", "name": null}}, "url": "https://github.com/codice/ddf/commit/57b8ef7fbc6b4f370cb00d422bd089203173f544", "committedDate": "2020-03-18T15:03:23Z", "message": "DDF-5867 fix exporting incorrect results with cache active"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5575eff9a3d3be8681cd67f46c7cb193f182f25", "author": {"user": {"login": "andrewzimmer", "name": null}}, "url": "https://github.com/codice/ddf/commit/a5575eff9a3d3be8681cd67f46c7cb193f182f25", "committedDate": "2020-03-18T16:37:20Z", "message": "DDF-5867 undelete function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1be037908761f61df0243506acc82cbcb41e8e94", "author": {"user": {"login": "andrewzimmer", "name": null}}, "url": "https://github.com/codice/ddf/commit/1be037908761f61df0243506acc82cbcb41e8e94", "committedDate": "2020-03-19T19:37:35Z", "message": "DDF-5867 fix incorrect start index"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf687726f96df153dc1ad0d7f11e96c56602df32", "author": {"user": {"login": "andrewzimmer", "name": null}}, "url": "https://github.com/codice/ddf/commit/cf687726f96df153dc1ad0d7f11e96c56602df32", "committedDate": "2020-03-19T20:12:25Z", "message": "DDF-5867 fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7305482f34b58cee863a2e7f74f2abeb73c683c0", "author": {"user": {"login": "andrewzimmer", "name": null}}, "url": "https://github.com/codice/ddf/commit/7305482f34b58cee863a2e7f74f2abeb73c683c0", "committedDate": "2020-03-24T18:35:15Z", "message": "DDF-5867 addressing comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dda0d1a28860d3571a856e5a8468d21242706bb5", "author": {"user": {"login": "andrewzimmer", "name": null}}, "url": "https://github.com/codice/ddf/commit/dda0d1a28860d3571a856e5a8468d21242706bb5", "committedDate": "2020-03-24T23:50:22Z", "message": "DDF-5867 fix no source case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMjU5NzMy", "url": "https://github.com/codice/ddf/pull/5868#pullrequestreview-382259732", "createdAt": "2020-03-26T17:49:04Z", "commit": {"oid": "dda0d1a28860d3571a856e5a8468d21242706bb5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 41, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}