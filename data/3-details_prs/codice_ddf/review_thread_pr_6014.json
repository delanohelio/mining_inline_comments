{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3OTk4MDEw", "number": 6014, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODowODo1MFrOD5GrHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODoxNDoxNFrOD5GzjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMjA0NzY0OnYy", "diffSide": "RIGHT", "path": "catalog/ui/catalog-ui-search/src/main/java/org/codice/ddf/catalog/ui/security/accesscontrol/AccessControlAccessPlugin.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODowODo1MVrOGQMCYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODo1MjoxOVrOGQNn7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYyNzYxNg==", "bodyText": "\u2753 does calling this put mutate the prev metacard? it's adding the remove-user-access into the prevMap, but is that updating the metacard itself?", "url": "https://github.com/codice/ddf/pull/6014#discussion_r419627616", "createdAt": "2020-05-04T18:08:51Z", "author": {"login": "cassandrabailey293"}, "path": "catalog/ui/catalog-ui-search/src/main/java/org/codice/ddf/catalog/ui/security/accesscontrol/AccessControlAccessPlugin.java", "diffHunk": "@@ -104,6 +109,36 @@ private boolean isOwnerChanged(Metacard prev, Metacard updated) {\n     return !isAnyObjectNull(prev, updated) && OWNER_HAS_CHANGED.apply(prev, updated);\n   }\n \n+  private boolean hasRemoveAccess(Metacard updated) {\n+    Attribute attr = updated.getAttribute(Metacard.SECURITY);\n+    if (attr == null) {\n+      return false;\n+    }\n+    Map<String, Set<String>> map = (Map<String, Set<String>>) attr.getValue();\n+    if (map == null) {\n+      return false;\n+    }\n+    KeyValueCollectionPermission securityPermission =\n+        new KeyValueCollectionPermission(CollectionPermission.UPDATE_ACTION, map);\n+    return securityPermission\n+        .getPermissionList()\n+        .stream()\n+        .filter(p -> p instanceof KeyValuePermission)\n+        .map(p -> (KeyValuePermission) p)\n+        .anyMatch(\n+            p ->\n+                \"remove-user-access\".equals(p.getKey())\n+                    && p.getValues().contains(subjectSupplier.get()));\n+  }\n+\n+  private void addRemoveAccess(Metacard prev, Metacard updated) {\n+    Map<String, Set<String>> prevMap =\n+        (Map<String, Set<String>>) prev.getAttribute(Metacard.SECURITY).getValue();\n+    Map<String, Set<String>> updatedMap =\n+        (Map<String, Set<String>>) updated.getAttribute(Metacard.SECURITY).getValue();\n+    prevMap.put(\"remove-user-access\", updatedMap.get(\"remove-user-access\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b32a583bd61a0369b1aa3fed288aafe501025b6b"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY1MzYxMg==", "bodyText": "Yeah prevMap will have the same reference so it will be updated in the metacard obj as well", "url": "https://github.com/codice/ddf/pull/6014#discussion_r419653612", "createdAt": "2020-05-04T18:52:19Z", "author": {"login": "andrewzimmer"}, "path": "catalog/ui/catalog-ui-search/src/main/java/org/codice/ddf/catalog/ui/security/accesscontrol/AccessControlAccessPlugin.java", "diffHunk": "@@ -104,6 +109,36 @@ private boolean isOwnerChanged(Metacard prev, Metacard updated) {\n     return !isAnyObjectNull(prev, updated) && OWNER_HAS_CHANGED.apply(prev, updated);\n   }\n \n+  private boolean hasRemoveAccess(Metacard updated) {\n+    Attribute attr = updated.getAttribute(Metacard.SECURITY);\n+    if (attr == null) {\n+      return false;\n+    }\n+    Map<String, Set<String>> map = (Map<String, Set<String>>) attr.getValue();\n+    if (map == null) {\n+      return false;\n+    }\n+    KeyValueCollectionPermission securityPermission =\n+        new KeyValueCollectionPermission(CollectionPermission.UPDATE_ACTION, map);\n+    return securityPermission\n+        .getPermissionList()\n+        .stream()\n+        .filter(p -> p instanceof KeyValuePermission)\n+        .map(p -> (KeyValuePermission) p)\n+        .anyMatch(\n+            p ->\n+                \"remove-user-access\".equals(p.getKey())\n+                    && p.getValues().contains(subjectSupplier.get()));\n+  }\n+\n+  private void addRemoveAccess(Metacard prev, Metacard updated) {\n+    Map<String, Set<String>> prevMap =\n+        (Map<String, Set<String>>) prev.getAttribute(Metacard.SECURITY).getValue();\n+    Map<String, Set<String>> updatedMap =\n+        (Map<String, Set<String>>) updated.getAttribute(Metacard.SECURITY).getValue();\n+    prevMap.put(\"remove-user-access\", updatedMap.get(\"remove-user-access\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYyNzYxNg=="}, "originalCommit": {"oid": "b32a583bd61a0369b1aa3fed288aafe501025b6b"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMjA2NjE0OnYy", "diffSide": "RIGHT", "path": "catalog/ui/catalog-ui-search/src/main/java/org/codice/ddf/catalog/ui/security/accesscontrol/AccessControlPolicyPlugin.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODoxMzozMFrOGQMNhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODoxMzozMFrOGQMNhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYzMDQ2OA==", "bodyText": "\u270f\ufe0f isOnlyUserAccessControlRemoved for the method name, more consistent with the one above?", "url": "https://github.com/codice/ddf/pull/6014#discussion_r419630468", "createdAt": "2020-05-04T18:13:30Z", "author": {"login": "cassandrabailey293"}, "path": "catalog/ui/catalog-ui-search/src/main/java/org/codice/ddf/catalog/ui/security/accesscontrol/AccessControlPolicyPlugin.java", "diffHunk": "@@ -104,9 +124,64 @@ public PolicyResponse processPostQuery(Result input, Map<String, Serializable> p\n     return new PolicyResponseImpl(Collections.emptyMap(), getPolicy(metacard));\n   }\n \n+  private boolean isUserOnlyRemoved(Metacard prev, Metacard updated, String attribute) {\n+    List<String> prevValues = new ArrayList<>(getValuesOrEmpty(prev, attribute));\n+    List<String> updatedValues = getValuesOrEmpty(updated, attribute);\n+    if (prevValues.size() > updatedValues.size()) {\n+      prevValues.removeAll(updatedValues);\n+      return prevValues.size() == 1 && prevValues.contains(subjectSupplier.get());\n+    }\n+    return false;\n+  }\n+\n+  private boolean isOnlyUserRemovedFromAccessControlAttribute(\n+      Metacard prev, Metacard updated, String attribute) {\n+    if (!attributeHasChanged(prev, updated, attribute)) {\n+      return true;\n+    }\n+    return (Security.ACCESS_ADMINISTRATORS.equals(attribute)\n+            || Security.ACCESS_INDIVIDUALS.equals(attribute)\n+            || Security.ACCESS_INDIVIDUALS_READ.equals(attribute))\n+        && isUserOnlyRemoved(prev, updated, attribute);\n+  }\n+\n+  private boolean onlyUserAccessControlRemoved(Metacard prev, Metacard updated) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b32a583bd61a0369b1aa3fed288aafe501025b6b"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMjA2OTI1OnYy", "diffSide": "RIGHT", "path": "catalog/ui/catalog-ui-search/src/main/java/org/codice/ddf/catalog/ui/security/accesscontrol/AccessControlPolicyPlugin.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODoxNDoxNFrOGQMPZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODoxNDoxNFrOGQMPZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYzMDk1MQ==", "bodyText": "\u270f\ufe0f isOnlyUserRemoved for consistency with the methods below?", "url": "https://github.com/codice/ddf/pull/6014#discussion_r419630951", "createdAt": "2020-05-04T18:14:14Z", "author": {"login": "cassandrabailey293"}, "path": "catalog/ui/catalog-ui-search/src/main/java/org/codice/ddf/catalog/ui/security/accesscontrol/AccessControlPolicyPlugin.java", "diffHunk": "@@ -104,9 +124,64 @@ public PolicyResponse processPostQuery(Result input, Map<String, Serializable> p\n     return new PolicyResponseImpl(Collections.emptyMap(), getPolicy(metacard));\n   }\n \n+  private boolean isUserOnlyRemoved(Metacard prev, Metacard updated, String attribute) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b32a583bd61a0369b1aa3fed288aafe501025b6b"}, "originalPosition": 57}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4741, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}