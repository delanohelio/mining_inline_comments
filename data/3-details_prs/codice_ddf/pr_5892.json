{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2ODI2Mjg2", "number": 5892, "title": "[2.19.x] DDF-UI-111 Fixed drawn geometries and result geometries over anti-meridian", "bodyText": "What does this PR do?\nBefore, if you drew a geometry over the anti-meridian (180 degrees longitude) on the 2D map, the query would return the correct results (within the originally drawn geometry) but the map would show a geometry that would fit within the constraints of the map (see \"before\" gifs below). This did not happen on the 3D map.\nAlso, results whose location geometries were over the anti-meridian would render within the constraints of the map as well.\nWho is reviewing it?\n@andrewzimmer @cassandrabailey293 @zta6\nSelect relevant component teams:\n@codice/ui\nAsk 2 committers to review/merge the PR and tag them here.\n@bdeining\n@millerw8\nHow should this be tested?\nSee gifs below, verify you see the behavior from the \"after\" gif for drawn geometries\nFor result geometries, edit the location attribute with WKTs that cross the antimeridian. Verify that they rendering correctly on the 2D map\nAny background context you want to provide?\nWhat are the relevant tickets?\nFixes: #codice/ddf-ui#111\nG-1595\nScreenshots\nDrawn geometries\nBounding Box before (this change occurs only upon search/save)\n\nBounding Box after\n\nPolygon before (this change occurs immediately after the drawing is complete)\n\nPolygon after\n\nLine before (also occurs immediately after drawing is complete)\n\nLine after\n\nResult geometries\nBased on the result's location WKT, it should appear on the map like this:\n\nBut it was appearing here instead:\n\nNow it appears in the correct location:\n\nChecklist:\n\n Documentation Updated\n Update / Add Threat Dragon models\n Update / Add Unit Tests\n Update / Add Integration Tests\n\nNotes on Review Process\nPlease see Notes on Review Process for further guidance on requirements for merging and abbreviated reviews.\nReview Comment Legend:\n\n\u270f\ufe0f (Pencil) This comment is a nitpick or style suggestion, no action required for approval. This comment should provide a suggestion either as an in line code snippet or a gist.\n\u2753 (Question Mark) This comment is to gain a clearer understanding of design or code choices, clarification is required but action may not be necessary for approval.\n\u2757 (Exclamation Mark) This comment is critical and requires clarification or action before approval.", "createdAt": "2020-03-11T17:31:39Z", "url": "https://github.com/codice/ddf/pull/5892", "merged": true, "mergeCommit": {"oid": "5a07819f431b6258d65c4dc604d7055dcedf5575"}, "closed": true, "closedAt": "2020-03-23T16:24:16Z", "author": {"login": "hayleynorton"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcM8KRlAFqTM3MzU3ODM3OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPLoZ1AFqTM3NzcwMDIyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNTc4Mzc5", "url": "https://github.com/codice/ddf/pull/5892#pullrequestreview-373578379", "createdAt": "2020-03-12T13:58:42Z", "commit": {"oid": "6bbd072fff6e8e393a192bd28a06adc78392f968"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMzo1ODo0MlrOF1fvKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMzo1ODo0MlrOF1fvKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYzODgyNw==", "bodyText": "what do you need this negative local variable for? I think the logic would still be the same if you got rid of it", "url": "https://github.com/codice/ddf/pull/5892#discussion_r391638827", "createdAt": "2020-03-12T13:58:42Z", "author": {"login": "cassandrabailey293"}, "path": "ui/packages/catalog-ui-search/src/main/webapp/component/visualization/maps/geometry.view.js", "diffHunk": "@@ -78,24 +78,47 @@ const GeometryView = Marionette.ItemView.extend({\n       this.stopListening(this.options.clusterCollection)\n     }\n   },\n+  adjustPoints(type, coordinates) {\n+    coordinates.forEach((coord, index) => {\n+      if(index + 1 < coordinates.length) {\n+        let negative = false", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bbd072fff6e8e393a192bd28a06adc78392f968"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNTc5MDgy", "url": "https://github.com/codice/ddf/pull/5892#pullrequestreview-373579082", "createdAt": "2020-03-12T13:59:28Z", "commit": {"oid": "6bbd072fff6e8e393a192bd28a06adc78392f968"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMzo1OToyOVrOF1fxNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMzo1OToyOVrOF1fxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYzOTM0OQ==", "bodyText": "\u270f\ufe0f maybe we can take this commented line out?", "url": "https://github.com/codice/ddf/pull/5892#discussion_r391639349", "createdAt": "2020-03-12T13:59:29Z", "author": {"login": "cassandrabailey293"}, "path": "ui/packages/catalog-ui-search/src/main/webapp/component/visualization/maps/geometry.view.js", "diffHunk": "@@ -78,24 +78,47 @@ const GeometryView = Marionette.ItemView.extend({\n       this.stopListening(this.options.clusterCollection)\n     }\n   },\n+  adjustPoints(type, coordinates) {\n+    coordinates.forEach((coord, index) => {\n+      if(index + 1 < coordinates.length) {\n+        let negative = false\n+        const east = Number(coordinates[index + 1][0])\n+        const west = Number(coordinates[index][0])\n+        if(east - west < -180) {\n+          negative = true\n+          coordinates[index + 1][0] = east + 360\n+        } else if(!negative && east - west > 180) {\n+          coordinates[index][0] = west + 360\n+        }\n+      }\n+    })\n+    // If the geo is a polygon, ensure that the first and last coordinate are the same\n+    if(type.includes('Polygon')) {\n+      coordinates[0][0] = coordinates[coordinates.length - 1][0]\n+    }\n+    return coordinates\n+  },\n   handleGeometry(geometry) {\n     switch (geometry.type) {\n       case 'Point':\n         this.handlePoint(geometry.coordinates)\n         break\n       case 'Polygon':\n         geometry.coordinates.forEach(polygon => {\n+          polygon = this.adjustPoints(geometry.type, polygon)\n           this.handlePoint(polygon[0])\n           this.handleLine(polygon)\n           //this.handlePolygon(polygon);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bbd072fff6e8e393a192bd28a06adc78392f968"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNTgwMDI3", "url": "https://github.com/codice/ddf/pull/5892#pullrequestreview-373580027", "createdAt": "2020-03-12T14:00:31Z", "commit": {"oid": "6bbd072fff6e8e393a192bd28a06adc78392f968"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNDowMDozMVrOF1f0Fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNDowMDozMVrOF1f0Fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0MDA4Ng==", "bodyText": "\u270f\ufe0f same question about getting rid of the commented out line", "url": "https://github.com/codice/ddf/pull/5892#discussion_r391640086", "createdAt": "2020-03-12T14:00:31Z", "author": {"login": "cassandrabailey293"}, "path": "ui/packages/catalog-ui-search/src/main/webapp/component/visualization/maps/geometry.view.js", "diffHunk": "@@ -108,6 +131,7 @@ const GeometryView = Marionette.ItemView.extend({\n       case 'MultiPolygon':\n         geometry.coordinates.forEach(multipolygon => {\n           multipolygon.forEach(polygon => {\n+            polygon = this.adjustPoints(geometry.type, polygon)\n             this.handlePoint(polygon[0])\n             this.handleLine(polygon)\n             //this.handlePolygon(polygon);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bbd072fff6e8e393a192bd28a06adc78392f968"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90ae2707cd2fb9810191ce54b3e7f37a601272f1", "author": {"user": {"login": "hayleynorton", "name": "Hayley Norton"}}, "url": "https://github.com/codice/ddf/commit/90ae2707cd2fb9810191ce54b3e7f37a601272f1", "committedDate": "2020-03-16T21:55:24Z", "message": "DDF-UI-111 fixed drawn geometries and result geometries over antimeridian"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f057e39cc105b43f0b613fb41e46d7c642565b6", "author": {"user": {"login": "hayleynorton", "name": "Hayley Norton"}}, "url": "https://github.com/codice/ddf/commit/1f057e39cc105b43f0b613fb41e46d7c642565b6", "committedDate": "2020-03-16T22:30:16Z", "message": "address comments and format"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6bbd072fff6e8e393a192bd28a06adc78392f968", "author": {"user": {"login": "hayleynorton", "name": "Hayley Norton"}}, "url": "https://github.com/codice/ddf/commit/6bbd072fff6e8e393a192bd28a06adc78392f968", "committedDate": "2020-03-11T17:21:03Z", "message": "DDF-UI-111 fixed drawn geometries and result geometries over antimeridian"}, "afterCommit": {"oid": "1f057e39cc105b43f0b613fb41e46d7c642565b6", "author": {"user": {"login": "hayleynorton", "name": "Hayley Norton"}}, "url": "https://github.com/codice/ddf/commit/1f057e39cc105b43f0b613fb41e46d7c642565b6", "committedDate": "2020-03-16T22:30:16Z", "message": "address comments and format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2Mjc0MjY5", "url": "https://github.com/codice/ddf/pull/5892#pullrequestreview-376274269", "createdAt": "2020-03-17T17:55:37Z", "commit": {"oid": "1f057e39cc105b43f0b613fb41e46d7c642565b6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NDcxNjA2", "url": "https://github.com/codice/ddf/pull/5892#pullrequestreview-377471606", "createdAt": "2020-03-19T07:21:09Z", "commit": {"oid": "1f057e39cc105b43f0b613fb41e46d7c642565b6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NzAwMjIy", "url": "https://github.com/codice/ddf/pull/5892#pullrequestreview-377700222", "createdAt": "2020-03-19T13:08:02Z", "commit": {"oid": "1f057e39cc105b43f0b613fb41e46d7c642565b6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 62, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}