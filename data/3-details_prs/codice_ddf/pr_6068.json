{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5NzY4MDA5", "number": 6068, "title": "DDF-6049 Move SecureWebSocketServlet into DDF", "bodyText": "DDF-UI Pull Request\nWhat does this PR do?\nMoves the SecureWebSocketServlet into DDF and changes the way the web sockets checks to see if a user is logged in. The web sockets now store a reference to the http session (which contains the login information), and when that session is invalid it means the user has logged out.\nWho is reviewing it?\n@SmithJosh\nSelect relevant component teams:\n\nAsk 2 committers to review/merge the PR and tag them here.\n\n@blen-desta\n@garrettfreibott\n@stustison\nHow should this be tested?\nFeel free to contact me with any questions.\nSetup:\n\nInstall the standard profile.\nBuild and install this DDF-UI. Make sure that ddf.version in the DDF-UI root pom matches this version of DDF.\n\nTest w/ Basic:\n\nLogin to the admin console with basic credentials.\nNavigate to System -> Configuration -> Catalog UI Search and check Enable Web Sockets.\nIn a new tab login to intrigue with basic credentials.\nIngest some things.\nExecute a query and verify results.\nIn the admin console tab, logout of the admin account. The goal here is to logout of the admin account with the intrigue tab still open and ready.\nIn the intrigue tab, re-execute the query. The query should fail. (Further executions may succeed due to the user being re-signed in with cached credentials, that is expected behavior)\nRefreshing the intrigue tab should make you re-enter credentials and querying should work as expected.\n\n(Extra Credit) Test w/ OIDC:\n\nStart up keycloak and set it up a client for DDF to OIDC.\nLogin to DDF's admin console.\nModify the OIDC Handler configuration to contain the proper information to connect with keycoak.\nModify the Web Context Policy Manager to use OIDC for Web Pages and Endpoints.\nLogout.\nLogin to intrigue.\nExecute a query and verify results.\nIn a new tab login to a web page (i.e. the admin console or intrigue) and logout. The goal here is to logout of the admin account with the intrigue tab still open and ready.\nIn the intrigue tab, re-execute the query. The query should fail. Further executions of the query should also fail.\nRefreshing the intrigue tab should make you re-enter credentials and querying should work as expected.\n\nAny background context you want to provide?\nWhat are the relevant tickets?\nFixes: #6049\nScreenshots\n\nChecklist:\n\n Documentation Updated\n Update / Add Threat Dragon models\n Update / Add Unit Tests\n Update / Add Integration Tests\n\nNotes on Review Process\nPlease see Notes on Review Process for further guidance on requirements for merging and abbreviated reviews.\nReview Comment Legend:\n\n\u270f\ufe0f (Pencil) This comment is a nitpick or style suggestion, no action required for approval. This comment should provide a suggestion either as an in line code snippet or a gist.\n\u2753 (Question Mark) This comment is to gain a clearer understanding of design or code choices, clarification is required but action may not be necessary for approval.\n\u2757 (Exclamation Mark) This comment is critical and requires clarification or action before approval.", "createdAt": "2020-05-18T22:12:19Z", "url": "https://github.com/codice/ddf/pull/6068", "merged": true, "mergeCommit": {"oid": "66618e722a5154f298a131f2844463380c6ea9e3"}, "closed": true, "closedAt": "2020-05-27T16:20:12Z", "author": {"login": "bakejeyner"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcinW7fgH2gAyNDE5NzY4MDA5OmM3ZDY2MDQ1MjU5YzQ0NGFmZDExYzFhODJhNGQ4MWJkMzMzMDdlYjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclSTPLgBqjMzNzY0MzE4NjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c7d66045259c444afd11c1a82a4d81bd33307eb7", "author": {"user": {"login": "bakejeyner", "name": "Jacob Beyner"}}, "url": "https://github.com/codice/ddf/commit/c7d66045259c444afd11c1a82a4d81bd33307eb7", "committedDate": "2020-05-18T22:10:51Z", "message": "DDF-6049 Move SecureWebSocketServlet into DDF"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzOTc3ODAz", "url": "https://github.com/codice/ddf/pull/6068#pullrequestreview-413977803", "createdAt": "2020-05-18T22:22:36Z", "commit": {"oid": "c7d66045259c444afd11c1a82a4d81bd33307eb7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzOTg5NzYw", "url": "https://github.com/codice/ddf/pull/6068#pullrequestreview-413989760", "createdAt": "2020-05-18T22:52:23Z", "commit": {"oid": "c7d66045259c444afd11c1a82a4d81bd33307eb7"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMjo1MjoyM1rOGXKBIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMjo1MjoyM1rOGXKBIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkzNDU2Mw==", "bodyText": "Looks like this comment no longer applies", "url": "https://github.com/codice/ddf/pull/6068#discussion_r426934563", "createdAt": "2020-05-18T22:52:23Z", "author": {"login": "SmithJosh"}, "path": "platform/security/servlet/security-servlet-web-socket/src/main/java/org/codice/ddf/security/servlet/web/socket/SecureWebSocketServlet.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/**\n+ * Copyright (c) Codice Foundation\n+ *\n+ * <p>This is free software: you can redistribute it and/or modify it under the terms of the GNU\n+ * Lesser General Public License as published by the Free Software Foundation, either version 3 of\n+ * the License, or any later version.\n+ *\n+ * <p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n+ * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU Lesser General Public License for more details. A copy of the GNU Lesser General Public\n+ * License is distributed along with this program and can be found at\n+ * <http://www.gnu.org/licenses/lgpl.html>.\n+ */\n+package org.codice.ddf.security.servlet.web.socket;\n+\n+import ddf.security.SecurityConstants;\n+import ddf.security.Subject;\n+import java.io.IOException;\n+import java.util.concurrent.ExecutorService;\n+import javax.servlet.http.HttpSession;\n+import org.eclipse.jetty.websocket.api.Session;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketClose;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketConnect;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketError;\n+import org.eclipse.jetty.websocket.api.annotations.OnWebSocketMessage;\n+import org.eclipse.jetty.websocket.servlet.ServletUpgradeRequest;\n+import org.eclipse.jetty.websocket.servlet.WebSocketServlet;\n+import org.eclipse.jetty.websocket.servlet.WebSocketServletFactory;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class SecureWebSocketServlet extends WebSocketServlet {\n+\n+  private static final Logger LOGGER = LoggerFactory.getLogger(SecureWebSocketServlet.class);\n+\n+  private final WebSocket ws;\n+\n+  private final ExecutorService executor;\n+\n+  public SecureWebSocketServlet(ExecutorService executor, WebSocket ws) {\n+    this.ws = ws;\n+    this.executor = executor;\n+  }\n+\n+  @Override\n+  public void destroy() {\n+    executor.shutdown();\n+  }\n+\n+  /*\n+   Pass the TokenHolder into the WebSocket, in order to know when the user has logged out. Can't\n+   pass the Session because Jetty won't let anything check session attributes unless there's a\n+   request (excluding WebSocket requests) being actively fulfilled for that session.\n+  */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7d66045259c444afd11c1a82a4d81bd33307eb7"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MDMwNTk2", "url": "https://github.com/codice/ddf/pull/6068#pullrequestreview-417030596", "createdAt": "2020-05-22T16:18:35Z", "commit": {"oid": "c7d66045259c444afd11c1a82a4d81bd33307eb7"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjoxODozNVrOGZcqbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNjoxODozNVrOGZcqbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMzNzE5Ng==", "bodyText": "This might need to be changed now. Try rebasing and see if this actually needs impl.", "url": "https://github.com/codice/ddf/pull/6068#discussion_r429337196", "createdAt": "2020-05-22T16:18:35Z", "author": {"login": "stustison"}, "path": "features/security/src/main/feature/feature.xml", "diffHunk": "@@ -528,6 +528,13 @@ org.ops4j.pax.web.default.realmname=DDF\n         <bundle>mvn:ddf.security.servlet/security-servlet-whoami/${project.version}</bundle>\n     </feature>\n \n+    <feature name=\"security-servlet-web-socket\" version=\"${project.version}\"\n+             description=\"Defines a secure web socket servlet type.\">\n+        <feature>security-core-impl</feature>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7d66045259c444afd11c1a82a4d81bd33307eb7"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NTczNTU1", "url": "https://github.com/codice/ddf/pull/6068#pullrequestreview-418573555", "createdAt": "2020-05-26T18:38:15Z", "commit": {"oid": "c7d66045259c444afd11c1a82a4d81bd33307eb7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fa597e83630a283340daeff74c90e2e917f9c98f", "author": {"user": {"login": "bakejeyner", "name": "Jacob Beyner"}}, "url": "https://github.com/codice/ddf/commit/fa597e83630a283340daeff74c90e2e917f9c98f", "committedDate": "2020-05-27T02:18:18Z", "message": "Change security-core-impl to security-core-api in web-socket-servlet feature"}, "afterCommit": {"oid": "8c599259b122ef44ab9a6a09d0ef705ad7cf74a2", "author": {"user": {"login": "bakejeyner", "name": "Jacob Beyner"}}, "url": "https://github.com/codice/ddf/commit/8c599259b122ef44ab9a6a09d0ef705ad7cf74a2", "committedDate": "2020-05-27T02:20:43Z", "message": "Change security-core-impl to security-core-api in web-socket-servlet feature"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d009bec71a7770da74644f08619be8a1236ce9ca", "author": {"user": {"login": "bakejeyner", "name": "Jacob Beyner"}}, "url": "https://github.com/codice/ddf/commit/d009bec71a7770da74644f08619be8a1236ce9ca", "committedDate": "2020-05-27T05:20:19Z", "message": "Change security-core-impl to security-core-api in web-socket-servlet feature"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8c599259b122ef44ab9a6a09d0ef705ad7cf74a2", "author": {"user": {"login": "bakejeyner", "name": "Jacob Beyner"}}, "url": "https://github.com/codice/ddf/commit/8c599259b122ef44ab9a6a09d0ef705ad7cf74a2", "committedDate": "2020-05-27T02:20:43Z", "message": "Change security-core-impl to security-core-api in web-socket-servlet feature"}, "afterCommit": {"oid": "d009bec71a7770da74644f08619be8a1236ce9ca", "author": {"user": {"login": "bakejeyner", "name": "Jacob Beyner"}}, "url": "https://github.com/codice/ddf/commit/d009bec71a7770da74644f08619be8a1236ce9ca", "committedDate": "2020-05-27T05:20:19Z", "message": "Change security-core-impl to security-core-api in web-socket-servlet feature"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 918, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}