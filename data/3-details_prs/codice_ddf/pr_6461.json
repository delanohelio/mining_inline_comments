{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwODMwNTY3", "number": 6461, "title": "[2.26.x] Fix printErrorMessage when executeWithSubject fails in SubjectCommands", "bodyText": "What does this PR do?\n\nFixes the error message printed out to the Karaf console when executeWithSubject throws an Exception in any class that implements SubjectCommands\nUpdate catalog:range command to only print table header row when there are no errors\n\nBefore:\nadmin@root()> catalog:range name ___ ___\n\n#       ID                                name                       Title\n\nnull\n\nAfter:\nadmin@root()> catalog:range name ___ ___\nCould not parse date parameters.\n\nHow should this be tested?\nVerify that both checked and unchecked exceptions are handled (log and karaf console output) correctly for comands that extend SubjectCommands. I tested with catalog:range. Here are the commands that I used:\n\n\n\n\nrun with username\nrun without username\n\n\n\n\nsuccessful execution\ncatalog:range --user admin modified 01-23-2009 01-24-2009\ncatalog:range modified 01-23-2009 01-24-2009\n\n\nunchecked Exception\ncatalog:range --user admin modified 01-23-2009 01-23-2009\ncatalog:range modified 01-23-2009 01-23-2009\n\n\nchecked Exception\ncatalog:range --user admin modified _ 01-23-2009\ncatalog:range modified _ 01-23-2009\n\n\n\nAdditionally, make sure that the table update in RangeCommand doesn't cause any regressions. Verify that output is still outputted correctly in the table and that the max title length is enforced.\nChecklist:\n\n[n/a] Documentation Updated\n[n/a] Update / Add Threat Dragon models\n Update / Add Unit Tests\n Update / Add Integration Tests\n\nNotes on Review Process\nPlease see Notes on Review Process for further guidance on requirements for merging and abbreviated reviews.\nReview Comment Legend:\n\n\u270f\ufe0f (Pencil) This comment is a nitpick or style suggestion, no action required for approval. This comment should provide a suggestion either as an in line code snippet or a gist.\n\u2753 (Question Mark) This comment is to gain a clearer understanding of design or code choices, clarification is required but action may not be necessary for approval.\n\u2757 (Exclamation Mark) This comment is critical and requires clarification or action before approval.", "createdAt": "2020-12-16T01:43:42Z", "url": "https://github.com/codice/ddf/pull/6461", "merged": true, "mergeCommit": {"oid": "b63d26656734c400a5a584b7a54398edcfc8db47"}, "closed": true, "closedAt": "2020-12-18T03:58:11Z", "author": {"login": "emmberk"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmko6xAH2gAyNTQwODMwNTY3OjZjYTU5Mzg4NjYzMmQyZmQwNzViY2JkYTNmNDhjZGZlZjA0NGI3M2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnF2BmgFqTU1NDc1NDE2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6ca593886632d2fd075bcbda3f48cdfef044b73e", "author": {"user": {"login": "emmberk", "name": "Emily Berk"}}, "url": "https://github.com/codice/ddf/commit/6ca593886632d2fd075bcbda3f48cdfef044b73e", "committedDate": "2020-12-16T01:27:38Z", "message": "Fix printErrorMessage when executeWithSubject fails in SubjectCommands"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzODA4OTc2", "url": "https://github.com/codice/ddf/pull/6461#pullrequestreview-553808976", "createdAt": "2020-12-16T15:35:51Z", "commit": {"oid": "6ca593886632d2fd075bcbda3f48cdfef044b73e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNTozNTo1MVrOIHLXaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNTozNTo1MVrOIHLXaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM5NzE2MQ==", "bodyText": "\u2757 missing placeholder for logging parameter", "url": "https://github.com/codice/ddf/pull/6461#discussion_r544397161", "createdAt": "2020-12-16T15:35:51Z", "author": {"login": "jlcsmith"}, "path": "catalog/core/catalog-core-commands/src/main/java/org/codice/ddf/commands/catalog/SubjectCommands.java", "diffHunk": "@@ -68,46 +64,59 @@\n    * the user doesn't have the permission to run the command.\n    *\n    * @return value returned by {@link #executeWithSubject()}, or {@code null} if the command failed\n-   * @throws InvocationTargetException thrown if an exception occurred while executing the command\n-   * @throws Exception if any other unexpected exception occurred\n    */\n   @Override\n-  public Object execute() throws Exception {\n-\n-    try {\n-      if (isNotBlank(user)) {\n-        return runWithUserName();\n-      } else {\n-        return security.runWithSubjectOrElevate(\n-            () ->\n-                AccessController.doPrivileged(\n-                    (PrivilegedExceptionAction<Object>) this::executeWithSubject));\n-      }\n-    } catch (SecurityServiceException e) {\n-      printErrorMessage(e.getMessage());\n-    } catch (InvocationTargetException e) {\n-      printErrorMessage(e.getCause().getMessage());\n+  public Object execute() {\n+    if (isNotBlank(user)) {\n+      return runWithUsername();\n+    } else {\n+      return runWithoutUsername();\n     }\n-    return null;\n   }\n \n-  private Object runWithUserName() throws InvocationTargetException {\n+  @Nullable\n+  private Object runWithUsername() {\n+    final String password;\n     try {\n-      String password = session.readLine(\"Password for \" + user + \": \", '*');\n-      Subject subject = security.getSubject(user, password, \"127.0.0.1\");\n+      password = session.readLine(\"Password for \" + user + \": \", '*');\n+    } catch (IOException e) {\n+      LOGGER.info(\"Failed to run command\", e);\n+      printErrorMessage(\"Failed to read password\");\n+      return null;\n+    }\n \n-      if (subject == null) {\n-        printErrorMessage(\"Invalid username/password\");\n-        return null;\n-      }\n+    final Subject subject = security.getSubject(user, password, \"127.0.0.1\");\n+    if (subject == null) {\n+      printErrorMessage(\"Invalid username/password\");\n+      return null;\n+    }\n \n+    try {\n       return subject.execute(this::executeWithSubject);\n     } catch (ExecutionException e) {\n-      LOGGER.info(\"Failed to run command: {}\", e.getCause().getMessage(), e.getCause());\n-      throw new InvocationTargetException(e.getCause());\n-    } catch (IOException e) {\n-      LOGGER.info(\"Failed to run command\", e);\n-      printErrorMessage(\"Failed to read password\");\n+      final Throwable failure = e.getCause();\n+      final String message = failure.getMessage();\n+      LOGGER.info(\"Failed to run command: {}\", message, failure);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ca593886632d2fd075bcbda3f48cdfef044b73e"}, "originalPosition": 88}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69a189db0f3d1d5703e553febd0f98c084c391dc", "author": {"user": {"login": "emmberk", "name": "Emily Berk"}}, "url": "https://github.com/codice/ddf/commit/69a189db0f3d1d5703e553febd0f98c084c391dc", "committedDate": "2020-12-16T20:28:53Z", "message": "Update solution to account for both checked and unchecked exceptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "645cfbd85f0d1292c804a8043a9553b5f125ef1d", "author": {"user": {"login": "emmberk", "name": "Emily Berk"}}, "url": "https://github.com/codice/ddf/commit/645cfbd85f0d1292c804a8043a9553b5f125ef1d", "committedDate": "2020-12-16T20:37:00Z", "message": "Update catalog:range command to only print table header row when there are no errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MDY0Mjk3", "url": "https://github.com/codice/ddf/pull/6461#pullrequestreview-554064297", "createdAt": "2020-12-16T20:37:45Z", "commit": {"oid": "6ca593886632d2fd075bcbda3f48cdfef044b73e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NzU0MTYw", "url": "https://github.com/codice/ddf/pull/6461#pullrequestreview-554754160", "createdAt": "2020-12-17T16:08:49Z", "commit": {"oid": "645cfbd85f0d1292c804a8043a9553b5f125ef1d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 696, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}