{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxNjczMTE4", "number": 5975, "title": "DDF-5974 Simplifies logout such that we attempt to log out from a single url", "bodyText": "What does this PR do?\nSimplifies logout such that we attempt to log out from a single URL. This will allow us to remove the use of iframes when logging out of external IdPs and appropriately propagate logout errors to the user.\nSelect relevant component teams:\n@codice/security\nAsk 2 committers to review/merge the PR and tag them here.\n@bakejeyner\n@garrettfreibott\n@SmithJosh\n@stustison\nHow should this be tested?\n\n Verify login and logout works for BASIC and PKI auth\n\nOn logout, you should see a message to close your browser for both auth types\n\n\n Verify login and logout for OIDC auth\n\nOn logout, you should see a message that you are logged out with a link to sign back in\n\n\n Verify login and logout for SAML auth\n\nOn logout, you should see the logout page of the SAML provider\n\n\n Verify the logout link on the 403 error page\n\nTo get the 403 error page, log in to Intrigue using OIDC auth then navigate to the admin page\nOn logout, you should see a message that you are logged out with a link to sign back in. The link should take you to the admin page\n\n\n\nWhat are the relevant tickets?\nFixes: #5974\nChecklist:\n\n Documentation Updated\n Update / Add Threat Dragon models\n Update / Add Unit Tests\n Update / Add Integration Tests\n\nNotes on Review Process\nPlease see Notes on Review Process for further guidance on requirements for merging and abbreviated reviews.\nReview Comment Legend:\n\n\u270f\ufe0f (Pencil) This comment is a nitpick or style suggestion, no action required for approval. This comment should provide a suggestion either as an in line code snippet or a gist.\n\u2753 (Question Mark) This comment is to gain a clearer understanding of design or code choices, clarification is required but action may not be necessary for approval.\n\u2757 (Exclamation Mark) This comment is critical and requires clarification or action before approval.", "createdAt": "2020-04-09T22:21:24Z", "url": "https://github.com/codice/ddf/pull/5975", "merged": true, "mergeCommit": {"oid": "fc2fa5fb5f4226a408db48446d33238011a6a17b"}, "closed": true, "closedAt": "2020-04-22T22:51:44Z", "author": {"login": "blen-desta"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWEHt-AH2gAyNDAxNjczMTE4OjAxZGJmNjNlMTU0ODlkODU1YmJlNDA3NDcwNzg3MzVlZjI2MmJiOWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaOdneAH2gAyNDAxNjczMTE4OjQ0OWU0NTM2NDJmZmNhYjM1NmJkYTViYmQxMTBmMzkxN2JkN2NmYWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "01dbf63e15489d855bbe40747078735ef262bb9f", "author": {"user": {"login": "blen-desta", "name": "Blen Desta"}}, "url": "https://github.com/codice/ddf/commit/01dbf63e15489d855bbe40747078735ef262bb9f", "committedDate": "2020-04-09T22:20:28Z", "message": "DDF-5974 Simplifies logout such that we attempt to log out from a single url"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMjY0MTEz", "url": "https://github.com/codice/ddf/pull/5975#pullrequestreview-392264113", "createdAt": "2020-04-13T16:37:36Z", "commit": {"oid": "01dbf63e15489d855bbe40747078735ef262bb9f"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNjozNzozNlrOGEsdxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzoxODoxNFrOGEtz9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU3NjAwNw==", "bodyText": "Avoid using Log4j directly. Apache StringUtils would be better", "url": "https://github.com/codice/ddf/pull/5975#discussion_r407576007", "createdAt": "2020-04-13T16:37:36Z", "author": {"login": "SmithJosh"}, "path": "platform/security/servlet/security-servlet-logout/src/main/java/org/codice/ddf/security/servlet/logout/LocalLogoutServlet.java", "diffHunk": "@@ -17,17 +17,20 @@\n import ddf.security.common.SecurityTokenHolder;\n import ddf.security.common.audit.SecurityLogger;\n import java.io.IOException;\n-import java.security.cert.X509Certificate;\n+import java.net.URISyntaxException;\n import java.util.Arrays;\n-import java.util.Enumeration;\n import javax.servlet.ServletException;\n import javax.servlet.http.Cookie;\n import javax.servlet.http.HttpServlet;\n import javax.servlet.http.HttpServletRequest;\n import javax.servlet.http.HttpServletResponse;\n import javax.servlet.http.HttpSession;\n+import org.apache.http.HttpStatus;\n+import org.apache.http.client.utils.URIBuilder;\n+import org.apache.logging.log4j.util.Strings;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01dbf63e15489d855bbe40747078735ef262bb9f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU4MjIxMw==", "bodyText": "\u270f\ufe0f I think you can redirect to the complete SystemBaseUrl.EXTERNAL.construct(redirectUri) url and avoid this conditional", "url": "https://github.com/codice/ddf/pull/5975#discussion_r407582213", "createdAt": "2020-04-13T16:48:56Z", "author": {"login": "SmithJosh"}, "path": "platform/security/servlet/security-servlet-logout/src/main/java/org/codice/ddf/security/servlet/logout/LocalLogoutServlet.java", "diffHunk": "@@ -46,32 +50,24 @@ protected void doGet(HttpServletRequest request, HttpServletResponse response)\n \n     invalidateSession(request, response);\n \n-    boolean mustCloseBrowser = (checkForBasic(request) || checkForPki(request));\n-    String message = String.format(\"{ \\\"mustCloseBrowser\\\": %b }\", mustCloseBrowser);\n-\n     try {\n-      response.setStatus(HttpServletResponse.SC_OK);\n-      response.setContentType(\"application/json\");\n-      response.getWriter().write(message);\n-      response.flushBuffer();\n-    } catch (IOException e) {\n-      LOGGER.warn(\"Unable to write response body\", e);\n-    }\n-  }\n+      URIBuilder redirectUrlBuilder;\n \n-  private boolean checkForBasic(HttpServletRequest request) {\n-    Enumeration authHeaders = request.getHeaders(javax.ws.rs.core.HttpHeaders.AUTHORIZATION);\n-    while (authHeaders.hasMoreElements()) {\n-      if (((String) authHeaders.nextElement()).contains(\"Basic\")) {\n-        return true;\n+      if (Strings.isNotBlank(SystemBaseUrl.EXTERNAL.getRootContext())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01dbf63e15489d855bbe40747078735ef262bb9f"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU5ODA3MA==", "bodyText": "\u2753 What about the service query parameter? The Admin UI and Intrigue use it instead of prevurl", "url": "https://github.com/codice/ddf/pull/5975#discussion_r407598070", "createdAt": "2020-04-13T17:18:14Z", "author": {"login": "SmithJosh"}, "path": "platform/security/servlet/security-servlet-logout/src/main/java/org/codice/ddf/security/servlet/logout/LogoutServiceImpl.java", "diffHunk": "@@ -65,23 +65,32 @@ public String getActionProviders(HttpServletRequest request, HttpServletResponse\n     subjectMap.put(\"http_response\", response);\n     subjectMap.put(SecurityConstants.SECURITY_SUBJECT, subject);\n \n-    List<Map<String, String>> actionPropertiesList = new ArrayList<>();\n+    Map<String, String> actionProperties = new HashMap<>();\n \n     for (ActionProvider actionProvider : logoutActionProviders) {\n-      Map<String, String> actionProperties = new HashMap<>();\n       Action action = actionProvider.getAction(subjectMap);\n \n       if (action != null) {\n         String displayName = SubjectUtils.getName(subject, \"\", true);\n         actionProperties.put(\"title\", action.getTitle());\n         actionProperties.put(\"auth\", displayName);\n         actionProperties.put(\"description\", action.getDescription());\n-        actionProperties.put(\"url\", action.getUrl().toString());\n-        actionPropertiesList.add(actionProperties);\n+\n+        StringBuilder urlBuilder = new StringBuilder(action.getUrl().toString());\n+        String referer = request.getHeader(\"Referer\");\n+        if (!StringUtils.isEmpty(referer)) {\n+          String[] parts = referer.split(\"\\\\?prevurl=\");\n+          if (parts.length > 1) {\n+            String previousUrl = parts[1];\n+            urlBuilder.append(\"?prevurl=\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01dbf63e15489d855bbe40747078735ef262bb9f"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMzAyMjIw", "url": "https://github.com/codice/ddf/pull/5975#pullrequestreview-392302220", "createdAt": "2020-04-13T17:35:20Z", "commit": {"oid": "01dbf63e15489d855bbe40747078735ef262bb9f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzozNToyMFrOGEuYxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNzozNToyMFrOGEuYxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzYwNzQ5Mg==", "bodyText": "\u2753 Why exclude the root context?", "url": "https://github.com/codice/ddf/pull/5975#discussion_r407607492", "createdAt": "2020-04-13T17:35:20Z", "author": {"login": "SmithJosh"}, "path": "platform/security/handler/security-handler-oidc/src/main/java/org/codice/ddf/security/handler/oidc/OidcCallbackEndpoint.java", "diffHunk": "@@ -54,12 +58,36 @@ public Response logout(\n \n     sessionStore.destroySession(j2EContext);\n \n+    String localLogout = SystemBaseUrl.EXTERNAL.constructUrl(\"/logout/local\");\n+    WebClient webClient = getWebClient(localLogout);\n+    Response logoutResponse = webClient.get();\n+    if (logoutResponse.getStatus() == HttpStatus.SC_INTERNAL_SERVER_ERROR) {\n+      return logoutResponse;\n+    }\n+\n     try {\n-      return Response.temporaryRedirect(new URI(SystemBaseUrl.EXTERNAL.constructUrl(\"/logout\")))\n-          .build();\n+      String redirectUrl = SystemBaseUrl.EXTERNAL.constructUrl(redirectUri, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01dbf63e15489d855bbe40747078735ef262bb9f"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMzg3MTIz", "url": "https://github.com/codice/ddf/pull/5975#pullrequestreview-392387123", "createdAt": "2020-04-13T19:44:35Z", "commit": {"oid": "01dbf63e15489d855bbe40747078735ef262bb9f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxOTo0NDozNVrOGEysgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxOTo0NDozNVrOGEysgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY3ODA4MA==", "bodyText": "\u2753 I'm confused as to why we have both index.html and logout-response.html. It looks to my like they both display a similarly formatted logout page, but index.html is specifically for the error case. Is that how they are used in code, i.e. we return logout-response.html when logout succeeds and return index.html when logout fails?", "url": "https://github.com/codice/ddf/pull/5975#discussion_r407678080", "createdAt": "2020-04-13T19:44:35Z", "author": {"login": "bakejeyner"}, "path": "ui/packages/security-logout/src/main/resources/logout-response.html", "diffHunk": "@@ -26,9 +26,13 @@\n </head>\n <body class=\"full-width logout-response-body\">\n <div class=\"full-width logout-response-container\">\n-    <div class=\"logout-msg\">\n-        <h2 id=\"extramessage\"></h2>\n-        <h4>You can <a id=\"landinglink\" href=\"#\">return to the landing page.</a></h4>\n+    <div id=\"standard-msg\" class=\"logout-msg\" style=\"display:none;\">\n+        <h2>You have been logged out</h2>\n+        <h4><a id=\"link\" href=\"#\">Sign in again</a></h4>\n+    </div>\n+    <div id=\"close-browser-msg\" class=\"logout-msg\" style=\"display:none;\">\n+        <h2>You have been logged out</h2>\n+        <h4>Please close your browser to prevent reuse of cached credentials</h4>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01dbf63e15489d855bbe40747078735ef262bb9f"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNTQ0NzY0", "url": "https://github.com/codice/ddf/pull/5975#pullrequestreview-392544764", "createdAt": "2020-04-14T01:31:47Z", "commit": {"oid": "01dbf63e15489d855bbe40747078735ef262bb9f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fc8b74820185169bf4437a23d5a4d080f839b8b8", "author": {"user": {"login": "blen-desta", "name": "Blen Desta"}}, "url": "https://github.com/codice/ddf/commit/fc8b74820185169bf4437a23d5a4d080f839b8b8", "committedDate": "2020-04-14T03:37:15Z", "message": "Addressed PR comments"}, "afterCommit": {"oid": "ff5762adae580eb271ce57fbc235c8840cb6f88f", "author": {"user": {"login": "blen-desta", "name": "Blen Desta"}}, "url": "https://github.com/codice/ddf/commit/ff5762adae580eb271ce57fbc235c8840cb6f88f", "committedDate": "2020-04-14T16:29:17Z", "message": "Addressed PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMzkyOTM4", "url": "https://github.com/codice/ddf/pull/5975#pullrequestreview-393392938", "createdAt": "2020-04-15T01:05:24Z", "commit": {"oid": "ff5762adae580eb271ce57fbc235c8840cb6f88f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ff5762adae580eb271ce57fbc235c8840cb6f88f", "author": {"user": {"login": "blen-desta", "name": "Blen Desta"}}, "url": "https://github.com/codice/ddf/commit/ff5762adae580eb271ce57fbc235c8840cb6f88f", "committedDate": "2020-04-14T16:29:17Z", "message": "Addressed PR comments"}, "afterCommit": {"oid": "72bc44770a8a174e8a82f3381514760726c58a38", "author": {"user": {"login": "blen-desta", "name": "Blen Desta"}}, "url": "https://github.com/codice/ddf/commit/72bc44770a8a174e8a82f3381514760726c58a38", "committedDate": "2020-04-21T06:14:02Z", "message": "Addressed PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73f24580de6560f20907df1f30f47ff9f0b4e5dc", "author": {"user": {"login": "blen-desta", "name": "Blen Desta"}}, "url": "https://github.com/codice/ddf/commit/73f24580de6560f20907df1f30f47ff9f0b4e5dc", "committedDate": "2020-04-21T07:04:49Z", "message": "Addressed PR comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "72bc44770a8a174e8a82f3381514760726c58a38", "author": {"user": {"login": "blen-desta", "name": "Blen Desta"}}, "url": "https://github.com/codice/ddf/commit/72bc44770a8a174e8a82f3381514760726c58a38", "committedDate": "2020-04-21T06:14:02Z", "message": "Addressed PR comments"}, "afterCommit": {"oid": "73f24580de6560f20907df1f30f47ff9f0b4e5dc", "author": {"user": {"login": "blen-desta", "name": "Blen Desta"}}, "url": "https://github.com/codice/ddf/commit/73f24580de6560f20907df1f30f47ff9f0b4e5dc", "committedDate": "2020-04-21T07:04:49Z", "message": "Addressed PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NzAwMzgx", "url": "https://github.com/codice/ddf/pull/5975#pullrequestreview-397700381", "createdAt": "2020-04-21T21:48:01Z", "commit": {"oid": "73f24580de6560f20907df1f30f47ff9f0b4e5dc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "449e453642ffcab356bda5bbd110f3917bd7cfab", "author": {"user": {"login": "blen-desta", "name": "Blen Desta"}}, "url": "https://github.com/codice/ddf/commit/449e453642ffcab356bda5bbd110f3917bd7cfab", "committedDate": "2020-04-22T20:39:08Z", "message": "Added to security policy"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4903, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}