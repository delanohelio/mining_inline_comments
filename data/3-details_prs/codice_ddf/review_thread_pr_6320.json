{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg1NDE1MzAx", "number": 6320, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMDoyMjowMFrOEjXzDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMDowMjo0NFrOEl4XGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA1NTI1NTE2OnYy", "diffSide": "RIGHT", "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/DynamicSchemaResolver.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMDoyMjowMFrOHRsBIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMDoyMjowMFrOHRsBIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwOTAyNQ==", "bodyText": "\u2757 I realized the other day that similar code I had added to the Solr client could cause threading issue since System properties are backed by a hashtable which is synchronized.  In the other case the method would generally short circuit before reaching the system property check.  In this case, it will happen for every sorted geo and text field.\nhttps://github.com/AdoptOpenJDK/openjdk-jdk8u/blob/master/jdk/src/share/classes/java/lang/System.java#L533\nI would recommend loading this property into a field.  We can restart the bundle if we need to refresh the value.", "url": "https://github.com/codice/ddf/pull/6320#discussion_r488309025", "createdAt": "2020-09-15T00:22:00Z", "author": {"login": "pklinef"}, "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/DynamicSchemaResolver.java", "diffHunk": "@@ -899,12 +899,17 @@ private String findAnyMatchingNumericalField(String propertyName, String fieldSu\n   }\n \n   String getSortKey(String field) {\n-    if (field.endsWith(SchemaFields.GEO_SUFFIX)) {\n+    if (field.endsWith(SchemaFields.GEO_SUFFIX)\n+        || (field.endsWith(SchemaFields.TEXT_SUFFIX) && caseInsensitiveSort())) {\n       field = field + SchemaFields.SORT_SUFFIX;\n     }\n     return field;\n   }\n \n+  private boolean caseInsensitiveSort() {\n+    return \"true\".equals(System.getProperty(\"solr.sort.case-insensitive\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1abc7f1866dc24ba9f43471627b00ea300ff399"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NzkzMDA0OnYy", "diffSide": "RIGHT", "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/DynamicSchemaResolver.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNDo1NTowMlrOHTmqlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNDo1NTowMlrOHTmqlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMxODQ4NA==", "bodyText": "\u270f\ufe0f There is one solr.query. system property and I am working on a PR to add another one.  Might consider making this solr.query.sort.caseInsensitive.\n\n  \n    \n      ddf/catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/SolrMetacardClientImpl.java\n    \n    \n         Line 155\n      in\n      b50f3c2\n    \n    \n    \n    \n\n        \n          \n           private static final String SOLR_QUERY_TIMEALLOWEDMS = \"solr.query.timeAllowed\";", "url": "https://github.com/codice/ddf/pull/6320#discussion_r490318484", "createdAt": "2020-09-17T14:55:02Z", "author": {"login": "pklinef"}, "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/DynamicSchemaResolver.java", "diffHunk": "@@ -163,6 +165,7 @@ public DynamicSchemaResolver(List<String> additionalFields) {\n     ConfigurationStore.getInstance().addConfigurationListener(this);\n     this.schemaFields = new SchemaFields();\n     metadataMaximumBytes = getMetadataSizeLimit();\n+    caseInsensitiveSort = \"true\".equals(System.getProperty(\"solr.sort.case-insensitive\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1e1cbddd63dd4db770fc324751af6f2e9d1ccc8"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MTI0MjMxOnYy", "diffSide": "RIGHT", "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/DynamicSchemaResolver.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMTo0NjowNlrOHVjhwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMTo0NjowNlrOHVjhwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM2NDIyNA==", "bodyText": "\u2757 Truncate the fields like we used to do to save on index space.  Before we were using 127 characters but that was limited by TruncateTokenFilterFactory.\nhttps://github.com/codice/ddf/blob/2.12.x/platform/solr/platform-solr-server-standalone/src/main/resources/solr/conf/schema.xml#L569-L570\nSortableTextField uses a value of 1024.", "url": "https://github.com/codice/ddf/pull/6320#discussion_r492364224", "createdAt": "2020-09-21T21:46:06Z", "author": {"login": "pklinef"}, "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/DynamicSchemaResolver.java", "diffHunk": "@@ -330,6 +333,18 @@ void addFields(Metacard metacard, SolrInputDocument solrInputDocument)\n                 formatIndexName + SchemaFields.SORT_SUFFIX, createCenterPoint(attributeValues));\n           }\n \n+          if (AttributeFormat.STRING.equals(format)\n+              && caseInsensitiveSort\n+              && solrInputDocument.getFieldValue(formatIndexName + SchemaFields.SORT_SUFFIX)\n+                  == null) {\n+            solrInputDocument.addField(\n+                formatIndexName + SchemaFields.SORT_SUFFIX,\n+                attributeValues.stream()\n+                    .map(Object::toString)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f52043a5fdfcac5ff9b5d6f9b134b2797c6078ba"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MTU0OTQ5OnYy", "diffSide": "RIGHT", "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/DynamicSchemaResolver.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMzo1NTo0OFrOHVmSvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMzo1NTo0OFrOHVmSvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQwOTUzNQ==", "bodyText": "\u270f\ufe0f Some kind of log message would be useful here to know why there was a NumberFormatException.", "url": "https://github.com/codice/ddf/pull/6320#discussion_r492409535", "createdAt": "2020-09-21T23:55:48Z", "author": {"login": "pklinef"}, "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/DynamicSchemaResolver.java", "diffHunk": "@@ -163,6 +167,13 @@ public DynamicSchemaResolver(List<String> additionalFields) {\n     ConfigurationStore.getInstance().addConfigurationListener(this);\n     this.schemaFields = new SchemaFields();\n     metadataMaximumBytes = getMetadataSizeLimit();\n+    caseInsensitiveSort = \"true\".equals(System.getProperty(\"solr.query.sort.caseInsensitive\"));\n+    try {\n+      textSortCharacterLimit =\n+          Integer.parseInt(System.getProperty(\"solr.index.sort.characterLimit\", \"127\").trim());\n+    } catch (NumberFormatException nfe) {\n+      textSortCharacterLimit = 127;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5680507a6b0ca92e724b50b29c143edfe1eb9546"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MTU1MTg0OnYy", "diffSide": "RIGHT", "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/DynamicSchemaResolver.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMzo1NzoxMVrOHVmUPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMzo1NzoxMVrOHVmUPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQwOTkxNg==", "bodyText": "\u270f\ufe0f If you truncate before toLowerCase, then there will be less to make lowercase.", "url": "https://github.com/codice/ddf/pull/6320#discussion_r492409916", "createdAt": "2020-09-21T23:57:11Z", "author": {"login": "pklinef"}, "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/DynamicSchemaResolver.java", "diffHunk": "@@ -330,6 +341,19 @@ void addFields(Metacard metacard, SolrInputDocument solrInputDocument)\n                 formatIndexName + SchemaFields.SORT_SUFFIX, createCenterPoint(attributeValues));\n           }\n \n+          if (AttributeFormat.STRING.equals(format)\n+              && caseInsensitiveSort\n+              && solrInputDocument.getFieldValue(formatIndexName + SchemaFields.SORT_SUFFIX)\n+                  == null) {\n+            solrInputDocument.addField(\n+                formatIndexName + SchemaFields.SORT_SUFFIX,\n+                attributeValues.stream()\n+                    .map(Object::toString)\n+                    .map(String::toLowerCase)\n+                    .map(value -> truncate(value, textSortCharacterLimit))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5680507a6b0ca92e724b50b29c143edfe1eb9546"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MTU1NDgyOnYy", "diffSide": "RIGHT", "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/DynamicSchemaResolver.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMzo1OToxMlrOHVmWMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQyMzo1OToxMlrOHVmWMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxMDQxOA==", "bodyText": "\u2757 Filter null values to avoid NPE in following maps.", "url": "https://github.com/codice/ddf/pull/6320#discussion_r492410418", "createdAt": "2020-09-21T23:59:12Z", "author": {"login": "pklinef"}, "path": "catalog/solr/catalog-solr-core/src/main/java/ddf/catalog/source/solr/DynamicSchemaResolver.java", "diffHunk": "@@ -330,6 +341,19 @@ void addFields(Metacard metacard, SolrInputDocument solrInputDocument)\n                 formatIndexName + SchemaFields.SORT_SUFFIX, createCenterPoint(attributeValues));\n           }\n \n+          if (AttributeFormat.STRING.equals(format)\n+              && caseInsensitiveSort\n+              && solrInputDocument.getFieldValue(formatIndexName + SchemaFields.SORT_SUFFIX)\n+                  == null) {\n+            solrInputDocument.addField(\n+                formatIndexName + SchemaFields.SORT_SUFFIX,\n+                attributeValues.stream()\n+                    .map(Object::toString)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5680507a6b0ca92e724b50b29c143edfe1eb9546"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MTU1OTA2OnYy", "diffSide": "RIGHT", "path": "distribution/ddf-common/src/main/resources-filtered/etc/custom.system.properties", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMDowMTowOFrOHVmYjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMDowMTowOFrOHVmYjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxMTAyMg==", "bodyText": "\u270f\ufe0f I am not sure if we need to include these properties here if the defaults are good for almost all deployments.", "url": "https://github.com/codice/ddf/pull/6320#discussion_r492411022", "createdAt": "2020-09-22T00:01:08Z", "author": {"login": "pklinef"}, "path": "distribution/ddf-common/src/main/resources-filtered/etc/custom.system.properties", "diffHunk": "@@ -96,6 +96,12 @@ solr.commit.nrt.metacardTypes=workspace,metacard.query,metacard.list,query-templ\n solr.highlight.blacklist=metacard-tags\n solr.highlight.enabled=false\n \n+# The number of characters to limit the text sorting fields to", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5680507a6b0ca92e724b50b29c143edfe1eb9546"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MTU2MTg2OnYy", "diffSide": "RIGHT", "path": "platform/solr/solr-schema/src/main/resources/solr/conf/schema.xml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMDowMjo0NFrOHVmaQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwMDowMjo0NFrOHVmaQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxMTQ1Nw==", "bodyText": "\u2757 Use a string field with docValues to improve sorting performance and avoid field cache memory usage.", "url": "https://github.com/codice/ddf/pull/6320#discussion_r492411457", "createdAt": "2020-09-22T00:02:44Z", "author": {"login": "pklinef"}, "path": "platform/solr/solr-schema/src/main/resources/solr/conf/schema.xml", "diffHunk": "@@ -57,6 +57,7 @@\n \n     <dynamicField name=\"*_xml\" type=\"string\" indexed=\"false\" stored=\"true\" multiValued=\"true\" docValues=\"false\"/>\n     <dynamicField name=\"*_txt\" type=\"string\" indexed=\"true\" stored=\"true\" multiValued=\"true\" docValues=\"true\"/>\n+    <dynamicField name=\"*_txt_sort\" type=\"lowercase\" indexed=\"true\" stored=\"false\" multiValued=\"true\" docValues=\"true\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5680507a6b0ca92e724b50b29c143edfe1eb9546"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4444, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}