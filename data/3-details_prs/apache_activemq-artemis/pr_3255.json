{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxMTAyMjA5", "number": 3255, "title": "ARTEMIS-2875 - Failed to handle re-establish connection failover", "bodyText": "While handling a re-establish connection on failover it can happen that the client can connect to the broker and re-establish a connection, but while reattaching all sessions to the new connection another connection loss can happen and there the failover fails without any possibility to recover on its own.", "createdAt": "2020-09-07T06:52:52Z", "url": "https://github.com/apache/activemq-artemis/pull/3255", "merged": true, "mergeCommit": {"oid": "24ba4daf94f1fef4e7a1a58b0bbdba81ed862432"}, "closed": true, "closedAt": "2020-09-10T19:07:52Z", "author": {"login": "skrutzler"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHLdXQAFqTQ4NDk2MDk3Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHas6zAH2gAyNDgxMTAyMjA5OjE3ODNhYTE1Y2JhNTNhYjNmMDNjOGU5YjIxYWEwNTQ3OWJhODVkZjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0OTYwOTcy", "url": "https://github.com/apache/activemq-artemis/pull/3255#pullrequestreview-484960972", "createdAt": "2020-09-09T12:35:43Z", "commit": {"oid": "e5a8955e197a6b4509b1ee0ec7686a52ab23116f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMjozNTo0M1rOHPFLBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMjozNTo0M1rOHPFLBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU3NTQyOQ==", "bodyText": "shouldn't you close the connection before setting it to null?\nalso... do you have a test showing the issue?\nAnd 3rd... can you amend the commit with the JIRA?\ngit commit --amend\n# on Vim or your configured editor, add the JIRA to the commit message (not the GitHub title)\ngit push origin -f\n(If you happen to have a test meanwhile you're doing that?)", "url": "https://github.com/apache/activemq-artemis/pull/3255#discussion_r485575429", "createdAt": "2020-09-09T12:35:43Z", "author": {"login": "clebertsuconic"}, "path": "artemis-core-client/src/main/java/org/apache/activemq/artemis/core/client/impl/ClientSessionFactoryImpl.java", "diffHunk": "@@ -632,11 +632,21 @@ private void failoverOrReconnect(final Object connectionID,\n \n                connector = null;\n \n-               reconnectSessions(oldConnection, reconnectAttempts, me);\n+               boolean allSessionReconnected;\n+               int failedReconnectSessionsCounter = 0;\n+               do {\n+                  allSessionReconnected = reconnectSessions(oldConnection, reconnectAttempts, me);\n+                  if (oldConnection != null) {\n+                     oldConnection.destroy();\n+                  }\n+                  oldConnection = connection;\n \n-               if (oldConnection != null) {\n-                  oldConnection.destroy();\n+                  if (!allSessionReconnected) {\n+                     failedReconnectSessionsCounter++;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5a8955e197a6b4509b1ee0ec7686a52ab23116f"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0OTYxODU4", "url": "https://github.com/apache/activemq-artemis/pull/3255#pullrequestreview-484961858", "createdAt": "2020-09-09T12:36:51Z", "commit": {"oid": "e5a8955e197a6b4509b1ee0ec7686a52ab23116f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMjozNjo1MVrOHPFN4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMjozNjo1MVrOHPFN4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU3NjE2Mg==", "bodyText": "this is the only test you changed... would this be enough to replicate the issue?\nshouldn't we parameterize the test to add this condition, since this seems to be changing other tests...\nI need some context on why you changed this.. if this is your test or what is this?\nthanks!", "url": "https://github.com/apache/activemq-artemis/pull/3255#discussion_r485576162", "createdAt": "2020-09-09T12:36:51Z", "author": {"login": "clebertsuconic"}, "path": "tests/integration-tests/src/test/java/org/apache/activemq/artemis/tests/integration/remoting/ReconnectTest.java", "diffHunk": "@@ -361,7 +361,7 @@ public boolean intercept(Packet packet, RemotingConnection connection) throws Ac\n \n       final long retryInterval = 50;\n       final double retryMultiplier = 1d;\n-      final int reconnectAttempts = 10;\n+      final int reconnectAttempts = 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5a8955e197a6b4509b1ee0ec7686a52ab23116f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1783aa15cba53ab3f03c8e9b21aa05479ba85df9", "author": {"user": null}, "url": "https://github.com/apache/activemq-artemis/commit/1783aa15cba53ab3f03c8e9b21aa05479ba85df9", "committedDate": "2020-09-10T06:21:18Z", "message": "ARTEMIS-2875 - retry to reattach sessions on failed failover for the specified amount of times set in reconnectAttempts parameter"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1587, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}