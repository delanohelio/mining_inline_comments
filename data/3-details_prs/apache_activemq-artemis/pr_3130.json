{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3MDI2ODc4", "number": 3130, "title": "ARTEMIS-2757 improving flow control in AMQP", "bodyText": "", "createdAt": "2020-05-12T23:27:20Z", "url": "https://github.com/apache/activemq-artemis/pull/3130", "merged": true, "mergeCommit": {"oid": "d9caf839bdeccf5cac514c6b2c98408a0ed9dd88"}, "closed": true, "closedAt": "2020-05-15T20:14:41Z", "author": {"login": "clebertsuconic"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgs3ZBgBqjMzMjk3MDg2OTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchn3UNABqjMzNDI0MDU5MzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8d7a6eafb3bd424e75f2ea7bf0c8fd4ba6955bb1", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/8d7a6eafb3bd424e75f2ea7bf0c8fd4ba6955bb1", "committedDate": "2020-05-12T23:25:43Z", "message": "ARTEMIS-2757 improving flow control in AMQP"}, "afterCommit": {"oid": "2e5f0f8a3f67f4dedd09fa6bbfbd3e52637d3d66", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/2e5f0f8a3f67f4dedd09fa6bbfbd3e52637d3d66", "committedDate": "2020-05-12T23:27:50Z", "message": "ARTEMIS-2757 improving flow control in AMQP"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e5f0f8a3f67f4dedd09fa6bbfbd3e52637d3d66", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/2e5f0f8a3f67f4dedd09fa6bbfbd3e52637d3d66", "committedDate": "2020-05-12T23:27:50Z", "message": "ARTEMIS-2757 improving flow control in AMQP"}, "afterCommit": {"oid": "06131629fde375528b71158b8c46d59c8841c6c5", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/06131629fde375528b71158b8c46d59c8841c6c5", "committedDate": "2020-05-12T23:30:38Z", "message": "ARTEMIS-2757 improving flow control in AMQP"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "06131629fde375528b71158b8c46d59c8841c6c5", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/06131629fde375528b71158b8c46d59c8841c6c5", "committedDate": "2020-05-12T23:30:38Z", "message": "ARTEMIS-2757 improving flow control in AMQP"}, "afterCommit": {"oid": "1599ac1a36b0938f500fcf86096300ee46f70d1a", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/1599ac1a36b0938f500fcf86096300ee46f70d1a", "committedDate": "2020-05-12T23:31:38Z", "message": "ARTEMIS-2757 improving flow control in AMQP"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1599ac1a36b0938f500fcf86096300ee46f70d1a", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/1599ac1a36b0938f500fcf86096300ee46f70d1a", "committedDate": "2020-05-12T23:31:38Z", "message": "ARTEMIS-2757 improving flow control in AMQP"}, "afterCommit": {"oid": "11b8dc11e29b25dbaa8ece71440952cd6f0ca4f6", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/11b8dc11e29b25dbaa8ece71440952cd6f0ca4f6", "committedDate": "2020-05-12T23:32:33Z", "message": "ARTEMIS-2757 improving flow control in AMQP"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "11b8dc11e29b25dbaa8ece71440952cd6f0ca4f6", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/11b8dc11e29b25dbaa8ece71440952cd6f0ca4f6", "committedDate": "2020-05-12T23:32:33Z", "message": "ARTEMIS-2757 improving flow control in AMQP"}, "afterCommit": {"oid": "1585e7f424e80528acd19378cfbd48da9f55e261", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/1585e7f424e80528acd19378cfbd48da9f55e261", "committedDate": "2020-05-12T23:37:53Z", "message": "ARTEMIS-2757 improving flow control in AMQP"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1585e7f424e80528acd19378cfbd48da9f55e261", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/1585e7f424e80528acd19378cfbd48da9f55e261", "committedDate": "2020-05-12T23:37:53Z", "message": "ARTEMIS-2757 improving flow control in AMQP"}, "afterCommit": {"oid": "2c0778588fef546b28a4e6b0c2d9da082ef72fdb", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/2c0778588fef546b28a4e6b0c2d9da082ef72fdb", "committedDate": "2020-05-12T23:55:51Z", "message": "ARTEMIS-2757 improving flow control in AMQP"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c0778588fef546b28a4e6b0c2d9da082ef72fdb", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/2c0778588fef546b28a4e6b0c2d9da082ef72fdb", "committedDate": "2020-05-12T23:55:51Z", "message": "ARTEMIS-2757 improving flow control in AMQP"}, "afterCommit": {"oid": "3ed3af04f58239bac878af26f283e55ca521bba4", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/3ed3af04f58239bac878af26f283e55ca521bba4", "committedDate": "2020-05-13T18:03:48Z", "message": "ARTEMIS-2757 improving flow control in AMQP"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c68dad7331af1819b65e7778a8aaf1072f76a5a5", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/c68dad7331af1819b65e7778a8aaf1072f76a5a5", "committedDate": "2020-05-14T15:32:08Z", "message": "new test"}, "afterCommit": {"oid": "bbffd73ca87966b6343adfc353e21d0e9e2c64c8", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/bbffd73ca87966b6343adfc353e21d0e9e2c64c8", "committedDate": "2020-05-14T19:12:02Z", "message": "ARTEMIS-2757 Improving flow control in AMQP 2nd improvements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMTA4ODkz", "url": "https://github.com/apache/activemq-artemis/pull/3130#pullrequestreview-412108893", "createdAt": "2020-05-14T19:13:21Z", "commit": {"oid": "bbffd73ca87966b6343adfc353e21d0e9e2c64c8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxOToxMzoyMVrOGVqnkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxOToxMzoyMVrOGVqnkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM3MTUzNw==", "bodyText": "This should fix your test... as this will guarantee no executor for non durable. It will be basically a straight call like before.", "url": "https://github.com/apache/activemq-artemis/pull/3130#discussion_r425371537", "createdAt": "2020-05-14T19:13:21Z", "author": {"login": "clebertsuconic"}, "path": "artemis-protocols/artemis-amqp-protocol/src/main/java/org/apache/activemq/artemis/protocol/amqp/broker/AMQPSessionCallback.java", "diffHunk": "@@ -496,15 +499,21 @@ public void serverSend(ProtonServerReceiverContext context,\n             }\n          } else {\n             message.setConnectionID(receiver.getSession().getConnection().getRemoteContainer());\n-            // We need to transfer IO execution to a different thread otherwise we may deadlock netty loop\n-            sessionExecutor.execute(() -> inSessionSend(context, transaction, message, delivery, receiver, routingContext));\n+            // If there are pending messages (durable) on the executors, we should still use the executors\n+            // otherwise we risk running out of order\n+            if (pendingSettles == 0 && !message.isDurable()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbffd73ca87966b6343adfc353e21d0e9e2c64c8"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMTA5MjE0", "url": "https://github.com/apache/activemq-artemis/pull/3130#pullrequestreview-412109214", "createdAt": "2020-05-14T19:13:48Z", "commit": {"oid": "bbffd73ca87966b6343adfc353e21d0e9e2c64c8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxOToxMzo0OFrOGVqofg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxOToxMzo0OFrOGVqofg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM3MTc3NA==", "bodyText": "@tabish121 this will also fix your test, as it will avoid using an executor for non durable", "url": "https://github.com/apache/activemq-artemis/pull/3130#discussion_r425371774", "createdAt": "2020-05-14T19:13:48Z", "author": {"login": "clebertsuconic"}, "path": "artemis-protocols/artemis-amqp-protocol/src/main/java/org/apache/activemq/artemis/protocol/amqp/broker/AMQPSessionCallback.java", "diffHunk": "@@ -543,7 +552,7 @@ private void inSessionSend(final ProtonServerReceiverContext context,\n             afterIO(new IOCallback() {\n                @Override\n                public void done() {\n-                  connection.runLater(() -> {\n+                  connection.runNow(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbffd73ca87966b6343adfc353e21d0e9e2c64c8"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMTA5Njgx", "url": "https://github.com/apache/activemq-artemis/pull/3130#pullrequestreview-412109681", "createdAt": "2020-05-14T19:14:31Z", "commit": {"oid": "bbffd73ca87966b6343adfc353e21d0e9e2c64c8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxOToxNDozMVrOGVqp2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxOToxNDozMVrOGVqp2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM3MjEyMw==", "bodyText": "@tabish121 also, in case you mix durable and non durable and use the executors, this will adjust pending settles on the credits.", "url": "https://github.com/apache/activemq-artemis/pull/3130#discussion_r425372123", "createdAt": "2020-05-14T19:14:31Z", "author": {"login": "clebertsuconic"}, "path": "artemis-protocols/artemis-amqp-protocol/src/main/java/org/apache/activemq/artemis/protocol/amqp/proton/ProtonServerReceiverContext.java", "diffHunk": "@@ -128,10 +147,11 @@ public void run() {\n          }\n \n          connection.requireInHandler();\n-         if (receiver.getCredit() <= threshold) {\n-            int topUp = refill - receiver.getCredit();\n+         int pending = context != null ? context.pendingSettles : 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbffd73ca87966b6343adfc353e21d0e9e2c64c8"}, "originalPosition": 62}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bbffd73ca87966b6343adfc353e21d0e9e2c64c8", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/bbffd73ca87966b6343adfc353e21d0e9e2c64c8", "committedDate": "2020-05-14T19:12:02Z", "message": "ARTEMIS-2757 Improving flow control in AMQP 2nd improvements"}, "afterCommit": {"oid": "84978c41ebf032b43d477c828fd6f875f3605091", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/84978c41ebf032b43d477c828fd6f875f3605091", "committedDate": "2020-05-14T19:38:56Z", "message": "ARTEMIS-2757 Improving flow control in AMQP 2nd improvements"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84978c41ebf032b43d477c828fd6f875f3605091", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/84978c41ebf032b43d477c828fd6f875f3605091", "committedDate": "2020-05-14T19:38:56Z", "message": "ARTEMIS-2757 Improving flow control in AMQP 2nd improvements"}, "afterCommit": {"oid": "64793ca0c4220e4262b6e15f6330a4d257522f42", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/64793ca0c4220e4262b6e15f6330a4d257522f42", "committedDate": "2020-05-14T19:39:08Z", "message": "ARTEMIS-2757 Improving flow control in AMQP 2nd improvements"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "64793ca0c4220e4262b6e15f6330a4d257522f42", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/64793ca0c4220e4262b6e15f6330a4d257522f42", "committedDate": "2020-05-14T19:39:08Z", "message": "ARTEMIS-2757 Improving flow control in AMQP 2nd improvements"}, "afterCommit": {"oid": "58ea641e2683277d047a6ccc8dcadf6aa52b2f94", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/58ea641e2683277d047a6ccc8dcadf6aa52b2f94", "committedDate": "2020-05-14T19:49:40Z", "message": "ARTEMIS-2757 Improving flow control in AMQP 2nd improvements"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b33ca65472c8c2296cd939ee10a515f8342ebc6f", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/b33ca65472c8c2296cd939ee10a515f8342ebc6f", "committedDate": "2020-05-14T20:30:35Z", "message": "ARTEMIS-2757 to be squashed - testing added"}, "afterCommit": {"oid": "7490bac8adb3cc984952b98cec5b9c1767008e9e", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/7490bac8adb3cc984952b98cec5b9c1767008e9e", "committedDate": "2020-05-14T20:36:39Z", "message": "ARTEMIS-2757 to be squashed - testing added"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7490bac8adb3cc984952b98cec5b9c1767008e9e", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/7490bac8adb3cc984952b98cec5b9c1767008e9e", "committedDate": "2020-05-14T20:36:39Z", "message": "ARTEMIS-2757 to be squashed - testing added"}, "afterCommit": {"oid": "231df44d44f726038ebb53e45e142dd8f04ae6e6", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/231df44d44f726038ebb53e45e142dd8f04ae6e6", "committedDate": "2020-05-14T22:11:33Z", "message": "ARTEMIS-2757 improving flow control in AMQP"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9bdc4f345fc2759158c77f02fae0313ea8aff0bb", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/9bdc4f345fc2759158c77f02fae0313ea8aff0bb", "committedDate": "2020-05-14T23:15:53Z", "message": "ARTEMIS-2757 Isolating Credits Calculation and adding a test"}, "afterCommit": {"oid": "aacaee5c12808d258e5e4ae4e05c7179a5c9f7ea", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/aacaee5c12808d258e5e4ae4e05c7179a5c9f7ea", "committedDate": "2020-05-15T14:39:44Z", "message": "ARTEMIS-2757 Isolating Credits Calculation and adding a test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ff3c17525b39410a934073a30548e3aa1b1cddc", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/9ff3c17525b39410a934073a30548e3aa1b1cddc", "committedDate": "2020-05-15T20:12:07Z", "message": "ARTEMIS-2757 improving flow control in AMQP"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ad30a540eae738868b7df8b0db6cf3ae2d24a048", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/ad30a540eae738868b7df8b0db6cf3ae2d24a048", "committedDate": "2020-05-15T15:42:53Z", "message": "ARTEMIS-2757 Removing an executor on the send"}, "afterCommit": {"oid": "9ff3c17525b39410a934073a30548e3aa1b1cddc", "author": {"user": {"login": "clebertsuconic", "name": null}}, "url": "https://github.com/apache/activemq-artemis/commit/9ff3c17525b39410a934073a30548e3aa1b1cddc", "committedDate": "2020-05-15T20:12:07Z", "message": "ARTEMIS-2757 improving flow control in AMQP"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1611, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}