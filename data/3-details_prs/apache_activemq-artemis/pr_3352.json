{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0NjU4NjEx", "number": 3352, "title": "ARTEMIS-2990 - alway be getBiased and only publish complete records a\u2026", "bodyText": "\u2026nd only calculate linked addresses once ARTEMIS-2990", "createdAt": "2020-11-20T11:58:55Z", "url": "https://github.com/apache/activemq-artemis/pull/3352", "merged": true, "mergeCommit": {"oid": "a5d7a043dc844708e0eae0f9c889ee71b636757f"}, "closed": true, "closedAt": "2020-11-24T13:33:22Z", "author": {"login": "gtully"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeYYaagFqTUzNTQ4Mjg0Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfWk3cABqjQwMjgxMzU1ODA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NDgyODQ3", "url": "https://github.com/apache/activemq-artemis/pull/3352#pullrequestreview-535482847", "createdAt": "2020-11-20T14:38:28Z", "commit": {"oid": "c335c7f8e9f7b2620ba629497d49febcb363da77"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNDozODoyOFrOH3SYng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNDozODoyOFrOH3SYng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzczNDk0Mg==", "bodyText": "it's just a personal thing with code:\nif (actualAddress != null) {\n    return actualAddress;\n}\n// from now one, slow path\nIt's helpful for the brain to not further reading the rest of code, if not needed\nand it allows to pack the slow path code into a specific (synchronized) method too", "url": "https://github.com/apache/activemq-artemis/pull/3352#discussion_r527734942", "createdAt": "2020-11-20T14:38:28Z", "author": {"login": "franz1981"}, "path": "artemis-server/src/main/java/org/apache/activemq/artemis/core/postoffice/impl/WildcardAddressManager.java", "diffHunk": "@@ -175,36 +175,38 @@ public void clear() {\n       wildCardAddresses.clear();\n    }\n \n-   private Address addAndUpdateAddressMap(final SimpleString address, boolean getBiased) {\n+   private Address addAndUpdateAddressMap(final SimpleString address) {\n       final boolean containsWildCard = address.containsEitherOf(wildcardConfiguration.getAnyWords(), wildcardConfiguration.getSingleWord());\n       final Map<SimpleString, Address> addressMap = containsWildCard ? wildCardAddresses : addresses;\n-      Address actualAddress = null;\n-      if (getBiased) {\n-         // CHM::get doesn't need to synchronize anything, so it's to be preferred for getBiased cases\n-         actualAddress = addressMap.get(address);\n-      }\n+      Address actualAddress = addressMap.get(address);\n       if (actualAddress == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c335c7f8e9f7b2620ba629497d49febcb363da77"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NDg3MzUz", "url": "https://github.com/apache/activemq-artemis/pull/3352#pullrequestreview-535487353", "createdAt": "2020-11-20T14:43:41Z", "commit": {"oid": "c335c7f8e9f7b2620ba629497d49febcb363da77"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNDo0Mzo0MVrOH3SljA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNDo0Mzo0MVrOH3SljA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzczODI1Mg==", "bodyText": "Same here: https://github.com/apache/activemq-artemis/pull/3352/files#r527734942", "url": "https://github.com/apache/activemq-artemis/pull/3352#discussion_r527738252", "createdAt": "2020-11-20T14:43:41Z", "author": {"login": "franz1981"}, "path": "artemis-server/src/main/java/org/apache/activemq/artemis/core/postoffice/impl/WildcardAddressManager.java", "diffHunk": "@@ -175,36 +175,38 @@ public void clear() {\n       wildCardAddresses.clear();\n    }\n \n-   private Address addAndUpdateAddressMap(final SimpleString address, boolean getBiased) {\n+   private Address addAndUpdateAddressMap(final SimpleString address) {\n       final boolean containsWildCard = address.containsEitherOf(wildcardConfiguration.getAnyWords(), wildcardConfiguration.getSingleWord());\n       final Map<SimpleString, Address> addressMap = containsWildCard ? wildCardAddresses : addresses;\n-      Address actualAddress = null;\n-      if (getBiased) {\n-         // CHM::get doesn't need to synchronize anything, so it's to be preferred for getBiased cases\n-         actualAddress = addressMap.get(address);\n-      }\n+      Address actualAddress = addressMap.get(address);\n       if (actualAddress == null) {\n-         actualAddress = addressMap.computeIfAbsent(address, addressKey -> new AddressImpl(addressKey, wildcardConfiguration));\n-      }\n-      assert actualAddress.containsWildCard() == containsWildCard;\n-      synchronized (this) {\n-         if (containsWildCard) {\n-            for (Address destAdd : this.addresses.values()) {\n-               if (destAdd.matches(actualAddress)) {\n-                  destAdd.addLinkedAddress(actualAddress);\n-                  actualAddress.addLinkedAddress(destAdd);\n-               }\n-            }\n-         } else {\n-            for (Address destAdd : wildCardAddresses.values()) {\n-               if (actualAddress.matches(destAdd)) {\n-                  destAdd.addLinkedAddress(actualAddress);\n-                  actualAddress.addLinkedAddress(destAdd);\n+         synchronized (this) {\n+            actualAddress = addressMap.get(address);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c335c7f8e9f7b2620ba629497d49febcb363da77"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NTAyNjc1", "url": "https://github.com/apache/activemq-artemis/pull/3352#pullrequestreview-535502675", "createdAt": "2020-11-20T15:00:56Z", "commit": {"oid": "c335c7f8e9f7b2620ba629497d49febcb363da77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNTowMDo1NlrOH3TSTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNTowMDo1NlrOH3TSTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc0OTcwOA==", "bodyText": "-1 having asserts, if it called twice it wont error but simply proceed. Is this really a good idea, risk breaking or erroring", "url": "https://github.com/apache/activemq-artemis/pull/3352#discussion_r527749708", "createdAt": "2020-11-20T15:00:56Z", "author": {"login": "michaelandrepearce"}, "path": "artemis-server/src/main/java/org/apache/activemq/artemis/core/postoffice/impl/AddressImpl.java", "diffHunk": "@@ -84,6 +84,7 @@ public void addLinkedAddress(final Address address) {\n       if (linkedAddresses == null) {\n          linkedAddresses = PlatformDependent.hasUnsafe() ? new NonBlockingHashSet<>() : new ConcurrentHashSet<>();\n       }\n+      assert !linkedAddresses.contains(address);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c335c7f8e9f7b2620ba629497d49febcb363da77"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c335c7f8e9f7b2620ba629497d49febcb363da77", "author": {"user": {"login": "gtully", "name": "Gary Tully"}}, "url": "https://github.com/apache/activemq-artemis/commit/c335c7f8e9f7b2620ba629497d49febcb363da77", "committedDate": "2020-11-20T11:57:15Z", "message": "ARTEMIS-2990 - alway be getBiased and only publish complete records and only calculate linked addresses once ARTEMIS-2990"}, "afterCommit": {"oid": "8fab62d5a723881a3dd1e5bb87d7348d1c178e37", "author": {"user": {"login": "gtully", "name": "Gary Tully"}}, "url": "https://github.com/apache/activemq-artemis/commit/8fab62d5a723881a3dd1e5bb87d7348d1c178e37", "committedDate": "2020-11-23T14:52:36Z", "message": "ARTEMIS-2990 - alway be getBiased and only publish complete records and only calculate linked addresses once ARTEMIS-2990"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d8dc5644bf41bbcb601ce517aab035f0371e831", "author": {"user": {"login": "gtully", "name": "Gary Tully"}}, "url": "https://github.com/apache/activemq-artemis/commit/7d8dc5644bf41bbcb601ce517aab035f0371e831", "committedDate": "2020-11-23T15:06:52Z", "message": "ARTEMIS-2990 - alway be getBiased and only publish complete records and only calculate linked addresses once ARTEMIS-2990"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8fab62d5a723881a3dd1e5bb87d7348d1c178e37", "author": {"user": {"login": "gtully", "name": "Gary Tully"}}, "url": "https://github.com/apache/activemq-artemis/commit/8fab62d5a723881a3dd1e5bb87d7348d1c178e37", "committedDate": "2020-11-23T14:52:36Z", "message": "ARTEMIS-2990 - alway be getBiased and only publish complete records and only calculate linked addresses once ARTEMIS-2990"}, "afterCommit": {"oid": "7d8dc5644bf41bbcb601ce517aab035f0371e831", "author": {"user": {"login": "gtully", "name": "Gary Tully"}}, "url": "https://github.com/apache/activemq-artemis/commit/7d8dc5644bf41bbcb601ce517aab035f0371e831", "committedDate": "2020-11-23T15:06:52Z", "message": "ARTEMIS-2990 - alway be getBiased and only publish complete records and only calculate linked addresses once ARTEMIS-2990"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1563, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}