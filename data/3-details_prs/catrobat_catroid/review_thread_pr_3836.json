{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNzI2NDMz", "number": 3836, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNTowNjozNFrOEukQmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNToyMzo0NFrOEuk1Hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3MjY0MDI2OnYy", "diffSide": "RIGHT", "path": "catroid/src/main/java/org/catrobat/catroid/utils/HtmlRegexExtractor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNTowNjozNFrOHjD2sQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNjowMTo1M1rOHjGtTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUyNTM2MQ==", "bodyText": "PLEASE REFACTOR:\nIn my opinion, it's a bit hard to read.\nMy suggestion would be:\nif (keyword == null) {\n\treturn null;\n}\nint keywordIndex = html.indexOf(keyword);\nif (keyword.equals(html) || keywordIndex < 0) {\n\treturn \"(.+)\";\n}", "url": "https://github.com/Catrobat/Catroid/pull/3836#discussion_r506525361", "createdAt": "2020-10-16T15:06:34Z", "author": {"login": "gPathpp"}, "path": "catroid/src/main/java/org/catrobat/catroid/utils/HtmlRegexExtractor.java", "diffHunk": "@@ -56,87 +57,64 @@ private void showError() {\n \t\t\t\tR.string.formula_editor_function_regex_html_extractor_not_found);\n \t}\n \n-\t@VisibleForTesting\n-\tpublic String findKeyword(String keyword, String text) {\n+\t@VisibleForTesting(otherwise = VisibleForTesting.PROTECTED)\n+\tpublic String findKeyword(String keyword, String html) {\n \t\tif (keyword.equals(\"\")) {\n \t\t\treturn null;\n \t\t}\n-\t\tif (text.indexOf(keyword) >= 0) {\n+\t\tif (html.contains(keyword)) {\n \t\t\treturn keyword;\n \t\t} else {\n-\t\t\treturn findKeywordWithHtmlBetweenWordsInText(keyword, text);\n+\t\t\treturn findKeywordWithHtmlBetweenWordsInText(keyword, html);\n \t\t}\n \t}\n \n-\tprivate String findKeywordWithHtmlBetweenWordsInText(String keyword, String text) {\n-\t\tString[] splittedKeyword = keyword.split(\" \");\n-\t\tString regex = Pattern.quote(splittedKeyword[0]);\n-\n-\t\tfor (int i = 1; i < splittedKeyword.length; i++) {\n-\t\t\tregex += \".*?\" + Pattern.quote(splittedKeyword[i]);\n-\t\t}\n-\t\treturn findShortestOccurrenceInText(regex, text);\n-\t}\n+\tprivate String findKeywordWithHtmlBetweenWordsInText(String keywords, String html) {\n \n-\tprivate String findShortestOccurrenceInText(String regex, String text) {\n-\t\tMatcher m = Pattern.compile(regex).matcher(text);\n+\t\tString[] splittedKeywords = keywords.split(\"\\\\s+\");\n+\t\tString keywordsWithHtmlBetweenWords = Pattern.quote(splittedKeywords[0]);\n \n-\t\tString shortestOccurrence = null;\n-\t\tint lastIndex = -1;\n-\t\twhile (m.find(lastIndex + 1)) {\n-\t\t\tString found = m.group();\n-\t\t\tif (shortestOccurrence == null || shortestOccurrence.length() > found.length()) {\n-\t\t\t\tshortestOccurrence = found;\n-\t\t\t\tlastIndex = m.start();\n-\t\t\t}\n+\t\tfor (int i = 1; i < splittedKeywords.length; i++) {\n+\t\t\tkeywordsWithHtmlBetweenWords += \"(\\\\s|&nbsp;|<[^>]+>)+?\" + Pattern.quote(splittedKeywords[i]);\n \t\t}\n-\t\treturn shortestOccurrence;\n+\t\tMatcher matcher = Pattern.compile(keywordsWithHtmlBetweenWords).matcher(html);\n+\t\tif (matcher.find()) {\n+\t\t\treturn matcher.group();\n+\t\t} \n+\t\treturn null;\n \t}\n \n-\tpublic String htmlToRegexConverter(String keyword, String htmlText) {\n-\t\tint keywordIndex;\n-\t\tString regex;\n+\t@VisibleForTesting(otherwise = VisibleForTesting.PROTECTED)\n+\tpublic String htmlToRegexConverter(String keyword, String html) {\n \n \t\tif (keyword != null) {\n-\t\t\tkeywordIndex = htmlText.indexOf(keyword);\n-\t\t\tif (keyword.equals(htmlText)) {\n-\t\t\t\tregex = \"(.*)\";\n-\t\t\t} else {\n-\t\t\t\tregex = \"(.*)\";\n+\t\t\tint keywordIndex = html.indexOf(keyword);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43ed69cbfd8bbec0739d091b42977c00dfea824f"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU3MjEwOA==", "bodyText": "PLEASE REFACTOR:\n...\n\nAgreed & done, thanks!", "url": "https://github.com/Catrobat/Catroid/pull/3836#discussion_r506572108", "createdAt": "2020-10-16T16:01:53Z", "author": {"login": "wslany"}, "path": "catroid/src/main/java/org/catrobat/catroid/utils/HtmlRegexExtractor.java", "diffHunk": "@@ -56,87 +57,64 @@ private void showError() {\n \t\t\t\tR.string.formula_editor_function_regex_html_extractor_not_found);\n \t}\n \n-\t@VisibleForTesting\n-\tpublic String findKeyword(String keyword, String text) {\n+\t@VisibleForTesting(otherwise = VisibleForTesting.PROTECTED)\n+\tpublic String findKeyword(String keyword, String html) {\n \t\tif (keyword.equals(\"\")) {\n \t\t\treturn null;\n \t\t}\n-\t\tif (text.indexOf(keyword) >= 0) {\n+\t\tif (html.contains(keyword)) {\n \t\t\treturn keyword;\n \t\t} else {\n-\t\t\treturn findKeywordWithHtmlBetweenWordsInText(keyword, text);\n+\t\t\treturn findKeywordWithHtmlBetweenWordsInText(keyword, html);\n \t\t}\n \t}\n \n-\tprivate String findKeywordWithHtmlBetweenWordsInText(String keyword, String text) {\n-\t\tString[] splittedKeyword = keyword.split(\" \");\n-\t\tString regex = Pattern.quote(splittedKeyword[0]);\n-\n-\t\tfor (int i = 1; i < splittedKeyword.length; i++) {\n-\t\t\tregex += \".*?\" + Pattern.quote(splittedKeyword[i]);\n-\t\t}\n-\t\treturn findShortestOccurrenceInText(regex, text);\n-\t}\n+\tprivate String findKeywordWithHtmlBetweenWordsInText(String keywords, String html) {\n \n-\tprivate String findShortestOccurrenceInText(String regex, String text) {\n-\t\tMatcher m = Pattern.compile(regex).matcher(text);\n+\t\tString[] splittedKeywords = keywords.split(\"\\\\s+\");\n+\t\tString keywordsWithHtmlBetweenWords = Pattern.quote(splittedKeywords[0]);\n \n-\t\tString shortestOccurrence = null;\n-\t\tint lastIndex = -1;\n-\t\twhile (m.find(lastIndex + 1)) {\n-\t\t\tString found = m.group();\n-\t\t\tif (shortestOccurrence == null || shortestOccurrence.length() > found.length()) {\n-\t\t\t\tshortestOccurrence = found;\n-\t\t\t\tlastIndex = m.start();\n-\t\t\t}\n+\t\tfor (int i = 1; i < splittedKeywords.length; i++) {\n+\t\t\tkeywordsWithHtmlBetweenWords += \"(\\\\s|&nbsp;|<[^>]+>)+?\" + Pattern.quote(splittedKeywords[i]);\n \t\t}\n-\t\treturn shortestOccurrence;\n+\t\tMatcher matcher = Pattern.compile(keywordsWithHtmlBetweenWords).matcher(html);\n+\t\tif (matcher.find()) {\n+\t\t\treturn matcher.group();\n+\t\t} \n+\t\treturn null;\n \t}\n \n-\tpublic String htmlToRegexConverter(String keyword, String htmlText) {\n-\t\tint keywordIndex;\n-\t\tString regex;\n+\t@VisibleForTesting(otherwise = VisibleForTesting.PROTECTED)\n+\tpublic String htmlToRegexConverter(String keyword, String html) {\n \n \t\tif (keyword != null) {\n-\t\t\tkeywordIndex = htmlText.indexOf(keyword);\n-\t\t\tif (keyword.equals(htmlText)) {\n-\t\t\t\tregex = \"(.*)\";\n-\t\t\t} else {\n-\t\t\t\tregex = \"(.*)\";\n+\t\t\tint keywordIndex = html.indexOf(keyword);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUyNTM2MQ=="}, "originalCommit": {"oid": "43ed69cbfd8bbec0739d091b42977c00dfea824f"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3MjczMzc1OnYy", "diffSide": "RIGHT", "path": "catroid/src/test/java/org/catrobat/catroid/test/ui/regexassistant/HtmlRegexExtractorTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNToyMzo0NFrOHjEzzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNTo0MToyNVrOHjFyxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU0MTAwNw==", "bodyText": "QUESTION: Do we need such a long text? And why was \"testCreateRegexWhereTextOnlyKeywords()\" deleted?", "url": "https://github.com/Catrobat/Catroid/pull/3836#discussion_r506541007", "createdAt": "2020-10-16T15:23:44Z", "author": {"login": "gPathpp"}, "path": "catroid/src/test/java/org/catrobat/catroid/test/ui/regexassistant/HtmlRegexExtractorTest.java", "diffHunk": "@@ -105,50 +104,79 @@ public void testFindKeywordSmallestOccurrence() {\n \n \t@Test\n \tpublic void testCreateRegexWithOneCharContext() {\n-\t\tassertEquals(\"b(.*)e\", htmlExtractor.htmlToRegexConverter(\"cd\", \"abcdefg\"));\n+\t\tassertEquals(\"\\\\Qb\\\\E(.+?)\\\\Qe\\\\E\", htmlExtractor.htmlToRegexConverter(\"cd\", \"abcdefg\"));\n \t}\n \n \t@Test\n \tpublic void testCreateRegexWithKeywordAtStart() {\n-\t\tassertEquals(\"(.*)c\", htmlExtractor.htmlToRegexConverter(\"ab\", \"abcdefg\"));\n-\t}\n-\n-\t@Test\n-\tpublic void testCreateRegexWithKeywordAtEnd() {\n-\t\tassertEquals(\"d(.*)\", htmlExtractor.htmlToRegexConverter(\"efg\", \"abcdefg\"));\n+\t\tassertEquals(\"\\\\Q\\\\E(.+?)\\\\Qc\\\\E\", htmlExtractor.htmlToRegexConverter(\"ab\", \"abcdefg\"));\n \t}\n \n \t@Test\n \tpublic void testCreateRegexWithDuplicateKeywordFirstOccurrence1CharContext() {\n-\t\tassertEquals(\"ab(.*)defga\", htmlExtractor.htmlToRegexConverter(\"KEY\", \"abKEYdefgadKEYdefg\"));\n+\t\tassertEquals(\"\\\\Qb\\\\E(.+?)\\\\Qd\\\\E\", htmlExtractor.htmlToRegexConverter(\"KEY\", \"abKEYdefgadKEYdefg\"));\n \t}\n \n \t@Test\n \tpublic void testCreateRegexWith2CharContext() {\n-\t\tassertEquals(\"yb(.*)de\", htmlExtractor.htmlToRegexConverter(\"KEY\", \"abcdefg ybKEYdefg\"));\n+\t\tassertEquals(\"\\\\Qyb\\\\E(.+?)\\\\Qde\\\\E\", htmlExtractor.htmlToRegexConverter(\"KEY\", \"abcdefg ybKEYdefg\"));\n \t}\n \n \t@Test\n \tpublic void testCreateRegexWhereKeywordEqualsHtmlText() {\n-\t\tassertEquals(\"(.*)\", htmlExtractor.htmlToRegexConverter(\"abcdefg\", \"abcdefg\"));\n+\t\tassertEquals(\"(.+)\", htmlExtractor.htmlToRegexConverter(\"abcdefg\", \"abcdefg\"));\n \t}\n \n \t@Test\n \tpublic void testCreateRegexPostfixInKeyword() {\n-\t\tassertEquals(\"(.*)b\", htmlExtractor.htmlToRegexConverter(\"abc\", \"abcbc\"));\n+\t\tassertEquals(\"\\\\Q\\\\E(.+?)\\\\Qbd\\\\E\", htmlExtractor.htmlToRegexConverter(\"abc\", \"abcbd\"));\n \t}\n \n \t@Test\n \tpublic void testCreateRegexOutOfBoundsAfter2CharContext() {\n-\t\tassertEquals(\"b(.*)ba\", htmlExtractor.htmlToRegexConverter(\"abc\", \"babcbabcb\"));\n+\t\tassertEquals(\"\\\\Qb\\\\E(.+?)\\\\Qba\\\\E\", htmlExtractor.htmlToRegexConverter(\"abc\", \"babcbabcb\"));\n \t}\n \t@Test\n \tpublic void testFirstKeyBordersOnSecondKey() {\n-\t\tassertEquals(\"baaaa(.*)aaaaK\", htmlExtractor.htmlToRegexConverter(\"KEY\",\n-\t\t\t\t\"baaaaKEYaaaaKEYaaaa\"));\n-\t}\n-\t@Test\n-\tpublic void testCreateRegexWhereTextOnlyKeywords() {\n-\t\tassertEquals(\"(.*)aa\", htmlExtractor.htmlToRegexConverter(\"a\", \"aaa\"));\n+\t\tassertEquals(\"\\\\Qa\\\\E(.+?)\\\\Qa\\\\E\", htmlExtractor.htmlToRegexConverter(\"KEY\",\n+\t\t\t\t\"baKEYaKEYaa\"));\n+\t}\n+\t@Test\n+\tpublic void testTemperatureTimeAndDateDotCom() {\n+\t\tString htmlTimeAndDateDotCom = \n+\t\t\t\t\"</script><nav class=nav-3><div class=fixed><a href='/weather/germany/hildesheim'\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43ed69cbfd8bbec0739d091b42977c00dfea824f"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU1NzEyNQ==", "bodyText": "The problem occurred only with long inputs, that's why I wanted a more realistic example. It is still only an excerpt of the full page.\nAnd I deleted testCreateRegexWhereTextOnlyKeywords() because it was a trivial case that would never occur in reality (the keyword == html text) and for which we would have to increase the complexity of the code, because of my code changes. I deemed it not worth to increase the complexity for this anyway unrealistic case.", "url": "https://github.com/Catrobat/Catroid/pull/3836#discussion_r506557125", "createdAt": "2020-10-16T15:41:25Z", "author": {"login": "wslany"}, "path": "catroid/src/test/java/org/catrobat/catroid/test/ui/regexassistant/HtmlRegexExtractorTest.java", "diffHunk": "@@ -105,50 +104,79 @@ public void testFindKeywordSmallestOccurrence() {\n \n \t@Test\n \tpublic void testCreateRegexWithOneCharContext() {\n-\t\tassertEquals(\"b(.*)e\", htmlExtractor.htmlToRegexConverter(\"cd\", \"abcdefg\"));\n+\t\tassertEquals(\"\\\\Qb\\\\E(.+?)\\\\Qe\\\\E\", htmlExtractor.htmlToRegexConverter(\"cd\", \"abcdefg\"));\n \t}\n \n \t@Test\n \tpublic void testCreateRegexWithKeywordAtStart() {\n-\t\tassertEquals(\"(.*)c\", htmlExtractor.htmlToRegexConverter(\"ab\", \"abcdefg\"));\n-\t}\n-\n-\t@Test\n-\tpublic void testCreateRegexWithKeywordAtEnd() {\n-\t\tassertEquals(\"d(.*)\", htmlExtractor.htmlToRegexConverter(\"efg\", \"abcdefg\"));\n+\t\tassertEquals(\"\\\\Q\\\\E(.+?)\\\\Qc\\\\E\", htmlExtractor.htmlToRegexConverter(\"ab\", \"abcdefg\"));\n \t}\n \n \t@Test\n \tpublic void testCreateRegexWithDuplicateKeywordFirstOccurrence1CharContext() {\n-\t\tassertEquals(\"ab(.*)defga\", htmlExtractor.htmlToRegexConverter(\"KEY\", \"abKEYdefgadKEYdefg\"));\n+\t\tassertEquals(\"\\\\Qb\\\\E(.+?)\\\\Qd\\\\E\", htmlExtractor.htmlToRegexConverter(\"KEY\", \"abKEYdefgadKEYdefg\"));\n \t}\n \n \t@Test\n \tpublic void testCreateRegexWith2CharContext() {\n-\t\tassertEquals(\"yb(.*)de\", htmlExtractor.htmlToRegexConverter(\"KEY\", \"abcdefg ybKEYdefg\"));\n+\t\tassertEquals(\"\\\\Qyb\\\\E(.+?)\\\\Qde\\\\E\", htmlExtractor.htmlToRegexConverter(\"KEY\", \"abcdefg ybKEYdefg\"));\n \t}\n \n \t@Test\n \tpublic void testCreateRegexWhereKeywordEqualsHtmlText() {\n-\t\tassertEquals(\"(.*)\", htmlExtractor.htmlToRegexConverter(\"abcdefg\", \"abcdefg\"));\n+\t\tassertEquals(\"(.+)\", htmlExtractor.htmlToRegexConverter(\"abcdefg\", \"abcdefg\"));\n \t}\n \n \t@Test\n \tpublic void testCreateRegexPostfixInKeyword() {\n-\t\tassertEquals(\"(.*)b\", htmlExtractor.htmlToRegexConverter(\"abc\", \"abcbc\"));\n+\t\tassertEquals(\"\\\\Q\\\\E(.+?)\\\\Qbd\\\\E\", htmlExtractor.htmlToRegexConverter(\"abc\", \"abcbd\"));\n \t}\n \n \t@Test\n \tpublic void testCreateRegexOutOfBoundsAfter2CharContext() {\n-\t\tassertEquals(\"b(.*)ba\", htmlExtractor.htmlToRegexConverter(\"abc\", \"babcbabcb\"));\n+\t\tassertEquals(\"\\\\Qb\\\\E(.+?)\\\\Qba\\\\E\", htmlExtractor.htmlToRegexConverter(\"abc\", \"babcbabcb\"));\n \t}\n \t@Test\n \tpublic void testFirstKeyBordersOnSecondKey() {\n-\t\tassertEquals(\"baaaa(.*)aaaaK\", htmlExtractor.htmlToRegexConverter(\"KEY\",\n-\t\t\t\t\"baaaaKEYaaaaKEYaaaa\"));\n-\t}\n-\t@Test\n-\tpublic void testCreateRegexWhereTextOnlyKeywords() {\n-\t\tassertEquals(\"(.*)aa\", htmlExtractor.htmlToRegexConverter(\"a\", \"aaa\"));\n+\t\tassertEquals(\"\\\\Qa\\\\E(.+?)\\\\Qa\\\\E\", htmlExtractor.htmlToRegexConverter(\"KEY\",\n+\t\t\t\t\"baKEYaKEYaa\"));\n+\t}\n+\t@Test\n+\tpublic void testTemperatureTimeAndDateDotCom() {\n+\t\tString htmlTimeAndDateDotCom = \n+\t\t\t\t\"</script><nav class=nav-3><div class=fixed><a href='/weather/germany/hildesheim'\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU0MTAwNw=="}, "originalCommit": {"oid": "43ed69cbfd8bbec0739d091b42977c00dfea824f"}, "originalPosition": 81}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3817, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}