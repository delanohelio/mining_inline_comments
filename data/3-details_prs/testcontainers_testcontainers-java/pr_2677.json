{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0NTYyNDc2", "number": 2677, "title": "Dynamic CI jobs for examples", "bodyText": "Intended to apply our dynamic approach for GitHub Actions jobs to the examples. This includes use of the remote Gradle cache so that we only run an optimal subset of the example jobs.\nTwo things irk me about this PR:\n\n\nExtensive duplication between ci.yml and ci-examples.yml. I considered trying to set up a matrix arrangement to avoid this, but I suspect it would become an even more complicated arrangement. We've probably already used up all our 'cleverness budget' with the existing dynamic job discovery. I think that on balance duplicating lots of the workflow file may be inelegant but is at least much clearer.\n\n\nI could not find a way to share the Gradle cache configuration between the ./settings.gradle and ./examples/settings.gradle. Extracting this to a custom script plugin failed: even a working setup would break when --scan was enabled, and I've not yet had the energy to investigate why.\n\n\nI think that, unless I've missed something very obvious, I'd like to proceed with the PR despite both of these annoyances. Happy to hear feedback to the contrary though :)", "createdAt": "2020-05-07T09:18:53Z", "url": "https://github.com/testcontainers/testcontainers-java/pull/2677", "merged": true, "mergeCommit": {"oid": "8c7c769cdfd3848457e0a70de8518f08ad7053b4"}, "closed": true, "closedAt": "2020-05-16T19:43:01Z", "author": {"login": "rnorth"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABce5sxTAH2gAyNDE0NTYyNDc2Ojc4MDNiMzBkMzNkY2FlMWVmMmQxN2VjMmFhMzU3NzRkNjFlODBjMzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABch8BP3gFqTQxMzEwMzIzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7803b30d33dcae1ef2d17ec2aa35774d61e80c31", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/7803b30d33dcae1ef2d17ec2aa35774d61e80c31", "committedDate": "2020-05-07T09:17:18Z", "message": "WIP: Dynamic CI jobs for examples"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3MzIxNjg2", "url": "https://github.com/testcontainers/testcontainers-java/pull/2677#pullrequestreview-407321686", "createdAt": "2020-05-07T09:55:20Z", "commit": {"oid": "7803b30d33dcae1ef2d17ec2aa35774d61e80c31"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwOTo1NToyMFrOGR3OtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwOTo1NToyMFrOGR3OtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM4Mzg2MA==", "bodyText": "we're not running \"Docker-in-Docker\", but mount the socket, hence \"in-container\" :) Maybe we can use \"wormhole\" or similar...", "url": "https://github.com/testcontainers/testcontainers-java/pull/2677#discussion_r421383860", "createdAt": "2020-05-07T09:55:20Z", "author": {"login": "bsideup"}, "path": ".github/workflows/ci-dind.yml", "diffHunk": "@@ -1,4 +1,4 @@\n-name: in-container\n+name: CI-DinD", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7803b30d33dcae1ef2d17ec2aa35774d61e80c31"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85f97ef9e6cfb885165927e385c67e16342593fb", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/85f97ef9e6cfb885165927e385c67e16342593fb", "committedDate": "2020-05-07T09:55:41Z", "message": "Undo de-duplication of cache configuration\n(as it does not work!)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92a9ff699d8cf14d134d835f6e0637934157aeb8", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/92a9ff699d8cf14d134d835f6e0637934157aeb8", "committedDate": "2020-05-07T09:56:59Z", "message": "Rename job"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7985c8b02a3cf6e3a2d20164289e55ec61f7245", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/b7985c8b02a3cf6e3a2d20164289e55ec61f7245", "committedDate": "2020-05-07T09:57:20Z", "message": "Merge remote-tracking branch 'origin/master' into examples-dynamic-ci-jobs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3MzIzNDQ5", "url": "https://github.com/testcontainers/testcontainers-java/pull/2677#pullrequestreview-407323449", "createdAt": "2020-05-07T09:57:48Z", "commit": {"oid": "b7985c8b02a3cf6e3a2d20164289e55ec61f7245"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwOTo1Nzo0OFrOGR3Ubg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QwOTo1Nzo0OFrOGR3Ubg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTM4NTMyNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      CIMATE_CI_KEY: \"CI / ${{ runner.os }} / ${{matrix.gradle_args}}\"\n          \n          \n            \n                      CIMATE_CI_KEY: \"Examples / ${{ runner.os }} / ${{matrix.gradle_args}}\"", "url": "https://github.com/testcontainers/testcontainers-java/pull/2677#discussion_r421385326", "createdAt": "2020-05-07T09:57:48Z", "author": {"login": "bsideup"}, "path": ".github/workflows/ci-examples.yml", "diffHunk": "@@ -0,0 +1,73 @@\n+name: CI-Examples\n+\n+on:\n+  pull_request: {}\n+  push: { branches: [ master ] }\n+\n+env:\n+  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}\n+  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}\n+\n+jobs:\n+  find_gradle_jobs:\n+    runs-on: ubuntu-18.04\n+    outputs:\n+      matrix: ${{ steps.set-matrix.outputs.matrix }}\n+    steps:\n+      - uses: actions/checkout@v2\n+      - uses: actions/setup-java@v1\n+        with:\n+          java-version: '1.8'\n+      - name: Cache Gradle Home files\n+        uses: actions/cache@v1\n+        with:\n+          path: ~/.gradle/caches\n+          key: ${{ runner.os }}-gradle-home-testmatrix-examples-${{ hashFiles('**/*.gradle') }}\n+          restore-keys: |\n+            ${{ runner.os }}-gradle-home-testmatrix-examples-\n+            ${{ runner.os }}-gradle-home-\n+      - id: set-matrix\n+        working-directory: ./examples/\n+        env:\n+          # Since we override the tests executor,\n+          # we should not push empty results to the cache\n+          READ_ONLY_REMOTE_GRADLE_CACHE: true\n+        run: |\n+          TASKS=$(./gradlew --no-daemon --parallel -q testMatrix)\n+          echo $TASKS\n+          echo \"::set-output name=matrix::{\\\"gradle_args\\\":$TASKS}\"\n+  check:\n+    needs: find_gradle_jobs\n+    strategy:\n+      fail-fast: false\n+      matrix: ${{ fromJson(needs.find_gradle_jobs.outputs.matrix) }}\n+    runs-on: ubuntu-18.04\n+    steps:\n+      - uses: actions/checkout@v2\n+      - uses: actions/setup-java@v1\n+        with:\n+          java-version: '1.8'\n+      - name: Cache Gradle Home files\n+        uses: actions/cache@v1\n+        with:\n+          path: ~/.gradle/caches\n+          key: ${{ runner.os }}-gradle-home-examples-${{matrix.gradle_args}}_check-${{ hashFiles('**/*.gradle') }}\n+          restore-keys: |\n+            ${{ runner.os }}-gradle-home-examples-${{matrix.gradle_args}}_check-\n+            ${{ runner.os }}-gradle-home-examples-${{matrix.gradle_args}}_check-\n+            ${{ runner.os }}-gradle-home-examples-\n+      - name: Clear existing docker image cache\n+        run: docker image prune -af\n+      - name: Build and test Examples with Gradle (${{matrix.gradle_args}})\n+        working-directory: ./examples/\n+        run: |\n+          ./gradlew --no-daemon --continue --scan --info ${{matrix.gradle_args}}\n+      - name: Aggregate Examples test reports with ciMate\n+        if: always()\n+        env:\n+          CIMATE_PROJECT_ID: 2348n4vl\n+          CIMATE_CI_KEY: \"CI / ${{ runner.os }} / ${{matrix.gradle_args}}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7985c8b02a3cf6e3a2d20164289e55ec61f7245"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cef6099bbd9f4e124c621fe0e9ca5d00216ef08", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/4cef6099bbd9f4e124c621fe0e9ca5d00216ef08", "committedDate": "2020-05-07T10:39:02Z", "message": "Update .github/workflows/ci-examples.yml\n\nCo-authored-by: Sergei Egorov <bsideup@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjQ0NjY0", "url": "https://github.com/testcontainers/testcontainers-java/pull/2677#pullrequestreview-411244664", "createdAt": "2020-05-13T19:44:35Z", "commit": {"oid": "4cef6099bbd9f4e124c621fe0e9ca5d00216ef08"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTo0NDozNVrOGVA6jA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTo0NDozNVrOGVA6jA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY4ODI2OA==", "bodyText": "Just to be sure - you just moved these lines without changing them, right? Or was it done by accident and we should probably revert it? :)", "url": "https://github.com/testcontainers/testcontainers-java/pull/2677#discussion_r424688268", "createdAt": "2020-05-13T19:44:35Z", "author": {"login": "bsideup"}, "path": "settings.gradle", "diffHunk": "@@ -13,6 +13,25 @@ buildscript {\n apply plugin: 'ch.myniva.s3-build-cache'\n apply plugin: 'com.gradle.enterprise'\n \n+rootProject.name = 'testcontainers-java'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4cef6099bbd9f4e124c621fe0e9ca5d00216ef08"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6c59ffce7157ee52460f179b51d4515e3c04abe", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/b6c59ffce7157ee52460f179b51d4515e3c04abe", "committedDate": "2020-05-14T14:43:50Z", "message": "Merge branch 'master' into examples-dynamic-ci-jobs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMTAzMjM0", "url": "https://github.com/testcontainers/testcontainers-java/pull/2677#pullrequestreview-413103234", "createdAt": "2020-05-16T19:41:15Z", "commit": {"oid": "b6c59ffce7157ee52460f179b51d4515e3c04abe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3373, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}