{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzNTA1MTg5", "number": 2662, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNDoyOTo0N1rOD6RreQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNDoyOTo0N1rOD6RreQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNDMzNjU3OnYy", "diffSide": "RIGHT", "path": "modules/couchbase/src/main/java/org/testcontainers/couchbase/CouchbaseContainer.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNDoyOTo0N1rOGSBXSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNzo0NzoxOFrOGbpfsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU0OTg5OQ==", "bodyText": "Just a thought: all these Response objects ought to be closed (here and elsewhere). Otherwise we'll potentially be holding connections open on the client and server side.\nThis is probably much more important inside a retryUntilTrue invocation, as the frequency of retries could be high.\nLombok's @Cleanup annotation would be a cheap and easy way to ensure that these response objects get cleaned up.", "url": "https://github.com/testcontainers/testcontainers-java/pull/2662#discussion_r421549899", "createdAt": "2020-05-07T14:29:47Z", "author": {"login": "rnorth"}, "path": "modules/couchbase/src/main/java/org/testcontainers/couchbase/CouchbaseContainer.java", "diffHunk": "@@ -353,6 +355,24 @@ private void createBuckets() {\n                 .forStatusCode(200)\n                 .waitUntilReady(this);\n \n+            if (enabledServices.contains(CouchbaseService.QUERY)) {\n+                // If the query service is enabled, make sure that we only proceed if the query engine also\n+                // knows about the bucket in its metadata configuration.\n+                Unreliables.retryUntilTrue(1, TimeUnit.MINUTES, () -> {\n+                    Response queryResponse = doHttpRequest(QUERY_PORT, \"/query/service\", \"POST\", new FormBody.Builder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b78068d7de91ff93a9312960d78efee8d498ac21"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5MDI3NQ==", "bodyText": "@daschl ping", "url": "https://github.com/testcontainers/testcontainers-java/pull/2662#discussion_r424690275", "createdAt": "2020-05-13T19:48:26Z", "author": {"login": "bsideup"}, "path": "modules/couchbase/src/main/java/org/testcontainers/couchbase/CouchbaseContainer.java", "diffHunk": "@@ -353,6 +355,24 @@ private void createBuckets() {\n                 .forStatusCode(200)\n                 .waitUntilReady(this);\n \n+            if (enabledServices.contains(CouchbaseService.QUERY)) {\n+                // If the query service is enabled, make sure that we only proceed if the query engine also\n+                // knows about the bucket in its metadata configuration.\n+                Unreliables.retryUntilTrue(1, TimeUnit.MINUTES, () -> {\n+                    Response queryResponse = doHttpRequest(QUERY_PORT, \"/query/service\", \"POST\", new FormBody.Builder()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU0OTg5OQ=="}, "originalCommit": {"oid": "b78068d7de91ff93a9312960d78efee8d498ac21"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY0NDU5Mg==", "bodyText": "sorry that I've been slow on this. Working on it now, will update the PR", "url": "https://github.com/testcontainers/testcontainers-java/pull/2662#discussion_r431644592", "createdAt": "2020-05-28T07:47:18Z", "author": {"login": "daschl"}, "path": "modules/couchbase/src/main/java/org/testcontainers/couchbase/CouchbaseContainer.java", "diffHunk": "@@ -353,6 +355,24 @@ private void createBuckets() {\n                 .forStatusCode(200)\n                 .waitUntilReady(this);\n \n+            if (enabledServices.contains(CouchbaseService.QUERY)) {\n+                // If the query service is enabled, make sure that we only proceed if the query engine also\n+                // knows about the bucket in its metadata configuration.\n+                Unreliables.retryUntilTrue(1, TimeUnit.MINUTES, () -> {\n+                    Response queryResponse = doHttpRequest(QUERY_PORT, \"/query/service\", \"POST\", new FormBody.Builder()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU0OTg5OQ=="}, "originalCommit": {"oid": "b78068d7de91ff93a9312960d78efee8d498ac21"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1517, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}