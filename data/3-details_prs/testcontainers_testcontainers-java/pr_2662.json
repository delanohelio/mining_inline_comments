{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzNTA1MTg5", "number": 2662, "title": "couchbase: wait until query engine knows about bucket before creating\u2026", "bodyText": "\u2026 primary index\nThe motivation for this change is that in slow environments, it could be that the\nquery engine is not aware of the just created bucket yet and so the create primary\nindex will take longer than the 10s read timeout for the subsequent http request.\nAs a result, this is just another precaution to minimize the chances that in\nslow environments the create primary index call times out with a read timeout.", "createdAt": "2020-05-05T13:09:16Z", "url": "https://github.com/testcontainers/testcontainers-java/pull/2662", "merged": true, "mergeCommit": {"oid": "835ac71d8ddcf206146af08b2e4efc56532d878f"}, "closed": true, "closedAt": "2020-05-29T12:56:08Z", "author": {"login": "daschl"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABce-Lb-gFqTQwNzUzMDA0Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcl_llUgFqTQyMDgyMDkwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NTMwMDQy", "url": "https://github.com/testcontainers/testcontainers-java/pull/2662#pullrequestreview-407530042", "createdAt": "2020-05-07T14:29:47Z", "commit": {"oid": "b78068d7de91ff93a9312960d78efee8d498ac21"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNDoyOTo0N1rOGSBXSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNDoyOTo0N1rOGSBXSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTU0OTg5OQ==", "bodyText": "Just a thought: all these Response objects ought to be closed (here and elsewhere). Otherwise we'll potentially be holding connections open on the client and server side.\nThis is probably much more important inside a retryUntilTrue invocation, as the frequency of retries could be high.\nLombok's @Cleanup annotation would be a cheap and easy way to ensure that these response objects get cleaned up.", "url": "https://github.com/testcontainers/testcontainers-java/pull/2662#discussion_r421549899", "createdAt": "2020-05-07T14:29:47Z", "author": {"login": "rnorth"}, "path": "modules/couchbase/src/main/java/org/testcontainers/couchbase/CouchbaseContainer.java", "diffHunk": "@@ -353,6 +355,24 @@ private void createBuckets() {\n                 .forStatusCode(200)\n                 .waitUntilReady(this);\n \n+            if (enabledServices.contains(CouchbaseService.QUERY)) {\n+                // If the query service is enabled, make sure that we only proceed if the query engine also\n+                // knows about the bucket in its metadata configuration.\n+                Unreliables.retryUntilTrue(1, TimeUnit.MINUTES, () -> {\n+                    Response queryResponse = doHttpRequest(QUERY_PORT, \"/query/service\", \"POST\", new FormBody.Builder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b78068d7de91ff93a9312960d78efee8d498ac21"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd1543e6d5c7c000dfda16efeff8b3c750b9eb16", "author": {"user": {"login": "daschl", "name": "Michael Nitschinger"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/cd1543e6d5c7c000dfda16efeff8b3c750b9eb16", "committedDate": "2020-05-28T07:52:47Z", "message": "couchbase: wait until query engine knows about bucket before creating primary index\n\nThe motivation for this change is that in slow environments, it could be that the\nquery engine is not aware of the just created bucket yet and so the create primary\nindex will take longer than the 10s read timeout for the subsequent http request.\n\nAs a result, this is just another precaution to minimize the chances that in\nslow environments the create primary index call times out with a read timeout."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b78068d7de91ff93a9312960d78efee8d498ac21", "author": {"user": {"login": "daschl", "name": "Michael Nitschinger"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/b78068d7de91ff93a9312960d78efee8d498ac21", "committedDate": "2020-05-05T13:07:04Z", "message": "couchbase: wait until query engine knows about bucket before creating primary index\n\nThe motivation for this change is that in slow environments, it could be that the\nquery engine is not aware of the just created bucket yet and so the create primary\nindex will take longer than the 10s read timeout for the subsequent http request.\n\nAs a result, this is just another precaution to minimize the chances that in\nslow environments the create primary index call times out with a read timeout."}, "afterCommit": {"oid": "cd1543e6d5c7c000dfda16efeff8b3c750b9eb16", "author": {"user": {"login": "daschl", "name": "Michael Nitschinger"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/cd1543e6d5c7c000dfda16efeff8b3c750b9eb16", "committedDate": "2020-05-28T07:52:47Z", "message": "couchbase: wait until query engine knows about bucket before creating primary index\n\nThe motivation for this change is that in slow environments, it could be that the\nquery engine is not aware of the just created bucket yet and so the create primary\nindex will take longer than the 10s read timeout for the subsequent http request.\n\nAs a result, this is just another precaution to minimize the chances that in\nslow environments the create primary index call times out with a read timeout."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMjA5NDMy", "url": "https://github.com/testcontainers/testcontainers-java/pull/2662#pullrequestreview-420209432", "createdAt": "2020-05-28T15:07:31Z", "commit": {"oid": "cd1543e6d5c7c000dfda16efeff8b3c750b9eb16"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwODIwOTA1", "url": "https://github.com/testcontainers/testcontainers-java/pull/2662#pullrequestreview-420820905", "createdAt": "2020-05-29T10:06:21Z", "commit": {"oid": "cd1543e6d5c7c000dfda16efeff8b3c750b9eb16"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3372, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}