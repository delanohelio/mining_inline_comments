{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyMjMzNzI5", "number": 3413, "title": "Default prefixing image substitutor", "bodyText": "Builds on #3411, #3021\nSplit out from #3021\nFor many orgs, sticking a prefix on the front of image names might be enough to use a private registry. I've added a default behaviour whereby, if a particular environment variable is present, image names are automatically substituted.", "createdAt": "2020-10-29T12:17:55Z", "url": "https://github.com/testcontainers/testcontainers-java/pull/3413", "merged": true, "mergeCommit": {"oid": "0e263f296556c2357f0d4ea99d120a3a2880ceb3"}, "closed": true, "closedAt": "2020-12-10T10:53:34Z", "author": {"login": "rnorth"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXQqdUgH2gAyNTEyMjMzNzI5OjBmNTFkZmE2MjA2MTYyYmFhNjEwNDYzY2U1ZDU2MzU4YjU4MTJkNjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkxHByAFqTU0OTA3NDM1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0f51dfa6206162baa610463ce5d56358b5812d60", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/0f51dfa6206162baa610463ce5d56358b5812d60", "committedDate": "2020-10-29T11:42:21Z", "message": "Refactor Testcontainers configuration to allow config by env var"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "950af34178f3a28a3747b0b446738e83c7b62bbf", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/950af34178f3a28a3747b0b446738e83c7b62bbf", "committedDate": "2020-10-29T12:14:54Z", "message": "Add Image substitution mechanism\n\nBuilds upon #3021 and #3411:\n\n* adds a pluggable image substitution mechanism using ServiceLoader, enabling users to perform custom substitution/auditing of images being used by their tests\n\n* provides a default implementation that behaves similarly to legacy `TestcontainersConfiguration` approach (`testcontainers.properties`)\n\nNotes:\n\n* behaviour is similar but not quite identical to `TestcontainersConfiguration`: use of a configured custom image for, e.g. Kafka/Pulsar that does not have a tag specified causes the substitution to take effect for all usages. It seems very unlikely that people would be using a mix of the config file image overrides in some places _and_ specific images specified in code in others.\n\n* Duplication of default image names in modules vs `TestcontainersConfiguration` class is intentional: specifying image overrides in `testcontainers.properties` should be removed in the future.\n\n* ~Add log deprecation warnings when `testcontainers.properties` image overrides are used.~ Defer to a future release?"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58179b38c687a945cbbe6263dcf1a67fc44a8dba", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/58179b38c687a945cbbe6263dcf1a67fc44a8dba", "committedDate": "2020-10-29T12:16:57Z", "message": "Add Image substitution mechanism\n\nBuilds upon #3021 and #3411:\n\n* adds a pluggable image substitution mechanism using ServiceLoader, enabling users to perform custom substitution/auditing of images being used by their tests\n\n* provides a default implementation that behaves similarly to legacy `TestcontainersConfiguration` approach (`testcontainers.properties`)\n\nNotes:\n\n* behaviour is similar but not quite identical to `TestcontainersConfiguration`: use of a configured custom image for, e.g. Kafka/Pulsar that does not have a tag specified causes the substitution to take effect for all usages. It seems very unlikely that people would be using a mix of the config file image overrides in some places _and_ specific images specified in code in others.\n\n* Duplication of default image names in modules vs `TestcontainersConfiguration` class is intentional: specifying image overrides in `testcontainers.properties` should be removed in the future.\n\n* ~Add log deprecation warnings when `testcontainers.properties` image overrides are used.~ Defer to a future release?"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "658c98a4e72ed1af6567f02d467755ea9939a013", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/658c98a4e72ed1af6567f02d467755ea9939a013", "committedDate": "2020-10-29T12:16:57Z", "message": "Improve default image name substitution\n\nFor many orgs, sticking a prefix on the front of image names might be enough to use a private registry. I've added a default behaviour whereby, if a particular environment variable is present, image names are automatically substituted. e.g. `TESTCONTAINERS_IMAGE_NAME_PREFIX=my.registry.com/` would transform `redis` to `my.registry.com/redis` etc."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83258722f999d7bc4fb27db968c8c1adeb39b8e4", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/83258722f999d7bc4fb27db968c8c1adeb39b8e4", "committedDate": "2020-11-07T14:38:40Z", "message": "Merge remote-tracking branch 'origin/master' into default-prefixing-image-substitutor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bf309712a9110cfc3ee778c2a7ffacbd7a726a7", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/9bf309712a9110cfc3ee778c2a7ffacbd7a726a7", "committedDate": "2020-11-08T10:53:33Z", "message": "Rework - WIP\nDocs update required"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2176ef8e2aa8c0a62a32d505b3f55dfc1d24112a", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/2176ef8e2aa8c0a62a32d505b3f55dfc1d24112a", "committedDate": "2020-11-08T11:35:55Z", "message": "Provisional changes - single config setting, applied to Hub image names only"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8565f7f325b1b8be114771804cd4d59c6038abd2", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/8565f7f325b1b8be114771804cd4d59c6038abd2", "committedDate": "2020-11-08T11:38:03Z", "message": "Tidy up merge issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45ac5f4b4dfb6fe8aa99483d1e0352bbeb3d7f95", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/45ac5f4b4dfb6fe8aa99483d1e0352bbeb3d7f95", "committedDate": "2020-11-08T11:38:23Z", "message": "Tidy up merge issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1Nzk5Mzc2", "url": "https://github.com/testcontainers/testcontainers-java/pull/3413#pullrequestreview-525799376", "createdAt": "2020-11-08T11:39:09Z", "commit": {"oid": "2176ef8e2aa8c0a62a32d505b3f55dfc1d24112a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQxMTozOTowOVrOHvTfiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQxMTozOTowOVrOHvTfiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTM2NDQ4OQ==", "bodyText": "Testcontainers will not apply the prefix to non-Hub image names.\n\nJudgement call required on this specific point!", "url": "https://github.com/testcontainers/testcontainers-java/pull/3413#discussion_r519364489", "createdAt": "2020-11-08T11:39:09Z", "author": {"login": "rnorth"}, "path": "docs/features/image_name_substitution.md", "diffHunk": "@@ -45,7 +45,34 @@ to:\n \n \n \n+## Automatically modifying Docker Hub image names\n \n+Testcontainers can be configured to modify Docker Hub image names on the fly to apply a prefix string.\n+\n+Consider this if:\n+\n+* Developers and CI machines need to use different image names. For example, developers are able to pull images from Docker Hub, but CI machines need to pull from a private registry\n+* Your private registry has copies of images from Docker Hub where the names are predictable, and just adding a prefix is enough. \n+  For example, `registry.mycompany.com/mirror/mysql:8.0.22` can be derived from the original Docker Hub image name (`mysql:8.0.22`) with a consistent prefix string: `registry.mycompany.com/mirror/`\n+\n+In this case, image name references in code are **unchanged**.\n+i.e. you would leave as-is:\n+\n+<!--codeinclude--> \n+[Unchanged direct Docker Hub image name](../examples/junit4/generic/src/test/java/generic/ImageNameSubstitutionTest.java) inside_block:directDockerHubReference\n+<!--/codeinclude-->\n+\n+You can then configure Testcontainers to apply the prefix `registry.mycompany.com/mirror/` to every image that it tries to pull from Docker Hub.\n+This can be done in one of two ways:\n+\n+* Setting environment variables `TESTCONTAINERS_HUB_IMAGE_NAME_PREFIX=registry.mycompany.com/mirror/`\n+* Via config file, setting `hub.image.name.prefix` in either:\n+    * the `~/.testcontainers.properties` file in your user home directory, or\n+    * a file named `testcontainers.properties` on the classpath\n+    \n+Testcontainers will automatically apply the prefix to every image that it pulls from Docker Hub - please verify that all [the required images](./pull_rate_limiting.md#which-images-are-used-by-testcontainers) exist in your registry.\n+\n+Testcontainers will not apply the prefix to non-Hub image names.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2176ef8e2aa8c0a62a32d505b3f55dfc1d24112a"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73d22916d9bbb20dbf9eff8f163772ae3787158a", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/73d22916d9bbb20dbf9eff8f163772ae3787158a", "committedDate": "2020-11-08T11:41:51Z", "message": "Tidy up merge issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b63f2a812ccaf79ee8ff04929576f83ac8e8cd41", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/b63f2a812ccaf79ee8ff04929576f83ac8e8cd41", "committedDate": "2020-11-21T10:11:19Z", "message": "Merge branch 'master' into default-prefixing-image-substitutor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1OTU3OTIx", "url": "https://github.com/testcontainers/testcontainers-java/pull/3413#pullrequestreview-535957921", "createdAt": "2020-11-21T10:52:50Z", "commit": {"oid": "b63f2a812ccaf79ee8ff04929576f83ac8e8cd41"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQxMDo1Mjo1MFrOH3tpdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQxMDo1Mjo1MFrOH3tpdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODE4MTYyMg==", "bodyText": "leftover?", "url": "https://github.com/testcontainers/testcontainers-java/pull/3413#discussion_r528181622", "createdAt": "2020-11-21T10:52:50Z", "author": {"login": "bsideup"}, "path": "docs/features/configuration.md", "diffHunk": "@@ -72,6 +72,8 @@ Some companies disallow the usage of Docker Hub, but you can override `*.image`\n > **pulsar.container.image = apachepulsar/pulsar:2.2.0**  \n > Used by Apache Pulsar\n \n+See [Image Name Substitution](./image_name_substitution.md) for other strategies for substituting image names to pull from other registries.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b63f2a812ccaf79ee8ff04929576f83ac8e8cd41"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7c0a0933d74e548df5f02f487a43a44cb1395ca", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/c7c0a0933d74e548df5f02f487a43a44cb1395ca", "committedDate": "2020-11-21T16:06:30Z", "message": "Remove excess para"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b845b8a482411d18d6e6880eb308109494d38b08", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/b845b8a482411d18d6e6880eb308109494d38b08", "committedDate": "2020-11-21T16:07:03Z", "message": "Merge remote-tracking branch 'origin/default-prefixing-image-substitutor' into default-prefixing-image-substitutor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7aced507f7fd3eca2d977b28f8af0d1eacbacae", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/a7aced507f7fd3eca2d977b28f8af0d1eacbacae", "committedDate": "2020-11-26T09:24:32Z", "message": "Merge branch 'master' into default-prefixing-image-substitutor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTQ0NDY1", "url": "https://github.com/testcontainers/testcontainers-java/pull/3413#pullrequestreview-541144465", "createdAt": "2020-11-30T17:41:58Z", "commit": {"oid": "a7aced507f7fd3eca2d977b28f8af0d1eacbacae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzo0MTo1OVrOH8GVaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzo0MTo1OVrOH8GVaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc4MDM5NQ==", "bodyText": "since it is package private, we can remove this annotation \ud83d\udc4d", "url": "https://github.com/testcontainers/testcontainers-java/pull/3413#discussion_r532780395", "createdAt": "2020-11-30T17:41:59Z", "author": {"login": "bsideup"}, "path": "core/src/main/java/org/testcontainers/utility/PrefixingImageNameSubstitutor.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package org.testcontainers.utility;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import lombok.NoArgsConstructor;\n+import lombok.extern.slf4j.Slf4j;\n+import org.testcontainers.UnstableAPI;\n+\n+/**\n+ * An {@link ImageNameSubstitutor} which applies a prefix to all image names, e.g. a private registry host and path.\n+ * The prefix may be set via an environment variable (<code>TESTCONTAINERS_HUB_IMAGE_NAME_PREFIX</code>) or an equivalent\n+ * configuration file entry (see {@link TestcontainersConfiguration}).\n+ */\n+@UnstableAPI", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7aced507f7fd3eca2d977b28f8af0d1eacbacae"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTQ3MzQw", "url": "https://github.com/testcontainers/testcontainers-java/pull/3413#pullrequestreview-541147340", "createdAt": "2020-11-30T17:45:35Z", "commit": {"oid": "a7aced507f7fd3eca2d977b28f8af0d1eacbacae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzo0NTozNVrOH8Gewg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzo0NTozNVrOH8Gewg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc4Mjc4Ng==", "bodyText": "double negotiation? \ud83d\ude31\ud83d\ude00\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (!!configuredPrefix.isEmpty()) {\n          \n          \n            \n                    if (configuredPrefix.isEmpty()) {", "url": "https://github.com/testcontainers/testcontainers-java/pull/3413#discussion_r532782786", "createdAt": "2020-11-30T17:45:35Z", "author": {"login": "bsideup"}, "path": "core/src/main/java/org/testcontainers/utility/PrefixingImageNameSubstitutor.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package org.testcontainers.utility;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import lombok.NoArgsConstructor;\n+import lombok.extern.slf4j.Slf4j;\n+import org.testcontainers.UnstableAPI;\n+\n+/**\n+ * An {@link ImageNameSubstitutor} which applies a prefix to all image names, e.g. a private registry host and path.\n+ * The prefix may be set via an environment variable (<code>TESTCONTAINERS_HUB_IMAGE_NAME_PREFIX</code>) or an equivalent\n+ * configuration file entry (see {@link TestcontainersConfiguration}).\n+ */\n+@UnstableAPI\n+@NoArgsConstructor\n+@Slf4j\n+final class PrefixingImageNameSubstitutor extends ImageNameSubstitutor {\n+\n+    @VisibleForTesting\n+    static final String PREFIX_PROPERTY_KEY = \"hub.image.name.prefix\";\n+\n+    private TestcontainersConfiguration configuration = TestcontainersConfiguration.getInstance();\n+\n+    @VisibleForTesting\n+    PrefixingImageNameSubstitutor(final TestcontainersConfiguration configuration) {\n+        this.configuration = configuration;\n+    }\n+\n+    @Override\n+    public DockerImageName apply(DockerImageName original) {\n+        final String configuredPrefix = configuration.getEnvVarOrProperty(PREFIX_PROPERTY_KEY, \"\");\n+\n+        if (!!configuredPrefix.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7aced507f7fd3eca2d977b28f8af0d1eacbacae"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTQ4NjI4", "url": "https://github.com/testcontainers/testcontainers-java/pull/3413#pullrequestreview-541148628", "createdAt": "2020-11-30T17:47:10Z", "commit": {"oid": "a7aced507f7fd3eca2d977b28f8af0d1eacbacae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzo0NzoxMFrOH8Gi1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzo0NzoxMFrOH8Gi1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc4MzgzMA==", "bodyText": "Thought:\nMaybe we should only apply it on empty registry, while an explicit docker.io or registry.hub.docker.com would serve as \"I know what I am doing\". WDYT?", "url": "https://github.com/testcontainers/testcontainers-java/pull/3413#discussion_r532783830", "createdAt": "2020-11-30T17:47:10Z", "author": {"login": "bsideup"}, "path": "core/src/main/java/org/testcontainers/utility/PrefixingImageNameSubstitutor.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package org.testcontainers.utility;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import lombok.NoArgsConstructor;\n+import lombok.extern.slf4j.Slf4j;\n+import org.testcontainers.UnstableAPI;\n+\n+/**\n+ * An {@link ImageNameSubstitutor} which applies a prefix to all image names, e.g. a private registry host and path.\n+ * The prefix may be set via an environment variable (<code>TESTCONTAINERS_HUB_IMAGE_NAME_PREFIX</code>) or an equivalent\n+ * configuration file entry (see {@link TestcontainersConfiguration}).\n+ */\n+@UnstableAPI\n+@NoArgsConstructor\n+@Slf4j\n+final class PrefixingImageNameSubstitutor extends ImageNameSubstitutor {\n+\n+    @VisibleForTesting\n+    static final String PREFIX_PROPERTY_KEY = \"hub.image.name.prefix\";\n+\n+    private TestcontainersConfiguration configuration = TestcontainersConfiguration.getInstance();\n+\n+    @VisibleForTesting\n+    PrefixingImageNameSubstitutor(final TestcontainersConfiguration configuration) {\n+        this.configuration = configuration;\n+    }\n+\n+    @Override\n+    public DockerImageName apply(DockerImageName original) {\n+        final String configuredPrefix = configuration.getEnvVarOrProperty(PREFIX_PROPERTY_KEY, \"\");\n+\n+        if (!!configuredPrefix.isEmpty()) {\n+            log.debug(\"No prefix is configured\");\n+            return original;\n+        }\n+\n+        boolean isAHubImage = original.getRegistry().isEmpty() ||", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7aced507f7fd3eca2d977b28f8af0d1eacbacae"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTUwMDc1", "url": "https://github.com/testcontainers/testcontainers-java/pull/3413#pullrequestreview-541150075", "createdAt": "2020-11-30T17:48:59Z", "commit": {"oid": "a7aced507f7fd3eca2d977b28f8af0d1eacbacae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzo0ODo1OVrOH8Gnbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNzo0ODo1OVrOH8Gnbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc4NTAwNw==", "bodyText": "does it parse my.registry.com/ (note trailing slash) correctly?", "url": "https://github.com/testcontainers/testcontainers-java/pull/3413#discussion_r532785007", "createdAt": "2020-11-30T17:48:59Z", "author": {"login": "bsideup"}, "path": "core/src/main/java/org/testcontainers/utility/PrefixingImageNameSubstitutor.java", "diffHunk": "@@ -0,0 +1,62 @@\n+package org.testcontainers.utility;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import lombok.NoArgsConstructor;\n+import lombok.extern.slf4j.Slf4j;\n+import org.testcontainers.UnstableAPI;\n+\n+/**\n+ * An {@link ImageNameSubstitutor} which applies a prefix to all image names, e.g. a private registry host and path.\n+ * The prefix may be set via an environment variable (<code>TESTCONTAINERS_HUB_IMAGE_NAME_PREFIX</code>) or an equivalent\n+ * configuration file entry (see {@link TestcontainersConfiguration}).\n+ */\n+@UnstableAPI\n+@NoArgsConstructor\n+@Slf4j\n+final class PrefixingImageNameSubstitutor extends ImageNameSubstitutor {\n+\n+    @VisibleForTesting\n+    static final String PREFIX_PROPERTY_KEY = \"hub.image.name.prefix\";\n+\n+    private TestcontainersConfiguration configuration = TestcontainersConfiguration.getInstance();\n+\n+    @VisibleForTesting\n+    PrefixingImageNameSubstitutor(final TestcontainersConfiguration configuration) {\n+        this.configuration = configuration;\n+    }\n+\n+    @Override\n+    public DockerImageName apply(DockerImageName original) {\n+        final String configuredPrefix = configuration.getEnvVarOrProperty(PREFIX_PROPERTY_KEY, \"\");\n+\n+        if (!!configuredPrefix.isEmpty()) {\n+            log.debug(\"No prefix is configured\");\n+            return original;\n+        }\n+\n+        boolean isAHubImage = original.getRegistry().isEmpty() ||\n+            original.getRegistry().equals(\"docker.io\") ||\n+            original.getRegistry().equals(\"registry.hub.docker.com\");\n+        if (!isAHubImage) {\n+            log.debug(\"Image {} is not a Docker Hub image - not applying registry/repository change\", original);\n+            return original;\n+        }\n+\n+        log.debug(\n+            \"Applying changes to image name {}: applying prefix '{}'\",\n+            original,\n+            configuredPrefix\n+        );\n+\n+        DockerImageName prefixAsImage = DockerImageName.parse(configuredPrefix);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7aced507f7fd3eca2d977b28f8af0d1eacbacae"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMjY4OTg3", "url": "https://github.com/testcontainers/testcontainers-java/pull/3413#pullrequestreview-541268987", "createdAt": "2020-11-30T20:28:43Z", "commit": {"oid": "a7aced507f7fd3eca2d977b28f8af0d1eacbacae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMDoyODo0M1rOH8MnsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMDoyODo0M1rOH8MnsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4MzM3Nw==", "bodyText": "I am curious how Docker handles a case where registry's host is \"some\".\nOr, to make it look more \"real\": localhost/image:tag", "url": "https://github.com/testcontainers/testcontainers-java/pull/3413#discussion_r532883377", "createdAt": "2020-11-30T20:28:43Z", "author": {"login": "bsideup"}, "path": "core/src/test/java/org/testcontainers/utility/PrefixingImageNameSubstitutorTest.java", "diffHunk": "@@ -0,0 +1,101 @@\n+package org.testcontainers.utility;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+import static org.rnorth.visibleassertions.VisibleAssertions.assertEquals;\n+import static org.testcontainers.utility.PrefixingImageNameSubstitutor.PREFIX_PROPERTY_KEY;\n+\n+public class PrefixingImageNameSubstitutorTest {\n+\n+    private TestcontainersConfiguration mockConfiguration;\n+    private PrefixingImageNameSubstitutor underTest;\n+\n+    @Before\n+    public void setUp() {\n+        mockConfiguration = mock(TestcontainersConfiguration.class);\n+        underTest = new PrefixingImageNameSubstitutor(mockConfiguration);\n+    }\n+\n+    @Test\n+    public void testHappyPath() {\n+        when(mockConfiguration.getEnvVarOrProperty(eq(PREFIX_PROPERTY_KEY), any())).thenReturn(\"someregistry.com/our-mirror/\");\n+\n+        final DockerImageName result = underTest.apply(DockerImageName.parse(\"some/image:tag\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7aced507f7fd3eca2d977b28f8af0d1eacbacae"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d706f305e37e459ffaf16048ab7b9ce3e6a378a", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/0d706f305e37e459ffaf16048ab7b9ce3e6a378a", "committedDate": "2020-12-01T07:31:05Z", "message": "Update core/src/main/java/org/testcontainers/utility/PrefixingImageNameSubstitutor.java\n\nCo-authored-by: Sergei Egorov <bsideup@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6370a63392bb1dddc64b33c587fd515c195fc3fc", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/6370a63392bb1dddc64b33c587fd515c195fc3fc", "committedDate": "2020-12-01T20:25:56Z", "message": "Simplify Hub image detection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "714f482663db66208c156c0912eed3cdfa69214e", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/714f482663db66208c156c0912eed3cdfa69214e", "committedDate": "2020-12-01T20:40:47Z", "message": "Update test to reflect changed hub identification logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abdcd930383421bab2a400d42625c04cf1a35499", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/abdcd930383421bab2a400d42625c04cf1a35499", "committedDate": "2020-12-01T20:58:56Z", "message": "Add tests that the prefix is applied literally (both for slash-present and -absent cases, the prefix is applied as-is)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd63ec6081cf60ee811ad5653de1b85cd5e67285", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/cd63ec6081cf60ee811ad5653de1b85cd5e67285", "committedDate": "2020-12-01T21:18:58Z", "message": "Remove duplicate getter (Lombok @Getter exists)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3Mjk5OTcw", "url": "https://github.com/testcontainers/testcontainers-java/pull/3413#pullrequestreview-547299970", "createdAt": "2020-12-08T14:43:08Z", "commit": {"oid": "cd63ec6081cf60ee811ad5653de1b85cd5e67285"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNDo0MzowOFrOIBgTbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxNDo0MzowOFrOIBgTbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODQ0ODc1MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Testcontainers will not apply the prefix to:\n          \n          \n            \n            Testcontainers will not apply the prefix to:\n          \n          \n            \n            \n          \n      \n    \n    \n  \n\nOtherwise it renders incorrectly:", "url": "https://github.com/testcontainers/testcontainers-java/pull/3413#discussion_r538448751", "createdAt": "2020-12-08T14:43:08Z", "author": {"login": "bsideup"}, "path": "docs/features/image_name_substitution.md", "diffHunk": "@@ -45,7 +45,36 @@ to:\n \n \n \n+## Automatically modifying Docker Hub image names\n \n+Testcontainers can be configured to modify Docker Hub image names on the fly to apply a prefix string.\n+\n+Consider this if:\n+\n+* Developers and CI machines need to use different image names. For example, developers are able to pull images from Docker Hub, but CI machines need to pull from a private registry\n+* Your private registry has copies of images from Docker Hub where the names are predictable, and just adding a prefix is enough. \n+  For example, `registry.mycompany.com/mirror/mysql:8.0.22` can be derived from the original Docker Hub image name (`mysql:8.0.22`) with a consistent prefix string: `registry.mycompany.com/mirror/`\n+\n+In this case, image name references in code are **unchanged**.\n+i.e. you would leave as-is:\n+\n+<!--codeinclude--> \n+[Unchanged direct Docker Hub image name](../examples/junit4/generic/src/test/java/generic/ImageNameSubstitutionTest.java) inside_block:directDockerHubReference\n+<!--/codeinclude-->\n+\n+You can then configure Testcontainers to apply the prefix `registry.mycompany.com/mirror/` to every image that it tries to pull from Docker Hub.\n+This can be done in one of two ways:\n+\n+* Setting environment variables `TESTCONTAINERS_HUB_IMAGE_NAME_PREFIX=registry.mycompany.com/mirror/`\n+* Via config file, setting `hub.image.name.prefix` in either:\n+    * the `~/.testcontainers.properties` file in your user home directory, or\n+    * a file named `testcontainers.properties` on the classpath\n+    \n+Testcontainers will automatically apply the prefix to every image that it pulls from Docker Hub - please verify that all [the required images](../supported_docker_environment/image_registry_rate_limiting.md#which-images-are-used-by-testcontainers) exist in your registry.\n+\n+Testcontainers will not apply the prefix to:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd63ec6081cf60ee811ad5653de1b85cd5e67285"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9984aa2eeca2b25228395b4b1d2d06530841b604", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/9984aa2eeca2b25228395b4b1d2d06530841b604", "committedDate": "2020-12-09T22:46:10Z", "message": "Update docs/features/image_name_substitution.md\n\nCo-authored-by: Sergei Egorov <bsideup@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5MDc0MzUz", "url": "https://github.com/testcontainers/testcontainers-java/pull/3413#pullrequestreview-549074353", "createdAt": "2020-12-10T10:51:32Z", "commit": {"oid": "9984aa2eeca2b25228395b4b1d2d06530841b604"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3325, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}