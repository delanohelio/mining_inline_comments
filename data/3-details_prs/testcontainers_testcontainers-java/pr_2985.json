{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2OTgwNDg2", "number": 2985, "title": "Add a rootless Docker strategy", "bodyText": "Closes #2943, #1770", "createdAt": "2020-07-09T16:54:38Z", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985", "merged": true, "mergeCommit": {"oid": "50c778fa39c8adab5b0ee078ee47b074482112ac"}, "closed": true, "closedAt": "2020-07-15T12:14:08Z", "author": {"login": "bsideup"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczR_iEAH2gAyNDQ2OTgwNDg2OjAwYjY0Mzc4MjI2NzhjOTI4ZmQyOTUyMzk1YzExNjI2ODc3ODdlMjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1JOvhgFqTQ0ODg3NzA0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "00b6437822678c928fd2952395c1162687787e20", "author": {"user": {"login": "bsideup", "name": "Sergei Egorov"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/00b6437822678c928fd2952395c1162687787e20", "committedDate": "2020-07-09T16:54:00Z", "message": "Add a rootless Docker strategy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1ODM5NzAx", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#pullrequestreview-445839701", "createdAt": "2020-07-09T17:50:05Z", "commit": {"oid": "00b6437822678c928fd2952395c1162687787e20"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNzo1MDowNVrOGvbqMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNzo1MDowNVrOGvbqMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM4OTQyNw==", "bodyText": "Slightly pedantic point, but I'm assuming we'll have to make the 1000 reflect the current user's uid. I guess this may become more necessary once testing rootless with cloud CI.", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#discussion_r452389427", "createdAt": "2020-07-09T17:50:05Z", "author": {"login": "rnorth"}, "path": "core/src/main/java/org/testcontainers/dockerclient/RootlessDockerClientProviderStrategy.java", "diffHunk": "@@ -0,0 +1,61 @@\n+package org.testcontainers.dockerclient;\n+\n+import org.apache.commons.lang.SystemUtils;\n+\n+import java.io.IOException;\n+import java.net.URI;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+/**\n+ *\n+ * @deprecated this class is used by the SPI and should not be used directly\n+ */\n+@Deprecated\n+public final class RootlessDockerClientProviderStrategy extends DockerClientProviderStrategy {\n+    protected static final String DOCKER_SOCK_PATH = \"/run/user/1000/docker.sock\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00b6437822678c928fd2952395c1162687787e20"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1ODQwODc1", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#pullrequestreview-445840875", "createdAt": "2020-07-09T17:51:48Z", "commit": {"oid": "00b6437822678c928fd2952395c1162687787e20"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNzo1MTo0OFrOGvbt0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNzo1MTo0OFrOGvbt0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM5MDM1Mw==", "bodyText": "I'd be inclined to add a new method to the TransportConfig object to perform this logic.\nI'll start that change in #1771, as it's going to be necessary there, but FYI.", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#discussion_r452390353", "createdAt": "2020-07-09T17:51:48Z", "author": {"login": "rnorth"}, "path": "core/src/main/java/org/testcontainers/utility/ResourceReaper.java", "diffHunk": "@@ -70,13 +74,34 @@ private ResourceReaper() {\n         dockerClient = DockerClientFactory.instance().client();\n     }\n \n-    @SneakyThrows(InterruptedException.class)\n+    /**\n+     *\n+     * @deprecated not for public usage\n+     */\n+    @Deprecated\n     public static String start(String hostIpAddress, DockerClient client) {\n+        return start(hostIpAddress, client, null);\n+    }\n+\n+    /**\n+     *\n+     * @deprecated not for public usage\n+     */\n+    @Deprecated\n+    @SneakyThrows(InterruptedException.class)\n+    public static String start(String hostIpAddress, DockerClient client, @Nullable TransportConfig transportConfig) {\n         String ryukImage = TestcontainersConfiguration.getInstance().getRyukImage();\n         DockerClientFactory.instance().checkAndPullImage(client, ryukImage);\n \n+        String socketPath = \"//var/run/docker.sock\";\n+        if (transportConfig != null) {\n+            URI dockerHost = transportConfig.getDockerHost();\n+            if (\"unix\".equals(dockerHost.getScheme())) {\n+                socketPath = dockerHost.getRawPath();\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00b6437822678c928fd2952395c1162687787e20"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62cdd1a5bc21ef72c372bc6d4bd37b97e823b729", "author": {"user": {"login": "bsideup", "name": "Sergei Egorov"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/62cdd1a5bc21ef72c372bc6d4bd37b97e823b729", "committedDate": "2020-07-10T06:42:21Z", "message": "Use `XDG_RUNTIME_DIR`, add CI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1d8f5ac28f3e9d1a5f02c3685f4bd0bc0f8c03a", "author": {"user": {"login": "bsideup", "name": "Sergei Egorov"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/e1d8f5ac28f3e9d1a5f02c3685f4bd0bc0f8c03a", "committedDate": "2020-07-10T10:18:14Z", "message": "run all `core` tests with Rootless Docker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b13156d114342df6a501126516c1029e97d0831", "author": {"user": {"login": "bsideup", "name": "Sergei Egorov"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/0b13156d114342df6a501126516c1029e97d0831", "committedDate": "2020-07-10T11:47:45Z", "message": "Fix local compose"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb9c21e8f608c2d641aa94a1e6ba60d3323d1f12", "author": {"user": {"login": "bsideup", "name": "Sergei Egorov"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/fb9c21e8f608c2d641aa94a1e6ba60d3323d1f12", "committedDate": "2020-07-10T11:56:29Z", "message": "fix `docker-credential-fake`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NDEzNzQ2", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#pullrequestreview-446413746", "createdAt": "2020-07-10T13:45:41Z", "commit": {"oid": "fb9c21e8f608c2d641aa94a1e6ba60d3323d1f12"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMzo0NTo0MVrOGv3-HQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMzo0NTo0MVrOGv3-HQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg1MzI3Nw==", "bodyText": "\ud83d\ude02 for our tests, could we do this using the host socket URI?", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#discussion_r452853277", "createdAt": "2020-07-10T13:45:41Z", "author": {"login": "rnorth"}, "path": "core/src/test/java/org/testcontainers/containers/GenericContainerTest.java", "diffHunk": "@@ -21,6 +24,9 @@\n \n     @Test\n     public void shouldReportOOMAfterWait() {\n+        Info info = DockerClientFactory.instance().client().infoCmd().exec();\n+        // Poor man's rootless Docker detection :D", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb9c21e8f608c2d641aa94a1e6ba60d3323d1f12"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NDI1MTA0", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#pullrequestreview-446425104", "createdAt": "2020-07-10T13:59:58Z", "commit": {"oid": "fb9c21e8f608c2d641aa94a1e6ba60d3323d1f12"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMzo1OTo1OFrOGv4f9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMzo1OTo1OFrOGv4f9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg2MTk0MA==", "bodyText": "Do we want this to be the highest priority? I'd put this lower than UnixSocketClientProviderStrategy, at least after #1771 is merged (so that DOCKER_HOST is always respected, non-rootless-docker is tried first, and automatically configured rootless docker is tried last of all)", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#discussion_r452861940", "createdAt": "2020-07-10T13:59:58Z", "author": {"login": "rnorth"}, "path": "core/src/main/java/org/testcontainers/dockerclient/RootlessDockerClientProviderStrategy.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package org.testcontainers.dockerclient;\n+\n+import com.sun.jna.Library;\n+import com.sun.jna.Native;\n+import org.apache.commons.lang.SystemUtils;\n+\n+import java.net.URI;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+\n+/**\n+ *\n+ * @deprecated this class is used by the SPI and should not be used directly\n+ */\n+@Deprecated\n+public final class RootlessDockerClientProviderStrategy extends DockerClientProviderStrategy {\n+\n+    public static final int PRIORITY = EnvironmentAndSystemPropertyClientProviderStrategy.PRIORITY + 20;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb9c21e8f608c2d641aa94a1e6ba60d3323d1f12"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ae6ef64ffbd4b8f4b71645275ea73dd6cfeebfd", "author": {"user": {"login": "bsideup", "name": "Sergei Egorov"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/5ae6ef64ffbd4b8f4b71645275ea73dd6cfeebfd", "committedDate": "2020-07-10T14:09:23Z", "message": "debug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd7cc6fb3fc3948d69261b95269f9ec0eabc14f4", "author": {"user": {"login": "bsideup", "name": "Sergei Egorov"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/dd7cc6fb3fc3948d69261b95269f9ec0eabc14f4", "committedDate": "2020-07-10T15:09:10Z", "message": "Use `Native.loadLibrary` for better compatibility with JNA 4.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53f5a4246681e2f0c57bb32a17fe32bfaaba6826", "author": {"user": {"login": "bsideup", "name": "Sergei Egorov"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/53f5a4246681e2f0c57bb32a17fe32bfaaba6826", "committedDate": "2020-07-11T19:06:03Z", "message": "Merge branch 'master' into rootless_docker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59761964e48decf20ba34638ff877b7d23cf9392", "author": {"user": {"login": "bsideup", "name": "Sergei Egorov"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/59761964e48decf20ba34638ff877b7d23cf9392", "committedDate": "2020-07-11T19:07:48Z", "message": "change the priority and remove hardcoded \"localhost\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72ad8d23f0aad462c886bc28b83f2d5dd367c758", "author": {"user": {"login": "bsideup", "name": "Sergei Egorov"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/72ad8d23f0aad462c886bc28b83f2d5dd367c758", "committedDate": "2020-07-12T16:23:30Z", "message": "Merge branch 'master' into rootless_docker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8dc8c7942114897e6aa07c46e5b82911ccb5641c", "author": {"user": {"login": "bsideup", "name": "Sergei Egorov"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/8dc8c7942114897e6aa07c46e5b82911ccb5641c", "committedDate": "2020-07-12T16:32:52Z", "message": "make `UnixSocketClientProviderStrategy` work on Mac (again :D)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7f1a081fc4f2ccb44216fa6313668ba3d92a894", "author": {"user": {"login": "bsideup", "name": "Sergei Egorov"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/f7f1a081fc4f2ccb44216fa6313668ba3d92a894", "committedDate": "2020-07-12T16:33:19Z", "message": "Allow overriding host's Docker socket"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ff171f81178d21aae8e4f7a8d0801a70aad156d", "author": {"user": {"login": "bsideup", "name": "Sergei Egorov"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/7ff171f81178d21aae8e4f7a8d0801a70aad156d", "committedDate": "2020-07-12T16:41:41Z", "message": "Document the overrides"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9ffae3b5c5d0984dace5d68273b030545ce9f97", "author": {"user": {"login": "bsideup", "name": "Sergei Egorov"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/b9ffae3b5c5d0984dace5d68273b030545ce9f97", "committedDate": "2020-07-12T16:45:18Z", "message": "add a new line"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NTA1MzEy", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#pullrequestreview-447505312", "createdAt": "2020-07-13T18:40:00Z", "commit": {"oid": "b9ffae3b5c5d0984dace5d68273b030545ce9f97"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxODo0MDowMVrOGw1Cyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxODo0MDo0OVrOGw1EpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1Mzg5OA==", "bodyText": "Could we make these match the format of other configuration settings, where we show what the default value is?", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#discussion_r453853898", "createdAt": "2020-07-13T18:40:01Z", "author": {"login": "rnorth"}, "path": "docs/features/configuration.md", "diffHunk": "@@ -72,3 +72,15 @@ but does not allow starting privileged containers, you can turn off the Ryuk con\n \n > **pull.pause.timeout = 30**\n > By default Testcontainers will abort the pull of an image if the pull appears stalled (no data transferred) for longer than this duration (in seconds).\n+\n+## Customizing Docker host detection\n+\n+Testcontainers will attempt to detect the Docker environment and configure everything.\n+\n+However, sometimes a customization is required. For that, you can provide the following environment variables:\n+\n+> **TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE = /var/run/docker-alt.sock**  ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9ffae3b5c5d0984dace5d68273b030545ce9f97"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg1NDM3Mw==", "bodyText": "If we're saying this, should we (for completeness) mention DOCKER_HOST?", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#discussion_r453854373", "createdAt": "2020-07-13T18:40:49Z", "author": {"login": "rnorth"}, "path": "docs/features/configuration.md", "diffHunk": "@@ -72,3 +72,15 @@ but does not allow starting privileged containers, you can turn off the Ryuk con\n \n > **pull.pause.timeout = 30**\n > By default Testcontainers will abort the pull of an image if the pull appears stalled (no data transferred) for longer than this duration (in seconds).\n+\n+## Customizing Docker host detection\n+\n+Testcontainers will attempt to detect the Docker environment and configure everything.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9ffae3b5c5d0984dace5d68273b030545ce9f97"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb01cc87e91ccca06551ebbf80588910c4b6b22f", "author": {"user": {"login": "bsideup", "name": "Sergei Egorov"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/cb01cc87e91ccca06551ebbf80588910c4b6b22f", "committedDate": "2020-07-13T20:44:09Z", "message": "Mention `DOCKER_HOST` as well"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b1e44001602cf3f90aca0a3e9ca231383119dd1", "author": {"user": {"login": "bsideup", "name": "Sergei Egorov"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/8b1e44001602cf3f90aca0a3e9ca231383119dd1", "committedDate": "2020-07-14T09:25:07Z", "message": "fix the DOCKER_HOST link"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17f531f289b310dca2d63700590470fce328e2b8", "author": {"user": {"login": "bsideup", "name": "Sergei Egorov"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/17f531f289b310dca2d63700590470fce328e2b8", "committedDate": "2020-07-15T08:42:56Z", "message": "Add examples"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4ODc3MDQy", "url": "https://github.com/testcontainers/testcontainers-java/pull/2985#pullrequestreview-448877042", "createdAt": "2020-07-15T11:49:19Z", "commit": {"oid": "17f531f289b310dca2d63700590470fce328e2b8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3343, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}