{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzMDgyNjUx", "number": 2573, "title": "Support ImageFromDockerfile authenticated image pulls", "bodyText": "#2201 was intended to support authenticated pulls for images required by ImageFromDockerfile builds and Docker Compose. Unfortunately there was a bug in the ImageFromDockerfile implementation, which needs patching.\nSadly authenticated pulls are not easy to automatically test, so this was missed in manual testing.\nThis PR:\n\nEnsures that the required images are pulled once the list of images is actually populated\nAutomatically disable's docker's built-in pull if this has been done, as it is not required and will fail if an authenticated image is involved\nAdds integration tests that pull images from a local private docker registry. This covers both building a Docker Image from dockerfile and also launching a compose project. The tests are intended to ensure that the authenticated pull code is actually used; unit tests cover the various permutations of looking up which images need to be pulled.", "createdAt": "2020-04-14T09:51:26Z", "url": "https://github.com/testcontainers/testcontainers-java/pull/2573", "merged": true, "mergeCommit": {"oid": "f631023576288234e7aacdce867520200b2dcfda"}, "closed": true, "closedAt": "2020-04-19T18:57:43Z", "author": {"login": "rnorth"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXf2TvgH2gAyNDAzMDgyNjUxOjUwZjIxZTY3YjdkNzE5NDViM2YzYWJmZDE2ZTFkMzFiNTNmMTVkZWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZN4sogH2gAyNDAzMDgyNjUxOjM3OGNiNjk1M2Y3ZGU2ZDI2NzQ5ZWJlMTFjYWZkZWNlYWEyMWIyYTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "50f21e67b7d71945b3f3abfd16e1d31b53f15ded", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/50f21e67b7d71945b3f3abfd16e1d31b53f15ded", "committedDate": "2020-04-14T09:12:43Z", "message": "Support ImageFromDockerfile authenticated image pulls"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNzc5OTc0", "url": "https://github.com/testcontainers/testcontainers-java/pull/2573#pullrequestreview-392779974", "createdAt": "2020-04-14T09:59:59Z", "commit": {"oid": "50f21e67b7d71945b3f3abfd16e1d31b53f15ded"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwOTo1OTo1OVrOGFHSug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwOTo1OTo1OVrOGFHSug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAxNTU0Ng==", "bodyText": "nit: why not the good old for-in? :D", "url": "https://github.com/testcontainers/testcontainers-java/pull/2573#discussion_r408015546", "createdAt": "2020-04-14T09:59:59Z", "author": {"login": "bsideup"}, "path": "core/src/main/java/org/testcontainers/images/builder/ImageFromDockerfile.java", "diffHunk": "@@ -154,11 +146,30 @@ protected void configure(BuildImageCmd buildImageCmd) {\n         this.dockerfile.ifPresent(p -> {\n             buildImageCmd.withDockerfile(p.toFile());\n             dependencyImageNames = new ParsedDockerfile(p).getDependencyImageNames();\n+\n+            if (dependencyImageNames.size() > 0) {\n+                // if we'l be pre-pulling images, disable the built-in pull as it is not necessary and will fail for\n+                // authenticated registries\n+                buildImageCmd.withPull(false);\n+            }\n         });\n \n         this.buildArgs.forEach(buildImageCmd::withBuildArg);\n     }\n \n+    private void prePullDependencyImages(Set<String> imagesToPull) {\n+        final DockerClient dockerClient = DockerClientFactory.instance().client();\n+\n+        imagesToPull.forEach(imageName -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50f21e67b7d71945b3f3abfd16e1d31b53f15ded"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNzgwNDY2", "url": "https://github.com/testcontainers/testcontainers-java/pull/2573#pullrequestreview-392780466", "createdAt": "2020-04-14T10:00:39Z", "commit": {"oid": "50f21e67b7d71945b3f3abfd16e1d31b53f15ded"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMDI2MjU3", "url": "https://github.com/testcontainers/testcontainers-java/pull/2573#pullrequestreview-393026257", "createdAt": "2020-04-14T15:11:01Z", "commit": {"oid": "50f21e67b7d71945b3f3abfd16e1d31b53f15ded"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNToxMTowMVrOGFTejg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNToxMTowMVrOGFTejg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIxNTE4Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            // if we'l be pre-pulling images, disable the built-in pull as it is not necessary and will fail for\n          \n          \n            \n                            // if we'll be pre-pulling images, disable the built-in pull as it is not necessary and will fail for", "url": "https://github.com/testcontainers/testcontainers-java/pull/2573#discussion_r408215182", "createdAt": "2020-04-14T15:11:01Z", "author": {"login": "dbyron0"}, "path": "core/src/main/java/org/testcontainers/images/builder/ImageFromDockerfile.java", "diffHunk": "@@ -154,11 +146,30 @@ protected void configure(BuildImageCmd buildImageCmd) {\n         this.dockerfile.ifPresent(p -> {\n             buildImageCmd.withDockerfile(p.toFile());\n             dependencyImageNames = new ParsedDockerfile(p).getDependencyImageNames();\n+\n+            if (dependencyImageNames.size() > 0) {\n+                // if we'l be pre-pulling images, disable the built-in pull as it is not necessary and will fail for", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50f21e67b7d71945b3f3abfd16e1d31b53f15ded"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f536def44edc1b776a0b6c344d21da61d943bc9", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/8f536def44edc1b776a0b6c344d21da61d943bc9", "committedDate": "2020-04-14T20:03:44Z", "message": "Add integration tests for authenticated pulls for ImageFromDockerfile and Docker Compose"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7fcf2236b4cf3fc695908396f23d8975dd70907", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/b7fcf2236b4cf3fc695908396f23d8975dd70907", "committedDate": "2020-04-14T20:05:44Z", "message": "Update core/src/main/java/org/testcontainers/images/builder/ImageFromDockerfile.java\n\nCo-Authored-By: David Byron <dbyron@dbyron.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMjYwMDk4", "url": "https://github.com/testcontainers/testcontainers-java/pull/2573#pullrequestreview-393260098", "createdAt": "2020-04-14T20:12:49Z", "commit": {"oid": "b7fcf2236b4cf3fc695908396f23d8975dd70907"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQyMDoxMjo0OVrOGFfJKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQyMDoxMjo0OVrOGFfJKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQwNjMxNQ==", "bodyText": "Deprecation duty.", "url": "https://github.com/testcontainers/testcontainers-java/pull/2573#discussion_r408406315", "createdAt": "2020-04-14T20:12:49Z", "author": {"login": "rnorth"}, "path": "core/src/test/java/org/testcontainers/utility/AuthenticatedImagePullTest.java", "diffHunk": "@@ -109,10 +169,7 @@ private void putImageInRegistry() throws InterruptedException {\n         client.tagImageCmd(id, testImageName, \"latest\").exec();\n \n         client.pushImageCmd(testImageNameWithTag)\n-            .exec(new PushImageResultCallback())\n+            .exec(new ResultCallback.Adapter<>())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7fcf2236b4cf3fc695908396f23d8975dd70907"}, "originalPosition": 166}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMjYyMDM4", "url": "https://github.com/testcontainers/testcontainers-java/pull/2573#pullrequestreview-393262038", "createdAt": "2020-04-14T20:15:41Z", "commit": {"oid": "b7fcf2236b4cf3fc695908396f23d8975dd70907"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQyMDoxNTo0MVrOGFfPCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQyMDoxNTo0MVrOGFfPCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQwNzgxNw==", "bodyText": "I wish we had text blocks!\nI would have preferred to just point to a static file on disk, but unfortunately our dockerized private registry has a port number that can vary, and thus the image name changes.\nHence, constructing a tiny YAML file in a string seemed like a tolerable evil.", "url": "https://github.com/testcontainers/testcontainers-java/pull/2573#discussion_r408407817", "createdAt": "2020-04-14T20:15:41Z", "author": {"login": "rnorth"}, "path": "core/src/test/java/org/testcontainers/utility/AuthenticatedImagePullTest.java", "diffHunk": "@@ -83,17 +83,77 @@ public void testThatAuthLocatorIsUsed() throws Exception {\n \n         // a push will use the auth locator for authentication, although that isn't the goal of this test\n         putImageInRegistry();\n+    }\n+\n+    @Before\n+    public void removeImageFromLocalDocker() {\n+        // remove the image tag from local docker so that it must be pulled before use\n+        client.removeImageCmd(testImageNameWithTag).withForce(true).exec();\n+    }\n \n+    @AfterClass\n+    public static void tearDown() {\n+        RegistryAuthLocator.setInstance(originalAuthLocatorSingleton);\n+    }\n+\n+    @Test\n+    public void testThatAuthLocatorIsUsedForContainerCreation() {\n         // actually start a container, which will require an authenticated pull\n-        try (final GenericContainer container = new GenericContainer<>(testImageNameWithTag)\n+        try (final GenericContainer<?> container = new GenericContainer<>(testImageNameWithTag)\n             .withCommand(\"/bin/sh\", \"-c\", \"sleep 10\")) {\n             container.start();\n \n             assertTrue(\"container started following an authenticated pull\", container.isRunning());\n         }\n     }\n \n-    private void putImageInRegistry() throws InterruptedException {\n+    @Test\n+    public void testThatAuthLocatorIsUsedForDockerfileBuild() throws IOException {\n+        // Prepare a simple temporary Dockerfile which requires our custom private image\n+        Path tempContext = Files.createTempDirectory(Paths.get(\".\"), this.getClass().getSimpleName() + \"-test-\");\n+        Path tempFile = Files.createTempFile(tempContext, \"test\", \".Dockerfile\");\n+        String dockerFileContent = \"FROM \" + testImageNameWithTag;\n+        Files.write(tempFile, dockerFileContent.getBytes());\n+\n+        // Start a container built from a derived image, which will require an authenticated pull\n+        try (final GenericContainer<?> container = new GenericContainer<>(\n+            new ImageFromDockerfile()\n+                .withDockerfile(tempFile)\n+        )\n+            .withCommand(\"/bin/sh\", \"-c\", \"sleep 10\")) {\n+            container.start();\n+\n+            assertTrue(\"container started following an authenticated pull\", container.isRunning());\n+        }\n+    }\n+\n+    @Test\n+    public void testThatAuthLocatorIsUsedForDockerComposePull() throws IOException {\n+        // Prepare a simple temporary Docker Compose manifest which requires our custom private image\n+        Path tempContext = Files.createTempDirectory(Paths.get(\".\"), this.getClass().getSimpleName() + \"-test-\");\n+        Path tempFile = Files.createTempFile(tempContext, \"test\", \".docker-compose.yml\");\n+        @Language(\"yaml\") String composeFileContent =\n+            \"version: '2.0'\\n\" +\n+                \"services:\\n\" +\n+                \"  privateservice:\\n\" +\n+                \"      command: /bin/sh -c 'sleep 60'\\n\" +\n+                \"      image: \" + testImageNameWithTag;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7fcf2236b4cf3fc695908396f23d8975dd70907"}, "originalPosition": 141}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23f26c9c3bdaff8eb28e8c3f22445a0fbdf971c3", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/23f26c9c3bdaff8eb28e8c3f22445a0fbdf971c3", "committedDate": "2020-04-14T21:01:08Z", "message": "Merge branch 'master' into fix-imagefromdockerfile-authenticated-pull"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57754d42c29719980908484af40031a771819f28", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/57754d42c29719980908484af40031a771819f28", "committedDate": "2020-04-15T18:36:34Z", "message": "Merge branch 'master' into fix-imagefromdockerfile-authenticated-pull"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff3d053f8528322e946fa7f60b490f527f2eb324", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/ff3d053f8528322e946fa7f60b490f527f2eb324", "committedDate": "2020-04-19T12:55:38Z", "message": "Merge branch 'master' into fix-imagefromdockerfile-authenticated-pull"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "378cb6953f7de6d26749ebe11cafdeceaa21b2a0", "author": {"user": {"login": "rnorth", "name": "Richard North"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/378cb6953f7de6d26749ebe11cafdeceaa21b2a0", "committedDate": "2020-04-19T17:24:53Z", "message": "Merge branch 'master' into fix-imagefromdockerfile-authenticated-pull"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3396, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}