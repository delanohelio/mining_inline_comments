{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2MTg4NjU0", "number": 3015, "title": "Improve log messages when database container test query fails", "bodyText": "Throw an exception if container is started but test sql query cannot be executed (cannot connect to database port or smth else).\nFixes #2878", "createdAt": "2020-07-24T09:43:54Z", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015", "merged": true, "mergeCommit": {"oid": "3858aff8d63ae0b28b92bd08c21255163ae75160"}, "closed": true, "closedAt": "2021-05-19T12:23:26Z", "author": {"login": "vcvitaly"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcz37W7AH2gAyNDU2MTg4NjU0OjhmMzdkNDUyYjY1ODBjNmYxMDcxOGE5MjdkYzlkMWJjODVkMWNiNmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABeVag6qgH2gAyNDU2MTg4NjU0OjcwYjE3ZjkzNjVmMTQ1MmI0ZDkwNDZlOGUzMDQ1YWViNDk2NjU5OTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8f37d452b6580c6f10718a927dc9d1bc85d1cb6c", "author": {"user": {"login": "vcvitaly", "name": "vcvitaly"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/8f37d452b6580c6f10718a927dc9d1bc85d1cb6c", "committedDate": "2020-07-11T13:05:50Z", "message": "Refactor, remove `waitUntilContainerStarted()` where it's behaviour is not overriden"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c266ad80fc1278c87c43cf84d2dfab4dec24f2f", "author": {"user": {"login": "vcvitaly", "name": "vcvitaly"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/7c266ad80fc1278c87c43cf84d2dfab4dec24f2f", "committedDate": "2020-07-11T18:04:47Z", "message": "Add logger cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8038b2a1b7ba7649c91f390c25147ecccfea433", "author": {"user": {"login": "vcvitaly", "name": "vcvitaly"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/b8038b2a1b7ba7649c91f390c25147ecccfea433", "committedDate": "2020-07-24T09:36:32Z", "message": "Throw an exception if container is not accessible by jdbc url"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NzU5MjEw", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015#pullrequestreview-454759210", "createdAt": "2020-07-24T09:45:09Z", "commit": {"oid": "b8038b2a1b7ba7649c91f390c25147ecccfea433"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwOTo0NTowOVrOG2pbWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwOTo0NTowOVrOG2pbWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk1NTAzNQ==", "bodyText": "No sure if it was made on purpose. The local variable hides the instance variable and seemed redundant.", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015#discussion_r459955035", "createdAt": "2020-07-24T09:45:09Z", "author": {"login": "vcvitaly"}, "path": "core/src/main/java/org/testcontainers/containers/GenericContainer.java", "diffHunk": "@@ -867,7 +868,6 @@ public void setWaitStrategy(org.testcontainers.containers.wait.strategy.WaitStra\n      * @see #waitingFor(org.testcontainers.containers.wait.strategy.WaitStrategy)\n      */\n     protected void waitUntilContainerStarted() {\n-        org.testcontainers.containers.wait.strategy.WaitStrategy waitStrategy = getWaitStrategy();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8038b2a1b7ba7649c91f390c25147ecccfea433"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7e6d1fbadef9eb1465c8c65db1a54ece2f344491", "author": {"user": {"login": "vcvitaly", "name": "vcvitaly"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/7e6d1fbadef9eb1465c8c65db1a54ece2f344491", "committedDate": "2020-07-24T10:13:26Z", "message": "Update logging settings for containers (loggers provided by DockerLoggerFactory)"}, "afterCommit": {"oid": "b8038b2a1b7ba7649c91f390c25147ecccfea433", "author": {"user": {"login": "vcvitaly", "name": "vcvitaly"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/b8038b2a1b7ba7649c91f390c25147ecccfea433", "committedDate": "2020-07-24T09:36:32Z", "message": "Throw an exception if container is not accessible by jdbc url"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60761b7f06c396cd96e2fb42d4abbf19501a122f", "author": {"user": {"login": "vcvitaly", "name": "vcvitaly"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/60761b7f06c396cd96e2fb42d4abbf19501a122f", "committedDate": "2020-07-24T10:22:23Z", "message": "Revert changes unrelated to the issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "335fdec3df5915ca74a4171379e2e318b99fc87e", "author": {"user": {"login": "vcvitaly", "name": "vcvitaly"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/335fdec3df5915ca74a4171379e2e318b99fc87e", "committedDate": "2020-08-25T05:47:25Z", "message": "#2878 write a test for the <exception> case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc4MTE4ODI4", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015#pullrequestreview-578118828", "createdAt": "2021-01-28T09:09:16Z", "commit": {"oid": "335fdec3df5915ca74a4171379e2e318b99fc87e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOFQwOTowOToxNlrOIbtfqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOFQwOTowOToxNlrOIbtfqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkyNzg0OQ==", "bodyText": "Just an idea:\nI wonder if Unreliables can be used in this case to reduce complexity of all that while sleep construction ? @bsideup @rnorth @kiview whats your opinion on that ?\nI know that it was historically written that way, but imho that would really helped if that test would be rewritten without any sleep in here", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015#discussion_r565927849", "createdAt": "2021-01-28T09:09:16Z", "author": {"login": "artjomka"}, "path": "modules/jdbc/src/main/java/org/testcontainers/containers/JdbcDatabaseContainer.java", "diffHunk": "@@ -122,25 +124,23 @@ public SELF withInitScript(String initScriptPath) {\n         return self();\n     }\n \n+    @SneakyThrows(InterruptedException.class)\n     @Override\n     protected void waitUntilContainerStarted() {\n         logger().info(\"Waiting for database connection to become available at {} using query '{}'\", getJdbcUrl(), getTestQueryString());\n \n         // Repeatedly try and open a connection to the DB and execute a test query\n         long start = System.currentTimeMillis();\n-        try {\n-            while (System.currentTimeMillis() < start + (1000 * startupTimeoutSeconds)) {\n-                try {\n-                    if (!isRunning()) {\n-                        Thread.sleep(100L);\n-                        continue; // Don't attempt to connect yet\n-                    }\n \n-                    try (Connection connection = createConnection(\"\")) {\n-                        boolean testQuerySucceeded = connection.createStatement().execute(this.getTestQueryString());\n-                        if (testQuerySucceeded) {\n-                            break;\n-                        }\n+        while (System.currentTimeMillis() < start + (1000 * startupTimeoutSeconds)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "335fdec3df5915ca74a4171379e2e318b99fc87e"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc4MTI2MDQ1", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015#pullrequestreview-578126045", "createdAt": "2021-01-28T09:17:26Z", "commit": {"oid": "335fdec3df5915ca74a4171379e2e318b99fc87e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOFQwOToxNzoyNlrOIbt1IA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOFQwOToxNzoyNlrOIbt1IA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkzMzM0NA==", "bodyText": "I wonder what exactly tan prefix means ? :)\nAlso I would suggest to use should prefix in test names for codebase consistency for example shouldThrowProperExceptionOnUnavailableConnection just as an idea", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015#discussion_r565933344", "createdAt": "2021-01-28T09:17:26Z", "author": {"login": "artjomka"}, "path": "modules/jdbc/src/test/java/org/testcontainers/containers/JdbcDatabaseContainerTest.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.testcontainers.containers;\n+\n+import java.sql.Connection;\n+import java.sql.SQLException;\n+import lombok.NonNull;\n+import org.junit.Test;\n+import org.slf4j.Logger;\n+\n+import static org.assertj.core.api.Assertions.assertThatExceptionOfType;\n+import static org.mockito.Mockito.mock;\n+\n+public class JdbcDatabaseContainerTest {\n+\n+    @Test\n+    public void tanExceptionIsThrownIfJdbcIsNotAvailable() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "335fdec3df5915ca74a4171379e2e318b99fc87e"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTg0ODkxMzM2", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015#pullrequestreview-584891336", "createdAt": "2021-02-06T15:24:16Z", "commit": {"oid": "335fdec3df5915ca74a4171379e2e318b99fc87e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wNlQxNToyNDoxNlrOIg-aaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wNlQxNToyNDoxNlrOIg-aaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTQ0NzkxMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void tanExceptionIsThrownIfJdbcIsNotAvailable() {\n          \n          \n            \n                public void anExceptionIsThrownIfJdbcIsNotAvailable() {", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015#discussion_r571447913", "createdAt": "2021-02-06T15:24:16Z", "author": {"login": "bsideup"}, "path": "modules/jdbc/src/test/java/org/testcontainers/containers/JdbcDatabaseContainerTest.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.testcontainers.containers;\n+\n+import java.sql.Connection;\n+import java.sql.SQLException;\n+import lombok.NonNull;\n+import org.junit.Test;\n+import org.slf4j.Logger;\n+\n+import static org.assertj.core.api.Assertions.assertThatExceptionOfType;\n+import static org.mockito.Mockito.mock;\n+\n+public class JdbcDatabaseContainerTest {\n+\n+    @Test\n+    public void tanExceptionIsThrownIfJdbcIsNotAvailable() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "335fdec3df5915ca74a4171379e2e318b99fc87e"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e899dc4581bfc7943f1f44756a7c0d94f684ac18", "author": {"user": {"login": "vcvitaly", "name": "vcvitaly"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/e899dc4581bfc7943f1f44756a7c0d94f684ac18", "committedDate": "2021-02-15T11:30:33Z", "message": "Fix a typo in a test method name\n\nCo-authored-by: Sergei Egorov <bsideup@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjU0NTE1NjAw", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015#pullrequestreview-654515600", "createdAt": "2021-05-07T14:24:29Z", "commit": {"oid": "e899dc4581bfc7943f1f44756a7c0d94f684ac18"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNS0wN1QxNDoyNDoyOVrOJXJb_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNS0wN1QxNDoyNDoyOVrOJXJb_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODI1MTY0NA==", "bodyText": "Super tiny nit, but I think this can be reduced to:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            JdbcDatabaseContainer.this.getJdbcUrl())\n          \n          \n            \n                            this.getJdbcUrl())\n          \n      \n    \n    \n  \n\nOther than that though, and an unfortunate merge conflict that I don't have permission to resolve, I think this PR is fine.", "url": "https://github.com/testcontainers/testcontainers-java/pull/3015#discussion_r628251644", "createdAt": "2021-05-07T14:24:29Z", "author": {"login": "rnorth"}, "path": "modules/jdbc/src/main/java/org/testcontainers/containers/JdbcDatabaseContainer.java", "diffHunk": "@@ -151,12 +151,12 @@ protected void waitUntilContainerStarted() {\n                     Thread.sleep(100L);\n                 }\n             }\n-        } catch (InterruptedException e) {\n-            Thread.currentThread().interrupt();\n-            throw new ContainerLaunchException(\"Container startup wait was interrupted\", e);\n         }\n \n-        logger().info(\"Container is started (JDBC URL: {})\", JdbcDatabaseContainer.this.getJdbcUrl());\n+        throw new IllegalStateException(\n+            String.format(\"Container is started, but cannot be accessed by (JDBC URL: %s), please check container logs\",\n+                JdbcDatabaseContainer.this.getJdbcUrl())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e899dc4581bfc7943f1f44756a7c0d94f684ac18"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a67b9cf6c44fb2bc9402f464595ff1338fbdb09a", "author": {"user": {"login": "vcvitaly", "name": "vcvitaly"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/a67b9cf6c44fb2bc9402f464595ff1338fbdb09a", "committedDate": "2021-05-10T14:06:24Z", "message": "Update as per PR review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70b17f9365f1452b4d9046e8e3045aeb49665996", "author": {"user": {"login": "vcvitaly", "name": "vcvitaly"}}, "url": "https://github.com/testcontainers/testcontainers-java/commit/70b17f9365f1452b4d9046e8e3045aeb49665996", "committedDate": "2021-05-10T14:14:17Z", "message": "Merge remote-tracking branch 'upstream/master' into 2878/jdbc_container_start_timeout\n\n# Conflicts:\n#\tmodules/jdbc/build.gradle"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3350, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}