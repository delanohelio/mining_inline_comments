{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyNTk1NDg1", "number": 725, "title": "Adopt retrieval of application packages during staging", "bodyText": "Description:\nWhen the upload of the application is not skipped and the application is not restarted because there are no changes in the content - a problem might rise if the application is restaged, after the validation phase of the blue green deployment.\nIssue: https://sapjira.wdf.sap.corp/browse/LMCROSSITXSADEPLOY-1851", "createdAt": "2020-01-14T11:54:59Z", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/725", "merged": true, "mergeCommit": {"oid": "56e7da34a1f8569e99a9fe04b11d54e015660d79"}, "closed": true, "closedAt": "2020-01-15T13:51:12Z", "author": {"login": "enchobelezirev"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6QEEsABqjI5NDY4NTA5NzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6lvvPABqjI5NTA4MzQ5Mzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30a7d2291b84a800b2cc8928c6b07913a5e57002", "author": {"user": {"login": "enchobelezirev", "name": "Encho Belezirev"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/30a7d2291b84a800b2cc8928c6b07913a5e57002", "committedDate": "2020-01-14T11:47:36Z", "message": "Adopt retrieval of application packages during staging"}, "afterCommit": {"oid": "0b7bc26ccb496ce2e272b4815045d80c9f771d3c", "author": {"user": {"login": "enchobelezirev", "name": "Encho Belezirev"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/0b7bc26ccb496ce2e272b4815045d80c9f771d3c", "committedDate": "2020-01-14T12:25:11Z", "message": "Adopt retrieval of application packages during staging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNjAyMjcw", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/725#pullrequestreview-342602270", "createdAt": "2020-01-14T15:08:07Z", "commit": {"oid": "0b7bc26ccb496ce2e272b4815045d80c9f771d3c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNTowODowN1rOFdaxug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNTowOTo0NFrOFda1WQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5MTczOA==", "bodyText": "Can we avoid the fetch of this app?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/725#discussion_r366391738", "createdAt": "2020-01-14T15:08:07Z", "author": {"login": "nictas"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/StageAppStep.java", "diffHunk": "@@ -26,8 +27,11 @@\n \n     @Override\n     protected StepPhase executeAsyncStep(ExecutionWrapper execution) {\n-        CloudApplication app = StepsUtil.getApp(execution.getContext());\n-        ApplicationStager applicationStager = new ApplicationStager(execution.getControllerClient());\n+        String appName = StepsUtil.getApp(execution.getContext())\n+                                  .getName();\n+        CloudControllerClient client = execution.getControllerClient();\n+        CloudApplication app = client.getApplication(appName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b7bc26ccb496ce2e272b4815045d80c9f771d3c"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5MjY2NQ==", "bodyText": "There are two ands in this variable name.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/725#discussion_r366392665", "createdAt": "2020-01-14T15:09:44Z", "author": {"login": "nictas"}, "path": "com.sap.cloud.lm.sl.cf.process/src/test/java/com/sap/cloud/lm/sl/cf/process/util/ApplicationStagerTest.java", "diffHunk": "@@ -214,10 +218,49 @@ public void testBindDropletToApp() {\n     }\n \n     @Test\n-    public void testStageAppIfThereIsNoUploadToken() {\n+    public void testStageAppIfThereIsNoUploadTokenAndThereAreNoPackages() {\n         Mockito.when(context.getVariable(Constants.VAR_UPLOAD_TOKEN))\n                .thenReturn(null);\n-        assertEquals(StepPhase.DONE, applicationStager.stageApp(context, null, null));\n+        UUID testApplicationGuid = UUID.randomUUID();\n+        CloudApplication testApplication = ImmutableCloudApplication.builder()\n+                                                                    .metadata(ImmutableCloudMetadata.builder()\n+                                                                                                    .guid(testApplicationGuid)\n+                                                                                                    .build())\n+                                                                    .name(\"test-app\")\n+                                                                    .build();\n+        Mockito.when(client.getPackagesForApplication(Mockito.eq(testApplicationGuid), Mockito.any()))\n+               .thenReturn(Collections.emptyList());\n+\n+        Mockito.verifyNoInteractions(stepLogger);\n+        assertEquals(StepPhase.DONE, applicationStager.stageApp(context, testApplication, stepLogger));\n+    }\n+\n+    @Test\n+    public void testStageAppIfThereIsNoUploadTokenAndThereIsOnlyOnePackage() {\n+        Mockito.when(context.getVariable(Constants.VAR_UPLOAD_TOKEN))\n+               .thenReturn(null);\n+        UUID packageGuid = UUID.randomUUID();\n+        UUID testApplicationGuid = UUID.randomUUID();\n+        CloudApplication testApplication = ImmutableCloudApplication.builder()\n+                                                                    .metadata(ImmutableCloudMetadata.builder()\n+                                                                                                    .guid(testApplicationGuid)\n+                                                                                                    .build())\n+                                                                    .name(\"test-app\")\n+                                                                    .build();\n+        CloudPackage andAndOnlyApplicationPackage = ImmutableCloudPackage.builder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b7bc26ccb496ce2e272b4815045d80c9f771d3c"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNjA1NDI4", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/725#pullrequestreview-342605428", "createdAt": "2020-01-14T15:12:09Z", "commit": {"oid": "0b7bc26ccb496ce2e272b4815045d80c9f771d3c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNToxMjowOVrOFda69w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNToxMjowOVrOFda69w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5NDEwMw==", "bodyText": "Do uploadToken.getPackageGuid() here and remove the stageApplication method overload below.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/725#discussion_r366394103", "createdAt": "2020-01-14T15:12:09Z", "author": {"login": "nictas"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ApplicationStager.java", "diffHunk": "@@ -133,11 +137,28 @@ public void bindDropletToApplication(DelegateExecution context, UUID appGuid) {\n \n     public StepPhase stageApp(DelegateExecution context, CloudApplication app, StepLogger stepLogger) {\n         UploadToken uploadToken = StepsUtil.getUploadToken(context);\n-        if (uploadToken == null) {\n-            return StepPhase.DONE;\n+        if (uploadToken != null) {\n+            stepLogger.debug(Messages.UPLOAD_TOKEN_FOR_APPLICATION_0_1, app.getName(), JsonUtil.toJson(uploadToken, true));\n+            return stageApplication(context, app, stepLogger, uploadToken);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b7bc26ccb496ce2e272b4815045d80c9f771d3c"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0b7bc26ccb496ce2e272b4815045d80c9f771d3c", "author": {"user": {"login": "enchobelezirev", "name": "Encho Belezirev"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/0b7bc26ccb496ce2e272b4815045d80c9f771d3c", "committedDate": "2020-01-14T12:25:11Z", "message": "Adopt retrieval of application packages during staging"}, "afterCommit": {"oid": "45a3be1338875c9be5ca2dc92905f02c9a660380", "author": {"user": {"login": "enchobelezirev", "name": "Encho Belezirev"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/45a3be1338875c9be5ca2dc92905f02c9a660380", "committedDate": "2020-01-15T11:55:24Z", "message": "Adopt retrieval of application packages during staging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMTczNjQ1", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/725#pullrequestreview-343173645", "createdAt": "2020-01-15T12:07:34Z", "commit": {"oid": "45a3be1338875c9be5ca2dc92905f02c9a660380"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58961c54a6463cb483c149e40c881348fceef8b3", "author": {"user": {"login": "enchobelezirev", "name": "Encho Belezirev"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/58961c54a6463cb483c149e40c881348fceef8b3", "committedDate": "2020-01-15T13:41:00Z", "message": "Adopt retrieval of application packages during staging"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "45a3be1338875c9be5ca2dc92905f02c9a660380", "author": {"user": {"login": "enchobelezirev", "name": "Encho Belezirev"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/45a3be1338875c9be5ca2dc92905f02c9a660380", "committedDate": "2020-01-15T11:55:24Z", "message": "Adopt retrieval of application packages during staging"}, "afterCommit": {"oid": "58961c54a6463cb483c149e40c881348fceef8b3", "author": {"user": {"login": "enchobelezirev", "name": "Encho Belezirev"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/58961c54a6463cb483c149e40c881348fceef8b3", "committedDate": "2020-01-15T13:41:00Z", "message": "Adopt retrieval of application packages during staging"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 966, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}