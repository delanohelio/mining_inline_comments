{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzOTE3MjQ0", "number": 897, "title": "Skip user filtering if needed", "bodyText": "Do not filter by a user during health check monitoring if the user is not set.\nLMCROSSITXSADEPLOY-1940", "createdAt": "2020-07-03T08:09:41Z", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/897", "merged": true, "mergeCommit": {"oid": "e09480e980823b7c15558d22ae75b0aaf322e731"}, "closed": true, "closedAt": "2020-07-03T09:24:11Z", "author": {"login": "IvanBorislavovDimitrov"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxPTF2ABqjM1MTAxNDE3NTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcxP5-IAFqTQ0MjI3NDM3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c5bc05b7a7838dfbe932b4b25b09e239bbb28e7", "author": {"user": {"login": "IvanBorislavovDimitrov", "name": "Ivan Dimitrov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/9c5bc05b7a7838dfbe932b4b25b09e239bbb28e7", "committedDate": "2020-07-03T08:06:59Z", "message": "Skip user filtering if needed"}, "afterCommit": {"oid": "1c202493d0fea70f357d0cceea1493f4417aec7f", "author": {"user": {"login": "IvanBorislavovDimitrov", "name": "Ivan Dimitrov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/1c202493d0fea70f357d0cceea1493f4417aec7f", "committedDate": "2020-07-03T08:37:31Z", "message": "Skip user filtering if needed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMjY0NjYx", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/897#pullrequestreview-442264661", "createdAt": "2020-07-03T09:05:38Z", "commit": {"oid": "1c202493d0fea70f357d0cceea1493f4417aec7f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwOTowNTozOFrOGspc0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwOTowNTozOFrOGspc0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ2OTY0OQ==", "bodyText": "Is there a chance that something else is null?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/897#discussion_r449469649", "createdAt": "2020-07-03T09:05:38Z", "author": {"login": "radoslav-d"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/health/HealthRetriever.java", "diffHunk": "@@ -38,15 +39,21 @@ public Health getHealth() {\n         HealthCheckConfiguration healthCheckConfiguration = configuration.getHealthCheckConfiguration();\n         ZonedDateTime currentTime = currentTimeSupplier.get();\n         ZonedDateTime xSecondsAgo = currentTime.minusSeconds(healthCheckConfiguration.getTimeRangeInSeconds());\n-        List<Operation> healthCheckOperations = operationService.createQuery()\n-                                                                .mtaId(healthCheckConfiguration.getMtaId())\n-                                                                .spaceId(healthCheckConfiguration.getSpaceId())\n-                                                                .user(healthCheckConfiguration.getUserName())\n-                                                                .endedAfter(Date.from(xSecondsAgo.toInstant()))\n-                                                                .inFinalState()\n-                                                                .orderByEndTime(OrderDirection.DESCENDING)\n-                                                                .list();\n+        List<Operation> healthCheckOperations = getHealthCheckOperations(healthCheckConfiguration, xSecondsAgo);\n         return Health.fromOperations(healthCheckOperations);\n     }\n \n+    private List<Operation> getHealthCheckOperations(HealthCheckConfiguration healthCheckConfiguration, ZonedDateTime xSecondsAgo) {\n+        OperationQuery healthCheckOperationsQuery = operationService.createQuery()\n+                                                                    .mtaId(healthCheckConfiguration.getMtaId())\n+                                                                    .spaceId(healthCheckConfiguration.getSpaceId())\n+                                                                    .endedAfter(Date.from(xSecondsAgo.toInstant()))\n+                                                                    .inFinalState()\n+                                                                    .orderByEndTime(OrderDirection.DESCENDING);\n+        if (healthCheckConfiguration.getUserName() != null) {\n+            healthCheckOperationsQuery.user(healthCheckConfiguration.getUserName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c202493d0fea70f357d0cceea1493f4417aec7f"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMjY2Mjkz", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/897#pullrequestreview-442266293", "createdAt": "2020-07-03T09:08:01Z", "commit": {"oid": "1c202493d0fea70f357d0cceea1493f4417aec7f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwOTowODowMVrOGsph8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwOTowODowMVrOGsph8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ3MDk2Mg==", "bodyText": "I think that there is never() or something similar, which can be used instead of times(0).", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/897#discussion_r449470962", "createdAt": "2020-07-03T09:08:01Z", "author": {"login": "radoslav-d"}, "path": "com.sap.cloud.lm.sl.cf.core/src/test/java/com/sap/cloud/lm/sl/cf/core/health/HealthRetrieverTest.java", "diffHunk": "@@ -101,15 +106,49 @@ public void testGetHealth() {\n \n         HealthCheckOperation healthCheckOperation = health.getHealthCheckOperations()\n                                                           .get(0);\n+        validateHealthCheckOperationParameters(healthCheckOperation);\n+        Mockito.verify(operationQuery, times(1))\n+               .user(USER_NAME);\n+        validateMandatoryParametersAreSet();\n+    }\n+\n+    @Test\n+    void testGetHealthWithoutUsername() {\n+        prepareConfiguration(ImmutableHealthCheckConfiguration.builder()\n+                                                              .mtaId(MTA_ID)\n+                                                              .spaceId(SPACE_ID)\n+                                                              .timeRangeInSeconds(TIME_RANGE_IN_SECONDS)\n+                                                              .build());\n+        Health health = healthRetriever.getHealth();\n+\n+        assertTrue(health.isHealthy());\n+        HealthCheckOperation healthCheckOperation = health.getHealthCheckOperations()\n+                                                          .get(0);\n+        validateHealthCheckOperationParameters(healthCheckOperation);\n+        Mockito.verify(operationQuery, times(0))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c202493d0fea70f357d0cceea1493f4417aec7f"}, "originalPosition": 128}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMjcxMDQ5", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/897#pullrequestreview-442271049", "createdAt": "2020-07-03T09:15:07Z", "commit": {"oid": "1c202493d0fea70f357d0cceea1493f4417aec7f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "638a980f0a6e2bfa2c7ea89a308f6b59d7aef742", "author": {"user": {"login": "IvanBorislavovDimitrov", "name": "Ivan Dimitrov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/638a980f0a6e2bfa2c7ea89a308f6b59d7aef742", "committedDate": "2020-07-03T09:17:21Z", "message": "Skip user filtering if needed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1c202493d0fea70f357d0cceea1493f4417aec7f", "author": {"user": {"login": "IvanBorislavovDimitrov", "name": "Ivan Dimitrov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/1c202493d0fea70f357d0cceea1493f4417aec7f", "committedDate": "2020-07-03T08:37:31Z", "message": "Skip user filtering if needed"}, "afterCommit": {"oid": "638a980f0a6e2bfa2c7ea89a308f6b59d7aef742", "author": {"user": {"login": "IvanBorislavovDimitrov", "name": "Ivan Dimitrov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/638a980f0a6e2bfa2c7ea89a308f6b59d7aef742", "committedDate": "2020-07-03T09:17:21Z", "message": "Skip user filtering if needed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMjc0Mzcy", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/897#pullrequestreview-442274372", "createdAt": "2020-07-03T09:20:16Z", "commit": {"oid": "638a980f0a6e2bfa2c7ea89a308f6b59d7aef742"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 952, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}