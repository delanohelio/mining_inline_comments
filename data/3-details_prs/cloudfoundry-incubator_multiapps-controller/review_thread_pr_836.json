{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMzc4MDg0", "number": 836, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDoxNzo1MlrODwbNdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDoxNzo1MlrODwbNdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMTA0MDUzOnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/resources/com/sap/cloud/lm/sl/cf/core/db/changelog/db-changelog-update_configuration_registry_clean_up_leftovers.xml", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDoxNzo1MlrOGDazGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMjo1MDoyNVrOGLWKRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzNzk3OQ==", "bodyText": "I am thinking about improve the ordering:\n-> ORDER BY provider_version DESC, id DESC\nThis will handle the situation when redeployment is done when sequence is changed.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/836#discussion_r406237979", "createdAt": "2020-04-09T14:17:52Z", "author": {"login": "boyan-velinov"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/resources/com/sap/cloud/lm/sl/cf/core/db/changelog/db-changelog-update_configuration_registry_clean_up_leftovers.xml", "diffHunk": "@@ -0,0 +1,33 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n+<databaseChangeLog xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\"\r\n+\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\r\n+\txsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\r\n+                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd\">\r\n+\t<changeSet author=\"sap.com\" id=\"db-changelog-update_configuration_registry_delete_null_space_id\">\r\n+        <delete tableName=\"configuration_registry\">\r\n+            <where>space_id IS NULL</where>\r\n+        </delete>\r\n+    </changeSet>\r\n+    <changeSet author=\"sap.com\" id=\"db-changelog-update_configuration_registry_delete_duplicated_by_space_id_and_provider_id\">\r\n+        <preConditions onFail=\"MARK_RAN\">\r\n+            <dbms type=\"postgresql\" />\r\n+        </preConditions>\r\n+        <sql>\r\n+  \t\t    DELETE FROM configuration_registry\r\n+\t\t\tWHERE id IN (\r\n+\t\t\t    SELECT\r\n+\t\t\t        id\r\n+\t\t\t    FROM (\r\n+\t\t\t        SELECT\r\n+\t\t\t            id,\r\n+\t\t\t            ROW_NUMBER() OVER w AS rnum\r\n+\t\t\t        FROM configuration_registry \r\n+\t\t\t        WINDOW w AS (\r\n+\t\t\t            PARTITION BY provider_nid, provider_id, space_id\r\n+\t\t\t            ORDER BY id DESC\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e3dd2652211ffde05a1004b396f7303cc166de4"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI2MDg4Nw==", "bodyText": "I'm not a fan of this SQL statement, because I'd have to read a lot of online information to understand it. Maybe we should convert this change to Java code and use the ConfigurationEntryService?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/836#discussion_r406260887", "createdAt": "2020-04-09T14:49:32Z", "author": {"login": "nictas"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/resources/com/sap/cloud/lm/sl/cf/core/db/changelog/db-changelog-update_configuration_registry_clean_up_leftovers.xml", "diffHunk": "@@ -0,0 +1,33 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n+<databaseChangeLog xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\"\r\n+\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\r\n+\txsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\r\n+                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd\">\r\n+\t<changeSet author=\"sap.com\" id=\"db-changelog-update_configuration_registry_delete_null_space_id\">\r\n+        <delete tableName=\"configuration_registry\">\r\n+            <where>space_id IS NULL</where>\r\n+        </delete>\r\n+    </changeSet>\r\n+    <changeSet author=\"sap.com\" id=\"db-changelog-update_configuration_registry_delete_duplicated_by_space_id_and_provider_id\">\r\n+        <preConditions onFail=\"MARK_RAN\">\r\n+            <dbms type=\"postgresql\" />\r\n+        </preConditions>\r\n+        <sql>\r\n+  \t\t    DELETE FROM configuration_registry\r\n+\t\t\tWHERE id IN (\r\n+\t\t\t    SELECT\r\n+\t\t\t        id\r\n+\t\t\t    FROM (\r\n+\t\t\t        SELECT\r\n+\t\t\t            id,\r\n+\t\t\t            ROW_NUMBER() OVER w AS rnum\r\n+\t\t\t        FROM configuration_registry \r\n+\t\t\t        WINDOW w AS (\r\n+\t\t\t            PARTITION BY provider_nid, provider_id, space_id\r\n+\t\t\t            ORDER BY id DESC\r", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzNzk3OQ=="}, "originalCommit": {"oid": "6e3dd2652211ffde05a1004b396f7303cc166de4"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU1MDU5Nw==", "bodyText": "as agreed offline, the sql will be removed since many of these duplicated configuration entries will be removed after re-deploy.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/836#discussion_r414550597", "createdAt": "2020-04-24T12:50:25Z", "author": {"login": "boyan-velinov"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/resources/com/sap/cloud/lm/sl/cf/core/db/changelog/db-changelog-update_configuration_registry_clean_up_leftovers.xml", "diffHunk": "@@ -0,0 +1,33 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n+<databaseChangeLog xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\"\r\n+\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\r\n+\txsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\r\n+                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd\">\r\n+\t<changeSet author=\"sap.com\" id=\"db-changelog-update_configuration_registry_delete_null_space_id\">\r\n+        <delete tableName=\"configuration_registry\">\r\n+            <where>space_id IS NULL</where>\r\n+        </delete>\r\n+    </changeSet>\r\n+    <changeSet author=\"sap.com\" id=\"db-changelog-update_configuration_registry_delete_duplicated_by_space_id_and_provider_id\">\r\n+        <preConditions onFail=\"MARK_RAN\">\r\n+            <dbms type=\"postgresql\" />\r\n+        </preConditions>\r\n+        <sql>\r\n+  \t\t    DELETE FROM configuration_registry\r\n+\t\t\tWHERE id IN (\r\n+\t\t\t    SELECT\r\n+\t\t\t        id\r\n+\t\t\t    FROM (\r\n+\t\t\t        SELECT\r\n+\t\t\t            id,\r\n+\t\t\t            ROW_NUMBER() OVER w AS rnum\r\n+\t\t\t        FROM configuration_registry \r\n+\t\t\t        WINDOW w AS (\r\n+\t\t\t            PARTITION BY provider_nid, provider_id, space_id\r\n+\t\t\t            ORDER BY id DESC\r", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzNzk3OQ=="}, "originalCommit": {"oid": "6e3dd2652211ffde05a1004b396f7303cc166de4"}, "originalPosition": 27}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 501, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}