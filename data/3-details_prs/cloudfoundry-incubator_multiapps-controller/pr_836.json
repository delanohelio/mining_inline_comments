{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMzc4MDg0", "number": 836, "title": "Clean leftovers from configuration registry", "bodyText": "", "createdAt": "2020-04-09T11:48:43Z", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/836", "merged": true, "mergeCommit": {"oid": "f313dd282e818dd0716f0d3fc1204a8b324e9451"}, "closed": true, "closedAt": "2020-04-28T06:51:36Z", "author": {"login": "boyan-velinov"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcV84CMABqjMyMTg0MDQ1MDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcb-M_8gFqTQwMTU0MjY0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "acdb0e4c950b8848abae7cc59ef7a5c348e514a9", "author": {"user": {"login": "boyan-velinov", "name": "Boyan Velinov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/acdb0e4c950b8848abae7cc59ef7a5c348e514a9", "committedDate": "2020-04-09T11:45:31Z", "message": "Clean leftovers from configuration registry"}, "afterCommit": {"oid": "6e3dd2652211ffde05a1004b396f7303cc166de4", "author": {"user": {"login": "boyan-velinov", "name": "Boyan Velinov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/6e3dd2652211ffde05a1004b396f7303cc166de4", "committedDate": "2020-04-09T13:42:56Z", "message": "Remove DeleteDiscontinuedConfigurationEntriesForAppSte\n\nThe step seems not useful because it deletes entries only for the existing\napplication that were created from last deployed MTA with that exact version.\nOther step DeleteDiscontinuedConfigurationEntriesStep should cover\nthat scenario as well - it deletes all entries that are not published by currend operation.\n\nJira: LMCROSSITXSADEPLOY-729"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwODM1MDQy", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/836#pullrequestreview-390835042", "createdAt": "2020-04-09T14:17:52Z", "commit": {"oid": "6e3dd2652211ffde05a1004b396f7303cc166de4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDoxNzo1MlrOGDazGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDoxNzo1MlrOGDazGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzNzk3OQ==", "bodyText": "I am thinking about improve the ordering:\n-> ORDER BY provider_version DESC, id DESC\nThis will handle the situation when redeployment is done when sequence is changed.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/836#discussion_r406237979", "createdAt": "2020-04-09T14:17:52Z", "author": {"login": "boyan-velinov"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/resources/com/sap/cloud/lm/sl/cf/core/db/changelog/db-changelog-update_configuration_registry_clean_up_leftovers.xml", "diffHunk": "@@ -0,0 +1,33 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n+<databaseChangeLog xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\"\r\n+\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\r\n+\txsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\r\n+                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd\">\r\n+\t<changeSet author=\"sap.com\" id=\"db-changelog-update_configuration_registry_delete_null_space_id\">\r\n+        <delete tableName=\"configuration_registry\">\r\n+            <where>space_id IS NULL</where>\r\n+        </delete>\r\n+    </changeSet>\r\n+    <changeSet author=\"sap.com\" id=\"db-changelog-update_configuration_registry_delete_duplicated_by_space_id_and_provider_id\">\r\n+        <preConditions onFail=\"MARK_RAN\">\r\n+            <dbms type=\"postgresql\" />\r\n+        </preConditions>\r\n+        <sql>\r\n+  \t\t    DELETE FROM configuration_registry\r\n+\t\t\tWHERE id IN (\r\n+\t\t\t    SELECT\r\n+\t\t\t        id\r\n+\t\t\t    FROM (\r\n+\t\t\t        SELECT\r\n+\t\t\t            id,\r\n+\t\t\t            ROW_NUMBER() OVER w AS rnum\r\n+\t\t\t        FROM configuration_registry \r\n+\t\t\t        WINDOW w AS (\r\n+\t\t\t            PARTITION BY provider_nid, provider_id, space_id\r\n+\t\t\t            ORDER BY id DESC\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e3dd2652211ffde05a1004b396f7303cc166de4"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7697dc4cabe7385a8d45c7d68ed115fbe004557a", "author": {"user": {"login": "boyan-velinov", "name": "Boyan Velinov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/7697dc4cabe7385a8d45c7d68ed115fbe004557a", "committedDate": "2020-04-24T12:34:23Z", "message": "Remove leftovers in configuration registry\n\nConfiguration entries with spaceId equals to NULL\nare entries for deleted spaces. Such entries are stored long time ago\nand when we created data termination service they were not migrated,\nsince spaceid was not found for the combination of org_name and space_name.\n\nJira: LMCROSSITXSADEPLOY-729"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32140b9088d825c5d1a1b6765a77c36bf65c6b42", "author": {"user": {"login": "boyan-velinov", "name": "Boyan Velinov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/32140b9088d825c5d1a1b6765a77c36bf65c6b42", "committedDate": "2020-04-24T12:34:23Z", "message": "Delete discontinued configuration entries by space GUID\n\nThe existing logic relies on combination of org and space names.\nspace and org name can be changed in time in such case entries\nremained as leftovers in configuration registry. The new logic relies on\nspaceId because it is unique.\n\nJira: LMCROSSITXSADEPLOY-729"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8454e33aa9e4aed3ad650e5d30a1576880496d7", "author": {"user": {"login": "boyan-velinov", "name": "Boyan Velinov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/c8454e33aa9e4aed3ad650e5d30a1576880496d7", "committedDate": "2020-04-24T12:34:23Z", "message": "Remove DeleteDiscontinuedConfigurationEntriesForAppStep\n\nThe step seems not useful because it deletes entries only for the existing\napplication that were created from last deployed MTA with that exact version.\nOther step DeleteDiscontinuedConfigurationEntriesStep should cover\nthat scenario as well - it deletes all entries that are not published by currend operation.\n\nJira: LMCROSSITXSADEPLOY-729"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6e3dd2652211ffde05a1004b396f7303cc166de4", "author": {"user": {"login": "boyan-velinov", "name": "Boyan Velinov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/6e3dd2652211ffde05a1004b396f7303cc166de4", "committedDate": "2020-04-09T13:42:56Z", "message": "Remove DeleteDiscontinuedConfigurationEntriesForAppSte\n\nThe step seems not useful because it deletes entries only for the existing\napplication that were created from last deployed MTA with that exact version.\nOther step DeleteDiscontinuedConfigurationEntriesStep should cover\nthat scenario as well - it deletes all entries that are not published by currend operation.\n\nJira: LMCROSSITXSADEPLOY-729"}, "afterCommit": {"oid": "c8454e33aa9e4aed3ad650e5d30a1576880496d7", "author": {"user": {"login": "boyan-velinov", "name": "Boyan Velinov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/c8454e33aa9e4aed3ad650e5d30a1576880496d7", "committedDate": "2020-04-24T12:34:23Z", "message": "Remove DeleteDiscontinuedConfigurationEntriesForAppStep\n\nThe step seems not useful because it deletes entries only for the existing\napplication that were created from last deployed MTA with that exact version.\nOther step DeleteDiscontinuedConfigurationEntriesStep should cover\nthat scenario as well - it deletes all entries that are not published by currend operation.\n\nJira: LMCROSSITXSADEPLOY-729"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b42712de5169d8d11d65028e7d20b6b2522bd96b", "author": {"user": {"login": "boyan-velinov", "name": "Boyan Velinov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/b42712de5169d8d11d65028e7d20b6b2522bd96b", "committedDate": "2020-04-24T16:03:42Z", "message": "Skip configuration entry creation for empty provided dependencies\n\n* Do not create configuration entries when provided dependencies do\nnot have any properties. So far al  v2 provided dependencies\nthat are not defined as public resulted in garbage in configuration registry.\nSuch configuration entries could not be used at all because they have empty content\n* Delete such entries without content from registry\n\nJira: LMCROSSITXSADEPLOY-729"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNTQyNjQ5", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/836#pullrequestreview-401542649", "createdAt": "2020-04-28T06:50:21Z", "commit": {"oid": "b42712de5169d8d11d65028e7d20b6b2522bd96b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 890, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}