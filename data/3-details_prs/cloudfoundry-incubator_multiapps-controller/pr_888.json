{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxOTk2NTM2", "number": 888, "title": "Fix cleanup of processes in Flowable tables", "bodyText": "Change logic for searching active operations in AbortProcessListener and\nadd new cleaner which will delete all left processes in act_ru_execution\ntable by TTL\nJIRA:LMCROSSITXSADEPLOY-2120", "createdAt": "2020-06-30T12:33:01Z", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/888", "merged": true, "mergeCommit": {"oid": "cf0b4cc41937856bfbd0ef9006492462dc0ebde5"}, "closed": true, "closedAt": "2020-07-01T07:51:56Z", "author": {"login": "theghost5800"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwVZINAFqTQzOTk4NjEyMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwlS38gBqjM1MDExMTU2Nzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5OTg2MTIy", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/888#pullrequestreview-439986122", "createdAt": "2020-06-30T12:58:13Z", "commit": {"oid": "6691e3424550e4985c3e75557076c2b4cd397978"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMjo1ODoxM1rOGq7EPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMzowOTowNFrOGq7flQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY2MTExNw==", "bodyText": "I think this will throw an exception if there's no process with this ID. Also rename the variable operationId to processId.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/888#discussion_r447661117", "createdAt": "2020-06-30T12:58:13Z", "author": {"login": "nictas"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/jobs/AbortedOperationsCleaner.java", "diffHunk": "@@ -56,18 +51,7 @@ public void execute(Date expirationTime) {\n     }\n \n     private boolean isInActiveState(String operationId) {\n-        Operation operation = getOperation(operationId);\n-        return operation != null && operation.getState() == null;\n-    }\n-\n-    private Operation getOperation(String operationId) {\n-        try {\n-            return operationService.createQuery()\n-                                   .processId(operationId)\n-                                   .singleResult();\n-        } catch (NoResultException e) {\n-            return null;\n-        }\n+        return flowableFacade.getProcessInstance(operationId) != null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6691e3424550e4985c3e75557076c2b4cd397978"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY2MjQ1OA==", "bodyText": "Flowable uses \"process\" as a term and not \"operation\". Operations exist only in our codebase and we're not using the OperationService here, so the current name is a little confusing and misleading. I suggest renaming this class to FlowableDataCleaner, which will be consistent with FlowableHistoricDataCleaner.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/888#discussion_r447662458", "createdAt": "2020-06-30T13:00:18Z", "author": {"login": "nictas"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/jobs/FlowableOperationsCleaner.java", "diffHunk": "@@ -0,0 +1,51 @@\n+package com.sap.cloud.lm.sl.cf.process.jobs;\n+\n+import java.text.MessageFormat;\n+import java.util.Date;\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import org.flowable.engine.runtime.ProcessInstance;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.core.annotation.Order;\n+\n+import com.sap.cloud.lm.sl.cf.process.Messages;\n+import com.sap.cloud.lm.sl.cf.process.flowable.FlowableFacade;\n+import com.sap.cloud.lm.sl.cf.web.api.model.Operation;\n+\n+@Named\n+@Order(30)\n+public class FlowableOperationsCleaner implements Cleaner {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6691e3424550e4985c3e75557076c2b4cd397978"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY2NDg2NQ==", "bodyText": "Does the formatting look that bad without this comment?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/888#discussion_r447664865", "createdAt": "2020-06-30T13:04:08Z", "author": {"login": "nictas"}, "path": "com.sap.cloud.lm.sl.cf.process/src/test/java/com/sap/cloud/lm/sl/cf/process/jobs/FlowableOperationsCleanerTest.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package com.sap.cloud.lm.sl.cf.process.jobs;\n+\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.flowable.engine.impl.persistence.entity.ExecutionEntityImpl;\n+import org.flowable.engine.runtime.ProcessInstance;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.Arguments;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import org.mockito.Mock;\n+import org.mockito.MockitoAnnotations;\n+\n+import com.sap.cloud.lm.sl.cf.process.flowable.FlowableFacade;\n+\n+public class FlowableOperationsCleanerTest {\n+\n+    @Mock\n+    private FlowableFacade flowableFacade;\n+\n+    private FlowableOperationsCleaner flowableOperationsCleaner;\n+\n+    @BeforeEach\n+    void setUp() {\n+        MockitoAnnotations.initMocks(this);\n+        flowableOperationsCleaner = new FlowableOperationsCleaner(flowableFacade);\n+    }\n+\n+    static Stream<Arguments> testDeleteInvocation() {\n+        // @formatter:off", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6691e3424550e4985c3e75557076c2b4cd397978"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY2NTg2Mw==", "bodyText": "Pass some real Date object here and test whether it's being passed to the Flowable facade.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/888#discussion_r447665863", "createdAt": "2020-06-30T13:05:35Z", "author": {"login": "nictas"}, "path": "com.sap.cloud.lm.sl.cf.process/src/test/java/com/sap/cloud/lm/sl/cf/process/jobs/FlowableOperationsCleanerTest.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package com.sap.cloud.lm.sl.cf.process.jobs;\n+\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.flowable.engine.impl.persistence.entity.ExecutionEntityImpl;\n+import org.flowable.engine.runtime.ProcessInstance;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.Arguments;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import org.mockito.Mock;\n+import org.mockito.MockitoAnnotations;\n+\n+import com.sap.cloud.lm.sl.cf.process.flowable.FlowableFacade;\n+\n+public class FlowableOperationsCleanerTest {\n+\n+    @Mock\n+    private FlowableFacade flowableFacade;\n+\n+    private FlowableOperationsCleaner flowableOperationsCleaner;\n+\n+    @BeforeEach\n+    void setUp() {\n+        MockitoAnnotations.initMocks(this);\n+        flowableOperationsCleaner = new FlowableOperationsCleaner(flowableFacade);\n+    }\n+\n+    static Stream<Arguments> testDeleteInvocation() {\n+        // @formatter:off\n+             return Stream.of(\n+                              Arguments.of(Arrays.asList(\"process-id-1\"), 1),\n+                              Arguments.of(Arrays.asList(\"process-id-1\", \"process-id-2\"), 2),\n+                              Arguments.of(Collections.emptyList(), 0)\n+             );\n+        // @formatter:on\n+    }\n+\n+    @ParameterizedTest\n+    @MethodSource\n+    void testDeleteInvocation(List<String> processIds, int deleteTimes) {\n+        prepareFlowableFacade(processIds);\n+        flowableOperationsCleaner.execute(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6691e3424550e4985c3e75557076c2b4cd397978"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY2NjE2OQ==", "bodyText": "Make a separate verification call for each process ID in the list.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/888#discussion_r447666169", "createdAt": "2020-06-30T13:06:05Z", "author": {"login": "nictas"}, "path": "com.sap.cloud.lm.sl.cf.process/src/test/java/com/sap/cloud/lm/sl/cf/process/jobs/FlowableOperationsCleanerTest.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package com.sap.cloud.lm.sl.cf.process.jobs;\n+\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.flowable.engine.impl.persistence.entity.ExecutionEntityImpl;\n+import org.flowable.engine.runtime.ProcessInstance;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.Arguments;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import org.mockito.Mock;\n+import org.mockito.MockitoAnnotations;\n+\n+import com.sap.cloud.lm.sl.cf.process.flowable.FlowableFacade;\n+\n+public class FlowableOperationsCleanerTest {\n+\n+    @Mock\n+    private FlowableFacade flowableFacade;\n+\n+    private FlowableOperationsCleaner flowableOperationsCleaner;\n+\n+    @BeforeEach\n+    void setUp() {\n+        MockitoAnnotations.initMocks(this);\n+        flowableOperationsCleaner = new FlowableOperationsCleaner(flowableFacade);\n+    }\n+\n+    static Stream<Arguments> testDeleteInvocation() {\n+        // @formatter:off\n+             return Stream.of(\n+                              Arguments.of(Arrays.asList(\"process-id-1\"), 1),\n+                              Arguments.of(Arrays.asList(\"process-id-1\", \"process-id-2\"), 2),\n+                              Arguments.of(Collections.emptyList(), 0)\n+             );\n+        // @formatter:on\n+    }\n+\n+    @ParameterizedTest\n+    @MethodSource\n+    void testDeleteInvocation(List<String> processIds, int deleteTimes) {\n+        prepareFlowableFacade(processIds);\n+        flowableOperationsCleaner.execute(null);\n+        verify(flowableFacade, times(deleteTimes)).deleteProcessInstance(anyString(), anyString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6691e3424550e4985c3e75557076c2b4cd397978"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY2NjUyOA==", "bodyText": "Use @InjectMocks instead of creating the object \"manually\" in the setUp method.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/888#discussion_r447666528", "createdAt": "2020-06-30T13:06:35Z", "author": {"login": "nictas"}, "path": "com.sap.cloud.lm.sl.cf.process/src/test/java/com/sap/cloud/lm/sl/cf/process/jobs/FlowableOperationsCleanerTest.java", "diffHunk": "@@ -0,0 +1,68 @@\n+package com.sap.cloud.lm.sl.cf.process.jobs;\n+\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.flowable.engine.impl.persistence.entity.ExecutionEntityImpl;\n+import org.flowable.engine.runtime.ProcessInstance;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.Arguments;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import org.mockito.Mock;\n+import org.mockito.MockitoAnnotations;\n+\n+import com.sap.cloud.lm.sl.cf.process.flowable.FlowableFacade;\n+\n+public class FlowableOperationsCleanerTest {\n+\n+    @Mock\n+    private FlowableFacade flowableFacade;\n+\n+    private FlowableOperationsCleaner flowableOperationsCleaner;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6691e3424550e4985c3e75557076c2b4cd397978"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzY2ODExNw==", "bodyText": "Don't use the term \"operation\". Use \"process\" instead.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/888#discussion_r447668117", "createdAt": "2020-06-30T13:09:04Z", "author": {"login": "nictas"}, "path": "com.sap.cloud.lm.sl.cf.process/src/test/java/com/sap/cloud/lm/sl/cf/process/jobs/AbortedOperationsCleanerTest.java", "diffHunk": "@@ -80,56 +78,53 @@ public void testExecute() {\n \n     @Test\n     public void testExecuteWithMixedOperations() {\n-        prepareMocksWithOperations(Arrays.asList(createOperation(\"foo\", null), createOperation(\"bar\", Operation.State.FINISHED)));\n+        prepareMocksWithOperations(Arrays.asList(new CustomOperation(\"foo\", true), new CustomOperation(\"bar\", false)));\n \n         abortedOperationsCleaner.execute(new Date()); // Passed argument is not used.\n \n-        Mockito.verify(operationService, Mockito.times(2))\n-               .createQuery();\n+        Mockito.verify(flowableFacade, Mockito.times(2))\n+               .getProcessInstance(anyString());\n         Mockito.verify(flowableFacade)\n                .deleteProcessInstance(\"foo\", Operation.State.ABORTED.name());\n         Mockito.verify(flowableFacade, Mockito.never())\n                .deleteProcessInstance(\"bar\", Operation.State.ABORTED.name());\n     }\n \n-    private void prepareMocksWithOperations(List<Operation> operations) {\n+    private void prepareMocksWithOperations(List<CustomOperation> operations) {\n         HistoricOperationEventQuery historicOperationEventQuery = Mockito.mock(HistoricOperationEventQuery.class, Mockito.RETURNS_SELF);\n         Mockito.when(historicOperationEventQuery.list())\n                .thenReturn(createAbortedEvents(operations));\n         Mockito.when(historicOperationEventService.createQuery())\n                .thenReturn(historicOperationEventQuery);\n+        operations.stream()\n+                  .filter(operation -> operation.isActive)\n+                  .forEach(operation -> Mockito.when(flowableFacade.getProcessInstance(operation.processId))\n+                                               .thenReturn(Mockito.mock(ProcessInstance.class)));\n \n-        OperationQuery commonOperationQuery = Mockito.mock(OperationQuery.class, Mockito.RETURNS_SELF);\n-        Mockito.when(operationService.createQuery())\n-               .thenReturn(commonOperationQuery);\n-        for (Operation operation : operations) {\n-            OperationQuery operationQuery = Mockito.mock(OperationQuery.class, Mockito.RETURNS_SELF);\n-            Mockito.doReturn(operation)\n-                   .when(operationQuery)\n-                   .singleResult();\n-            Mockito.when(commonOperationQuery.processId(operation.getProcessId()))\n-                   .thenReturn(operationQuery);\n-        }\n     }\n \n-    private List<HistoricOperationEvent> createAbortedEvents(List<Operation> operations) {\n+    private List<HistoricOperationEvent> createAbortedEvents(List<CustomOperation> operations) {\n         return operations.stream()\n                          .map(this::createAbortedEvent)\n                          .collect(Collectors.toList());\n     }\n \n-    private HistoricOperationEvent createAbortedEvent(Operation operation) {\n+    private HistoricOperationEvent createAbortedEvent(CustomOperation operation) {\n         return ImmutableHistoricOperationEvent.builder()\n-                                              .processId(operation.getProcessId())\n+                                              .processId(operation.processId)\n                                               .type(EventType.ABORTED)\n                                               .build();\n     }\n \n-    private Operation createOperation(String processId, State state) {\n-        return ImmutableOperation.builder()\n-                                 .processId(processId)\n-                                 .state(state)\n-                                 .build();\n+    private class CustomOperation {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6691e3424550e4985c3e75557076c2b4cd397978"}, "originalPosition": 143}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNTg3NzE5", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/888#pullrequestreview-440587719", "createdAt": "2020-07-01T06:46:51Z", "commit": {"oid": "678399fee994d784db639de680143c5d912d58ef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "560de88501670e86af15705475a326ae13e2a5b9", "author": {"user": {"login": "theghost5800", "name": "Kristian Atanasov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/560de88501670e86af15705475a326ae13e2a5b9", "committedDate": "2020-07-01T07:34:13Z", "message": "Fix cleanup of processes in Flowable tables\n\nChange logic for searching active operations in AbortProcessListener and\nadd new cleaner which will delete all left processes in act_ru_execution\ntable by TTL\n\nJIRA:LMCROSSITXSADEPLOY-2120"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "678399fee994d784db639de680143c5d912d58ef", "author": {"user": {"login": "theghost5800", "name": "Kristian Atanasov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/678399fee994d784db639de680143c5d912d58ef", "committedDate": "2020-06-30T15:38:50Z", "message": "Refactor"}, "afterCommit": {"oid": "560de88501670e86af15705475a326ae13e2a5b9", "author": {"user": {"login": "theghost5800", "name": "Kristian Atanasov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/560de88501670e86af15705475a326ae13e2a5b9", "committedDate": "2020-07-01T07:34:13Z", "message": "Fix cleanup of processes in Flowable tables\n\nChange logic for searching active operations in AbortProcessListener and\nadd new cleaner which will delete all left processes in act_ru_execution\ntable by TTL\n\nJIRA:LMCROSSITXSADEPLOY-2120"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 949, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}