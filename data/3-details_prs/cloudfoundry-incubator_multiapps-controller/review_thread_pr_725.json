{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyNTk1NDg1", "number": 725, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNTowODowN1rODX4WCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNToxMjowOVrODX4brQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MzY2OTg0OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/StageAppStep.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNTowODowN1rOFdaxug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxMTo1Mzo1OVrOFd15sQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5MTczOA==", "bodyText": "Can we avoid the fetch of this app?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/725#discussion_r366391738", "createdAt": "2020-01-14T15:08:07Z", "author": {"login": "nictas"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/StageAppStep.java", "diffHunk": "@@ -26,8 +27,11 @@\n \n     @Override\n     protected StepPhase executeAsyncStep(ExecutionWrapper execution) {\n-        CloudApplication app = StepsUtil.getApp(execution.getContext());\n-        ApplicationStager applicationStager = new ApplicationStager(execution.getControllerClient());\n+        String appName = StepsUtil.getApp(execution.getContext())\n+                                  .getName();\n+        CloudControllerClient client = execution.getControllerClient();\n+        CloudApplication app = client.getApplication(appName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b7bc26ccb496ce2e272b4815045d80c9f771d3c"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjgzNjE0NQ==", "bodyText": "We need the GUID...\nIt is in the ApplicationStager app.getMetadata().getGuid()", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/725#discussion_r366836145", "createdAt": "2020-01-15T11:53:59Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/StageAppStep.java", "diffHunk": "@@ -26,8 +27,11 @@\n \n     @Override\n     protected StepPhase executeAsyncStep(ExecutionWrapper execution) {\n-        CloudApplication app = StepsUtil.getApp(execution.getContext());\n-        ApplicationStager applicationStager = new ApplicationStager(execution.getControllerClient());\n+        String appName = StepsUtil.getApp(execution.getContext())\n+                                  .getName();\n+        CloudControllerClient client = execution.getControllerClient();\n+        CloudApplication app = client.getApplication(appName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5MTczOA=="}, "originalCommit": {"oid": "0b7bc26ccb496ce2e272b4815045d80c9f771d3c"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MzY3NTY5OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.process/src/test/java/com/sap/cloud/lm/sl/cf/process/util/ApplicationStagerTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNTowOTo0NFrOFda1WQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNTowOTo0NFrOFda1WQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5MjY2NQ==", "bodyText": "There are two ands in this variable name.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/725#discussion_r366392665", "createdAt": "2020-01-14T15:09:44Z", "author": {"login": "nictas"}, "path": "com.sap.cloud.lm.sl.cf.process/src/test/java/com/sap/cloud/lm/sl/cf/process/util/ApplicationStagerTest.java", "diffHunk": "@@ -214,10 +218,49 @@ public void testBindDropletToApp() {\n     }\n \n     @Test\n-    public void testStageAppIfThereIsNoUploadToken() {\n+    public void testStageAppIfThereIsNoUploadTokenAndThereAreNoPackages() {\n         Mockito.when(context.getVariable(Constants.VAR_UPLOAD_TOKEN))\n                .thenReturn(null);\n-        assertEquals(StepPhase.DONE, applicationStager.stageApp(context, null, null));\n+        UUID testApplicationGuid = UUID.randomUUID();\n+        CloudApplication testApplication = ImmutableCloudApplication.builder()\n+                                                                    .metadata(ImmutableCloudMetadata.builder()\n+                                                                                                    .guid(testApplicationGuid)\n+                                                                                                    .build())\n+                                                                    .name(\"test-app\")\n+                                                                    .build();\n+        Mockito.when(client.getPackagesForApplication(Mockito.eq(testApplicationGuid), Mockito.any()))\n+               .thenReturn(Collections.emptyList());\n+\n+        Mockito.verifyNoInteractions(stepLogger);\n+        assertEquals(StepPhase.DONE, applicationStager.stageApp(context, testApplication, stepLogger));\n+    }\n+\n+    @Test\n+    public void testStageAppIfThereIsNoUploadTokenAndThereIsOnlyOnePackage() {\n+        Mockito.when(context.getVariable(Constants.VAR_UPLOAD_TOKEN))\n+               .thenReturn(null);\n+        UUID packageGuid = UUID.randomUUID();\n+        UUID testApplicationGuid = UUID.randomUUID();\n+        CloudApplication testApplication = ImmutableCloudApplication.builder()\n+                                                                    .metadata(ImmutableCloudMetadata.builder()\n+                                                                                                    .guid(testApplicationGuid)\n+                                                                                                    .build())\n+                                                                    .name(\"test-app\")\n+                                                                    .build();\n+        CloudPackage andAndOnlyApplicationPackage = ImmutableCloudPackage.builder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b7bc26ccb496ce2e272b4815045d80c9f771d3c"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MzY4NDI5OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ApplicationStager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNToxMjowOVrOFda69w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNToxMjowOVrOFda69w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM5NDEwMw==", "bodyText": "Do uploadToken.getPackageGuid() here and remove the stageApplication method overload below.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/725#discussion_r366394103", "createdAt": "2020-01-14T15:12:09Z", "author": {"login": "nictas"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/util/ApplicationStager.java", "diffHunk": "@@ -133,11 +137,28 @@ public void bindDropletToApplication(DelegateExecution context, UUID appGuid) {\n \n     public StepPhase stageApp(DelegateExecution context, CloudApplication app, StepLogger stepLogger) {\n         UploadToken uploadToken = StepsUtil.getUploadToken(context);\n-        if (uploadToken == null) {\n-            return StepPhase.DONE;\n+        if (uploadToken != null) {\n+            stepLogger.debug(Messages.UPLOAD_TOKEN_FOR_APPLICATION_0_1, app.getName(), JsonUtil.toJson(uploadToken, true));\n+            return stageApplication(context, app, stepLogger, uploadToken);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b7bc26ccb496ce2e272b4815045d80c9f771d3c"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 572, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}