{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2MDcwNjYy", "number": 926, "title": "Fix update of service instance metadata", "bodyText": "", "createdAt": "2020-08-11T12:23:17Z", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/926", "merged": true, "mergeCommit": {"oid": "2303981b49cdf6fcce0fc1bc0f4743d3cf774270"}, "closed": true, "closedAt": "2020-08-11T15:47:28Z", "author": {"login": "nictas"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc918SigFqTQ2NTAxMjU3Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc93_1fABqjM2NDM1NjQ0NjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MDEyNTcz", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/926#pullrequestreview-465012573", "createdAt": "2020-08-11T12:24:15Z", "commit": {"oid": "9c9c27302f82ce3f6b883788b2e6785f4db1fc57"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMjoyNDoxNVrOG-1Yeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMjoyNjoxMVrOG-1ceA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODUzOTUxNA==", "bodyText": "The unit tests fail after this change. I'll fix'em after I get some lunch.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/926#discussion_r468539514", "createdAt": "2020-08-11T12:24:15Z", "author": {"login": "nictas"}, "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/CreateServiceStep.java", "diffHunk": "@@ -95,20 +92,10 @@ private void processServiceCreationFailure(ProcessContext context, CloudServiceI\n                              ExceptionMessageTailMapper.map(configuration, CloudComponents.SERVICE_BROKERS, service.getLabel()));\n     }\n \n-    private void updateServiceMetadata(CloudServiceInstanceExtended serviceToProcess, CloudControllerClient client) {\n-        ImmutableCloudServiceInstance serviceWithMetadata = ImmutableCloudServiceInstance.copyOf(serviceToProcess);\n-        CloudMetadata serviceMeta = client.getServiceInstance(serviceWithMetadata.getName())\n-                                          .getMetadata();\n-        serviceWithMetadata = serviceWithMetadata.withMetadata(serviceMeta);\n-        client.updateServiceInstanceMetadata(serviceWithMetadata.getMetadata()\n-                                                                .getGuid(),\n-                                             serviceWithMetadata.getV3Metadata());\n-    }\n-\n     @Override\n     protected List<AsyncExecution> getAsyncStepExecutions(ProcessContext context) {\n-        return Collections.singletonList(new PollServiceCreateOrUpdateOperationsExecution(getServiceOperationGetter(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c9c27302f82ce3f6b883788b2e6785f4db1fc57"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODUzOTkzMQ==", "bodyText": "Will be extracted in the Messages class after I get some lunch.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/926#discussion_r468539931", "createdAt": "2020-08-11T12:25:03Z", "author": {"login": "nictas"}, "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/UpdateServiceMetadataExecution.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package org.cloudfoundry.multiapps.controller.process.steps;\n+\n+import java.text.MessageFormat;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudMetadata;\n+import org.cloudfoundry.client.lib.domain.CloudServiceInstance;\n+import org.cloudfoundry.client.lib.domain.ImmutableCloudServiceInstance;\n+import org.cloudfoundry.multiapps.controller.client.lib.domain.CloudServiceInstanceExtended;\n+import org.cloudfoundry.multiapps.controller.process.variables.Variables;\n+\n+public class UpdateServiceMetadataExecution implements AsyncExecution {\n+\n+    @Override\n+    public AsyncExecutionState execute(ProcessContext context) {\n+        CloudServiceInstanceExtended serviceInstance = context.getVariable(Variables.SERVICE_TO_PROCESS);\n+        updateMetadata(context.getControllerClient(), serviceInstance);\n+        return AsyncExecutionState.FINISHED;\n+    }\n+\n+    private void updateMetadata(CloudControllerClient client, CloudServiceInstanceExtended serviceInstance) {\n+        CloudMetadata serviceMetadata = client.getServiceInstance(serviceInstance.getName())\n+                                              .getMetadata();\n+        CloudServiceInstance serviceWithMetadata = ImmutableCloudServiceInstance.copyOf(serviceInstance)\n+                                                                                .withMetadata(serviceMetadata);\n+        client.updateServiceInstanceMetadata(serviceWithMetadata.getMetadata()\n+                                                                .getGuid(),\n+                                             serviceWithMetadata.getV3Metadata());\n+    }\n+\n+    @Override\n+    public String getPollingErrorMessage(ProcessContext context) {\n+        CloudServiceInstanceExtended serviceInstance = context.getVariable(Variables.SERVICE_TO_PROCESS);\n+        return MessageFormat.format(\"Could not update metadata of service instance \\\"{0}\\\"\", serviceInstance.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c9c27302f82ce3f6b883788b2e6785f4db1fc57"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU0MDUzNg==", "bodyText": "Don't get this metadata confused with the V3 metadata. This one is just the V2 metadata of the resource that includes its GUID, created/updated timestamps, etc. The V3 metadata comes from the getV3Metadata() method.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/926#discussion_r468540536", "createdAt": "2020-08-11T12:26:11Z", "author": {"login": "nictas"}, "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/UpdateServiceMetadataExecution.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package org.cloudfoundry.multiapps.controller.process.steps;\n+\n+import java.text.MessageFormat;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudMetadata;\n+import org.cloudfoundry.client.lib.domain.CloudServiceInstance;\n+import org.cloudfoundry.client.lib.domain.ImmutableCloudServiceInstance;\n+import org.cloudfoundry.multiapps.controller.client.lib.domain.CloudServiceInstanceExtended;\n+import org.cloudfoundry.multiapps.controller.process.variables.Variables;\n+\n+public class UpdateServiceMetadataExecution implements AsyncExecution {\n+\n+    @Override\n+    public AsyncExecutionState execute(ProcessContext context) {\n+        CloudServiceInstanceExtended serviceInstance = context.getVariable(Variables.SERVICE_TO_PROCESS);\n+        updateMetadata(context.getControllerClient(), serviceInstance);\n+        return AsyncExecutionState.FINISHED;\n+    }\n+\n+    private void updateMetadata(CloudControllerClient client, CloudServiceInstanceExtended serviceInstance) {\n+        CloudMetadata serviceMetadata = client.getServiceInstance(serviceInstance.getName())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c9c27302f82ce3f6b883788b2e6785f4db1fc57"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MDIzNjcz", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/926#pullrequestreview-465023673", "createdAt": "2020-08-11T12:39:41Z", "commit": {"oid": "9c9c27302f82ce3f6b883788b2e6785f4db1fc57"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MDI0ODYz", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/926#pullrequestreview-465024863", "createdAt": "2020-08-11T12:41:24Z", "commit": {"oid": "9c9c27302f82ce3f6b883788b2e6785f4db1fc57"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMjo0MToyNFrOG-19ZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMjo0MToyNFrOG-19ZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU0ODk2NA==", "bodyText": "We should ensure that it will be last on the list of other executions somehow.\nI dont have perfect solutions but there are two options:\n\nunit test\nshort comment", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/926#discussion_r468548964", "createdAt": "2020-08-11T12:41:24Z", "author": {"login": "boyan-velinov"}, "path": "multiapps-controller-process/src/main/java/org/cloudfoundry/multiapps/controller/process/steps/CreateServiceStep.java", "diffHunk": "@@ -95,20 +92,10 @@ private void processServiceCreationFailure(ProcessContext context, CloudServiceI\n                              ExceptionMessageTailMapper.map(configuration, CloudComponents.SERVICE_BROKERS, service.getLabel()));\n     }\n \n-    private void updateServiceMetadata(CloudServiceInstanceExtended serviceToProcess, CloudControllerClient client) {\n-        ImmutableCloudServiceInstance serviceWithMetadata = ImmutableCloudServiceInstance.copyOf(serviceToProcess);\n-        CloudMetadata serviceMeta = client.getServiceInstance(serviceWithMetadata.getName())\n-                                          .getMetadata();\n-        serviceWithMetadata = serviceWithMetadata.withMetadata(serviceMeta);\n-        client.updateServiceInstanceMetadata(serviceWithMetadata.getMetadata()\n-                                                                .getGuid(),\n-                                             serviceWithMetadata.getV3Metadata());\n-    }\n-\n     @Override\n     protected List<AsyncExecution> getAsyncStepExecutions(ProcessContext context) {\n-        return Collections.singletonList(new PollServiceCreateOrUpdateOperationsExecution(getServiceOperationGetter(),\n-                                                                                          getServiceProgressReporter()));\n+        return Arrays.asList(new PollServiceCreateOrUpdateOperationsExecution(getServiceOperationGetter(), getServiceProgressReporter()),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c9c27302f82ce3f6b883788b2e6785f4db1fc57"}, "originalPosition": 44}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c9c27302f82ce3f6b883788b2e6785f4db1fc57", "author": {"user": {"login": "nictas", "name": "Alexander Tsvetkov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/9c9c27302f82ce3f6b883788b2e6785f4db1fc57", "committedDate": "2020-08-11T12:22:48Z", "message": "Fix update of service instance metadata"}, "afterCommit": {"oid": "a7251806ede12b08e5678fddbb8271720abef1b3", "author": {"user": {"login": "nictas", "name": "Alexander Tsvetkov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/a7251806ede12b08e5678fddbb8271720abef1b3", "committedDate": "2020-08-11T14:36:16Z", "message": "Fix update of service instance metadata"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MTM1ODMz", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/926#pullrequestreview-465135833", "createdAt": "2020-08-11T14:40:46Z", "commit": {"oid": "a7251806ede12b08e5678fddbb8271720abef1b3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7251806ede12b08e5678fddbb8271720abef1b3", "author": {"user": {"login": "nictas", "name": "Alexander Tsvetkov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/a7251806ede12b08e5678fddbb8271720abef1b3", "committedDate": "2020-08-11T14:36:16Z", "message": "Fix update of service instance metadata"}, "afterCommit": {"oid": "6cb070df90ae6ebb5c4b86927e82e79f804b8a91", "author": {"user": {"login": "nictas", "name": "Alexander Tsvetkov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/6cb070df90ae6ebb5c4b86927e82e79f804b8a91", "committedDate": "2020-08-11T14:43:08Z", "message": "Fix update of service instance metadata\n\nThe update of service instance metadata fails if done immediately after\ntriggering an asynchronous creation of the service instance."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e72e28292641e61b41e7c6eb389e05e6ef20718", "author": {"user": {"login": "nictas", "name": "Alexander Tsvetkov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/6e72e28292641e61b41e7c6eb389e05e6ef20718", "committedDate": "2020-08-11T14:47:37Z", "message": "Fix update of service instance metadata\n\nThe metadata update fails when there's an ongoing operation for the\nservice instance."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MTQ0MDMz", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/926#pullrequestreview-465144033", "createdAt": "2020-08-11T14:48:58Z", "commit": {"oid": "6cb070df90ae6ebb5c4b86927e82e79f804b8a91"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6cb070df90ae6ebb5c4b86927e82e79f804b8a91", "author": {"user": {"login": "nictas", "name": "Alexander Tsvetkov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/6cb070df90ae6ebb5c4b86927e82e79f804b8a91", "committedDate": "2020-08-11T14:43:08Z", "message": "Fix update of service instance metadata\n\nThe update of service instance metadata fails if done immediately after\ntriggering an asynchronous creation of the service instance."}, "afterCommit": {"oid": "6e72e28292641e61b41e7c6eb389e05e6ef20718", "author": {"user": {"login": "nictas", "name": "Alexander Tsvetkov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/6e72e28292641e61b41e7c6eb389e05e6ef20718", "committedDate": "2020-08-11T14:47:37Z", "message": "Fix update of service instance metadata\n\nThe metadata update fails when there's an ongoing operation for the\nservice instance."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 772, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}