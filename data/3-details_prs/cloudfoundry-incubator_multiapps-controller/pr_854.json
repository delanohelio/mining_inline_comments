{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2NzMxMzM2", "number": 854, "title": "Fix cases when the processes are already deleted", "bodyText": "Description:\nWhen the CleanUp job is fired more than two times, the already deleted operations are retrieved from the database as part of the request. When this happens, the logic in this cleaner is trying to delete the operation without checking whether it is presented in the database or not.\nThis commit fixes this problem by adding additional check whether the operation exists.\nCause:\nCould result in growing database of operations and non-deleted Flowable processes.\nIssue:\nhttps://jtrack.wdf.sap.corp/browse/NGPBUG-116635", "createdAt": "2020-05-12T13:37:20Z", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/854", "merged": true, "mergeCommit": {"oid": "59ef77d7892608cc44c3b13771c801cf3ddc5c65"}, "closed": true, "closedAt": "2020-05-13T12:39:18Z", "author": {"login": "enchobelezirev"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgkBpBAH2gAyNDE2NzMxMzM2OjA3Yzc2MWJjZGJlZjliNjQ1YzBhMjJlZWY1NWZhNzk2NWNjYjliZDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcg3a9WgFqTQxMDg0MjI1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "07c761bcdbef9b645c0a22eef55fa7965ccb9bd6", "author": {"user": {"login": "enchobelezirev", "name": "Encho Belezirev"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/07c761bcdbef9b645c0a22eef55fa7965ccb9bd6", "committedDate": "2020-05-12T13:10:02Z", "message": "Fix cases when the processes are already deleted"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNjU3ODg3", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/854#pullrequestreview-410657887", "createdAt": "2020-05-13T07:31:06Z", "commit": {"oid": "5198ae3c010681cbcf9ba2a8dc8b89ccec37eabc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNzozMTowNlrOGUk4Qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNzozMTowNlrOGUk4Qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDIyODkzMA==", "bodyText": "The name deleteOperation is a little bit misleading for me because OperationsCleanerActions.abortOperation is used in OperationCleaner. Afterwards records in operation table for finished old operations are deleted.\nOne can be mislead that the current function \"deleteOperation\" will do the required job after abortOperation() s but it makes changes in flowable.\nSo we can rename it to note that it make changes in flowable, e.g. \"abortFlowableProcess\" or something similar", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/854#discussion_r424228930", "createdAt": "2020-05-13T07:31:06Z", "author": {"login": "boyan-velinov"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/jobs/OperationsCleanerActions.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.sap.cloud.lm.sl.cf.process.jobs;\n+\n+import static java.text.MessageFormat.format;\n+\n+import java.text.MessageFormat;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.sap.cloud.lm.sl.cf.process.Messages;\n+import com.sap.cloud.lm.sl.cf.process.flowable.AbortProcessAction;\n+import com.sap.cloud.lm.sl.cf.process.flowable.FlowableFacade;\n+import com.sap.cloud.lm.sl.cf.process.flowable.ProcessAction;\n+import com.sap.cloud.lm.sl.cf.process.flowable.ProcessActionRegistry;\n+import com.sap.cloud.lm.sl.cf.web.api.model.Operation;\n+\n+@Named\n+public class OperationsCleanerActions {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(OperationsCleanerActions.class);\n+\n+    private final FlowableFacade flowableFacade;\n+    private final ProcessActionRegistry processActionRegistry;\n+\n+    @Inject\n+    public OperationsCleanerActions(FlowableFacade flowableFacade, ProcessActionRegistry processActionRegistry) {\n+        this.flowableFacade = flowableFacade;\n+        this.processActionRegistry = processActionRegistry;\n+    }\n+\n+    public void abortOperation(Operation operation) {\n+        ProcessAction abortAction = processActionRegistry.getAction(AbortProcessAction.ACTION_ID_ABORT);\n+        String processId = operation.getProcessId();\n+        LOGGER.debug(CleanUpJob.LOG_MARKER, format(Messages.ABORTING_OPERATION_0, processId));\n+        abortAction.execute(null, processId);\n+        deleteOperation(operation);\n+    }\n+\n+    public void deleteOperation(Operation operation) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5198ae3c010681cbcf9ba2a8dc8b89ccec37eabc"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNzUxNTI0", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/854#pullrequestreview-410751524", "createdAt": "2020-05-13T09:31:50Z", "commit": {"oid": "5198ae3c010681cbcf9ba2a8dc8b89ccec37eabc"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwOTozMTo1MFrOGUpZAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwOTozMTo1MFrOGUpZAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDMwMjg0OA==", "bodyText": "Good, let's use the proposed name deleteFlowableProcess", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/854#discussion_r424302848", "createdAt": "2020-05-13T09:31:50Z", "author": {"login": "boyan-velinov"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/jobs/OperationsCleanerActions.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package com.sap.cloud.lm.sl.cf.process.jobs;\n+\n+import static java.text.MessageFormat.format;\n+\n+import java.text.MessageFormat;\n+\n+import javax.inject.Inject;\n+import javax.inject.Named;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.sap.cloud.lm.sl.cf.process.Messages;\n+import com.sap.cloud.lm.sl.cf.process.flowable.AbortProcessAction;\n+import com.sap.cloud.lm.sl.cf.process.flowable.FlowableFacade;\n+import com.sap.cloud.lm.sl.cf.process.flowable.ProcessAction;\n+import com.sap.cloud.lm.sl.cf.process.flowable.ProcessActionRegistry;\n+import com.sap.cloud.lm.sl.cf.web.api.model.Operation;\n+\n+@Named\n+public class OperationsCleanerActions {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(OperationsCleanerActions.class);\n+\n+    private final FlowableFacade flowableFacade;\n+    private final ProcessActionRegistry processActionRegistry;\n+\n+    @Inject\n+    public OperationsCleanerActions(FlowableFacade flowableFacade, ProcessActionRegistry processActionRegistry) {\n+        this.flowableFacade = flowableFacade;\n+        this.processActionRegistry = processActionRegistry;\n+    }\n+\n+    public void abortOperation(Operation operation) {\n+        ProcessAction abortAction = processActionRegistry.getAction(AbortProcessAction.ACTION_ID_ABORT);\n+        String processId = operation.getProcessId();\n+        LOGGER.debug(CleanUpJob.LOG_MARKER, format(Messages.ABORTING_OPERATION_0, processId));\n+        abortAction.execute(null, processId);\n+        deleteOperation(operation);\n+    }\n+\n+    public void deleteOperation(Operation operation) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDIyODkzMA=="}, "originalCommit": {"oid": "5198ae3c010681cbcf9ba2a8dc8b89ccec37eabc"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be62635dd5b03c49ae3eb4e290d3e1a2b4aa03c2", "author": {"user": {"login": "enchobelezirev", "name": "Encho Belezirev"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/be62635dd5b03c49ae3eb4e290d3e1a2b4aa03c2", "committedDate": "2020-05-13T11:43:37Z", "message": "Change order of AbortedOperationsCleaner"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5198ae3c010681cbcf9ba2a8dc8b89ccec37eabc", "author": {"user": {"login": "enchobelezirev", "name": "Encho Belezirev"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/5198ae3c010681cbcf9ba2a8dc8b89ccec37eabc", "committedDate": "2020-05-13T07:15:15Z", "message": "Fix inconsistencies between AbortedOperationsCleaner and OperationsCleaner"}, "afterCommit": {"oid": "be62635dd5b03c49ae3eb4e290d3e1a2b4aa03c2", "author": {"user": {"login": "enchobelezirev", "name": "Encho Belezirev"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/be62635dd5b03c49ae3eb4e290d3e1a2b4aa03c2", "committedDate": "2020-05-13T11:43:37Z", "message": "Change order of AbortedOperationsCleaner"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwODQyMjU0", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/854#pullrequestreview-410842254", "createdAt": "2020-05-13T11:45:53Z", "commit": {"oid": "be62635dd5b03c49ae3eb4e290d3e1a2b4aa03c2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 913, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}