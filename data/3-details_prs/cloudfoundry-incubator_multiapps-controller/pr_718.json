{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5ODg1NjA2", "number": 718, "title": "Build tree to get all leaf nodes to abort process", "bodyText": "Description:\nWhen process is aborted, AbortProcessAction should wait\nuntil all running subprocess have deadletter jobs.\nSo far AbortProcessAction do not wait and delete the process\nhierarchy which lead to deadlock in DB.\nJira: LMCROSSITXSADEPLOY-1761", "createdAt": "2020-01-07T08:47:57Z", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/718", "merged": true, "mergeCommit": {"oid": "457171860e1d1c45d3bb8e561b88572b8c2ee447"}, "closed": true, "closedAt": "2020-01-09T11:40:40Z", "author": {"login": "boyan-velinov"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb3--7qgFqTMzOTE3NDg2MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4W-LhgBqjI5MzE1ODk3MjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MTc0ODYw", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/718#pullrequestreview-339174860", "createdAt": "2020-01-07T11:15:19Z", "commit": {"oid": "5a45ed2608eaa55a0efbd5d76d529a9c32e2b326"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMToxNToxOVrOFa2lZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMToyMzoyMVrOFa2wDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzcwMTYwNQ==", "bodyText": "For me an you leaf is an understandable word but not for the rest of the team.\nMaybe renaming it to child processes or subProcessLeafs would be better.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/718#discussion_r363701605", "createdAt": "2020-01-07T11:15:19Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/flowable/FlowableFacade.java", "diffHunk": "@@ -113,6 +113,11 @@ public boolean hasDeadLetterJobs(String processId) {\n         return !getDeadLetterJobs(processId).isEmpty();\n     }\n \n+    private boolean haveAllLeafsHaveDeadLetterJobs(List<Execution> executions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a45ed2608eaa55a0efbd5d76d529a9c32e2b326"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzcwMzk5OQ==", "bodyText": "This is a lot complexity: O(n^2).\nCould we revert the things like this:\n\nFind the execution which is related to the processInstanceId\nFind each executions which have parentId = processInstaceId || superExecutionId = processInstanceId\nDo 1 and 2, recursively for each execution foud in the step 2\nWould this work?\nThis way we would lower the complexity to O(nlogn)", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/718#discussion_r363703999", "createdAt": "2020-01-07T11:22:23Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/flowable/FlowableFacade.java", "diffHunk": "@@ -268,6 +280,25 @@ public boolean isProcessInstanceAtReceiveTask(String processInstanceId) {\n                                    .collect(Collectors.toList());\n     }\n \n+    private List<Execution> getAllLeafExecutions(String processInstanceId) {\n+        List<Execution> allExecutions = getAllProcessExecutions(processInstanceId);\n+        return allExecutions.stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a45ed2608eaa55a0efbd5d76d529a9c32e2b326"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzcwNDMzNQ==", "bodyText": "What if there is a bug in the code? We would stay in the loop forever.\nMaybe giving it some time would be enough in order the executions to finish. For instance, 10 mins MAX or more?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/718#discussion_r363704335", "createdAt": "2020-01-07T11:23:21Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/flowable/FlowableFacade.java", "diffHunk": "@@ -230,6 +235,13 @@ public void deleteProcessInstance(String processInstanceId, String deleteReason)\n                 // different if the process has parallel executions.\n                 processEngine.getRuntimeService()\n                              .setVariable(processInstanceId, Constants.PROCESS_ABORTED, Boolean.TRUE);\n+                while (true) {\n+                    List<Execution> allLeafExecutions = getAllLeafExecutions(processInstanceId);\n+\n+                    if (haveAllLeafsHaveDeadLetterJobs(allLeafExecutions)) {\n+                        break;\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a45ed2608eaa55a0efbd5d76d529a9c32e2b326"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5a45ed2608eaa55a0efbd5d76d529a9c32e2b326", "author": {"user": {"login": "boyan-velinov", "name": "Boyan Velinov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/5a45ed2608eaa55a0efbd5d76d529a9c32e2b326", "committedDate": "2020-01-07T08:39:39Z", "message": "Build tree to get all leaf nodes to abort process\n\nWhen process is aborted, AbortProcessAction should wait\nuntil all running subprocess have deadletter jobs.\nSo far AbortProcessAction do not wait and delete the process\nhierarchy which lead to deadlock in DB.\n\nJira: LMCROSSITXSADEPLOY-1761"}, "afterCommit": {"oid": "97c59fb5777ffdea1f07a4fcda7d99071cbb08d4", "author": {"user": {"login": "boyan-velinov", "name": "Boyan Velinov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/97c59fb5777ffdea1f07a4fcda7d99071cbb08d4", "committedDate": "2020-01-08T12:08:38Z", "message": "Build tree to get all leaf nodes to abort process\n\nWhen process is aborted, AbortProcessAction should wait\nuntil all running subprocess have deadletter jobs.\nSo far AbortProcessAction do not wait and delete the process\nhierarchy which lead to deadlock in DB.\n\nJira: LMCROSSITXSADEPLOY-1761"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be2257b81c31606fcf15ad0a831a2283452123a1", "author": {"user": {"login": "boyan-velinov", "name": "Boyan Velinov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/be2257b81c31606fcf15ad0a831a2283452123a1", "committedDate": "2020-01-08T15:20:24Z", "message": "Build tree to get all leaf nodes to abort process\n\nWhen process is aborted, AbortProcessAction should wait\nuntil all running subprocess have deadletter jobs.\nSo far AbortProcessAction do not wait and delete the process\nhierarchy which lead to deadlock in DB.\n\nJira: LMCROSSITXSADEPLOY-1761"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "97c59fb5777ffdea1f07a4fcda7d99071cbb08d4", "author": {"user": {"login": "boyan-velinov", "name": "Boyan Velinov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/97c59fb5777ffdea1f07a4fcda7d99071cbb08d4", "committedDate": "2020-01-08T12:08:38Z", "message": "Build tree to get all leaf nodes to abort process\n\nWhen process is aborted, AbortProcessAction should wait\nuntil all running subprocess have deadletter jobs.\nSo far AbortProcessAction do not wait and delete the process\nhierarchy which lead to deadlock in DB.\n\nJira: LMCROSSITXSADEPLOY-1761"}, "afterCommit": {"oid": "be2257b81c31606fcf15ad0a831a2283452123a1", "author": {"user": {"login": "boyan-velinov", "name": "Boyan Velinov"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/be2257b81c31606fcf15ad0a831a2283452123a1", "committedDate": "2020-01-08T15:20:24Z", "message": "Build tree to get all leaf nodes to abort process\n\nWhen process is aborted, AbortProcessAction should wait\nuntil all running subprocess have deadletter jobs.\nSo far AbortProcessAction do not wait and delete the process\nhierarchy which lead to deadlock in DB.\n\nJira: LMCROSSITXSADEPLOY-1761"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 962, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}