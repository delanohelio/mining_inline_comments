{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyNjI0NTEy", "number": 726, "reviewThreads": {"totalCount": 56, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwOTo1MDoxMlrODabsYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzoxODozMVrODbkUug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDQzMjk2OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaDetector.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwOTo1MDoxMlrOFhYfaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwOTo1MDoxMlrOFhYfaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU0ODU4NQ==", "bodyText": "Why are we creating 2 streams from lists and then collect into a list?\nWhy don't we just use ListUtils.union(List, List) ?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370548585", "createdAt": "2020-01-24T09:50:12Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaDetector.java", "diffHunk": "@@ -0,0 +1,118 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.detect;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor.MtaMetadataEntityAggregator;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor.MtaMetadataEntityCollector;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.MtaMetadataEntity;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.criteria.MtaMetadataCriteria;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.criteria.MtaMetadataCriteriaBuilder;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+\n+@Component\n+public class DeployedMtaDetector {\n+\n+    @Autowired\n+    private List<MtaMetadataEntityCollector<?>> mtaMetadataEntityCollectors;\n+\n+    @Autowired\n+    private MtaMetadataEntityAggregator mtaMetadataEntityAggregator;\n+\n+    public List<DeployedMta> getAllDeployedMtas(CloudControllerClient client) {\n+        MtaMetadataCriteria selectionCriteria = MtaMetadataCriteriaBuilder.builder()\n+                                                                          .label(MtaMetadataCriteriaBuilder.LABEL_MTA_ID)\n+                                                                          .exists()\n+                                                                          .build();\n+        List<DeployedMta> deployedMtas = getDeployedMtasByMetadataSelectionCriteria(selectionCriteria, client);\n+        List<DeployedMta> deployedMtasByEnv = getDeployedMtasByEnv(client).stream()\n+                                                                          .filter(deployedMtaByEnv -> !deployedMtas.contains(deployedMtaByEnv))\n+                                                                          .collect(Collectors.toList());\n+        return Stream.concat(deployedMtas.stream(), deployedMtasByEnv.stream())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDQ2NjM4OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaDetector.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMDowMjowMVrOFhYz9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMDowMjowMVrOFhYz9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU1Mzg0NQ==", "bodyText": "I think a cleaner way of doing this is collecting like this\nCollectors.toMap(mta -> mta.getMetadata().getId(), mta -> mta, this::mergeMtas)\nThis way, there won't be a need to use optional and the map's values could be directly passed to a list constructor", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370553845", "createdAt": "2020-01-24T10:02:01Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaDetector.java", "diffHunk": "@@ -0,0 +1,118 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.detect;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor.MtaMetadataEntityAggregator;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor.MtaMetadataEntityCollector;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.MtaMetadataEntity;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.criteria.MtaMetadataCriteria;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.criteria.MtaMetadataCriteriaBuilder;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+\n+@Component\n+public class DeployedMtaDetector {\n+\n+    @Autowired\n+    private List<MtaMetadataEntityCollector<?>> mtaMetadataEntityCollectors;\n+\n+    @Autowired\n+    private MtaMetadataEntityAggregator mtaMetadataEntityAggregator;\n+\n+    public List<DeployedMta> getAllDeployedMtas(CloudControllerClient client) {\n+        MtaMetadataCriteria selectionCriteria = MtaMetadataCriteriaBuilder.builder()\n+                                                                          .label(MtaMetadataCriteriaBuilder.LABEL_MTA_ID)\n+                                                                          .exists()\n+                                                                          .build();\n+        List<DeployedMta> deployedMtas = getDeployedMtasByMetadataSelectionCriteria(selectionCriteria, client);\n+        List<DeployedMta> deployedMtasByEnv = getDeployedMtasByEnv(client).stream()\n+                                                                          .filter(deployedMtaByEnv -> !deployedMtas.contains(deployedMtaByEnv))\n+                                                                          .collect(Collectors.toList());\n+        return Stream.concat(deployedMtas.stream(), deployedMtasByEnv.stream())\n+                     .collect(Collectors.toList());\n+    }\n+\n+    private List<DeployedMta> getDeployedMtasByMetadataSelectionCriteria(MtaMetadataCriteria criteria, CloudControllerClient client) {\n+        List<MtaMetadataEntity> mtaMetadataEntities = mtaMetadataEntityCollectors.stream()\n+                                                                                 .map(collector -> collector.collect(criteria, client))\n+                                                                                 .flatMap(List::stream)\n+                                                                                 .collect(Collectors.toList());\n+        List<DeployedMta> deployedMtas = mtaMetadataEntityAggregator.aggregate(mtaMetadataEntities);\n+        return processDeployedMtas(deployedMtas);\n+    }\n+\n+    private List<DeployedMta> processDeployedMtas(List<DeployedMta> deployedMtas) {\n+        List<DeployedMta> mergedMtasById = mergeDifferentVersionsOfMtasWithSameId(deployedMtas);\n+        return removeEmptyMtas(mergedMtasById);\n+    }\n+\n+    private List<DeployedMta> mergeDifferentVersionsOfMtasWithSameId(List<DeployedMta> mtas) {\n+        Map<String, Optional<DeployedMta>> deployedMtasById = mtas.stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDQ3MzI1OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/ApplicationMtaMetadata.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMDowNDoyMVrOFhY3_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMDowNDoyMVrOFhY3_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU1NDg3Ng==", "bodyText": "Why not use Immutables?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370554876", "createdAt": "2020-01-24T10:04:21Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/ApplicationMtaMetadata.java", "diffHunk": "@@ -0,0 +1,50 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata;\n+\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+\n+public class ApplicationMtaMetadata {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDQ3NTMyOnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaDetectorEnv.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMDowNToxMlrOFhY5TA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMDowNToxMlrOFhY5TA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU1NTIxMg==", "bodyText": "Same as the above comment.\nThis is unneeded complexity with the merging of mtas.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370555212", "createdAt": "2020-01-24T10:05:12Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaDetectorEnv.java", "diffHunk": "@@ -0,0 +1,112 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.detect;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ApplicationMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.ApplicationMtaMetadataEnvExtractor;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+//TODO delete this class and its usages after the CF metadata becomes the go to metadata approach\n+//A release note should be already present explaining that the migration (at least one mta redeploy) is mandatory\n+public class DeployedMtaDetectorEnv {\n+\n+    /**\n+     * Detects all deployed components on this platform.\n+     *\n+     */\n+\n+    private final CloudControllerClient client;\n+\n+    public DeployedMtaDetectorEnv(CloudControllerClient client) {\n+        this.client = client;\n+    }\n+\n+    public List<DeployedMta> detectAllDeployedComponents() {\n+        List<DeployedMta> deployedMtas = client.getApplications()\n+                                               .stream()\n+                                               .map(ApplicationMtaMetadataEnvExtractor::extractMetadata)\n+                                               .filter(Objects::nonNull)\n+                                               .map(this::getDeployedMta)\n+                                               .collect(Collectors.toList());\n+        return mergeDifferentVersionsOfMtasWithSameId(deployedMtas);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDQ3NjEyOnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/ServiceMtaMetadata.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMDowNTozM1rOFhY52A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMDowNTozM1rOFhY52A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU1NTM1Mg==", "bodyText": "Immutables?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370555352", "createdAt": "2020-01-24T10:05:33Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/ServiceMtaMetadata.java", "diffHunk": "@@ -0,0 +1,59 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata;\n+\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+\n+public class ServiceMtaMetadata {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDQ4MTIzOnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/criteria/LabelBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMDowNzowNlrOFhY8qA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMDowNzowNlrOFhY8qA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU1NjA3Mg==", "bodyText": "Why not give the prefix and label a default non-null value and/or check when they are being set that the value passed is not null and change this to return prefix + label?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370556072", "createdAt": "2020-01-24T10:07:06Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/criteria/LabelBuilder.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.criteria;\n+\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+public class LabelBuilder {\n+    private MtaMetadataCriteriaBuilder mtaMetadataCriteriaBuilder;\n+    private String label;\n+    private String prefix;\n+\n+    public LabelBuilder(MtaMetadataCriteriaBuilder mtaMetadataCriteriaBuilder, String label) {\n+        this.mtaMetadataCriteriaBuilder = mtaMetadataCriteriaBuilder;\n+        this.label = label;\n+    }\n+\n+    public LabelBuilder withPrefix(String prefix) {\n+        MtaMetadataCriteriaValidator.validateLabelKeyPrefix(prefix);\n+        this.prefix = prefix;\n+        return this;\n+    }\n+\n+    public FinalizingBuilder exists() {\n+        return completeQuery(buildLabel());\n+    }\n+\n+    public FinalizingBuilder notExists() {\n+        return completeQuery(\"!\" + buildLabel());\n+    }\n+\n+    public FinalizingBuilder haveValue(String value) {\n+        MtaMetadataCriteriaValidator.validateLabelValue(value);\n+        return completeQuery(buildLabel() + \"=\" + value);\n+    }\n+\n+    public FinalizingBuilder notHaveValue(String value) {\n+        MtaMetadataCriteriaValidator.validateLabelValue(value);\n+        return completeQuery(buildLabel() + \"!=\" + value);\n+    }\n+\n+    public FinalizingBuilder valueIn(List<String> values) {\n+        String concatenatedValues = values.stream()\n+                                          .peek(MtaMetadataCriteriaValidator::validateLabelValue)\n+                                          .collect(Collectors.joining(\",\"));\n+        return completeQuery(buildLabel() + \" in (\" + concatenatedValues + \")\");\n+    }\n+\n+    public FinalizingBuilder valueNotIn(List<String> values) {\n+        String concatenatedValues = values.stream()\n+                                          .peek(MtaMetadataCriteriaValidator::validateLabelValue)\n+                                          .collect(Collectors.joining(\",\"));\n+        return completeQuery(buildLabel() + \" notin (\" + concatenatedValues + \")\");\n+    }\n+\n+    private String buildLabel() {\n+        return Stream.of(prefix, label)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDQ5NTI5OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/entity/processor/MtaMetadataEntityAggregator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMDoxMTozOVrOFhZE5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMDoxMTozOVrOFhZE5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU1ODE4MA==", "bodyText": "I prefer .map(Map::values).flatMap(Collection::stream)", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370558180", "createdAt": "2020-01-24T10:11:39Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/entity/processor/MtaMetadataEntityAggregator.java", "diffHunk": "@@ -0,0 +1,38 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.MtaMetadataEntity;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+@Component\n+public class MtaMetadataEntityAggregator {\n+\n+    public List<DeployedMta> aggregate(List<MtaMetadataEntity> entities) {\n+        Map<String, Map<Version, List<MtaMetadataEntity>>> entitiesByIdByVersion = getMtaMetadataEntitiesByIdByVersion(entities);\n+        return entitiesByIdByVersion.values()\n+                                    .stream()\n+                                    .flatMap(entitiesByVersion -> entitiesByVersion.values()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDY1MjUwOnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/v2/ApplicationMetadataBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTowOTo1NlrOFhajjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTowOTo1NlrOFhajjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU4MjQxNA==", "bodyText": "Parameters can't be null since it's .getOrDefault(..., Collections.emptyMap())", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370582414", "createdAt": "2020-01-24T11:09:56Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/v2/ApplicationMetadataBuilder.java", "diffHunk": "@@ -0,0 +1,80 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.v2;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.TreeMap;\n+import java.util.stream.Collectors;\n+\n+import org.cloudfoundry.client.v3.Metadata;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadataLabels;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.ApplicationMtaMetadataExtractor;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.SupportedParameters;\n+import com.sap.cloud.lm.sl.cf.core.util.NameUtil;\n+import com.sap.cloud.lm.sl.common.util.JsonUtil;\n+import com.sap.cloud.lm.sl.mta.model.DeploymentDescriptor;\n+import com.sap.cloud.lm.sl.mta.model.Module;\n+import com.sap.cloud.lm.sl.mta.model.ProvidedDependency;\n+import com.sap.cloud.lm.sl.mta.model.Resource;\n+\n+public class ApplicationMetadataBuilder {\n+\n+    public static Metadata build(DeploymentDescriptor deploymentDescriptor, Module module, List<ResourceAndResourceType> moduleResources,\n+                                 List<String> uris) {\n+        List<DeployedMtaResource> deployedResources = moduleResources.stream()\n+                                                                     .map(resource -> mapResourceToDeployedMtaResource(resource, module))\n+                                                                     .collect(Collectors.toList());\n+\n+        List<String> providedDependenciesNames = module.getProvidedDependencies()\n+                                                       .stream()\n+                                                       .filter(ProvidedDependency::isPublic)\n+                                                       .map(ProvidedDependency::getName)\n+                                                       .collect(Collectors.toList());\n+\n+        DeployedMtaModule deployedMtaModule = DeployedMtaModule.builder()\n+                                                               .withModuleName(module.getName())\n+                                                               .withAppName(NameUtil.getApplicationName(module))\n+                                                               .withProvidedDependencyNames(providedDependenciesNames)\n+                                                               .withResources(deployedResources)\n+                                                               .withUris(uris)\n+                                                               .build();\n+\n+        return Metadata.builder()\n+                       .label(MtaMetadataLabels.MTA_ID, deploymentDescriptor.getId())\n+                       .label(MtaMetadataLabels.MTA_VERSION, deploymentDescriptor.getVersion())\n+                       .annotation(ApplicationMtaMetadataExtractor.MODULE, JsonUtil.toJson(deployedMtaModule, true))\n+                       .build();\n+    }\n+\n+    private static DeployedMtaResource mapResourceToDeployedMtaResource(ResourceAndResourceType applicationService, Module module) {\n+        ResourceType resourceType = applicationService.getResourceType();\n+        Resource resource = applicationService.getResource();\n+        if (resourceType != ResourceType.USER_PROVIDED_SERVICE) {\n+            return DeployedMtaResource.builder()\n+                                      .withServiceName(NameUtil.getServiceName(resource))\n+                                      .withResourceName(resource.getName())\n+                                      .build();\n+        }\n+\n+        List<DeployedMtaModule> deployedMtaModules = Collections.singletonList(DeployedMtaModule.builder()\n+                                                                                                .withModuleName(module.getName())\n+                                                                                                .withAppName(NameUtil.getApplicationName(module))\n+                                                                                                .build());\n+        Map<String, Object> parameters = (Map<String, Object>) resource.getParameters()\n+                                                                       .getOrDefault(SupportedParameters.SERVICE_CONFIG,\n+                                                                                     Collections.emptyMap());\n+        if (parameters == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDY1NjU2OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/v2/ServiceMetadataBuilder.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMToxMTo0MVrOFhamMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzoxNTo1N1rOFjH8iQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU4MzA4OQ==", "bodyText": "This class has a lot in common with the application metadata builder.\nIs it possible that some form of generalization be done to reduce duplication?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370583089", "createdAt": "2020-01-24T11:11:41Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/v2/ServiceMetadataBuilder.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.v2;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.ServiceMtaMetadataExtractor;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadataLabels;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.util.NameUtil;\n+import com.sap.cloud.lm.sl.common.util.JsonUtil;\n+import com.sap.cloud.lm.sl.mta.model.DeploymentDescriptor;\n+import com.sap.cloud.lm.sl.mta.model.Module;\n+import com.sap.cloud.lm.sl.mta.model.Resource;\n+import org.cloudfoundry.client.v3.Metadata;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class ServiceMetadataBuilder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3NDY2NQ==", "bodyText": "Check my above comment and you will find a way to workaround it.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372374665", "createdAt": "2020-01-29T13:15:57Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/v2/ServiceMetadataBuilder.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.v2;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.ServiceMtaMetadataExtractor;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadataLabels;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.util.NameUtil;\n+import com.sap.cloud.lm.sl.common.util.JsonUtil;\n+import com.sap.cloud.lm.sl.mta.model.DeploymentDescriptor;\n+import com.sap.cloud.lm.sl.mta.model.Module;\n+import com.sap.cloud.lm.sl.mta.model.Resource;\n+import org.cloudfoundry.client.v3.Metadata;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class ServiceMetadataBuilder {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU4MzA4OQ=="}, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDY3MDA1OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/model/DeployedMta.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMToxNzo1OVrOFhauog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMToxNzo1OVrOFhauog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU4NTI1MA==", "bodyText": "Is it possible to use Immutables?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370585250", "createdAt": "2020-01-24T11:17:59Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/model/DeployedMta.java", "diffHunk": "@@ -1,29 +1,37 @@\n package com.sap.cloud.lm.sl.cf.core.model;\r\n \r\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\r\n+\r\n+import java.util.ArrayList;\r\n import java.util.List;\r\n import java.util.Objects;\r\n-import java.util.Set;\r\n \r\n public class DeployedMta {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDY3MjA4OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/model/DeployedMtaModule.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMToxODo1MVrOFhav3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMToxODo1MVrOFhav3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU4NTU2NA==", "bodyText": "Immutables?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370585564", "createdAt": "2020-01-24T11:18:51Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/model/DeployedMtaModule.java", "diffHunk": "@@ -1,30 +1,31 @@\n package com.sap.cloud.lm.sl.cf.core.model;\n \n+import java.util.ArrayList;\n import java.util.Date;\n import java.util.List;\n+import java.util.Objects;\n \n public class DeployedMtaModule {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDY3MjkwOnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/model/DeployedMtaResource.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMToxOToxMVrOFhawTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMToxOToxMVrOFhawTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU4NTY3OQ==", "bodyText": "Immutables?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370585679", "createdAt": "2020-01-24T11:19:11Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/model/DeployedMtaResource.java", "diffHunk": "@@ -0,0 +1,141 @@\n+package com.sap.cloud.lm.sl.cf.core.model;\n+\n+import java.util.ArrayList;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class DeployedMtaResource {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDY4NDM5OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/BuildCloudUndeployModelStep.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMToyNDowMFrOFha3CA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMToyNDowMFrOFha3CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU4NzQwMA==", "bodyText": "I prefer .map(Module::getResources).flatMap(List::stream)", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370587400", "createdAt": "2020-01-24T11:24:00Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/BuildCloudUndeployModelStep.java", "diffHunk": "@@ -142,18 +143,20 @@ private void setComponentsToUndeploy(DelegateExecution context, List<String> ser\n         StepsUtil.setAppsToUndeploy(context, apps);\n     }\n \n-    private List<String> computeServicesToDelete(List<DeployedMtaModule> modulesWithoutChange, Set<String> existingServices,\n+    private List<String> computeServicesToDelete(List<DeployedMtaModule> modulesWithoutChange, List<DeployedMtaResource> existingServices,\n                                                  Set<String> servicesForApplications) {\n         return existingServices.stream()\n-                               .filter(service -> shouldDeleteService(modulesWithoutChange, service, servicesForApplications))\n+                               .map(DeployedMtaResource::getServiceName)\n+                               .filter(name -> shouldDeleteService(modulesWithoutChange, name, servicesForApplications))\n                                .sorted()\n                                .collect(Collectors.toList());\n     }\n \n     private boolean shouldDeleteService(List<DeployedMtaModule> modulesToKeep, String service, Set<String> servicesForApplications) {\n         return modulesToKeep.stream()\n-                            .map(DeployedMtaModule::getServices)\n-                            .noneMatch(moduleToKeepService -> moduleToKeepService.contains(service))\n+                            .flatMap(module -> module.getResources().stream())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDY5Mjg3OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CheckForCreationConflictsStep.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMToyNzozNVrOFha8LQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMToyNzozNVrOFha8LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU4ODcxNw==", "bodyText": "The formatting in this class seems a bit weird", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370588717", "createdAt": "2020-01-24T11:27:35Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CheckForCreationConflictsStep.java", "diffHunk": "@@ -11,31 +11,39 @@\n import java.util.Set;\n import java.util.stream.Collectors;\n \n+import javax.inject.Inject;\n import javax.inject.Named;\n \n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.util.MtaMetadataUtil;\n+import org.apache.commons.lang3.StringUtils;\n import org.cloudfoundry.client.lib.CloudControllerClient;\n import org.cloudfoundry.client.lib.CloudControllerException;\n import org.cloudfoundry.client.lib.CloudOperationException;\n import org.cloudfoundry.client.lib.domain.CloudApplication;\n import org.cloudfoundry.client.lib.domain.CloudServiceBinding;\n import org.cloudfoundry.client.lib.domain.CloudServiceInstance;\n+import org.cloudfoundry.client.v3.Metadata;\n import org.flowable.engine.delegate.DelegateExecution;\n import org.springframework.beans.factory.config.BeanDefinition;\n import org.springframework.context.annotation.Scope;\n \n import com.sap.cloud.lm.sl.cf.client.lib.domain.CloudServiceExtended;\n-import com.sap.cloud.lm.sl.cf.core.cf.detect.ApplicationMtaMetadataParser;\n-import com.sap.cloud.lm.sl.cf.core.cf.detect.DeployedComponentsDetector;\n-import com.sap.cloud.lm.sl.cf.core.model.ApplicationMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.ApplicationMtaMetadataEnvExtractor;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.ApplicationMtaMetadataExtractor;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ApplicationMtaMetadata;\n import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n import com.sap.cloud.lm.sl.cf.process.message.Messages;\n import com.sap.cloud.lm.sl.common.SLException;\n \n @Named(\"checkForCreationConflictsStep\")\n @Scope(BeanDefinition.SCOPE_PROTOTYPE)\n public class CheckForCreationConflictsStep extends SyncFlowableStep {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDY5NzEwOnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CreateOrUpdateAppStep.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMToyOTozN1rOFha-6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMToyOTozN1rOFha-6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU4OTQxOQ==", "bodyText": "Why is this duplicated?\nFirst here in handleAppAtributes, then again in handleAppMetadata?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370589419", "createdAt": "2020-01-24T11:29:37Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CreateOrUpdateAppStep.java", "diffHunk": "@@ -171,6 +173,10 @@ public void handleApplicationAttributes() {\n             }\r\n             client.createApplication(app.getName(), app.getStaging(), diskQuota, memory, uris, Collections.emptyList(),\r\n                                      app.getDockerInfo());\r\n+            CloudApplication application = client.getApplication(app.getName());\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDY5OTM3OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CreateOrUpdateAppStep.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTozMDozOVrOFhbASA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTozMDozOVrOFhbASA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU4OTc2OA==", "bodyText": "Does the metadata override the equals() method?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370589768", "createdAt": "2020-01-24T11:30:39Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CreateOrUpdateAppStep.java", "diffHunk": "@@ -279,6 +293,19 @@ public void printStepEndMessage() {\n                                                               getStepLogger()).updateApplication(client, app);\r\n         }\r\n \r\n+        @Override\r\n+        public void handleApplicationMetadata() {\r\n+            if(app.getV3Metadata() != null) {\r\n+                boolean shouldUpdateMetadata = true;\r\n+                if(existingApp.getV3Metadata() != null) {\r\n+                    shouldUpdateMetadata = !existingApp.getV3Metadata().equals(app.getV3Metadata());\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDcwMTgyOnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CreateOrUpdateAppStep.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTozMToyOVrOFhbBuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTozMToyOVrOFhbBuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU5MDEzNw==", "bodyText": "I think it would be slightly better if this condition is inverted and the function returns if the metadata is null", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370590137", "createdAt": "2020-01-24T11:31:29Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/CreateOrUpdateAppStep.java", "diffHunk": "@@ -279,6 +293,19 @@ public void printStepEndMessage() {\n                                                               getStepLogger()).updateApplication(client, app);\r\n         }\r\n \r\n+        @Override\r\n+        public void handleApplicationMetadata() {\r\n+            if(app.getV3Metadata() != null) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDcwNzA2OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/DetermineServiceCreateUpdateServiceActionsStep.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTozNDowM1rOFhbFJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTozNDowM1rOFhbFJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU5MTAxNA==", "bodyText": "Could be substituted with return newMetadata != null", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370591014", "createdAt": "2020-01-24T11:34:03Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/DetermineServiceCreateUpdateServiceActionsStep.java", "diffHunk": "@@ -177,6 +184,18 @@ private String buildServiceType(CloudService service) {\n         return label + \"/\" + plan;\n     }\n \n+    private boolean shouldUpdateMetadata(CloudServiceExtended service, CloudService existingService, CloudControllerClient client) {\n+        Metadata existingMetadata = existingService.getV3Metadata();\n+        Metadata newMetadata = service.getV3Metadata();\n+        if (existingMetadata != null && newMetadata != null) {\n+            return !existingMetadata.equals(newMetadata);\n+        }\n+        if (newMetadata != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDcwODQ3OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/ServiceStep.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTozNDo0NlrOFhbGFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTozNDo0NlrOFhbGFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU5MTI1Mg==", "bodyText": "Why is this imported if it's not used?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370591252", "createdAt": "2020-01-24T11:34:46Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/ServiceStep.java", "diffHunk": "@@ -8,6 +8,7 @@\n import javax.inject.Named;\n \n import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.v3.Metadata;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDcxMDc4OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/SyncFlowableStepWithHooks.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTozNTo0NFrOFhbHaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTozNTo0NFrOFhbHaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU5MTU5Mg==", "bodyText": "This method is duplicated a lot in many files.\nMaybe introduce a Factory for the metadata?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370591592", "createdAt": "2020-01-24T11:35:44Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/SyncFlowableStepWithHooks.java", "diffHunk": "@@ -89,8 +97,17 @@ private Module determineModuleFromAppName(DeploymentDescriptor deploymentDescrip\n     }\n \n     protected String getModuleName(CloudApplicationExtended cloudApplication) {\n-        return ApplicationMtaMetadataParser.parseAppMetadata(cloudApplication)\n-                                           .getModuleName();\n+        return getApplicationMtaMetadata(cloudApplication)\n+            .getDeployedMtaModule()\n+            .getModuleName();\n+    }\n+\n+    private ApplicationMtaMetadata getApplicationMtaMetadata(CloudApplication app) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDcxMjgzOnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/UpdateServiceMetadataStep.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTozNjozNFrOFhbImw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTozNjozNFrOFhbImw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU5MTg5OQ==", "bodyText": "singletonList", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370591899", "createdAt": "2020-01-24T11:36:34Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/UpdateServiceMetadataStep.java", "diffHunk": "@@ -0,0 +1,64 @@\n+package com.sap.cloud.lm.sl.cf.process.steps;\n+\n+import java.text.MessageFormat;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import javax.inject.Inject;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.CloudControllerException;\n+import org.cloudfoundry.client.lib.CloudOperationException;\n+import org.cloudfoundry.client.lib.CloudServiceBrokerException;\n+import org.cloudfoundry.client.lib.domain.CloudMetadata;\n+import org.cloudfoundry.client.lib.domain.ImmutableCloudService;\n+import org.flowable.engine.delegate.DelegateExecution;\n+import org.springframework.beans.factory.config.BeanDefinition;\n+import org.springframework.context.annotation.Scope;\n+import org.springframework.http.HttpStatus;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.client.lib.domain.CloudServiceExtended;\n+import com.sap.cloud.lm.sl.cf.core.cf.clients.ServiceWithAlternativesCreator;\n+import com.sap.cloud.lm.sl.cf.core.cf.services.ServiceOperationType;\n+import com.sap.cloud.lm.sl.cf.core.exec.MethodExecution;\n+import com.sap.cloud.lm.sl.cf.core.exec.MethodExecution.ExecutionState;\n+import com.sap.cloud.lm.sl.cf.process.message.Messages;\n+import com.sap.cloud.lm.sl.common.util.JsonUtil;\n+\n+@Component(\"updateServiceMetadataStep\")\n+@Scope(BeanDefinition.SCOPE_PROTOTYPE)\n+public class UpdateServiceMetadataStep extends ServiceStep {\n+\n+    @Override\n+    protected MethodExecution<String> executeOperation(DelegateExecution execution, CloudControllerClient controllerClient,\n+                                                       CloudServiceExtended service) {\n+        return updateServiceMetadata(execution, controllerClient, service);\n+    }\n+\n+    private MethodExecution<String> updateServiceMetadata(DelegateExecution context, CloudControllerClient client, CloudServiceExtended service) {\n+        getStepLogger().debug(Messages.UPDATING_SERVICE_METADATA, service.getName(), service.getResourceName());\n+        updateServiceMetadata(service, client);\n+        getStepLogger().debug(Messages.SERVICE_METADATA_UPDATED, service.getName());\n+        return new MethodExecution<>(null, ExecutionState.FINISHED);\n+    }\n+\n+    private void updateServiceMetadata(CloudServiceExtended serviceToProcess, CloudControllerClient client) {\n+        ImmutableCloudService serviceWithMetadata = ImmutableCloudService.copyOf(serviceToProcess);\n+        CloudMetadata serviceMeta = client.getService(serviceWithMetadata.getName()).getMetadata();\n+        serviceWithMetadata = serviceWithMetadata.withMetadata(serviceMeta);\n+        client.updateServiceMetadata(serviceWithMetadata.getMetadata().getGuid(), serviceWithMetadata.getV3Metadata());\n+        getStepLogger().debug(\"updated service metadata name: \" + serviceWithMetadata + \" metadata: \" + JsonUtil.toJson(serviceWithMetadata.getV3Metadata(), true));\n+    }\n+\n+    @Override\n+    protected List<AsyncExecution> getAsyncStepExecutions(ExecutionWrapper execution) {\n+        return Arrays.asList(new PollServiceCreateOrUpdateOperationsExecution(getServiceOperationGetter(), getServiceProgressReporter()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDcxNTY3OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.process/src/test/java/com/sap/cloud/lm/sl/cf/process/helpers/ApplicationColorDetectorTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTozNzo1MVrOFhbKSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTozNzo1MVrOFhbKSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU5MjMyOA==", "bodyText": "It's difficult to read with this formatting", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370592328", "createdAt": "2020-01-24T11:37:51Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.process/src/test/java/com/sap/cloud/lm/sl/cf/process/helpers/ApplicationColorDetectorTest.java", "diffHunk": "@@ -225,11 +230,7 @@ private Date parseDate(String date) {\n     }\n \n     private DeployedMtaModule createMtaModule(String moduleName, String appName, Date createdOn) {\n-        DeployedMtaModule deployedMtaModule = new DeployedMtaModule();\n-        deployedMtaModule.setModuleName(moduleName);\n-        deployedMtaModule.setAppName(appName);\n-        deployedMtaModule.setCreatedOn(createdOn);\n-        return deployedMtaModule;\n+        return DeployedMtaModule.builder().withModuleName(moduleName).withAppName(appName).withCreatedOn(createdOn).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDcyMTkxOnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.web/src/main/java/com/sap/cloud/lm/sl/cf/web/api/impl/MtasApiServiceImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTo0MDo0NlrOFhbOEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTo0MDo0NlrOFhbOEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU5MzI5Nw==", "bodyText": "return deployedMtas.stream().map(this::getMta).collect(Collectors.toList())", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370593297", "createdAt": "2020-01-24T11:40:46Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.web/src/main/java/com/sap/cloud/lm/sl/cf/web/api/impl/MtasApiServiceImpl.java", "diffHunk": "@@ -34,45 +35,47 @@\n     @Inject\n     private CloudControllerClientProvider clientProvider;\n \n+    @Inject\n+    private DeployedMtaDetector deployedMtaDetector;\n+\n     @Override\n     public ResponseEntity<List<Mta>> getMtas(String spaceGuid) {\n-        DeployedComponents deployedComponents = detectDeployedComponents(spaceGuid);\n+        List<DeployedMta> deployedMtas = deployedMtaDetector.getAllDeployedMtas(getCloudFoundryClient(spaceGuid));\n+        List<Mta> mtas = getMtas(deployedMtas);\n         return ResponseEntity.ok()\n-                             .body(getMtas(deployedComponents));\n+                             .body(mtas);\n     }\n \n     @Override\n     public ResponseEntity<Mta> getMta(String spaceGuid, String mtaId) {\n-        DeployedMta mta = detectDeployedComponents(spaceGuid).findDeployedMta(mtaId);\n-        if (mta == null) {\n-            throw new NotFoundException(Messages.MTA_NOT_FOUND, mtaId);\n-        }\n+        Optional<DeployedMta> optionalDeployedMta = deployedMtaDetector.getDeployedMta(mtaId, getCloudFoundryClient(spaceGuid));\n+        DeployedMta deployedMta = optionalDeployedMta.orElseThrow(() -> new NotFoundException(Messages.MTA_NOT_FOUND, mtaId));\n         return ResponseEntity.ok()\n-                             .body(getMta(mta));\n-    }\n-\n-    private DeployedComponents detectDeployedComponents(String spaceGuid) {\n-        List<CloudApplication> applications = getCloudFoundryClient(spaceGuid).getApplications();\n-        return new DeployedComponentsDetector().detectAllDeployedComponents(applications);\n+                             .body(getMta(deployedMta));\n     }\n \n     private CloudControllerClient getCloudFoundryClient(String spaceGuid) {\n         UserInfo userInfo = SecurityContextUtil.getUserInfo();\n         return clientProvider.getControllerClient(userInfo.getName(), spaceGuid);\n     }\n \n-    private List<Mta> getMtas(DeployedComponents components) {\n-        return components.getMtas()\n-                         .stream()\n-                         .map(this::getMta)\n-                         .collect(Collectors.toList());\n+    private List<Mta> getMtas(List<DeployedMta> deployedMtas) {\n+        List<Mta> mtas = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MDcyNDU3OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.web/src/main/java/com/sap/cloud/lm/sl/cf/web/api/impl/MtasApiServiceImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTo0MTo1MVrOFhbPmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTo0MTo1MVrOFhbPmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU5MzY4OA==", "bodyText": "In the change above you use a method reference, here you don't.\nUse one or the other in all places", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r370593688", "createdAt": "2020-01-24T11:41:51Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.web/src/main/java/com/sap/cloud/lm/sl/cf/web/api/impl/MtasApiServiceImpl.java", "diffHunk": "@@ -88,11 +91,14 @@ private Module getModule(DeployedMtaModule module) {\n                               .moduleName(module.getModuleName())\n                               .providedDendencyNames(module.getProvidedDependencyNames())\n                               .uris(module.getUris())\n-                              .services(module.getServices())\n+                              .services(module.getResources()\n+                                              .stream()\n+                                              .map(s -> s.getServiceName())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d9462ec98a34c4811fb8c58bede26e204d11fe"}, "originalPosition": 100}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTYxNTc5OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaEnvDetector.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOToxMDo0M1rOFjBI4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMjoyMTowM1rOFjGfxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI2MzEzNw==", "bodyText": "This can be substituted with\napplications.stream().collect(groupingBy(app -> parseMetadata(app).getId())", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372263137", "createdAt": "2020-01-29T09:10:43Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaEnvDetector.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.detect;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.Constants;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.EnvMtaMetadataParser;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMta;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+//TODO delete this class and its usages after the CF metadata becomes the go to metadata approach\n+//A release note should be already present explaining that the migration (at least one mta redeploy) is mandatory\n+@Component\n+public class DeployedMtaEnvDetector {\n+\n+    @Inject\n+    private EnvMtaMetadataParser envMtaMetadataParser;\n+\n+    public List<DeployedMta> getAllDeployedMtas(CloudControllerClient client) {\n+        Map<String, List<CloudApplication>> applicationsByMtaId = getApplicationsByMtaId(client);\n+        return applicationsByMtaId.values()\n+                                  .stream()\n+                                  .map(this::toDeployedMta)\n+                                  .collect(Collectors.toList());\n+    }\n+\n+    private Map<String, List<CloudApplication>> getApplicationsByMtaId(CloudControllerClient client) {\n+        Map<String, List<CloudApplication>> applicationsByMtaId = new HashMap<>();\n+        List<CloudApplication> applications = getApplicationsWithEnvMetadata(client);\n+        for (CloudApplication application : applications) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI5OTIwMw==", "bodyText": "This used to be groupingBy but got changed recently as a discussion with Encho led us to agree that we wanted to avoid having the complexity of 'groupingBy' in the code. What do you think?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372299203", "createdAt": "2020-01-29T10:23:02Z", "author": {"login": "valentinEmpy"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaEnvDetector.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.detect;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.Constants;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.EnvMtaMetadataParser;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMta;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+//TODO delete this class and its usages after the CF metadata becomes the go to metadata approach\n+//A release note should be already present explaining that the migration (at least one mta redeploy) is mandatory\n+@Component\n+public class DeployedMtaEnvDetector {\n+\n+    @Inject\n+    private EnvMtaMetadataParser envMtaMetadataParser;\n+\n+    public List<DeployedMta> getAllDeployedMtas(CloudControllerClient client) {\n+        Map<String, List<CloudApplication>> applicationsByMtaId = getApplicationsByMtaId(client);\n+        return applicationsByMtaId.values()\n+                                  .stream()\n+                                  .map(this::toDeployedMta)\n+                                  .collect(Collectors.toList());\n+    }\n+\n+    private Map<String, List<CloudApplication>> getApplicationsByMtaId(CloudControllerClient client) {\n+        Map<String, List<CloudApplication>> applicationsByMtaId = new HashMap<>();\n+        List<CloudApplication> applications = getApplicationsWithEnvMetadata(client);\n+        for (CloudApplication application : applications) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI2MzEzNw=="}, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMzOTc4NA==", "bodyText": "I half agree. Using grouping by in complex scenarios, like having to modify the downstream (eg. groupingBy(<some property>, mapping()/collectingAndThen()/toSet()...), is worse than using a regular loop. But this is a standard scenario. My opinion is that all the extra lines and extra operations on the map are more complex than using stream().collect(groupingBy(func()))", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372339784", "createdAt": "2020-01-29T11:54:29Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaEnvDetector.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.detect;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.Constants;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.EnvMtaMetadataParser;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMta;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+//TODO delete this class and its usages after the CF metadata becomes the go to metadata approach\n+//A release note should be already present explaining that the migration (at least one mta redeploy) is mandatory\n+@Component\n+public class DeployedMtaEnvDetector {\n+\n+    @Inject\n+    private EnvMtaMetadataParser envMtaMetadataParser;\n+\n+    public List<DeployedMta> getAllDeployedMtas(CloudControllerClient client) {\n+        Map<String, List<CloudApplication>> applicationsByMtaId = getApplicationsByMtaId(client);\n+        return applicationsByMtaId.values()\n+                                  .stream()\n+                                  .map(this::toDeployedMta)\n+                                  .collect(Collectors.toList());\n+    }\n+\n+    private Map<String, List<CloudApplication>> getApplicationsByMtaId(CloudControllerClient client) {\n+        Map<String, List<CloudApplication>> applicationsByMtaId = new HashMap<>();\n+        List<CloudApplication> applications = getApplicationsWithEnvMetadata(client);\n+        for (CloudApplication application : applications) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI2MzEzNw=="}, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM1MDkxOA==", "bodyText": "As we talked with Radi, try using computeIfAbsent and if it is looking better -> leave it that way.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372350918", "createdAt": "2020-01-29T12:21:03Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaEnvDetector.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.detect;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.Constants;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.EnvMtaMetadataParser;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMta;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+//TODO delete this class and its usages after the CF metadata becomes the go to metadata approach\n+//A release note should be already present explaining that the migration (at least one mta redeploy) is mandatory\n+@Component\n+public class DeployedMtaEnvDetector {\n+\n+    @Inject\n+    private EnvMtaMetadataParser envMtaMetadataParser;\n+\n+    public List<DeployedMta> getAllDeployedMtas(CloudControllerClient client) {\n+        Map<String, List<CloudApplication>> applicationsByMtaId = getApplicationsByMtaId(client);\n+        return applicationsByMtaId.values()\n+                                  .stream()\n+                                  .map(this::toDeployedMta)\n+                                  .collect(Collectors.toList());\n+    }\n+\n+    private Map<String, List<CloudApplication>> getApplicationsByMtaId(CloudControllerClient client) {\n+        Map<String, List<CloudApplication>> applicationsByMtaId = new HashMap<>();\n+        List<CloudApplication> applications = getApplicationsWithEnvMetadata(client);\n+        for (CloudApplication application : applications) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI2MzEzNw=="}, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTYyNTQ1OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/entity/processor/MtaMetadataEntityAggregator.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOToxNDowM1rOFjBOuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMDoyMzowN1rOFjDV6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI2NDYzMw==", "bodyText": "can be substituted with\nentities.stream().collect(groupingBy(entity -> parseMetadata(entity).getId())", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372264633", "createdAt": "2020-01-29T09:14:03Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/entity/processor/MtaMetadataEntityAggregator.java", "diffHunk": "@@ -0,0 +1,106 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.cloudfoundry.client.lib.domain.CloudEntity;\n+import org.cloudfoundry.client.lib.domain.CloudService;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.MtaMetadataParser;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMta;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+@Component\n+public class MtaMetadataEntityAggregator {\n+\n+    @Inject\n+    private MtaMetadataParser mtaMetadataParser;\n+\n+    public List<DeployedMta> aggregate(List<CloudEntity> entities) {\n+        Map<String, List<CloudEntity>> entitiesByMtaId = getEntitiesByMtaId(entities);\n+        return entitiesByMtaId.values()\n+                              .stream()\n+                              .map(this::toDeployedMta)\n+                              .collect(Collectors.toList());\n+    }\n+\n+    private Map<String, List<CloudEntity>> getEntitiesByMtaId(List<CloudEntity> entities) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI5OTI0Mw==", "bodyText": "Same as above response.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372299243", "createdAt": "2020-01-29T10:23:07Z", "author": {"login": "valentinEmpy"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/entity/processor/MtaMetadataEntityAggregator.java", "diffHunk": "@@ -0,0 +1,106 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.cloudfoundry.client.lib.domain.CloudEntity;\n+import org.cloudfoundry.client.lib.domain.CloudService;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.MtaMetadataParser;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMta;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+@Component\n+public class MtaMetadataEntityAggregator {\n+\n+    @Inject\n+    private MtaMetadataParser mtaMetadataParser;\n+\n+    public List<DeployedMta> aggregate(List<CloudEntity> entities) {\n+        Map<String, List<CloudEntity>> entitiesByMtaId = getEntitiesByMtaId(entities);\n+        return entitiesByMtaId.values()\n+                              .stream()\n+                              .map(this::toDeployedMta)\n+                              .collect(Collectors.toList());\n+    }\n+\n+    private Map<String, List<CloudEntity>> getEntitiesByMtaId(List<CloudEntity> entities) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI2NDYzMw=="}, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTY1MDQwOnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/processor/EnvMtaMetadataParser.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOToyMjo1OVrOFjBe-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMDoyMzoxMlrOFjDWIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI2ODc5Mw==", "bodyText": "This is a bit confusing. The check is if the keys of the env don't have common elements with the metadata fields and then negates it. That's a bit roundabout.\nI would prefer the other way around.\nChange it to app.getEnv().keySet().stream().anyMatch(ENV_METADATA_FIELDS::contains)\nAnd if you want that slight bit of performance, change the type of the env_metadata_fields to a HashSet", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372268793", "createdAt": "2020-01-29T09:22:59Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/processor/EnvMtaMetadataParser.java", "diffHunk": "@@ -0,0 +1,134 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.processor;\n+\n+import java.text.MessageFormat;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.sap.cloud.lm.sl.cf.core.Constants;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.message.Messages;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMtaResource;\n+import com.sap.cloud.lm.sl.common.ParsingException;\n+import com.sap.cloud.lm.sl.common.util.JsonUtil;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+@Component\n+public class EnvMtaMetadataParser {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EnvMtaMetadataParser.class);\n+    private static final List<String> ENV_METADATA_FIELDS = Arrays.asList(Constants.ENV_MTA_METADATA, Constants.ENV_MTA_MODULE_METADATA,\n+                                                                         Constants.ENV_MTA_SERVICES,\n+                                                                         Constants.ENV_MTA_MODULE_PUBLIC_PROVIDED_DEPENDENCIES);\n+\n+    public boolean hasMtaMetadata(CloudApplication application) {\n+        return !Collections.disjoint(application.getEnv()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI5OTI5Ng==", "bodyText": "Agreed. I also do not like the complexity of disjoint.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372299296", "createdAt": "2020-01-29T10:23:12Z", "author": {"login": "valentinEmpy"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/processor/EnvMtaMetadataParser.java", "diffHunk": "@@ -0,0 +1,134 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.processor;\n+\n+import java.text.MessageFormat;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.sap.cloud.lm.sl.cf.core.Constants;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.message.Messages;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMtaResource;\n+import com.sap.cloud.lm.sl.common.ParsingException;\n+import com.sap.cloud.lm.sl.common.util.JsonUtil;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+@Component\n+public class EnvMtaMetadataParser {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EnvMtaMetadataParser.class);\n+    private static final List<String> ENV_METADATA_FIELDS = Arrays.asList(Constants.ENV_MTA_METADATA, Constants.ENV_MTA_MODULE_METADATA,\n+                                                                         Constants.ENV_MTA_SERVICES,\n+                                                                         Constants.ENV_MTA_MODULE_PUBLIC_PROVIDED_DEPENDENCIES);\n+\n+    public boolean hasMtaMetadata(CloudApplication application) {\n+        return !Collections.disjoint(application.getEnv()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI2ODc5Mw=="}, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTY3MTA2OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/processor/MtaMetadataParser.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOToyOToyNVrOFjBrkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMDoyMzoxN1rOFjDWVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI3MjAxNg==", "bodyText": "Shouldn't this be negated?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372272016", "createdAt": "2020-01-29T09:29:25Z", "author": {"login": "radito3"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/processor/MtaMetadataParser.java", "diffHunk": "@@ -0,0 +1,100 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.processor;\n+\n+import static com.sap.cloud.lm.sl.cf.core.cf.metadata.util.MtaMetadataUtil.getMtaId;\n+import static com.sap.cloud.lm.sl.cf.core.cf.metadata.util.MtaMetadataUtil.getMtaVersion;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.cloudfoundry.client.lib.domain.CloudEntity;\n+import org.cloudfoundry.client.lib.domain.CloudService;\n+import org.cloudfoundry.client.v3.Metadata;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadataAnnotations;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadataLabels;\n+import com.sap.cloud.lm.sl.cf.core.message.Messages;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.common.ParsingException;\n+import com.sap.cloud.lm.sl.common.util.JsonUtil;\n+\n+@Component\n+public class MtaMetadataParser {\n+\n+    private static final List<String> METADATA_LABELS = Arrays.asList(MtaMetadataLabels.MTA_ID, MtaMetadataLabels.MTA_VERSION);\n+\n+    public boolean hasMtaMetadata(CloudEntity entity) {\n+        Metadata metadata = entity.getV3Metadata();\n+        if (metadata == null || metadata.getLabels() == null) {\n+            return false;\n+        }\n+        return Collections.disjoint(metadata.getLabels()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI5OTM0OA==", "bodyText": "It should. Will replace this with stream anyMatch to avoid mistakes as this one and to avoid the complexity.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372299348", "createdAt": "2020-01-29T10:23:17Z", "author": {"login": "valentinEmpy"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/processor/MtaMetadataParser.java", "diffHunk": "@@ -0,0 +1,100 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.processor;\n+\n+import static com.sap.cloud.lm.sl.cf.core.cf.metadata.util.MtaMetadataUtil.getMtaId;\n+import static com.sap.cloud.lm.sl.cf.core.cf.metadata.util.MtaMetadataUtil.getMtaVersion;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.cloudfoundry.client.lib.domain.CloudEntity;\n+import org.cloudfoundry.client.lib.domain.CloudService;\n+import org.cloudfoundry.client.v3.Metadata;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadataAnnotations;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadataLabels;\n+import com.sap.cloud.lm.sl.cf.core.message.Messages;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.common.ParsingException;\n+import com.sap.cloud.lm.sl.common.util.JsonUtil;\n+\n+@Component\n+public class MtaMetadataParser {\n+\n+    private static final List<String> METADATA_LABELS = Arrays.asList(MtaMetadataLabels.MTA_ID, MtaMetadataLabels.MTA_VERSION);\n+\n+    public boolean hasMtaMetadata(CloudEntity entity) {\n+        Metadata metadata = entity.getV3Metadata();\n+        if (metadata == null || metadata.getLabels() == null) {\n+            return false;\n+        }\n+        return Collections.disjoint(metadata.getLabels()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI3MjAxNg=="}, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTY3NjE5OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaDetector.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTozMTowMlrOFjBuqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTozMTowMlrOFjBuqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI3MjgwOQ==", "bodyText": "Extract this to method as well.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372272809", "createdAt": "2020-01-29T09:31:02Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaDetector.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.detect;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.collections4.ListUtils;\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudEntity;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.criteria.MtaMetadataCriteria;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.criteria.MtaMetadataCriteriaBuilder;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor.MtaMetadataEntityAggregator;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor.MtaMetadataEntityCollector;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+\n+@Component\n+public class DeployedMtaDetector {\n+\n+    @Inject\n+    private List<MtaMetadataEntityCollector<?>> mtaMetadataEntityCollectors;\n+\n+    @Inject\n+    private MtaMetadataEntityAggregator mtaMetadataEntityAggregator;\n+\n+    @Inject\n+    private DeployedMtaEnvDetector deployedMtaEnvDetector;\n+\n+    public List<DeployedMta> getAllDeployedMtas(CloudControllerClient client) {\n+        MtaMetadataCriteria selectionCriteria = MtaMetadataCriteriaBuilder.builder()\n+                                                                          .label(MtaMetadataCriteriaBuilder.LABEL_MTA_ID)\n+                                                                          .exists()\n+                                                                          .build();\n+        List<DeployedMta> deployedMtas = getDeployedMtasByMetadataSelectionCriteria(selectionCriteria, client);\n+        List<DeployedMta> deployedMtasByEnv = deployedMtaEnvDetector.getAllDeployedMtas(client)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTY3ODk1OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaDetector.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTozMTo1N1rOFjBwaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTozMTo1N1rOFjBwaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI3MzI1Nw==", "bodyText": "Order to method by their invocation order.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372273257", "createdAt": "2020-01-29T09:31:57Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaDetector.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.detect;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.collections4.ListUtils;\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudEntity;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.criteria.MtaMetadataCriteria;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.criteria.MtaMetadataCriteriaBuilder;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor.MtaMetadataEntityAggregator;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor.MtaMetadataEntityCollector;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+\n+@Component\n+public class DeployedMtaDetector {\n+\n+    @Inject\n+    private List<MtaMetadataEntityCollector<?>> mtaMetadataEntityCollectors;\n+\n+    @Inject\n+    private MtaMetadataEntityAggregator mtaMetadataEntityAggregator;\n+\n+    @Inject\n+    private DeployedMtaEnvDetector deployedMtaEnvDetector;\n+\n+    public List<DeployedMta> getAllDeployedMtas(CloudControllerClient client) {\n+        MtaMetadataCriteria selectionCriteria = MtaMetadataCriteriaBuilder.builder()\n+                                                                          .label(MtaMetadataCriteriaBuilder.LABEL_MTA_ID)\n+                                                                          .exists()\n+                                                                          .build();\n+        List<DeployedMta> deployedMtas = getDeployedMtasByMetadataSelectionCriteria(selectionCriteria, client);\n+        List<DeployedMta> deployedMtasByEnv = deployedMtaEnvDetector.getAllDeployedMtas(client)\n+                                                                    .stream()\n+                                                                    .filter(deployedMtaByEnv -> !deployedMtas.contains(deployedMtaByEnv))\n+                                                                    .collect(Collectors.toList());\n+        return ListUtils.union(deployedMtas, deployedMtasByEnv);\n+    }\n+\n+    private List<DeployedMta> getDeployedMtasByMetadataSelectionCriteria(MtaMetadataCriteria criteria, CloudControllerClient client) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTY4MTc2OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/entity/processor/MtaMetadataEntityCollector.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTozMjo1OFrOFjByGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTozMjo1OFrOFjByGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI3MzY4OQ==", "bodyText": "Re-order the args(client, criteria) - this way it would match some of the others interfaces we have which are working with the Client.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372273689", "createdAt": "2020-01-29T09:32:58Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/entity/processor/MtaMetadataEntityCollector.java", "diffHunk": "@@ -0,0 +1,14 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor;\n+\n+import java.util.List;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudEntity;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.criteria.MtaMetadataCriteria;\n+\n+public interface MtaMetadataEntityCollector<T extends CloudEntity> {\n+\n+    List<T> collect(MtaMetadataCriteria criteria, CloudControllerClient client);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTY4NDQxOnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaDetector.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTozMzozNlrOFjBzjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTozMzozNlrOFjBzjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI3NDA2Mw==", "bodyText": "Use Named annotation for consistency", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372274063", "createdAt": "2020-01-29T09:33:36Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaDetector.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.detect;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.collections4.ListUtils;\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudEntity;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.criteria.MtaMetadataCriteria;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.criteria.MtaMetadataCriteriaBuilder;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor.MtaMetadataEntityAggregator;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor.MtaMetadataEntityCollector;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+\n+@Component", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTY4ODQ3OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaDetector.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTozNDo1NVrOFjB2Cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTozNDo1NVrOFjB2Cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI3NDY5OA==", "bodyText": "Maybe detectDeployedMtas ?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372274698", "createdAt": "2020-01-29T09:34:55Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaDetector.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.detect;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.collections4.ListUtils;\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudEntity;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.criteria.MtaMetadataCriteria;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.criteria.MtaMetadataCriteriaBuilder;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor.MtaMetadataEntityAggregator;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor.MtaMetadataEntityCollector;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+\n+@Component\n+public class DeployedMtaDetector {\n+\n+    @Inject\n+    private List<MtaMetadataEntityCollector<?>> mtaMetadataEntityCollectors;\n+\n+    @Inject\n+    private MtaMetadataEntityAggregator mtaMetadataEntityAggregator;\n+\n+    @Inject\n+    private DeployedMtaEnvDetector deployedMtaEnvDetector;\n+\n+    public List<DeployedMta> getAllDeployedMtas(CloudControllerClient client) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTY4OTIwOnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaDetector.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTozNToxMFrOFjB2fQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTozNToxMFrOFjB2fQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI3NDgxMw==", "bodyText": "Maybe detect...?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372274813", "createdAt": "2020-01-29T09:35:10Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaDetector.java", "diffHunk": "@@ -0,0 +1,66 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.detect;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.apache.commons.collections4.ListUtils;\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudEntity;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.criteria.MtaMetadataCriteria;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.criteria.MtaMetadataCriteriaBuilder;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor.MtaMetadataEntityAggregator;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor.MtaMetadataEntityCollector;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+\n+@Component\n+public class DeployedMtaDetector {\n+\n+    @Inject\n+    private List<MtaMetadataEntityCollector<?>> mtaMetadataEntityCollectors;\n+\n+    @Inject\n+    private MtaMetadataEntityAggregator mtaMetadataEntityAggregator;\n+\n+    @Inject\n+    private DeployedMtaEnvDetector deployedMtaEnvDetector;\n+\n+    public List<DeployedMta> getAllDeployedMtas(CloudControllerClient client) {\n+        MtaMetadataCriteria selectionCriteria = MtaMetadataCriteriaBuilder.builder()\n+                                                                          .label(MtaMetadataCriteriaBuilder.LABEL_MTA_ID)\n+                                                                          .exists()\n+                                                                          .build();\n+        List<DeployedMta> deployedMtas = getDeployedMtasByMetadataSelectionCriteria(selectionCriteria, client);\n+        List<DeployedMta> deployedMtasByEnv = deployedMtaEnvDetector.getAllDeployedMtas(client)\n+                                                                    .stream()\n+                                                                    .filter(deployedMtaByEnv -> !deployedMtas.contains(deployedMtaByEnv))\n+                                                                    .collect(Collectors.toList());\n+        return ListUtils.union(deployedMtas, deployedMtasByEnv);\n+    }\n+\n+    private List<DeployedMta> getDeployedMtasByMetadataSelectionCriteria(MtaMetadataCriteria criteria, CloudControllerClient client) {\n+        List<CloudEntity> mtaMetadataEntities = mtaMetadataEntityCollectors.stream()\n+                                                                           .map(collector -> collector.collect(criteria, client))\n+                                                                           .flatMap(List::stream)\n+                                                                           .collect(Collectors.toList());\n+        return mtaMetadataEntityAggregator.aggregate(mtaMetadataEntities);\n+    }\n+\n+    public Optional<DeployedMta> getDeployedMta(String mtaId, CloudControllerClient client) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTY5MTAyOnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaEnvDetector.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTozNTo1MFrOFjB3qQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTozNTo1MFrOFjB3qQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI3NTExMw==", "bodyText": "We are aware of this TODO.\nBetter - remove it and write a java doc which explains it.\nAlso, add Deprecated annotation", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372275113", "createdAt": "2020-01-29T09:35:50Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaEnvDetector.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.detect;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.Constants;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.EnvMtaMetadataParser;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMta;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+//TODO delete this class and its usages after the CF metadata becomes the go to metadata approach", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTY5Mjc1OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaEnvDetector.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTozNjoyN1rOFjB41w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTozNjoyN1rOFjB41w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI3NTQxNQ==", "bodyText": "I would use Constructor based injection for one or two class fields", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372275415", "createdAt": "2020-01-29T09:36:27Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaEnvDetector.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.detect;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.Constants;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.EnvMtaMetadataParser;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMta;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+//TODO delete this class and its usages after the CF metadata becomes the go to metadata approach\n+//A release note should be already present explaining that the migration (at least one mta redeploy) is mandatory\n+@Component\n+public class DeployedMtaEnvDetector {\n+\n+    @Inject\n+    private EnvMtaMetadataParser envMtaMetadataParser;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTY5NTg5OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaEnvDetector.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTozNzoyOFrOFjB60w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTozNzoyOFrOFjB60w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI3NTkyMw==", "bodyText": "Hmm both detectors have, maybe, the same interface??", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372275923", "createdAt": "2020-01-29T09:37:28Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaEnvDetector.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.detect;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.Constants;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.EnvMtaMetadataParser;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMta;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+//TODO delete this class and its usages after the CF metadata becomes the go to metadata approach\n+//A release note should be already present explaining that the migration (at least one mta redeploy) is mandatory\n+@Component\n+public class DeployedMtaEnvDetector {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTcxOTA3OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/entity/processor/MtaMetadataEntityAggregator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTo0NDo0OFrOFjCJfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTo0NDo0OFrOFjCJfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI3OTY3OQ==", "bodyText": "I think entries.get(0) is confusing.\nWhy don't just iterate trhrough the entryset and then for each do the below methods?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372279679", "createdAt": "2020-01-29T09:44:48Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/entity/processor/MtaMetadataEntityAggregator.java", "diffHunk": "@@ -0,0 +1,106 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.cloudfoundry.client.lib.domain.CloudEntity;\n+import org.cloudfoundry.client.lib.domain.CloudService;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.MtaMetadataParser;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMta;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+@Component\n+public class MtaMetadataEntityAggregator {\n+\n+    @Inject\n+    private MtaMetadataParser mtaMetadataParser;\n+\n+    public List<DeployedMta> aggregate(List<CloudEntity> entities) {\n+        Map<String, List<CloudEntity>> entitiesByMtaId = getEntitiesByMtaId(entities);\n+        return entitiesByMtaId.values()\n+                              .stream()\n+                              .map(this::toDeployedMta)\n+                              .collect(Collectors.toList());\n+    }\n+\n+    private Map<String, List<CloudEntity>> getEntitiesByMtaId(List<CloudEntity> entities) {\n+        Map<String, List<CloudEntity>> entitiesByMtaId = new HashMap<>();\n+        for (CloudEntity entity : entities) {\n+            String mtaId = mtaMetadataParser.parseMtaMetadata(entity)\n+                                            .getId();\n+            if (entitiesByMtaId.containsKey(mtaId)) {\n+                entitiesByMtaId.get(mtaId)\n+                               .add(entity);\n+            } else {\n+                entitiesByMtaId.put(mtaId, new ArrayList<>(Arrays.asList(entity)));\n+            }\n+        }\n+        return entitiesByMtaId;\n+    }\n+\n+    private DeployedMta toDeployedMta(List<CloudEntity> entities) {\n+        MtaMetadata mtaMetadata = getMtaMetadata(entities);\n+        return ImmutableDeployedMta.builder()\n+                                   .metadata(mtaMetadata)\n+                                   .modules(getModules(entities))\n+                                   .resources(getResources(entities))\n+                                   .build();\n+    }\n+\n+    private MtaMetadata getMtaMetadata(List<CloudEntity> entities) {\n+        String mtaId = mtaMetadataParser.parseMtaMetadata(entities.get(0))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTcyMjI5OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/entity/processor/MtaMetadataEntityAggregator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTo0NTo1MFrOFjCLhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTo0NTo1MFrOFjCLhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI4MDE5Nw==", "bodyText": "maybe groupEntitiesByMtaId?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372280197", "createdAt": "2020-01-29T09:45:50Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/entity/processor/MtaMetadataEntityAggregator.java", "diffHunk": "@@ -0,0 +1,106 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.cloudfoundry.client.lib.domain.CloudEntity;\n+import org.cloudfoundry.client.lib.domain.CloudService;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.MtaMetadataParser;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMta;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+@Component\n+public class MtaMetadataEntityAggregator {\n+\n+    @Inject\n+    private MtaMetadataParser mtaMetadataParser;\n+\n+    public List<DeployedMta> aggregate(List<CloudEntity> entities) {\n+        Map<String, List<CloudEntity>> entitiesByMtaId = getEntitiesByMtaId(entities);\n+        return entitiesByMtaId.values()\n+                              .stream()\n+                              .map(this::toDeployedMta)\n+                              .collect(Collectors.toList());\n+    }\n+\n+    private Map<String, List<CloudEntity>> getEntitiesByMtaId(List<CloudEntity> entities) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTcyMzA2OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/entity/processor/MtaMetadataEntityAggregator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTo0NjowNlrOFjCMAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTo0NjowNlrOFjCMAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI4MDMyMw==", "bodyText": "Rename it to result - easy for reading.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372280323", "createdAt": "2020-01-29T09:46:06Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/entity/processor/MtaMetadataEntityAggregator.java", "diffHunk": "@@ -0,0 +1,106 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.cloudfoundry.client.lib.domain.CloudEntity;\n+import org.cloudfoundry.client.lib.domain.CloudService;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.MtaMetadataParser;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMta;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+@Component\n+public class MtaMetadataEntityAggregator {\n+\n+    @Inject\n+    private MtaMetadataParser mtaMetadataParser;\n+\n+    public List<DeployedMta> aggregate(List<CloudEntity> entities) {\n+        Map<String, List<CloudEntity>> entitiesByMtaId = getEntitiesByMtaId(entities);\n+        return entitiesByMtaId.values()\n+                              .stream()\n+                              .map(this::toDeployedMta)\n+                              .collect(Collectors.toList());\n+    }\n+\n+    private Map<String, List<CloudEntity>> getEntitiesByMtaId(List<CloudEntity> entities) {\n+        Map<String, List<CloudEntity>> entitiesByMtaId = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTc1NzEwOnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/entity/processor/MtaMetadataEntityAggregator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTo1NjoyOVrOFjChkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTo1NjoyOVrOFjChkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI4NTg0Mw==", "bodyText": "What about computeIfAbsent?\nTry it - if it is readable and understandable -> do it that way otherwise leave it as it is.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372285843", "createdAt": "2020-01-29T09:56:29Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/entity/processor/MtaMetadataEntityAggregator.java", "diffHunk": "@@ -0,0 +1,106 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.cloudfoundry.client.lib.domain.CloudEntity;\n+import org.cloudfoundry.client.lib.domain.CloudService;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.MtaMetadataParser;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMta;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+@Component\n+public class MtaMetadataEntityAggregator {\n+\n+    @Inject\n+    private MtaMetadataParser mtaMetadataParser;\n+\n+    public List<DeployedMta> aggregate(List<CloudEntity> entities) {\n+        Map<String, List<CloudEntity>> entitiesByMtaId = getEntitiesByMtaId(entities);\n+        return entitiesByMtaId.values()\n+                              .stream()\n+                              .map(this::toDeployedMta)\n+                              .collect(Collectors.toList());\n+    }\n+\n+    private Map<String, List<CloudEntity>> getEntitiesByMtaId(List<CloudEntity> entities) {\n+        Map<String, List<CloudEntity>> entitiesByMtaId = new HashMap<>();\n+        for (CloudEntity entity : entities) {\n+            String mtaId = mtaMetadataParser.parseMtaMetadata(entity)\n+                                            .getId();\n+            if (entitiesByMtaId.containsKey(mtaId)) {\n+                entitiesByMtaId.get(mtaId)\n+                               .add(entity);\n+            } else {\n+                entitiesByMtaId.put(mtaId, new ArrayList<>(Arrays.asList(entity)));\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTc2NTc0OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaEnvDetector.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTo1OTowNlrOFjCnDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTo1OTowNlrOFjCnDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI4NzI0NA==", "bodyText": "Do we need to check for the others except Constants.ENV_MTA_METADATA", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372287244", "createdAt": "2020-01-29T09:59:06Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaEnvDetector.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.detect;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.Constants;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.EnvMtaMetadataParser;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMta;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+//TODO delete this class and its usages after the CF metadata becomes the go to metadata approach\n+//A release note should be already present explaining that the migration (at least one mta redeploy) is mandatory\n+@Component\n+public class DeployedMtaEnvDetector {\n+\n+    @Inject\n+    private EnvMtaMetadataParser envMtaMetadataParser;\n+\n+    public List<DeployedMta> getAllDeployedMtas(CloudControllerClient client) {\n+        Map<String, List<CloudApplication>> applicationsByMtaId = getApplicationsByMtaId(client);\n+        return applicationsByMtaId.values()\n+                                  .stream()\n+                                  .map(this::toDeployedMta)\n+                                  .collect(Collectors.toList());\n+    }\n+\n+    private Map<String, List<CloudApplication>> getApplicationsByMtaId(CloudControllerClient client) {\n+        Map<String, List<CloudApplication>> applicationsByMtaId = new HashMap<>();\n+        List<CloudApplication> applications = getApplicationsWithEnvMetadata(client);\n+        for (CloudApplication application : applications) {\n+            String mtaId = envMtaMetadataParser.parseMtaMetadata(application)\n+                                               .getId();\n+            if (applicationsByMtaId.containsKey(mtaId)) {\n+                applicationsByMtaId.get(mtaId)\n+                                   .add(application);\n+            } else {\n+                applicationsByMtaId.put(mtaId, new ArrayList<>(Arrays.asList(application)));\n+            }\n+        }\n+        return applicationsByMtaId;\n+    }\n+\n+    private List<CloudApplication> getApplicationsWithEnvMetadata(CloudControllerClient client) {\n+        return client.getApplications()\n+                     .stream()\n+                     .filter(this::hasEnvMetadata)\n+                     .collect(Collectors.toList());\n+    }\n+\n+    private boolean hasEnvMetadata(CloudApplication application) {\n+        Map<String, String> env = application.getEnv();\n+        return env.containsKey(Constants.ENV_MTA_METADATA) || env.containsKey(Constants.ENV_MTA_MODULE_METADATA)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTc2ODA2OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaEnvDetector.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTo1OTo1MVrOFjCokA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwOTo1OTo1MVrOFjCokA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI4NzYzMg==", "bodyText": "Hmmmmm I think I have already seen this ????????!??!?!?!?!?!", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372287632", "createdAt": "2020-01-29T09:59:51Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/detect/DeployedMtaEnvDetector.java", "diffHunk": "@@ -0,0 +1,121 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.detect;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.Constants;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.EnvMtaMetadataParser;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMta;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+//TODO delete this class and its usages after the CF metadata becomes the go to metadata approach\n+//A release note should be already present explaining that the migration (at least one mta redeploy) is mandatory\n+@Component\n+public class DeployedMtaEnvDetector {\n+\n+    @Inject\n+    private EnvMtaMetadataParser envMtaMetadataParser;\n+\n+    public List<DeployedMta> getAllDeployedMtas(CloudControllerClient client) {\n+        Map<String, List<CloudApplication>> applicationsByMtaId = getApplicationsByMtaId(client);\n+        return applicationsByMtaId.values()\n+                                  .stream()\n+                                  .map(this::toDeployedMta)\n+                                  .collect(Collectors.toList());\n+    }\n+\n+    private Map<String, List<CloudApplication>> getApplicationsByMtaId(CloudControllerClient client) {\n+        Map<String, List<CloudApplication>> applicationsByMtaId = new HashMap<>();\n+        List<CloudApplication> applications = getApplicationsWithEnvMetadata(client);\n+        for (CloudApplication application : applications) {\n+            String mtaId = envMtaMetadataParser.parseMtaMetadata(application)\n+                                               .getId();\n+            if (applicationsByMtaId.containsKey(mtaId)) {\n+                applicationsByMtaId.get(mtaId)\n+                                   .add(application);\n+            } else {\n+                applicationsByMtaId.put(mtaId, new ArrayList<>(Arrays.asList(application)));\n+            }\n+        }\n+        return applicationsByMtaId;\n+    }\n+\n+    private List<CloudApplication> getApplicationsWithEnvMetadata(CloudControllerClient client) {\n+        return client.getApplications()\n+                     .stream()\n+                     .filter(this::hasEnvMetadata)\n+                     .collect(Collectors.toList());\n+    }\n+\n+    private boolean hasEnvMetadata(CloudApplication application) {\n+        Map<String, String> env = application.getEnv();\n+        return env.containsKey(Constants.ENV_MTA_METADATA) || env.containsKey(Constants.ENV_MTA_MODULE_METADATA)\n+            || env.containsKey(Constants.ENV_MTA_SERVICES) || env.containsKey(Constants.ENV_MTA_MODULE_PUBLIC_PROVIDED_DEPENDENCIES);\n+    }\n+\n+    private DeployedMta toDeployedMta(List<CloudApplication> applications) {\n+        MtaMetadata mtaMetadata = getMtaMetadata(applications);\n+        List<DeployedMtaModule> modules = new ArrayList<>();\n+        List<DeployedMtaResource> resources = new ArrayList<>();\n+        for (CloudApplication application : applications) {\n+            DeployedMtaModule module = envMtaMetadataParser.parseModule(application);\n+            modules.add(module);\n+            resources.addAll(module.getResources());\n+        }\n+        return ImmutableDeployedMta.builder()\n+                                   .metadata(mtaMetadata)\n+                                   .modules(modules)\n+                                   .resources(resources)\n+                                   .build();\n+    }\n+\n+    private MtaMetadata getMtaMetadata(List<CloudApplication> applications) {\n+        String mtaId = envMtaMetadataParser.parseMtaMetadata(applications.get(0))\n+                                           .getId();\n+        Version version = getVersion(applications);\n+        return ImmutableMtaMetadata.builder()\n+                                   .id(mtaId)\n+                                   .version(version)\n+                                   .build();\n+    }\n+\n+    private Version getVersion(List<CloudApplication> applications) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 98}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTc3MjAwOnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/entity/processor/MtaMetadataApplicationCollector.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMDowMDo1NlrOFjCq5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzowMTowN1rOFjHi4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI4ODIyOA==", "bodyText": "Named", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372288228", "createdAt": "2020-01-29T10:00:56Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/entity/processor/MtaMetadataApplicationCollector.java", "diffHunk": "@@ -0,0 +1,18 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor;\n+\n+import java.util.List;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.criteria.MtaMetadataCriteria;\n+\n+@Component\n+public class MtaMetadataApplicationCollector implements MtaMetadataEntityCollector<CloudApplication> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM2ODA5OA==", "bodyText": "Apply Named annotation everywhere.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372368098", "createdAt": "2020-01-29T13:01:07Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/entity/processor/MtaMetadataApplicationCollector.java", "diffHunk": "@@ -0,0 +1,18 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor;\n+\n+import java.util.List;\n+\n+import org.cloudfoundry.client.lib.CloudControllerClient;\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.criteria.MtaMetadataCriteria;\n+\n+@Component\n+public class MtaMetadataApplicationCollector implements MtaMetadataEntityCollector<CloudApplication> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI4ODIyOA=="}, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTgzMDQ0OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/processor/EnvMtaMetadataParser.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMDoxOTowMVrOFjDOhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMDoxOTowMVrOFjDOhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI5NzM1MQ==", "bodyText": "Make it generic and put it in the method", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372297351", "createdAt": "2020-01-29T10:19:01Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/processor/EnvMtaMetadataParser.java", "diffHunk": "@@ -0,0 +1,134 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.processor;\n+\n+import java.text.MessageFormat;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.sap.cloud.lm.sl.cf.core.Constants;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.message.Messages;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMtaResource;\n+import com.sap.cloud.lm.sl.common.ParsingException;\n+import com.sap.cloud.lm.sl.common.util.JsonUtil;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+@Component\n+public class EnvMtaMetadataParser {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EnvMtaMetadataParser.class);\n+    private static final List<String> ENV_METADATA_FIELDS = Arrays.asList(Constants.ENV_MTA_METADATA, Constants.ENV_MTA_MODULE_METADATA,\n+                                                                         Constants.ENV_MTA_SERVICES,\n+                                                                         Constants.ENV_MTA_MODULE_PUBLIC_PROVIDED_DEPENDENCIES);\n+\n+    public boolean hasMtaMetadata(CloudApplication application) {\n+        return !Collections.disjoint(application.getEnv()\n+                                                .keySet(),\n+                                     ENV_METADATA_FIELDS);\n+    }\n+\n+    public MtaMetadata parseMtaMetadata(CloudApplication application) {\n+        try {\n+            if (!isMtaMetadataComplete(application)) {\n+                throw new ParsingException(Messages.MTA_METADATA_FOR_APP_0_IS_INCOMPLETE, application.getName());\n+            }\n+            String envMtaMetadata = application.getEnv()\n+                                               .get(Constants.ENV_MTA_METADATA);\n+            Map<String, Object> mtaMetadata = JsonUtil.convertJsonToMap(envMtaMetadata);\n+            String exceptionMessage = MessageFormat.format(Messages.ENV_OF_APP_0_CONTAINS_INVALID_VALUE_FOR_1, application.getName(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTgzNzI3OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/processor/MtaMetadataParser.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMDoyMToyMlrOFjDSpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMDoyMToyMlrOFjDSpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI5ODQwNw==", "bodyText": "Do we need to ignore the MTA_ID and MTA_VERSION if the v3 metadata is presented?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372298407", "createdAt": "2020-01-29T10:21:22Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/processor/MtaMetadataParser.java", "diffHunk": "@@ -0,0 +1,100 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.processor;\n+\n+import static com.sap.cloud.lm.sl.cf.core.cf.metadata.util.MtaMetadataUtil.getMtaId;\n+import static com.sap.cloud.lm.sl.cf.core.cf.metadata.util.MtaMetadataUtil.getMtaVersion;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.cloudfoundry.client.lib.domain.CloudEntity;\n+import org.cloudfoundry.client.lib.domain.CloudService;\n+import org.cloudfoundry.client.v3.Metadata;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadataAnnotations;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadataLabels;\n+import com.sap.cloud.lm.sl.cf.core.message.Messages;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.common.ParsingException;\n+import com.sap.cloud.lm.sl.common.util.JsonUtil;\n+\n+@Component\n+public class MtaMetadataParser {\n+\n+    private static final List<String> METADATA_LABELS = Arrays.asList(MtaMetadataLabels.MTA_ID, MtaMetadataLabels.MTA_VERSION);\n+\n+    public boolean hasMtaMetadata(CloudEntity entity) {\n+        Metadata metadata = entity.getV3Metadata();\n+        if (metadata == null || metadata.getLabels() == null) {\n+            return false;\n+        }\n+        return Collections.disjoint(metadata.getLabels()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMTg0MTIxOnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/processor/MtaMetadataParser.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMDoyMjo0MVrOFjDVFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMDoyMjo0MVrOFjDVFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI5OTAyOQ==", "bodyText": "Do we need this check?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372299029", "createdAt": "2020-01-29T10:22:41Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/processor/MtaMetadataParser.java", "diffHunk": "@@ -0,0 +1,100 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.processor;\n+\n+import static com.sap.cloud.lm.sl.cf.core.cf.metadata.util.MtaMetadataUtil.getMtaId;\n+import static com.sap.cloud.lm.sl.cf.core.cf.metadata.util.MtaMetadataUtil.getMtaVersion;\n+\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.cloudfoundry.client.lib.domain.CloudEntity;\n+import org.cloudfoundry.client.lib.domain.CloudService;\n+import org.cloudfoundry.client.v3.Metadata;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadataAnnotations;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadataLabels;\n+import com.sap.cloud.lm.sl.cf.core.message.Messages;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.common.ParsingException;\n+import com.sap.cloud.lm.sl.common.util.JsonUtil;\n+\n+@Component\n+public class MtaMetadataParser {\n+\n+    private static final List<String> METADATA_LABELS = Arrays.asList(MtaMetadataLabels.MTA_ID, MtaMetadataLabels.MTA_VERSION);\n+\n+    public boolean hasMtaMetadata(CloudEntity entity) {\n+        Metadata metadata = entity.getV3Metadata();\n+        if (metadata == null || metadata.getLabels() == null) {\n+            return false;\n+        }\n+        return Collections.disjoint(metadata.getLabels()\n+                                            .keySet(),\n+                                    METADATA_LABELS);\n+    }\n+\n+    public MtaMetadata parseMtaMetadata(CloudEntity entity) {\n+        try {\n+            if (!isMtaMetadataComplete(entity)) {\n+                throw new ParsingException(Messages.MTA_METADATA_FOR_0_IS_INCOMPLETE, entity.getName());\n+            }\n+            return toMtaMetadata(entity.getV3Metadata());\n+        } catch (ParsingException e) {\n+            throw new ParsingException(e, Messages.CANT_PARSE_MTA_METADATA_FOR_0, entity.getName());\n+        }\n+    }\n+\n+    private boolean isMtaMetadataComplete(CloudEntity entity) {\n+        return entity.getV3Metadata()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4603b0626b9898d17e21f3643adc5926df7bca3a"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMjI4NDQyOnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/entity/processor/MtaMetadataEntityAggregator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzowMTo0N1rOFjHkEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzowMTo0N1rOFjHkEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM2ODQwMw==", "bodyText": "HMMMMMM, I think the whole class is somehow duplicated somewhere else?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372368403", "createdAt": "2020-01-29T13:01:47Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/entity/processor/MtaMetadataEntityAggregator.java", "diffHunk": "@@ -0,0 +1,106 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.entity.processor;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import javax.inject.Inject;\n+\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.cloudfoundry.client.lib.domain.CloudEntity;\n+import org.cloudfoundry.client.lib.domain.CloudService;\n+import org.springframework.stereotype.Component;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.processor.MtaMetadataParser;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMta;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMta;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+@Component\n+public class MtaMetadataEntityAggregator {\n+\n+    @Inject\n+    private MtaMetadataParser mtaMetadataParser;\n+\n+    public List<DeployedMta> aggregate(List<CloudEntity> entities) {\n+        Map<String, List<CloudEntity>> entitiesByMtaId = getEntitiesByMtaId(entities);\n+        return entitiesByMtaId.values()\n+                              .stream()\n+                              .map(this::toDeployedMta)\n+                              .collect(Collectors.toList());\n+    }\n+\n+    private Map<String, List<CloudEntity>> getEntitiesByMtaId(List<CloudEntity> entities) {\n+        Map<String, List<CloudEntity>> entitiesByMtaId = new HashMap<>();\n+        for (CloudEntity entity : entities) {\n+            String mtaId = mtaMetadataParser.parseMtaMetadata(entity)\n+                                            .getId();\n+            if (entitiesByMtaId.containsKey(mtaId)) {\n+                entitiesByMtaId.get(mtaId)\n+                               .add(entity);\n+            } else {\n+                entitiesByMtaId.put(mtaId, new ArrayList<>(Arrays.asList(entity)));\n+            }\n+        }\n+        return entitiesByMtaId;\n+    }\n+\n+    private DeployedMta toDeployedMta(List<CloudEntity> entities) {\n+        MtaMetadata mtaMetadata = getMtaMetadata(entities);\n+        return ImmutableDeployedMta.builder()\n+                                   .metadata(mtaMetadata)\n+                                   .modules(getModules(entities))\n+                                   .resources(getResources(entities))\n+                                   .build();\n+    }\n+\n+    private MtaMetadata getMtaMetadata(List<CloudEntity> entities) {\n+        String mtaId = mtaMetadataParser.parseMtaMetadata(entities.get(0))\n+                                        .getId();\n+        Version version = getVersion(entities);\n+        return ImmutableMtaMetadata.builder()\n+                                   .id(mtaId)\n+                                   .version(version)\n+                                   .build();\n+    }\n+\n+    private Version getVersion(List<CloudEntity> entities) {\n+        if (allHaveSameMtaVersion(entities)) {\n+            return mtaMetadataParser.parseMtaMetadata(entities.get(0))\n+                                    .getVersion();\n+        }\n+        return null;\n+    }\n+\n+    private boolean allHaveSameMtaVersion(List<CloudEntity> entities) {\n+        return entities.stream()\n+                       .map(entity -> mtaMetadataParser.parseMtaMetadata(entity)\n+                                                       .getVersion())\n+                       .distinct()\n+                       .count() == 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19fe229012989c6a094822b4c6c10241784cdf03"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMjI4NzA0OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/processor/EnvMtaMetadataParser.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzowMjo1MVrOFjHl0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzowMjo1MVrOFjHl0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM2ODg1MQ==", "bodyText": "Is it parsing exception? Isn't it IllegalState?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372368851", "createdAt": "2020-01-29T13:02:51Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/processor/EnvMtaMetadataParser.java", "diffHunk": "@@ -0,0 +1,135 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.processor;\n+\n+import java.text.MessageFormat;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.sap.cloud.lm.sl.cf.core.Constants;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.message.Messages;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMtaResource;\n+import com.sap.cloud.lm.sl.common.ParsingException;\n+import com.sap.cloud.lm.sl.common.util.JsonUtil;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+@Component\n+public class EnvMtaMetadataParser {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EnvMtaMetadataParser.class);\n+    private static final List<String> ENV_METADATA_FIELDS = Arrays.asList(Constants.ENV_MTA_METADATA, Constants.ENV_MTA_MODULE_METADATA,\n+                                                                          Constants.ENV_MTA_SERVICES,\n+                                                                          Constants.ENV_MTA_MODULE_PUBLIC_PROVIDED_DEPENDENCIES);\n+\n+    public boolean hasMtaMetadata(CloudApplication application) {\n+        return application.getEnv()\n+                          .keySet()\n+                          .stream()\n+                          .anyMatch(ENV_METADATA_FIELDS::contains);\n+    }\n+\n+    public MtaMetadata parseMtaMetadata(CloudApplication application) {\n+        try {\n+            if (!isMtaMetadataComplete(application)) {\n+                throw new ParsingException(Messages.MTA_METADATA_FOR_APP_0_IS_INCOMPLETE, application.getName());\n+            }\n+            String envMtaMetadata = application.getEnv()\n+                                               .get(Constants.ENV_MTA_METADATA);\n+            Map<String, Object> mtaMetadata = JsonUtil.convertJsonToMap(envMtaMetadata);\n+            String exceptionMessage = MessageFormat.format(Messages.ENV_OF_APP_0_CONTAINS_INVALID_VALUE_FOR_1, application.getName(),\n+                                                           Constants.ENV_MTA_METADATA);\n+            String id = (String) getRequired(mtaMetadata, Constants.ATTR_ID, exceptionMessage);\n+            String version = (String) getRequired(mtaMetadata, Constants.ATTR_VERSION, exceptionMessage);\n+            return ImmutableMtaMetadata.builder()\n+                                       .id(id)\n+                                       .version(Version.parseVersion(version))\n+                                       .build();\n+        } catch (ParsingException e) {\n+            throw new ParsingException(e, Messages.CANT_PARSE_MTA_ENV_METADATA_FOR_APP_0, application.getName());\n+        }\n+    }\n+\n+    private boolean isMtaMetadataComplete(CloudApplication application) {\n+        return application.getEnv()\n+                          .keySet()\n+                          .containsAll(ENV_METADATA_FIELDS);\n+    }\n+\n+    private <K, V> V getRequired(Map<K, V> map, K key, String exceptionMessage) {\n+        V value = map.get(key);\n+        if (value == null) {\n+            throw new ParsingException(exceptionMessage);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19fe229012989c6a094822b4c6c10241784cdf03"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMjI5MTU5OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/processor/EnvMtaMetadataParser.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzowNDoyN1rOFjHoqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzowNDoyN1rOFjHoqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM2OTU3Nw==", "bodyText": "I think the cast is not needed here", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372369577", "createdAt": "2020-01-29T13:04:27Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/processor/EnvMtaMetadataParser.java", "diffHunk": "@@ -0,0 +1,135 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.processor;\n+\n+import java.text.MessageFormat;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.sap.cloud.lm.sl.cf.core.Constants;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.message.Messages;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMtaResource;\n+import com.sap.cloud.lm.sl.common.ParsingException;\n+import com.sap.cloud.lm.sl.common.util.JsonUtil;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+@Component\n+public class EnvMtaMetadataParser {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EnvMtaMetadataParser.class);\n+    private static final List<String> ENV_METADATA_FIELDS = Arrays.asList(Constants.ENV_MTA_METADATA, Constants.ENV_MTA_MODULE_METADATA,\n+                                                                          Constants.ENV_MTA_SERVICES,\n+                                                                          Constants.ENV_MTA_MODULE_PUBLIC_PROVIDED_DEPENDENCIES);\n+\n+    public boolean hasMtaMetadata(CloudApplication application) {\n+        return application.getEnv()\n+                          .keySet()\n+                          .stream()\n+                          .anyMatch(ENV_METADATA_FIELDS::contains);\n+    }\n+\n+    public MtaMetadata parseMtaMetadata(CloudApplication application) {\n+        try {\n+            if (!isMtaMetadataComplete(application)) {\n+                throw new ParsingException(Messages.MTA_METADATA_FOR_APP_0_IS_INCOMPLETE, application.getName());\n+            }\n+            String envMtaMetadata = application.getEnv()\n+                                               .get(Constants.ENV_MTA_METADATA);\n+            Map<String, Object> mtaMetadata = JsonUtil.convertJsonToMap(envMtaMetadata);\n+            String exceptionMessage = MessageFormat.format(Messages.ENV_OF_APP_0_CONTAINS_INVALID_VALUE_FOR_1, application.getName(),\n+                                                           Constants.ENV_MTA_METADATA);\n+            String id = (String) getRequired(mtaMetadata, Constants.ATTR_ID, exceptionMessage);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19fe229012989c6a094822b4c6c10241784cdf03"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMjI5NTc0OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/processor/EnvMtaMetadataParser.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzowNTo1N1rOFjHrLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzowNTo1N1rOFjHrLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3MDIyMQ==", "bodyText": "services /resources ?!?!??!?!?!?!?!?!?!?!?!?!?!?!?!?!?!?!?!", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372370221", "createdAt": "2020-01-29T13:05:57Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/processor/EnvMtaMetadataParser.java", "diffHunk": "@@ -0,0 +1,135 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.processor;\n+\n+import java.text.MessageFormat;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.sap.cloud.lm.sl.cf.core.Constants;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.message.Messages;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMtaResource;\n+import com.sap.cloud.lm.sl.common.ParsingException;\n+import com.sap.cloud.lm.sl.common.util.JsonUtil;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+@Component\n+public class EnvMtaMetadataParser {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EnvMtaMetadataParser.class);\n+    private static final List<String> ENV_METADATA_FIELDS = Arrays.asList(Constants.ENV_MTA_METADATA, Constants.ENV_MTA_MODULE_METADATA,\n+                                                                          Constants.ENV_MTA_SERVICES,\n+                                                                          Constants.ENV_MTA_MODULE_PUBLIC_PROVIDED_DEPENDENCIES);\n+\n+    public boolean hasMtaMetadata(CloudApplication application) {\n+        return application.getEnv()\n+                          .keySet()\n+                          .stream()\n+                          .anyMatch(ENV_METADATA_FIELDS::contains);\n+    }\n+\n+    public MtaMetadata parseMtaMetadata(CloudApplication application) {\n+        try {\n+            if (!isMtaMetadataComplete(application)) {\n+                throw new ParsingException(Messages.MTA_METADATA_FOR_APP_0_IS_INCOMPLETE, application.getName());\n+            }\n+            String envMtaMetadata = application.getEnv()\n+                                               .get(Constants.ENV_MTA_METADATA);\n+            Map<String, Object> mtaMetadata = JsonUtil.convertJsonToMap(envMtaMetadata);\n+            String exceptionMessage = MessageFormat.format(Messages.ENV_OF_APP_0_CONTAINS_INVALID_VALUE_FOR_1, application.getName(),\n+                                                           Constants.ENV_MTA_METADATA);\n+            String id = (String) getRequired(mtaMetadata, Constants.ATTR_ID, exceptionMessage);\n+            String version = (String) getRequired(mtaMetadata, Constants.ATTR_VERSION, exceptionMessage);\n+            return ImmutableMtaMetadata.builder()\n+                                       .id(id)\n+                                       .version(Version.parseVersion(version))\n+                                       .build();\n+        } catch (ParsingException e) {\n+            throw new ParsingException(e, Messages.CANT_PARSE_MTA_ENV_METADATA_FOR_APP_0, application.getName());\n+        }\n+    }\n+\n+    private boolean isMtaMetadataComplete(CloudApplication application) {\n+        return application.getEnv()\n+                          .keySet()\n+                          .containsAll(ENV_METADATA_FIELDS);\n+    }\n+\n+    private <K, V> V getRequired(Map<K, V> map, K key, String exceptionMessage) {\n+        V value = map.get(key);\n+        if (value == null) {\n+            throw new ParsingException(exceptionMessage);\n+        }\n+        return value;\n+    }\n+\n+    public DeployedMtaModule parseModule(CloudApplication application) {\n+        try {\n+            if (!isMtaMetadataComplete(application)) {\n+                throw new ParsingException(Messages.MTA_METADATA_FOR_APP_0_IS_INCOMPLETE, application.getName());\n+            }\n+            String moduleName = parseModuleName(application);\n+            List<String> providedDependencyNames = parseProvidedDependencyNames(application);\n+            List<DeployedMtaResource> services = parseResources(application);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19fe229012989c6a094822b4c6c10241784cdf03"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMjMwNjIzOnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/processor/EnvMtaMetadataParser.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzowOTozNVrOFjHxjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzowOTozNVrOFjHxjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3MTg1Mw==", "bodyText": "This is common with the other convertion?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372371853", "createdAt": "2020-01-29T13:09:35Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/metadata/processor/EnvMtaMetadataParser.java", "diffHunk": "@@ -0,0 +1,135 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.metadata.processor;\n+\n+import java.text.MessageFormat;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import org.cloudfoundry.client.lib.domain.CloudApplication;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.sap.cloud.lm.sl.cf.core.Constants;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.ImmutableMtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadata;\n+import com.sap.cloud.lm.sl.cf.core.message.Messages;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMtaResource;\n+import com.sap.cloud.lm.sl.common.ParsingException;\n+import com.sap.cloud.lm.sl.common.util.JsonUtil;\n+import com.sap.cloud.lm.sl.mta.model.Version;\n+\n+@Component\n+public class EnvMtaMetadataParser {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(EnvMtaMetadataParser.class);\n+    private static final List<String> ENV_METADATA_FIELDS = Arrays.asList(Constants.ENV_MTA_METADATA, Constants.ENV_MTA_MODULE_METADATA,\n+                                                                          Constants.ENV_MTA_SERVICES,\n+                                                                          Constants.ENV_MTA_MODULE_PUBLIC_PROVIDED_DEPENDENCIES);\n+\n+    public boolean hasMtaMetadata(CloudApplication application) {\n+        return application.getEnv()\n+                          .keySet()\n+                          .stream()\n+                          .anyMatch(ENV_METADATA_FIELDS::contains);\n+    }\n+\n+    public MtaMetadata parseMtaMetadata(CloudApplication application) {\n+        try {\n+            if (!isMtaMetadataComplete(application)) {\n+                throw new ParsingException(Messages.MTA_METADATA_FOR_APP_0_IS_INCOMPLETE, application.getName());\n+            }\n+            String envMtaMetadata = application.getEnv()\n+                                               .get(Constants.ENV_MTA_METADATA);\n+            Map<String, Object> mtaMetadata = JsonUtil.convertJsonToMap(envMtaMetadata);\n+            String exceptionMessage = MessageFormat.format(Messages.ENV_OF_APP_0_CONTAINS_INVALID_VALUE_FOR_1, application.getName(),\n+                                                           Constants.ENV_MTA_METADATA);\n+            String id = (String) getRequired(mtaMetadata, Constants.ATTR_ID, exceptionMessage);\n+            String version = (String) getRequired(mtaMetadata, Constants.ATTR_VERSION, exceptionMessage);\n+            return ImmutableMtaMetadata.builder()\n+                                       .id(id)\n+                                       .version(Version.parseVersion(version))\n+                                       .build();\n+        } catch (ParsingException e) {\n+            throw new ParsingException(e, Messages.CANT_PARSE_MTA_ENV_METADATA_FOR_APP_0, application.getName());\n+        }\n+    }\n+\n+    private boolean isMtaMetadataComplete(CloudApplication application) {\n+        return application.getEnv()\n+                          .keySet()\n+                          .containsAll(ENV_METADATA_FIELDS);\n+    }\n+\n+    private <K, V> V getRequired(Map<K, V> map, K key, String exceptionMessage) {\n+        V value = map.get(key);\n+        if (value == null) {\n+            throw new ParsingException(exceptionMessage);\n+        }\n+        return value;\n+    }\n+\n+    public DeployedMtaModule parseModule(CloudApplication application) {\n+        try {\n+            if (!isMtaMetadataComplete(application)) {\n+                throw new ParsingException(Messages.MTA_METADATA_FOR_APP_0_IS_INCOMPLETE, application.getName());\n+            }\n+            String moduleName = parseModuleName(application);\n+            List<String> providedDependencyNames = parseProvidedDependencyNames(application);\n+            List<DeployedMtaResource> services = parseResources(application);\n+            return ImmutableDeployedMtaModule.builder()\n+                                             .appName(application.getName())\n+                                             .moduleName(moduleName)\n+                                             .providedDependencyNames(providedDependencyNames)\n+                                             .resources(services)\n+                                             .build();\n+        } catch (ParsingException e) {\n+            throw new ParsingException(e, Messages.CANT_PARSE_MTA_ENV_METADATA_FOR_APP_0, application.getName());\n+        }\n+    }\n+\n+    private String parseModuleName(CloudApplication application) {\n+        String envValue = application.getEnv()\n+                                     .get(Constants.ENV_MTA_MODULE_METADATA);\n+        Map<String, Object> mtaModuleMetadata = JsonUtil.convertJsonToMap(envValue);\n+        return (String) getRequired(mtaModuleMetadata, Constants.ATTR_NAME,\n+                                    MessageFormat.format(Messages.ENV_OF_APP_0_CONTAINS_INVALID_VALUE_FOR_1, application.getName(),\n+                                                         Constants.ENV_MTA_MODULE_METADATA));\n+    }\n+\n+    private List<String> parseProvidedDependencyNames(CloudApplication application) {\n+        String envValue = application.getEnv()\n+                                     .get(Constants.ENV_MTA_MODULE_PUBLIC_PROVIDED_DEPENDENCIES);\n+        try {\n+            return JsonUtil.convertJsonToList(envValue, new TypeReference<List<String>>() {\n+            });\n+        } catch (ParsingException e) {\n+            LOGGER.warn(MessageFormat.format(Messages.COULD_NOT_PARSE_PROVIDED_DEPENDENCY_NAMES_1_OF_APP_0, application.getName(),\n+                                             envValue),\n+                        e);\n+            return Collections.emptyList();\n+        }\n+    }\n+\n+    private List<DeployedMtaResource> parseResources(CloudApplication application) {\n+        return parseServices(application).stream()\n+                                         .map(name -> ImmutableDeployedMtaResource.builder()\n+                                                                                  .serviceName(name)\n+                                                                                  .build())\n+                                         .collect(Collectors.toList());\n+    }\n+\n+    private List<String> parseServices(CloudApplication application) {\n+        String envValue = application.getEnv()\n+                                     .get(Constants.ENV_MTA_SERVICES);\n+        return JsonUtil.convertJsonToList(envValue, new TypeReference<List<String>>() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19fe229012989c6a094822b4c6c10241784cdf03"}, "originalPosition": 131}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMjMxNTM4OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/v2/ApplicationMetadataBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzoxMjo0NFrOFjH2-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzoxMjo0NFrOFjH2-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3MzI0Mg==", "bodyText": "Please, keep the naming - if you are using resource user resource as a whole if service then service, do not mix them. In this case, the resource should be used.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372373242", "createdAt": "2020-01-29T13:12:44Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/v2/ApplicationMetadataBuilder.java", "diffHunk": "@@ -0,0 +1,88 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.v2;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.TreeMap;\n+import java.util.stream.Collectors;\n+\n+import org.cloudfoundry.client.v3.Metadata;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadataAnnotations;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadataLabels;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.SupportedParameters;\n+import com.sap.cloud.lm.sl.cf.core.util.NameUtil;\n+import com.sap.cloud.lm.sl.common.util.JsonUtil;\n+import com.sap.cloud.lm.sl.mta.model.DeploymentDescriptor;\n+import com.sap.cloud.lm.sl.mta.model.Module;\n+import com.sap.cloud.lm.sl.mta.model.ProvidedDependency;\n+import com.sap.cloud.lm.sl.mta.model.Resource;\n+\n+public class ApplicationMetadataBuilder {\n+\n+    public static Metadata build(DeploymentDescriptor deploymentDescriptor, Module module, List<ResourceAndResourceType> moduleResources,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19fe229012989c6a094822b4c6c10241784cdf03"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMjMyMjg3OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/v2/ApplicationMetadataBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzoxNToyOFrOFjH7ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzoxNToyOFrOFjH7ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3NDQzMA==", "bodyText": "I would suggest, splitting this builder into several small builders which are intended to build each MtaMetadata entry separately.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372374430", "createdAt": "2020-01-29T13:15:28Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/cf/v2/ApplicationMetadataBuilder.java", "diffHunk": "@@ -0,0 +1,88 @@\n+package com.sap.cloud.lm.sl.cf.core.cf.v2;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.TreeMap;\n+import java.util.stream.Collectors;\n+\n+import org.cloudfoundry.client.v3.Metadata;\n+\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadataAnnotations;\n+import com.sap.cloud.lm.sl.cf.core.cf.metadata.MtaMetadataLabels;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.DeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMtaModule;\n+import com.sap.cloud.lm.sl.cf.core.model.ImmutableDeployedMtaResource;\n+import com.sap.cloud.lm.sl.cf.core.model.SupportedParameters;\n+import com.sap.cloud.lm.sl.cf.core.util.NameUtil;\n+import com.sap.cloud.lm.sl.common.util.JsonUtil;\n+import com.sap.cloud.lm.sl.mta.model.DeploymentDescriptor;\n+import com.sap.cloud.lm.sl.mta.model.Module;\n+import com.sap.cloud.lm.sl.mta.model.ProvidedDependency;\n+import com.sap.cloud.lm.sl.mta.model.Resource;\n+\n+public class ApplicationMetadataBuilder {\n+\n+    public static Metadata build(DeploymentDescriptor deploymentDescriptor, Module module, List<ResourceAndResourceType> moduleResources,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19fe229012989c6a094822b4c6c10241784cdf03"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMjMzMTY4OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/message/Messages.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzoxODoxMFrOFjIA6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzoxODoxMFrOFjIA6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3NTc4Ng==", "bodyText": "Double '", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372375786", "createdAt": "2020-01-29T13:18:10Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/message/Messages.java", "diffHunk": "@@ -64,8 +64,13 @@\n     public static final String UNABLE_TO_PARSE_MEMORY_STRING_0 = \"Unable to parse memory string \\\"{0}\\\"\";\r\n     public static final String CANT_CREATE_SERVICE_NOT_MATCHING_OFFERINGS_OR_PLAN = \"Service \\\"{0}\\\" could not be created because none of the service offering(s) \\\"{1}\\\" match with existing service offerings or provide service plan \\\"{2}\\\"\";\r\n     public static final String CANT_CREATE_SERVICE = \"Service \\\"{0}\\\" could not be created because all attempt(s) to use service offerings \\\"{1}\\\" failed\";\r\n-    public static final String CANT_PARSE_MTA_METADATA_FOR_APP_0 = \"Cannot parse MTA metadata for application \\\"{0}\\\". This indicates that MTA reserved variables in the application''s environment were modified manually. Either revert the changes or delete the application.\";\r\n+    public static final String CANT_PARSE_MTA_ENV_METADATA_FOR_APP_0 = \"Cannot parse MTA metadata for application \\\"{0}\\\". This indicates that MTA reserved variables in the application''s environment were modified manually. Either revert the changes or delete the application.\";\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19fe229012989c6a094822b4c6c10241784cdf03"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMjMzMjc0OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/message/Messages.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzoxODozMVrOFjIBkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzoxODozMVrOFjIBkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3NTk1NQ==", "bodyText": "Same", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/726#discussion_r372375955", "createdAt": "2020-01-29T13:18:31Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.core/src/main/java/com/sap/cloud/lm/sl/cf/core/message/Messages.java", "diffHunk": "@@ -64,8 +64,13 @@\n     public static final String UNABLE_TO_PARSE_MEMORY_STRING_0 = \"Unable to parse memory string \\\"{0}\\\"\";\r\n     public static final String CANT_CREATE_SERVICE_NOT_MATCHING_OFFERINGS_OR_PLAN = \"Service \\\"{0}\\\" could not be created because none of the service offering(s) \\\"{1}\\\" match with existing service offerings or provide service plan \\\"{2}\\\"\";\r\n     public static final String CANT_CREATE_SERVICE = \"Service \\\"{0}\\\" could not be created because all attempt(s) to use service offerings \\\"{1}\\\" failed\";\r\n-    public static final String CANT_PARSE_MTA_METADATA_FOR_APP_0 = \"Cannot parse MTA metadata for application \\\"{0}\\\". This indicates that MTA reserved variables in the application''s environment were modified manually. Either revert the changes or delete the application.\";\r\n+    public static final String CANT_PARSE_MTA_ENV_METADATA_FOR_APP_0 = \"Cannot parse MTA metadata for application \\\"{0}\\\". This indicates that MTA reserved variables in the application''s environment were modified manually. Either revert the changes or delete the application.\";\r\n+    public static final String CANT_PARSE_MTA_METADATA_FOR_0 = \"Cannot parse MTA metadata for \\\"{0}\\\". This indicates that MTA reserved variables in the entity''s metadata were modified manually. Either revert the changes or delete the entity.\";\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19fe229012989c6a094822b4c6c10241784cdf03"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 577, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}