{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4MzgyMDQ5", "number": 773, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMTo0MDowN1rODiS_XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMTo0MzowNFrODiTCYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3Mjg5MzA5OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/UploadAppStep.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMTo0MDowN1rOFtdvVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzoxNzo0N1rOFtgQWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIxNzQ5NQ==", "bodyText": "This call is already made on line 156. Could we reuse the CloudApplication?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/773#discussion_r383217495", "createdAt": "2020-02-24T11:40:07Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/UploadAppStep.java", "diffHunk": "@@ -67,16 +69,27 @@ public StepPhase executeAsyncStep(ExecutionWrapper execution) throws FileStorage\n             return StepPhase.DONE;\r\n         }\r\n \r\n-        getStepLogger().debug(Messages.UPLOADING_FILE_0_FOR_APP_1, fileName, app.getName());\r\n-\r\n         String newApplicationDigest = getNewApplicationDigest(execution, appArchiveId, fileName);\r\n-        detectApplicationFileDigestChanges(execution, app.getName(), client, newApplicationDigest);\r\n+        boolean contentChanged = detectApplicationFileDigestChanges(execution, appName, client, newApplicationDigest);\r\n+        if (!contentChanged && isAppStagedCorrectly(client, appName)) {\r\n+            getStepLogger().info(Messages.CONTENT_OF_APPLICATION_0_IS_NOT_CHANGED, appName);\r\n+            return StepPhase.DONE;\r\n+        }\r\n+\r\n+        getStepLogger().debug(Messages.UPLOADING_FILE_0_FOR_APP_1, fileName, appName);\r\n         UploadToken uploadToken = asyncUploadFiles(execution, client, app, appArchiveId, fileName);\r\n-        getStepLogger().debug(Messages.STARTED_ASYNC_UPLOAD_OF_APP_0, app.getName());\r\n+\r\n+        getStepLogger().debug(Messages.STARTED_ASYNC_UPLOAD_OF_APP_0, appName);\r\n         StepsUtil.setUploadToken(uploadToken, execution.getContext());\r\n         return StepPhase.POLL;\r\n     }\r\n \r\n+    private boolean isAppStagedCorrectly(CloudControllerClient client, String appName) {\r\n+        ApplicationStager appStager = new ApplicationStager(client);\r\n+        CloudApplication cloudApp = client.getApplication(appName);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc8ed375715a8541b5e6b4fc554438b3ce6605cb"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1ODcxNQ==", "bodyText": "Done.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/773#discussion_r383258715", "createdAt": "2020-02-24T13:17:47Z", "author": {"login": "VaskoBozhurski"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/UploadAppStep.java", "diffHunk": "@@ -67,16 +69,27 @@ public StepPhase executeAsyncStep(ExecutionWrapper execution) throws FileStorage\n             return StepPhase.DONE;\r\n         }\r\n \r\n-        getStepLogger().debug(Messages.UPLOADING_FILE_0_FOR_APP_1, fileName, app.getName());\r\n-\r\n         String newApplicationDigest = getNewApplicationDigest(execution, appArchiveId, fileName);\r\n-        detectApplicationFileDigestChanges(execution, app.getName(), client, newApplicationDigest);\r\n+        boolean contentChanged = detectApplicationFileDigestChanges(execution, appName, client, newApplicationDigest);\r\n+        if (!contentChanged && isAppStagedCorrectly(client, appName)) {\r\n+            getStepLogger().info(Messages.CONTENT_OF_APPLICATION_0_IS_NOT_CHANGED, appName);\r\n+            return StepPhase.DONE;\r\n+        }\r\n+\r\n+        getStepLogger().debug(Messages.UPLOADING_FILE_0_FOR_APP_1, fileName, appName);\r\n         UploadToken uploadToken = asyncUploadFiles(execution, client, app, appArchiveId, fileName);\r\n-        getStepLogger().debug(Messages.STARTED_ASYNC_UPLOAD_OF_APP_0, app.getName());\r\n+\r\n+        getStepLogger().debug(Messages.STARTED_ASYNC_UPLOAD_OF_APP_0, appName);\r\n         StepsUtil.setUploadToken(uploadToken, execution.getContext());\r\n         return StepPhase.POLL;\r\n     }\r\n \r\n+    private boolean isAppStagedCorrectly(CloudControllerClient client, String appName) {\r\n+        ApplicationStager appStager = new ApplicationStager(client);\r\n+        CloudApplication cloudApp = client.getApplication(appName);\r", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIxNzQ5NQ=="}, "originalCommit": {"oid": "dc8ed375715a8541b5e6b4fc554438b3ce6605cb"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3Mjg5NzI2OnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/DetermineDesiredStateAchievingActionsStep.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMTo0MTozNlrOFtdxzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNDoyMjo1OFrOFtiTAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIxODEyNQ==", "bodyText": "Better naming of the variable.\nAlso, could you extract StepsUtil.getUploadToken(execution.getContext()) into separate variable?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/773#discussion_r383218125", "createdAt": "2020-02-24T11:41:36Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/DetermineDesiredStateAchievingActionsStep.java", "diffHunk": "@@ -40,11 +39,10 @@ protected StepPhase executeStep(ExecutionWrapper execution) {\n         getStepLogger().debug(Messages.CURRENT_STATE, appName, currentState);\n         ApplicationStartupState desiredState = computeDesiredState(execution.getContext(), app);\n         getStepLogger().debug(Messages.DESIRED_STATE, appName, desiredState);\n-        ApplicationStager applicationStager = new ApplicationStager(execution.getControllerClient());\n+        boolean isAppStaged = StepsUtil.getUploadToken(execution.getContext()) == null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc8ed375715a8541b5e6b4fc554438b3ce6605cb"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI5MjE2MQ==", "bodyText": "Done. I've renamed it and inverted it so it is easier to understand.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/773#discussion_r383292161", "createdAt": "2020-02-24T14:22:58Z", "author": {"login": "VaskoBozhurski"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/DetermineDesiredStateAchievingActionsStep.java", "diffHunk": "@@ -40,11 +39,10 @@ protected StepPhase executeStep(ExecutionWrapper execution) {\n         getStepLogger().debug(Messages.CURRENT_STATE, appName, currentState);\n         ApplicationStartupState desiredState = computeDesiredState(execution.getContext(), app);\n         getStepLogger().debug(Messages.DESIRED_STATE, appName, desiredState);\n-        ApplicationStager applicationStager = new ApplicationStager(execution.getControllerClient());\n+        boolean isAppStaged = StepsUtil.getUploadToken(execution.getContext()) == null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIxODEyNQ=="}, "originalCommit": {"oid": "dc8ed375715a8541b5e6b4fc554438b3ce6605cb"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM3MjkwMDgxOnYy", "diffSide": "RIGHT", "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/UploadAppStep.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMTo0MzowNFrOFtdz9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzoxNzozNVrOFtgQGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIxODY3OA==", "bodyText": "Is this necessarry to be info message?", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/773#discussion_r383218678", "createdAt": "2020-02-24T11:43:04Z", "author": {"login": "enchobelezirev"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/UploadAppStep.java", "diffHunk": "@@ -67,16 +69,27 @@ public StepPhase executeAsyncStep(ExecutionWrapper execution) throws FileStorage\n             return StepPhase.DONE;\r\n         }\r\n \r\n-        getStepLogger().debug(Messages.UPLOADING_FILE_0_FOR_APP_1, fileName, app.getName());\r\n-\r\n         String newApplicationDigest = getNewApplicationDigest(execution, appArchiveId, fileName);\r\n-        detectApplicationFileDigestChanges(execution, app.getName(), client, newApplicationDigest);\r\n+        boolean contentChanged = detectApplicationFileDigestChanges(execution, appName, client, newApplicationDigest);\r\n+        if (!contentChanged && isAppStagedCorrectly(client, appName)) {\r\n+            getStepLogger().info(Messages.CONTENT_OF_APPLICATION_0_IS_NOT_CHANGED, appName);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc8ed375715a8541b5e6b4fc554438b3ce6605cb"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1ODY1MA==", "bodyText": "I think it is much more easier to understand what is happening with your deployment when this message exists as otherwise you only see the message saying \"Uploading Application X\", while there is no actual deployment happening.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/773#discussion_r383258650", "createdAt": "2020-02-24T13:17:35Z", "author": {"login": "VaskoBozhurski"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/steps/UploadAppStep.java", "diffHunk": "@@ -67,16 +69,27 @@ public StepPhase executeAsyncStep(ExecutionWrapper execution) throws FileStorage\n             return StepPhase.DONE;\r\n         }\r\n \r\n-        getStepLogger().debug(Messages.UPLOADING_FILE_0_FOR_APP_1, fileName, app.getName());\r\n-\r\n         String newApplicationDigest = getNewApplicationDigest(execution, appArchiveId, fileName);\r\n-        detectApplicationFileDigestChanges(execution, app.getName(), client, newApplicationDigest);\r\n+        boolean contentChanged = detectApplicationFileDigestChanges(execution, appName, client, newApplicationDigest);\r\n+        if (!contentChanged && isAppStagedCorrectly(client, appName)) {\r\n+            getStepLogger().info(Messages.CONTENT_OF_APPLICATION_0_IS_NOT_CHANGED, appName);\r", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIxODY3OA=="}, "originalCommit": {"oid": "dc8ed375715a8541b5e6b4fc554438b3ce6605cb"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 604, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}