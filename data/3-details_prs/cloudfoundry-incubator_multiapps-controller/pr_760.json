{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0ODAyMDE3", "number": 760, "title": "Sunny's PoC for process abortion", "bodyText": "Description:\nTested with stress tests and randomly aborting script. The result:\n\nNo deadlocks in the logs of the deploy-service found\nKibana monitoring was OK\nOperations were aborted(deleted) after 31 minutes calculated from the failure time.\n\nIssue:\nhttps://sapjira.wdf.sap.corp/browse/LMCROSSITXSADEPLOY-1953", "createdAt": "2020-02-13T10:58:55Z", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/760", "merged": true, "mergeCommit": {"oid": "223e60004b0e1c4bebcef1a89bd02e43c9d5e561"}, "closed": true, "closedAt": "2020-02-19T08:59:59Z", "author": {"login": "enchobelezirev"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcD43BLABqjMwMzQzODc2NjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFyfHygBqjMwNTA3NjE0OTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a3ddae47009c0c76c75326e85b9e578c6cd8be66", "author": {"user": {"login": "enchobelezirev", "name": "Encho Belezirev"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/a3ddae47009c0c76c75326e85b9e578c6cd8be66", "committedDate": "2020-02-13T10:57:51Z", "message": "Sunny's PoC for process abortion"}, "afterCommit": {"oid": "43d3837fb41ce62da8f9b068f571a7b9e0ce57a2", "author": {"user": {"login": "enchobelezirev", "name": "Encho Belezirev"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/43d3837fb41ce62da8f9b068f571a7b9e0ce57a2", "committedDate": "2020-02-13T11:02:28Z", "message": "Sunny's PoC for process abortion"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "43d3837fb41ce62da8f9b068f571a7b9e0ce57a2", "author": {"user": {"login": "enchobelezirev", "name": "Encho Belezirev"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/43d3837fb41ce62da8f9b068f571a7b9e0ce57a2", "committedDate": "2020-02-13T11:02:28Z", "message": "Sunny's PoC for process abortion"}, "afterCommit": {"oid": "ae6db3d849ec40d717ff191e348249df3bd2ade0", "author": {"user": {"login": "enchobelezirev", "name": "Encho Belezirev"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/ae6db3d849ec40d717ff191e348249df3bd2ade0", "committedDate": "2020-02-18T15:58:55Z", "message": "Sunny's PoC for process abortion"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ae6db3d849ec40d717ff191e348249df3bd2ade0", "author": {"user": {"login": "enchobelezirev", "name": "Encho Belezirev"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/ae6db3d849ec40d717ff191e348249df3bd2ade0", "committedDate": "2020-02-18T15:58:55Z", "message": "Sunny's PoC for process abortion"}, "afterCommit": {"oid": "cb9127bf9ad41914794f4785d1e13bf2c2d15cfc", "author": {"user": {"login": "enchobelezirev", "name": "Encho Belezirev"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/cb9127bf9ad41914794f4785d1e13bf2c2d15cfc", "committedDate": "2020-02-18T16:05:05Z", "message": "Sunny's PoC for process abortion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwOTEwMzA2", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/760#pullrequestreview-360910306", "createdAt": "2020-02-19T08:15:24Z", "commit": {"oid": "cb9127bf9ad41914794f4785d1e13bf2c2d15cfc"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwODoxNToyNVrOFrejPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwODoxNjowN1rOFrekUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEzMzYzMA==", "bodyText": "\"id\" should be capitalized.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/760#discussion_r381133630", "createdAt": "2020-02-19T08:15:25Z", "author": {"login": "nictas"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/Messages.java", "diffHunk": "@@ -203,6 +203,8 @@\n     public static final String CREATE_SUPPORT_TICKET_TO_DS_COMPONENT = \"If you think the problem is in the deployment process, please create a support ticket to {0} component \\\"{1}\\\".\";\r\n     public static final String CREATE_SUPPORT_TICKET_TO_SERVICE_BROKER_COMPONENT = \"If you think the problem is in the service broker, please create a support ticket to {0} component \\\"{1}\\\".\";\r\n     public static final String CREATE_SUPPORT_TICKET_TO_CC_COMPONENT = \"If you think the problem is in the controller, please create a support ticket to {0} component \\\"{1}\\\".\";\r\n+    public static final String DELETING_OPERATION_WITH_ID = \"Deleting operation with id \\\"{0}\\\"\";\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb9127bf9ad41914794f4785d1e13bf2c2d15cfc"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEzMzkwNg==", "bodyText": "This comment is not necessary.", "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/pull/760#discussion_r381133906", "createdAt": "2020-02-19T08:16:07Z", "author": {"login": "nictas"}, "path": "com.sap.cloud.lm.sl.cf.process/src/main/java/com/sap/cloud/lm/sl/cf/process/flowable/AbortProcessAction.java", "diffHunk": "@@ -5,31 +5,42 @@\n import javax.inject.Inject;\n import javax.inject.Named;\n \n-import com.sap.cloud.lm.sl.cf.core.model.HistoricOperationEvent;\n+import com.sap.cloud.lm.sl.cf.core.model.HistoricOperationEvent.EventType;\n+import com.sap.cloud.lm.sl.cf.core.persistence.service.OperationService;\n import com.sap.cloud.lm.sl.cf.process.util.HistoricOperationEventPersister;\n-import com.sap.cloud.lm.sl.cf.web.api.model.Operation;\n+import com.sap.cloud.lm.sl.cf.process.util.ProcessConflictPreventer;\n \n @Named\n public class AbortProcessAction extends ProcessAction {\n \n     public static final String ACTION_ID_ABORT = \"abort\";\n-    private final HistoricOperationEventPersister historicOperationEventPersister;\n+\n+    private HistoricOperationEventPersister historicEventPersister;\n+    private OperationService operationService;\n \n     @Inject\n     public AbortProcessAction(FlowableFacade flowableFacade, List<AdditionalProcessAction> additionalProcessActions,\n-                              HistoricOperationEventPersister historicOperationEventPersister) {\n+                              HistoricOperationEventPersister historicEventPersister, OperationService operationService) {\n         super(flowableFacade, additionalProcessActions);\n-        this.historicOperationEventPersister = historicOperationEventPersister;\n+        this.historicEventPersister = historicEventPersister;\n+        this.operationService = operationService;\n     }\n \n     @Override\n     public void executeActualProcessAction(String user, String superProcessInstanceId) {\n-        historicOperationEventPersister.add(superProcessInstanceId, HistoricOperationEvent.EventType.ABORTED);\n-        if (flowableFacade.isProcessInstanceSuspended(superProcessInstanceId)) {\n-            flowableFacade.activateProcessInstance(superProcessInstanceId);\n-        }\n-        // TODO: The Delete Reason won't be indispensable anymore and should be deleted after this version is stable.\n-        flowableFacade.deleteProcessInstance(superProcessInstanceId, Operation.State.ABORTED.name());\n+        flowableFacade.setAbortVariable(superProcessInstanceId);\n+        // Release the lock for the operation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb9127bf9ad41914794f4785d1e13bf2c2d15cfc"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a6c05da99c12925378dee813b423c4c46d0367a", "author": {"user": {"login": "enchobelezirev", "name": "Encho Belezirev"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/1a6c05da99c12925378dee813b423c4c46d0367a", "committedDate": "2020-02-19T08:43:46Z", "message": "Delete processes as part of CleanupJob"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cb9127bf9ad41914794f4785d1e13bf2c2d15cfc", "author": {"user": {"login": "enchobelezirev", "name": "Encho Belezirev"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/cb9127bf9ad41914794f4785d1e13bf2c2d15cfc", "committedDate": "2020-02-18T16:05:05Z", "message": "Sunny's PoC for process abortion"}, "afterCommit": {"oid": "1a6c05da99c12925378dee813b423c4c46d0367a", "author": {"user": {"login": "enchobelezirev", "name": "Encho Belezirev"}}, "url": "https://github.com/cloudfoundry-incubator/multiapps-controller/commit/1a6c05da99c12925378dee813b423c4c46d0367a", "committedDate": "2020-02-19T08:43:46Z", "message": "Delete processes as part of CleanupJob"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1000, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}