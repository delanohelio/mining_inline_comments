{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4NzYwMDI2", "number": 2064, "title": "HBASE-24735: Refactor ReplicationSourceManager: move logPositionAndCl\u2026", "bodyText": "\u2026eanOldLogs/cleanUpHFileRefs to ReplicationSource inside", "createdAt": "2020-07-14T09:22:00Z", "url": "https://github.com/apache/hbase/pull/2064", "merged": true, "mergeCommit": {"oid": "06cc3c502eb7b3206956de2dca7e87c9fcdf7016"}, "closed": true, "closedAt": "2020-08-11T12:07:10Z", "author": {"login": "infraio"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1BlcGABqjM1NDY2NDk1ODI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc90r1IAFqTQ2NDk1ODgzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cbd602e8846d4c4f779beb9c9cc97a97404057e3", "author": {"user": {"login": "infraio", "name": "Guanghao Zhang"}}, "url": "https://github.com/apache/hbase/commit/cbd602e8846d4c4f779beb9c9cc97a97404057e3", "committedDate": "2020-07-14T09:21:16Z", "message": "HBASE-24735: Refactor ReplicationSourceManager: move logPositionAndCleanOldLogs/cleanUpHFileRefs to ReplicationSource inside"}, "afterCommit": {"oid": "c41d7989bc53f6c8ad6b7429c0fb915183662d2c", "author": {"user": {"login": "infraio", "name": "Guanghao Zhang"}}, "url": "https://github.com/apache/hbase/commit/c41d7989bc53f6c8ad6b7429c0fb915183662d2c", "committedDate": "2020-07-15T02:54:02Z", "message": "HBASE-24735: Refactor ReplicationSourceManager: move logPositionAndCleanOldLogs/cleanUpHFileRefs to ReplicationSource inside"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NDA0NDQ4", "url": "https://github.com/apache/hbase/pull/2064#pullrequestreview-449404448", "createdAt": "2020-07-15T23:13:07Z", "commit": {"oid": "c41d7989bc53f6c8ad6b7429c0fb915183662d2c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMzoxMzowN1rOGyUdHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMzoyMzowMVrOGyUpww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxNzExNw==", "bodyText": "nit: method javadoc", "url": "https://github.com/apache/hbase/pull/2064#discussion_r455417117", "createdAt": "2020-07-15T23:13:07Z", "author": {"login": "bharathv"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceInterface.java", "diffHunk": "@@ -192,4 +188,8 @@ default boolean isSyncReplication() {\n   default boolean isRecovered() {\n     return false;\n   }\n+\n+  void logPosition(WALEntryBatch entryBatch);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c41d7989bc53f6c8ad6b7429c0fb915183662d2c"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxNzE1NQ==", "bodyText": "nit: method javadoc", "url": "https://github.com/apache/hbase/pull/2064#discussion_r455417155", "createdAt": "2020-07-15T23:13:17Z", "author": {"login": "bharathv"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceInterface.java", "diffHunk": "@@ -192,4 +188,8 @@ default boolean isSyncReplication() {\n   default boolean isRecovered() {\n     return false;\n   }\n+\n+  void logPosition(WALEntryBatch entryBatch);\n+\n+  void cleanOldLogs(String walName, boolean inclusive);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c41d7989bc53f6c8ad6b7429c0fb915183662d2c"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxOTExNw==", "bodyText": "You don't need the manager in the c'tor anymore?", "url": "https://github.com/apache/hbase/pull/2064#discussion_r455419117", "createdAt": "2020-07-15T23:19:06Z", "author": {"login": "bharathv"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -139,17 +144,16 @@\n    * Instantiation method used by region servers\n    * @param conf configuration to use\n    * @param fs file system to use\n-   * @param manager replication manager to ping to\n    * @param server the server for this region server\n    * @param queueId the id of our replication queue\n    * @param clusterId unique UUID for the cluster\n    * @param metrics metrics for replication source\n    */\n   @Override\n-  public void init(Configuration conf, FileSystem fs, ReplicationSourceManager manager,\n+  public void init(Configuration conf, FileSystem fs, Path walDir, ReplicationSourceManager manager,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c41d7989bc53f6c8ad6b7429c0fb915183662d2c"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxOTUzNQ==", "bodyText": "move this to the interface?", "url": "https://github.com/apache/hbase/pull/2064#discussion_r455419535", "createdAt": "2020-07-15T23:20:25Z", "author": {"login": "bharathv"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -729,4 +728,143 @@ void removeWorker(ReplicationSourceShipper worker) {\n   private String logPeerId(){\n     return \"[Source for peer \" + this.getPeer().getId() + \"]:\";\n   }\n+\n+  @VisibleForTesting\n+  public void logPosition(WALEntryBatch entryBatch) {\n+    String fileName = entryBatch.getLastWalPath().getName();\n+    interruptOrAbortWhenFail(() -> this.queueStorage\n+      .setWALPosition(server.getServerName(), getQueueId(), fileName,\n+        entryBatch.getLastWalPosition(), entryBatch.getLastSeqIds()));\n+  }\n+\n+  /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c41d7989bc53f6c8ad6b7429c0fb915183662d2c"}, "originalPosition": 149}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQyMDA0NQ==", "bodyText": "curious why this change?", "url": "https://github.com/apache/hbase/pull/2064#discussion_r455420045", "createdAt": "2020-07-15T23:21:59Z", "author": {"login": "bharathv"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceManager.java", "diffHunk": "@@ -926,7 +799,8 @@ public void join() {\n    * @return list of all normal sources\n    */\n   public List<ReplicationSourceInterface> getSources() {\n-    return new ArrayList<>(this.sources.values());\n+    return this.sources.values().stream().filter(source -> source.isSourceActive())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c41d7989bc53f6c8ad6b7429c0fb915183662d2c"}, "originalPosition": 186}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQyMDM1NQ==", "bodyText": "I think this is not needed.", "url": "https://github.com/apache/hbase/pull/2064#discussion_r455420355", "createdAt": "2020-07-15T23:23:01Z", "author": {"login": "bharathv"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/WALEntryBatch.java", "diffHunk": "@@ -30,8 +30,7 @@\n /**\n  * Holds a batch of WAL entries to replicate, along with some statistics\n  */\n-@InterfaceAudience.Private\n-class WALEntryBatch {\n+@InterfaceAudience.Private public class WALEntryBatch {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c41d7989bc53f6c8ad6b7429c0fb915183662d2c"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c41d7989bc53f6c8ad6b7429c0fb915183662d2c", "author": {"user": {"login": "infraio", "name": "Guanghao Zhang"}}, "url": "https://github.com/apache/hbase/commit/c41d7989bc53f6c8ad6b7429c0fb915183662d2c", "committedDate": "2020-07-15T02:54:02Z", "message": "HBASE-24735: Refactor ReplicationSourceManager: move logPositionAndCleanOldLogs/cleanUpHFileRefs to ReplicationSource inside"}, "afterCommit": {"oid": "27dab4e8b43b5d498f52c6413cd9c2d9d4f60bd4", "author": {"user": {"login": "infraio", "name": "Guanghao Zhang"}}, "url": "https://github.com/apache/hbase/commit/27dab4e8b43b5d498f52c6413cd9c2d9d4f60bd4", "committedDate": "2020-07-21T01:35:00Z", "message": "HBASE-24735: Refactor ReplicationSourceManager: move logPositionAndCleanOldLogs/cleanUpHFileRefs to ReplicationSource inside"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "27dab4e8b43b5d498f52c6413cd9c2d9d4f60bd4", "author": {"user": {"login": "infraio", "name": "Guanghao Zhang"}}, "url": "https://github.com/apache/hbase/commit/27dab4e8b43b5d498f52c6413cd9c2d9d4f60bd4", "committedDate": "2020-07-21T01:35:00Z", "message": "HBASE-24735: Refactor ReplicationSourceManager: move logPositionAndCleanOldLogs/cleanUpHFileRefs to ReplicationSource inside"}, "afterCommit": {"oid": "6f28e3bd2944251277a86beff7232f9b5abe6249", "author": {"user": {"login": "infraio", "name": "Guanghao Zhang"}}, "url": "https://github.com/apache/hbase/commit/6f28e3bd2944251277a86beff7232f9b5abe6249", "committedDate": "2020-07-21T01:38:50Z", "message": "HBASE-24735: Refactor ReplicationSourceManager: move logPositionAndCleanOldLogs/cleanUpHFileRefs to ReplicationSource inside"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f28e3bd2944251277a86beff7232f9b5abe6249", "author": {"user": {"login": "infraio", "name": "Guanghao Zhang"}}, "url": "https://github.com/apache/hbase/commit/6f28e3bd2944251277a86beff7232f9b5abe6249", "committedDate": "2020-07-21T01:38:50Z", "message": "HBASE-24735: Refactor ReplicationSourceManager: move logPositionAndCleanOldLogs/cleanUpHFileRefs to ReplicationSource inside"}, "afterCommit": {"oid": "782dc50265aeda6f68e036efdd48b0e5b5237662", "author": {"user": {"login": "infraio", "name": "Guanghao Zhang"}}, "url": "https://github.com/apache/hbase/commit/782dc50265aeda6f68e036efdd48b0e5b5237662", "committedDate": "2020-07-21T06:05:39Z", "message": "HBASE-24735: Refactor ReplicationSourceManager: move logPositionAndCleanOldLogs/cleanUpHFileRefs to ReplicationSource inside"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "782dc50265aeda6f68e036efdd48b0e5b5237662", "author": {"user": {"login": "infraio", "name": "Guanghao Zhang"}}, "url": "https://github.com/apache/hbase/commit/782dc50265aeda6f68e036efdd48b0e5b5237662", "committedDate": "2020-07-21T06:05:39Z", "message": "HBASE-24735: Refactor ReplicationSourceManager: move logPositionAndCleanOldLogs/cleanUpHFileRefs to ReplicationSource inside"}, "afterCommit": {"oid": "717e4c635642b80aa0bd10bffc28a631412c062f", "author": {"user": {"login": "infraio", "name": "Guanghao Zhang"}}, "url": "https://github.com/apache/hbase/commit/717e4c635642b80aa0bd10bffc28a631412c062f", "committedDate": "2020-08-10T06:52:27Z", "message": "HBASE-24735: Refactor ReplicationSourceManager: move logPositionAndCleanOldLogs/cleanUpHFileRefs to ReplicationSource inside"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "717e4c635642b80aa0bd10bffc28a631412c062f", "author": {"user": {"login": "infraio", "name": "Guanghao Zhang"}}, "url": "https://github.com/apache/hbase/commit/717e4c635642b80aa0bd10bffc28a631412c062f", "committedDate": "2020-08-10T06:52:27Z", "message": "HBASE-24735: Refactor ReplicationSourceManager: move logPositionAndCleanOldLogs/cleanUpHFileRefs to ReplicationSource inside"}, "afterCommit": {"oid": "027690e8712cd484ffafeeda4818c0a76bf6d2d7", "author": {"user": {"login": "infraio", "name": "Guanghao Zhang"}}, "url": "https://github.com/apache/hbase/commit/027690e8712cd484ffafeeda4818c0a76bf6d2d7", "committedDate": "2020-08-10T13:52:41Z", "message": "HBASE-24735: Refactor ReplicationSourceManager: move logPositionAndCleanOldLogs/cleanUpHFileRefs to ReplicationSource inside"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NDcxMDE1", "url": "https://github.com/apache/hbase/pull/2064#pullrequestreview-464471015", "createdAt": "2020-08-10T18:25:45Z", "commit": {"oid": "027690e8712cd484ffafeeda4818c0a76bf6d2d7"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxODoyNTo0NVrOG-aRvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxODoyOTowM1rOG-aYQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA5NTQyMw==", "bodyText": "Since we are cleaning out this extra, unnecessary variable, could we make \"this.manager\" package private (or provide a package private getter), so that source readers and source shippers don't have to define an additional reference to ReplicationSourceManager?", "url": "https://github.com/apache/hbase/pull/2064#discussion_r468095423", "createdAt": "2020-08-10T18:25:45Z", "author": {"login": "wchevreuil"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -130,8 +137,6 @@\n   protected final ConcurrentHashMap<String, ReplicationSourceShipper> workerThreads =\n       new ConcurrentHashMap<>();\n \n-  private AtomicLong totalBufferUsed;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "027690e8712cd484ffafeeda4818c0a76bf6d2d7"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA5NjA2NQ==", "bodyText": "Might not be needed if we make \"ReplicationSource.manager\" accessible (see my comments above).", "url": "https://github.com/apache/hbase/pull/2064#discussion_r468096065", "createdAt": "2020-08-10T18:27:03Z", "author": {"login": "wchevreuil"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -398,10 +402,11 @@ protected ReplicationSourceShipper createNewShipper(String walGroupId,\n   }\n \n   private ReplicationSourceWALReader createNewWALReader(String walGroupId,\n-      PriorityBlockingQueue<Path> queue, long startPosition) {\n-    return replicationPeer.getPeerConfig().isSerial()\n-      ? new SerialReplicationSourceWALReader(fs, conf, queue, startPosition, walEntryFilter, this)\n-      : new ReplicationSourceWALReader(fs, conf, queue, startPosition, walEntryFilter, this);\n+    PriorityBlockingQueue<Path> queue, long startPosition) {\n+    return replicationPeer.getPeerConfig().isSerial() ?\n+      new SerialReplicationSourceWALReader(fs, conf, queue, startPosition, walEntryFilter, this,\n+        manager) :\n+      new ReplicationSourceWALReader(fs, conf, queue, startPosition, walEntryFilter, this, manager);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "027690e8712cd484ffafeeda4818c0a76bf6d2d7"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA5NzA5MQ==", "bodyText": "Better use IA.Private, instead. See: See: https://lists.apache.org/thread.html/r9a2df6a3b58e00c0c482d8660434d8ce6075863c18700978e6ea8b21%40%3Cdev.hbase.apache.org%3E", "url": "https://github.com/apache/hbase/pull/2064#discussion_r468097091", "createdAt": "2020-08-10T18:29:03Z", "author": {"login": "wchevreuil"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -770,4 +770,137 @@ void removeWorker(ReplicationSourceShipper worker) {\n   private String logPeerId(){\n     return \"[Source for peer \" + this.getPeer().getId() + \"]:\";\n   }\n+\n+  @VisibleForTesting", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "027690e8712cd484ffafeeda4818c0a76bf6d2d7"}, "originalPosition": 107}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5fb08cae55a824b940c9c6e1fe1a45908aac989", "author": {"user": {"login": "infraio", "name": "Guanghao Zhang"}}, "url": "https://github.com/apache/hbase/commit/f5fb08cae55a824b940c9c6e1fe1a45908aac989", "committedDate": "2020-08-11T01:15:47Z", "message": "HBASE-24735: Refactor ReplicationSourceManager: move logPositionAndCleanOldLogs/cleanUpHFileRefs to ReplicationSource inside"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "027690e8712cd484ffafeeda4818c0a76bf6d2d7", "author": {"user": {"login": "infraio", "name": "Guanghao Zhang"}}, "url": "https://github.com/apache/hbase/commit/027690e8712cd484ffafeeda4818c0a76bf6d2d7", "committedDate": "2020-08-10T13:52:41Z", "message": "HBASE-24735: Refactor ReplicationSourceManager: move logPositionAndCleanOldLogs/cleanUpHFileRefs to ReplicationSource inside"}, "afterCommit": {"oid": "f5fb08cae55a824b940c9c6e1fe1a45908aac989", "author": {"user": {"login": "infraio", "name": "Guanghao Zhang"}}, "url": "https://github.com/apache/hbase/commit/f5fb08cae55a824b940c9c6e1fe1a45908aac989", "committedDate": "2020-08-11T01:15:47Z", "message": "HBASE-24735: Refactor ReplicationSourceManager: move logPositionAndCleanOldLogs/cleanUpHFileRefs to ReplicationSource inside"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0OTU4ODMy", "url": "https://github.com/apache/hbase/pull/2064#pullrequestreview-464958832", "createdAt": "2020-08-11T10:58:24Z", "commit": {"oid": "f5fb08cae55a824b940c9c6e1fe1a45908aac989"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4274, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}