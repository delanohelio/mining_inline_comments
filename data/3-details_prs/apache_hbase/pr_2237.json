{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1NzU5OTU0", "number": 2237, "title": "HBASE-24833: Bootstrap should not delete the META table directory if \u2026", "bodyText": "\u2026it's not partial\nAdd a check on meta bootstrap to skip removing meta table directory\nif ZK data does not exist when hmaster restart. here the existence\nof clusterID in ZK indicate if the meta is partial if we hit the\nINIT_META_WRITE_FS_LAYOUT in InitMetaProcedure", "createdAt": "2020-08-10T22:19:49Z", "url": "https://github.com/apache/hbase/pull/2237", "merged": true, "mergeCommit": {"oid": "3ce90521880feefa65d67c4a2010314bf52c0ecf"}, "closed": true, "closedAt": "2021-10-12T17:56:01Z", "author": {"login": "taklwu"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc92UtCgFqTQ2NTAzMzc3MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABe8dEtTAFqTc0OTYyNjA4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MDMzNzcw", "url": "https://github.com/apache/hbase/pull/2237#pullrequestreview-465033770", "createdAt": "2020-08-11T12:52:56Z", "commit": {"oid": "ead2eee7946196ed8349c8e16abf03da656d98d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMjo1Mjo1NlrOG-2YAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMjo1Mjo1NlrOG-2YAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU1NTc3Ng==", "bodyText": "Hm... This check alone is not enough I fear..  Say there is a cluster recreate over existing data and so no zk node for clusterId.  We will get true here.  In next lines, we will create and write the zk node.   Assume immediately after that, the HM restarted.  Now after restart, when we come here, we have zk data for clusterId, and we will end up deleting the Meta dir !!\nAfter cluster recreate we will come to know this boolean value before creation of zk node.  So we need to record that info some how somewhere so that even if there is a restart before we reach to the Meta bootstrap.  Even that info should be there in InitMetaProcedure also.. If there is an HM restart after the submit of this proc, the next time we know the boolean status.\nComments?", "url": "https://github.com/apache/hbase/pull/2237#discussion_r468555776", "createdAt": "2020-08-11T12:52:56Z", "author": {"login": "anoopsjohn"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java", "diffHunk": "@@ -915,6 +917,11 @@ private void finishActiveMasterInitialization(MonitoredTask status)\n       this.tableDescriptors.getAll();\n     }\n \n+    // check cluster Id stored in ZNode before, and use it to indicate if a cluster has been\n+    // restarted with an existing Zookeeper quorum.\n+    isClusterRestartWithExistingZNodes =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ead2eee7946196ed8349c8e16abf03da656d98d5"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ead2eee7946196ed8349c8e16abf03da656d98d5", "author": {"user": {"login": "taklwu", "name": "Tak Lon (Stephen) Wu"}}, "url": "https://github.com/apache/hbase/commit/ead2eee7946196ed8349c8e16abf03da656d98d5", "committedDate": "2020-08-10T22:16:30Z", "message": "HBASE-24833: Bootstrap should not delete the META table directory if it's not partial\n\nAdd a check on meta bootstrap to skip removing meta table directory\nif ZK data does not exist when hmaster restart. here the existence\nof clusterID in ZK indicate if the meta is partial if we hit the\nINIT_META_WRITE_FS_LAYOUT in InitMetaProcedure"}, "afterCommit": {"oid": "98119eb5ba20240a485b374d71ed5337796c1393", "author": {"user": {"login": "taklwu", "name": "Tak Lon (Stephen) Wu"}}, "url": "https://github.com/apache/hbase/commit/98119eb5ba20240a485b374d71ed5337796c1393", "committedDate": "2020-08-18T06:21:46Z", "message": "HBASE-24833: Bootstrap should not delete the META table directory if it's not partial\n\nAdd a check on meta bootstrap to skip removing meta table directory\nWhen enterting state INIT_META_WRITE_FS_LAYOUT. here, if any valid\nHFiles are found in the meta table directory, it is not partial\nand throws an Exception to crash the Master startup."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5ODE3Nzkx", "url": "https://github.com/apache/hbase/pull/2237#pullrequestreview-469817791", "createdAt": "2020-08-18T20:45:42Z", "commit": {"oid": "98119eb5ba20240a485b374d71ed5337796c1393"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMDo0NTo0MlrOHCmDGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMDo0NTo0MlrOHCmDGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ4MjU4Nw==", "bodyText": "@Apache9, we're failing the InitMetaProcedure with an IOException, and HMaster will fail the master startup if InitMetaProcedure is FAILED with an exception.\nStill, alternatively, we could continue the bootstrap without throwing (but this is not good as you recommended)\nso, do you think this change align with your comments?", "url": "https://github.com/apache/hbase/pull/2237#discussion_r472482587", "createdAt": "2020-08-18T20:45:42Z", "author": {"login": "taklwu"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/procedure/InitMetaProcedure.java", "diffHunk": "@@ -167,4 +171,35 @@ protected void completionCleanup(MasterProcedureEnv env) {\n   public void await() throws InterruptedException {\n     latch.await();\n   }\n+\n+  private static boolean deleteMetaTableDirectoryIfPartial(FileSystem rootDirectoryFs,\n+    Path metaTableDir) throws IOException {\n+    boolean isPartial = true;\n+    try {\n+      TableDescriptor metaDescriptor =\n+        FSTableDescriptors.getTableDescriptorFromFs(rootDirectoryFs, metaTableDir);\n+      // when entering the state of INIT_META_WRITE_FS_LAYOUT, if a meta table directory is found,\n+      // the meta table should not have any useful data and considers as partial.\n+      // if we find any valid HFiles, operator should fix the meta e.g. via HBCK.\n+      if (metaDescriptor != null && metaDescriptor.getColumnFamilyCount() > 0) {\n+        RemoteIterator<LocatedFileStatus> iterator = rootDirectoryFs.listFiles(metaTableDir, true);\n+        while (iterator.hasNext()) {\n+          LocatedFileStatus status = iterator.next();\n+          if (StoreFileInfo.isHFile(status.getPath()) && HFile\n+            .isHFileFormat(rootDirectoryFs, status.getPath())) {\n+            isPartial = false;\n+            break;\n+          }\n+        }\n+      }\n+    } finally {\n+      if (!isPartial) {\n+        throw new IOException(\"Meta table is not partial, please sideline this meta directory \"\n+          + \"or run HBCK to fix this meta table, e.g. rebuild the server hostname in ZNode for the \"\n+          + \"meta region\");\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98119eb5ba20240a485b374d71ed5337796c1393"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMDk5MTQ1", "url": "https://github.com/apache/hbase/pull/2237#pullrequestreview-470099145", "createdAt": "2020-08-19T03:27:39Z", "commit": {"oid": "98119eb5ba20240a485b374d71ed5337796c1393"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMzoyNzozOVrOHCvq5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMzoyNzozOVrOHCvq5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY0MDIyOA==", "bodyText": "In general the approach is fine. The only concern is the implementation. I do not think InitMetaProcedure support rollback, so what will happen if we throw exception here? You will see a ERROR log in the output to say that the procedure does not support rollback?", "url": "https://github.com/apache/hbase/pull/2237#discussion_r472640228", "createdAt": "2020-08-19T03:27:39Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/procedure/InitMetaProcedure.java", "diffHunk": "@@ -167,4 +171,35 @@ protected void completionCleanup(MasterProcedureEnv env) {\n   public void await() throws InterruptedException {\n     latch.await();\n   }\n+\n+  private static boolean deleteMetaTableDirectoryIfPartial(FileSystem rootDirectoryFs,\n+    Path metaTableDir) throws IOException {\n+    boolean isPartial = true;\n+    try {\n+      TableDescriptor metaDescriptor =\n+        FSTableDescriptors.getTableDescriptorFromFs(rootDirectoryFs, metaTableDir);\n+      // when entering the state of INIT_META_WRITE_FS_LAYOUT, if a meta table directory is found,\n+      // the meta table should not have any useful data and considers as partial.\n+      // if we find any valid HFiles, operator should fix the meta e.g. via HBCK.\n+      if (metaDescriptor != null && metaDescriptor.getColumnFamilyCount() > 0) {\n+        RemoteIterator<LocatedFileStatus> iterator = rootDirectoryFs.listFiles(metaTableDir, true);\n+        while (iterator.hasNext()) {\n+          LocatedFileStatus status = iterator.next();\n+          if (StoreFileInfo.isHFile(status.getPath()) && HFile\n+            .isHFileFormat(rootDirectoryFs, status.getPath())) {\n+            isPartial = false;\n+            break;\n+          }\n+        }\n+      }\n+    } finally {\n+      if (!isPartial) {\n+        throw new IOException(\"Meta table is not partial, please sideline this meta directory \"\n+          + \"or run HBCK to fix this meta table, e.g. rebuild the server hostname in ZNode for the \"\n+          + \"meta region\");\n+      }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ4MjU4Nw=="}, "originalCommit": {"oid": "98119eb5ba20240a485b374d71ed5337796c1393"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMjg0NjM3", "url": "https://github.com/apache/hbase/pull/2237#pullrequestreview-471284637", "createdAt": "2020-08-20T06:36:02Z", "commit": {"oid": "98119eb5ba20240a485b374d71ed5337796c1393"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY5NTkyOTEx", "url": "https://github.com/apache/hbase/pull/2237#pullrequestreview-569592911", "createdAt": "2021-01-15T20:22:06Z", "commit": {"oid": "082d601941be026d13df42cc469c4895d1774acd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQyMDoyMjowN1rOIUsmsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQyMDoyMjozNVrOIUsnag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODU3MzIzNQ==", "bodyText": "Should we mention the HBCK sub command to help fix this? (Is this offline meta repair?) Since we're adding a new failure mode, it should be clear how to fix this case.", "url": "https://github.com/apache/hbase/pull/2237#discussion_r558573235", "createdAt": "2021-01-15T20:22:07Z", "author": {"login": "z-york"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/procedure/InitMetaProcedure.java", "diffHunk": "@@ -166,4 +170,35 @@ protected void completionCleanup(MasterProcedureEnv env) {\n   public void await() throws InterruptedException {\n     latch.await();\n   }\n+\n+  private static boolean deleteMetaTableDirectoryIfPartial(FileSystem rootDirectoryFs,\n+    Path metaTableDir) throws IOException {\n+    boolean isPartial = true;\n+    try {\n+      TableDescriptor metaDescriptor =\n+        FSTableDescriptors.getTableDescriptorFromFs(rootDirectoryFs, metaTableDir);\n+      // when entering the state of INIT_META_WRITE_FS_LAYOUT, if a meta table directory is found,\n+      // the meta table should not have any useful data and considers as partial.\n+      // if we find any valid HFiles, operator should fix the meta e.g. via HBCK.\n+      if (metaDescriptor != null && metaDescriptor.getColumnFamilyCount() > 0) {\n+        RemoteIterator<LocatedFileStatus> iterator = rootDirectoryFs.listFiles(metaTableDir, true);\n+        while (iterator.hasNext()) {\n+          LocatedFileStatus status = iterator.next();\n+          if (StoreFileInfo.isHFile(status.getPath()) && HFile\n+            .isHFileFormat(rootDirectoryFs, status.getPath())) {\n+            isPartial = false;\n+            break;\n+          }\n+        }\n+      }\n+    } finally {\n+      if (!isPartial) {\n+        throw new IOException(\"Meta table is not partial, please sideline this meta directory \"\n+          + \"or run HBCK to fix this meta table, e.g. rebuild the server hostname in ZNode for the \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "082d601941be026d13df42cc469c4895d1774acd"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODU3MzQxOA==", "bodyText": "Change to shouldDelete? isPartial is a bit confusing to me.", "url": "https://github.com/apache/hbase/pull/2237#discussion_r558573418", "createdAt": "2021-01-15T20:22:35Z", "author": {"login": "z-york"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/procedure/InitMetaProcedure.java", "diffHunk": "@@ -166,4 +170,35 @@ protected void completionCleanup(MasterProcedureEnv env) {\n   public void await() throws InterruptedException {\n     latch.await();\n   }\n+\n+  private static boolean deleteMetaTableDirectoryIfPartial(FileSystem rootDirectoryFs,\n+    Path metaTableDir) throws IOException {\n+    boolean isPartial = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "082d601941be026d13df42cc469c4895d1774acd"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37c1f51c9cb46c85e74a42e5def7841e45c55473", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/37c1f51c9cb46c85e74a42e5def7841e45c55473", "committedDate": "2021-09-07T17:11:20Z", "message": "HBASE-24833: Bootstrap should not delete the META table directory if it's not partial\n\nAdd a check on meta bootstrap to skip removing meta table directory\nWhen entering state INIT_META_WRITE_FS_LAYOUT. here, if any valid\nHFiles are found in the meta table directory, it is not partial\nand throws an Exception to crash the Master startup."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5010b26a2a26ddc811d02e07052596a74857fbc", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/b5010b26a2a26ddc811d02e07052596a74857fbc", "committedDate": "2021-09-07T17:26:15Z", "message": "Remove Zknode will not hang anymore after HBASE-26193"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "082d601941be026d13df42cc469c4895d1774acd", "author": {"user": {"login": "taklwu", "name": "Tak Lon (Stephen) Wu"}}, "url": "https://github.com/apache/hbase/commit/082d601941be026d13df42cc469c4895d1774acd", "committedDate": "2021-01-14T21:12:49Z", "message": "Merge branch 'branch-2' into HBASE-24833-branch-2"}, "afterCommit": {"oid": "b5010b26a2a26ddc811d02e07052596a74857fbc", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/b5010b26a2a26ddc811d02e07052596a74857fbc", "committedDate": "2021-09-07T17:26:15Z", "message": "Remove Zknode will not hang anymore after HBASE-26193"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NzQ5NjI2MDg5", "url": "https://github.com/apache/hbase/pull/2237#pullrequestreview-749626089", "createdAt": "2021-09-08T21:16:14Z", "commit": {"oid": "b5010b26a2a26ddc811d02e07052596a74857fbc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4849, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}