{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4ODk0NDg1", "number": 2174, "title": "HBASE-24794 hbase.rowlock.wait.duration should not be <= 0", "bodyText": "with just the new test, things fail after spinning until timeout\n13:40:17 [INFO] -------------------------------------------------------\n13:40:17 [INFO]  T E S T S\n13:40:17 [INFO] -------------------------------------------------------\n13:40:18 [INFO] Running org.apache.hadoop.hbase.regionserver.TestHRegion\n13:54:30 [ERROR] Tests run: 104, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 780.658 s <<< FAILURE! - in org.apache.hadoop.hbase.regionserver.TestHRegion\n13:54:30 [ERROR] org.apache.hadoop.hbase.regionserver.TestHRegion  Time elapsed: 586.556 s  <<< ERROR!\norg.junit.runners.model.TestTimedOutException: test timed out after 780 seconds\n\tat org.apache.hadoop.hbase.regionserver.TestHRegion.testBatchMutateWithZeroRowLockWait(TestHRegion.java:6488)\n\nwarning for those looking to duplicate this, there are about 2.5 million copies of this message\nMacBook-Air:hbase busbey$ grep -A 30 \"Failed getting lock, row=a\" hbase-server/target/surefire-reports/org.apache.hadoop.hbase.regionserver.TestHRegion-output.txt | head -n 31\n2020-07-29 13:43:32,802 WARN  [Time-limited test] regionserver.HRegion$BatchOperation(3501): Failed getting lock, row=a, in region org.apache.hadoop.hbase.regionserver.HRegion$MutationBatchOperation@3546487c\njava.io.IOException: Timed out waiting for lock for row: a in region 9368508e4300a0030fbbdf19cc7e1fcd\n\tat org.apache.hadoop.hbase.regionserver.HRegion.getRowLockInternal(HRegion.java:6151)\n\tat org.apache.hadoop.hbase.regionserver.HRegion$BatchOperation.lockRowsAndBuildMiniBatch(HRegion.java:3493)\n\tat org.apache.hadoop.hbase.regionserver.HRegion.doMiniBatchMutate(HRegion.java:4194)\n\tat org.apache.hadoop.hbase.regionserver.HRegion.batchMutate(HRegion.java:4164)\n\tat org.apache.hadoop.hbase.regionserver.HRegion.batchMutate(HRegion.java:4095)\n\tat org.apache.hadoop.hbase.regionserver.HRegion.batchMutate(HRegion.java:4086)\n\tat org.apache.hadoop.hbase.regionserver.HRegion.batchMutate(HRegion.java:4100)\n\tat org.apache.hadoop.hbase.regionserver.TestHRegion.testBatchMutateWithZeroRowLockWait(TestHRegion.java:6488)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:59)\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:56)\n\tat org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\n\tat org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)\n\tat org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)\n\tat org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:61)\n\tat org.junit.rules.ExpectedException$ExpectedExceptionStatement.evaluate(ExpectedException.java:258)\n\tat org.junit.runners.ParentRunner$3.evaluate(ParentRunner.java:306)\n\tat org.junit.runners.BlockJUnit4ClassRunner$1.evaluate(BlockJUnit4ClassRunner.java:100)\n\tat org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:366)\n\tat org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:103)\n\tat org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:63)\n\tat org.junit.runners.ParentRunner$4.run(ParentRunner.java:331)\n\tat org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:79)\n\tat org.junit.runners.ParentRunner.runChildren(ParentRunner.java:329)\n\tat org.junit.runners.ParentRunner.access$100(ParentRunner.java:66)\n\nand it takes a bit of room\nMacBook-Air:hbase busbey$ ls -lah hbase-server/target/surefire-reports/org.apache.hadoop.hbase.regionserver.TestHRegion-output.txt \n-rw-r--r--  1 busbey  staff   7.7G Jul 29 13:55 hbase-server/target/surefire-reports/org.apache.hadoop.hbase.regionserver.TestHRegion-output.txt\n\ntest passes after this patch is in place, verified presence of warning in test logs. test-only backport to branch-1.3 also passes without the HRegion change.\ntested out a branch-2.1 based backport on a cluster and that also worked as expected (logged a warning and then writes to meta were able to succeed)", "createdAt": "2020-07-30T06:00:47Z", "url": "https://github.com/apache/hbase/pull/2174", "merged": true, "mergeCommit": {"oid": "840a55761b4b3db6bfcf8ca5b7ae67509fc21566"}, "closed": true, "closedAt": "2020-07-30T17:26:12Z", "author": {"login": "busbey"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5x-2pAH2gAyNDU4ODk0NDg1OjZiZGNlMzVlZmI1MTJiNzEyNTk0NTczZmFmZTgxMWRiMGFlODY2ODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6CxFngFqTQ1ODU5NTQyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6bdce35efb512b712594573fafe811db0ae86684", "author": {"user": {"login": "busbey", "name": "Sean Busbey"}}, "url": "https://github.com/apache/hbase/commit/6bdce35efb512b712594573fafe811db0ae86684", "committedDate": "2020-07-29T21:33:46Z", "message": "HBASE-24794 hbase.rowlock.wait.duration should not be <= 0"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MTQ2Mzc1", "url": "https://github.com/apache/hbase/pull/2174#pullrequestreview-458146375", "createdAt": "2020-07-30T07:24:28Z", "commit": {"oid": "6bdce35efb512b712594573fafe811db0ae86684"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwNzoyNDoyOVrOG5XGmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwNzoyNDoyOVrOG5XGmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjgwMDUzOA==", "bodyText": "nit: We are not expecting this condition for upgrade to 3.0.0 right? We can either roll this out to branch-2.2+ except master or we can remove behavior of hbase versions older than 1.4 from log msg at least in master branch to treat this as generic condition regardless of how HBase version<1.4 treated negative rowLockDuration. For branch-2.2+, log msg as is should be good (i.e behavior of hbase versions older than 1.4 suits well to branch-2.x).\nThought?", "url": "https://github.com/apache/hbase/pull/2174#discussion_r462800538", "createdAt": "2020-07-30T07:24:29Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java", "diffHunk": "@@ -793,8 +793,15 @@ public HRegion(final HRegionFileSystem fs, final WAL wal, final Configuration co\n       throw new IllegalArgumentException(MEMSTORE_FLUSH_PER_CHANGES + \" can not exceed \"\n           + MAX_FLUSH_PER_CHANGES);\n     }\n-    this.rowLockWaitDuration = conf.getInt(\"hbase.rowlock.wait.duration\",\n-                    DEFAULT_ROWLOCK_WAIT_DURATION);\n+    int tmpRowLockDuration = conf.getInt(\"hbase.rowlock.wait.duration\",\n+        DEFAULT_ROWLOCK_WAIT_DURATION);\n+    if (tmpRowLockDuration <= 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bdce35efb512b712594573fafe811db0ae86684"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e0f95dfcb4b419e9c2e8ccdc2cebb01eb30b1aa", "author": {"user": {"login": "busbey", "name": "Sean Busbey"}}, "url": "https://github.com/apache/hbase/commit/4e0f95dfcb4b419e9c2e8ccdc2cebb01eb30b1aa", "committedDate": "2020-07-30T16:22:40Z", "message": "HBASE-24794 addendum for better info message."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NTk1NDI1", "url": "https://github.com/apache/hbase/pull/2174#pullrequestreview-458595425", "createdAt": "2020-07-30T17:07:07Z", "commit": {"oid": "4e0f95dfcb4b419e9c2e8ccdc2cebb01eb30b1aa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4123, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}