{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2Njc5NzY0", "number": 1401, "title": "HBASE-24075: Fix a race between master shutdown and metrics (re)init", "bodyText": "JMXCacheBuster resets the metrics state at various points in time. These\nevents can potentially race with a master shutdown. When the master is\ntearing down, metrics initialization can touch a lot of unsafe state,\nfor example invalidated FS objects. To avoid this, this patch makes\nthe getMetrics() a no-op when the master is either stopped or in the\nprocess of shutting down. Additionally, getClusterId() when the server\nis shutting down is made a no-op.\nSimulating a test for this is a bit tricky but with the patch I don't\nlocally see the long stacktraces from the jira.\nSigned-off-by: Michael Stack stack@apache.org\n(cherry picked from commit 6f213e9)", "createdAt": "2020-03-31T23:52:31Z", "url": "https://github.com/apache/hbase/pull/1401", "merged": true, "mergeCommit": {"oid": "9384b8455252300a2f96f4eeedc96591e8e5d60a"}, "closed": true, "closedAt": "2020-04-01T17:14:36Z", "author": {"login": "bharathv"}, "timelineItems": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTL-ryAH2gAyMzk2Njc5NzY0OjIxMWI0YmZiZjkxZDc4YmFlZDBlYjRlODMzNzVhOGQ2ZmE2ZTg5YTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTQgQAgFqTM4NTI2Njk3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "211b4bfbf91d78baed0eb4e83375a8d6fa6e89a3", "author": {"user": {"login": "bharathv", "name": "Bharath Vissapragada"}}, "url": "https://github.com/apache/hbase/commit/211b4bfbf91d78baed0eb4e83375a8d6fa6e89a3", "committedDate": "2020-03-31T23:48:04Z", "message": "HBASE-24075: Fix a race between master shutdown and metrics (re)init\n\nJMXCacheBuster resets the metrics state at various points in time. These\nevents can potentially race with a master shutdown. When the master is\ntearing down, metrics initialization can touch a lot of unsafe state,\nfor example invalidated FS objects. To avoid this, this patch makes\nthe getMetrics() a no-op when the master is either stopped or in the\nprocess of shutting down. Additionally, getClusterId() when the server\nis shutting down is made a no-op.\n\nSimulating a test for this is a bit tricky but with the patch I don't\nlocally see the long stacktraces from the jira.\n\nSigned-off-by: Michael Stack <stack@apache.org>\n(cherry picked from commit 6f213e9d5a15afcc40b6562ab4898f913cec91eb)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MjY2OTc1", "url": "https://github.com/apache/hbase/pull/1401#pullrequestreview-385266975", "createdAt": "2020-04-01T05:03:36Z", "commit": {"oid": "211b4bfbf91d78baed0eb4e83375a8d6fa6e89a3"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwNTowMzozNlrOF-w6aQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwNTowMzo1NFrOF-w6uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM1NzQxNw==", "bodyText": "Great", "url": "https://github.com/apache/hbase/pull/1401#discussion_r401357417", "createdAt": "2020-04-01T05:03:36Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/CachedClusterId.java", "diffHunk": "@@ -130,9 +134,12 @@ private void waitForFetchToFinish() throws InterruptedException {\n    * trying get from a clean cache.\n    *\n    * @return ClusterId by reading from FileSystem or null in any error case or cluster ID does\n-   *     not exist on the file system.\n+   *     not exist on the file system or if the server initiated a tear down.\n    */\n   public String getFromCacheOrFetch() {\n+    if (server.isStopping() || server.isStopped()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "211b4bfbf91d78baed0eb4e83375a8d6fa6e89a3"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM1NzQ5OQ==", "bodyText": "isStopped is probably enough but this is fine.", "url": "https://github.com/apache/hbase/pull/1401#discussion_r401357499", "createdAt": "2020-04-01T05:03:54Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/CachedClusterId.java", "diffHunk": "@@ -130,9 +134,12 @@ private void waitForFetchToFinish() throws InterruptedException {\n    * trying get from a clean cache.\n    *\n    * @return ClusterId by reading from FileSystem or null in any error case or cluster ID does\n-   *     not exist on the file system.\n+   *     not exist on the file system or if the server initiated a tear down.\n    */\n   public String getFromCacheOrFetch() {\n+    if (server.isStopping() || server.isStopped()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTM1NzQxNw=="}, "originalCommit": {"oid": "211b4bfbf91d78baed0eb4e83375a8d6fa6e89a3"}, "originalPosition": 46}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2523, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}