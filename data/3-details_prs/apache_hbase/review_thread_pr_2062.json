{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4NTc1NTQ2", "number": 2062, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwOTozNToxMFrOEOLlzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwOTo0Mzo0OVrOEOLxmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMzA1NDIwOnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/MetaFixer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwOTozNToxMFrOGxL_jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNzoxNzo1OVrOGxdcUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIyOTkwMw==", "bodyText": "It seems addReplicas does not require TableDescriptor. Can you please remove it with this PR?", "url": "https://github.com/apache/hbase/pull/2062#discussion_r454229903", "createdAt": "2020-07-14T09:35:10Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/MetaFixer.java", "diffHunk": "@@ -174,22 +177,35 @@ private static RegionInfo buildRegionInfo(TableName tn, byte [] start, byte [] e\n   private static List<RegionInfo> createMetaEntries(final MasterServices masterServices,\n     final List<RegionInfo> newRegionInfos) {\n \n-    final List<Either<RegionInfo, IOException>> addMetaEntriesResults = newRegionInfos.stream()\n+    final List<Either<List<RegionInfo>, IOException>> addMetaEntriesResults = newRegionInfos.stream()\n       .map(regionInfo -> {\n         try {\n-          MetaTableAccessor.addRegionToMeta(masterServices.getConnection(), regionInfo);\n-          masterServices.getAssignmentManager()\n-            .getRegionStates()\n-            .updateRegionState(regionInfo, RegionState.State.CLOSED);\n-          return Either.<RegionInfo, IOException>ofLeft(regionInfo);\n+          TableDescriptor td = masterServices.getTableDescriptors().get(regionInfo.getTable());\n+\n+          // Add replicas if needed\n+          // we need to create regions with replicaIds starting from 1\n+          List<RegionInfo> newRegions = RegionReplicaUtil.addReplicas(td,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ccc11505f7d9988a40a023756a3dbd6e08b1799"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUxNTc5Mg==", "bodyText": "Ok, let me remove it.", "url": "https://github.com/apache/hbase/pull/2062#discussion_r454515792", "createdAt": "2020-07-14T17:17:59Z", "author": {"login": "huaxiangsun"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/MetaFixer.java", "diffHunk": "@@ -174,22 +177,35 @@ private static RegionInfo buildRegionInfo(TableName tn, byte [] start, byte [] e\n   private static List<RegionInfo> createMetaEntries(final MasterServices masterServices,\n     final List<RegionInfo> newRegionInfos) {\n \n-    final List<Either<RegionInfo, IOException>> addMetaEntriesResults = newRegionInfos.stream()\n+    final List<Either<List<RegionInfo>, IOException>> addMetaEntriesResults = newRegionInfos.stream()\n       .map(regionInfo -> {\n         try {\n-          MetaTableAccessor.addRegionToMeta(masterServices.getConnection(), regionInfo);\n-          masterServices.getAssignmentManager()\n-            .getRegionStates()\n-            .updateRegionState(regionInfo, RegionState.State.CLOSED);\n-          return Either.<RegionInfo, IOException>ofLeft(regionInfo);\n+          TableDescriptor td = masterServices.getTableDescriptors().get(regionInfo.getTable());\n+\n+          // Add replicas if needed\n+          // we need to create regions with replicaIds starting from 1\n+          List<RegionInfo> newRegions = RegionReplicaUtil.addReplicas(td,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIyOTkwMw=="}, "originalCommit": {"oid": "0ccc11505f7d9988a40a023756a3dbd6e08b1799"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMzA4NDQzOnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/MetaFixer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwOTo0Mzo0OVrOGxMSoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNzoxODoxNFrOGxdc3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIzNDc4NQ==", "bodyText": "nit: line is beyond 100 char limit. Spotbugs is no longer considering line max char limits it seems.", "url": "https://github.com/apache/hbase/pull/2062#discussion_r454234785", "createdAt": "2020-07-14T09:43:49Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/MetaFixer.java", "diffHunk": "@@ -174,22 +177,35 @@ private static RegionInfo buildRegionInfo(TableName tn, byte [] start, byte [] e\n   private static List<RegionInfo> createMetaEntries(final MasterServices masterServices,\n     final List<RegionInfo> newRegionInfos) {\n \n-    final List<Either<RegionInfo, IOException>> addMetaEntriesResults = newRegionInfos.stream()\n+    final List<Either<List<RegionInfo>, IOException>> addMetaEntriesResults = newRegionInfos.stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ccc11505f7d9988a40a023756a3dbd6e08b1799"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUxNTkzMw==", "bodyText": "Will do.", "url": "https://github.com/apache/hbase/pull/2062#discussion_r454515933", "createdAt": "2020-07-14T17:18:14Z", "author": {"login": "huaxiangsun"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/MetaFixer.java", "diffHunk": "@@ -174,22 +177,35 @@ private static RegionInfo buildRegionInfo(TableName tn, byte [] start, byte [] e\n   private static List<RegionInfo> createMetaEntries(final MasterServices masterServices,\n     final List<RegionInfo> newRegionInfos) {\n \n-    final List<Either<RegionInfo, IOException>> addMetaEntriesResults = newRegionInfos.stream()\n+    final List<Either<List<RegionInfo>, IOException>> addMetaEntriesResults = newRegionInfos.stream()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIzNDc4NQ=="}, "originalCommit": {"oid": "0ccc11505f7d9988a40a023756a3dbd6e08b1799"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2789, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}