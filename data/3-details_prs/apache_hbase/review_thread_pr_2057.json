{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4MjQwMDU0", "number": 2057, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNTo0MjozM1rOEN4INw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNzozMjo1OFrOEN6yHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyOTg2NTUxOnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNTo0MjozM1rOGwucZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNzowNjowM1rOGxdAWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc0NTc2Ng==", "bodyText": "This change is related to this PR?", "url": "https://github.com/apache/hbase/pull/2057#discussion_r453745766", "createdAt": "2020-07-13T15:42:33Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java", "diffHunk": "@@ -715,7 +716,10 @@ public static void closeRegionSilentlyAndWait(AsyncClusterConnection connection,\n           return;\n         }\n       } catch (IOException ioe) {\n-        if (ioe instanceof NotServingRegionException) {\n+        if (ioe instanceof NotServingRegionException ||\n+          (ioe instanceof RemoteWithExtrasException &&\n+            ((RemoteWithExtrasException)ioe).unwrapRemoteException()\n+              instanceof NotServingRegionException)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1baf3ad44e479f1e9bb46a5661f177a332efc30b"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIzMTE1Mg==", "bodyText": "Yes, it is. The excess meta replicas are not assigned so when we try to close them a NotServingRegionException is thrown. Unfortunately it gets wrapped in a RemoteWithExtrasException which was not handled so the logic kept trying to close the region not realizing it was not necessary.", "url": "https://github.com/apache/hbase/pull/2057#discussion_r454231152", "createdAt": "2020-07-14T09:37:21Z", "author": {"login": "BukrosSzabolcs"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java", "diffHunk": "@@ -715,7 +716,10 @@ public static void closeRegionSilentlyAndWait(AsyncClusterConnection connection,\n           return;\n         }\n       } catch (IOException ioe) {\n-        if (ioe instanceof NotServingRegionException) {\n+        if (ioe instanceof NotServingRegionException ||\n+          (ioe instanceof RemoteWithExtrasException &&\n+            ((RemoteWithExtrasException)ioe).unwrapRemoteException()\n+              instanceof NotServingRegionException)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc0NTc2Ng=="}, "originalCommit": {"oid": "1baf3ad44e479f1e9bb46a5661f177a332efc30b"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDUwODYzNA==", "bodyText": "Sounds good, I thought it was specific to unit test and only in the case of unit test (based on config), this is happening but yeah if this is generic, we are good.\nThanks @BukrosSzabolcs", "url": "https://github.com/apache/hbase/pull/2057#discussion_r454508634", "createdAt": "2020-07-14T17:06:03Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java", "diffHunk": "@@ -715,7 +716,10 @@ public static void closeRegionSilentlyAndWait(AsyncClusterConnection connection,\n           return;\n         }\n       } catch (IOException ioe) {\n-        if (ioe instanceof NotServingRegionException) {\n+        if (ioe instanceof NotServingRegionException ||\n+          (ioe instanceof RemoteWithExtrasException &&\n+            ((RemoteWithExtrasException)ioe).unwrapRemoteException()\n+              instanceof NotServingRegionException)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc0NTc2Ng=="}, "originalCommit": {"oid": "1baf3ad44e479f1e9bb46a5661f177a332efc30b"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMDI5OTgyOnYy", "diffSide": "RIGHT", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestMetaWithReplicasBasic.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNzozMjo0OFrOGwypjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjozNDozMFrOGxRq3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgxNDY2OA==", "bodyText": "The parameter order for assertEquals should be switched.", "url": "https://github.com/apache/hbase/pull/2057#discussion_r453814668", "createdAt": "2020-07-13T17:32:48Z", "author": {"login": "petersomogyi"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestMetaWithReplicasBasic.java", "diffHunk": "@@ -80,6 +83,27 @@ public void testZookeeperNodesForReplicas() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testReplicaCleanup() throws Exception {\n+    ZKWatcher zkw = TEST_UTIL.getZooKeeperWatcher();\n+    List<String> metaReplicaZnodes = zkw.getMetaReplicaNodes();\n+    assertEquals(metaReplicaZnodes.size(), 3);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1baf3ad44e479f1e9bb46a5661f177a332efc30b"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMyMjkwOA==", "bodyText": "Switched", "url": "https://github.com/apache/hbase/pull/2057#discussion_r454322908", "createdAt": "2020-07-14T12:34:30Z", "author": {"login": "BukrosSzabolcs"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestMetaWithReplicasBasic.java", "diffHunk": "@@ -80,6 +83,27 @@ public void testZookeeperNodesForReplicas() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testReplicaCleanup() throws Exception {\n+    ZKWatcher zkw = TEST_UTIL.getZooKeeperWatcher();\n+    List<String> metaReplicaZnodes = zkw.getMetaReplicaNodes();\n+    assertEquals(metaReplicaZnodes.size(), 3);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgxNDY2OA=="}, "originalCommit": {"oid": "1baf3ad44e479f1e9bb46a5661f177a332efc30b"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMDMwMDQ3OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestMetaWithReplicasBasic.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNzozMjo1OFrOGwyp7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMjozNDozNFrOGxRrDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgxNDc2Nw==", "bodyText": "The parameter order for assertEquals should be switched.", "url": "https://github.com/apache/hbase/pull/2057#discussion_r453814767", "createdAt": "2020-07-13T17:32:58Z", "author": {"login": "petersomogyi"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestMetaWithReplicasBasic.java", "diffHunk": "@@ -80,6 +83,27 @@ public void testZookeeperNodesForReplicas() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testReplicaCleanup() throws Exception {\n+    ZKWatcher zkw = TEST_UTIL.getZooKeeperWatcher();\n+    List<String> metaReplicaZnodes = zkw.getMetaReplicaNodes();\n+    assertEquals(metaReplicaZnodes.size(), 3);\n+\n+    final HMaster master = TEST_UTIL.getMiniHBaseCluster().getMaster();\n+    master.stop(\"Restarting\");\n+    TEST_UTIL.waitFor(30000, () -> master.isStopped());\n+    TEST_UTIL.getMiniHBaseCluster().getConfiguration().setInt(HConstants.META_REPLICAS_NUM, 1);\n+\n+    JVMClusterUtil.MasterThread newMasterThread = TEST_UTIL.getMiniHBaseCluster().startMaster();\n+    final HMaster newMaster = newMasterThread.getMaster();\n+\n+    //wait until new master finished meta replica assignment logic\n+    TEST_UTIL.waitFor(30000, () -> newMaster.getMasterQuotaManager() != null);\n+    zkw = TEST_UTIL.getZooKeeperWatcher();\n+    metaReplicaZnodes = zkw.getMetaReplicaNodes();\n+    assertEquals(metaReplicaZnodes.size(), 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1baf3ad44e479f1e9bb46a5661f177a332efc30b"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDMyMjk1OA==", "bodyText": "Switched", "url": "https://github.com/apache/hbase/pull/2057#discussion_r454322958", "createdAt": "2020-07-14T12:34:34Z", "author": {"login": "BukrosSzabolcs"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestMetaWithReplicasBasic.java", "diffHunk": "@@ -80,6 +83,27 @@ public void testZookeeperNodesForReplicas() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testReplicaCleanup() throws Exception {\n+    ZKWatcher zkw = TEST_UTIL.getZooKeeperWatcher();\n+    List<String> metaReplicaZnodes = zkw.getMetaReplicaNodes();\n+    assertEquals(metaReplicaZnodes.size(), 3);\n+\n+    final HMaster master = TEST_UTIL.getMiniHBaseCluster().getMaster();\n+    master.stop(\"Restarting\");\n+    TEST_UTIL.waitFor(30000, () -> master.isStopped());\n+    TEST_UTIL.getMiniHBaseCluster().getConfiguration().setInt(HConstants.META_REPLICAS_NUM, 1);\n+\n+    JVMClusterUtil.MasterThread newMasterThread = TEST_UTIL.getMiniHBaseCluster().startMaster();\n+    final HMaster newMaster = newMasterThread.getMaster();\n+\n+    //wait until new master finished meta replica assignment logic\n+    TEST_UTIL.waitFor(30000, () -> newMaster.getMasterQuotaManager() != null);\n+    zkw = TEST_UTIL.getZooKeeperWatcher();\n+    metaReplicaZnodes = zkw.getMetaReplicaNodes();\n+    assertEquals(metaReplicaZnodes.size(), 1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgxNDc2Nw=="}, "originalCommit": {"oid": "1baf3ad44e479f1e9bb46a5661f177a332efc30b"}, "originalPosition": 42}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2783, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}