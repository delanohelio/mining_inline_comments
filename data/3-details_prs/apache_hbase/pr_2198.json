{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMDA1NDY0", "number": 2198, "title": "HBASE-24817 Allow configuring WALEntry filters on ReplicationSource", "bodyText": "Allow specifying base WALEntry filter on construction of\nReplicationSource. Add means of being able to filter WALs by name.\nhbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java\nAdd constructor that allows passing a predicate for filtering in WALs\nand a list of filters for filtering out WALEntries. The latter was\nhardcoded to filter out system-table WALEntries. The former did not\nexist but we'll need it if Replication takes in more than just the\ndefault Provider.", "createdAt": "2020-08-04T20:57:22Z", "url": "https://github.com/apache/hbase/pull/2198", "merged": true, "mergeCommit": {"oid": "9a564dc2bff0f55d2b0ef93a2cdf74cdbde578ba"}, "closed": true, "closedAt": "2020-08-06T16:29:09Z", "author": {"login": "saintstack"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc78qOFAFqTQ2MTc0NzQ3OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8HxoWgFqTQ2MjE3MjQ2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNzQ3NDc5", "url": "https://github.com/apache/hbase/pull/2198#pullrequestreview-461747479", "createdAt": "2020-08-05T14:56:46Z", "commit": {"oid": "bafff990e6a06aff532582ea39f618db67afbbdf"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNDo1Njo0NlrOG8NhwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNTowMzo1MVrOG8N2FA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc4OTM3Ng==", "bodyText": "For system tables we return null Entry. Good to consider return type Optional<Entry> here?\nMaybe as follow up task?", "url": "https://github.com/apache/hbase/pull/2198#discussion_r465789376", "createdAt": "2020-08-05T14:56:46Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/WALEntryFilter.java", "diffHunk": "@@ -49,5 +47,5 @@\n    * @return a (possibly modified) Entry to use. Returning null or an entry with no cells will cause\n    *         the entry to be skipped for replication.\n    */\n-  public Entry filter(Entry entry);\n+  Entry filter(Entry entry);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bafff990e6a06aff532582ea39f618db67afbbdf"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc5MTk2Ng==", "bodyText": "nit: just in case if you like assertSame(e, wef.filter(e))", "url": "https://github.com/apache/hbase/pull/2198#discussion_r465791966", "createdAt": "2020-08-05T15:00:15Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/replication/regionserver/TestReplicationSource.java", "diffHunk": "@@ -108,16 +107,100 @@ public static void tearDownAfterClass() throws Exception {\n     TEST_UTIL.shutdownMiniDFSCluster();\n   }\n \n+  /**\n+   * Test the default ReplicationSource skips queuing hbase:meta WAL files.\n+   */\n+  @Test\n+  public void testDefaultSkipsMetaWAL() throws IOException {\n+    ReplicationSource rs = new ReplicationSource();\n+    Configuration conf = new Configuration(TEST_UTIL.getConfiguration());\n+    conf.setInt(\"replication.source.maxretriesmultiplier\", 1);\n+    ReplicationPeer mockPeer = Mockito.mock(ReplicationPeer.class);\n+    Mockito.when(mockPeer.getConfiguration()).thenReturn(conf);\n+    Mockito.when(mockPeer.getPeerBandwidth()).thenReturn(0L);\n+    ReplicationPeerConfig peerConfig = Mockito.mock(ReplicationPeerConfig.class);\n+    Mockito.when(peerConfig.getReplicationEndpointImpl()).\n+      thenReturn(DoNothingReplicationEndpoint.class.getName());\n+    Mockito.when(mockPeer.getPeerConfig()).thenReturn(peerConfig);\n+    ReplicationSourceManager manager = Mockito.mock(ReplicationSourceManager.class);\n+    Mockito.when(manager.getTotalBufferUsed()).thenReturn(new AtomicLong());\n+    String queueId = \"qid\";\n+    RegionServerServices rss =\n+      TEST_UTIL.createMockRegionServerService(ServerName.parseServerName(\"a.b.c,1,1\"));\n+    rs.init(conf, null, manager, null, mockPeer, rss, queueId, null,\n+      p -> OptionalLong.empty(), new MetricsSource(queueId));\n+    try {\n+      rs.startup();\n+      assertTrue(rs.isSourceActive());\n+      assertEquals(0, rs.getSourceMetrics().getSizeOfLogQueue());\n+      rs.enqueueLog(new Path(\"a.1\" + META_WAL_PROVIDER_ID));\n+      assertEquals(0, rs.getSourceMetrics().getSizeOfLogQueue());\n+      rs.enqueueLog(new Path(\"a.1\"));\n+      assertEquals(1, rs.getSourceMetrics().getSizeOfLogQueue());\n+    } finally {\n+      rs.terminate(\"Done\");\n+      rss.stop(\"Done\");\n+    }\n+  }\n+\n+  /**\n+   * Test that we filter out meta edits, etc.\n+   */\n+  @Test\n+  public void testWALEntryFilter() throws IOException {\n+    // To get the fully constructed default WALEntryFilter, need to create a ReplicationSource\n+    // instance and init it.\n+    ReplicationSource rs = new ReplicationSource();\n+    UUID uuid = UUID.randomUUID();\n+    Configuration conf = new Configuration(TEST_UTIL.getConfiguration());\n+    ReplicationPeer mockPeer = Mockito.mock(ReplicationPeer.class);\n+    Mockito.when(mockPeer.getConfiguration()).thenReturn(conf);\n+    Mockito.when(mockPeer.getPeerBandwidth()).thenReturn(0L);\n+    ReplicationPeerConfig peerConfig = Mockito.mock(ReplicationPeerConfig.class);\n+    Mockito.when(peerConfig.getReplicationEndpointImpl()).\n+      thenReturn(DoNothingReplicationEndpoint.class.getName());\n+    Mockito.when(mockPeer.getPeerConfig()).thenReturn(peerConfig);\n+    ReplicationSourceManager manager = Mockito.mock(ReplicationSourceManager.class);\n+    Mockito.when(manager.getTotalBufferUsed()).thenReturn(new AtomicLong());\n+    String queueId = \"qid\";\n+    RegionServerServices rss =\n+      TEST_UTIL.createMockRegionServerService(ServerName.parseServerName(\"a.b.c,1,1\"));\n+    rs.init(conf, null, manager, null, mockPeer, rss, queueId,\n+      uuid, p -> OptionalLong.empty(), new MetricsSource(queueId));\n+    try {\n+      rs.startup();\n+      TEST_UTIL.waitFor(30000, () -> rs.getWalEntryFilter() != null);\n+      WALEntryFilter wef = rs.getWalEntryFilter();\n+      // Test non-system WAL edit.\n+      WAL.Entry e = new WAL.Entry(new WALKeyImpl(HConstants.EMPTY_BYTE_ARRAY,\n+        TableName.valueOf(\"test\"), -1), new WALEdit());\n+      assertTrue(wef.filter(e) == e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bafff990e6a06aff532582ea39f618db67afbbdf"}, "originalPosition": 140}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc5NDU4MA==", "bodyText": "nit: redundant", "url": "https://github.com/apache/hbase/pull/2198#discussion_r465794580", "createdAt": "2020-08-05T15:03:51Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/replication/regionserver/TestReplicationSource.java", "diffHunk": "@@ -295,7 +356,40 @@ protected void stopServiceThreads() {\n     }\n   }\n \n-  // Test HBASE-20497\n+  /**\n+   * Deadend Endpoint. Does nothing.\n+   */\n+  public static class DoNothingReplicationEndpoint extends HBaseInterClusterReplicationEndpoint {\n+    private final UUID uuid = UUID.randomUUID();\n+\n+    @Override public void init(Context context) throws IOException {\n+      this.ctx = context;\n+      return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bafff990e6a06aff532582ea39f618db67afbbdf"}, "originalPosition": 316}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxOTAxMjcw", "url": "https://github.com/apache/hbase/pull/2198#pullrequestreview-461901270", "createdAt": "2020-08-05T18:03:01Z", "commit": {"oid": "bafff990e6a06aff532582ea39f618db67afbbdf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxODowMzowMVrOG8UwKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxODowMzowMVrOG8UwKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTkwNzc1Mg==", "bodyText": "Are we changing this config name also in this patch?", "url": "https://github.com/apache/hbase/pull/2198#discussion_r465907752", "createdAt": "2020-08-05T18:03:01Z", "author": {"login": "anoopsjohn"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -194,30 +232,34 @@ private void decorateConf() {\n   }\n \n   @Override\n-  public void enqueueLog(Path log) {\n-    String logPrefix = AbstractFSWALProvider.getWALPrefixFromWALName(log.getName());\n+  public void enqueueLog(Path wal) {\n+    if (!this.filterInWALs.test(wal)) {\n+      LOG.trace(\"NOT replicating {}\", wal);\n+      return;\n+    }\n+    String logPrefix = AbstractFSWALProvider.getWALPrefixFromWALName(wal.getName());\n     PriorityBlockingQueue<Path> queue = queues.get(logPrefix);\n     if (queue == null) {\n       queue = new PriorityBlockingQueue<>(queueSizePerGroup, new LogsComparator());\n       queues.put(logPrefix, queue);\n       if (this.isSourceActive() && this.walEntryFilter != null) {\n         // new wal group observed after source startup, start a new worker thread to track it\n-        // notice: it's possible that log enqueued when this.running is set but worker thread\n+        // notice: it's possible that wal enqueued when this.running is set but worker thread\n         // still not launched, so it's necessary to check workerThreads before start the worker\n         tryStartNewShipper(logPrefix, queue);\n       }\n     }\n-    queue.put(log);\n+    queue.put(wal);\n     if (LOG.isTraceEnabled()) {\n-      LOG.trace(\"{} Added log file {} to queue of source {}.\", logPeerId(), logPrefix,\n+      LOG.trace(\"{} Added wal {} to queue of source {}.\", logPeerId(), logPrefix,\n         this.replicationQueueInfo.getQueueId());\n     }\n     this.metrics.incrSizeOfLogQueue();\n-    // This will log a warning for each new log that gets created above the warn threshold\n+    // This will wal a warning for each new wal that gets created above the warn threshold\n     int queueSize = queue.size();\n     if (queueSize > this.logQueueWarnThreshold) {\n       LOG.warn(\"{} WAL group {} queue size: {} exceeds value of \"\n-          + \"replication.source.log.queue.warn: {}\", logPeerId(),\n+          + \"replication.source.wal.queue.warn: {}\", logPeerId(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bafff990e6a06aff532582ea39f618db67afbbdf"}, "originalPosition": 138}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b21753f604d33b30d36b1552e6364805580c4d40", "author": {"user": {"login": "saintstack", "name": "Michael Stack"}}, "url": "https://github.com/apache/hbase/commit/b21753f604d33b30d36b1552e6364805580c4d40", "committedDate": "2020-08-05T20:50:00Z", "message": "HBASE-24817 Allow configuring WALEntry filters on ReplicationSource\nAllow specifying base WALEntry filter on construction of\nReplicationSource. Add means of being able to filter WALs by name.\n\nhbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java\n Add constructor that allows passing a predicate for filtering *in* WALs\n and a list of filters for filtering *out* WALEntries. The latter was\n hardcoded to filter out system-table WALEntries. The former did not\n exist but we'll need it if Replication takes in more than just the\n default Provider."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bafff990e6a06aff532582ea39f618db67afbbdf", "author": {"user": {"login": "saintstack", "name": "Michael Stack"}}, "url": "https://github.com/apache/hbase/commit/bafff990e6a06aff532582ea39f618db67afbbdf", "committedDate": "2020-08-04T20:56:03Z", "message": "HBASE-24817 Allow configuring WALEntry filters on ReplicationSource\nAllow specifying base WALEntry filter on construction of\nReplicationSource. Add means of being able to filter WALs by name.\n\nhbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java\n Add constructor that allows passing a predicate for filtering *in* WALs\n and a list of filters for filtering *out* WALEntries. The latter was\n hardcoded to filter out system-table WALEntries. The former did not\n exist but we'll need it if Replication takes in more than just the\n default Provider."}, "afterCommit": {"oid": "b21753f604d33b30d36b1552e6364805580c4d40", "author": {"user": {"login": "saintstack", "name": "Michael Stack"}}, "url": "https://github.com/apache/hbase/commit/b21753f604d33b30d36b1552e6364805580c4d40", "committedDate": "2020-08-05T20:50:00Z", "message": "HBASE-24817 Allow configuring WALEntry filters on ReplicationSource\nAllow specifying base WALEntry filter on construction of\nReplicationSource. Add means of being able to filter WALs by name.\n\nhbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java\n Add constructor that allows passing a predicate for filtering *in* WALs\n and a list of filters for filtering *out* WALEntries. The latter was\n hardcoded to filter out system-table WALEntries. The former did not\n exist but we'll need it if Replication takes in more than just the\n default Provider."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMTcyNDYy", "url": "https://github.com/apache/hbase/pull/2198#pullrequestreview-462172462", "createdAt": "2020-08-06T04:05:05Z", "commit": {"oid": "b21753f604d33b30d36b1552e6364805580c4d40"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4168, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}