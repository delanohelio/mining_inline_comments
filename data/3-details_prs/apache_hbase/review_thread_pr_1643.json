{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMDk0NDI1", "number": 1643, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNzo1OToyN1rOD5GdBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMzowNDo0OFrOD5MlQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMjAxMTU4OnYy", "diffSide": "RIGHT", "path": "dev-support/create-release/README.txt", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNzo1OToyN1rOGQLsMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNzo1OToyN1rOGQLsMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYyMTkzNg==", "bodyText": "Good catch!", "url": "https://github.com/apache/hbase/pull/1643#discussion_r419621936", "createdAt": "2020-05-04T17:59:27Z", "author": {"login": "beettlle"}, "path": "dev-support/create-release/README.txt", "diffHunk": "@@ -37,13 +38,14 @@ $ sudo add-apt-repository -y \\\n $ sudo apt-get update\n $ sudo apt-get install -y docker-ce docker-ce-cli containerd.io\n $ sudo usermod -a -G docker $USERID\n-# LOGOUT and then LOGIN again so $USERID shows as part of docker groupl\n+# LOGOUT and then LOGIN again so $USERID shows as part of docker group", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMjk4OTU0OnYy", "diffSide": "RIGHT", "path": "dev-support/create-release/do-release-docker.sh", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMjo1Mzo0OFrOGQVD1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNTozMDoyMlrOGREhGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3NTQ0Ng==", "bodyText": "Highlight this? Add to the release note so RMs notice.", "url": "https://github.com/apache/hbase/pull/1643#discussion_r419775446", "createdAt": "2020-05-04T22:53:48Z", "author": {"login": "saintstack"}, "path": "dev-support/create-release/do-release-docker.sh", "diffHunk": "@@ -64,24 +65,26 @@ This script runs the release scripts inside a docker image.\n Options:\n \n   -d [path]    required. working directory. output will be written to \"output\" in here.\n-  -n           dry run mode. Checks and local builds, but does not upload anything.\n+  -f           \"force\" -- actually publish this release. Unless you specify '-f', it will\n+               default to dry run mode, which checks and does local builds, but does not upload anything.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwMjAwNA==", "bodyText": "Great idea, added a Release Note in the jira.", "url": "https://github.com/apache/hbase/pull/1643#discussion_r420502004", "createdAt": "2020-05-06T01:38:13Z", "author": {"login": "mattf-apache"}, "path": "dev-support/create-release/do-release-docker.sh", "diffHunk": "@@ -64,24 +65,26 @@ This script runs the release scripts inside a docker image.\n Options:\n \n   -d [path]    required. working directory. output will be written to \"output\" in here.\n-  -n           dry run mode. Checks and local builds, but does not upload anything.\n+  -f           \"force\" -- actually publish this release. Unless you specify '-f', it will\n+               default to dry run mode, which checks and does local builds, but does not upload anything.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3NTQ0Ng=="}, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU1Mjk4NQ==", "bodyText": "Good", "url": "https://github.com/apache/hbase/pull/1643#discussion_r420552985", "createdAt": "2020-05-06T05:30:22Z", "author": {"login": "saintstack"}, "path": "dev-support/create-release/do-release-docker.sh", "diffHunk": "@@ -64,24 +65,26 @@ This script runs the release scripts inside a docker image.\n Options:\n \n   -d [path]    required. working directory. output will be written to \"output\" in here.\n-  -n           dry run mode. Checks and local builds, but does not upload anything.\n+  -f           \"force\" -- actually publish this release. Unless you specify '-f', it will\n+               default to dry run mode, which checks and does local builds, but does not upload anything.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3NTQ0Ng=="}, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMjk5MTMzOnYy", "diffSide": "RIGHT", "path": "dev-support/create-release/do-release-docker.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMjo1NDoyOFrOGQVE0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMjo1NDoyOFrOGQVE0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3NTY5Ng==", "bodyText": "good", "url": "https://github.com/apache/hbase/pull/1643#discussion_r419775696", "createdAt": "2020-05-04T22:54:28Z", "author": {"login": "saintstack"}, "path": "dev-support/create-release/do-release-docker.sh", "diffHunk": "@@ -64,24 +65,26 @@ This script runs the release scripts inside a docker image.\n Options:\n \n   -d [path]    required. working directory. output will be written to \"output\" in here.\n-  -n           dry run mode. Checks and local builds, but does not upload anything.\n+  -f           \"force\" -- actually publish this release. Unless you specify '-f', it will\n+               default to dry run mode, which checks and does local builds, but does not upload anything.\n   -t [tag]     tag for the hbase-rm docker image to use for building (default: \"latest\").\n   -j [path]    path to local JDK installation to use building. By default the script will\n                use openjdk8 installed in the docker image.\n-  -p [project] project to build; default 'hbase'; alternatively, 'hbase-thirdparty', etc.\n-  -s [step]    runs a single step of the process; valid steps are: tag, build, publish. if\n-               none specified, runs tag, then build, and then publish.\n+  -p [project] project to build, such as 'hbase' or 'hbase-thirdparty'; defaults to $PROJECT env var\n+  -s [step]    runs a single step of the process; valid steps are: tag|publish-dist|publish-release.\n+               If none specified, runs tag, then publish-dist, and then publish-release.\n+               'publish-snapshot' is also an allowed, less used, option.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMzAwMDg1OnYy", "diffSide": "RIGHT", "path": "dev-support/create-release/do-release.sh", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMjo1ODozOVrOGQVKTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNTozMzoyOFrOGREj-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3NzEwMQ==", "bodyText": "I don't know where this comes from. The tag is immediate in my experience. A short wait and just move on would be nice future-to-have.", "url": "https://github.com/apache/hbase/pull/1643#discussion_r419777101", "createdAt": "2020-05-04T22:58:39Z", "author": {"login": "saintstack"}, "path": "dev-support/create-release/do-release.sh", "diffHunk": "@@ -66,26 +82,34 @@ function should_build {\n   fi\n }\n \n-if should_build \"tag\" && [ $SKIP_TAG = 0 ]; then\n+if should_build \"tag\" && [ \"$SKIP_TAG\" = 0 ]; then\n   run_silent \"Creating release tag $RELEASE_TAG...\" \"tag.log\" \\\n-    \"$SELF/release-tag.sh\"\n-  echo \"It may take some time for the tag to be synchronized to github.\"\n-  echo \"Press enter when you've verified that the new tag ($RELEASE_TAG) is available.\"\n-  read\n+    \"$SELF/release-build.sh\" tag\n+  if is_dry_run; then\n+    export TAG_SAME_DRY_RUN=\"true\";\n+  else\n+    echo \"It may take some time for the tag to be synchronized to github.\"\n+    echo \"Press enter when you've verified that the new tag ($RELEASE_TAG) is available.\"\n+    read -r\n+  fi", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwMzc1MA==", "bodyText": "Apparently it was in the original code swiped from the Spark project. I think it would be pretty easy to replace it with a little wait loop; I'll do that.", "url": "https://github.com/apache/hbase/pull/1643#discussion_r420503750", "createdAt": "2020-05-06T01:45:59Z", "author": {"login": "mattf-apache"}, "path": "dev-support/create-release/do-release.sh", "diffHunk": "@@ -66,26 +82,34 @@ function should_build {\n   fi\n }\n \n-if should_build \"tag\" && [ $SKIP_TAG = 0 ]; then\n+if should_build \"tag\" && [ \"$SKIP_TAG\" = 0 ]; then\n   run_silent \"Creating release tag $RELEASE_TAG...\" \"tag.log\" \\\n-    \"$SELF/release-tag.sh\"\n-  echo \"It may take some time for the tag to be synchronized to github.\"\n-  echo \"Press enter when you've verified that the new tag ($RELEASE_TAG) is available.\"\n-  read\n+    \"$SELF/release-build.sh\" tag\n+  if is_dry_run; then\n+    export TAG_SAME_DRY_RUN=\"true\";\n+  else\n+    echo \"It may take some time for the tag to be synchronized to github.\"\n+    echo \"Press enter when you've verified that the new tag ($RELEASE_TAG) is available.\"\n+    read -r\n+  fi", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3NzEwMQ=="}, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU1Mjk1NQ==", "bodyText": "No hurry. Nice-to-have. Can come later too.", "url": "https://github.com/apache/hbase/pull/1643#discussion_r420552955", "createdAt": "2020-05-06T05:30:12Z", "author": {"login": "saintstack"}, "path": "dev-support/create-release/do-release.sh", "diffHunk": "@@ -66,26 +82,34 @@ function should_build {\n   fi\n }\n \n-if should_build \"tag\" && [ $SKIP_TAG = 0 ]; then\n+if should_build \"tag\" && [ \"$SKIP_TAG\" = 0 ]; then\n   run_silent \"Creating release tag $RELEASE_TAG...\" \"tag.log\" \\\n-    \"$SELF/release-tag.sh\"\n-  echo \"It may take some time for the tag to be synchronized to github.\"\n-  echo \"Press enter when you've verified that the new tag ($RELEASE_TAG) is available.\"\n-  read\n+    \"$SELF/release-build.sh\" tag\n+  if is_dry_run; then\n+    export TAG_SAME_DRY_RUN=\"true\";\n+  else\n+    echo \"It may take some time for the tag to be synchronized to github.\"\n+    echo \"Press enter when you've verified that the new tag ($RELEASE_TAG) is available.\"\n+    read -r\n+  fi", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3NzEwMQ=="}, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU1MzcyMA==", "bodyText": "Done.  See commit db4bab6 just added.\nIt waits in 30-second increments up to 5 minutes.", "url": "https://github.com/apache/hbase/pull/1643#discussion_r420553720", "createdAt": "2020-05-06T05:33:28Z", "author": {"login": "mattf-apache"}, "path": "dev-support/create-release/do-release.sh", "diffHunk": "@@ -66,26 +82,34 @@ function should_build {\n   fi\n }\n \n-if should_build \"tag\" && [ $SKIP_TAG = 0 ]; then\n+if should_build \"tag\" && [ \"$SKIP_TAG\" = 0 ]; then\n   run_silent \"Creating release tag $RELEASE_TAG...\" \"tag.log\" \\\n-    \"$SELF/release-tag.sh\"\n-  echo \"It may take some time for the tag to be synchronized to github.\"\n-  echo \"Press enter when you've verified that the new tag ($RELEASE_TAG) is available.\"\n-  read\n+    \"$SELF/release-build.sh\" tag\n+  if is_dry_run; then\n+    export TAG_SAME_DRY_RUN=\"true\";\n+  else\n+    echo \"It may take some time for the tag to be synchronized to github.\"\n+    echo \"Press enter when you've verified that the new tag ($RELEASE_TAG) is available.\"\n+    read -r\n+  fi", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3NzEwMQ=="}, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMzAwMjg1OnYy", "diffSide": "RIGHT", "path": "dev-support/create-release/do-release.sh", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMjo1OTozMFrOGQVLfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNToyOTo0NlrOGREghA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3NzQwNg==", "bodyText": "publish-dist is new step? If so, put that in release note too... as change.", "url": "https://github.com/apache/hbase/pull/1643#discussion_r419777406", "createdAt": "2020-05-04T22:59:30Z", "author": {"login": "saintstack"}, "path": "dev-support/create-release/do-release.sh", "diffHunk": "@@ -66,26 +82,34 @@ function should_build {\n   fi\n }\n \n-if should_build \"tag\" && [ $SKIP_TAG = 0 ]; then\n+if should_build \"tag\" && [ \"$SKIP_TAG\" = 0 ]; then\n   run_silent \"Creating release tag $RELEASE_TAG...\" \"tag.log\" \\\n-    \"$SELF/release-tag.sh\"\n-  echo \"It may take some time for the tag to be synchronized to github.\"\n-  echo \"Press enter when you've verified that the new tag ($RELEASE_TAG) is available.\"\n-  read\n+    \"$SELF/release-build.sh\" tag\n+  if is_dry_run; then\n+    export TAG_SAME_DRY_RUN=\"true\";\n+  else\n+    echo \"It may take some time for the tag to be synchronized to github.\"\n+    echo \"Press enter when you've verified that the new tag ($RELEASE_TAG) is available.\"\n+    read -r\n+  fi\n else\n   echo \"Skipping tag creation for $RELEASE_TAG.\"\n fi\n \n-if should_build \"build\"; then\n-  run_silent \"Building ${PROJECT}...\" \"build.log\" \\\n-    \"$SELF/release-build.sh\" build\n+if should_build \"publish-dist\"; then\n+  run_silent \"Publishing distribution packages (tarballs)\" \"publish-dist.log\" \\\n+    \"$SELF/release-build.sh\" publish-dist\n else\n-  echo \"Skipping build step.\"\n+  echo \"Skipping publish-dist step.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwMjQxOQ==", "bodyText": "Done, in Release Note in jira (along with the reason why).", "url": "https://github.com/apache/hbase/pull/1643#discussion_r420502419", "createdAt": "2020-05-06T01:39:56Z", "author": {"login": "mattf-apache"}, "path": "dev-support/create-release/do-release.sh", "diffHunk": "@@ -66,26 +82,34 @@ function should_build {\n   fi\n }\n \n-if should_build \"tag\" && [ $SKIP_TAG = 0 ]; then\n+if should_build \"tag\" && [ \"$SKIP_TAG\" = 0 ]; then\n   run_silent \"Creating release tag $RELEASE_TAG...\" \"tag.log\" \\\n-    \"$SELF/release-tag.sh\"\n-  echo \"It may take some time for the tag to be synchronized to github.\"\n-  echo \"Press enter when you've verified that the new tag ($RELEASE_TAG) is available.\"\n-  read\n+    \"$SELF/release-build.sh\" tag\n+  if is_dry_run; then\n+    export TAG_SAME_DRY_RUN=\"true\";\n+  else\n+    echo \"It may take some time for the tag to be synchronized to github.\"\n+    echo \"Press enter when you've verified that the new tag ($RELEASE_TAG) is available.\"\n+    read -r\n+  fi\n else\n   echo \"Skipping tag creation for $RELEASE_TAG.\"\n fi\n \n-if should_build \"build\"; then\n-  run_silent \"Building ${PROJECT}...\" \"build.log\" \\\n-    \"$SELF/release-build.sh\" build\n+if should_build \"publish-dist\"; then\n+  run_silent \"Publishing distribution packages (tarballs)\" \"publish-dist.log\" \\\n+    \"$SELF/release-build.sh\" publish-dist\n else\n-  echo \"Skipping build step.\"\n+  echo \"Skipping publish-dist step.\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3NzQwNg=="}, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU1MjgzNg==", "bodyText": "Good.", "url": "https://github.com/apache/hbase/pull/1643#discussion_r420552836", "createdAt": "2020-05-06T05:29:46Z", "author": {"login": "saintstack"}, "path": "dev-support/create-release/do-release.sh", "diffHunk": "@@ -66,26 +82,34 @@ function should_build {\n   fi\n }\n \n-if should_build \"tag\" && [ $SKIP_TAG = 0 ]; then\n+if should_build \"tag\" && [ \"$SKIP_TAG\" = 0 ]; then\n   run_silent \"Creating release tag $RELEASE_TAG...\" \"tag.log\" \\\n-    \"$SELF/release-tag.sh\"\n-  echo \"It may take some time for the tag to be synchronized to github.\"\n-  echo \"Press enter when you've verified that the new tag ($RELEASE_TAG) is available.\"\n-  read\n+    \"$SELF/release-build.sh\" tag\n+  if is_dry_run; then\n+    export TAG_SAME_DRY_RUN=\"true\";\n+  else\n+    echo \"It may take some time for the tag to be synchronized to github.\"\n+    echo \"Press enter when you've verified that the new tag ($RELEASE_TAG) is available.\"\n+    read -r\n+  fi\n else\n   echo \"Skipping tag creation for $RELEASE_TAG.\"\n fi\n \n-if should_build \"build\"; then\n-  run_silent \"Building ${PROJECT}...\" \"build.log\" \\\n-    \"$SELF/release-build.sh\" build\n+if should_build \"publish-dist\"; then\n+  run_silent \"Publishing distribution packages (tarballs)\" \"publish-dist.log\" \\\n+    \"$SELF/release-build.sh\" publish-dist\n else\n-  echo \"Skipping build step.\"\n+  echo \"Skipping publish-dist step.\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3NzQwNg=="}, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMzAwODY5OnYy", "diffSide": "RIGHT", "path": "dev-support/create-release/release-build.sh", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMzowMTozOVrOGQVOww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNToyOTozNlrOGREgUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3ODI0Mw==", "bodyText": "Is this what I do when I want to run a release candidate? Release candidate goes into staging repo first.", "url": "https://github.com/apache/hbase/pull/1643#discussion_r419778243", "createdAt": "2020-05-04T23:01:39Z", "author": {"login": "saintstack"}, "path": "dev-support/create-release/release-build.sh", "diffHunk": "@@ -20,114 +20,180 @@\n trap cleanup EXIT\n \n # Source in utils.\n-SELF=$(cd $(dirname $0) && pwd)\n+SELF=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\n+# shellcheck source=SCRIPTDIR/release-util.sh\n . \"$SELF/release-util.sh\"\n \n # Print usage and exit.\n function exit_with_usage {\n-  cat << EOF\n-Usage: release-build.sh <build|publish-snapshot|publish-release>\n-Creates build deliverables from a tag/commit.\n-Arguments:\n- build             Create binary packages and commit to dist.apache.org/repos/dist/dev/hbase/\n- publish-snapshot  Publish snapshot release to Apache snapshots\n- publish-release   Publish a release to Apache release repo\n-\n-All other inputs are environment variables:\n- GIT_REF - Release tag or commit to build from\n- PACKAGE_VERSION - Release identifier in top level package directory (e.g. 2.1.2RC1)\n- VERSION - (optional) Version of project being built (e.g. 2.1.2)\n- ASF_USERNAME - Username of ASF committer account\n- ASF_PASSWORD - Password of ASF committer account\n- GPG_KEY - GPG key used to sign release artifacts\n- GPG_PASSPHRASE - Passphrase for GPG key\n- PROJECT - The project to build. No default.\n-\n-Set REPO environment to full path to repo to use\n-to avoid re-downloading dependencies on each run.\n+  cat <<'EOF'\n+Usage: release-build.sh <tag|publish-dist|publish-snapshot|publish-release>\n+Creates release deliverables from a tag or commit.\n+Argument: one of 'tag', 'publish-dist', 'publish-snapshot', or 'publish-release'\n+  tag               Prepares for release on specified git branch: Set release version,\n+                    update CHANGES and RELEASENOTES, create release tag,\n+                    increment version for ongoing dev, and publish to Apache git repo.\n+  publish-dist      Build and publish distribution packages (tarballs) to Apache dist repo\n+  publish-snapshot  Build and publish maven artifacts snapshot release to Apache snapshots repo\n+  publish-release   Build and publish maven artifacts release to Apache release repo, and", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUwODk1OQ==", "bodyText": "What one should do to run a release candidate, is invoke do-release-docker.sh (preferably) or do-release.sh (if there's a reason not to use docker).  I agree with your comments here and in the next item below, that this script must clearly be documented as NOT the entrance script.  And yet, the many env variables that get passed around as inter-script communication do need to be documented somewhere.  Let me see if I can move them to do-release.sh, and make the comments and the README more useful.\nOn a completely unrelated note, you mention, as a question,\n\nRelease candidate goes into staging repo first.\n\nThat's correct, for non-snapshot releases/release candidates.  The business with staging repo in Nexus is part of the publish-release step. I did not change its basic logic, which is now in release-util.sh::maven_deploy():\n\nUse mvn to set the version in pom.xml\nDo mvn deploy to Nexus, using -P apache-release,release profiles, which use the maven-release-plugin, nexus-staging-maven-plugin, and configs from the HBase top-level pom and root ASF pom, to manage Nexus deployment.\nAfterward (back to release-build.sh, at the end of publish-release step), the code expects to find that the Staging Repo has been closed (made immutable), and returns the repo ID to the user. Note that for snapshot releases, the Staging Repo intermediate appears not to be used.", "url": "https://github.com/apache/hbase/pull/1643#discussion_r420508959", "createdAt": "2020-05-06T02:09:11Z", "author": {"login": "mattf-apache"}, "path": "dev-support/create-release/release-build.sh", "diffHunk": "@@ -20,114 +20,180 @@\n trap cleanup EXIT\n \n # Source in utils.\n-SELF=$(cd $(dirname $0) && pwd)\n+SELF=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\n+# shellcheck source=SCRIPTDIR/release-util.sh\n . \"$SELF/release-util.sh\"\n \n # Print usage and exit.\n function exit_with_usage {\n-  cat << EOF\n-Usage: release-build.sh <build|publish-snapshot|publish-release>\n-Creates build deliverables from a tag/commit.\n-Arguments:\n- build             Create binary packages and commit to dist.apache.org/repos/dist/dev/hbase/\n- publish-snapshot  Publish snapshot release to Apache snapshots\n- publish-release   Publish a release to Apache release repo\n-\n-All other inputs are environment variables:\n- GIT_REF - Release tag or commit to build from\n- PACKAGE_VERSION - Release identifier in top level package directory (e.g. 2.1.2RC1)\n- VERSION - (optional) Version of project being built (e.g. 2.1.2)\n- ASF_USERNAME - Username of ASF committer account\n- ASF_PASSWORD - Password of ASF committer account\n- GPG_KEY - GPG key used to sign release artifacts\n- GPG_PASSPHRASE - Passphrase for GPG key\n- PROJECT - The project to build. No default.\n-\n-Set REPO environment to full path to repo to use\n-to avoid re-downloading dependencies on each run.\n+  cat <<'EOF'\n+Usage: release-build.sh <tag|publish-dist|publish-snapshot|publish-release>\n+Creates release deliverables from a tag or commit.\n+Argument: one of 'tag', 'publish-dist', 'publish-snapshot', or 'publish-release'\n+  tag               Prepares for release on specified git branch: Set release version,\n+                    update CHANGES and RELEASENOTES, create release tag,\n+                    increment version for ongoing dev, and publish to Apache git repo.\n+  publish-dist      Build and publish distribution packages (tarballs) to Apache dist repo\n+  publish-snapshot  Build and publish maven artifacts snapshot release to Apache snapshots repo\n+  publish-release   Build and publish maven artifacts release to Apache release repo, and", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3ODI0Mw=="}, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU1Mjc4Ng==", "bodyText": "k. This sounds like it works as it used to which sort of basically worked.", "url": "https://github.com/apache/hbase/pull/1643#discussion_r420552786", "createdAt": "2020-05-06T05:29:36Z", "author": {"login": "saintstack"}, "path": "dev-support/create-release/release-build.sh", "diffHunk": "@@ -20,114 +20,180 @@\n trap cleanup EXIT\n \n # Source in utils.\n-SELF=$(cd $(dirname $0) && pwd)\n+SELF=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\n+# shellcheck source=SCRIPTDIR/release-util.sh\n . \"$SELF/release-util.sh\"\n \n # Print usage and exit.\n function exit_with_usage {\n-  cat << EOF\n-Usage: release-build.sh <build|publish-snapshot|publish-release>\n-Creates build deliverables from a tag/commit.\n-Arguments:\n- build             Create binary packages and commit to dist.apache.org/repos/dist/dev/hbase/\n- publish-snapshot  Publish snapshot release to Apache snapshots\n- publish-release   Publish a release to Apache release repo\n-\n-All other inputs are environment variables:\n- GIT_REF - Release tag or commit to build from\n- PACKAGE_VERSION - Release identifier in top level package directory (e.g. 2.1.2RC1)\n- VERSION - (optional) Version of project being built (e.g. 2.1.2)\n- ASF_USERNAME - Username of ASF committer account\n- ASF_PASSWORD - Password of ASF committer account\n- GPG_KEY - GPG key used to sign release artifacts\n- GPG_PASSPHRASE - Passphrase for GPG key\n- PROJECT - The project to build. No default.\n-\n-Set REPO environment to full path to repo to use\n-to avoid re-downloading dependencies on each run.\n+  cat <<'EOF'\n+Usage: release-build.sh <tag|publish-dist|publish-snapshot|publish-release>\n+Creates release deliverables from a tag or commit.\n+Argument: one of 'tag', 'publish-dist', 'publish-snapshot', or 'publish-release'\n+  tag               Prepares for release on specified git branch: Set release version,\n+                    update CHANGES and RELEASENOTES, create release tag,\n+                    increment version for ongoing dev, and publish to Apache git repo.\n+  publish-dist      Build and publish distribution packages (tarballs) to Apache dist repo\n+  publish-snapshot  Build and publish maven artifacts snapshot release to Apache snapshots repo\n+  publish-release   Build and publish maven artifacts release to Apache release repo, and", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3ODI0Mw=="}, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMzAxMTM1OnYy", "diffSide": "RIGHT", "path": "dev-support/create-release/release-build.sh", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMzowMjo1M1rOGQVQcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNTozNjowMVrOGREmog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3ODY3Mg==", "bodyText": "Do you think we need an entrance script or a rename of the one of these scripts as main.sh or some such. As is, operator has to consult the README. I suppose this ok given how specialized this all is.", "url": "https://github.com/apache/hbase/pull/1643#discussion_r419778672", "createdAt": "2020-05-04T23:02:53Z", "author": {"login": "saintstack"}, "path": "dev-support/create-release/release-build.sh", "diffHunk": "@@ -20,114 +20,180 @@\n trap cleanup EXIT\n \n # Source in utils.\n-SELF=$(cd $(dirname $0) && pwd)\n+SELF=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\n+# shellcheck source=SCRIPTDIR/release-util.sh\n . \"$SELF/release-util.sh\"\n \n # Print usage and exit.\n function exit_with_usage {\n-  cat << EOF\n-Usage: release-build.sh <build|publish-snapshot|publish-release>\n-Creates build deliverables from a tag/commit.\n-Arguments:\n- build             Create binary packages and commit to dist.apache.org/repos/dist/dev/hbase/\n- publish-snapshot  Publish snapshot release to Apache snapshots\n- publish-release   Publish a release to Apache release repo\n-\n-All other inputs are environment variables:\n- GIT_REF - Release tag or commit to build from\n- PACKAGE_VERSION - Release identifier in top level package directory (e.g. 2.1.2RC1)\n- VERSION - (optional) Version of project being built (e.g. 2.1.2)\n- ASF_USERNAME - Username of ASF committer account\n- ASF_PASSWORD - Password of ASF committer account\n- GPG_KEY - GPG key used to sign release artifacts\n- GPG_PASSPHRASE - Passphrase for GPG key\n- PROJECT - The project to build. No default.\n-\n-Set REPO environment to full path to repo to use\n-to avoid re-downloading dependencies on each run.\n+  cat <<'EOF'\n+Usage: release-build.sh <tag|publish-dist|publish-snapshot|publish-release>\n+Creates release deliverables from a tag or commit.\n+Argument: one of 'tag', 'publish-dist', 'publish-snapshot', or 'publish-release'\n+  tag               Prepares for release on specified git branch: Set release version,\n+                    update CHANGES and RELEASENOTES, create release tag,\n+                    increment version for ongoing dev, and publish to Apache git repo.\n+  publish-dist      Build and publish distribution packages (tarballs) to Apache dist repo\n+  publish-snapshot  Build and publish maven artifacts snapshot release to Apache snapshots repo\n+  publish-release   Build and publish maven artifacts release to Apache release repo, and\n+                    construct vote email from template\n+\n+All other inputs are environment variables.  Please use do-release-docker.sh or\n+do-release.sh to set up the needed environment variables.  This script, release-build.sh,\n+is not intended to be called stand-alone, and such use is untested.  The env variables used are:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyMDk1Ng==", "bodyText": "I was letting it go due to how specialized it is, but you're right; there's no reason not to make it nice and clear.  Will try to improve this; see comment immediately above.", "url": "https://github.com/apache/hbase/pull/1643#discussion_r420520956", "createdAt": "2020-05-06T03:02:36Z", "author": {"login": "mattf-apache"}, "path": "dev-support/create-release/release-build.sh", "diffHunk": "@@ -20,114 +20,180 @@\n trap cleanup EXIT\n \n # Source in utils.\n-SELF=$(cd $(dirname $0) && pwd)\n+SELF=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\n+# shellcheck source=SCRIPTDIR/release-util.sh\n . \"$SELF/release-util.sh\"\n \n # Print usage and exit.\n function exit_with_usage {\n-  cat << EOF\n-Usage: release-build.sh <build|publish-snapshot|publish-release>\n-Creates build deliverables from a tag/commit.\n-Arguments:\n- build             Create binary packages and commit to dist.apache.org/repos/dist/dev/hbase/\n- publish-snapshot  Publish snapshot release to Apache snapshots\n- publish-release   Publish a release to Apache release repo\n-\n-All other inputs are environment variables:\n- GIT_REF - Release tag or commit to build from\n- PACKAGE_VERSION - Release identifier in top level package directory (e.g. 2.1.2RC1)\n- VERSION - (optional) Version of project being built (e.g. 2.1.2)\n- ASF_USERNAME - Username of ASF committer account\n- ASF_PASSWORD - Password of ASF committer account\n- GPG_KEY - GPG key used to sign release artifacts\n- GPG_PASSPHRASE - Passphrase for GPG key\n- PROJECT - The project to build. No default.\n-\n-Set REPO environment to full path to repo to use\n-to avoid re-downloading dependencies on each run.\n+  cat <<'EOF'\n+Usage: release-build.sh <tag|publish-dist|publish-snapshot|publish-release>\n+Creates release deliverables from a tag or commit.\n+Argument: one of 'tag', 'publish-dist', 'publish-snapshot', or 'publish-release'\n+  tag               Prepares for release on specified git branch: Set release version,\n+                    update CHANGES and RELEASENOTES, create release tag,\n+                    increment version for ongoing dev, and publish to Apache git repo.\n+  publish-dist      Build and publish distribution packages (tarballs) to Apache dist repo\n+  publish-snapshot  Build and publish maven artifacts snapshot release to Apache snapshots repo\n+  publish-release   Build and publish maven artifacts release to Apache release repo, and\n+                    construct vote email from template\n+\n+All other inputs are environment variables.  Please use do-release-docker.sh or\n+do-release.sh to set up the needed environment variables.  This script, release-build.sh,\n+is not intended to be called stand-alone, and such use is untested.  The env variables used are:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3ODY3Mg=="}, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU1MjQwNg==", "bodyText": "Sweet", "url": "https://github.com/apache/hbase/pull/1643#discussion_r420552406", "createdAt": "2020-05-06T05:28:14Z", "author": {"login": "saintstack"}, "path": "dev-support/create-release/release-build.sh", "diffHunk": "@@ -20,114 +20,180 @@\n trap cleanup EXIT\n \n # Source in utils.\n-SELF=$(cd $(dirname $0) && pwd)\n+SELF=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\n+# shellcheck source=SCRIPTDIR/release-util.sh\n . \"$SELF/release-util.sh\"\n \n # Print usage and exit.\n function exit_with_usage {\n-  cat << EOF\n-Usage: release-build.sh <build|publish-snapshot|publish-release>\n-Creates build deliverables from a tag/commit.\n-Arguments:\n- build             Create binary packages and commit to dist.apache.org/repos/dist/dev/hbase/\n- publish-snapshot  Publish snapshot release to Apache snapshots\n- publish-release   Publish a release to Apache release repo\n-\n-All other inputs are environment variables:\n- GIT_REF - Release tag or commit to build from\n- PACKAGE_VERSION - Release identifier in top level package directory (e.g. 2.1.2RC1)\n- VERSION - (optional) Version of project being built (e.g. 2.1.2)\n- ASF_USERNAME - Username of ASF committer account\n- ASF_PASSWORD - Password of ASF committer account\n- GPG_KEY - GPG key used to sign release artifacts\n- GPG_PASSPHRASE - Passphrase for GPG key\n- PROJECT - The project to build. No default.\n-\n-Set REPO environment to full path to repo to use\n-to avoid re-downloading dependencies on each run.\n+  cat <<'EOF'\n+Usage: release-build.sh <tag|publish-dist|publish-snapshot|publish-release>\n+Creates release deliverables from a tag or commit.\n+Argument: one of 'tag', 'publish-dist', 'publish-snapshot', or 'publish-release'\n+  tag               Prepares for release on specified git branch: Set release version,\n+                    update CHANGES and RELEASENOTES, create release tag,\n+                    increment version for ongoing dev, and publish to Apache git repo.\n+  publish-dist      Build and publish distribution packages (tarballs) to Apache dist repo\n+  publish-snapshot  Build and publish maven artifacts snapshot release to Apache snapshots repo\n+  publish-release   Build and publish maven artifacts release to Apache release repo, and\n+                    construct vote email from template\n+\n+All other inputs are environment variables.  Please use do-release-docker.sh or\n+do-release.sh to set up the needed environment variables.  This script, release-build.sh,\n+is not intended to be called stand-alone, and such use is untested.  The env variables used are:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3ODY3Mg=="}, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU1NDQwMg==", "bodyText": "Getting late, will tackle this in the morning.", "url": "https://github.com/apache/hbase/pull/1643#discussion_r420554402", "createdAt": "2020-05-06T05:36:01Z", "author": {"login": "mattf-apache"}, "path": "dev-support/create-release/release-build.sh", "diffHunk": "@@ -20,114 +20,180 @@\n trap cleanup EXIT\n \n # Source in utils.\n-SELF=$(cd $(dirname $0) && pwd)\n+SELF=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\n+# shellcheck source=SCRIPTDIR/release-util.sh\n . \"$SELF/release-util.sh\"\n \n # Print usage and exit.\n function exit_with_usage {\n-  cat << EOF\n-Usage: release-build.sh <build|publish-snapshot|publish-release>\n-Creates build deliverables from a tag/commit.\n-Arguments:\n- build             Create binary packages and commit to dist.apache.org/repos/dist/dev/hbase/\n- publish-snapshot  Publish snapshot release to Apache snapshots\n- publish-release   Publish a release to Apache release repo\n-\n-All other inputs are environment variables:\n- GIT_REF - Release tag or commit to build from\n- PACKAGE_VERSION - Release identifier in top level package directory (e.g. 2.1.2RC1)\n- VERSION - (optional) Version of project being built (e.g. 2.1.2)\n- ASF_USERNAME - Username of ASF committer account\n- ASF_PASSWORD - Password of ASF committer account\n- GPG_KEY - GPG key used to sign release artifacts\n- GPG_PASSPHRASE - Passphrase for GPG key\n- PROJECT - The project to build. No default.\n-\n-Set REPO environment to full path to repo to use\n-to avoid re-downloading dependencies on each run.\n+  cat <<'EOF'\n+Usage: release-build.sh <tag|publish-dist|publish-snapshot|publish-release>\n+Creates release deliverables from a tag or commit.\n+Argument: one of 'tag', 'publish-dist', 'publish-snapshot', or 'publish-release'\n+  tag               Prepares for release on specified git branch: Set release version,\n+                    update CHANGES and RELEASENOTES, create release tag,\n+                    increment version for ongoing dev, and publish to Apache git repo.\n+  publish-dist      Build and publish distribution packages (tarballs) to Apache dist repo\n+  publish-snapshot  Build and publish maven artifacts snapshot release to Apache snapshots repo\n+  publish-release   Build and publish maven artifacts release to Apache release repo, and\n+                    construct vote email from template\n+\n+All other inputs are environment variables.  Please use do-release-docker.sh or\n+do-release.sh to set up the needed environment variables.  This script, release-build.sh,\n+is not intended to be called stand-alone, and such use is untested.  The env variables used are:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3ODY3Mg=="}, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMzAxMjc1OnYy", "diffSide": "RIGHT", "path": "dev-support/create-release/release-build.sh", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMzowMzozMFrOGQVRPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMzowMzozMFrOGQVRPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3ODg3OA==", "bodyText": "Good doc.", "url": "https://github.com/apache/hbase/pull/1643#discussion_r419778878", "createdAt": "2020-05-04T23:03:30Z", "author": {"login": "saintstack"}, "path": "dev-support/create-release/release-build.sh", "diffHunk": "@@ -20,114 +20,180 @@\n trap cleanup EXIT\n \n # Source in utils.\n-SELF=$(cd $(dirname $0) && pwd)\n+SELF=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\n+# shellcheck source=SCRIPTDIR/release-util.sh\n . \"$SELF/release-util.sh\"\n \n # Print usage and exit.\n function exit_with_usage {\n-  cat << EOF\n-Usage: release-build.sh <build|publish-snapshot|publish-release>\n-Creates build deliverables from a tag/commit.\n-Arguments:\n- build             Create binary packages and commit to dist.apache.org/repos/dist/dev/hbase/\n- publish-snapshot  Publish snapshot release to Apache snapshots\n- publish-release   Publish a release to Apache release repo\n-\n-All other inputs are environment variables:\n- GIT_REF - Release tag or commit to build from\n- PACKAGE_VERSION - Release identifier in top level package directory (e.g. 2.1.2RC1)\n- VERSION - (optional) Version of project being built (e.g. 2.1.2)\n- ASF_USERNAME - Username of ASF committer account\n- ASF_PASSWORD - Password of ASF committer account\n- GPG_KEY - GPG key used to sign release artifacts\n- GPG_PASSPHRASE - Passphrase for GPG key\n- PROJECT - The project to build. No default.\n-\n-Set REPO environment to full path to repo to use\n-to avoid re-downloading dependencies on each run.\n+  cat <<'EOF'\n+Usage: release-build.sh <tag|publish-dist|publish-snapshot|publish-release>\n+Creates release deliverables from a tag or commit.\n+Argument: one of 'tag', 'publish-dist', 'publish-snapshot', or 'publish-release'\n+  tag               Prepares for release on specified git branch: Set release version,\n+                    update CHANGES and RELEASENOTES, create release tag,\n+                    increment version for ongoing dev, and publish to Apache git repo.\n+  publish-dist      Build and publish distribution packages (tarballs) to Apache dist repo\n+  publish-snapshot  Build and publish maven artifacts snapshot release to Apache snapshots repo\n+  publish-release   Build and publish maven artifacts release to Apache release repo, and\n+                    construct vote email from template\n+\n+All other inputs are environment variables.  Please use do-release-docker.sh or\n+do-release.sh to set up the needed environment variables.  This script, release-build.sh,\n+is not intended to be called stand-alone, and such use is untested.  The env variables used are:\n+\n+Used for 'tag' and 'publish' stages:\n+  PROJECT - The project to build. No default.\n+  RELEASE_VERSION - Version used in pom files for release (e.g. 2.1.2)\n+    Required for 'tag'; defaults for 'publish' to the version in pom at GIT_REF\n+  RELEASE_TAG - Name of release tag (e.g. 2.1.2RC0), also used by\n+    publish-dist as package version name in dist directory path\n+  ASF_USERNAME - Username of ASF committer account\n+  ASF_PASSWORD - Password of ASF committer account\n+  DRY_RUN - 1:true (default), 0:false. If \"1\", does almost all the work, but doesn't actually\n+    publish anything to upstream source or object repositories. It defaults to \"1\", so if you want\n+    to actually publish you have to set '-f' (force) flag in do-release.sh or do-release-docker.sh.\n+\n+Used only for 'tag':\n+  GIT_NAME - Name to use with git\n+  GIT_EMAIL - E-mail address to use with git\n+  GIT_BRANCH - Git branch on which to make release. Tag is always placed at HEAD of this branch.\n+  NEXT_VERSION - Development version after release (e.g. 2.1.3-SNAPSHOT)\n+\n+Used only for 'publish':\n+  GIT_REF - Release tag or commit to build from (defaults to $RELEASE_TAG; only need to\n+    separately define GIT_REF if RELEASE_TAG is not actually present as a tag at publish time)\n+    If both RELEASE_TAG and GIT_REF are undefined it will default to HEAD of master.\n+  GPG_KEY - GPG key id (usually email addr) used to sign release artifacts\n+  GPG_PASSPHRASE - Passphrase for GPG key\n+  REPO - Set to full path of a directory to use as maven local repo (dependencies cache)\n+    to avoid re-downloading dependencies for each stage.  It is automatically set if you\n+    request full sequence of stages (tag, publish-dist, publish-release) in do-release.sh.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxMzAxNTY4OnYy", "diffSide": "RIGHT", "path": "dev-support/create-release/release-build.sh", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMzowNDo0OFrOGQVS7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNToyNzo1MFrOGREedg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3OTMwOQ==", "bodyText": "Release or release candidate?", "url": "https://github.com/apache/hbase/pull/1643#discussion_r419779309", "createdAt": "2020-05-04T23:04:48Z", "author": {"login": "saintstack"}, "path": "dev-support/create-release/release-build.sh", "diffHunk": "@@ -20,114 +20,180 @@\n trap cleanup EXIT\n \n # Source in utils.\n-SELF=$(cd $(dirname $0) && pwd)\n+SELF=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\n+# shellcheck source=SCRIPTDIR/release-util.sh\n . \"$SELF/release-util.sh\"\n \n # Print usage and exit.\n function exit_with_usage {\n-  cat << EOF\n-Usage: release-build.sh <build|publish-snapshot|publish-release>\n-Creates build deliverables from a tag/commit.\n-Arguments:\n- build             Create binary packages and commit to dist.apache.org/repos/dist/dev/hbase/\n- publish-snapshot  Publish snapshot release to Apache snapshots\n- publish-release   Publish a release to Apache release repo\n-\n-All other inputs are environment variables:\n- GIT_REF - Release tag or commit to build from\n- PACKAGE_VERSION - Release identifier in top level package directory (e.g. 2.1.2RC1)\n- VERSION - (optional) Version of project being built (e.g. 2.1.2)\n- ASF_USERNAME - Username of ASF committer account\n- ASF_PASSWORD - Password of ASF committer account\n- GPG_KEY - GPG key used to sign release artifacts\n- GPG_PASSPHRASE - Passphrase for GPG key\n- PROJECT - The project to build. No default.\n-\n-Set REPO environment to full path to repo to use\n-to avoid re-downloading dependencies on each run.\n+  cat <<'EOF'\n+Usage: release-build.sh <tag|publish-dist|publish-snapshot|publish-release>\n+Creates release deliverables from a tag or commit.\n+Argument: one of 'tag', 'publish-dist', 'publish-snapshot', or 'publish-release'\n+  tag               Prepares for release on specified git branch: Set release version,\n+                    update CHANGES and RELEASENOTES, create release tag,\n+                    increment version for ongoing dev, and publish to Apache git repo.\n+  publish-dist      Build and publish distribution packages (tarballs) to Apache dist repo\n+  publish-snapshot  Build and publish maven artifacts snapshot release to Apache snapshots repo\n+  publish-release   Build and publish maven artifacts release to Apache release repo, and\n+                    construct vote email from template\n+\n+All other inputs are environment variables.  Please use do-release-docker.sh or\n+do-release.sh to set up the needed environment variables.  This script, release-build.sh,\n+is not intended to be called stand-alone, and such use is untested.  The env variables used are:\n+\n+Used for 'tag' and 'publish' stages:\n+  PROJECT - The project to build. No default.\n+  RELEASE_VERSION - Version used in pom files for release (e.g. 2.1.2)\n+    Required for 'tag'; defaults for 'publish' to the version in pom at GIT_REF\n+  RELEASE_TAG - Name of release tag (e.g. 2.1.2RC0), also used by\n+    publish-dist as package version name in dist directory path\n+  ASF_USERNAME - Username of ASF committer account\n+  ASF_PASSWORD - Password of ASF committer account\n+  DRY_RUN - 1:true (default), 0:false. If \"1\", does almost all the work, but doesn't actually\n+    publish anything to upstream source or object repositories. It defaults to \"1\", so if you want\n+    to actually publish you have to set '-f' (force) flag in do-release.sh or do-release-docker.sh.\n+\n+Used only for 'tag':\n+  GIT_NAME - Name to use with git\n+  GIT_EMAIL - E-mail address to use with git\n+  GIT_BRANCH - Git branch on which to make release. Tag is always placed at HEAD of this branch.\n+  NEXT_VERSION - Development version after release (e.g. 2.1.3-SNAPSHOT)\n+\n+Used only for 'publish':\n+  GIT_REF - Release tag or commit to build from (defaults to $RELEASE_TAG; only need to\n+    separately define GIT_REF if RELEASE_TAG is not actually present as a tag at publish time)\n+    If both RELEASE_TAG and GIT_REF are undefined it will default to HEAD of master.\n+  GPG_KEY - GPG key id (usually email addr) used to sign release artifacts\n+  GPG_PASSPHRASE - Passphrase for GPG key\n+  REPO - Set to full path of a directory to use as maven local repo (dependencies cache)\n+    to avoid re-downloading dependencies for each stage.  It is automatically set if you\n+    request full sequence of stages (tag, publish-dist, publish-release) in do-release.sh.\n \n For example:\n- $ PROJECT=\"hbase-operator-tools\" ASF_USERNAME=NAME ASF_PASSWORD=PASSWORD GPG_PASSPHRASE=PASSWORD GPG_KEY=stack@apache.org ./release-build.sh build\n+ $ PROJECT=\"hbase-operator-tools\" ASF_USERNAME=NAME ASF_PASSWORD=PASSWORD GPG_PASSPHRASE=PASSWORD GPG_KEY=stack@apache.org ./release-build.sh publish-dist\n EOF\n   exit 1\n }\n \n set -e\n \n function cleanup {\n-  echo \"Cleaning up temp settings file.\" >&2\n-  rm \"${tmp_settings}\" &> /dev/null || true\n   # If REPO was set, then leave things be. Otherwise if we defined a repo clean it out.\n-  if [[ -z \"${REPO}\" ]] && [[ -n \"${tmp_repo}\" ]]; then\n-    echo \"Cleaning up temp repo in '${tmp_repo}'. set REPO to reuse downloads.\" >&2\n-    rm -rf \"${tmp_repo}\" &> /dev/null || true\n+  if [[ -z \"${REPO}\" ]] && [[ -n \"${MAVEN_LOCAL_REPO}\" ]]; then\n+    echo \"Cleaning up temp repo in '${MAVEN_LOCAL_REPO}'. Set REPO to reuse downloads.\" >&2\n+    rm -f \"${MAVEN_SETTINGS_FILE}\" &> /dev/null || true\n+    rm -rf \"${MAVEN_LOCAL_REPO}\" &> /dev/null || true\n   fi\n }\n \n-if [ $# -eq 0 ]; then\n+if [ $# -ne 1 ]; then\n   exit_with_usage\n fi\n \n-if [[ $@ == *\"help\"* ]]; then\n+if [[ \"$*\" == *\"help\"* ]]; then\n   exit_with_usage\n fi\n \n-# Read in the ASF password.\n-if [[ -z \"$ASF_PASSWORD\" ]]; then\n-  echo 'The environment variable ASF_PASSWORD is not set. Enter the password.'\n-  echo\n-  stty -echo && printf \"ASF password: \" && read ASF_PASSWORD && printf '\\n' && stty echo\n-fi\n+init_locale\n+init_java\n+init_mvn\n+init_python\n+# Print out subset of perl version (used in git hooks)\n+perl --version | grep 'This is'\n \n-# Read in the GPG passphrase\n-if [[ -z \"$GPG_PASSPHRASE\" ]]; then\n-  echo 'The environment variable GPG_PASSPHRASE is not set. Enter the passphrase to'\n-  echo 'unlock the GPG signing key that will be used to sign the release!'\n-  echo\n-  stty -echo && printf \"GPG passphrase: \" && read GPG_PASSPHRASE && printf '\\n' && stty echo\n-  export GPG_PASSPHRASE\n-  export GPG_TTY=$(tty)\n-fi\n+rm -rf \"${PROJECT}\"\n+\n+if [[ \"$1\" == \"tag\" ]]; then\n+  # for 'tag' stage\n+  set -o pipefail\n+  set -x  # detailed logging during action\n+  check_get_passwords ASF_PASSWORD\n+  check_needed_vars PROJECT ASF_USERNAME ASF_PASSWORD RELEASE_VERSION RELEASE_TAG NEXT_VERSION \\\n+      GIT_EMAIL GIT_NAME GIT_BRANCH\n+  ASF_REPO=\"gitbox.apache.org/repos/asf/${PROJECT}.git\"\n+  encoded_username=\"$(python -c \"import urllib; print urllib.quote('''$ASF_USERNAME''')\")\"\n+  encoded_password=\"$(python -c \"import urllib; print urllib.quote('''$ASF_PASSWORD''')\")\"\n+  git clone \"https://$encoded_username:$encoded_password@$ASF_REPO\" -b \"$GIT_BRANCH\" \"${PROJECT}\"\n+\n+  # 'update_releasenotes' searches the project's Jira for issues where 'Fix Version' matches specified\n+  # $jira_fix_version. For most projects this is same as ${RELEASE_VERSION}. However, all the 'hbase-*'\n+  # projects share the same HBASE jira name.  To make this work, by convention, the HBASE jira \"Fix Version\"\n+  # field values have the sub-project name pre-pended, as in \"hbase-operator-tools-1.0.0\".\n+  # So, here we prepend the project name to the version, but only for the hbase sub-projects.\n+  jira_fix_version=\"${RELEASE_VERSION}\"\n+  shopt -s nocasematch\n+  if [[ \"${PROJECT}\" =~ ^hbase- ]]; then\n+    jira_fix_version=\"${PROJECT}-${RELEASE_VERSION}\"\n+  fi\n+  shopt -u nocasematch\n+  update_releasenotes \"$(pwd)/${PROJECT}\" \"${jira_fix_version}\"\n+\n+  cd \"${PROJECT}\"\n+\n+  git config user.name \"$GIT_NAME\"\n+  git config user.email \"$GIT_EMAIL\"\n \n-for env in ASF_USERNAME GPG_PASSPHRASE GPG_KEY; do\n-  if [ -z \"${!env}\" ]; then\n-    echo \"ERROR: $env must be set to run this script\"\n-    exit_with_usage\n+  # Create release version", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 166}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDUyNjE2NA==", "bodyText": "This line of comment comes from the original code from what was formerly release-tag.sh. Basically, it sets the maven version in pom.xml for the release or release candidate you are making. It just uses the version string you've specified in do-release.sh, which is usually a release candidate version, but it's up to you.", "url": "https://github.com/apache/hbase/pull/1643#discussion_r420526164", "createdAt": "2020-05-06T03:28:25Z", "author": {"login": "mattf-apache"}, "path": "dev-support/create-release/release-build.sh", "diffHunk": "@@ -20,114 +20,180 @@\n trap cleanup EXIT\n \n # Source in utils.\n-SELF=$(cd $(dirname $0) && pwd)\n+SELF=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\n+# shellcheck source=SCRIPTDIR/release-util.sh\n . \"$SELF/release-util.sh\"\n \n # Print usage and exit.\n function exit_with_usage {\n-  cat << EOF\n-Usage: release-build.sh <build|publish-snapshot|publish-release>\n-Creates build deliverables from a tag/commit.\n-Arguments:\n- build             Create binary packages and commit to dist.apache.org/repos/dist/dev/hbase/\n- publish-snapshot  Publish snapshot release to Apache snapshots\n- publish-release   Publish a release to Apache release repo\n-\n-All other inputs are environment variables:\n- GIT_REF - Release tag or commit to build from\n- PACKAGE_VERSION - Release identifier in top level package directory (e.g. 2.1.2RC1)\n- VERSION - (optional) Version of project being built (e.g. 2.1.2)\n- ASF_USERNAME - Username of ASF committer account\n- ASF_PASSWORD - Password of ASF committer account\n- GPG_KEY - GPG key used to sign release artifacts\n- GPG_PASSPHRASE - Passphrase for GPG key\n- PROJECT - The project to build. No default.\n-\n-Set REPO environment to full path to repo to use\n-to avoid re-downloading dependencies on each run.\n+  cat <<'EOF'\n+Usage: release-build.sh <tag|publish-dist|publish-snapshot|publish-release>\n+Creates release deliverables from a tag or commit.\n+Argument: one of 'tag', 'publish-dist', 'publish-snapshot', or 'publish-release'\n+  tag               Prepares for release on specified git branch: Set release version,\n+                    update CHANGES and RELEASENOTES, create release tag,\n+                    increment version for ongoing dev, and publish to Apache git repo.\n+  publish-dist      Build and publish distribution packages (tarballs) to Apache dist repo\n+  publish-snapshot  Build and publish maven artifacts snapshot release to Apache snapshots repo\n+  publish-release   Build and publish maven artifacts release to Apache release repo, and\n+                    construct vote email from template\n+\n+All other inputs are environment variables.  Please use do-release-docker.sh or\n+do-release.sh to set up the needed environment variables.  This script, release-build.sh,\n+is not intended to be called stand-alone, and such use is untested.  The env variables used are:\n+\n+Used for 'tag' and 'publish' stages:\n+  PROJECT - The project to build. No default.\n+  RELEASE_VERSION - Version used in pom files for release (e.g. 2.1.2)\n+    Required for 'tag'; defaults for 'publish' to the version in pom at GIT_REF\n+  RELEASE_TAG - Name of release tag (e.g. 2.1.2RC0), also used by\n+    publish-dist as package version name in dist directory path\n+  ASF_USERNAME - Username of ASF committer account\n+  ASF_PASSWORD - Password of ASF committer account\n+  DRY_RUN - 1:true (default), 0:false. If \"1\", does almost all the work, but doesn't actually\n+    publish anything to upstream source or object repositories. It defaults to \"1\", so if you want\n+    to actually publish you have to set '-f' (force) flag in do-release.sh or do-release-docker.sh.\n+\n+Used only for 'tag':\n+  GIT_NAME - Name to use with git\n+  GIT_EMAIL - E-mail address to use with git\n+  GIT_BRANCH - Git branch on which to make release. Tag is always placed at HEAD of this branch.\n+  NEXT_VERSION - Development version after release (e.g. 2.1.3-SNAPSHOT)\n+\n+Used only for 'publish':\n+  GIT_REF - Release tag or commit to build from (defaults to $RELEASE_TAG; only need to\n+    separately define GIT_REF if RELEASE_TAG is not actually present as a tag at publish time)\n+    If both RELEASE_TAG and GIT_REF are undefined it will default to HEAD of master.\n+  GPG_KEY - GPG key id (usually email addr) used to sign release artifacts\n+  GPG_PASSPHRASE - Passphrase for GPG key\n+  REPO - Set to full path of a directory to use as maven local repo (dependencies cache)\n+    to avoid re-downloading dependencies for each stage.  It is automatically set if you\n+    request full sequence of stages (tag, publish-dist, publish-release) in do-release.sh.\n \n For example:\n- $ PROJECT=\"hbase-operator-tools\" ASF_USERNAME=NAME ASF_PASSWORD=PASSWORD GPG_PASSPHRASE=PASSWORD GPG_KEY=stack@apache.org ./release-build.sh build\n+ $ PROJECT=\"hbase-operator-tools\" ASF_USERNAME=NAME ASF_PASSWORD=PASSWORD GPG_PASSPHRASE=PASSWORD GPG_KEY=stack@apache.org ./release-build.sh publish-dist\n EOF\n   exit 1\n }\n \n set -e\n \n function cleanup {\n-  echo \"Cleaning up temp settings file.\" >&2\n-  rm \"${tmp_settings}\" &> /dev/null || true\n   # If REPO was set, then leave things be. Otherwise if we defined a repo clean it out.\n-  if [[ -z \"${REPO}\" ]] && [[ -n \"${tmp_repo}\" ]]; then\n-    echo \"Cleaning up temp repo in '${tmp_repo}'. set REPO to reuse downloads.\" >&2\n-    rm -rf \"${tmp_repo}\" &> /dev/null || true\n+  if [[ -z \"${REPO}\" ]] && [[ -n \"${MAVEN_LOCAL_REPO}\" ]]; then\n+    echo \"Cleaning up temp repo in '${MAVEN_LOCAL_REPO}'. Set REPO to reuse downloads.\" >&2\n+    rm -f \"${MAVEN_SETTINGS_FILE}\" &> /dev/null || true\n+    rm -rf \"${MAVEN_LOCAL_REPO}\" &> /dev/null || true\n   fi\n }\n \n-if [ $# -eq 0 ]; then\n+if [ $# -ne 1 ]; then\n   exit_with_usage\n fi\n \n-if [[ $@ == *\"help\"* ]]; then\n+if [[ \"$*\" == *\"help\"* ]]; then\n   exit_with_usage\n fi\n \n-# Read in the ASF password.\n-if [[ -z \"$ASF_PASSWORD\" ]]; then\n-  echo 'The environment variable ASF_PASSWORD is not set. Enter the password.'\n-  echo\n-  stty -echo && printf \"ASF password: \" && read ASF_PASSWORD && printf '\\n' && stty echo\n-fi\n+init_locale\n+init_java\n+init_mvn\n+init_python\n+# Print out subset of perl version (used in git hooks)\n+perl --version | grep 'This is'\n \n-# Read in the GPG passphrase\n-if [[ -z \"$GPG_PASSPHRASE\" ]]; then\n-  echo 'The environment variable GPG_PASSPHRASE is not set. Enter the passphrase to'\n-  echo 'unlock the GPG signing key that will be used to sign the release!'\n-  echo\n-  stty -echo && printf \"GPG passphrase: \" && read GPG_PASSPHRASE && printf '\\n' && stty echo\n-  export GPG_PASSPHRASE\n-  export GPG_TTY=$(tty)\n-fi\n+rm -rf \"${PROJECT}\"\n+\n+if [[ \"$1\" == \"tag\" ]]; then\n+  # for 'tag' stage\n+  set -o pipefail\n+  set -x  # detailed logging during action\n+  check_get_passwords ASF_PASSWORD\n+  check_needed_vars PROJECT ASF_USERNAME ASF_PASSWORD RELEASE_VERSION RELEASE_TAG NEXT_VERSION \\\n+      GIT_EMAIL GIT_NAME GIT_BRANCH\n+  ASF_REPO=\"gitbox.apache.org/repos/asf/${PROJECT}.git\"\n+  encoded_username=\"$(python -c \"import urllib; print urllib.quote('''$ASF_USERNAME''')\")\"\n+  encoded_password=\"$(python -c \"import urllib; print urllib.quote('''$ASF_PASSWORD''')\")\"\n+  git clone \"https://$encoded_username:$encoded_password@$ASF_REPO\" -b \"$GIT_BRANCH\" \"${PROJECT}\"\n+\n+  # 'update_releasenotes' searches the project's Jira for issues where 'Fix Version' matches specified\n+  # $jira_fix_version. For most projects this is same as ${RELEASE_VERSION}. However, all the 'hbase-*'\n+  # projects share the same HBASE jira name.  To make this work, by convention, the HBASE jira \"Fix Version\"\n+  # field values have the sub-project name pre-pended, as in \"hbase-operator-tools-1.0.0\".\n+  # So, here we prepend the project name to the version, but only for the hbase sub-projects.\n+  jira_fix_version=\"${RELEASE_VERSION}\"\n+  shopt -s nocasematch\n+  if [[ \"${PROJECT}\" =~ ^hbase- ]]; then\n+    jira_fix_version=\"${PROJECT}-${RELEASE_VERSION}\"\n+  fi\n+  shopt -u nocasematch\n+  update_releasenotes \"$(pwd)/${PROJECT}\" \"${jira_fix_version}\"\n+\n+  cd \"${PROJECT}\"\n+\n+  git config user.name \"$GIT_NAME\"\n+  git config user.email \"$GIT_EMAIL\"\n \n-for env in ASF_USERNAME GPG_PASSPHRASE GPG_KEY; do\n-  if [ -z \"${!env}\" ]; then\n-    echo \"ERROR: $env must be set to run this script\"\n-    exit_with_usage\n+  # Create release version", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3OTMwOQ=="}, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 166}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU1MjMxMA==", "bodyText": "k", "url": "https://github.com/apache/hbase/pull/1643#discussion_r420552310", "createdAt": "2020-05-06T05:27:50Z", "author": {"login": "saintstack"}, "path": "dev-support/create-release/release-build.sh", "diffHunk": "@@ -20,114 +20,180 @@\n trap cleanup EXIT\n \n # Source in utils.\n-SELF=$(cd $(dirname $0) && pwd)\n+SELF=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\n+# shellcheck source=SCRIPTDIR/release-util.sh\n . \"$SELF/release-util.sh\"\n \n # Print usage and exit.\n function exit_with_usage {\n-  cat << EOF\n-Usage: release-build.sh <build|publish-snapshot|publish-release>\n-Creates build deliverables from a tag/commit.\n-Arguments:\n- build             Create binary packages and commit to dist.apache.org/repos/dist/dev/hbase/\n- publish-snapshot  Publish snapshot release to Apache snapshots\n- publish-release   Publish a release to Apache release repo\n-\n-All other inputs are environment variables:\n- GIT_REF - Release tag or commit to build from\n- PACKAGE_VERSION - Release identifier in top level package directory (e.g. 2.1.2RC1)\n- VERSION - (optional) Version of project being built (e.g. 2.1.2)\n- ASF_USERNAME - Username of ASF committer account\n- ASF_PASSWORD - Password of ASF committer account\n- GPG_KEY - GPG key used to sign release artifacts\n- GPG_PASSPHRASE - Passphrase for GPG key\n- PROJECT - The project to build. No default.\n-\n-Set REPO environment to full path to repo to use\n-to avoid re-downloading dependencies on each run.\n+  cat <<'EOF'\n+Usage: release-build.sh <tag|publish-dist|publish-snapshot|publish-release>\n+Creates release deliverables from a tag or commit.\n+Argument: one of 'tag', 'publish-dist', 'publish-snapshot', or 'publish-release'\n+  tag               Prepares for release on specified git branch: Set release version,\n+                    update CHANGES and RELEASENOTES, create release tag,\n+                    increment version for ongoing dev, and publish to Apache git repo.\n+  publish-dist      Build and publish distribution packages (tarballs) to Apache dist repo\n+  publish-snapshot  Build and publish maven artifacts snapshot release to Apache snapshots repo\n+  publish-release   Build and publish maven artifacts release to Apache release repo, and\n+                    construct vote email from template\n+\n+All other inputs are environment variables.  Please use do-release-docker.sh or\n+do-release.sh to set up the needed environment variables.  This script, release-build.sh,\n+is not intended to be called stand-alone, and such use is untested.  The env variables used are:\n+\n+Used for 'tag' and 'publish' stages:\n+  PROJECT - The project to build. No default.\n+  RELEASE_VERSION - Version used in pom files for release (e.g. 2.1.2)\n+    Required for 'tag'; defaults for 'publish' to the version in pom at GIT_REF\n+  RELEASE_TAG - Name of release tag (e.g. 2.1.2RC0), also used by\n+    publish-dist as package version name in dist directory path\n+  ASF_USERNAME - Username of ASF committer account\n+  ASF_PASSWORD - Password of ASF committer account\n+  DRY_RUN - 1:true (default), 0:false. If \"1\", does almost all the work, but doesn't actually\n+    publish anything to upstream source or object repositories. It defaults to \"1\", so if you want\n+    to actually publish you have to set '-f' (force) flag in do-release.sh or do-release-docker.sh.\n+\n+Used only for 'tag':\n+  GIT_NAME - Name to use with git\n+  GIT_EMAIL - E-mail address to use with git\n+  GIT_BRANCH - Git branch on which to make release. Tag is always placed at HEAD of this branch.\n+  NEXT_VERSION - Development version after release (e.g. 2.1.3-SNAPSHOT)\n+\n+Used only for 'publish':\n+  GIT_REF - Release tag or commit to build from (defaults to $RELEASE_TAG; only need to\n+    separately define GIT_REF if RELEASE_TAG is not actually present as a tag at publish time)\n+    If both RELEASE_TAG and GIT_REF are undefined it will default to HEAD of master.\n+  GPG_KEY - GPG key id (usually email addr) used to sign release artifacts\n+  GPG_PASSPHRASE - Passphrase for GPG key\n+  REPO - Set to full path of a directory to use as maven local repo (dependencies cache)\n+    to avoid re-downloading dependencies for each stage.  It is automatically set if you\n+    request full sequence of stages (tag, publish-dist, publish-release) in do-release.sh.\n \n For example:\n- $ PROJECT=\"hbase-operator-tools\" ASF_USERNAME=NAME ASF_PASSWORD=PASSWORD GPG_PASSPHRASE=PASSWORD GPG_KEY=stack@apache.org ./release-build.sh build\n+ $ PROJECT=\"hbase-operator-tools\" ASF_USERNAME=NAME ASF_PASSWORD=PASSWORD GPG_PASSPHRASE=PASSWORD GPG_KEY=stack@apache.org ./release-build.sh publish-dist\n EOF\n   exit 1\n }\n \n set -e\n \n function cleanup {\n-  echo \"Cleaning up temp settings file.\" >&2\n-  rm \"${tmp_settings}\" &> /dev/null || true\n   # If REPO was set, then leave things be. Otherwise if we defined a repo clean it out.\n-  if [[ -z \"${REPO}\" ]] && [[ -n \"${tmp_repo}\" ]]; then\n-    echo \"Cleaning up temp repo in '${tmp_repo}'. set REPO to reuse downloads.\" >&2\n-    rm -rf \"${tmp_repo}\" &> /dev/null || true\n+  if [[ -z \"${REPO}\" ]] && [[ -n \"${MAVEN_LOCAL_REPO}\" ]]; then\n+    echo \"Cleaning up temp repo in '${MAVEN_LOCAL_REPO}'. Set REPO to reuse downloads.\" >&2\n+    rm -f \"${MAVEN_SETTINGS_FILE}\" &> /dev/null || true\n+    rm -rf \"${MAVEN_LOCAL_REPO}\" &> /dev/null || true\n   fi\n }\n \n-if [ $# -eq 0 ]; then\n+if [ $# -ne 1 ]; then\n   exit_with_usage\n fi\n \n-if [[ $@ == *\"help\"* ]]; then\n+if [[ \"$*\" == *\"help\"* ]]; then\n   exit_with_usage\n fi\n \n-# Read in the ASF password.\n-if [[ -z \"$ASF_PASSWORD\" ]]; then\n-  echo 'The environment variable ASF_PASSWORD is not set. Enter the password.'\n-  echo\n-  stty -echo && printf \"ASF password: \" && read ASF_PASSWORD && printf '\\n' && stty echo\n-fi\n+init_locale\n+init_java\n+init_mvn\n+init_python\n+# Print out subset of perl version (used in git hooks)\n+perl --version | grep 'This is'\n \n-# Read in the GPG passphrase\n-if [[ -z \"$GPG_PASSPHRASE\" ]]; then\n-  echo 'The environment variable GPG_PASSPHRASE is not set. Enter the passphrase to'\n-  echo 'unlock the GPG signing key that will be used to sign the release!'\n-  echo\n-  stty -echo && printf \"GPG passphrase: \" && read GPG_PASSPHRASE && printf '\\n' && stty echo\n-  export GPG_PASSPHRASE\n-  export GPG_TTY=$(tty)\n-fi\n+rm -rf \"${PROJECT}\"\n+\n+if [[ \"$1\" == \"tag\" ]]; then\n+  # for 'tag' stage\n+  set -o pipefail\n+  set -x  # detailed logging during action\n+  check_get_passwords ASF_PASSWORD\n+  check_needed_vars PROJECT ASF_USERNAME ASF_PASSWORD RELEASE_VERSION RELEASE_TAG NEXT_VERSION \\\n+      GIT_EMAIL GIT_NAME GIT_BRANCH\n+  ASF_REPO=\"gitbox.apache.org/repos/asf/${PROJECT}.git\"\n+  encoded_username=\"$(python -c \"import urllib; print urllib.quote('''$ASF_USERNAME''')\")\"\n+  encoded_password=\"$(python -c \"import urllib; print urllib.quote('''$ASF_PASSWORD''')\")\"\n+  git clone \"https://$encoded_username:$encoded_password@$ASF_REPO\" -b \"$GIT_BRANCH\" \"${PROJECT}\"\n+\n+  # 'update_releasenotes' searches the project's Jira for issues where 'Fix Version' matches specified\n+  # $jira_fix_version. For most projects this is same as ${RELEASE_VERSION}. However, all the 'hbase-*'\n+  # projects share the same HBASE jira name.  To make this work, by convention, the HBASE jira \"Fix Version\"\n+  # field values have the sub-project name pre-pended, as in \"hbase-operator-tools-1.0.0\".\n+  # So, here we prepend the project name to the version, but only for the hbase sub-projects.\n+  jira_fix_version=\"${RELEASE_VERSION}\"\n+  shopt -s nocasematch\n+  if [[ \"${PROJECT}\" =~ ^hbase- ]]; then\n+    jira_fix_version=\"${PROJECT}-${RELEASE_VERSION}\"\n+  fi\n+  shopt -u nocasematch\n+  update_releasenotes \"$(pwd)/${PROJECT}\" \"${jira_fix_version}\"\n+\n+  cd \"${PROJECT}\"\n+\n+  git config user.name \"$GIT_NAME\"\n+  git config user.email \"$GIT_EMAIL\"\n \n-for env in ASF_USERNAME GPG_PASSPHRASE GPG_KEY; do\n-  if [ -z \"${!env}\" ]; then\n-    echo \"ERROR: $env must be set to run this script\"\n-    exit_with_usage\n+  # Create release version", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc3OTMwOQ=="}, "originalCommit": {"oid": "0ed5931ff23cd5e097ace40c8f83545d83865eee"}, "originalPosition": 166}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1741, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}