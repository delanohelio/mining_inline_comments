{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4OTI0MDI2", "number": 1292, "title": "HBASE-23994:Add WebUI to Canary", "bodyText": "", "createdAt": "2020-03-16T01:56:24Z", "url": "https://github.com/apache/hbase/pull/1292", "merged": true, "mergeCommit": {"oid": "daf79de329c49e2ea9fc6e01bd0995a8a75dd9a9"}, "closed": true, "closedAt": "2020-04-14T22:52:23Z", "author": {"login": "GeorryHuang"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOELAkAH2gAyMzg4OTI0MDI2OjJlMWNmNmEyMzg1YjZkMzliMjQzYWVlOTc3NjRkOWVhZTQ0NmVlYTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXWRYNAFqTM5MjQ3MTI3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2e1cf6a2385b6d39b243aee97764d9eae446eea6", "author": {"user": {"login": "GeorryHuang", "name": null}}, "url": "https://github.com/apache/hbase/commit/2e1cf6a2385b6d39b243aee97764d9eae446eea6", "committedDate": "2020-03-16T01:52:40Z", "message": "HBASE-23994:Add WebUI to Canary"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNjczMDc2", "url": "https://github.com/apache/hbase/pull/1292#pullrequestreview-381673076", "createdAt": "2020-03-26T03:03:59Z", "commit": {"oid": "2e1cf6a2385b6d39b243aee97764d9eae446eea6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwMzowNDowMFrOF71yqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQwMzowNzowNlrOF711UA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI5MTYyNQ==", "bodyText": "Avoid using e.printStackTrace directly?", "url": "https://github.com/apache/hbase/pull/1292#discussion_r398291625", "createdAt": "2020-03-26T03:04:00Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/tool/CanaryTool.java", "diffHunk": "@@ -123,6 +127,31 @@\n @InterfaceAudience.LimitedPrivate(HBaseInterfaceAudience.TOOLS)\n public class CanaryTool implements Tool, Canary {\n \n+\n+  private void putUpWebUI() throws IOException {\n+    if (zookeeperMode) {\n+      LOG.info(\"WebUI is not supported in Zookeeper mode\");\n+    } else if (regionServerMode) {\n+      LOG.info(\"WebUI is not supported in RegionServer mode\");\n+    } else {\n+      Configuration conf = new Configuration();\n+      int port = conf.getInt(HConstants.HBASE_CANARY_INFO_PORT, DEFAULT_CANARY_INFOPORT);\n+      // -1 is for disabling info server\n+      if (port < 0) return;\n+      String addr = conf.get(HBASE_CANARY_INFO_BINDADDRESS, \"0.0.0.0\");\n+      try {\n+        InfoServer infoServer = new InfoServer(\"canary\", addr, port, false, conf);\n+        infoServer.addUnprivilegedServlet(\"canary\", \"/canary-status\", CanaryStatusServlet.class);\n+        infoServer.setAttribute(\"sink\", this.sink);\n+        infoServer.start();\n+        LOG.info(\"Bind Canary http info server to port: \" + port);\n+      } catch (BindException e) {\n+        e.printStackTrace();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e1cf6a2385b6d39b243aee97764d9eae446eea6"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI5MTg1OA==", "bodyText": "Declare as ConcurrentMap?", "url": "https://github.com/apache/hbase/pull/1292#discussion_r398291858", "createdAt": "2020-03-26T03:05:04Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/tool/CanaryTool.java", "diffHunk": "@@ -274,16 +303,50 @@ public void publishReadTiming(String znode, String server, long msTime) {\n     private Map<String, LongAdder> perTableReadLatency = new HashMap<>();\n     private LongAdder writeLatency = new LongAdder();\n     private final Map<String, List<RegionTaskResult>> regionMap = new ConcurrentHashMap<>();\n+    private Map<ServerName, LongAdder> perServerFailuresCount = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e1cf6a2385b6d39b243aee97764d9eae446eea6"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODI5MjMwNA==", "bodyText": "Is it possible to not add these configurations in HConstants? Just put them in the CanaryTool class?", "url": "https://github.com/apache/hbase/pull/1292#discussion_r398292304", "createdAt": "2020-03-26T03:07:06Z", "author": {"login": "Apache9"}, "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java", "diffHunk": "@@ -1464,6 +1464,12 @@\n \n   public static final String HBASE_CANARY_READ_RAW_SCAN_KEY = \"hbase.canary.read.raw.enabled\";\n \n+  public static final String HBASE_CANARY_INFO_PORT = \"hbase.canary.info.port\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e1cf6a2385b6d39b243aee97764d9eae446eea6"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1688474d17619c6b9146bb8025189cc148d7d89", "author": {"user": {"login": "GeorryHuang", "name": null}}, "url": "https://github.com/apache/hbase/commit/b1688474d17619c6b9146bb8025189cc148d7d89", "committedDate": "2020-03-31T01:55:51Z", "message": "HBASE-23994:Add WebUI to Canary(Modify code)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "717fb3f54106cabd1d2ef7d5374aca1d10e65bec", "author": {"user": {"login": "GeorryHuang", "name": null}}, "url": "https://github.com/apache/hbase/commit/717fb3f54106cabd1d2ef7d5374aca1d10e65bec", "committedDate": "2020-04-09T13:30:46Z", "message": "HBASE-23994:Add WebUI to Canary(Map to ConcurrentMap)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fc29b879fb0b789cbbd2ef948550dce3f46e957b", "author": {"user": {"login": "GeorryHuang", "name": null}}, "url": "https://github.com/apache/hbase/commit/fc29b879fb0b789cbbd2ef948550dce3f46e957b", "committedDate": "2020-04-09T13:10:30Z", "message": "HBASE-23994:Add WebUI to Canary(Map to ConcurrentMap)"}, "afterCommit": {"oid": "717fb3f54106cabd1d2ef7d5374aca1d10e65bec", "author": {"user": {"login": "GeorryHuang", "name": null}}, "url": "https://github.com/apache/hbase/commit/717fb3f54106cabd1d2ef7d5374aca1d10e65bec", "committedDate": "2020-04-09T13:30:46Z", "message": "HBASE-23994:Add WebUI to Canary(Map to ConcurrentMap)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwODE0MTMw", "url": "https://github.com/apache/hbase/pull/1292#pullrequestreview-390814130", "createdAt": "2020-04-09T13:54:47Z", "commit": {"oid": "717fb3f54106cabd1d2ef7d5374aca1d10e65bec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwOTg3OTE1", "url": "https://github.com/apache/hbase/pull/1292#pullrequestreview-390987915", "createdAt": "2020-04-09T17:23:57Z", "commit": {"oid": "717fb3f54106cabd1d2ef7d5374aca1d10e65bec"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNzoyMzo1OFrOGDiNSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNzoyNzoyNlrOGDiVTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM1OTM3MQ==", "bodyText": "nit: could skip these warnings (and the whole function body) when HBASE_CANARY_INFO_PORT == -1", "url": "https://github.com/apache/hbase/pull/1292#discussion_r406359371", "createdAt": "2020-04-09T17:23:58Z", "author": {"login": "ndimiduk"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/tool/CanaryTool.java", "diffHunk": "@@ -122,6 +125,35 @@\n  */\n @InterfaceAudience.LimitedPrivate(HBaseInterfaceAudience.TOOLS)\n public class CanaryTool implements Tool, Canary {\n+  public static final String HBASE_CANARY_INFO_PORT = \"hbase.canary.info.port\";\n+\n+  public static final int DEFAULT_CANARY_INFOPORT = 16050;\n+\n+  public static final String HBASE_CANARY_INFO_BINDADDRESS = \"hbase.canary.info.bindAddress\";\n+\n+\n+  private void putUpWebUI() throws IOException {\n+    if (zookeeperMode) {\n+      LOG.info(\"WebUI is not supported in Zookeeper mode\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717fb3f54106cabd1d2ef7d5374aca1d10e65bec"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM2MDIzMQ==", "bodyText": "What happens when sink == null when running without assertions? A nasty NPE? Would be better to handle null properly.", "url": "https://github.com/apache/hbase/pull/1292#discussion_r406360231", "createdAt": "2020-04-09T17:25:22Z", "author": {"login": "ndimiduk"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/tool/CanaryStatusServlet.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/**\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.tool;\n+\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.tmpl.tool.CanaryStatusTmpl;\n+import org.apache.yetus.audience.InterfaceAudience;\n+\n+import javax.servlet.ServletException;\n+import javax.servlet.http.HttpServlet;\n+import javax.servlet.http.HttpServletRequest;\n+import javax.servlet.http.HttpServletResponse;\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.concurrent.atomic.LongAdder;\n+\n+@InterfaceAudience.Private\n+public class CanaryStatusServlet extends HttpServlet {\n+  @Override\n+  protected void doGet(HttpServletRequest req, HttpServletResponse resp)\n+    throws ServletException, IOException {\n+    CanaryTool.RegionStdOutSink sink =\n+      (CanaryTool.RegionStdOutSink) getServletContext().getAttribute(\n+        \"sink\");\n+    assert sink != null : \"No tool in context!\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717fb3f54106cabd1d2ef7d5374aca1d10e65bec"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM2MDY5Nw==", "bodyText": "Might as well print out the full socket address (bind address:port)", "url": "https://github.com/apache/hbase/pull/1292#discussion_r406360697", "createdAt": "2020-04-09T17:26:09Z", "author": {"login": "ndimiduk"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/tool/CanaryTool.java", "diffHunk": "@@ -122,6 +125,35 @@\n  */\n @InterfaceAudience.LimitedPrivate(HBaseInterfaceAudience.TOOLS)\n public class CanaryTool implements Tool, Canary {\n+  public static final String HBASE_CANARY_INFO_PORT = \"hbase.canary.info.port\";\n+\n+  public static final int DEFAULT_CANARY_INFOPORT = 16050;\n+\n+  public static final String HBASE_CANARY_INFO_BINDADDRESS = \"hbase.canary.info.bindAddress\";\n+\n+\n+  private void putUpWebUI() throws IOException {\n+    if (zookeeperMode) {\n+      LOG.info(\"WebUI is not supported in Zookeeper mode\");\n+    } else if (regionServerMode) {\n+      LOG.info(\"WebUI is not supported in RegionServer mode\");\n+    } else {\n+      Configuration conf = new Configuration();\n+      int port = conf.getInt(HBASE_CANARY_INFO_PORT, DEFAULT_CANARY_INFOPORT);\n+      // -1 is for disabling info server\n+      if (port < 0) return;\n+      String addr = conf.get(HBASE_CANARY_INFO_BINDADDRESS, \"0.0.0.0\");\n+      try {\n+        InfoServer infoServer = new InfoServer(\"canary\", addr, port, false, conf);\n+        infoServer.addUnprivilegedServlet(\"canary\", \"/canary-status\", CanaryStatusServlet.class);\n+        infoServer.setAttribute(\"sink\", this.sink);\n+        infoServer.start();\n+        LOG.info(\"Bind Canary http info server to port: \" + port);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717fb3f54106cabd1d2ef7d5374aca1d10e65bec"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM2MTQyMg==", "bodyText": "No assertions at all? Is there nothing to verify within the rendered template output?", "url": "https://github.com/apache/hbase/pull/1292#discussion_r406361422", "createdAt": "2020-04-09T17:27:26Z", "author": {"login": "ndimiduk"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/tool/TestCanaryStatusServlet.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.tool;\n+\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.client.RegionInfo;\n+import org.apache.hadoop.hbase.client.RegionInfoBuilder;\n+import org.apache.hadoop.hbase.testclassification.SmallTests;\n+import org.apache.hadoop.hbase.tmpl.tool.CanaryStatusTmpl;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+\n+import java.io.IOException;\n+import java.io.StringWriter;\n+\n+@Category({ SmallTests.class })\n+public class TestCanaryStatusServlet {\n+  @ClassRule\n+  public static final HBaseClassTestRule CLASS_RULE =\n+    HBaseClassTestRule.forClass(TestCanaryStatusServlet.class);\n+\n+  @Test\n+  public void testFailures() throws IOException {\n+    CanaryTool.RegionStdOutSink regionStdOutSink = new CanaryTool.RegionStdOutSink();\n+\n+    ServerName serverName1 = ServerName.valueOf(\"staging-st04.server:22600\",\n+      1584180761635L);\n+    TableName fakeTableName1 = TableName.valueOf(\"fakeTableName1\");\n+    RegionInfo regionInfo1 = RegionInfoBuilder.newBuilder(fakeTableName1).build();\n+\n+    ServerName serverName2 = ServerName.valueOf(\"staging-st05.server:22600\",\n+      1584180761636L);\n+    TableName fakeTableName2 = TableName.valueOf(\"fakeTableName2\");\n+    RegionInfo regionInfo2 = RegionInfoBuilder.newBuilder(fakeTableName2).build();\n+\n+    regionStdOutSink.publishReadFailure(serverName1, regionInfo1, new IOException());\n+    regionStdOutSink.publishWriteFailure(serverName2, regionInfo2, new IOException());\n+    CanaryStatusTmpl tmpl = new CanaryStatusTmpl();\n+    tmpl.render(new StringWriter(), regionStdOutSink);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "717fb3f54106cabd1d2ef7d5374aca1d10e65bec"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22658fe28f22b4b2e66bd2ff84a52033ee0f8dde", "author": {"user": {"login": "GeorryHuang", "name": null}}, "url": "https://github.com/apache/hbase/commit/22658fe28f22b4b2e66bd2ff84a52033ee0f8dde", "committedDate": "2020-04-10T03:15:49Z", "message": "HBASE-23994:Add WebUI to Canary(Checkstyle)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "102c8e3385a603c12a14051c75b9a1c95b4bc73b", "author": {"user": {"login": "GeorryHuang", "name": null}}, "url": "https://github.com/apache/hbase/commit/102c8e3385a603c12a14051c75b9a1c95b4bc73b", "committedDate": "2020-04-10T14:11:57Z", "message": "HBASE-23994:Add WebUI to Canary(Revise according to comments)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5403ea1e80986e77ca5b643c99fc5820930f6bd", "author": {"user": {"login": "GeorryHuang", "name": null}}, "url": "https://github.com/apache/hbase/commit/d5403ea1e80986e77ca5b643c99fc5820930f6bd", "committedDate": "2020-04-13T14:03:55Z", "message": "HBASE-23994:Add WebUI to Canary(Purge tabs and add assertions to TestCanaryStatusServlet)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNDcxMjc1", "url": "https://github.com/apache/hbase/pull/1292#pullrequestreview-392471275", "createdAt": "2020-04-13T22:03:14Z", "commit": {"oid": "d5403ea1e80986e77ca5b643c99fc5820930f6bd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2679, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}