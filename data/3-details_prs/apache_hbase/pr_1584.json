{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4NzcxODQy", "number": 1584, "title": "HBASE-24256 When fixOverlap hits the max region limit, it is possible\u2026", "bodyText": "\u2026 to include the same region in multiple merge request\nThere are two issues:\n\nThe same region could be included in multiple merge requests.\ndeleteMergeQualifiers() could delete columns without merge keyword,\nwhich could cause inconsistent state.", "createdAt": "2020-04-24T21:24:11Z", "url": "https://github.com/apache/hbase/pull/1584", "merged": true, "mergeCommit": {"oid": "30f07e81876ad746cd73aed538cb5638aad058a4"}, "closed": true, "closedAt": "2020-05-08T17:16:43Z", "author": {"login": "huaxiangsun"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABca4YR5gBqjMyNzEwOTUxNzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfD8bNgBqjMzMTQ2ODAyNDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "332b37ecb81eb8ba9ba5866956359addd4975f8e", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/332b37ecb81eb8ba9ba5866956359addd4975f8e", "committedDate": "2020-04-24T21:20:32Z", "message": "HBASE-24256 When fixOverlap hits the max region limit, it is possible to include the same region in multiple merge request\n\nThere are two issues:\n   1. The same region could be included in multiple merge requests.\n   2. deleteMergeQualifiers() could delete columns without merge keyword,\n      which could cause inconsistent state."}, "afterCommit": {"oid": "68e4b057a2bad7e3f13d7188cf4feca7e15a47cb", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/68e4b057a2bad7e3f13d7188cf4feca7e15a47cb", "committedDate": "2020-04-24T21:28:53Z", "message": "HBASE-24256 When fixOverlap hits the max region limit, it is possible to include the same region in multiple merge request\n\nThere are two issues:\n   1. The same region could be included in multiple merge requests.\n   2. deleteMergeQualifiers() could delete columns without merge keyword,\n      which could cause inconsistent state."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "68e4b057a2bad7e3f13d7188cf4feca7e15a47cb", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/68e4b057a2bad7e3f13d7188cf4feca7e15a47cb", "committedDate": "2020-04-24T21:28:53Z", "message": "HBASE-24256 When fixOverlap hits the max region limit, it is possible to include the same region in multiple merge request\n\nThere are two issues:\n   1. The same region could be included in multiple merge requests.\n   2. deleteMergeQualifiers() could delete columns without merge keyword,\n      which could cause inconsistent state."}, "afterCommit": {"oid": "f5e00a23ddb3d60e76aa3316af8887fad4859f7e", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/f5e00a23ddb3d60e76aa3316af8887fad4859f7e", "committedDate": "2020-04-24T22:41:25Z", "message": "HBASE-24256 When fixOverlap hits the max region limit, it is possible to include the same region in multiple merge request\n\nThere are two issues:\n   1. The same region could be included in multiple merge requests.\n   2. deleteMergeQualifiers() could delete columns without merge keyword,\n      which could cause inconsistent state."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMjg4NTcx", "url": "https://github.com/apache/hbase/pull/1584#pullrequestreview-400288571", "createdAt": "2020-04-24T21:43:11Z", "commit": {"oid": "68e4b057a2bad7e3f13d7188cf4feca7e15a47cb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQyMTo0MzoxMVrOGLqSoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQyMTo0MzoxMVrOGLqSoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDg4MDQxNg==", "bodyText": "Should we add a lock on the merge region instead of this?", "url": "https://github.com/apache/hbase/pull/1584#discussion_r414880416", "createdAt": "2020-04-24T21:43:11Z", "author": {"login": "saintstack"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/MetaTableAccessor.java", "diffHunk": "@@ -1846,6 +1846,16 @@ public static void deleteMergeQualifiers(Connection connection, final RegionInfo\n       qualifiers.add(qualifier);\n       delete.addColumns(getCatalogFamily(), qualifier, HConstants.LATEST_TIMESTAMP);\n     }\n+\n+    // There will be race condition that a GCMultipleMergedRegionsProcedure is scheduled while\n+    // the previous GCMultipleMergedRegionsProcedure is still going on, in this case, the second\n+    // GCMultipleMergedRegionsProcedure could delete the merged region by accident!\n+    if (qualifiers.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68e4b057a2bad7e3f13d7188cf4feca7e15a47cb"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MTU0MzE5", "url": "https://github.com/apache/hbase/pull/1584#pullrequestreview-405154319", "createdAt": "2020-05-04T16:34:25Z", "commit": {"oid": "f5e00a23ddb3d60e76aa3316af8887fad4859f7e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNjozNDoyNlrOGQIaGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNjozNDoyNlrOGQIaGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTU2ODE1Mw==", "bodyText": "This bit is hard to read. A comment on why <= 1?", "url": "https://github.com/apache/hbase/pull/1584#discussion_r419568153", "createdAt": "2020-05-04T16:34:26Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/MetaFixer.java", "diffHunk": "@@ -242,17 +243,35 @@ void fixOverlaps(CatalogJanitor.Report report) throws IOException {\n     }\n     List<SortedSet<RegionInfo>> merges = new ArrayList<>();\n     SortedSet<RegionInfo> currentMergeSet = new TreeSet<>();\n+    HashSet<RegionInfo> regionsInMergeSet = new HashSet<>();\n     RegionInfo regionInfoWithlargestEndKey =  null;\n     for (Pair<RegionInfo, RegionInfo> pair: overlaps) {\n       if (regionInfoWithlargestEndKey != null) {\n         if (!isOverlap(regionInfoWithlargestEndKey, pair) ||\n             currentMergeSet.size() >= maxMergeCount) {\n-          merges.add(currentMergeSet);\n-          currentMergeSet = new TreeSet<>();\n+          if (currentMergeSet.size() <= 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5e00a23ddb3d60e76aa3316af8887fad4859f7e"}, "originalPosition": 20}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f5e00a23ddb3d60e76aa3316af8887fad4859f7e", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/f5e00a23ddb3d60e76aa3316af8887fad4859f7e", "committedDate": "2020-04-24T22:41:25Z", "message": "HBASE-24256 When fixOverlap hits the max region limit, it is possible to include the same region in multiple merge request\n\nThere are two issues:\n   1. The same region could be included in multiple merge requests.\n   2. deleteMergeQualifiers() could delete columns without merge keyword,\n      which could cause inconsistent state."}, "afterCommit": {"oid": "f1774607d1f9842b96235e47e7595c106814f166", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/f1774607d1f9842b96235e47e7595c106814f166", "committedDate": "2020-05-04T22:23:37Z", "message": "HBASE-24256 When fixOverlap hits the max region limit, it is possible to include the same region in multiple merge request"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f1774607d1f9842b96235e47e7595c106814f166", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/f1774607d1f9842b96235e47e7595c106814f166", "committedDate": "2020-05-04T22:23:37Z", "message": "HBASE-24256 When fixOverlap hits the max region limit, it is possible to include the same region in multiple merge request"}, "afterCommit": {"oid": "9435f1777c17691c48c56266965bea3dbc145f35", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/9435f1777c17691c48c56266965bea3dbc145f35", "committedDate": "2020-05-04T22:50:34Z", "message": "HBASE-24256 When fixOverlap hits the max region limit, it is possible to include the same region in multiple merge request"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9435f1777c17691c48c56266965bea3dbc145f35", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/9435f1777c17691c48c56266965bea3dbc145f35", "committedDate": "2020-05-04T22:50:34Z", "message": "HBASE-24256 When fixOverlap hits the max region limit, it is possible to include the same region in multiple merge request"}, "afterCommit": {"oid": "9f80488fdaa512a1cedee50da2e6ec03d21a0a5a", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/9f80488fdaa512a1cedee50da2e6ec03d21a0a5a", "committedDate": "2020-05-07T17:57:24Z", "message": "HBASE-24256 When fixOverlap hits the max region limit, it is possible to include the same region in multiple merge request"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb10a945f88da18e1ea718333d5a6d60d4f17501", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/bb10a945f88da18e1ea718333d5a6d60d4f17501", "committedDate": "2020-05-07T21:13:14Z", "message": "HBASE-24256 When fixOverlap hits the max region limit, it is possible to include the same region in multiple merge request"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9f80488fdaa512a1cedee50da2e6ec03d21a0a5a", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/9f80488fdaa512a1cedee50da2e6ec03d21a0a5a", "committedDate": "2020-05-07T17:57:24Z", "message": "HBASE-24256 When fixOverlap hits the max region limit, it is possible to include the same region in multiple merge request"}, "afterCommit": {"oid": "bb10a945f88da18e1ea718333d5a6d60d4f17501", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/bb10a945f88da18e1ea718333d5a6d60d4f17501", "committedDate": "2020-05-07T21:13:14Z", "message": "HBASE-24256 When fixOverlap hits the max region limit, it is possible to include the same region in multiple merge request"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2231, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}