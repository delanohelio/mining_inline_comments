{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4MjQ5MDg5", "number": 2168, "title": "HBASE-24695 FSHLog - close the current WAL file in a background thread.", "bodyText": "", "createdAt": "2020-07-29T07:27:04Z", "url": "https://github.com/apache/hbase/pull/2168", "merged": true, "mergeCommit": {"oid": "a3f623eea71b400bc0aa47c8f7e4f115fbc93631"}, "closed": true, "closedAt": "2020-08-01T11:57:20Z", "author": {"login": "anoopsjohn"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5l24iAH2gAyNDU4MjQ5MDg5OjViNjUxNzY0MWMwNDhkZmM5M2ZiZjZkZTZiODZhMzQ5ODFhZWQxYTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6MLI3gFqTQ1ODkwMzM5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5b6517641c048dfc93fbf6de6b86a34981aed1a6", "author": {"user": {"login": "anoopsjohn", "name": "Anoop Sam John"}}, "url": "https://github.com/apache/hbase/commit/5b6517641c048dfc93fbf6de6b86a34981aed1a6", "committedDate": "2020-07-29T07:26:12Z", "message": "HBASE-24695 FSHLog - close the current WAL file in a background thread."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MzgzMjU4", "url": "https://github.com/apache/hbase/pull/2168#pullrequestreview-457383258", "createdAt": "2020-07-29T10:13:12Z", "commit": {"oid": "5b6517641c048dfc93fbf6de6b86a34981aed1a6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMDoxMzoxM1rOG4x52g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMDoxMzoxM1rOG4x52g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE5MTA2Ng==", "bodyText": "May be we can replace with that {} method of logging where we have the placeholders?", "url": "https://github.com/apache/hbase/pull/2168#discussion_r462191066", "createdAt": "2020-07-29T10:13:13Z", "author": {"login": "ramkrish86"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/wal/FSHLog.java", "diffHunk": "@@ -436,6 +464,19 @@ protected void doShutdown() throws IOException {\n       this.writer.close();\n       this.writer = null;\n     }\n+    closeExecutor.shutdown();\n+    try {\n+      if (!closeExecutor.awaitTermination(waitOnShutdownInSeconds, TimeUnit.SECONDS)) {\n+        LOG.error(\"We have waited \" + waitOnShutdownInSeconds + \" seconds but\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b6517641c048dfc93fbf6de6b86a34981aed1a6"}, "originalPosition": 116}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3Mzg0NDQ5", "url": "https://github.com/apache/hbase/pull/2168#pullrequestreview-457384449", "createdAt": "2020-07-29T10:15:00Z", "commit": {"oid": "5b6517641c048dfc93fbf6de6b86a34981aed1a6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMDoxNTowMVrOG4x9ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMDoxNTowMVrOG4x9ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE5MjAxMA==", "bodyText": "confirming once again with hasFlushedEntries when syncCloseCall is it mandatory or just to be on the safe side? Because even if hasUnFlushedEntries is false here i think errors would have crossed the limit anyway because we increment and then check it.\nRest LGTM. Can check the QA once. May be you may have to change some cluster based test to run with FSHLog as the default may be AsyncWAL.", "url": "https://github.com/apache/hbase/pull/2168#discussion_r462192010", "createdAt": "2020-07-29T10:15:01Z", "author": {"login": "ramkrish86"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/wal/FSHLog.java", "diffHunk": "@@ -412,6 +422,24 @@ protected void doReplaceWriter(Path oldPath, Path newPath, Writer nextWriter) th\n     }\n   }\n \n+  private void closeWriter(Path path, boolean syncCloseCall) throws IOException {\n+    try {\n+      TraceUtil.addTimelineAnnotation(\"closing writer\");\n+      writer.close();\n+      TraceUtil.addTimelineAnnotation(\"writer closed\");\n+    } catch (IOException ioe) {\n+      int errors = closeErrorCount.incrementAndGet();\n+      boolean hasUnflushedEntries = isUnflushedEntries();\n+      if (syncCloseCall && (hasUnflushedEntries || (errors > this.closeErrorsTolerated))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b6517641c048dfc93fbf6de6b86a34981aed1a6"}, "originalPosition": 96}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44e11fb58d2cb608b04699da176ba3c66f1907f2", "author": {"user": {"login": "anoopsjohn", "name": "Anoop Sam John"}}, "url": "https://github.com/apache/hbase/commit/44e11fb58d2cb608b04699da176ba3c66f1907f2", "committedDate": "2020-07-29T11:15:24Z", "message": "HBASE-24695 FSHLog - close the current WAL file in a background thread."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a050b4877a33351f63ab567b2a9918da6ddfa2b5", "author": {"user": {"login": "anoopsjohn", "name": "Anoop Sam John"}}, "url": "https://github.com/apache/hbase/commit/a050b4877a33351f63ab567b2a9918da6ddfa2b5", "committedDate": "2020-07-29T11:32:23Z", "message": "HBASE-24695 FSHLog - close the current WAL file in a background thread."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MDU1MzEw", "url": "https://github.com/apache/hbase/pull/2168#pullrequestreview-458055310", "createdAt": "2020-07-30T04:01:13Z", "commit": {"oid": "a050b4877a33351f63ab567b2a9918da6ddfa2b5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4OTAzMzk5", "url": "https://github.com/apache/hbase/pull/2168#pullrequestreview-458903399", "createdAt": "2020-07-31T04:04:43Z", "commit": {"oid": "a050b4877a33351f63ab567b2a9918da6ddfa2b5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4111, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}