{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzNzY3NDc0", "number": 2614, "title": "HBASE-25216 The client zk syncer should deal with meta replica count \u2026", "bodyText": "\u2026change", "createdAt": "2020-11-02T03:55:15Z", "url": "https://github.com/apache/hbase/pull/2614", "merged": true, "mergeCommit": {"oid": "49774c7e18f4a4cf4cccd1617014d8345fb1e8e2"}, "closed": true, "closedAt": "2020-11-04T09:54:18Z", "author": {"login": "Apache9"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYfRpagBqjM5NDY1NzUwNzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZFewuABqjM5NTU2OTU5OTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "51cf6a309bb5b1f8a54d4bef78c60988ba6d6be5", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/51cf6a309bb5b1f8a54d4bef78c60988ba6d6be5", "committedDate": "2020-11-02T03:54:15Z", "message": "HBASE-25216 The client zk syncer should deal with meta replica count change"}, "afterCommit": {"oid": "4387a8ddbde5ed4f764fbfa9e308008055077c24", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/4387a8ddbde5ed4f764fbfa9e308008055077c24", "committedDate": "2020-11-02T07:17:25Z", "message": "HBASE-25216 The client zk syncer should deal with meta replica count change"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4387a8ddbde5ed4f764fbfa9e308008055077c24", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/4387a8ddbde5ed4f764fbfa9e308008055077c24", "committedDate": "2020-11-02T07:17:25Z", "message": "HBASE-25216 The client zk syncer should deal with meta replica count change"}, "afterCommit": {"oid": "8ad90d35a2b992ab88a3f7b00fc75b5602426a15", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/8ad90d35a2b992ab88a3f7b00fc75b5602426a15", "committedDate": "2020-11-02T13:22:49Z", "message": "HBASE-25216 The client zk syncer should deal with meta replica count change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNTg5MzAy", "url": "https://github.com/apache/hbase/pull/2614#pullrequestreview-522589302", "createdAt": "2020-11-03T15:06:20Z", "commit": {"oid": "8ad90d35a2b992ab88a3f7b00fc75b5602426a15"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNTowNjoyMVrOHszEUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNToxOTowOFrOHszpmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjczNjA4Mw==", "bodyText": "The newly introduced ZKData structure is more efficient, shall we update the comments here and add some javadoc for the ZKData class?", "url": "https://github.com/apache/hbase/pull/2614#discussion_r516736083", "createdAt": "2020-11-03T15:06:21Z", "author": {"login": "carp84"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/zksyncer/ClientZKSyncer.java", "diffHunk": "@@ -34,30 +33,69 @@\n import org.apache.yetus.audience.InterfaceAudience;\n import org.apache.zookeeper.CreateMode;\n import org.apache.zookeeper.KeeperException;\n-\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n /**\n  * Tracks the target znode(s) on server ZK cluster and synchronize them to client ZK cluster if\n  * changed\n  * <p/>\n- * The target znode(s) is given through {@link #getNodesToWatch()} method\n+ * The target znode(s) is given through {@link #getPathsToWatch()} method\n  */\n @InterfaceAudience.Private\n public abstract class ClientZKSyncer extends ZKListener {\n   private static final Logger LOG = LoggerFactory.getLogger(ClientZKSyncer.class);\n   private final Server server;\n   private final ZKWatcher clientZkWatcher;\n+\n+  private static final class ZKData {\n+\n+    byte[] data;\n+\n+    boolean delete = false;\n+\n+    synchronized void set(byte[] data) {\n+      this.data = data;\n+      notifyAll();\n+    }\n+\n+    synchronized byte[] get() throws InterruptedException {\n+      while (!delete && data == null) {\n+        wait();\n+      }\n+      byte[] d = data;\n+      data = null;\n+      return d;\n+    }\n+\n+    synchronized void delete() {\n+      this.delete = true;\n+      notifyAll();\n+    }\n+\n+    synchronized boolean isDeleted() {\n+      return delete;\n+    }\n+  }\n+\n   // We use queues and daemon threads to synchronize the data to client ZK cluster", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ad90d35a2b992ab88a3f7b00fc75b5602426a15"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc0MjEwMA==", "bodyText": "So we choose not to reconnect if there are some issue on network stability that cause zookeeper connection loss? And it seems the reconnectAfterExpiration is not following the same handling on line 173-174", "url": "https://github.com/apache/hbase/pull/2614#discussion_r516742100", "createdAt": "2020-11-03T15:14:24Z", "author": {"login": "carp84"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/zksyncer/ClientZKSyncer.java", "diffHunk": "@@ -145,8 +177,7 @@ private final void setDataForClientZkUntilSuccess(String node, byte[] data)\n           LOG.warn(\n             \"Failed to create znode \" + node + \" due to: \" + e.getMessage() + \", will retry later\");\n         }\n-      } catch (KeeperException.ConnectionLossException\n-          | KeeperException.SessionExpiredException ee) {\n+      } catch (KeeperException.SessionExpiredException see) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ad90d35a2b992ab88a3f7b00fc75b5602426a15"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc0NTYyNg==", "bodyText": "Maybe adding more logics to verify the ClientZKSyncer is working well when meta replica changes, especially when reducing from multiple to single replica?", "url": "https://github.com/apache/hbase/pull/2614#discussion_r516745626", "createdAt": "2020-11-03T15:19:08Z", "author": {"login": "carp84"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestSeparateClientZKCluster.java", "diffHunk": "@@ -255,7 +260,20 @@ public void testAsyncTable() throws Exception {\n       Get get = new Get(row);\n       Result result = table.get(get).get();\n       LOG.debug(\"Result: \" + Bytes.toString(result.getValue(family, qualifier)));\n-      Assert.assertArrayEquals(value, result.getValue(family, qualifier));\n+      assertArrayEquals(value, result.getValue(family, qualifier));\n+    }\n+  }\n+\n+  @Test\n+  public void testChangeMetaReplicaCount() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ad90d35a2b992ab88a3f7b00fc75b5602426a15"}, "originalPosition": 163}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f29e809372ab3c6d1e1c08724b5361e12403c7e", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/4f29e809372ab3c6d1e1c08724b5361e12403c7e", "committedDate": "2020-11-04T03:48:13Z", "message": "HBASE-25216 The client zk syncer should deal with meta replica count change"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ad90d35a2b992ab88a3f7b00fc75b5602426a15", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/8ad90d35a2b992ab88a3f7b00fc75b5602426a15", "committedDate": "2020-11-02T13:22:49Z", "message": "HBASE-25216 The client zk syncer should deal with meta replica count change"}, "afterCommit": {"oid": "4f29e809372ab3c6d1e1c08724b5361e12403c7e", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/4f29e809372ab3c6d1e1c08724b5361e12403c7e", "committedDate": "2020-11-04T03:48:13Z", "message": "HBASE-25216 The client zk syncer should deal with meta replica count change"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1873, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}