{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNzAzNjk0", "number": 1022, "title": "HBASE-23680 RegionProcedureStore missing cleaning of hfile archive", "bodyText": "", "createdAt": "2020-01-11T07:14:57Z", "url": "https://github.com/apache/hbase/pull/1022", "merged": true, "mergeCommit": {"oid": "167892ce64143f7d3058ab583b02e1143e8e5217"}, "closed": true, "closedAt": "2020-01-18T12:30:48Z", "author": {"login": "Apache9"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb5Sf06ABqjI5NDA1OTQ1MDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7XJzTgFqTM0NDg4OTgyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e8c29cba30f0d6c4d56d2307c7f90e5a80300bf0", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/e8c29cba30f0d6c4d56d2307c7f90e5a80300bf0", "committedDate": "2020-01-11T07:14:05Z", "message": "HBASE-23680 RegionProcedureStore missing cleaning of hfile archive"}, "afterCommit": {"oid": "6d2b43013b69176de3b12c7466024bbfd8293a37", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/6d2b43013b69176de3b12c7466024bbfd8293a37", "committedDate": "2020-01-11T12:41:26Z", "message": "HBASE-23680 RegionProcedureStore missing cleaning of hfile archive"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNTMxNjY0", "url": "https://github.com/apache/hbase/pull/1022#pullrequestreview-341531664", "createdAt": "2020-01-11T17:05:07Z", "commit": {"oid": "6d2b43013b69176de3b12c7466024bbfd8293a37"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQxNzowNTowN1rOFcmRxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMVQxNzowNzowNVrOFcmSKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMTU5MA==", "bodyText": "We just delete archived files? Why even archive them then? Can we delay the delete at least?", "url": "https://github.com/apache/hbase/pull/1022#discussion_r365531590", "createdAt": "2020-01-11T17:05:07Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/procedure2/store/region/RegionFlusherAndCompactor.java", "diffHunk": "@@ -136,9 +146,30 @@ static void setupConf(Configuration conf) {\n       flushPerChanges, flushIntervalMs);\n   }\n \n+  private void deleteCompactedHFiles() throws IOException {\n+    HStore store = Iterables.getOnlyElement(region.getStores());\n+    store.closeAndArchiveCompactedFiles();\n+    // for now we just deleted these HFiles, without moving them to the global archive directory.\n+    // This is because that, our HFiles are on the WAL file system, but the global HFile archive\n+    // directory is on the root(HFile) file system, we can not move between two different file\n+    // systems.\n+    Path archiveDir = HFileArchiveUtil.getStoreArchivePath(conf, region.getRegionInfo(),\n+      store.getColumnFamilyDescriptor().getName());\n+    FileSystem fs = archiveDir.getFileSystem(conf);\n+    if (LOG.isDebugEnabled()) {\n+      FileStatus[] toDelete = fs.listStatus(archiveDir);\n+      if (toDelete != null && toDelete.length > 0) {\n+        LOG.debug(\"Delete all archived HFiles under {}: {}\", archiveDir, Stream.of(toDelete)\n+          .map(s -> s.getPath().getName()).collect(Collectors.joining(\", \", \"[\", \"]\")));\n+      }\n+    }\n+    fs.delete(archiveDir, true);\n+  }\n+\n   private void compact() {\n     try {\n       region.compact(true);\n+      deleteCompactedHFiles();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d2b43013b69176de3b12c7466024bbfd8293a37"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMTY5MQ==", "bodyText": "Why we writing hfiles into WAL fs out of interest?", "url": "https://github.com/apache/hbase/pull/1022#discussion_r365531691", "createdAt": "2020-01-11T17:07:05Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/procedure2/store/region/RegionFlusherAndCompactor.java", "diffHunk": "@@ -136,9 +146,30 @@ static void setupConf(Configuration conf) {\n       flushPerChanges, flushIntervalMs);\n   }\n \n+  private void deleteCompactedHFiles() throws IOException {\n+    HStore store = Iterables.getOnlyElement(region.getStores());\n+    store.closeAndArchiveCompactedFiles();\n+    // for now we just deleted these HFiles, without moving them to the global archive directory.\n+    // This is because that, our HFiles are on the WAL file system, but the global HFile archive\n+    // directory is on the root(HFile) file system, we can not move between two different file\n+    // systems.\n+    Path archiveDir = HFileArchiveUtil.getStoreArchivePath(conf, region.getRegionInfo(),\n+      store.getColumnFamilyDescriptor().getName());\n+    FileSystem fs = archiveDir.getFileSystem(conf);\n+    if (LOG.isDebugEnabled()) {\n+      FileStatus[] toDelete = fs.listStatus(archiveDir);\n+      if (toDelete != null && toDelete.length > 0) {\n+        LOG.debug(\"Delete all archived HFiles under {}: {}\", archiveDir, Stream.of(toDelete)\n+          .map(s -> s.getPath().getName()).collect(Collectors.joining(\", \", \"[\", \"]\")));\n+      }\n+    }\n+    fs.delete(archiveDir, true);\n+  }\n+\n   private void compact() {\n     try {\n       region.compact(true);\n+      deleteCompactedHFiles();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTUzMTU5MA=="}, "originalCommit": {"oid": "6d2b43013b69176de3b12c7466024bbfd8293a37"}, "originalPosition": 65}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6d2b43013b69176de3b12c7466024bbfd8293a37", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/6d2b43013b69176de3b12c7466024bbfd8293a37", "committedDate": "2020-01-11T12:41:26Z", "message": "HBASE-23680 RegionProcedureStore missing cleaning of hfile archive"}, "afterCommit": {"oid": "e9e831c835912efef2dbc19f2e879ece823110f8", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/e9e831c835912efef2dbc19f2e879ece823110f8", "committedDate": "2020-01-12T05:44:19Z", "message": "HBASE-23680 RegionProcedureStore missing cleaning of hfile archive"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e9e831c835912efef2dbc19f2e879ece823110f8", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/e9e831c835912efef2dbc19f2e879ece823110f8", "committedDate": "2020-01-12T05:44:19Z", "message": "HBASE-23680 RegionProcedureStore missing cleaning of hfile archive"}, "afterCommit": {"oid": "dbe7d1d16da5246d62acb308a31790bf1501c862", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/dbe7d1d16da5246d62acb308a31790bf1501c862", "committedDate": "2020-01-12T12:52:30Z", "message": "HBASE-23680 RegionProcedureStore missing cleaning of hfile archive"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNzEyODc0", "url": "https://github.com/apache/hbase/pull/1022#pullrequestreview-342712874", "createdAt": "2020-01-14T17:34:30Z", "commit": {"oid": "dbe7d1d16da5246d62acb308a31790bf1501c862"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNzozNDozMFrOFdf6RQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNzozNDozMFrOFdf6RQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ3NTg0NQ==", "bodyText": "We should be asking the other cleaner delegates if it's okay to delete these files. I could see it being either the WAL cleaner delegates or the HFile Cleaner delegates, but it needs to be one of them.", "url": "https://github.com/apache/hbase/pull/1022#discussion_r366475845", "createdAt": "2020-01-14T17:34:30Z", "author": {"login": "busbey"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/procedure2/store/region/RegionFlusherAndCompactor.java", "diffHunk": "@@ -136,9 +156,43 @@ static void setupConf(Configuration conf) {\n       flushPerChanges, flushIntervalMs);\n   }\n \n+  private boolean isHFileDeleteable(FileStatus status) {\n+    long currentTime = EnvironmentEdgeManager.currentTime();\n+    long time = status.getModificationTime();\n+    long life = currentTime - time;\n+    if (LOG.isTraceEnabled()) {\n+      LOG.trace(\"HFile life: {}ms, ttl: {}ms, current: {}, from: {}\", life, compactedHFileTTLMs,\n+        currentTime, time);\n+    }\n+    if (life < 0) {\n+      LOG.warn(\"Found a hfile ({}) newer than current time ({} < {}), probably a clock skew\",\n+        status.getPath(), currentTime, time);\n+      return false;\n+    }\n+    return life > compactedHFileTTLMs;\n+  }\n+\n+  void cleanupCompactedHFiles() throws IOException {\n+    HStore store = Iterables.getOnlyElement(region.getStores());\n+    // our HFiles are on the WAL file system, but the global HFile archive directory is on the\n+    // root(HFile) file system, we can not move between two different file systems. So here we have\n+    // to implement our own TTL cleaner.\n+    Path archiveDir = HFileArchiveUtil.getStoreArchivePath(conf, region.getRegionInfo(),\n+      store.getColumnFamilyDescriptor().getName());\n+    FileSystem fs = archiveDir.getFileSystem(conf);\n+\n+    for (FileStatus status : fs.listStatus(archiveDir)) {\n+      if (isHFileDeleteable(status)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dbe7d1d16da5246d62acb308a31790bf1501c862"}, "originalPosition": 99}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dbe7d1d16da5246d62acb308a31790bf1501c862", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/dbe7d1d16da5246d62acb308a31790bf1501c862", "committedDate": "2020-01-12T12:52:30Z", "message": "HBASE-23680 RegionProcedureStore missing cleaning of hfile archive"}, "afterCommit": {"oid": "936c95224a2d7a74d5998d41cdc794a5089e6066", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/936c95224a2d7a74d5998d41cdc794a5089e6066", "committedDate": "2020-01-16T08:51:24Z", "message": "HBASE-23680 RegionProcedureStore missing cleaning of hfile archive"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee1d497428e68e019bf2c6530a30eff263855dbe", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/ee1d497428e68e019bf2c6530a30eff263855dbe", "committedDate": "2020-01-16T15:31:24Z", "message": "HBASE-23680 RegionProcedureStore missing cleaning of hfile archive"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "936c95224a2d7a74d5998d41cdc794a5089e6066", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/936c95224a2d7a74d5998d41cdc794a5089e6066", "committedDate": "2020-01-16T08:51:24Z", "message": "HBASE-23680 RegionProcedureStore missing cleaning of hfile archive"}, "afterCommit": {"oid": "ee1d497428e68e019bf2c6530a30eff263855dbe", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/ee1d497428e68e019bf2c6530a30eff263855dbe", "committedDate": "2020-01-16T15:31:24Z", "message": "HBASE-23680 RegionProcedureStore missing cleaning of hfile archive"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0ODg5ODI1", "url": "https://github.com/apache/hbase/pull/1022#pullrequestreview-344889825", "createdAt": "2020-01-17T23:14:47Z", "commit": {"oid": "ee1d497428e68e019bf2c6530a30eff263855dbe"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMzoxNDo0OFrOFfHkeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMzoxNDo0OFrOFfHkeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE3NDIwMA==", "bodyText": "Strange place to start cleanerPool down here in the procedure startup given it is used cleaning WALs and hfile...", "url": "https://github.com/apache/hbase/pull/1022#discussion_r368174200", "createdAt": "2020-01-17T23:14:48Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java", "diffHunk": "@@ -1520,8 +1518,10 @@ protected void stopServiceThreads() {\n \n   private void createProcedureExecutor() throws IOException {\n     MasterProcedureEnv procEnv = new MasterProcedureEnv(this);\n-    procedureStore =\n-      new RegionProcedureStore(this, new MasterProcedureEnv.FsUtilsLeaseRecovery(this));\n+    // Create cleaner thread pool\n+    cleanerPool = new DirScanPool(conf);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee1d497428e68e019bf2c6530a30eff263855dbe"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3189, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}