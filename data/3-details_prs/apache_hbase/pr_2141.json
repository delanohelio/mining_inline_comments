{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2NDM4NTk1", "number": 2141, "title": "HBASE-11686 Shell code should create a binding / irb workspace instead of polluting the root namespace", "bodyText": "Resolves https://issues.apache.org/jira/browse/HBASE-11686\nGoal\nStop defining HBase commands and constants on Ruby's main object. Instead, HBase commands and constants are defined within the scope of an Interactive Ruby (IRB) Workspace.\nConsequences for Scripts\nWhen using script via STDIN (echo version | hbase shell) or filename (hbase shell script.rb), the code is evaluated by this PR within the created IRB Workspace. Code should work as before unless the script \"breaks out\" of the current binding (for example, this could be done using Ruby's TOPLEVEL_BINDING). For cases like this one, I added a flag --top-level-defs that should be backwards compatible with all scripts.\nChangelog\n\nRefactor Shell.export_commands to define commands as singleton methods\nusing ruby lambdas. Additionally, this change stores a reference to shell_inst\nin scope so that we no longer need to assume the existance of the variable\n@shell.\nAdd logic to Shell class for constructing an IRB workspace with its own\nbinding and non-global receiver. This workspace is loaded with all HBase and\nIRB commands.\nCreate new method on Shell for evaluating input from an arbitrary IO instance\nwithin the created IRB workspace. This is based on work by Hsieh that was\npreviously in bin/hirb.rb. This method is more generic and more testable.\nThis single pattern can be used for both executing files and reading from\nstdin, therefore reducing complexity.\nMove special 'help' and 'tools' command definitions to shell.rb. These\ncommands are tightly linked with an instance of the shell, so it is easiest\nto have them defined together.\nRemove all global includes of HBaseConstants from ruby test files. Before\nthis change, tests were loading these constants into the top level, which\ncould cause tests to pass that should really fail.\nTry to reduce the number of places that constants are included. I think it's\nbest to reference each ruby constant's full name, but where that would cause\na big diff I instead moved the include to the innermost Module or Class.\nUpdate docs and comments\nRemove unneccessary includes\nAdd shell --top-level-defs compatibility flag. Since this PR removes all the\nHBase symbols from the top-level receiver (ie. main Object), it is possible\n(albeit unlikely) that this will break operator scripts. This flag will\nexport all the commands at the top-level like the shell previously did.\nCreate new helper method Shell::Shell#export_all to install @hbase, @shell,\nconstants, and all hbase commands to a target receiver. As a result, the\nHBaseReceiver became very simple and could be moved to shell.rb.\nAdd unit tests for Shell::Shell#eval_io and Shell::Shell#export_all", "createdAt": "2020-07-24T18:54:06Z", "url": "https://github.com/apache/hbase/pull/2141", "merged": true, "mergeCommit": {"oid": "7eff07d6bfc74080addb7b2ab4076a9e75d3175c"}, "closed": true, "closedAt": "2020-07-28T03:56:10Z", "author": {"login": "bitoffdev"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc4IqY_gH2gAyNDU2NDM4NTk1OmIwNWM2MzBjMjlhYzUwZTdjMTM1NmYwYjA5YTk5NTEzZWM3NTZkOGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5GbJjgH2gAyNDU2NDM4NTk1OjliNmRkNWVkOTBiMmU1ZTZmMDFkZWQ3YjAyOWM2NjVjNGJkMGU1ODA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b05c630c29ac50e7c1356f0b09a99513ec756d8c", "author": {"user": {"login": "bitoffdev", "name": "Elliot"}}, "url": "https://github.com/apache/hbase/commit/b05c630c29ac50e7c1356f0b09a99513ec756d8c", "committedDate": "2020-07-24T18:51:23Z", "message": "HBASE-11686 Shell code should create a binding / irb workspace instead of polluting the root namespace\n\n- Refactor Shell.export_commands to define commands using ruby lambdas.\n  Additionally, this change stores a reference to shell_inst in scope so that\n  we no longer need to assume the existance of the variable @shell.\n- Add logic to Shell class for constructing an IRB workspace with its own\n  binding and non-global receiver. This workspace is loaded with all HBase and\n  IRB commands.\n- Create new method on Shell for evaluating input from an arbitrary IO instance\n  within the created IRB workspace. This is based on work by Hsieh that was\n  previously in bin/hirb.rb. This method is more generic and more testable.\n  This single pattern can be used for both executing files and reading from\n  stdin, therefore reducing complexity.\n- Move special 'help' and 'tools' command definitions to shell.rb. These\n  commands are tightly linked with an instance of the shell, so it is easiest\n  to have them defined together.\n- Remove all global includes of HBaseConstants from ruby test files. Before\n  this change, tests were loading these constants into the top level, which\n  could cause tests to pass that should really fail.\n- Try to reduce the number of places that constants are included. I think it's\n  best to reference each ruby constant's full name, but where that would cause\n  a big diff I instead moved the include to the innermost Module or Class.\n- Update docs and comments\n- Remove unneccessary includes\n- Add shell --top-level-cmds compatibility flag. Since this PR removes all the\n  HBase symbols from the top-level receiver (ie. main Object), it is possible\n  (albeit unlikely) that this will break operator scripts. This flag will\n  export all the commands at the top-level like the shell previously did."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d73834114be6a7268c159ca17c79c72156724bc", "author": {"user": {"login": "bitoffdev", "name": "Elliot"}}, "url": "https://github.com/apache/hbase/commit/3d73834114be6a7268c159ca17c79c72156724bc", "committedDate": "2020-07-27T16:52:25Z", "message": "HBASE-11686 Light refactoring with added unit tests\n\n- Fixes some constants references by admin test 2\n- Install HBase commands as singleton methods on recevier instances so that\n  multiple receivers may exist.\n- Rename new flag from --top-level-cmds to --top-level-defs to be more\n  semantically accurate.\n- Create new helper method Shell::Shell#export_all to install @hbase, @shell,\n  constants, and all hbase commands to a target receiver. As a result, the\n  HBaseReceiver became very simple and could be moved to shell.rb.\n- Add unit tests for Shell::Shell#eval_io and Shell::Shell#export_all\n- Add @hbase and @shell to hbase-shell IRB workspace\n- Fix robocop issues within patch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MDA2MDUw", "url": "https://github.com/apache/hbase/pull/2141#pullrequestreview-456006050", "createdAt": "2020-07-27T17:51:54Z", "commit": {"oid": "3d73834114be6a7268c159ca17c79c72156724bc"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzo1MTo1NFrOG3tM9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNzo1MTo1NFrOG3tM9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA2NTQ2MQ==", "bodyText": "s/is/if/", "url": "https://github.com/apache/hbase/pull/2141#discussion_r461065461", "createdAt": "2020-07-27T17:51:54Z", "author": {"login": "saintstack"}, "path": "bin/hirb.rb", "diffHunk": "@@ -143,21 +148,10 @@ def add_to_configuration(c, arg)\n @shell = Shell::Shell.new(@hbase, interactive)\n @shell.debug = @shell_debug\n \n-# Add commands to this namespace\n-# TODO avoid polluting main namespace by using a binding\n-@shell.export_commands(self)\n-\n-# Add help command\n-def help(command = nil)\n-  @shell.help(command)\n-end\n-\n-# Backwards compatibility method\n-def tools\n-  @shell.help_group('tools')\n-end\n-\n-# Debugging method\n+##\n+# Toggle shell debugging\n+#\n+# @return [Boolean] true is debug is turned on after updating the flag", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d73834114be6a7268c159ca17c79c72156724bc"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b6dd5ed90b2e5e6f01ded7b029c665c4bd0e580", "author": {"user": {"login": "bitoffdev", "name": "Elliot"}}, "url": "https://github.com/apache/hbase/commit/9b6dd5ed90b2e5e6f01ded7b029c665c4bd0e580", "committedDate": "2020-07-27T18:48:51Z", "message": "Typo s/is/if/"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4080, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}