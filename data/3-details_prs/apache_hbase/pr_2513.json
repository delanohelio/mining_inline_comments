{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5OTcxNDg3", "number": 2513, "title": "HBASE-25164 Make ModifyTableProcedure support changing meta replica c\u2026", "bodyText": "\u2026ount", "createdAt": "2020-10-08T14:34:59Z", "url": "https://github.com/apache/hbase/pull/2513", "merged": true, "mergeCommit": {"oid": "92c3bcd9fbc108dd7699d75486e85707e3e4514f"}, "closed": true, "closedAt": "2020-10-13T01:43:56Z", "author": {"login": "Apache9"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQkfrAAFqTUwNDk2MzgzNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdR2Ee1gFqTUwNjczODY0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0OTYzODM1", "url": "https://github.com/apache/hbase/pull/2513#pullrequestreview-504963835", "createdAt": "2020-10-08T16:32:42Z", "commit": {"oid": "1de3e5344dcf99fa14d9ecbb1dc84b21b8de7799"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxNjozMjo0MlrOHem4jQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxNjo0MTo1MVrOHenOpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg1NjM5Nw==", "bodyText": "Doc needs an edit. It has section on meta replicas how-to.", "url": "https://github.com/apache/hbase/pull/2513#discussion_r501856397", "createdAt": "2020-10-08T16:32:42Z", "author": {"login": "saintstack"}, "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java", "diffHunk": "@@ -1131,7 +1131,20 @@\n   /** Conf key for enabling meta replication */\n   public static final String USE_META_REPLICAS = \"hbase.meta.replicas.use\";\n   public static final boolean DEFAULT_USE_META_REPLICAS = false;\n+\n+  /**\n+   * @deprecated Since 2.4.0, will be removed in 4.0.0. Please change the meta replicas number by\n+   *             altering meta table, i.e, set a new 'region replication' number and call\n+   *             modifyTable.\n+   */\n+  @Deprecated\n   public static final String META_REPLICAS_NUM = \"hbase.meta.replica.count\";\n+  /**\n+   * @deprecated Since 2.4.0, will be removed in 4.0.0. Please change the meta replicas number by\n+   *             altering meta table, i.e, set a new 'region replication' number and call\n+   *             modifyTable.\n+   */\n+  @Deprecated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1de3e5344dcf99fa14d9ecbb1dc84b21b8de7799"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg1OTg0Ng==", "bodyText": "Good", "url": "https://github.com/apache/hbase/pull/2513#discussion_r501859846", "createdAt": "2020-10-08T16:38:13Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java", "diffHunk": "@@ -1093,6 +1091,39 @@ private void finishActiveMasterInitialization(MonitoredTask status) throws IOExc\n     this.assignmentManager.joinCluster();\n     // The below depends on hbase:meta being online.\n     this.tableStateManager.start();\n+\n+    // for migrating from a version without HBASE-25099, and also for honoring the configuration\n+    // first.\n+    if (conf.get(HConstants.META_REPLICAS_NUM) != null) {\n+      int replicasNumInConf =\n+        conf.getInt(HConstants.META_REPLICAS_NUM, HConstants.DEFAULT_META_REPLICA_NUM);\n+      TableDescriptor metaDesc = tableDescriptors.get(TableName.META_TABLE_NAME);\n+      if (metaDesc.getRegionReplication() != replicasNumInConf) {\n+        // it is possible that we already have some replicas before upgrading, so we must set the\n+        // region replication number in meta TableDescriptor directly first, without creating a\n+        // ModifyTableProcedure, otherwise it may cause a double assign for the meta replicas.\n+        int existingReplicasCount =\n+          assignmentManager.getRegionStates().getRegionsOfTable(TableName.META_TABLE_NAME).size();\n+        if (existingReplicasCount > metaDesc.getRegionReplication()) {\n+          LOG.info(\"Update replica count of hbase:meta from {}(in TableDescriptor)\" +\n+            \" to {}(existing ZNodes)\", metaDesc.getRegionReplication(), existingReplicasCount);\n+          metaDesc = TableDescriptorBuilder.newBuilder(metaDesc)\n+            .setRegionReplication(existingReplicasCount).build();\n+          tableDescriptors.update(metaDesc);\n+        }\n+        // check again, and issue a ModifyTableProcedure if needed\n+        if (metaDesc.getRegionReplication() != replicasNumInConf) {\n+          LOG.info(\n+            \"The {} config is {} while the replica count in TableDescriptor is {}\" +\n+              \" for hbase:meta, altering...\",\n+            HConstants.META_REPLICAS_NUM, replicasNumInConf, metaDesc.getRegionReplication());\n+          procedureExecutor.submitProcedure(new ModifyTableProcedure(\n+            procedureExecutor.getEnvironment(), TableDescriptorBuilder.newBuilder(metaDesc)\n+              .setRegionReplication(replicasNumInConf).build(),\n+            null, metaDesc, false));\n+        }\n+      }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1de3e5344dcf99fa14d9ecbb1dc84b21b8de7799"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg2MTI4Mw==", "bodyText": "Grep hbase.meta.replica.count in the doc.", "url": "https://github.com/apache/hbase/pull/2513#discussion_r501861283", "createdAt": "2020-10-08T16:40:32Z", "author": {"login": "saintstack"}, "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java", "diffHunk": "@@ -1131,7 +1131,20 @@\n   /** Conf key for enabling meta replication */\n   public static final String USE_META_REPLICAS = \"hbase.meta.replicas.use\";\n   public static final boolean DEFAULT_USE_META_REPLICAS = false;\n+\n+  /**\n+   * @deprecated Since 2.4.0, will be removed in 4.0.0. Please change the meta replicas number by\n+   *             altering meta table, i.e, set a new 'region replication' number and call\n+   *             modifyTable.\n+   */\n+  @Deprecated\n   public static final String META_REPLICAS_NUM = \"hbase.meta.replica.count\";\n+  /**\n+   * @deprecated Since 2.4.0, will be removed in 4.0.0. Please change the meta replicas number by\n+   *             altering meta table, i.e, set a new 'region replication' number and call\n+   *             modifyTable.\n+   */\n+  @Deprecated", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg1NjM5Nw=="}, "originalCommit": {"oid": "1de3e5344dcf99fa14d9ecbb1dc84b21b8de7799"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg2MjA1NQ==", "bodyText": "We don't need this anymore?", "url": "https://github.com/apache/hbase/pull/2513#discussion_r501862055", "createdAt": "2020-10-08T16:41:51Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java", "diffHunk": "@@ -1157,13 +1188,6 @@ private void finishActiveMasterInitialization(MonitoredTask status) throws IOExc\n     }\n \n     assignmentManager.checkIfShouldMoveSystemRegionAsync();\n-    status.setStatus(\"Assign meta replicas\");\n-    MasterMetaBootstrap metaBootstrap = createMetaBootstrap();\n-    try {\n-      metaBootstrap.assignMetaReplicas();\n-    } catch (IOException | KeeperException e){\n-      LOG.error(\"Assigning meta replica failed: \", e);\n-    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1de3e5344dcf99fa14d9ecbb1dc84b21b8de7799"}, "originalPosition": 70}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1de3e5344dcf99fa14d9ecbb1dc84b21b8de7799", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/1de3e5344dcf99fa14d9ecbb1dc84b21b8de7799", "committedDate": "2020-10-08T14:34:03Z", "message": "HBASE-25164 Make ModifyTableProcedure support changing meta replica count"}, "afterCommit": {"oid": "82de2106bd85661fa892199ed0cf56161928f371", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/82de2106bd85661fa892199ed0cf56161928f371", "committedDate": "2020-10-10T00:48:10Z", "message": "HBASE-25164 Make ModifyTableProcedure support changing meta replica count"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1890a051a2f42c74e289dcf70533d775a3315a47", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/1890a051a2f42c74e289dcf70533d775a3315a47", "committedDate": "2020-10-10T09:01:22Z", "message": "HBASE-25164 Make ModifyTableProcedure support changing meta replica count"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7f7a5269cbfd6335075a1544cc69337f96c75c48", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/7f7a5269cbfd6335075a1544cc69337f96c75c48", "committedDate": "2020-10-10T01:39:19Z", "message": "fix checkstyle"}, "afterCommit": {"oid": "1890a051a2f42c74e289dcf70533d775a3315a47", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/1890a051a2f42c74e289dcf70533d775a3315a47", "committedDate": "2020-10-10T09:01:22Z", "message": "HBASE-25164 Make ModifyTableProcedure support changing meta replica count"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NzM4NjQ0", "url": "https://github.com/apache/hbase/pull/2513#pullrequestreview-506738644", "createdAt": "2020-10-12T15:53:43Z", "commit": {"oid": "1890a051a2f42c74e289dcf70533d775a3315a47"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4317, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}