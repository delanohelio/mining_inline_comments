{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyMTQ0NDEx", "number": 2450, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMjozOToxNVrOEm2gmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQxNDozMTowOVrOEsSc5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5MTc0NDI0OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupBasedLoadBalancer.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMjozOToxNVrOHXHqTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQwNzo1NTozNlrOHZfdrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwNDgxNA==", "bodyText": "When will retainAssignment return null? If there is no difference between a null and an empty Map, let's just return an empty Map to avoid the null check here?", "url": "https://github.com/apache/hbase/pull/2450#discussion_r494004814", "createdAt": "2020-09-24T02:39:15Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupBasedLoadBalancer.java", "diffHunk": "@@ -203,8 +203,11 @@ public void setMasterServices(MasterServices masterServices) {\n         regionList.forEach(r -> currentAssignmentMap.put(r, regions.get(r)));\n         Map<ServerName, List<RegionInfo>> pairResult =\n             this.internalBalancer.retainAssignment(currentAssignmentMap, pair.getSecond());\n-        pairResult.forEach((server, rs) ->\n-            assignments.computeIfAbsent(server, s -> Lists.newArrayList()).addAll(rs));\n+        if (pairResult == null || pairResult.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "275f0bdeb56cbb6ae80f626333635e505adc2598"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI0MDQ5OQ==", "bodyText": "the BaseLoadBalancer.retainAssignment may return null when online server is empty(for some situation), then will add these regions to pendingAssignQueue to retry assign.\nactually, the RSGroupBasedLoadBalancer.retainAssignment will do generateGroupAssignments first, so when invoke internalBalancer.retainAssignment the server list can't be empty, at least has BOGUS_SERVER_NAME,so here can not return null", "url": "https://github.com/apache/hbase/pull/2450#discussion_r494240499", "createdAt": "2020-09-24T11:32:48Z", "author": {"login": "nyl3532016"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupBasedLoadBalancer.java", "diffHunk": "@@ -203,8 +203,11 @@ public void setMasterServices(MasterServices masterServices) {\n         regionList.forEach(r -> currentAssignmentMap.put(r, regions.get(r)));\n         Map<ServerName, List<RegionInfo>> pairResult =\n             this.internalBalancer.retainAssignment(currentAssignmentMap, pair.getSecond());\n-        pairResult.forEach((server, rs) ->\n-            assignments.computeIfAbsent(server, s -> Lists.newArrayList()).addAll(rs));\n+        if (pairResult == null || pairResult.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwNDgxNA=="}, "originalCommit": {"oid": "275f0bdeb56cbb6ae80f626333635e505adc2598"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI0MjE1NQ==", "bodyText": "@cuibo01 do you meet this NPE in production environment?", "url": "https://github.com/apache/hbase/pull/2450#discussion_r494242155", "createdAt": "2020-09-24T11:35:56Z", "author": {"login": "nyl3532016"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupBasedLoadBalancer.java", "diffHunk": "@@ -203,8 +203,11 @@ public void setMasterServices(MasterServices masterServices) {\n         regionList.forEach(r -> currentAssignmentMap.put(r, regions.get(r)));\n         Map<ServerName, List<RegionInfo>> pairResult =\n             this.internalBalancer.retainAssignment(currentAssignmentMap, pair.getSecond());\n-        pairResult.forEach((server, rs) ->\n-            assignments.computeIfAbsent(server, s -> Lists.newArrayList()).addAll(rs));\n+        if (pairResult == null || pairResult.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwNDgxNA=="}, "originalCommit": {"oid": "275f0bdeb56cbb6ae80f626333635e505adc2598"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTQzNzczNQ==", "bodyText": "Seems you do not get my point...\nWhat I mean is what is the difference when returning null and an empty Map for the retainAssignment method... I do not care when will the method return null, I just want to know, is it OK to change to return an empty Map. If not, why?", "url": "https://github.com/apache/hbase/pull/2450#discussion_r495437735", "createdAt": "2020-09-26T09:32:20Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupBasedLoadBalancer.java", "diffHunk": "@@ -203,8 +203,11 @@ public void setMasterServices(MasterServices masterServices) {\n         regionList.forEach(r -> currentAssignmentMap.put(r, regions.get(r)));\n         Map<ServerName, List<RegionInfo>> pairResult =\n             this.internalBalancer.retainAssignment(currentAssignmentMap, pair.getSecond());\n-        pairResult.forEach((server, rs) ->\n-            assignments.computeIfAbsent(server, s -> Lists.newArrayList()).addAll(rs));\n+        if (pairResult == null || pairResult.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwNDgxNA=="}, "originalCommit": {"oid": "275f0bdeb56cbb6ae80f626333635e505adc2598"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ5MTk1MQ==", "bodyText": "Yes, Let me refactor retainAssignment and roundRobinAssignment with nonNull return", "url": "https://github.com/apache/hbase/pull/2450#discussion_r496491951", "createdAt": "2020-09-29T07:55:36Z", "author": {"login": "nyl3532016"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupBasedLoadBalancer.java", "diffHunk": "@@ -203,8 +203,11 @@ public void setMasterServices(MasterServices masterServices) {\n         regionList.forEach(r -> currentAssignmentMap.put(r, regions.get(r)));\n         Map<ServerName, List<RegionInfo>> pairResult =\n             this.internalBalancer.retainAssignment(currentAssignmentMap, pair.getSecond());\n-        pairResult.forEach((server, rs) ->\n-            assignments.computeIfAbsent(server, s -> Lists.newArrayList()).addAll(rs));\n+        if (pairResult == null || pairResult.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwNDgxNA=="}, "originalCommit": {"oid": "275f0bdeb56cbb6ae80f626333635e505adc2598"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0ODc1MTExOnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/AssignmentManager.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQxNDozMTowOVrOHfgRMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMVQxMjo0OTo0NlrOHfnRkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc5NjU5NA==", "bodyText": "Why this change?", "url": "https://github.com/apache/hbase/pull/2450#discussion_r502796594", "createdAt": "2020-10-10T14:31:09Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/AssignmentManager.java", "diffHunk": "@@ -2150,12 +2150,8 @@ private void acceptPlan(final HashMap<RegionInfo, RegionStateNode> regions,\n     final ProcedureEvent<?>[] events = new ProcedureEvent[regions.size()];\n     final long st = System.currentTimeMillis();\n \n-    if (plan == null) {\n-      throw new HBaseIOException(\"unable to compute plans for regions=\" + regions.size());\n-    }\n-\n     if (plan.isEmpty()) {\n-      return;\n+      throw new HBaseIOException(\"unable to compute plans for regions=\" + regions.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86275542f37d997544abe1fcddc704cec065c4ed"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg3MDA1Mg==", "bodyText": "we use empty Map replace null return, so it means exception occur during assignment", "url": "https://github.com/apache/hbase/pull/2450#discussion_r502870052", "createdAt": "2020-10-11T05:59:09Z", "author": {"login": "nyl3532016"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/AssignmentManager.java", "diffHunk": "@@ -2150,12 +2150,8 @@ private void acceptPlan(final HashMap<RegionInfo, RegionStateNode> regions,\n     final ProcedureEvent<?>[] events = new ProcedureEvent[regions.size()];\n     final long st = System.currentTimeMillis();\n \n-    if (plan == null) {\n-      throw new HBaseIOException(\"unable to compute plans for regions=\" + regions.size());\n-    }\n-\n     if (plan.isEmpty()) {\n-      return;\n+      throw new HBaseIOException(\"unable to compute plans for regions=\" + regions.size());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc5NjU5NA=="}, "originalCommit": {"oid": "86275542f37d997544abe1fcddc704cec065c4ed"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjkxMTM3Ng==", "bodyText": "Oh, just saw the 'plan == null' in the old code. This is a bit strange as the plan is a function parameter, but anyway, not your fault.", "url": "https://github.com/apache/hbase/pull/2450#discussion_r502911376", "createdAt": "2020-10-11T12:49:46Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/AssignmentManager.java", "diffHunk": "@@ -2150,12 +2150,8 @@ private void acceptPlan(final HashMap<RegionInfo, RegionStateNode> regions,\n     final ProcedureEvent<?>[] events = new ProcedureEvent[regions.size()];\n     final long st = System.currentTimeMillis();\n \n-    if (plan == null) {\n-      throw new HBaseIOException(\"unable to compute plans for regions=\" + regions.size());\n-    }\n-\n     if (plan.isEmpty()) {\n-      return;\n+      throw new HBaseIOException(\"unable to compute plans for regions=\" + regions.size());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc5NjU5NA=="}, "originalCommit": {"oid": "86275542f37d997544abe1fcddc704cec065c4ed"}, "originalPosition": 10}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2512, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}