{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4ODYwMjI1", "number": 2644, "title": "HBASE-25127 Enhance PerformanceEvaluation to profile meta replica performance.", "bodyText": "", "createdAt": "2020-11-11T00:39:35Z", "url": "https://github.com/apache/hbase/pull/2644", "merged": true, "mergeCommit": {"oid": "4ee22704528844ac6f9a914fa8fa56d89ddd279a"}, "closed": true, "closedAt": "2020-11-14T18:45:43Z", "author": {"login": "clarax"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdH5gVsgH2gAyNTE4ODYwMjI1OmYzMDQwMDU2NTQzYjAyYTkxMjZmODE1ZWNhMWZhMTNmMzJjMzZlNWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdcRO7CAH2gAyNTE4ODYwMjI1OmRiNWRiODQ4MjdjMjI4NGRmOGU3NzhlOWYyNGU5ZDk5MzE1NWViOTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f3040056543b02a9126f815eca1fa13f32c36e5b", "author": {"user": {"login": "clarax", "name": null}}, "url": "https://github.com/apache/hbase/commit/f3040056543b02a9126f815eca1fa13f32c36e5b", "committedDate": "2020-09-11T18:14:37Z", "message": "HBASE-25006 Make the cost functions optional for StochastoicBalancer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a9cec9154a0a9cc67b9f4207e0de09aadd00206", "author": {"user": {"login": "clarax", "name": null}}, "url": "https://github.com/apache/hbase/commit/4a9cec9154a0a9cc67b9f4207e0de09aadd00206", "committedDate": "2020-11-11T00:34:18Z", "message": "Revert \"HBASE-25006 Make the cost functions optional for StochastoicBalancer\"\n\nThis reverts commit f3040056543b02a9126f815eca1fa13f32c36e5b."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c07a388612f2a9ac759f4698859e35acff9ec341", "author": {"user": {"login": "clarax", "name": null}}, "url": "https://github.com/apache/hbase/commit/c07a388612f2a9ac759f4698859e35acff9ec341", "committedDate": "2020-11-11T00:35:07Z", "message": "Merge remote-tracking branch 'upstream/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29a3d0dab81097c8e56cfe6003028b9753100349", "author": {"user": {"login": "clarax", "name": null}}, "url": "https://github.com/apache/hbase/commit/29a3d0dab81097c8e56cfe6003028b9753100349", "committedDate": "2020-11-11T00:37:38Z", "message": "HBASE-25127 add meta write and read tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3Nzg2NzM2", "url": "https://github.com/apache/hbase/pull/2644#pullrequestreview-527786736", "createdAt": "2020-11-11T01:50:48Z", "commit": {"oid": "29a3d0dab81097c8e56cfe6003028b9753100349"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwMTo1MDo0OVrOHw38Fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwMTo1MTozNlrOHw3-Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxMDE5OQ==", "bodyText": "the return value is not used?", "url": "https://github.com/apache/hbase/pull/2644#discussion_r521010199", "createdAt": "2020-11-11T01:50:49Z", "author": {"login": "Apache9"}, "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java", "diffHunk": "@@ -1998,6 +2006,41 @@ protected void testTakedown() throws IOException {\n       super.testTakedown();\n     }\n   }\n+  static class MetaRandomReadTest extends TableTest {\n+    private Random rd = new Random();\n+    private RegionLocator regionLocator;\n+\n+    MetaRandomReadTest(Connection con, TestOptions options, Status status) {\n+      super(con, options, status);\n+      LOG.info(\"call getRegionLocation\");\n+    }\n+\n+    @Override\n+    void onStartup() throws IOException {\n+      this.table = connection.getTable(TableName.valueOf(\"hbase:meta\"));\n+      this.regionLocator = connection.getRegionLocator(TableName.valueOf(\"hbase:meta\"));\n+    }\n+\n+    @Override\n+    boolean testRow(final int i, final long startTime) throws IOException, InterruptedException {\n+      if (opts.randomSleep > 0) {\n+        Thread.sleep(rd.nextInt(opts.randomSleep));\n+      }\n+      HRegionLocation hRegionLocation = regionLocator.getRegionLocation(Bytes.toBytes(Integer.toString(rd.nextInt(100) + 1)), true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29a3d0dab81097c8e56cfe6003028b9753100349"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTAxMDc2Mg==", "bodyText": "This will be a bit confusing that we add \"hbase:meta\" to hbase:meta?", "url": "https://github.com/apache/hbase/pull/2644#discussion_r521010762", "createdAt": "2020-11-11T01:51:36Z", "author": {"login": "Apache9"}, "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java", "diffHunk": "@@ -2276,7 +2319,38 @@ boolean testRow(final int i, final long startTime) throws IOException {\n       return true;\n     }\n   }\n+  static class MetaWriteTest extends Test {\n+\n+    MetaWriteTest(Connection con, TestOptions options, Status status) {\n+      super(con, options, status);\n+    }\n+\n+    @Override\n+    void onStartup() throws IOException {\n+    }\n \n+    @Override\n+    void onTakedown() throws IOException {\n+    }\n+    @Override\n+    boolean testRow(final int i, final long startTime) throws IOException {\n+      List<RegionInfo> regionInfos = new ArrayList<RegionInfo>();\n+\n+      for (int index = 0; index < i; index++) {\n+        regionInfos.add(RegionInfoBuilder.newBuilder(TableName.valueOf(\"hbase:meta\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29a3d0dab81097c8e56cfe6003028b9753100349"}, "originalPosition": 100}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NDgxMjE0", "url": "https://github.com/apache/hbase/pull/2644#pullrequestreview-528481214", "createdAt": "2020-11-11T19:42:59Z", "commit": {"oid": "29a3d0dab81097c8e56cfe6003028b9753100349"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxOTo0Mjo1OVrOHxbtWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxOTo0Mjo1OVrOHxbtWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5NjI0OA==", "bodyText": "We do not need to set region id, builder will fill it internally, same for offline(), repilcaId, split bit.\nWe do need to set the startKey and endKey correctly to make sure that there is no overlay for regions. I think it is only one region if startKey and endKey are same.\nWe need to use the following as an example, it will insert about 11m entries to metatable, which has the continuous key space.\nbyte[5] startKey, endKey;\nfor (byte b1 = 'a'; b1 <= 'z'; b1++) {\nstartKey[0] = b1;\nendKey[0] = b1;\nfor (byte b2 = 'a'; b2 <= 'z'; b2++) {\nstartKey[1] = b2;\nendKey[1] = b2;\nfor (byte b3 = 'a'; b3 <= 'z'; b3++) {\nstartKey[2] = b3;\nendKey[2] = b3;\nfor (byte b4 = 'a'; b4 <= 'z'; b4++) {\nstartKey[3] = b4;\nendKey[3] = b4;\nfor (byte b5 = 'a'; b5 <= 'z'; b5++) {\nendKey[4] = b5;\nif (b5 == 'a') {\nstartKey[4] = '';\n}\n// TODO: add to Meta\nstartKey[4] = endKey[4];\n}\n}\n}\n}", "url": "https://github.com/apache/hbase/pull/2644#discussion_r521596248", "createdAt": "2020-11-11T19:42:59Z", "author": {"login": "huaxiangsun"}, "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java", "diffHunk": "@@ -2276,7 +2319,38 @@ boolean testRow(final int i, final long startTime) throws IOException {\n       return true;\n     }\n   }\n+  static class MetaWriteTest extends Test {\n+\n+    MetaWriteTest(Connection con, TestOptions options, Status status) {\n+      super(con, options, status);\n+    }\n+\n+    @Override\n+    void onStartup() throws IOException {\n+    }\n \n+    @Override\n+    void onTakedown() throws IOException {\n+    }\n+    @Override\n+    boolean testRow(final int i, final long startTime) throws IOException {\n+      List<RegionInfo> regionInfos = new ArrayList<RegionInfo>();\n+\n+      for (int index = 0; index < i; index++) {\n+        regionInfos.add(RegionInfoBuilder.newBuilder(TableName.valueOf(\"hbase:meta\"))\n+          .setRegionId(this.rand.nextLong())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29a3d0dab81097c8e56cfe6003028b9753100349"}, "originalPosition": 101}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d01acd7833bcebaa817c883020edab99c7a7bab", "author": {"user": {"login": "clarax", "name": null}}, "url": "https://github.com/apache/hbase/commit/6d01acd7833bcebaa817c883020edab99c7a7bab", "committedDate": "2020-11-13T22:40:08Z", "message": "PR review feedback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "207f6485db168f6184654e161470d3dee22a449f", "author": {"user": {"login": "clarax", "name": null}}, "url": "https://github.com/apache/hbase/commit/207f6485db168f6184654e161470d3dee22a449f", "committedDate": "2020-11-13T20:12:40Z", "message": "PR review feedback"}, "afterCommit": {"oid": "6d01acd7833bcebaa817c883020edab99c7a7bab", "author": {"user": {"login": "clarax", "name": null}}, "url": "https://github.com/apache/hbase/commit/6d01acd7833bcebaa817c883020edab99c7a7bab", "committedDate": "2020-11-13T22:40:08Z", "message": "PR review feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNTAxNTQ1", "url": "https://github.com/apache/hbase/pull/2644#pullrequestreview-530501545", "createdAt": "2020-11-14T00:47:23Z", "commit": {"oid": "207f6485db168f6184654e161470d3dee22a449f"}, "state": "APPROVED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwMDo0ODo0MFrOHzD5NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwMDo1NjoyNVrOHzD-wA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzMwMzIyMQ==", "bodyText": "Do we want to tie this to the new cleanMeta? i.e. in the help text here say cleanMeta cleans up the writes done by this test run?", "url": "https://github.com/apache/hbase/pull/2644#discussion_r523303221", "createdAt": "2020-11-14T00:48:40Z", "author": {"login": "saintstack"}, "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java", "diffHunk": "@@ -187,11 +192,12 @@\n       \"Run sequential read test\");\n     addCommandDescriptor(SequentialWriteTest.class, \"sequentialWrite\",\n       \"Run sequential write test\");\n-    addCommandDescriptor(ScanTest.class, \"scan\",\n-      \"Run scan test (read every row)\");\n+    addCommandDescriptor(MetaWriteTest.class, \"metaWrite\",\n+      \"Run addRegion test to populate meta table; used with 1 thread\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d01acd7833bcebaa817c883020edab99c7a7bab"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzMwMzI1MQ==", "bodyText": "No harm in a class comment?", "url": "https://github.com/apache/hbase/pull/2644#discussion_r523303251", "createdAt": "2020-11-14T00:48:54Z", "author": {"login": "saintstack"}, "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java", "diffHunk": "@@ -1481,6 +1489,28 @@ void onTakedown() throws IOException {\n     }\n   }\n \n+  static abstract class MetaTest extends TableTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d01acd7833bcebaa817c883020edab99c7a7bab"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzMwMzUwOQ==", "bodyText": "Add empty line above? Class comment on what this does?", "url": "https://github.com/apache/hbase/pull/2644#discussion_r523303509", "createdAt": "2020-11-14T00:49:57Z", "author": {"login": "saintstack"}, "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java", "diffHunk": "@@ -1998,6 +2028,45 @@ protected void testTakedown() throws IOException {\n       super.testTakedown();\n     }\n   }\n+  static class MetaRandomReadTest extends MetaTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d01acd7833bcebaa817c883020edab99c7a7bab"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzMwNDM0Ng==", "bodyText": "No need of the if debug test... use parameterized logging... \"Get location for {}\", hRegionLocation.... no need of 'region' in log message.", "url": "https://github.com/apache/hbase/pull/2644#discussion_r523304346", "createdAt": "2020-11-14T00:54:47Z", "author": {"login": "saintstack"}, "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java", "diffHunk": "@@ -1998,6 +2028,45 @@ protected void testTakedown() throws IOException {\n       super.testTakedown();\n     }\n   }\n+  static class MetaRandomReadTest extends MetaTest {\n+    private Random rd = new Random();\n+    private RegionLocator regionLocator;\n+\n+    MetaRandomReadTest(Connection con, TestOptions options, Status status) {\n+      super(con, options, status);\n+      LOG.info(\"call getRegionLocation\");\n+    }\n+\n+    @Override\n+    void onStartup() throws IOException {\n+      super.onStartup();\n+      this.regionLocator = connection.getRegionLocator(table.getName());\n+    }\n+\n+    @Override\n+    boolean testRow(final int i, final long startTime) throws IOException, InterruptedException {\n+      if (opts.randomSleep > 0) {\n+        Thread.sleep(rd.nextInt(opts.randomSleep));\n+      }\n+      HRegionLocation hRegionLocation = regionLocator.getRegionLocation(\n+        getSplitKey(rd.nextInt(opts.perClientRunRows)), true);\n+      if (LOG.isDebugEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d01acd7833bcebaa817c883020edab99c7a7bab"}, "originalPosition": 124}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzMwNDQyNA==", "bodyText": "No harm in class comment on what this does.", "url": "https://github.com/apache/hbase/pull/2644#discussion_r523304424", "createdAt": "2020-11-14T00:55:11Z", "author": {"login": "saintstack"}, "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java", "diffHunk": "@@ -2188,6 +2257,32 @@ boolean testRow(final int i, final long startTime) throws IOException {\n     }\n   }\n \n+  static class CleanMetaTest extends MetaTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d01acd7833bcebaa817c883020edab99c7a7bab"}, "originalPosition": 148}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzMwNDU2NA==", "bodyText": "No need of test for isdebug if parameterized logging.", "url": "https://github.com/apache/hbase/pull/2644#discussion_r523304564", "createdAt": "2020-11-14T00:55:58Z", "author": {"login": "saintstack"}, "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java", "diffHunk": "@@ -2188,6 +2257,32 @@ boolean testRow(final int i, final long startTime) throws IOException {\n     }\n   }\n \n+  static class CleanMetaTest extends MetaTest {\n+    CleanMetaTest(Connection con, TestOptions options, Status status) {\n+      super(con, options, status);\n+    }\n+\n+    @Override\n+    boolean testRow(final int i, final long startTime) throws IOException {\n+      try {\n+        RegionInfo regionInfo = connection.getRegionLocator(table.getName())\n+          .getRegionLocation(getSplitKey(i), false).getRegion();\n+        if (LOG.isDebugEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d01acd7833bcebaa817c883020edab99c7a7bab"}, "originalPosition": 158}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzMwNDY0MA==", "bodyText": "Add empty line above and class comment.", "url": "https://github.com/apache/hbase/pull/2644#discussion_r523304640", "createdAt": "2020-11-14T00:56:25Z", "author": {"login": "saintstack"}, "path": "hbase-mapreduce/src/test/java/org/apache/hadoop/hbase/PerformanceEvaluation.java", "diffHunk": "@@ -2276,7 +2371,29 @@ boolean testRow(final int i, final long startTime) throws IOException {\n       return true;\n     }\n   }\n+  static class MetaWriteTest extends MetaTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d01acd7833bcebaa817c883020edab99c7a7bab"}, "originalPosition": 181}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db5db84827c2284df8e778e9f24e9d993155eb95", "author": {"user": {"login": "clarax", "name": null}}, "url": "https://github.com/apache/hbase/commit/db5db84827c2284df8e778e9f24e9d993155eb95", "committedDate": "2020-11-14T01:11:48Z", "message": "style update"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1917, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}