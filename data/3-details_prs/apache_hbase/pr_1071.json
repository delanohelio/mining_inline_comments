{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0NTIyNTg2", "number": 1071, "title": "HBASE-23693 Split failure may cause region hole and data loss when use zk assign", "bodyText": "https://issues.apache.org/jira/browse/HBASE-23693", "createdAt": "2020-01-19T11:01:24Z", "url": "https://github.com/apache/hbase/pull/1071", "merged": true, "mergeCommit": {"oid": "f99e899ca3a6d28d935793a42af16c527e8e0d87"}, "closed": true, "closedAt": "2020-02-10T16:57:31Z", "author": {"login": "thangTang"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8EvqeABqjI5NjE1MzEyODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9bbm1AFqTM0NzgyODE5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "67526c66e6a59dd4ce0c504b8ad5c7511e96beb4", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/67526c66e6a59dd4ce0c504b8ad5c7511e96beb4", "committedDate": "2020-01-19T10:58:43Z", "message": "HBASE-23693 Split failure may cause region hole and data loss when use zk assign"}, "afterCommit": {"oid": "53de65e1bc1c9620cf2b372a658cde488321bcb6", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/53de65e1bc1c9620cf2b372a658cde488321bcb6", "committedDate": "2020-01-20T04:18:43Z", "message": "HBASE-23693 Split failure may cause region hole and data loss when use zk assign"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3b12c43a34c5ea0cde219ea0a4d16682298f59c", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/b3b12c43a34c5ea0cde219ea0a4d16682298f59c", "committedDate": "2020-01-20T08:55:57Z", "message": "HBASE-23693 Split failure may cause region hole and data loss when use zk assign"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "53de65e1bc1c9620cf2b372a658cde488321bcb6", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/53de65e1bc1c9620cf2b372a658cde488321bcb6", "committedDate": "2020-01-20T04:18:43Z", "message": "HBASE-23693 Split failure may cause region hole and data loss when use zk assign"}, "afterCommit": {"oid": "b3b12c43a34c5ea0cde219ea0a4d16682298f59c", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/b3b12c43a34c5ea0cde219ea0a4d16682298f59c", "committedDate": "2020-01-20T08:55:57Z", "message": "HBASE-23693 Split failure may cause region hole and data loss when use zk assign"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MjQyMDE0", "url": "https://github.com/apache/hbase/pull/1071#pullrequestreview-345242014", "createdAt": "2020-01-20T11:23:00Z", "commit": {"oid": "b3b12c43a34c5ea0cde219ea0a4d16682298f59c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxMToyMzowMFrOFfbRRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxMjoyMjoyM1rOFfcrZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ5Njk2Nw==", "bodyText": "Is it really entering this block? My understanding is that parent region would be in OFFLINE state and SPLIT=true after createDaughters call completed inside SplitTransactionImpl.execute.", "url": "https://github.com/apache/hbase/pull/1071#discussion_r368496967", "createdAt": "2020-01-20T11:23:00Z", "author": {"login": "wchevreuil"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/RegionStates.java", "diffHunk": "@@ -758,8 +764,20 @@ public void regionOffline(\n             // Delete the ZNode if exists\n             ZKAssign.deleteNodeFailSilent(watcher, region);\n             regionsToOffline.add(region);\n+            PairOfSameType<HRegionInfo> daughterRegions =\n+              MetaTableAccessor.getDaughterRegionsFromParent(this.server.getConnection(), region);\n+            if (daughterRegions != null) {\n+              if (daughterRegions.getFirst() != null) {\n+                daughter2Parent.put(daughterRegions.getFirst().getEncodedName(), region);\n+              }\n+              if (daughterRegions.getSecond() != null) {\n+                daughter2Parent.put(daughterRegions.getSecond().getEncodedName(), region);\n+              }\n+            }\n           } catch (KeeperException ke) {\n             server.abort(\"Unexpected ZK exception deleting node \" + region, ke);\n+          } catch (IOException e) {\n+            LOG.warn(\"get daughter from meta exception \" + region, e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3b12c43a34c5ea0cde219ea0a4d16682298f59c"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUyMDAzNw==", "bodyText": "Oh, so parent is OFFLINE and SPLIT=true in meta only, but not in assignedRegions? Sounds wrong that we marked parent as OFFLINE and SPLIT even when splitting was still not entirely complete.", "url": "https://github.com/apache/hbase/pull/1071#discussion_r368520037", "createdAt": "2020-01-20T12:22:23Z", "author": {"login": "wchevreuil"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/RegionStates.java", "diffHunk": "@@ -783,10 +801,20 @@ public void regionOffline(\n             LOG.info(\"Found region in \" + state +\n               \" to be reassigned by ServerCrashProcedure for \" + sn);\n             rits.add(hri);\n-          } else if(state.isSplittingNew() || state.isMergingNew()) {\n-            LOG.info(\"Offline/Cleanup region if no meta entry exists, hri: \" + hri +\n-                \" state: \" + state);\n-            regionsToClean.add(state.getRegion());\n+          } else if (state.isSplittingNew() || state.isMergingNew()) {\n+            LOG.info(\n+              \"Offline/Cleanup region if no meta entry exists, hri: \" + hri + \" state: \" + state);\n+            if (daughter2Parent.containsKey(hri.getEncodedName())) {\n+              HRegionInfo parent = daughter2Parent.get(hri.getEncodedName());\n+              HRegionInfo info = getHRIFromMeta(parent);\n+              if (info != null && info.isSplit() && info.isOffline()) {\n+                regionsToClean.add(Pair.newPair(state.getRegion(), info));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3b12c43a34c5ea0cde219ea0a4d16682298f59c"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NDQxMzY5", "url": "https://github.com/apache/hbase/pull/1071#pullrequestreview-345441369", "createdAt": "2020-01-20T17:01:46Z", "commit": {"oid": "b3b12c43a34c5ea0cde219ea0a4d16682298f59c"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNzowMTo0NlrOFfkrzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNzowNDoxOFrOFfkwcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY1MTIxMw==", "bodyText": "Suggest this needs more comment on why we need this accounting in daughter2Parent.", "url": "https://github.com/apache/hbase/pull/1071#discussion_r368651213", "createdAt": "2020-01-20T17:01:46Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/RegionStates.java", "diffHunk": "@@ -737,11 +741,13 @@ public void regionOffline(\n   public List<HRegionInfo> serverOffline(final ZooKeeperWatcher watcher, final ServerName sn) {\n     // Offline all regions on this server not already in transition.\n     List<HRegionInfo> rits = new ArrayList<HRegionInfo>();\n-    Set<HRegionInfo> regionsToClean = new HashSet<HRegionInfo>();\n+    Set<Pair<HRegionInfo, HRegionInfo>> regionsToClean =\n+      new HashSet<Pair<HRegionInfo, HRegionInfo>>();\n     // Offline regions outside the loop and synchronized block to avoid\n     // ConcurrentModificationException and deadlock in case of meta anassigned,\n     // but RegionState a blocked.\n     Set<HRegionInfo> regionsToOffline = new HashSet<HRegionInfo>();\n+    Map<String, HRegionInfo> daughter2Parent = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3b12c43a34c5ea0cde219ea0a4d16682298f59c"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY1MjQwMA==", "bodyText": "This daughter2Parent added stingency makes sense to me. Nice.", "url": "https://github.com/apache/hbase/pull/1071#discussion_r368652400", "createdAt": "2020-01-20T17:04:18Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/RegionStates.java", "diffHunk": "@@ -783,10 +801,20 @@ public void regionOffline(\n             LOG.info(\"Found region in \" + state +\n               \" to be reassigned by ServerCrashProcedure for \" + sn);\n             rits.add(hri);\n-          } else if(state.isSplittingNew() || state.isMergingNew()) {\n-            LOG.info(\"Offline/Cleanup region if no meta entry exists, hri: \" + hri +\n-                \" state: \" + state);\n-            regionsToClean.add(state.getRegion());\n+          } else if (state.isSplittingNew() || state.isMergingNew()) {\n+            LOG.info(\n+              \"Offline/Cleanup region if no meta entry exists, hri: \" + hri + \" state: \" + state);\n+            if (daughter2Parent.containsKey(hri.getEncodedName())) {\n+              HRegionInfo parent = daughter2Parent.get(hri.getEncodedName());\n+              HRegionInfo info = getHRIFromMeta(parent);\n+              if (info != null && info.isSplit() && info.isOffline()) {\n+                regionsToClean.add(Pair.newPair(state.getRegion(), info));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODUyMDAzNw=="}, "originalCommit": {"oid": "b3b12c43a34c5ea0cde219ea0a4d16682298f59c"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3ODI4MTkw", "url": "https://github.com/apache/hbase/pull/1071#pullrequestreview-347828190", "createdAt": "2020-01-24T09:21:54Z", "commit": {"oid": "b3b12c43a34c5ea0cde219ea0a4d16682298f59c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3005, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}