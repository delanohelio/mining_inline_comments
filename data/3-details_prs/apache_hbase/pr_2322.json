{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0NzcxMDA0", "number": 2322, "title": "[HBASE-24956] ConnectionManager#locateRegionInMeta waits for user region lock indefinitely.", "bodyText": "", "createdAt": "2020-08-27T15:15:35Z", "url": "https://github.com/apache/hbase/pull/2322", "merged": true, "mergeCommit": {"oid": "7fe07e90ebf1e7ff742583663f5d29f3b34ee3af"}, "closed": true, "closedAt": "2020-09-17T16:26:36Z", "author": {"login": "shahrs87"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdC2p3QgH2gAyNDc0NzcxMDA0OjNhNzk1ZGJiZWIwNDgxOGY4MzYzYTUwZDcxOGExMzIyNjhiNWZmY2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJRqaeAFqTQ4OTIwMjQ4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3a795dbbeb04818f8363a50d718a132268b5ffcd", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/3a795dbbeb04818f8363a50d718a132268b5ffcd", "committedDate": "2020-08-27T02:05:41Z", "message": "[HBASE-24956] ConnectionManager#locateRegionInMeta waits for user region lock indefinitely."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e72cffb75029f70ea83737fb26e8ed47696fcd4", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/2e72cffb75029f70ea83737fb26e8ed47696fcd4", "committedDate": "2020-08-27T15:40:24Z", "message": "Merge branch 'branch-2' of https://github.com/apache/hbase into HBASE-24956"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94f2de8e052ae71a652983f593231169b5371b6a", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/94f2de8e052ae71a652983f593231169b5371b6a", "committedDate": "2020-08-27T15:50:28Z", "message": "[HBASE-24956] Fixing errors pointed by apache hbase bot."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2OTc0NjI4", "url": "https://github.com/apache/hbase/pull/2322#pullrequestreview-476974628", "createdAt": "2020-08-27T18:23:56Z", "commit": {"oid": "94f2de8e052ae71a652983f593231169b5371b6a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxODoyMzo1NlrOHIcKmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxODoyMzo1NlrOHIcKmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYxMjEyMw==", "bodyText": "Make this subclass HBaseIOException rather than IOException?", "url": "https://github.com/apache/hbase/pull/2322#discussion_r478612123", "createdAt": "2020-08-27T18:23:56Z", "author": {"login": "saintstack"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/LockTimeoutException.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/**\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.client;\n+\n+import java.io.IOException;\n+import org.apache.yetus.audience.InterfaceAudience;\n+\n+/*\n+  Thrown whenever we are not able to get the lock within the specified wait time.\n+ */\n+@InterfaceAudience.Public\n+public class LockTimeoutException extends IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94f2de8e052ae71a652983f593231169b5371b6a"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MDcwNzc4", "url": "https://github.com/apache/hbase/pull/2322#pullrequestreview-477070778", "createdAt": "2020-08-27T20:49:46Z", "commit": {"oid": "94f2de8e052ae71a652983f593231169b5371b6a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMDo0OTo0NlrOHIgwbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMDo0OTo0NlrOHIgwbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY4NzM0MQ==", "bodyText": "@saintstack Rushabh and I had a quick offline chat about this PR. We were wondering what is the right timeout to use for this lock. In the client code path there are a bunch of time out configurations depending on the path we take and sometimes layered on top of each other.\nSpecifically I was wondering if hbase.client.operation.timeout would be the right one to use for this. I understand that we are using the scanner timeout here because the call wraps a scanner with the same timeout. From a client standpoint though, scanner is just an implementation detail of locateRegion (root caller in this case) and that root caller should be wrapped with a general operation timeout rather than a timeout that is specific to the scanner.\nNot a big deal but I was just curious and would like to know your thoughts. Thanks.", "url": "https://github.com/apache/hbase/pull/2322#discussion_r478687341", "createdAt": "2020-08-27T20:49:46Z", "author": {"login": "bharathv"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/ConnectionImplementation.java", "diffHunk": "@@ -968,6 +968,19 @@ private RegionLocations locateRegionInMeta(TableName tableName, byte[] row, bool\n     }\n   }\n \n+  private void takeUserRegionLock() throws IOException {\n+    try {\n+      long waitTime = connectionConfig.getScannerTimeoutPeriod();\n+      if (!userRegionLock.tryLock(waitTime, TimeUnit.MILLISECONDS)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94f2de8e052ae71a652983f593231169b5371b6a"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "541b33b8cc30c903eb1a89a4109083e87f279d3d", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/541b33b8cc30c903eb1a89a4109083e87f279d3d", "committedDate": "2020-08-27T21:16:49Z", "message": "[HBASE-24956] Address CR and fix checkstyle warnings."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3OTA3OTU0", "url": "https://github.com/apache/hbase/pull/2322#pullrequestreview-477907954", "createdAt": "2020-08-28T17:31:00Z", "commit": {"oid": "541b33b8cc30c903eb1a89a4109083e87f279d3d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d184c89f8d0363aac1802c6d8d4c7973d9e1d5ed", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/d184c89f8d0363aac1802c6d8d4c7973d9e1d5ed", "committedDate": "2020-08-28T21:21:20Z", "message": "[HBASE-24956] Missed hunks."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MDMzNzcw", "url": "https://github.com/apache/hbase/pull/2322#pullrequestreview-478033770", "createdAt": "2020-08-28T21:24:19Z", "commit": {"oid": "d184c89f8d0363aac1802c6d8d4c7973d9e1d5ed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQyMToyNDoxOVrOHJU23g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQyMToyNDoxOVrOHJU23g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU0MDk1OA==", "bodyText": "On my local system I created patch for this on top of 1.3 branch but while porting the patch to branch-2, I missed applying this hunk.\n@saintstack  @apurtell  Since you guys already +1 the previous diff, wanted to bring this change to your attention. Sorry for confusion.\nCc @bharathv  @infraio", "url": "https://github.com/apache/hbase/pull/2322#discussion_r479540958", "createdAt": "2020-08-28T21:24:19Z", "author": {"login": "shahrs87"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/ConnectionImplementation.java", "diffHunk": "@@ -863,13 +863,15 @@ private RegionLocations locateRegionInMeta(TableName tableName, byte[] row, bool\n       }\n       // Query the meta region\n       long pauseBase = this.pause;\n-      userRegionLock.lock();\n+      takeUserRegionLock();\n       try {\n-        if (useCache) {// re-check cache after get lock\n-          RegionLocations locations = getCachedLocation(tableName, row);\n-          if (locations != null && locations.getRegionLocation(replicaId) != null) {\n-            return locations;\n-          }\n+        // We don't need to check if useCache is enabled or not. Even if useCache is false", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d184c89f8d0363aac1802c6d8d4c7973d9e1d5ed"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MDc1NTA1", "url": "https://github.com/apache/hbase/pull/2322#pullrequestreview-478075505", "createdAt": "2020-08-28T23:53:21Z", "commit": {"oid": "d184c89f8d0363aac1802c6d8d4c7973d9e1d5ed"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQyMzo1MzoyMVrOHJXHGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOVQwMDoxNjoxM1rOHJXV5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU3Nzg4Mw==", "bodyText": "static getInt() is deprecated, switch to conf.getInt()?", "url": "https://github.com/apache/hbase/pull/2322#discussion_r479577883", "createdAt": "2020-08-28T23:53:21Z", "author": {"login": "bharathv"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/ConnectionConfiguration.java", "diffHunk": "@@ -117,6 +119,11 @@\n \n     this.writeRpcTimeout = conf.getInt(HConstants.HBASE_RPC_WRITE_TIMEOUT_KEY,\n         conf.getInt(HConstants.HBASE_RPC_TIMEOUT_KEY, HConstants.DEFAULT_HBASE_RPC_TIMEOUT));\n+\n+    this.scannerTimeoutPeriod = HBaseConfiguration.getInt(conf,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d184c89f8d0363aac1802c6d8d4c7973d9e1d5ed"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MDkzMQ==", "bodyText": "operation timeout is for 'whole operation end-to-end'\n\nIn that case IMO the right fix is to extend the operation timeout to all public methods of HTable (may or may not be a part of this change). Looking at the code, we do it for some and we skip it for others. One of those methods is locateRegion() which is the root caller in this case.\nMy concern was from a user configuration POV, there 3 or 4 different timeouts a user has to configure (depending on which API they are using) to get a proper timeout behavior. Ideally it'd be nice if there is a single timeout at the root level that is an e-e timeout and probably other timeouts like scanner timeout etc for finer control depending on the need.\nDon't mean to block this PR, we can probably implement that as a separate change.", "url": "https://github.com/apache/hbase/pull/2322#discussion_r479580931", "createdAt": "2020-08-29T00:11:17Z", "author": {"login": "bharathv"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/ConnectionImplementation.java", "diffHunk": "@@ -968,6 +968,19 @@ private RegionLocations locateRegionInMeta(TableName tableName, byte[] row, bool\n     }\n   }\n \n+  private void takeUserRegionLock() throws IOException {\n+    try {\n+      long waitTime = connectionConfig.getScannerTimeoutPeriod();\n+      if (!userRegionLock.tryLock(waitTime, TimeUnit.MILLISECONDS)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODY4NzM0MQ=="}, "originalCommit": {"oid": "94f2de8e052ae71a652983f593231169b5371b6a"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4MTY2OA==", "bodyText": "need to be public?", "url": "https://github.com/apache/hbase/pull/2322#discussion_r479581668", "createdAt": "2020-08-29T00:16:13Z", "author": {"login": "bharathv"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/LockTimeoutException.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/**\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.client;\n+\n+import org.apache.hadoop.hbase.HBaseIOException;\n+import org.apache.yetus.audience.InterfaceAudience;\n+\n+/*\n+  Thrown whenever we are not able to get the lock within the specified wait time.\n+ */\n+@InterfaceAudience.Public", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d184c89f8d0363aac1802c6d8d4c7973d9e1d5ed"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3210c8908809fa154118454e6a23f57bc222db1", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/f3210c8908809fa154118454e6a23f57bc222db1", "committedDate": "2020-08-30T02:55:06Z", "message": "[HBASE-24956] Addressing CR comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cd6f9542b97f8163e6f3e23f66f2edee4b5f8ef", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/4cd6f9542b97f8163e6f3e23f66f2edee4b5f8ef", "committedDate": "2020-08-31T16:07:04Z", "message": "Merge branch 'branch-2' of https://github.com/apache/hbase into HBASE-24956"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwOTA0MTQ0", "url": "https://github.com/apache/hbase/pull/2322#pullrequestreview-480904144", "createdAt": "2020-09-02T14:53:17Z", "commit": {"oid": "f3210c8908809fa154118454e6a23f57bc222db1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7c71147fe47b73ebca74e264cfac14cbf2f1211", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/b7c71147fe47b73ebca74e264cfac14cbf2f1211", "committedDate": "2020-09-08T21:05:50Z", "message": "Merge branch 'branch-2' of https://github.com/apache/hbase into HBASE-24956"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57d680a27bfc3b0b4cc5dc4729a2bc2d0529a367", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/57d680a27bfc3b0b4cc5dc4729a2bc2d0529a367", "committedDate": "2020-09-10T03:47:18Z", "message": "[HBASE-24956] Addressing CR comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58cb1cdaba1dbf952647934be0f34b4bad2e71db", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/58cb1cdaba1dbf952647934be0f34b4bad2e71db", "committedDate": "2020-09-10T03:47:24Z", "message": "Merge branch 'branch-2' of https://github.com/apache/hbase into HBASE-24956"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NjIyMzA4", "url": "https://github.com/apache/hbase/pull/2322#pullrequestreview-485622308", "createdAt": "2020-09-10T06:39:01Z", "commit": {"oid": "58cb1cdaba1dbf952647934be0f34b4bad2e71db"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNjozOTowMVrOHPlIWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNjozOTowMVrOHPlIWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjA5OTAzMg==", "bodyText": "Seems not push the latest commit?", "url": "https://github.com/apache/hbase/pull/2322#discussion_r486099032", "createdAt": "2020-09-10T06:39:01Z", "author": {"login": "infraio"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/ConnectionImplementation.java", "diffHunk": "@@ -968,6 +974,19 @@ private RegionLocations locateRegionInMeta(TableName tableName, byte[] row, bool\n     }\n   }\n \n+  void takeUserRegionLock() throws IOException {\n+    try {\n+      long waitTime = connectionConfig.getScannerTimeoutPeriod();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58cb1cdaba1dbf952647934be0f34b4bad2e71db"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37e306bc46270482e716e5acfc3dc2e9a0d0e437", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/37e306bc46270482e716e5acfc3dc2e9a0d0e437", "committedDate": "2020-09-15T18:33:10Z", "message": "Merge branch 'branch-2' of https://github.com/apache/hbase into HBASE-24956"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be6cda65636c5b3138e63aed40c239a1a1561709", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/be6cda65636c5b3138e63aed40c239a1a1561709", "committedDate": "2020-09-15T21:20:12Z", "message": "[HBASE-24956] Addressing CR comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MjAyNDgx", "url": "https://github.com/apache/hbase/pull/2322#pullrequestreview-489202481", "createdAt": "2020-09-16T00:57:16Z", "commit": {"oid": "be6cda65636c5b3138e63aed40c239a1a1561709"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4700, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}