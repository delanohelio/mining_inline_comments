{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4MTAzMDU0", "number": 2055, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNDo0NDoxMFrOEOSnag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNDo0NDoxMFrOEOSnag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzNDIwNTIyOnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/wal/AsyncProtobufLogWriter.java", "isResolved": false, "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNDo0NDoxMFrOGxXAAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwMzo1Mzo1NlrOG3S0kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQxMDI0Mw==", "bodyText": "Do we really need to make it volatile? IIRC, it will be initialized in the init call and we will always call it when constructing a new ProtobufLogWriter. Make it volatile may cause developer confusing...", "url": "https://github.com/apache/hbase/pull/2055#discussion_r454410243", "createdAt": "2020-07-14T14:44:10Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/wal/AsyncProtobufLogWriter.java", "diffHunk": "@@ -59,7 +59,7 @@\n \n   private final Class<? extends Channel> channelClass;\n \n-  private AsyncFSOutput output;\n+  private volatile AsyncFSOutput output;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91eac7ce9046e5b12ea8226ab1e0d660fa682745"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQxODQ1OA==", "bodyText": "The output would be set to null in AsyncProtobufLogWriter.close and would be used in getSyncedLength method, and seems there is no explicit constraint on which thread could invoke AsyncProtobufLogWriter.close , so here use volatile", "url": "https://github.com/apache/hbase/pull/2055#discussion_r454418458", "createdAt": "2020-07-14T14:54:38Z", "author": {"login": "comnetwork"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/wal/AsyncProtobufLogWriter.java", "diffHunk": "@@ -59,7 +59,7 @@\n \n   private final Class<? extends Channel> channelClass;\n \n-  private AsyncFSOutput output;\n+  private volatile AsyncFSOutput output;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQxMDI0Mw=="}, "originalCommit": {"oid": "91eac7ce9046e5b12ea8226ab1e0d660fa682745"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQzNzA5Mg==", "bodyText": "We will also use output in other methods where we do not test whether it is null, only test it in this method seems a bit confusing...", "url": "https://github.com/apache/hbase/pull/2055#discussion_r454437092", "createdAt": "2020-07-14T15:19:38Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/wal/AsyncProtobufLogWriter.java", "diffHunk": "@@ -59,7 +59,7 @@\n \n   private final Class<? extends Channel> channelClass;\n \n-  private AsyncFSOutput output;\n+  private volatile AsyncFSOutput output;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQxMDI0Mw=="}, "originalCommit": {"oid": "91eac7ce9046e5b12ea8226ab1e0d660fa682745"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc2NDY4MQ==", "bodyText": "Yes, you are right, I ignored other write methods also not test whether output is null. The problem here is it is meaningless to call  AsyncProtobufLogWriter.getSyncedLength after AsyncProtobufLogWriter.close , which indeed occured when  #1970  is applied to branch-2 previously caused by problematic state synchronization.\nIf we do not test whether output is null, we can just leave some comments here.", "url": "https://github.com/apache/hbase/pull/2055#discussion_r454764681", "createdAt": "2020-07-15T03:13:32Z", "author": {"login": "comnetwork"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/wal/AsyncProtobufLogWriter.java", "diffHunk": "@@ -59,7 +59,7 @@\n \n   private final Class<? extends Channel> channelClass;\n \n-  private AsyncFSOutput output;\n+  private volatile AsyncFSOutput output;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQxMDI0Mw=="}, "originalCommit": {"oid": "91eac7ce9046e5b12ea8226ab1e0d660fa682745"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDgxMjAwMQ==", "bodyText": "Oh, then this is another problem? I think it is allowed to call getSyncedLength after closing? We should not throw IllegalStateException...", "url": "https://github.com/apache/hbase/pull/2055#discussion_r454812001", "createdAt": "2020-07-15T06:04:51Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/wal/AsyncProtobufLogWriter.java", "diffHunk": "@@ -59,7 +59,7 @@\n \n   private final Class<? extends Channel> channelClass;\n \n-  private AsyncFSOutput output;\n+  private volatile AsyncFSOutput output;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQxMDI0Mw=="}, "originalCommit": {"oid": "91eac7ce9046e5b12ea8226ab1e0d660fa682745"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkyNzM1Mg==", "bodyText": "Yes ,the  problem description  is :\nhttps://issues.apache.org/jira/browse/HBASE-24625?focusedCommentId=17152610&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17152610\nIn my opinion, AsyncProtobufLogWriter.getSyncedLength is used for WALFileLengthProvider.getLogFileSizeIfBeingWritten and is just meaningful when the WAL file is current writing, once  AsyncProtobufLogWriter is closed(BTW, AsyncProtobufLogWriter.output is null),  upperlayer code seems  no need to call this method, and if upperlayer code still call this method after closed, it may indicates some  synchronization error or other.\nIf we allow to call getSyncedLength after closing, we should save the syncedLength when  AsyncProtobufLogWriter.close , or else getSyncedLength will throw NullPointException or just return 0, both are unexpected and may cause upperlayer code error.", "url": "https://github.com/apache/hbase/pull/2055#discussion_r454927352", "createdAt": "2020-07-15T09:44:48Z", "author": {"login": "comnetwork"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/wal/AsyncProtobufLogWriter.java", "diffHunk": "@@ -59,7 +59,7 @@\n \n   private final Class<? extends Channel> channelClass;\n \n-  private AsyncFSOutput output;\n+  private volatile AsyncFSOutput output;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQxMDI0Mw=="}, "originalCommit": {"oid": "91eac7ce9046e5b12ea8226ab1e0d660fa682745"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjkxOTcxMQ==", "bodyText": "In practise, as we will call getSyncedLength in another thread, it is possible that we call getSyncedLength on a closed writer. Maybe we could introduce another field to save the final length of the file, and in getSyncedLength, we check whether we have this field set, if so we just return the value of this field, otherwise we will go to get output. WDYT?", "url": "https://github.com/apache/hbase/pull/2055#discussion_r456919711", "createdAt": "2020-07-19T15:06:31Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/wal/AsyncProtobufLogWriter.java", "diffHunk": "@@ -59,7 +59,7 @@\n \n   private final Class<? extends Channel> channelClass;\n \n-  private AsyncFSOutput output;\n+  private volatile AsyncFSOutput output;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQxMDI0Mw=="}, "originalCommit": {"oid": "91eac7ce9046e5b12ea8226ab1e0d660fa682745"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzA0MzIxNA==", "bodyText": "@Apache9 , Yes, I agree with you, and would modify PR following your suggestion.\nBTW,  for now, AsyncProtobufLogWriter.getSyncedLength is only used when the WAL file is writing.  AsyncProtobufLogWriter.getSyncedLength  for  closed wrter may be used for future use.", "url": "https://github.com/apache/hbase/pull/2055#discussion_r457043214", "createdAt": "2020-07-20T04:40:55Z", "author": {"login": "comnetwork"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/wal/AsyncProtobufLogWriter.java", "diffHunk": "@@ -59,7 +59,7 @@\n \n   private final Class<? extends Channel> channelClass;\n \n-  private AsyncFSOutput output;\n+  private volatile AsyncFSOutput output;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQxMDI0Mw=="}, "originalCommit": {"oid": "91eac7ce9046e5b12ea8226ab1e0d660fa682745"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY4NDg3MQ==", "bodyText": "@Apache9 , I modify PR to introduce finalSyncedLength to save the syncedLength when AsyncProtobufLogWriter.close.\nBut in getSyncedLength method,  I check whether output is  null  instead of  checking whether finalSyncedLength is set, because I think the statement \"this.output = null;\" in AsyncProtobufLogWriter.close is a  good sync point, if output is null, then finalSyncedLength must set, so we can return finalSyncedLength, else we return output.getSyncedLength.\nIf we use finalSyncedLength as a sync point, it is hard to decide whether the output is null or not.", "url": "https://github.com/apache/hbase/pull/2055#discussion_r458684871", "createdAt": "2020-07-22T10:10:35Z", "author": {"login": "comnetwork"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/wal/AsyncProtobufLogWriter.java", "diffHunk": "@@ -59,7 +59,7 @@\n \n   private final Class<? extends Channel> channelClass;\n \n-  private AsyncFSOutput output;\n+  private volatile AsyncFSOutput output;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQxMDI0Mw=="}, "originalCommit": {"oid": "91eac7ce9046e5b12ea8226ab1e0d660fa682745"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDYzMzIzNQ==", "bodyText": "@Apache9 , please have a review, thanks.", "url": "https://github.com/apache/hbase/pull/2055#discussion_r460633235", "createdAt": "2020-07-27T03:53:56Z", "author": {"login": "comnetwork"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/wal/AsyncProtobufLogWriter.java", "diffHunk": "@@ -59,7 +59,7 @@\n \n   private final Class<? extends Channel> channelClass;\n \n-  private AsyncFSOutput output;\n+  private volatile AsyncFSOutput output;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQxMDI0Mw=="}, "originalCommit": {"oid": "91eac7ce9046e5b12ea8226ab1e0d660fa682745"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2776, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}