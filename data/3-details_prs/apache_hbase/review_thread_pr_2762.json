{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1NzU5NDI0", "number": 2762, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMDoxMjoxMlrOFEShoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQwNjoxMjo1NVrOFQuCew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQwMDQyMTQ0OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMDoxMjoxMlrOIEXNcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMDoxMjoxMlrOIEXNcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ0NTQ4OA==", "bodyText": "500 seems high to me. Would 20 be enough? Should this be a constant in the file, even if not configurable?", "url": "https://github.com/apache/hbase/pull/2762#discussion_r541445488", "createdAt": "2020-12-12T00:12:12Z", "author": {"login": "d-c-manning"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "diffHunk": "@@ -3549,11 +3554,24 @@ public void updateRegionsInTransitionMetrics() {\n       if (oldestRITTime < ritTime) {\n         oldestRITTime = ritTime;\n       }\n+      if (counter < 500) { // Record 500 oldest RITs", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c12786bcd7b5abcf538149c6282c384fbc79e9"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQwMDQ1MDU5OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMDoxOTozOFrOIEXfyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwMjozOTo0MlrOIGp5aQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ1MDE4NQ==", "bodyText": "Why do we update the metrics hashes only if it's been more than ritThreshold / 2 time since last update? If we do the work to find the oldest, it seems like we should update the metrics always. Then any query to get metrics will always have the most recent results (~3 seconds old at max, with default hbase.regionserver.msginterval)\nThough I do think it's a good idea for limiting the logging. Should the LOG.debug statement be in here?\nThen this statement may deserve a comment.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  if ((time - ritThreshold / 2) >= this.lastRITHashMetricUpdate) {\n          \n          \n            \n                  // Only log if it has been long enough since the last update (default 30 seconds)\n          \n          \n            \n                  if ((time - ritThreshold / 2) >= this.lastRITHashMetricUpdate) {", "url": "https://github.com/apache/hbase/pull/2762#discussion_r541450185", "createdAt": "2020-12-12T00:19:38Z", "author": {"login": "d-c-manning"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "diffHunk": "@@ -3549,11 +3554,24 @@ public void updateRegionsInTransitionMetrics() {\n       if (oldestRITTime < ritTime) {\n         oldestRITTime = ritTime;\n       }\n+      if (counter < 500) { // Record 500 oldest RITs\n+        oldestRITHashesAndStates.add(\n+          state.getRegion().getRegionNameAsString() + \":\" + state.getState().name()\n+        );\n+      }\n+      counter += 1;\n     }\n     if (this.metricsAssignmentManager != null) {\n       this.metricsAssignmentManager.updateRITOldestAge(oldestRITTime);\n       this.metricsAssignmentManager.updateRITCount(totalRITs);\n       this.metricsAssignmentManager.updateRITCountOverThreshold(totalRITsOverThreshold);\n+\n+      LOG.debug(\"Oldest RIT hashes and states: \" + oldestRITHashesAndStates.toString());\n+      long time = EnvironmentEdgeManager.currentTime();\n+      if ((time - ritThreshold / 2) >= this.lastRITHashMetricUpdate) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c12786bcd7b5abcf538149c6282c384fbc79e9"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg0ODgwOQ==", "bodyText": "Though I do think it's a good idea for limiting the logging. Should the LOG.debug statement be in here?\n\nyes it is for the reason you stated. will add the comment and move LOG.debug under this condition. maybe the other stuff can be moved outside.", "url": "https://github.com/apache/hbase/pull/2762#discussion_r543848809", "createdAt": "2020-12-16T02:39:42Z", "author": {"login": "caroliney14"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "diffHunk": "@@ -3549,11 +3554,24 @@ public void updateRegionsInTransitionMetrics() {\n       if (oldestRITTime < ritTime) {\n         oldestRITTime = ritTime;\n       }\n+      if (counter < 500) { // Record 500 oldest RITs\n+        oldestRITHashesAndStates.add(\n+          state.getRegion().getRegionNameAsString() + \":\" + state.getState().name()\n+        );\n+      }\n+      counter += 1;\n     }\n     if (this.metricsAssignmentManager != null) {\n       this.metricsAssignmentManager.updateRITOldestAge(oldestRITTime);\n       this.metricsAssignmentManager.updateRITCount(totalRITs);\n       this.metricsAssignmentManager.updateRITCountOverThreshold(totalRITsOverThreshold);\n+\n+      LOG.debug(\"Oldest RIT hashes and states: \" + oldestRITHashesAndStates.toString());\n+      long time = EnvironmentEdgeManager.currentTime();\n+      if ((time - ritThreshold / 2) >= this.lastRITHashMetricUpdate) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ1MDE4NQ=="}, "originalCommit": {"oid": "61c12786bcd7b5abcf538149c6282c384fbc79e9"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQwMDQ1MTExOnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMDoxOTo1NlrOIEXgCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMDoxOTo1NlrOIEXgCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ1MDI0OQ==", "bodyText": "can we just reuse currentTime here from the beginning of the method?", "url": "https://github.com/apache/hbase/pull/2762#discussion_r541450249", "createdAt": "2020-12-12T00:19:56Z", "author": {"login": "d-c-manning"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "diffHunk": "@@ -3549,11 +3554,24 @@ public void updateRegionsInTransitionMetrics() {\n       if (oldestRITTime < ritTime) {\n         oldestRITTime = ritTime;\n       }\n+      if (counter < 500) { // Record 500 oldest RITs\n+        oldestRITHashesAndStates.add(\n+          state.getRegion().getRegionNameAsString() + \":\" + state.getState().name()\n+        );\n+      }\n+      counter += 1;\n     }\n     if (this.metricsAssignmentManager != null) {\n       this.metricsAssignmentManager.updateRITOldestAge(oldestRITTime);\n       this.metricsAssignmentManager.updateRITCount(totalRITs);\n       this.metricsAssignmentManager.updateRITCountOverThreshold(totalRITsOverThreshold);\n+\n+      LOG.debug(\"Oldest RIT hashes and states: \" + oldestRITHashesAndStates.toString());\n+      long time = EnvironmentEdgeManager.currentTime();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c12786bcd7b5abcf538149c6282c384fbc79e9"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQwMDQ3NzMwOnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMDozMjozMlrOIEXtVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMDozMjozMlrOIEXtVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ1MzY1NA==", "bodyText": "since this method uses the state.getStamp() to determine whether the RIT is over the threshold or the oldest time... should we just use getRegionsInTransitionOrderedByTimestamp instead?\nThis new method getRegionsInTransitionOrderedByDuration is tracking total duration instead of duration since last state transition, so the longest RITs may not necessarily be those that are reported over threshold. I think it's probably good to be consistent... I'm not sure which way is better to be consistent, but since these metrics in this method are reporting time since last change instead of total duration, I'd favor that approach.", "url": "https://github.com/apache/hbase/pull/2762#discussion_r541453654", "createdAt": "2020-12-12T00:32:32Z", "author": {"login": "d-c-manning"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "diffHunk": "@@ -3538,9 +3541,11 @@ public void updateRegionsInTransitionMetrics() {\n     int totalRITs = 0;\n     int totalRITsOverThreshold = 0;\n     long oldestRITTime = 0;\n+    Set<String> oldestRITHashesAndStates = Sets.newHashSet(); // set of <rit hash>:<rit state>\n     int ritThreshold = this.server.getConfiguration().\n       getInt(HConstants.METRICS_RIT_STUCK_WARNING_THRESHOLD, 60000);\n-    for (RegionState state: regionStates.getRegionsInTransition()) {\n+    int counter = 0;\n+    for (RegionState state: regionStates.getRegionsInTransitionOrderedByDuration()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c12786bcd7b5abcf538149c6282c384fbc79e9"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQwMDQ3OTI5OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMDozMzo0M1rOIEXudA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwMjozMToxMFrOIGpgbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ1Mzk0MA==", "bodyText": "should we also filter these to only those RITs that are over the threshold? Or do we want to display every RIT, even if it's only been transitioning for 100ms, if it's the longest/only RIT in the cluster?", "url": "https://github.com/apache/hbase/pull/2762#discussion_r541453940", "createdAt": "2020-12-12T00:33:43Z", "author": {"login": "d-c-manning"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "diffHunk": "@@ -3549,11 +3554,24 @@ public void updateRegionsInTransitionMetrics() {\n       if (oldestRITTime < ritTime) {\n         oldestRITTime = ritTime;\n       }\n+      if (counter < 500) { // Record 500 oldest RITs\n+        oldestRITHashesAndStates.add(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c12786bcd7b5abcf538149c6282c384fbc79e9"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg0MjQxMw==", "bodyText": "I think it makes sense to only record RITs over threshold, since those would be the problematic ones", "url": "https://github.com/apache/hbase/pull/2762#discussion_r543842413", "createdAt": "2020-12-16T02:31:10Z", "author": {"login": "caroliney14"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "diffHunk": "@@ -3549,11 +3554,24 @@ public void updateRegionsInTransitionMetrics() {\n       if (oldestRITTime < ritTime) {\n         oldestRITTime = ritTime;\n       }\n+      if (counter < 500) { // Record 500 oldest RITs\n+        oldestRITHashesAndStates.add(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ1Mzk0MA=="}, "originalCommit": {"oid": "61c12786bcd7b5abcf538149c6282c384fbc79e9"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQwMDUwMTk1OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMDo0MDo0MlrOIEX74Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwMjozNTo1M1rOIGpucA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ1NzM3Nw==", "bodyText": "Do we have to use name() as I see other references use state.getState() directly.\nregion names could be quite long - when you refer to hash, did you want the md5 encoded name?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      state.getRegion().getRegionNameAsString() + \":\" + state.getState().name()\n          \n          \n            \n                      state.getRegion().getEncodedName() + \":\" + state.getState()\n          \n      \n    \n    \n  \n\nOr should the entire region name be available?", "url": "https://github.com/apache/hbase/pull/2762#discussion_r541457377", "createdAt": "2020-12-12T00:40:42Z", "author": {"login": "d-c-manning"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "diffHunk": "@@ -3549,11 +3554,24 @@ public void updateRegionsInTransitionMetrics() {\n       if (oldestRITTime < ritTime) {\n         oldestRITTime = ritTime;\n       }\n+      if (counter < 500) { // Record 500 oldest RITs\n+        oldestRITHashesAndStates.add(\n+          state.getRegion().getRegionNameAsString() + \":\" + state.getState().name()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c12786bcd7b5abcf538149c6282c384fbc79e9"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg0NDE2Ng==", "bodyText": "if the md5 encoded name is enough info for debugging (which I think yes), then it should suffice to use that \ud83d\udc4d", "url": "https://github.com/apache/hbase/pull/2762#discussion_r543844166", "createdAt": "2020-12-16T02:33:31Z", "author": {"login": "caroliney14"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "diffHunk": "@@ -3549,11 +3554,24 @@ public void updateRegionsInTransitionMetrics() {\n       if (oldestRITTime < ritTime) {\n         oldestRITTime = ritTime;\n       }\n+      if (counter < 500) { // Record 500 oldest RITs\n+        oldestRITHashesAndStates.add(\n+          state.getRegion().getRegionNameAsString() + \":\" + state.getState().name()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ1NzM3Nw=="}, "originalCommit": {"oid": "61c12786bcd7b5abcf538149c6282c384fbc79e9"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzg0NjAwMA==", "bodyText": "as for state, that is an enum, and we want the state name, which is why I added .name(). see this SO", "url": "https://github.com/apache/hbase/pull/2762#discussion_r543846000", "createdAt": "2020-12-16T02:35:53Z", "author": {"login": "caroliney14"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "diffHunk": "@@ -3549,11 +3554,24 @@ public void updateRegionsInTransitionMetrics() {\n       if (oldestRITTime < ritTime) {\n         oldestRITTime = ritTime;\n       }\n+      if (counter < 500) { // Record 500 oldest RITs\n+        oldestRITHashesAndStates.add(\n+          state.getRegion().getRegionNameAsString() + \":\" + state.getState().name()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ1NzM3Nw=="}, "originalCommit": {"oid": "61c12786bcd7b5abcf538149c6282c384fbc79e9"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQwMDUzMzI3OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMDo1NzoxMVrOIEYLlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMlQwMDo1NzoxMVrOIEYLlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTQ2MTM5Nw==", "bodyText": "we should only log if oldestRITHashesAndStates is non-empty.", "url": "https://github.com/apache/hbase/pull/2762#discussion_r541461397", "createdAt": "2020-12-12T00:57:11Z", "author": {"login": "d-c-manning"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "diffHunk": "@@ -3549,11 +3554,24 @@ public void updateRegionsInTransitionMetrics() {\n       if (oldestRITTime < ritTime) {\n         oldestRITTime = ritTime;\n       }\n+      if (counter < 500) { // Record 500 oldest RITs\n+        oldestRITHashesAndStates.add(\n+          state.getRegion().getRegionNameAsString() + \":\" + state.getState().name()\n+        );\n+      }\n+      counter += 1;\n     }\n     if (this.metricsAssignmentManager != null) {\n       this.metricsAssignmentManager.updateRITOldestAge(oldestRITTime);\n       this.metricsAssignmentManager.updateRITCount(totalRITs);\n       this.metricsAssignmentManager.updateRITCountOverThreshold(totalRITsOverThreshold);\n+\n+      LOG.debug(\"Oldest RIT hashes and states: \" + oldestRITHashesAndStates.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61c12786bcd7b5abcf538149c6282c384fbc79e9"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwMjc5MDg4OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QwOToxMDowOVrOISl6fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QwOToxMDowOVrOISl6fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjM2NjQ2Mg==", "bodyText": "nit: new HashMap<>()", "url": "https://github.com/apache/hbase/pull/2762#discussion_r556366462", "createdAt": "2021-01-13T09:10:09Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "diffHunk": "@@ -3538,18 +3538,31 @@ public void updateRegionsInTransitionMetrics() {\n     int totalRITs = 0;\n     int totalRITsOverThreshold = 0;\n     long oldestRITTime = 0;\n+    HashMap<String, RegionState> ritsOverThreshold = null;\n     int ritThreshold = this.server.getConfiguration().\n       getInt(HConstants.METRICS_RIT_STUCK_WARNING_THRESHOLD, 60000);\n     for (RegionState state: regionStates.getRegionsInTransition()) {\n       totalRITs++;\n       long ritTime = currentTime - state.getStamp();\n       if (ritTime > ritThreshold) { // more than the threshold\n         totalRITsOverThreshold++;\n+        if (ritsOverThreshold == null) {\n+          ritsOverThreshold = new HashMap<String, RegionState>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "064250c4071d261aa10d2a6138990f7f357c64ff"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwMjgwNDIwOnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QwOToxMzozMFrOISmCqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QwOToxMzozMFrOISmCqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjM2ODU1Mg==", "bodyText": "nit: use chain of append() to cover String concatenation?\n        sb.append(regionName).append(\":\")\n          .append(ritsOverThreshold.get(regionName).getState().name()).append(\"\\n\");", "url": "https://github.com/apache/hbase/pull/2762#discussion_r556368552", "createdAt": "2021-01-13T09:13:30Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "diffHunk": "@@ -3538,18 +3538,31 @@ public void updateRegionsInTransitionMetrics() {\n     int totalRITs = 0;\n     int totalRITsOverThreshold = 0;\n     long oldestRITTime = 0;\n+    HashMap<String, RegionState> ritsOverThreshold = null;\n     int ritThreshold = this.server.getConfiguration().\n       getInt(HConstants.METRICS_RIT_STUCK_WARNING_THRESHOLD, 60000);\n     for (RegionState state: regionStates.getRegionsInTransition()) {\n       totalRITs++;\n       long ritTime = currentTime - state.getStamp();\n       if (ritTime > ritThreshold) { // more than the threshold\n         totalRITsOverThreshold++;\n+        if (ritsOverThreshold == null) {\n+          ritsOverThreshold = new HashMap<String, RegionState>();\n+        }\n+        ritsOverThreshold.put(state.getRegion().getEncodedName(), state);\n       }\n       if (oldestRITTime < ritTime) {\n         oldestRITTime = ritTime;\n       }\n     }\n+    if (LOG.isDebugEnabled() && ritsOverThreshold != null && !ritsOverThreshold.isEmpty()) {\n+      StringBuilder sb = new StringBuilder();\n+      for (String regionName: ritsOverThreshold.keySet()) {\n+        sb.append(regionName + \":\" + ritsOverThreshold.get(regionName).getState().name() + \"\\n\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "064250c4071d261aa10d2a6138990f7f357c64ff"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwMjgwNzM0OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QwOToxNDoxM1rOISmEjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QwOToxNDoxM1rOISmEjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjM2OTAzNw==", "bodyText": "Do we want to remove last appended new line char? If so, start index should be sb.length()-1 right?", "url": "https://github.com/apache/hbase/pull/2762#discussion_r556369037", "createdAt": "2021-01-13T09:14:13Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "diffHunk": "@@ -3538,18 +3538,31 @@ public void updateRegionsInTransitionMetrics() {\n     int totalRITs = 0;\n     int totalRITsOverThreshold = 0;\n     long oldestRITTime = 0;\n+    HashMap<String, RegionState> ritsOverThreshold = null;\n     int ritThreshold = this.server.getConfiguration().\n       getInt(HConstants.METRICS_RIT_STUCK_WARNING_THRESHOLD, 60000);\n     for (RegionState state: regionStates.getRegionsInTransition()) {\n       totalRITs++;\n       long ritTime = currentTime - state.getStamp();\n       if (ritTime > ritThreshold) { // more than the threshold\n         totalRITsOverThreshold++;\n+        if (ritsOverThreshold == null) {\n+          ritsOverThreshold = new HashMap<String, RegionState>();\n+        }\n+        ritsOverThreshold.put(state.getRegion().getEncodedName(), state);\n       }\n       if (oldestRITTime < ritTime) {\n         oldestRITTime = ritTime;\n       }\n     }\n+    if (LOG.isDebugEnabled() && ritsOverThreshold != null && !ritsOverThreshold.isEmpty()) {\n+      StringBuilder sb = new StringBuilder();\n+      for (String regionName: ritsOverThreshold.keySet()) {\n+        sb.append(regionName + \":\" + ritsOverThreshold.get(regionName).getState().name() + \"\\n\");\n+      }\n+      sb.delete(sb.length()-2, sb.length());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "064250c4071d261aa10d2a6138990f7f357c64ff"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUwMjgxNDg5OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QwOToxNTo1OFrOISmI8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QwOToxNTo1OFrOISmI8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjM3MDE2MQ==", "bodyText": "nit: Map<String, RegionState> ritsOverThreshold = null", "url": "https://github.com/apache/hbase/pull/2762#discussion_r556370161", "createdAt": "2021-01-13T09:15:58Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "diffHunk": "@@ -3538,18 +3538,31 @@ public void updateRegionsInTransitionMetrics() {\n     int totalRITs = 0;\n     int totalRITsOverThreshold = 0;\n     long oldestRITTime = 0;\n+    HashMap<String, RegionState> ritsOverThreshold = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "064250c4071d261aa10d2a6138990f7f357c64ff"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUxNTI2MjU4OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQxNDo1MzoyNlrOIUff5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQxNDo1MzoyNlrOIUff5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODM1ODUwMA==", "bodyText": "If you could convert this to entrySet(), that would be great (as per findbugs)", "url": "https://github.com/apache/hbase/pull/2762#discussion_r558358500", "createdAt": "2021-01-15T14:53:26Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "diffHunk": "@@ -3538,18 +3538,32 @@ public void updateRegionsInTransitionMetrics() {\n     int totalRITs = 0;\n     int totalRITsOverThreshold = 0;\n     long oldestRITTime = 0;\n+    Map<String, RegionState> ritsOverThreshold = null;\n     int ritThreshold = this.server.getConfiguration().\n       getInt(HConstants.METRICS_RIT_STUCK_WARNING_THRESHOLD, 60000);\n     for (RegionState state: regionStates.getRegionsInTransition()) {\n       totalRITs++;\n       long ritTime = currentTime - state.getStamp();\n       if (ritTime > ritThreshold) { // more than the threshold\n         totalRITsOverThreshold++;\n+        if (ritsOverThreshold == null) {\n+          ritsOverThreshold = new HashMap<>();\n+        }\n+        ritsOverThreshold.put(state.getRegion().getEncodedName(), state);\n       }\n       if (oldestRITTime < ritTime) {\n         oldestRITTime = ritTime;\n       }\n     }\n+    if (LOG.isDebugEnabled() && ritsOverThreshold != null && !ritsOverThreshold.isEmpty()) {\n+      StringBuilder sb = new StringBuilder();\n+      for (String regionName: ritsOverThreshold.keySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab52ab083cb8b780ae845d5059cee1f0db39932b"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUzMDc1ODM1OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQwNjoxMjo1NVrOIWuipg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQwNjoxMjo1NVrOIWuipg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDcwMjExOA==", "bodyText": "This should be:\n       sb.append(regionName.getKey()).append(\":\")\n          .append(regionName.getValue().getState().name()).append(\"\\n\");", "url": "https://github.com/apache/hbase/pull/2762#discussion_r560702118", "createdAt": "2021-01-20T06:12:55Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/AssignmentManager.java", "diffHunk": "@@ -3538,18 +3538,32 @@ public void updateRegionsInTransitionMetrics() {\n     int totalRITs = 0;\n     int totalRITsOverThreshold = 0;\n     long oldestRITTime = 0;\n+    Map<String, RegionState> ritsOverThreshold = null;\n     int ritThreshold = this.server.getConfiguration().\n       getInt(HConstants.METRICS_RIT_STUCK_WARNING_THRESHOLD, 60000);\n     for (RegionState state: regionStates.getRegionsInTransition()) {\n       totalRITs++;\n       long ritTime = currentTime - state.getStamp();\n       if (ritTime > ritThreshold) { // more than the threshold\n         totalRITsOverThreshold++;\n+        if (ritsOverThreshold == null) {\n+          ritsOverThreshold = new HashMap<>();\n+        }\n+        ritsOverThreshold.put(state.getRegion().getEncodedName(), state);\n       }\n       if (oldestRITTime < ritTime) {\n         oldestRITTime = ritTime;\n       }\n     }\n+    if (LOG.isDebugEnabled() && ritsOverThreshold != null && !ritsOverThreshold.isEmpty()) {\n+      StringBuilder sb = new StringBuilder();\n+      for (Map.Entry<String, RegionState> regionName: ritsOverThreshold.entrySet()) {\n+        sb.append(regionName).append(\":\")\n+          .append(ritsOverThreshold.get(regionName).getState().name()).append(\"\\n\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36e0655984977ac21814640e715dbf202301146b"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2349, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}