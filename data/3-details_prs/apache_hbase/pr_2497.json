{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3Mjg5OTgx", "number": 2497, "title": "HBASE-25124 Support changing region replica count without disabling table", "bodyText": "", "createdAt": "2020-10-03T15:04:20Z", "url": "https://github.com/apache/hbase/pull/2497", "merged": true, "mergeCommit": {"oid": "0d63318f10638af6aaac16616ca741be57608e3f"}, "closed": true, "closedAt": "2020-10-08T13:35:30Z", "author": {"login": "Apache9"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPOdkYABqjM4Mzc1MTk1ODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQdkkmgBqjM4NTQyNTU1MzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c01f880aade6747356a56068e501bbc012ee6fb2", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/c01f880aade6747356a56068e501bbc012ee6fb2", "committedDate": "2020-10-03T15:01:15Z", "message": "HBASE-25124 Support changing meta replica count without disabling table"}, "afterCommit": {"oid": "cc40759b03cff80202c6371416d9a7eb5e95d8bf", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/cc40759b03cff80202c6371416d9a7eb5e95d8bf", "committedDate": "2020-10-04T12:36:20Z", "message": "HBASE-25124 Support changing meta replica count without disabling table"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc40759b03cff80202c6371416d9a7eb5e95d8bf", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/cc40759b03cff80202c6371416d9a7eb5e95d8bf", "committedDate": "2020-10-04T12:36:20Z", "message": "HBASE-25124 Support changing meta replica count without disabling table"}, "afterCommit": {"oid": "9b9ab5f2cf5c5231f472d4e24e038da5e157a10c", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/9b9ab5f2cf5c5231f472d4e24e038da5e157a10c", "committedDate": "2020-10-05T14:44:21Z", "message": "HBASE-25124 Support changing meta replica count without disabling table"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9b9ab5f2cf5c5231f472d4e24e038da5e157a10c", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/9b9ab5f2cf5c5231f472d4e24e038da5e157a10c", "committedDate": "2020-10-05T14:44:21Z", "message": "HBASE-25124 Support changing meta replica count without disabling table"}, "afterCommit": {"oid": "741b7306954610afd624b073fc9b26a5a7bb28f2", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/741b7306954610afd624b073fc9b26a5a7bb28f2", "committedDate": "2020-10-05T15:16:02Z", "message": "HBASE-25124 Support changing meta replica count without disabling table"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "741b7306954610afd624b073fc9b26a5a7bb28f2", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/741b7306954610afd624b073fc9b26a5a7bb28f2", "committedDate": "2020-10-05T15:16:02Z", "message": "HBASE-25124 Support changing meta replica count without disabling table"}, "afterCommit": {"oid": "8d37f48e73798ffbcf64419579a0a40e637ad66d", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/8d37f48e73798ffbcf64419579a0a40e637ad66d", "committedDate": "2020-10-05T15:21:33Z", "message": "HBASE-25124 Support changing meta replica count without disabling table"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8d37f48e73798ffbcf64419579a0a40e637ad66d", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/8d37f48e73798ffbcf64419579a0a40e637ad66d", "committedDate": "2020-10-05T15:21:33Z", "message": "HBASE-25124 Support changing meta replica count without disabling table"}, "afterCommit": {"oid": "fb914bbf6ed37de97eaf16a8b2630ec8b61ce777", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/fb914bbf6ed37de97eaf16a8b2630ec8b61ce777", "committedDate": "2020-10-06T14:51:41Z", "message": "HBASE-25124 Support changing region replica count without disabling table"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MjU0MTU3", "url": "https://github.com/apache/hbase/pull/2497#pullrequestreview-504254157", "createdAt": "2020-10-07T20:46:52Z", "commit": {"oid": "fb914bbf6ed37de97eaf16a8b2630ec8b61ce777"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMDo0Njo1MlrOHeE6hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMTowNDo1M1rOHeFfbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTI5OTg0Nw==", "bodyText": "Think this could go back to branch-2? For 2.4.0?", "url": "https://github.com/apache/hbase/pull/2497#discussion_r501299847", "createdAt": "2020-10-07T20:46:52Z", "author": {"login": "saintstack"}, "path": "hbase-protocol-shaded/src/main/protobuf/server/master/MasterProcedure.proto", "diffHunk": "@@ -72,6 +72,8 @@ enum ModifyTableState {\n   MODIFY_TABLE_DELETE_FS_LAYOUT = 5;\n   MODIFY_TABLE_POST_OPERATION = 6;\n   MODIFY_TABLE_REOPEN_ALL_REGIONS = 7;\n+  MODIFY_TABLE_CLOSE_EXCESS_REPLICAS = 8;\n+  MODIFY_TABLE_ASSIGN_NEW_REPLICAS = 9;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb914bbf6ed37de97eaf16a8b2630ec8b61ce777"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMwMzEyMw==", "bodyText": "I don't remember how this worked. It is a technique to stop the current procedure on the regionNode from running? What is the procedure that is on the regionNode? Is it something we've put in place? Something expected? Or just a random procedure that might be running? I don't remember this part of the code.", "url": "https://github.com/apache/hbase/pull/2497#discussion_r501303123", "createdAt": "2020-10-07T20:52:57Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/AssignmentManager.java", "diffHunk": "@@ -870,32 +870,49 @@ public TransitRegionStateProcedure createOneUnassignProcedure(RegionInfo ri, boo\n       .sorted(AssignmentManager::compare).toArray(TransitRegionStateProcedure[]::new);\n   }\n \n+  // for creating unassign TRSP when disabling a table or closing excess region replicas\n+  private TransitRegionStateProcedure forceCreateUnssignProcedure(RegionStateNode regionNode) {\n+    regionNode.lock();\n+    try {\n+      if (!regionStates.include(regionNode, false) ||\n+        regionStates.isRegionOffline(regionNode.getRegionInfo())) {\n+        return null;\n+      }\n+      // As in DisableTableProcedure or ModifyTableProcedure, we will hold the xlock for table, so\n+      // we can make sure that this procedure has not been executed yet, as TRSP will hold the\n+      // shared lock for table all the time. So here we will unset it and when it is actually\n+      // executed, it will find that the attach procedure is not itself and quit immediately.\n+      if (regionNode.getProcedure() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb914bbf6ed37de97eaf16a8b2630ec8b61ce777"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMwNDY2MA==", "bodyText": "Why safe the proc to a local variable? Just return result of unassign?", "url": "https://github.com/apache/hbase/pull/2497#discussion_r501304660", "createdAt": "2020-10-07T20:55:56Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/AssignmentManager.java", "diffHunk": "@@ -870,32 +870,49 @@ public TransitRegionStateProcedure createOneUnassignProcedure(RegionInfo ri, boo\n       .sorted(AssignmentManager::compare).toArray(TransitRegionStateProcedure[]::new);\n   }\n \n+  // for creating unassign TRSP when disabling a table or closing excess region replicas\n+  private TransitRegionStateProcedure forceCreateUnssignProcedure(RegionStateNode regionNode) {\n+    regionNode.lock();\n+    try {\n+      if (!regionStates.include(regionNode, false) ||\n+        regionStates.isRegionOffline(regionNode.getRegionInfo())) {\n+        return null;\n+      }\n+      // As in DisableTableProcedure or ModifyTableProcedure, we will hold the xlock for table, so\n+      // we can make sure that this procedure has not been executed yet, as TRSP will hold the\n+      // shared lock for table all the time. So here we will unset it and when it is actually\n+      // executed, it will find that the attach procedure is not itself and quit immediately.\n+      if (regionNode.getProcedure() != null) {\n+        regionNode.unsetProcedure(regionNode.getProcedure());\n+      }\n+      TransitRegionStateProcedure proc = TransitRegionStateProcedure\n+        .unassign(getProcedureEnvironment(), regionNode.getRegionInfo());\n+      regionNode.setProcedure(proc);\n+      return proc;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb914bbf6ed37de97eaf16a8b2630ec8b61ce777"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMwODQ3Nw==", "bodyText": "We didn't actually use this replicasFound that we read from meta?", "url": "https://github.com/apache/hbase/pull/2497#discussion_r501308477", "createdAt": "2020-10-07T21:03:12Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/procedure/EnableTableProcedure.java", "diffHunk": "@@ -111,25 +104,16 @@ protected Flow executeFromState(final MasterProcedureEnv env, final EnableTableS\n           // How many replicas do we currently have? Check regions returned from\n           // in-memory state.\n           int currentMaxReplica = getMaxReplicaId(regionsOfTable);\n-\n-          // Read the META table to know the number of replicas the table currently has.\n-          // If there was a table modification on region replica count then need to\n-          // adjust replica counts here.\n-          int replicasFound = TableName.isMetaTableName(this.tableName)?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb914bbf6ed37de97eaf16a8b2630ec8b61ce777"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMwOTI5Mg==", "bodyText": "Nice", "url": "https://github.com/apache/hbase/pull/2497#discussion_r501309292", "createdAt": "2020-10-07T21:04:53Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/HBaseTestingUtility.java", "diffHunk": "@@ -1846,11 +1846,9 @@ public static void modifyTableSync(Admin admin, TableDescriptor desc)\n    */\n   public static void setReplicas(Admin admin, TableName table, int replicaCount)\n     throws IOException, InterruptedException {\n-    admin.disableTable(table);\n     TableDescriptor desc = TableDescriptorBuilder.newBuilder(admin.getDescriptor(table))\n       .setRegionReplication(replicaCount).build();\n     admin.modifyTable(desc);\n-    admin.enableTable(table);\n   }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb914bbf6ed37de97eaf16a8b2630ec8b61ce777"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a027599007e09ace3321e03d09809c840aab5fec", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/a027599007e09ace3321e03d09809c840aab5fec", "committedDate": "2020-10-08T08:46:52Z", "message": "HBASE-25124 Support changing region replica count without disabling table"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb914bbf6ed37de97eaf16a8b2630ec8b61ce777", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/fb914bbf6ed37de97eaf16a8b2630ec8b61ce777", "committedDate": "2020-10-06T14:51:41Z", "message": "HBASE-25124 Support changing region replica count without disabling table"}, "afterCommit": {"oid": "a027599007e09ace3321e03d09809c840aab5fec", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/a027599007e09ace3321e03d09809c840aab5fec", "committedDate": "2020-10-08T08:46:52Z", "message": "HBASE-25124 Support changing region replica count without disabling table"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4655, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}