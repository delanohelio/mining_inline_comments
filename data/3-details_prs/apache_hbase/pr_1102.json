{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MjI4MTM1", "number": 1102, "title": "HBASE-23752: Fix remaining test failures from nightly runs", "bodyText": "TestFromClientSideWithCoprocessor: Initialization bug causing parameterized\nruns to fail.\nTestCustomSaslAuthenticationProvider: Test config had to be fixed because\nit was written pre-master registry implementation.", "createdAt": "2020-01-28T21:03:30Z", "url": "https://github.com/apache/hbase/pull/1102", "merged": true, "mergeCommit": {"oid": "b798f690535dba250c13f752841f3dd1871639ec"}, "closed": true, "closedAt": "2020-02-03T18:15:33Z", "author": {"login": "bharathv"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-6XnFgBqjI5ODc3Mjk2MDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcAxA06AFqTM1MjQ1NjI3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a95cac8616a85c7d6016e857b5c5527dfc0d9265", "author": {"user": {"login": "bharathv", "name": "Bharath Vissapragada"}}, "url": "https://github.com/apache/hbase/commit/a95cac8616a85c7d6016e857b5c5527dfc0d9265", "committedDate": "2020-01-28T20:59:44Z", "message": "HBASE-23752: Fix remaining test failures from nightly runs\n\nTestFromClientSideWithCoprocessor: Initialization bug causing parameterized\nruns to fail.\nTestCustomSaslAuthenticationProvider: Test config had to be fixed because\nit was written pre-master registry implementation."}, "afterCommit": {"oid": "f8e6e20c866322284eadce2f58b813bc5903e836", "author": {"user": {"login": "bharathv", "name": "Bharath Vissapragada"}}, "url": "https://github.com/apache/hbase/commit/f8e6e20c866322284eadce2f58b813bc5903e836", "committedDate": "2020-01-28T23:35:30Z", "message": "HBASE-23752: Fix remaining test failures from nightly runs\n\nTestFromClientSideWithCoprocessor: Initialization bug causing parameterized\nruns to fail.\nTestCustomSaslAuthenticationProvider: Test config had to be fixed because\nit was written pre-master registry implementation.\nTestSnapshotScannerHDFSAclController: Cluster restart did not reset the\ncached connection state."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f8e6e20c866322284eadce2f58b813bc5903e836", "author": {"user": {"login": "bharathv", "name": "Bharath Vissapragada"}}, "url": "https://github.com/apache/hbase/commit/f8e6e20c866322284eadce2f58b813bc5903e836", "committedDate": "2020-01-28T23:35:30Z", "message": "HBASE-23752: Fix remaining test failures from nightly runs\n\nTestFromClientSideWithCoprocessor: Initialization bug causing parameterized\nruns to fail.\nTestCustomSaslAuthenticationProvider: Test config had to be fixed because\nit was written pre-master registry implementation.\nTestSnapshotScannerHDFSAclController: Cluster restart did not reset the\ncached connection state."}, "afterCommit": {"oid": "efa33a6b3d98219de69d2819957d380ea57be62d", "author": {"user": {"login": "bharathv", "name": "Bharath Vissapragada"}}, "url": "https://github.com/apache/hbase/commit/efa33a6b3d98219de69d2819957d380ea57be62d", "committedDate": "2020-01-29T00:55:19Z", "message": "HBASE-23752: Fix remaining test failures from nightly runs\n\nTestFromClientSideWithCoprocessor: Initialization bug causing parameterized\nruns to fail.\nTestCustomSaslAuthenticationProvider: Test config had to be fixed because\nit was written pre-master registry implementation.\nTestSnapshotScannerHDFSAclController: Cluster restart did not reset the\ncached connection state."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5ODA1Mzg4", "url": "https://github.com/apache/hbase/pull/1102#pullrequestreview-349805388", "createdAt": "2020-01-29T00:56:12Z", "commit": {"oid": "efa33a6b3d98219de69d2819957d380ea57be62d"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "efa33a6b3d98219de69d2819957d380ea57be62d", "author": {"user": {"login": "bharathv", "name": "Bharath Vissapragada"}}, "url": "https://github.com/apache/hbase/commit/efa33a6b3d98219de69d2819957d380ea57be62d", "committedDate": "2020-01-29T00:55:19Z", "message": "HBASE-23752: Fix remaining test failures from nightly runs\n\nTestFromClientSideWithCoprocessor: Initialization bug causing parameterized\nruns to fail.\nTestCustomSaslAuthenticationProvider: Test config had to be fixed because\nit was written pre-master registry implementation.\nTestSnapshotScannerHDFSAclController: Cluster restart did not reset the\ncached connection state."}, "afterCommit": {"oid": "65aa30cf72f0829c3306a48cfbf95198bc50c4fc", "author": {"user": {"login": "bharathv", "name": "Bharath Vissapragada"}}, "url": "https://github.com/apache/hbase/commit/65aa30cf72f0829c3306a48cfbf95198bc50c4fc", "committedDate": "2020-01-29T05:41:43Z", "message": "HBASE-23752: Fix remaining test failures from nightly runs\n\nTestFromClientSideWithCoprocessor: Initialization bug causing parameterized\nruns to fail.\nTestCustomSaslAuthenticationProvider: Test config had to be fixed because\nit was written pre-master registry implementation.\nTestSnapshotScannerHDFSAclController: Cluster restart did not reset the\ncached connection state."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMjc3ODI3", "url": "https://github.com/apache/hbase/pull/1102#pullrequestreview-350277827", "createdAt": "2020-01-29T17:10:34Z", "commit": {"oid": "65aa30cf72f0829c3306a48cfbf95198bc50c4fc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNzoxMDozNFrOFjQg2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNzoxMDozNFrOFjQg2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjUxNTAzMw==", "bodyText": "Why is this test forced onto the blocking rpc client? Can/Should it be parameterized over both implementations?\ncan we not use the MasterRegistry with hedged rpcs disabled? It appears this configuration is supported by the MasterRegistry constructor.", "url": "https://github.com/apache/hbase/pull/1102#discussion_r372515033", "createdAt": "2020-01-29T17:10:34Z", "author": {"login": "ndimiduk"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/security/provider/TestCustomSaslAuthenticationProvider.java", "diffHunk": "@@ -431,9 +431,13 @@ public static void setupCluster() throws Exception {\n         UTIL.getDataTestDir(\"keytab\").toUri().getPath());\n     final MiniKdc kdc = UTIL.setupMiniKdc(KEYTAB_FILE);\n \n-    // Switch back to NIO for now.\n+    // Switch to blocking RPC impl.\n     CONF.set(RpcClientFactory.CUSTOM_RPC_CLIENT_IMPL_CONF_KEY, BlockingRpcClient.class.getName());\n     CONF.set(RpcServerFactory.CUSTOM_RPC_SERVER_IMPL_CONF_KEY, SimpleRpcServer.class.getName());\n+    // Set the connection registry to ZKConnectionRegistry since hedging is not supported on\n+    // blocking rpc clients.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65aa30cf72f0829c3306a48cfbf95198bc50c4fc"}, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "65aa30cf72f0829c3306a48cfbf95198bc50c4fc", "author": {"user": {"login": "bharathv", "name": "Bharath Vissapragada"}}, "url": "https://github.com/apache/hbase/commit/65aa30cf72f0829c3306a48cfbf95198bc50c4fc", "committedDate": "2020-01-29T05:41:43Z", "message": "HBASE-23752: Fix remaining test failures from nightly runs\n\nTestFromClientSideWithCoprocessor: Initialization bug causing parameterized\nruns to fail.\nTestCustomSaslAuthenticationProvider: Test config had to be fixed because\nit was written pre-master registry implementation.\nTestSnapshotScannerHDFSAclController: Cluster restart did not reset the\ncached connection state."}, "afterCommit": {"oid": "c371dab95388cf1bab15d88c9449e0edd46c7993", "author": {"user": {"login": "bharathv", "name": "Bharath Vissapragada"}}, "url": "https://github.com/apache/hbase/commit/c371dab95388cf1bab15d88c9449e0edd46c7993", "committedDate": "2020-01-31T05:30:57Z", "message": "HBASE-23752: Fix remaining test failures from nightly runs\n\nTestFromClientSideWithCoprocessor: Initialization bug causing parameterized\nruns to fail.\nTestCustomSaslAuthenticationProvider: Test config had to be fixed because\nit was written pre-master registry implementation.\nTestSnapshotScannerHDFSAclController: Cluster restart did not reset the\ncached connection state."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNTY1MjY0", "url": "https://github.com/apache/hbase/pull/1102#pullrequestreview-351565264", "createdAt": "2020-01-31T15:04:16Z", "commit": {"oid": "c371dab95388cf1bab15d88c9449e0edd46c7993"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxNTowNDoxN1rOFkOK6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxNTowNDoxN1rOFkOK6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUyNTIyNg==", "bodyText": "There's a throws Exception on run() so we need  a fail() \"close\" to the return null. Right now, an exception other than MasterRegistryFetchException and RetriesExhaustedException would not cause a unit test failure.\nYou can just move the fail from inside the try, next to this return null and change the message to be something like Expected an authentication failure.", "url": "https://github.com/apache/hbase/pull/1102#discussion_r373525226", "createdAt": "2020-01-31T15:04:17Z", "author": {"login": "joshelser"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/security/provider/TestCustomSaslAuthenticationProvider.java", "diffHunk": "@@ -527,12 +568,22 @@ public void testNegativeAuthentication() throws Exception {\n     user1.addToken(createPasswordToken(\"user1\", \"definitely not the password\", clusterId));\n     user1.doAs(new PrivilegedExceptionAction<Void>() {\n       @Override public Void run() throws Exception {\n+        // Depending on the registry in use, the following code can throw exceptions at different\n+        // places. Master registry fails at the createConnection() step because the RPC to the\n+        // master fails with sasl auth. With ZK registry, connection creation succeeds (since there\n+        // is no RPC to HBase services involved) but the subsequent get() fails. The root cause\n+        // should still be a SaslException in both the cases.\n         try (Connection conn = ConnectionFactory.createConnection(clientConf);\n             Table t = conn.getTable(tableName)) {\n           t.get(new Get(Bytes.toBytes(\"r1\")));\n           fail(\"Should not successfully authenticate with HBase\");\n-          return null;\n+        } catch (MasterRegistryFetchException mfe) {\n+          Throwable cause = mfe.getCause();\n+          assertTrue(cause.getMessage(), cause.getMessage().contains(\"SaslException\"));\n+        } catch (RetriesExhaustedException re) {\n+          assertTrue(re.getMessage(), re.getMessage().contains(\"SaslException\"));\n         }\n+        return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c371dab95388cf1bab15d88c9449e0edd46c7993"}, "originalPosition": 216}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNTY1Njcz", "url": "https://github.com/apache/hbase/pull/1102#pullrequestreview-351565673", "createdAt": "2020-01-31T15:04:53Z", "commit": {"oid": "c371dab95388cf1bab15d88c9449e0edd46c7993"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "298392ce8ff877a7f2a2ae509bdc355b4bfafde3", "author": {"user": {"login": "bharathv", "name": "Bharath Vissapragada"}}, "url": "https://github.com/apache/hbase/commit/298392ce8ff877a7f2a2ae509bdc355b4bfafde3", "committedDate": "2020-01-31T19:52:18Z", "message": "HBASE-23752: Fix remaining test failures from nightly runs\n\nTestFromClientSideWithCoprocessor: Initialization bug causing parameterized\nruns to fail.\nTestCustomSaslAuthenticationProvider: Test config had to be fixed because\nit was written pre-master registry implementation.\nTestSnapshotScannerHDFSAclController: Cluster restart did not reset the\ncached connection state."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c371dab95388cf1bab15d88c9449e0edd46c7993", "author": {"user": {"login": "bharathv", "name": "Bharath Vissapragada"}}, "url": "https://github.com/apache/hbase/commit/c371dab95388cf1bab15d88c9449e0edd46c7993", "committedDate": "2020-01-31T05:30:57Z", "message": "HBASE-23752: Fix remaining test failures from nightly runs\n\nTestFromClientSideWithCoprocessor: Initialization bug causing parameterized\nruns to fail.\nTestCustomSaslAuthenticationProvider: Test config had to be fixed because\nit was written pre-master registry implementation.\nTestSnapshotScannerHDFSAclController: Cluster restart did not reset the\ncached connection state."}, "afterCommit": {"oid": "298392ce8ff877a7f2a2ae509bdc355b4bfafde3", "author": {"user": {"login": "bharathv", "name": "Bharath Vissapragada"}}, "url": "https://github.com/apache/hbase/commit/298392ce8ff877a7f2a2ae509bdc355b4bfafde3", "committedDate": "2020-01-31T19:52:18Z", "message": "HBASE-23752: Fix remaining test failures from nightly runs\n\nTestFromClientSideWithCoprocessor: Initialization bug causing parameterized\nruns to fail.\nTestCustomSaslAuthenticationProvider: Test config had to be fixed because\nit was written pre-master registry implementation.\nTestSnapshotScannerHDFSAclController: Cluster restart did not reset the\ncached connection state."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxODQ4ODEy", "url": "https://github.com/apache/hbase/pull/1102#pullrequestreview-351848812", "createdAt": "2020-02-01T00:43:38Z", "commit": {"oid": "298392ce8ff877a7f2a2ae509bdc355b4bfafde3"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNDQ2NjY4", "url": "https://github.com/apache/hbase/pull/1102#pullrequestreview-352446668", "createdAt": "2020-02-03T17:56:15Z", "commit": {"oid": "298392ce8ff877a7f2a2ae509bdc355b4bfafde3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxNzo1NjoxNVrOFk6Zvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxNzo1NjoxNVrOFk6Zvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI0OTkxOA==", "bodyText": "Sucks that we have to spin the new cluster for every test method. It is not possible to do this cluster configuration and initialization in the constructor instead?", "url": "https://github.com/apache/hbase/pull/1102#discussion_r374249918", "createdAt": "2020-02-03T17:56:15Z", "author": {"login": "ndimiduk"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/security/provider/TestCustomSaslAuthenticationProvider.java", "diffHunk": "@@ -443,9 +464,23 @@ public static void setupCluster() throws Exception {\n         InMemoryServerProvider.class.getName());\n     CONF.set(SaslClientAuthenticationProviders.SELECTOR_KEY,\n         InMemoryProviderSelector.class.getName());\n+    createBaseCluster(UTIL, KEYTAB_FILE, kdc);\n+  }\n \n-    CLUSTER = createCluster(UTIL, KEYTAB_FILE, kdc);\n+  @Before\n+  public void setUpBeforeTest() throws Exception {\n+    CONF.unset(HConstants.CLIENT_CONNECTION_REGISTRY_IMPL_CONF_KEY);\n+    CONF.set(RpcClientFactory.CUSTOM_RPC_CLIENT_IMPL_CONF_KEY, rpcClientImpl);\n+    CONF.set(RpcServerFactory.CUSTOM_RPC_SERVER_IMPL_CONF_KEY, rpcServerImpl);\n+    if (rpcClientImpl.equals(BlockingRpcClient.class.getName())) {\n+      // Set the connection registry to ZKConnectionRegistry since hedging is not supported on\n+      // blocking rpc clients.\n+      CONF.set(HConstants.CLIENT_CONNECTION_REGISTRY_IMPL_CONF_KEY,\n+          HConstants.ZK_CONNECTION_REGISTRY_CLASS);\n+    }\n+    CLUSTER = new LocalHBaseCluster(CONF, 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "298392ce8ff877a7f2a2ae509bdc355b4bfafde3"}, "originalPosition": 157}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNDU2Mjc3", "url": "https://github.com/apache/hbase/pull/1102#pullrequestreview-352456277", "createdAt": "2020-02-03T18:12:20Z", "commit": {"oid": "298392ce8ff877a7f2a2ae509bdc355b4bfafde3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3055, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}