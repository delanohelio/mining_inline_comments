{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1NTUzNjI2", "number": 2232, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNjo0NzoyMVrOEW4ETQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwNTowNjoyN1rOEZUBQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNDIyNzMzOnYy", "diffSide": "RIGHT", "path": "hbase-shell/src/main/ruby/shell.rb", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNjo0NzoyMVrOG-W70w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNzozMzozM1rOG-YgmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA0MDY1OQ==", "bodyText": "Control flow returns to this line after a raise ? raise is an expression in this language..?", "url": "https://github.com/apache/hbase/pull/2232#discussion_r468040659", "createdAt": "2020-08-10T16:47:21Z", "author": {"login": "ndimiduk"}, "path": "hbase-shell/src/main/ruby/shell.rb", "diffHunk": "@@ -335,12 +348,9 @@ def eval_io(io)\n         # Include the 'ERROR' string to try to make transition easier for scripts that\n         # may have already been relying on grepping output.\n         puts \"ERROR #{e.class}: #{message}\"\n-        if $fullBacktrace\n-          # re-raising the will include a backtrace and exit.\n-          raise e\n-        else\n-          exit 1\n-        end\n+        raise e unless hide_traceback\n+\n+        exit 1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba7c57ec936731563392d7fcf9008c72fa3a15e0"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA2MTI2Mw==", "bodyText": "Ruby allows one-line conditionals such as <statement> if <condition>, which is equivalent to if <condition>; <statement>; end. It's a fun feature of Ruby \ud83d\ude04.\nSo, this logic will raise SystemExit (via exit 1) if we want to hide the traceback.", "url": "https://github.com/apache/hbase/pull/2232#discussion_r468061263", "createdAt": "2020-08-10T17:24:19Z", "author": {"login": "bitoffdev"}, "path": "hbase-shell/src/main/ruby/shell.rb", "diffHunk": "@@ -335,12 +348,9 @@ def eval_io(io)\n         # Include the 'ERROR' string to try to make transition easier for scripts that\n         # may have already been relying on grepping output.\n         puts \"ERROR #{e.class}: #{message}\"\n-        if $fullBacktrace\n-          # re-raising the will include a backtrace and exit.\n-          raise e\n-        else\n-          exit 1\n-        end\n+        raise e unless hide_traceback\n+\n+        exit 1", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA0MDY1OQ=="}, "originalCommit": {"oid": "ba7c57ec936731563392d7fcf9008c72fa3a15e0"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA2NjQ1Ng==", "bodyText": "I also added unit tests that cover/verify this.", "url": "https://github.com/apache/hbase/pull/2232#discussion_r468066456", "createdAt": "2020-08-10T17:33:33Z", "author": {"login": "bitoffdev"}, "path": "hbase-shell/src/main/ruby/shell.rb", "diffHunk": "@@ -335,12 +348,9 @@ def eval_io(io)\n         # Include the 'ERROR' string to try to make transition easier for scripts that\n         # may have already been relying on grepping output.\n         puts \"ERROR #{e.class}: #{message}\"\n-        if $fullBacktrace\n-          # re-raising the will include a backtrace and exit.\n-          raise e\n-        else\n-          exit 1\n-        end\n+        raise e unless hide_traceback\n+\n+        exit 1", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA0MDY1OQ=="}, "originalCommit": {"oid": "ba7c57ec936731563392d7fcf9008c72fa3a15e0"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNDIzMTA4OnYy", "diffSide": "RIGHT", "path": "hbase-shell/src/main/ruby/shell.rb", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNjo0ODoyN1rOG-W-NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNzozNzoxM1rOG-YoTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA0MTI2OA==", "bodyText": "this propagates source files and line numbers for the purpose of error handling? nice!", "url": "https://github.com/apache/hbase/pull/2232#discussion_r468041268", "createdAt": "2020-08-10T16:48:27Z", "author": {"login": "ndimiduk"}, "path": "hbase-shell/src/main/ruby/shell.rb", "diffHunk": "@@ -320,10 +323,20 @@ def eval_io(io)\n       scanner = RubyLex.new\n       scanner.set_input(io)\n \n+      scanner.each_top_level_statement do |statement, linenum|\n+        puts(workspace.evaluate(nil, statement, filename, linenum))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba7c57ec936731563392d7fcf9008c72fa3a15e0"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA2ODQyOQ==", "bodyText": "Yup! Credit to @busbey for figuring this out in HBASE-11658 (this code used to exist in bin/hirb.rb).", "url": "https://github.com/apache/hbase/pull/2232#discussion_r468068429", "createdAt": "2020-08-10T17:37:13Z", "author": {"login": "bitoffdev"}, "path": "hbase-shell/src/main/ruby/shell.rb", "diffHunk": "@@ -320,10 +323,20 @@ def eval_io(io)\n       scanner = RubyLex.new\n       scanner.set_input(io)\n \n+      scanner.each_top_level_statement do |statement, linenum|\n+        puts(workspace.evaluate(nil, statement, filename, linenum))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA0MTI2OA=="}, "originalCommit": {"oid": "ba7c57ec936731563392d7fcf9008c72fa3a15e0"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNDIzNzkwOnYy", "diffSide": "RIGHT", "path": "hbase-shell/src/test/ruby/shell/shell_test.rb", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNjo1MDoyMVrOG-XCdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNzozMTo0OFrOG-YdEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA0MjM1Nw==", "bodyText": "why do you both define a variable hide_traceback = true and also pass true to the exception_handler -- it's redundant?", "url": "https://github.com/apache/hbase/pull/2232#discussion_r468042357", "createdAt": "2020-08-10T16:50:21Z", "author": {"login": "ndimiduk"}, "path": "hbase-shell/src/test/ruby/shell/shell_test.rb", "diffHunk": "@@ -123,14 +124,35 @@ class FooC; end\n \n     # check that at least one of the HBase constants is present while evaluating\n     io = StringIO.new <<~EOF\n-      ROWPREFIXFILTER\n+      ROWPREFIXFILTER.dump\n     EOF\n     output = capture_stdout { @shell.eval_io(io) }\n     assert_match(/\"ROWPREFIXFILTER\"/, output)\n   end\n \n   #-----------------------------------------------------------------------------\n \n+  define_test 'Shell::Shell#exception_handler should hide traceback' do\n+    class TestException < RuntimeError; end\n+    hide_traceback = true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba7c57ec936731563392d7fcf9008c72fa3a15e0"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA2NTU1Mw==", "bodyText": "Agreed. I removed the unused variables.", "url": "https://github.com/apache/hbase/pull/2232#discussion_r468065553", "createdAt": "2020-08-10T17:31:48Z", "author": {"login": "bitoffdev"}, "path": "hbase-shell/src/test/ruby/shell/shell_test.rb", "diffHunk": "@@ -123,14 +124,35 @@ class FooC; end\n \n     # check that at least one of the HBase constants is present while evaluating\n     io = StringIO.new <<~EOF\n-      ROWPREFIXFILTER\n+      ROWPREFIXFILTER.dump\n     EOF\n     output = capture_stdout { @shell.eval_io(io) }\n     assert_match(/\"ROWPREFIXFILTER\"/, output)\n   end\n \n   #-----------------------------------------------------------------------------\n \n+  define_test 'Shell::Shell#exception_handler should hide traceback' do\n+    class TestException < RuntimeError; end\n+    hide_traceback = true", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA0MjM1Nw=="}, "originalCommit": {"oid": "ba7c57ec936731563392d7fcf9008c72fa3a15e0"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0OTc3ODU3OnYy", "diffSide": "RIGHT", "path": "hbase-shell/src/main/ruby/shell.rb", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwNTowNjoyOFrOHCDfsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxMzoxMjozNVrOHCTlOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkxNjQ2Ng==", "bodyText": "Whats going on here? We are skipping output of the exception stack trace?", "url": "https://github.com/apache/hbase/pull/2232#discussion_r471916466", "createdAt": "2020-08-18T05:06:28Z", "author": {"login": "saintstack"}, "path": "hbase-shell/src/main/ruby/shell.rb", "diffHunk": "@@ -320,10 +323,20 @@ def eval_io(io)\n       scanner = RubyLex.new\n       scanner.set_input(io)\n \n+      scanner.each_top_level_statement do |statement, linenum|\n+        puts(workspace.evaluate(nil, statement, filename, linenum))\n+      end\n+      nil\n+    end\n+\n+    ##\n+    # Runs a block and logs exception from both Ruby and Java, optionally discarding the traceback\n+    #\n+    # @param [Boolean] hide_traceback if true, Exceptions will be converted to\n+    #   a SystemExit so that the traceback is not printed\n+    def self.exception_handler(hide_traceback)\n       begin\n-        scanner.each_top_level_statement do |statement, linenum|\n-          puts(workspace.evaluate(nil, statement, 'stdin', linenum))\n-        end\n+        yield", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4323aae535e3a273338095157893a21c2d1d2112"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkxNjcwMg==", "bodyText": "We need this begin/rescue w/ a yield in the middle of it?", "url": "https://github.com/apache/hbase/pull/2232#discussion_r471916702", "createdAt": "2020-08-18T05:07:22Z", "author": {"login": "saintstack"}, "path": "hbase-shell/src/main/ruby/shell.rb", "diffHunk": "@@ -320,10 +323,20 @@ def eval_io(io)\n       scanner = RubyLex.new\n       scanner.set_input(io)\n \n+      scanner.each_top_level_statement do |statement, linenum|\n+        puts(workspace.evaluate(nil, statement, filename, linenum))\n+      end\n+      nil\n+    end\n+\n+    ##\n+    # Runs a block and logs exception from both Ruby and Java, optionally discarding the traceback\n+    #\n+    # @param [Boolean] hide_traceback if true, Exceptions will be converted to\n+    #   a SystemExit so that the traceback is not printed\n+    def self.exception_handler(hide_traceback)\n       begin\n-        scanner.each_top_level_statement do |statement, linenum|\n-          puts(workspace.evaluate(nil, statement, 'stdin', linenum))\n-        end\n+        yield", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkxNjQ2Ng=="}, "originalCommit": {"oid": "4323aae535e3a273338095157893a21c2d1d2112"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjE4MDAyNg==", "bodyText": "The yield ensures that whatever block is passed to exception_handler is executed within our begin/rescue, which is how we are able to catch and translate exceptions to a SystemExit to avoid printing the full traceback.", "url": "https://github.com/apache/hbase/pull/2232#discussion_r472180026", "createdAt": "2020-08-18T13:12:35Z", "author": {"login": "bitoffdev"}, "path": "hbase-shell/src/main/ruby/shell.rb", "diffHunk": "@@ -320,10 +323,20 @@ def eval_io(io)\n       scanner = RubyLex.new\n       scanner.set_input(io)\n \n+      scanner.each_top_level_statement do |statement, linenum|\n+        puts(workspace.evaluate(nil, statement, filename, linenum))\n+      end\n+      nil\n+    end\n+\n+    ##\n+    # Runs a block and logs exception from both Ruby and Java, optionally discarding the traceback\n+    #\n+    # @param [Boolean] hide_traceback if true, Exceptions will be converted to\n+    #   a SystemExit so that the traceback is not printed\n+    def self.exception_handler(hide_traceback)\n       begin\n-        scanner.each_top_level_statement do |statement, linenum|\n-          puts(workspace.evaluate(nil, statement, 'stdin', linenum))\n-        end\n+        yield", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTkxNjQ2Ng=="}, "originalCommit": {"oid": "4323aae535e3a273338095157893a21c2d1d2112"}, "originalPosition": 47}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2641, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}