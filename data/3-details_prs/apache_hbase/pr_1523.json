{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzNzU0NzI4", "number": 1523, "title": "HBASE-24195 : Admin.getRegionServers() should return live servers exc\u2026", "bodyText": "\u2026luding decom RS optionally", "createdAt": "2020-04-15T13:19:12Z", "url": "https://github.com/apache/hbase/pull/1523", "merged": true, "mergeCommit": {"oid": "d212dc4df0f494d8697f8843d683c4676f200142"}, "closed": true, "closedAt": "2020-04-16T14:43:15Z", "author": {"login": "virajjasani"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcX39N1gH2gAyNDAzNzU0NzI4OmVhMmNjNzE3MmIyYmU5MDViMTA2NDFjZWM3NDUwNTU4Yzg4YjAwM2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYNjaxgFqTM5NDY4OTM1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ea2cc7172b2be905b10641cec7450558c88b003e", "author": {"user": {"login": "virajjasani", "name": "Viraj Jasani"}}, "url": "https://github.com/apache/hbase/commit/ea2cc7172b2be905b10641cec7450558c88b003e", "committedDate": "2020-04-15T13:17:59Z", "message": "HBASE-24195 : Admin.getRegionServers() should return live servers excluding decom RS optionally"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MzEwNjk0", "url": "https://github.com/apache/hbase/pull/1523#pullrequestreview-394310694", "createdAt": "2020-04-16T05:36:11Z", "commit": {"oid": "ea2cc7172b2be905b10641cec7450558c88b003e"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNTozNjoxMVrOGGVQZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNTo0Njo1OVrOGGVdrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI5MjkwMA==", "bodyText": "Add Assert.assertEquals(3, ADMIN.getRegionServers(false).size()); for paranoid reviewers (cough cough me).", "url": "https://github.com/apache/hbase/pull/1523#discussion_r409292900", "createdAt": "2020-04-16T05:36:11Z", "author": {"login": "liuml07"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin2.java", "diffHunk": "@@ -864,4 +865,42 @@ public void testSlowLogResponses() throws Exception {\n     Assert.assertEquals(onlineLogRecords.size(), 0);\n   }\n \n+  @Test\n+  public void testGetRegionServers() throws Exception {\n+    // get all live server names\n+    List<ServerName> serverNames = new ArrayList<>(ADMIN.getRegionServers(true));\n+    Assert.assertEquals(3, serverNames.size());\n+\n+    List<ServerName> serversToDecom = new ArrayList<>();\n+    ServerName serverToDecommission = serverNames.get(0);\n+\n+    serversToDecom.add(serverToDecommission);\n+    ADMIN.decommissionRegionServers(serversToDecom, false);\n+    waitForServerDecom(serverToDecommission, true);\n+\n+    Assert.assertEquals(2, ADMIN.getRegionServers(true).size());\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea2cc7172b2be905b10641cec7450558c88b003e"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI5MzU2OQ==", "bodyText": "Why wait for decommission this server in the end?", "url": "https://github.com/apache/hbase/pull/1523#discussion_r409293569", "createdAt": "2020-04-16T05:38:27Z", "author": {"login": "liuml07"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin2.java", "diffHunk": "@@ -864,4 +865,42 @@ public void testSlowLogResponses() throws Exception {\n     Assert.assertEquals(onlineLogRecords.size(), 0);\n   }\n \n+  @Test\n+  public void testGetRegionServers() throws Exception {\n+    // get all live server names\n+    List<ServerName> serverNames = new ArrayList<>(ADMIN.getRegionServers(true));\n+    Assert.assertEquals(3, serverNames.size());\n+\n+    List<ServerName> serversToDecom = new ArrayList<>();\n+    ServerName serverToDecommission = serverNames.get(0);\n+\n+    serversToDecom.add(serverToDecommission);\n+    ADMIN.decommissionRegionServers(serversToDecom, false);\n+    waitForServerDecom(serverToDecommission, true);\n+\n+    Assert.assertEquals(2, ADMIN.getRegionServers(true).size());\n+\n+    ADMIN.recommissionRegionServer(serverToDecommission, Collections.emptyList());\n+\n+    Assert.assertEquals(3, ADMIN.getRegionServers(true).size());\n+    waitForServerDecom(serverToDecommission, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea2cc7172b2be905b10641cec7450558c88b003e"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI5NjMwMQ==", "bodyText": "if (CollectionUtils.isNotEmpty(decommissionedRegionServers)) {\n    allServers = new ArrayList<>(allServers);\n    allServers.removeIf(decommissionedRegionServers::contains);\n    return Collections.unmodifiableList(allServers);\n  }\n return allServers;\n\nto\n  return allServers.stream()\n    .filter(s -> !decommissionedRegionServers.contains(s))\n    .collect(ImmutableList.toImmutableList());\n\nI think this will save one time full copy (previous code copy twice, and this copies just once). Need to confirm.", "url": "https://github.com/apache/hbase/pull/1523#discussion_r409296301", "createdAt": "2020-04-16T05:46:59Z", "author": {"login": "liuml07"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/Admin.java", "diffHunk": "@@ -1064,7 +1067,31 @@ default ServerName getMaster() throws IOException {\n    * @throws IOException if a remote or network exception occurs\n    */\n   default Collection<ServerName> getRegionServers() throws IOException {\n-    return getClusterMetrics(EnumSet.of(Option.SERVERS_NAME)).getServersName();\n+    return getRegionServers(false);\n+  }\n+\n+  /**\n+   * Retrieve all current live region servers including decommissioned\n+   * if excludeDecommissionedRS is false, else non-decommissioned ones only\n+   *\n+   * @param excludeDecommissionedRS should we exclude decommissioned RS nodes\n+   * @return all current live region servers including/excluding decommissioned hosts\n+   * @throws IOException if a remote or network exception occurs\n+   */\n+  default Collection<ServerName> getRegionServers(boolean excludeDecommissionedRS)\n+      throws IOException {\n+    List<ServerName> allServers =\n+      getClusterMetrics(EnumSet.of(Option.SERVERS_NAME)).getServersName();\n+    if (!excludeDecommissionedRS) {\n+      return allServers;\n+    }\n+    List<ServerName> decommissionedRegionServers = listDecommissionedRegionServers();\n+    if (CollectionUtils.isNotEmpty(decommissionedRegionServers)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea2cc7172b2be905b10641cec7450558c88b003e"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d52a72040825d16517976a41eb9e49619e88a1e5", "author": {"user": {"login": "virajjasani", "name": "Viraj Jasani"}}, "url": "https://github.com/apache/hbase/commit/d52a72040825d16517976a41eb9e49619e88a1e5", "committedDate": "2020-04-16T09:49:56Z", "message": "addressing review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NjU3Mzc1", "url": "https://github.com/apache/hbase/pull/1523#pullrequestreview-394657375", "createdAt": "2020-04-16T13:55:52Z", "commit": {"oid": "d52a72040825d16517976a41eb9e49619e88a1e5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMzo1NTo1MlrOGGmiMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMzo1NTo1MlrOGGmiMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU3NTk4NA==", "bodyText": "Is the timeout chosen randomly?", "url": "https://github.com/apache/hbase/pull/1523#discussion_r409575984", "createdAt": "2020-04-16T13:55:52Z", "author": {"login": "HorizonNet"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin2.java", "diffHunk": "@@ -864,4 +865,44 @@ public void testSlowLogResponses() throws Exception {\n     Assert.assertEquals(onlineLogRecords.size(), 0);\n   }\n \n+  @Test\n+  public void testGetRegionServers() throws Exception {\n+    // get all live server names\n+    List<ServerName> serverNames = new ArrayList<>(ADMIN.getRegionServers(true));\n+    Assert.assertEquals(3, serverNames.size());\n+\n+    List<ServerName> serversToDecom = new ArrayList<>();\n+    ServerName serverToDecommission = serverNames.get(0);\n+\n+    serversToDecom.add(serverToDecommission);\n+    ADMIN.decommissionRegionServers(serversToDecom, false);\n+    waitForServerCommissioned(serverToDecommission, true);\n+\n+    Assert.assertEquals(2, ADMIN.getRegionServers(true).size());\n+    Assert.assertEquals(3, ADMIN.getRegionServers(false).size());\n+\n+    ADMIN.recommissionRegionServer(serverToDecommission, Collections.emptyList());\n+    waitForServerCommissioned(null, false);\n+\n+    Assert.assertEquals(3, ADMIN.getRegionServers(true).size());\n+    Assert.assertEquals(3, ADMIN.getRegionServers(false).size());\n+  }\n+\n+  private static void waitForServerCommissioned(ServerName excludeServer,\n+      boolean anyServerDecommissioned) {\n+    TEST_UTIL.waitFor(3000, () -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d52a72040825d16517976a41eb9e49619e88a1e5"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0Njg5MzU5", "url": "https://github.com/apache/hbase/pull/1523#pullrequestreview-394689359", "createdAt": "2020-04-16T14:27:43Z", "commit": {"oid": "d52a72040825d16517976a41eb9e49619e88a1e5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2453, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}