{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzMDIwMzY2", "number": 2738, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNDoyNTo0NFrOFBzi8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNDoyNzo0OFrOFBznfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NDM3NDI0OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/cleaner/HFileLinkCleaner.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNDoyNTo0NFrOIApQjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNDoyNTo0NFrOIApQjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU0Njg5Mg==", "bodyText": "Usually we will put this line before the try block.", "url": "https://github.com/apache/hbase/pull/2738#discussion_r537546892", "createdAt": "2020-12-07T14:25:44Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/cleaner/HFileLinkCleaner.java", "diffHunk": "@@ -44,71 +45,79 @@\n   private static final Logger LOG = LoggerFactory.getLogger(HFileLinkCleaner.class);\n \n   private FileSystem fs = null;\n+  private ReentrantReadWriteLock lock = new ReentrantReadWriteLock();\n \n   @Override\n-  public synchronized boolean isFileDeletable(FileStatus fStat) {\n-    if (this.fs == null) return false;\n-    Path filePath = fStat.getPath();\n-    // HFile Link is always deletable\n-    if (HFileLink.isHFileLink(filePath)) return true;\n+  public boolean isFileDeletable(FileStatus fStat) {\n+    try {\n+      lock.readLock().lock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91b6bcaafde0424b1974f89f033dff2286d55279"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NDM4MTc0OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/cleaner/HFileLinkCleaner.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNDoyNzoxMFrOIApU8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNDoyNzoxMFrOIApU8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU0ODAxOQ==", "bodyText": "nits: add '{}' to hold the 'return false;' block to fix a checkstyle warning.", "url": "https://github.com/apache/hbase/pull/2738#discussion_r537548019", "createdAt": "2020-12-07T14:27:10Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/cleaner/HFileLinkCleaner.java", "diffHunk": "@@ -44,71 +45,79 @@\n   private static final Logger LOG = LoggerFactory.getLogger(HFileLinkCleaner.class);\n \n   private FileSystem fs = null;\n+  private ReentrantReadWriteLock lock = new ReentrantReadWriteLock();\n \n   @Override\n-  public synchronized boolean isFileDeletable(FileStatus fStat) {\n-    if (this.fs == null) return false;\n-    Path filePath = fStat.getPath();\n-    // HFile Link is always deletable\n-    if (HFileLink.isHFileLink(filePath)) return true;\n+  public boolean isFileDeletable(FileStatus fStat) {\n+    try {\n+      lock.readLock().lock();\n+      if (this.fs == null) return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91b6bcaafde0424b1974f89f033dff2286d55279"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NDM4MzI0OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/cleaner/HFileLinkCleaner.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNDoyNzoxOVrOIApVrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNDoyNzoxOVrOIApVrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU0ODIwNw==", "bodyText": "Ditto.", "url": "https://github.com/apache/hbase/pull/2738#discussion_r537548207", "createdAt": "2020-12-07T14:27:19Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/cleaner/HFileLinkCleaner.java", "diffHunk": "@@ -44,71 +45,79 @@\n   private static final Logger LOG = LoggerFactory.getLogger(HFileLinkCleaner.class);\n \n   private FileSystem fs = null;\n+  private ReentrantReadWriteLock lock = new ReentrantReadWriteLock();\n \n   @Override\n-  public synchronized boolean isFileDeletable(FileStatus fStat) {\n-    if (this.fs == null) return false;\n-    Path filePath = fStat.getPath();\n-    // HFile Link is always deletable\n-    if (HFileLink.isHFileLink(filePath)) return true;\n+  public boolean isFileDeletable(FileStatus fStat) {\n+    try {\n+      lock.readLock().lock();\n+      if (this.fs == null) return false;\n+      Path filePath = fStat.getPath();\n+      // HFile Link is always deletable\n+      if (HFileLink.isHFileLink(filePath)) return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91b6bcaafde0424b1974f89f033dff2286d55279"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NDM4NTg5OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/cleaner/HFileLinkCleaner.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNDoyNzo0OFrOIApXHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNDoyNzo0OFrOIApXHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU0ODU3NQ==", "bodyText": "Better move this line before the try block.", "url": "https://github.com/apache/hbase/pull/2738#discussion_r537548575", "createdAt": "2020-12-07T14:27:48Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/cleaner/HFileLinkCleaner.java", "diffHunk": "@@ -44,71 +45,79 @@\n   private static final Logger LOG = LoggerFactory.getLogger(HFileLinkCleaner.class);\n \n   private FileSystem fs = null;\n+  private ReentrantReadWriteLock lock = new ReentrantReadWriteLock();\n \n   @Override\n-  public synchronized boolean isFileDeletable(FileStatus fStat) {\n-    if (this.fs == null) return false;\n-    Path filePath = fStat.getPath();\n-    // HFile Link is always deletable\n-    if (HFileLink.isHFileLink(filePath)) return true;\n+  public boolean isFileDeletable(FileStatus fStat) {\n+    try {\n+      lock.readLock().lock();\n+      if (this.fs == null) return false;\n+      Path filePath = fStat.getPath();\n+      // HFile Link is always deletable\n+      if (HFileLink.isHFileLink(filePath)) return true;\n \n-    // If the file is inside a link references directory, means that it is a back ref link.\n-    // The back ref can be deleted only if the referenced file doesn't exists.\n-    Path parentDir = filePath.getParent();\n-    if (HFileLink.isBackReferencesDir(parentDir)) {\n-      Path hfilePath = null;\n-      try {\n-        // Also check if the HFile is in the HBASE_TEMP_DIRECTORY; this is where the referenced\n-        // file gets created when cloning a snapshot.\n-        hfilePath = HFileLink.getHFileFromBackReference(\n-          new Path(CommonFSUtils.getRootDir(getConf()), HConstants.HBASE_TEMP_DIRECTORY), filePath);\n-        if (fs.exists(hfilePath)) {\n-          return false;\n-        }\n-        // check whether the HFileLink still exists in mob dir.\n-        hfilePath = HFileLink.getHFileFromBackReference(MobUtils.getMobHome(getConf()), filePath);\n-        if (fs.exists(hfilePath)) {\n+      // If the file is inside a link references directory, means that it is a back ref link.\n+      // The back ref can be deleted only if the referenced file doesn't exists.\n+      Path parentDir = filePath.getParent();\n+      if (HFileLink.isBackReferencesDir(parentDir)) {\n+        Path hfilePath = null;\n+        try {\n+          // Also check if the HFile is in the HBASE_TEMP_DIRECTORY; this is where the referenced\n+          // file gets created when cloning a snapshot.\n+          hfilePath = HFileLink.getHFileFromBackReference(new Path(CommonFSUtils.getRootDir(getConf()), HConstants.HBASE_TEMP_DIRECTORY),\n+            filePath);\n+          if (fs.exists(hfilePath)) {\n+            return false;\n+          }\n+          // check whether the HFileLink still exists in mob dir.\n+          hfilePath = HFileLink.getHFileFromBackReference(MobUtils.getMobHome(getConf()), filePath);\n+          if (fs.exists(hfilePath)) {\n+            return false;\n+          }\n+          hfilePath = HFileLink.getHFileFromBackReference(CommonFSUtils.getRootDir(getConf()), filePath);\n+          return !fs.exists(hfilePath);\n+        } catch (IOException e) {\n+          if (LOG.isDebugEnabled()) {\n+            LOG.debug(\"Couldn't verify if the referenced file still exists, keep it just in case: \"\n+              + hfilePath);\n+          }\n           return false;\n         }\n-        hfilePath =\n-          HFileLink.getHFileFromBackReference(CommonFSUtils.getRootDir(getConf()), filePath);\n-        return !fs.exists(hfilePath);\n+      }\n+\n+      // HFile is deletable only if has no links\n+      Path backRefDir = null;\n+      try {\n+        backRefDir = HFileLink.getBackReferencesDir(parentDir, filePath.getName());\n+        return CommonFSUtils.listStatus(fs, backRefDir) == null;\n       } catch (IOException e) {\n         if (LOG.isDebugEnabled()) {\n-          LOG.debug(\"Couldn't verify if the referenced file still exists, keep it just in case: \" +\n-            hfilePath);\n+          LOG.debug(\n+            \"Couldn't get the references, not deleting file, just in case. filePath=\" + filePath + \", backRefDir=\" + backRefDir);\n         }\n         return false;\n       }\n-    }\n-\n-    // HFile is deletable only if has no links\n-    Path backRefDir = null;\n-    try {\n-      backRefDir = HFileLink.getBackReferencesDir(parentDir, filePath.getName());\n-      return CommonFSUtils.listStatus(fs, backRefDir) == null;\n-    } catch (IOException e) {\n-      if (LOG.isDebugEnabled()) {\n-        LOG.debug(\"Couldn't get the references, not deleting file, just in case. filePath=\"\n-            + filePath + \", backRefDir=\" + backRefDir);\n-      }\n-      return false;\n+    } finally {\n+      lock.readLock().unlock();\n     }\n   }\n \n   @Override\n-  public synchronized void setConf(Configuration conf) {\n+  public void setConf(Configuration conf) {\n     super.setConf(conf);\n \n     // setup filesystem\n     try {\n+      lock.writeLock().lock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91b6bcaafde0424b1974f89f033dff2286d55279"}, "originalPosition": 115}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2323, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}