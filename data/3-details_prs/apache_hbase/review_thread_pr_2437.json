{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNjY2ODA0", "number": 2437, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxNDowNTozMlrOEn12dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxNDowNTozMlrOEn12dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwMjEyMjE0OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxNDowNTozM1rOHYnmfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNjoxNDozMFrOHbRvuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NjcwMw==", "bodyText": "But after this, you do not get the stat again?\nAnyway, my point here is that, make sure that when we call this method, we have already finished renaming the wal directory and calling recover lease on the wal files. Calling recoverLease and then re-get the FileStatus will generate extra load to NameNode.", "url": "https://github.com/apache/hbase/pull/2437#discussion_r495576703", "createdAt": "2020-09-27T14:05:33Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java", "diffHunk": "@@ -6423,7 +6427,11 @@ protected void restoreEdit(HStore s, Cell cell, MemStoreSizing memstoreAccountin\n    * @throws IOException\n    */\n   private static boolean isZeroLengthThenDelete(final FileSystem fs, final FileStatus stat,\n-      final Path p) throws IOException {\n+      final Path p, Configuration conf) throws IOException {\n+    if (stat.getLen() > 0) {\n+      return false;\n+    }\n+    RecoverLeaseFSUtils.recoverFileLease(fs, p, conf);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3f83c0bcc3724ff80eea4e5ee453920f380844a"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTc2ODMzMg==", "bodyText": "https://github.com/apache/hbase/blob/master/hbase-server/src/main/java/org/apache/hadoop/hbase/master/region/MasterRegion.java#L255\nI think we can make sure we finish rename and recover lease", "url": "https://github.com/apache/hbase/pull/2437#discussion_r495768332", "createdAt": "2020-09-28T08:23:30Z", "author": {"login": "nyl3532016"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java", "diffHunk": "@@ -6423,7 +6427,11 @@ protected void restoreEdit(HStore s, Cell cell, MemStoreSizing memstoreAccountin\n    * @throws IOException\n    */\n   private static boolean isZeroLengthThenDelete(final FileSystem fs, final FileStatus stat,\n-      final Path p) throws IOException {\n+      final Path p, Configuration conf) throws IOException {\n+    if (stat.getLen() > 0) {\n+      return false;\n+    }\n+    RecoverLeaseFSUtils.recoverFileLease(fs, p, conf);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NjcwMw=="}, "originalCommit": {"oid": "b3f83c0bcc3724ff80eea4e5ee453920f380844a"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg1MDI4NA==", "bodyText": "OK, then we do not need to add extra recover lease here.", "url": "https://github.com/apache/hbase/pull/2437#discussion_r495850284", "createdAt": "2020-09-28T10:48:10Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java", "diffHunk": "@@ -6423,7 +6427,11 @@ protected void restoreEdit(HStore s, Cell cell, MemStoreSizing memstoreAccountin\n    * @throws IOException\n    */\n   private static boolean isZeroLengthThenDelete(final FileSystem fs, final FileStatus stat,\n-      final Path p) throws IOException {\n+      final Path p, Configuration conf) throws IOException {\n+    if (stat.getLen() > 0) {\n+      return false;\n+    }\n+    RecoverLeaseFSUtils.recoverFileLease(fs, p, conf);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NjcwMw=="}, "originalCommit": {"oid": "b3f83c0bcc3724ff80eea4e5ee453920f380844a"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI3NTg4NQ==", "bodyText": "@saintstack Here is the conversation", "url": "https://github.com/apache/hbase/pull/2437#discussion_r498275885", "createdAt": "2020-10-01T14:12:20Z", "author": {"login": "nyl3532016"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java", "diffHunk": "@@ -6423,7 +6427,11 @@ protected void restoreEdit(HStore s, Cell cell, MemStoreSizing memstoreAccountin\n    * @throws IOException\n    */\n   private static boolean isZeroLengthThenDelete(final FileSystem fs, final FileStatus stat,\n-      final Path p) throws IOException {\n+      final Path p, Configuration conf) throws IOException {\n+    if (stat.getLen() > 0) {\n+      return false;\n+    }\n+    RecoverLeaseFSUtils.recoverFileLease(fs, p, conf);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NjcwMw=="}, "originalCommit": {"oid": "b3f83c0bcc3724ff80eea4e5ee453920f380844a"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM2NDM0Nw==", "bodyText": "I see now (was resolved so I missed it).\nThen the patch looks good. A nit is that we could do w/ a comment here that says it is safe to trust the zero-length in this case because we've been through rename and lease recovery in the above. Thanks.", "url": "https://github.com/apache/hbase/pull/2437#discussion_r498364347", "createdAt": "2020-10-01T16:14:30Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java", "diffHunk": "@@ -6423,7 +6427,11 @@ protected void restoreEdit(HStore s, Cell cell, MemStoreSizing memstoreAccountin\n    * @throws IOException\n    */\n   private static boolean isZeroLengthThenDelete(final FileSystem fs, final FileStatus stat,\n-      final Path p) throws IOException {\n+      final Path p, Configuration conf) throws IOException {\n+    if (stat.getLen() > 0) {\n+      return false;\n+    }\n+    RecoverLeaseFSUtils.recoverFileLease(fs, p, conf);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU3NjcwMw=="}, "originalCommit": {"oid": "b3f83c0bcc3724ff80eea4e5ee453920f380844a"}, "originalPosition": 48}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2499, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}