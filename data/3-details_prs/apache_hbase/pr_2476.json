{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1MzQxNjEw", "number": 2476, "title": "HBASE-25121 Refactor MetaTableAccessor.addRegionsToMeta and its usage\u2026", "bodyText": "\u2026 places", "createdAt": "2020-09-30T08:27:39Z", "url": "https://github.com/apache/hbase/pull/2476", "merged": true, "mergeCommit": {"oid": "9ba90e16793a120f211e2eb4403007926cf2354e"}, "closed": true, "closedAt": "2020-10-05T13:29:56Z", "author": {"login": "Apache9"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOlSjwABqjM4MzM3ODcwODE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPcJZHAFqTUwMTcxMjMyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c4514c663b8c3ff7b5a2e915953a40aec5f35143", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/c4514c663b8c3ff7b5a2e915953a40aec5f35143", "committedDate": "2020-09-30T14:29:54Z", "message": "fix checkstyle"}, "afterCommit": {"oid": "14c3cfef5dcc359d80bab2cf3f6791d30bddf554", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/14c3cfef5dcc359d80bab2cf3f6791d30bddf554", "committedDate": "2020-10-02T12:38:41Z", "message": "HBASE-25121 Refactor MetaTableAccessor.addRegionsToMeta and its usage places"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "14c3cfef5dcc359d80bab2cf3f6791d30bddf554", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/14c3cfef5dcc359d80bab2cf3f6791d30bddf554", "committedDate": "2020-10-02T12:38:41Z", "message": "HBASE-25121 Refactor MetaTableAccessor.addRegionsToMeta and its usage places"}, "afterCommit": {"oid": "244425b671924540f8e00448c819d5ca99d9c7bb", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/244425b671924540f8e00448c819d5ca99d9c7bb", "committedDate": "2020-10-02T15:18:54Z", "message": "HBASE-25121 Refactor MetaTableAccessor.addRegionsToMeta and its usage places"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7352590896fb4f102667b9e19425334861d46b6", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/d7352590896fb4f102667b9e19425334861d46b6", "committedDate": "2020-10-03T13:57:23Z", "message": "HBASE-25121 Refactor MetaTableAccessor.addRegionsToMeta and its usage places"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "244425b671924540f8e00448c819d5ca99d9c7bb", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/244425b671924540f8e00448c819d5ca99d9c7bb", "committedDate": "2020-10-02T15:18:54Z", "message": "HBASE-25121 Refactor MetaTableAccessor.addRegionsToMeta and its usage places"}, "afterCommit": {"oid": "d7352590896fb4f102667b9e19425334861d46b6", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/d7352590896fb4f102667b9e19425334861d46b6", "committedDate": "2020-10-03T13:57:23Z", "message": "HBASE-25121 Refactor MetaTableAccessor.addRegionsToMeta and its usage places"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNzEyMzI1", "url": "https://github.com/apache/hbase/pull/2476#pullrequestreview-501712325", "createdAt": "2020-10-05T04:11:41Z", "commit": {"oid": "d7352590896fb4f102667b9e19425334861d46b6"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNDoxMTo0MVrOHcNK-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNDoyOTozOFrOHcNW5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMzNzk3OA==", "bodyText": "If old and new  replica counts are equal, we just pass through -- that seems right.", "url": "https://github.com/apache/hbase/pull/2476#discussion_r499337978", "createdAt": "2020-10-05T04:11:41Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/RegionStateStore.java", "diffHunk": "@@ -545,6 +547,83 @@ public void overwriteRegions(List<RegionInfo> regionInfos, int regionReplication\n     LOG.debug(\"Overwritten regions: {} \", regionInfos);\n   }\n \n+  /**\n+   * Update region replicas if necessary by adding new replica locations or removing unused region\n+   * replicas\n+   */\n+  public void updateRegionReplicas(TableName tableName, int oldReplicaCount, int newReplicaCount)\n+    throws IOException {\n+    if (newReplicaCount < oldReplicaCount) {\n+      removeRegionReplicas(tableName, oldReplicaCount, newReplicaCount);\n+    } else if (newReplicaCount > oldReplicaCount) {\n+      addRegionReplicas(tableName, oldReplicaCount, newReplicaCount);\n+    }\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7352590896fb4f102667b9e19425334861d46b6"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMzODUxMw==", "bodyText": "Not your fault but this is ugly... Pity replica columns were not tied together w/ a prefix (or in their on column family). For later.", "url": "https://github.com/apache/hbase/pull/2476#discussion_r499338513", "createdAt": "2020-10-05T04:14:30Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/RegionStateStore.java", "diffHunk": "@@ -545,6 +547,83 @@ public void overwriteRegions(List<RegionInfo> regionInfos, int regionReplication\n     LOG.debug(\"Overwritten regions: {} \", regionInfos);\n   }\n \n+  /**\n+   * Update region replicas if necessary by adding new replica locations or removing unused region\n+   * replicas\n+   */\n+  public void updateRegionReplicas(TableName tableName, int oldReplicaCount, int newReplicaCount)\n+    throws IOException {\n+    if (newReplicaCount < oldReplicaCount) {\n+      removeRegionReplicas(tableName, oldReplicaCount, newReplicaCount);\n+    } else if (newReplicaCount > oldReplicaCount) {\n+      addRegionReplicas(tableName, oldReplicaCount, newReplicaCount);\n+    }\n+  }\n+\n+  private Scan getScanForUpdateRegionReplicas(TableName tableName) {\n+    return MetaTableAccessor.getScanForTableName(master.getConfiguration(), tableName)\n+      .addColumn(HConstants.CATALOG_FAMILY, HConstants.REGIONINFO_QUALIFIER);\n+  }\n+\n+  private void removeRegionReplicas(TableName tableName, int oldReplicaCount, int newReplicaCount)\n+    throws IOException {\n+    Scan scan = getScanForUpdateRegionReplicas(tableName);\n+    List<Delete> deletes = new ArrayList<>();\n+    long now = EnvironmentEdgeManager.currentTime();\n+    try (Table metaTable = getMetaTable(); ResultScanner scanner = metaTable.getScanner(scan)) {\n+      for (;;) {\n+        Result result = scanner.next();\n+        if (result == null) {\n+          break;\n+        }\n+        RegionInfo primaryRegionInfo = CatalogFamilyFormat.getRegionInfo(result);\n+        if (primaryRegionInfo == null || primaryRegionInfo.isSplitParent()) {\n+          continue;\n+        }\n+        Delete delete = new Delete(result.getRow());\n+        for (int i = newReplicaCount; i < oldReplicaCount; i++) {\n+          delete.addColumns(HConstants.CATALOG_FAMILY, CatalogFamilyFormat.getServerColumn(i), now);\n+          delete.addColumns(HConstants.CATALOG_FAMILY, CatalogFamilyFormat.getSeqNumColumn(i), now);\n+          delete.addColumns(HConstants.CATALOG_FAMILY, CatalogFamilyFormat.getStartCodeColumn(i),\n+            now);\n+          delete.addColumns(HConstants.CATALOG_FAMILY, CatalogFamilyFormat.getServerNameColumn(i),\n+            now);\n+          delete.addColumns(HConstants.CATALOG_FAMILY, CatalogFamilyFormat.getRegionStateColumn(i),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7352590896fb4f102667b9e19425334861d46b6"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM0MDkzMg==", "bodyText": "You don't want to make this a try (Table metaTalbe = env.getMaster....) .. instead so it gets auto-closed? (nit)", "url": "https://github.com/apache/hbase/pull/2476#discussion_r499340932", "createdAt": "2020-10-05T04:29:03Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/procedure/DeleteTableProcedure.java", "diffHunk": "@@ -357,22 +358,29 @@ protected static void deleteFromFs(final MasterProcedureEnv env,\n   /**\n    * There may be items for this table still up in hbase:meta in the case where the info:regioninfo\n    * column was empty because of some write error. Remove ALL rows from hbase:meta that have to do\n-   * with this table. See HBASE-12980.\n+   * with this table.\n+   * <p/>\n+   * See HBASE-12980.\n    */\n   private static void cleanRegionsInMeta(final MasterProcedureEnv env, final TableName tableName)\n-      throws IOException {\n-    Connection connection = env.getMasterServices().getConnection();\n-    Scan tableScan = MetaTableAccessor.getScanForTableName(connection, tableName);\n-    try (Table metaTable = connection.getTable(TableName.META_TABLE_NAME)) {\n-      List<Delete> deletes = new ArrayList<>();\n-      try (ResultScanner resScanner = metaTable.getScanner(tableScan)) {\n-        for (Result result : resScanner) {\n-          deletes.add(new Delete(result.getRow()));\n+    throws IOException {\n+    Scan tableScan = MetaTableAccessor.getScanForTableName(env.getMasterConfiguration(), tableName)\n+      .setFilter(new KeyOnlyFilter());\n+    long now = EnvironmentEdgeManager.currentTime();\n+    List<Delete> deletes = new ArrayList<>();\n+    try (", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7352590896fb4f102667b9e19425334861d46b6"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM0MTAzMA==", "bodyText": "Ditto on the ResultScanner?", "url": "https://github.com/apache/hbase/pull/2476#discussion_r499341030", "createdAt": "2020-10-05T04:29:38Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/procedure/DeleteTableProcedure.java", "diffHunk": "@@ -357,22 +358,29 @@ protected static void deleteFromFs(final MasterProcedureEnv env,\n   /**\n    * There may be items for this table still up in hbase:meta in the case where the info:regioninfo\n    * column was empty because of some write error. Remove ALL rows from hbase:meta that have to do\n-   * with this table. See HBASE-12980.\n+   * with this table.\n+   * <p/>\n+   * See HBASE-12980.\n    */\n   private static void cleanRegionsInMeta(final MasterProcedureEnv env, final TableName tableName)\n-      throws IOException {\n-    Connection connection = env.getMasterServices().getConnection();\n-    Scan tableScan = MetaTableAccessor.getScanForTableName(connection, tableName);\n-    try (Table metaTable = connection.getTable(TableName.META_TABLE_NAME)) {\n-      List<Delete> deletes = new ArrayList<>();\n-      try (ResultScanner resScanner = metaTable.getScanner(tableScan)) {\n-        for (Result result : resScanner) {\n-          deletes.add(new Delete(result.getRow()));\n+    throws IOException {\n+    Scan tableScan = MetaTableAccessor.getScanForTableName(env.getMasterConfiguration(), tableName)\n+      .setFilter(new KeyOnlyFilter());\n+    long now = EnvironmentEdgeManager.currentTime();\n+    List<Delete> deletes = new ArrayList<>();\n+    try (", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM0MDkzMg=="}, "originalCommit": {"oid": "d7352590896fb4f102667b9e19425334861d46b6"}, "originalPosition": 46}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4620, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}