{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2MTIwMjgx", "number": 1825, "title": "HBASE-24189 WALSplit recreates region dirs for deleted table with rec\u2026", "bodyText": "\u2026overed edits data.", "createdAt": "2020-06-01T17:36:18Z", "url": "https://github.com/apache/hbase/pull/1825", "merged": true, "mergeCommit": {"oid": "4005e42a62abd8ffca765aafed2bd53b4889b2c4"}, "closed": true, "closedAt": "2020-06-11T15:57:21Z", "author": {"login": "anoopsjohn"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnD0KQgH2gAyNDI2MTIwMjgxOjIxMjAzNDBhNDUxNWI2MjA1Y2UwNWM5NDVmYmQzMzY3ODc0OGY2YTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqPyHYgH2gAyNDI2MTIwMjgxOjMxMzk2N2Q1NDBhNzVmNmYwM2NmOTZjYmE3ZjE2M2M0NmE4YTAyOTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2120340a4515b6205ce05c945fbd33678748f6a9", "author": {"user": {"login": "anoopsjohn", "name": "Anoop Sam John"}}, "url": "https://github.com/apache/hbase/commit/2120340a4515b6205ce05c945fbd33678748f6a9", "committedDate": "2020-06-01T17:35:49Z", "message": "HBASE-24189 WALSplit recreates region dirs for deleted table with recovered edits data."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMjI3MDE1", "url": "https://github.com/apache/hbase/pull/1825#pullrequestreview-422227015", "createdAt": "2020-06-01T22:35:20Z", "commit": {"oid": "2120340a4515b6205ce05c945fbd33678748f6a9"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMjozNToyMFrOGdcSjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQyMjozNzoyMFrOGdcVCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUyNTM4OQ==", "bodyText": "Should hbase-common know about region dirs? Seems like it knows about table dirs so I suppose this ok.", "url": "https://github.com/apache/hbase/pull/1825#discussion_r433525389", "createdAt": "2020-06-01T22:35:20Z", "author": {"login": "saintstack"}, "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/util/CommonFSUtils.java", "diffHunk": "@@ -423,6 +423,19 @@ public static Path getTableDir(Path rootdir, final TableName tableName) {\n         tableName.getQualifierAsString());\n   }\n \n+  /**\n+   * Returns the {@link org.apache.hadoop.fs.Path} object representing the region directory under\n+   * path rootdir\n+   *\n+   * @param rootdir qualified path of HBase root directory\n+   * @param tableName name of table\n+   * @param regionName The encoded region name\n+   * @return {@link org.apache.hadoop.fs.Path} for region\n+   */\n+  public static Path getRegionDir(Path rootdir, TableName tableName, String regionName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2120340a4515b6205ce05c945fbd33678748f6a9"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzUyNjAyNg==", "bodyText": "Is it WAL FS dir or the data/hfile FS?", "url": "https://github.com/apache/hbase/pull/1825#discussion_r433526026", "createdAt": "2020-06-01T22:37:20Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALSplitter.java", "diffHunk": "@@ -285,23 +286,35 @@ boolean splitLogFile(FileStatus logfile, CancelableProgressable reporter) throws\n         String encodedRegionNameAsStr = Bytes.toString(region);\n         lastFlushedSequenceId = lastFlushedSequenceIds.get(encodedRegionNameAsStr);\n         if (lastFlushedSequenceId == null) {\n-          if (sequenceIdChecker != null) {\n-            RegionStoreSequenceIds ids = sequenceIdChecker.getLastSequenceId(region);\n-            Map<byte[], Long> maxSeqIdInStores = new TreeMap<>(Bytes.BYTES_COMPARATOR);\n-            for (StoreSequenceId storeSeqId : ids.getStoreSequenceIdList()) {\n-              maxSeqIdInStores.put(storeSeqId.getFamilyName().toByteArray(),\n-                storeSeqId.getSequenceId());\n+          if (!(isRegionDirPresentUnderRoot(entry.getKey().getTableName(), encodedRegionNameAsStr))) {\n+            // The region directory itself is not present in the WAL FS. This indicates that", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2120340a4515b6205ce05c945fbd33678748f6a9"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f2c3b247b0611520771146660ec81ed0d24f8b8", "author": {"user": {"login": "anoopsjohn", "name": "Anoop Sam John"}}, "url": "https://github.com/apache/hbase/commit/8f2c3b247b0611520771146660ec81ed0d24f8b8", "committedDate": "2020-06-02T08:38:01Z", "message": "HBASE-24189 WALSplit recreates region dirs for deleted table with recovered edits data."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyOTI5OTI2", "url": "https://github.com/apache/hbase/pull/1825#pullrequestreview-422929926", "createdAt": "2020-06-02T17:59:39Z", "commit": {"oid": "8f2c3b247b0611520771146660ec81ed0d24f8b8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNzo1OTozOVrOGd9Z7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNzo1OTozOVrOGd9Z7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDA2Nzk0OA==", "bodyText": "Is this the right test to do? Should we rather ask the Master if this is an active Region? Asking the FS could be racy?  E.g. something like maser.getAM.getRegionStates().isRegionInRegionStates... It takes HRI which you might not have so you might need to add a version that takes encoded region name?", "url": "https://github.com/apache/hbase/pull/1825#discussion_r434067948", "createdAt": "2020-06-02T17:59:39Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALSplitter.java", "diffHunk": "@@ -285,23 +286,35 @@ boolean splitLogFile(FileStatus logfile, CancelableProgressable reporter) throws\n         String encodedRegionNameAsStr = Bytes.toString(region);\n         lastFlushedSequenceId = lastFlushedSequenceIds.get(encodedRegionNameAsStr);\n         if (lastFlushedSequenceId == null) {\n-          if (sequenceIdChecker != null) {\n-            RegionStoreSequenceIds ids = sequenceIdChecker.getLastSequenceId(region);\n-            Map<byte[], Long> maxSeqIdInStores = new TreeMap<>(Bytes.BYTES_COMPARATOR);\n-            for (StoreSequenceId storeSeqId : ids.getStoreSequenceIdList()) {\n-              maxSeqIdInStores.put(storeSeqId.getFamilyName().toByteArray(),\n-                storeSeqId.getSequenceId());\n+          if (!(isRegionDirPresentUnderRoot(entry.getKey().getTableName(), encodedRegionNameAsStr))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f2c3b247b0611520771146660ec81ed0d24f8b8"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzNzk2NDAy", "url": "https://github.com/apache/hbase/pull/1825#pullrequestreview-423796402", "createdAt": "2020-06-03T17:54:54Z", "commit": {"oid": "8f2c3b247b0611520771146660ec81ed0d24f8b8"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNzo1NDo1NFrOGenGfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxODoxNzowNFrOGen36A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc1MTEwMg==", "bodyText": "If the Region no longer exists, should we even be adding state for it in here other than perhaps local state to save having to do expensive lookups again?\nThe comment here exposes some of the soft logic this change depends upon; we are looking at FS and whether a dir is present or not, we then suppose Region present or not.\nI think we should be asking the Master. If it is racy around split/merge, then its a bug given Master transitions are meant to be locked down--not racy. What you think Anoop?", "url": "https://github.com/apache/hbase/pull/1825#discussion_r434751102", "createdAt": "2020-06-03T17:54:54Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALSplitter.java", "diffHunk": "@@ -285,23 +286,35 @@ boolean splitLogFile(FileStatus logfile, CancelableProgressable reporter) throws\n         String encodedRegionNameAsStr = Bytes.toString(region);\n         lastFlushedSequenceId = lastFlushedSequenceIds.get(encodedRegionNameAsStr);\n         if (lastFlushedSequenceId == null) {\n-          if (sequenceIdChecker != null) {\n-            RegionStoreSequenceIds ids = sequenceIdChecker.getLastSequenceId(region);\n-            Map<byte[], Long> maxSeqIdInStores = new TreeMap<>(Bytes.BYTES_COMPARATOR);\n-            for (StoreSequenceId storeSeqId : ids.getStoreSequenceIdList()) {\n-              maxSeqIdInStores.put(storeSeqId.getFamilyName().toByteArray(),\n-                storeSeqId.getSequenceId());\n+          if (!(isRegionDirPresentUnderRoot(entry.getKey().getTableName(), encodedRegionNameAsStr))) {\n+            // The region directory itself is not present in the FS. This indicates that\n+            // the region/table is already removed. We can just skip all the edits for this\n+            // region. Setting lastFlushedSequenceId as Long.MAX_VALUE so that all edits\n+            // will get skipped by the seqId check below.\n+            // See more details at https://issues.apache.org/jira/browse/HBASE-24189\n+            LOG.debug(\n+                \"Region {} seems not available in the FS. Just skipping all edits for this region\",\n+                encodedRegionNameAsStr);\n+            lastFlushedSequenceId = Long.MAX_VALUE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f2c3b247b0611520771146660ec81ed0d24f8b8"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc2MTgwNg==", "bodyText": "But....ouch.. ouch... ouch. This stuff runs on the RegionServer? You can't ask the Master.. dang.\nSo we are splitting arbitrary WALs.", "url": "https://github.com/apache/hbase/pull/1825#discussion_r434761806", "createdAt": "2020-06-03T18:13:35Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALSplitter.java", "diffHunk": "@@ -285,23 +286,35 @@ boolean splitLogFile(FileStatus logfile, CancelableProgressable reporter) throws\n         String encodedRegionNameAsStr = Bytes.toString(region);\n         lastFlushedSequenceId = lastFlushedSequenceIds.get(encodedRegionNameAsStr);\n         if (lastFlushedSequenceId == null) {\n-          if (sequenceIdChecker != null) {\n-            RegionStoreSequenceIds ids = sequenceIdChecker.getLastSequenceId(region);\n-            Map<byte[], Long> maxSeqIdInStores = new TreeMap<>(Bytes.BYTES_COMPARATOR);\n-            for (StoreSequenceId storeSeqId : ids.getStoreSequenceIdList()) {\n-              maxSeqIdInStores.put(storeSeqId.getFamilyName().toByteArray(),\n-                storeSeqId.getSequenceId());\n+          if (!(isRegionDirPresentUnderRoot(entry.getKey().getTableName(), encodedRegionNameAsStr))) {\n+            // The region directory itself is not present in the FS. This indicates that\n+            // the region/table is already removed. We can just skip all the edits for this\n+            // region. Setting lastFlushedSequenceId as Long.MAX_VALUE so that all edits\n+            // will get skipped by the seqId check below.\n+            // See more details at https://issues.apache.org/jira/browse/HBASE-24189\n+            LOG.debug(\n+                \"Region {} seems not available in the FS. Just skipping all edits for this region\",\n+                encodedRegionNameAsStr);\n+            lastFlushedSequenceId = Long.MAX_VALUE;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc1MTEwMg=="}, "originalCommit": {"oid": "8f2c3b247b0611520771146660ec81ed0d24f8b8"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDc2Mzc1Mg==", "bodyText": "Don't say 'seems'.  LOG this at info level I think. You don't need the word 'region' in the log... it is plain from context.... {} is not on the FS; skipping all edits.", "url": "https://github.com/apache/hbase/pull/1825#discussion_r434763752", "createdAt": "2020-06-03T18:17:04Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/wal/WALSplitter.java", "diffHunk": "@@ -285,23 +286,35 @@ boolean splitLogFile(FileStatus logfile, CancelableProgressable reporter) throws\n         String encodedRegionNameAsStr = Bytes.toString(region);\n         lastFlushedSequenceId = lastFlushedSequenceIds.get(encodedRegionNameAsStr);\n         if (lastFlushedSequenceId == null) {\n-          if (sequenceIdChecker != null) {\n-            RegionStoreSequenceIds ids = sequenceIdChecker.getLastSequenceId(region);\n-            Map<byte[], Long> maxSeqIdInStores = new TreeMap<>(Bytes.BYTES_COMPARATOR);\n-            for (StoreSequenceId storeSeqId : ids.getStoreSequenceIdList()) {\n-              maxSeqIdInStores.put(storeSeqId.getFamilyName().toByteArray(),\n-                storeSeqId.getSequenceId());\n+          if (!(isRegionDirPresentUnderRoot(entry.getKey().getTableName(), encodedRegionNameAsStr))) {\n+            // The region directory itself is not present in the FS. This indicates that\n+            // the region/table is already removed. We can just skip all the edits for this\n+            // region. Setting lastFlushedSequenceId as Long.MAX_VALUE so that all edits\n+            // will get skipped by the seqId check below.\n+            // See more details at https://issues.apache.org/jira/browse/HBASE-24189\n+            LOG.debug(\n+                \"Region {} seems not available in the FS. Just skipping all edits for this region\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f2c3b247b0611520771146660ec81ed0d24f8b8"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0OTEwNjQ4", "url": "https://github.com/apache/hbase/pull/1825#pullrequestreview-424910648", "createdAt": "2020-06-04T23:49:38Z", "commit": {"oid": "8f2c3b247b0611520771146660ec81ed0d24f8b8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MTMwMDYy", "url": "https://github.com/apache/hbase/pull/1825#pullrequestreview-425130062", "createdAt": "2020-06-05T09:12:22Z", "commit": {"oid": "8f2c3b247b0611520771146660ec81ed0d24f8b8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed7c0f56afcdc3b24e89f4598abca3735434f454", "author": {"user": {"login": "anoopsjohn", "name": "Anoop Sam John"}}, "url": "https://github.com/apache/hbase/commit/ed7c0f56afcdc3b24e89f4598abca3735434f454", "committedDate": "2020-06-09T06:47:09Z", "message": "HBASE-24189 WALSplit recreates region dirs for deleted table with recovered edits data."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "313967d540a75f6f03cf96cba7f163c46a8a0296", "author": {"user": {"login": "anoopsjohn", "name": "Anoop Sam John"}}, "url": "https://github.com/apache/hbase/commit/313967d540a75f6f03cf96cba7f163c46a8a0296", "committedDate": "2020-06-11T15:14:13Z", "message": "HBASE-24189 WALSplit recreates region dirs for deleted table with recovered edits data."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4493, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}