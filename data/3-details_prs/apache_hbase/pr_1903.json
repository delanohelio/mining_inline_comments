{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0NjIzNDc3", "number": 1903, "title": "HBASE-24562: Stabilize master startup with meta replicas enabled", "bodyText": "This is related to HBASE-21624 .\nI created a separate ticket because in the original one a \"complete solution for meta replicas\" was requested and this is not one. I'm just trying to make master startup more stable by making assigning meta replicas asynchronous and preventing a potential assignment failure from crashing master.\nThe idea is that starting master with less or even no meta replicas assigned is preferable to not having a running master.", "createdAt": "2020-06-15T15:44:01Z", "url": "https://github.com/apache/hbase/pull/1903", "merged": true, "mergeCommit": {"oid": "8cdb2cca4461d6adad3f44af001055848a205370"}, "closed": true, "closedAt": "2020-06-24T17:38:37Z", "author": {"login": "BukrosSzabolcs"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrilQ5AH2gAyNDM0NjIzNDc3OjM2OGI1ZjcxZTM3MDY5MGMzNjVlM2U3NjJjMTQ0MDc0YzliY2ZlODc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcswC76AFqTQzMzk1MTI3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "368b5f71e370690c365e3e762c144074c9bcfe87", "author": {"user": {"login": "BukrosSzabolcs", "name": null}}, "url": "https://github.com/apache/hbase/commit/368b5f71e370690c365e3e762c144074c9bcfe87", "committedDate": "2020-06-15T15:42:18Z", "message": "HBASE-24562: Stabilize master startup with meta replicas enabled\n\nmake meta replication async\ncatch and log exception instead of letting it crash master\nadd test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwODAzMzYz", "url": "https://github.com/apache/hbase/pull/1903#pullrequestreview-430803363", "createdAt": "2020-06-15T16:25:33Z", "commit": {"oid": "368b5f71e370690c365e3e762c144074c9bcfe87"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNjoyNTozNFrOGj5o3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxNjoyNTozNFrOGj5o3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI5NzY5NQ==", "bodyText": "As the main purpose of the change is to allow Master to complete initialisation in case of meta replica failures, shouldn't this test assert that HMaster.finishActiveMasterInitialization completes properly even with the induced replicas assignment failures? I can see we are asserting that replicas assignment fails, which is not what we actually want to safeguard from.", "url": "https://github.com/apache/hbase/pull/1903#discussion_r440297695", "createdAt": "2020-06-15T16:25:34Z", "author": {"login": "wchevreuil"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestMetaWithReplicas.java", "diffHunk": "@@ -355,4 +362,58 @@ public void testShutdownOfReplicaHolder() throws Exception {\n       assertNotEquals(3, i);\n     }\n   }\n+\n+  @Test\n+  public void testFailedReplicaAssigment() throws InterruptedException, IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "368b5f71e370690c365e3e762c144074c9bcfe87"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da610375a2e66d7407dfd3ff9aebad423e84a9e7", "author": {"user": {"login": "BukrosSzabolcs", "name": null}}, "url": "https://github.com/apache/hbase/commit/da610375a2e66d7407dfd3ff9aebad423e84a9e7", "committedDate": "2020-06-16T13:29:29Z", "message": "HBASE-24562: Stabilize master startup with meta replicas enabled"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNzA5NzY3", "url": "https://github.com/apache/hbase/pull/1903#pullrequestreview-432709767", "createdAt": "2020-06-17T19:28:45Z", "commit": {"oid": "368b5f71e370690c365e3e762c144074c9bcfe87"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxOToyODo0NlrOGlUTxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxOTo1MjoyOFrOGlVEIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4MzIzNw==", "bodyText": "assignMetaReplicas() throws IOException, InterruptedException, and KeeperException. Why only HBaseIOException is processed here? Should it catch all exceptions and totally ignore all exceptions caused by assignMetaReplicas()?", "url": "https://github.com/apache/hbase/pull/1903#discussion_r441783237", "createdAt": "2020-06-17T19:28:46Z", "author": {"login": "huaxiangsun"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/HMaster.java", "diffHunk": "@@ -1166,7 +1166,11 @@ private void finishActiveMasterInitialization(MonitoredTask status) throws IOExc\n     assignmentManager.checkIfShouldMoveSystemRegionAsync();\n     status.setStatus(\"Assign meta replicas\");\n     MasterMetaBootstrap metaBootstrap = createMetaBootstrap();\n-    metaBootstrap.assignMetaReplicas();\n+    try {\n+      metaBootstrap.assignMetaReplicas();\n+    } catch (HBaseIOException e){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "368b5f71e370690c365e3e762c144074c9bcfe87"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4NDMzNg==", "bodyText": "Most of this method's code is a duplicate  of the assign() above, the common part can be wrapped in a private method.", "url": "https://github.com/apache/hbase/pull/1903#discussion_r441784336", "createdAt": "2020-06-17T19:30:59Z", "author": {"login": "huaxiangsun"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/AssignmentManager.java", "diffHunk": "@@ -616,6 +616,24 @@ public long assign(RegionInfo regionInfo) throws IOException {\n     return assign(regionInfo, null);\n   }\n \n+  public Future<byte[]> assignAsync(RegionInfo regionInfo, ServerName sn) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "368b5f71e370690c365e3e762c144074c9bcfe87"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4NTIwNA==", "bodyText": "If we are adding a new public method, can we have doc for these two new methods?", "url": "https://github.com/apache/hbase/pull/1903#discussion_r441785204", "createdAt": "2020-06-17T19:32:28Z", "author": {"login": "huaxiangsun"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/AssignmentManager.java", "diffHunk": "@@ -616,6 +616,24 @@ public long assign(RegionInfo regionInfo) throws IOException {\n     return assign(regionInfo, null);\n   }\n \n+  public Future<byte[]> assignAsync(RegionInfo regionInfo, ServerName sn) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4NDMzNg=="}, "originalCommit": {"oid": "368b5f71e370690c365e3e762c144074c9bcfe87"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5NTYxNg==", "bodyText": "Have one question about the test case, do not see any exceptions thrown out during assigning meta replica regions, how do we make sure the following code is working.\n    try {\n      metaBootstrap.assignMetaReplicas();\n    } catch (HBaseIOException e){\n\nIf we can make sure that the test can compile with or without the changes in non-test modules, it will be great as we can verify that without those changes, the test will fail. Seems with current implementation, it is not possible.", "url": "https://github.com/apache/hbase/pull/1903#discussion_r441795616", "createdAt": "2020-06-17T19:52:28Z", "author": {"login": "huaxiangsun"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestMetaWithReplicas.java", "diffHunk": "@@ -355,4 +362,58 @@ public void testShutdownOfReplicaHolder() throws Exception {\n       assertNotEquals(3, i);\n     }\n   }\n+\n+  @Test\n+  public void testFailedReplicaAssigment() throws InterruptedException, IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI5NzY5NQ=="}, "originalCommit": {"oid": "368b5f71e370690c365e3e762c144074c9bcfe87"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95a9fd2548365acce176998b4e8d30d096a96320", "author": {"user": {"login": "BukrosSzabolcs", "name": null}}, "url": "https://github.com/apache/hbase/commit/95a9fd2548365acce176998b4e8d30d096a96320", "committedDate": "2020-06-18T13:02:47Z", "message": "HBASE-24562: Stabilize master startup with meta replicas enabled\n\nextract common assign code\nadd docs to new methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "850461ec85f4c8f9179e82ae913eb970c062ed1b", "author": {"user": {"login": "BukrosSzabolcs", "name": null}}, "url": "https://github.com/apache/hbase/commit/850461ec85f4c8f9179e82ae913eb970c062ed1b", "committedDate": "2020-06-18T16:48:55Z", "message": "HBASE-24562: Stabilize master startup with meta replicas enabled\n\nalso catch KeeperException"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNjkzNjEy", "url": "https://github.com/apache/hbase/pull/1903#pullrequestreview-433693612", "createdAt": "2020-06-18T22:40:14Z", "commit": {"oid": "850461ec85f4c8f9179e82ae913eb970c062ed1b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f1adf83e64b712a93db4ff0205bf14a420c8ce5", "author": {"user": {"login": "BukrosSzabolcs", "name": null}}, "url": "https://github.com/apache/hbase/commit/6f1adf83e64b712a93db4ff0205bf14a420c8ce5", "committedDate": "2020-06-19T07:31:21Z", "message": "HBASE-24562: Stabilize master startup with meta replicas enabled\n\ncatch IOException instead of HbaseIOException"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzOTUxMjc4", "url": "https://github.com/apache/hbase/pull/1903#pullrequestreview-433951278", "createdAt": "2020-06-19T09:57:24Z", "commit": {"oid": "6f1adf83e64b712a93db4ff0205bf14a420c8ce5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4618, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}