{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxMDE0NzY2", "number": 1749, "title": "HBASE-24367 ScheduledChore log elapsed timespan in a human-friendly format", "bodyText": "", "createdAt": "2020-05-20T20:54:54Z", "url": "https://github.com/apache/hbase/pull/1749", "merged": true, "mergeCommit": {"oid": "474d200daa795d65ef0992dbb4ad758895d9c4dc"}, "closed": true, "closedAt": "2020-06-09T16:55:20Z", "author": {"login": "apurtell"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjTBXPgFqTQxNTgxMzQ0Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpfaw2AFqTQyNjgzNjI5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1ODEzNDQ3", "url": "https://github.com/apache/hbase/pull/1749#pullrequestreview-415813447", "createdAt": "2020-05-21T01:03:06Z", "commit": {"oid": "068b54cae428b01f9e214e6ea66a0c0bc5a5ec75"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwMTowMzowN1rOGYi3wQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwMTowMzowN1rOGYi3wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5MDMzNw==", "bodyText": "log the start time, too? If the debug was enabled between execution, may get a wrong execution time?", "url": "https://github.com/apache/hbase/pull/1749#discussion_r428390337", "createdAt": "2020-05-21T01:03:07Z", "author": {"login": "infraio"}, "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/ScheduledChore.java", "diffHunk": "@@ -183,18 +176,21 @@ public void run() {\n       if (LOG.isInfoEnabled()) LOG.info(\"Chore: \" + getName() + \" was stopped\");\n     } else {\n       try {\n+        // TODO: Histogram metrics per chore name.\n+        // For now, just measure and log if DEBUG level logging is enabled.\n+        long start = 0;\n+        if (LOG.isDebugEnabled()) {\n+          start = System.nanoTime();\n+        }\n         if (!initialChoreComplete) {\n           initialChoreComplete = initialChore();\n         } else {\n-          timeMeasurement.measure(() -> {\n             chore();\n-            return null;\n-          });\n-          if (LOG.isInfoEnabled() && (System.nanoTime() - lastLog > FIVE_MINUTES_IN_NANOS)) {\n-            LOG.info(\"{} average execution time: {} ns.\", getName(),\n-                (long)(timeMeasurement.getAverageTime()));\n-            lastLog = System.nanoTime();\n-          }\n+        }\n+        if (LOG.isDebugEnabled()) {\n+          long end = System.nanoTime();\n+          LOG.debug(\"{} execution time: {} ms.\", getName(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "068b54cae428b01f9e214e6ea66a0c0bc5a5ec75"}, "originalPosition": 53}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MTQwMzE5", "url": "https://github.com/apache/hbase/pull/1749#pullrequestreview-417140319", "createdAt": "2020-05-22T19:22:09Z", "commit": {"oid": "068b54cae428b01f9e214e6ea66a0c0bc5a5ec75"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxOToyMjoxMFrOGZhnjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxOToyNzoyMFrOGZhu-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQxODM4Mg==", "bodyText": "Oh, fun edge case @infraio :) How about a check that start > 0 and only log in that case?", "url": "https://github.com/apache/hbase/pull/1749#discussion_r429418382", "createdAt": "2020-05-22T19:22:10Z", "author": {"login": "ndimiduk"}, "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/ScheduledChore.java", "diffHunk": "@@ -183,18 +176,21 @@ public void run() {\n       if (LOG.isInfoEnabled()) LOG.info(\"Chore: \" + getName() + \" was stopped\");\n     } else {\n       try {\n+        // TODO: Histogram metrics per chore name.\n+        // For now, just measure and log if DEBUG level logging is enabled.\n+        long start = 0;\n+        if (LOG.isDebugEnabled()) {\n+          start = System.nanoTime();\n+        }\n         if (!initialChoreComplete) {\n           initialChoreComplete = initialChore();\n         } else {\n-          timeMeasurement.measure(() -> {\n             chore();\n-            return null;\n-          });\n-          if (LOG.isInfoEnabled() && (System.nanoTime() - lastLog > FIVE_MINUTES_IN_NANOS)) {\n-            LOG.info(\"{} average execution time: {} ns.\", getName(),\n-                (long)(timeMeasurement.getAverageTime()));\n-            lastLog = System.nanoTime();\n-          }\n+        }\n+        if (LOG.isDebugEnabled()) {\n+          long end = System.nanoTime();\n+          LOG.debug(\"{} execution time: {} ms.\", getName(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5MDMzNw=="}, "originalCommit": {"oid": "068b54cae428b01f9e214e6ea66a0c0bc5a5ec75"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQxOTg0MA==", "bodyText": "A question of clarification. I think what you have is correct, but I'm asking anyway. We have EnvironmentEdgeManager, which abstracts a form of clock. System.nanoTime() is a different form of clock. Is there some case where we'd want the nanoTime to be abstracted behind EnvironmentEdgeManager? My understanding is no, we don't have such a use-case, because EnvironmentEdgeManager is for abstracting over a clock-time (a la java.time.Instant), while nanoTime is providing a timer for calculating a time duration, something that is abstract from a clock-time.", "url": "https://github.com/apache/hbase/pull/1749#discussion_r429419840", "createdAt": "2020-05-22T19:26:09Z", "author": {"login": "ndimiduk"}, "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/ScheduledChore.java", "diffHunk": "@@ -183,18 +176,21 @@ public void run() {\n       if (LOG.isInfoEnabled()) LOG.info(\"Chore: \" + getName() + \" was stopped\");\n     } else {\n       try {\n+        // TODO: Histogram metrics per chore name.\n+        // For now, just measure and log if DEBUG level logging is enabled.\n+        long start = 0;\n+        if (LOG.isDebugEnabled()) {\n+          start = System.nanoTime();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "068b54cae428b01f9e214e6ea66a0c0bc5a5ec75"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQyMDI4Mw==", "bodyText": "Do we want some duration threshold that triggers escalating the log level to info (or warn), as was done before?", "url": "https://github.com/apache/hbase/pull/1749#discussion_r429420283", "createdAt": "2020-05-22T19:27:20Z", "author": {"login": "ndimiduk"}, "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/ScheduledChore.java", "diffHunk": "@@ -183,18 +176,21 @@ public void run() {\n       if (LOG.isInfoEnabled()) LOG.info(\"Chore: \" + getName() + \" was stopped\");\n     } else {\n       try {\n+        // TODO: Histogram metrics per chore name.\n+        // For now, just measure and log if DEBUG level logging is enabled.\n+        long start = 0;\n+        if (LOG.isDebugEnabled()) {\n+          start = System.nanoTime();\n+        }\n         if (!initialChoreComplete) {\n           initialChoreComplete = initialChore();\n         } else {\n-          timeMeasurement.measure(() -> {\n             chore();\n-            return null;\n-          });\n-          if (LOG.isInfoEnabled() && (System.nanoTime() - lastLog > FIVE_MINUTES_IN_NANOS)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "068b54cae428b01f9e214e6ea66a0c0bc5a5ec75"}, "originalPosition": 45}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "068b54cae428b01f9e214e6ea66a0c0bc5a5ec75", "author": {"user": {"login": "apurtell", "name": "Andrew Purtell"}}, "url": "https://github.com/apache/hbase/commit/068b54cae428b01f9e214e6ea66a0c0bc5a5ec75", "committedDate": "2020-05-20T20:54:06Z", "message": "HBASE-24367 ScheduledChore log elapsed timespan in a human-friendly format"}, "afterCommit": {"oid": "414d4a88efd40bd2d358295885164ae80f53b077", "author": {"user": {"login": "apurtell", "name": "Andrew Purtell"}}, "url": "https://github.com/apache/hbase/commit/414d4a88efd40bd2d358295885164ae80f53b077", "committedDate": "2020-06-04T00:40:45Z", "message": "HBASE-24367 ScheduledChore log elapsed timespan in a human-friendly format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "555db026cfa5b91290e90861d2d42ea7511d6311", "author": {"user": {"login": "apurtell", "name": "Andrew Purtell"}}, "url": "https://github.com/apache/hbase/commit/555db026cfa5b91290e90861d2d42ea7511d6311", "committedDate": "2020-06-05T17:24:48Z", "message": "HBASE-24367 ScheduledChore log elapsed timespan in a human-friendly format"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "414d4a88efd40bd2d358295885164ae80f53b077", "author": {"user": {"login": "apurtell", "name": "Andrew Purtell"}}, "url": "https://github.com/apache/hbase/commit/414d4a88efd40bd2d358295885164ae80f53b077", "committedDate": "2020-06-04T00:40:45Z", "message": "HBASE-24367 ScheduledChore log elapsed timespan in a human-friendly format"}, "afterCommit": {"oid": "555db026cfa5b91290e90861d2d42ea7511d6311", "author": {"user": {"login": "apurtell", "name": "Andrew Purtell"}}, "url": "https://github.com/apache/hbase/commit/555db026cfa5b91290e90861d2d42ea7511d6311", "committedDate": "2020-06-05T17:24:48Z", "message": "HBASE-24367 ScheduledChore log elapsed timespan in a human-friendly format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NTgwNTcz", "url": "https://github.com/apache/hbase/pull/1749#pullrequestreview-425580573", "createdAt": "2020-06-05T19:46:29Z", "commit": {"oid": "555db026cfa5b91290e90861d2d42ea7511d6311"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1OTE5OTQ1", "url": "https://github.com/apache/hbase/pull/1749#pullrequestreview-425919945", "createdAt": "2020-06-08T05:16:33Z", "commit": {"oid": "555db026cfa5b91290e90861d2d42ea7511d6311"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2ODM2Mjk1", "url": "https://github.com/apache/hbase/pull/1749#pullrequestreview-426836295", "createdAt": "2020-06-09T06:53:16Z", "commit": {"oid": "555db026cfa5b91290e90861d2d42ea7511d6311"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4698, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}