{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwNDA1NDQ0", "number": 2283, "title": "HBASE-24885 STUCK RIT by hbck2 assigns", "bodyText": "Adds region state check on hbck2 assigns/unassigns. Returns pid of -1\nif in inappropriate state with logging explaination which suggests\npassing override if operator wants to assign/unassign anyways. Here\nis an example of what happens now if hbck2 tries an unassign and\nRegion already unassigned:\n2020-08-19 11:22:06,926 INFO  [RpcServer.default.FPBQ.Fifo.handler=1,queue=0,port=50086] assignment.AssignmentManager(820): Failed {ENCODED => d1112e553991e938b6852f87774c91ee, NAME => 'TestHbck,zzzzz,1597861310769.d1112e553991e938b6852f87774c91ee.', STARTKEY => 'zzzzz', ENDKEY => ''} unassign, override=false; set override to by-pass state checks.\norg.apache.hadoop.hbase.client.DoNotRetryRegionException: Unexpected state for state=CLOSED, location=null, table=TestHbck, region=d1112e553991e938b6852f87774c91ee\nat org.apache.hadoop.hbase.master.assignment.AssignmentManager.preTransitCheck(AssignmentManager.java:583)\nat org.apache.hadoop.hbase.master.assignment.AssignmentManager.createOneUnassignProcedure(AssignmentManager.java:812)\nat org.apache.hadoop.hbase.master.MasterRpcServices.unassigns(MasterRpcServices.java:2616)\nat org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos$HbckService$2.callBlockingMethod(MasterProtos.java)\nat org.apache.hadoop.hbase.ipc.RpcServer.call(RpcServer.java:397)\nat org.apache.hadoop.hbase.ipc.CallRunner.run(CallRunner.java:133)\nat org.apache.hadoop.hbase.ipc.RpcExecutor$Handler.run(RpcExecutor.java:338)\nat org.apache.hadoop.hbase.ipc.RpcExecutor$Handler.run(RpcExecutor.java:318)\nPrevious it would just create the unassign anyways. Now must pass override\nto queue the procedure regardless. Safer.\nhbase-server/src/main/java/org/apache/hadoop/hbase/master/MasterRpcServices.java\njavadoc on assigns/unassigns. Minor refactor in assigns/unassigns to cater to\ncase where procedure may come back null (if override not set and fails state checks).\nhbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/AssignmentManager.java\ncheckstyle cleanups.\nClarifying javadoc on how there is no state checking when bulk assigns creating/enabling\ntables.\ncreateOneAssignProcedure and createOneUnassignProcedure now handle exceptions which now\ncan be thrown if no override and region state is not appropriate.\nAggregation of createAssignProcedure and createUnassignProcedure instances adding in\nregion state check invoked if override is NOT set.\nhbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/RegionStateNode.java\nChange to setProcedure so it returns passed proc as result instead of void", "createdAt": "2020-08-19T19:32:38Z", "url": "https://github.com/apache/hbase/pull/2283", "merged": true, "mergeCommit": {"oid": "4243536b19ff3268a2b7e5910eaf8f1743430f67"}, "closed": true, "closedAt": "2020-08-24T16:19:44Z", "author": {"login": "saintstack"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAgziAgH2gAyNDcwNDA1NDQ0OjA4ODNkZjllNmZhMWJmN2EwOGNhZDUxNjJjOTFiZGM2Njk1MzIzZTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdB9OYygFqTQ3MzE3MTM2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0883df9e6fa1bf7a08cad5162c91bdc6695323e5", "author": {"user": {"login": "saintstack", "name": "Michael Stack"}}, "url": "https://github.com/apache/hbase/commit/0883df9e6fa1bf7a08cad5162c91bdc6695323e5", "committedDate": "2020-08-19T19:30:29Z", "message": "HBASE-24885 STUCK RIT by hbck2 assigns\n\nAdds region state check on hbck2 assigns/unassigns. Returns pid of -1\nif in inappropriate state with logging explaination which suggests\npassing override if operator wants to assign/unassign anyways. Here\nis an example of what happens now if hbck2 tries an unassign and\nRegion already unassigned:\n\n  2020-08-19 11:22:06,926 INFO  [RpcServer.default.FPBQ.Fifo.handler=1,queue=0,port=50086] assignment.AssignmentManager(820): Failed {ENCODED => d1112e553991e938b6852f87774c91ee, NAME => 'TestHbck,zzzzz,1597861310769.d1112e553991e938b6852f87774c91ee.', STARTKEY => 'zzzzz', ENDKEY => ''} unassign, override=false; set override to by-pass state checks.\n  org.apache.hadoop.hbase.client.DoNotRetryRegionException: Unexpected state for state=CLOSED, location=null, table=TestHbck, region=d1112e553991e938b6852f87774c91ee\n          at org.apache.hadoop.hbase.master.assignment.AssignmentManager.preTransitCheck(AssignmentManager.java:583)\n          at org.apache.hadoop.hbase.master.assignment.AssignmentManager.createOneUnassignProcedure(AssignmentManager.java:812)\n          at org.apache.hadoop.hbase.master.MasterRpcServices.unassigns(MasterRpcServices.java:2616)\n          at org.apache.hadoop.hbase.shaded.protobuf.generated.MasterProtos$HbckService$2.callBlockingMethod(MasterProtos.java)\n          at org.apache.hadoop.hbase.ipc.RpcServer.call(RpcServer.java:397)\n          at org.apache.hadoop.hbase.ipc.CallRunner.run(CallRunner.java:133)\n          at org.apache.hadoop.hbase.ipc.RpcExecutor$Handler.run(RpcExecutor.java:338)\n          at org.apache.hadoop.hbase.ipc.RpcExecutor$Handler.run(RpcExecutor.java:318)\n\nPrevious it would just create the unassign anyways. Now must pass override\nto queue the procedure regardless. Safer.\n\nhbase-server/src/main/java/org/apache/hadoop/hbase/master/MasterRpcServices.java\n javadoc on assigns/unassigns. Minor refactor in assigns/unassigns to cater to\n case where procedure may come back null (if override not set and fails state checks).\n\nhbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/AssignmentManager.java\n checkstyle cleanups.\n Clarifying javadoc on how there is no state checking when bulk assigns creating/enabling\n tables.\n\n createOneAssignProcedure and createOneUnassignProcedure now handle exceptions which now\n can be thrown if no override and region state is not appropriate.\n\n Aggregation of createAssignProcedure and createUnassignProcedure instances adding in\n region state check invoked if override is NOT set.\n\nhbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/RegionStateNode.java\n Change to setProcedure so it returns passed proc as result instead of void"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMjQ5Mjk1", "url": "https://github.com/apache/hbase/pull/2283#pullrequestreview-472249295", "createdAt": "2020-08-21T06:58:24Z", "commit": {"oid": "0883df9e6fa1bf7a08cad5162c91bdc6695323e5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwNjo1ODoyNFrOHEd27Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwNjo1ODoyNFrOHEd27Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ0NTU0OQ==", "bodyText": "What is the purpose of this change?", "url": "https://github.com/apache/hbase/pull/2283#discussion_r474445549", "createdAt": "2020-08-21T06:58:24Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/RegionStateNode.java", "diffHunk": "@@ -190,10 +190,11 @@ public ServerName setRegionLocation(final ServerName serverName) {\n     return lastRegionLocation;\n   }\n \n-  public void setProcedure(TransitRegionStateProcedure proc) {\n+  public TransitRegionStateProcedure setProcedure(TransitRegionStateProcedure proc) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0883df9e6fa1bf7a08cad5162c91bdc6695323e5"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMTcxMzY0", "url": "https://github.com/apache/hbase/pull/2283#pullrequestreview-473171364", "createdAt": "2020-08-24T07:11:05Z", "commit": {"oid": "0883df9e6fa1bf7a08cad5162c91bdc6695323e5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4936, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}