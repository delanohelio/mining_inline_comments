{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4MTQ2NzM0", "number": 2640, "title": "Backport: HBASE-25126 Add load balance logic in hbase-client to distribute read\u2026", "bodyText": "\u2026 load over meta replica regions\nIt adds load balance support for meta lookup in AsyncTableRegionLocator.\nThe existing meta replica mode is renamed as \"HedgedRead\", client sends scan request to the primary meta replica region first,\nif response is not back within a configured amount of time, it will send scan requests to all meta replica regions and\ntake the first response. On top of the existing mode, a new mode \"LoadBalance\" is introduced. In this mode, client first\nchoose a meta replica region to send scan request. If the response is stale, it may send the request to another meta replica region or\nthe primary region. In this mode, meta scan requests are load balanced across all replica regions with the primary mode as\nthe ultimate source of truth.\nTwo new config knobs are added:\n\n\nhbase.locator.meta.replicas.mode\nValid options are \"None\", \"HedgedRead\" and \"LoadBalance\", they are case insensitive. The default mode is \"None\".\n\n\nhbase.locator.meta.replicas.mode.loadbalance.selector\nThe load balance alogrithm to select a meta replica to send the requests.\nOnly org.apache.hadoop.hbase.client.CatalogReplicaLoadBalanceReplicaSimpleSelector.class\nis supported for now, which is the default as well. The algorithm works as follows:\na. Clients select a randome meta replica region to send the requests if there is no entry for the location in the stale\nlocation cache.\nb. If the location from one meta replica region is stale, a stale entry will be created in the statle location cache\nfor the region.\nc. Clients select the primary meta region if the location is in the stale location cache.\nd. The stale location cache entries time out in 3 seconds.\n\n\nIf there is no \"hbase.locator.meta.replicas.mode\" configured, it will check the config knob \"hbase.meta.replicas.use\".\nIf \"hbase.meta.replicas.use\" is configured, the mode will be set to \"HedgedRead\".\nFor branch-2 support, it introduces support for ReversedScan over a specific non-default replica region, this is mainly\nfor load balance meta scan among all its replica regions.", "createdAt": "2020-11-10T01:31:25Z", "url": "https://github.com/apache/hbase/pull/2640", "merged": true, "mergeCommit": {"oid": "920cf9faf410dca2ddea2ab08cbba19b2c5b9443"}, "closed": true, "closedAt": "2020-11-20T18:45:25Z", "author": {"login": "huaxiangsun"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbAdlJAFqTUyNjgxNjg1Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeb3AggBqjQwMjIzMDA2NDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2ODE2ODU3", "url": "https://github.com/apache/hbase/pull/2640#pullrequestreview-526816857", "createdAt": "2020-11-10T02:59:30Z", "commit": {"oid": "8da5fb0de7d5fb448d6a57da73efcd9e72e5a910"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwMjo1OTozMFrOHwJ3Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwMzowMzoxNVrOHwJ7LA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI1NTI2Ng==", "bodyText": "I can not recall whether I have mentioned this on the patch for master. The scope of 'useMetaReplicas' is wider than the newly introduced metaReplicaMode, as it could also effect the methods in Admin implementation, so I do not think we could remove it directly. If we want to do so, we'd better follow the typical rule to deprecated it first and then remove it in the next major release.", "url": "https://github.com/apache/hbase/pull/2640#discussion_r520255266", "createdAt": "2020-11-10T02:59:30Z", "author": {"login": "Apache9"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/ConnectionImplementation.java", "diffHunk": "@@ -161,7 +165,11 @@\n   private final boolean hostnamesCanChange;\n   private final long pause;\n   private final long pauseForCQTBE;// pause for CallQueueTooBigException, if specified\n-  private boolean useMetaReplicas;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8da5fb0de7d5fb448d6a57da73efcd9e72e5a910"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI1NjE0Ng==", "bodyText": "This is a bit strange, TIMELINE means we should send request to primary first and if it does not come back in time, we switch to secondary replicas. IIRC the design here is that, if targetReplicaId is -1, we follow the rule of STRONG or TIMELINE, if targetReplicaId is not -1, we will go to the specific replica directly?", "url": "https://github.com/apache/hbase/pull/2640#discussion_r520256146", "createdAt": "2020-11-10T03:02:37Z", "author": {"login": "Apache9"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/ReversedClientScanner.java", "diffHunk": "@@ -64,7 +64,9 @@ protected boolean setNewStartKey() {\n \n   @Override\n   protected ReversedScannerCallable createScannerCallable() {\n+    // In case of meta, we want to support scan over a replica region.\n+    int replicaId = (scan.getConsistency() == Consistency.TIMELINE) ? scan.getReplicaId() : 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8da5fb0de7d5fb448d6a57da73efcd9e72e5a910"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI1NjMwMA==", "bodyText": "Put static import on top?", "url": "https://github.com/apache/hbase/pull/2640#discussion_r520256300", "createdAt": "2020-11-10T03:03:15Z", "author": {"login": "Apache9"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/ScannerCallableWithReplicas.java", "diffHunk": "@@ -42,13 +42,15 @@\n import org.slf4j.LoggerFactory;\n import org.apache.hadoop.hbase.client.ScannerCallable.MoreResults;\n import org.apache.hadoop.hbase.util.Pair;\n+import static org.apache.hadoop.hbase.client.RegionReplicaUtil.DEFAULT_REPLICA_ID;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8da5fb0de7d5fb448d6a57da73efcd9e72e5a910"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3Mzg3MjI4", "url": "https://github.com/apache/hbase/pull/2640#pullrequestreview-527387228", "createdAt": "2020-11-10T16:33:02Z", "commit": {"oid": "8da5fb0de7d5fb448d6a57da73efcd9e72e5a910"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNjozMzowM1rOHwlFoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNjo0MzozNFrOHwljeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcwMTM0NA==", "bodyText": "Is this code duplicated? Does it have to be?", "url": "https://github.com/apache/hbase/pull/2640#discussion_r520701344", "createdAt": "2020-11-10T16:33:03Z", "author": {"login": "saintstack"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/ConnectionImplementation.java", "diffHunk": "@@ -332,19 +338,59 @@ public void newDead(ServerName sn) {\n       close();\n       throw e;\n     }\n+\n+    // Get the region locator's meta replica mode.\n+    this.metaReplicaMode = CatalogReplicaMode.fromString(conf.get(LOCATOR_META_REPLICAS_MODE,\n+      CatalogReplicaMode.NONE.toString()));\n+\n+    switch (this.metaReplicaMode) {\n+      case LOAD_BALANCE:\n+        String replicaSelectorClass = conf.get(\n+          RegionLocator.LOCATOR_META_REPLICAS_MODE_LOADBALANCE_SELECTOR,\n+          CatalogReplicaLoadBalanceSimpleSelector.class.getName());\n+\n+        this.metaReplicaSelector = CatalogReplicaLoadBalanceSelectorFactory.createSelector(\n+          replicaSelectorClass, META_TABLE_NAME, getChoreService(), () -> {\n+            int numOfReplicas = 1;\n+            try {\n+              RegionLocations metaLocations = registry.getMetaRegionLocations().get(\n+                connectionConfig.getReadRpcTimeout(), TimeUnit.MILLISECONDS);\n+              numOfReplicas = metaLocations.size();\n+            } catch (Exception e) {\n+              LOG.error(\"Failed to get table {}'s region replication, \", META_TABLE_NAME, e);\n+            }\n+            return numOfReplicas;\n+          });\n+        break;\n+      case NONE:\n+        // If user does not configure LOCATOR_META_REPLICAS_MODE, let's check the legacy config.\n+\n+        boolean useMetaReplicas = conf.getBoolean(USE_META_REPLICAS,\n+          DEFAULT_USE_META_REPLICAS);\n+        if (useMetaReplicas) {\n+          this.metaReplicaMode = CatalogReplicaMode.HEDGED_READ;\n+        }\n+        break;\n+      default:\n+        // Doing nothing\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8da5fb0de7d5fb448d6a57da73efcd9e72e5a910"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcwODcxNw==", "bodyText": "I was wondering about the @Apache9 comment above on scope. I was thinking this a @Private class so we should be able to change internals but I see now this method exposes our internal useMetaReplicas.\nIts a weird method though. Package protected for testing only? The test shouldn't do this? Should change config rather than this method? Probably ok to add @deprecated.... to be replaced by nothing.", "url": "https://github.com/apache/hbase/pull/2640#discussion_r520708717", "createdAt": "2020-11-10T16:43:09Z", "author": {"login": "saintstack"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/ConnectionImplementation.java", "diffHunk": "@@ -332,19 +338,59 @@ public void newDead(ServerName sn) {\n       close();\n       throw e;\n     }\n+\n+    // Get the region locator's meta replica mode.\n+    this.metaReplicaMode = CatalogReplicaMode.fromString(conf.get(LOCATOR_META_REPLICAS_MODE,\n+      CatalogReplicaMode.NONE.toString()));\n+\n+    switch (this.metaReplicaMode) {\n+      case LOAD_BALANCE:\n+        String replicaSelectorClass = conf.get(\n+          RegionLocator.LOCATOR_META_REPLICAS_MODE_LOADBALANCE_SELECTOR,\n+          CatalogReplicaLoadBalanceSimpleSelector.class.getName());\n+\n+        this.metaReplicaSelector = CatalogReplicaLoadBalanceSelectorFactory.createSelector(\n+          replicaSelectorClass, META_TABLE_NAME, getChoreService(), () -> {\n+            int numOfReplicas = 1;\n+            try {\n+              RegionLocations metaLocations = registry.getMetaRegionLocations().get(\n+                connectionConfig.getReadRpcTimeout(), TimeUnit.MILLISECONDS);\n+              numOfReplicas = metaLocations.size();\n+            } catch (Exception e) {\n+              LOG.error(\"Failed to get table {}'s region replication, \", META_TABLE_NAME, e);\n+            }\n+            return numOfReplicas;\n+          });\n+        break;\n+      case NONE:\n+        // If user does not configure LOCATOR_META_REPLICAS_MODE, let's check the legacy config.\n+\n+        boolean useMetaReplicas = conf.getBoolean(USE_META_REPLICAS,\n+          DEFAULT_USE_META_REPLICAS);\n+        if (useMetaReplicas) {\n+          this.metaReplicaMode = CatalogReplicaMode.HEDGED_READ;\n+        }\n+        break;\n+      default:\n+        // Doing nothing\n+    }\n   }\n \n   private void spawnRenewalChore(final UserGroupInformation user) {\n-    authService = new ChoreService(\"Relogin service\");\n-    authService.scheduleChore(AuthUtil.getAuthRenewalChore(user));\n+    ChoreService service = getChoreService();\n+    service.scheduleChore(AuthUtil.getAuthRenewalChore(user));\n   }\n \n   /**\n    * @param useMetaReplicas\n    */\n   @VisibleForTesting\n   void setUseMetaReplicas(final boolean useMetaReplicas) {\n-    this.useMetaReplicas = useMetaReplicas;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8da5fb0de7d5fb448d6a57da73efcd9e72e5a910"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcwODk4NA==", "bodyText": "Yeah, this a dupe too?", "url": "https://github.com/apache/hbase/pull/2640#discussion_r520708984", "createdAt": "2020-11-10T16:43:34Z", "author": {"login": "saintstack"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/ConnectionImplementation.java", "diffHunk": "@@ -841,8 +898,23 @@ private RegionLocations locateRegionInMeta(TableName tableName, byte[] row, bool\n     Scan s = new Scan().withStartRow(metaStartKey).withStopRow(metaStopKey, true)\n       .addFamily(HConstants.CATALOG_FAMILY).setReversed(true).setCaching(5)\n       .setReadType(ReadType.PREAD);\n-    if (this.useMetaReplicas) {\n-      s.setConsistency(Consistency.TIMELINE);\n+\n+    switch (this.metaReplicaMode) {\n+      case LOAD_BALANCE:\n+        int metaReplicaId = this.metaReplicaSelector.select(tableName, row,\n+          RegionLocateType.CURRENT);\n+        if (metaReplicaId != RegionInfo.DEFAULT_REPLICA_ID) {\n+          // If the selector gives a non-primary meta replica region, then go with it.\n+          // Otherwise, just go to primary in non-hedgedRead mode.\n+          s.setConsistency(Consistency.TIMELINE);\n+          s.setReplicaId(metaReplicaId);\n+        }\n+        break;\n+      case HEDGED_READ:\n+        s.setConsistency(Consistency.TIMELINE);\n+        break;\n+      default:\n+        // do nothing", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8da5fb0de7d5fb448d6a57da73efcd9e72e5a910"}, "originalPosition": 149}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8da5fb0de7d5fb448d6a57da73efcd9e72e5a910", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/8da5fb0de7d5fb448d6a57da73efcd9e72e5a910", "committedDate": "2020-11-10T01:27:00Z", "message": "HBASE-25126 Add load balance logic in hbase-client to distribute read load over meta replica regions\n\nIt adds load balance support for meta lookup in AsyncTableRegionLocator.\nThe existing meta replica mode is renamed as \"HedgedRead\", client sends scan request to the primary meta replica region first,\nif response is not back within a configured amount of time, it will send scan requests to all meta replica regions and\ntake the first response. On top of the existing mode, a new mode \"LoadBalance\" is introduced. In this mode, client first\nchoose a meta replica region to send scan request. If the response is stale, it may send the request to another meta replica region or\nthe primary region. In this mode, meta scan requests are load balanced across all replica regions with the primary mode as\nthe ultimate source of truth.\n\nTwo new config knobs are added:\n\n1. hbase.locator.meta.replicas.mode\n   Valid options are \"None\", \"HedgedRead\" and \"LoadBalance\", they are case insensitive. The default mode is \"None\".\n\n2. hbase.locator.meta.replicas.mode.loadbalance.selector\n   The load balance alogrithm to select a meta replica to send the requests.\n   Only org.apache.hadoop.hbase.client.CatalogReplicaLoadBalanceReplicaSimpleSelector.class\n   is supported for now, which is the default as well. The algorithm works as follows:\n      a. Clients select a randome meta replica region to send the requests if there is no entry for the location in the stale\n         location cache.\n      b. If the location from one meta replica region is stale, a stale entry will be created in the statle location cache\n         for the region.\n      c. Clients select the primary meta region if the location is in the stale location cache.\n      d. The stale location cache entries time out in 3 seconds.\n\nIf there is no \"hbase.locator.meta.replicas.mode\" configured, it will check the config knob \"hbase.meta.replicas.use\".\nIf \"hbase.meta.replicas.use\" is configured, the mode will be set to \"HedgedRead\".\n\nFor branch-2 support, it introduces support for ReversedScan over a specific non-default replica region, this is mainly\nfor load balance meta scan among all its replica regions."}, "afterCommit": {"oid": "f7757275b2ef279014e5d80474de2d0c27223207", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/f7757275b2ef279014e5d80474de2d0c27223207", "committedDate": "2020-11-10T23:19:06Z", "message": "HBASE-25126 Add load balance logic in hbase-client to distribute read load over meta replica regions\n\nIt adds load balance support for meta lookup in AsyncTableRegionLocator.\nThe existing meta replica mode is renamed as \"HedgedRead\", client sends scan request to the primary meta replica region first,\nif response is not back within a configured amount of time, it will send scan requests to all meta replica regions and\ntake the first response. On top of the existing mode, a new mode \"LoadBalance\" is introduced. In this mode, client first\nchoose a meta replica region to send scan request. If the response is stale, it may send the request to another meta replica region or\nthe primary region. In this mode, meta scan requests are load balanced across all replica regions with the primary mode as\nthe ultimate source of truth.\n\nTwo new config knobs are added:\n\n1. hbase.locator.meta.replicas.mode\n   Valid options are \"None\", \"HedgedRead\" and \"LoadBalance\", they are case insensitive. The default mode is \"None\".\n\n2. hbase.locator.meta.replicas.mode.loadbalance.selector\n   The load balance alogrithm to select a meta replica to send the requests.\n   Only org.apache.hadoop.hbase.client.CatalogReplicaLoadBalanceReplicaSimpleSelector.class\n   is supported for now, which is the default as well. The algorithm works as follows:\n      a. Clients select a randome meta replica region to send the requests if there is no entry for the location in the stale\n         location cache.\n      b. If the location from one meta replica region is stale, a stale entry will be created in the statle location cache\n         for the region.\n      c. Clients select the primary meta region if the location is in the stale location cache.\n      d. The stale location cache entries time out in 3 seconds.\n\nIf there is no \"hbase.locator.meta.replicas.mode\" configured, it will check the config knob \"hbase.meta.replicas.use\".\nIf \"hbase.meta.replicas.use\" is configured, the mode will be set to \"HedgedRead\".\n\nFor branch-2 support, it introduces support for ReversedScan over a specific non-default replica region, this is mainly\nfor load balance meta scan among all its replica regions."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a3f1c09ec8e0b1bbea92af5f2f54921d911859ce", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/a3f1c09ec8e0b1bbea92af5f2f54921d911859ce", "committedDate": "2020-11-11T21:07:42Z", "message": "Remove ConnectionImplementation#setUseMetaReplicas()"}, "afterCommit": {"oid": "bf676598a43e104b72b933f097947ced88cd74d7", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/bf676598a43e104b72b933f097947ced88cd74d7", "committedDate": "2020-11-11T21:09:45Z", "message": "Remove ConnectionImplementation#setUseMetaReplicas()"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf676598a43e104b72b933f097947ced88cd74d7", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/bf676598a43e104b72b933f097947ced88cd74d7", "committedDate": "2020-11-11T21:09:45Z", "message": "Remove ConnectionImplementation#setUseMetaReplicas()"}, "afterCommit": {"oid": "7540dec4ba3317e6b556a9286eff76531fb80c53", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/7540dec4ba3317e6b556a9286eff76531fb80c53", "committedDate": "2020-11-12T17:43:17Z", "message": "Remove ConnectionImplementation#setUseMetaReplicas()"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7540dec4ba3317e6b556a9286eff76531fb80c53", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/7540dec4ba3317e6b556a9286eff76531fb80c53", "committedDate": "2020-11-12T17:43:17Z", "message": "Remove ConnectionImplementation#setUseMetaReplicas()"}, "afterCommit": {"oid": "93e7c72dc3ad4decbd4c45a96fb6137c98518f69", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/93e7c72dc3ad4decbd4c45a96fb6137c98518f69", "committedDate": "2020-11-16T17:35:35Z", "message": "HBASE-25126 Add load balance logic in hbase-client to distribute read load over meta replica regions\n\nIt adds load balance support for meta lookup in AsyncTableRegionLocator.\nThe existing meta replica mode is renamed as \"HedgedRead\", client sends scan request to the primary meta replica region first,\nif response is not back within a configured amount of time, it will send scan requests to all meta replica regions and\ntake the first response. On top of the existing mode, a new mode \"LoadBalance\" is introduced. In this mode, client first\nchoose a meta replica region to send scan request. If the response is stale, it may send the request to another meta replica region or\nthe primary region. In this mode, meta scan requests are load balanced across all replica regions with the primary mode as\nthe ultimate source of truth.\n\nTwo new config knobs are added:\n\n1. hbase.locator.meta.replicas.mode\n   Valid options are \"None\", \"HedgedRead\" and \"LoadBalance\", they are case insensitive. The default mode is \"None\".\n\n2. hbase.locator.meta.replicas.mode.loadbalance.selector\n   The load balance alogrithm to select a meta replica to send the requests.\n   Only org.apache.hadoop.hbase.client.CatalogReplicaLoadBalanceReplicaSimpleSelector.class\n   is supported for now, which is the default as well. The algorithm works as follows:\n      a. Clients select a randome meta replica region to send the requests if there is no entry for the location in the stale\n         location cache.\n      b. If the location from one meta replica region is stale, a stale entry will be created in the statle location cache\n         for the region.\n      c. Clients select the primary meta region if the location is in the stale location cache.\n      d. The stale location cache entries time out in 3 seconds.\n\nIf there is no \"hbase.locator.meta.replicas.mode\" configured, it will check the config knob \"hbase.meta.replicas.use\".\nIf \"hbase.meta.replicas.use\" is configured, the mode will be set to \"HedgedRead\".\n\nFor branch-2 support, it introduces support for ReversedScan over a specific non-default replica region, this is mainly\nfor load balance meta scan among all its replica regions.\n\nRemove ConnectionImplementation#setUseMetaReplicas()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxOTA2NTQ1", "url": "https://github.com/apache/hbase/pull/2640#pullrequestreview-531906545", "createdAt": "2020-11-16T23:30:14Z", "commit": {"oid": "93e7c72dc3ad4decbd4c45a96fb6137c98518f69"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MTgwNDg3", "url": "https://github.com/apache/hbase/pull/2640#pullrequestreview-535180487", "createdAt": "2020-11-20T07:48:33Z", "commit": {"oid": "93e7c72dc3ad4decbd4c45a96fb6137c98518f69"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a77dce89fb332b3d684e03257d7357ac8407d41", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/0a77dce89fb332b3d684e03257d7357ac8407d41", "committedDate": "2020-11-20T18:15:26Z", "message": "HBASE-25126 Add load balance logic in hbase-client to distribute read load over meta replica regions\n\nIt adds load balance support for meta lookup in AsyncTableRegionLocator.\nThe existing meta replica mode is renamed as \"HedgedRead\", client sends scan request to the primary meta replica region first,\nif response is not back within a configured amount of time, it will send scan requests to all meta replica regions and\ntake the first response. On top of the existing mode, a new mode \"LoadBalance\" is introduced. In this mode, client first\nchoose a meta replica region to send scan request. If the response is stale, it may send the request to another meta replica region or\nthe primary region. In this mode, meta scan requests are load balanced across all replica regions with the primary mode as\nthe ultimate source of truth.\n\nTwo new config knobs are added:\n\n1. hbase.locator.meta.replicas.mode\n   Valid options are \"None\", \"HedgedRead\" and \"LoadBalance\", they are case insensitive. The default mode is \"None\".\n\n2. hbase.locator.meta.replicas.mode.loadbalance.selector\n   The load balance alogrithm to select a meta replica to send the requests.\n   Only org.apache.hadoop.hbase.client.CatalogReplicaLoadBalanceReplicaSimpleSelector.class\n   is supported for now, which is the default as well. The algorithm works as follows:\n      a. Clients select a randome meta replica region to send the requests if there is no entry for the location in the stale\n         location cache.\n      b. If the location from one meta replica region is stale, a stale entry will be created in the statle location cache\n         for the region.\n      c. Clients select the primary meta region if the location is in the stale location cache.\n      d. The stale location cache entries time out in 3 seconds.\n\nIf there is no \"hbase.locator.meta.replicas.mode\" configured, it will check the config knob \"hbase.meta.replicas.use\".\nIf \"hbase.meta.replicas.use\" is configured, the mode will be set to \"HedgedRead\".\n\nFor branch-2 support, it introduces support for ReversedScan over a specific non-default replica region, this is mainly\nfor load balance meta scan among all its replica regions.\n\nRemove ConnectionImplementation#setUseMetaReplicas()"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93e7c72dc3ad4decbd4c45a96fb6137c98518f69", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/93e7c72dc3ad4decbd4c45a96fb6137c98518f69", "committedDate": "2020-11-16T17:35:35Z", "message": "HBASE-25126 Add load balance logic in hbase-client to distribute read load over meta replica regions\n\nIt adds load balance support for meta lookup in AsyncTableRegionLocator.\nThe existing meta replica mode is renamed as \"HedgedRead\", client sends scan request to the primary meta replica region first,\nif response is not back within a configured amount of time, it will send scan requests to all meta replica regions and\ntake the first response. On top of the existing mode, a new mode \"LoadBalance\" is introduced. In this mode, client first\nchoose a meta replica region to send scan request. If the response is stale, it may send the request to another meta replica region or\nthe primary region. In this mode, meta scan requests are load balanced across all replica regions with the primary mode as\nthe ultimate source of truth.\n\nTwo new config knobs are added:\n\n1. hbase.locator.meta.replicas.mode\n   Valid options are \"None\", \"HedgedRead\" and \"LoadBalance\", they are case insensitive. The default mode is \"None\".\n\n2. hbase.locator.meta.replicas.mode.loadbalance.selector\n   The load balance alogrithm to select a meta replica to send the requests.\n   Only org.apache.hadoop.hbase.client.CatalogReplicaLoadBalanceReplicaSimpleSelector.class\n   is supported for now, which is the default as well. The algorithm works as follows:\n      a. Clients select a randome meta replica region to send the requests if there is no entry for the location in the stale\n         location cache.\n      b. If the location from one meta replica region is stale, a stale entry will be created in the statle location cache\n         for the region.\n      c. Clients select the primary meta region if the location is in the stale location cache.\n      d. The stale location cache entries time out in 3 seconds.\n\nIf there is no \"hbase.locator.meta.replicas.mode\" configured, it will check the config knob \"hbase.meta.replicas.use\".\nIf \"hbase.meta.replicas.use\" is configured, the mode will be set to \"HedgedRead\".\n\nFor branch-2 support, it introduces support for ReversedScan over a specific non-default replica region, this is mainly\nfor load balance meta scan among all its replica regions.\n\nRemove ConnectionImplementation#setUseMetaReplicas()"}, "afterCommit": {"oid": "0a77dce89fb332b3d684e03257d7357ac8407d41", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/0a77dce89fb332b3d684e03257d7357ac8407d41", "committedDate": "2020-11-20T18:15:26Z", "message": "HBASE-25126 Add load balance logic in hbase-client to distribute read load over meta replica regions\n\nIt adds load balance support for meta lookup in AsyncTableRegionLocator.\nThe existing meta replica mode is renamed as \"HedgedRead\", client sends scan request to the primary meta replica region first,\nif response is not back within a configured amount of time, it will send scan requests to all meta replica regions and\ntake the first response. On top of the existing mode, a new mode \"LoadBalance\" is introduced. In this mode, client first\nchoose a meta replica region to send scan request. If the response is stale, it may send the request to another meta replica region or\nthe primary region. In this mode, meta scan requests are load balanced across all replica regions with the primary mode as\nthe ultimate source of truth.\n\nTwo new config knobs are added:\n\n1. hbase.locator.meta.replicas.mode\n   Valid options are \"None\", \"HedgedRead\" and \"LoadBalance\", they are case insensitive. The default mode is \"None\".\n\n2. hbase.locator.meta.replicas.mode.loadbalance.selector\n   The load balance alogrithm to select a meta replica to send the requests.\n   Only org.apache.hadoop.hbase.client.CatalogReplicaLoadBalanceReplicaSimpleSelector.class\n   is supported for now, which is the default as well. The algorithm works as follows:\n      a. Clients select a randome meta replica region to send the requests if there is no entry for the location in the stale\n         location cache.\n      b. If the location from one meta replica region is stale, a stale entry will be created in the statle location cache\n         for the region.\n      c. Clients select the primary meta region if the location is in the stale location cache.\n      d. The stale location cache entries time out in 3 seconds.\n\nIf there is no \"hbase.locator.meta.replicas.mode\" configured, it will check the config knob \"hbase.meta.replicas.use\".\nIf \"hbase.meta.replicas.use\" is configured, the mode will be set to \"HedgedRead\".\n\nFor branch-2 support, it introduces support for ReversedScan over a specific non-default replica region, this is mainly\nfor load balance meta scan among all its replica regions.\n\nRemove ConnectionImplementation#setUseMetaReplicas()"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1905, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}