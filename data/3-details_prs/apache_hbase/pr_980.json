{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4OTI1NjA3", "number": 980, "title": "HBASE-23205 Correctly update the position of WALs currently being replicated", "bodyText": "https://issues.apache.org/jira/browse/HBASE-23205\nrelated PR : #944", "createdAt": "2020-01-03T09:35:05Z", "url": "https://github.com/apache/hbase/pull/980", "merged": true, "mergeCommit": {"oid": "879b7ea9ffe1e98af9a3338b9ebd8b0674adf67b"}, "closed": true, "closedAt": "2020-01-09T10:09:41Z", "author": {"login": "JeongDaeKim"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb2qTIegH2gAyMzU4OTI1NjA3OjhhYTk0NDdmN2IyMzljNDMwMTg1MDE4YjU5NDdlMWI2YzQ1MjBlMWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb36CDZAFqTMzOTAzMDU5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8aa9447f7b239c430185018b5947e1b6c4520e1b", "author": {"user": {"login": "JeongDaeKim", "name": "Jeongdae Kim"}}, "url": "https://github.com/apache/hbase/commit/8aa9447f7b239c430185018b5947e1b6c4520e1b", "committedDate": "2020-01-03T08:43:45Z", "message": "HBASE-23205 Correctly update the position of WALs currently being replicated"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4MTg4NDU1", "url": "https://github.com/apache/hbase/pull/980#pullrequestreview-338188455", "createdAt": "2020-01-03T17:31:13Z", "commit": {"oid": "8aa9447f7b239c430185018b5947e1b6c4520e1b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxNzozMToxM1rOFaFQZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxNzozMToxM1rOFaFQZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjg5MzQxMw==", "bodyText": "Are the workerThreads sorted so we get last logged first?", "url": "https://github.com/apache/hbase/pull/980#discussion_r362893413", "createdAt": "2020-01-03T17:31:13Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -436,14 +437,30 @@ public String getPeerClusterId() {\n   }\n \n   @Override\n+  @VisibleForTesting\n   public Path getCurrentPath() {\n-    // only for testing\n     for (ReplicationSourceShipperThread worker : workerThreads.values()) {\n       if (worker.getCurrentPath() != null) return worker.getCurrentPath();\n     }\n     return null;\n   }\n \n+  @VisibleForTesting\n+  public Path getLastLoggedPath() {\n+    for (ReplicationSourceShipperThread worker : workerThreads.values()) {\n+      return worker.getLastLoggedPath();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8aa9447f7b239c430185018b5947e1b6c4520e1b"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NTk1NjU5", "url": "https://github.com/apache/hbase/pull/980#pullrequestreview-338595659", "createdAt": "2020-01-06T11:31:03Z", "commit": {"oid": "8aa9447f7b239c430185018b5947e1b6c4520e1b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MDMwNTk5", "url": "https://github.com/apache/hbase/pull/980#pullrequestreview-339030599", "createdAt": "2020-01-07T04:56:35Z", "commit": {"oid": "8aa9447f7b239c430185018b5947e1b6c4520e1b"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNDo1NjozNVrOFav2xQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QwNTozNToxNlrOFawNrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU5MTM2NQ==", "bodyText": "This is not for test, right? We iterate the workers twice -- once to get path and then again to get position. Don't want to return a Pair with Path and offset so just iterate once?", "url": "https://github.com/apache/hbase/pull/980#discussion_r363591365", "createdAt": "2020-01-07T04:56:35Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -478,8 +495,8 @@ public String getStats() {\n     for (Map.Entry<String, ReplicationSourceShipperThread> entry : workerThreads.entrySet()) {\n       String walGroupId = entry.getKey();\n       ReplicationSourceShipperThread worker = entry.getValue();\n-      long position = worker.getCurrentPosition();\n-      Path currentPath = worker.getCurrentPath();\n+      long position = worker.getLastLoggedPosition();\n+      Path currentPath = worker.getLastLoggedPath();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8aa9447f7b239c430185018b5947e1b6c4520e1b"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU5NjU5OQ==", "bodyText": "Hmm... reading later in the patch, I see need to have them distinct. For sure we'll get the right offset for the selected path?", "url": "https://github.com/apache/hbase/pull/980#discussion_r363596599", "createdAt": "2020-01-07T05:31:33Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -478,8 +495,8 @@ public String getStats() {\n     for (Map.Entry<String, ReplicationSourceShipperThread> entry : workerThreads.entrySet()) {\n       String walGroupId = entry.getKey();\n       ReplicationSourceShipperThread worker = entry.getValue();\n-      long position = worker.getCurrentPosition();\n-      Path currentPath = worker.getCurrentPath();\n+      long position = worker.getLastLoggedPosition();\n+      Path currentPath = worker.getLastLoggedPath();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU5MTM2NQ=="}, "originalCommit": {"oid": "8aa9447f7b239c430185018b5947e1b6c4520e1b"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU5NzA3Nw==", "bodyText": "Will we be doing a bunch of spinning updating same value over and over w/o these checks in place that look to see if position has changed? Will we be burning CPU to no end?", "url": "https://github.com/apache/hbase/pull/980#discussion_r363597077", "createdAt": "2020-01-07T05:34:23Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -635,15 +650,13 @@ private void checkBandwidthChangeAndResetThrottler() {\n     protected void shipEdits(WALEntryBatch entryBatch) {\n       List<Entry> entries = entryBatch.getWalEntries();\n       long lastReadPosition = entryBatch.getLastWalPosition();\n-      currentPath = entryBatch.getLastWalPath();\n+      lastLoggedPath = entryBatch.getLastWalPath();\n       int sleepMultiplier = 0;\n       if (entries.isEmpty()) {\n-        if (lastLoggedPosition != lastReadPosition) {\n-          updateLogPosition(lastReadPosition);\n-          // if there was nothing to ship and it's not an error\n-          // set \"ageOfLastShippedOp\" to <now> to indicate that we're current\n-          metrics.setAgeOfLastShippedOp(EnvironmentEdgeManager.currentTime(), walGroupId);\n-        }\n+        updateLogPosition(lastReadPosition);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8aa9447f7b239c430185018b5947e1b6c4520e1b"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU5NzE1Ng==", "bodyText": "Its ok to remove this setting?", "url": "https://github.com/apache/hbase/pull/980#discussion_r363597156", "createdAt": "2020-01-07T05:34:48Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -727,8 +740,7 @@ protected void shipEdits(WALEntryBatch entryBatch) {\n     }\n \n     private void updateLogPosition(long lastReadPosition) {\n-      manager.setPendingShipment(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8aa9447f7b239c430185018b5947e1b6c4520e1b"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU5NzIyOQ==", "bodyText": "We don't do pending flag anymore?", "url": "https://github.com/apache/hbase/pull/980#discussion_r363597229", "createdAt": "2020-01-07T05:35:16Z", "author": {"login": "saintstack"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -727,8 +740,7 @@ protected void shipEdits(WALEntryBatch entryBatch) {\n     }\n \n     private void updateLogPosition(long lastReadPosition) {\n-      manager.setPendingShipment(false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzU5NzE1Ng=="}, "originalCommit": {"oid": "8aa9447f7b239c430185018b5947e1b6c4520e1b"}, "originalPosition": 111}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3104, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}