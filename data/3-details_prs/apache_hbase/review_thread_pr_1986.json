{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwNzMyNDg0", "number": 1986, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQwMToyMDoyMVrOEJZdTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwMDoxNzo1N1rOENGTMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4Mjg5NzQzOnYy", "diffSide": "RIGHT", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/assignment/TestRegionReplicaSplit.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQwMToyMDoyMVrOGp5eig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwMToxMjowOFrOGr6Ieg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4NjUwNg==", "bodyText": "Why this change?", "url": "https://github.com/apache/hbase/pull/1986#discussion_r446586506", "createdAt": "2020-06-28T01:20:21Z", "author": {"login": "infraio"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/assignment/TestRegionReplicaSplit.java", "diffHunk": "@@ -109,7 +109,7 @@ public void testRegionReplicaSplitRegionAssignment() throws Exception {\n         }\n       }\n       // There are 6 regions before split, 9 regions after split.\n-      HTU.getAdmin().split(table.getName(), Bytes.toBytes(1));\n+      HTU.getAdmin().split(table.getName(), Bytes.toBytes(\"d\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "168102f3c09d85cba441ac8247de427626d8954d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEwMTQ0MA==", "bodyText": "Splitting with key \"1\" does not split hfiles. With \"d\", hfiles will be split as well.", "url": "https://github.com/apache/hbase/pull/1986#discussion_r447101440", "createdAt": "2020-06-29T16:31:35Z", "author": {"login": "huaxiangsun"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/assignment/TestRegionReplicaSplit.java", "diffHunk": "@@ -109,7 +109,7 @@ public void testRegionReplicaSplitRegionAssignment() throws Exception {\n         }\n       }\n       // There are 6 regions before split, 9 regions after split.\n-      HTU.getAdmin().split(table.getName(), Bytes.toBytes(1));\n+      HTU.getAdmin().split(table.getName(), Bytes.toBytes(\"d\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4NjUwNg=="}, "originalCommit": {"oid": "168102f3c09d85cba441ac8247de427626d8954d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODExMTk0NQ==", "bodyText": "can we add some assertions that the hfile split has happened?", "url": "https://github.com/apache/hbase/pull/1986#discussion_r448111945", "createdAt": "2020-07-01T04:43:43Z", "author": {"login": "busbey"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/assignment/TestRegionReplicaSplit.java", "diffHunk": "@@ -109,7 +109,7 @@ public void testRegionReplicaSplitRegionAssignment() throws Exception {\n         }\n       }\n       // There are 6 regions before split, 9 regions after split.\n-      HTU.getAdmin().split(table.getName(), Bytes.toBytes(1));\n+      HTU.getAdmin().split(table.getName(), Bytes.toBytes(\"d\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4NjUwNg=="}, "originalCommit": {"oid": "168102f3c09d85cba441ac8247de427626d8954d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY5NDM5NA==", "bodyText": "The latest patch addresses it, it now makes sure that every region has some hfiles (including the split daughter regions).", "url": "https://github.com/apache/hbase/pull/1986#discussion_r448694394", "createdAt": "2020-07-02T01:12:08Z", "author": {"login": "huaxiangsun"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/assignment/TestRegionReplicaSplit.java", "diffHunk": "@@ -109,7 +109,7 @@ public void testRegionReplicaSplitRegionAssignment() throws Exception {\n         }\n       }\n       // There are 6 regions before split, 9 regions after split.\n-      HTU.getAdmin().split(table.getName(), Bytes.toBytes(1));\n+      HTU.getAdmin().split(table.getName(), Bytes.toBytes(\"d\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjU4NjUwNg=="}, "originalCommit": {"oid": "168102f3c09d85cba441ac8247de427626d8954d"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMjI4NjM5OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/assignment/TestRegionReplicaSplit.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxODo0ODo0NFrOGuLSkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQyMDoxMzoyNlrOGvgMjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3MjY1Ng==", "bodyText": "Can we have a test to verify we don't split meta/read-only region?", "url": "https://github.com/apache/hbase/pull/1986#discussion_r451072656", "createdAt": "2020-07-07T18:48:44Z", "author": {"login": "clarax"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/assignment/TestRegionReplicaSplit.java", "diffHunk": "@@ -109,11 +112,16 @@ public void testRegionReplicaSplitRegionAssignment() throws Exception {\n         }\n       }\n       // There are 6 regions before split, 9 regions after split.\n-      HTU.getAdmin().split(table.getName(), Bytes.toBytes(1));\n+      HTU.getAdmin().split(table.getName(), Bytes.toBytes(\"d\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "518c97bfff2f9d582c7a9907bda5da9ee61fe102"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3OTc1Ng==", "bodyText": "Thanks Clara. Meta region is not supposed to be split (as split meta support yet). As for normal table replica/read-only regions, once the primary region is split, the read-only regions are supposed to be split as well. Do you mean something else?", "url": "https://github.com/apache/hbase/pull/1986#discussion_r451179756", "createdAt": "2020-07-07T22:28:48Z", "author": {"login": "huaxiangsun"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/assignment/TestRegionReplicaSplit.java", "diffHunk": "@@ -109,11 +112,16 @@ public void testRegionReplicaSplitRegionAssignment() throws Exception {\n         }\n       }\n       // There are 6 regions before split, 9 regions after split.\n-      HTU.getAdmin().split(table.getName(), Bytes.toBytes(1));\n+      HTU.getAdmin().split(table.getName(), Bytes.toBytes(\"d\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3MjY1Ng=="}, "originalCommit": {"oid": "518c97bfff2f9d582c7a9907bda5da9ee61fe102"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ2Mzc1OQ==", "bodyText": "I was referring to the check you put in and a test to validate. Thank you for the explanation.", "url": "https://github.com/apache/hbase/pull/1986#discussion_r452463759", "createdAt": "2020-07-09T20:13:26Z", "author": {"login": "clarax"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/assignment/TestRegionReplicaSplit.java", "diffHunk": "@@ -109,11 +112,16 @@ public void testRegionReplicaSplitRegionAssignment() throws Exception {\n         }\n       }\n       // There are 6 regions before split, 9 regions after split.\n-      HTU.getAdmin().split(table.getName(), Bytes.toBytes(1));\n+      HTU.getAdmin().split(table.getName(), Bytes.toBytes(\"d\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA3MjY1Ng=="}, "originalCommit": {"oid": "518c97bfff2f9d582c7a9907bda5da9ee61fe102"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyMTcwMTYyOnYy", "diffSide": "RIGHT", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/assignment/TestRegionReplicaSplit.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwMDoxNzo1N1rOGvl7Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNjoxNjoxMlrOGwvyTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU1NzY1OQ==", "bodyText": "Why do you expect there to be data in all stores?", "url": "https://github.com/apache/hbase/pull/1986#discussion_r452557659", "createdAt": "2020-07-10T00:17:57Z", "author": {"login": "ndimiduk"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/assignment/TestRegionReplicaSplit.java", "diffHunk": "@@ -109,11 +112,16 @@ public void testRegionReplicaSplitRegionAssignment() throws Exception {\n         }\n       }\n       // There are 6 regions before split, 9 regions after split.\n-      HTU.getAdmin().split(table.getName(), Bytes.toBytes(1));\n+      HTU.getAdmin().split(table.getName(), Bytes.toBytes(\"d\"));\n       int count = 0;\n       while (true) {\n         for (RegionServerThread rs : HTU.getMiniHBaseCluster().getRegionServerThreads()) {\n           for (Region r : rs.getRegionServer().getRegions(table.getName())) {\n+            // Make sure that every region has some data (even for split daughter regions).\n+            if (RegionReplicaUtil.isDefaultReplica(r.getRegionInfo())) {\n+              assertTrue(r.getStore(f).hasReferences() ||", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "518c97bfff2f9d582c7a9907bda5da9ee61fe102"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc2Nzc1Nw==", "bodyText": "That is per @busbey 's comments regarding with updating the split point, I think it is ok to make sure that after the split point change, every daughter region has some data, so coming up the assert. Since replica regions has some delay to map the data, the assert only makes sure that the primary(default) region gets data.", "url": "https://github.com/apache/hbase/pull/1986#discussion_r453767757", "createdAt": "2020-07-13T16:16:12Z", "author": {"login": "huaxiangsun"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/assignment/TestRegionReplicaSplit.java", "diffHunk": "@@ -109,11 +112,16 @@ public void testRegionReplicaSplitRegionAssignment() throws Exception {\n         }\n       }\n       // There are 6 regions before split, 9 regions after split.\n-      HTU.getAdmin().split(table.getName(), Bytes.toBytes(1));\n+      HTU.getAdmin().split(table.getName(), Bytes.toBytes(\"d\"));\n       int count = 0;\n       while (true) {\n         for (RegionServerThread rs : HTU.getMiniHBaseCluster().getRegionServerThreads()) {\n           for (Region r : rs.getRegionServer().getRegions(table.getName())) {\n+            // Make sure that every region has some data (even for split daughter regions).\n+            if (RegionReplicaUtil.isDefaultReplica(r.getRegionInfo())) {\n+              assertTrue(r.getStore(f).hasReferences() ||", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjU1NzY1OQ=="}, "originalCommit": {"oid": "518c97bfff2f9d582c7a9907bda5da9ee61fe102"}, "originalPosition": 45}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2869, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}