{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3MDg1NDYw", "number": 1279, "reviewThreads": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDoxNzoyMlrODnZ-bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQwNzowOTowOFrODqENiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNjQ2NjM5OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/LoadBalancer.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDoxNzoyMlrOF1Yj-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDoxNzoyMlrOF1Yj-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUyMTI3Mg==", "bodyText": "Add javadoc for the parameter of balanceCluster and balanceTable?", "url": "https://github.com/apache/hbase/pull/1279#discussion_r391521272", "createdAt": "2020-03-12T10:17:22Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/LoadBalancer.java", "diffHunk": "@@ -89,18 +89,18 @@\n   void setMasterServices(MasterServices masterServices);\n \n   /**\n-   * Perform the major balance operation\n+   * Perform the major balance operation for cluster\n    * @return List of plans\n    */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d57bdab63832c4c3c305fcdaea91f5e8ec622d73"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNzI1MTQ1OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/BaseLoadBalancer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNDowOToxN1rOF1gLiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMjoxOToxOFrOF11jTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0NjA5MQ==", "bodyText": "Why synchronized?", "url": "https://github.com/apache/hbase/pull/1279#discussion_r391646091", "createdAt": "2020-03-12T14:09:17Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/BaseLoadBalancer.java", "diffHunk": "@@ -1639,6 +1641,44 @@ private void roundRobinAssignment(Cluster cluster, List<RegionInfo> regions,\n     }\n   }\n \n+  private Map<ServerName, List<RegionInfo>> toEnsumbleTableClusterLoad(\n+      Map<TableName, Map<ServerName, List<RegionInfo>>> clusterLoadPerTable) {\n+    Map<ServerName, List<RegionInfo>> returnMap = new TreeMap<>();\n+    for (Map<ServerName, List<RegionInfo>> serverNameListMap : clusterLoadPerTable.values()) {\n+      serverNameListMap.forEach((serverName, regionInfoList) -> {\n+        List<RegionInfo> regionInfos =\n+            returnMap.computeIfAbsent(serverName, k -> new ArrayList<>());\n+        regionInfos.addAll(regionInfoList);\n+      });\n+    }\n+    return returnMap;\n+  }\n+\n+  @Override\n+  public List<RegionPlan> balanceTable(TableName tableName, Map<ServerName, List<RegionInfo>> clusterLoad){\n+    throw new UnsupportedOperationException(\"balanceTable is not support in BaseLoadBalancer\");\n+  }\n+\n+  @Override\n+  public synchronized List<RegionPlan>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ab54d1e014b762b1cf5117c74439ca01f8bd3af"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk5NjIzNw==", "bodyText": "method of the extends class need be synchronized", "url": "https://github.com/apache/hbase/pull/1279#discussion_r391996237", "createdAt": "2020-03-13T02:19:18Z", "author": {"login": "nyl3532016"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/BaseLoadBalancer.java", "diffHunk": "@@ -1639,6 +1641,44 @@ private void roundRobinAssignment(Cluster cluster, List<RegionInfo> regions,\n     }\n   }\n \n+  private Map<ServerName, List<RegionInfo>> toEnsumbleTableClusterLoad(\n+      Map<TableName, Map<ServerName, List<RegionInfo>>> clusterLoadPerTable) {\n+    Map<ServerName, List<RegionInfo>> returnMap = new TreeMap<>();\n+    for (Map<ServerName, List<RegionInfo>> serverNameListMap : clusterLoadPerTable.values()) {\n+      serverNameListMap.forEach((serverName, regionInfoList) -> {\n+        List<RegionInfo> regionInfos =\n+            returnMap.computeIfAbsent(serverName, k -> new ArrayList<>());\n+        regionInfos.addAll(regionInfoList);\n+      });\n+    }\n+    return returnMap;\n+  }\n+\n+  @Override\n+  public List<RegionPlan> balanceTable(TableName tableName, Map<ServerName, List<RegionInfo>> clusterLoad){\n+    throw new UnsupportedOperationException(\"balanceTable is not support in BaseLoadBalancer\");\n+  }\n+\n+  @Override\n+  public synchronized List<RegionPlan>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0NjA5MQ=="}, "originalCommit": {"oid": "5ab54d1e014b762b1cf5117c74439ca01f8bd3af"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNzI1NDg5OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/BaseLoadBalancer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNDoxMDowNlrOF1gNtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMjoyMzo0NVrOF11nIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0NjY0Ng==", "bodyText": "Unsupport? Should be abstrat method?", "url": "https://github.com/apache/hbase/pull/1279#discussion_r391646646", "createdAt": "2020-03-12T14:10:06Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/BaseLoadBalancer.java", "diffHunk": "@@ -1639,6 +1641,44 @@ private void roundRobinAssignment(Cluster cluster, List<RegionInfo> regions,\n     }\n   }\n \n+  private Map<ServerName, List<RegionInfo>> toEnsumbleTableClusterLoad(\n+      Map<TableName, Map<ServerName, List<RegionInfo>>> clusterLoadPerTable) {\n+    Map<ServerName, List<RegionInfo>> returnMap = new TreeMap<>();\n+    for (Map<ServerName, List<RegionInfo>> serverNameListMap : clusterLoadPerTable.values()) {\n+      serverNameListMap.forEach((serverName, regionInfoList) -> {\n+        List<RegionInfo> regionInfos =\n+            returnMap.computeIfAbsent(serverName, k -> new ArrayList<>());\n+        regionInfos.addAll(regionInfoList);\n+      });\n+    }\n+    return returnMap;\n+  }\n+\n+  @Override\n+  public List<RegionPlan> balanceTable(TableName tableName, Map<ServerName, List<RegionInfo>> clusterLoad){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ab54d1e014b762b1cf5117c74439ca01f8bd3af"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk5NzIxNg==", "bodyText": "yes ,it should be abstrat method", "url": "https://github.com/apache/hbase/pull/1279#discussion_r391997216", "createdAt": "2020-03-13T02:23:45Z", "author": {"login": "nyl3532016"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/BaseLoadBalancer.java", "diffHunk": "@@ -1639,6 +1641,44 @@ private void roundRobinAssignment(Cluster cluster, List<RegionInfo> regions,\n     }\n   }\n \n+  private Map<ServerName, List<RegionInfo>> toEnsumbleTableClusterLoad(\n+      Map<TableName, Map<ServerName, List<RegionInfo>>> clusterLoadPerTable) {\n+    Map<ServerName, List<RegionInfo>> returnMap = new TreeMap<>();\n+    for (Map<ServerName, List<RegionInfo>> serverNameListMap : clusterLoadPerTable.values()) {\n+      serverNameListMap.forEach((serverName, regionInfoList) -> {\n+        List<RegionInfo> regionInfos =\n+            returnMap.computeIfAbsent(serverName, k -> new ArrayList<>());\n+        regionInfos.addAll(regionInfoList);\n+      });\n+    }\n+    return returnMap;\n+  }\n+\n+  @Override\n+  public List<RegionPlan> balanceTable(TableName tableName, Map<ServerName, List<RegionInfo>> clusterLoad){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0NjY0Ng=="}, "originalCommit": {"oid": "5ab54d1e014b762b1cf5117c74439ca01f8bd3af"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNzI2MDc0OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/SimpleLoadBalancer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNDoxMToyNVrOF1gRRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMjoyNjozMlrOF11pQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0NzU1Nw==", "bodyText": "No need this?", "url": "https://github.com/apache/hbase/pull/1279#discussion_r391647557", "createdAt": "2020-03-12T14:11:25Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/SimpleLoadBalancer.java", "diffHunk": "@@ -106,6 +106,12 @@ void setNextRegionForUnload(int nextRegionForUnload) {\n \n   }\n \n+  @Override\n+  public synchronized void setConf(Configuration conf) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ab54d1e014b762b1cf5117c74439ca01f8bd3af"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk5Nzc2Mg==", "bodyText": "yes, I remove it", "url": "https://github.com/apache/hbase/pull/1279#discussion_r391997762", "createdAt": "2020-03-13T02:26:32Z", "author": {"login": "nyl3532016"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/SimpleLoadBalancer.java", "diffHunk": "@@ -106,6 +106,12 @@ void setNextRegionForUnload(int nextRegionForUnload) {\n \n   }\n \n+  @Override\n+  public synchronized void setConf(Configuration conf) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0NzU1Nw=="}, "originalCommit": {"oid": "5ab54d1e014b762b1cf5117c74439ca01f8bd3af"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNzI2NDY1OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/StochasticLoadBalancer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNDoxMjoxOVrOF1gTuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMjo0OTozM1rOF1184A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0ODE4NQ==", "bodyText": "If call super method directly, no need to add this method here?", "url": "https://github.com/apache/hbase/pull/1279#discussion_r391648185", "createdAt": "2020-03-12T14:12:19Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/StochasticLoadBalancer.java", "diffHunk": "@@ -360,10 +356,9 @@ protected boolean needsBalance(Cluster cluster) {\n   }\n \n   @Override\n-  public synchronized List<RegionPlan> balanceCluster(TableName tableName, Map<ServerName,\n-    List<RegionInfo>> clusterState) {\n-    this.tableName = tableName;\n-    return balanceCluster(clusterState);\n+  public synchronized List<RegionPlan> balanceCluster(Map<TableName, Map<ServerName,\n+    List<RegionInfo>>> clusterLoadPerTable) {\n+    return super.balanceCluster(clusterLoadPerTable);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ab54d1e014b762b1cf5117c74439ca01f8bd3af"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjAwMjc4NA==", "bodyText": "yes, I remove it", "url": "https://github.com/apache/hbase/pull/1279#discussion_r392002784", "createdAt": "2020-03-13T02:49:33Z", "author": {"login": "nyl3532016"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/StochasticLoadBalancer.java", "diffHunk": "@@ -360,10 +356,9 @@ protected boolean needsBalance(Cluster cluster) {\n   }\n \n   @Override\n-  public synchronized List<RegionPlan> balanceCluster(TableName tableName, Map<ServerName,\n-    List<RegionInfo>> clusterState) {\n-    this.tableName = tableName;\n-    return balanceCluster(clusterState);\n+  public synchronized List<RegionPlan> balanceCluster(Map<TableName, Map<ServerName,\n+    List<RegionInfo>>> clusterLoadPerTable) {\n+    return super.balanceCluster(clusterLoadPerTable);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0ODE4NQ=="}, "originalCommit": {"oid": "5ab54d1e014b762b1cf5117c74439ca01f8bd3af"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNzI3MTgxOnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupBasedLoadBalancer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNDoxMzo1NVrOF1gYGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMjozMjoxMlrOF11uQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0OTMwNw==", "bodyText": "Why not support here?", "url": "https://github.com/apache/hbase/pull/1279#discussion_r391649307", "createdAt": "2020-03-12T14:13:55Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupBasedLoadBalancer.java", "diffHunk": "@@ -427,4 +419,9 @@ public void postMasterStartupInitialize() {\n   public void updateBalancerStatus(boolean status) {\n     internalBalancer.updateBalancerStatus(status);\n   }\n+\n+  @Override\n+  public List<RegionPlan> balanceTable(TableName tableName, Map<ServerName, List<RegionInfo>> clusterLoad){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ab54d1e014b762b1cf5117c74439ca01f8bd3af"}, "originalPosition": 148}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk5OTA0MQ==", "bodyText": "yes , it should support", "url": "https://github.com/apache/hbase/pull/1279#discussion_r391999041", "createdAt": "2020-03-13T02:32:12Z", "author": {"login": "nyl3532016"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupBasedLoadBalancer.java", "diffHunk": "@@ -427,4 +419,9 @@ public void postMasterStartupInitialize() {\n   public void updateBalancerStatus(boolean status) {\n     internalBalancer.updateBalancerStatus(status);\n   }\n+\n+  @Override\n+  public List<RegionPlan> balanceTable(TableName tableName, Map<ServerName, List<RegionInfo>> clusterLoad){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY0OTMwNw=="}, "originalCommit": {"oid": "5ab54d1e014b762b1cf5117c74439ca01f8bd3af"}, "originalPosition": 148}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQyNzI3Nzc1OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/favored/FavoredNodeLoadBalancer.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxNDoxNToyNFrOF1gb8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwNzoyMzozM1rOF15w4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1MDI4OA==", "bodyText": "The balancer should only need to override balanceTable method?", "url": "https://github.com/apache/hbase/pull/1279#discussion_r391650288", "createdAt": "2020-03-12T14:15:24Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/favored/FavoredNodeLoadBalancer.java", "diffHunk": "@@ -87,7 +87,8 @@ public synchronized void initialize() throws HBaseIOException {\n   }\n \n   @Override\n-  public List<RegionPlan> balanceCluster(Map<ServerName, List<RegionInfo>> clusterState)  {\n+  public List<RegionPlan>\n+      balanceCluster(Map<TableName, Map<ServerName, List<RegionInfo>>> clusterLoadPerTable) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ab54d1e014b762b1cf5117c74439ca01f8bd3af"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjAxNDU3NQ==", "bodyText": "yes , but method 'balanceCluster' of this class not invoke 'balanceTable' , so just override balanceTable with null return", "url": "https://github.com/apache/hbase/pull/1279#discussion_r392014575", "createdAt": "2020-03-13T03:32:27Z", "author": {"login": "nyl3532016"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/favored/FavoredNodeLoadBalancer.java", "diffHunk": "@@ -87,7 +87,8 @@ public synchronized void initialize() throws HBaseIOException {\n   }\n \n   @Override\n-  public List<RegionPlan> balanceCluster(Map<ServerName, List<RegionInfo>> clusterState)  {\n+  public List<RegionPlan>\n+      balanceCluster(Map<TableName, Map<ServerName, List<RegionInfo>>> clusterLoadPerTable) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1MDI4OA=="}, "originalCommit": {"oid": "5ab54d1e014b762b1cf5117c74439ca01f8bd3af"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA2NTI0OA==", "bodyText": "Didn't get your point. Please add javadoc comment about why retrun null here.", "url": "https://github.com/apache/hbase/pull/1279#discussion_r392065248", "createdAt": "2020-03-13T07:23:33Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/favored/FavoredNodeLoadBalancer.java", "diffHunk": "@@ -87,7 +87,8 @@ public synchronized void initialize() throws HBaseIOException {\n   }\n \n   @Override\n-  public List<RegionPlan> balanceCluster(Map<ServerName, List<RegionInfo>> clusterState)  {\n+  public List<RegionPlan>\n+      balanceCluster(Map<TableName, Map<ServerName, List<RegionInfo>>> clusterLoadPerTable) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1MDI4OA=="}, "originalCommit": {"oid": "5ab54d1e014b762b1cf5117c74439ca01f8bd3af"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNDY0MjQ4OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/SimpleLoadBalancer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwNDozODo1N1rOF2lWIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwNDo0MTozMlrOF2lX7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc3OTI5OQ==", "bodyText": "Add reason for why need to setClusterLoad?", "url": "https://github.com/apache/hbase/pull/1279#discussion_r392779299", "createdAt": "2020-03-16T04:38:57Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/SimpleLoadBalancer.java", "diffHunk": "@@ -594,10 +597,13 @@ private void addRegionPlan(final MinMaxPriorityQueue<RegionPlan> regionsToMove,\n     regionsToReturn.add(rp);\n   }\n \n+  /**\n+   * Override to invoke {@link #setClusterLoad} before balance\n+   */\n   @Override\n-  public List<RegionPlan> balanceCluster(TableName tableName,\n-      Map<ServerName, List<RegionInfo>> clusterState) throws HBaseIOException {\n-    LOG.debug(\"Start Generate Balance plan for table: \" + tableName);\n-    return balanceCluster(clusterState);\n+  public synchronized List<RegionPlan>\n+      balanceCluster(Map<TableName, Map<ServerName, List<RegionInfo>>> clusterLoadPerTable) {\n+    setClusterLoad(clusterLoadPerTable);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d1d3f0d186a5d01add7be2bdd6f88edd44a399c"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc3OTc1OA==", "bodyText": "ok", "url": "https://github.com/apache/hbase/pull/1279#discussion_r392779758", "createdAt": "2020-03-16T04:41:32Z", "author": {"login": "nyl3532016"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/SimpleLoadBalancer.java", "diffHunk": "@@ -594,10 +597,13 @@ private void addRegionPlan(final MinMaxPriorityQueue<RegionPlan> regionsToMove,\n     regionsToReturn.add(rp);\n   }\n \n+  /**\n+   * Override to invoke {@link #setClusterLoad} before balance\n+   */\n   @Override\n-  public List<RegionPlan> balanceCluster(TableName tableName,\n-      Map<ServerName, List<RegionInfo>> clusterState) throws HBaseIOException {\n-    LOG.debug(\"Start Generate Balance plan for table: \" + tableName);\n-    return balanceCluster(clusterState);\n+  public synchronized List<RegionPlan>\n+      balanceCluster(Map<TableName, Map<ServerName, List<RegionInfo>>> clusterLoadPerTable) {\n+    setClusterLoad(clusterLoadPerTable);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc3OTI5OQ=="}, "originalCommit": {"oid": "2d1d3f0d186a5d01add7be2bdd6f88edd44a399c"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNDY1NTE0OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupBasedLoadBalancer.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwNDo0OTowM1rOF2ldnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwNDo0OTowM1rOF2ldnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc4MTIxNQ==", "bodyText": "It is wired to call balanceClsuter here. Maybe abstract a new method balanceTableInRSGroup. And balanceTable and balanceClsuter both call the new method.", "url": "https://github.com/apache/hbase/pull/1279#discussion_r392781215", "createdAt": "2020-03-16T04:49:03Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupBasedLoadBalancer.java", "diffHunk": "@@ -427,4 +421,19 @@ public void postMasterStartupInitialize() {\n   public void updateBalancerStatus(boolean status) {\n     internalBalancer.updateBalancerStatus(status);\n   }\n+\n+  /**\n+   * can achieve table balanced rather than overall balanced\n+   */\n+  @Override\n+  public List<RegionPlan> balanceTable(TableName tableName,\n+      Map<ServerName, List<RegionInfo>> clusterLoad) {\n+    Map<TableName, Map<ServerName, List<RegionInfo>>> clusterLoadThisTable = new HashMap<>();\n+    clusterLoadThisTable.put(tableName, clusterLoad);\n+    try {\n+      return balanceCluster(clusterLoadThisTable);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e1adf9b807d3af8e1b7675128f8664cc595e535"}, "originalPosition": 172}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNjE4OTA1OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupBasedLoadBalancer.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMzozMTowOVrOF20P_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMzozMTowOVrOF20P_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAyMzQ4Ng==", "bodyText": "LoadOfTableInGroup => loadOfTablesInGroup", "url": "https://github.com/apache/hbase/pull/1279#discussion_r393023486", "createdAt": "2020-03-16T13:31:09Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupBasedLoadBalancer.java", "diffHunk": "@@ -111,51 +109,44 @@ public void setMasterServices(MasterServices masterServices) {\n     this.masterServices = masterServices;\n   }\n \n+  /**\n+   * Override to balance by RSGroup\n+   * not invoke {@link #balanceTable(TableName, Map)}\n+   */\n   @Override\n-  public List<RegionPlan> balanceCluster(TableName tableName, Map<ServerName, List<RegionInfo>>\n-      clusterState) throws IOException {\n-    return balanceCluster(clusterState);\n-  }\n-\n-  @Override\n-  public List<RegionPlan> balanceCluster(Map<ServerName, List<RegionInfo>> clusterState)\n-      throws IOException {\n+  public List<RegionPlan> balanceCluster(\n+      Map<TableName, Map<ServerName, List<RegionInfo>>> loadOfAllTable) throws IOException {\n     if (!isOnline()) {\n       throw new ConstraintException(\n           RSGroupInfoManager.class.getSimpleName() + \" is not online, unable to perform balance\");\n     }\n \n     // Calculate correct assignments and a list of RegionPlan for mis-placed regions\n-    Pair<Map<ServerName,List<RegionInfo>>, List<RegionPlan>> correctedStateAndRegionPlans =\n-        correctAssignments(clusterState);\n-    Map<ServerName,List<RegionInfo>> correctedState = correctedStateAndRegionPlans.getFirst();\n+    Pair<Map<TableName, Map<ServerName, List<RegionInfo>>>, List<RegionPlan>> correctedStateAndRegionPlans =\n+        correctAssignments(loadOfAllTable);\n+    Map<TableName, Map<ServerName, List<RegionInfo>>> correctedLoadOfAllTable =\n+        correctedStateAndRegionPlans.getFirst();\n     List<RegionPlan> regionPlans = correctedStateAndRegionPlans.getSecond();\n-\n+    RSGroupInfo defaultInfo = rsGroupInfoManager.getRSGroup(RSGroupInfo.DEFAULT_GROUP);\n     // Add RegionPlan\n     // for the regions which have been placed according to the region server group assignment\n     // into the movement list\n     try {\n-      // Record which region servers have been processed\uff0cso as to skip them after processed\n-      HashSet<ServerName> processedServers = new HashSet<>();\n-\n       // For each rsgroup\n       for (RSGroupInfo rsgroup : rsGroupInfoManager.listRSGroups()) {\n-        Map<ServerName, List<RegionInfo>> groupClusterState = new HashMap<>();\n-        Map<TableName, Map<ServerName, List<RegionInfo>>> groupClusterLoad = new HashMap<>();\n-        for (ServerName server : clusterState.keySet()) { // for each region server\n-          if (!processedServers.contains(server) // server is not processed yet\n-              && rsgroup.containsServer(server.getAddress())) { // server belongs to this rsgroup\n-            List<RegionInfo> regionsOnServer = correctedState.get(server);\n-            groupClusterState.put(server, regionsOnServer);\n-\n-            processedServers.add(server);\n+        Map<TableName, Map<ServerName, List<RegionInfo>>> LoadOfTableInGroup =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5fe214eec9737fedc440f467b924f79ef7db8af"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNjIwMjQ0OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/balancer/TestDefaultLoadBalancer.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMzozNDo0MFrOF20YaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMzozNDo0MFrOF20YaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAyNTY0MA==", "bodyText": "This test is for SimpleLoadBalancer? Rename TestDefaultLoadBalancer to TestSimpleLoadBalancer?", "url": "https://github.com/apache/hbase/pull/1279#discussion_r393025640", "createdAt": "2020-03-16T13:34:40Z", "author": {"login": "infraio"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/balancer/TestDefaultLoadBalancer.java", "diffHunk": "@@ -58,7 +57,7 @@\n \n   private static final Logger LOG = LoggerFactory.getLogger(TestDefaultLoadBalancer.class);\n \n-  private static LoadBalancer loadBalancer;\n+  private static SimpleLoadBalancer loadBalancer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5fe214eec9737fedc440f467b924f79ef7db8af"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MDc4NjQ5OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/BaseLoadBalancer.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQwMTowODozM1rOF5FPjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxMDo0MjowOFrOF5o0cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM5OTA1NA==", "bodyText": "There is no Table ENSEMBLE_TABLE_NAME actually, need to change this log?", "url": "https://github.com/apache/hbase/pull/1279#discussion_r395399054", "createdAt": "2020-03-20T01:08:33Z", "author": {"login": "binlijin"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/BaseLoadBalancer.java", "diffHunk": "@@ -1639,6 +1637,44 @@ private void roundRobinAssignment(Cluster cluster, List<RegionInfo> regions,\n     }\n   }\n \n+  private Map<ServerName, List<RegionInfo>> toEnsumbleTableLoad(\n+      Map<TableName, Map<ServerName, List<RegionInfo>>> LoadOfAllTable) {\n+    Map<ServerName, List<RegionInfo>> returnMap = new TreeMap<>();\n+    for (Map<ServerName, List<RegionInfo>> serverNameListMap : LoadOfAllTable.values()) {\n+      serverNameListMap.forEach((serverName, regionInfoList) -> {\n+        List<RegionInfo> regionInfos =\n+            returnMap.computeIfAbsent(serverName, k -> new ArrayList<>());\n+        regionInfos.addAll(regionInfoList);\n+      });\n+    }\n+    return returnMap;\n+  }\n+\n+  @Override\n+  public abstract List<RegionPlan> balanceTable(TableName tableName,\n+      Map<ServerName, List<RegionInfo>> loadOfOneTable);\n+\n+\n+  @Override\n+  public List<RegionPlan>\n+      balanceCluster(Map<TableName, Map<ServerName, List<RegionInfo>>> loadOfAllTable) {\n+    if (isByTable) {\n+      List<RegionPlan> result = new ArrayList<>();\n+      loadOfAllTable.forEach((tableName, loadOfOneTable) -> {\n+        LOG.debug(\"Start Generate Balance plan for table: \" + tableName);\n+        List<RegionPlan> partialPlans = balanceTable(tableName, loadOfOneTable);\n+        if (partialPlans != null) {\n+          result.addAll(partialPlans);\n+        }\n+      });\n+      return result;\n+    } else {\n+      LOG.debug(\"Start Generate Balance plan for table: \" + HConstants.ENSEMBLE_TABLE_NAME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05965882ea72b78a16e3ed52bc5d0ac52277c543"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQyMDgwNQ==", "bodyText": "it convenient to debug ,balance for Table ENSEMBLE_TABLE_NAME , mean balanceByTable is false, we just consider all region as one table's", "url": "https://github.com/apache/hbase/pull/1279#discussion_r395420805", "createdAt": "2020-03-20T03:04:49Z", "author": {"login": "nyl3532016"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/BaseLoadBalancer.java", "diffHunk": "@@ -1639,6 +1637,44 @@ private void roundRobinAssignment(Cluster cluster, List<RegionInfo> regions,\n     }\n   }\n \n+  private Map<ServerName, List<RegionInfo>> toEnsumbleTableLoad(\n+      Map<TableName, Map<ServerName, List<RegionInfo>>> LoadOfAllTable) {\n+    Map<ServerName, List<RegionInfo>> returnMap = new TreeMap<>();\n+    for (Map<ServerName, List<RegionInfo>> serverNameListMap : LoadOfAllTable.values()) {\n+      serverNameListMap.forEach((serverName, regionInfoList) -> {\n+        List<RegionInfo> regionInfos =\n+            returnMap.computeIfAbsent(serverName, k -> new ArrayList<>());\n+        regionInfos.addAll(regionInfoList);\n+      });\n+    }\n+    return returnMap;\n+  }\n+\n+  @Override\n+  public abstract List<RegionPlan> balanceTable(TableName tableName,\n+      Map<ServerName, List<RegionInfo>> loadOfOneTable);\n+\n+\n+  @Override\n+  public List<RegionPlan>\n+      balanceCluster(Map<TableName, Map<ServerName, List<RegionInfo>>> loadOfAllTable) {\n+    if (isByTable) {\n+      List<RegionPlan> result = new ArrayList<>();\n+      loadOfAllTable.forEach((tableName, loadOfOneTable) -> {\n+        LOG.debug(\"Start Generate Balance plan for table: \" + tableName);\n+        List<RegionPlan> partialPlans = balanceTable(tableName, loadOfOneTable);\n+        if (partialPlans != null) {\n+          result.addAll(partialPlans);\n+        }\n+      });\n+      return result;\n+    } else {\n+      LOG.debug(\"Start Generate Balance plan for table: \" + HConstants.ENSEMBLE_TABLE_NAME);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM5OTA1NA=="}, "originalCommit": {"oid": "05965882ea72b78a16e3ed52bc5d0ac52277c543"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk2OTA2Nw==", "bodyText": "May be good to log \"\"Start generate balance plan for cluster\". No need log the ENSEMBLE_TABLE_NAME.  And this log can be info?", "url": "https://github.com/apache/hbase/pull/1279#discussion_r395969067", "createdAt": "2020-03-21T07:05:49Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/BaseLoadBalancer.java", "diffHunk": "@@ -1639,6 +1637,44 @@ private void roundRobinAssignment(Cluster cluster, List<RegionInfo> regions,\n     }\n   }\n \n+  private Map<ServerName, List<RegionInfo>> toEnsumbleTableLoad(\n+      Map<TableName, Map<ServerName, List<RegionInfo>>> LoadOfAllTable) {\n+    Map<ServerName, List<RegionInfo>> returnMap = new TreeMap<>();\n+    for (Map<ServerName, List<RegionInfo>> serverNameListMap : LoadOfAllTable.values()) {\n+      serverNameListMap.forEach((serverName, regionInfoList) -> {\n+        List<RegionInfo> regionInfos =\n+            returnMap.computeIfAbsent(serverName, k -> new ArrayList<>());\n+        regionInfos.addAll(regionInfoList);\n+      });\n+    }\n+    return returnMap;\n+  }\n+\n+  @Override\n+  public abstract List<RegionPlan> balanceTable(TableName tableName,\n+      Map<ServerName, List<RegionInfo>> loadOfOneTable);\n+\n+\n+  @Override\n+  public List<RegionPlan>\n+      balanceCluster(Map<TableName, Map<ServerName, List<RegionInfo>>> loadOfAllTable) {\n+    if (isByTable) {\n+      List<RegionPlan> result = new ArrayList<>();\n+      loadOfAllTable.forEach((tableName, loadOfOneTable) -> {\n+        LOG.debug(\"Start Generate Balance plan for table: \" + tableName);\n+        List<RegionPlan> partialPlans = balanceTable(tableName, loadOfOneTable);\n+        if (partialPlans != null) {\n+          result.addAll(partialPlans);\n+        }\n+      });\n+      return result;\n+    } else {\n+      LOG.debug(\"Start Generate Balance plan for table: \" + HConstants.ENSEMBLE_TABLE_NAME);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM5OTA1NA=="}, "originalCommit": {"oid": "05965882ea72b78a16e3ed52bc5d0ac52277c543"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk4MTkzOA==", "bodyText": "yes, you are right", "url": "https://github.com/apache/hbase/pull/1279#discussion_r395981938", "createdAt": "2020-03-21T10:42:08Z", "author": {"login": "nyl3532016"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/BaseLoadBalancer.java", "diffHunk": "@@ -1639,6 +1637,44 @@ private void roundRobinAssignment(Cluster cluster, List<RegionInfo> regions,\n     }\n   }\n \n+  private Map<ServerName, List<RegionInfo>> toEnsumbleTableLoad(\n+      Map<TableName, Map<ServerName, List<RegionInfo>>> LoadOfAllTable) {\n+    Map<ServerName, List<RegionInfo>> returnMap = new TreeMap<>();\n+    for (Map<ServerName, List<RegionInfo>> serverNameListMap : LoadOfAllTable.values()) {\n+      serverNameListMap.forEach((serverName, regionInfoList) -> {\n+        List<RegionInfo> regionInfos =\n+            returnMap.computeIfAbsent(serverName, k -> new ArrayList<>());\n+        regionInfos.addAll(regionInfoList);\n+      });\n+    }\n+    return returnMap;\n+  }\n+\n+  @Override\n+  public abstract List<RegionPlan> balanceTable(TableName tableName,\n+      Map<ServerName, List<RegionInfo>> loadOfOneTable);\n+\n+\n+  @Override\n+  public List<RegionPlan>\n+      balanceCluster(Map<TableName, Map<ServerName, List<RegionInfo>>> loadOfAllTable) {\n+    if (isByTable) {\n+      List<RegionPlan> result = new ArrayList<>();\n+      loadOfAllTable.forEach((tableName, loadOfOneTable) -> {\n+        LOG.debug(\"Start Generate Balance plan for table: \" + tableName);\n+        List<RegionPlan> partialPlans = balanceTable(tableName, loadOfOneTable);\n+        if (partialPlans != null) {\n+          result.addAll(partialPlans);\n+        }\n+      });\n+      return result;\n+    } else {\n+      LOG.debug(\"Start Generate Balance plan for table: \" + HConstants.ENSEMBLE_TABLE_NAME);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM5OTA1NA=="}, "originalCommit": {"oid": "05965882ea72b78a16e3ed52bc5d0ac52277c543"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDM1NjM0OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/BaseLoadBalancer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQwNzowNTo0NFrOF5oCKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxMDo0MjozNlrOF5o0kQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk2OTA2NA==", "bodyText": "LOG.info(\"Start generate balance plan for table: {}\", tableName);", "url": "https://github.com/apache/hbase/pull/1279#discussion_r395969064", "createdAt": "2020-03-21T07:05:44Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/BaseLoadBalancer.java", "diffHunk": "@@ -1639,6 +1637,44 @@ private void roundRobinAssignment(Cluster cluster, List<RegionInfo> regions,\n     }\n   }\n \n+  private Map<ServerName, List<RegionInfo>> toEnsumbleTableLoad(\n+      Map<TableName, Map<ServerName, List<RegionInfo>>> LoadOfAllTable) {\n+    Map<ServerName, List<RegionInfo>> returnMap = new TreeMap<>();\n+    for (Map<ServerName, List<RegionInfo>> serverNameListMap : LoadOfAllTable.values()) {\n+      serverNameListMap.forEach((serverName, regionInfoList) -> {\n+        List<RegionInfo> regionInfos =\n+            returnMap.computeIfAbsent(serverName, k -> new ArrayList<>());\n+        regionInfos.addAll(regionInfoList);\n+      });\n+    }\n+    return returnMap;\n+  }\n+\n+  @Override\n+  public abstract List<RegionPlan> balanceTable(TableName tableName,\n+      Map<ServerName, List<RegionInfo>> loadOfOneTable);\n+\n+\n+  @Override\n+  public List<RegionPlan>\n+      balanceCluster(Map<TableName, Map<ServerName, List<RegionInfo>>> loadOfAllTable) {\n+    if (isByTable) {\n+      List<RegionPlan> result = new ArrayList<>();\n+      loadOfAllTable.forEach((tableName, loadOfOneTable) -> {\n+        LOG.debug(\"Start Generate Balance plan for table: \" + tableName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05965882ea72b78a16e3ed52bc5d0ac52277c543"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk4MTk2OQ==", "bodyText": "ok , I will change  this", "url": "https://github.com/apache/hbase/pull/1279#discussion_r395981969", "createdAt": "2020-03-21T10:42:36Z", "author": {"login": "nyl3532016"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/balancer/BaseLoadBalancer.java", "diffHunk": "@@ -1639,6 +1637,44 @@ private void roundRobinAssignment(Cluster cluster, List<RegionInfo> regions,\n     }\n   }\n \n+  private Map<ServerName, List<RegionInfo>> toEnsumbleTableLoad(\n+      Map<TableName, Map<ServerName, List<RegionInfo>>> LoadOfAllTable) {\n+    Map<ServerName, List<RegionInfo>> returnMap = new TreeMap<>();\n+    for (Map<ServerName, List<RegionInfo>> serverNameListMap : LoadOfAllTable.values()) {\n+      serverNameListMap.forEach((serverName, regionInfoList) -> {\n+        List<RegionInfo> regionInfos =\n+            returnMap.computeIfAbsent(serverName, k -> new ArrayList<>());\n+        regionInfos.addAll(regionInfoList);\n+      });\n+    }\n+    return returnMap;\n+  }\n+\n+  @Override\n+  public abstract List<RegionPlan> balanceTable(TableName tableName,\n+      Map<ServerName, List<RegionInfo>> loadOfOneTable);\n+\n+\n+  @Override\n+  public List<RegionPlan>\n+      balanceCluster(Map<TableName, Map<ServerName, List<RegionInfo>>> loadOfAllTable) {\n+    if (isByTable) {\n+      List<RegionPlan> result = new ArrayList<>();\n+      loadOfAllTable.forEach((tableName, loadOfOneTable) -> {\n+        LOG.debug(\"Start Generate Balance plan for table: \" + tableName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk2OTA2NA=="}, "originalCommit": {"oid": "05965882ea72b78a16e3ed52bc5d0ac52277c543"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1NDM1Nzg0OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupBasedLoadBalancer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQwNzowOTowOFrOF5oC6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxMDo0MzoxNVrOF5o00Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk2OTI1Nw==", "bodyText": "add log here, too?", "url": "https://github.com/apache/hbase/pull/1279#discussion_r395969257", "createdAt": "2020-03-21T07:09:08Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupBasedLoadBalancer.java", "diffHunk": "@@ -111,51 +109,45 @@ public void setMasterServices(MasterServices masterServices) {\n     this.masterServices = masterServices;\n   }\n \n+  /**\n+   * Override to balance by RSGroup\n+   * not invoke {@link #balanceTable(TableName, Map)}\n+   */\n   @Override\n-  public List<RegionPlan> balanceCluster(TableName tableName, Map<ServerName, List<RegionInfo>>\n-      clusterState) throws IOException {\n-    return balanceCluster(clusterState);\n-  }\n-\n-  @Override\n-  public List<RegionPlan> balanceCluster(Map<ServerName, List<RegionInfo>> clusterState)\n-      throws IOException {\n+  public List<RegionPlan> balanceCluster(\n+      Map<TableName, Map<ServerName, List<RegionInfo>>> loadOfAllTable) throws IOException {\n     if (!isOnline()) {\n       throw new ConstraintException(\n           RSGroupInfoManager.class.getSimpleName() + \" is not online, unable to perform balance\");\n     }\n \n     // Calculate correct assignments and a list of RegionPlan for mis-placed regions\n-    Pair<Map<ServerName,List<RegionInfo>>, List<RegionPlan>> correctedStateAndRegionPlans =\n-        correctAssignments(clusterState);\n-    Map<ServerName,List<RegionInfo>> correctedState = correctedStateAndRegionPlans.getFirst();\n+    Pair<Map<TableName, Map<ServerName, List<RegionInfo>>>, List<RegionPlan>> correctedStateAndRegionPlans =\n+        correctAssignments(loadOfAllTable);\n+    Map<TableName, Map<ServerName, List<RegionInfo>>> correctedLoadOfAllTable =\n+        correctedStateAndRegionPlans.getFirst();\n     List<RegionPlan> regionPlans = correctedStateAndRegionPlans.getSecond();\n-\n+    RSGroupInfo defaultInfo = rsGroupInfoManager.getRSGroup(RSGroupInfo.DEFAULT_GROUP);\n     // Add RegionPlan\n     // for the regions which have been placed according to the region server group assignment\n     // into the movement list\n     try {\n-      // Record which region servers have been processed\uff0cso as to skip them after processed\n-      HashSet<ServerName> processedServers = new HashSet<>();\n-\n       // For each rsgroup\n       for (RSGroupInfo rsgroup : rsGroupInfoManager.listRSGroups()) {\n-        Map<ServerName, List<RegionInfo>> groupClusterState = new HashMap<>();\n-        Map<TableName, Map<ServerName, List<RegionInfo>>> groupClusterLoad = new HashMap<>();\n-        for (ServerName server : clusterState.keySet()) { // for each region server\n-          if (!processedServers.contains(server) // server is not processed yet\n-              && rsgroup.containsServer(server.getAddress())) { // server belongs to this rsgroup\n-            List<RegionInfo> regionsOnServer = correctedState.get(server);\n-            groupClusterState.put(server, regionsOnServer);\n-\n-            processedServers.add(server);\n+        Map<TableName, Map<ServerName, List<RegionInfo>>> loadOfTablesInGroup =\n+            new HashMap<>();\n+        for (Map.Entry<TableName, Map<ServerName, List<RegionInfo>>> entry: correctedLoadOfAllTable.entrySet()) {\n+          TableName tableName = entry.getKey();\n+          RSGroupInfo targetRSGInfo = RSGroupUtil\n+              .getRSGroupInfo(masterServices, rsGroupInfoManager, tableName).orElse(defaultInfo);\n+          if (targetRSGInfo.getName().equals(rsgroup.getName())) {\n+            loadOfTablesInGroup.put(tableName, entry.getValue());\n           }\n         }\n-\n-        groupClusterLoad.put(HConstants.ENSEMBLE_TABLE_NAME, groupClusterState);\n-        this.internalBalancer.setClusterLoad(groupClusterLoad);\n-        List<RegionPlan> groupPlans = this.internalBalancer\n-            .balanceCluster(groupClusterState);\n+        List<RegionPlan> groupPlans = null;\n+        if (!loadOfTablesInGroup.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05965882ea72b78a16e3ed52bc5d0ac52277c543"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk4MjAzMw==", "bodyText": "well , I add some log", "url": "https://github.com/apache/hbase/pull/1279#discussion_r395982033", "createdAt": "2020-03-21T10:43:15Z", "author": {"login": "nyl3532016"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/rsgroup/RSGroupBasedLoadBalancer.java", "diffHunk": "@@ -111,51 +109,45 @@ public void setMasterServices(MasterServices masterServices) {\n     this.masterServices = masterServices;\n   }\n \n+  /**\n+   * Override to balance by RSGroup\n+   * not invoke {@link #balanceTable(TableName, Map)}\n+   */\n   @Override\n-  public List<RegionPlan> balanceCluster(TableName tableName, Map<ServerName, List<RegionInfo>>\n-      clusterState) throws IOException {\n-    return balanceCluster(clusterState);\n-  }\n-\n-  @Override\n-  public List<RegionPlan> balanceCluster(Map<ServerName, List<RegionInfo>> clusterState)\n-      throws IOException {\n+  public List<RegionPlan> balanceCluster(\n+      Map<TableName, Map<ServerName, List<RegionInfo>>> loadOfAllTable) throws IOException {\n     if (!isOnline()) {\n       throw new ConstraintException(\n           RSGroupInfoManager.class.getSimpleName() + \" is not online, unable to perform balance\");\n     }\n \n     // Calculate correct assignments and a list of RegionPlan for mis-placed regions\n-    Pair<Map<ServerName,List<RegionInfo>>, List<RegionPlan>> correctedStateAndRegionPlans =\n-        correctAssignments(clusterState);\n-    Map<ServerName,List<RegionInfo>> correctedState = correctedStateAndRegionPlans.getFirst();\n+    Pair<Map<TableName, Map<ServerName, List<RegionInfo>>>, List<RegionPlan>> correctedStateAndRegionPlans =\n+        correctAssignments(loadOfAllTable);\n+    Map<TableName, Map<ServerName, List<RegionInfo>>> correctedLoadOfAllTable =\n+        correctedStateAndRegionPlans.getFirst();\n     List<RegionPlan> regionPlans = correctedStateAndRegionPlans.getSecond();\n-\n+    RSGroupInfo defaultInfo = rsGroupInfoManager.getRSGroup(RSGroupInfo.DEFAULT_GROUP);\n     // Add RegionPlan\n     // for the regions which have been placed according to the region server group assignment\n     // into the movement list\n     try {\n-      // Record which region servers have been processed\uff0cso as to skip them after processed\n-      HashSet<ServerName> processedServers = new HashSet<>();\n-\n       // For each rsgroup\n       for (RSGroupInfo rsgroup : rsGroupInfoManager.listRSGroups()) {\n-        Map<ServerName, List<RegionInfo>> groupClusterState = new HashMap<>();\n-        Map<TableName, Map<ServerName, List<RegionInfo>>> groupClusterLoad = new HashMap<>();\n-        for (ServerName server : clusterState.keySet()) { // for each region server\n-          if (!processedServers.contains(server) // server is not processed yet\n-              && rsgroup.containsServer(server.getAddress())) { // server belongs to this rsgroup\n-            List<RegionInfo> regionsOnServer = correctedState.get(server);\n-            groupClusterState.put(server, regionsOnServer);\n-\n-            processedServers.add(server);\n+        Map<TableName, Map<ServerName, List<RegionInfo>>> loadOfTablesInGroup =\n+            new HashMap<>();\n+        for (Map.Entry<TableName, Map<ServerName, List<RegionInfo>>> entry: correctedLoadOfAllTable.entrySet()) {\n+          TableName tableName = entry.getKey();\n+          RSGroupInfo targetRSGInfo = RSGroupUtil\n+              .getRSGroupInfo(masterServices, rsGroupInfoManager, tableName).orElse(defaultInfo);\n+          if (targetRSGInfo.getName().equals(rsgroup.getName())) {\n+            loadOfTablesInGroup.put(tableName, entry.getValue());\n           }\n         }\n-\n-        groupClusterLoad.put(HConstants.ENSEMBLE_TABLE_NAME, groupClusterState);\n-        this.internalBalancer.setClusterLoad(groupClusterLoad);\n-        List<RegionPlan> groupPlans = this.internalBalancer\n-            .balanceCluster(groupClusterState);\n+        List<RegionPlan> groupPlans = null;\n+        if (!loadOfTablesInGroup.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk2OTI1Nw=="}, "originalCommit": {"oid": "05965882ea72b78a16e3ed52bc5d0ac52277c543"}, "originalPosition": 78}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1999, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}