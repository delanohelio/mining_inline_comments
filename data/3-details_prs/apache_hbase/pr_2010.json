{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyNjE0OTA2", "number": 2010, "title": "HBASE-24391 Implement meta split", "bodyText": "", "createdAt": "2020-07-01T10:47:19Z", "url": "https://github.com/apache/hbase/pull/2010", "merged": true, "mergeCommit": {"oid": "e5cf12e94a04a880f4b7eefc66f01aee837769c6"}, "closed": true, "closedAt": "2020-09-07T02:59:44Z", "author": {"login": "Apache9"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwrp-ogBqjM1MDI5MTY4ODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGZdC8AFqTQ4MzIwNjQ4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "184543653825596c7b084e93a2488ac693eab6e9", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/184543653825596c7b084e93a2488ac693eab6e9", "committedDate": "2020-07-01T10:46:03Z", "message": "HBASE-24391 Implement meta split"}, "afterCommit": {"oid": "adfd91312239d4ea348f4e82bdd2d0f09a8f7de4", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/adfd91312239d4ea348f4e82bdd2d0f09a8f7de4", "committedDate": "2020-07-01T15:03:37Z", "message": "HBASE-24391 Implement meta split"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "adfd91312239d4ea348f4e82bdd2d0f09a8f7de4", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/adfd91312239d4ea348f4e82bdd2d0f09a8f7de4", "committedDate": "2020-07-01T15:03:37Z", "message": "HBASE-24391 Implement meta split"}, "afterCommit": {"oid": "4d47a37fc5c40259caad6e00892a30264fb52fc9", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/4d47a37fc5c40259caad6e00892a30264fb52fc9", "committedDate": "2020-07-04T15:36:17Z", "message": "HBASE-24391 Implement meta split"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4d47a37fc5c40259caad6e00892a30264fb52fc9", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/4d47a37fc5c40259caad6e00892a30264fb52fc9", "committedDate": "2020-07-04T15:36:17Z", "message": "HBASE-24391 Implement meta split"}, "afterCommit": {"oid": "2c5c24e17fc30343993870a4b79c19c30963baa6", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/2c5c24e17fc30343993870a4b79c19c30963baa6", "committedDate": "2020-07-10T07:44:14Z", "message": "HBASE-24391 Implement meta split"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2c5c24e17fc30343993870a4b79c19c30963baa6", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/2c5c24e17fc30343993870a4b79c19c30963baa6", "committedDate": "2020-07-10T07:44:14Z", "message": "HBASE-24391 Implement meta split"}, "afterCommit": {"oid": "9c7f193e17ecc822b74628a1adfe91bbe3959f82", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/9c7f193e17ecc822b74628a1adfe91bbe3959f82", "committedDate": "2020-08-09T14:24:10Z", "message": "HBASE-24391 Implement meta split"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c7f193e17ecc822b74628a1adfe91bbe3959f82", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/9c7f193e17ecc822b74628a1adfe91bbe3959f82", "committedDate": "2020-08-09T14:24:10Z", "message": "HBASE-24391 Implement meta split"}, "afterCommit": {"oid": "d9caed08ec58fd0ccada31158788299197191d4c", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/d9caed08ec58fd0ccada31158788299197191d4c", "committedDate": "2020-08-11T10:41:51Z", "message": "HBASE-24391 Implement meta split"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d9caed08ec58fd0ccada31158788299197191d4c", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/d9caed08ec58fd0ccada31158788299197191d4c", "committedDate": "2020-08-11T10:41:51Z", "message": "HBASE-24391 Implement meta split"}, "afterCommit": {"oid": "d8eb5822fedc78298a6ad718c4d9c56d99f1fa65", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/d8eb5822fedc78298a6ad718c4d9c56d99f1fa65", "committedDate": "2020-08-12T02:43:37Z", "message": "HBASE-24391 Implement meta split"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d8eb5822fedc78298a6ad718c4d9c56d99f1fa65", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/d8eb5822fedc78298a6ad718c4d9c56d99f1fa65", "committedDate": "2020-08-12T02:43:37Z", "message": "HBASE-24391 Implement meta split"}, "afterCommit": {"oid": "354b09051e6febc00d386bb59b78d69383b88490", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/354b09051e6febc00d386bb59b78d69383b88490", "committedDate": "2020-08-17T14:59:33Z", "message": "HBASE-24391 Implement meta split"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "354b09051e6febc00d386bb59b78d69383b88490", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/354b09051e6febc00d386bb59b78d69383b88490", "committedDate": "2020-08-17T14:59:33Z", "message": "HBASE-24391 Implement meta split"}, "afterCommit": {"oid": "99f7eac50e102c68e8be396b234d1d226c380d31", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/99f7eac50e102c68e8be396b234d1d226c380d31", "committedDate": "2020-08-19T06:41:16Z", "message": "HBASE-24391 Implement meta split"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "99f7eac50e102c68e8be396b234d1d226c380d31", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/99f7eac50e102c68e8be396b234d1d226c380d31", "committedDate": "2020-08-19T06:41:16Z", "message": "HBASE-24391 Implement meta split"}, "afterCommit": {"oid": "8c2c64321c51291b92ed4f5faf8ca2094e2d3704", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/8c2c64321c51291b92ed4f5faf8ca2094e2d3704", "committedDate": "2020-08-21T07:45:05Z", "message": "HBASE-24391 Implement meta split"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8c2c64321c51291b92ed4f5faf8ca2094e2d3704", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/8c2c64321c51291b92ed4f5faf8ca2094e2d3704", "committedDate": "2020-08-21T07:45:05Z", "message": "HBASE-24391 Implement meta split"}, "afterCommit": {"oid": "9acc17c5e4541d709e3e69ba93fc416862af1cf6", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/9acc17c5e4541d709e3e69ba93fc416862af1cf6", "committedDate": "2020-08-25T15:04:02Z", "message": "HBASE-24391 Implement meta split"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9acc17c5e4541d709e3e69ba93fc416862af1cf6", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/9acc17c5e4541d709e3e69ba93fc416862af1cf6", "committedDate": "2020-08-25T15:04:02Z", "message": "HBASE-24391 Implement meta split"}, "afterCommit": {"oid": "ee9014eb099cc7fdc7df8beca72667891cf10602", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/ee9014eb099cc7fdc7df8beca72667891cf10602", "committedDate": "2020-08-26T06:38:01Z", "message": "HBASE-24391 Implement meta split"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ee9014eb099cc7fdc7df8beca72667891cf10602", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/ee9014eb099cc7fdc7df8beca72667891cf10602", "committedDate": "2020-08-26T06:38:01Z", "message": "HBASE-24391 Implement meta split"}, "afterCommit": {"oid": "d95e490eba4f78d8f7caaf816a249c5a67d198e6", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/d95e490eba4f78d8f7caaf816a249c5a67d198e6", "committedDate": "2020-08-26T09:24:03Z", "message": "HBASE-24391 Implement meta split"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24ba213fd9d6b9c3b8928f69600c3e591814ec9b", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/24ba213fd9d6b9c3b8928f69600c3e591814ec9b", "committedDate": "2020-09-05T05:58:14Z", "message": "HBASE-24391 Implement meta split"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d95e490eba4f78d8f7caaf816a249c5a67d198e6", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/d95e490eba4f78d8f7caaf816a249c5a67d198e6", "committedDate": "2020-08-26T09:24:03Z", "message": "HBASE-24391 Implement meta split"}, "afterCommit": {"oid": "24ba213fd9d6b9c3b8928f69600c3e591814ec9b", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/24ba213fd9d6b9c3b8928f69600c3e591814ec9b", "committedDate": "2020-09-05T05:58:14Z", "message": "HBASE-24391 Implement meta split"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7c3d9d874e63f823ffe08b62608f00d03193139", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/b7c3d9d874e63f823ffe08b62608f00d03193139", "committedDate": "2020-09-05T11:51:47Z", "message": "fix TestShutdownOfMetaReplicaHolder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMTQ2Mjkz", "url": "https://github.com/apache/hbase/pull/2010#pullrequestreview-483146293", "createdAt": "2020-09-06T14:07:14Z", "commit": {"oid": "b7c3d9d874e63f823ffe08b62608f00d03193139"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNlQxNDowNzoxNFrOHNpkDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNlQxNDowNzoxNFrOHNpkDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA3NDUwOA==", "bodyText": "Why don't need comparator previously? Don't use this to scan meta previously?", "url": "https://github.com/apache/hbase/pull/2010#discussion_r484074508", "createdAt": "2020-09-06T14:07:14Z", "author": {"login": "infraio"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/AsyncScanSingleRegionRpcRetryingCaller.java", "diffHunk": "@@ -442,6 +449,32 @@ private void updateNextStartRowWhenError(Result result) {\n     includeNextStartRowWhenError = result.mayHaveMoreCellsInRow();\n   }\n \n+  private boolean noMoreResultsForScan(Scan scan, RegionInfo info) {\n+    if (isEmptyStopRow(info.getEndKey())) {\n+      return true;\n+    }\n+    if (isEmptyStopRow(scan.getStopRow())) {\n+      return false;\n+    }\n+    int c = comparator.compare(info.getEndKey(), scan.getStopRow());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7c3d9d874e63f823ffe08b62608f00d03193139"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMTQ3MzIy", "url": "https://github.com/apache/hbase/pull/2010#pullrequestreview-483147322", "createdAt": "2020-09-06T14:20:27Z", "commit": {"oid": "b7c3d9d874e63f823ffe08b62608f00d03193139"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNlQxNDoyMDoyN1rOHNpptA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNlQxNDoyMDoyN1rOHNpptA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA3NTk1Ng==", "bodyText": "Add some log here?", "url": "https://github.com/apache/hbase/pull/2010#discussion_r484075956", "createdAt": "2020-09-06T14:20:27Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/RegionStateStore.java", "diffHunk": "@@ -250,15 +255,62 @@ private long getOpenSeqNumForParentRegion(RegionInfo region) throws IOException\n   // ============================================================================================\n   //  Update Region Splitting State helpers\n   // ============================================================================================\n-  public void splitRegion(RegionInfo parent, RegionInfo hriA, RegionInfo hriB,\n-      ServerName serverName) throws IOException {\n-    TableDescriptor htd = getDescriptor(parent.getTable());\n+  /**\n+   * Splits the region into two in an atomic operation. Offlines the parent region with the\n+   * information that it is split into two, and also adds the daughter regions. Does not add the\n+   * location information to the daughter regions since they are not open yet.\n+   */\n+  public void splitRegion(RegionInfo parent, RegionInfo splitA, RegionInfo splitB,\n+    ServerName serverName, TableDescriptor htd) throws IOException {\n     long parentOpenSeqNum = HConstants.NO_SEQNUM;\n     if (htd.hasGlobalReplicationScope()) {\n       parentOpenSeqNum = getOpenSeqNumForParentRegion(parent);\n     }\n-    MetaTableAccessor.splitRegion(master.getConnection(), parent, parentOpenSeqNum, hriA, hriB,\n-      serverName, getRegionReplication(htd));\n+    long time = EnvironmentEdgeManager.currentTime();\n+    // Put for parent\n+    Put putParent = MetaTableAccessor.makePutFromRegionInfo(\n+      RegionInfoBuilder.newBuilder(parent).setOffline(true).setSplit(true).build(), time);\n+    MetaTableAccessor.addDaughtersToPut(putParent, splitA, splitB);\n+\n+    // Puts for daughters\n+    Put putA = MetaTableAccessor.makePutFromRegionInfo(splitA, time);\n+    Put putB = MetaTableAccessor.makePutFromRegionInfo(splitB, time);\n+    if (parentOpenSeqNum > 0) {\n+      MetaTableAccessor.addReplicationBarrier(putParent, parentOpenSeqNum);\n+      MetaTableAccessor.addReplicationParent(putA, Collections.singletonList(parent));\n+      MetaTableAccessor.addReplicationParent(putB, Collections.singletonList(parent));\n+    }\n+    // Set initial state to CLOSED\n+    // NOTE: If initial state is not set to CLOSED then daughter regions get added with the\n+    // default OFFLINE state. If Master gets restarted after this step, start up sequence of\n+    // master tries to assign these offline regions. This is followed by re-assignments of the\n+    // daughter regions from resumed {@link SplitTableRegionProcedure}\n+    MetaTableAccessor.addRegionStateToPut(putA, RegionState.State.CLOSED);\n+    MetaTableAccessor.addRegionStateToPut(putB, RegionState.State.CLOSED);\n+\n+    // new regions, openSeqNum = 1 is fine.\n+    MetaTableAccessor.addSequenceNum(putA, 1, splitA.getReplicaId());\n+    MetaTableAccessor.addSequenceNum(putB, 1, splitB.getReplicaId());\n+\n+    // Add empty locations for region replicas of daughters so that number of replicas can be\n+    // cached whenever the primary region is looked up from meta\n+    int regionReplication = getRegionReplication(htd);\n+    for (int i = 1; i < regionReplication; i++) {\n+      MetaTableAccessor.addEmptyLocation(putA, i);\n+      MetaTableAccessor.addEmptyLocation(putB, i);\n+    }\n+\n+    List<Mutation> mutations = Arrays.asList(putParent, putA, putB);\n+    if (htd.isMetaTable()) {\n+      masterRegion.update(region -> {\n+        List<byte[]> rowsToLock =\n+          mutations.stream().map(Mutation::getRow).collect(Collectors.toList());\n+        region.mutateRowsWithLocks(mutations, rowsToLock, HConstants.NO_NONCE, HConstants.NO_NONCE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7c3d9d874e63f823ffe08b62608f00d03193139"}, "originalPosition": 89}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMTQ4MDM4", "url": "https://github.com/apache/hbase/pull/2010#pullrequestreview-483148038", "createdAt": "2020-09-06T14:29:10Z", "commit": {"oid": "b7c3d9d874e63f823ffe08b62608f00d03193139"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNlQxNDoyOToxMFrOHNptWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNlQxNDoyOToxMFrOHNptWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA3Njg5MA==", "bodyText": "Good idea.", "url": "https://github.com/apache/hbase/pull/2010#discussion_r484076890", "createdAt": "2020-09-06T14:29:10Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/MetaRegionSplitPolicy.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.regionserver;\n+\n+import org.apache.hadoop.hbase.HConstants;\n+import org.apache.hadoop.hbase.util.Bytes;\n+import org.apache.yetus.audience.InterfaceAudience;\n+\n+/**\n+ * The split policy for meta.\n+ * <p/>\n+ * Now we just use {@link DelimitedKeyPrefixRegionSplitPolicy} with\n+ * {@value org.apache.hadoop.hbase.HConstants#DELIMITER}, which means all the records for a table\n+ * will be in the same region, so the multi-mutate operation when splitting/merging is still valid.\n+ */\n+@InterfaceAudience.Private\n+public class MetaRegionSplitPolicy extends DelimitedKeyPrefixRegionSplitPolicy {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b7c3d9d874e63f823ffe08b62608f00d03193139"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMjA2NDg5", "url": "https://github.com/apache/hbase/pull/2010#pullrequestreview-483206489", "createdAt": "2020-09-07T02:20:08Z", "commit": {"oid": "b7c3d9d874e63f823ffe08b62608f00d03193139"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4464, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}