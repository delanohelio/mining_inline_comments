{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3MDYyNTI3", "number": 1841, "title": "HBASE-24208 Remove RS entry from zk draining servers node after RS been stopped", "bodyText": "removed RS entry from zk draining server znode on RS stopped", "createdAt": "2020-06-03T08:59:49Z", "url": "https://github.com/apache/hbase/pull/1841", "merged": true, "mergeCommit": {"oid": "920d60f43b3adfca3ce2d3068af4c8656831b481"}, "closed": true, "closedAt": "2020-06-08T17:17:01Z", "author": {"login": "gkanade"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnqS2kAFqTQyMzYwMzA0MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpMSOugBqjM0MTg4NTY3MjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzNjAzMDQx", "url": "https://github.com/apache/hbase/pull/1841#pullrequestreview-423603041", "createdAt": "2020-06-03T14:20:16Z", "commit": {"oid": "476400374e804eee2a4fb4c6b0f3b285fecde1f7"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNDoyMDoxN1rOGeeJ0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNDoyMzo1OVrOGeeVIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYwNDQ5OA==", "bodyText": "LOG.warn(\"Error deleting the znode for draining server {}\", serverName.getServerName(), e) providing stacktrace will be better?", "url": "https://github.com/apache/hbase/pull/1841#discussion_r434604498", "createdAt": "2020-06-03T14:20:17Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java", "diffHunk": "@@ -586,6 +588,15 @@ synchronized long expireServer(final ServerName serverName, boolean force) {\n     }\n     moveFromOnlineToDeadServers(serverName);\n \n+    // If server is in draining mode, remove corresponding znode\n+    String drainingZnode = ZNodePaths.joinZNode(zkw.getZNodePaths().drainingZNode,\n+      serverName.getServerName());\n+    try {\n+      ZKUtil.deleteNodeFailSilent(zkw, drainingZnode);\n+    } catch (KeeperException e) {\n+      LOG.warn(\"Error deleting the znode for draining server \" + drainingZnode);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "476400374e804eee2a4fb4c6b0f3b285fecde1f7"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYwNTAyMA==", "bodyText": "MediumTests should be good here.", "url": "https://github.com/apache/hbase/pull/1841#discussion_r434605020", "createdAt": "2020-06-03T14:20:58Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.client;\n+\n+import static org.apache.hadoop.hbase.util.Threads.sleep;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.ArrayList;\n+import java.util.EnumSet;\n+import java.util.List;\n+import org.apache.hadoop.hbase.ClusterMetrics;\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.HBaseTestingUtility;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.testclassification.ClientTests;\n+import org.apache.hadoop.hbase.testclassification.LargeTests;\n+import org.junit.Before;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Category({ LargeTests.class, ClientTests.class })", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "476400374e804eee2a4fb4c6b0f3b285fecde1f7"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYwNzM5Mw==", "bodyText": "We can include this inline directly on L591: ZNodePaths.joinZNode(master.getZooKeeper().getZNodePaths().drainingZNode....\nBecause for below 2 return statements, this just turns out to be redundant statement.", "url": "https://github.com/apache/hbase/pull/1841#discussion_r434607393", "createdAt": "2020-06-03T14:23:59Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java", "diffHunk": "@@ -573,6 +574,7 @@ public synchronized long expireServer(final ServerName serverName) {\n   }\n \n   synchronized long expireServer(final ServerName serverName, boolean force) {\n+    ZKWatcher zkw = master.getZooKeeper();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "476400374e804eee2a4fb4c6b0f3b285fecde1f7"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MTUwMzI5", "url": "https://github.com/apache/hbase/pull/1841#pullrequestreview-424150329", "createdAt": "2020-06-04T06:55:20Z", "commit": {"oid": "e523a13c48701c862ed04a0ede28f256a49c4dc6"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwNjo1NToyMVrOGe4LMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwNzowNzowN1rOGe4hEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzMDgzMg==", "bodyText": "The line is exceeding 100 chars. Not sure why build didn't catch this as checkstyle issue. Anyways, you can bring it to 2 lines.", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435030832", "createdAt": "2020-06-04T06:55:21Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.client;\n+\n+import static org.apache.hadoop.hbase.util.Threads.sleep;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.ArrayList;\n+import java.util.EnumSet;\n+import java.util.List;\n+import org.apache.hadoop.hbase.ClusterMetrics;\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.HBaseTestingUtility;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.testclassification.ClientTests;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.junit.Before;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Category({ MediumTests.class, ClientTests.class })\n+public class TestDecommissionStopAdminApi extends TestAdminBase{\n+  @ClassRule\n+  public static final HBaseClassTestRule CLASS_RULE = HBaseClassTestRule.forClass(TestDecommissionStopAdminApi.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e523a13c48701c862ed04a0ede28f256a49c4dc6"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzMDk5Ng==", "bodyText": "Can be removed", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435030996", "createdAt": "2020-06-04T06:55:43Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.client;\n+\n+import static org.apache.hadoop.hbase.util.Threads.sleep;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.ArrayList;\n+import java.util.EnumSet;\n+import java.util.List;\n+import org.apache.hadoop.hbase.ClusterMetrics;\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.HBaseTestingUtility;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.testclassification.ClientTests;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.junit.Before;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Category({ MediumTests.class, ClientTests.class })\n+public class TestDecommissionStopAdminApi extends TestAdminBase{\n+  @ClassRule\n+  public static final HBaseClassTestRule CLASS_RULE = HBaseClassTestRule.forClass(TestDecommissionStopAdminApi.class);\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(TestDecommissionStopAdminApi.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e523a13c48701c862ed04a0ede28f256a49c4dc6"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzMjQyNA==", "bodyText": "Instead of relying on sleep (which usually results in flaky tests, works maybe 90% times, and 10% remains flaky), we can use Waiter.wait():\nSomething like this maybe:\n    assertNotEquals(\"Error message...xyz...\", -1,\n      TEST_UTIL.waitFor(1000, () -> ADMIN.listDecommissionedRegionServers().isEmpty()));\n\nBasically Waiter keeps executing the code until it has successfully returned true from the Predicate. If it can't even after timeout, it will return -1.", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435032424", "createdAt": "2020-06-04T06:58:39Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.client;\n+\n+import static org.apache.hadoop.hbase.util.Threads.sleep;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.ArrayList;\n+import java.util.EnumSet;\n+import java.util.List;\n+import org.apache.hadoop.hbase.ClusterMetrics;\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.HBaseTestingUtility;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.testclassification.ClientTests;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.junit.Before;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Category({ MediumTests.class, ClientTests.class })\n+public class TestDecommissionStopAdminApi extends TestAdminBase{\n+  @ClassRule\n+  public static final HBaseClassTestRule CLASS_RULE = HBaseClassTestRule.forClass(TestDecommissionStopAdminApi.class);\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(TestDecommissionStopAdminApi.class);\n+\n+  // For HBASE-24208\n+  @Test\n+  public void testDecommissionAndStopRegionServers() throws Exception {\n+    List<ServerName> decommissionedRegionServers = ADMIN.listDecommissionedRegionServers();\n+    assertTrue(decommissionedRegionServers.isEmpty());\n+\n+    ArrayList<ServerName> clusterRegionServers =\n+      new ArrayList<>(ADMIN.getClusterMetrics(EnumSet.of(ClusterMetrics.Option.LIVE_SERVERS))\n+        .getLiveServerMetrics().keySet());\n+\n+    List<ServerName> serversToDecommission = new ArrayList<ServerName>();\n+    serversToDecommission.add(clusterRegionServers.get(0));\n+\n+    // Decommission\n+    ADMIN.decommissionRegionServers(serversToDecommission, true);\n+    assertEquals(1, ADMIN.listDecommissionedRegionServers().size());\n+\n+    // Stop decommissioned region server and verify it is removed from draining znode\n+    ServerName serverName = serversToDecommission.get(0);\n+    ADMIN.stopRegionServer(serverName.getHostname()+\":\"+serverName.getPort());\n+    sleep(1000);\n+    assertTrue(ADMIN.listDecommissionedRegionServers().isEmpty());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e523a13c48701c862ed04a0ede28f256a49c4dc6"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzNTM1Ng==", "bodyText": "Btw, we can put testDecommissionAndStopRegionServers() in TestAdmin2 or TestAdmin3. They are already LargeTests and have good no of Admin tests. However, keeping this test in separate file is also good. Maybe we can rename this class to TestAdmin4? This way, new Admin tests can be written in this class going forward.", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435035356", "createdAt": "2020-06-04T07:04:42Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.client;\n+\n+import static org.apache.hadoop.hbase.util.Threads.sleep;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.ArrayList;\n+import java.util.EnumSet;\n+import java.util.List;\n+import org.apache.hadoop.hbase.ClusterMetrics;\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.HBaseTestingUtility;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.testclassification.ClientTests;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.junit.Before;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Category({ MediumTests.class, ClientTests.class })\n+public class TestDecommissionStopAdminApi extends TestAdminBase{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e523a13c48701c862ed04a0ede28f256a49c4dc6"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTAzNjQzMw==", "bodyText": "Before, TableName and HBaseTestingUtility are unused imports.", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435036433", "createdAt": "2020-06-04T07:07:07Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestDecommissionStopAdminApi.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.client;\n+\n+import static org.apache.hadoop.hbase.util.Threads.sleep;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.util.ArrayList;\n+import java.util.EnumSet;\n+import java.util.List;\n+import org.apache.hadoop.hbase.ClusterMetrics;\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.HBaseTestingUtility;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.TableName;\n+import org.apache.hadoop.hbase.testclassification.ClientTests;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.junit.Before;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e523a13c48701c862ed04a0ede28f256a49c4dc6"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0Njk2MjQy", "url": "https://github.com/apache/hbase/pull/1841#pullrequestreview-424696242", "createdAt": "2020-06-04T18:00:11Z", "commit": {"oid": "6b18c796d67244b2747d8c6998b639fa02d85a6b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxODowMDoxMVrOGfRg1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxODowMDoxMVrOGfRg1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQ0NTk3NA==", "bodyText": "The build is failing:\n[ERROR] /home/jenkins/jenkins-slave/workspace/Base-PreCommit-GitHub-PR_PR-1841@2/yetus-jdk11-hadoop3-check/src/hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java:[63,16] no suitable method found for waitFor(int,boolean)\n\nOh, seems like lambda expression is missing:\n    assertNotEquals(\"RS not removed from decommissioned list\", -1,\n      TEST_UTIL.waitFor(1000, () -> ADMIN.listDecommissionedRegionServers().isEmpty()));", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435445974", "createdAt": "2020-06-04T18:00:11Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.client;\n+\n+import static org.junit.Assert.*;\n+\n+import java.util.ArrayList;\n+import java.util.EnumSet;\n+import java.util.List;\n+import org.apache.hadoop.hbase.ClusterMetrics;\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.testclassification.ClientTests;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Category({ MediumTests.class, ClientTests.class })\n+public class TestAdmin4 extends TestAdminBase{\n+  @ClassRule\n+  public static final HBaseClassTestRule CLASS_RULE =\n+    HBaseClassTestRule.forClass(TestAdmin4.class);\n+\n+  // For HBASE-24208\n+  @Test\n+  public void testDecommissionAndStopRegionServers() throws Exception {\n+    List<ServerName> decommissionedRegionServers = ADMIN.listDecommissionedRegionServers();\n+    assertTrue(decommissionedRegionServers.isEmpty());\n+\n+    ArrayList<ServerName> clusterRegionServers =\n+      new ArrayList<>(ADMIN.getClusterMetrics(EnumSet.of(ClusterMetrics.Option.LIVE_SERVERS))\n+        .getLiveServerMetrics().keySet());\n+\n+    List<ServerName> serversToDecommission = new ArrayList<ServerName>();\n+    serversToDecommission.add(clusterRegionServers.get(0));\n+\n+    // Decommission\n+    ADMIN.decommissionRegionServers(serversToDecommission, true);\n+    assertEquals(1, ADMIN.listDecommissionedRegionServers().size());\n+\n+    // Stop decommissioned region server and verify it is removed from draining znode\n+    ServerName serverName = serversToDecommission.get(0);\n+    ADMIN.stopRegionServer(serverName.getHostname()+\":\"+serverName.getPort());\n+    assertNotEquals(\"RS not removed from decommissioned list\", -1,\n+      TEST_UTIL.waitFor(1000, ADMIN.listDecommissionedRegionServers().isEmpty()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b18c796d67244b2747d8c6998b639fa02d85a6b"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MjU1ODI1", "url": "https://github.com/apache/hbase/pull/1841#pullrequestreview-425255825", "createdAt": "2020-06-05T12:31:23Z", "commit": {"oid": "03b18066e88c329accb7477470bac131d0276701"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MzU0OTIz", "url": "https://github.com/apache/hbase/pull/1841#pullrequestreview-425354923", "createdAt": "2020-06-05T14:31:20Z", "commit": {"oid": "03b18066e88c329accb7477470bac131d0276701"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNDozMToyMVrOGfw-yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNDo0MDoxMFrOGfxUeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk2MTU0Ng==", "bodyText": "Can u change the log to say \"Error deleting the draining znode for stopping server \"+ serverName", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435961546", "createdAt": "2020-06-05T14:31:21Z", "author": {"login": "anoopsjohn"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java", "diffHunk": "@@ -586,6 +587,15 @@ synchronized long expireServer(final ServerName serverName, boolean force) {\n     }\n     moveFromOnlineToDeadServers(serverName);\n \n+    // If server is in draining mode, remove corresponding znode\n+    String drainingZnode = ZNodePaths.joinZNode(master.getZooKeeper().getZNodePaths().drainingZNode,\n+      serverName.getServerName());\n+    try {\n+      ZKUtil.deleteNodeFailSilent(master.getZooKeeper(), drainingZnode);\n+    } catch (KeeperException e) {\n+      LOG.warn(\"Error deleting the znode for draining server \" +  serverName.getServerName(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03b18066e88c329accb7477470bac131d0276701"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk2NTI5MA==", "bodyText": "Cant we use Admin#getRegionServers(boolean excludeDecommissionedRS) API directly here?", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435965290", "createdAt": "2020-06-05T14:37:23Z", "author": {"login": "anoopsjohn"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.client;\n+\n+import static org.junit.Assert.*;\n+\n+import java.util.ArrayList;\n+import java.util.EnumSet;\n+import java.util.List;\n+import org.apache.hadoop.hbase.ClusterMetrics;\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.testclassification.ClientTests;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Category({ MediumTests.class, ClientTests.class })\n+public class TestAdmin4 extends TestAdminBase{\n+  @ClassRule\n+  public static final HBaseClassTestRule CLASS_RULE =\n+    HBaseClassTestRule.forClass(TestAdmin4.class);\n+\n+  // For HBASE-24208\n+  @Test\n+  public void testDecommissionAndStopRegionServers() throws Exception {\n+    List<ServerName> decommissionedRegionServers = ADMIN.listDecommissionedRegionServers();\n+    assertTrue(decommissionedRegionServers.isEmpty());\n+\n+    ArrayList<ServerName> clusterRegionServers =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03b18066e88c329accb7477470bac131d0276701"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk2NzA5OA==", "bodyText": "This asserts only the decommissionedRSs list maintained in the HM side.  Pls add assert with checking the zk path also. We need to make sure the stop call actually deleted that zk path also.", "url": "https://github.com/apache/hbase/pull/1841#discussion_r435967098", "createdAt": "2020-06-05T14:40:10Z", "author": {"login": "anoopsjohn"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin4.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/**\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hbase.client;\n+\n+import static org.junit.Assert.*;\n+\n+import java.util.ArrayList;\n+import java.util.EnumSet;\n+import java.util.List;\n+import org.apache.hadoop.hbase.ClusterMetrics;\n+import org.apache.hadoop.hbase.HBaseClassTestRule;\n+import org.apache.hadoop.hbase.ServerName;\n+import org.apache.hadoop.hbase.testclassification.ClientTests;\n+import org.apache.hadoop.hbase.testclassification.MediumTests;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@Category({ MediumTests.class, ClientTests.class })\n+public class TestAdmin4 extends TestAdminBase{\n+  @ClassRule\n+  public static final HBaseClassTestRule CLASS_RULE =\n+    HBaseClassTestRule.forClass(TestAdmin4.class);\n+\n+  // For HBASE-24208\n+  @Test\n+  public void testDecommissionAndStopRegionServers() throws Exception {\n+    List<ServerName> decommissionedRegionServers = ADMIN.listDecommissionedRegionServers();\n+    assertTrue(decommissionedRegionServers.isEmpty());\n+\n+    ArrayList<ServerName> clusterRegionServers =\n+      new ArrayList<>(ADMIN.getClusterMetrics(EnumSet.of(ClusterMetrics.Option.LIVE_SERVERS))\n+        .getLiveServerMetrics().keySet());\n+\n+    List<ServerName> serversToDecommission = new ArrayList<ServerName>();\n+    serversToDecommission.add(clusterRegionServers.get(0));\n+\n+    // Decommission\n+    ADMIN.decommissionRegionServers(serversToDecommission, true);\n+    assertEquals(1, ADMIN.listDecommissionedRegionServers().size());\n+\n+    // Stop decommissioned region server and verify it is removed from draining znode\n+    ServerName serverName = serversToDecommission.get(0);\n+    ADMIN.stopRegionServer(serverName.getHostname()+\":\"+serverName.getPort());\n+    assertNotEquals(\"RS not removed from decommissioned list\", -1,\n+      TEST_UTIL.waitFor(1000, () -> ADMIN.listDecommissionedRegionServers().isEmpty()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03b18066e88c329accb7477470bac131d0276701"}, "originalPosition": 63}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "80e15a62bc2539c8fa97e5158ae288f50c8e9c02", "author": {"user": {"login": "gkanade", "name": null}}, "url": "https://github.com/apache/hbase/commit/80e15a62bc2539c8fa97e5158ae288f50c8e9c02", "committedDate": "2020-06-06T14:28:18Z", "message": "increased wait time to 10s"}, "afterCommit": {"oid": "46531e9f9b4dd0840408eb1cbbc828ee1cb7c6c3", "author": {"user": {"login": "gkanade", "name": null}}, "url": "https://github.com/apache/hbase/commit/46531e9f9b4dd0840408eb1cbbc828ee1cb7c6c3", "committedDate": "2020-06-06T14:37:00Z", "message": "Addressed PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NzUyODY2", "url": "https://github.com/apache/hbase/pull/1841#pullrequestreview-425752866", "createdAt": "2020-06-06T16:42:54Z", "commit": {"oid": "46531e9f9b4dd0840408eb1cbbc828ee1cb7c6c3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d2b50fda266d1edc1ccfb21ac4f95c03ede754a", "author": {"user": {"login": "gkanade", "name": null}}, "url": "https://github.com/apache/hbase/commit/0d2b50fda266d1edc1ccfb21ac4f95c03ede754a", "committedDate": "2020-06-08T06:34:00Z", "message": "spacing"}, "afterCommit": {"oid": "09f2d9b961b886be198091d5e3a72b44b009c197", "author": {"user": {"login": "gkanade", "name": null}}, "url": "https://github.com/apache/hbase/commit/09f2d9b961b886be198091d5e3a72b44b009c197", "committedDate": "2020-06-08T06:34:45Z", "message": "remove draining server znode if present"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6176450df448adcd6901ded10294bc4fed12064b", "author": {"user": {"login": "gkanade", "name": null}}, "url": "https://github.com/apache/hbase/commit/6176450df448adcd6901ded10294bc4fed12064b", "committedDate": "2020-06-08T08:35:22Z", "message": "remove draining server znode if present"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1853ef47ad3e6c78bcae110721222482e527f494", "author": {"user": {"login": "gkanade", "name": null}}, "url": "https://github.com/apache/hbase/commit/1853ef47ad3e6c78bcae110721222482e527f494", "committedDate": "2020-06-08T08:33:44Z", "message": "spacing"}, "afterCommit": {"oid": "6176450df448adcd6901ded10294bc4fed12064b", "author": {"user": {"login": "gkanade", "name": null}}, "url": "https://github.com/apache/hbase/commit/6176450df448adcd6901ded10294bc4fed12064b", "committedDate": "2020-06-08T08:35:22Z", "message": "remove draining server znode if present"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4516, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}