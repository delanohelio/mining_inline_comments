{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4MjQwMDU0", "number": 2057, "title": "HBASE-24720: Meta replicas not cleaned when disabled", "bodyText": "make sure to always clean up excess meta replicas not just when their number get decreased\nmake sure NotServingRegionException is handled properly even when wrapped\nadd test", "createdAt": "2020-07-13T13:00:40Z", "url": "https://github.com/apache/hbase/pull/2057", "merged": true, "mergeCommit": {"oid": "3e709c6f53c9dfbf2a8ef469bb78a1dc1444fcf9"}, "closed": true, "closedAt": "2020-07-14T16:24:56Z", "author": {"login": "BukrosSzabolcs"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwqrOCAH2gAyNDQ4MjQwMDU0OjFiYWYzYWQ0NGU0NzlmMWU5YmI0NmE1NjYxZjE3N2EzMzJlZmMzMGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc03P2TAFqTQ0ODE4NDAzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1baf3ad44e479f1e9bb46a5661f177a332efc30b", "author": {"user": {"login": "BukrosSzabolcs", "name": null}}, "url": "https://github.com/apache/hbase/commit/1baf3ad44e479f1e9bb46a5661f177a332efc30b", "committedDate": "2020-07-01T13:57:40Z", "message": "clean up after disabling meta replcation\n\n- make sure to always clean up excess meta replicas not just when their\nnumber get decreased\n- make sure NotServingRegionException is handled properly even when\nwrapped\n- add test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MzQ5ODA1", "url": "https://github.com/apache/hbase/pull/2057#pullrequestreview-447349805", "createdAt": "2020-07-13T15:18:09Z", "commit": {"oid": "1baf3ad44e479f1e9bb46a5661f177a332efc30b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MzcyMzEy", "url": "https://github.com/apache/hbase/pull/2057#pullrequestreview-447372312", "createdAt": "2020-07-13T15:42:33Z", "commit": {"oid": "1baf3ad44e479f1e9bb46a5661f177a332efc30b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNTo0MjozM1rOGwucZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNTo0MjozM1rOGwucZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc0NTc2Ng==", "bodyText": "This change is related to this PR?", "url": "https://github.com/apache/hbase/pull/2057#discussion_r453745766", "createdAt": "2020-07-13T15:42:33Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java", "diffHunk": "@@ -715,7 +716,10 @@ public static void closeRegionSilentlyAndWait(AsyncClusterConnection connection,\n           return;\n         }\n       } catch (IOException ioe) {\n-        if (ioe instanceof NotServingRegionException) {\n+        if (ioe instanceof NotServingRegionException ||\n+          (ioe instanceof RemoteWithExtrasException &&\n+            ((RemoteWithExtrasException)ioe).unwrapRemoteException()\n+              instanceof NotServingRegionException)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1baf3ad44e479f1e9bb46a5661f177a332efc30b"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NDU3OTE3", "url": "https://github.com/apache/hbase/pull/2057#pullrequestreview-447457917", "createdAt": "2020-07-13T17:32:48Z", "commit": {"oid": "1baf3ad44e479f1e9bb46a5661f177a332efc30b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNzozMjo0OFrOGwypjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNzozMjo1OFrOGwyp7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgxNDY2OA==", "bodyText": "The parameter order for assertEquals should be switched.", "url": "https://github.com/apache/hbase/pull/2057#discussion_r453814668", "createdAt": "2020-07-13T17:32:48Z", "author": {"login": "petersomogyi"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestMetaWithReplicasBasic.java", "diffHunk": "@@ -80,6 +83,27 @@ public void testZookeeperNodesForReplicas() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testReplicaCleanup() throws Exception {\n+    ZKWatcher zkw = TEST_UTIL.getZooKeeperWatcher();\n+    List<String> metaReplicaZnodes = zkw.getMetaReplicaNodes();\n+    assertEquals(metaReplicaZnodes.size(), 3);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1baf3ad44e479f1e9bb46a5661f177a332efc30b"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgxNDc2Nw==", "bodyText": "The parameter order for assertEquals should be switched.", "url": "https://github.com/apache/hbase/pull/2057#discussion_r453814767", "createdAt": "2020-07-13T17:32:58Z", "author": {"login": "petersomogyi"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestMetaWithReplicasBasic.java", "diffHunk": "@@ -80,6 +83,27 @@ public void testZookeeperNodesForReplicas() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testReplicaCleanup() throws Exception {\n+    ZKWatcher zkw = TEST_UTIL.getZooKeeperWatcher();\n+    List<String> metaReplicaZnodes = zkw.getMetaReplicaNodes();\n+    assertEquals(metaReplicaZnodes.size(), 3);\n+\n+    final HMaster master = TEST_UTIL.getMiniHBaseCluster().getMaster();\n+    master.stop(\"Restarting\");\n+    TEST_UTIL.waitFor(30000, () -> master.isStopped());\n+    TEST_UTIL.getMiniHBaseCluster().getConfiguration().setInt(HConstants.META_REPLICAS_NUM, 1);\n+\n+    JVMClusterUtil.MasterThread newMasterThread = TEST_UTIL.getMiniHBaseCluster().startMaster();\n+    final HMaster newMaster = newMasterThread.getMaster();\n+\n+    //wait until new master finished meta replica assignment logic\n+    TEST_UTIL.waitFor(30000, () -> newMaster.getMasterQuotaManager() != null);\n+    zkw = TEST_UTIL.getZooKeeperWatcher();\n+    metaReplicaZnodes = zkw.getMetaReplicaNodes();\n+    assertEquals(metaReplicaZnodes.size(), 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1baf3ad44e479f1e9bb46a5661f177a332efc30b"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ffa272b333d995095f548eed841be5363af9138", "author": {"user": {"login": "BukrosSzabolcs", "name": null}}, "url": "https://github.com/apache/hbase/commit/6ffa272b333d995095f548eed841be5363af9138", "committedDate": "2020-07-14T12:15:29Z", "message": "HBASE-24720: Meta replicas not cleaned when disabled\n\ncheckstyle\nfix assertEquals param order"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MTg0MDMz", "url": "https://github.com/apache/hbase/pull/2057#pullrequestreview-448184033", "createdAt": "2020-07-14T14:52:14Z", "commit": {"oid": "6ffa272b333d995095f548eed841be5363af9138"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4256, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}