{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxODIzMjA5", "number": 1761, "title": "HBASE-21406 \"status 'replication'\" should not show SINK if the cluste\u2026", "bodyText": "\u2026r does not act as sink", "createdAt": "2020-05-22T09:44:32Z", "url": "https://github.com/apache/hbase/pull/1761", "merged": true, "mergeCommit": {"oid": "e5345b3a7c32c6a80394319c17540b84c8fe66ba"}, "closed": true, "closedAt": "2020-06-02T08:27:17Z", "author": {"login": "wchevreuil"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjvACwgH2gAyNDIxODIzMjA5OjU0NDQ0Yzc2Y2ZlMTc2Y2I1MTg0NGFkODQ1MWM3OGZmOTc4MDUzNDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnEwS5AFqTQyMjA4OTEyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "54444c76cfe176cb51844ad8451c78ff97805341", "author": {"user": {"login": "wchevreuil", "name": "Wellington Ramos Chevreuil"}}, "url": "https://github.com/apache/hbase/commit/54444c76cfe176cb51844ad8451c78ff97805341", "committedDate": "2020-05-22T09:39:01Z", "message": "HBASE-21406 \"status 'replication'\" should not show SINK if the cluster does not act as sink"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2ODU4MDUy", "url": "https://github.com/apache/hbase/pull/1761#pullrequestreview-416858052", "createdAt": "2020-05-22T12:03:29Z", "commit": {"oid": "54444c76cfe176cb51844ad8451c78ff97805341"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxMjowMzoyOVrOGZUtHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxMjoxODo1NlrOGZVFsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTIwNjgxNQ==", "bodyText": "Although 10s seems more than enough time, we can use Waiter.wait() / HBASE_TESTING_UTILITY.waitFor() with predicate to check if loadSink.getTimestampsOfLastAppliedOp()>loadSink.getTimestampStarted().", "url": "https://github.com/apache/hbase/pull/1761#discussion_r429206815", "createdAt": "2020-05-22T12:03:29Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/replication/TestReplicationStatus.java", "diffHunk": "@@ -120,6 +124,28 @@ public void testReplicationStatus() throws Exception {\n     assertEquals(PEER_ID2, rLoadSourceList.get(0).getPeerID());\n   }\n \n+  @Test\n+  public void testReplicationStatusSink() throws Exception {\n+    try (Admin hbaseAdmin = UTIL2.getConnection().getAdmin()) {\n+      ServerName server = UTIL2.getHBaseCluster().getRegionServer(0).getServerName();\n+      ReplicationLoadSink loadSink = getLatestSinkMetric(hbaseAdmin, server);\n+      //First checks if status of timestamp of last applied op is same as RS start, since no edits\n+      //were replicated yet\n+      assertEquals(loadSink.getTimestampStarted(), loadSink.getTimestampsOfLastAppliedOp());\n+      //now insert some rows on source, so that it gets delivered to target\n+      insertRowsOnSource();\n+      Thread.sleep(10000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54444c76cfe176cb51844ad8451c78ff97805341"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTIxMzEwNA==", "bodyText": "nit: Gets the total number of OPs delivered to this sink would be better? WDYT?", "url": "https://github.com/apache/hbase/pull/1761#discussion_r429213104", "createdAt": "2020-05-22T12:18:56Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/MetricsSink.java", "diffHunk": "@@ -98,4 +99,21 @@ public long getAgeOfLastAppliedOp() {\n   public long getTimestampOfLastAppliedOp() {\n     return this.lastTimestampForAge;\n   }\n+\n+  /**\n+   * Gets the time stamp from when the Sink was initialized.\n+   * @return startTimestamp\n+   */\n+  public long getStartTimestamp() {\n+    return startTimestamp;\n+  }\n+\n+  /**\n+   * Gets the total number of OPs delivered to target by this sink.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54444c76cfe176cb51844ad8451c78ff97805341"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28562e0ce894bb21defc1c24a4ff174e34c6cf93", "author": {"user": {"login": "wchevreuil", "name": "Wellington Ramos Chevreuil"}}, "url": "https://github.com/apache/hbase/commit/28562e0ce894bb21defc1c24a4ff174e34c6cf93", "committedDate": "2020-05-23T13:56:54Z", "message": "fixing build issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64a3888f78f70619ffca60ee1407730aae9d86ad", "author": {"user": {"login": "wchevreuil", "name": "Wellington Ramos Chevreuil"}}, "url": "https://github.com/apache/hbase/commit/64a3888f78f70619ffca60ee1407730aae9d86ad", "committedDate": "2020-05-23T17:57:14Z", "message": "addressing Viraj suggestions."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MzIzODA1", "url": "https://github.com/apache/hbase/pull/1761#pullrequestreview-417323805", "createdAt": "2020-05-24T03:21:15Z", "commit": {"oid": "64a3888f78f70619ffca60ee1407730aae9d86ad"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNFQwMzoyMToxNVrOGZsaxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNFQwMzoyMToxNVrOGZsaxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTU5NTMzNA==", "bodyText": "Want to keep it 10s instead of 100s? :)", "url": "https://github.com/apache/hbase/pull/1761#discussion_r429595334", "createdAt": "2020-05-24T03:21:15Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/replication/TestReplicationStatus.java", "diffHunk": "@@ -120,6 +124,35 @@ public void testReplicationStatus() throws Exception {\n     assertEquals(PEER_ID2, rLoadSourceList.get(0).getPeerID());\n   }\n \n+  @Test\n+  public void testReplicationStatusSink() throws Exception {\n+    try (Admin hbaseAdmin = UTIL2.getConnection().getAdmin()) {\n+      ServerName server = UTIL2.getHBaseCluster().getRegionServer(0).getServerName();\n+      ReplicationLoadSink loadSink = getLatestSinkMetric(hbaseAdmin, server);\n+      //First checks if status of timestamp of last applied op is same as RS start, since no edits\n+      //were replicated yet\n+      assertEquals(loadSink.getTimestampStarted(), loadSink.getTimestampsOfLastAppliedOp());\n+      //now insert some rows on source, so that it gets delivered to target\n+      insertRowsOnSource();\n+      long wait = Waiter.waitFor(UTIL2.getConfiguration(),\n+        100000, new Waiter.Predicate<Exception>() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64a3888f78f70619ffca60ee1407730aae9d86ad"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6645ae431b52b8beadde563b946229b3abbc26fd", "author": {"user": {"login": "wchevreuil", "name": "Wellington Ramos Chevreuil"}}, "url": "https://github.com/apache/hbase/commit/6645ae431b52b8beadde563b946229b3abbc26fd", "committedDate": "2020-05-25T18:44:56Z", "message": "Adjusting the waiter timeout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b9f46cc1dd64fcfc763f67d8c07be45d078e9ec", "author": {"user": {"login": "wchevreuil", "name": "Wellington Ramos Chevreuil"}}, "url": "https://github.com/apache/hbase/commit/5b9f46cc1dd64fcfc763f67d8c07be45d078e9ec", "committedDate": "2020-05-25T20:27:40Z", "message": "Adjusting checkstyles"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NTIyMTE2", "url": "https://github.com/apache/hbase/pull/1761#pullrequestreview-419522116", "createdAt": "2020-05-27T19:00:39Z", "commit": {"oid": "5b9f46cc1dd64fcfc763f67d8c07be45d078e9ec"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxOTowMDo1OVrOGbY9Qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxOTowMDo1OVrOGbY9Qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM3MzYzNA==", "bodyText": "Add this to stay consistent to the other getters here.", "url": "https://github.com/apache/hbase/pull/1761#discussion_r431373634", "createdAt": "2020-05-27T19:00:59Z", "author": {"login": "HorizonNet"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/MetricsSink.java", "diffHunk": "@@ -98,4 +99,21 @@ public long getAgeOfLastAppliedOp() {\n   public long getTimestampOfLastAppliedOp() {\n     return this.lastTimestampForAge;\n   }\n+\n+  /**\n+   * Gets the time stamp from when the Sink was initialized.\n+   * @return startTimestamp\n+   */\n+  public long getStartTimestamp() {\n+    return startTimestamp;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b9f46cc1dd64fcfc763f67d8c07be45d078e9ec"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwNTUxNDM0", "url": "https://github.com/apache/hbase/pull/1761#pullrequestreview-420551434", "createdAt": "2020-05-28T23:07:49Z", "commit": {"oid": "5b9f46cc1dd64fcfc763f67d8c07be45d078e9ec"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMzowNzo0OVrOGcJr9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQyMzoxMjoxNVrOGcJxRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE3MjAyMA==", "bodyText": "nit: Can drop the wrapping parens", "url": "https://github.com/apache/hbase/pull/1761#discussion_r432172020", "createdAt": "2020-05-28T23:07:49Z", "author": {"login": "joshelser"}, "path": "hbase-shell/src/main/ruby/hbase/admin.rb", "diffHunk": "@@ -835,12 +835,16 @@ def status(format, type)\n           r_source_string = '       SOURCE:'\n           r_load_sink = sl.getReplicationLoadSink\n           next if r_load_sink.nil?\n+          if (r_load_sink.getTimestampsOfLastAppliedOp() == r_load_sink.getTimeStampStarted())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b9f46cc1dd64fcfc763f67d8c07be45d078e9ec"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE3MzM4Mg==", "bodyText": "A comment here would also be very appreciated (e.g \"If we have applied no operations since we've started replication, assume that we're not acting as a sink and don't print the normal information\")", "url": "https://github.com/apache/hbase/pull/1761#discussion_r432173382", "createdAt": "2020-05-28T23:12:15Z", "author": {"login": "joshelser"}, "path": "hbase-shell/src/main/ruby/hbase/admin.rb", "diffHunk": "@@ -835,12 +835,16 @@ def status(format, type)\n           r_source_string = '       SOURCE:'\n           r_load_sink = sl.getReplicationLoadSink\n           next if r_load_sink.nil?\n+          if (r_load_sink.getTimestampsOfLastAppliedOp() == r_load_sink.getTimeStampStarted())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE3MjAyMA=="}, "originalCommit": {"oid": "5b9f46cc1dd64fcfc763f67d8c07be45d078e9ec"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d19ea42341ec3a5a8d112fe551fe344a090fcd48", "author": {"user": {"login": "wchevreuil", "name": "Wellington Ramos Chevreuil"}}, "url": "https://github.com/apache/hbase/commit/d19ea42341ec3a5a8d112fe551fe344a090fcd48", "committedDate": "2020-06-01T18:36:22Z", "message": "Addressing latest comments from Josh and Jan, together with shell UT failures"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMDg5MTIw", "url": "https://github.com/apache/hbase/pull/1761#pullrequestreview-422089120", "createdAt": "2020-06-01T18:41:30Z", "commit": {"oid": "d19ea42341ec3a5a8d112fe551fe344a090fcd48"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4718, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}