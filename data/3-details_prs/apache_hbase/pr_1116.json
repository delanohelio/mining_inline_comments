{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwMDU0OTY0", "number": 1116, "title": "HBASE-23783: Address tests writing and reading SSL/Security files in \u2026", "bodyText": "\u2026a common location.\nThis is causing me issues with parallel test runs.", "createdAt": "2020-02-02T20:56:14Z", "url": "https://github.com/apache/hbase/pull/1116", "merged": true, "mergeCommit": {"oid": "299b6bebc5120dacf7a55cfba06de6d98fb973c0"}, "closed": true, "closedAt": "2020-02-04T22:38:56Z", "author": {"login": "markrmiller"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcAxmHoAFqTM1MjQ3NzE1OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcCFu8iAFqTM1NTQzMDc3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNDc3MTU4", "url": "https://github.com/apache/hbase/pull/1116#pullrequestreview-352477158", "createdAt": "2020-02-03T18:45:46Z", "commit": {"oid": "271ab347e09fb8531a250e3a40abd437f6749f07"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxODo0NTo0N1rOFk73hA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxODo1MDo1N1rOFk8BTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3MzkyNA==", "bodyText": "Statics. normally capitalized as in HTU rather than htu.", "url": "https://github.com/apache/hbase/pull/1116#discussion_r374273924", "createdAt": "2020-02-03T18:45:47Z", "author": {"login": "saintstack"}, "path": "hbase-http/src/test/java/org/apache/hadoop/hbase/http/TestSSLHttpServer.java", "diffHunk": "@@ -51,62 +52,65 @@\n \n   @ClassRule\n   public static final HBaseClassTestRule CLASS_RULE =\n-      HBaseClassTestRule.forClass(TestSSLHttpServer.class);\n+    HBaseClassTestRule.forClass(TestSSLHttpServer.class);\n \n   private static final String BASEDIR = System.getProperty(\"test.build.dir\",\n-      \"target/test-dir\") + \"/\" + TestSSLHttpServer.class.getSimpleName();\n+    \"target/test-dir\") + \"/\" + TestSSLHttpServer.class.getSimpleName();\n \n   private static final Logger LOG = LoggerFactory.getLogger(TestSSLHttpServer.class);\n   private static Configuration conf;\n   private static HttpServer server;\n   private static URL baseUrl;\n-  private static String keystoresDir;\n+  private static File keystoresDir;\n   private static String sslConfDir;\n   private static SSLFactory clientSslFactory;\n+  private static HBaseCommonTestingUtility htu;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "271ab347e09fb8531a250e3a40abd437f6749f07"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3NDU1Mw==", "bodyText": "Above its sslconf... you want conf here?", "url": "https://github.com/apache/hbase/pull/1116#discussion_r374274553", "createdAt": "2020-02-03T18:47:04Z", "author": {"login": "saintstack"}, "path": "hbase-http/src/test/java/org/apache/hadoop/hbase/http/TestSSLHttpServer.java", "diffHunk": "@@ -51,62 +52,65 @@\n \n   @ClassRule\n   public static final HBaseClassTestRule CLASS_RULE =\n-      HBaseClassTestRule.forClass(TestSSLHttpServer.class);\n+    HBaseClassTestRule.forClass(TestSSLHttpServer.class);\n \n   private static final String BASEDIR = System.getProperty(\"test.build.dir\",\n-      \"target/test-dir\") + \"/\" + TestSSLHttpServer.class.getSimpleName();\n+    \"target/test-dir\") + \"/\" + TestSSLHttpServer.class.getSimpleName();\n \n   private static final Logger LOG = LoggerFactory.getLogger(TestSSLHttpServer.class);\n   private static Configuration conf;\n   private static HttpServer server;\n   private static URL baseUrl;\n-  private static String keystoresDir;\n+  private static File keystoresDir;\n   private static String sslConfDir;\n   private static SSLFactory clientSslFactory;\n+  private static HBaseCommonTestingUtility htu;\n \n   @BeforeClass\n   public static void setup() throws Exception {\n     conf = new Configuration();\n     conf.setInt(HttpServer.HTTP_MAX_THREADS, TestHttpServer.MAX_THREADS);\n \n-    File base = new File(BASEDIR);\n-    FileUtil.fullyDelete(base);\n-    base.mkdirs();\n-    keystoresDir = new File(BASEDIR).getAbsolutePath();\n+    htu = new HBaseCommonTestingUtility(conf);\n+\n+    keystoresDir = new File(htu.getDataTestDir(\"keystore\").toString());\n+    keystoresDir.mkdirs();\n+\n     sslConfDir = KeyStoreTestUtil.getClasspathDir(TestSSLHttpServer.class);\n \n-    KeyStoreTestUtil.setupSSLConfig(keystoresDir, sslConfDir, conf, false);\n+    KeyStoreTestUtil.setupSSLConfig(keystoresDir.getAbsolutePath(), sslConfDir, conf, false);\n     Configuration sslConf = new Configuration(false);\n-    sslConf.addResource(\"ssl-server.xml\");\n-    sslConf.addResource(\"ssl-client.xml\");\n-\n+    sslConf.addResource(conf.get(SSLFactory.SSL_CLIENT_CONF_KEY));\n+    conf.addResource(conf.get(SSLFactory.SSL_SERVER_CONF_KEY));\n+    sslConf.set(SSLFactory.SSL_CLIENT_CONF_KEY, conf.get(SSLFactory.SSL_CLIENT_CONF_KEY));\n+    \n     clientSslFactory = new SSLFactory(SSLFactory.Mode.CLIENT, sslConf);\n     clientSslFactory.init();\n \n     server = new HttpServer.Builder()\n-        .setName(\"test\")\n-        .addEndpoint(new URI(\"https://localhost\"))\n-        .setConf(conf)\n-        .keyPassword(HBaseConfiguration.getPassword(sslConf, \"ssl.server.keystore.keypassword\",\n-            null))\n-        .keyStore(sslConf.get(\"ssl.server.keystore.location\"),\n-            HBaseConfiguration.getPassword(sslConf, \"ssl.server.keystore.password\", null),\n-            sslConf.get(\"ssl.server.keystore.type\", \"jks\"))\n-        .trustStore(sslConf.get(\"ssl.server.truststore.location\"),\n-            HBaseConfiguration.getPassword(sslConf, \"ssl.server.truststore.password\", null),\n-            sslConf.get(\"ssl.server.truststore.type\", \"jks\")).build();\n+      .setName(\"test\")\n+      .addEndpoint(new URI(\"https://localhost\"))\n+      .setConf(conf)\n+      .keyPassword(HBaseConfiguration.getPassword(conf, \"ssl.server.keystore.keypassword\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "271ab347e09fb8531a250e3a40abd437f6749f07"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3NDkzNg==", "bodyText": "Ditto. We use conf instead of sslconf here... That intentional?", "url": "https://github.com/apache/hbase/pull/1116#discussion_r374274936", "createdAt": "2020-02-03T18:47:51Z", "author": {"login": "saintstack"}, "path": "hbase-http/src/test/java/org/apache/hadoop/hbase/http/TestSSLHttpServer.java", "diffHunk": "@@ -51,62 +52,65 @@\n \n   @ClassRule\n   public static final HBaseClassTestRule CLASS_RULE =\n-      HBaseClassTestRule.forClass(TestSSLHttpServer.class);\n+    HBaseClassTestRule.forClass(TestSSLHttpServer.class);\n \n   private static final String BASEDIR = System.getProperty(\"test.build.dir\",\n-      \"target/test-dir\") + \"/\" + TestSSLHttpServer.class.getSimpleName();\n+    \"target/test-dir\") + \"/\" + TestSSLHttpServer.class.getSimpleName();\n \n   private static final Logger LOG = LoggerFactory.getLogger(TestSSLHttpServer.class);\n   private static Configuration conf;\n   private static HttpServer server;\n   private static URL baseUrl;\n-  private static String keystoresDir;\n+  private static File keystoresDir;\n   private static String sslConfDir;\n   private static SSLFactory clientSslFactory;\n+  private static HBaseCommonTestingUtility htu;\n \n   @BeforeClass\n   public static void setup() throws Exception {\n     conf = new Configuration();\n     conf.setInt(HttpServer.HTTP_MAX_THREADS, TestHttpServer.MAX_THREADS);\n \n-    File base = new File(BASEDIR);\n-    FileUtil.fullyDelete(base);\n-    base.mkdirs();\n-    keystoresDir = new File(BASEDIR).getAbsolutePath();\n+    htu = new HBaseCommonTestingUtility(conf);\n+\n+    keystoresDir = new File(htu.getDataTestDir(\"keystore\").toString());\n+    keystoresDir.mkdirs();\n+\n     sslConfDir = KeyStoreTestUtil.getClasspathDir(TestSSLHttpServer.class);\n \n-    KeyStoreTestUtil.setupSSLConfig(keystoresDir, sslConfDir, conf, false);\n+    KeyStoreTestUtil.setupSSLConfig(keystoresDir.getAbsolutePath(), sslConfDir, conf, false);\n     Configuration sslConf = new Configuration(false);\n-    sslConf.addResource(\"ssl-server.xml\");\n-    sslConf.addResource(\"ssl-client.xml\");\n-\n+    sslConf.addResource(conf.get(SSLFactory.SSL_CLIENT_CONF_KEY));\n+    conf.addResource(conf.get(SSLFactory.SSL_SERVER_CONF_KEY));\n+    sslConf.set(SSLFactory.SSL_CLIENT_CONF_KEY, conf.get(SSLFactory.SSL_CLIENT_CONF_KEY));\n+    \n     clientSslFactory = new SSLFactory(SSLFactory.Mode.CLIENT, sslConf);\n     clientSslFactory.init();\n \n     server = new HttpServer.Builder()\n-        .setName(\"test\")\n-        .addEndpoint(new URI(\"https://localhost\"))\n-        .setConf(conf)\n-        .keyPassword(HBaseConfiguration.getPassword(sslConf, \"ssl.server.keystore.keypassword\",\n-            null))\n-        .keyStore(sslConf.get(\"ssl.server.keystore.location\"),\n-            HBaseConfiguration.getPassword(sslConf, \"ssl.server.keystore.password\", null),\n-            sslConf.get(\"ssl.server.keystore.type\", \"jks\"))\n-        .trustStore(sslConf.get(\"ssl.server.truststore.location\"),\n-            HBaseConfiguration.getPassword(sslConf, \"ssl.server.truststore.password\", null),\n-            sslConf.get(\"ssl.server.truststore.type\", \"jks\")).build();\n+      .setName(\"test\")\n+      .addEndpoint(new URI(\"https://localhost\"))\n+      .setConf(conf)\n+      .keyPassword(HBaseConfiguration.getPassword(conf, \"ssl.server.keystore.keypassword\",\n+        null))\n+      .keyStore(conf.get(\"ssl.server.keystore.location\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "271ab347e09fb8531a250e3a40abd437f6749f07"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3NTczMQ==", "bodyText": "Capitalize", "url": "https://github.com/apache/hbase/pull/1116#discussion_r374275731", "createdAt": "2020-02-03T18:49:33Z", "author": {"login": "saintstack"}, "path": "hbase-http/src/test/java/org/apache/hadoop/hbase/http/log/TestLogLevel.java", "diffHunk": "@@ -84,31 +83,29 @@\n   private final static String KEYTAB  = \"loglevel.keytab\";\n \n   private static MiniKdc kdc;\n-  private static HBaseCommonTestingUtility htu = new HBaseCommonTestingUtility();\n \n   private static final String LOCALHOST = \"localhost\";\n   private static final String clientPrincipal = \"client/\" + LOCALHOST;\n   private static String HTTP_PRINCIPAL = \"HTTP/\" + LOCALHOST;\n-\n-  private static final File KEYTAB_FILE = new File(\n-      htu.getDataTestDir(\"keytab\").toUri().getPath());\n+  private static HBaseCommonTestingUtility htu;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "271ab347e09fb8531a250e3a40abd437f6749f07"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDI3NjQyOQ==", "bodyText": "And maybe you want to use the HTU's conf. Do HTU.getConfiguration instead of creating a 'new Configuration()' in line above ... and FYI, for configs that will include hbase config, you want HBaseConfiguration.create.... instead of new Configuration.", "url": "https://github.com/apache/hbase/pull/1116#discussion_r374276429", "createdAt": "2020-02-03T18:50:57Z", "author": {"login": "saintstack"}, "path": "hbase-http/src/test/java/org/apache/hadoop/hbase/http/log/TestLogLevel.java", "diffHunk": "@@ -84,31 +83,29 @@\n   private final static String KEYTAB  = \"loglevel.keytab\";\n \n   private static MiniKdc kdc;\n-  private static HBaseCommonTestingUtility htu = new HBaseCommonTestingUtility();\n \n   private static final String LOCALHOST = \"localhost\";\n   private static final String clientPrincipal = \"client/\" + LOCALHOST;\n   private static String HTTP_PRINCIPAL = \"HTTP/\" + LOCALHOST;\n-\n-  private static final File KEYTAB_FILE = new File(\n-      htu.getDataTestDir(\"keytab\").toUri().getPath());\n+  private static HBaseCommonTestingUtility htu;\n+  private static File keyTabFile;\n \n   @BeforeClass\n   public static void setUp() throws Exception {\n-    BASEDIR = new File(htu.getDataTestDir().toUri().getPath());\n-\n-    FileUtil.fullyDelete(BASEDIR);\n-    if (!BASEDIR.mkdirs()) {\n-      throw new Exception(\"unable to create the base directory for testing\");\n-    }\n     serverConf = new Configuration();\n+    htu = new HBaseCommonTestingUtility(serverConf);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "271ab347e09fb8531a250e3a40abd437f6749f07"}, "originalPosition": 35}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "271ab347e09fb8531a250e3a40abd437f6749f07", "author": {"user": {"login": "markrmiller", "name": "Mark Robert Miller"}}, "url": "https://github.com/apache/hbase/commit/271ab347e09fb8531a250e3a40abd437f6749f07", "committedDate": "2020-02-02T20:54:43Z", "message": "HBASE-23783: Address tests writing and reading SSL/Security files in a common location.\n\nThis is causing me issues with parallel test runs."}, "afterCommit": {"oid": "f87bd537d011a182d718c94d7bc6b48fd84aa7ae", "author": {"user": {"login": "markrmiller", "name": "Mark Robert Miller"}}, "url": "https://github.com/apache/hbase/commit/f87bd537d011a182d718c94d7bc6b48fd84aa7ae", "committedDate": "2020-02-04T01:32:22Z", "message": "HBASE-23783: Address tests writing and reading SSL/Security files in a common location.\n\nThis is causing me issues with parallel test runs.\n\nAlso allow setting the surefire reports and temp directories via command line."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b67ca24bf4baf1d84abea59b88740a76a8a77c6", "author": {"user": {"login": "markrmiller", "name": "Mark Robert Miller"}}, "url": "https://github.com/apache/hbase/commit/7b67ca24bf4baf1d84abea59b88740a76a8a77c6", "committedDate": "2020-02-04T01:44:01Z", "message": "HBASE-23783: Address tests writing and reading SSL/Security files in a common location.\n\nThis is causing me issues with parallel test runs.\n\nAlso allow setting the surefire reports and temp directories via command line."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f87bd537d011a182d718c94d7bc6b48fd84aa7ae", "author": {"user": {"login": "markrmiller", "name": "Mark Robert Miller"}}, "url": "https://github.com/apache/hbase/commit/f87bd537d011a182d718c94d7bc6b48fd84aa7ae", "committedDate": "2020-02-04T01:32:22Z", "message": "HBASE-23783: Address tests writing and reading SSL/Security files in a common location.\n\nThis is causing me issues with parallel test runs.\n\nAlso allow setting the surefire reports and temp directories via command line."}, "afterCommit": {"oid": "7b67ca24bf4baf1d84abea59b88740a76a8a77c6", "author": {"user": {"login": "markrmiller", "name": "Mark Robert Miller"}}, "url": "https://github.com/apache/hbase/commit/7b67ca24bf4baf1d84abea59b88740a76a8a77c6", "committedDate": "2020-02-04T01:44:01Z", "message": "HBASE-23783: Address tests writing and reading SSL/Security files in a common location.\n\nThis is causing me issues with parallel test runs.\n\nAlso allow setting the surefire reports and temp directories via command line."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NDMwNzc1", "url": "https://github.com/apache/hbase/pull/1116#pullrequestreview-355430775", "createdAt": "2020-02-07T20:54:43Z", "commit": {"oid": "7b67ca24bf4baf1d84abea59b88740a76a8a77c6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QyMDo1NDo0M1rOFnKAjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QyMDo1NDo0M1rOFnKAjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYwMjc2Nw==", "bodyText": "Hey @markrmiller  I don't think this variable is defined anywhere. Missing some other change someplace?", "url": "https://github.com/apache/hbase/pull/1116#discussion_r376602767", "createdAt": "2020-02-07T20:54:43Z", "author": {"login": "ndimiduk"}, "path": "pom.xml", "diffHunk": "@@ -729,6 +729,8 @@\n             <skip>${surefire.skipFirstPart}</skip>\n             <forkCount>${surefire.firstPartForkCount}</forkCount>\n             <reuseForks>false</reuseForks>\n+            <reportsDirectory>${surefire.reportsDirectory}</reportsDirectory>\n+            <tempDir>${surefire.tempDir}</tempDir>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b67ca24bf4baf1d84abea59b88740a76a8a77c6"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3087, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}