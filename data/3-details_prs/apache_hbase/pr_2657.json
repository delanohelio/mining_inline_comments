{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxMzE2ODQ0", "number": 2657, "title": "HBASE-25282 Remove processingServers in DeadServer as we can get this\u2026", "bodyText": "\u2026 information by Procedure of master", "createdAt": "2020-11-16T02:37:31Z", "url": "https://github.com/apache/hbase/pull/2657", "merged": true, "mergeCommit": {"oid": "403756ade51241ffdb0cecddacdfc03cb450b018"}, "closed": true, "closedAt": "2020-11-25T07:16:28Z", "author": {"login": "yuqi1129"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdc75XFAH2gAyNTIxMzE2ODQ0OjE1NTJkMjg3N2UwMjMzZTgxN2UwMzRkOTI5ZTM2MDYzM2MyNzA3MmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdjdIk8AFqTU0NTY4NDU4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1552d2877e0233e817e034d929e360633c27072a", "author": {"user": {"login": "yuqi1129", "name": "Qi Yu"}}, "url": "https://github.com/apache/hbase/commit/1552d2877e0233e817e034d929e360633c27072a", "committedDate": "2020-11-16T02:54:10Z", "message": "HBASE-25282 Remove processingServers in DeadServer as we can get this information by Procedure of master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71b3b5e6be2fab78761ef34e230a01f4d83c96cc", "author": {"user": {"login": "yuqi1129", "name": "Qi Yu"}}, "url": "https://github.com/apache/hbase/commit/71b3b5e6be2fab78761ef34e230a01f4d83c96cc", "committedDate": "2020-11-16T02:54:20Z", "message": "HBASE-25282 Remove processingServers in DeadServer as we can get this information by Procedure of master, again"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4da3356a4019bcbc10cb0bc69aa9301c2d593c45", "author": {"user": {"login": "yuqi1129", "name": "Qi Yu"}}, "url": "https://github.com/apache/hbase/commit/4da3356a4019bcbc10cb0bc69aa9301c2d593c45", "committedDate": "2020-11-16T02:51:46Z", "message": "Merge remote-tracking branch 'me/25282' into 25282"}, "afterCommit": {"oid": "71b3b5e6be2fab78761ef34e230a01f4d83c96cc", "author": {"user": {"login": "yuqi1129", "name": "Qi Yu"}}, "url": "https://github.com/apache/hbase/commit/71b3b5e6be2fab78761ef34e230a01f4d83c96cc", "committedDate": "2020-11-16T02:54:20Z", "message": "HBASE-25282 Remove processingServers in DeadServer as we can get this information by Procedure of master, again"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxOTM5Mjcy", "url": "https://github.com/apache/hbase/pull/2657#pullrequestreview-531939272", "createdAt": "2020-11-17T00:48:18Z", "commit": {"oid": "71b3b5e6be2fab78761ef34e230a01f4d83c96cc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMDo0ODoxOVrOH0f_kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMDo0ODoxOVrOH0f_kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgxMjE3OQ==", "bodyText": "Why this change?", "url": "https://github.com/apache/hbase/pull/2657#discussion_r524812179", "createdAt": "2020-11-17T00:48:19Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/MasterRpcServices.java", "diffHunk": "@@ -2440,6 +2440,12 @@ public ClearDeadServersResponse clearDeadServers(RpcController controller,\n         Set<Address> clearedServers = new HashSet<>();\n         for (HBaseProtos.ServerName pbServer : request.getServerNameList()) {\n           ServerName server = ProtobufUtil.toServerName(pbServer);\n+          final boolean deadInProcess = master.getServerManager().isDeadServersInProgress(server);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71b3b5e6be2fab78761ef34e230a01f4d83c96cc"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxOTM5NDA1", "url": "https://github.com/apache/hbase/pull/2657#pullrequestreview-531939405", "createdAt": "2020-11-17T00:48:43Z", "commit": {"oid": "71b3b5e6be2fab78761ef34e230a01f4d83c96cc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMDo0ODo0M1rOH0gAEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMDo0ODo0M1rOH0gAEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgxMjMwNQ==", "bodyText": "Why add this method?", "url": "https://github.com/apache/hbase/pull/2657#discussion_r524812305", "createdAt": "2020-11-17T00:48:43Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/ServerManager.java", "diffHunk": "@@ -504,7 +506,21 @@ public DeadServer getDeadServers() {\n    * @return true if any RS are being processed as dead, false if not\n    */\n   public boolean areDeadServersInProgress() {\n-    return this.deadservers.areDeadServersInProgress();\n+    try {\n+      return master.getProcedures().stream().anyMatch(p -> p instanceof ServerCrashProcedure);\n+    } catch (IOException e) {\n+      throw new RuntimeException(e);\n+    }\n+  }\n+\n+  public boolean isDeadServersInProgress(ServerName serverName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71b3b5e6be2fab78761ef34e230a01f4d83c96cc"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyOTQ1MTY1", "url": "https://github.com/apache/hbase/pull/2657#pullrequestreview-532945165", "createdAt": "2020-11-18T01:28:06Z", "commit": {"oid": "71b3b5e6be2fab78761ef34e230a01f4d83c96cc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMToyODowN1rOH1SOsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwMToyODowN1rOH1SOsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYzNTI1MQ==", "bodyText": "You can filter the SCP here too? I thought no need to introduce new method. Please keep the code simple. Thanks.", "url": "https://github.com/apache/hbase/pull/2657#discussion_r525635251", "createdAt": "2020-11-18T01:28:07Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/MasterRpcServices.java", "diffHunk": "@@ -2440,6 +2440,12 @@ public ClearDeadServersResponse clearDeadServers(RpcController controller,\n         Set<Address> clearedServers = new HashSet<>();\n         for (HBaseProtos.ServerName pbServer : request.getServerNameList()) {\n           ServerName server = ProtobufUtil.toServerName(pbServer);\n+          final boolean deadInProcess = master.getServerManager().isDeadServersInProgress(server);\n+\n+          if (!deadInProcess) {\n+            throw new RuntimeException(String.format(\"Dead server '%s' is not 'dead' in fact...\", server));\n+          }\n+\n           if (!deadServer.removeDeadServer(server)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71b3b5e6be2fab78761ef34e230a01f4d83c96cc"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf60ce629972aaa0f08bd0d2d71af94d0e90f51b", "author": {"user": {"login": "yuqi1129", "name": "Qi Yu"}}, "url": "https://github.com/apache/hbase/commit/bf60ce629972aaa0f08bd0d2d71af94d0e90f51b", "committedDate": "2020-11-18T07:21:24Z", "message": "HBASE-25282 Remove processingServers in DeadServer as we can get this information by Procedure of master, fix discussion 1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9613660c835c12a302ba635a4a01085c6d3fd735", "author": {"user": {"login": "yuqi1129", "name": "Qi Yu"}}, "url": "https://github.com/apache/hbase/commit/9613660c835c12a302ba635a4a01085c6d3fd735", "committedDate": "2020-11-18T07:23:05Z", "message": "HBASE-25282 Remove processingServers in DeadServer as we can get this information by Procedure of master, fix discussion 2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MTQ2MTg0", "url": "https://github.com/apache/hbase/pull/2657#pullrequestreview-536146184", "createdAt": "2020-11-23T02:03:35Z", "commit": {"oid": "9613660c835c12a302ba635a4a01085c6d3fd735"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b29e0b71589f3d4a4c0e1186463afd8dedd31ba8", "author": {"user": {"login": "yuqi1129", "name": "Qi Yu"}}, "url": "https://github.com/apache/hbase/commit/b29e0b71589f3d4a4c0e1186463afd8dedd31ba8", "committedDate": "2020-11-23T02:11:38Z", "message": "Merge branch 'master' of https://github.com/apache/hbase into 25282"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9d4a480f6f9ed937df10f07674191a1af21ff34", "author": {"user": {"login": "yuqi1129", "name": "Qi Yu"}}, "url": "https://github.com/apache/hbase/commit/d9d4a480f6f9ed937df10f07674191a1af21ff34", "committedDate": "2020-11-23T02:26:50Z", "message": "Merge branch '25282' of https://github.com/yuqi1129/hbase into 25282"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b4669369da6d17d85ae8524d7e729cd400583ed", "author": {"user": {"login": "yuqi1129", "name": "Qi Yu"}}, "url": "https://github.com/apache/hbase/commit/0b4669369da6d17d85ae8524d7e729cd400583ed", "committedDate": "2020-11-24T08:12:28Z", "message": "HBASE-25282 Remove processingServers in DeadServer as we can get this information by Procedure of master, again, fix ut"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e146b308919547b7d3bde3676978da49792ca174", "author": {"user": {"login": "yuqi1129", "name": "Qi Yu"}}, "url": "https://github.com/apache/hbase/commit/e146b308919547b7d3bde3676978da49792ca174", "committedDate": "2020-11-25T01:55:39Z", "message": "Fix checkstyle problem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95031fb720cab6296eaf1441065ae8580f98528b", "author": {"user": {"login": "yuqi1129", "name": "Qi Yu"}}, "url": "https://github.com/apache/hbase/commit/95031fb720cab6296eaf1441065ae8580f98528b", "committedDate": "2020-11-25T01:57:12Z", "message": "Fix checkstyle problem again"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NjgxMDc5", "url": "https://github.com/apache/hbase/pull/2657#pullrequestreview-544681079", "createdAt": "2020-12-04T06:12:34Z", "commit": {"oid": "95031fb720cab6296eaf1441065ae8580f98528b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwNjoxMjozNVrOH_CVZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwNjoxMjozNVrOH_CVZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg2MDU4Mg==", "bodyText": "These codes are not only set the server be dead, but also set it be processing.\nBut the changed codes only set it be dead.\nAs a result ,when calling ServerManager.expireServer() method, the server is firstly set be dead by moveFromOnlineToDeadServers(), but the SCP is submitted afterwards.\nSo this patch made a diff from the origin codes when calling ServerManager.areDeadServersInProgress(), because the new codes has a little delay time of submit and execute the SCP procedure.", "url": "https://github.com/apache/hbase/pull/2657#discussion_r535860582", "createdAt": "2020-12-04T06:12:35Z", "author": {"login": "sunhelly"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/DeadServer.java", "diffHunk": "@@ -96,29 +75,6 @@ synchronized boolean areDeadServersInProgress() {\n    */\n   synchronized void putIfAbsent(ServerName sn) {\n     this.deadServers.putIfAbsent(sn, EnvironmentEdgeManager.currentTime());\n-    processing(sn);\n-  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95031fb720cab6296eaf1441065ae8580f98528b"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1Njg0NTg4", "url": "https://github.com/apache/hbase/pull/2657#pullrequestreview-545684588", "createdAt": "2020-12-06T09:01:05Z", "commit": {"oid": "95031fb720cab6296eaf1441065ae8580f98528b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQwOTowMTowNVrOIAHbjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQwOTowMTowNVrOIAHbjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjk5MjY1Mw==", "bodyText": "This test case should assert false, because the SCP has been done completely.", "url": "https://github.com/apache/hbase/pull/2657#discussion_r536992653", "createdAt": "2020-12-06T09:01:05Z", "author": {"login": "sunhelly"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/master/TestDeadServer.java", "diffHunk": "@@ -104,15 +93,15 @@ public static void tearDownAfterClass() throws Exception {\n   }\n \n   @Test\n-  public void testCrashProcedureReplay() {\n+  public void testCrashProcedureReplay() throws IOException {\n     HMaster master = TEST_UTIL.getHBaseCluster().getMaster();\n     final ProcedureExecutor<MasterProcedureEnv> pExecutor = master.getMasterProcedureExecutor();\n     ServerCrashProcedure proc = new ServerCrashProcedure(\n       pExecutor.getEnvironment(), hostname123, false, false);\n \n     ProcedureTestingUtility.submitAndWait(pExecutor, proc);\n \n-    assertFalse(master.getServerManager().getDeadServers().areDeadServersInProgress());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95031fb720cab6296eaf1441065ae8580f98528b"}, "originalPosition": 44}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1953, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}