{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzNzI0MDYz", "number": 1346, "title": "HBASE-23937 : Support Online LargeLogs similar to SlowLogs APIs", "bodyText": "", "createdAt": "2020-03-25T17:27:08Z", "url": "https://github.com/apache/hbase/pull/1346", "merged": true, "mergeCommit": {"oid": "0dcbf80583f3805d4e7a3e28c891a4837debd224"}, "closed": true, "closedAt": "2020-04-01T12:52:23Z", "author": {"login": "virajjasani"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRK6QygH2gAyMzkzNzI0MDYzOjhmN2I0MzM2ZWFkMWZmNGI4YjA2ZDg2ZTgzMDJlMzQ5Y2E5NmQwZjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTVScsAH2gAyMzkzNzI0MDYzOjc5MzhkYmU4Zjk4NzUxZjc4ZjI3MzNjMDU1ZTI3YzEzNGMzODZkNTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8f7b4336ead1ff4b8b06d86e8302e349ca96d0f1", "author": {"user": {"login": "virajjasani", "name": "Viraj Jasani"}}, "url": "https://github.com/apache/hbase/commit/8f7b4336ead1ff4b8b06d86e8302e349ca96d0f1", "committedDate": "2020-03-25T17:25:29Z", "message": "HBASE-23937 : Support Online LargeLogs similar to SlowLogs APIs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzMzgxMzI3", "url": "https://github.com/apache/hbase/pull/1346#pullrequestreview-383381327", "createdAt": "2020-03-29T07:23:26Z", "commit": {"oid": "8f7b4336ead1ff4b8b06d86e8302e349ca96d0f1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOVQwNzoyMzoyN1rOF9PSbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yOVQwNzoyMzoyN1rOF9PSbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTc1NzkzMg==", "bodyText": "@bharathv I am planning to change SlowLogRecord to OnlineLogRecord and SlowLogQueryFilter to OnlineLogQueryFilter. Will make that change before merging the PR because this class is being referred at multiple places (in thrift), so will be redundant refactor for now (to make review relevant to actual changes).\nAlso, the overall change is providing new API in Admin and shell command and to have 2 flags at server side (isSlowLog and isLargeLog) to fetch relevant records from server.", "url": "https://github.com/apache/hbase/pull/1346#discussion_r399757932", "createdAt": "2020-03-29T07:23:27Z", "author": {"login": "virajjasani"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/Admin.java", "diffHunk": "@@ -2276,6 +2276,18 @@ boolean snapshotCleanupSwitch(final boolean on, final boolean synchronous)\n   List<SlowLogRecord> getSlowLogResponses(final Set<ServerName> serverNames,\n       final SlowLogQueryFilter slowLogQueryFilter) throws IOException;\n \n+  /**\n+   * Retrieves online large RPC logs from the provided list of\n+   * RegionServers\n+   *\n+   * @param serverNames Server names to get slowlog responses from\n+   * @param largeLogQueryFilter filter to be used if provided\n+   * @return online slowlog response list\n+   * @throws IOException if a remote or network exception occurs\n+   */\n+  List<SlowLogRecord> getLargeLogResponses(final Set<ServerName> serverNames,\n+    final SlowLogQueryFilter largeLogQueryFilter) throws IOException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f7b4336ead1ff4b8b06d86e8302e349ca96d0f1"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0MTYwNDY1", "url": "https://github.com/apache/hbase/pull/1346#pullrequestreview-384160465", "createdAt": "2020-03-30T19:24:14Z", "commit": {"oid": "8f7b4336ead1ff4b8b06d86e8302e349ca96d0f1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxOToyNDoxNFrOF94zjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxOTo0NjoxOVrOF95i8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQzODE1OA==", "bodyText": "use an enum? OnlineLogType for ex.. Also, you don't need to have two separate RPCs if you pass this \"type\" as a param to the RPC call (we can potentially have other \"types\" in the future in which case we don't want to add a new set of RPCs).", "url": "https://github.com/apache/hbase/pull/1346#discussion_r400438158", "createdAt": "2020-03-30T19:24:14Z", "author": {"login": "bharathv"}, "path": "hbase-protocol-shaded/src/main/protobuf/Admin.proto", "diffHunk": "@@ -287,6 +287,8 @@ message SlowLogResponseRequest {\n   optional string client_address = 3;\n   optional string user_name = 4;\n   optional uint32 limit = 5 [default = 10];\n+  optional bool is_slow_log = 6 [default = false];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f7b4336ead1ff4b8b06d86e8302e349ca96d0f1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDQ1MDI4OA==", "bodyText": "This can probably be simplified too with 'TYPE' => LARGE_LOGS", "url": "https://github.com/apache/hbase/pull/1346#discussion_r400450288", "createdAt": "2020-03-30T19:46:19Z", "author": {"login": "bharathv"}, "path": "hbase-shell/src/main/ruby/shell/commands/get_largelog_responses.rb", "diffHunk": "@@ -0,0 +1,78 @@\n+#\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements. See the NOTICE file distributed with this\n+# work for additional information regarding copyright ownership. The ASF\n+# licenses this file to you under the Apache License, Version 2.0 (the\n+# \"License\"); you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+# http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+# License for the specific language governing permissions and limitations\n+# under the License.\n+\n+# Retrieve latest large log responses maintained in memory by RegionServers\n+\n+module Shell\n+  module Commands\n+    # Retrieve latest large log responses\n+    class GetLargelogResponses < Command\n+      def help\n+        <<-EOF\n+Retrieve latest LargeLog Responses maintained by each or specific RegionServers.\n+Specify '*' to include all RS otherwise array of server names for specific\n+RS. A server name is the host, port plus startcode of a RegionServer.\n+e.g.: host187.example.com,60020,1289493121758 (find servername in\n+master ui or when you do detailed status in shell)\n+\n+Provide optional filter parameters as Hash.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f7b4336ead1ff4b8b06d86e8302e349ca96d0f1"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b7af237cec0ffafa87c16ee6af0f6b0d5cf1c39", "author": {"user": {"login": "virajjasani", "name": "Viraj Jasani"}}, "url": "https://github.com/apache/hbase/commit/5b7af237cec0ffafa87c16ee6af0f6b0d5cf1c39", "committedDate": "2020-03-31T08:34:10Z", "message": "review comment - enum for slow and large logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0459e549b6bcfd6b5a93919f79564f0b7d80ceff", "author": {"user": {"login": "virajjasani", "name": "Viraj Jasani"}}, "url": "https://github.com/apache/hbase/commit/0459e549b6bcfd6b5a93919f79564f0b7d80ceff", "committedDate": "2020-03-31T19:46:40Z", "message": "single Admin API for large and slow logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "351f16526e70e9a1d3ab8232c7d158d50b06699f", "author": {"user": {"login": "virajjasani", "name": "Viraj Jasani"}}, "url": "https://github.com/apache/hbase/commit/351f16526e70e9a1d3ab8232c7d158d50b06699f", "committedDate": "2020-03-31T20:05:31Z", "message": "Updating thrift usage to consider LogQueryFilter changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MTA0Njk3", "url": "https://github.com/apache/hbase/pull/1346#pullrequestreview-385104697", "createdAt": "2020-03-31T21:06:14Z", "commit": {"oid": "351f16526e70e9a1d3ab8232c7d158d50b06699f"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMTowNjoxNFrOF-oPEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQyMTowODo1NVrOF-oUgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIxNTI1MA==", "bodyText": "Why this branch on the client? Can't the server side infer the type and respond accordingly?", "url": "https://github.com/apache/hbase/pull/1346#discussion_r401215250", "createdAt": "2020-03-31T21:06:14Z", "author": {"login": "bharathv"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/RawAsyncHBaseAdmin.java", "diffHunk": "@@ -3952,17 +3952,27 @@ private void getProcedureResult(long procId, CompletableFuture<Void> future, int\n \n   @Override\n   public CompletableFuture<List<SlowLogRecord>> getSlowLogResponses(\n-    @Nullable final Set<ServerName> serverNames,\n+      @Nullable final Set<ServerName> serverNames,\n     final SlowLogQueryFilter slowLogQueryFilter) {\n     if (CollectionUtils.isEmpty(serverNames)) {\n       return CompletableFuture.completedFuture(Collections.emptyList());\n     }\n-    return CompletableFuture.supplyAsync(() -> serverNames.stream()\n-      .map((ServerName serverName) ->\n-        getSlowLogResponseFromServer(serverName, slowLogQueryFilter))\n-      .map(CompletableFuture::join)\n-      .flatMap(List::stream)\n-      .collect(Collectors.toList()));\n+    if (slowLogQueryFilter.getType() == null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "351f16526e70e9a1d3ab8232c7d158d50b06699f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIxNTc0OA==", "bodyText": "nit: Helps to have a code comment about what a SLOW log is and what a LARGE log is..", "url": "https://github.com/apache/hbase/pull/1346#discussion_r401215748", "createdAt": "2020-03-31T21:07:16Z", "author": {"login": "bharathv"}, "path": "hbase-protocol-shaded/src/main/protobuf/TooSlowLog.proto", "diffHunk": "@@ -42,4 +42,12 @@ message SlowLogPayload {\n   optional int32 multi_gets = 12 [default = 0];\n   optional int32 multi_mutations = 13 [default = 0];\n   optional int32 multi_service_calls = 14 [default = 0];\n+  required Type type = 15;\n+\n+  enum Type {\n+    SLOW_LOG = 0;\n+    LARGE_LOG = 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "351f16526e70e9a1d3ab8232c7d158d50b06699f"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTIxNjY0MA==", "bodyText": "same question as above.. we can get rid of this one, right? (I thought that was our discussion in the PR earlier).", "url": "https://github.com/apache/hbase/pull/1346#discussion_r401216640", "createdAt": "2020-03-31T21:08:55Z", "author": {"login": "bharathv"}, "path": "hbase-protocol-shaded/src/main/protobuf/Admin.proto", "diffHunk": "@@ -369,6 +369,9 @@ service AdminService {\n   rpc GetSlowLogResponses(SlowLogResponseRequest)\n     returns(SlowLogResponses);\n \n+  rpc GetLargeLogResponses(SlowLogResponseRequest)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "351f16526e70e9a1d3ab8232c7d158d50b06699f"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68ae48b7366f7e3ebe5b7b3276cc6c31a6c30a71", "author": {"user": {"login": "virajjasani", "name": "Viraj Jasani"}}, "url": "https://github.com/apache/hbase/commit/68ae48b7366f7e3ebe5b7b3276cc6c31a6c30a71", "committedDate": "2020-04-01T10:12:53Z", "message": "comment for enum, refactor SlowLogQueryFilter -> LogQueryFilter & SlowLogRecord -> OnlineLogRecord"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7938dbe8f98751f78f2733c055e27c134c386d53", "author": {"user": {"login": "virajjasani", "name": "Viraj Jasani"}}, "url": "https://github.com/apache/hbase/commit/7938dbe8f98751f78f2733c055e27c134c386d53", "committedDate": "2020-04-01T10:38:48Z", "message": "thrift bug fix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2478, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}