{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4MjQxMjUz", "number": 1955, "title": "HBASE-24616 Remove BoundedRecoveredHFilesOutputSink dependency on a T\u2026", "bodyText": "\u2026ableDescriptor\nLogging cleanup.\nhbase-server/src/main/java/org/apache/hadoop/hbase/wal/BoundedRecoveredHFilesOutputSink.java\nUndo fetching Table Descriptor. Not reliably available at recovery time.", "createdAt": "2020-06-23T00:16:34Z", "url": "https://github.com/apache/hbase/pull/1955", "merged": true, "mergeCommit": {"oid": "e6639f9d4e8b5824f11f61bcaf62458ab6c06ede"}, "closed": true, "closedAt": "2020-06-25T18:45:07Z", "author": {"login": "saintstack"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABct88rHgFqTQzNTQxNTgyMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuQ7ixgFqTQzNjI4ODc2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NDE1ODIy", "url": "https://github.com/apache/hbase/pull/1955#pullrequestreview-435415822", "createdAt": "2020-06-23T03:33:14Z", "commit": {"oid": "5b676884cf4b91e040adf30c8abf7629671cb846"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwMzozMzoxNFrOGnYDvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwMzozMzoxNFrOGnYDvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk0MTgyMA==", "bodyText": "Move the log out of the if {} code block?", "url": "https://github.com/apache/hbase/pull/1955#discussion_r443941820", "createdAt": "2020-06-23T03:33:14Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegionServer.java", "diffHunk": "@@ -2037,8 +2037,7 @@ private void startServices() throws IOException {\n       this.splitLogWorker = new SplitLogWorker(sinkConf, this,\n           this, walFactory);\n       splitLogWorker.start();\n-    } else {\n-      LOG.warn(\"SplitLogWorker Service NOT started; CoordinatedStateManager is null\");\n+      LOG.debug(\"SplitLogWorker started\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b676884cf4b91e040adf30c8abf7629671cb846"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NDE2MTM0", "url": "https://github.com/apache/hbase/pull/1955#pullrequestreview-435416134", "createdAt": "2020-06-23T03:34:25Z", "commit": {"oid": "5b676884cf4b91e040adf30c8abf7629671cb846"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwMzozNDoyNlrOGnYEtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwMzozNDoyNlrOGnYEtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk0MjA2OQ==", "bodyText": "This log is too little?", "url": "https://github.com/apache/hbase/pull/1955#discussion_r443942069", "createdAt": "2020-06-23T03:34:26Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/handler/RSProcedureHandler.java", "diffHunk": "@@ -48,7 +48,7 @@ public void process() {\n     try {\n       callable.call();\n     } catch (Throwable t) {\n-      LOG.error(\"Error when call RSProcedureCallable: \", t);\n+      LOG.error(\"pid=\" + this.procId, t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b676884cf4b91e040adf30c8abf7629671cb846"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NDE2NTUw", "url": "https://github.com/apache/hbase/pull/1955#pullrequestreview-435416550", "createdAt": "2020-06-23T03:35:53Z", "commit": {"oid": "5b676884cf4b91e040adf30c8abf7629671cb846"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwMzozNTo1M1rOGnYGJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwMzozNTo1M1rOGnYGJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk0MjQzNg==", "bodyText": "The tableDescriptors may be removed from WalSplitter, too?", "url": "https://github.com/apache/hbase/pull/1955#discussion_r443942436", "createdAt": "2020-06-23T03:35:53Z", "author": {"login": "infraio"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/wal/BoundedRecoveredHFilesOutputSink.java", "diffHunk": "@@ -191,50 +186,22 @@ public boolean keepRegionEvent(Entry entry) {\n     return false;\n   }\n \n+  /**\n+   * @return Returns a base HFile without compressions or encodings; good enough for recovery\n+   *   given hfile has metadata on how it was written.\n+   */\n   private StoreFileWriter createRecoveredHFileWriter(TableName tableName, String regionName,\n       long seqId, String familyName, boolean isMetaTable) throws IOException {\n     Path outputDir = WALSplitUtil.tryCreateRecoveredHFilesDir(walSplitter.rootFS, walSplitter.conf,\n       tableName, regionName, familyName);\n     StoreFileWriter.Builder writerBuilder =\n         new StoreFileWriter.Builder(walSplitter.conf, CacheConfig.DISABLED, walSplitter.rootFS)\n             .withOutputDir(outputDir);\n-\n-    TableDescriptor tableDesc =\n-        tableDescCache.computeIfAbsent(tableName, t -> getTableDescriptor(t));\n-    if (tableDesc == null) {\n-      throw new IOException(\"Failed to get table descriptor for table \" + tableName);\n-    }\n-    ColumnFamilyDescriptor cfd = tableDesc.getColumnFamily(Bytes.toBytesBinary(familyName));\n-    HFileContext hFileContext = createFileContext(cfd, isMetaTable);\n-    return writerBuilder.withFileContext(hFileContext).withBloomType(cfd.getBloomFilterType())\n-        .build();\n-  }\n-\n-  private HFileContext createFileContext(ColumnFamilyDescriptor cfd, boolean isMetaTable)\n-      throws IOException {\n-    return new HFileContextBuilder().withCompression(cfd.getCompressionType())\n-        .withChecksumType(HStore.getChecksumType(walSplitter.conf))\n-        .withBytesPerCheckSum(HStore.getBytesPerChecksum(walSplitter.conf))\n-        .withBlockSize(cfd.getBlocksize()).withCompressTags(cfd.isCompressTags())\n-        .withDataBlockEncoding(cfd.getDataBlockEncoding()).withCellComparator(\n-          isMetaTable ? CellComparatorImpl.META_COMPARATOR : CellComparatorImpl.COMPARATOR)\n-        .build();\n-  }\n-\n-  private TableDescriptor getTableDescriptor(TableName tableName) {\n-    if (walSplitter.rsServices != null) {\n-      try {\n-        return walSplitter.rsServices.getConnection().getAdmin().getDescriptor(tableName);\n-      } catch (IOException e) {\n-        LOG.warn(\"Failed to get table descriptor for {}\", tableName, e);\n-      }\n-    }\n-    LOG.info(\"Failed getting {} table descriptor from master; trying local\", tableName);\n-    try {\n-      return walSplitter.tableDescriptors.get(tableName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b676884cf4b91e040adf30c8abf7629671cb846"}, "originalPosition": 71}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NDIxNzAz", "url": "https://github.com/apache/hbase/pull/1955#pullrequestreview-435421703", "createdAt": "2020-06-23T03:55:39Z", "commit": {"oid": "5b676884cf4b91e040adf30c8abf7629671cb846"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwMzo1NTozOVrOGnYW-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwMzo1NTozOVrOGnYW-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzk0Njc0Nw==", "bodyText": "Should we try to get the TableDescriptor first? If it is not possible, then we fallback to write generic HFiles.", "url": "https://github.com/apache/hbase/pull/1955#discussion_r443946747", "createdAt": "2020-06-23T03:55:39Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/wal/BoundedRecoveredHFilesOutputSink.java", "diffHunk": "@@ -191,50 +186,22 @@ public boolean keepRegionEvent(Entry entry) {\n     return false;\n   }\n \n+  /**\n+   * @return Returns a base HFile without compressions or encodings; good enough for recovery", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b676884cf4b91e040adf30c8abf7629671cb846"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47f7dabcf2fce5a2a09a28e9272c4e03cbe6f29f", "author": {"user": {"login": "saintstack", "name": "Michael Stack"}}, "url": "https://github.com/apache/hbase/commit/47f7dabcf2fce5a2a09a28e9272c4e03cbe6f29f", "committedDate": "2020-06-23T17:32:55Z", "message": "HBASE-24616 Remove BoundedRecoveredHFilesOutputSink dependency on a TableDescriptor\n\nPurge query Master for table descriptors; make do w/ generic options.\n\nLogging cleanup.\n\nhbase-server/src/main/java/org/apache/hadoop/hbase/wal/BoundedRecoveredHFilesOutputSink.java\n Undo fetching Table Descriptor. Not reliably available at recovery time."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b676884cf4b91e040adf30c8abf7629671cb846", "author": {"user": {"login": "saintstack", "name": "Michael Stack"}}, "url": "https://github.com/apache/hbase/commit/5b676884cf4b91e040adf30c8abf7629671cb846", "committedDate": "2020-06-23T00:12:00Z", "message": "HBASE-24616 Remove BoundedRecoveredHFilesOutputSink dependency on a TableDescriptor\n\nLogging cleanup.\n\nhbase-server/src/main/java/org/apache/hadoop/hbase/wal/BoundedRecoveredHFilesOutputSink.java\n Undo fetching Table Descriptor. Not reliably available at recovery time."}, "afterCommit": {"oid": "47f7dabcf2fce5a2a09a28e9272c4e03cbe6f29f", "author": {"user": {"login": "saintstack", "name": "Michael Stack"}}, "url": "https://github.com/apache/hbase/commit/47f7dabcf2fce5a2a09a28e9272c4e03cbe6f29f", "committedDate": "2020-06-23T17:32:55Z", "message": "HBASE-24616 Remove BoundedRecoveredHFilesOutputSink dependency on a TableDescriptor\n\nPurge query Master for table descriptors; make do w/ generic options.\n\nLogging cleanup.\n\nhbase-server/src/main/java/org/apache/hadoop/hbase/wal/BoundedRecoveredHFilesOutputSink.java\n Undo fetching Table Descriptor. Not reliably available at recovery time."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2Mjg4NzYz", "url": "https://github.com/apache/hbase/pull/1955#pullrequestreview-436288763", "createdAt": "2020-06-24T02:50:07Z", "commit": {"oid": "47f7dabcf2fce5a2a09a28e9272c4e03cbe6f29f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4390, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}