{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwOTI2ODgz", "number": 1990, "title": "HBASE-24648 Remove the legacy 'forceSplit' related code at region ser\u2026", "bodyText": "\u2026ver side", "createdAt": "2020-06-27T15:36:26Z", "url": "https://github.com/apache/hbase/pull/1990", "merged": true, "mergeCommit": {"oid": "37b863bd0b02f677ca536f3b7989600bc6fa1bc3"}, "closed": true, "closedAt": "2020-06-29T14:50:43Z", "author": {"login": "Apache9"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvosYUAFqTQzODc1NzQyMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcv8L8EAFqTQzODk2MDkwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NzU3NDIx", "url": "https://github.com/apache/hbase/pull/1990#pullrequestreview-438757421", "createdAt": "2020-06-28T08:31:32Z", "commit": {"oid": "4f9abeeba9d17bdd1d417513ac3010ed40241b83"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQwODozMTozMlrOGp7f4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOFQwOTowNDozNFrOGp7vOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYxOTYxOQ==", "bodyText": "Seems unintentional change?", "url": "https://github.com/apache/hbase/pull/1990#discussion_r446619619", "createdAt": "2020-06-28T08:31:32Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/SplitTableRegionProcedure.java", "diffHunk": "@@ -167,12 +167,15 @@ public RegionInfo getDaughterTwoRI() {\n     return daughterTwoRI;\n   }\n \n+  private boolean hasBestSplitRow() {\n+    return bestSplitRow != null && bestSplitRow.length > 0;\n+  }\n+\n   /**\n    * Check whether the region is splittable\n    * @param env MasterProcedureEnv\n    * @param regionToSplit parent Region to be split\n    * @param splitRow if splitRow is not specified, will first try to get bestSplitRow from RS\n-   * @throws IOException", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f9abeeba9d17bdd1d417513ac3010ed40241b83"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYyMDI0MQ==", "bodyText": "Good to log node.getRegionInfo().getRegionNameAsString() as well as node.getRegionLocation() with this line?", "url": "https://github.com/apache/hbase/pull/1990#discussion_r446620241", "createdAt": "2020-06-28T08:37:41Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/master/assignment/SplitTableRegionProcedure.java", "diffHunk": "@@ -187,19 +190,19 @@ private void checkSplittable(final MasterProcedureEnv env,\n     boolean splittable = false;\n     if (node != null) {\n       try {\n-        if (bestSplitRow == null || bestSplitRow.length == 0) {\n+        GetRegionInfoResponse response;\n+        if (!hasBestSplitRow()) {\n           LOG\n             .info(\"splitKey isn't explicitly specified, will try to find a best split key from RS\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f9abeeba9d17bdd1d417513ac3010ed40241b83"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYyMDc3MA==", "bodyText": "Better to return Optional.empty()", "url": "https://github.com/apache/hbase/pull/1990#discussion_r446620770", "createdAt": "2020-06-28T08:42:29Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/HRegion.java", "diffHunk": "@@ -8537,49 +8535,25 @@ public void run(Message message) {\n     return responseBuilder.build();\n   }\n \n-  boolean shouldForceSplit() {\n-    return this.splitRequest;\n-  }\n-\n-  byte[] getExplicitSplitPoint() {\n-    return this.explicitSplitPoint;\n-  }\n-\n-  void forceSplit(byte[] sp) {\n-    // This HRegion will go away after the forced split is successful\n-    // But if a forced split fails, we need to clear forced split.\n-    this.splitRequest = true;\n-    if (sp != null) {\n-      this.explicitSplitPoint = sp;\n-    }\n-  }\n-\n-  void clearSplit() {\n-    this.splitRequest = false;\n-    this.explicitSplitPoint = null;\n+  public Optional<byte[]> checkSplit() {\n+    return checkSplit(false);\n   }\n \n   /**\n-   * Return the splitpoint. null indicates the region isn't splittable\n-   * If the splitpoint isn't explicitly specified, it will go over the stores\n-   * to find the best splitpoint. Currently the criteria of best splitpoint\n-   * is based on the size of the store.\n+   * Return the split point. An empty result indicates the region isn't splittable.\n    */\n-  public byte[] checkSplit() {\n+  public Optional<byte[]> checkSplit(boolean force) {\n     // Can't split META\n     if (this.getRegionInfo().isMetaRegion()) {\n-      if (shouldForceSplit()) {\n-        LOG.warn(\"Cannot split meta region in HBase 0.20 and above\");\n-      }\n-      return null;\n+      return Optional.empty();\n     }\n \n     // Can't split a region that is closing.\n     if (this.isClosing()) {\n-      return null;\n+      return Optional.empty();\n     }\n \n-    if (!splitPolicy.shouldSplit()) {\n+    if (!force && !splitPolicy.shouldSplit()) {\n       return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f9abeeba9d17bdd1d417513ac3010ed40241b83"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjYyMzU0NQ==", "bodyText": "After this change, region.getSplitPolicy() is no longer read by source code, only test code. If test code can get splitPolicy using reflection, maybe we can remove getSplitPolicy() from HRegion. Anyways, not a strong preference w.r.t this PR, we are good.", "url": "https://github.com/apache/hbase/pull/1990#discussion_r446623545", "createdAt": "2020-06-28T09:04:34Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/RSRpcServices.java", "diffHunk": "@@ -1837,35 +1837,30 @@ public GetOnlineRegionResponse getOnlineRegion(final RpcController controller,\n   @Override\n   @QosPriority(priority=HConstants.ADMIN_QOS)\n   public GetRegionInfoResponse getRegionInfo(final RpcController controller,\n-      final GetRegionInfoRequest request) throws ServiceException {\n+    final GetRegionInfoRequest request) throws ServiceException {\n     try {\n       checkOpen();\n       requestCount.increment();\n       HRegion region = getRegion(request.getRegion());\n       RegionInfo info = region.getRegionInfo();\n-      byte[] bestSplitRow = null;\n-      boolean shouldSplit = true;\n+      byte[] bestSplitRow;\n       if (request.hasBestSplitRow() && request.getBestSplitRow()) {\n-        HRegion r = region;\n-        region.startRegionOperation(Operation.SPLIT_REGION);\n-        r.forceSplit(null);\n-        // Even after setting force split if split policy says no to split then we should not split.\n-        shouldSplit = region.getSplitPolicy().shouldSplit() && !info.isMetaRegion();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f9abeeba9d17bdd1d417513ac3010ed40241b83"}, "originalPosition": 19}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4f9abeeba9d17bdd1d417513ac3010ed40241b83", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/4f9abeeba9d17bdd1d417513ac3010ed40241b83", "committedDate": "2020-06-27T15:35:45Z", "message": "HBASE-24648 Remove the legacy 'forceSplit' related code at region server side"}, "afterCommit": {"oid": "1445121616f5242041889cf18d2e530a6fdc57ea", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/1445121616f5242041889cf18d2e530a6fdc57ea", "committedDate": "2020-06-28T16:17:41Z", "message": "HBASE-24648 Remove the legacy 'forceSplit' related code at region server side"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78a62858cb9e3a6be7794bd6d2ca270dbd2e1e73", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/78a62858cb9e3a6be7794bd6d2ca270dbd2e1e73", "committedDate": "2020-06-29T02:09:34Z", "message": "HBASE-24648 Remove the legacy 'forceSplit' related code at region server side"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1445121616f5242041889cf18d2e530a6fdc57ea", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/1445121616f5242041889cf18d2e530a6fdc57ea", "committedDate": "2020-06-28T16:17:41Z", "message": "HBASE-24648 Remove the legacy 'forceSplit' related code at region server side"}, "afterCommit": {"oid": "78a62858cb9e3a6be7794bd6d2ca270dbd2e1e73", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/78a62858cb9e3a6be7794bd6d2ca270dbd2e1e73", "committedDate": "2020-06-29T02:09:34Z", "message": "HBASE-24648 Remove the legacy 'forceSplit' related code at region server side"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9fc06f9ae0747b7f4e97b567c68214a6978b4d2", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/d9fc06f9ae0747b7f4e97b567c68214a6978b4d2", "committedDate": "2020-06-29T03:11:46Z", "message": "fix checkstyle warning"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4OTYwOTA5", "url": "https://github.com/apache/hbase/pull/1990#pullrequestreview-438960909", "createdAt": "2020-06-29T07:47:52Z", "commit": {"oid": "d9fc06f9ae0747b7f4e97b567c68214a6978b4d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4418, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}