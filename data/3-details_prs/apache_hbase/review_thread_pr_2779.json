{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5OTY4MTQ5", "number": 2779, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwNzozNzoxOVrOFMBluQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwNzozNzoxOVrOFMBluQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ4MTUzMjczOnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/master/ReplicationLogCleaner.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwNzozNzoxOVrOIPh60g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wN1QwODoyMDozNlrOIPi9IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE1NTI4Mg==", "bodyText": "Better set this flag to true by default, and in the below if (zkw == null), set it to false. Without any other assumptions, it is possible that HMaster.getZooKeeper returns null and we will create a new ZKWatcher but shareZK is false then we will not close it...", "url": "https://github.com/apache/hbase/pull/2779#discussion_r553155282", "createdAt": "2021-01-07T07:37:19Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/master/ReplicationLogCleaner.java", "diffHunk": "@@ -92,12 +96,20 @@ public boolean apply(FileStatus file) {\n   }\n \n   @Override\n-  public void setConf(Configuration config) {\n-    // Make my own Configuration.  Then I'll have my own connection to zk that\n-    // I can close myself when comes time.\n-    Configuration conf = new Configuration(config);\n+  public void init(Map<String, Object> params) {\n+    super.init(params);\n     try {\n-      setConf(conf, new ZKWatcher(conf, \"replicationLogCleaner\", null));\n+      if (MapUtils.isNotEmpty(params)) {\n+        Object master = params.get(HMaster.MASTER);\n+        if (master != null && master instanceof HMaster) {\n+          zkw = ((HMaster) master).getZooKeeper();\n+          shareZK = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "151101e8db9468420f521f892c0b07cb089ef365"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE3MjI1Nw==", "bodyText": "yes\uff0cit is better. But it is impossible that HMaster.getZooKeeper returns null\uff0cand if zk of hmaster is null, master must be abort.", "url": "https://github.com/apache/hbase/pull/2779#discussion_r553172257", "createdAt": "2021-01-07T08:20:36Z", "author": {"login": "cuibo01"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/master/ReplicationLogCleaner.java", "diffHunk": "@@ -92,12 +96,20 @@ public boolean apply(FileStatus file) {\n   }\n \n   @Override\n-  public void setConf(Configuration config) {\n-    // Make my own Configuration.  Then I'll have my own connection to zk that\n-    // I can close myself when comes time.\n-    Configuration conf = new Configuration(config);\n+  public void init(Map<String, Object> params) {\n+    super.init(params);\n     try {\n-      setConf(conf, new ZKWatcher(conf, \"replicationLogCleaner\", null));\n+      if (MapUtils.isNotEmpty(params)) {\n+        Object master = params.get(HMaster.MASTER);\n+        if (master != null && master instanceof HMaster) {\n+          zkw = ((HMaster) master).getZooKeeper();\n+          shareZK = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzE1NTI4Mg=="}, "originalCommit": {"oid": "151101e8db9468420f521f892c0b07cb089ef365"}, "originalPosition": 46}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2238, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}