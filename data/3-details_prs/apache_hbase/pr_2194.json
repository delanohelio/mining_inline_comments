{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyNzE1MDQ5", "number": 2194, "title": "HBASE-24849 Branch-1 Backport : HBASE-24665 MultiWAL : Avoid rolling of ALL WALs when one of the WAL needs a roll", "bodyText": "", "createdAt": "2020-08-04T11:47:46Z", "url": "https://github.com/apache/hbase/pull/2194", "merged": true, "mergeCommit": {"oid": "e06695112a358706344cc8682f2713b43daab340"}, "closed": true, "closedAt": "2020-10-16T12:42:19Z", "author": {"login": "WenFeiYi"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc4_CVygH2gAyNDYyNzE1MDQ5OmViMDI3ZDQ4MzBhYTYzZDM1NzliY2QxMzNiMmExOGM4NjBiY2NkY2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdTCQfSgH2gAyNDYyNzE1MDQ5OmFlNDUyMTA1ZWNmMmIyNDUyNGE1NDQxNGE4NGUzNjJhZGNmMTg5NDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "eb027d4830aa63d3579bcd133b2a18c860bccdcf", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/eb027d4830aa63d3579bcd133b2a18c860bccdcf", "committedDate": "2020-07-27T10:12:25Z", "message": "HBASE-24665"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c68eeba5f8bfc0390bf5f0d54763e8446447e995", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/c68eeba5f8bfc0390bf5f0d54763e8446447e995", "committedDate": "2020-08-04T11:44:27Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32e723d06195332fb00a5abcdce6d94d43f6b716", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/32e723d06195332fb00a5abcdce6d94d43f6b716", "committedDate": "2020-08-07T01:52:01Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e38b0de5ecd821a60a3e3fd124289a479651019", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/4e38b0de5ecd821a60a3e3fd124289a479651019", "committedDate": "2020-08-07T06:49:59Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12c5b196c7d7ad48268bf95fe60cbacd6cd823ca", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/12c5b196c7d7ad48268bf95fe60cbacd6cd823ca", "committedDate": "2020-08-10T02:30:04Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cc0dbff4ceded376d99b4d0f2d5b3a0e511bd05", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/7cc0dbff4ceded376d99b4d0f2d5b3a0e511bd05", "committedDate": "2020-08-10T06:29:29Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MTYwMDc4", "url": "https://github.com/apache/hbase/pull/2194#pullrequestreview-464160078", "createdAt": "2020-08-10T11:48:45Z", "commit": {"oid": "7cc0dbff4ceded376d99b4d0f2d5b3a0e511bd05"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMTo0ODo0NVrOG-LTzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMTo1MDo0NFrOG-LXRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg1MDE5MA==", "bodyText": "This is not as per other branch patches. Why?", "url": "https://github.com/apache/hbase/pull/2194#discussion_r467850190", "createdAt": "2020-08-10T11:48:45Z", "author": {"login": "anoopsjohn"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/LogRoller.java", "diffHunk": "@@ -229,11 +244,52 @@ private void scheduleFlush(final byte [] encodedRegionName) {\n    */\n   @VisibleForTesting\n   public boolean walRollFinished() {\n-    for (boolean needRoll : walNeedsRoll.values()) {\n-      if (needRoll) {\n+    long now = System.currentTimeMillis();\n+    for (RollController controller : wals.values()) {\n+      if (controller.needsRoll(now)) {\n         return false;\n       }\n     }\n     return true;\n   }\n+\n+\n+  /**\n+   * Independently control the roll of each wal. When use multiwal,\n+   * can avoid all wal roll together. see HBASE-24665 for detail\n+   */\n+  protected class RollController {\n+    private final WAL wal;\n+    private final AtomicBoolean rollRequest;\n+    private long lastRollTime;\n+\n+    RollController(WAL wal) {\n+      this.wal = wal;\n+      this.rollRequest = new AtomicBoolean(false);\n+      this.lastRollTime = System.currentTimeMillis();\n+    }\n+\n+    public void requestRoll() {\n+      this.rollRequest.set(true);\n+    }\n+\n+    public byte[][] rollWal(long now) throws IOException {\n+      this.lastRollTime = now;\n+      byte[][] regionsToFlush = wal.rollWriter(true);\n+      this.rollRequest.set(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cc0dbff4ceded376d99b4d0f2d5b3a0e511bd05"}, "originalPosition": 163}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg1MDYzOQ==", "bodyText": "This logic is not same as per branch-2 patches.  What is different here? why?", "url": "https://github.com/apache/hbase/pull/2194#discussion_r467850639", "createdAt": "2020-08-10T11:49:49Z", "author": {"login": "anoopsjohn"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/LogRoller.java", "diffHunk": "@@ -141,9 +150,14 @@ public void run() {\n     while (!server.isStopped()) {\n       long now = System.currentTimeMillis();\n       checkLowReplication(now);\n-      boolean periodic = false;\n       if (!rollLog.get()) {\n-        periodic = (now - this.lastrolltime) > this.rollperiod;\n+        boolean periodic = false;\n+        for (RollController controller : wals.values()) {\n+          if (controller.needsPeriodicRoll(now)) {\n+            periodic = true;\n+            break;\n+          }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cc0dbff4ceded376d99b4d0f2d5b3a0e511bd05"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg1MTA3OA==", "bodyText": "I see.. because of jdk 1.7 support, we have to use this way and that is what Findbugs complain.", "url": "https://github.com/apache/hbase/pull/2194#discussion_r467851078", "createdAt": "2020-08-10T11:50:44Z", "author": {"login": "anoopsjohn"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/LogRoller.java", "diffHunk": "@@ -56,23 +56,32 @@\n   private static final Log LOG = LogFactory.getLog(LogRoller.class);\n   private final ReentrantLock rollLock = new ReentrantLock();\n   private final AtomicBoolean rollLog = new AtomicBoolean(false);\n-  private final ConcurrentHashMap<WAL, Boolean> walNeedsRoll =\n-      new ConcurrentHashMap<WAL, Boolean>();\n+  private final ConcurrentHashMap<WAL, RollController> wals =\n+      new ConcurrentHashMap<WAL, RollController>();\n   private final Server server;\n   protected final RegionServerServices services;\n-  private volatile long lastrolltime = System.currentTimeMillis();\n   // Period to roll log.\n-  private final long rollperiod;\n+  private final long rollPeriod;\n   private final int threadWakeFrequency;\n   // The interval to check low replication on hlog's pipeline\n-  private long checkLowReplicationInterval;\n+  private final long checkLowReplicationInterval;\n \n   public void addWAL(final WAL wal) {\n-    if (null == walNeedsRoll.putIfAbsent(wal, Boolean.FALSE)) {\n+    if (null == wals.putIfAbsent(wal, new RollController(wal))) {\n       wal.registerWALActionsListener(new WALActionsListener.Base() {\n         @Override\n         public void logRollRequested(WALActionsListener.RollRequestReason reason) {\n-          walNeedsRoll.put(wal, Boolean.TRUE);\n+          RollController controller = wals.get(wal);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cc0dbff4ceded376d99b4d0f2d5b3a0e511bd05"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4MDk2Njc3", "url": "https://github.com/apache/hbase/pull/2194#pullrequestreview-498096677", "createdAt": "2020-09-29T05:01:12Z", "commit": {"oid": "7cc0dbff4ceded376d99b4d0f2d5b3a0e511bd05"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cff4dc111ca37a1bf63e328a74d487605ff8b82e", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/cff4dc111ca37a1bf63e328a74d487605ff8b82e", "committedDate": "2020-09-29T07:09:12Z", "message": "HBASE-24665"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f3e7f99da0798866d39adf2f19ac95c2c750826", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/5f3e7f99da0798866d39adf2f19ac95c2c750826", "committedDate": "2020-10-15T05:59:11Z", "message": "fix findBugs warning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f05444091cdfa0419cd01887b130957411eb8f28", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/f05444091cdfa0419cd01887b130957411eb8f28", "committedDate": "2020-10-15T09:51:12Z", "message": "fix findBugs warning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae452105ecf2b24524a54414a84e362adcf18943", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/ae452105ecf2b24524a54414a84e362adcf18943", "committedDate": "2020-10-16T08:39:37Z", "message": "fix findbugs warning"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4157, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}