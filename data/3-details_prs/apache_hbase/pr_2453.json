{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyMzQ3Mjc0", "number": 2453, "title": "HBASE-24813 ReplicationSource should clear buffer usage on Replicatio\u2026", "bodyText": "Branch-2 compatible PR, after cherry-picking and resolving conflicts", "createdAt": "2020-09-24T10:29:49Z", "url": "https://github.com/apache/hbase/pull/2453", "merged": true, "mergeCommit": {"oid": "dedb630da04305e5b90dacf8406fc2a92be2882e"}, "closed": true, "closedAt": "2020-10-01T07:03:47Z", "author": {"login": "wchevreuil"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdL-mVJgH2gAyNDkyMzQ3Mjc0OmNjMTk1YTZkNTEyZWZiZGVlNzZmNjhlYjcwZTE0NWU5Nzk0OTI5NWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdN_ZNGAH2gAyNDkyMzQ3Mjc0OjIxMTRkMjY5OGI3YTJkYzk5YTBmM2U4NDQ5N2M4M2NkZmY0ZTVmMzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cc195a6d512efbdee76f68eb70e145e97949295f", "author": {"user": {"login": "wchevreuil", "name": "Wellington Ramos Chevreuil"}}, "url": "https://github.com/apache/hbase/commit/cc195a6d512efbdee76f68eb70e145e97949295f", "committedDate": "2020-09-24T10:26:23Z", "message": "HBASE-24813 ReplicationSource should clear buffer usage on ReplicationSourceManager upon termination"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4ODg1NTgz", "url": "https://github.com/apache/hbase/pull/2453#pullrequestreview-498885583", "createdAt": "2020-09-29T20:55:20Z", "commit": {"oid": "cc195a6d512efbdee76f68eb70e145e97949295f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQyMDo1NToyMVrOHaBfHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQyMDo1NToyMVrOHaBfHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA0OTM3Mw==", "bodyText": "this should be using the environment to get the time I think? or is there not one accessible from here?", "url": "https://github.com/apache/hbase/pull/2453#discussion_r497049373", "createdAt": "2020-09-29T20:55:21Z", "author": {"login": "busbey"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceShipper.java", "diffHunk": "@@ -331,4 +333,53 @@ public boolean sleepForRetries(String msg, int sleepMultiplier) {\n     }\n     return sleepMultiplier < maxRetriesMultiplier;\n   }\n+\n+  /**\n+   * Attempts to properly update <code>ReplicationSourceManager.totalBufferUser</code>,\n+   * in case there were unprocessed entries batched by the reader to the shipper,\n+   * but the shipper didn't manage to ship those because the replication source is being terminated.\n+   * In that case, it iterates through the batched entries and decrease the pending\n+   * entries size from <code>ReplicationSourceManager.totalBufferUser</code>\n+   * <p/>\n+   * <b>NOTES</b>\n+   * 1) This method should only be called upon replication source termination.\n+   * It blocks waiting for both shipper and reader threads termination,\n+   * to make sure no race conditions\n+   * when updating <code>ReplicationSourceManager.totalBufferUser</code>.\n+   *\n+   * 2) It <b>does not</b> attempt to terminate reader and shipper threads. Those <b>must</b>\n+   * have been triggered interruption/termination prior to calling this method.\n+   */\n+  void clearWALEntryBatch() {\n+    long timeout = System.currentTimeMillis() + this.shipEditsTimeout;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc195a6d512efbdee76f68eb70e145e97949295f"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b7d80f2b9d6fd32bdba3ef4964a3bd4da815ddd", "author": {"user": {"login": "wchevreuil", "name": "Wellington Ramos Chevreuil"}}, "url": "https://github.com/apache/hbase/commit/7b7d80f2b9d6fd32bdba3ef4964a3bd4da815ddd", "committedDate": "2020-09-30T15:21:59Z", "message": "Addressing latest suggestion from Sean"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2114d2698b7a2dc99a0f3e84497c83cdff4e5f35", "author": {"user": {"login": "wchevreuil", "name": "Wellington Ramos Chevreuil"}}, "url": "https://github.com/apache/hbase/commit/2114d2698b7a2dc99a0f3e84497c83cdff4e5f35", "committedDate": "2020-09-30T16:29:48Z", "message": "Checkstyle"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4585, "cost": 1, "resetAt": "2021-10-28T16:48:13Z"}}}