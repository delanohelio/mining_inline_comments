{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0NjU3OTk3", "number": 2753, "title": "HBASE-25368 Filter out more invalid encoded name in isEncodedRegionNa\u2026", "bodyText": "\u2026me(byte[] regionName)\nThis addresses a few issues:\n\nIt fixes the issue that flush/compact/split from hbase shell cannot run with a table name length over 32 bytes.\nIt saves one query to registry when flush/compact/split a tablename as parameter.\n\nSigned-off-by: stack stack@apache.org", "createdAt": "2020-12-08T18:59:03Z", "url": "https://github.com/apache/hbase/pull/2753", "merged": true, "mergeCommit": {"oid": "c3276801256aa16a62e5cdba7a37d4e18d59e880"}, "closed": true, "closedAt": "2020-12-16T05:52:55Z", "author": {"login": "huaxiangsun"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkQHrzgFqTU0NzU5OTcxMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdk25a3ABqjQwOTYzNDIwMzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NTk5NzEy", "url": "https://github.com/apache/hbase/pull/2753#pullrequestreview-547599712", "createdAt": "2020-12-08T20:23:15Z", "commit": {"oid": "d4167a7292c7d249056fc7a1b721dca7f92ff12a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMDoyMzoxNVrOIB0ifg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMDoyNToxOVrOIB0nfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc4MDI4Ng==", "bodyText": "What are we protecting against? Could we be passed a tablename? If so, why can't we have a tablename that is an MD5? Or 32 bytes in size?  Should we check it is all hex at least? I suppose if someone passes a tablename that is an md5, then they are asking for trouble?", "url": "https://github.com/apache/hbase/pull/2753#discussion_r538780286", "createdAt": "2020-12-08T20:23:15Z", "author": {"login": "saintstack"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/RegionInfo.java", "diffHunk": "@@ -363,7 +363,23 @@ static TableName getTable(final byte [] regionName) {\n   @InterfaceAudience.Private // For use by internals only.\n   public static boolean isEncodedRegionName(byte[] regionName) {\n     // If not parseable as region name, presume encoded. TODO: add stringency; e.g. if hex.\n-    return parseRegionNameOrReturnNull(regionName) == null && regionName.length <= MD5_HEX_LENGTH;\n+    if (parseRegionNameOrReturnNull(regionName) == null) {\n+      if (regionName.length > MD5_HEX_LENGTH) {\n+        return false;\n+      } else if (regionName.length == MD5_HEX_LENGTH) {\n+        return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4167a7292c7d249056fc7a1b721dca7f92ff12a"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc4MTI0NA==", "bodyText": "We know the hbase:meta int. It does not change. Compare it? When meta splits, it will have md5 for new regions.", "url": "https://github.com/apache/hbase/pull/2753#discussion_r538781244", "createdAt": "2020-12-08T20:24:45Z", "author": {"login": "saintstack"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/RegionInfo.java", "diffHunk": "@@ -363,7 +363,23 @@ static TableName getTable(final byte [] regionName) {\n   @InterfaceAudience.Private // For use by internals only.\n   public static boolean isEncodedRegionName(byte[] regionName) {\n     // If not parseable as region name, presume encoded. TODO: add stringency; e.g. if hex.\n-    return parseRegionNameOrReturnNull(regionName) == null && regionName.length <= MD5_HEX_LENGTH;\n+    if (parseRegionNameOrReturnNull(regionName) == null) {\n+      if (regionName.length > MD5_HEX_LENGTH) {\n+        return false;\n+      } else if (regionName.length == MD5_HEX_LENGTH) {\n+        return true;\n+      } else {\n+        String encodedName = Bytes.toString(regionName);\n+        try {\n+          Integer.parseInt(encodedName);\n+          // If this is a valid integer, it could be hbase:meta's encoded region name.\n+          return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4167a7292c7d249056fc7a1b721dca7f92ff12a"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc4MTU2Nw==", "bodyText": "How about some tests for this change in this method?", "url": "https://github.com/apache/hbase/pull/2753#discussion_r538781567", "createdAt": "2020-12-08T20:25:19Z", "author": {"login": "saintstack"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/RegionInfo.java", "diffHunk": "@@ -363,7 +363,23 @@ static TableName getTable(final byte [] regionName) {\n   @InterfaceAudience.Private // For use by internals only.\n   public static boolean isEncodedRegionName(byte[] regionName) {\n     // If not parseable as region name, presume encoded. TODO: add stringency; e.g. if hex.\n-    return parseRegionNameOrReturnNull(regionName) == null && regionName.length <= MD5_HEX_LENGTH;\n+    if (parseRegionNameOrReturnNull(regionName) == null) {\n+      if (regionName.length > MD5_HEX_LENGTH) {\n+        return false;\n+      } else if (regionName.length == MD5_HEX_LENGTH) {\n+        return true;\n+      } else {\n+        String encodedName = Bytes.toString(regionName);\n+        try {\n+          Integer.parseInt(encodedName);\n+          // If this is a valid integer, it could be hbase:meta's encoded region name.\n+          return true;\n+        } catch(NumberFormatException er) {\n+          return false;\n+        }\n+      }\n+    }\n+    return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4167a7292c7d249056fc7a1b721dca7f92ff12a"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NTkwNjIw", "url": "https://github.com/apache/hbase/pull/2753#pullrequestreview-548590620", "createdAt": "2020-12-09T20:40:50Z", "commit": {"oid": "d4167a7292c7d249056fc7a1b721dca7f92ff12a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMDo0MDo1MFrOICog8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMDo0MDo1MFrOICog8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTYzMTg1OQ==", "bodyText": "Will remove these two lines, they are used for testing before the new test case.", "url": "https://github.com/apache/hbase/pull/2753#discussion_r539631859", "createdAt": "2020-12-09T20:40:50Z", "author": {"login": "huaxiangsun"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/client/TestAdmin1.java", "diffHunk": "@@ -116,6 +130,8 @@ public void testCompactionTimestamps() throws Exception {\n     assertEquals(0, ts);\n \n     ADMIN.flush(tableName);\n+    //ADMIN.majorCompactRegion(Bytes.toBytes(\"abcdefghijklmnopqrstuvwxyzabcdedgeghijklmnopqrs\"));\n+    ADMIN.majorCompactRegion(Bytes.toBytes(\"abcd\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4167a7292c7d249056fc7a1b721dca7f92ff12a"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4ODU1MzAy", "url": "https://github.com/apache/hbase/pull/2753#pullrequestreview-548855302", "createdAt": "2020-12-10T05:44:12Z", "commit": {"oid": "d4167a7292c7d249056fc7a1b721dca7f92ff12a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bf1fdefe5d47285833a96d7aa5ef778d5272483", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/2bf1fdefe5d47285833a96d7aa5ef778d5272483", "committedDate": "2020-12-10T17:34:54Z", "message": "HBASE-25368 Filter out more invalid encoded name in isEncodedRegionName(byte[] regionName)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d4167a7292c7d249056fc7a1b721dca7f92ff12a", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/d4167a7292c7d249056fc7a1b721dca7f92ff12a", "committedDate": "2020-12-08T18:56:36Z", "message": "HBASE-25368 Filter out more invalid encoded name in isEncodedRegionName(byte[] regionName)"}, "afterCommit": {"oid": "2bf1fdefe5d47285833a96d7aa5ef778d5272483", "author": {"user": null}, "url": "https://github.com/apache/hbase/commit/2bf1fdefe5d47285833a96d7aa5ef778d5272483", "committedDate": "2020-12-10T17:34:54Z", "message": "HBASE-25368 Filter out more invalid encoded name in isEncodedRegionName(byte[] regionName)"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1815, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}