{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3MzI3MzYx", "number": 2255, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMTo0NjoxOVrOEYBDAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNDo1Mjo1MlrOEbm4Ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzNjE4NDM0OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMTo0NjoxOVrOHAH62A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMTo0NjoxOVrOHAH62A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTg5MTgwMA==", "bodyText": "nit: redundant", "url": "https://github.com/apache/hbase/pull/2255#discussion_r469891800", "createdAt": "2020-08-13T11:46:19Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -35,6 +35,8 @@\n import java.util.concurrent.PriorityBlockingQueue;\n import java.util.concurrent.TimeUnit;\n import java.util.concurrent.TimeoutException;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicInteger;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a0adaf203d7a7b270a615882aadf4b365bde07b"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzNjE4NjUwOnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMTo0Njo1OFrOHAH8Hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMTo0Njo1OFrOHAH8Hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTg5MjEyNw==", "bodyText": "nit: final for both?", "url": "https://github.com/apache/hbase/pull/2255#discussion_r469892127", "createdAt": "2020-08-13T11:46:58Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -120,6 +122,13 @@\n   // ReplicationEndpoint which will handle the actual replication\n   private volatile ReplicationEndpoint replicationEndpoint;\n \n+  private AtomicBoolean retryStartup = new AtomicBoolean(false);\n+\n+  private AtomicBoolean startupOngoing = new AtomicBoolean(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a0adaf203d7a7b270a615882aadf4b365bde07b"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkzNjI2NzA2OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMjoxMDozMFrOHAIq0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNjo0MTozMlrOHA7YRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkwNDA4MQ==", "bodyText": "I hope if we encounter uncaughtException here, we want to retry the loop again.\nIf so, shall we also add startupOngoing.set(true); here explicitely? Just in case if it is set to false in initialize()?", "url": "https://github.com/apache/hbase/pull/2255#discussion_r469904081", "createdAt": "2020-08-13T12:10:30Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -583,16 +614,27 @@ private void initialize() {\n       PriorityBlockingQueue<Path> queue = entry.getValue();\n       tryStartNewShipper(walGroupId, queue);\n     }\n+    this.startupOngoing.set(false);\n   }\n \n   @Override\n   public void startup() {\n     // mark we are running now\n     this.sourceRunning = true;\n-    initThread = new Thread(this::initialize);\n-    Threads.setDaemonThreadRunning(initThread,\n-      Thread.currentThread().getName() + \".replicationSource,\" + this.queueId,\n-      this::uncaughtException);\n+    this.retryStartup.set(true);\n+    do {\n+      if(retryStartup.get()) {\n+        retryStartup.set(false);\n+        startupOngoing.set(true);\n+        initThread = new Thread(this::initialize);\n+        Threads.setDaemonThreadRunning(initThread,\n+          Thread.currentThread().getName() + \".replicationSource,\" + this.queueId,\n+          (t,e) -> {\n+          uncaughtException(t, e);\n+          retryStartup.set(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a0adaf203d7a7b270a615882aadf4b365bde07b"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ3NzgwNQ==", "bodyText": "I hope if we encounter uncaughtException here, we want to retry the loop again.\n\nYes, we want to keep trying until we succeed.\n\nIf so, shall we also add startupOngoing.set(true); here explicitely? Just in case if it is set to false in initialize()?\n\nThe only cases startupOngoing would had been set to false in  initialize is if it completes fine without any uncaught exception, so adding it here would be redundant.", "url": "https://github.com/apache/hbase/pull/2255#discussion_r470477805", "createdAt": "2020-08-14T08:14:55Z", "author": {"login": "wchevreuil"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -583,16 +614,27 @@ private void initialize() {\n       PriorityBlockingQueue<Path> queue = entry.getValue();\n       tryStartNewShipper(walGroupId, queue);\n     }\n+    this.startupOngoing.set(false);\n   }\n \n   @Override\n   public void startup() {\n     // mark we are running now\n     this.sourceRunning = true;\n-    initThread = new Thread(this::initialize);\n-    Threads.setDaemonThreadRunning(initThread,\n-      Thread.currentThread().getName() + \".replicationSource,\" + this.queueId,\n-      this::uncaughtException);\n+    this.retryStartup.set(true);\n+    do {\n+      if(retryStartup.get()) {\n+        retryStartup.set(false);\n+        startupOngoing.set(true);\n+        initThread = new Thread(this::initialize);\n+        Threads.setDaemonThreadRunning(initThread,\n+          Thread.currentThread().getName() + \".replicationSource,\" + this.queueId,\n+          (t,e) -> {\n+          uncaughtException(t, e);\n+          retryStartup.set(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkwNDA4MQ=="}, "originalCommit": {"oid": "5a0adaf203d7a7b270a615882aadf4b365bde07b"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQ4NTcwNg==", "bodyText": "Yeah right, it is not set to false if it completes successfully, anyone touching the same code in future should realize this.\nAlthough not a strong point but If you don't mind, maybe we can comment here indicating startupOngoing is expected to be true when we are here handling Exception.", "url": "https://github.com/apache/hbase/pull/2255#discussion_r470485706", "createdAt": "2020-08-14T08:31:32Z", "author": {"login": "virajjasani"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -583,16 +614,27 @@ private void initialize() {\n       PriorityBlockingQueue<Path> queue = entry.getValue();\n       tryStartNewShipper(walGroupId, queue);\n     }\n+    this.startupOngoing.set(false);\n   }\n \n   @Override\n   public void startup() {\n     // mark we are running now\n     this.sourceRunning = true;\n-    initThread = new Thread(this::initialize);\n-    Threads.setDaemonThreadRunning(initThread,\n-      Thread.currentThread().getName() + \".replicationSource,\" + this.queueId,\n-      this::uncaughtException);\n+    this.retryStartup.set(true);\n+    do {\n+      if(retryStartup.get()) {\n+        retryStartup.set(false);\n+        startupOngoing.set(true);\n+        initThread = new Thread(this::initialize);\n+        Threads.setDaemonThreadRunning(initThread,\n+          Thread.currentThread().getName() + \".replicationSource,\" + this.queueId,\n+          (t,e) -> {\n+          uncaughtException(t, e);\n+          retryStartup.set(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkwNDA4MQ=="}, "originalCommit": {"oid": "5a0adaf203d7a7b270a615882aadf4b365bde07b"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDczNDkxNg==", "bodyText": "Addressed the nits and added some comments to the two flags.", "url": "https://github.com/apache/hbase/pull/2255#discussion_r470734916", "createdAt": "2020-08-14T16:41:32Z", "author": {"login": "wchevreuil"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -583,16 +614,27 @@ private void initialize() {\n       PriorityBlockingQueue<Path> queue = entry.getValue();\n       tryStartNewShipper(walGroupId, queue);\n     }\n+    this.startupOngoing.set(false);\n   }\n \n   @Override\n   public void startup() {\n     // mark we are running now\n     this.sourceRunning = true;\n-    initThread = new Thread(this::initialize);\n-    Threads.setDaemonThreadRunning(initThread,\n-      Thread.currentThread().getName() + \".replicationSource,\" + this.queueId,\n-      this::uncaughtException);\n+    this.retryStartup.set(true);\n+    do {\n+      if(retryStartup.get()) {\n+        retryStartup.set(false);\n+        startupOngoing.set(true);\n+        initThread = new Thread(this::initialize);\n+        Threads.setDaemonThreadRunning(initThread,\n+          Thread.currentThread().getName() + \".replicationSource,\" + this.queueId,\n+          (t,e) -> {\n+          uncaughtException(t, e);\n+          retryStartup.set(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTkwNDA4MQ=="}, "originalCommit": {"oid": "5a0adaf203d7a7b270a615882aadf4b365bde07b"}, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NDMyNzQwOnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMzoxOTowNFrOHCvV0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMzoxOTowNFrOHCvV0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjYzNDgzNA==", "bodyText": "So here it is for wal reader. I think refreshSources and retry is an acceptable way. Then let's just test the abortOnError flag here? If it is true, we will call uncaughtException, otherwise we will try to refresh the replication source.", "url": "https://github.com/apache/hbase/pull/2255#discussion_r472634834", "createdAt": "2020-08-19T03:19:04Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -373,7 +389,21 @@ private void tryStartNewShipper(String walGroupId, PriorityBlockingQueue<Path> q\n         Threads.setDaemonThreadRunning(\n             walReader, Thread.currentThread().getName()\n                 + \".replicationSource.wal-reader.\" + walGroupId + \",\" + queueId,\n-            this::uncaughtException);\n+                (t,e) -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fb4dce7b7f52839ee3b142c621d50e7acb38052"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NDMzNzcyOnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceShipper.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMzoyMTo0NlrOHCvceQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjowNzowNVrOHFhY1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjYzNjUzNw==", "bodyText": "OK, the code is almost the same... Then I think we could move the logic into uncaughtException method? If abortOnError is true, we about, otherwise we will try to refresh the source.", "url": "https://github.com/apache/hbase/pull/2255#discussion_r472636537", "createdAt": "2020-08-19T03:21:46Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceShipper.java", "diffHunk": "@@ -290,7 +290,22 @@ private boolean updateLogPosition(WALEntryBatch batch) {\n   public void startup(UncaughtExceptionHandler handler) {\n     String name = Thread.currentThread().getName();\n     Threads.setDaemonThreadRunning(this,\n-      name + \".replicationSource.shipper\" + walGroupId + \",\" + source.getQueueId(), handler);\n+      name + \".replicationSource.shipper\" + walGroupId + \",\" + source.getQueueId(),\n+      (t,e) -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fb4dce7b7f52839ee3b142c621d50e7acb38052"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU1MTk1Ng==", "bodyText": "Moved it to uncaughtException. This is true when handling potential errors on both the reader and shipper threads, but uncaughtException is also used when handling issues from ReplicationSource.initialize method, which might blow before reader/shipper is even started. So needed to add extra check in uncaughtException to decide when to invoke refreshSources.", "url": "https://github.com/apache/hbase/pull/2255#discussion_r475551956", "createdAt": "2020-08-24T12:07:05Z", "author": {"login": "wchevreuil"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSourceShipper.java", "diffHunk": "@@ -290,7 +290,22 @@ private boolean updateLogPosition(WALEntryBatch batch) {\n   public void startup(UncaughtExceptionHandler handler) {\n     String name = Thread.currentThread().getName();\n     Threads.setDaemonThreadRunning(this,\n-      name + \".replicationSource.shipper\" + walGroupId + \",\" + source.getQueueId(), handler);\n+      name + \".replicationSource.shipper\" + walGroupId + \",\" + source.getQueueId(),\n+      (t,e) -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjYzNjUzNw=="}, "originalCommit": {"oid": "3fb4dce7b7f52839ee3b142c621d50e7acb38052"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NDM0MjIwOnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMzoyMjo1OFrOHCvffA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwODo0Mzo0OFrOHEjOig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjYzNzMwOA==", "bodyText": "This flag is only used in this method? Let's use a local var instead of a class member field?", "url": "https://github.com/apache/hbase/pull/2255#discussion_r472637308", "createdAt": "2020-08-19T03:22:58Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -583,16 +617,27 @@ private void initialize() {\n       PriorityBlockingQueue<Path> queue = entry.getValue();\n       tryStartNewShipper(walGroupId, queue);\n     }\n+    this.startupOngoing.set(false);\n   }\n \n   @Override\n   public void startup() {\n     // mark we are running now\n     this.sourceRunning = true;\n-    initThread = new Thread(this::initialize);\n-    Threads.setDaemonThreadRunning(initThread,\n-      Thread.currentThread().getName() + \".replicationSource,\" + this.queueId,\n-      this::uncaughtException);\n+    this.retryStartup.set(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fb4dce7b7f52839ee3b142c621d50e7acb38052"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDUzMzUxNA==", "bodyText": "Yeah, originally I was also referring it on uncaughtException, but it was not actually needed.", "url": "https://github.com/apache/hbase/pull/2255#discussion_r474533514", "createdAt": "2020-08-21T08:43:48Z", "author": {"login": "wchevreuil"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -583,16 +617,27 @@ private void initialize() {\n       PriorityBlockingQueue<Path> queue = entry.getValue();\n       tryStartNewShipper(walGroupId, queue);\n     }\n+    this.startupOngoing.set(false);\n   }\n \n   @Override\n   public void startup() {\n     // mark we are running now\n     this.sourceRunning = true;\n-    initThread = new Thread(this::initialize);\n-    Threads.setDaemonThreadRunning(initThread,\n-      Thread.currentThread().getName() + \".replicationSource,\" + this.queueId,\n-      this::uncaughtException);\n+    this.retryStartup.set(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjYzNzMwOA=="}, "originalCommit": {"oid": "3fb4dce7b7f52839ee3b142c621d50e7acb38052"}, "originalPosition": 102}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NDM0NjU0OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMzoyNDoxNFrOHCvihg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwODo1NTowOFrOHEj44w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjYzODA4Ng==", "bodyText": "So this one is exactly the same with source.isActive? Can we just make use of that flag instead of introducing a new one?", "url": "https://github.com/apache/hbase/pull/2255#discussion_r472638086", "createdAt": "2020-08-19T03:24:14Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -583,16 +617,27 @@ private void initialize() {\n       PriorityBlockingQueue<Path> queue = entry.getValue();\n       tryStartNewShipper(walGroupId, queue);\n     }\n+    this.startupOngoing.set(false);\n   }\n \n   @Override\n   public void startup() {\n     // mark we are running now\n     this.sourceRunning = true;\n-    initThread = new Thread(this::initialize);\n-    Threads.setDaemonThreadRunning(initThread,\n-      Thread.currentThread().getName() + \".replicationSource,\" + this.queueId,\n-      this::uncaughtException);\n+    this.retryStartup.set(true);\n+    do {\n+      if(retryStartup.get()) {\n+        retryStartup.set(false);\n+        startupOngoing.set(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fb4dce7b7f52839ee3b142c621d50e7acb38052"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDU0NDM1NQ==", "bodyText": "Not exactly the same, but we may use the negation of source.isActive to control this retry loop, and change this.sourceRunning value properly along startup and initialize method.", "url": "https://github.com/apache/hbase/pull/2255#discussion_r474544355", "createdAt": "2020-08-21T08:55:08Z", "author": {"login": "wchevreuil"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -583,16 +617,27 @@ private void initialize() {\n       PriorityBlockingQueue<Path> queue = entry.getValue();\n       tryStartNewShipper(walGroupId, queue);\n     }\n+    this.startupOngoing.set(false);\n   }\n \n   @Override\n   public void startup() {\n     // mark we are running now\n     this.sourceRunning = true;\n-    initThread = new Thread(this::initialize);\n-    Threads.setDaemonThreadRunning(initThread,\n-      Thread.currentThread().getName() + \".replicationSource,\" + this.queueId,\n-      this::uncaughtException);\n+    this.retryStartup.set(true);\n+    do {\n+      if(retryStartup.get()) {\n+        retryStartup.set(false);\n+        startupOngoing.set(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjYzODA4Ng=="}, "originalCommit": {"oid": "3fb4dce7b7f52839ee3b142c621d50e7acb38052"}, "originalPosition": 106}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3MzIzMTE0OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjo0Nzo0OFrOHFiryA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjo0Nzo0OFrOHFiryA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU3MzE5Mg==", "bodyText": "nit: indent?", "url": "https://github.com/apache/hbase/pull/2255#discussion_r475573192", "createdAt": "2020-08-24T12:47:48Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -119,6 +120,14 @@\n   private int logQueueWarnThreshold;\n   // ReplicationEndpoint which will handle the actual replication\n   private volatile ReplicationEndpoint replicationEndpoint;\n+  //This is needed for the startup loop to identify when there's already\n+  // an initialization happening (but not finished yet),\n+  // so that it doesn't try submit another initialize thread.\n+  // NOTE: this should only be set to false at the end of initialize method, prior to return.\n+//  private final AtomicBoolean startupOngoing = new AtomicBoolean(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8af3041eb5ab52b147b72880faf8507ef8a1f4cf"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3MzIzNTk3OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjo0OToyMFrOHFiu5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjo0OToyMFrOHFiu5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU3Mzk4OQ==", "bodyText": "Need to update the formatter config? Usually it should be 'if (manager != null) {'.", "url": "https://github.com/apache/hbase/pull/2255#discussion_r475573989", "createdAt": "2020-08-24T12:49:20Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -450,11 +463,28 @@ WALEntryFilter getWalEntryFilter() {\n     return walEntryFilter;\n   }\n \n-  protected final void uncaughtException(Thread t, Throwable e) {\n+  protected final void uncaughtException(Thread t, Throwable e,\n+      ReplicationSourceManager manager, String peerId) {\n     RSRpcServices.exitIfOOME(e);\n     LOG.error(\"Unexpected exception in {} currentPath={}\",\n       t.getName(), getCurrentPath(), e);\n-    server.abort(\"Unexpected exception in \" + t.getName(), e);\n+    if(abortOnError){\n+      server.abort(\"Unexpected exception in \" + t.getName(), e);\n+    }\n+    if(manager!=null){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8af3041eb5ab52b147b72880faf8507ef8a1f4cf"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3MzI0MzQ3OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjo1MToyNVrOHFizhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwODoyOTo1NFrOHGNWrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU3NTE3Mg==", "bodyText": "Why we need a AtomicBoolean here? It is only used locally, so a simple boolean is enough?", "url": "https://github.com/apache/hbase/pull/2255#discussion_r475575172", "createdAt": "2020-08-24T12:51:25Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -587,12 +617,25 @@ private void initialize() {\n \n   @Override\n   public void startup() {\n-    // mark we are running now\n-    this.sourceRunning = true;\n-    initThread = new Thread(this::initialize);\n-    Threads.setDaemonThreadRunning(initThread,\n-      Thread.currentThread().getName() + \".replicationSource,\" + this.queueId,\n-      this::uncaughtException);\n+    //Flag that signalizes uncaught error happening while starting up the source\n+    // and a retry should be attempted\n+    AtomicBoolean retryStartup = new AtomicBoolean(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8af3041eb5ab52b147b72880faf8507ef8a1f4cf"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY2NTQ4NQ==", "bodyText": "It's been modified by the lambda expression on line #635, since lambdas expressions require variables to be final, I can't use a simple, local primitive boolean or wrapper.", "url": "https://github.com/apache/hbase/pull/2255#discussion_r475665485", "createdAt": "2020-08-24T14:45:44Z", "author": {"login": "wchevreuil"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -587,12 +617,25 @@ private void initialize() {\n \n   @Override\n   public void startup() {\n-    // mark we are running now\n-    this.sourceRunning = true;\n-    initThread = new Thread(this::initialize);\n-    Threads.setDaemonThreadRunning(initThread,\n-      Thread.currentThread().getName() + \".replicationSource,\" + this.queueId,\n-      this::uncaughtException);\n+    //Flag that signalizes uncaught error happening while starting up the source\n+    // and a retry should be attempted\n+    AtomicBoolean retryStartup = new AtomicBoolean(false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU3NTE3Mg=="}, "originalCommit": {"oid": "8af3041eb5ab52b147b72880faf8507ef8a1f4cf"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY4NTI5Mg==", "bodyText": "Then use MutableBoolean? We do not need to use atomic here.", "url": "https://github.com/apache/hbase/pull/2255#discussion_r475685292", "createdAt": "2020-08-24T15:06:38Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -587,12 +617,25 @@ private void initialize() {\n \n   @Override\n   public void startup() {\n-    // mark we are running now\n-    this.sourceRunning = true;\n-    initThread = new Thread(this::initialize);\n-    Threads.setDaemonThreadRunning(initThread,\n-      Thread.currentThread().getName() + \".replicationSource,\" + this.queueId,\n-      this::uncaughtException);\n+    //Flag that signalizes uncaught error happening while starting up the source\n+    // and a retry should be attempted\n+    AtomicBoolean retryStartup = new AtomicBoolean(false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU3NTE3Mg=="}, "originalCommit": {"oid": "8af3041eb5ab52b147b72880faf8507ef8a1f4cf"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI3MjMwMQ==", "bodyText": "Sure, thanks for suggesting MutableBoolean, am not too familiar with apache commons lib.", "url": "https://github.com/apache/hbase/pull/2255#discussion_r476272301", "createdAt": "2020-08-25T08:29:54Z", "author": {"login": "wchevreuil"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -587,12 +617,25 @@ private void initialize() {\n \n   @Override\n   public void startup() {\n-    // mark we are running now\n-    this.sourceRunning = true;\n-    initThread = new Thread(this::initialize);\n-    Threads.setDaemonThreadRunning(initThread,\n-      Thread.currentThread().getName() + \".replicationSource,\" + this.queueId,\n-      this::uncaughtException);\n+    //Flag that signalizes uncaught error happening while starting up the source\n+    // and a retry should be attempted\n+    AtomicBoolean retryStartup = new AtomicBoolean(false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU3NTE3Mg=="}, "originalCommit": {"oid": "8af3041eb5ab52b147b72880faf8507ef8a1f4cf"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3MzgzOTk1OnYy", "diffSide": "RIGHT", "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNDo1Mjo1MlrOHFooVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNDo1Mjo1MlrOHFooVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY3MDYxNQ==", "bodyText": "I had a second thought on this here, we can't simply re-use this boolean, because in case of failure, we risk reach this point before the exception handler has updated it to false. I'm bringing back the original startupOngoing in the next commit,", "url": "https://github.com/apache/hbase/pull/2255#discussion_r475670615", "createdAt": "2020-08-24T14:52:52Z", "author": {"login": "wchevreuil"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/replication/regionserver/ReplicationSource.java", "diffHunk": "@@ -587,12 +617,25 @@ private void initialize() {\n \n   @Override\n   public void startup() {\n-    // mark we are running now\n-    this.sourceRunning = true;\n-    initThread = new Thread(this::initialize);\n-    Threads.setDaemonThreadRunning(initThread,\n-      Thread.currentThread().getName() + \".replicationSource,\" + this.queueId,\n-      this::uncaughtException);\n+    //Flag that signalizes uncaught error happening while starting up the source\n+    // and a retry should be attempted\n+    AtomicBoolean retryStartup = new AtomicBoolean(false);\n+    retryStartup.set(true);\n+    do {\n+      if(retryStartup.get()) {\n+        retryStartup.set(false);\n+        // mark we are running now\n+        this.sourceRunning = true;\n+        initThread = new Thread(this::initialize);\n+        Threads.setDaemonThreadRunning(initThread,\n+          Thread.currentThread().getName() + \".replicationSource,\" + this.queueId,\n+          (t,e) -> {\n+          sourceRunning = false;\n+          uncaughtException(t, e, null, null);\n+          retryStartup.set(true);\n+        });\n+      }\n+    } while (!this.sourceRunning);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8af3041eb5ab52b147b72880faf8507ef8a1f4cf"}, "originalPosition": 105}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2651, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}