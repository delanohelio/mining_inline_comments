{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNDc5NTI4", "number": 1018, "title": "HBASE-23652 Move the unsupported procedure type check before migratin\u2026", "bodyText": "\u2026g to RegionProcedureStore", "createdAt": "2020-01-10T14:38:33Z", "url": "https://github.com/apache/hbase/pull/1018", "merged": true, "mergeCommit": {"oid": "0321f567650be18748e7b4833fd705e88b71f90f"}, "closed": true, "closedAt": "2020-01-16T14:58:17Z", "author": {"login": "Apache9"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb5I1BZABqjI5NDAyOTQxNjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb60jnTABqjI5NTMzODg1MDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7168417826858b198fa53896986eb1b695d49fd2", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/7168417826858b198fa53896986eb1b695d49fd2", "committedDate": "2020-01-10T14:37:32Z", "message": "HBASE-23652 Move the unsupported procedure type check before migrating to RegionProcedureStore"}, "afterCommit": {"oid": "bf753ae8a3bf098f542c05cf410b8d273836e7bf", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/bf753ae8a3bf098f542c05cf410b8d273836e7bf", "committedDate": "2020-01-11T01:07:22Z", "message": "HBASE-23652 Move the unsupported procedure type check before migrating to RegionProcedureStore"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyODQ1ODU2", "url": "https://github.com/apache/hbase/pull/1018#pullrequestreview-342845856", "createdAt": "2020-01-14T21:20:32Z", "commit": {"oid": "bf753ae8a3bf098f542c05cf410b8d273836e7bf"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQyMToyMDozM1rOFdmJIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQyMToyNDowN1rOFdmO8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU3Nzk1NQ==", "bodyText": "nit: \"Migrated {} existing procedures from the old storage format.\"", "url": "https://github.com/apache/hbase/pull/1018#discussion_r366577955", "createdAt": "2020-01-14T21:20:33Z", "author": {"login": "ndimiduk"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/procedure2/store/region/RegionProcedureStore.java", "diffHunk": "@@ -347,6 +393,22 @@ public void handleCorrupted(ProcedureIterator procIter) throws IOException {\n         }\n       }\n     });\n+\n+    // check whether there are unsupported procedures, this could happen when we are migrating from\n+    // 2.1-. We used to do this in HMaster, after loading all the procedures from procedure store,\n+    // but here we have to do it before migrating, otherwise, if we find some unsupported\n+    // procedures, the users can not go back to 2.1 to finish them any more, as all the data are now\n+    // in the new region based procedure store, which is not supported in 2.1-.\n+    checkUnsupportedProcedure(activeProcsByType);\n+\n+    MutableLong maxProcIdFromProcs = new MutableLong(-1);\n+    for (Procedure<?> proc : procs) {\n+      update(proc);\n+      if (proc.getProcId() > maxProcIdFromProcs.longValue()) {\n+        maxProcIdFromProcs.setValue(proc.getProcId());\n+      }\n+    }\n+    LOG.info(\"Migrated {} procedures\", procs.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf753ae8a3bf098f542c05cf410b8d273836e7bf"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU3ODgxNQ==", "bodyText": "Both of these error messages should include a link to https://hbase.apache.org/book.html#upgrade2.2", "url": "https://github.com/apache/hbase/pull/1018#discussion_r366578815", "createdAt": "2020-01-14T21:22:34Z", "author": {"login": "ndimiduk"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/procedure2/store/region/RegionProcedureStore.java", "diffHunk": "@@ -298,6 +307,45 @@ private HRegion open(Configuration conf, FileSystem fs, Path rootDir) throws IOE\n       null);\n   }\n \n+  @SuppressWarnings(\"deprecation\")\n+  private static final ImmutableSet<Class<?>> UNSUPPORTED_PROCEDURES =\n+    ImmutableSet.of(RecoverMetaProcedure.class, AssignProcedure.class, UnassignProcedure.class,\n+      MoveRegionProcedure.class);\n+\n+  /**\n+   * In HBASE-20811, we have introduced a new TRSP to assign/unassign/move regions, and it is\n+   * incompatible with the old AssignProcedure/UnassignProcedure/MoveRegionProcedure. So we need to\n+   * make sure that there are none these procedures when upgrading. If there are, the master will\n+   * quit, you need to go back to the old version to finish these procedures first before upgrading.\n+   */\n+  private void checkUnsupportedProcedure(Map<Class<?>, List<Procedure<?>>> procsByType)\n+    throws HBaseIOException {\n+    // Confirm that we do not have unfinished assign/unassign related procedures. It is not easy to\n+    // support both the old assign/unassign procedures and the new TransitRegionStateProcedure as\n+    // there will be conflict in the code for AM. We should finish all these procedures before\n+    // upgrading.\n+    for (Class<?> clazz : UNSUPPORTED_PROCEDURES) {\n+      List<Procedure<?>> procs = procsByType.get(clazz);\n+      if (procs != null) {\n+        LOG.error(\n+          \"Unsupported procedure type {} found, please rollback your master to the old\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf753ae8a3bf098f542c05cf410b8d273836e7bf"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU3OTQ0Mg==", "bodyText": "nit: this if check reads a bit easier with some newlines\nif (procsByType.getOrDefault(ServerCrashProcedure.class, Collections.emptyList())\n       .stream()\n       .map(p -> (ServerCrashProcedure) p)\n       .anyMatch(ServerCrashProcedure::isInRecoverMetaState)) {", "url": "https://github.com/apache/hbase/pull/1018#discussion_r366579442", "createdAt": "2020-01-14T21:24:07Z", "author": {"login": "ndimiduk"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/procedure2/store/region/RegionProcedureStore.java", "diffHunk": "@@ -298,6 +307,45 @@ private HRegion open(Configuration conf, FileSystem fs, Path rootDir) throws IOE\n       null);\n   }\n \n+  @SuppressWarnings(\"deprecation\")\n+  private static final ImmutableSet<Class<?>> UNSUPPORTED_PROCEDURES =\n+    ImmutableSet.of(RecoverMetaProcedure.class, AssignProcedure.class, UnassignProcedure.class,\n+      MoveRegionProcedure.class);\n+\n+  /**\n+   * In HBASE-20811, we have introduced a new TRSP to assign/unassign/move regions, and it is\n+   * incompatible with the old AssignProcedure/UnassignProcedure/MoveRegionProcedure. So we need to\n+   * make sure that there are none these procedures when upgrading. If there are, the master will\n+   * quit, you need to go back to the old version to finish these procedures first before upgrading.\n+   */\n+  private void checkUnsupportedProcedure(Map<Class<?>, List<Procedure<?>>> procsByType)\n+    throws HBaseIOException {\n+    // Confirm that we do not have unfinished assign/unassign related procedures. It is not easy to\n+    // support both the old assign/unassign procedures and the new TransitRegionStateProcedure as\n+    // there will be conflict in the code for AM. We should finish all these procedures before\n+    // upgrading.\n+    for (Class<?> clazz : UNSUPPORTED_PROCEDURES) {\n+      List<Procedure<?>> procs = procsByType.get(clazz);\n+      if (procs != null) {\n+        LOG.error(\n+          \"Unsupported procedure type {} found, please rollback your master to the old\" +\n+            \" version to finish them, and then try to upgrade again. The full procedure list: {}\",\n+          clazz, procs);\n+        throw new HBaseIOException(\"Unsupported procedure type \" + clazz + \" found\");\n+      }\n+    }\n+    // A special check for SCP, as we do not support RecoverMetaProcedure any more so we need to\n+    // make sure that no one will try to schedule it but SCP does have a state which will schedule\n+    // it.\n+    if (procsByType.getOrDefault(ServerCrashProcedure.class, Collections.emptyList()).stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf753ae8a3bf098f542c05cf410b8d273836e7bf"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f1a9b1a67502f97517d02ccd3a502b0fde4a6bb", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/3f1a9b1a67502f97517d02ccd3a502b0fde4a6bb", "committedDate": "2020-01-16T06:56:15Z", "message": "HBASE-23652 Move the unsupported procedure type check before migrating to RegionProcedureStore"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf753ae8a3bf098f542c05cf410b8d273836e7bf", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/bf753ae8a3bf098f542c05cf410b8d273836e7bf", "committedDate": "2020-01-11T01:07:22Z", "message": "HBASE-23652 Move the unsupported procedure type check before migrating to RegionProcedureStore"}, "afterCommit": {"oid": "3f1a9b1a67502f97517d02ccd3a502b0fde4a6bb", "author": {"user": {"login": "Apache9", "name": "Duo Zhang"}}, "url": "https://github.com/apache/hbase/commit/3f1a9b1a67502f97517d02ccd3a502b0fde4a6bb", "committedDate": "2020-01-16T06:56:15Z", "message": "HBASE-23652 Move the unsupported procedure type check before migrating to RegionProcedureStore"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3179, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}