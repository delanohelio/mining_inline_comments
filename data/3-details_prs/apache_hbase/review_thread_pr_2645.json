{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4OTI5NTA4", "number": 2645, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNjo0MDowOVrOE3yKZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNjo0MDowOVrOE3yKZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2OTI4OTk2OnYy", "diffSide": "RIGHT", "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/ScannerCallableWithReplicas.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNjo0MDowOVrOHxVKOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwNDoyNjo0N1rOHxqFIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ4ODk1NQ==", "bodyText": "More changes are needed in ScannerCallableWithReplicas. It is hard to copy the diff in the right format, so I post the patch in the jira. Put the link here.\ncode diff", "url": "https://github.com/apache/hbase/pull/2645#discussion_r521488955", "createdAt": "2020-11-11T16:40:09Z", "author": {"login": "huaxiangsun"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/ScannerCallableWithReplicas.java", "diffHunk": "@@ -209,13 +209,13 @@ public MoreResults moreResultsForScan() {\n         LOG.debug(\"Scan with primary region returns \" + e.getCause());\n       }\n \n-      // If rl's size is 1 or scan's consitency is strong, it needs to throw\n-      // out the exception from the primary replica\n-      if ((regionReplication == 1) || (scan.getConsistency() == Consistency.STRONG)) {\n+      // If rl's size is 1 or scan's consistency is strong or a specific replica id has been\n+      // specified, it needs to throw out the exception from the first tried replica\n+      if (regionReplication == 1 || scan.getConsistency() == Consistency.STRONG ||\n+        scan.getReplicaId() >= 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d545591849ec4403aa9d1c88c54703f23fafe073"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc2NzA5OA==", "bodyText": "The logic is strange. If scan is strong we set endIndex to 1, and startIndex is also, so when calling cs.pollForFirstSuccessfullyCompletedTask we will get a null and then we will throw the exception out. But in pollForFirstSuccessfullyCompletedTask, we have this\n    // impossible to reach\n    return null;\n\nWhich is really confusing...\nAnyway, we all know that after years of patching on the sync client, the code is totally a mess so I will follow your approach to make the code safer... It is good that we do not need to maintain the code on master...", "url": "https://github.com/apache/hbase/pull/2645#discussion_r521767098", "createdAt": "2020-11-12T01:51:21Z", "author": {"login": "Apache9"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/ScannerCallableWithReplicas.java", "diffHunk": "@@ -209,13 +209,13 @@ public MoreResults moreResultsForScan() {\n         LOG.debug(\"Scan with primary region returns \" + e.getCause());\n       }\n \n-      // If rl's size is 1 or scan's consitency is strong, it needs to throw\n-      // out the exception from the primary replica\n-      if ((regionReplication == 1) || (scan.getConsistency() == Consistency.STRONG)) {\n+      // If rl's size is 1 or scan's consistency is strong or a specific replica id has been\n+      // specified, it needs to throw out the exception from the first tried replica\n+      if (regionReplication == 1 || scan.getConsistency() == Consistency.STRONG ||\n+        scan.getReplicaId() >= 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ4ODk1NQ=="}, "originalCommit": {"oid": "d545591849ec4403aa9d1c88c54703f23fafe073"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgzMTcxNA==", "bodyText": "The comment is incorrect, I removed it in my patch.", "url": "https://github.com/apache/hbase/pull/2645#discussion_r521831714", "createdAt": "2020-11-12T04:26:47Z", "author": {"login": "huaxiangsun"}, "path": "hbase-client/src/main/java/org/apache/hadoop/hbase/client/ScannerCallableWithReplicas.java", "diffHunk": "@@ -209,13 +209,13 @@ public MoreResults moreResultsForScan() {\n         LOG.debug(\"Scan with primary region returns \" + e.getCause());\n       }\n \n-      // If rl's size is 1 or scan's consitency is strong, it needs to throw\n-      // out the exception from the primary replica\n-      if ((regionReplication == 1) || (scan.getConsistency() == Consistency.STRONG)) {\n+      // If rl's size is 1 or scan's consistency is strong or a specific replica id has been\n+      // specified, it needs to throw out the exception from the first tried replica\n+      if (regionReplication == 1 || scan.getConsistency() == Consistency.STRONG ||\n+        scan.getReplicaId() >= 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ4ODk1NQ=="}, "originalCommit": {"oid": "d545591849ec4403aa9d1c88c54703f23fafe073"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2377, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}