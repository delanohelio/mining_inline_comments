{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwNzc4MTAx", "number": 2731, "title": "HBASE-25349 [Flakey Tests] branch-2 TestRefreshRecoveredReplication.t\u2026", "bodyText": "\u2026estReplicationRefreshSource:141 Waiting timed out after [60,000] msec\nStart the check for recovered queue presence earlier.", "createdAt": "2020-12-02T06:15:38Z", "url": "https://github.com/apache/hbase/pull/2731", "merged": true, "mergeCommit": {"oid": "9cc2f7624817f256bc7984662d2f6532bc5eb033"}, "closed": true, "closedAt": "2020-12-02T17:55:25Z", "author": {"login": "saintstack"}, "timelineItems": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiIVWKgH2gAyNTMwNzc4MTAxOjkwMzI4MjY2MTdmN2RjNDdhZTQxY2U0ZTQ0MWZmZmY2MTdjMmFkOGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiSKONgFqTU0MzA3NTY5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9032826617f7dc47ae41ce4e441ffff617c2ad8b", "author": {"user": {"login": "saintstack", "name": "Michael Stack"}}, "url": "https://github.com/apache/hbase/commit/9032826617f7dc47ae41ce4e441ffff617c2ad8b", "committedDate": "2020-12-02T06:13:13Z", "message": "HBASE-25349 [Flakey Tests] branch-2 TestRefreshRecoveredReplication.testReplicationRefreshSource:141 Waiting timed out after [60,000] msec\n\nStart the check for recovered queue presence earlier."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMDc1Njkz", "url": "https://github.com/apache/hbase/pull/2731#pullrequestreview-543075693", "createdAt": "2020-12-02T17:31:38Z", "commit": {"oid": "9032826617f7dc47ae41ce4e441ffff617c2ad8b"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNzozMTozOVrOH9mQHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxNzozOTozNFrOH9mlYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM1MTkwMg==", "bodyText": "Can NUM_SLAVES1 be made final, and referenced wherever it's presumed to be 2? Maybe rename it if you're in there making that change...", "url": "https://github.com/apache/hbase/pull/2731#discussion_r534351902", "createdAt": "2020-12-02T17:31:39Z", "author": {"login": "ndimiduk"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/replication/regionserver/TestRefreshRecoveredReplication.java", "diffHunk": "@@ -75,6 +80,7 @@\n \n   @BeforeClass\n   public static void setUpBeforeClass() throws Exception {\n+    // NUM_SLAVES1 is presumed 2 in below.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9032826617f7dc47ae41ce4e441ffff617c2ad8b"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM1NzM0Ng==", "bodyText": "Instead of waiting on strict equality by count, can you wait for getLiveRegionServerThreads() to contain only otherServer by identity?", "url": "https://github.com/apache/hbase/pull/2731#discussion_r534357346", "createdAt": "2020-12-02T17:39:34Z", "author": {"login": "ndimiduk"}, "path": "hbase-server/src/test/java/org/apache/hadoop/hbase/replication/regionserver/TestRefreshRecoveredReplication.java", "diffHunk": "@@ -121,22 +127,25 @@ public void testReplicationRefreshSource() throws Exception {\n       table1.put(new Put(r).addColumn(famName, famName, r));\n     }\n \n-    // kill rs holding table region\n-    Optional<RegionServerThread> server = UTIL1.getMiniHBaseCluster().getLiveRegionServerThreads()\n-        .stream()\n+    // Kill rs holding table region. There are only TWO servers. We depend on it.\n+    List<RegionServerThread> rss = UTIL1.getMiniHBaseCluster().getLiveRegionServerThreads();\n+    assertEquals(2, rss.size());\n+    Optional<RegionServerThread> server = rss.stream()\n         .filter(rst -> CollectionUtils.isNotEmpty(rst.getRegionServer().getRegions(tablename)))\n         .findAny();\n     Assert.assertTrue(server.isPresent());\n+    HRegionServer otherServer = rss.get(0).getRegionServer() == server.get().getRegionServer()?\n+      rss.get(1).getRegionServer(): rss.get(0).getRegionServer();\n     server.get().getRegionServer().abort(\"stopping for test\");\n+    // waiting for recovered peer to appear.\n+    Replication replication = (Replication)otherServer.getReplicationSourceService();\n+    UTIL1.waitFor(60000, () -> !replication.getReplicationManager().getOldSources().isEmpty());\n+    // Wait on only one server being up.\n     UTIL1.waitFor(60000, () ->\n-        UTIL1.getMiniHBaseCluster().getLiveRegionServerThreads().size() == NUM_SLAVES1 - 1);\n+      // Have to go back to source here because getLiveRegionServerThreads makes new array each time\n+      UTIL1.getMiniHBaseCluster().getLiveRegionServerThreads().size() == NUM_SLAVES1 - 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9032826617f7dc47ae41ce4e441ffff617c2ad8b"}, "originalPosition": 59}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1768, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}