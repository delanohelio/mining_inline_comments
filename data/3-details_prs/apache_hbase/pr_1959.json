{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4ODMwNDIw", "number": 1959, "title": "HBASE-20819 Use TableDescriptor to replace HTableDescriptor in hbase-shell module", "bodyText": "Resolves https://issues.apache.org/jira/browse/HBASE-20819\n\nBased on an old patch from Ha, Xiaolin (patch is still attached to Jira), updated for the current master branch\nIn the hbase-shell module, replace all usages of HTableDescriptor with TableDescriptorBuilder\nAdd unit tests for removing nonexistent attributes and configurations in the shell (This was previously untested and touches some of the code changes in this PR)\nAdded new overload for TableDescriptorBuilder.removeValue that takes a String argument.", "createdAt": "2020-06-23T21:25:40Z", "url": "https://github.com/apache/hbase/pull/1959", "merged": true, "mergeCommit": {"oid": "83f27b528775ba2946b8e288b7c819a93a29730e"}, "closed": true, "closedAt": "2020-06-26T19:39:35Z", "author": {"login": "bitoffdev"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuL4sqgH2gAyNDM4ODMwNDIwOjYzMTE4N2Q1M2U0NTRkYjkzMjdiMjEyYzc1ZWE5YWYyNTgxZGY2NWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvGjSnAH2gAyNDM4ODMwNDIwOjI3MDUyYTE1NGQzOGVlZWIwZjdjNjhmOGM2NDY5MzYyYzgxYzM2NDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "631187d53e454db9327b212c75ea9af2581df65b", "author": {"user": {"login": "bitoffdev", "name": "Elliot"}}, "url": "https://github.com/apache/hbase/commit/631187d53e454db9327b212c75ea9af2581df65b", "committedDate": "2020-06-23T20:57:29Z", "message": "HBASE-20819 Use TableDescriptor to replace HTableDescriptor in hbase-shell module"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5667720e7de3a412faa2586dcdc06f531c0e338", "author": {"user": {"login": "bitoffdev", "name": "Elliot"}}, "url": "https://github.com/apache/hbase/commit/d5667720e7de3a412faa2586dcdc06f531c0e338", "committedDate": "2020-06-23T21:39:39Z", "message": "Resolve whitespace issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MTk3NTc1", "url": "https://github.com/apache/hbase/pull/1959#pullrequestreview-436197575", "createdAt": "2020-06-23T22:14:59Z", "commit": {"oid": "d5667720e7de3a412faa2586dcdc06f531c0e338"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMjoxNDo1OVrOGn8fUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMjoxNjo0OFrOGn8h0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUzODcwNQ==", "bodyText": "Are there imports you can drop now after doing this work? e.g. the HTableDescriptor import?", "url": "https://github.com/apache/hbase/pull/1959#discussion_r444538705", "createdAt": "2020-06-23T22:14:59Z", "author": {"login": "saintstack"}, "path": "hbase-shell/src/main/ruby/hbase/admin.rb", "diffHunk": "@@ -25,6 +25,8 @@\n java_import org.apache.hadoop.hbase.util.Bytes\n java_import org.apache.hadoop.hbase.ServerName\n java_import org.apache.hadoop.hbase.TableName\n+java_import org.apache.hadoop.hbase.client.ColumnFamilyDescriptorBuilder", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5667720e7de3a412faa2586dcdc06f531c0e338"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUzOTM0Nw==", "bodyText": "No 'remove' for CF?", "url": "https://github.com/apache/hbase/pull/1959#discussion_r444539347", "createdAt": "2020-06-23T22:16:48Z", "author": {"login": "saintstack"}, "path": "hbase-shell/src/main/ruby/hbase/admin.rb", "diffHunk": "@@ -701,40 +703,40 @@ def alter(table_name_str, wait = true, *args)\n           # Delete column family\n           if method == 'delete'\n             raise(ArgumentError, 'NAME parameter missing for delete method') unless name\n-            htd.removeFamily(name.to_java_bytes)\n+            tdb.removeColumnFamily(name.to_java_bytes)\n             hasTableUpdate = true\n           # Unset table attributes\n           elsif method == 'table_att_unset'\n             raise(ArgumentError, 'NAME parameter missing for table_att_unset method') unless name\n             if name.is_a?(Array)\n               name.each do |key|\n-                if htd.getValue(key).nil?\n+                if tdb.build.getValue(key).nil?\n                   raise ArgumentError, \"Could not find attribute: #{key}\"\n                 end\n-                htd.remove(key)\n+                tdb.setValue(key, nil)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5667720e7de3a412faa2586dcdc06f531c0e338"}, "originalPosition": 120}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MjkwMzg0", "url": "https://github.com/apache/hbase/pull/1959#pullrequestreview-436290384", "createdAt": "2020-06-24T02:55:31Z", "commit": {"oid": "d5667720e7de3a412faa2586dcdc06f531c0e338"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMjo1NTozMVrOGoBOtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwMjo1NjoxOFrOGoBPhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxNjM3NA==", "bodyText": "We have a removeValue method so we'd better make use of it. Anyway the implementation is to just call setValue(key, null).", "url": "https://github.com/apache/hbase/pull/1959#discussion_r444616374", "createdAt": "2020-06-24T02:55:31Z", "author": {"login": "Apache9"}, "path": "hbase-shell/src/main/ruby/hbase/admin.rb", "diffHunk": "@@ -701,40 +703,40 @@ def alter(table_name_str, wait = true, *args)\n           # Delete column family\n           if method == 'delete'\n             raise(ArgumentError, 'NAME parameter missing for delete method') unless name\n-            htd.removeFamily(name.to_java_bytes)\n+            tdb.removeColumnFamily(name.to_java_bytes)\n             hasTableUpdate = true\n           # Unset table attributes\n           elsif method == 'table_att_unset'\n             raise(ArgumentError, 'NAME parameter missing for table_att_unset method') unless name\n             if name.is_a?(Array)\n               name.each do |key|\n-                if htd.getValue(key).nil?\n+                if tdb.build.getValue(key).nil?\n                   raise ArgumentError, \"Could not find attribute: #{key}\"\n                 end\n-                htd.remove(key)\n+                tdb.setValue(key, nil)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUzOTM0Nw=="}, "originalCommit": {"oid": "d5667720e7de3a412faa2586dcdc06f531c0e338"}, "originalPosition": 120}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxNjUwOA==", "bodyText": "Ditto.", "url": "https://github.com/apache/hbase/pull/1959#discussion_r444616508", "createdAt": "2020-06-24T02:56:01Z", "author": {"login": "Apache9"}, "path": "hbase-shell/src/main/ruby/hbase/admin.rb", "diffHunk": "@@ -701,40 +703,40 @@ def alter(table_name_str, wait = true, *args)\n           # Delete column family\n           if method == 'delete'\n             raise(ArgumentError, 'NAME parameter missing for delete method') unless name\n-            htd.removeFamily(name.to_java_bytes)\n+            tdb.removeColumnFamily(name.to_java_bytes)\n             hasTableUpdate = true\n           # Unset table attributes\n           elsif method == 'table_att_unset'\n             raise(ArgumentError, 'NAME parameter missing for table_att_unset method') unless name\n             if name.is_a?(Array)\n               name.each do |key|\n-                if htd.getValue(key).nil?\n+                if tdb.build.getValue(key).nil?\n                   raise ArgumentError, \"Could not find attribute: #{key}\"\n                 end\n-                htd.remove(key)\n+                tdb.setValue(key, nil)\n               end\n             else\n-              if htd.getValue(name).nil?\n+              if tdb.build.getValue(name).nil?\n                 raise ArgumentError, \"Could not find attribute: #{name}\"\n               end\n-              htd.remove(name)\n+              tdb.setValue(name, nil)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5667720e7de3a412faa2586dcdc06f531c0e338"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxNjU1Ng==", "bodyText": "Ditto.", "url": "https://github.com/apache/hbase/pull/1959#discussion_r444616556", "createdAt": "2020-06-24T02:56:11Z", "author": {"login": "Apache9"}, "path": "hbase-shell/src/main/ruby/hbase/admin.rb", "diffHunk": "@@ -701,40 +703,40 @@ def alter(table_name_str, wait = true, *args)\n           # Delete column family\n           if method == 'delete'\n             raise(ArgumentError, 'NAME parameter missing for delete method') unless name\n-            htd.removeFamily(name.to_java_bytes)\n+            tdb.removeColumnFamily(name.to_java_bytes)\n             hasTableUpdate = true\n           # Unset table attributes\n           elsif method == 'table_att_unset'\n             raise(ArgumentError, 'NAME parameter missing for table_att_unset method') unless name\n             if name.is_a?(Array)\n               name.each do |key|\n-                if htd.getValue(key).nil?\n+                if tdb.build.getValue(key).nil?\n                   raise ArgumentError, \"Could not find attribute: #{key}\"\n                 end\n-                htd.remove(key)\n+                tdb.setValue(key, nil)\n               end\n             else\n-              if htd.getValue(name).nil?\n+              if tdb.build.getValue(name).nil?\n                 raise ArgumentError, \"Could not find attribute: #{name}\"\n               end\n-              htd.remove(name)\n+              tdb.setValue(name, nil)\n             end\n             hasTableUpdate = true\n           # Unset table configuration\n           elsif method == 'table_conf_unset'\n             raise(ArgumentError, 'NAME parameter missing for table_conf_unset method') unless name\n             if name.is_a?(Array)\n               name.each do |key|\n-                if htd.getConfigurationValue(key).nil?\n+                if tdb.build.getValue(key).nil?\n                   raise ArgumentError, \"Could not find configuration: #{key}\"\n                 end\n-                htd.removeConfiguration(key)\n+                tdb.setValue(key, nil)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5667720e7de3a412faa2586dcdc06f531c0e338"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxNjU4MA==", "bodyText": "Ditto.", "url": "https://github.com/apache/hbase/pull/1959#discussion_r444616580", "createdAt": "2020-06-24T02:56:18Z", "author": {"login": "Apache9"}, "path": "hbase-shell/src/main/ruby/hbase/admin.rb", "diffHunk": "@@ -701,40 +703,40 @@ def alter(table_name_str, wait = true, *args)\n           # Delete column family\n           if method == 'delete'\n             raise(ArgumentError, 'NAME parameter missing for delete method') unless name\n-            htd.removeFamily(name.to_java_bytes)\n+            tdb.removeColumnFamily(name.to_java_bytes)\n             hasTableUpdate = true\n           # Unset table attributes\n           elsif method == 'table_att_unset'\n             raise(ArgumentError, 'NAME parameter missing for table_att_unset method') unless name\n             if name.is_a?(Array)\n               name.each do |key|\n-                if htd.getValue(key).nil?\n+                if tdb.build.getValue(key).nil?\n                   raise ArgumentError, \"Could not find attribute: #{key}\"\n                 end\n-                htd.remove(key)\n+                tdb.setValue(key, nil)\n               end\n             else\n-              if htd.getValue(name).nil?\n+              if tdb.build.getValue(name).nil?\n                 raise ArgumentError, \"Could not find attribute: #{name}\"\n               end\n-              htd.remove(name)\n+              tdb.setValue(name, nil)\n             end\n             hasTableUpdate = true\n           # Unset table configuration\n           elsif method == 'table_conf_unset'\n             raise(ArgumentError, 'NAME parameter missing for table_conf_unset method') unless name\n             if name.is_a?(Array)\n               name.each do |key|\n-                if htd.getConfigurationValue(key).nil?\n+                if tdb.build.getValue(key).nil?\n                   raise ArgumentError, \"Could not find configuration: #{key}\"\n                 end\n-                htd.removeConfiguration(key)\n+                tdb.setValue(key, nil)\n               end\n             else\n-              if htd.getConfigurationValue(name).nil?\n+              if tdb.build.getValue(name).nil?\n                 raise ArgumentError, \"Could not find configuration: #{name}\"\n               end\n-              htd.removeConfiguration(name)\n+              tdb.setValue(name, nil)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5667720e7de3a412faa2586dcdc06f531c0e338"}, "originalPosition": 149}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57a1b0130fbc54cde83d04d30cf84bcd2878449d", "author": {"user": {"login": "bitoffdev", "name": "Elliot"}}, "url": "https://github.com/apache/hbase/commit/57a1b0130fbc54cde83d04d30cf84bcd2878449d", "committedDate": "2020-06-24T14:11:11Z", "message": "Add String removeValue overload to TableDescriptorBuilder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dff435b684581d3da026d2dbb931c1cab9dfd990", "author": {"user": {"login": "bitoffdev", "name": "Elliot"}}, "url": "https://github.com/apache/hbase/commit/dff435b684581d3da026d2dbb931c1cab9dfd990", "committedDate": "2020-06-24T14:11:11Z", "message": "Use removeValue rather than setValue where possible in hbase-shell"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13dbed076045a4bb4d3cc934c2ab172289831b9b", "author": {"user": {"login": "bitoffdev", "name": "Elliot"}}, "url": "https://github.com/apache/hbase/commit/13dbed076045a4bb4d3cc934c2ab172289831b9b", "committedDate": "2020-06-24T15:44:17Z", "message": "Convert remaining usages of HTableDescriptor in security.rb"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MTYxOTcz", "url": "https://github.com/apache/hbase/pull/1959#pullrequestreview-437161973", "createdAt": "2020-06-25T04:38:34Z", "commit": {"oid": "13dbed076045a4bb4d3cc934c2ab172289831b9b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQwNDozODozNFrOGorFxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQwNDo0Njo1OFrOGorN1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMwMjIxMg==", "bodyText": "Since this no longer returns HColumnDescriptor maybe cfd would be a better name?", "url": "https://github.com/apache/hbase/pull/1959#discussion_r445302212", "createdAt": "2020-06-25T04:38:34Z", "author": {"login": "busbey"}, "path": "hbase-shell/src/main/ruby/hbase/admin.rb", "diffHunk": "@@ -971,101 +976,103 @@ def enabled?(table_name)\n     end\n \n     #----------------------------------------------------------------------------------------------\n-    # Return a new HColumnDescriptor made of passed args\n-    def hcd(arg, htd)\n+    # Return a new ColumnFamilyDescriptor made of passed args\n+    def hcd(arg, tdb)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13dbed076045a4bb4d3cc934c2ab172289831b9b"}, "originalPosition": 190}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMwMjQ0OQ==", "bodyText": "we'll need to release note the changed set of constants, if any.", "url": "https://github.com/apache/hbase/pull/1959#discussion_r445302449", "createdAt": "2020-06-25T04:39:38Z", "author": {"login": "busbey"}, "path": "hbase-shell/src/main/ruby/hbase_constants.rb", "diffHunk": "@@ -109,8 +109,8 @@ def self.promote_constants(constants)\n     end\n   end\n \n-  promote_constants(org.apache.hadoop.hbase.HColumnDescriptor.constants)\n-  promote_constants(org.apache.hadoop.hbase.HTableDescriptor.constants)\n+  promote_constants(org.apache.hadoop.hbase.client.ColumnFamilyDescriptorBuilder.constants)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13dbed076045a4bb4d3cc934c2ab172289831b9b"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMwMzI3OA==", "bodyText": "this method was accessible to shell users, so we will need to release note the removal.", "url": "https://github.com/apache/hbase/pull/1959#discussion_r445303278", "createdAt": "2020-06-25T04:42:46Z", "author": {"login": "busbey"}, "path": "hbase-shell/src/main/ruby/hbase/admin.rb", "diffHunk": "@@ -1359,26 +1366,26 @@ def list_locks\n       @admin.getLocks\n     end\n \n-    # Parse arguments and update HTableDescriptor accordingly\n-    def update_htd_from_arg(htd, arg)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13dbed076045a4bb4d3cc934c2ab172289831b9b"}, "originalPosition": 358}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMwMzY3NA==", "bodyText": "even if we do not change this name we will need to release note this change because it is visible to shell users but the return type changed.", "url": "https://github.com/apache/hbase/pull/1959#discussion_r445303674", "createdAt": "2020-06-25T04:44:20Z", "author": {"login": "busbey"}, "path": "hbase-shell/src/main/ruby/hbase/admin.rb", "diffHunk": "@@ -971,101 +976,103 @@ def enabled?(table_name)\n     end\n \n     #----------------------------------------------------------------------------------------------\n-    # Return a new HColumnDescriptor made of passed args\n-    def hcd(arg, htd)\n+    # Return a new ColumnFamilyDescriptor made of passed args\n+    def hcd(arg, tdb)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMwMjIxMg=="}, "originalCommit": {"oid": "13dbed076045a4bb4d3cc934c2ab172289831b9b"}, "originalPosition": 190}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMwNDI3OQ==", "bodyText": "do we need to build the whole table descriptor in order to check for the column family? I see we do this several times in the change set.", "url": "https://github.com/apache/hbase/pull/1959#discussion_r445304279", "createdAt": "2020-06-25T04:46:58Z", "author": {"login": "busbey"}, "path": "hbase-shell/src/main/ruby/hbase/admin.rb", "diffHunk": "@@ -971,101 +976,103 @@ def enabled?(table_name)\n     end\n \n     #----------------------------------------------------------------------------------------------\n-    # Return a new HColumnDescriptor made of passed args\n-    def hcd(arg, htd)\n+    # Return a new ColumnFamilyDescriptor made of passed args\n+    def hcd(arg, tdb)\n       # String arg, single parameter constructor\n-      return org.apache.hadoop.hbase.HColumnDescriptor.new(arg) if arg.is_a?(String)\n+\n+      return ColumnFamilyDescriptorBuilder.of(arg) if arg.is_a?(String)\n \n       raise(ArgumentError, \"Column family #{arg} must have a name\") unless name = arg.delete(NAME)\n \n-      family = htd.getFamily(name.to_java_bytes)\n+      cfd = tdb.build.getColumnFamily(name.to_java_bytes)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13dbed076045a4bb4d3cc934c2ab172289831b9b"}, "originalPosition": 199}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf2aa593e590133b0c76d3723b4074b28b55dcc9", "author": {"user": {"login": "bitoffdev", "name": "Elliot"}}, "url": "https://github.com/apache/hbase/commit/cf2aa593e590133b0c76d3723b4074b28b55dcc9", "committedDate": "2020-06-25T16:58:45Z", "message": "Rename hcd (HColumnDescriptor) to cfd (ColumnFamilyDescriptor)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d11504443d445cec5aed86f8c103df9c1dc9598", "author": {"user": {"login": "bitoffdev", "name": "Elliot"}}, "url": "https://github.com/apache/hbase/commit/5d11504443d445cec5aed86f8c103df9c1dc9598", "committedDate": "2020-06-26T16:33:14Z", "message": "Add back 3 constants to HBaseConstants in hbase-shell"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NDUwMDg0", "url": "https://github.com/apache/hbase/pull/1959#pullrequestreview-438450084", "createdAt": "2020-06-26T16:53:25Z", "commit": {"oid": "5d11504443d445cec5aed86f8c103df9c1dc9598"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27052a154d38eeeb0f7c68f8c6469362c81c3649", "author": {"user": {"login": "bitoffdev", "name": "Elliot"}}, "url": "https://github.com/apache/hbase/commit/27052a154d38eeeb0f7c68f8c6469362c81c3649", "committedDate": "2020-06-26T17:18:30Z", "message": "Fix bad constant reference"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4396, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}