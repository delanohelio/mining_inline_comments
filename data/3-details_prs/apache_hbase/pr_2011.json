{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzMjk4NTgy", "number": 2011, "title": "HBASE-24664 Some changing of split region by overall region size rath\u2026", "bodyText": "\u2026er than only one store size", "createdAt": "2020-07-02T06:13:37Z", "url": "https://github.com/apache/hbase/pull/2011", "merged": true, "mergeCommit": {"oid": "3bd54217a04e30db09e3261626687fc8779061b3"}, "closed": true, "closedAt": "2020-07-13T09:00:49Z", "author": {"login": "bsglz"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcw4lO-AH2gAyNDQzMjk4NTgyOmVmMzI2NTk2NDM5ODU2NmVhMDY5YTJmYzk1MWEyNmE2MjRhZjdkOGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0YuOEgFqTQ0Njk1Nzg2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ef3265964398566ea069a2fc951a26a624af7d8b", "author": {"user": {"login": "bsglz", "name": null}}, "url": "https://github.com/apache/hbase/commit/ef3265964398566ea069a2fc951a26a624af7d8b", "committedDate": "2020-07-02T06:09:48Z", "message": "HBASE-24664 Some changing of split region by overall region size rather than only one store size"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79c682c220611299f9fef620529e7d1dd2c83572", "author": {"user": {"login": "bsglz", "name": null}}, "url": "https://github.com/apache/hbase/commit/79c682c220611299f9fef620529e7d1dd2c83572", "committedDate": "2020-07-02T07:23:37Z", "message": "fix checkstyle issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyOTY5OTM2", "url": "https://github.com/apache/hbase/pull/2011#pullrequestreview-442969936", "createdAt": "2020-07-06T10:49:08Z", "commit": {"oid": "79c682c220611299f9fef620529e7d1dd2c83572"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxMDo0OTowOFrOGtSW8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxMToxMjo0M1rOGtTB2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDEzOTg4OA==", "bodyText": "Move this check to the for loops inside isExceedSize, so that we don't have to do do an extra iteration for all stores again in case none returns false for canSplit.", "url": "https://github.com/apache/hbase/pull/2011#discussion_r450139888", "createdAt": "2020-07-06T10:49:08Z", "author": {"login": "wchevreuil"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java", "diffHunk": "@@ -68,22 +76,14 @@ protected void configureForRegion(HRegion region) {\n \n   @Override\n   protected boolean shouldSplit() {\n-    boolean foundABigStore = false;\n-\n+    // If any of the stores is unable to split (eg they contain reference files)\n+    // then don't split\n     for (HStore store : region.getStores()) {\n-      // If any of the stores are unable to split (eg they contain reference files)\n-      // then don't split\n-      if ((!store.canSplit())) {\n+      if (!store.canSplit()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79c682c220611299f9fef620529e7d1dd2c83572"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDE1MDg3NA==", "bodyText": "We should just return this comparison and let each caller decide how to log it? That would discard the need for having an extra param just for the sake of logging.", "url": "https://github.com/apache/hbase/pull/2011#discussion_r450150874", "createdAt": "2020-07-06T11:12:43Z", "author": {"login": "wchevreuil"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java", "diffHunk": "@@ -94,4 +94,33 @@ long getDesiredMaxFileSize() {\n   public boolean positiveJitterRate() {\n     return this.jitterRate > 0;\n   }\n+\n+  /**\n+   * @return true if region size exceed the sizeToCheck\n+   */\n+  protected boolean isExceedSize(long sizeToCheck, String extraLogStr) {\n+    if (overallHregionFiles) {\n+      long sumSize = 0;\n+      for (HStore store : region.getStores()) {\n+        sumSize += store.getSize();\n+      }\n+      if (sumSize > sizeToCheck) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79c682c220611299f9fef620529e7d1dd2c83572"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61ff63ea7dbdda9f66c04181a906b32b9cab3aa4", "author": {"user": {"login": "bsglz", "name": null}}, "url": "https://github.com/apache/hbase/commit/61ff63ea7dbdda9f66c04181a906b32b9cab3aa4", "committedDate": "2020-07-07T13:11:15Z", "message": "1.remove extraLogStr param; 2.use parent's canSplit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "735f67f0b0e24abd65898ff8948648af3f402e5f", "author": {"user": {"login": "bsglz", "name": null}}, "url": "https://github.com/apache/hbase/commit/735f67f0b0e24abd65898ff8948648af3f402e5f", "committedDate": "2020-07-07T15:03:35Z", "message": "fix compile error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c632a556bba6aea231e19ee09f9f8dba979bdd4b", "author": {"user": {"login": "bsglz", "name": null}}, "url": "https://github.com/apache/hbase/commit/c632a556bba6aea231e19ee09f9f8dba979bdd4b", "committedDate": "2020-07-08T02:06:37Z", "message": "fix ut failure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NTY2OTcz", "url": "https://github.com/apache/hbase/pull/2011#pullrequestreview-446566973", "createdAt": "2020-07-10T17:16:02Z", "commit": {"oid": "c632a556bba6aea231e19ee09f9f8dba979bdd4b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2ODc2NDcx", "url": "https://github.com/apache/hbase/pull/2011#pullrequestreview-446876471", "createdAt": "2020-07-12T13:00:07Z", "commit": {"oid": "c632a556bba6aea231e19ee09f9f8dba979bdd4b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQxMzowMDowN1rOGwUElQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMlQxMzowNjoyM1rOGwUHUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMxMzY4NQ==", "bodyText": "Should we use 'hregion' or 'region'? I'm not sure, just ask.", "url": "https://github.com/apache/hbase/pull/2011#discussion_r453313685", "createdAt": "2020-07-12T13:00:07Z", "author": {"login": "Apache9"}, "path": "hbase-common/src/main/java/org/apache/hadoop/hbase/HConstants.java", "diffHunk": "@@ -382,6 +382,13 @@\n   /** Default maximum file size */\n   public static final long DEFAULT_MAX_FILE_SIZE = 10 * 1024 * 1024 * 1024L;\n \n+  /** Conf key for if we should sum overall region files size when check to split */\n+  public static final String OVERALL_HREGION_FILES =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c632a556bba6aea231e19ee09f9f8dba979bdd4b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMxMzgxNA==", "bodyText": "overallHRegionFiles? The 'R' should be upper case.", "url": "https://github.com/apache/hbase/pull/2011#discussion_r453313814", "createdAt": "2020-07-12T13:01:13Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java", "diffHunk": "@@ -38,10 +41,13 @@\n  */\n @InterfaceAudience.LimitedPrivate(HBaseInterfaceAudience.CONFIG)\n public class ConstantSizeRegionSplitPolicy extends RegionSplitPolicy {\n+  private static final Logger LOG =\n+    LoggerFactory.getLogger(ConstantSizeRegionSplitPolicy.class);\n   private static final Random RANDOM = new Random();\n \n   private long desiredMaxFileSize;\n   private double jitterRate;\n+  protected boolean overallHregionFiles;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c632a556bba6aea231e19ee09f9f8dba979bdd4b"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMxNDA1NQ==", "bodyText": "Should we make this method final? I think it is used to be called by sub classes, not to be overridden?", "url": "https://github.com/apache/hbase/pull/2011#discussion_r453314055", "createdAt": "2020-07-12T13:03:29Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/ConstantSizeRegionSplitPolicy.java", "diffHunk": "@@ -94,4 +90,33 @@ long getDesiredMaxFileSize() {\n   public boolean positiveJitterRate() {\n     return this.jitterRate > 0;\n   }\n+\n+  /**\n+   * @return true if region size exceed the sizeToCheck\n+   */\n+  protected boolean isExceedSize(long sizeToCheck) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c632a556bba6aea231e19ee09f9f8dba979bdd4b"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzMxNDM4Ng==", "bodyText": "This is an interesting change. Is behavior still the same?", "url": "https://github.com/apache/hbase/pull/2011#discussion_r453314386", "createdAt": "2020-07-12T13:06:23Z", "author": {"login": "Apache9"}, "path": "hbase-server/src/main/java/org/apache/hadoop/hbase/regionserver/RegionSplitPolicy.java", "diffHunk": "@@ -75,7 +75,7 @@ protected void configureForRegion(HRegion region) {\n    */\n   protected boolean canSplit() {\n     return !region.getRegionInfo().isMetaRegion() && region.isAvailable() &&\n-      !region.hasReferences();\n+      region.getStores().stream().allMatch(HStore::canSplit);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c632a556bba6aea231e19ee09f9f8dba979bdd4b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7b8fd1286bc5ed1ed1d8c7d99f928a14afbf6df", "author": {"user": {"login": "bsglz", "name": null}}, "url": "https://github.com/apache/hbase/commit/c7b8fd1286bc5ed1ed1d8c7d99f928a14afbf6df", "committedDate": "2020-07-13T02:21:24Z", "message": "fix review issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2OTU3ODYx", "url": "https://github.com/apache/hbase/pull/2011#pullrequestreview-446957861", "createdAt": "2020-07-13T03:18:21Z", "commit": {"oid": "c7b8fd1286bc5ed1ed1d8c7d99f928a14afbf6df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4193, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}