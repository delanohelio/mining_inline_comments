{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4NTUwNzUw", "number": 289, "title": "fix(griffin) - order by on column with function throws exception #288", "bodyText": "", "createdAt": "2020-05-15T12:00:01Z", "url": "https://github.com/questdb/questdb/pull/289", "merged": true, "mergeCommit": {"oid": "fe9c62a7e3f1abaf42e9aaad87773241623c7db4"}, "closed": true, "closedAt": "2020-05-18T15:26:12Z", "author": {"login": "jaugsburger"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchg0GRgH2gAyNDE4NTUwNzUwOjBhYzVmNTk2Mjg3ZjZmYjg2OGVjMDZhODRhNTJjZmZjZTQ1OTEwOWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcihcPKgFqTQxMzY5NDIwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0ac5f596287f6fb868ec06a84a52cffce459109a", "author": {"user": null}, "url": "https://github.com/questdb/questdb/commit/0ac5f596287f6fb868ec06a84a52cffce459109a", "committedDate": "2020-05-15T11:59:27Z", "message": "fix(griffin) - order by on column with function throws exception #288"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a4bf314a287554d1f39dfde359336c054b5485d", "author": {"user": null}, "url": "https://github.com/questdb/questdb/commit/2a4bf314a287554d1f39dfde359336c054b5485d", "committedDate": "2020-05-17T20:50:18Z", "message": "fix(griffin) - order by on column with function throws exception #288"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0dfc2fef74439cf7e10b0617912e7740660b68c", "author": {"user": null}, "url": "https://github.com/questdb/questdb/commit/c0dfc2fef74439cf7e10b0617912e7740660b68c", "committedDate": "2020-05-17T21:30:31Z", "message": "fix(griffin) - order by on column with function throws exception #288"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ba40e21d4c18adf3b74d0e138a46ca77feb05fb", "author": {"user": null}, "url": "https://github.com/questdb/questdb/commit/3ba40e21d4c18adf3b74d0e138a46ca77feb05fb", "committedDate": "2020-05-18T08:22:58Z", "message": "fix(griffin) - order by on column with function throws exception #288"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddcd27680f1db694ba3c9171d77bd595ccea7103", "author": {"user": null}, "url": "https://github.com/questdb/questdb/commit/ddcd27680f1db694ba3c9171d77bd595ccea7103", "committedDate": "2020-05-18T09:06:32Z", "message": "fix(griffin) - order by on column with function throws exception #288"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bd71959d406e39a75f7576a54cf36021732cc7c", "author": {"user": null}, "url": "https://github.com/questdb/questdb/commit/2bd71959d406e39a75f7576a54cf36021732cc7c", "committedDate": "2020-05-18T09:36:44Z", "message": "fix(griffin) - order by on column with function throws exception #288"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNDQxNjA2", "url": "https://github.com/questdb/questdb/pull/289#pullrequestreview-413441606", "createdAt": "2020-05-18T09:53:04Z", "commit": {"oid": "2bd71959d406e39a75f7576a54cf36021732cc7c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwOTo1MzowNFrOGWv4EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwOTo1NTozMlrOGWv-Dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUwNjI1Ng==", "bodyText": "We need more tests.\nWhat happens here is what I've written about in email - if order by has non-literal columns, advice must be empty. We must not give selective advice to the sub=query", "url": "https://github.com/questdb/questdb/pull/289#discussion_r426506256", "createdAt": "2020-05-18T09:53:04Z", "author": {"login": "bluestreak01"}, "path": "core/src/main/java/io/questdb/griffin/SqlOptimiser.java", "diffHunk": "@@ -1163,10 +1163,12 @@ private int getIndexOfTableForColumn(QueryModel model, CharSequence column, int\n             return orderByAdvice;\n         }\n \n-        CharSequenceObjHashMap<CharSequence> map = model.getAliasToColumnNameMap();\n+        CharSequenceObjHashMap<QueryColumn> map = model.getAliasToColumnMap();\n         for (int i = 0; i < len; i++) {\n-            orderByAdvice.add(nextLiteral(map.get(orderBy.getQuick(i).token)));\n-\n+            QueryColumn queryColumn = map.get(orderBy.getQuick(i).token);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bd71959d406e39a75f7576a54cf36021732cc7c"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUwNzYwMw==", "bodyText": "we should probably keep that - advice must not have unresolvable columns", "url": "https://github.com/questdb/questdb/pull/289#discussion_r426507603", "createdAt": "2020-05-18T09:55:14Z", "author": {"login": "bluestreak01"}, "path": "core/src/main/java/io/questdb/griffin/SqlCodeGenerator.java", "diffHunk": "@@ -1870,7 +1870,6 @@ private RecordCursorFactory generateTableQuery(\n                         // we can only deal with 'order by symbol, timestamp' at best\n                         // skip this optimisation if order by is more extensive\n                         final int columnIndex = metadata.getColumnIndexQuiet(model.getOrderByAdvice().getQuick(0).token);\n-                        assert columnIndex > -1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bd71959d406e39a75f7576a54cf36021732cc7c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUwNzc5MQ==", "bodyText": "we probably do not need these methods anymore?", "url": "https://github.com/questdb/questdb/pull/289#discussion_r426507791", "createdAt": "2020-05-18T09:55:32Z", "author": {"login": "bluestreak01"}, "path": "core/src/main/java/io/questdb/griffin/SqlKeywords.java", "diffHunk": "@@ -642,4 +642,37 @@ public static boolean isColumnKeyword(CharSequence tok) {\n                 && (tok.charAt(i++) | 32) == 'm'\n                 && (tok.charAt(i) | 32) == 'n';\n     }\n+\n+    public static boolean isMaxKeyword(CharSequence tok) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bd71959d406e39a75f7576a54cf36021732cc7c"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45bdca092e1b0da4a9b964e92067911af6fa87c1", "author": {"user": null}, "url": "https://github.com/questdb/questdb/commit/45bdca092e1b0da4a9b964e92067911af6fa87c1", "committedDate": "2020-05-18T10:22:40Z", "message": "fix(griffin) - order by on column with function throws exception #288"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "636049cc78edd47b84498e977ffb05e32decc125", "author": {"user": null}, "url": "https://github.com/questdb/questdb/commit/636049cc78edd47b84498e977ffb05e32decc125", "committedDate": "2020-05-18T12:04:47Z", "message": "fix(griffin) - order by on column with function throws exception #288"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bbe6875068da5788f546296c55ce4f5f793f293", "author": {"user": null}, "url": "https://github.com/questdb/questdb/commit/2bbe6875068da5788f546296c55ce4f5f793f293", "committedDate": "2020-05-18T13:10:45Z", "message": "fix(griffin) - order by on column with function throws exception #288"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1082c056446b079864554b2d0a41bb97fa49ee14", "author": {"user": null}, "url": "https://github.com/questdb/questdb/commit/1082c056446b079864554b2d0a41bb97fa49ee14", "committedDate": "2020-05-18T13:44:11Z", "message": "fix(griffin) - order by query throws exception instaed of returning invalid column message #284"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef04499769708545509a313af03fd43f2be8b614", "author": {"user": null}, "url": "https://github.com/questdb/questdb/commit/ef04499769708545509a313af03fd43f2be8b614", "committedDate": "2020-05-18T14:14:39Z", "message": "fix(griffin) - order by query throws exception instaed of returning invalid column message #284"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf33c91db455f6a56e842c6d8a1634bfc456bd1a", "author": {"user": null}, "url": "https://github.com/questdb/questdb/commit/bf33c91db455f6a56e842c6d8a1634bfc456bd1a", "committedDate": "2020-05-18T14:38:28Z", "message": "fix(griffin) - order by query throws exception instaed of returning invalid column message #284"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNjYyMTQ4", "url": "https://github.com/questdb/questdb/pull/289#pullrequestreview-413662148", "createdAt": "2020-05-18T14:43:01Z", "commit": {"oid": "bf33c91db455f6a56e842c6d8a1634bfc456bd1a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNDo0MzowMVrOGW6Wqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNDo0NDozNVrOGW6a1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY3NzkzMQ==", "bodyText": "lets do in-place clear() and break", "url": "https://github.com/questdb/questdb/pull/289#discussion_r426677931", "createdAt": "2020-05-18T14:43:01Z", "author": {"login": "bluestreak01"}, "path": "core/src/main/java/io/questdb/griffin/SqlOptimiser.java", "diffHunk": "@@ -1163,10 +1163,19 @@ private int getIndexOfTableForColumn(QueryModel model, CharSequence column, int\n             return orderByAdvice;\n         }\n \n-        CharSequenceObjHashMap<CharSequence> map = model.getAliasToColumnNameMap();\n+        CharSequenceObjHashMap<QueryColumn> map = model.getAliasToColumnMap();\n+        boolean clearOrderByAdvice = false;\n         for (int i = 0; i < len; i++) {\n-            orderByAdvice.add(nextLiteral(map.get(orderBy.getQuick(i).token)));\n-\n+            QueryColumn queryColumn = map.get(orderBy.getQuick(i).token);\n+            if (queryColumn.getAst().type == ExpressionNode.LITERAL) {\n+                orderByAdvice.add(nextLiteral(queryColumn.getAst().token));\n+            } else {\n+                clearOrderByAdvice = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf33c91db455f6a56e842c6d8a1634bfc456bd1a"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY3ODk5Ng==", "bodyText": "Perhaps this one in place too, i feel it would be less confusing. This is after looking where the boolean is being set", "url": "https://github.com/questdb/questdb/pull/289#discussion_r426678996", "createdAt": "2020-05-18T14:44:35Z", "author": {"login": "bluestreak01"}, "path": "core/src/main/java/io/questdb/griffin/SqlCodeGenerator.java", "diffHunk": "@@ -1839,13 +1845,18 @@ private RecordCursorFactory generateTableQuery(\n                     }\n \n                     if (orderByKeyColumn) {\n+                        metadata.setTimestampIndex(-1);\n                         if (model.getOrderByDirectionAdvice().getQuick(0) == QueryModel.ORDER_DIRECTION_ASCENDING) {\n                             symbolValueList.sort(Chars.CHAR_SEQUENCE_COMPARATOR);\n                         } else {\n                             symbolValueList.sort(Chars.CHAR_SEQUENCE_COMPARATOR_DESC);\n                         }\n                     }\n \n+                    if (clearTimestampIndex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf33c91db455f6a56e842c6d8a1634bfc456bd1a"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6dc2bf8fe4f064946260b4c7ec3a4a281a24db2", "author": {"user": null}, "url": "https://github.com/questdb/questdb/commit/f6dc2bf8fe4f064946260b4c7ec3a4a281a24db2", "committedDate": "2020-05-18T14:55:59Z", "message": "fix(griffin) - order by on column with function throws exception #288"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNjk0MjA2", "url": "https://github.com/questdb/questdb/pull/289#pullrequestreview-413694206", "createdAt": "2020-05-18T15:17:13Z", "commit": {"oid": "f6dc2bf8fe4f064946260b4c7ec3a4a281a24db2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3314, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}