{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5MTQ1NTA1", "number": 236, "title": "feat(imports): add partitionBy and timestampIndex", "bodyText": "Allow specifying partition type and their indexes from the /imp rest endpoint via query string parameters partitionBy={DAY,MONTH,YEAR,NONE} and timestamp=columnName.\nExample command:\ncurl -i -F schema='[{\"name\": \"date\", \"type\": \"TIMESTAMP\", \"pattern\": \"yyyy-MM-dd\"}]' -F data=@agg1d.csv 'http://localhost:9000/imp?name=agg1d&partitionBy=YEAR&timestamp=date&overwrite=true'", "createdAt": "2020-04-26T19:41:55Z", "url": "https://github.com/questdb/questdb/pull/236", "merged": true, "mergeCommit": {"oid": "26f3041656096e8e194df85be87aa4aeef31da5c"}, "closed": true, "closedAt": "2020-04-30T10:27:16Z", "author": {"login": "clickingbuttons"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcbgqmmAH2gAyNDA5MTQ1NTA1OjVjNjRmNmFmMTAxYTczNTg1NThiZTdlOGY0Mzg2YjVkMzY3YmJiMjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccqgAYAFqTQwMzM5MzEyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5c64f6af101a7358558be7e8f4386b5d367bbb26", "author": {"user": {"login": "clickingbuttons", "name": null}}, "url": "https://github.com/questdb/questdb/commit/5c64f6af101a7358558be7e8f4386b5d367bbb26", "committedDate": "2020-04-26T20:25:32Z", "message": "feat(import): add partitionBy and timestampIndex"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e4bf292ab08f64cef6272d99d863f9b64b66470", "author": {"user": {"login": "clickingbuttons", "name": null}}, "url": "https://github.com/questdb/questdb/commit/5e4bf292ab08f64cef6272d99d863f9b64b66470", "committedDate": "2020-04-26T19:41:18Z", "message": "feat(imports): working tablestructure"}, "afterCommit": {"oid": "5c64f6af101a7358558be7e8f4386b5d367bbb26", "author": {"user": {"login": "clickingbuttons", "name": null}}, "url": "https://github.com/questdb/questdb/commit/5c64f6af101a7358558be7e8f4386b5d367bbb26", "committedDate": "2020-04-26T20:25:32Z", "message": "feat(import): add partitionBy and timestampIndex"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "884dc1700f6999fde0f1d2096318c7bfbee89786", "author": {"user": {"login": "clickingbuttons", "name": null}}, "url": "https://github.com/questdb/questdb/commit/884dc1700f6999fde0f1d2096318c7bfbee89786", "committedDate": "2020-04-26T20:42:54Z", "message": "prevent shooting self in foot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6623a51c7346c18068d9b23ef31167edb060e9c", "author": {"user": {"login": "clickingbuttons", "name": null}}, "url": "https://github.com/questdb/questdb/commit/a6623a51c7346c18068d9b23ef31167edb060e9c", "committedDate": "2020-04-26T21:07:45Z", "message": "fix test snapshot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb9518708811394ba2067f5d783109b8a3d0419f", "author": {"user": {"login": "clickingbuttons", "name": null}}, "url": "https://github.com/questdb/questdb/commit/bb9518708811394ba2067f5d783109b8a3d0419f", "committedDate": "2020-04-26T22:10:47Z", "message": "fix textloader tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMDIxMTM4", "url": "https://github.com/questdb/questdb/pull/236#pullrequestreview-402021138", "createdAt": "2020-04-28T16:42:27Z", "commit": {"oid": "bb9518708811394ba2067f5d783109b8a3d0419f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNjo0MjoyN1rOGNdOaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNjo1NDo1MVrOGNdwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc2MzQ5Ng==", "bodyText": "the name & type check can be done here, here is example:\n        TableStructureAdapter of(ObjList<CharSequence> names, ObjList<TypeAdapter> types) throws TextException {\n            this.names = names;\n            this.types = types;\n            if (timestampIndexCol == null) {\n                timestampIndex = -1;\n            } else {\n                timestampIndex = names.indexOf(timestampIndexCol);\n                if (timestampIndex == -1) {\n                    throw TextException.$(\"invalid timestamp column '\").put(timestampIndexCol).put('\\'');\n                }\n                if (types.getQuick(timestampIndex).getType() != ColumnType.TIMESTAMP) {\n                    throw TextException.$(\"not a timestamp '\").put(timestampIndexCol).put('\\'');\n                }\n            }\n            return this;\n        }", "url": "https://github.com/questdb/questdb/pull/236#discussion_r416763496", "createdAt": "2020-04-28T16:42:27Z", "author": {"login": "bluestreak01"}, "path": "core/src/main/java/io/questdb/cutlass/text/CairoTextWriter.java", "diffHunk": "@@ -320,14 +325,12 @@ public CharSequence getTableName() {\n         }\n \n         @Override\n-        public int getTimestampIndex() {\n-            // not yet on protocol\n-            return -1;\n-        }\n+        public int getTimestampIndex() { return timestampIndex; }\n \n         TableStructureAdapter of(ObjList<CharSequence> names, ObjList<TypeAdapter> types) {\n             this.names = names;\n             this.types = types;\n+            timestampIndex = names.indexOf(timestampIndexCol);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb9518708811394ba2067f5d783109b8a3d0419f"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc2OTgzNQ==", "bodyText": "Additionally at end of prepareTable we could get timestamp adapter only once:\ntimestampAdapter = (TimestampAdapter) types.getQuick(timestampIndex);\nAdditionally i would suggest two lambdas returning Row. One lambda will use timestamp index, the other will get row without timestamp. This will simplify onFields", "url": "https://github.com/questdb/questdb/pull/236#discussion_r416769835", "createdAt": "2020-04-28T16:51:33Z", "author": {"login": "bluestreak01"}, "path": "core/src/main/java/io/questdb/cutlass/text/CairoTextWriter.java", "diffHunk": "@@ -320,14 +325,12 @@ public CharSequence getTableName() {\n         }\n \n         @Override\n-        public int getTimestampIndex() {\n-            // not yet on protocol\n-            return -1;\n-        }\n+        public int getTimestampIndex() { return timestampIndex; }\n \n         TableStructureAdapter of(ObjList<CharSequence> names, ObjList<TypeAdapter> types) {\n             this.names = names;\n             this.types = types;\n+            timestampIndex = names.indexOf(timestampIndexCol);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc2MzQ5Ng=="}, "originalCommit": {"oid": "bb9518708811394ba2067f5d783109b8a3d0419f"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc3MjE0Nw==", "bodyText": "the error handling here needs to either:\n\nWhen atomicity == SKIP_ALL, throw CairoException. There is no need to rollback row, it hasn't been created\ndo the logging but exit method via return.", "url": "https://github.com/questdb/questdb/pull/236#discussion_r416772147", "createdAt": "2020-04-28T16:54:51Z", "author": {"login": "bluestreak01"}, "path": "core/src/main/java/io/questdb/cutlass/text/CairoTextWriter.java", "diffHunk": "@@ -118,17 +115,32 @@ public long getWrittenLineCount() {\n         return writer == null ? 0 : writer.size() - _size;\n     }\n \n-    public void of(CharSequence name, boolean overwrite, boolean durable, int atomicity) {\n+    public void of(CharSequence name, boolean overwrite, boolean durable, int atomicity, int partitionBy, CharSequence timestampIndexCol) {\n         this.tableName = name;\n         this.overwrite = overwrite;\n         this.durable = durable;\n         this.atomicity = atomicity;\n+        this.partitionBy = partitionBy;\n+        this.timestampIndexCol = timestampIndexCol;\n     }\n \n     @Override\n     public void onFields(long line, ObjList<DirectByteCharSequence> values, int valuesLength) {\n-        final TableWriter.Row w = writer.newRow();\n+        long timestamp = 0L;\n+        if (timestampIndex != -1 && types.getQuick(timestampIndex).getType() == ColumnType.TIMESTAMP) {\n+            TimestampAdapter adapter = (TimestampAdapter) types.getQuick(timestampIndex);\n+            final DirectByteCharSequence dbcs = values.getQuick(timestampIndex);\n+            try {\n+                timestamp = adapter.getTimestamp(dbcs);\n+            } catch (NumericException e) {\n+                logError(line, timestampIndex, dbcs);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb9518708811394ba2067f5d783109b8a3d0419f"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d272600e93f1420551304231db7d04218c514dee", "author": {"user": {"login": "clickingbuttons", "name": null}}, "url": "https://github.com/questdb/questdb/commit/d272600e93f1420551304231db7d04218c514dee", "committedDate": "2020-04-28T22:53:55Z", "message": "apply suggested feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ef18291f3f18f9188d3ec148f9bdf1a1584bd8f", "author": {"user": {"login": "clickingbuttons", "name": null}}, "url": "https://github.com/questdb/questdb/commit/0ef18291f3f18f9188d3ec148f9bdf1a1584bd8f", "committedDate": "2020-04-29T21:30:07Z", "message": "fix edge cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f142f20a957e22410b7504b1a5a7d943adaa417c", "author": {"user": {"login": "clickingbuttons", "name": null}}, "url": "https://github.com/questdb/questdb/commit/f142f20a957e22410b7504b1a5a7d943adaa417c", "committedDate": "2020-04-29T23:44:24Z", "message": "fix copytest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMzkzMTIy", "url": "https://github.com/questdb/questdb/pull/236#pullrequestreview-403393122", "createdAt": "2020-04-30T10:26:56Z", "commit": {"oid": "f142f20a957e22410b7504b1a5a7d943adaa417c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3302, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}