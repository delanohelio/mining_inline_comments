{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE1MTE2NTY3", "number": 8918, "title": "custom poi types cache db", "bodyText": "", "createdAt": "2020-05-08T08:29:11Z", "url": "https://github.com/osmandapp/OsmAnd/pull/8918", "merged": true, "mergeCommit": {"oid": "392d69dd66278e9a6417c03c03e7496a64554773"}, "closed": true, "closedAt": "2020-05-18T13:23:06Z", "author": {"login": "veliymolfar"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfNndYAH2gAyNDE1MTE2NTY3OmMwMmE3ODIwZmE0MWYxZDVjYzMwZjBlNTIwMTVjZDMzYmU5YTQxYmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcifxYTAH2gAyNDE1MTE2NTY3OmM5MDZmY2FiNWIyOGU3YzAwMGFkNGJjMDMwOGY5ZTM0ZThkNzQxYjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c02a7820fa41f1d5cc30f0e52015cd33be9a41ba", "author": {"user": null}, "url": "https://github.com/osmandapp/OsmAnd/commit/c02a7820fa41f1d5cc30f0e52015cd33be9a41ba", "committedDate": "2020-05-08T08:29:36Z", "message": "custom poi types cache db"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb6980ff2db59b24dde5795532292b1cd57b6ae7", "author": {"user": null}, "url": "https://github.com/osmandapp/OsmAnd/commit/bb6980ff2db59b24dde5795532292b1cd57b6ae7", "committedDate": "2020-05-12T13:16:43Z", "message": "corrections"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861", "author": {"user": null}, "url": "https://github.com/osmandapp/OsmAnd/commit/165d1430e3e081d8b76c6a34bab6428647836861", "committedDate": "2020-05-12T14:39:03Z", "message": "refactor PoiHelper"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNjI5ODg1", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#pullrequestreview-411629885", "createdAt": "2020-05-14T09:33:43Z", "commit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTozMzo0M1rOGVUCcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTozMzo0M1rOGVUCcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAwMTU4NA==", "bodyText": "Bad class naming, couldn't be part of PoiFiltersDBHelper and same db?", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#discussion_r425001584", "createdAt": "2020-05-14T09:33:43Z", "author": {"login": "vshcherb"}, "path": "OsmAnd/src/net/osmand/plus/poi/PoiHelper.java", "diffHunk": "@@ -0,0 +1,321 @@\n+package net.osmand.plus.poi;\n+\n+\n+import android.annotation.SuppressLint;\n+import android.os.AsyncTask;\n+\n+import androidx.annotation.NonNull;\n+\n+import net.osmand.PlatformUtil;\n+import net.osmand.binary.BinaryMapIndexReader;\n+import net.osmand.osm.MapPoiTypes;\n+import net.osmand.osm.PoiCategory;\n+import net.osmand.osm.PoiType;\n+import net.osmand.plus.OsmandApplication;\n+import net.osmand.plus.activities.LocalIndexHelper;\n+import net.osmand.plus.activities.LocalIndexInfo;\n+import net.osmand.plus.api.SQLiteAPI;\n+import net.osmand.plus.download.ui.AbstractLoadLocalIndexTask;\n+\n+import org.apache.commons.logging.Log;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class PoiHelper {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNjMxMDky", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#pullrequestreview-411631092", "createdAt": "2020-05-14T09:35:15Z", "commit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTozNToxNVrOGVUFzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTozNToxNVrOGVUFzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAwMjQ0NQ==", "bodyText": "Bad link, Helpers/Serice connected to OsmAndApplication shouldn't use LocalIndexInfo/LocalIndexHelper which are UI classes at all. Static methods are also bad", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#discussion_r425002445", "createdAt": "2020-05-14T09:35:15Z", "author": {"login": "vshcherb"}, "path": "OsmAnd/src/net/osmand/plus/poi/PoiHelper.java", "diffHunk": "@@ -0,0 +1,321 @@\n+package net.osmand.plus.poi;\n+\n+\n+import android.annotation.SuppressLint;\n+import android.os.AsyncTask;\n+\n+import androidx.annotation.NonNull;\n+\n+import net.osmand.PlatformUtil;\n+import net.osmand.binary.BinaryMapIndexReader;\n+import net.osmand.osm.MapPoiTypes;\n+import net.osmand.osm.PoiCategory;\n+import net.osmand.osm.PoiType;\n+import net.osmand.plus.OsmandApplication;\n+import net.osmand.plus.activities.LocalIndexHelper;\n+import net.osmand.plus.activities.LocalIndexInfo;\n+import net.osmand.plus.api.SQLiteAPI;\n+import net.osmand.plus.download.ui.AbstractLoadLocalIndexTask;\n+\n+import org.apache.commons.logging.Log;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class PoiHelper {\n+\n+\tprivate static final Log LOG = PlatformUtil.getLog(PoiHelper.class);\n+\tprivate OsmandApplication app;\n+\tprivate PoiDbHelper helper;\n+\tprivate Map<String, Long> files;\n+\tprivate Map<String, List<String>> categories;\n+\n+\tpublic PoiHelper(OsmandApplication app) {\n+\t\tthis.app = app;\n+\t\thelper = new PoiDbHelper(app);\n+\t}\n+\n+\tpublic Map<String, Long> getFiles() {\n+\t\tif (files == null) {\n+\t\t\tfiles = helper.getFiles();\n+\t\t}\n+\t\treturn files;\n+\t}\n+\n+\tpublic Map<String, List<String>> getCategories() {\n+\t\tif (categories == null) {\n+\t\t\tcategories = helper.getCategories();\n+\t\t}\n+\t\treturn categories;\n+\t}\n+\n+\tpublic void readPoiTypesFromMap() {\n+\t\tLocalIndexHelper localIndexHelper = new LocalIndexHelper(app);\n+\t\tList<LocalIndexInfo> localMapsIndexes = localIndexHelper.getLocalFullMaps(new AbstractLoadLocalIndexTask() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNjMxOTIz", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#pullrequestreview-411631923", "createdAt": "2020-05-14T09:36:12Z", "commit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTozNjoxMlrOGVUINQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTozNjoxMlrOGVUINQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAwMzA2MQ==", "bodyText": "Shouldn't be async cause initialization of all maps is already async and it should be part of map initialization processes", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#discussion_r425003061", "createdAt": "2020-05-14T09:36:12Z", "author": {"login": "vshcherb"}, "path": "OsmAnd/src/net/osmand/plus/poi/PoiHelper.java", "diffHunk": "@@ -0,0 +1,321 @@\n+package net.osmand.plus.poi;\n+\n+\n+import android.annotation.SuppressLint;\n+import android.os.AsyncTask;\n+\n+import androidx.annotation.NonNull;\n+\n+import net.osmand.PlatformUtil;\n+import net.osmand.binary.BinaryMapIndexReader;\n+import net.osmand.osm.MapPoiTypes;\n+import net.osmand.osm.PoiCategory;\n+import net.osmand.osm.PoiType;\n+import net.osmand.plus.OsmandApplication;\n+import net.osmand.plus.activities.LocalIndexHelper;\n+import net.osmand.plus.activities.LocalIndexInfo;\n+import net.osmand.plus.api.SQLiteAPI;\n+import net.osmand.plus.download.ui.AbstractLoadLocalIndexTask;\n+\n+import org.apache.commons.logging.Log;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class PoiHelper {\n+\n+\tprivate static final Log LOG = PlatformUtil.getLog(PoiHelper.class);\n+\tprivate OsmandApplication app;\n+\tprivate PoiDbHelper helper;\n+\tprivate Map<String, Long> files;\n+\tprivate Map<String, List<String>> categories;\n+\n+\tpublic PoiHelper(OsmandApplication app) {\n+\t\tthis.app = app;\n+\t\thelper = new PoiDbHelper(app);\n+\t}\n+\n+\tpublic Map<String, Long> getFiles() {\n+\t\tif (files == null) {\n+\t\t\tfiles = helper.getFiles();\n+\t\t}\n+\t\treturn files;\n+\t}\n+\n+\tpublic Map<String, List<String>> getCategories() {\n+\t\tif (categories == null) {\n+\t\t\tcategories = helper.getCategories();\n+\t\t}\n+\t\treturn categories;\n+\t}\n+\n+\tpublic void readPoiTypesFromMap() {\n+\t\tLocalIndexHelper localIndexHelper = new LocalIndexHelper(app);\n+\t\tList<LocalIndexInfo> localMapsIndexes = localIndexHelper.getLocalFullMaps(new AbstractLoadLocalIndexTask() {\n+\t\t\t@Override\n+\t\t\tpublic void loadFile(LocalIndexInfo... loaded) {\n+\t\t\t}\n+\t\t});\n+\t\tMap<String, Long> savedFiles = getFiles();\n+\t\tif (savedFiles.size() == localMapsIndexes.size()) {\n+\t\t\tfor (LocalIndexInfo info : localMapsIndexes) {\n+\t\t\t\tFile f = new File(info.getPathToData());\n+\t\t\t\tString name = f.getName();\n+\t\t\t\tlong date = f.lastModified();\n+\t\t\t\tif (!savedFiles.containsKey(name) || savedFiles.get(name) != date) {\n+\t\t\t\t\tinitCategoriesFromFiles();\n+\t\t\t\t\treplaceSavedFiles(localMapsIndexes);\n+\t\t\t\t\treturn;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} else {\n+\t\t\tinitCategoriesFromFiles();\n+\t\t\treplaceSavedFiles(localMapsIndexes);\n+\t\t\treturn;\n+\t\t}\n+\t\treadCategoriesFromDb();\n+\t}\n+\n+\t@SuppressLint(\"StaticFieldLeak\")\n+\tpublic void readPoiTypesFromMapAsync() {\n+\t\tnew AsyncTask<Void, Void, Void>() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "originalPosition": 87}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNjMyOTEy", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#pullrequestreview-411632912", "createdAt": "2020-05-14T09:37:29Z", "commit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTozNzoyOVrOGVULCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTozNzoyOVrOGVULCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAwMzc4NA==", "bodyText": "BinaryMapIndexReader shouldn't use at all MapPoiTypes, looks like it was bad design from previous request.", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#discussion_r425003784", "createdAt": "2020-05-14T09:37:29Z", "author": {"login": "vshcherb"}, "path": "OsmAnd/src/net/osmand/plus/poi/PoiHelper.java", "diffHunk": "@@ -0,0 +1,321 @@\n+package net.osmand.plus.poi;\n+\n+\n+import android.annotation.SuppressLint;\n+import android.os.AsyncTask;\n+\n+import androidx.annotation.NonNull;\n+\n+import net.osmand.PlatformUtil;\n+import net.osmand.binary.BinaryMapIndexReader;\n+import net.osmand.osm.MapPoiTypes;\n+import net.osmand.osm.PoiCategory;\n+import net.osmand.osm.PoiType;\n+import net.osmand.plus.OsmandApplication;\n+import net.osmand.plus.activities.LocalIndexHelper;\n+import net.osmand.plus.activities.LocalIndexInfo;\n+import net.osmand.plus.api.SQLiteAPI;\n+import net.osmand.plus.download.ui.AbstractLoadLocalIndexTask;\n+\n+import org.apache.commons.logging.Log;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class PoiHelper {\n+\n+\tprivate static final Log LOG = PlatformUtil.getLog(PoiHelper.class);\n+\tprivate OsmandApplication app;\n+\tprivate PoiDbHelper helper;\n+\tprivate Map<String, Long> files;\n+\tprivate Map<String, List<String>> categories;\n+\n+\tpublic PoiHelper(OsmandApplication app) {\n+\t\tthis.app = app;\n+\t\thelper = new PoiDbHelper(app);\n+\t}\n+\n+\tpublic Map<String, Long> getFiles() {\n+\t\tif (files == null) {\n+\t\t\tfiles = helper.getFiles();\n+\t\t}\n+\t\treturn files;\n+\t}\n+\n+\tpublic Map<String, List<String>> getCategories() {\n+\t\tif (categories == null) {\n+\t\t\tcategories = helper.getCategories();\n+\t\t}\n+\t\treturn categories;\n+\t}\n+\n+\tpublic void readPoiTypesFromMap() {\n+\t\tLocalIndexHelper localIndexHelper = new LocalIndexHelper(app);\n+\t\tList<LocalIndexInfo> localMapsIndexes = localIndexHelper.getLocalFullMaps(new AbstractLoadLocalIndexTask() {\n+\t\t\t@Override\n+\t\t\tpublic void loadFile(LocalIndexInfo... loaded) {\n+\t\t\t}\n+\t\t});\n+\t\tMap<String, Long> savedFiles = getFiles();\n+\t\tif (savedFiles.size() == localMapsIndexes.size()) {\n+\t\t\tfor (LocalIndexInfo info : localMapsIndexes) {\n+\t\t\t\tFile f = new File(info.getPathToData());\n+\t\t\t\tString name = f.getName();\n+\t\t\t\tlong date = f.lastModified();\n+\t\t\t\tif (!savedFiles.containsKey(name) || savedFiles.get(name) != date) {\n+\t\t\t\t\tinitCategoriesFromFiles();\n+\t\t\t\t\treplaceSavedFiles(localMapsIndexes);\n+\t\t\t\t\treturn;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} else {\n+\t\t\tinitCategoriesFromFiles();\n+\t\t\treplaceSavedFiles(localMapsIndexes);\n+\t\t\treturn;\n+\t\t}\n+\t\treadCategoriesFromDb();\n+\t}\n+\n+\t@SuppressLint(\"StaticFieldLeak\")\n+\tpublic void readPoiTypesFromMapAsync() {\n+\t\tnew AsyncTask<Void, Void, Void>() {\n+\n+\t\t\t@Override\n+\t\t\tprotected Void doInBackground(Void... voids) {\n+\t\t\t\tapp.getPoiTypes().init();\n+\t\t\t\treadPoiTypesFromMap();\n+\t\t\t\treturn null;\n+\t\t\t}\n+\t\t}.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);\n+\t}\n+\n+\tprivate void readCategoriesFromDb() {\n+\t\tfor (Map.Entry<String, List<String>> entry : getCategories().entrySet()) {\n+\t\t\tPoiCategory poiCategory = app.getPoiTypes().getPoiCategoryByName(entry.getKey(), true);\n+\t\t\tfor (String s : entry.getValue()) {\n+\t\t\t\tPoiType poiType = new PoiType(MapPoiTypes.getDefault(), poiCategory, null, s);\n+\t\t\t\tList<String> filters = new ArrayList<>();\n+\t\t\t\tfor (PoiType poi : poiCategory.getPoiTypes()) {\n+\t\t\t\t\tfilters.add(poi.getKeyName());\n+\t\t\t\t}\n+\t\t\t\tif (!filters.contains(s)) {\n+\t\t\t\t\tpoiCategory.getPoiTypes().add(poiType);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\tprivate void replaceSavedFiles(List<LocalIndexInfo> localMapsIndexes) {\n+\t\tfiles.clear();\n+\t\thelper.deleteFilesTable();\n+\t\tfor (LocalIndexInfo info : localMapsIndexes) {\n+\t\t\tFile f = new File(info.getPathToData());\n+\t\t\thelper.addFile(f);\n+\t\t\tfiles.put(f.getName(), f.lastModified());\n+\t\t}\n+\t\thelper.close();\n+\t}\n+\n+\tprivate void initCategoriesFromFiles() {\n+\t\tapp.getPoiTypes().clearCreatedCategories();\n+\t\tfinal BinaryMapIndexReader[] currentFile = app.getResourceManager().getPoiSearchFiles();\n+\t\tfor (BinaryMapIndexReader r : currentFile) {\n+\t\t\ttry {\n+\t\t\t\tr.initCategories();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "originalPosition": 130}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNjM0MjI5", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#pullrequestreview-411634229", "createdAt": "2020-05-14T09:39:11Z", "commit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTozOToxMVrOGVUO2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTozOToxMVrOGVUO2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAwNDc2Mg==", "bodyText": "Bad naming - createdCategories?", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#discussion_r425004762", "createdAt": "2020-05-14T09:39:11Z", "author": {"login": "vshcherb"}, "path": "OsmAnd-java/src/main/java/net/osmand/osm/MapPoiTypes.java", "diffHunk": "@@ -33,6 +33,7 @@\n \tprivate static final Log log = PlatformUtil.getLog(MapRenderingTypes.class);\n \tprivate String resourceName;\n \tprivate List<PoiCategory> categories = new ArrayList<PoiCategory>();\n+\tprivate List<PoiCategory> createdCategories = new ArrayList<PoiCategory>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNjM2MTM1", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#pullrequestreview-411636135", "createdAt": "2020-05-14T09:41:29Z", "commit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTo0MTozMFrOGVUUww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTo0MTozMFrOGVUUww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAwNjI3NQ==", "bodyText": "Wrong table design", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#discussion_r425006275", "createdAt": "2020-05-14T09:41:30Z", "author": {"login": "vshcherb"}, "path": "OsmAnd/src/net/osmand/plus/poi/PoiHelper.java", "diffHunk": "@@ -0,0 +1,321 @@\n+package net.osmand.plus.poi;\n+\n+\n+import android.annotation.SuppressLint;\n+import android.os.AsyncTask;\n+\n+import androidx.annotation.NonNull;\n+\n+import net.osmand.PlatformUtil;\n+import net.osmand.binary.BinaryMapIndexReader;\n+import net.osmand.osm.MapPoiTypes;\n+import net.osmand.osm.PoiCategory;\n+import net.osmand.osm.PoiType;\n+import net.osmand.plus.OsmandApplication;\n+import net.osmand.plus.activities.LocalIndexHelper;\n+import net.osmand.plus.activities.LocalIndexInfo;\n+import net.osmand.plus.api.SQLiteAPI;\n+import net.osmand.plus.download.ui.AbstractLoadLocalIndexTask;\n+\n+import org.apache.commons.logging.Log;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class PoiHelper {\n+\n+\tprivate static final Log LOG = PlatformUtil.getLog(PoiHelper.class);\n+\tprivate OsmandApplication app;\n+\tprivate PoiDbHelper helper;\n+\tprivate Map<String, Long> files;\n+\tprivate Map<String, List<String>> categories;\n+\n+\tpublic PoiHelper(OsmandApplication app) {\n+\t\tthis.app = app;\n+\t\thelper = new PoiDbHelper(app);\n+\t}\n+\n+\tpublic Map<String, Long> getFiles() {\n+\t\tif (files == null) {\n+\t\t\tfiles = helper.getFiles();\n+\t\t}\n+\t\treturn files;\n+\t}\n+\n+\tpublic Map<String, List<String>> getCategories() {\n+\t\tif (categories == null) {\n+\t\t\tcategories = helper.getCategories();\n+\t\t}\n+\t\treturn categories;\n+\t}\n+\n+\tpublic void readPoiTypesFromMap() {\n+\t\tLocalIndexHelper localIndexHelper = new LocalIndexHelper(app);\n+\t\tList<LocalIndexInfo> localMapsIndexes = localIndexHelper.getLocalFullMaps(new AbstractLoadLocalIndexTask() {\n+\t\t\t@Override\n+\t\t\tpublic void loadFile(LocalIndexInfo... loaded) {\n+\t\t\t}\n+\t\t});\n+\t\tMap<String, Long> savedFiles = getFiles();\n+\t\tif (savedFiles.size() == localMapsIndexes.size()) {\n+\t\t\tfor (LocalIndexInfo info : localMapsIndexes) {\n+\t\t\t\tFile f = new File(info.getPathToData());\n+\t\t\t\tString name = f.getName();\n+\t\t\t\tlong date = f.lastModified();\n+\t\t\t\tif (!savedFiles.containsKey(name) || savedFiles.get(name) != date) {\n+\t\t\t\t\tinitCategoriesFromFiles();\n+\t\t\t\t\treplaceSavedFiles(localMapsIndexes);\n+\t\t\t\t\treturn;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} else {\n+\t\t\tinitCategoriesFromFiles();\n+\t\t\treplaceSavedFiles(localMapsIndexes);\n+\t\t\treturn;\n+\t\t}\n+\t\treadCategoriesFromDb();\n+\t}\n+\n+\t@SuppressLint(\"StaticFieldLeak\")\n+\tpublic void readPoiTypesFromMapAsync() {\n+\t\tnew AsyncTask<Void, Void, Void>() {\n+\n+\t\t\t@Override\n+\t\t\tprotected Void doInBackground(Void... voids) {\n+\t\t\t\tapp.getPoiTypes().init();\n+\t\t\t\treadPoiTypesFromMap();\n+\t\t\t\treturn null;\n+\t\t\t}\n+\t\t}.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);\n+\t}\n+\n+\tprivate void readCategoriesFromDb() {\n+\t\tfor (Map.Entry<String, List<String>> entry : getCategories().entrySet()) {\n+\t\t\tPoiCategory poiCategory = app.getPoiTypes().getPoiCategoryByName(entry.getKey(), true);\n+\t\t\tfor (String s : entry.getValue()) {\n+\t\t\t\tPoiType poiType = new PoiType(MapPoiTypes.getDefault(), poiCategory, null, s);\n+\t\t\t\tList<String> filters = new ArrayList<>();\n+\t\t\t\tfor (PoiType poi : poiCategory.getPoiTypes()) {\n+\t\t\t\t\tfilters.add(poi.getKeyName());\n+\t\t\t\t}\n+\t\t\t\tif (!filters.contains(s)) {\n+\t\t\t\t\tpoiCategory.getPoiTypes().add(poiType);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\tprivate void replaceSavedFiles(List<LocalIndexInfo> localMapsIndexes) {\n+\t\tfiles.clear();\n+\t\thelper.deleteFilesTable();\n+\t\tfor (LocalIndexInfo info : localMapsIndexes) {\n+\t\t\tFile f = new File(info.getPathToData());\n+\t\t\thelper.addFile(f);\n+\t\t\tfiles.put(f.getName(), f.lastModified());\n+\t\t}\n+\t\thelper.close();\n+\t}\n+\n+\tprivate void initCategoriesFromFiles() {\n+\t\tapp.getPoiTypes().clearCreatedCategories();\n+\t\tfinal BinaryMapIndexReader[] currentFile = app.getResourceManager().getPoiSearchFiles();\n+\t\tfor (BinaryMapIndexReader r : currentFile) {\n+\t\t\ttry {\n+\t\t\t\tr.initCategories();\n+\t\t\t} catch (IOException e) {\n+\t\t\t\tLOG.error(\"Error while read poi types from map \" + e);\n+\t\t\t}\n+\t\t}\n+\t\treplaceSavedCategories(app.getPoiTypes().getCreatedCategories());\n+\t}\n+\n+\tprivate void replaceSavedCategories(List<PoiCategory> poiCategories) {\n+\t\tcategories.clear();\n+\t\thelper.deletePoiTypesTable();\n+\t\tfor (PoiCategory category : poiCategories) {\n+\t\t\thelper.addCategory(category);\n+\t\t\tcategories.put(category.getKeyName(), getSubCategoriesFilters(category.getPoiTypes()));\n+\t\t}\n+\t\thelper.close();\n+\t}\n+\n+\tprivate List<String> getSubCategoriesFilters(List<PoiType> poiTypeList) {\n+\t\tList<String> filters = new ArrayList<>();\n+\t\tfor (PoiType poiType : poiTypeList) {\n+\t\t\tfilters.add(poiType.getKeyName());\n+\t\t}\n+\t\treturn filters;\n+\t}\n+\n+\tpublic class PoiDbHelper {\n+\n+\t\tprivate static final String DATABASE_NAME = \"poi_types_cache\";\n+\t\tprivate static final int DATABASE_VERSION = 1;\n+\n+\t\tprivate static final String FILES_TABLE_NAME = \"files\";\n+\t\tprivate static final String FILE_NAME = \"name\";\n+\t\tprivate static final String FILE_DATE = \"date\";\n+\n+\t\tprivate static final String FILES_TABLE_CREATE = \"CREATE TABLE \" +\n+\t\t\t\tFILES_TABLE_NAME + \" (\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "originalPosition": 166}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNjM3NzMy", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#pullrequestreview-411637732", "createdAt": "2020-05-14T09:43:31Z", "commit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTo0MzozMlrOGVUZ2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTo0MzozMlrOGVUZ2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAwNzU3OQ==", "bodyText": "Probably this is not needed at all.", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#discussion_r425007579", "createdAt": "2020-05-14T09:43:32Z", "author": {"login": "vshcherb"}, "path": "OsmAnd/src/net/osmand/plus/AppInitializer.java", "diffHunk": "@@ -550,6 +539,7 @@ public void onCreateApplication() {\n \t\tapp.lockHelper = startupInit(new LockHelper(app), LockHelper.class);\n \t\tapp.settingsHelper = startupInit(new SettingsHelper(app), SettingsHelper.class);\n \t\tapp.quickActionRegistry = startupInit(new QuickActionRegistry(app.getSettings()), QuickActionRegistry.class);\n+\t\tapp.poiHelper = startupInit(new PoiHelper(app), PoiHelper.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNjQyNjA0", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#pullrequestreview-411642604", "createdAt": "2020-05-14T09:49:38Z", "commit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTo0OTozOFrOGVUomQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTo0OTozOFrOGVUomQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAxMTM1Mw==", "bodyText": "List.contains ?", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#discussion_r425011353", "createdAt": "2020-05-14T09:49:38Z", "author": {"login": "vshcherb"}, "path": "OsmAnd/src/net/osmand/plus/poi/PoiHelper.java", "diffHunk": "@@ -0,0 +1,321 @@\n+package net.osmand.plus.poi;\n+\n+\n+import android.annotation.SuppressLint;\n+import android.os.AsyncTask;\n+\n+import androidx.annotation.NonNull;\n+\n+import net.osmand.PlatformUtil;\n+import net.osmand.binary.BinaryMapIndexReader;\n+import net.osmand.osm.MapPoiTypes;\n+import net.osmand.osm.PoiCategory;\n+import net.osmand.osm.PoiType;\n+import net.osmand.plus.OsmandApplication;\n+import net.osmand.plus.activities.LocalIndexHelper;\n+import net.osmand.plus.activities.LocalIndexInfo;\n+import net.osmand.plus.api.SQLiteAPI;\n+import net.osmand.plus.download.ui.AbstractLoadLocalIndexTask;\n+\n+import org.apache.commons.logging.Log;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class PoiHelper {\n+\n+\tprivate static final Log LOG = PlatformUtil.getLog(PoiHelper.class);\n+\tprivate OsmandApplication app;\n+\tprivate PoiDbHelper helper;\n+\tprivate Map<String, Long> files;\n+\tprivate Map<String, List<String>> categories;\n+\n+\tpublic PoiHelper(OsmandApplication app) {\n+\t\tthis.app = app;\n+\t\thelper = new PoiDbHelper(app);\n+\t}\n+\n+\tpublic Map<String, Long> getFiles() {\n+\t\tif (files == null) {\n+\t\t\tfiles = helper.getFiles();\n+\t\t}\n+\t\treturn files;\n+\t}\n+\n+\tpublic Map<String, List<String>> getCategories() {\n+\t\tif (categories == null) {\n+\t\t\tcategories = helper.getCategories();\n+\t\t}\n+\t\treturn categories;\n+\t}\n+\n+\tpublic void readPoiTypesFromMap() {\n+\t\tLocalIndexHelper localIndexHelper = new LocalIndexHelper(app);\n+\t\tList<LocalIndexInfo> localMapsIndexes = localIndexHelper.getLocalFullMaps(new AbstractLoadLocalIndexTask() {\n+\t\t\t@Override\n+\t\t\tpublic void loadFile(LocalIndexInfo... loaded) {\n+\t\t\t}\n+\t\t});\n+\t\tMap<String, Long> savedFiles = getFiles();\n+\t\tif (savedFiles.size() == localMapsIndexes.size()) {\n+\t\t\tfor (LocalIndexInfo info : localMapsIndexes) {\n+\t\t\t\tFile f = new File(info.getPathToData());\n+\t\t\t\tString name = f.getName();\n+\t\t\t\tlong date = f.lastModified();\n+\t\t\t\tif (!savedFiles.containsKey(name) || savedFiles.get(name) != date) {\n+\t\t\t\t\tinitCategoriesFromFiles();\n+\t\t\t\t\treplaceSavedFiles(localMapsIndexes);\n+\t\t\t\t\treturn;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} else {\n+\t\t\tinitCategoriesFromFiles();\n+\t\t\treplaceSavedFiles(localMapsIndexes);\n+\t\t\treturn;\n+\t\t}\n+\t\treadCategoriesFromDb();\n+\t}\n+\n+\t@SuppressLint(\"StaticFieldLeak\")\n+\tpublic void readPoiTypesFromMapAsync() {\n+\t\tnew AsyncTask<Void, Void, Void>() {\n+\n+\t\t\t@Override\n+\t\t\tprotected Void doInBackground(Void... voids) {\n+\t\t\t\tapp.getPoiTypes().init();\n+\t\t\t\treadPoiTypesFromMap();\n+\t\t\t\treturn null;\n+\t\t\t}\n+\t\t}.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);\n+\t}\n+\n+\tprivate void readCategoriesFromDb() {\n+\t\tfor (Map.Entry<String, List<String>> entry : getCategories().entrySet()) {\n+\t\t\tPoiCategory poiCategory = app.getPoiTypes().getPoiCategoryByName(entry.getKey(), true);\n+\t\t\tfor (String s : entry.getValue()) {\n+\t\t\t\tPoiType poiType = new PoiType(MapPoiTypes.getDefault(), poiCategory, null, s);\n+\t\t\t\tList<String> filters = new ArrayList<>();\n+\t\t\t\tfor (PoiType poi : poiCategory.getPoiTypes()) {\n+\t\t\t\t\tfilters.add(poi.getKeyName());\n+\t\t\t\t}\n+\t\t\t\tif (!filters.contains(s)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "originalPosition": 107}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNjQyOTcw", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#pullrequestreview-411642970", "createdAt": "2020-05-14T09:50:07Z", "commit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTo1MDowN1rOGVUpzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTo1MDowN1rOGVUpzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAxMTY2MQ==", "bodyText": "First create, then check?", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#discussion_r425011661", "createdAt": "2020-05-14T09:50:07Z", "author": {"login": "vshcherb"}, "path": "OsmAnd/src/net/osmand/plus/poi/PoiHelper.java", "diffHunk": "@@ -0,0 +1,321 @@\n+package net.osmand.plus.poi;\n+\n+\n+import android.annotation.SuppressLint;\n+import android.os.AsyncTask;\n+\n+import androidx.annotation.NonNull;\n+\n+import net.osmand.PlatformUtil;\n+import net.osmand.binary.BinaryMapIndexReader;\n+import net.osmand.osm.MapPoiTypes;\n+import net.osmand.osm.PoiCategory;\n+import net.osmand.osm.PoiType;\n+import net.osmand.plus.OsmandApplication;\n+import net.osmand.plus.activities.LocalIndexHelper;\n+import net.osmand.plus.activities.LocalIndexInfo;\n+import net.osmand.plus.api.SQLiteAPI;\n+import net.osmand.plus.download.ui.AbstractLoadLocalIndexTask;\n+\n+import org.apache.commons.logging.Log;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class PoiHelper {\n+\n+\tprivate static final Log LOG = PlatformUtil.getLog(PoiHelper.class);\n+\tprivate OsmandApplication app;\n+\tprivate PoiDbHelper helper;\n+\tprivate Map<String, Long> files;\n+\tprivate Map<String, List<String>> categories;\n+\n+\tpublic PoiHelper(OsmandApplication app) {\n+\t\tthis.app = app;\n+\t\thelper = new PoiDbHelper(app);\n+\t}\n+\n+\tpublic Map<String, Long> getFiles() {\n+\t\tif (files == null) {\n+\t\t\tfiles = helper.getFiles();\n+\t\t}\n+\t\treturn files;\n+\t}\n+\n+\tpublic Map<String, List<String>> getCategories() {\n+\t\tif (categories == null) {\n+\t\t\tcategories = helper.getCategories();\n+\t\t}\n+\t\treturn categories;\n+\t}\n+\n+\tpublic void readPoiTypesFromMap() {\n+\t\tLocalIndexHelper localIndexHelper = new LocalIndexHelper(app);\n+\t\tList<LocalIndexInfo> localMapsIndexes = localIndexHelper.getLocalFullMaps(new AbstractLoadLocalIndexTask() {\n+\t\t\t@Override\n+\t\t\tpublic void loadFile(LocalIndexInfo... loaded) {\n+\t\t\t}\n+\t\t});\n+\t\tMap<String, Long> savedFiles = getFiles();\n+\t\tif (savedFiles.size() == localMapsIndexes.size()) {\n+\t\t\tfor (LocalIndexInfo info : localMapsIndexes) {\n+\t\t\t\tFile f = new File(info.getPathToData());\n+\t\t\t\tString name = f.getName();\n+\t\t\t\tlong date = f.lastModified();\n+\t\t\t\tif (!savedFiles.containsKey(name) || savedFiles.get(name) != date) {\n+\t\t\t\t\tinitCategoriesFromFiles();\n+\t\t\t\t\treplaceSavedFiles(localMapsIndexes);\n+\t\t\t\t\treturn;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} else {\n+\t\t\tinitCategoriesFromFiles();\n+\t\t\treplaceSavedFiles(localMapsIndexes);\n+\t\t\treturn;\n+\t\t}\n+\t\treadCategoriesFromDb();\n+\t}\n+\n+\t@SuppressLint(\"StaticFieldLeak\")\n+\tpublic void readPoiTypesFromMapAsync() {\n+\t\tnew AsyncTask<Void, Void, Void>() {\n+\n+\t\t\t@Override\n+\t\t\tprotected Void doInBackground(Void... voids) {\n+\t\t\t\tapp.getPoiTypes().init();\n+\t\t\t\treadPoiTypesFromMap();\n+\t\t\t\treturn null;\n+\t\t\t}\n+\t\t}.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);\n+\t}\n+\n+\tprivate void readCategoriesFromDb() {\n+\t\tfor (Map.Entry<String, List<String>> entry : getCategories().entrySet()) {\n+\t\t\tPoiCategory poiCategory = app.getPoiTypes().getPoiCategoryByName(entry.getKey(), true);\n+\t\t\tfor (String s : entry.getValue()) {\n+\t\t\t\tPoiType poiType = new PoiType(MapPoiTypes.getDefault(), poiCategory, null, s);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "originalPosition": 102}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNjQzNjI2", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#pullrequestreview-411643626", "createdAt": "2020-05-14T09:50:57Z", "commit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTo1MDo1N1rOGVUsGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTo1MDo1N1rOGVUsGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAxMjI0OQ==", "bodyText": "Should it be method part of POICategory to check?", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#discussion_r425012249", "createdAt": "2020-05-14T09:50:57Z", "author": {"login": "vshcherb"}, "path": "OsmAnd/src/net/osmand/plus/poi/PoiHelper.java", "diffHunk": "@@ -0,0 +1,321 @@\n+package net.osmand.plus.poi;\n+\n+\n+import android.annotation.SuppressLint;\n+import android.os.AsyncTask;\n+\n+import androidx.annotation.NonNull;\n+\n+import net.osmand.PlatformUtil;\n+import net.osmand.binary.BinaryMapIndexReader;\n+import net.osmand.osm.MapPoiTypes;\n+import net.osmand.osm.PoiCategory;\n+import net.osmand.osm.PoiType;\n+import net.osmand.plus.OsmandApplication;\n+import net.osmand.plus.activities.LocalIndexHelper;\n+import net.osmand.plus.activities.LocalIndexInfo;\n+import net.osmand.plus.api.SQLiteAPI;\n+import net.osmand.plus.download.ui.AbstractLoadLocalIndexTask;\n+\n+import org.apache.commons.logging.Log;\n+import org.json.JSONArray;\n+import org.json.JSONException;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class PoiHelper {\n+\n+\tprivate static final Log LOG = PlatformUtil.getLog(PoiHelper.class);\n+\tprivate OsmandApplication app;\n+\tprivate PoiDbHelper helper;\n+\tprivate Map<String, Long> files;\n+\tprivate Map<String, List<String>> categories;\n+\n+\tpublic PoiHelper(OsmandApplication app) {\n+\t\tthis.app = app;\n+\t\thelper = new PoiDbHelper(app);\n+\t}\n+\n+\tpublic Map<String, Long> getFiles() {\n+\t\tif (files == null) {\n+\t\t\tfiles = helper.getFiles();\n+\t\t}\n+\t\treturn files;\n+\t}\n+\n+\tpublic Map<String, List<String>> getCategories() {\n+\t\tif (categories == null) {\n+\t\t\tcategories = helper.getCategories();\n+\t\t}\n+\t\treturn categories;\n+\t}\n+\n+\tpublic void readPoiTypesFromMap() {\n+\t\tLocalIndexHelper localIndexHelper = new LocalIndexHelper(app);\n+\t\tList<LocalIndexInfo> localMapsIndexes = localIndexHelper.getLocalFullMaps(new AbstractLoadLocalIndexTask() {\n+\t\t\t@Override\n+\t\t\tpublic void loadFile(LocalIndexInfo... loaded) {\n+\t\t\t}\n+\t\t});\n+\t\tMap<String, Long> savedFiles = getFiles();\n+\t\tif (savedFiles.size() == localMapsIndexes.size()) {\n+\t\t\tfor (LocalIndexInfo info : localMapsIndexes) {\n+\t\t\t\tFile f = new File(info.getPathToData());\n+\t\t\t\tString name = f.getName();\n+\t\t\t\tlong date = f.lastModified();\n+\t\t\t\tif (!savedFiles.containsKey(name) || savedFiles.get(name) != date) {\n+\t\t\t\t\tinitCategoriesFromFiles();\n+\t\t\t\t\treplaceSavedFiles(localMapsIndexes);\n+\t\t\t\t\treturn;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} else {\n+\t\t\tinitCategoriesFromFiles();\n+\t\t\treplaceSavedFiles(localMapsIndexes);\n+\t\t\treturn;\n+\t\t}\n+\t\treadCategoriesFromDb();\n+\t}\n+\n+\t@SuppressLint(\"StaticFieldLeak\")\n+\tpublic void readPoiTypesFromMapAsync() {\n+\t\tnew AsyncTask<Void, Void, Void>() {\n+\n+\t\t\t@Override\n+\t\t\tprotected Void doInBackground(Void... voids) {\n+\t\t\t\tapp.getPoiTypes().init();\n+\t\t\t\treadPoiTypesFromMap();\n+\t\t\t\treturn null;\n+\t\t\t}\n+\t\t}.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);\n+\t}\n+\n+\tprivate void readCategoriesFromDb() {\n+\t\tfor (Map.Entry<String, List<String>> entry : getCategories().entrySet()) {\n+\t\t\tPoiCategory poiCategory = app.getPoiTypes().getPoiCategoryByName(entry.getKey(), true);\n+\t\t\tfor (String s : entry.getValue()) {\n+\t\t\t\tPoiType poiType = new PoiType(MapPoiTypes.getDefault(), poiCategory, null, s);\n+\t\t\t\tList<String> filters = new ArrayList<>();\n+\t\t\t\tfor (PoiType poi : poiCategory.getPoiTypes()) {\n+\t\t\t\t\tfilters.add(poi.getKeyName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "originalPosition": 105}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNjUzNjc3", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#pullrequestreview-411653677", "createdAt": "2020-05-14T10:03:30Z", "commit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMDowMzozMFrOGVVKlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMDowMzozMFrOGVVKlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTAyMDA1Mw==", "bodyText": "UI ?", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#discussion_r425020053", "createdAt": "2020-05-14T10:03:30Z", "author": {"login": "vshcherb"}, "path": "OsmAnd/src/net/osmand/plus/download/ui/LocalIndexesFragment.java", "diffHunk": "@@ -632,6 +632,7 @@ protected void onPostExecute(String result) {\n \t\t\t} else {\n \t\t\t\ta.newDownloadIndexes();\n \t\t\t}\n+\t\t\tgetMyApplication().getPoiHelper().readPoiTypesFromMapAsync();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "165d1430e3e081d8b76c6a34bab6428647836861"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccc98d8c8786f074fd9f7aaef05636384338fbd0", "author": {"user": {"login": "veliymolfar", "name": "Dmytro Ruban"}}, "url": "https://github.com/osmandapp/OsmAnd/commit/ccc98d8c8786f074fd9f7aaef05636384338fbd0", "committedDate": "2020-05-15T09:42:46Z", "message": "Merge branches 'create_custom_poi' and 'master' of https://github.com/osmandapp/Osmand into create_custom_poi"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a800d252053003f3f408d8b60319194fe31788a", "author": {"user": {"login": "veliymolfar", "name": "Dmytro Ruban"}}, "url": "https://github.com/osmandapp/OsmAnd/commit/3a800d252053003f3f408d8b60319194fe31788a", "committedDate": "2020-05-18T08:24:41Z", "message": "refactor poi cache db"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNTc1ODIx", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#pullrequestreview-413575821", "createdAt": "2020-05-18T13:08:02Z", "commit": {"oid": "3a800d252053003f3f408d8b60319194fe31788a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMzowODowM1rOGW2V7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxMzowODowM1rOGW2V7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYxMjIwNA==", "bodyText": "?\nIterate in the loop over and check each subtype, it should be faster", "url": "https://github.com/osmandapp/OsmAnd/pull/8918#discussion_r426612204", "createdAt": "2020-05-18T13:08:03Z", "author": {"login": "vshcherb"}, "path": "OsmAnd/src/net/osmand/plus/resources/AmenityIndexRepositoryBinary.java", "diffHunk": "@@ -9,27 +10,79 @@\n import net.osmand.binary.BinaryMapIndexReader.MapIndex;\n import net.osmand.binary.BinaryMapIndexReader.SearchPoiTypeFilter;\n import net.osmand.binary.BinaryMapIndexReader.SearchRequest;\n+import net.osmand.binary.BinaryMapPoiReaderAdapter;\n import net.osmand.data.Amenity;\n+import net.osmand.osm.MapPoiTypes;\n import net.osmand.osm.PoiCategory;\n+import net.osmand.plus.OsmandApplication;\n+import net.osmand.plus.poi.PoiFiltersHelper;\n import net.osmand.plus.resources.ResourceManager.BinaryMapReaderResource;\n import net.osmand.plus.resources.ResourceManager.BinaryMapReaderResourceType;\n import net.osmand.util.MapUtils;\n \n import org.apache.commons.logging.Log;\n \n import java.io.IOException;\n+import java.util.ArrayList;\n import java.util.Collections;\n import java.util.HashMap;\n+import java.util.HashSet;\n import java.util.List;\n import java.util.Map;\n+import java.util.Set;\n \n public class AmenityIndexRepositoryBinary implements AmenityIndexRepository {\n \n \tprivate final static Log log = PlatformUtil.getLog(AmenityIndexRepositoryBinary.class);\n \tprivate BinaryMapReaderResource resource;\n+\tprivate MapPoiTypes poiTypes;\n+\tprivate Map<String, List<String>> poiCategories = new HashMap<>();\n \n-\tpublic AmenityIndexRepositoryBinary(BinaryMapReaderResource resource) {\n+\tpublic AmenityIndexRepositoryBinary(BinaryMapReaderResource resource, OsmandApplication app) {\n \t\tthis.resource = resource;\n+\t\tpoiTypes = app.getPoiTypes();\n+\t\tcheckCachedCategories(app.getPoiFilters());\n+\t}\n+\n+\tpublic Map<String, List<String>> getPoiCategories() {\n+\t\treturn poiCategories;\n+\t}\n+\n+\tprivate void checkCachedCategories(PoiFiltersHelper poiFiltersHelper) {\n+\t\tString fileName = resource.getFileName();\n+\t\tlong lastModified = resource.getFileLastModified();\n+\t\tPair<Long, Map<String, List<String>>> cache = poiFiltersHelper.getCacheByResourceName(fileName);\n+\t\tif (cache == null || cache.first != null && cache.first != lastModified) {\n+\t\t\ttry {\n+\t\t\t\tBinaryMapIndexReader reader = getOpenFile();\n+\t\t\t\tif (reader != null) {\n+\t\t\t\t\treader.initCategories();\n+\t\t\t\t\tList<BinaryMapPoiReaderAdapter.PoiRegion> regions = reader.getPoiIndexes();\n+\t\t\t\t\tfor (BinaryMapPoiReaderAdapter.PoiRegion region : regions) {\n+\t\t\t\t\t\tList<String> categories = region.getCategories();\n+\t\t\t\t\t\tList<List<String>> subCategories = region.getSubcategories();\n+\t\t\t\t\t\tfor (int i = 0; i < categories.size(); i++) {\n+\t\t\t\t\t\t\tPoiCategory poiCategory = poiTypes.getPoiCategoryByName(categories.get(i));\n+\t\t\t\t\t\t\tSet<String> filters = new HashSet<>(subCategories.get(i));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a800d252053003f3f408d8b60319194fe31788a"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c906fcab5b28e7c000ad4bc0308f9e34e8d741b1", "author": {"user": {"login": "vshcherb", "name": null}}, "url": "https://github.com/osmandapp/OsmAnd/commit/c906fcab5b28e7c000ad4bc0308f9e34e8d741b1", "committedDate": "2020-05-18T13:20:30Z", "message": "Small refactoring"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3561, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}