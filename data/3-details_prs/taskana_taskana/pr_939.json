{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3NzQ4Nzk0", "number": 939, "title": "TSK-1131 updateOwner on multiple tasks", "bodyText": "", "createdAt": "2020-02-20T13:15:10Z", "url": "https://github.com/Taskana/taskana/pull/939", "merged": true, "mergeCommit": {"oid": "7dea198c2c1ab3d9dce80aef2f9c64b11745be72"}, "closed": true, "closedAt": "2020-02-26T13:48:52Z", "author": {"login": "BerndBreier"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGLi1fABqjMwNTYxOTExNzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIHBIjgFqTM2NDkwOTU3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4696bdb600780725a3c5349642d224110a2b663a", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/4696bdb600780725a3c5349642d224110a2b663a", "committedDate": "2020-02-20T12:54:20Z", "message": "TSK-1131 updateOwner on multiple tasks"}, "afterCommit": {"oid": "b4824ddce8181e5d2b19a23ad7780c60ac260600", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/b4824ddce8181e5d2b19a23ad7780c60ac260600", "committedDate": "2020-02-20T13:56:13Z", "message": "TSK-1131 updateOwner on multiple tasks"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b4824ddce8181e5d2b19a23ad7780c60ac260600", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/b4824ddce8181e5d2b19a23ad7780c60ac260600", "committedDate": "2020-02-20T13:56:13Z", "message": "TSK-1131 updateOwner on multiple tasks"}, "afterCommit": {"oid": "8dcec2b1348341f569f7d0899f70e88e848b2e28", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/8dcec2b1348341f569f7d0899f70e88e848b2e28", "committedDate": "2020-02-20T14:32:58Z", "message": "TSK-1131 updateOwner on multiple tasks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMzU1NjAx", "url": "https://github.com/Taskana/taskana/pull/939#pullrequestreview-363355601", "createdAt": "2020-02-24T12:32:20Z", "commit": {"oid": "8dcec2b1348341f569f7d0899f70e88e848b2e28"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMjozMjoyMFrOFtfBjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMjo0NDoxM1rOFtfU_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIzODU0Mw==", "bodyText": "This would be better placed in TaskanaEngine or even better in CurrentUserContext?", "url": "https://github.com/Taskana/taskana/pull/939#discussion_r383238543", "createdAt": "2020-02-24T12:32:20Z", "author": {"login": "holgerhagen"}, "path": "lib/taskana-core/src/main/java/pro/taskana/task/internal/TaskServiceImpl.java", "diffHunk": "@@ -757,6 +808,77 @@ Duration calculateDuration(\n     return result;\n   }\n \n+  private void addErrorsToResultObject(\n+      String owner,\n+      BulkOperationResults<String, TaskanaException> bulkLog,\n+      List<MinimalTaskSummary> existingMinimalTaskSummaries) {\n+    for (MinimalTaskSummary taskSummary : existingMinimalTaskSummaries) {\n+      if (!owner.equals(taskSummary.getOwner())) { // owner was not set\n+        if (!taskSummary.getTaskState().equals(TaskState.READY)) { // due to invalid state\n+          bulkLog.addError(\n+              taskSummary.getTaskId(),\n+              new InvalidStateException(\n+                  \"Task \"\n+                      + taskSummary.getTaskId()\n+                      + \" is in state \"\n+                      + taskSummary.getTaskState()));\n+        } else { // due to unknown reason\n+          bulkLog.addError(\n+              taskSummary.getTaskId(),\n+              new UpdateFailedException(\n+                  \"Could not set owner of Task \" + taskSummary.getTaskId() + \".\"));\n+        }\n+      }\n+    }\n+  }\n+\n+  private void handleNonExistingTasks(\n+      List<String> taskIds,\n+      List<MinimalTaskSummary> existingMinimalTaskSummaries,\n+      BulkOperationResults<String, TaskanaException> bulkLog) {\n+    List<String> nonExistingTaskIds = new ArrayList<>(taskIds);\n+    List<String> existingTaskIds =\n+        existingMinimalTaskSummaries.stream()\n+            .map(MinimalTaskSummary::getTaskId)\n+            .collect(Collectors.toList());\n+    nonExistingTaskIds.removeAll(existingTaskIds);\n+    for (String taskId : nonExistingTaskIds) {\n+      bulkLog.addError(taskId, new TaskNotFoundException(taskId, \"Task was not found\"));\n+    }\n+  }\n+\n+  private List<String> filterForAuthorized(\n+      List<String> taskIds, BulkOperationResults<String, TaskanaException> bulkLog) {\n+    List<String> accessIds = getAccessIds();\n+    List<String> tasksAuthorizedFor = new ArrayList<>(taskIds);\n+    if (accessIds != null) {\n+      List<String> tasksNotAuthorizedFor =\n+          taskMapper.filterTaskIdsNotAuthorizedFor(taskIds, accessIds);\n+      tasksAuthorizedFor.removeAll(tasksNotAuthorizedFor);\n+      String currentUserId = CurrentUserContext.getUserid();\n+      for (String taskId : tasksNotAuthorizedFor) {\n+        bulkLog.addError(\n+            taskId,\n+            new NotAuthorizedException(\n+                \"Current user not authorized for task \" + taskId, currentUserId));\n+      }\n+    }\n+    return tasksAuthorizedFor;\n+  }\n+\n+  private List<String> getAccessIds() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8dcec2b1348341f569f7d0899f70e88e848b2e28"}, "originalPosition": 134}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI0MTg5MQ==", "bodyText": "We could move this down to do the preparations before we open the connection. This way we reduce the time the DB connection is used.", "url": "https://github.com/Taskana/taskana/pull/939#discussion_r383241891", "createdAt": "2020-02-24T12:40:13Z", "author": {"login": "holgerhagen"}, "path": "lib/taskana-core/src/main/java/pro/taskana/task/internal/TaskServiceImpl.java", "diffHunk": "@@ -617,6 +619,55 @@ public void forceDeleteTask(String taskId)\n     }\n   }\n \n+  @Override\n+  public BulkOperationResults<String, TaskanaException> setOwnerOfTasks(\n+      String owner, List<String> argTaskIds) {\n+    if (LOGGER.isDebugEnabled()) {\n+      LOGGER.debug(\n+          \"entry to setOwnerOfTasks(owner = {}, tasks = {})\",\n+          owner,\n+          LoggerUtils.listToString(argTaskIds));\n+    }\n+    try {\n+      taskanaEngine.openConnection();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8dcec2b1348341f569f7d0899f70e88e848b2e28"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI0MjE1OA==", "bodyText": "why sorted?", "url": "https://github.com/Taskana/taskana/pull/939#discussion_r383242158", "createdAt": "2020-02-24T12:40:53Z", "author": {"login": "holgerhagen"}, "path": "lib/taskana-core/src/main/java/pro/taskana/task/internal/TaskServiceImpl.java", "diffHunk": "@@ -617,6 +619,55 @@ public void forceDeleteTask(String taskId)\n     }\n   }\n \n+  @Override\n+  public BulkOperationResults<String, TaskanaException> setOwnerOfTasks(\n+      String owner, List<String> argTaskIds) {\n+    if (LOGGER.isDebugEnabled()) {\n+      LOGGER.debug(\n+          \"entry to setOwnerOfTasks(owner = {}, tasks = {})\",\n+          owner,\n+          LoggerUtils.listToString(argTaskIds));\n+    }\n+    try {\n+      taskanaEngine.openConnection();\n+      BulkOperationResults<String, TaskanaException> bulkLog = new BulkOperationResults<>();\n+      if (argTaskIds == null || argTaskIds.isEmpty()) {\n+        return bulkLog;\n+      }\n+      // remove duplicates\n+      List<String> taskIds = argTaskIds.stream().sorted().distinct().collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8dcec2b1348341f569f7d0899f70e88e848b2e28"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI0MjYzNg==", "bodyText": "Cannot we do the authorization check withon the retrieval of the tasks?", "url": "https://github.com/Taskana/taskana/pull/939#discussion_r383242636", "createdAt": "2020-02-24T12:42:03Z", "author": {"login": "holgerhagen"}, "path": "lib/taskana-core/src/main/java/pro/taskana/task/internal/TaskServiceImpl.java", "diffHunk": "@@ -617,6 +619,55 @@ public void forceDeleteTask(String taskId)\n     }\n   }\n \n+  @Override\n+  public BulkOperationResults<String, TaskanaException> setOwnerOfTasks(\n+      String owner, List<String> argTaskIds) {\n+    if (LOGGER.isDebugEnabled()) {\n+      LOGGER.debug(\n+          \"entry to setOwnerOfTasks(owner = {}, tasks = {})\",\n+          owner,\n+          LoggerUtils.listToString(argTaskIds));\n+    }\n+    try {\n+      taskanaEngine.openConnection();\n+      BulkOperationResults<String, TaskanaException> bulkLog = new BulkOperationResults<>();\n+      if (argTaskIds == null || argTaskIds.isEmpty()) {\n+        return bulkLog;\n+      }\n+      // remove duplicates\n+      List<String> taskIds = argTaskIds.stream().sorted().distinct().collect(Collectors.toList());\n+      final int requestSize = taskIds.size();\n+      // use only elements we are authorized for\n+      taskIds = filterForAuthorized(taskIds, bulkLog);\n+      // set the Owner of these tasks we are authorized for\n+      if (taskIds.isEmpty()) {\n+        return bulkLog;\n+      } else {\n+        final int numberOfAffectedTasks = taskMapper.setOwnerOfTasks(owner, taskIds, Instant.now());\n+        // check the outcome\n+        List<MinimalTaskSummary> existingMinimalTaskSummaries =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8dcec2b1348341f569f7d0899f70e88e848b2e28"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI0MzUxOQ==", "bodyText": "Personally I think we could be more precise in the naming. \"AddExceptionForNonExistingTasks\" for example. And isn't it a good practice to return the modified value? In this case the bulklog?", "url": "https://github.com/Taskana/taskana/pull/939#discussion_r383243519", "createdAt": "2020-02-24T12:44:13Z", "author": {"login": "holgerhagen"}, "path": "lib/taskana-core/src/main/java/pro/taskana/task/internal/TaskServiceImpl.java", "diffHunk": "@@ -757,6 +808,77 @@ Duration calculateDuration(\n     return result;\n   }\n \n+  private void addErrorsToResultObject(\n+      String owner,\n+      BulkOperationResults<String, TaskanaException> bulkLog,\n+      List<MinimalTaskSummary> existingMinimalTaskSummaries) {\n+    for (MinimalTaskSummary taskSummary : existingMinimalTaskSummaries) {\n+      if (!owner.equals(taskSummary.getOwner())) { // owner was not set\n+        if (!taskSummary.getTaskState().equals(TaskState.READY)) { // due to invalid state\n+          bulkLog.addError(\n+              taskSummary.getTaskId(),\n+              new InvalidStateException(\n+                  \"Task \"\n+                      + taskSummary.getTaskId()\n+                      + \" is in state \"\n+                      + taskSummary.getTaskState()));\n+        } else { // due to unknown reason\n+          bulkLog.addError(\n+              taskSummary.getTaskId(),\n+              new UpdateFailedException(\n+                  \"Could not set owner of Task \" + taskSummary.getTaskId() + \".\"));\n+        }\n+      }\n+    }\n+  }\n+\n+  private void handleNonExistingTasks(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8dcec2b1348341f569f7d0899f70e88e848b2e28"}, "originalPosition": 100}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8dcec2b1348341f569f7d0899f70e88e848b2e28", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/8dcec2b1348341f569f7d0899f70e88e848b2e28", "committedDate": "2020-02-20T14:32:58Z", "message": "TSK-1131 updateOwner on multiple tasks"}, "afterCommit": {"oid": "8e99b7aeb5da1637d06144d7440de0a0ecf9fdd8", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/8e99b7aeb5da1637d06144d7440de0a0ecf9fdd8", "committedDate": "2020-02-25T08:19:31Z", "message": "TSK-1131 updateOwner Bulk - comments from Holger"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8e99b7aeb5da1637d06144d7440de0a0ecf9fdd8", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/8e99b7aeb5da1637d06144d7440de0a0ecf9fdd8", "committedDate": "2020-02-25T08:19:31Z", "message": "TSK-1131 updateOwner Bulk - comments from Holger"}, "afterCommit": {"oid": "523a6a668ad68cba51804dddaac03e6b4c973202", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/523a6a668ad68cba51804dddaac03e6b4c973202", "committedDate": "2020-02-25T13:36:44Z", "message": "TSK-1131 updateOwner Bulk - comments from Holger"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "523a6a668ad68cba51804dddaac03e6b4c973202", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/523a6a668ad68cba51804dddaac03e6b4c973202", "committedDate": "2020-02-25T13:36:44Z", "message": "TSK-1131 updateOwner Bulk - comments from Holger"}, "afterCommit": {"oid": "6cd2bd61390fbd67d7be976aeeccb8ab0cc03ec4", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/6cd2bd61390fbd67d7be976aeeccb8ab0cc03ec4", "committedDate": "2020-02-25T14:53:28Z", "message": "TSK-1131 updateOwner Bulk - comments from Holger"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6cd2bd61390fbd67d7be976aeeccb8ab0cc03ec4", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/6cd2bd61390fbd67d7be976aeeccb8ab0cc03ec4", "committedDate": "2020-02-25T14:53:28Z", "message": "TSK-1131 updateOwner Bulk - comments from Holger"}, "afterCommit": {"oid": "05b5aec6e45172f4a2739af1a146c42078022199", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/05b5aec6e45172f4a2739af1a146c42078022199", "committedDate": "2020-02-25T14:54:50Z", "message": "TSK-1131 updateOwner Bulk - comments from Holger"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "05b5aec6e45172f4a2739af1a146c42078022199", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/05b5aec6e45172f4a2739af1a146c42078022199", "committedDate": "2020-02-25T14:54:50Z", "message": "TSK-1131 updateOwner Bulk - comments from Holger"}, "afterCommit": {"oid": "2372672d72b9ac7687722c1172738f8a9099f5c4", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/2372672d72b9ac7687722c1172738f8a9099f5c4", "committedDate": "2020-02-25T15:23:38Z", "message": "TSK-1131 updateOwner Bulk - comments from Holger"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2372672d72b9ac7687722c1172738f8a9099f5c4", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/2372672d72b9ac7687722c1172738f8a9099f5c4", "committedDate": "2020-02-25T15:23:38Z", "message": "TSK-1131 updateOwner Bulk - comments from Holger"}, "afterCommit": {"oid": "3ec1ec899f003ca0dec651ee8f2505029d92e240", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/3ec1ec899f003ca0dec651ee8f2505029d92e240", "committedDate": "2020-02-25T15:58:44Z", "message": "TSK-1131 updateOwner Bulk - comments from Holger"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ec1ec899f003ca0dec651ee8f2505029d92e240", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/3ec1ec899f003ca0dec651ee8f2505029d92e240", "committedDate": "2020-02-25T15:58:44Z", "message": "TSK-1131 updateOwner Bulk - comments from Holger"}, "afterCommit": {"oid": "0a38b4158d82100611b98cb9bffd8dd648e87df2", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/0a38b4158d82100611b98cb9bffd8dd648e87df2", "committedDate": "2020-02-26T07:11:32Z", "message": "TSK-1131 updateOwner Bulk - comments from Holger"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f4b8ac62ef7c8b7d5a740ca8b5af34977f85431", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/9f4b8ac62ef7c8b7d5a740ca8b5af34977f85431", "committedDate": "2020-02-26T08:17:07Z", "message": "TSK-1131 updateOwner on multiple tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c92943843c7c7b97d424884254b7d4e086c368b", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/5c92943843c7c7b97d424884254b7d4e086c368b", "committedDate": "2020-02-26T08:35:07Z", "message": "TSK-1131 updateOwner Bulk - comments from Holger"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a38b4158d82100611b98cb9bffd8dd648e87df2", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/0a38b4158d82100611b98cb9bffd8dd648e87df2", "committedDate": "2020-02-26T07:11:32Z", "message": "TSK-1131 updateOwner Bulk - comments from Holger"}, "afterCommit": {"oid": "5c92943843c7c7b97d424884254b7d4e086c368b", "author": {"user": {"login": "BerndBreier", "name": null}}, "url": "https://github.com/Taskana/taskana/commit/5c92943843c7c7b97d424884254b7d4e086c368b", "committedDate": "2020-02-26T08:35:07Z", "message": "TSK-1131 updateOwner Bulk - comments from Holger"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0OTA5NTc4", "url": "https://github.com/Taskana/taskana/pull/939#pullrequestreview-364909578", "createdAt": "2020-02-26T13:48:03Z", "commit": {"oid": "5c92943843c7c7b97d424884254b7d4e086c368b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4566, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}