{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0OTU2NTMy", "number": 852, "title": "Tsk1029 Deletion of workbasket as business admin not possible without explicit permissions", "bodyText": "", "createdAt": "2020-01-20T18:23:51Z", "url": "https://github.com/Taskana/taskana/pull/852", "merged": true, "mergeCommit": {"oid": "d9c80ae08efdc216f90ceedd234ed260f84b2d05"}, "closed": true, "closedAt": "2020-01-23T12:00:05Z", "author": {"login": "benjamineckstein"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8S_rnAFqTM0NTUyODQxNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9JF8kgFqTM0NzI0MzkxNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NTI4NDE1", "url": "https://github.com/Taskana/taskana/pull/852#pullrequestreview-345528415", "createdAt": "2020-01-20T20:53:51Z", "commit": {"oid": "801873b004bae2a0060738447c76bbadf257cfc9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMDo1Mzo1MVrOFfpCMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQyMDo1ODowM1rOFfpGQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcyMjQ4MQ==", "bodyText": "This only works if you do have a user called \"admin\" configured as admin in taskana.properties, doesn't it? I guess we have to think about this a bit more.", "url": "https://github.com/Taskana/taskana/pull/852#discussion_r368722481", "createdAt": "2020-01-20T20:53:51Z", "author": {"login": "holgerhagen"}, "path": "lib/taskana-core/src/main/java/pro/taskana/security/CurrentUserContext.java", "diffHunk": "@@ -77,6 +79,31 @@ public static String getUserid() {\n     return accessIds;\n   }\n \n+  /**\n+   * This method is supposed to skip further permission checks if we are already in a secured\n+   * environment. With great power comes great responsibility.\n+   *\n+   * @param supplier will be executed with admin privileges\n+   * @param <T> defined with the supplier return value\n+   * @return output from supplier\n+   */\n+  public static <T> T runAsAdmin(Supplier<T> supplier) {\n+\n+    Subject subject = Subject.getSubject(AccessController.getContext());\n+    if (subject == null) {\n+      // dont add authorisation if none is available.\n+      return supplier.get();\n+    }\n+    Set<Principal> principals = subject.getPrincipals();\n+    Set<Object> privateCredentials = subject.getPrivateCredentials();\n+    Set<Object> publicCredentials = subject.getPublicCredentials();\n+\n+    principals.add(new GroupPrincipal(\"admin\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "801873b004bae2a0060738447c76bbadf257cfc9"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcyMjk0OQ==", "bodyText": "Don't we change the current Subject as well, if we do it this way? From my perspective it might be better to create a dedicated Subject from scratch instead of patching the current subject.", "url": "https://github.com/Taskana/taskana/pull/852#discussion_r368722949", "createdAt": "2020-01-20T20:55:53Z", "author": {"login": "holgerhagen"}, "path": "lib/taskana-core/src/main/java/pro/taskana/security/CurrentUserContext.java", "diffHunk": "@@ -77,6 +79,31 @@ public static String getUserid() {\n     return accessIds;\n   }\n \n+  /**\n+   * This method is supposed to skip further permission checks if we are already in a secured\n+   * environment. With great power comes great responsibility.\n+   *\n+   * @param supplier will be executed with admin privileges\n+   * @param <T> defined with the supplier return value\n+   * @return output from supplier\n+   */\n+  public static <T> T runAsAdmin(Supplier<T> supplier) {\n+\n+    Subject subject = Subject.getSubject(AccessController.getContext());\n+    if (subject == null) {\n+      // dont add authorisation if none is available.\n+      return supplier.get();\n+    }\n+    Set<Principal> principals = subject.getPrincipals();\n+    Set<Object> privateCredentials = subject.getPrivateCredentials();\n+    Set<Object> publicCredentials = subject.getPublicCredentials();\n+\n+    principals.add(new GroupPrincipal(\"admin\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcyMjQ4MQ=="}, "originalCommit": {"oid": "801873b004bae2a0060738447c76bbadf257cfc9"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcyMzUyMg==", "bodyText": "testDeleteWorkbasketAsBusinessAdminWithoutExplicitReadPermission?", "url": "https://github.com/Taskana/taskana/pull/852#discussion_r368723522", "createdAt": "2020-01-20T20:58:03Z", "author": {"login": "holgerhagen"}, "path": "rest/taskana-rest-spring/src/test/java/pro/taskana/rest/WorkbasketControllerIntTest.java", "diffHunk": "@@ -107,6 +108,25 @@ void testGetSecondPageSortedByKey() {\n     assertNotNull(response.getBody().getLink(Link.REL_PREVIOUS));\n   }\n \n+  /**\n+   * Bug Ticket TSK-1029.\n+   * Businessadmin is allowed to delete any workbasket ticket without user related access\n+   * restrictions.\n+   */\n+  @Test\n+  void testDeleteWorkbasketPermissionWithBusinessAdmin() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "801873b004bae2a0060738447c76bbadf257cfc9"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MDk3MTEy", "url": "https://github.com/Taskana/taskana/pull/852#pullrequestreview-347097112", "createdAt": "2020-01-23T07:24:35Z", "commit": {"oid": "a3df6153eb92fdd3ff70a01b9efeb1cc58b27f70"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c0cf04e1d94defac2e7f5e6c7cf04fe0cb5d3f4", "author": {"user": {"login": "benjamineckstein", "name": "Benjamin Eckstein"}}, "url": "https://github.com/Taskana/taskana/commit/1c0cf04e1d94defac2e7f5e6c7cf04fe0cb5d3f4", "committedDate": "2020-01-23T09:30:26Z", "message": "TSK-1029: Add test to trigger permission bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd043b92ee3c80eb0eb117e712eccf233f68e17d", "author": {"user": {"login": "benjamineckstein", "name": "Benjamin Eckstein"}}, "url": "https://github.com/Taskana/taskana/commit/bd043b92ee3c80eb0eb117e712eccf233f68e17d", "committedDate": "2020-01-23T09:30:26Z", "message": "TSK-1029: Fix deletion of workbasket as business admin not possible"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f3a166f2700f2d706b0fba9528ab6661e621840", "author": {"user": {"login": "benjamineckstein", "name": "Benjamin Eckstein"}}, "url": "https://github.com/Taskana/taskana/commit/4f3a166f2700f2d706b0fba9528ab6661e621840", "committedDate": "2020-01-23T09:30:27Z", "message": "TSK-1029: Fix side effect of tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef980bdbae6c8c29a58a2a9c6eaa3cae63e18c72", "author": {"user": {"login": "benjamineckstein", "name": "Benjamin Eckstein"}}, "url": "https://github.com/Taskana/taskana/commit/ef980bdbae6c8c29a58a2a9c6eaa3cae63e18c72", "committedDate": "2020-01-23T09:30:27Z", "message": "TSK-1029: Test and fix privilege for runasadmin is only temporary"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "358caaf88087165873e9cd3cabd837adddc78b82", "author": {"user": {"login": "benjamineckstein", "name": "Benjamin Eckstein"}}, "url": "https://github.com/Taskana/taskana/commit/358caaf88087165873e9cd3cabd837adddc78b82", "committedDate": "2020-01-23T10:01:58Z", "message": "TSK-1029: Refactor runAsAdmin method and usage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MjQzOTE0", "url": "https://github.com/Taskana/taskana/pull/852#pullrequestreview-347243914", "createdAt": "2020-01-23T11:59:57Z", "commit": {"oid": "358caaf88087165873e9cd3cabd837adddc78b82"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4576, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}