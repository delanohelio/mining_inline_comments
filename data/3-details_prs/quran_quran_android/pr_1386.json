{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwOTE2NTUx", "number": 1386, "title": "Fix some bugs with AudioUtils", "bodyText": "", "createdAt": "2020-06-27T14:09:40Z", "url": "https://github.com/quran/quran_android/pull/1386", "merged": true, "mergeCommit": {"oid": "2870498f580bc33b20095c864885764204dd5b68"}, "closed": true, "closedAt": "2020-06-27T14:58:59Z", "author": {"login": "ahmedre"}, "timelineItems": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvYccpgH2gAyNDQwOTE2NTUxOjQyODk0OGEyYjc5ZDY5MmU2MWY2NGZlYzM5NWU0Mzc0NjFhZGVmMmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcvYfJgAFqTQzODcwMDg4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "428948a2b79d692e61f64fec395e437461adef2d", "author": {"user": {"login": "ahmedre", "name": "Ahmed El-Helw"}}, "url": "https://github.com/quran/quran_android/commit/428948a2b79d692e61f64fec395e437461adef2d", "committedDate": "2020-06-27T14:09:19Z", "message": "Fix some bugs with AudioUtils"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NzAwODg5", "url": "https://github.com/quran/quran_android/pull/1386#pullrequestreview-438700889", "createdAt": "2020-06-27T14:09:55Z", "commit": {"oid": "428948a2b79d692e61f64fec395e437461adef2d"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yN1QxNDowOTo1NVrOGp2DSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yN1QxNDoxMjoxNFrOGp2Ecg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUzMDM3Ng==", "bodyText": "never actually happened", "url": "https://github.com/quran/quran_android/pull/1386#discussion_r446530376", "createdAt": "2020-06-27T14:09:55Z", "author": {"login": "ahmedre"}, "path": "app/src/main/java/com/quran/labs/androidquran/presenter/audio/AudioPresenter.kt", "diffHunk": "@@ -50,13 +50,8 @@ constructor(private val quranDisplayData: QuranDisplayData,\n         audioPathInfo\n       }\n \n-      val (checkedStart, checkedEnd) = if (start < end) start to end else end to start\n-      if (checkedStart != start) {\n-        Crashlytics.logException(IllegalArgumentException(\"expected $start > $end, but wasn't.\"))\n-      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "428948a2b79d692e61f64fec395e437461adef2d"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUzMDU5OQ==", "bodyText": "this was for page download amount, and there's a method for that which is also more correct than this (this code is actually wrong if you consider a case like 56:51, which was returning the sura as 57 instead of 56)", "url": "https://github.com/quran/quran_android/pull/1386#discussion_r446530599", "createdAt": "2020-06-27T14:11:20Z", "author": {"login": "ahmedre"}, "path": "app/src/main/java/com/quran/labs/androidquran/util/AudioUtils.kt", "diffHunk": "@@ -125,19 +125,7 @@ constructor(private val quranInfo: QuranInfo, private val quranFileUtils: QuranF\n     if (page > totalPages || page < 0) {\n       return null\n     }\n-    if (page < totalPages) {\n-      val nextPage = page + 1\n-      val nextPageSura = quranInfo.getSuraNumberFromPage(nextPage)\n-      // using [page+1] as an index because we literally want the next page\n-      val nextPageAyah = quranInfo.getFirstAyahOnPage(nextPage)\n-\n-      pageLastSura = nextPageSura\n-      pageLastAyah = nextPageAyah - 1\n-      if (pageLastAyah < 1) {\n-        pageLastSura--\n-        pageLastAyah = quranInfo.getNumberOfAyahs(pageLastSura)\n-      }\n-    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "428948a2b79d692e61f64fec395e437461adef2d"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUzMDY2NQ==", "bodyText": "converted to Kotlin", "url": "https://github.com/quran/quran_android/pull/1386#discussion_r446530665", "createdAt": "2020-06-27T14:12:03Z", "author": {"login": "ahmedre"}, "path": "app/src/test/java/com/quran/labs/androidquran/util/AudioUtilsTest.kt", "diffHunk": "@@ -0,0 +1,60 @@\n+package com.quran.labs.androidquran.util\n+\n+import com.google.common.truth.Truth.assertThat\n+import com.quran.data.core.QuranInfo\n+import com.quran.data.model.SuraAyah\n+import com.quran.data.pageinfo.common.MadaniDataSource\n+import com.quran.data.source.PageProvider\n+import org.junit.Assert\n+import org.junit.Test\n+import org.mockito.Mockito\n+import org.mockito.Mockito.`when` as whenever\n+\n+class AudioUtilsTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "428948a2b79d692e61f64fec395e437461adef2d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUzMDY3NA==", "bodyText": "added this test - was failing before my code change", "url": "https://github.com/quran/quran_android/pull/1386#discussion_r446530674", "createdAt": "2020-06-27T14:12:14Z", "author": {"login": "ahmedre"}, "path": "app/src/test/java/com/quran/labs/androidquran/util/AudioUtilsTest.kt", "diffHunk": "@@ -0,0 +1,60 @@\n+package com.quran.labs.androidquran.util\n+\n+import com.google.common.truth.Truth.assertThat\n+import com.quran.data.core.QuranInfo\n+import com.quran.data.model.SuraAyah\n+import com.quran.data.pageinfo.common.MadaniDataSource\n+import com.quran.data.source.PageProvider\n+import org.junit.Assert\n+import org.junit.Test\n+import org.mockito.Mockito\n+import org.mockito.Mockito.`when` as whenever\n+\n+class AudioUtilsTest {\n+\n+  @Test\n+  fun testGetLastAyahWithNewSurahOnNextPageForMadani() {\n+    val pageProviderMock = Mockito.mock(PageProvider::class.java)\n+    whenever(pageProviderMock.getDataSource())\n+        .thenReturn(MadaniDataSource())\n+    val quranInfo = QuranInfo(MadaniDataSource())\n+    val audioUtils = AudioUtils(quranInfo, Mockito.mock(QuranFileUtils::class.java))\n+    val lastAyah = audioUtils.getLastAyahToPlay(SuraAyah(109, 1), 603, 1, false)\n+    Assert.assertNotNull(lastAyah)\n+    Assert.assertEquals(5, lastAyah!!.ayah.toLong())\n+    Assert.assertEquals(111, lastAyah.sura.toLong())\n+  }\n+\n+  @Test\n+  fun testSuraTawbaDoesNotNeedBasmallah() {\n+    val quranInfo = QuranInfo(MadaniDataSource())\n+    val audioUtils = AudioUtils(quranInfo, Mockito.mock(QuranFileUtils::class.java))\n+\n+    // start after ayah 1 of sura anfal\n+    val start = SuraAyah(8, 2)\n+    // finish in sura tawbah, so no basmallah needed here\n+    val ending = SuraAyah(9, 100)\n+\n+    // overall don't need a basmallah\n+    Assert.assertFalse(audioUtils.doesRequireBasmallah(start, ending))\n+  }\n+\n+  @Test\n+  fun testNeedBasmallahAcrossRange() {\n+    val quranInfo = QuranInfo(MadaniDataSource())\n+    val audioUtils = AudioUtils(quranInfo, Mockito.mock(QuranFileUtils::class.java))\n+    val start = SuraAyah(8, 1)\n+    val ending = SuraAyah(10, 2)\n+    // should need a basmallah due to 10:1\n+    Assert.assertTrue(audioUtils.doesRequireBasmallah(start, ending))\n+  }\n+\n+  @Test\n+  fun testLastAyahForFirstAyahWithPageDownload() {\n+    val audioUtils = AudioUtils(QuranInfo(MadaniDataSource()),\n+        Mockito.mock(QuranFileUtils::class.java))\n+    val start = SuraAyah(56, 51)\n+    val end = audioUtils.getLastAyahToPlay(start, 536, 1, false)\n+    assertThat(end).isEqualTo(SuraAyah(56, 76))\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "428948a2b79d692e61f64fec395e437461adef2d"}, "originalPosition": 59}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3010, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}