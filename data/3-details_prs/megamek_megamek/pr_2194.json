{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2NzU1OTM4", "number": 2194, "title": "Bot friendly fire reduction", "bodyText": "Doesn't happen very often, but I've seen the bot blow up buildings containing its own turrets to try to get to the other side. Mostly this happens after you've considerably reduced the building CF. This PR addresses that by preventing the long-range pathfinder from pathing through buildings containing immobile units.\nInitial version was abominably slow for some reason, but adding a caching mechanism speeded things up nicely.", "createdAt": "2020-09-01T01:54:43Z", "url": "https://github.com/MegaMek/megamek/pull/2194", "merged": true, "mergeCommit": {"oid": "268a4d55ef49e3113784b747afc6553a35088df6"}, "closed": true, "closedAt": "2020-09-12T01:16:23Z", "author": {"login": "NickAragua"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEdR7tAH2gAyNDc2NzU1OTM4OjI1M2IzNTYyMGFhNGY2OWJjYTI1MjNlMmFkNDY5ODJhNDZmNzk0ZjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdH_M-nAH2gAyNDc2NzU1OTM4Ojc2YzU3MjNiNWFhYWQ2MDBmM2EzNTY2MjgyM2ZlMTU2NjkxNTVmYzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "253b35620aa4f69bca2523e2ad46982a46f794f3", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/253b35620aa4f69bca2523e2ad46982a46f794f3", "committedDate": "2020-09-01T01:39:46Z", "message": "reduce bot friendly fire for long range pathfinding"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4eada040b344c25dfdd7c07fac51ed87da0daaac", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/4eada040b344c25dfdd7c07fac51ed87da0daaac", "committedDate": "2020-09-01T01:49:21Z", "message": "caching mechanism"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aeacc356511d7fb5fef1d7c8c0133db40958e5bc", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/aeacc356511d7fb5fef1d7c8c0133db40958e5bc", "committedDate": "2020-09-01T01:52:13Z", "message": "cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3MDg5MzA2", "url": "https://github.com/MegaMek/megamek/pull/2194#pullrequestreview-487089306", "createdAt": "2020-09-11T20:01:37Z", "commit": {"oid": "aeacc356511d7fb5fef1d7c8c0133db40958e5bc"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQyMDowMTozN1rOHQsLiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQyMDowNDozNFrOHQsQSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2MzExMw==", "bodyText": "Access modifiers?", "url": "https://github.com/MegaMek/megamek/pull/2194#discussion_r487263113", "createdAt": "2020-09-11T20:01:37Z", "author": {"login": "Windchild292"}, "path": "megamek/src/megamek/common/pathfinder/DestructionAwareDestinationPathfinder.java", "diffHunk": "@@ -42,6 +44,7 @@\n \n     Comparator<BulldozerMovePath> movePathComparator;\n     int maximumCost = Integer.MAX_VALUE;\n+    Map<Coords, Boolean> friendlyFireCheckResults = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aeacc356511d7fb5fef1d7c8c0133db40958e5bc"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2MzIyNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(!child.isJumping() && friendlyFireCheck(child.getEntity(), child.getGame(), child.getFinalCoords(), false)) {\n          \n          \n            \n                    if (!child.isJumping() && friendlyFireCheck(child.getEntity(), child.getGame(), child.getFinalCoords(), false)) {", "url": "https://github.com/MegaMek/megamek/pull/2194#discussion_r487263226", "createdAt": "2020-09-11T20:01:53Z", "author": {"login": "Windchild292"}, "path": "megamek/src/megamek/common/pathfinder/DestructionAwareDestinationPathfinder.java", "diffHunk": "@@ -230,6 +233,12 @@ protected void processChild(BulldozerMovePath child, List<BulldozerMovePath> chi\n             return;\n         }\n         \n+        // let's avoid pathing through buildings containing our immobile units - \n+        // they're not going to get out of the way and we can probably do better than killing our own guys\n+        if(!child.isJumping() && friendlyFireCheck(child.getEntity(), child.getGame(), child.getFinalCoords(), false)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aeacc356511d7fb5fef1d7c8c0133db40958e5bc"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2MzM3OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for(Entity entity : game.getEntitiesVector(position, true)) {\n          \n          \n            \n                        if(!entity.isEnemyOf(shooter) && (includeMobileUnits || (entity.getWalkMP(true, false) == 0))) {\n          \n          \n            \n                    for (Entity entity : game.getEntitiesVector(position, true)) {\n          \n          \n            \n                        if (!entity.isEnemyOf(shooter) && (includeMobileUnits || (entity.getWalkMP(true, false) == 0))) {", "url": "https://github.com/MegaMek/megamek/pull/2194#discussion_r487263379", "createdAt": "2020-09-11T20:02:17Z", "author": {"login": "Windchild292"}, "path": "megamek/src/megamek/common/pathfinder/DestructionAwareDestinationPathfinder.java", "diffHunk": "@@ -242,6 +251,37 @@ protected void processChild(BulldozerMovePath child, List<BulldozerMovePath> chi\n         }\n     }\n     \n+    /**\n+     * Utility function that returns true if an attack on the building in the given coordinates\n+     * will result in damage to friendly units. Computation is cached as it is somewhat expensive to perform for each possible path node.\n+     */\n+    public boolean friendlyFireCheck(Entity shooter, IGame game, Coords position, boolean includeMobileUnits) {\n+        if(friendlyFireCheckResults.containsKey(position)) {\n+            return friendlyFireCheckResults.get(position);\n+        }\n+        \n+        Building building = game.getBoard().getBuildingAt(position);\n+        \n+        // no building, no problem\n+        if (building == null) {\n+            friendlyFireCheckResults.put(position, false);\n+            return false;\n+        }\n+        \n+        // check if there are any entities in the building that meet the following criteria:\n+        // - is friendly\n+        // - if we care only about mobile units, has no MP \n+        for(Entity entity : game.getEntitiesVector(position, true)) {\n+            if(!entity.isEnemyOf(shooter) && (includeMobileUnits || (entity.getWalkMP(true, false) == 0))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aeacc356511d7fb5fef1d7c8c0133db40958e5bc"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2NDE3Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(friendlyFireCheckResults.containsKey(position)) {\n          \n          \n            \n                    if (friendlyFireCheckResults.containsKey(position)) {", "url": "https://github.com/MegaMek/megamek/pull/2194#discussion_r487264172", "createdAt": "2020-09-11T20:04:12Z", "author": {"login": "Windchild292"}, "path": "megamek/src/megamek/common/pathfinder/DestructionAwareDestinationPathfinder.java", "diffHunk": "@@ -242,6 +251,37 @@ protected void processChild(BulldozerMovePath child, List<BulldozerMovePath> chi\n         }\n     }\n     \n+    /**\n+     * Utility function that returns true if an attack on the building in the given coordinates\n+     * will result in damage to friendly units. Computation is cached as it is somewhat expensive to perform for each possible path node.\n+     */\n+    public boolean friendlyFireCheck(Entity shooter, IGame game, Coords position, boolean includeMobileUnits) {\n+        if(friendlyFireCheckResults.containsKey(position)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aeacc356511d7fb5fef1d7c8c0133db40958e5bc"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2NDMyOQ==", "bodyText": "Why public instead of private?", "url": "https://github.com/MegaMek/megamek/pull/2194#discussion_r487264329", "createdAt": "2020-09-11T20:04:34Z", "author": {"login": "Windchild292"}, "path": "megamek/src/megamek/common/pathfinder/DestructionAwareDestinationPathfinder.java", "diffHunk": "@@ -242,6 +251,37 @@ protected void processChild(BulldozerMovePath child, List<BulldozerMovePath> chi\n         }\n     }\n     \n+    /**\n+     * Utility function that returns true if an attack on the building in the given coordinates\n+     * will result in damage to friendly units. Computation is cached as it is somewhat expensive to perform for each possible path node.\n+     */\n+    public boolean friendlyFireCheck(Entity shooter, IGame game, Coords position, boolean includeMobileUnits) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aeacc356511d7fb5fef1d7c8c0133db40958e5bc"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76c5723b5aaad600f3a35662823fe15669155fc7", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/76c5723b5aaad600f3a35662823fe15669155fc7", "committedDate": "2020-09-12T00:52:54Z", "message": "code review suggestions; minor Server cleanup"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4742, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}