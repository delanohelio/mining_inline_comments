{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2MzMxMzUz", "number": 2132, "title": "add Java object look-ahead library to mitigate deserialization vulnerabilities", "bodyText": "Megamek unsafely deserializes untrusted raw objects from files in megamek/common/MechSummaryCache.java and over the wire in megamek/common/net/marshall/NativeSerializationMarshaller.java, which could allow attackers to gain remote code execution on the game host machine. I don't believe this is currently exploitable due to a lack of well-known gadgets in the classpath (such as those within CommonsCollections), but it could still be possible to construct a viable gadget chain with enough effort. Future dependencies that get added could also make it exploitable.\nThis commit wraps the InputStream in these instances with SerialKiller, a Look-Ahead Java Object Deserialization library. I generated a whitelist of allowed objects using SerialKiller's profiling mode, which is stored in mmconf/serialkiller.xml. This file will need to be updated if more objects are added that need to be deserialized. Note that I've whitelisted all internal classes (megamek.common.*), so this should only affect external library classes.\nI've tested by playing a couple of games locally on Linux and verifying that no benign classes are being blocked. I also confirmed that the deserialization proofs-of-concept I developed are blocked by SerialKiller (with an error in megameklog.txt). I would love help testing to make sure everything works smoothly in real multiplayer games.", "createdAt": "2020-08-11T20:13:49Z", "url": "https://github.com/MegaMek/megamek/pull/2132", "merged": true, "mergeCommit": {"oid": "15b3e5f7321059cca4bac71fc61ab846fd9bbfb6"}, "closed": true, "closedAt": "2020-08-16T04:09:52Z", "author": {"login": "Algebro7"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc98ehJAH2gAyNDY2MzMxMzUzOjAzNGYzYmQzZWFhZTk3YTc3MGYyNDRhM2Q3OWZiYjJhNmVlYTZjODM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_VDHLgH2gAyNDY2MzMxMzUzOjdjMGM1OTBjYzk4ZTIzNTNiOTFiYjg4NDZkNWExMjFhZWE5MWU3YTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "034f3bd3eaae97a770f244a3d79fbb2a6eea6c83", "author": {"user": {"login": "Algebro7", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/034f3bd3eaae97a770f244a3d79fbb2a6eea6c83", "committedDate": "2020-08-11T20:03:06Z", "message": "add serialkiller to mitigate deserialization vulnerabilities\n\nMegamek unsafely deserializes untrusted raw objects from files in\nmegamek/common/MechSummaryCache.java and over the wire in\nmegamek/common/net/marshall/NativeSerializationMarshaller.java, which\ncould allow attackers to gain remote code execution on the game host\nmachine. This commit wraps the InputStream in these instances with\nSerialKiller, a Look-Ahead Java Object Deserialization library. A whitelist\nof allowed objects is stored in resources/megamek/serialkiller.xml, which\nwill need to be updated if more objects are added that need to be deserialized.\nNote that I've whitelisted all internal classes (megamek.common.*)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NDA2MTc0", "url": "https://github.com/MegaMek/megamek/pull/2132#pullrequestreview-465406174", "createdAt": "2020-08-11T20:30:42Z", "commit": {"oid": "034f3bd3eaae97a770f244a3d79fbb2a6eea6c83"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMDozMDo0MlrOG_IJeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMDozMDo0MlrOG_IJeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg0Njk3MA==", "bodyText": "I just noticed the game hangs when I launch using the unixDistTar package, but not when I run with gradlew. Do I need to move the shipped serialkiller.xml file to the mmconf folder instead of the resources folder to use it from a jar?", "url": "https://github.com/MegaMek/megamek/pull/2132#discussion_r468846970", "createdAt": "2020-08-11T20:30:42Z", "author": {"login": "Algebro7"}, "path": "megamek/src/megamek/common/net/marshall/NativeSerializationMarshaller.java", "diffHunk": "@@ -48,7 +50,7 @@ public void marshall(Packet packet, OutputStream stream) throws Exception {\n      */\n     @Override\n     public Packet unmarshall(InputStream stream) throws Exception {\n-        ObjectInputStream in = new ObjectInputStream(stream);\n+        ObjectInputStream in = new SerialKiller(stream, Objects.requireNonNull(getClass().getClassLoader().getResource(\"./megamek/serialkiller.xml\")).toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "034f3bd3eaae97a770f244a3d79fbb2a6eea6c83"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cc0cbd64fd0204f19442cd442c3a1e870d75b4b", "author": {"user": {"login": "Algebro7", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/3cc0cbd64fd0204f19442cd442c3a1e870d75b4b", "committedDate": "2020-08-11T20:50:41Z", "message": "move serialkiller config to mmconf"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a15de18d808cd3bf7c13d03f43e0a125b29abbc", "author": {"user": {"login": "Algebro7", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/5a15de18d808cd3bf7c13d03f43e0a125b29abbc", "committedDate": "2020-08-11T20:57:12Z", "message": "remove unneeded import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c47f9e0d7a5725553b72396792cfa2cd59cd84e3", "author": {"user": {"login": "Algebro7", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/c47f9e0d7a5725553b72396792cfa2cd59cd84e3", "committedDate": "2020-08-12T01:37:01Z", "message": "move serialkiller config to jar resources"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1OTcyMTg2", "url": "https://github.com/MegaMek/megamek/pull/2132#pullrequestreview-465972186", "createdAt": "2020-08-12T14:28:23Z", "commit": {"oid": "c47f9e0d7a5725553b72396792cfa2cd59cd84e3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cb4012677ae333b2d93e6ace33a56c7fc2f215d", "author": {"user": {"login": "Algebro7", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/6cb4012677ae333b2d93e6ace33a56c7fc2f215d", "committedDate": "2020-08-15T20:39:10Z", "message": "whitelist 1-dimensional megamek array"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c0c590cc98e2353b91bb8846d5a121aea91e7a7", "author": {"user": {"login": "Algebro7", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/7c0c590cc98e2353b91bb8846d5a121aea91e7a7", "committedDate": "2020-08-16T03:14:43Z", "message": "whitelist whole megamek namespace"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4707, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}