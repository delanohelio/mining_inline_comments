{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2Njc2MjIz", "number": 2135, "title": "Unit sprites in the Combat Log", "bodyText": "This addresses #2099 by adding unit sprites to the combat log. It's meant to help illustrate more clearly what is happening to whom during a battle. By default, it doesn't display images for reports that are indented more than once, specifically because having an image for every entry takes up a ton of vertical space. However, there is a function to override that if you wanted to add the images to a specific report. I didn't try to add wreckage or damage decals for the sake of readability and consistency, but I don't imagine it would be too difficult to implement if someone wanted it.\nThe way it works is by first generating the composite art, i.e. base art, camo and tint, and then it converts that image to a base64 string and creates an <img> object with that string as the src. By default, the HTMLEditorKit doesn't support decoding the base64 string, so there's a custom toolkit and image view that handles it. All of the entity art is created, encoded and cached when \"receiveEntities\" is called on the client. It knows where to put the <img> object because it adds the entity's ID when \"addDesc\" is called from the report. Currently it adds the ID between two vertical bars, e.g. |1|, and then the client extracts the ID and swaps the whole sequence with the desired <img> object.\nThis is what it looks like with the sprites.\n\nIt also displays in the mini report display and the movement alert. I believe that I accounted for all of the various ways of displaying reports, but I would not be surprised if I missed something.", "createdAt": "2020-08-12T10:32:36Z", "url": "https://github.com/MegaMek/megamek/pull/2135", "merged": true, "mergeCommit": {"oid": "c1ad782b84b75e7c2b848a73185274454bb826b1"}, "closed": true, "closedAt": "2020-08-15T01:36:42Z", "author": {"login": "Krashner"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc90euQgH2gAyNDY2Njc2MjIzOmNmZjNiN2FjNmUzOGUxZjExZGJlNzkzMzc4NzViNWJkNzNiM2QxMzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-33tggFqTQ2NzczOTcyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cff3b7ac6e38e1f11dbe79337875b5bd73b3d130", "author": {"user": {"login": "Krashner", "name": "Justin"}}, "url": "https://github.com/MegaMek/megamek/commit/cff3b7ac6e38e1f11dbe79337875b5bd73b3d130", "committedDate": "2020-08-11T10:44:05Z", "message": "Added entity image to report and enabled displaying Base64 sources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc3509e58afbeebdca38141154be27e4aef0e709", "author": {"user": {"login": "Krashner", "name": "Justin"}}, "url": "https://github.com/MegaMek/megamek/commit/bc3509e58afbeebdca38141154be27e4aef0e709", "committedDate": "2020-08-12T02:03:02Z", "message": "Implemented image caching and enabled camo for units in the report dialogue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24add1256b2ac19da51e5acd990d835e2e024a72", "author": {"user": {"login": "Krashner", "name": "Justin"}}, "url": "https://github.com/MegaMek/megamek/commit/24add1256b2ac19da51e5acd990d835e2e024a72", "committedDate": "2020-08-12T09:19:45Z", "message": "Updated reports so that the images will not show on log items that have been indented more than once"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e533857b10bca0bc6061667f2fe7d6ae64e3394", "author": {"user": {"login": "Krashner", "name": "Justin"}}, "url": "https://github.com/MegaMek/megamek/commit/9e533857b10bca0bc6061667f2fe7d6ae64e3394", "committedDate": "2020-08-12T10:53:02Z", "message": "Fix for potential null reference"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1OTc0MDQz", "url": "https://github.com/MegaMek/megamek/pull/2135#pullrequestreview-465974043", "createdAt": "2020-08-12T14:30:21Z", "commit": {"oid": "9e533857b10bca0bc6061667f2fe7d6ae64e3394"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDozMDoyMlrOG_j_Wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxNDozMTo0NlrOG_kDRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMzEzMA==", "bodyText": "Why not use the TilesetManager class instead of basically rolling your own implementation of it? It's present in the BoardView class and contains pretty much all of the information you could need.", "url": "https://github.com/MegaMek/megamek/pull/2135#discussion_r469303130", "createdAt": "2020-08-12T14:30:22Z", "author": {"login": "NickAragua"}, "path": "megamek/src/megamek/client/Client.java", "diffHunk": "@@ -161,6 +129,15 @@\n \n     public Map<String, Client> bots = new TreeMap<String, Client>(StringUtil.stringComparator());\n \n+    //get the image data\n+    private MechTileset mechTileset = new MechTileset(Configuration.unitImagesDir());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e533857b10bca0bc6061667f2fe7d6ae64e3394"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMzU4Mg==", "bodyText": "This class needs a standard megamek header comment.", "url": "https://github.com/MegaMek/megamek/pull/2135#discussion_r469303582", "createdAt": "2020-08-12T14:31:00Z", "author": {"login": "NickAragua"}, "path": "megamek/src/megamek/client/ui/swing/util/BASE64ImageView.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package megamek.client.ui.swing.util;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e533857b10bca0bc6061667f2fe7d6ae64e3394"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMzg1Mw==", "bodyText": "Let's put a javadoc-style comment on the class and any public-facing methods.", "url": "https://github.com/MegaMek/megamek/pull/2135#discussion_r469303853", "createdAt": "2020-08-12T14:31:24Z", "author": {"login": "NickAragua"}, "path": "megamek/src/megamek/client/ui/swing/util/BASE64ImageView.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package megamek.client.ui.swing.util;\n+\n+import javax.imageio.ImageIO;\n+import javax.swing.text.Element;\n+import javax.swing.text.html.HTML;\n+import javax.swing.text.html.ImageView;\n+import java.awt.*;\n+import java.awt.image.BufferedImage;\n+import java.io.ByteArrayInputStream;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.util.Base64;\n+import java.util.Dictionary;\n+import java.util.Hashtable;\n+\n+public class BASE64ImageView extends ImageView {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e533857b10bca0bc6061667f2fe7d6ae64e3394"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwNDEzNA==", "bodyText": "\"Copyright\" header, javadoc comment on class and public-facing methods.", "url": "https://github.com/MegaMek/megamek/pull/2135#discussion_r469304134", "createdAt": "2020-08-12T14:31:46Z", "author": {"login": "NickAragua"}, "path": "megamek/src/megamek/client/ui/swing/util/BASE64ToolKit.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package megamek.client.ui.swing.util;\n+\n+import javax.swing.text.*;\n+import javax.swing.text.html.HTML;\n+import javax.swing.text.html.HTMLEditorKit;\n+\n+public class BASE64ToolKit extends HTMLEditorKit {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e533857b10bca0bc6061667f2fe7d6ae64e3394"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61a939b5208920a3a7db5bb6b293e530baaa5677", "author": {"user": {"login": "Krashner", "name": "Justin"}}, "url": "https://github.com/MegaMek/megamek/commit/61a939b5208920a3a7db5bb6b293e530baaa5677", "committedDate": "2020-08-13T13:02:53Z", "message": "Added more comments, new method to get sprites, better sprite placement and an advanced option to toggle the feature on/off"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cdf9aa3a5700408b65320e2640fba6639e725b3", "author": {"user": {"login": "Krashner", "name": "Justin"}}, "url": "https://github.com/MegaMek/megamek/commit/6cdf9aa3a5700408b65320e2640fba6639e725b3", "committedDate": "2020-08-13T22:18:08Z", "message": "Added wrecks to log, fixed occasionally blank log on load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1271d093bc0f5651034dab336ccd774e8c4173b", "author": {"user": {"login": "Krashner", "name": "Justin"}}, "url": "https://github.com/MegaMek/megamek/commit/a1271d093bc0f5651034dab336ccd774e8c4173b", "committedDate": "2020-08-13T22:49:49Z", "message": "Fix for possible null reference"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c686dac7a3d696222ddcb2709b10b8d4bffbe16a", "author": {"user": {"login": "Krashner", "name": "Justin"}}, "url": "https://github.com/MegaMek/megamek/commit/c686dac7a3d696222ddcb2709b10b8d4bffbe16a", "committedDate": "2020-08-13T23:22:23Z", "message": "Fix for possible null reference"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eaeca8e10873579b66ec758503987f7568ef298e", "author": {"user": {"login": "Krashner", "name": "Justin"}}, "url": "https://github.com/MegaMek/megamek/commit/eaeca8e10873579b66ec758503987f7568ef298e", "committedDate": "2020-08-13T23:24:46Z", "message": "Fix for possuble null entity refererence"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4135e3e536685e6254d7f9d551507a86b983dbe1", "author": {"user": {"login": "Krashner", "name": "Justin"}}, "url": "https://github.com/MegaMek/megamek/commit/4135e3e536685e6254d7f9d551507a86b983dbe1", "committedDate": "2020-08-13T23:26:14Z", "message": "Merge branch 'combatLogSprites' of https://github.com/Krashner/megamek into combatLogSprites"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b613715a6f674c68b10210479f2a34c2dee7883d", "author": {"user": {"login": "Krashner", "name": "Justin"}}, "url": "https://github.com/MegaMek/megamek/commit/b613715a6f674c68b10210479f2a34c2dee7883d", "committedDate": "2020-08-13T23:47:02Z", "message": "Removed useless null check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MjU5NDA2", "url": "https://github.com/MegaMek/megamek/pull/2135#pullrequestreview-467259406", "createdAt": "2020-08-14T01:50:31Z", "commit": {"oid": "b613715a6f674c68b10210479f2a34c2dee7883d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwMTo1MDozMVrOHAk7tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwMjoxMTowOVrOHAlODQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2NzE1OQ==", "bodyText": "Let's get rid of this commented out method.", "url": "https://github.com/MegaMek/megamek/pull/2135#discussion_r470367159", "createdAt": "2020-08-14T01:50:31Z", "author": {"login": "NickAragua"}, "path": "megamek/src/megamek/client/Client.java", "diffHunk": "@@ -274,6 +245,14 @@ protected void updateConnection() {\n         }\n     }\n \n+    private BoardView1 bv;\n+    public void setBoardView(BoardView1 bv){\n+        this.bv = bv;\n+    }\n+\n+    //public getBoardView(){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b613715a6f674c68b10210479f2a34c2dee7883d"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2Nzc1MQ==", "bodyText": "I think we usually put the header comment above the imports.", "url": "https://github.com/MegaMek/megamek/pull/2135#discussion_r470367751", "createdAt": "2020-08-14T01:53:02Z", "author": {"login": "NickAragua"}, "path": "megamek/src/megamek/client/ui/swing/util/BASE64ImageView.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package megamek.client.ui.swing.util;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMzU4Mg=="}, "originalCommit": {"oid": "9e533857b10bca0bc6061667f2fe7d6ae64e3394"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM3MTg1Mw==", "bodyText": "I'm fairly certain that the TilesetManager has its own caching mechanism. I don't think you need to have a separate caching mechanism here.", "url": "https://github.com/MegaMek/megamek/pull/2135#discussion_r470371853", "createdAt": "2020-08-14T02:11:09Z", "author": {"login": "NickAragua"}, "path": "megamek/src/megamek/client/Client.java", "diffHunk": "@@ -1125,7 +1115,85 @@ public String receiveReport(Vector<Report> v) {\n         for (Report r : v) {\n             report.append(r.getText());\n         }\n-        return report.toString();\n+\n+        Set<Integer> set = new HashSet<Integer>();\n+        //find id stored in spans and extract it\n+        Pattern p = Pattern.compile(\"<s(.*?)n>\");\n+        Matcher m = p.matcher(report.toString());\n+\n+        //add all instances to a hashset to prevent duplicates\n+        while(m.find()){\n+            String cleanedText = m.group(1).replaceAll(\"\\\\D\", \"\");\n+            if(cleanedText.length() > 0) {\n+                set.add(Integer.parseInt(cleanedText));\n+            }\n+        }\n+\n+        String updatedReport = report.toString();\n+        //loop through the hashset of unique ids and replace the ids with img tags\n+        for (int i : set) {\n+            if(getCachedImageData(i) != null) {\n+                updatedReport = updatedReport.replace(\"<span id='\" +i + \"'></span>\", getCachedImageData(i));\n+            }\n+        }\n+        return updatedReport;\n+    }\n+\n+    /**\n+     * get img tag for unit id\n+     */\n+    private String getCachedImageData(int id){\n+        if(imgCache == null || !imgCache.containsKey(id)) {\n+            return null;\n+        }\n+        return imgCache.get(id);\n+    }\n+\n+    /**\n+     * Hashtable for storing image tags containing base64Text src\n+     */\n+    private void cacheImageData(Entity entity){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b613715a6f674c68b10210479f2a34c2dee7883d"}, "originalPosition": 203}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b643fff3ee0c73a753fe88ea503c65a1b05475e", "author": {"user": {"login": "Krashner", "name": "Justin"}}, "url": "https://github.com/MegaMek/megamek/commit/7b643fff3ee0c73a753fe88ea503c65a1b05475e", "committedDate": "2020-08-14T15:43:01Z", "message": "Removed commented function, moved copyright comments and renamed function"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NzM5NzI2", "url": "https://github.com/MegaMek/megamek/pull/2135#pullrequestreview-467739726", "createdAt": "2020-08-14T17:15:01Z", "commit": {"oid": "7b643fff3ee0c73a753fe88ea503c65a1b05475e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4709, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}