{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYxOTYzNjM3", "number": 2103, "title": "Wreckage graphical improvement", "bodyText": "Building off of Saxarba's and SJuliez' work on unit damage decals.\nBasically, this comes from the fact that a lot of our tank wrecks look nothing like the \"active\" tank sprite, which is either due to them being generic wrecks or having been redrawn in the \"new\" style. So, pretty much every unit (other than mechs and infantry), when destroyed will switch to a \"completely farked up\" look, complete with splatter decals.\nAdditional notes:\n\nUnits that get destroyed over water will now show up translucent to indicate that they've sunk\nImmobilized (both destroyed and intact) units with ICE engines will leak oil out the bottom\nImmobilized (both destroyed and intact) units with treads or wheels will have loose treads/wheels scattered around\nUnits destroyed by ammo explosions or otherwise \"unsalvageable\" turn into a crater\nUnits that have run out of ammo but haven't taken any damage no longer show as being on fire\nIntroduced rudimentary damage tracking for gun emplacements\n\nCaveats:\n\nNo \"bottom\" decals on bridges, because it looks weird. If there was a way to do a decal and only paint it over the bridge, I'd do that, but I'm not sure there is.\nCan't do this for mechs because they should fall over when they blow up, so it'll require a substantial amount of art assets\nInfantry damage/destroyed infantry have proven a little tougher than expected, so I'm leaving it for later\n\nSome aerospace fighters got into an argument:\n\nA gallery of tank wrecks (\"destroyed\" by ejection not weapons fire)\n\nThe APC had a fuel tank explosion so it displays as a crater instead.\nThe Demolisher is immobilized and has an ICE engine so it's got a fuel leak and some treads have slipped off\n\nThe AC/10 turret sunk a sea skimmer, blew up a Pegasus (and then collapsed the bridge), and blew up a \"compromised\" turret:", "createdAt": "2020-08-03T06:05:48Z", "url": "https://github.com/MegaMek/megamek/pull/2103", "merged": true, "mergeCommit": {"oid": "020c957da276006902a7606b0f7f4167608d4b6a"}, "closed": true, "closedAt": "2020-08-22T18:46:35Z", "author": {"login": "NickAragua"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7IimlgH2gAyNDYxOTYzNjM3OmFjMzVjOTM4YTdkYWQ0NjZkYjBmYjFiMDdmZGYwN2E0MTBjYTc0NzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdBdR5IgFqTQ3Mjk0MTg0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ac35c938a7dad466db0fb1b07fdf07a410ca7474", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/ac35c938a7dad466db0fb1b07fdf07a410ca7474", "committedDate": "2020-08-03T02:24:39Z", "message": "initial work"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "becd26d9484ee509d745f3bc1cb13097fccd0d0a", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/becd26d9484ee509d745f3bc1cb13097fccd0d0a", "committedDate": "2020-08-03T05:41:36Z", "message": "polish"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a68f77d5c9ca9430575c6b5668ea16eddc416fd", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/4a68f77d5c9ca9430575c6b5668ea16eddc416fd", "committedDate": "2020-08-03T05:51:08Z", "message": "apply wreck decals to all unit types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7f79c9970e54a9dd09dfcc2316bd6bef8c8caa1", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/f7f79c9970e54a9dd09dfcc2316bd6bef8c8caa1", "committedDate": "2020-08-03T18:51:31Z", "message": "Merge branch 'master' of https://github.com/MegaMek/megamek into wreckage_ui_improvement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8026aa3fce28ad9e0db0bcef03f043857b8853c1", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/8026aa3fce28ad9e0db0bcef03f043857b8853c1", "committedDate": "2020-08-04T02:20:29Z", "message": "further polish"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e53fdbadbb579d01b0f42e53abb4902ea5e3dadd", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/e53fdbadbb579d01b0f42e53abb4902ea5e3dadd", "committedDate": "2020-08-05T02:44:09Z", "message": "Merge branch 'master' into wreckage_ui_improvement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fc2e5a369d53896ce94be9c82cc8e6455449104", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/5fc2e5a369d53896ce94be9c82cc8e6455449104", "committedDate": "2020-08-05T16:29:24Z", "message": "Merge branch 'master' of https://github.com/MegaMek/megamek into wreckage_ui_improvement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2968325e7800f9eb7f9f06df8f89f7895d8915a4", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/2968325e7800f9eb7f9f06df8f89f7895d8915a4", "committedDate": "2020-08-06T02:47:28Z", "message": "Merge branch 'master' of https://github.com/MegaMek/megamek into wreckage_ui_improvement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cde828ab43577251cde4cd0da01adc6e0b6d04bb", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/cde828ab43577251cde4cd0da01adc6e0b6d04bb", "committedDate": "2020-08-06T14:54:29Z", "message": "Merge branch 'master' of https://github.com/MegaMek/megamek into wreckage_ui_improvement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a83175ac0f766d0582a6564f4e05e00c1ff09d1e", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/a83175ac0f766d0582a6564f4e05e00c1ff09d1e", "committedDate": "2020-08-07T18:58:24Z", "message": "Merge branch 'master' of https://github.com/MegaMek/megamek into wreckage_ui_improvement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "437194fdbd97c8076617acd2a59191f2a6d26b1a", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/437194fdbd97c8076617acd2a59191f2a6d26b1a", "committedDate": "2020-08-09T02:48:50Z", "message": "Merge branch 'master' of https://github.com/MegaMek/megamek into wreckage_ui_improvement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdaa92a599101b3c2406f25aa329ae75d0a0641f", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/bdaa92a599101b3c2406f25aa329ae75d0a0641f", "committedDate": "2020-08-10T14:50:52Z", "message": "Merge branch 'master' of https://github.com/MegaMek/megamek into wreckage_ui_improvement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "751fbae46c6aefd6d12f2d709c8852739f64d3e6", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/751fbae46c6aefd6d12f2d709c8852739f64d3e6", "committedDate": "2020-08-13T04:10:48Z", "message": "bug fixes and refinements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "faeede8544124f7cab0ba290bcef13a68af32139", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/faeede8544124f7cab0ba290bcef13a68af32139", "committedDate": "2020-08-13T04:15:19Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc36e462d54037ff44c604aeaabd8e3e049bcf3b", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/bc36e462d54037ff44c604aeaabd8e3e049bcf3b", "committedDate": "2020-08-13T04:20:16Z", "message": "fix disappearing dropship hexes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f52028743a8568d4b97150967a6f1472e8ff6653", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/f52028743a8568d4b97150967a6f1472e8ff6653", "committedDate": "2020-08-13T04:40:02Z", "message": "no craters for space combat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73497e6c4200ef5d9936d7b3444a357244affe90", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/73497e6c4200ef5d9936d7b3444a357244affe90", "committedDate": "2020-08-13T04:41:51Z", "message": "Merge branch 'master' of https://github.com/MegaMek/megamek into wreckage_ui_improvement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d33086cb93d3d4478c1e3e00646b9aba2d5d04f", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/4d33086cb93d3d4478c1e3e00646b9aba2d5d04f", "committedDate": "2020-08-18T04:24:04Z", "message": "prevent destroyed mechs from swaying gently in the wind"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f583dca1a048ebad0fc6b8f2972160d72a793b4b", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/f583dca1a048ebad0fc6b8f2972160d72a793b4b", "committedDate": "2020-08-19T03:15:49Z", "message": "Merge branch 'wreckage_ui_improvement' of https://github.com/NickAragua/megamek into wreckage_ui_improvement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "109c214583da1ca32bb35e859e05f4c38f14b97a", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/109c214583da1ca32bb35e859e05f4c38f14b97a", "committedDate": "2020-08-19T03:16:00Z", "message": "Merge branch 'master' of https://github.com/MegaMek/megamek into wreckage_ui_improvement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dafe2775ea96c4e3c0aa10e5a7e22ca3f34e17a", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/1dafe2775ea96c4e3c0aa10e5a7e22ca3f34e17a", "committedDate": "2020-08-19T16:10:36Z", "message": "add doubles to list of allowed things to serialize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0082aca784f7965b37bc3a140ea0e62ed9a9b083", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/0082aca784f7965b37bc3a140ea0e62ed9a9b083", "committedDate": "2020-08-20T01:08:17Z", "message": "fix decal naming"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyOTM1OTI4", "url": "https://github.com/MegaMek/megamek/pull/2103#pullrequestreview-472935928", "createdAt": "2020-08-22T16:13:01Z", "commit": {"oid": "0082aca784f7965b37bc3a140ea0e62ed9a9b083"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQxNjoxMzowMVrOHFGIOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQxNjoyNzoxMlrOHFGNRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwNTMzOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    bounds = new Rectangle(0,0,bv.hex_size.width, bv.hex_size.height);\n          \n          \n            \n                    bounds = new Rectangle(0, 0, bv.hex_size.width, bv.hex_size.height);", "url": "https://github.com/MegaMek/megamek/pull/2103#discussion_r475105338", "createdAt": "2020-08-22T16:13:01Z", "author": {"login": "sixlettervariables"}, "path": "megamek/src/megamek/client/ui/swing/boardview/AbstractWreckSprite.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * MegaMek - Copyright (C) 2020 - The MegaMek Team\n+ *\n+ *  This program is free software; you can redistribute it and/or modify it\n+ *  under the terms of the GNU General Public License as published by the Free\n+ *  Software Foundation; either version 2 of the License, or (at your option)\n+ *  any later version.\n+ *\n+ *  This program is distributed in the hope that it will be useful, but\n+ *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY\n+ *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License\n+ *  for more details.\n+ */\n+\n+package megamek.client.ui.swing.boardview;\n+\n+import java.awt.AlphaComposite;\n+import java.awt.Color;\n+import java.awt.Font;\n+import java.awt.Graphics2D;\n+import java.awt.Image;\n+import java.awt.Point;\n+import java.awt.Rectangle;\n+\n+import megamek.client.ui.swing.GUIPreferences;\n+import megamek.client.ui.swing.util.EntityWreckHelper;\n+import megamek.common.Entity;\n+import megamek.common.Terrains;\n+import megamek.common.util.ImageUtil;\n+\n+/**\n+ * Contains common functionality for wreck sprites (currently isometric and regular)\n+ * @author NickAragua\n+ *\n+ */\n+public abstract class AbstractWreckSprite extends Sprite {\n+    protected Entity entity;\n+\n+    protected Rectangle modelRect;\n+\n+    protected int secondaryPos;\n+    \n+    public AbstractWreckSprite(BoardView1 boardView1) {\n+        super(boardView1);\n+    }\n+    \n+    @Override\n+    public Rectangle getBounds() {\n+        // Start with the hex and add the label\n+        bounds = new Rectangle(0,0,bv.hex_size.width, bv.hex_size.height);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0082aca784f7965b37bc3a140ea0e62ed9a9b083"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwNTM5OA==", "bodyText": "Future proofing I guess:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (secondaryPos == -1) {\n          \n          \n            \n                    if (secondaryPos < 0 || secondaryPos >= entity.getSecondaryPositions().size()) {", "url": "https://github.com/MegaMek/megamek/pull/2103#discussion_r475105398", "createdAt": "2020-08-22T16:13:41Z", "author": {"login": "sixlettervariables"}, "path": "megamek/src/megamek/client/ui/swing/boardview/AbstractWreckSprite.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * MegaMek - Copyright (C) 2020 - The MegaMek Team\n+ *\n+ *  This program is free software; you can redistribute it and/or modify it\n+ *  under the terms of the GNU General Public License as published by the Free\n+ *  Software Foundation; either version 2 of the License, or (at your option)\n+ *  any later version.\n+ *\n+ *  This program is distributed in the hope that it will be useful, but\n+ *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY\n+ *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License\n+ *  for more details.\n+ */\n+\n+package megamek.client.ui.swing.boardview;\n+\n+import java.awt.AlphaComposite;\n+import java.awt.Color;\n+import java.awt.Font;\n+import java.awt.Graphics2D;\n+import java.awt.Image;\n+import java.awt.Point;\n+import java.awt.Rectangle;\n+\n+import megamek.client.ui.swing.GUIPreferences;\n+import megamek.client.ui.swing.util.EntityWreckHelper;\n+import megamek.common.Entity;\n+import megamek.common.Terrains;\n+import megamek.common.util.ImageUtil;\n+\n+/**\n+ * Contains common functionality for wreck sprites (currently isometric and regular)\n+ * @author NickAragua\n+ *\n+ */\n+public abstract class AbstractWreckSprite extends Sprite {\n+    protected Entity entity;\n+\n+    protected Rectangle modelRect;\n+\n+    protected int secondaryPos;\n+    \n+    public AbstractWreckSprite(BoardView1 boardView1) {\n+        super(boardView1);\n+    }\n+    \n+    @Override\n+    public Rectangle getBounds() {\n+        // Start with the hex and add the label\n+        bounds = new Rectangle(0,0,bv.hex_size.width, bv.hex_size.height);\n+        \n+        // Move to board position, save this origin for correct drawing\n+        Point hexOrigin = bounds.getLocation();\n+        Point ePos;\n+        if (secondaryPos == -1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0082aca784f7965b37bc3a140ea0e62ed9a9b083"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwNTU0OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if ((secondaryPos == -1) && GUIPreferences.getInstance()\n          \n          \n            \n                    if ((secondaryPos < 0) && GUIPreferences.getInstance()", "url": "https://github.com/MegaMek/megamek/pull/2103#discussion_r475105549", "createdAt": "2020-08-22T16:15:24Z", "author": {"login": "sixlettervariables"}, "path": "megamek/src/megamek/client/ui/swing/boardview/AbstractWreckSprite.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * MegaMek - Copyright (C) 2020 - The MegaMek Team\n+ *\n+ *  This program is free software; you can redistribute it and/or modify it\n+ *  under the terms of the GNU General Public License as published by the Free\n+ *  Software Foundation; either version 2 of the License, or (at your option)\n+ *  any later version.\n+ *\n+ *  This program is distributed in the hope that it will be useful, but\n+ *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY\n+ *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License\n+ *  for more details.\n+ */\n+\n+package megamek.client.ui.swing.boardview;\n+\n+import java.awt.AlphaComposite;\n+import java.awt.Color;\n+import java.awt.Font;\n+import java.awt.Graphics2D;\n+import java.awt.Image;\n+import java.awt.Point;\n+import java.awt.Rectangle;\n+\n+import megamek.client.ui.swing.GUIPreferences;\n+import megamek.client.ui.swing.util.EntityWreckHelper;\n+import megamek.common.Entity;\n+import megamek.common.Terrains;\n+import megamek.common.util.ImageUtil;\n+\n+/**\n+ * Contains common functionality for wreck sprites (currently isometric and regular)\n+ * @author NickAragua\n+ *\n+ */\n+public abstract class AbstractWreckSprite extends Sprite {\n+    protected Entity entity;\n+\n+    protected Rectangle modelRect;\n+\n+    protected int secondaryPos;\n+    \n+    public AbstractWreckSprite(BoardView1 boardView1) {\n+        super(boardView1);\n+    }\n+    \n+    @Override\n+    public Rectangle getBounds() {\n+        // Start with the hex and add the label\n+        bounds = new Rectangle(0,0,bv.hex_size.width, bv.hex_size.height);\n+        \n+        // Move to board position, save this origin for correct drawing\n+        Point hexOrigin = bounds.getLocation();\n+        Point ePos;\n+        if (secondaryPos == -1) {\n+            ePos = bv.getHexLocation(entity.getPosition());\n+        } else {\n+            ePos = bv.getHexLocation(entity.getSecondaryPositions().get(secondaryPos));\n+        }\n+        bounds.setLocation(hexOrigin.x + ePos.x, hexOrigin.y + ePos.y);\n+\n+        return bounds;\n+    }\n+\n+    /**\n+     * Creates the sprite for this entity. It is an extra pain to create\n+     * transparent images in AWT.\n+     */\n+    @Override\n+    public void prepare() {\n+        // figure out size\n+        String shortName = entity.getShortName();\n+        Font font = new Font(\"SansSerif\", Font.PLAIN, 10); //$NON-NLS-1$\n+        Rectangle tempRect = new Rectangle(47, 55, bv.getFontMetrics(font)\n+                .stringWidth(shortName) + 1, bv.getFontMetrics(font)\n+                .getAscent());\n+\n+        // create image for buffer\n+        image = ImageUtil.createAcceleratedImage(bounds.width, bounds.height);\n+        Graphics2D graph = (Graphics2D) image.getGraphics();\n+        \n+        // if the entity is underwater or would sink underwater, we want to make the wreckage translucent\n+        // so it looks like it sunk\n+        boolean entityIsUnderwater = (entity.relHeight() < 0) ||\n+                ((entity.relHeight() >= 0) && entity.getGame().getBoard().getHex(entity.getPosition()).containsTerrain(Terrains.WATER)) &&\n+                !EntityWreckHelper.entityOnBridge(entity);\n+        \n+        if(entityIsUnderwater) {\n+            graph.setComposite(AlphaComposite.getInstance(\n+                    AlphaComposite.SRC_OVER, 0.35f));\n+        }\n+\n+        // draw the 'destroyed decal' where appropriate\n+        boolean displayDestroyedDecal = EntityWreckHelper.displayDestroyedDecal(entity);\n+        \n+        if(displayDestroyedDecal) {\n+            Image destroyed = bv.tileManager.bottomLayerWreckMarkerFor(entity, 0);\n+            if (null != destroyed) {\n+                graph.drawImage(destroyed, 0, 0, this);\n+            }\n+        }\n+        \n+        // draw the 'fuel leak' decal where appropriate\n+        boolean drawFuelLeak = EntityWreckHelper.displayFuelLeak(entity);\n+        \n+        if(drawFuelLeak) {\n+            Image fuelLeak = bv.tileManager.bottomLayerFuelLeakMarkerFor(entity);\n+            if (null != fuelLeak) {\n+                graph.drawImage(fuelLeak, 0, 0, this);\n+            }\n+        }\n+        \n+        // draw the 'tires' or 'tracks' decal where appropriate\n+        boolean drawMotiveWreckage = EntityWreckHelper.displayMotiveDamage(entity);\n+        \n+        if(drawMotiveWreckage) {\n+            Image motiveWreckage = bv.tileManager.bottomLayerMotiveMarkerFor(entity);\n+            if (null != motiveWreckage) {\n+                graph.drawImage(motiveWreckage, 0, 0, this);\n+            }\n+        }\n+        \n+        // Draw wreck image, if we've got one.\n+        Image wreck = null;\n+        \n+        if(EntityWreckHelper.displayDevastation(entity)) {\n+            // objects in space should not have craters\n+            wreck = entity.getGame().getBoard().inSpace() ?\n+                    bv.tileManager.wreckMarkerFor(entity, secondaryPos) :\n+                    bv.tileManager.getCraterFor(entity, secondaryPos);\n+        } else {\n+            wreck = EntityWreckHelper.useExplicitWreckImage(entity) ? \n+                        bv.tileManager.wreckMarkerFor(entity, secondaryPos) :\n+                        bv.tileManager.imageFor(entity, secondaryPos);\n+        }\n+\n+        if (null != wreck) {\n+            graph.drawImage(wreck, 0, 0, this);\n+        }\n+        \n+        if(entityIsUnderwater) {\n+            graph.setComposite(AlphaComposite.getInstance(\n+                    AlphaComposite.SRC_OVER, 1.0f));\n+        }\n+        \n+        if ((secondaryPos == -1) && GUIPreferences.getInstance()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0082aca784f7965b37bc3a140ea0e62ed9a9b083"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwNTY4OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (secondaryPos == -1) {\n          \n          \n            \n                    if (secondaryPos < 0 || secondaryPos >= entity.getSecondaryPositions().size()) {", "url": "https://github.com/MegaMek/megamek/pull/2103#discussion_r475105689", "createdAt": "2020-08-22T16:16:54Z", "author": {"login": "sixlettervariables"}, "path": "megamek/src/megamek/client/ui/swing/boardview/IsometricWreckSprite.java", "diffHunk": "@@ -96,61 +73,12 @@ public void drawOnto(Graphics g, int x, int y, ImageObserver observer,\n     public Entity getEntity() {\n         return entity;\n     }\n-\n-    /**\n-     * Creates the sprite for this entity. It is an extra pain to create\n-     * transparent images in AWT.\n-     */\n-    @Override\n-    public void prepare() {\n-        // figure out size\n-        String shortName = entity.getShortName();\n-        Font font = new Font(\"SansSerif\", Font.PLAIN, 10); //$NON-NLS-1$\n-        Rectangle tempRect = new Rectangle(47, 55, bv.getFontMetrics(font)\n-                .stringWidth(shortName) + 1, bv.getFontMetrics(font)\n-                .getAscent());\n-\n-        // create image for buffer\n-        image = ImageUtil.createAcceleratedImage(bounds.width, bounds.height);\n-        Graphics graph = image.getGraphics();\n-\n-        // Draw wreck image,if we've got one.\n-        Image wreck = bv.tileManager.wreckMarkerFor(entity, -1);\n-        if (null != wreck) {\n-            graph.drawImage(wreck, 0, 0, this);\n-        }\n-\n-        if ((secondaryPos == -1) && GUIPreferences.getInstance()\n-                .getBoolean(GUIPreferences.ADVANCED_DRAW_ENTITY_LABEL)) {\n-            // draw box with shortName\n-            Color text = Color.lightGray;\n-            Color bkgd = Color.darkGray;\n-            Color bord = Color.black;\n-\n-            graph.setFont(font);\n-            graph.setColor(bord);\n-            graph.fillRect(tempRect.x, tempRect.y, tempRect.width,\n-                    tempRect.height);\n-            tempRect.translate(-1, -1);\n-            graph.setColor(bkgd);\n-            graph.fillRect(tempRect.x, tempRect.y, tempRect.width,\n-                    tempRect.height);\n-            graph.setColor(text);\n-            graph.drawString(shortName, tempRect.x + 1,\n-                    (tempRect.y + tempRect.height) - 1);\n+    \n+    public Coords getPosition() {\n+        if (secondaryPos == -1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0082aca784f7965b37bc3a140ea0e62ed9a9b083"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwNjA4OQ==", "bodyText": "Floating point math is weird, is this always going to be 1.0?", "url": "https://github.com/MegaMek/megamek/pull/2103#discussion_r475106089", "createdAt": "2020-08-22T16:20:58Z", "author": {"login": "sixlettervariables"}, "path": "megamek/src/megamek/client/ui/swing/tileset/EntityImage.java", "diffHunk": "@@ -132,17 +134,49 @@ public EntityImage(Image base, Image wreck, int tint, Image camo,\n         this.camo = camo;\r\n         parent = comp;\r\n         this.wreck = wreck;\r\n-        this.dmgLevel = entity.getDamageLevel();\r\n-        this.weight = entity.getWeight();\r\n+        this.dmgLevel = calculateDamageLevel(entity);\r\n+        // hack: gun emplacements are pretty beefy but have weight 0\r\n+        this.weight = entity instanceof GunEmplacement ?\r\n+                SMOKE_THREE + 1 : entity.getWeight();\r\n         isInfantry = entity instanceof Infantry;\r\n+        isTank = entity instanceof Tank;\r\n         isPreview = preview;\r\n-        isSlim = entity instanceof Tank || entity instanceof Aero;\r\n+        isSlim = (isTank && !(entity instanceof GunEmplacement));\r\n         isVerySlim = entity instanceof VTOL;\r\n         pos = secondaryPos;\r\n         isSingleHex = secondaryPos == -1;\r\n         decal = getDamageDecal(entity, secondaryPos);\r\n         smoke = getSmokeImage(entity, secondaryPos);\r\n     }\r\n+    \r\n+    /**\r\n+     * Worker function that calculates the entity's damage level for the purposes of displaying damage \r\n+     * to avoid particularly dumb-looking situations\r\n+     */\r\n+    private int calculateDamageLevel(Entity entity) {\r\n+        // gun emplacements don't show up as crippled when destroyed, which leads to them looking pristine\r\n+        if((entity instanceof GunEmplacement) && entity.isDestroyed()) {\r\n+            return Entity.DMG_CRIPPLED;\r\n+        }\r\n+        \r\n+        // aerospace fighters where the pilot ejects look pretty dumb without any damage decals\r\n+        // so let's give them at least some damage\r\n+        if(entity.isAirborne() && entity.getCrew().isEjected()) {\r\n+            return Math.max(Entity.DMG_HEAVY, entity.getDamageLevel(false));\r\n+        }\r\n+        \r\n+        int calculatedDamageLevel = entity.getDamageLevel();\r\n+        \r\n+        // crippled entities may be \"crippled\" due to harmless weapon jams or being out of ammo but \r\n+        // not having taken any actual damage\r\n+        if(calculatedDamageLevel == Entity.DMG_CRIPPLED) {\r\n+            if(entity.getArmorRemainingPercent() == 1.0) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0082aca784f7965b37bc3a140ea0e62ed9a9b083"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwNjEzNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private List<EntityImage> mechImageList = new ArrayList<EntityImage>();\n          \n          \n            \n                private Map<ArrayList<Integer>, EntityImage> mechImages = new HashMap<ArrayList<Integer>, EntityImage>();\n          \n          \n            \n                private List<EntityImage> mechImageList = new ArrayList<>();\n          \n          \n            \n                private Map<ArrayList<Integer>, EntityImage> mechImages = new HashMap<>();", "url": "https://github.com/MegaMek/megamek/pull/2103#discussion_r475106137", "createdAt": "2020-08-22T16:21:37Z", "author": {"login": "sixlettervariables"}, "path": "megamek/src/megamek/client/ui/swing/tileset/TilesetManager.java", "diffHunk": "@@ -78,8 +88,10 @@\n     private MechTileset mechTileset = new MechTileset(Configuration.unitImagesDir());\n     private MechTileset wreckTileset = new MechTileset(\n             new MegaMekFile(Configuration.unitImagesDir(), DIR_NAME_WRECKS).getFile());\n-    private ArrayList<EntityImage> mechImageList = new ArrayList<EntityImage>();\n-    private HashMap<ArrayList<Integer>, EntityImage> mechImages = new HashMap<ArrayList<Integer>, EntityImage>();\n+    private List<EntityImage> mechImageList = new ArrayList<EntityImage>();\n+    private Map<ArrayList<Integer>, EntityImage> mechImages = new HashMap<ArrayList<Integer>, EntityImage>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0082aca784f7965b37bc3a140ea0e62ed9a9b083"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwNjE3MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private Map<Color, Image> ecmStaticImages = new HashMap<Color, Image>();\n          \n          \n            \n                private Map<Color, Image> ecmStaticImages = new HashMap<>();", "url": "https://github.com/MegaMek/megamek/pull/2103#discussion_r475106171", "createdAt": "2020-08-22T16:21:49Z", "author": {"login": "sixlettervariables"}, "path": "megamek/src/megamek/client/ui/swing/tileset/TilesetManager.java", "diffHunk": "@@ -100,7 +112,7 @@\n      * images for various colors (for Players, and possibly multiple players\n      * in the same hex).\n      */\n-    private HashMap<Color, Image> ecmStaticImages = new HashMap<Color, Image>();\n+    private Map<Color, Image> ecmStaticImages = new HashMap<Color, Image>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0082aca784f7965b37bc3a140ea0e62ed9a9b083"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwNjI5OA==", "bodyText": "What's the magic with 4?", "url": "https://github.com/MegaMek/megamek/pull/2103#discussion_r475106298", "createdAt": "2020-08-22T16:23:24Z", "author": {"login": "sixlettervariables"}, "path": "megamek/src/megamek/client/ui/swing/tileset/TilesetManager.java", "diffHunk": "@@ -179,6 +217,107 @@ public Image wreckMarkerFor(Entity entity, int secondaryPos) {\n         }\n         return entityImage.getWreckFacing(entity.getFacing());\n     }\n+    \n+    /** Retrieves the \"devastated\" decoration for the given entity */\n+    public Image getCraterFor(Entity entity, int secondaryPos) {\n+        Image marker = null;\n+        \n+        String suffix = EntityWreckHelper.getWeightSuffix(entity);\n+        String filename = String.format(\"crater_decal_%s.png\", suffix);\n+        String path = String.format(\"%s/%s\", DIR_NAME_WRECKS, DIR_NAME_BOTTOM_DECALS);\n+        \n+        if(wreckageDecals.containsKey(filename)) {\n+            marker = wreckageDecals.get(filename);\n+        } else {\n+            marker = TilesetManager.LoadSpecificImage(new File(Configuration.unitImagesDir(), path), filename);\n+            wreckageDecals.put(filename, marker);\n+        }\n+        \n+        return marker;\n+    }\n+    \n+    /** Retrieves the \"destroyed\" decoration for the given entity */\n+    public Image bottomLayerWreckMarkerFor(Entity entity, int secondaryPos) {\n+        Image marker = null;\n+\n+        // wreck filenames are in the format destroyed_decal_x_weightsuffix, where x is 1 through however many bottom splats we have\n+        // in the directory. To make sure we don't swap splats between entities, we make it depend on entity ID        \n+        String suffix = EntityWreckHelper.getWeightSuffix(entity);\n+        int wreckNum = (entity.getId() % this.wreckageDecalCount.get(suffix)) + 1;\n+        String filename = String.format(\"%s%d_%s.png\", FILENAME_PREFIX_WRECKS, wreckNum, suffix);\n+        String path = String.format(\"%s/%s\", DIR_NAME_WRECKS, DIR_NAME_BOTTOM_DECALS);\n+        \n+        if(wreckageDecals.containsKey(filename)) {\n+            marker = wreckageDecals.get(filename);\n+        } else {\n+            marker = TilesetManager.LoadSpecificImage(new File(Configuration.unitImagesDir(), path), filename);\n+            wreckageDecals.put(filename, marker);\n+        }\n+        \n+        return marker;\n+    }\n+    \n+    /** Retrieves the \"destroyed\" decoration for the given entity */\n+    public Image bottomLayerFuelLeakMarkerFor(Entity entity) {\n+        Image marker = null;\n+        \n+        String suffix = EntityWreckHelper.getWeightSuffix(entity);\n+        String filename = String.format(\"fuelleak_decal_%s.png\", suffix);\n+        String path = String.format(\"%s/%s\", DIR_NAME_WRECKS, DIR_NAME_BOTTOM_DECALS);\n+        \n+        int rotationKey = entity.getId() % 4;\n+        String imageKey = String.format(\"%s%s\", filename, rotationKey);\n+        \n+        if(!wreckageDecals.containsKey(imageKey)) {\n+            Image baseImage = TilesetManager.LoadSpecificImage(new File(Configuration.unitImagesDir(), path), filename);\n+            \n+            for(double x = 0; x < 4; x++) {\n+                RotateFilter rf = new RotateFilter(x * 90);\n+                String newImageKey = String.format(\"%s%s\", filename, (int) x);\n+                \n+                ImageProducer ip = new FilteredImageSource(baseImage.getSource(), rf);\n+                Image resultImage = Toolkit.getDefaultToolkit().createImage(ip);\n+                wreckageDecals.put(newImageKey, resultImage);\n+            }\n+        }\n+        \n+        marker = wreckageDecals.get(imageKey);\n+        \n+        return marker;\n+    }\n+    \n+    /** Retrieves the \"destroyed\" decoration for the given entity */\n+    public Image bottomLayerMotiveMarkerFor(Entity entity) {\n+        Image marker = null;\n+        \n+        String weightSuffix = EntityWreckHelper.getWeightSuffix(entity);\n+        String motivePrefix = EntityWreckHelper.getMotivePrefix(entity);\n+        \n+        if(motivePrefix != null) {\n+            String filename = String.format(\"%s_decal_%s.png\", motivePrefix, weightSuffix);\n+            String path = String.format(\"%s/%s\", DIR_NAME_WRECKS, DIR_NAME_BOTTOM_DECALS);\n+            \n+            int rotationKey = entity.getId() % 4;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0082aca784f7965b37bc3a140ea0e62ed9a9b083"}, "originalPosition": 174}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwNjQ3Mg==", "bodyText": "Does this handle entities that have moved offboard? I know we've had some issues with that in the past.", "url": "https://github.com/MegaMek/megamek/pull/2103#discussion_r475106472", "createdAt": "2020-08-22T16:25:18Z", "author": {"login": "sixlettervariables"}, "path": "megamek/src/megamek/client/ui/swing/util/EntityWreckHelper.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * MegaMek - Copyright (C) 2020 - The MegaMek Team\n+ *\n+ *  This program is free software; you can redistribute it and/or modify it\n+ *  under the terms of the GNU General Public License as published by the Free\n+ *  Software Foundation; either version 2 of the License, or (at your option)\n+ *  any later version.\n+ *\n+ *  This program is distributed in the hope that it will be useful, but\n+ *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY\n+ *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License\n+ *  for more details.\n+ */\n+\n+package megamek.client.ui.swing.util;\n+\n+import megamek.client.ui.swing.tileset.TilesetManager;\n+import megamek.common.Engine;\n+import megamek.common.Entity;\n+import megamek.common.EntityMovementMode;\n+import megamek.common.EntityWeightClass;\n+import megamek.common.GunEmplacement;\n+import megamek.common.IEntityRemovalConditions;\n+import megamek.common.IHex;\n+import megamek.common.Infantry;\n+import megamek.common.Mech;\n+import megamek.common.Tank;\n+import megamek.common.Terrains;\n+\n+/**\n+ * This class handles logic for displaying various kinds of damage and destruction decals\n+ * @author NickAragua\n+ * \n+ */\n+public class EntityWreckHelper {    \n+    /**\n+     * Logic that determines if we should be display \"destroyed\" decals below the destroyed entity.\n+     * Assumes that the entity is destroyed.\n+     */\n+    public static boolean displayDestroyedDecal(Entity entity) {\n+        // don't display \"generic\" destroyed decals in the following situations:\n+        //  in space (looks weird)\n+        //  for mechs/infantry/VTOLs (needs specialized icons) \n+        //  for units that were destroyed by ejection rather than unit destruction\n+        //  for units on top of a bridge (looks kind of stupid)\n+        \n+        if(entity.getGame().getBoard().inSpace() ||\n+                (entity instanceof Mech) ||\n+                (entity instanceof Infantry) ||\n+                (entity instanceof GunEmplacement) ||\n+                !entity.getSecondaryPositions().isEmpty() ||\n+                entityOnBridge(entity)) {\n+            return false;\n+        }\n+        \n+        return true;\n+    }\n+    \n+    public static boolean useExplicitWreckImage(Entity entity) {\n+        return entity instanceof Mech;\n+    }\n+    \n+    /**\n+     * Logic that determines whether we should display a 'fuel leak' for the given entity.\n+     */\n+    public static boolean displayFuelLeak(Entity entity) {\n+        return (entity instanceof Tank) &&\n+                (entity.getMovementMode() != EntityMovementMode.VTOL) && \n+                (entity.getEngine().getEngineType() == Engine.COMBUSTION_ENGINE) &&\n+                entity.isPermanentlyImmobilized(false) &&\n+                !entity.getGame().getBoard().inSpace() &&\n+                !entityOnBridge(entity);\n+    }\n+    \n+    /**\n+     * Whether we should display 'motive damage' for the given entity, meaning loose treads and such\n+     */\n+    public static boolean displayMotiveDamage(Entity entity) {\n+        return entity.isPermanentlyImmobilized(false) && \n+                ((entity.getMovementMode() == EntityMovementMode.WHEELED) ||\n+                (entity.getMovementMode() == EntityMovementMode.TRACKED)) && \n+                entity.getSecondaryPositions().isEmpty() &&\n+                !entity.getGame().getBoard().inSpace() &&\n+                !entityOnBridge(entity);\n+    }\n+    \n+    /**\n+     * Whether a given entity should display a crater instead of its standard wreckage marker.\n+     */\n+    public static boolean displayDevastation(Entity entity) {\n+        return (entity.getRemovalCondition() == IEntityRemovalConditions.REMOVE_DEVASTATED);\n+    }\n+    \n+    /**\n+     * Gets the prefix used to retrieve image files for motive-damaged entities\n+     */\n+    public static String getMotivePrefix(Entity entity) {\n+        if(!displayMotiveDamage(entity)) {\n+            return null;\n+        }\n+        \n+        switch(entity.getMovementMode()) {\n+        case WHEELED:\n+            return \"wheels\";\n+        case TRACKED:\n+            return \"treads\";\n+        default:\n+            return null;\n+        }\n+    }\n+    \n+    /**\n+     * Gets the weight class suffix for destruction decals for the given entity\n+     */\n+    public static String getWeightSuffix(Entity entity) {\n+        switch(entity.getWeightClass()) {\n+        case EntityWeightClass.WEIGHT_ULTRA_LIGHT:\n+            return TilesetManager.FILENAME_SUFFIX_WRECKS_ULTRALIGHT;\n+        case EntityWeightClass.WEIGHT_LIGHT:\n+            // this is a \"hack\" as some units < 20 tons are classified as 'light'\n+            // additionally, gun emplacements are \"light\" but should really have a little more debris.\n+            if ((entity.getWeight() > 0) && (entity.getWeight() < 20)) {\n+               return TilesetManager.FILENAME_SUFFIX_WRECKS_ULTRALIGHT; \n+            } else {\n+                return TilesetManager.FILENAME_SUFFIX_WRECKS_ASSAULTPLUS;\n+            }\n+        default:\n+            return TilesetManager.FILENAME_SUFFIX_WRECKS_ASSAULTPLUS;\n+        }\n+    }\n+    \n+    /**\n+     * Utility function that determines if the entity is on a bridge\n+     */\n+    public static boolean entityOnBridge(Entity entity) {   \n+        IHex hex = entity.getGame().getBoard().getHex(entity.getPosition());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0082aca784f7965b37bc3a140ea0e62ed9a9b083"}, "originalPosition": 136}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwNjUxMg==", "bodyText": "Do these need to be public?", "url": "https://github.com/MegaMek/megamek/pull/2103#discussion_r475106512", "createdAt": "2020-08-22T16:25:46Z", "author": {"login": "sixlettervariables"}, "path": "megamek/src/megamek/common/GunEmplacement.java", "diffHunk": "@@ -51,6 +51,9 @@\n             .setTechRating(RATING_A).setAvailability(RATING_A, RATING_A, RATING_A, RATING_A)\n             .setStaticTechLevel(SimpleTechLevel.INTRO);\n     \n+    public int initialBuildingCF;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0082aca784f7965b37bc3a140ea0e62ed9a9b083"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwNjU2MA==", "bodyText": "The logic in a previous file used 1.0 as if percent was a fraction. This seems to insinuate we're using percents.", "url": "https://github.com/MegaMek/megamek/pull/2103#discussion_r475106560", "createdAt": "2020-08-22T16:26:30Z", "author": {"login": "sixlettervariables"}, "path": "megamek/src/megamek/common/GunEmplacement.java", "diffHunk": "@@ -585,4 +588,42 @@ public int getArmorType(int loc) {\n     public boolean hasStealth() {\n         return false;\n     }\n+    \n+    /**\n+     * Sets the deployed flag. \n+     * Has the side effect of initializing building CF if deployed\n+     */\n+    @Override\n+    public void setDeployed(boolean deployed) {\n+        super.setDeployed(deployed);\n+        \n+        if(deployed) {\n+            Building occupiedStructure = getGame().getBoard().getBuildingAt(getPosition());\n+            \n+            initialBuildingCF = occupiedStructure.getCurrentCF(getPosition());\n+            initialBuildingArmor = occupiedStructure.getArmor(getPosition());\n+        } else {\n+            initialBuildingCF = initialBuildingArmor = 0;\n+        }\n+    }\n+    \n+    /**\n+     * How much more damage, percentage-wise, the gun emplacement's building can take\n+     */\n+    @Override\n+    public double getArmorRemainingPercent() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0082aca784f7965b37bc3a140ea0e62ed9a9b083"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwNjYzMQ==", "bodyText": "Double check your logic here and below, you're mixing fractions and percents.", "url": "https://github.com/MegaMek/megamek/pull/2103#discussion_r475106631", "createdAt": "2020-08-22T16:27:12Z", "author": {"login": "sixlettervariables"}, "path": "megamek/src/megamek/client/ui/swing/tileset/EntityImage.java", "diffHunk": "@@ -132,17 +134,49 @@ public EntityImage(Image base, Image wreck, int tint, Image camo,\n         this.camo = camo;\r\n         parent = comp;\r\n         this.wreck = wreck;\r\n-        this.dmgLevel = entity.getDamageLevel();\r\n-        this.weight = entity.getWeight();\r\n+        this.dmgLevel = calculateDamageLevel(entity);\r\n+        // hack: gun emplacements are pretty beefy but have weight 0\r\n+        this.weight = entity instanceof GunEmplacement ?\r\n+                SMOKE_THREE + 1 : entity.getWeight();\r\n         isInfantry = entity instanceof Infantry;\r\n+        isTank = entity instanceof Tank;\r\n         isPreview = preview;\r\n-        isSlim = entity instanceof Tank || entity instanceof Aero;\r\n+        isSlim = (isTank && !(entity instanceof GunEmplacement));\r\n         isVerySlim = entity instanceof VTOL;\r\n         pos = secondaryPos;\r\n         isSingleHex = secondaryPos == -1;\r\n         decal = getDamageDecal(entity, secondaryPos);\r\n         smoke = getSmokeImage(entity, secondaryPos);\r\n     }\r\n+    \r\n+    /**\r\n+     * Worker function that calculates the entity's damage level for the purposes of displaying damage \r\n+     * to avoid particularly dumb-looking situations\r\n+     */\r\n+    private int calculateDamageLevel(Entity entity) {\r\n+        // gun emplacements don't show up as crippled when destroyed, which leads to them looking pristine\r\n+        if((entity instanceof GunEmplacement) && entity.isDestroyed()) {\r\n+            return Entity.DMG_CRIPPLED;\r\n+        }\r\n+        \r\n+        // aerospace fighters where the pilot ejects look pretty dumb without any damage decals\r\n+        // so let's give them at least some damage\r\n+        if(entity.isAirborne() && entity.getCrew().isEjected()) {\r\n+            return Math.max(Entity.DMG_HEAVY, entity.getDamageLevel(false));\r\n+        }\r\n+        \r\n+        int calculatedDamageLevel = entity.getDamageLevel();\r\n+        \r\n+        // crippled entities may be \"crippled\" due to harmless weapon jams or being out of ammo but \r\n+        // not having taken any actual damage\r\n+        if(calculatedDamageLevel == Entity.DMG_CRIPPLED) {\r\n+            if(entity.getArmorRemainingPercent() == 1.0) {\r", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwNjA4OQ=="}, "originalCommit": {"oid": "0082aca784f7965b37bc3a140ea0e62ed9a9b083"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83c1592bf6b0984f431725a49b44e3fb7c07a78c", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/83c1592bf6b0984f431725a49b44e3fb7c07a78c", "committedDate": "2020-08-22T16:53:37Z", "message": "Apply suggestions from code review\n\nCo-authored-by: Christopher Watford <christopher.watford@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9487f286deacd815099c37b6a9179d54c17b86fc", "author": {"user": {"login": "NickAragua", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/9487f286deacd815099c37b6a9179d54c17b86fc", "committedDate": "2020-08-22T17:13:41Z", "message": "apply code review suggestions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyOTQxODQx", "url": "https://github.com/MegaMek/megamek/pull/2103#pullrequestreview-472941841", "createdAt": "2020-08-22T17:57:57Z", "commit": {"oid": "9487f286deacd815099c37b6a9179d54c17b86fc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4926, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}