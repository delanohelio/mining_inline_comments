{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwNDY5NjE1", "number": 2460, "title": "Fix machine gun array linking and bv", "bodyText": "This fixes some related issues with machine gun arrays. Each array can link up to four machine guns of the same type in the same location. MM uses the bay weapon list in Mounted to track which guns are linked. The linking happens in MechFileParser#postLoadInit, which is called when the unit is loaded and also called by MML when changes may affect weapon linkings.\nProblems:\n\nThe loop that checks for machine guns to link will link all machine guns of the correct size in the location that have not already been linked until it is full or runs out of guns. This does not allow the unit to split guns between separate arrays. For example, the Linebacker I has two MGAs in each arm, which should each have three MGs. But it always assigns four to the first one and the other two to the remaining one. It is also not possible to have additional unlinked machine guns in the location if the MGA is not full.\nThe BV of a machine gun array is the sum of the linked guns x 0.67. The BV code currently ignores any linking restrictions and includes the BV of all machine guns in the location. So in the case of the Linebacker I, each arm MGA is assigned twice the correct BV.\n\nFixes:\n\nI changed the linking code to look for a contiguous block of qualifying machine guns in the location. Once the first eligible gun is found, any successive slot occupied by anything other than an eligible MG stops the process. So an MGA followed by the linked guns or a block of linked guns followed by the MGA will both work. Placing the MGA in the middle of a block of machine guns will cause the guns preceding the MGA to be linked and those following to be independent. I believe that this fits intuitive behavior.\nI factored the linking code out of the postLoadInit method, which is ~700 lines, which also makes it a distinct unit available for testing.\nThe BV calculations only count the linked guns. This involves functionally identical code in six different places, but I left it to keep the changes minimal since I'm working on a complete rewrite of the BV code. This will fix the bug in the meantime.\n\nFixes #2195", "createdAt": "2020-12-01T17:44:06Z", "url": "https://github.com/MegaMek/megamek/pull/2460", "merged": true, "mergeCommit": {"oid": "4766915d2cd52f7a3eac43ec21069b7d0b4c13b6"}, "closed": true, "closedAt": "2020-12-01T22:57:11Z", "author": {"login": "neoancient"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdh9EK5AH2gAyNTMwNDY5NjE1Ojg5ZGRkNjBjN2MwZDk1MjQxZmM1YjNmYmFhMGM5MDE1NTNjYTI4ZTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdh-N5pAFqTU0MjE3OTc2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "89ddd60c7c0d95241fc5b3fbaa0c901553ca28e5", "author": {"user": {"login": "neoancient", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/89ddd60c7c0d95241fc5b3fbaa0c901553ca28e5", "committedDate": "2020-12-01T17:05:30Z", "message": "Limit machine gun array BV to linked weapons"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "727f800011453226a7f928dcac4dc5f6a68fd2f8", "author": {"user": {"login": "neoancient", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/727f800011453226a7f928dcac4dc5f6a68fd2f8", "committedDate": "2020-12-01T17:05:36Z", "message": "Improve linking machine guns to machine gun arrays"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4900dcebbbbbd1be04f25662918ef8e62241c48", "author": {"user": {"login": "neoancient", "name": null}}, "url": "https://github.com/MegaMek/megamek/commit/c4900dcebbbbbd1be04f25662918ef8e62241c48", "committedDate": "2020-12-01T17:05:47Z", "message": "Factor MGA linking routine out of postLoadInit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMTY2MTIz", "url": "https://github.com/MegaMek/megamek/pull/2460#pullrequestreview-542166123", "createdAt": "2020-12-01T18:08:16Z", "commit": {"oid": "c4900dcebbbbbd1be04f25662918ef8e62241c48"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxODowODoxNlrOH85dgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxODowODoxNlrOH85dgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYxODA0OA==", "bodyText": "This block of code appears to be repeated something like five times, perhaps we could create a utility function somewhere to reduce duplicated logic?", "url": "https://github.com/MegaMek/megamek/pull/2460#discussion_r533618048", "createdAt": "2020-12-01T18:08:16Z", "author": {"login": "NickAragua"}, "path": "megamek/src/megamek/common/Aero.java", "diffHunk": "@@ -1841,14 +1841,14 @@ public int calculateBattleValue(boolean ignoreC3, boolean ignorePilot) {\n             }\n             // calc MG Array here:\n             if (wtype.hasFlag(WeaponType.F_MGA)) {\n-                double mgaBV = 0;\n-                for (Mounted possibleMG : getTotalWeaponList()) {\n-                    if (possibleMG.getType().hasFlag(WeaponType.F_MG)\n-                            && (possibleMG.getLocation() == weapon.getLocation())) {\n-                        mgaBV += possibleMG.getType().getBV(this);\n+                double mgBV = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4900dcebbbbbd1be04f25662918ef8e62241c48"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMTc5NzYz", "url": "https://github.com/MegaMek/megamek/pull/2460#pullrequestreview-542179763", "createdAt": "2020-12-01T18:26:02Z", "commit": {"oid": "c4900dcebbbbbd1be04f25662918ef8e62241c48"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4687, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}