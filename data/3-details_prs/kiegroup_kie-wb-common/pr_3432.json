{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxOTA3OTA2", "number": 3432, "title": "RHPAM-3119 : [Data Modeler] Unsaved changes dialog appears after rename", "bodyText": "Issue: When we change a package or fileName in the general properties of DataModeller and save it, the DataObject is reloaded. If we try to close the data object before reload is complete we see unsaved changes dialog.\nReason: DataObject context and source are updated only during reloading.\nSolution: The context and source hash are updated before reload. The DataObject is sent to the server after any change in DataModeller or the source to handle the inconsistencies in source and DataObject Model.\nJIRA: RHPAM-3119\n\n\nHow to retest this PR or trigger a specific build:\n\n\nRetest PR: jenkins retest this\nA full downstream build: jenkins do fdb\nA compile downstream build: jenkins do cdb\nA full production downstream build: jenkins do product fdb\nAn upstream build: jenkins do upstream", "createdAt": "2020-09-23T16:42:52Z", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432", "merged": true, "mergeCommit": {"oid": "89d685d1ae8089fc5ab64ee698084b93fc80debb"}, "closed": true, "closedAt": "2020-09-25T16:56:53Z", "author": {"login": "akumar074"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLv87_ABqjM3OTkyMzQ4NDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMYxTZAFqTQ5NjU5MTAxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f5edc7af76da423709ecbd218509fecab81681bf", "author": {"user": {"login": "akumar074", "name": "Abhishek Kumar"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/f5edc7af76da423709ecbd218509fecab81681bf", "committedDate": "2020-09-23T16:25:25Z", "message": "RHPAM-3119 : [Data Modeler] Unsaved changes dialog appears after rename\n\n - DataObject is being send to the server if any change in Source or DataModeler\n - DataModeler context and source updated after package or file name changes\n - DataObject package and file name updates before  resolveSaveSource"}, "afterCommit": {"oid": "4eaa7971453b7c1e35a56a60bbbc57a55de64045", "author": {"user": {"login": "akumar074", "name": "Abhishek Kumar"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/4eaa7971453b7c1e35a56a60bbbc57a55de64045", "committedDate": "2020-09-23T17:21:48Z", "message": "RHPAM-3119 : [Data Modeler] Unsaved changes dialog appears after rename\n\n - DataObject is being send to the server if any change in Source or DataModeler\n - DataModeler context and source updated after package or file name changes\n - DataObject package and file name updates before  resolveSaveSource"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "594b992aea0f5b47ae665f5896ba73a9cce0def6", "author": {"user": {"login": "akumar074", "name": "Abhishek Kumar"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/594b992aea0f5b47ae665f5896ba73a9cce0def6", "committedDate": "2020-09-24T08:28:42Z", "message": "RHPAM-3119 : [Data Modeler] Unsaved changes dialog appears after rename\n\n - DataObject is being send to the server if any change in Source or DataModeler\n - DataModeler context and source updated after package or file name changes\n - DataObject package and file name updates before  resolveSaveSource"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4eaa7971453b7c1e35a56a60bbbc57a55de64045", "author": {"user": {"login": "akumar074", "name": "Abhishek Kumar"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/4eaa7971453b7c1e35a56a60bbbc57a55de64045", "committedDate": "2020-09-23T17:21:48Z", "message": "RHPAM-3119 : [Data Modeler] Unsaved changes dialog appears after rename\n\n - DataObject is being send to the server if any change in Source or DataModeler\n - DataModeler context and source updated after package or file name changes\n - DataObject package and file name updates before  resolveSaveSource"}, "afterCommit": {"oid": "594b992aea0f5b47ae665f5896ba73a9cce0def6", "author": {"user": {"login": "akumar074", "name": "Abhishek Kumar"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/594b992aea0f5b47ae665f5896ba73a9cce0def6", "committedDate": "2020-09-24T08:28:42Z", "message": "RHPAM-3119 : [Data Modeler] Unsaved changes dialog appears after rename\n\n - DataObject is being send to the server if any change in Source or DataModeler\n - DataModeler context and source updated after package or file name changes\n - DataObject package and file name updates before  resolveSaveSource"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NDQ1NTI0", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432#pullrequestreview-495445524", "createdAt": "2020-09-24T10:50:27Z", "commit": {"oid": "594b992aea0f5b47ae665f5896ba73a9cce0def6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NjIyMTU4", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432#pullrequestreview-495622158", "createdAt": "2020-09-24T14:17:21Z", "commit": {"oid": "594b992aea0f5b47ae665f5896ba73a9cce0def6"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNDoxNzoyMVrOHXdJfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNDo1Mjo1MVrOHXe2fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM1Njg2MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                * */\n          \n          \n            \n                                 */", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432#discussion_r494356860", "createdAt": "2020-09-24T14:17:21Z", "author": {"login": "caponetto"}, "path": "kie-wb-common-screens/kie-wb-common-data-modeller/kie-wb-common-data-modeller-client/src/main/java/org/kie/workbench/common/screens/datamodeller/client/DataModelerScreenPresenter.java", "diffHunk": "@@ -588,23 +588,16 @@ public void execute(final String commitMessage) {\n \n                 final DataObject[] modifiedDataObject = new DataObject[1];\n                 if (isDirty()) {\n-                    if (context.isEditorChanged()) {\n-\n-                        //at save time the source has always priority over the model.\n-                        //If the source was properly parsed and the editor has changes, we need to send the DataObject\n-                        //to the server in order to let the source to be updated prior to save.\n-                        modifiedDataObject[0] = context.getDataObject();\n-                    } else {\n-                        //if the source has changes, no update form the UI to the source will be performed.\n-                        //instead the parsed DataObject must be returned from the server.\n-                        modifiedDataObject[0] = null;\n-                    }\n+                    /* when DataObject editor or source is changed we\n+                     * need to send the DataObject to the server  in order\n+                     *  to let the source to be updated prior to save.\n+                    * */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "594b992aea0f5b47ae665f5896ba73a9cce0def6"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM2ODQ5Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private RemoteCallback<GenerationResult> getSaveSuccessCallback( final Path currentPath) {\n          \n          \n            \n                private RemoteCallback<GenerationResult> getSaveSuccessCallback(final Path currentPath) {", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432#discussion_r494368497", "createdAt": "2020-09-24T14:32:03Z", "author": {"login": "caponetto"}, "path": "kie-wb-common-screens/kie-wb-common-data-modeller/kie-wb-common-data-modeller-client/src/main/java/org/kie/workbench/common/screens/datamodeller/client/DataModelerScreenPresenter.java", "diffHunk": "@@ -627,17 +619,14 @@ public void execute(final String commitMessage) {\n         };\n     }\n \n-    private RemoteCallback<GenerationResult> getSaveSuccessCallback(final JavaTypeInfo newTypeInfo,\n-                                                                    final Path currentPath) {\n+    private RemoteCallback<GenerationResult> getSaveSuccessCallback( final Path currentPath) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "594b992aea0f5b47ae665f5896ba73a9cce0def6"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM3ODIzNA==", "bodyText": "Given the comment below If the file was renamed as part of the file saving, don't do anything.,\nwould you mind explaining the reason for removing this if-else block?\nAlso, there is no unit test for exercising this method.\nIt'd be great if you could create a few ones.", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432#discussion_r494378234", "createdAt": "2020-09-24T14:44:38Z", "author": {"login": "caponetto"}, "path": "kie-wb-common-screens/kie-wb-common-data-modeller/kie-wb-common-data-modeller-client/src/main/java/org/kie/workbench/common/screens/datamodeller/client/DataModelerScreenPresenter.java", "diffHunk": "@@ -627,17 +619,14 @@ public void execute(final String commitMessage) {\n         };\n     }\n \n-    private RemoteCallback<GenerationResult> getSaveSuccessCallback(final JavaTypeInfo newTypeInfo,\n-                                                                    final Path currentPath) {\n+    private RemoteCallback<GenerationResult> getSaveSuccessCallback( final Path currentPath) {\n         return new RemoteCallback<GenerationResult>() {\n \n             @Override\n             public void callback(GenerationResult result) {\n \n                 view.hideBusyIndicator();\n \n-                if (newTypeInfo == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "594b992aea0f5b47ae665f5896ba73a9cce0def6"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM4NDc2Ng==", "bodyText": "I'd move this code into the if blocks above because there is no need for doing setName and setPackageName if name and package didn't change, respectively. It also avoids having to remove \".java\" from targetName.\nSomething like this:\nif (newPackageName != null && (currentPackage == null || !newPackageName.equals(currentPackage.getPackageName()))) {\n    targetPackage = serviceHelper.ensurePackageStructure(moduleService.resolveModule(path),\n                                                         newPackageName);\n\n    // Moved here\n    if (dataObject != null && targetPackage != null) {\n        dataObject.setPackageName(targetPackage.getPackageName());\n    }\n\n    packageChanged = true;\n}\n\nif (newFileName != null && !(newFileName + \".java\").equals(path.getFileName())) {\n    targetName = newFileName + \".java\";\n\n    // Moved here\n    if (dataObject != null) {\n        dataObject.setName(newFileName);\n    }\n\n    nameChanged = true;\n}", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432#discussion_r494384766", "createdAt": "2020-09-24T14:52:51Z", "author": {"login": "caponetto"}, "path": "kie-wb-common-screens/kie-wb-common-data-modeller/kie-wb-common-data-modeller-backend/src/main/java/org/kie/workbench/common/screens/datamodeller/backend/server/DataModelerServiceImpl.java", "diffHunk": "@@ -569,6 +566,19 @@ public GenerationResult saveSource(final String source,\n                 targetName = newFileName + \".java\";\n                 nameChanged = true;\n             }\n+            \n+            /* Modify data object with updated fileName and packageName\n+             * before resolving source to handle inconsistencies in\n+             * source code and data object\n+             * */\n+            if  (dataObject  != null) {\n+                dataObject.setName(targetName.replace(\".java\", \"\"));\n+                dataObject.setPackageName(targetPackage.getPackageName());\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "594b992aea0f5b47ae665f5896ba73a9cce0def6"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2b52043e3a9e22cae6e3431f4a6165dc80aa1b7", "author": {"user": {"login": "akumar074", "name": "Abhishek Kumar"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/b2b52043e3a9e22cae6e3431f4a6165dc80aa1b7", "committedDate": "2020-09-24T20:12:25Z", "message": "RHPAM-3119 : [Data Modeler] Unsaved changes dialog appears after rename\n\n - DataObject is being send to the server if any change in Source or DataModeler\n - DataModeler context and source updated after package or file name changes\n - DataObject package and file name updates before  resolveSaveSource"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb37f0eda657ef39a932630f5fd88bc70d4de2f8", "author": {"user": {"login": "akumar074", "name": "Abhishek Kumar"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/bb37f0eda657ef39a932630f5fd88bc70d4de2f8", "committedDate": "2020-09-25T09:53:06Z", "message": "RHPAM-3119 : [Data Modeler] Unsaved changes dialog appears after rename\n\n - DataObject is being send to the server if any change in Source or DataModeler\n - DataModeler context and source updated after package or file name changes\n - DataObject package and file name updates before  resolveSaveSource\n - Added tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ee2f779356dbbeb580ef60e7b64c5be9bf40d3d4", "author": {"user": {"login": "akumar074", "name": "Abhishek Kumar"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/ee2f779356dbbeb580ef60e7b64c5be9bf40d3d4", "committedDate": "2020-09-25T05:28:15Z", "message": "RHPAM-3119 : [Data Modeler] Unsaved changes dialog appears after rename\n\n - DataObject is being send to the server if any change in Source or DataModeler\n - DataModeler context and source updated after package or file name changes\n - DataObject package and file name updates before  resolveSaveSource\n - Added tests"}, "afterCommit": {"oid": "bb37f0eda657ef39a932630f5fd88bc70d4de2f8", "author": {"user": {"login": "akumar074", "name": "Abhishek Kumar"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/bb37f0eda657ef39a932630f5fd88bc70d4de2f8", "committedDate": "2020-09-25T09:53:06Z", "message": "RHPAM-3119 : [Data Modeler] Unsaved changes dialog appears after rename\n\n - DataObject is being send to the server if any change in Source or DataModeler\n - DataModeler context and source updated after package or file name changes\n - DataObject package and file name updates before  resolveSaveSource\n - Added tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2Mzg0NjU1", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432#pullrequestreview-496384655", "createdAt": "2020-09-25T12:44:29Z", "commit": {"oid": "bb37f0eda657ef39a932630f5fd88bc70d4de2f8"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxMjo0NDoyOVrOHYCETQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxMjo0NDoyOVrOHYCETQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk2MTc0MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if  (dataObject  != null) {\n          \n          \n            \n                        if (dataObject != null) {\n          \n      \n    \n    \n  \n\nSince we are keeping this if block, can you please remove these extra spaces?", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432#discussion_r494961741", "createdAt": "2020-09-25T12:44:29Z", "author": {"login": "caponetto"}, "path": "kie-wb-common-screens/kie-wb-common-data-modeller/kie-wb-common-data-modeller-backend/src/main/java/org/kie/workbench/common/screens/datamodeller/backend/server/DataModelerServiceImpl.java", "diffHunk": "@@ -569,6 +566,19 @@ public GenerationResult saveSource(final String source,\n                 targetName = newFileName + \".java\";\n                 nameChanged = true;\n             }\n+            \n+            /* Modify data object with updated fileName and packageName\n+             * or by resolving from @path before resolving source to handle\n+             * inconsistencies in source code and data object\n+             * */\n+            if  (dataObject  != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb37f0eda657ef39a932630f5fd88bc70d4de2f8"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "188ba5025926701f6bc69ae560764ab12b95d878", "author": {"user": {"login": "akumar074", "name": "Abhishek Kumar"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/188ba5025926701f6bc69ae560764ab12b95d878", "committedDate": "2020-09-25T13:20:18Z", "message": "RHPAM-3119 : [Data Modeler] Unsaved changes dialog appears after rename\r\n\r\n- DataObject is being send to the server if any change in Source or DataModeler\r\n- DataModeler context and source updated after package or file name changes\r\n- DataObject package and file name updates before\u00a0 resolveSaveSource\r\n- Added tests\n\nCo-authored-by: Guilherme Caponetto <638737+caponetto@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NTkxMDE5", "url": "https://github.com/kiegroup/kie-wb-common/pull/3432#pullrequestreview-496591019", "createdAt": "2020-09-25T16:55:54Z", "commit": {"oid": "188ba5025926701f6bc69ae560764ab12b95d878"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 312, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}