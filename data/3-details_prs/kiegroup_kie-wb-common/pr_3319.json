{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2ODYxOTkz", "number": 3319, "title": "JBPM-9175: Stunner - Usability improvements around selection / drag capabilities", "bodyText": "@romartin, @inodeman: Please, could you review this PR?\nSee https://issues.redhat.com/browse/JBPM-9175\nAssembly with:\n\n#3319\nkiegroup/lienzo-core#111\nkiegroup/lienzo-tests#94", "createdAt": "2020-06-02T22:28:53Z", "url": "https://github.com/kiegroup/kie-wb-common/pull/3319", "merged": true, "mergeCommit": {"oid": "fc322c69ea5c8729958e730a01ca45a07fb9fbcf"}, "closed": true, "closedAt": "2020-07-21T23:23:11Z", "author": {"login": "handreyrc"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnsVvhABqjM0MDMxMDUyMjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc025LIAFqTQ0ODE1OTc3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c385b96b55b6e901fb074499c438c594b99da84", "author": {"user": {"login": "handreyrc", "name": "Handreyrc"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/9c385b96b55b6e901fb074499c438c594b99da84", "committedDate": "2020-06-02T22:05:58Z", "message": "JBPM-8253: Stunner - node lose selection decorations"}, "afterCommit": {"oid": "c3de3e5f9b346e9a09a0caeb901010e3a73f4118", "author": {"user": {"login": "handreyrc", "name": "Handreyrc"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/c3de3e5f9b346e9a09a0caeb901010e3a73f4118", "committedDate": "2020-06-03T16:47:57Z", "message": "JBPM-8253: Stunner - node lose selection decorations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c3de3e5f9b346e9a09a0caeb901010e3a73f4118", "author": {"user": {"login": "handreyrc", "name": "Handreyrc"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/c3de3e5f9b346e9a09a0caeb901010e3a73f4118", "committedDate": "2020-06-03T16:47:57Z", "message": "JBPM-8253: Stunner - node lose selection decorations"}, "afterCommit": {"oid": "1125801c835837c4e8aced6a9dc1cc04ea95c367", "author": {"user": {"login": "handreyrc", "name": "Handreyrc"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/1125801c835837c4e8aced6a9dc1cc04ea95c367", "committedDate": "2020-06-04T19:48:35Z", "message": "JBPM-8253: Stunner - node lose selection decorations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1125801c835837c4e8aced6a9dc1cc04ea95c367", "author": {"user": {"login": "handreyrc", "name": "Handreyrc"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/1125801c835837c4e8aced6a9dc1cc04ea95c367", "committedDate": "2020-06-04T19:48:35Z", "message": "JBPM-8253: Stunner - node lose selection decorations"}, "afterCommit": {"oid": "22ddd80d1b90d6f753dae94420ef85fffe860bcb", "author": {"user": {"login": "handreyrc", "name": "Handreyrc"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/22ddd80d1b90d6f753dae94420ef85fffe860bcb", "committedDate": "2020-06-11T15:14:40Z", "message": "JBPM-8253: Stunner - node lose selection decorations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "22ddd80d1b90d6f753dae94420ef85fffe860bcb", "author": {"user": {"login": "handreyrc", "name": "Handreyrc"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/22ddd80d1b90d6f753dae94420ef85fffe860bcb", "committedDate": "2020-06-11T15:14:40Z", "message": "JBPM-8253: Stunner - node lose selection decorations"}, "afterCommit": {"oid": "d575276a7a7a01c888b17b9930be8f9a650864da", "author": {"user": {"login": "handreyrc", "name": "Handreyrc"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/d575276a7a7a01c888b17b9930be8f9a650864da", "committedDate": "2020-06-11T15:47:45Z", "message": "JBPM-8253: Stunner - node lose selection decorations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MzUxOTQw", "url": "https://github.com/kiegroup/kie-wb-common/pull/3319#pullrequestreview-435351940", "createdAt": "2020-06-23T00:01:40Z", "commit": {"oid": "d575276a7a7a01c888b17b9930be8f9a650864da"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwMDowMTo0MFrOGnUx8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwMDoxNzoyOVrOGnVCnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4ODExMg==", "bodyText": "I'm not following you on these changes about calling ensureSelection and about the flag for the canvasHighlight.unhighLight call. Which is the goal behind those changes, about usability? about performance?", "url": "https://github.com/kiegroup/kie-wb-common/pull/3319#discussion_r443888112", "createdAt": "2020-06-23T00:01:40Z", "author": {"login": "romartin"}, "path": "kie-wb-common-stunner/kie-wb-common-stunner-client/kie-wb-common-stunner-lienzo/src/main/java/org/kie/workbench/common/stunner/client/lienzo/canvas/controls/ConnectionAcceptorControlImpl.java", "diffHunk": "@@ -257,18 +258,38 @@ private boolean isAccept(final CommandResult<CanvasViolation> result) {\n     private void highlight(final Node node,\n                            final Edge<ViewConnector<?>, Node> connector,\n                            final boolean valid) {\n-        canvasHighlight.unhighLight();\n+        // keep selected nodes\n+        ensureSelection(node);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d575276a7a7a01c888b17b9930be8f9a650864da"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg4OTQxMw==", "bodyText": "well it's true, but I think we should not consider a node being selected by its state for the shape (ShapeState.SELECTED).\nFor example, at some point it, if the node gets into an invalid state, the shape will have the state as ShapeState.INVALID, but it can be selected as well, so forms, toolbox and any other component that queries the actual selection via the canvas controls will consider it \"selected\".\nSo I think that we should consider a node selected by looking at the canvas SelectionControl, not looking at the visual attributes. We're already checking the state for the selection control in other \"controls\", so feel free to look at some example and let me know what you think.\nAnyway, look at my comment above, not really sure what's the goal for this, so maybe we've not to rely on selection at some point, let's keep brainstorming here", "url": "https://github.com/kiegroup/kie-wb-common/pull/3319#discussion_r443889413", "createdAt": "2020-06-23T00:06:00Z", "author": {"login": "romartin"}, "path": "kie-wb-common-stunner/kie-wb-common-stunner-client/kie-wb-common-stunner-lienzo/src/main/java/org/kie/workbench/common/stunner/client/lienzo/canvas/controls/ConnectionAcceptorControlImpl.java", "diffHunk": "@@ -257,18 +258,38 @@ private boolean isAccept(final CommandResult<CanvasViolation> result) {\n     private void highlight(final Node node,\n                            final Edge<ViewConnector<?>, Node> connector,\n                            final boolean valid) {\n-        canvasHighlight.unhighLight();\n+        // keep selected nodes\n+        ensureSelection(node);\n+        canvasHighlight.unhighLight(true);\n+\n         if (null != node && valid) {\n-            if (!node.getInEdges().contains(connector)) {\n+            if (!node.getInEdges().contains(connector) && !isNodeSelected(node)) {\n                 canvasHighlight.highLight(node);\n             }\n         } else if (null != node) {\n             canvasHighlight.invalid(node);\n         }\n     }\n \n+    private void ensureSelection(final Node node) {\n+        if (isNodeSelected(node)) {\n+            canvasHighlight.setSelectedUUID(node.getUUID());\n+        }\n+    }\n+\n+    private boolean isNodeSelected(final Node node) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d575276a7a7a01c888b17b9930be8f9a650864da"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg5MTUwOA==", "bodyText": "As also commented above, I need to figure out why you're adding this new selectedUUID field, added more state in the class, to achieve the overall goal.\nThe lifecycle for this CanvasHighlight stuff was supposed to be really simple - by calling the highLight method it's just changing the visual style for each node, and finally by calling unhighLight it will just get back to normal visualization. The implementation has some internal collection of uuids, but that's not exposed in the API and should not change the result of the public methods calls.\nOn the other hand by looking your the changes on the public methods, it's a bit more confusing to me the lifecycle.\nI'm not complaining about this, you've more feedback than me hehe, just let's try to clarify the goals to achieve and do collective thinking on the best way to do it :)", "url": "https://github.com/kiegroup/kie-wb-common/pull/3319#discussion_r443891508", "createdAt": "2020-06-23T00:14:13Z", "author": {"login": "romartin"}, "path": "kie-wb-common-stunner/kie-wb-common-stunner-core/kie-wb-common-stunner-commons/kie-wb-common-stunner-client-common/src/main/java/org/kie/workbench/common/stunner/core/client/canvas/util/CanvasHighlight.java", "diffHunk": "@@ -35,6 +35,7 @@\n \n     private final Set<String> uuids;\n     private AbstractCanvasHandler canvasHandler;\n+    private String selectedUUID = \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d575276a7a7a01c888b17b9930be8f9a650864da"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg5MTgxNg==", "bodyText": "a bit unclear... what does keepSelection flag means? which selection?", "url": "https://github.com/kiegroup/kie-wb-common/pull/3319#discussion_r443891816", "createdAt": "2020-06-23T00:15:29Z", "author": {"login": "romartin"}, "path": "kie-wb-common-stunner/kie-wb-common-stunner-core/kie-wb-common-stunner-commons/kie-wb-common-stunner-client-common/src/main/java/org/kie/workbench/common/stunner/core/client/canvas/util/CanvasHighlight.java", "diffHunk": "@@ -77,16 +84,29 @@ public CanvasHighlight none(final Element<?> node) {\n         return this;\n     }\n \n+    public void setSelectedUUID(String selectedUUID) {\n+        this.selectedUUID = selectedUUID;\n+    }\n+\n     public CanvasHighlight unhighLight() {\n+        return unhighLight(false);\n+    }\n+\n+    public CanvasHighlight unhighLight(boolean keepSelection) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d575276a7a7a01c888b17b9930be8f9a650864da"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzg5MjM4MQ==", "bodyText": "if we don't rely on the shape state in the connection acceptor maybe there will be no need to propagate all these delegate methods in all changes classes, although is stricly correct doing it as well, let's keep discussing it", "url": "https://github.com/kiegroup/kie-wb-common/pull/3319#discussion_r443892381", "createdAt": "2020-06-23T00:17:29Z", "author": {"login": "romartin"}, "path": "kie-wb-common-stunner/kie-wb-common-stunner-core/kie-wb-common-stunner-commons/kie-wb-common-stunner-client-common/src/main/java/org/kie/workbench/common/stunner/core/client/shape/impl/ConnectorShape.java", "diffHunk": "@@ -85,4 +85,9 @@ public void applyPosition(final Edge<ViewConnector<W>, Node> element,\n     public void applyState(final ShapeState shapeState) {\n         getShape().applyState(shapeState);\n     }\n+\n+    @Override\n+    public ShapeState getShapeState() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d575276a7a7a01c888b17b9930be8f9a650864da"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d575276a7a7a01c888b17b9930be8f9a650864da", "author": {"user": {"login": "handreyrc", "name": "Handreyrc"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/d575276a7a7a01c888b17b9930be8f9a650864da", "committedDate": "2020-06-11T15:47:45Z", "message": "JBPM-8253: Stunner - node lose selection decorations"}, "afterCommit": {"oid": "0c99957dc9bbf2a4adb49897e259660010a50285", "author": {"user": {"login": "handreyrc", "name": "Handreyrc"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/0c99957dc9bbf2a4adb49897e259660010a50285", "committedDate": "2020-06-24T19:38:32Z", "message": "JBPM-8253: Stunner - node lose selection decorations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0c99957dc9bbf2a4adb49897e259660010a50285", "author": {"user": {"login": "handreyrc", "name": "Handreyrc"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/0c99957dc9bbf2a4adb49897e259660010a50285", "committedDate": "2020-06-24T19:38:32Z", "message": "JBPM-8253: Stunner - node lose selection decorations"}, "afterCommit": {"oid": "4259ed6228e393287a5e968fe16f4eded8899998", "author": {"user": {"login": "handreyrc", "name": "Handreyrc"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/4259ed6228e393287a5e968fe16f4eded8899998", "committedDate": "2020-06-25T20:53:18Z", "message": "JBPM-8253: Stunner - node lose selection decorations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNTkwMTcx", "url": "https://github.com/kiegroup/kie-wb-common/pull/3319#pullrequestreview-441590171", "createdAt": "2020-07-02T11:29:56Z", "commit": {"oid": "4259ed6228e393287a5e968fe16f4eded8899998"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNzEzNzQ5", "url": "https://github.com/kiegroup/kie-wb-common/pull/3319#pullrequestreview-441713749", "createdAt": "2020-07-02T14:07:43Z", "commit": {"oid": "4259ed6228e393287a5e968fe16f4eded8899998"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNDowNzo0M1rOGsOhUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNDowNzo0M1rOGsOhUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAyODQzNA==", "bodyText": "(null != id && count > 1 && !id.equals(s)) || (null != id && count > 1 && id.equals(s))\ncan be simplified to\n(null != id && count > 1)", "url": "https://github.com/kiegroup/kie-wb-common/pull/3319#discussion_r449028434", "createdAt": "2020-07-02T14:07:43Z", "author": {"login": "hasys"}, "path": "kie-wb-common-stunner/kie-wb-common-stunner-core/kie-wb-common-stunner-commons/kie-wb-common-stunner-client-common/src/main/java/org/kie/workbench/common/stunner/core/client/canvas/controls/toolbox/AbstractToolboxControl.java", "diffHunk": "@@ -52,7 +52,10 @@\n \n         @Override\n         public boolean test(String s) {\n-            return (null == id && count == 0) || (null != id && count == 1 && id.equals(s)) || (null != id && count > 1 && !id.equals(s));\n+            return (null == id && count == 0) ||\n+                    (null != id && count == 1 && id.equals(s)) ||\n+                    (null != id && count > 1 && !id.equals(s)) ||", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4259ed6228e393287a5e968fe16f4eded8899998"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d456ffc751d64ec7990f452eaa49ebb58e7637e9", "author": {"user": {"login": "handreyrc", "name": "Handreyrc"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/d456ffc751d64ec7990f452eaa49ebb58e7637e9", "committedDate": "2020-07-06T21:03:19Z", "message": "JBPM-9019: Stunner - The toolbox menu is not displayed when selected immediately after multiselection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ff0ebf0f4ab601d49d3b2c033c72c17a8938b5e", "author": {"user": {"login": "handreyrc", "name": "Handreyrc"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/2ff0ebf0f4ab601d49d3b2c033c72c17a8938b5e", "committedDate": "2020-07-06T21:03:19Z", "message": "JBPM-8253: Stunner - node lose selection decorations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12092d3530a85683e249d5d0514038f1bc6d1692", "author": {"user": {"login": "handreyrc", "name": "Handreyrc"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/12092d3530a85683e249d5d0514038f1bc6d1692", "committedDate": "2020-07-06T21:31:31Z", "message": "JBPM-9019: Stunner - The toolbox menu is not displayed when selected immediately after multiselection"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4259ed6228e393287a5e968fe16f4eded8899998", "author": {"user": {"login": "handreyrc", "name": "Handreyrc"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/4259ed6228e393287a5e968fe16f4eded8899998", "committedDate": "2020-06-25T20:53:18Z", "message": "JBPM-8253: Stunner - node lose selection decorations"}, "afterCommit": {"oid": "12092d3530a85683e249d5d0514038f1bc6d1692", "author": {"user": {"login": "handreyrc", "name": "Handreyrc"}}, "url": "https://github.com/kiegroup/kie-wb-common/commit/12092d3530a85683e249d5d0514038f1bc6d1692", "committedDate": "2020-07-06T21:31:31Z", "message": "JBPM-9019: Stunner - The toolbox menu is not displayed when selected immediately after multiselection"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MTU5Nzc3", "url": "https://github.com/kiegroup/kie-wb-common/pull/3319#pullrequestreview-448159777", "createdAt": "2020-07-14T14:27:28Z", "commit": {"oid": "12092d3530a85683e249d5d0514038f1bc6d1692"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 405, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}