{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxMTA1ODA1", "number": 2779, "title": "Refactor StepsRunner to have step methods accept progressDispatcherFactory", "bodyText": "The current StepsRunner code makes it hard to write unit tests for each method.\nHaving each step method accept ProgressEventDispatcher.Factory is also consistent overall, as some methods (those working on individual images) already accept it like this one:\n\n  \n    \n      jib/jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java\n    \n    \n        Lines 430 to 434\n      in\n      664d661\n    \n    \n    \n    \n\n        \n          \n           private Future<Image> buildImage( \n        \n\n        \n          \n               Image baseImage, \n        \n\n        \n          \n               List<Future<PreparedLayer>> baseLayers, \n        \n\n        \n          \n               ProgressEventDispatcher.Factory progressDispatcherFactory) { \n        \n\n        \n          \n             return executorService.submit(", "createdAt": "2020-09-22T18:01:46Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2779", "merged": true, "mergeCommit": {"oid": "1abee1e88fee768e71d7d91df23aaeb0942ad503"}, "closed": true, "closedAt": "2020-09-23T14:12:17Z", "author": {"login": "chanseokoh"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLb2PWgH2gAyNDkxMTA1ODA1OmVkMzFlMGRjYzQxZDA2NTNhNTczNzFjZTc0MzgxNmM5NmE5OTc3Mjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLjN28gFqTQ5Mzk4Nzg4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ed31e0dcc41d0653a57371ce743816c96a997729", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/ed31e0dcc41d0653a57371ce743816c96a997729", "committedDate": "2020-09-22T17:57:05Z", "message": "Refactor to accept progressDispatcherFactory"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNzMxNDEy", "url": "https://github.com/GoogleContainerTools/jib/pull/2779#pullrequestreview-493731412", "createdAt": "2020-09-22T18:21:36Z", "commit": {"oid": "ed31e0dcc41d0653a57371ce743816c96a997729"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxODoyMTozNlrOHWG23g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxODoyMTozNlrOHWG23g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk0MzA3MA==", "bodyText": "Do we no longer need to initialize a root progress dispatcher?", "url": "https://github.com/GoogleContainerTools/jib/pull/2779#discussion_r492943070", "createdAt": "2020-09-22T18:21:36Z", "author": {"login": "mpeddada1"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -115,17 +116,16 @@ public static StepsRunner begin(BuildContext buildContext) {\n   private final BuildContext buildContext;\n   private final TempDirectoryProvider tempDirectoryProvider = new TempDirectoryProvider();\n \n-  // We save steps to run by wrapping each step into a Runnable, only because of the unfortunate\n-  // chicken-and-egg situation arising from using ProgressEventDispatcher. The current\n-  // ProgressEventDispatcher model requires knowing in advance how many units of work (i.e., steps)\n-  // we should perform. That is, to instantiate a root ProgressEventDispatcher instance, we should\n-  // know ahead how many steps we will run. However, to instantiate a step, we need a root progress\n-  // dispatcher. So, we wrap steps into Runnables and save them to run them later. Then we can count\n-  // the number of Runnables and, create a root dispatcher, and run the saved Runnables.\n-  private final List<Runnable> stepsToRun = new ArrayList<>();\n+  // Instead of directly running each step, we first save them as a lambda. This is only because of\n+  // the unfortunate chicken-and-egg situation when using ProgressEventDispatcher. The current\n+  // ProgressEventDispatcher model requires allocating the total units of work (i.e., steps)\n+  // up front. That is, to instantiate a root ProgressEventDispatcher, we should know ahead how many\n+  // steps we will run. However, to run a step, we need a root progress dispatcher. So, we take each\n+  // step as a lambda and save them to run later. Then we can count the number of lambdas, create a\n+  // root dispatcher with the count, and run the saved lambdas using the dispatcher.\n+  private final List<Consumer<ProgressEventDispatcher.Factory>> stepsToRun = new ArrayList<>();\n \n   @Nullable private String rootProgressDescription;\n-  @Nullable private ProgressEventDispatcher rootProgressDispatcher;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed31e0dcc41d0653a57371ce743816c96a997729"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNzMzMjQ4", "url": "https://github.com/GoogleContainerTools/jib/pull/2779#pullrequestreview-493733248", "createdAt": "2020-09-22T18:23:51Z", "commit": {"oid": "ed31e0dcc41d0653a57371ce743816c96a997729"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzOTg3ODg1", "url": "https://github.com/GoogleContainerTools/jib/pull/2779#pullrequestreview-493987885", "createdAt": "2020-09-23T02:32:13Z", "commit": {"oid": "ed31e0dcc41d0653a57371ce743816c96a997729"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4773, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}