{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyNDA2MDU0", "number": 2656, "title": "Adding functionality to push base image layers and push container config to the registry", "bodyText": "This PR pushes multiple container config JSONs: loops through the built images and schedules multiple pushes in pushContainerConfiguration(). Note care has been taken to not block scheduling threads while looping by using the Future<Image>  as the key in the resulting pushResults map.\n2.This PR also pushes multiple baseImageLayers: loops through the results.baseImagesAndLayers.get() and schedules multiple pushes in pushBaseImageLayers(). Note  the resulting results from the pushes are being stored in a list for now but in the next PR we will update the resulting pushResults list into a map so as to track the builtImage/baseImageLayers key-pair values.", "createdAt": "2020-08-03T21:28:09Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2656", "merged": true, "mergeCommit": {"oid": "9217975afaab77e9c10a21fcb335f2b17d3fc301"}, "closed": true, "closedAt": "2020-08-05T17:57:54Z", "author": {"login": "louismurerwa"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7Yy7pAH2gAyNDYyNDA2MDU0OmIwNWIxODc4OTZkODgzYmI4OTQyYmE4ZjJkN2NhYmFiM2EyMWFkOTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7-5AwAH2gAyNDYyNDA2MDU0OmRiMDRhOTg1NzQ5MWEzZDc0ZDc0MjNhMTMyNjg4MjMxNzdkMzZlYzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b05b187896d883bb8942ba8f2d7cabab3a21ad96", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/b05b187896d883bb8942ba8f2d7cabab3a21ad96", "committedDate": "2020-08-03T21:20:58Z", "message": "Adding functionality to push base image layers and push container configurations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c0303dcda4ce8feacc07503878dbfa05c5bae1a", "author": {"user": {"login": "mpeddada1", "name": "Mridula"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/8c0303dcda4ce8feacc07503878dbfa05c5bae1a", "committedDate": "2020-08-04T19:04:22Z", "message": "Update build-plan CHANGELOG.md (#2654)\n\n* Update build-plan changelog\r\n\r\n* placing unreleased entries under version\r\n\r\n* moving recent change to unreleased\r\n\r\n* formatting change\r\n\r\n* formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7424d86338d009850cf5e8691a9cdb180c7fe42a", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/7424d86338d009850cf5e8691a9cdb180c7fe42a", "committedDate": "2020-08-04T19:04:22Z", "message": "empty commit to trigger builds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69eb5b584f3bbf5d45bdda07f657306fdb650f52", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/69eb5b584f3bbf5d45bdda07f657306fdb650f52", "committedDate": "2020-08-04T19:05:26Z", "message": "Merge remote-tracking branch 'origin' into pushbaseimages"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMzgwMjE1", "url": "https://github.com/GoogleContainerTools/jib/pull/2656#pullrequestreview-460380215", "createdAt": "2020-08-03T22:28:06Z", "commit": {"oid": "b05b187896d883bb8942ba8f2d7cabab3a21ad96"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMjoyODowNlrOG7KuSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMjoyODowNlrOG7KuSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY5NDg1Nw==", "bodyText": "Should this also be a map, so that we can work on the per-image basis (for example, start pushing one image while pushing base image layers are pending for other images)?", "url": "https://github.com/GoogleContainerTools/jib/pull/2656#discussion_r464694857", "createdAt": "2020-08-03T22:28:06Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -332,17 +333,21 @@ private void pushBaseImageLayers() {\n \n     results.baseImageLayerPushResults =\n         executorService.submit(\n-            () ->\n-                scheduleCallables(\n-                    PushLayerStep.makeList(\n-                        buildContext,\n-                        childProgressDispatcherFactory,\n-                        results.targetRegistryClient.get(),\n-                        Verify.verifyNotNull(\n-                            results\n-                                .baseImagesAndLayers\n-                                .get()\n-                                .get(results.baseImagesAndRegistryClient.get().images.get(0))))));\n+            () -> {\n+              List<List<Future<BlobDescriptor>>> baseImageLayerPushResults = new ArrayList<>();\n+              for (List<Future<PreparedLayer>> baseImageLayers :\n+                  results.baseImagesAndLayers.get().values()) {\n+                List<Future<BlobDescriptor>> baseImageLayerPushResult =\n+                    scheduleCallables(\n+                        PushLayerStep.makeList(\n+                            buildContext,\n+                            childProgressDispatcherFactory,\n+                            results.targetRegistryClient.get(),\n+                            Verify.verifyNotNull(baseImageLayers)));\n+                baseImageLayerPushResults.add(baseImageLayerPushResult);\n+              }\n+              return baseImageLayerPushResults;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b05b187896d883bb8942ba8f2d7cabab3a21ad96"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTAyODQ5", "url": "https://github.com/GoogleContainerTools/jib/pull/2656#pullrequestreview-461102849", "createdAt": "2020-08-04T19:21:50Z", "commit": {"oid": "69eb5b584f3bbf5d45bdda07f657306fdb650f52"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOToyMTo1MVrOG7uI2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOToyMTo1MVrOG7uI2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI3NTA5Ng==", "bodyText": "Let's rename this to builtImagesAndContainerConfigurationPushResults.\nUsing a Map is convenient, but compared to using a dedicated class, it's difficult to know what the keys and the values mean and what is the relation between them without documentation or descriptive naming. For a short time, I had to go over the code to see if Image in the map is a base image or a built image. We may keep the current name, but in that case, we should add a clear Javadoc to the field.", "url": "https://github.com/GoogleContainerTools/jib/pull/2656#discussion_r465275096", "createdAt": "2020-08-04T19:21:51Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -384,15 +389,26 @@ private void pushContainerConfiguration() {\n     ProgressEventDispatcher.Factory childProgressDispatcherFactory =\n         Verify.verifyNotNull(rootProgressDispatcher).newChildProducer();\n \n-    results.containerConfigurationPushResult =\n+    results.containerConfigurationPushResults =\n         executorService.submit(\n-            () ->\n-                new PushContainerConfigurationStep(\n-                        buildContext,\n-                        childProgressDispatcherFactory,\n-                        results.targetRegistryClient.get(),\n-                        results.builtImages.get().get(0).get())\n-                    .call());\n+            () -> {\n+              Map<Image, Future<BlobDescriptor>> containerConfigurationPushResults =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69eb5b584f3bbf5d45bdda07f657306fdb650f52"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50640e4cb7c532c9211d603ea1550d253a1292d1", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/50640e4cb7c532c9211d603ea1550d253a1292d1", "committedDate": "2020-08-04T20:03:29Z", "message": "Changing variable names"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTc0Mzcy", "url": "https://github.com/GoogleContainerTools/jib/pull/2656#pullrequestreview-461174372", "createdAt": "2020-08-04T21:05:30Z", "commit": {"oid": "50640e4cb7c532c9211d603ea1550d253a1292d1"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMTowNTozMFrOG7xfIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMTowOTozNFrOG7xm0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMyOTk1Mw==", "bodyText": "In a local scope, I think we don't always have to be fully verbose. IMO, reasonable names help reducing cognitive load when reading code, especially in a local scope. So, I prefer\n              List<List<Future<BlobDescriptor>>>  pushResults = new ArrayList<>();\n              for (List<Future<PreparedLayer>> layers : results.baseImagesAndLayers.get().values()) {\n                List<Future<BlobDescriptor>> pushResult =", "url": "https://github.com/GoogleContainerTools/jib/pull/2656#discussion_r465329953", "createdAt": "2020-08-04T21:05:30Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -332,17 +333,21 @@ private void pushBaseImageLayers() {\n \n     results.baseImageLayerPushResults =\n         executorService.submit(\n-            () ->\n-                scheduleCallables(\n-                    PushLayerStep.makeList(\n-                        buildContext,\n-                        childProgressDispatcherFactory,\n-                        results.targetRegistryClient.get(),\n-                        Verify.verifyNotNull(\n-                            results\n-                                .baseImagesAndLayers\n-                                .get()\n-                                .get(results.baseImagesAndRegistryClient.get().images.get(0))))));\n+            () -> {\n+              List<List<Future<BlobDescriptor>>> baseImageLayerPushResults = new ArrayList<>();\n+              for (List<Future<PreparedLayer>> baseImageLayers :\n+                  results.baseImagesAndLayers.get().values()) {\n+                List<Future<BlobDescriptor>> baseImageLayerPushResult =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50640e4cb7c532c9211d603ea1550d253a1292d1"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMzMTkyMw==", "bodyText": "As mentioned in the other comment, how about\nMap<Image, Future<BlobDescriptor>> pushResults =\n\n? (I think buildImage in for (Future<Image> builtImage : ...` is good though.)", "url": "https://github.com/GoogleContainerTools/jib/pull/2656#discussion_r465331923", "createdAt": "2020-08-04T21:09:34Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -384,15 +389,26 @@ private void pushContainerConfiguration() {\n     ProgressEventDispatcher.Factory childProgressDispatcherFactory =\n         Verify.verifyNotNull(rootProgressDispatcher).newChildProducer();\n \n-    results.containerConfigurationPushResult =\n+    results.containerConfigurationPushResults =\n         executorService.submit(\n-            () ->\n-                new PushContainerConfigurationStep(\n-                        buildContext,\n-                        childProgressDispatcherFactory,\n-                        results.targetRegistryClient.get(),\n-                        results.builtImages.get().get(0).get())\n-                    .call());\n+            () -> {\n+              Map<Image, Future<BlobDescriptor>> containerConfigurationPushResults =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI3NTA5Ng=="}, "originalCommit": {"oid": "69eb5b584f3bbf5d45bdda07f657306fdb650f52"}, "originalPosition": 61}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMTg2NzEz", "url": "https://github.com/GoogleContainerTools/jib/pull/2656#pullrequestreview-461186713", "createdAt": "2020-08-04T21:26:42Z", "commit": {"oid": "50640e4cb7c532c9211d603ea1550d253a1292d1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMToyNjo0MlrOG7yGFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQyMToyNjo0MlrOG7yGFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTMzOTkyNw==", "bodyText": "So I realized a problem with this. builtImage in the loop is a Future, so calling builtImage.get() means blocking until the image is built. Rather, we don't want the loop to block. We may need to put a Future<Image> instead of Image as a key?", "url": "https://github.com/GoogleContainerTools/jib/pull/2656#discussion_r465339927", "createdAt": "2020-08-04T21:26:42Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -384,15 +389,26 @@ private void pushContainerConfiguration() {\n     ProgressEventDispatcher.Factory childProgressDispatcherFactory =\n         Verify.verifyNotNull(rootProgressDispatcher).newChildProducer();\n \n-    results.containerConfigurationPushResult =\n+    results.builtImagesAndContainerConfigurationPushResults =\n         executorService.submit(\n-            () ->\n-                new PushContainerConfigurationStep(\n-                        buildContext,\n-                        childProgressDispatcherFactory,\n-                        results.targetRegistryClient.get(),\n-                        results.builtImages.get().get(0).get())\n-                    .call());\n+            () -> {\n+              Map<Image, Future<BlobDescriptor>> containerConfigurationPushResults =\n+                  new HashMap<>();\n+              for (Future<Image> builtImage : results.builtImages.get()) {\n+                Future<BlobDescriptor> containerConfigurationPushResult =\n+                    executorService.submit(\n+                        () ->\n+                            new PushContainerConfigurationStep(\n+                                    buildContext,\n+                                    childProgressDispatcherFactory,\n+                                    results.targetRegistryClient.get(),\n+                                    builtImage.get())\n+                                .call());\n+                containerConfigurationPushResults.put(\n+                    builtImage.get(), containerConfigurationPushResult);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50640e4cb7c532c9211d603ea1550d253a1292d1"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b043f8e52ca36a5312dc7a06ceb92ee85ebf116b", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/b043f8e52ca36a5312dc7a06ceb92ee85ebf116b", "committedDate": "2020-08-05T15:32:49Z", "message": "Style Fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxODgxNjI0", "url": "https://github.com/GoogleContainerTools/jib/pull/2656#pullrequestreview-461881624", "createdAt": "2020-08-05T17:35:36Z", "commit": {"oid": "b043f8e52ca36a5312dc7a06ceb92ee85ebf116b"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNzozNTozNlrOG8Tzsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNzozNjowNVrOG8T0vQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg5MjI3NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          for (Future<Image> buildImage : results.builtImages.get()) {\n          \n          \n            \n                          for (Future<Image> builtImage : results.builtImages.get()) {", "url": "https://github.com/GoogleContainerTools/jib/pull/2656#discussion_r465892274", "createdAt": "2020-08-05T17:35:36Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -384,15 +389,24 @@ private void pushContainerConfiguration() {\n     ProgressEventDispatcher.Factory childProgressDispatcherFactory =\n         Verify.verifyNotNull(rootProgressDispatcher).newChildProducer();\n \n-    results.containerConfigurationPushResult =\n+    results.builtImagesAndContainerConfigurationPushResults =\n         executorService.submit(\n-            () ->\n-                new PushContainerConfigurationStep(\n-                        buildContext,\n-                        childProgressDispatcherFactory,\n-                        results.targetRegistryClient.get(),\n-                        results.builtImages.get().get(0).get())\n-                    .call());\n+            () -> {\n+              Map<Future<Image>, Future<BlobDescriptor>> pushResults = new HashMap<>();\n+              for (Future<Image> buildImage : results.builtImages.get()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b043f8e52ca36a5312dc7a06ceb92ee85ebf116b"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg5MjU0MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            Future<BlobDescriptor> containerConfigurationPushResult =\n          \n          \n            \n                            Future<BlobDescriptor> configPushResult =", "url": "https://github.com/GoogleContainerTools/jib/pull/2656#discussion_r465892541", "createdAt": "2020-08-05T17:36:05Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -384,15 +389,24 @@ private void pushContainerConfiguration() {\n     ProgressEventDispatcher.Factory childProgressDispatcherFactory =\n         Verify.verifyNotNull(rootProgressDispatcher).newChildProducer();\n \n-    results.containerConfigurationPushResult =\n+    results.builtImagesAndContainerConfigurationPushResults =\n         executorService.submit(\n-            () ->\n-                new PushContainerConfigurationStep(\n-                        buildContext,\n-                        childProgressDispatcherFactory,\n-                        results.targetRegistryClient.get(),\n-                        results.builtImages.get().get(0).get())\n-                    .call());\n+            () -> {\n+              Map<Future<Image>, Future<BlobDescriptor>> pushResults = new HashMap<>();\n+              for (Future<Image> buildImage : results.builtImages.get()) {\n+                Future<BlobDescriptor> containerConfigurationPushResult =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b043f8e52ca36a5312dc7a06ceb92ee85ebf116b"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db04a9857491a3d74d7423a13268823177d36ec1", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/db04a9857491a3d74d7423a13268823177d36ec1", "committedDate": "2020-08-05T17:44:00Z", "message": "Fixing Styles"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4928, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}