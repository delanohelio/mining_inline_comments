{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwODQ4OTU1", "number": 2893, "title": "Modify standard jar exploded mode to not maintain original directory structure when adding dependencies to container.", "bodyText": "Add dependency directly to container, without maintaining original directory structure. For example, if the dependency path is originally nested/dependency.jar, the path on the container will be app/dependendencies/dependency.jar. This is for the dependencies to be recognized when the -cp is specified with a wildcard, in the form: java -cp /app/explodedJar:/app/dependencies/* <MainClass>.", "createdAt": "2020-11-13T20:58:35Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2893", "merged": true, "mergeCommit": {"oid": "95c5b6c240018e5e59e4248a3cecfc1903f15d7c"}, "closed": true, "closedAt": "2020-11-17T22:57:37Z", "author": {"login": "mpeddada1"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcNIHsgH2gAyNTIwODQ4OTU1OjMzM2Y4ZTUzODVmOGRlOGUxODI4NjJlYTIxMDgyYzc3YTRiNmY4MGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddge7bgH2gAyNTIwODQ4OTU1OjgzYThmNjhmZjJjNzNkM2Y4NGU1ZTQ0MTA5YzI1ODhkMDU3OTI1OWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "333f8e5385f8de8e182862ea21082c77a4b6f80e", "author": {"user": {"login": "mpeddada1", "name": "Mridula"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/333f8e5385f8de8e182862ea21082c77a4b6f80e", "committedDate": "2020-11-13T20:24:45Z", "message": "don't maintain original dependency structure when adding to container"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25fc7f729a61dc696f7b45c085988b27c12c0e21", "author": {"user": {"login": "mpeddada1", "name": "Mridula"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/25fc7f729a61dc696f7b45c085988b27c12c0e21", "committedDate": "2020-11-13T20:40:28Z", "message": "use small jar for test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "797ab5e1cef4022b62b23c049c89532edb3318df", "author": {"user": {"login": "mpeddada1", "name": "Mridula"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/797ab5e1cef4022b62b23c049c89532edb3318df", "committedDate": "2020-11-13T20:56:34Z", "message": "validate classpath"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDE5MDcw", "url": "https://github.com/GoogleContainerTools/jib/pull/2893#pullrequestreview-530419070", "createdAt": "2020-11-13T21:13:15Z", "commit": {"oid": "797ab5e1cef4022b62b23c049c89532edb3318df"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToxMzoxNVrOHy_vUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToyMzo1OVrOHzABtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzNTE1NQ==", "bodyText": "It's okay to put everything into the try block, especially in tests.", "url": "https://github.com/GoogleContainerTools/jib/pull/2893#discussion_r523235155", "createdAt": "2020-11-13T21:13:15Z", "author": {"login": "chanseokoh"}, "path": "jib-cli/src/integration-test/java/com/google/cloud/tools/jib/cli/cli2/JarCommandTest.java", "diffHunk": "@@ -64,11 +68,20 @@ public void testErrorLogging_directoryGiven() throws URISyntaxException {\n \n   @Test\n   public void testJar_toDocker() throws IOException, InterruptedException, URISyntaxException {\n-    Path jarFile = Paths.get(Resources.getResource(\"simpleJar.jar\").toURI());\n+    Path jarPath = Paths.get(Resources.getResource(\"jarTest/jarWithCp.jar\").toURI());\n     Integer exitCode =\n         new CommandLine(new JibCli())\n-            .execute(\"--target\", \"docker://jib-cli-image\", \"jar\", jarFile.toString());\n+            .execute(\"--target\", \"docker://jib-cli-image\", \"jar\", jarPath.toString());\n     String output = new Command(\"docker\", \"run\", \"--rm\", \"jib-cli-image\").run();\n+    String classPath = null;\n+    try (JarFile jarFile = new JarFile(jarPath.toFile())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "797ab5e1cef4022b62b23c049c89532edb3318df"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzNTUxOQ==", "bodyText": "No need for splitting. I think it can be assertThat(classPath).isEqualTo(\"dependency1.jar;directory/dependency2.jar\"), even without checking not null.\nAnd just double-check that the main in simplJar does use classes in both dependency1.jar and dependency2.jar.", "url": "https://github.com/GoogleContainerTools/jib/pull/2893#discussion_r523235519", "createdAt": "2020-11-13T21:14:12Z", "author": {"login": "chanseokoh"}, "path": "jib-cli/src/integration-test/java/com/google/cloud/tools/jib/cli/cli2/JarCommandTest.java", "diffHunk": "@@ -64,11 +68,20 @@ public void testErrorLogging_directoryGiven() throws URISyntaxException {\n \n   @Test\n   public void testJar_toDocker() throws IOException, InterruptedException, URISyntaxException {\n-    Path jarFile = Paths.get(Resources.getResource(\"simpleJar.jar\").toURI());\n+    Path jarPath = Paths.get(Resources.getResource(\"jarTest/jarWithCp.jar\").toURI());\n     Integer exitCode =\n         new CommandLine(new JibCli())\n-            .execute(\"--target\", \"docker://jib-cli-image\", \"jar\", jarFile.toString());\n+            .execute(\"--target\", \"docker://jib-cli-image\", \"jar\", jarPath.toString());\n     String output = new Command(\"docker\", \"run\", \"--rm\", \"jib-cli-image\").run();\n+    String classPath = null;\n+    try (JarFile jarFile = new JarFile(jarPath.toFile())) {\n+      classPath = jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.CLASS_PATH);\n+    }\n+\n+    // Validate classpath before checking output\n+    assertThat(classPath).isNotNull();\n+    List<String> dependencies = Splitter.onPattern(\"\\\\s+\").splitToList(classPath.trim());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "797ab5e1cef4022b62b23c049c89532edb3318df"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzNTg3Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                standardJar.getParent().resolve(Paths.get(\"dependency1\")),\n          \n          \n            \n                                standardJar.getParent().resolve(\"dependency1\"),", "url": "https://github.com/GoogleContainerTools/jib/pull/2893#discussion_r523235877", "createdAt": "2020-11-13T21:15:01Z", "author": {"login": "chanseokoh"}, "path": "jib-cli/src/test/java/com/google/cloud/tools/jib/cli/jar/JarFilesTest.java", "diffHunk": "@@ -67,7 +67,8 @@ public void testToJibContainerBuilder_basicInfo()\n         .isEqualTo(\n             FileEntriesLayer.builder()\n                 .addEntry(\n-                    Paths.get(\"dependency1\"), AbsoluteUnixPath.get(\"/app/dependencies/dependency1\"))\n+                    standardJar.getParent().resolve(Paths.get(\"dependency1\")),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "797ab5e1cef4022b62b23c049c89532edb3318df"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzNjEyMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    .resolve(RelativeUnixPath.get(\"dependencies\"))\n          \n          \n            \n                                    .resolve(\"dependencies\")\n          \n      \n    \n    \n  \n\nand the one above tool.", "url": "https://github.com/GoogleContainerTools/jib/pull/2893#discussion_r523236123", "createdAt": "2020-11-13T21:15:36Z", "author": {"login": "chanseokoh"}, "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessor.java", "diffHunk": "@@ -123,7 +127,10 @@ static JarType determineJarType(Path jarPath) throws IOException {\n         snapshotDependencies.forEach(\n             path ->\n                 snapshotDependenciesLayerBuilder.addEntry(\n-                    path, APP_ROOT.resolve(RelativeUnixPath.get(\"dependencies\")).resolve(path)));\n+                    jarParent.resolve(path),\n+                    APP_ROOT\n+                        .resolve(RelativeUnixPath.get(\"dependencies\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "797ab5e1cef4022b62b23c049c89532edb3318df"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzOTg2Mg==", "bodyText": "I just realized one thing we are missing. Remember this output? A lot of people will try Jib CLI on a standard JAR without having dependency JARs at all or in right relative locations, and they will just see java.nio.file.NoSuchFileException: some.jar. And they may falsely think Jib CLI is bugged by failing to load its dependency. I think it's very important to check the existence of dependency JARs locally before we delegate to jib-core, and throw an exception (IllegalStateException?) with a detailed message that some dependency JARs of the user app don't exist locally. Doesn't have to be in this PR, but we should not forget this.", "url": "https://github.com/GoogleContainerTools/jib/pull/2893#discussion_r523239862", "createdAt": "2020-11-13T21:23:59Z", "author": {"login": "chanseokoh"}, "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessor.java", "diffHunk": "@@ -108,13 +108,17 @@ static JarType determineJarType(Path jarPath) throws IOException {\n               .collect(Collectors.toList());\n       List<Path> snapshotDependencies =\n           allDependencies.stream().filter(isSnapshot).map(Paths::get).collect(Collectors.toList());\n+      Path jarParent = jarPath.getParent() == null ? Paths.get(\"\") : jarPath.getParent();\n       if (!nonSnapshotDependencies.isEmpty()) {\n         FileEntriesLayer.Builder nonSnapshotDependenciesLayerBuilder =\n             FileEntriesLayer.builder().setName(DEPENDENCIES);\n         nonSnapshotDependencies.forEach(\n             path ->\n                 nonSnapshotDependenciesLayerBuilder.addEntry(\n-                    path, APP_ROOT.resolve(RelativeUnixPath.get(\"dependencies\")).resolve(path)));\n+                    jarParent.resolve(path),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "797ab5e1cef4022b62b23c049c89532edb3318df"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c39801c2b082fadcd911631c9acb53f9571b2a8d", "author": {"user": {"login": "mpeddada1", "name": "Mridula"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/c39801c2b082fadcd911631c9acb53f9571b2a8d", "committedDate": "2020-11-16T02:41:45Z", "message": "Throw exception if dependency is not under same parent directory as JAR and cleanup up method to create layers for exploded jar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b2be76279e04ce2902c054135b69ee4943ebc7a", "author": {"user": {"login": "mpeddada1", "name": "Mridula"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/3b2be76279e04ce2902c054135b69ee4943ebc7a", "committedDate": "2020-11-16T02:58:13Z", "message": "small format change in JarFiles test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3b23a630c148780fa011cae74109a3bd40cd619", "author": {"user": {"login": "mpeddada1", "name": "Mridula"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/d3b23a630c148780fa011cae74109a3bd40cd619", "committedDate": "2020-11-16T03:01:32Z", "message": "Formatting tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNDQ3MTk1", "url": "https://github.com/GoogleContainerTools/jib/pull/2893#pullrequestreview-531447195", "createdAt": "2020-11-16T15:45:51Z", "commit": {"oid": "d3b23a630c148780fa011cae74109a3bd40cd619"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNTo0NTo1MlrOH0EyOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxNjowMzozOVrOH0FqSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM2NjM5NA==", "bodyText": "nit: String classpath = jarFile....\nAlso in the following test.", "url": "https://github.com/GoogleContainerTools/jib/pull/2893#discussion_r524366394", "createdAt": "2020-11-16T15:45:52Z", "author": {"login": "chanseokoh"}, "path": "jib-cli/src/integration-test/java/com/google/cloud/tools/jib/cli/cli2/JarCommandTest.java", "diffHunk": "@@ -64,11 +68,20 @@ public void testErrorLogging_directoryGiven() throws URISyntaxException {\n \n   @Test\n   public void testJar_toDocker() throws IOException, InterruptedException, URISyntaxException {\n-    Path jarFile = Paths.get(Resources.getResource(\"simpleJar.jar\").toURI());\n+    Path jarPath = Paths.get(Resources.getResource(\"jarTest/jarWithCp.jar\").toURI());\n     Integer exitCode =\n         new CommandLine(new JibCli())\n-            .execute(\"--target\", \"docker://jib-cli-image\", \"jar\", jarFile.toString());\n+            .execute(\"--target\", \"docker://jib-cli-image\", \"jar\", jarPath.toString());\n     String output = new Command(\"docker\", \"run\", \"--rm\", \"jib-cli-image\").run();\n+    String classPath = null;\n+    try (JarFile jarFile = new JarFile(jarPath.toFile())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzNTE1NQ=="}, "originalCommit": {"oid": "797ab5e1cef4022b62b23c049c89532edb3318df"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM2NzM2MQ==", "bodyText": "Q: why contains? Are there other dependencies?", "url": "https://github.com/GoogleContainerTools/jib/pull/2893#discussion_r524367361", "createdAt": "2020-11-16T15:46:56Z", "author": {"login": "chanseokoh"}, "path": "jib-cli/src/integration-test/java/com/google/cloud/tools/jib/cli/cli2/JarCommandTest.java", "diffHunk": "@@ -64,13 +66,36 @@ public void testErrorLogging_directoryGiven() throws URISyntaxException {\n \n   @Test\n   public void testJar_toDocker() throws IOException, InterruptedException, URISyntaxException {\n-    Path jarFile = Paths.get(Resources.getResource(\"simpleJar.jar\").toURI());\n+    Path jarPath = Paths.get(Resources.getResource(\"jarTest/jarWithCp.jar\").toURI());\n     Integer exitCode =\n         new CommandLine(new JibCli())\n-            .execute(\"--target\", \"docker://jib-cli-image\", \"jar\", jarFile.toString());\n+            .execute(\"--target\", \"docker://jib-cli-image\", \"jar\", jarPath.toString());\n     String output = new Command(\"docker\", \"run\", \"--rm\", \"jib-cli-image\").run();\n+    String classPath = null;\n+    try (JarFile jarFile = new JarFile(jarPath.toFile())) {\n+      classPath = jarFile.getManifest().getMainAttributes().getValue(Attributes.Name.CLASS_PATH);\n \n-    assertThat(exitCode).isEqualTo(0);\n-    assertThat(output).isEqualTo(\"Hello World\");\n+      assertThat(classPath).contains(\"dependency1.jar directory/dependency2.jar\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3b23a630c148780fa011cae74109a3bd40cd619"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM3MDI2MQ==", "bodyText": "if (!Files.exist(jarParent.resolve(depPath)))", "url": "https://github.com/GoogleContainerTools/jib/pull/2893#discussion_r524370261", "createdAt": "2020-11-16T15:50:38Z", "author": {"login": "chanseokoh"}, "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessor.java", "diffHunk": "@@ -173,6 +174,21 @@ static JarType determineJarType(Path jarPath) throws IOException {\n     }\n   }\n \n+  private static void addDependency(\n+      FileEntriesLayer.Builder layerbuilder,\n+      Path depPath,\n+      Path jarParent,\n+      AbsoluteUnixPath pathOnContainer) {\n+    File depFile = new File(jarParent.resolve(depPath).toString());\n+    if (!depFile.exists()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3b23a630c148780fa011cae74109a3bd40cd619"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM3MzYyNg==", "bodyText": "Maybe pass in pathOnContainer is because it's computable here with APP_ROOT.resolve(\"dependencies\").resolve(depPath.getFileName())?", "url": "https://github.com/GoogleContainerTools/jib/pull/2893#discussion_r524373626", "createdAt": "2020-11-16T15:54:29Z", "author": {"login": "chanseokoh"}, "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessor.java", "diffHunk": "@@ -173,6 +174,21 @@ static JarType determineJarType(Path jarPath) throws IOException {\n     }\n   }\n \n+  private static void addDependency(\n+      FileEntriesLayer.Builder layerbuilder,\n+      Path depPath,\n+      Path jarParent,\n+      AbsoluteUnixPath pathOnContainer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3b23a630c148780fa011cae74109a3bd40cd619"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM4MDc0Ng==", "bodyText": "I think this will cause confusion when a dependency is nested. It reads like such a dependency should be in the same parent directory. How about something like\n\"Dependency required by the JAR (as specified in 'Class-Path:' in the JAR manifest) doesn't exist: <full path of jarParent.resolve(depPath)>\"\n? And then we can also pass the full path instead of two argument (depPath and jarParent) to the method. WDYT?", "url": "https://github.com/GoogleContainerTools/jib/pull/2893#discussion_r524380746", "createdAt": "2020-11-16T16:03:39Z", "author": {"login": "chanseokoh"}, "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/jar/JarModeProcessor.java", "diffHunk": "@@ -173,6 +174,21 @@ static JarType determineJarType(Path jarPath) throws IOException {\n     }\n   }\n \n+  private static void addDependency(\n+      FileEntriesLayer.Builder layerbuilder,\n+      Path depPath,\n+      Path jarParent,\n+      AbsoluteUnixPath pathOnContainer) {\n+    File depFile = new File(jarParent.resolve(depPath).toString());\n+    if (!depFile.exists()) {\n+      throw new IllegalArgumentException(\n+          String.format(\n+              \"Dependency: %s needs to be in the same parent directory as the JAR.\",\n+              depPath.toString()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3b23a630c148780fa011cae74109a3bd40cd619"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac1f17c1cb424ff0a3d5caca898b9bd61046bd38", "author": {"user": {"login": "mpeddada1", "name": "Mridula"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/ac1f17c1cb424ff0a3d5caca898b9bd61046bd38", "committedDate": "2020-11-16T16:37:39Z", "message": "improve error messaging and format tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNjgwMTc5", "url": "https://github.com/GoogleContainerTools/jib/pull/2893#pullrequestreview-532680179", "createdAt": "2020-11-17T18:42:35Z", "commit": {"oid": "ac1f17c1cb424ff0a3d5caca898b9bd61046bd38"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83a8f68ff2c73d3f84e5e44109c2588d0579259d", "author": {"user": {"login": "mpeddada1", "name": "Mridula"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/83a8f68ff2c73d3f84e5e44109c2588d0579259d", "committedDate": "2020-11-17T21:31:47Z", "message": "rename test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4876, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}