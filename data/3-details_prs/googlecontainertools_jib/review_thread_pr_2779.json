{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxMTA1ODA1", "number": 2779, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxODoyMTozNlrOEmNcnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxODoyMTozNlrOEmNcnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NTAxNjYwOnYy", "diffSide": "LEFT", "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxODoyMTozNlrOHWG23g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNDowNDowNFrOHWwJ3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk0MzA3MA==", "bodyText": "Do we no longer need to initialize a root progress dispatcher?", "url": "https://github.com/GoogleContainerTools/jib/pull/2779#discussion_r492943070", "createdAt": "2020-09-22T18:21:36Z", "author": {"login": "mpeddada1"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -115,17 +116,16 @@ public static StepsRunner begin(BuildContext buildContext) {\n   private final BuildContext buildContext;\n   private final TempDirectoryProvider tempDirectoryProvider = new TempDirectoryProvider();\n \n-  // We save steps to run by wrapping each step into a Runnable, only because of the unfortunate\n-  // chicken-and-egg situation arising from using ProgressEventDispatcher. The current\n-  // ProgressEventDispatcher model requires knowing in advance how many units of work (i.e., steps)\n-  // we should perform. That is, to instantiate a root ProgressEventDispatcher instance, we should\n-  // know ahead how many steps we will run. However, to instantiate a step, we need a root progress\n-  // dispatcher. So, we wrap steps into Runnables and save them to run them later. Then we can count\n-  // the number of Runnables and, create a root dispatcher, and run the saved Runnables.\n-  private final List<Runnable> stepsToRun = new ArrayList<>();\n+  // Instead of directly running each step, we first save them as a lambda. This is only because of\n+  // the unfortunate chicken-and-egg situation when using ProgressEventDispatcher. The current\n+  // ProgressEventDispatcher model requires allocating the total units of work (i.e., steps)\n+  // up front. That is, to instantiate a root ProgressEventDispatcher, we should know ahead how many\n+  // steps we will run. However, to run a step, we need a root progress dispatcher. So, we take each\n+  // step as a lambda and save them to run later. Then we can count the number of lambdas, create a\n+  // root dispatcher with the count, and run the saved lambdas using the dispatcher.\n+  private final List<Consumer<ProgressEventDispatcher.Factory>> stepsToRun = new ArrayList<>();\n \n   @Nullable private String rootProgressDescription;\n-  @Nullable private ProgressEventDispatcher rootProgressDispatcher;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed31e0dcc41d0653a57371ce743816c96a997729"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk1MDg1Nw==", "bodyText": "Right, this is no longer needed, as the StepsRunner.run() injects a factory into each method (such as PullBaseImages()), rather than the method retrieving a factory from a class field rootProgressDispatcher on its own.", "url": "https://github.com/GoogleContainerTools/jib/pull/2779#discussion_r492950857", "createdAt": "2020-09-22T18:34:12Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -115,17 +116,16 @@ public static StepsRunner begin(BuildContext buildContext) {\n   private final BuildContext buildContext;\n   private final TempDirectoryProvider tempDirectoryProvider = new TempDirectoryProvider();\n \n-  // We save steps to run by wrapping each step into a Runnable, only because of the unfortunate\n-  // chicken-and-egg situation arising from using ProgressEventDispatcher. The current\n-  // ProgressEventDispatcher model requires knowing in advance how many units of work (i.e., steps)\n-  // we should perform. That is, to instantiate a root ProgressEventDispatcher instance, we should\n-  // know ahead how many steps we will run. However, to instantiate a step, we need a root progress\n-  // dispatcher. So, we wrap steps into Runnables and save them to run them later. Then we can count\n-  // the number of Runnables and, create a root dispatcher, and run the saved Runnables.\n-  private final List<Runnable> stepsToRun = new ArrayList<>();\n+  // Instead of directly running each step, we first save them as a lambda. This is only because of\n+  // the unfortunate chicken-and-egg situation when using ProgressEventDispatcher. The current\n+  // ProgressEventDispatcher model requires allocating the total units of work (i.e., steps)\n+  // up front. That is, to instantiate a root ProgressEventDispatcher, we should know ahead how many\n+  // steps we will run. However, to run a step, we need a root progress dispatcher. So, we take each\n+  // step as a lambda and save them to run later. Then we can count the number of lambdas, create a\n+  // root dispatcher with the count, and run the saved lambdas using the dispatcher.\n+  private final List<Consumer<ProgressEventDispatcher.Factory>> stepsToRun = new ArrayList<>();\n \n   @Nullable private String rootProgressDescription;\n-  @Nullable private ProgressEventDispatcher rootProgressDispatcher;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk0MzA3MA=="}, "originalCommit": {"oid": "ed31e0dcc41d0653a57371ce743816c96a997729"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzYxOTY3OA==", "bodyText": "Thanks!", "url": "https://github.com/GoogleContainerTools/jib/pull/2779#discussion_r493619678", "createdAt": "2020-09-23T14:04:04Z", "author": {"login": "mpeddada1"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -115,17 +116,16 @@ public static StepsRunner begin(BuildContext buildContext) {\n   private final BuildContext buildContext;\n   private final TempDirectoryProvider tempDirectoryProvider = new TempDirectoryProvider();\n \n-  // We save steps to run by wrapping each step into a Runnable, only because of the unfortunate\n-  // chicken-and-egg situation arising from using ProgressEventDispatcher. The current\n-  // ProgressEventDispatcher model requires knowing in advance how many units of work (i.e., steps)\n-  // we should perform. That is, to instantiate a root ProgressEventDispatcher instance, we should\n-  // know ahead how many steps we will run. However, to instantiate a step, we need a root progress\n-  // dispatcher. So, we wrap steps into Runnables and save them to run them later. Then we can count\n-  // the number of Runnables and, create a root dispatcher, and run the saved Runnables.\n-  private final List<Runnable> stepsToRun = new ArrayList<>();\n+  // Instead of directly running each step, we first save them as a lambda. This is only because of\n+  // the unfortunate chicken-and-egg situation when using ProgressEventDispatcher. The current\n+  // ProgressEventDispatcher model requires allocating the total units of work (i.e., steps)\n+  // up front. That is, to instantiate a root ProgressEventDispatcher, we should know ahead how many\n+  // steps we will run. However, to run a step, we need a root progress dispatcher. So, we take each\n+  // step as a lambda and save them to run later. Then we can count the number of lambdas, create a\n+  // root dispatcher with the count, and run the saved lambdas using the dispatcher.\n+  private final List<Consumer<ProgressEventDispatcher.Factory>> stepsToRun = new ArrayList<>();\n \n   @Nullable private String rootProgressDescription;\n-  @Nullable private ProgressEventDispatcher rootProgressDispatcher;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk0MzA3MA=="}, "originalCommit": {"oid": "ed31e0dcc41d0653a57371ce743816c96a997729"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4921, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}