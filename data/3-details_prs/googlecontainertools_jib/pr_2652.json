{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYwNDUxNTk2", "number": 2652, "title": "build multiple base Images concurrently", "bodyText": "This PR adds the ability for JIB to build multiple Images concurrently .", "createdAt": "2020-07-31T19:54:48Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2652", "merged": true, "mergeCommit": {"oid": "2dbfe44f9ab6f3753705f78c8640b549fb8e89fd"}, "closed": true, "closedAt": "2020-08-03T20:04:40Z", "author": {"login": "louismurerwa"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6Z0ahAH2gAyNDYwNDUxNTk2OjVjYmIxMjM3MWRkOGNlYmM2MzdiZTlhYWNiMmMzNDQzM2JhZTczNDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7W_nwgFqTQ2MDI3NzQxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5cbb12371dd8cebc637be9aacb2c34433bae7345", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/5cbb12371dd8cebc637be9aacb2c34433bae7345", "committedDate": "2020-07-31T19:58:34Z", "message": "Adding Multi image building"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "601f287d4c29bedd445912b4230ac322c15ff899", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/601f287d4c29bedd445912b4230ac322c15ff899", "committedDate": "2020-07-31T19:52:43Z", "message": "Building Multiple Images"}, "afterCommit": {"oid": "5cbb12371dd8cebc637be9aacb2c34433bae7345", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/5cbb12371dd8cebc637be9aacb2c34433bae7345", "committedDate": "2020-07-31T19:58:34Z", "message": "Adding Multi image building"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abffbf0a5bc7d4f1c4da6f7a18338820586f871b", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/abffbf0a5bc7d4f1c4da6f7a18338820586f871b", "committedDate": "2020-07-31T20:05:40Z", "message": "Style Fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35d6663a81b840e3019f40a8c279dcce611a124f", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/35d6663a81b840e3019f40a8c279dcce611a124f", "committedDate": "2020-07-31T20:10:00Z", "message": "Fixing Styles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be2b0377ddc386215fdecf9f075a22ec153e52ac", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/be2b0377ddc386215fdecf9f075a22ec153e52ac", "committedDate": "2020-07-31T20:11:57Z", "message": "Fixing structure names"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3531cd7e2b0610be7e8a22d03c61bf8e034b4fa7", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/3531cd7e2b0610be7e8a22d03c61bf8e034b4fa7", "committedDate": "2020-07-31T20:13:13Z", "message": "Style Fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5NTA5MDAy", "url": "https://github.com/GoogleContainerTools/jib/pull/2652#pullrequestreview-459509002", "createdAt": "2020-07-31T22:31:55Z", "commit": {"oid": "3531cd7e2b0610be7e8a22d03c61bf8e034b4fa7"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMjozMTo1NVrOG6YkdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQyMjo1MDo0M1rOG6Y1_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3MzE0MQ==", "bodyText": "Just realized this. I actually think this code (and the code in obtainBaseImageLayers that we updated) will break once we have multiple Images due to childProgressDispatcherFactory (the progress reporting thing), which I haven't explained. Will need to fix it when the time comes. Will be easy to fix, so not a concern at all.", "url": "https://github.com/GoogleContainerTools/jib/pull/2652#discussion_r463873141", "createdAt": "2020-07-31T22:31:55Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -358,22 +358,27 @@ private void buildAndCacheApplicationLayers() {\n   private void buildImage() {\n     ProgressEventDispatcher.Factory childProgressDispatcherFactory =\n         Verify.verifyNotNull(rootProgressDispatcher).newChildProducer();\n-\n-    results.builtImage =\n+    results.builtImages =\n         executorService.submit(\n-            () ->\n-                new BuildImageStep(\n-                        buildContext,\n-                        childProgressDispatcherFactory,\n-                        results.baseImagesAndRegistryClient.get().images.get(0),\n-                        realizeFutures(\n-                            Verify.verifyNotNull(\n-                                results\n-                                    .baseImagesAndLayers\n-                                    .get()\n-                                    .get(results.baseImagesAndRegistryClient.get().images.get(0)))),\n-                        realizeFutures(Verify.verifyNotNull(results.applicationLayers)))\n-                    .call());\n+            () -> {\n+              List<Future<Image>> builtImages = new ArrayList<>();\n+              for (Image image : results.baseImagesAndLayers.get().keySet()) {\n+                Future<Image> builtImage =\n+                    executorService.submit(\n+                        () ->\n+                            new BuildImageStep(\n+                                    buildContext,\n+                                    childProgressDispatcherFactory,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3531cd7e2b0610be7e8a22d03c61bf8e034b4fa7"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3NzI3NA==", "bodyText": "You can use .entrySet() to iterator over a Map. An entry is a (key, value) pair, so no need to call Map.get(key) to get the value.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          for (Image image : results.baseImagesAndLayers.get().keySet()) {\n          \n          \n            \n                            Future<Image> builtImage =\n          \n          \n            \n                                executorService.submit(\n          \n          \n            \n                                    () ->\n          \n          \n            \n                                        new BuildImageStep(\n          \n          \n            \n                                                buildContext,\n          \n          \n            \n                                                childProgressDispatcherFactory,\n          \n          \n            \n                                                image,\n          \n          \n            \n                                                realizeFutures(\n          \n          \n            \n                                                    Verify.verifyNotNull(\n          \n          \n            \n                                                        results.baseImagesAndLayers.get().get(image))),\n          \n          \n            \n                                                realizeFutures(Verify.verifyNotNull(results.applicationLayers)))\n          \n          \n            \n                                            .call());\n          \n          \n            \n                            builtImages.add(builtImage);\n          \n          \n            \n                          }\n          \n          \n            \n                          for (Map.Entry<Image, List<Future<PreparedLayer>>> entry :\n          \n          \n            \n                              results.baseImagesAndLayers.get().entrySet()) {\n          \n          \n            \n                            Future<Image> builtImage =\n          \n          \n            \n                                executorService.submit(\n          \n          \n            \n                                    () ->\n          \n          \n            \n                                        new BuildImageStep(\n          \n          \n            \n                                                buildContext,\n          \n          \n            \n                                                childProgressDispatcherFactory,\n          \n          \n            \n                                                entry.getKey(), // base image\n          \n          \n            \n                                                realizeFutures(entry.getValue()), // base image layers\n          \n          \n            \n                                                realizeFutures(Verify.verifyNotNull(results.applicationLayers)))\n          \n          \n            \n                                            .call());\n          \n          \n            \n                            builtImages.add(builtImage);\n          \n          \n            \n                          }", "url": "https://github.com/GoogleContainerTools/jib/pull/2652#discussion_r463877274", "createdAt": "2020-07-31T22:49:15Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -358,22 +358,27 @@ private void buildAndCacheApplicationLayers() {\n   private void buildImage() {\n     ProgressEventDispatcher.Factory childProgressDispatcherFactory =\n         Verify.verifyNotNull(rootProgressDispatcher).newChildProducer();\n-\n-    results.builtImage =\n+    results.builtImages =\n         executorService.submit(\n-            () ->\n-                new BuildImageStep(\n-                        buildContext,\n-                        childProgressDispatcherFactory,\n-                        results.baseImagesAndRegistryClient.get().images.get(0),\n-                        realizeFutures(\n-                            Verify.verifyNotNull(\n-                                results\n-                                    .baseImagesAndLayers\n-                                    .get()\n-                                    .get(results.baseImagesAndRegistryClient.get().images.get(0)))),\n-                        realizeFutures(Verify.verifyNotNull(results.applicationLayers)))\n-                    .call());\n+            () -> {\n+              List<Future<Image>> builtImages = new ArrayList<>();\n+              for (Image image : results.baseImagesAndLayers.get().keySet()) {\n+                Future<Image> builtImage =\n+                    executorService.submit(\n+                        () ->\n+                            new BuildImageStep(\n+                                    buildContext,\n+                                    childProgressDispatcherFactory,\n+                                    image,\n+                                    realizeFutures(\n+                                        Verify.verifyNotNull(\n+                                            results.baseImagesAndLayers.get().get(image))),\n+                                    realizeFutures(Verify.verifyNotNull(results.applicationLayers)))\n+                                .call());\n+                builtImages.add(builtImage);\n+              }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3531cd7e2b0610be7e8a22d03c61bf8e034b4fa7"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3NzYzMQ==", "bodyText": "Rename it to buildImages()? Also, rename other methods too (pullBaseImage() --> pullBaseImages())?", "url": "https://github.com/GoogleContainerTools/jib/pull/2652#discussion_r463877631", "createdAt": "2020-07-31T22:50:43Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/StepsRunner.java", "diffHunk": "@@ -358,22 +358,27 @@ private void buildAndCacheApplicationLayers() {\n   private void buildImage() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3531cd7e2b0610be7e8a22d03c61bf8e034b4fa7"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "726c1b760a899f81bca1dbd71669565e3c668832", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/726c1b760a899f81bca1dbd71669565e3c668832", "committedDate": "2020-08-03T14:53:38Z", "message": "Fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b8ccb84009215c973d713b0ade77c3ec33006fb", "author": {"user": {"login": "louismurerwa", "name": "Louis Murerwa"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/9b8ccb84009215c973d713b0ade77c3ec33006fb", "committedDate": "2020-08-03T17:33:22Z", "message": "empty commit to trigger builds"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMjc3NDEx", "url": "https://github.com/GoogleContainerTools/jib/pull/2652#pullrequestreview-460277411", "createdAt": "2020-08-03T19:15:01Z", "commit": {"oid": "9b8ccb84009215c973d713b0ade77c3ec33006fb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4921, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}