{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzMjcxNDU5", "number": 2402, "title": "Respect DOCKER_CONFIG environment variable when finding credentials", "bodyText": "Part of #1618. Maybe we can follow-up with some sort of jib.docker.config system property (config parameter might not make sense since this path is platform dependent).", "createdAt": "2020-04-14T15:55:18Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2402", "merged": true, "mergeCommit": {"oid": "f79acdd9a4e7d976c6c4d27d6090cef6388860b9"}, "closed": true, "closedAt": "2020-04-14T20:31:23Z", "author": {"login": "TadCordle"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXllPJAH2gAyNDAzMjcxNDU5Ojg5ZWY2MWZiNTY5MzBhZjdkMzViZTA1YzVmZjExNGQ1OTk1NjcyZTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXpGVZAH2gAyNDAzMjcxNDU5OmJmMzNiMTY4MTYzMzNkOWE0NWQxYzFiZGRiMmQyMjhmZTVlNDkyM2Q=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "89ef61fb56930af7d35be05c5ff114d5995672e7", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/89ef61fb56930af7d35be05c5ff114d5995672e7", "committedDate": "2020-04-14T15:53:30Z", "message": "Respect DOCKER_CONFIG environment variable when finding credentials"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMDcwMDcx", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#pullrequestreview-393070071", "createdAt": "2020-04-14T15:57:12Z", "commit": {"oid": "89ef61fb56930af7d35be05c5ff114d5995672e7"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNTo1NzoxMlrOGFVm_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNTo1OTo0OFrOGFVugg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1MDExMA==", "bodyText": "should \".docker\" be a const?", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#discussion_r408250110", "createdAt": "2020-04-14T15:57:12Z", "author": {"login": "loosebazooka"}, "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/DefaultCredentialRetrievers.java", "diffHunk": "@@ -166,10 +166,23 @@ public DefaultCredentialRetrievers setCredentialHelper(@Nullable String credenti\n       credentialRetrievers.add(inferredCredentialRetriever);\n     }\n \n+    String dockerConfigEnv = environment.get(\"DOCKER_CONFIG\");\n+    if (dockerConfigEnv != null) {\n+      Path dockerConfigsPath = Paths.get(dockerConfigEnv);\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.dockerConfig(dockerConfigsPath.resolve(DOCKER_CONFIG_FILE)));\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.dockerConfig(\n+              dockerConfigsPath.resolve(KUBERNETES_DOCKER_CONFIG_FILE)));\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.legacyDockerConfig(\n+              dockerConfigsPath.resolve(LEGACY_DOCKER_CONFIG_FILE)));\n+    }\n+\n     String homeProperty = systemProperties.getProperty(\"user.home\");\n     String homeEnvVar = environment.get(\"HOME\");\n     if (homeProperty != null) {\n-      Path home = Paths.get(homeProperty);\n+      Path home = Paths.get(homeProperty).resolve(\".docker\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89ef61fb56930af7d35be05c5ff114d5995672e7"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI1MjAzNA==", "bodyText": "can we share this code by determining the dockerConfigsPath once by analyzing:\n\ndockerConfigEvn\nhomeProperty\nhomeEnvVar\n\nand then run this block of code for the value of dockerConfigsPath?", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#discussion_r408252034", "createdAt": "2020-04-14T15:59:48Z", "author": {"login": "loosebazooka"}, "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/DefaultCredentialRetrievers.java", "diffHunk": "@@ -166,10 +166,23 @@ public DefaultCredentialRetrievers setCredentialHelper(@Nullable String credenti\n       credentialRetrievers.add(inferredCredentialRetriever);\n     }\n \n+    String dockerConfigEnv = environment.get(\"DOCKER_CONFIG\");\n+    if (dockerConfigEnv != null) {\n+      Path dockerConfigsPath = Paths.get(dockerConfigEnv);\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.dockerConfig(dockerConfigsPath.resolve(DOCKER_CONFIG_FILE)));\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.dockerConfig(\n+              dockerConfigsPath.resolve(KUBERNETES_DOCKER_CONFIG_FILE)));\n+      credentialRetrievers.add(\n+          credentialRetrieverFactory.legacyDockerConfig(\n+              dockerConfigsPath.resolve(LEGACY_DOCKER_CONFIG_FILE)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89ef61fb56930af7d35be05c5ff114d5995672e7"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "990b22ade8aa257ca76a0232232b3e27eb45f3db", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/990b22ade8aa257ca76a0232232b3e27eb45f3db", "committedDate": "2020-04-14T16:01:21Z", "message": "Changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd2b5819efd4eaaff7ffca502d9a94fa78da6d5f", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/cd2b5819efd4eaaff7ffca502d9a94fa78da6d5f", "committedDate": "2020-04-14T16:11:19Z", "message": "Code compression"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMDkxNzU0", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#pullrequestreview-393091754", "createdAt": "2020-04-14T16:22:34Z", "commit": {"oid": "cd2b5819efd4eaaff7ffca502d9a94fa78da6d5f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNjoyMjozNFrOGFWsxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNjozMjo1NFrOGFXJWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI2Nzk3NQ==", "bodyText": "How about elaborate on this to message that DOCKER_CONFIG should be a directory containing a Docker config file?", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#discussion_r408267975", "createdAt": "2020-04-14T16:22:34Z", "author": {"login": "chanseokoh"}, "path": "jib-gradle-plugin/CHANGELOG.md", "diffHunk": "@@ -7,6 +7,7 @@ All notable changes to this project will be documented in this file.\n \n - Glob pattern support for `jib.extraDirectories.permissions`. ([#1200](https://github.com/GoogleContainerTools/jib/issues/1200))\n - Support for image references with both a tag and a digest. ([#1481](https://github.com/GoogleContainerTools/jib/issues/1481))\n+- The `DOCKER_CONFIG` environment variable is now checked for retrieving credentials from the docker config. ([#1618](https://github.com/GoogleContainerTools/jib/issues/1618))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd2b5819efd4eaaff7ffca502d9a94fa78da6d5f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI3NTI4OA==", "bodyText": "Do you think it's worth avoiding duplicates by checking if Paths.get(homeProperty).resolve(DOCKER_DIRECTORY) is same as Paths.get(dockerConfigEnv)? Or not? We've been comparing homeEnvVar and homeProperty. I just want some consistency for future readers of the code who might assume there is a reason for the inconsistency.", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#discussion_r408275288", "createdAt": "2020-04-14T16:32:54Z", "author": {"login": "chanseokoh"}, "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/DefaultCredentialRetrievers.java", "diffHunk": "@@ -166,29 +166,33 @@ public DefaultCredentialRetrievers setCredentialHelper(@Nullable String credenti\n       credentialRetrievers.add(inferredCredentialRetriever);\n     }\n \n+    String dockerConfigEnv = environment.get(\"DOCKER_CONFIG\");\n+    if (dockerConfigEnv != null) {\n+      addDockerFiles(credentialRetrievers, Paths.get(dockerConfigEnv));\n+    }\n+\n     String homeProperty = systemProperties.getProperty(\"user.home\");\n-    String homeEnvVar = environment.get(\"HOME\");\n     if (homeProperty != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd2b5819efd4eaaff7ffca502d9a94fa78da6d5f"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7855ef3e0ac3cd958f6ee4a3d619ff28d23a4630", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/7855ef3e0ac3cd958f6ee4a3d619ff28d23a4630", "committedDate": "2020-04-14T17:24:36Z", "message": "Feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMjM4NDUw", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#pullrequestreview-393238450", "createdAt": "2020-04-14T19:40:41Z", "commit": {"oid": "7855ef3e0ac3cd958f6ee4a3d619ff28d23a4630"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxOTo0MDo0MVrOGFeELg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxOTo0MDo0MVrOGFeELg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM4ODY1NA==", "bodyText": "With checkedDockerDirs, I think this can be just if (homeEnvVar) {?", "url": "https://github.com/GoogleContainerTools/jib/pull/2402#discussion_r408388654", "createdAt": "2020-04-14T19:40:41Z", "author": {"login": "chanseokoh"}, "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/DefaultCredentialRetrievers.java", "diffHunk": "@@ -166,29 +166,43 @@ public DefaultCredentialRetrievers setCredentialHelper(@Nullable String credenti\n       credentialRetrievers.add(inferredCredentialRetriever);\n     }\n \n+    List<Path> checkedDockerDirs = new ArrayList<>();\n+    String dockerConfigEnv = environment.get(\"DOCKER_CONFIG\");\n+    if (dockerConfigEnv != null) {\n+      Path dockerConfigEnvPath = Paths.get(dockerConfigEnv);\n+      addDockerFiles(credentialRetrievers, Paths.get(dockerConfigEnv));\n+      checkedDockerDirs.add(dockerConfigEnvPath);\n+    }\n+\n     String homeProperty = systemProperties.getProperty(\"user.home\");\n-    String homeEnvVar = environment.get(\"HOME\");\n     if (homeProperty != null) {\n-      Path home = Paths.get(homeProperty);\n-      credentialRetrievers.add(\n-          credentialRetrieverFactory.dockerConfig(home.resolve(DOCKER_CONFIG_FILE)));\n-      credentialRetrievers.add(\n-          credentialRetrieverFactory.dockerConfig(home.resolve(KUBERNETES_DOCKER_CONFIG_FILE)));\n-      credentialRetrievers.add(\n-          credentialRetrieverFactory.legacyDockerConfig(home.resolve(LEGACY_DOCKER_CONFIG_FILE)));\n+      Path homePropertyPath = Paths.get(homeProperty).resolve(DOCKER_DIRECTORY);\n+      if (!checkedDockerDirs.contains(homePropertyPath)) {\n+        addDockerFiles(credentialRetrievers, homePropertyPath);\n+        checkedDockerDirs.add(homePropertyPath);\n+      }\n     }\n+\n+    String homeEnvVar = environment.get(\"HOME\");\n     if (homeEnvVar != null && !homeEnvVar.equals(homeProperty)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7855ef3e0ac3cd958f6ee4a3d619ff28d23a4630"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf33b16816333d9a45d1c1bddb2d228fe5e4923d", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/bf33b16816333d9a45d1c1bddb2d228fe5e4923d", "committedDate": "2020-04-14T19:59:22Z", "message": "Fix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 203, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}