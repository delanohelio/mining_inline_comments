{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA1MDYwMTQy", "number": 2833, "title": "Create symlinks for symlink entries in tar when extracting", "bodyText": "Fixes #2829.\nCreates a symbolic link instead of a 0-byte empty file for a symbolic link entry in a tarball when extracting.\nThe test tarball symlinks.tar has two symlinks (one for a directory and the other for a file).\n.\n\u251c\u2500\u2500 directory1\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 file-symlink -> ../directory2/regular\n\u251c\u2500\u2500 directory2\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 regular\n\u2514\u2500\u2500 directory-symlink -> directory1", "createdAt": "2020-10-16T19:33:01Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2833", "merged": true, "mergeCommit": {"oid": "405947df17b4f16bcb00289d1007634359c34a86"}, "closed": true, "closedAt": "2020-10-19T14:02:15Z", "author": {"login": "chanseokoh"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdTLiycgH2gAyNTA1MDYwMTQyOjVhNjQxODY2NGI3MDVjNjBiYzZiNDJhYTJhZjI5ZWZjOTkyZTFlMDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdTNmIsgH2gAyNTA1MDYwMTQyOjdkNzM0YTZiZTY4MTQ1ZGU3MTZmYjIzZjBlZjk0MGUxMGI4NTQ0MjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5a6418664b705c60bc6b42aa2af29efc992e1e06", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/5a6418664b705c60bc6b42aa2af29efc992e1e06", "committedDate": "2020-10-16T19:28:45Z", "message": "Create symlinks for symlink entries in tar"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bc161fe94a489c03da785152c386a5c7a94ae83", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/6bc161fe94a489c03da785152c386a5c7a94ae83", "committedDate": "2020-10-16T19:37:46Z", "message": "CHANGELOG"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ea39542ac70b41d2f1775d3d4667b1c2f0bb75a", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/6ea39542ac70b41d2f1775d3d4667b1c2f0bb75a", "committedDate": "2020-10-16T20:45:39Z", "message": "Merge branch 'master' into i2829-tar-extract-symlinks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1c677a491fbfd8039038f15d76e46c9b7c0800d", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/d1c677a491fbfd8039038f15d76e46c9b7c0800d", "committedDate": "2020-10-16T21:17:00Z", "message": "Update test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODExMjk5", "url": "https://github.com/GoogleContainerTools/jib/pull/2833#pullrequestreview-510811299", "createdAt": "2020-10-16T21:35:12Z", "commit": {"oid": "d1c677a491fbfd8039038f15d76e46c9b7c0800d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMTozNToxMlrOHjQcGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMTozNToxMlrOHjQcGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjczMTU0Nw==", "bodyText": "Does this mean if the same layer is being cached twice?", "url": "https://github.com/GoogleContainerTools/jib/pull/2833#discussion_r506731547", "createdAt": "2020-10-16T21:35:12Z", "author": {"login": "mpeddada1"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/cache/CacheStorageWriter.java", "diffHunk": "@@ -120,8 +120,8 @@ private static void moveIfDoesNotExist(Path source, Path destination) throws IOE\n                 () -> {\n                   if (Files.exists(destination)) {\n                     // If the file already exists, we skip renaming and use the existing file.\n-                    // This happens if a new layer happens to have the same content as a\n-                    // previously-cached layer.\n+                    // This happens, e.g., if a new layer happens to have the same content as a\n+                    // previously-cached layer or the same layer is being cached concurrently.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1c677a491fbfd8039038f15d76e46c9b7c0800d"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODE0NDAy", "url": "https://github.com/GoogleContainerTools/jib/pull/2833#pullrequestreview-510814402", "createdAt": "2020-10-16T21:42:53Z", "commit": {"oid": "d1c677a491fbfd8039038f15d76e46c9b7c0800d"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMTo0Mjo1M1rOHjQl7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMTo0Mzo0OVrOHjQm-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjczNDA2Mw==", "bodyText": "Can we use entry.isSymbolicLink?", "url": "https://github.com/GoogleContainerTools/jib/pull/2833#discussion_r506734063", "createdAt": "2020-10-16T21:42:53Z", "author": {"login": "loosebazooka"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/tar/TarExtractor.java", "diffHunk": "@@ -61,8 +63,14 @@ public static void extract(Path source, Path destination) throws IOException {\n           if (entryPath.getParent() != null) {\n             Files.createDirectories(entryPath.getParent());\n           }\n-          try (OutputStream out = new BufferedOutputStream(Files.newOutputStream(entryPath))) {\n-            ByteStreams.copy(tarArchiveInputStream, out);\n+\n+          String linkName = entry.getLinkName();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1c677a491fbfd8039038f15d76e46c9b7c0800d"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjczNDMzMQ==", "bodyText": "So what happens when we then process this layer? Do we lose this symlink?", "url": "https://github.com/GoogleContainerTools/jib/pull/2833#discussion_r506734331", "createdAt": "2020-10-16T21:43:49Z", "author": {"login": "loosebazooka"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/tar/TarExtractor.java", "diffHunk": "@@ -61,8 +63,14 @@ public static void extract(Path source, Path destination) throws IOException {\n           if (entryPath.getParent() != null) {\n             Files.createDirectories(entryPath.getParent());\n           }\n-          try (OutputStream out = new BufferedOutputStream(Files.newOutputStream(entryPath))) {\n-            ByteStreams.copy(tarArchiveInputStream, out);\n+\n+          String linkName = entry.getLinkName();\n+          if (!Strings.isNullOrEmpty(linkName)) {\n+            Files.createSymbolicLink(entryPath, Paths.get(linkName));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1c677a491fbfd8039038f15d76e46c9b7c0800d"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d734a6be68145de716fb23f0ef940e10b854426", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/7d734a6be68145de716fb23f0ef940e10b854426", "committedDate": "2020-10-16T21:52:13Z", "message": "Use entry.isSymbolicLink"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4825, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}