{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3NzAxMTcx", "number": 2381, "title": "Correctly parse ImageReference with both tag and digest", "bodyText": "Fixes #1481. Since ImageReference is part of the public API, there were a couple weird changes to keep backwards compatibility (see the jib-core changelog).", "createdAt": "2020-04-02T17:00:22Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2381", "merged": true, "mergeCommit": {"oid": "f4d23992157c545f390af3903e025c31f4596c81"}, "closed": true, "closedAt": "2020-04-07T18:27:13Z", "author": {"login": "TadCordle"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTvSAdgH2gAyMzk3NzAxMTcxOjE1NjQxMzZlZjBiYzY3NjkwMjAxODBlOTZhNjNjOGYyMjE5NTA2NDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVXZoJAFqTM4OTM3MTQwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/1564136ef0bc6769020180e96a63c8f221950646", "committedDate": "2020-04-02T16:55:51Z", "message": "Correctly parse ImageReference with both tag and digest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2Njk4MTcx", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#pullrequestreview-386698171", "createdAt": "2020-04-02T18:41:05Z", "commit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxODo0MTowNVrOF_4mPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxODo1MjowN1rOF_4_iA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzMTkwMQ==", "bodyText": "\"... from a tag and digest\"?", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r402531901", "createdAt": "2020-04-02T18:41:05Z", "author": {"login": "chanseokoh"}, "path": "jib-core/CHANGELOG.md", "diffHunk": "@@ -5,7 +5,14 @@ All notable changes to this project will be documented in this file.\n \n ### Added\n \n+- Multiple additions to `ImageReference` to separate `tag` and `digest`. ([#1481](https://github.com/GoogleContainerTools/jib/issues/1481))\n+    - `of(registry, repository, tag, digest)` to create an image from a digest", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzMjYyNg==", "bodyText": "nit: newline before this line", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r402532626", "createdAt": "2020-04-02T18:42:24Z", "author": {"login": "chanseokoh"}, "path": "jib-core/CHANGELOG.md", "diffHunk": "@@ -5,7 +5,14 @@ All notable changes to this project will be documented in this file.\n \n ### Added\n \n+- Multiple additions to `ImageReference` to separate `tag` and `digest`. ([#1481](https://github.com/GoogleContainerTools/jib/issues/1481))\n+    - `of(registry, repository, tag, digest)` to create an image from a digest\n+    - `isValidDigest(digest)` to check if a string is a valid digest\n+    - `getDigest()` to get the digest\n+    - `parse()` now supports image reference strings containing both a tag and a digest\n+\n ### Changed\n+- `ImageReference#isTagDigest` is now deprecated.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzNDU3NA==", "bodyText": "I think the purpose of this method is to ensure :latest is added. I don't think toString() will add :latest.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r402534574", "createdAt": "2020-04-02T18:45:43Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -346,6 +387,10 @@ public String toString() {\n    * @return the image reference in Docker-readable format, without hiding the tag\n    */\n   public String toStringWithTag() {\n+    // Insert tag before digest\n+    if (!Strings.isNullOrEmpty(digest)) {\n+      return toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "originalPosition": 174}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzNTM2MQ==", "bodyText": "I know digest is of Optional, but is this different from digest.equals(otherImageReference.digest)?", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r402535361", "createdAt": "2020-04-02T18:47:09Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -360,11 +405,12 @@ public boolean equals(Object other) {\n     ImageReference otherImageReference = (ImageReference) other;\n     return registry.equals(otherImageReference.registry)\n         && repository.equals(otherImageReference.repository)\n-        && tag.equals(otherImageReference.tag);\n+        && tag.equals(otherImageReference.tag)\n+        && Objects.equals(digest, otherImageReference.digest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "originalPosition": 185}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjUzODM3Ng==", "bodyText": "I'm curious how Jib will work and respond if there's an error for a base image, e.g.,\n\ntag exists but digest doesn't match\ndigest exists but tag doesn't\n\nWill they work? If they fail, will the error message make sense and be helpful?", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r402538376", "createdAt": "2020-04-02T18:52:07Z", "author": {"login": "chanseokoh"}, "path": "jib-gradle-plugin/CHANGELOG.md", "diffHunk": "@@ -6,6 +6,7 @@ All notable changes to this project will be documented in this file.\n ### Added\n \n - Glob pattern support for `jib.extraDirectories.permissions`. ([#1200](https://github.com/GoogleContainerTools/jib/issues/1200))\n+- Support for image references with both a tag and a digest. ([#1481](https://github.com/GoogleContainerTools/jib/issues/1481))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1564136ef0bc6769020180e96a63c8f221950646"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b45f03c8663bb228320dd9632f69f6e76487e98d", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/b45f03c8663bb228320dd9632f69f6e76487e98d", "committedDate": "2020-04-02T20:40:15Z", "message": "Comments and tentative method rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/7636641ec50195b638633c441451b3d428a3b4e4", "committedDate": "2020-04-06T17:17:40Z", "message": "Rename"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4Njc0NDIz", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#pullrequestreview-388674423", "createdAt": "2020-04-06T22:56:00Z", "commit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMjo1NjowMFrOGBs4JQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQyMzoxMDozOVrOGBtNHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQzNzAyOQ==", "bodyText": "I think we should call this qualifier, considering the new constructor that accepts both tag and digest. I am OK with tagOrDigest too. And the doc could be \"the image tag, digest, or null to use the default tag latest\". We can then remove the part \"If tag is a valid digest string...\". I really think we should not call a digest \"tag\".", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r404437029", "createdAt": "2020-04-06T22:56:00Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -157,22 +151,42 @@ public static ImageReference parse(String reference) throws InvalidImageReferenc\n    *\n    * @param registry the image registry, or {@code null} to use the default registry (Docker Hub)\n    * @param repository the image repository\n-   * @param tag the image tag, or {@code null} to use the default tag ({@code latest})\n+   * @param tag the image tag, or {@code null} to use the default tag ({@code latest}). If {@code", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQzNzk1OQ==", "bodyText": "isValidTag has changed its behavior too.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r404437959", "createdAt": "2020-04-06T22:58:51Z", "author": {"login": "chanseokoh"}, "path": "jib-core/CHANGELOG.md", "diffHunk": "@@ -5,8 +5,17 @@ All notable changes to this project will be documented in this file.\n \n ### Added\n \n+- Multiple additions to `ImageReference` to separate `tag` and `digest`. ([#1481](https://github.com/GoogleContainerTools/jib/issues/1481))\n+    - `of(registry, repository, tag, digest)` to create an image from a tag and digest.\n+    - `isValidDigest(digest)` to check if a string is a valid digest.\n+    - `getDigest()` to get the digest.\n+    - `parse()` now supports image reference strings containing both a tag and a digest.\n+\n ### Changed\n \n+- `ImageReference#toStringWithTag` has been renamed to `toStringWithQualifier`.\n+- `ImageReference#isTagDigest` has been removed; use `#getDigest` with `Optional#isPresent()` to check if an `ImageReference` uses a digest.\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQzOTg1OQ==", "bodyText": "I actually think we can call of(registry, repository, tag, digest) here and get rid of some if checks in this method, as parse() and of() duplicate some logic. But let's not touch this method anymore in this PR to be on the safe side.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r404439859", "createdAt": "2020-04-06T23:03:38Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -137,18 +138,11 @@ public static ImageReference parse(String reference) throws InvalidImageReferenc\n       repository = LIBRARY_REPOSITORY_PREFIX + repository;\n     }\n \n-    if (!Strings.isNullOrEmpty(tag)) {\n-      if (!Strings.isNullOrEmpty(digest)) {\n-        // Cannot have matched both tag and digest.\n-        throw new InvalidImageReferenceException(reference);\n-      }\n-    } else if (!Strings.isNullOrEmpty(digest)) {\n-      tag = digest;\n-    } else {\n+    if (Strings.isNullOrEmpty(tag)) {\n       tag = DEFAULT_TAG;\n     }\n \n-    return new ImageReference(registry, repository, tag);\n+    return new ImageReference(registry, repository, tag, digest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MTAyOA==", "bodyText": "Remove this comment.\nBTW, I think it is correct that this method prints both a (non-default) tag and a digest.", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r404441028", "createdAt": "2020-04-06T23:06:44Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -334,18 +360,27 @@ public String toString() {\n     // Use tag if not the default tag.\n     if (!DEFAULT_TAG.equals(tag)) {\n       // Append with \"@tag\" instead of \":tag\" if tag is a digest", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4"}, "originalPosition": 164}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MjM5OA==", "bodyText": "Hmm... so if both a digest and a non-default tag are given, now toStringWithQualifier() will print both. Are we good with that?", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#discussion_r404442398", "createdAt": "2020-04-06T23:10:39Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/api/ImageReference.java", "diffHunk": "@@ -334,18 +360,27 @@ public String toString() {\n     // Use tag if not the default tag.\n     if (!DEFAULT_TAG.equals(tag)) {\n       // Append with \"@tag\" instead of \":tag\" if tag is a digest\n-      referenceString.append(isTagDigest() ? '@' : ':').append(tag);\n+      referenceString.append(':').append(tag);\n+    }\n+\n+    if (!Strings.isNullOrEmpty(digest)) {\n+      referenceString.append('@').append(digest);\n     }\n \n     return referenceString.toString();\n   }\n \n   /**\n-   * Stringifies the {@link ImageReference}, without hiding the tag.\n+   * Stringifies the {@link ImageReference}, including the default tag if no tag or digest is set.\n    *\n-   * @return the image reference in Docker-readable format, without hiding the tag\n+   * @return the image reference in Docker-readable format, including the default tag if no tag or\n+   *     digest is set.\n    */\n-  public String toStringWithTag() {\n+  public String toStringWithQualifier() {\n+    // Insert tag before digest\n+    if (!Strings.isNullOrEmpty(digest)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7636641ec50195b638633c441451b3d428a3b4e4"}, "originalPosition": 187}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "853bad7583d9df905985810a89ac48becc89a35b", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/853bad7583d9df905985810a89ac48becc89a35b", "committedDate": "2020-04-07T15:12:15Z", "message": "Merge branch 'master' of github.com:GoogleContainerTools/jib into i1481-imagereference-tag-digest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91614c2d958ef79b2fe30220aa2c424076e00978", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/91614c2d958ef79b2fe30220aa2c424076e00978", "committedDate": "2020-04-07T15:26:34Z", "message": "Feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f294908c4fcd71144a84114b3221da684dcf8960", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/f294908c4fcd71144a84114b3221da684dcf8960", "committedDate": "2020-04-07T17:41:15Z", "message": "Give digest priority in toStringWithQualifier"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzcxNDA2", "url": "https://github.com/GoogleContainerTools/jib/pull/2381#pullrequestreview-389371406", "createdAt": "2020-04-07T18:14:18Z", "commit": {"oid": "f294908c4fcd71144a84114b3221da684dcf8960"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 186, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}