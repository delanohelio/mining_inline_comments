{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2NDE4ODc3", "number": 2849, "title": "Fill in directories for files added by filter.", "bodyText": "This happens where parent directories are filtered\nbut need to be filled in for files in those\ndirectories\nfixes #2843", "createdAt": "2020-10-20T02:49:11Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2849", "merged": true, "mergeCommit": {"oid": "5a17bcc4f8f63e4935f3acdbff8c10023540f099"}, "closed": true, "closedAt": "2020-10-22T17:53:21Z", "author": {"login": "loosebazooka"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUPmPeAH2gAyNTA2NDE4ODc3OmY3YTcxMDkzYzUwZTdkZTI5Mjg4NWViNTVhZTNjODQ0YjFiMTA1ZWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVC2vngH2gAyNTA2NDE4ODc3OmFlZTI5MmUyNDQzMTUwMTcxMGRkMGFmMTQ2YTVjMTIzZmQ1MjBjNzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f7a71093c50e7de292885eb55ae3c844b1b105ec", "author": {"user": {"login": "loosebazooka", "name": "Appu"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/f7a71093c50e7de292885eb55ae3c844b1b105ec", "committedDate": "2020-10-20T02:46:04Z", "message": "Fill in directories for files added by filter.\n\nThis happens where parent directories are filtered\nbut need to be filled in for files in those\ndirectories"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNTI5NjEz", "url": "https://github.com/GoogleContainerTools/jib/pull/2849#pullrequestreview-512529613", "createdAt": "2020-10-20T09:50:47Z", "commit": {"oid": "f7a71093c50e7de292885eb55ae3c844b1b105ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwOTo1MDo0N1rOHk0GPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwOTo1MDo0N1rOHk0GPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM2NDM0OQ==", "bodyText": "Actually these need to be added in reverse order", "url": "https://github.com/GoogleContainerTools/jib/pull/2849#discussion_r508364349", "createdAt": "2020-10-20T09:50:47Z", "author": {"login": "loosebazooka"}, "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/Layers.java", "diffHunk": "@@ -96,49 +104,72 @@\n                     .map(Layers::toPathMatcher)\n                     .collect(Collectors.toList());\n             try (Stream<Path> dirWalk = Files.walk(src)) {\n-              dirWalk\n-                  // filter out against excludes\n-                  .filter(path -> excludes.stream().noneMatch(exclude -> exclude.matches(path)))\n-                  .filter(\n-                      path -> {\n-                        // if there are no includes directives, include everything\n-                        if (includes.isEmpty()) {\n-                          return true;\n-                        }\n-                        // TODO: if <dest>/path/to/file.txt is included because of a pattern like\n-                        // TODO: **/file.txt, ensure we create <dest>/path and <dest>/path/to with\n-                        // TODO: the correct directory properties here\n-                        // if there are includes directives, only include those specified\n-                        for (PathMatcher matcher : includes) {\n-                          if (matcher.matches(path)) {\n-                            return true;\n-                          }\n-                        }\n-                        return false;\n-                      })\n-                  .map(\n-                      path -> {\n-                        Path relative = src.relativize(path);\n-                        if (Files.isDirectory(path) || Files.isRegularFile(path)) {\n-                          return new FileEntry(\n-                              path,\n-                              dest.resolve(relative),\n-                              Files.isDirectory(path)\n-                                  ? filePropertiesStack.getDirectoryPermissions()\n-                                  : filePropertiesStack.getFilePermissions(),\n-                              filePropertiesStack.getModificationTime(),\n-                              filePropertiesStack.getOwnership());\n-                        } else {\n-                          throw new UnsupportedOperationException(\n-                              \"Cannot create FileLayers from non-file, non-directory: \"\n-                                  + path.toString());\n-                        }\n-                      })\n-                  .forEach(layerBuiler::addEntry);\n+              List<Path> filtered =\n+                  dirWalk\n+                      // filter out against excludes\n+                      .filter(path -> excludes.stream().noneMatch(exclude -> exclude.matches(path)))\n+                      .filter(\n+                          path -> {\n+                            // if there are no includes directives, include everything\n+                            if (includes.isEmpty()) {\n+                              return true;\n+                            }\n+                            // if there are includes directives, only include those specified\n+                            for (PathMatcher matcher : includes) {\n+                              if (matcher.matches(path)) {\n+                                return true;\n+                              }\n+                            }\n+                            return false;\n+                          })\n+                      .collect(Collectors.toList());\n+\n+              BiFunction<Path, FilePermissions, FileEntry> newEntry =\n+                  (file, permission) ->\n+                      new FileEntry(\n+                          file,\n+                          dest.resolve(src.relativize(file)),\n+                          permission,\n+                          filePropertiesStack.getModificationTime(),\n+                          filePropertiesStack.getOwnership());\n+\n+              Set<Path> addedDirectories = new HashSet<>();\n+              for (Path path : filtered) {\n+                if (!Files.isDirectory(path) && !Files.isRegularFile(path)) {\n+                  throw new UnsupportedOperationException(\n+                      \"Cannot create FileLayers from non-file, non-directory: \" + src.toString());\n+                }\n+\n+                if (Files.isDirectory(path)) {\n+                  addedDirectories.add(path);\n+                  layerBuiler.addEntry(\n+                      newEntry.apply(path, filePropertiesStack.getDirectoryPermissions()));\n+                } else if (Files.isRegularFile(path)) {\n+                  if (!path.startsWith(src)) {\n+                    // if we end up in a situation where the file added is somehow outside of the\n+                    // tree then we do not know how to properly handle it at the moment. It could\n+                    // be from a link scenario that we do not understand.\n+                    throw new IllegalStateException(\n+                        src.toString() + \" is not a parent of \" + path.toString());\n+                  }\n+                  Path parent = path.getParent();\n+                  while (true) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7a71093c50e7de292885eb55ae3c844b1b105ec"}, "originalPosition": 122}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyODU0NTYw", "url": "https://github.com/GoogleContainerTools/jib/pull/2849#pullrequestreview-512854560", "createdAt": "2020-10-20T15:21:09Z", "commit": {"oid": "f7a71093c50e7de292885eb55ae3c844b1b105ec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNToyMTowOVrOHlCk4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNToyMTowOVrOHlCk4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYwMTU2OA==", "bodyText": "Is this primarily to guard against symlinks?", "url": "https://github.com/GoogleContainerTools/jib/pull/2849#discussion_r508601568", "createdAt": "2020-10-20T15:21:09Z", "author": {"login": "chanseokoh"}, "path": "jib-cli/src/main/java/com/google/cloud/tools/jib/cli/buildfile/Layers.java", "diffHunk": "@@ -71,6 +75,10 @@\n           Path src = rawSrc.isAbsolute() ? rawSrc : buildRoot.resolve(rawSrc);\n           AbsoluteUnixPath dest = copySpec.getDest();\n \n+          if (!Files.isDirectory(src) && !Files.isRegularFile(src)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7a71093c50e7de292885eb55ae3c844b1b105ec"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMTA2NTM1", "url": "https://github.com/GoogleContainerTools/jib/pull/2849#pullrequestreview-513106535", "createdAt": "2020-10-20T20:28:07Z", "commit": {"oid": "f7a71093c50e7de292885eb55ae3c844b1b105ec"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDoyODowN1rOHlPyyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDoyODowN1rOHlPyyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgxODEyMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      # equivalent to \"**/excludedDir/**\"", "url": "https://github.com/GoogleContainerTools/jib/pull/2849#discussion_r508818122", "createdAt": "2020-10-20T20:28:07Z", "author": {"login": "chanseokoh"}, "path": "jib-cli/src/test/resources/buildfiles/layers/includesExcludesTest/layers.yaml", "diffHunk": "@@ -33,11 +33,20 @@ entries:\n         excludes:\n           # equivalent to \"**/excludedDir/**\"\n           - \"**/excludedDir/\"\n+  - name: \"exclude dir and contents\"\n+    files:\n+      - src: \"project\"\n+        dest: \"/target/edac\"\n+        excludes:\n+          # equivalent to \"**/excludedDir/**\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7a71093c50e7de292885eb55ae3c844b1b105ec"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89b4dd9cc37bdbae206791ac24f4a63af5c6e25b", "author": {"user": {"login": "loosebazooka", "name": "Appu"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/89b4dd9cc37bdbae206791ac24f4a63af5c6e25b", "committedDate": "2020-10-20T20:45:44Z", "message": "Update jib-cli/src/test/resources/buildfiles/layers/includesExcludesTest/layers.yaml\n\nCo-authored-by: Chanseok Oh <chanseok@google.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aee292e24431501710dd0af146a5c123fd520c72", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/aee292e24431501710dd0af146a5c123fd520c72", "committedDate": "2020-10-22T14:29:15Z", "message": "Merge remote-tracking branch 'origin/master' into parentDirs"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4839, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}