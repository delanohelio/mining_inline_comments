{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyMTAxNzY4", "number": 2914, "title": "Fix incomplete progress dispatching in PullBaseImageStep", "bodyText": "Moved the upper code block before try (ProgressEventDispatcher progressEventDispatcher = ...) { into that try block.\nThe upper code block has short-circuiting returns, so taking that path fails to complete the progress allocation given to PullBaseImageStep.", "createdAt": "2020-12-03T20:36:30Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2914", "merged": true, "mergeCommit": {"oid": "c7fe0962f3aa0fb8f574abb3260a8e0bad592507"}, "closed": true, "closedAt": "2020-12-04T15:10:23Z", "author": {"login": "chanseokoh"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdipPIrAH2gAyNTMyMTAxNzY4OmZhZjNjOTQxMGRjYzdjYTRmZTBhNzkwYmU3MWQzMDE4NDcxYzhhYmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdi5GHqAFqTU0NTAzNTA2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "faf3c9410dcc7ca4fe0a790be71d3018471c8abf", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/faf3c9410dcc7ca4fe0a790be71d3018471c8abf", "committedDate": "2020-12-03T20:33:18Z", "message": "Fix incomplete progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33f89dd9a2f143317b7a1fe735ab449a6534f944", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/33f89dd9a2f143317b7a1fe735ab449a6534f944", "committedDate": "2020-12-03T20:37:42Z", "message": "Merge branch 'master' into fix-progress-completion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NDE1OTY5", "url": "https://github.com/GoogleContainerTools/jib/pull/2914#pullrequestreview-544415969", "createdAt": "2020-12-03T20:39:46Z", "commit": {"oid": "33f89dd9a2f143317b7a1fe735ab449a6534f944"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDozOTo0NlrOH-xecA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMDozOTo0NlrOH-xecA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTU4NDM2OA==", "bodyText": "BTW, looks like the current allocation units (2) isn't correct, but I'm not addressing this here.", "url": "https://github.com/GoogleContainerTools/jib/pull/2914#discussion_r535584368", "createdAt": "2020-12-03T20:39:46Z", "author": {"login": "chanseokoh"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -95,47 +95,48 @@ public ImagesAndRegistryClient call()\n           LayerCountMismatchException, BadContainerConfigurationFormatException,\n           CacheCorruptedException, CredentialRetrievalException {\n     EventHandlers eventHandlers = buildContext.getEventHandlers();\n-    // Skip this step if this is a scratch image\n-    ImageReference imageReference = buildContext.getBaseImageConfiguration().getImage();\n-    if (imageReference.isScratch()) {\n-      Set<Platform> platforms = buildContext.getContainerConfiguration().getPlatforms();\n-      Verify.verify(!platforms.isEmpty());\n-\n-      eventHandlers.dispatch(LogEvent.progress(\"Getting scratch base image...\"));\n-      ImmutableList.Builder<Image> images = ImmutableList.builder();\n-      for (Platform platform : platforms) {\n-        Image.Builder imageBuilder = Image.builder(buildContext.getTargetFormat());\n-        imageBuilder.setArchitecture(platform.getArchitecture()).setOs(platform.getOs());\n-        images.add(imageBuilder.build());\n+    try (ProgressEventDispatcher progressEventDispatcher =\n+            progressEventDispatcherFactory.create(\"pulling base image manifest\", 2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33f89dd9a2f143317b7a1fe735ab449a6534f944"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTU4MDIx", "url": "https://github.com/GoogleContainerTools/jib/pull/2914#pullrequestreview-544558021", "createdAt": "2020-12-03T23:55:21Z", "commit": {"oid": "33f89dd9a2f143317b7a1fe735ab449a6534f944"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMzo1NToyMVrOH-6kcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMzo1NToyMVrOH-6kcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTczMzM2Mw==", "bodyText": "minor formatting: need to move line 136 up.", "url": "https://github.com/GoogleContainerTools/jib/pull/2914#discussion_r535733363", "createdAt": "2020-12-03T23:55:21Z", "author": {"login": "mpeddada1"}, "path": "jib-core/src/main/java/com/google/cloud/tools/jib/builder/steps/PullBaseImageStep.java", "diffHunk": "@@ -95,47 +95,48 @@ public ImagesAndRegistryClient call()\n           LayerCountMismatchException, BadContainerConfigurationFormatException,\n           CacheCorruptedException, CredentialRetrievalException {\n     EventHandlers eventHandlers = buildContext.getEventHandlers();\n-    // Skip this step if this is a scratch image\n-    ImageReference imageReference = buildContext.getBaseImageConfiguration().getImage();\n-    if (imageReference.isScratch()) {\n-      Set<Platform> platforms = buildContext.getContainerConfiguration().getPlatforms();\n-      Verify.verify(!platforms.isEmpty());\n-\n-      eventHandlers.dispatch(LogEvent.progress(\"Getting scratch base image...\"));\n-      ImmutableList.Builder<Image> images = ImmutableList.builder();\n-      for (Platform platform : platforms) {\n-        Image.Builder imageBuilder = Image.builder(buildContext.getTargetFormat());\n-        imageBuilder.setArchitecture(platform.getArchitecture()).setOs(platform.getOs());\n-        images.add(imageBuilder.build());\n+    try (ProgressEventDispatcher progressEventDispatcher =\n+            progressEventDispatcherFactory.create(\"pulling base image manifest\", 2);\n+        TimerEventDispatcher ignored1 = new TimerEventDispatcher(eventHandlers, DESCRIPTION)) {\n+\n+      // Skip this step if this is a scratch image\n+      ImageReference imageReference = buildContext.getBaseImageConfiguration().getImage();\n+      if (imageReference.isScratch()) {\n+        Set<Platform> platforms = buildContext.getContainerConfiguration().getPlatforms();\n+        Verify.verify(!platforms.isEmpty());\n+\n+        eventHandlers.dispatch(LogEvent.progress(\"Getting scratch base image...\"));\n+        ImmutableList.Builder<Image> images = ImmutableList.builder();\n+        for (Platform platform : platforms) {\n+          Image.Builder imageBuilder = Image.builder(buildContext.getTargetFormat());\n+          imageBuilder.setArchitecture(platform.getArchitecture()).setOs(platform.getOs());\n+          images.add(imageBuilder.build());\n+        }\n+        return new ImagesAndRegistryClient(images.build(), null);\n       }\n-      return new ImagesAndRegistryClient(images.build(), null);\n-    }\n \n-    eventHandlers.dispatch(\n-        LogEvent.progress(\"Getting manifest for base image \" + imageReference + \"...\"));\n+      eventHandlers.dispatch(\n+          LogEvent.progress(\"Getting manifest for base image \" + imageReference + \"...\"));\n \n-    if (buildContext.isOffline()) {\n-      List<Image> images = getCachedBaseImages();\n-      if (!images.isEmpty()) {\n-        return new ImagesAndRegistryClient(images, null);\n-      }\n-      throw new IOException(\n-          \"Cannot run Jib in offline mode; \" + imageReference + \" not found in local Jib cache\");\n-\n-    } else if (imageReference.getDigest().isPresent()) {\n-      List<Image> images = getCachedBaseImages();\n-      if (!images.isEmpty()) {\n-        RegistryClient noAuthRegistryClient =\n-            buildContext.newBaseImageRegistryClientFactory().newRegistryClient();\n-        // TODO: passing noAuthRegistryClient may be problematic. It may return 401 unauthorized if\n-        // layers have to be downloaded. https://github.com/GoogleContainerTools/jib/issues/2220\n-        return new ImagesAndRegistryClient(images, noAuthRegistryClient);\n+      if (buildContext.isOffline()) {\n+        List<Image> images = getCachedBaseImages();\n+        if (!images.isEmpty()) {\n+          return new ImagesAndRegistryClient(images, null);\n+        }\n+        throw new IOException(\n+            \"Cannot run Jib in offline mode; \" + imageReference + \" not found in local Jib cache\");\n+\n+      } else if (imageReference.getDigest().isPresent()) {\n+        List<Image> images = getCachedBaseImages();\n+        if (!images.isEmpty()) {\n+          RegistryClient noAuthRegistryClient =\n+              buildContext.newBaseImageRegistryClientFactory().newRegistryClient();\n+          // TODO: passing noAuthRegistryClient may be problematic. It may return 401 unauthorized\n+          // if\n+          // layers have to be downloaded. https://github.com/GoogleContainerTools/jib/issues/2220", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33f89dd9a2f143317b7a1fe735ab449a6534f944"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5618e9b9208268503bdb75614512c9ddf7db93dc", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/5618e9b9208268503bdb75614512c9ddf7db93dc", "committedDate": "2020-12-04T01:53:20Z", "message": "Format comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MDM1MDY4", "url": "https://github.com/GoogleContainerTools/jib/pull/2914#pullrequestreview-545035068", "createdAt": "2020-12-04T15:01:56Z", "commit": {"oid": "5618e9b9208268503bdb75614512c9ddf7db93dc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4882, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}