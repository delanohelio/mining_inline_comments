{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1NDkwOTQ1", "number": 2502, "title": "Add project dependencies in a separate layer for WAR projects", "bodyText": "Fixes #2450\nJunit test added", "createdAt": "2020-05-30T16:30:00Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2502", "merged": true, "mergeCommit": {"oid": "27a949f63e61eb103dc47867e694c546c64d137f"}, "closed": true, "closedAt": "2020-06-09T16:54:35Z", "author": {"login": "WuYff"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcmUX75gH2gAyNDI1NDkwOTQ1OmU2Y2VmMDQ3ZDg5NjZmYmQ1M2ZjYTg3NjczZTg2MTM1ZGQ5NTcyNGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpnpgwgFqTQyNzMzODgzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e6cef047d8966fbd53fca87673e86135dd95724e", "author": {"user": {"login": "WuYff", "name": "Yi Wu"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/e6cef047d8966fbd53fca87673e86135dd95724e", "committedDate": "2020-05-30T10:19:27Z", "message": "add project dependencies for WAR project"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1916074d99f29f9b1e0d7745958f915272e00ab", "author": {"user": {"login": "WuYff", "name": "Yi Wu"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/c1916074d99f29f9b1e0d7745958f915272e00ab", "committedDate": "2020-05-30T14:37:54Z", "message": " add test for project dependencies of WAR project"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00dcb2356073024b2536d02e6e31713c9d87f676", "author": {"user": {"login": "WuYff", "name": "Yi Wu"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/00dcb2356073024b2536d02e6e31713c9d87f676", "committedDate": "2020-05-30T15:23:10Z", "message": "format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxOTA5Mjg1", "url": "https://github.com/GoogleContainerTools/jib/pull/2502#pullrequestreview-421909285", "createdAt": "2020-06-01T14:52:06Z", "commit": {"oid": "00dcb2356073024b2536d02e6e31713c9d87f676"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNDo1MjowNlrOGdNahw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNTowNToxOVrOGdN5XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI4MTY3MQ==", "bodyText": "I'd prefer calling addProjectDependencies after addSnapshotDependencies. That is, the order should be\n\nadd 3rd-party dependencies\nadd snapshot dependencies\nadd project dependencies\n\nAnd let's chain .filter().\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          .filter(\n          \n          \n            \n                              path ->\n          \n          \n            \n                                  !path.getFileName().toString().contains(\"SNAPSHOT\")\n          \n          \n            \n                                      && !projectArtifacts.contains(path.getFileName().toString()))\n          \n          \n            \n                          .filter(path -> !path.getFileName().toString().contains(\"SNAPSHOT\"))\n          \n          \n            \n                          .filter(path -> !projectArtifacts.contains(path.getFileName().toString()))\n          \n      \n    \n    \n  \n\nAlso, now it's better to give names to these predicates. For example,\n.filter(path -> !isSnapshot(path))\n.filter(path -> !isProjectDependency(path))\n...\n.filter(isSnapshot)\n....\n.filter(isProjectDependency)", "url": "https://github.com/GoogleContainerTools/jib/pull/2502#discussion_r433281671", "createdAt": "2020-06-01T14:52:06Z", "author": {"login": "chanseokoh"}, "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelper.java", "diffHunk": "@@ -123,10 +126,18 @@ public static JibContainerBuilder fromExplodedWar(\n       javaContainerBuilder.addClasses(webInfClasses, isClassFile);\n     }\n     if (Files.exists(webInfLib)) {\n+      javaContainerBuilder.addProjectDependencies(\n+          new DirectoryWalker(webInfLib)\n+              .filterRoot()\n+              .filter(path -> projectArtifacts.contains(path.getFileName().toString()))\n+              .walk());\n       javaContainerBuilder.addDependencies(\n           new DirectoryWalker(webInfLib)\n               .filterRoot()\n-              .filter(path -> !path.getFileName().toString().contains(\"SNAPSHOT\"))\n+              .filter(\n+                  path ->\n+                      !path.getFileName().toString().contains(\"SNAPSHOT\")\n+                          && !projectArtifacts.contains(path.getFileName().toString()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00dcb2356073024b2536d02e6e31713c9d87f676"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI4NjE2NA==", "bodyText": "projectArtifacts --> projectArtifactFilename\nand update the Javadoc accordingly.", "url": "https://github.com/GoogleContainerTools/jib/pull/2502#discussion_r433286164", "createdAt": "2020-06-01T14:59:26Z", "author": {"login": "chanseokoh"}, "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelper.java", "diffHunk": "@@ -98,11 +99,13 @@ public static FileEntriesLayer extraDirectoryLayerConfiguration(\n    *\n    * @param javaContainerBuilder Java container builder to start with\n    * @param explodedWar the exploded WAR directory\n+   * @param projectArtifacts the project artifacts for project dependencies\n    * @return {@link JibContainerBuilder} containing the layers for the exploded WAR\n    * @throws IOException if adding layer contents fails\n    */\n   public static JibContainerBuilder fromExplodedWar(\n-      JavaContainerBuilder javaContainerBuilder, Path explodedWar) throws IOException {\n+      JavaContainerBuilder javaContainerBuilder, Path explodedWar, Set<String> projectArtifacts)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00dcb2356073024b2536d02e6e31713c9d87f676"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI4NzUxMA==", "bodyText": "Like what you did in Gradle, you can refactoring this out to a variable and reuse it below as well.", "url": "https://github.com/GoogleContainerTools/jib/pull/2502#discussion_r433287510", "createdAt": "2020-06-01T15:01:30Z", "author": {"login": "chanseokoh"}, "path": "jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenProjectProperties.java", "diffHunk": "@@ -256,7 +257,16 @@ public JibContainerBuilder createJibContainerBuilder(\n         Path war = getWarArtifact();\n         Path explodedWarPath = tempDirectoryProvider.newDirectory();\n         ZipUtil.unzip(war, explodedWarPath);\n-        return JavaContainerBuilderHelper.fromExplodedWar(javaContainerBuilder, explodedWarPath);\n+        return JavaContainerBuilderHelper.fromExplodedWar(\n+            javaContainerBuilder,\n+            explodedWarPath,\n+            session\n+                .getProjects()\n+                .stream()\n+                .map(MavenProject::getArtifact)\n+                .map(Artifact::getFile)\n+                .map(File::getName)\n+                .collect(Collectors.toSet()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00dcb2356073024b2536d02e6e31713c9d87f676"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI4OTIxNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                File f = new File(temporaryExplodedWar.resolve(\"WEB-INF/lib/dependencyA-1.0.0.jar\").toString());\n          \n          \n            \n                f.createNewFile();\n          \n          \n            \n                Files.createFile(temporaryExplodedWar.resolve(\"WEB-INF/lib/project-dependency-1.0.0.jar\"));", "url": "https://github.com/GoogleContainerTools/jib/pull/2502#discussion_r433289214", "createdAt": "2020-06-01T15:04:42Z", "author": {"login": "chanseokoh"}, "path": "jib-plugins-common/src/test/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelperTest.java", "diffHunk": "@@ -188,14 +191,18 @@ public void testFromExplodedWar()\n         Paths.get(Resources.getResource(\"plugins-common/exploded-war\").toURI());\n     FileOperations.copy(ImmutableList.of(resourceExplodedWar), temporaryFolder.getRoot().toPath());\n     Path temporaryExplodedWar = temporaryFolder.getRoot().toPath().resolve(\"exploded-war\");\n-\n     Files.createDirectories(temporaryExplodedWar.resolve(\"WEB-INF/classes/empty_dir\"));\n+    File f = new File(temporaryExplodedWar.resolve(\"WEB-INF/lib/dependencyA-1.0.0.jar\").toString());\n+    f.createNewFile();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00dcb2356073024b2536d02e6e31713c9d87f676"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI4OTU2NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                projectArtifacts.add(f.getName());\n          \n          \n            \n                projectArtifacts.add(\"project-dependency-1.0.0.jar\");", "url": "https://github.com/GoogleContainerTools/jib/pull/2502#discussion_r433289564", "createdAt": "2020-06-01T15:05:19Z", "author": {"login": "chanseokoh"}, "path": "jib-plugins-common/src/test/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelperTest.java", "diffHunk": "@@ -188,14 +191,18 @@ public void testFromExplodedWar()\n         Paths.get(Resources.getResource(\"plugins-common/exploded-war\").toURI());\n     FileOperations.copy(ImmutableList.of(resourceExplodedWar), temporaryFolder.getRoot().toPath());\n     Path temporaryExplodedWar = temporaryFolder.getRoot().toPath().resolve(\"exploded-war\");\n-\n     Files.createDirectories(temporaryExplodedWar.resolve(\"WEB-INF/classes/empty_dir\"));\n+    File f = new File(temporaryExplodedWar.resolve(\"WEB-INF/lib/dependencyA-1.0.0.jar\").toString());\n+    f.createNewFile();\n+    Set<String> projectArtifacts = new HashSet<>();\n+    projectArtifacts.add(f.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00dcb2356073024b2536d02e6e31713c9d87f676"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62dba12c4e9070129bc5ad572712891515e9a662", "author": {"user": {"login": "WuYff", "name": "Yi Wu"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/62dba12c4e9070129bc5ad572712891515e9a662", "committedDate": "2020-06-03T15:31:10Z", "message": "refactor code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MjEwMDg3", "url": "https://github.com/GoogleContainerTools/jib/pull/2502#pullrequestreview-427210087", "createdAt": "2020-06-09T14:28:31Z", "commit": {"oid": "62dba12c4e9070129bc5ad572712891515e9a662"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNDoyOTo0MlrOGhM7hQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNDozMDo0OFrOGhM-1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ2ODAzNw==", "bodyText": "nit: for consistency with Gradle, let's say\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \n          \n          \n            \n                  Stream<Artifact> mavenProjectArtifactStream =\n          \n          \n            \n                      session.getProjects().stream().map(MavenProject::getArtifact);\n          \n          \n            \n                  Set<Artifact> artifactsFromAllProjects =\n          \n          \n            \n                      session.getProjects().stream().map(MavenProject::getArtifact).collect(Collectors.toSet());", "url": "https://github.com/GoogleContainerTools/jib/pull/2502#discussion_r437468037", "createdAt": "2020-06-09T14:29:42Z", "author": {"login": "chanseokoh"}, "path": "jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenProjectProperties.java", "diffHunk": "@@ -252,11 +254,21 @@ public JibContainerBuilder createJibContainerBuilder(\n       JavaContainerBuilder javaContainerBuilder, ContainerizingMode containerizingMode)\n       throws IOException {\n     try {\n+\n+      Stream<Artifact> mavenProjectArtifactStream =\n+          session.getProjects().stream().map(MavenProject::getArtifact);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62dba12c4e9070129bc5ad572712891515e9a662"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ2ODM2Mg==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      classifyDependencies(\n          \n          \n            \n                      classifyDependencies(project.getArtifacts(), artifactsFromAllProjects);", "url": "https://github.com/GoogleContainerTools/jib/pull/2502#discussion_r437468362", "createdAt": "2020-06-09T14:30:10Z", "author": {"login": "chanseokoh"}, "path": "jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenProjectProperties.java", "diffHunk": "@@ -282,12 +294,7 @@ public JibContainerBuilder createJibContainerBuilder(\n       // Classify and add dependencies\n       Map<LayerType, List<Path>> classifiedDependencies =\n           classifyDependencies(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62dba12c4e9070129bc5ad572712891515e9a662"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ2ODg4Ng==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        mavenProjectArtifactStream\n          \n          \n            \n                        artifactsFromAllProjects\n          \n          \n            \n                            .stream()", "url": "https://github.com/GoogleContainerTools/jib/pull/2502#discussion_r437468886", "createdAt": "2020-06-09T14:30:48Z", "author": {"login": "chanseokoh"}, "path": "jib-maven-plugin/src/main/java/com/google/cloud/tools/jib/maven/MavenProjectProperties.java", "diffHunk": "@@ -252,11 +254,21 @@ public JibContainerBuilder createJibContainerBuilder(\n       JavaContainerBuilder javaContainerBuilder, ContainerizingMode containerizingMode)\n       throws IOException {\n     try {\n+\n+      Stream<Artifact> mavenProjectArtifactStream =\n+          session.getProjects().stream().map(MavenProject::getArtifact);\n+\n       if (isWarProject()) {\n         Path war = getWarArtifact();\n         Path explodedWarPath = tempDirectoryProvider.newDirectory();\n         ZipUtil.unzip(war, explodedWarPath);\n-        return JavaContainerBuilderHelper.fromExplodedWar(javaContainerBuilder, explodedWarPath);\n+        return JavaContainerBuilderHelper.fromExplodedWar(\n+            javaContainerBuilder,\n+            explodedWarPath,\n+            mavenProjectArtifactStream", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62dba12c4e9070129bc5ad572712891515e9a662"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a07044e922b27140958e159fe6444f29098499e1", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/a07044e922b27140958e159fe6444f29098499e1", "committedDate": "2020-06-09T15:38:26Z", "message": "Fix NullPointerException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73b97214903652a740233c27326903ec79d614df", "author": {"user": {"login": "chanseokoh", "name": "Chanseok Oh"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/73b97214903652a740233c27326903ec79d614df", "committedDate": "2020-06-09T16:16:47Z", "message": "Add CHANGELOG"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MzM4ODM4", "url": "https://github.com/GoogleContainerTools/jib/pull/2502#pullrequestreview-427338838", "createdAt": "2020-06-09T16:28:37Z", "commit": {"oid": "73b97214903652a740233c27326903ec79d614df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 23, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}