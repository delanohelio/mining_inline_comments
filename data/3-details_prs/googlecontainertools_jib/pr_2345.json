{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMTM1OTE3", "number": 2345, "title": "Add glob support for extra file permissions", "bodyText": "Fixes #1200.\nCan now use glob patterns when setting extra files permissions. Permissions configured with explicit paths will take priority over globs (e.g. if both '/a/b/file': '777' and '**/file': '444' are configured, /a/b/file will have 777 permissions, and all other files named file will have 444 permissions).\nIf a file matches multiple globs (e.g. if there's a file /a/b/file, and permissions are configured for both /a/b/* and **/file), behavior is undefined at the moment first configured match wins.", "createdAt": "2020-03-19T17:22:21Z", "url": "https://github.com/GoogleContainerTools/jib/pull/2345", "merged": true, "mergeCommit": {"oid": "a02a88fae7bbf54a3296c9b402ec411065b6ff47"}, "closed": true, "closedAt": "2020-03-24T15:36:49Z", "author": {"login": "TadCordle"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPPJZPgH2gAyMzkxMTM1OTE3OmYyODEyNWZiN2JiYjg5Mjc1MDdlZTFhNmNmMmI4ZGEzMDA1N2ZkYTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQ0d89gH2gAyMzkxMTM1OTE3OmNiMTg5NGE4YTRiM2ZhYWUwNDNkYjA2MThiYWYxY2E3ZGQ5Y2NkOWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f28125fb7bbb8927507ee1a6cf2b8da30057fda9", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/f28125fb7bbb8927507ee1a6cf2b8da30057fda9", "committedDate": "2020-03-19T17:13:47Z", "message": "Add glob support for extra file permissions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9135fc1f4fa85418cd8a02a5ea7ec6a97c7144ae", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/9135fc1f4fa85418cd8a02a5ea7ec6a97c7144ae", "committedDate": "2020-03-19T17:27:15Z", "message": "Merge branch 'master' of github.com:GoogleContainerTools/jib into i1200-permission-globs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "feab7ab96ffa49d719e4a578f1c6c4f2d68038d1", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/feab7ab96ffa49d719e4a578f1c6c4f2d68038d1", "committedDate": "2020-03-20T16:51:32Z", "message": "Maintain order"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4ODQ0NTI1", "url": "https://github.com/GoogleContainerTools/jib/pull/2345#pullrequestreview-378844525", "createdAt": "2020-03-20T22:26:57Z", "commit": {"oid": "feab7ab96ffa49d719e4a578f1c6c4f2d68038d1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMjoyNjo1N1rOF5kz6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQyMjoyNjo1N1rOF5kz6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxNjI2NQ==", "bodyText": "This looks good. I just think we can instantiate PathMatchers before new DirectoryWalker(...). That way, we don't have to instantiate them over and over for each file in extraDirectory. Then at least we won't instantiate them again within the same layer. This is a minor optimization, but I think it's worth, because\n\nIn practice, almost all the time, you will have some files whose permissions are not configured. That is, you'll get into this line a lot.\nThe optimization doesn't add new code but just amounts to moving the code outside .walk().\n\nWe could even skip path strings that aren't glob, but I think this is unnecessary and rather adds more code.\nWDYT?", "url": "https://github.com/GoogleContainerTools/jib/pull/2345#discussion_r395916265", "createdAt": "2020-03-20T22:26:57Z", "author": {"login": "chanseokoh"}, "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelper.java", "diffHunk": "@@ -58,10 +62,26 @@ public static FileEntriesLayer extraDirectoryLayerConfiguration(\n               AbsoluteUnixPath pathOnContainer =\n                   AbsoluteUnixPath.get(\"/\").resolve(extraDirectory.relativize(localPath));\n               Instant modificationTime = modificationTimeProvider.apply(localPath, pathOnContainer);\n-              FilePermissions permissions = extraDirectoryPermissions.get(pathOnContainer);\n+              FilePermissions permissions =\n+                  extraDirectoryPermissions.get(pathOnContainer.toString());\n               if (permissions == null) {\n+                // Check for matching globs\n+                Path containerPath = Paths.get(pathOnContainer.toString());\n+                for (Map.Entry<String, FilePermissions> entry :\n+                    extraDirectoryPermissions.entrySet()) {\n+                  PathMatcher pathMatcher =\n+                      FileSystems.getDefault().getPathMatcher(\"glob:\" + entry.getKey());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "feab7ab96ffa49d719e4a578f1c6c4f2d68038d1"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e9cd2c9596a58cd2c7f8300ec9a5faeb809c2e8", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/5e9cd2c9596a58cd2c7f8300ec9a5faeb809c2e8", "committedDate": "2020-03-20T23:42:30Z", "message": "Instantiate patterns before walking"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4ODc1NjQ4", "url": "https://github.com/GoogleContainerTools/jib/pull/2345#pullrequestreview-378875648", "createdAt": "2020-03-21T00:46:39Z", "commit": {"oid": "5e9cd2c9596a58cd2c7f8300ec9a5faeb809c2e8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQwMDo0NjozOVrOF5mf5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQwMDo0NjozOVrOF5mf5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk0MzkwOQ==", "bodyText": "Hmm... Isn't Map<PathMatcher, Permissions> more natural? Inside walk(), you iterate over this map instead of extraDirectoryPermissions.", "url": "https://github.com/GoogleContainerTools/jib/pull/2345#discussion_r395943909", "createdAt": "2020-03-21T00:46:39Z", "author": {"login": "chanseokoh"}, "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelper.java", "diffHunk": "@@ -46,22 +52,43 @@\n    */\n   public static FileEntriesLayer extraDirectoryLayerConfiguration(\n       Path extraDirectory,\n-      Map<AbsoluteUnixPath, FilePermissions> extraDirectoryPermissions,\n+      Map<String, FilePermissions> extraDirectoryPermissions,\n       BiFunction<Path, AbsoluteUnixPath, Instant> modificationTimeProvider)\n       throws IOException {\n     FileEntriesLayer.Builder builder =\n         FileEntriesLayer.builder().setName(LayerType.EXTRA_FILES.getName());\n+    Map<String, PathMatcher> pathMatchers = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e9cd2c9596a58cd2c7f8300ec9a5faeb809c2e8"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "601154c8c2c7add776d53af690f08feb649110c2", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/601154c8c2c7add776d53af690f08feb649110c2", "committedDate": "2020-03-21T00:51:34Z", "message": "Better"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d9176f589c4478c733e307b39353c476e004f92", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/4d9176f589c4478c733e307b39353c476e004f92", "committedDate": "2020-03-21T01:03:26Z", "message": "oops"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NDkyNjgy", "url": "https://github.com/GoogleContainerTools/jib/pull/2345#pullrequestreview-379492682", "createdAt": "2020-03-23T14:39:33Z", "commit": {"oid": "4d9176f589c4478c733e307b39353c476e004f92"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNDozOTozM1rOF6IcwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNDozOTozM1rOF6IcwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUwMDE2MQ==", "bodyText": "Did we add something to \"validate a layer\"?", "url": "https://github.com/GoogleContainerTools/jib/pull/2345#discussion_r396500161", "createdAt": "2020-03-23T14:39:33Z", "author": {"login": "chanseokoh"}, "path": "jib-plugins-common/src/main/java/com/google/cloud/tools/jib/plugins/common/JavaContainerBuilderHelper.java", "diffHunk": "@@ -36,7 +40,8 @@\n public class JavaContainerBuilderHelper {\n \n   /**\n-   * Returns a {@link FileEntriesLayer} for adding the extra directory to the container.\n+   * Validates and returns a {@link FileEntriesLayer} for adding the extra directory to the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d9176f589c4478c733e307b39353c476e004f92"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb1894a8a4b3faae043db0618baf1ca7dd9ccd9d", "author": {"user": {"login": "TadCordle", "name": "Tad Cordle"}}, "url": "https://github.com/GoogleContainerTools/jib/commit/cb1894a8a4b3faae043db0618baf1ca7dd9ccd9d", "committedDate": "2020-03-24T15:16:39Z", "message": "Fix comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 141, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}